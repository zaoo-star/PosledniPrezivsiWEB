<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="author" content="Zaoo">
    <meta name="description" content="Posledn칤 p콏e쬴v코칤 - Post-apokalyptick치 survival RPG hra. Prozkoumej radioaktivn칤 pustinu, bojuj s mutanty a p콏e쬴j!">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- BEZPE캛NOSTN칈 META TAGY -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUG9zbGVkbsOtIHDFmWXFvml2xaHDrSIsInNob3J0X25hbWUiOiJQxZllxb5pdsWhw60iLCJkZXNjcmlwdGlvbiI6IlBvc3QtYXBva2FseXB0aWNrw6Egc3Vydml2YWwgUlBHIGhyYSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMWExYTFhIiwidGhlbWVfY29sb3IiOiIjMWExYTFhIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0N0ZXh0IHk9Jy45ZW0nIGZvbnQtc2l6ZT0nOTAnJTNFJUUyJTk4JUEyJUVGJUI4JThGJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <title>驕뮖잺 Posledn칤 p콏e쬴v코칤 v58 | by Zaoo</title>
    
    <!-- VYPNUT칈 CONSOLE.LOG V PRODUKCI -->
    <script>
        (function() {
            // Detekce produkce - pokud nen칤 localhost
            const isProduction = !window.location.hostname.includes('localhost') && 
                                 !window.location.hostname.includes('127.0.0.1') &&
                                 !window.location.hostname.includes('192.168.');
            
            if (isProduction) {
                // Ulo쮂셠e p콢vodn칤 funkce pro p콏칤pad pot콏eby
                window._originalConsole = {
                    log: console.log,
                    warn: console.warn,
                    info: console.info,
                    debug: console.debug
                };
                
                // Vypneme v칳pisy (error ponech치me pro debugging)
                console.log = function() {};
                console.warn = function() {};
                console.info = function() {};
                console.debug = function() {};
                
                // Pro ru캜n칤 zapnut칤 v produkci: enableDevLogs()
                window.enableDevLogs = function() {
                    console.log = window._originalConsole.log;
                    console.warn = window._originalConsole.warn;
                    console.info = window._originalConsole.info;
                    console.debug = window._originalConsole.debug;
                    console.log('游댢 Dev logy zapnuty');
                };
            }
        })();
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --rust: #8B4513;
            --rust-light: #CD853F;
            --toxic-green: #39FF14;
            --toxic-dark: #228B22;
            --blood-red: #8B0000;
            --warning-yellow: #FFD700;
            --metal-dark: #1a1a1a;
            --metal-mid: #2d2d2d;
            --metal-light: #3d3d3d;
            --terminal-green: #00ff00;
            --radiation-glow: #7FFF00;
            --danger-orange: #FF4500;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1512 50%, #0d0d0d 100%);
            background-attachment: fixed;
            color: #c9c9c9;
            overflow-x: hidden;
            max-width: 100vw;
            min-height: 100vh;
        }
        
        /* Radia캜n칤 z치콏e na okraj칤ch */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at top left, rgba(76, 175, 80, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(255, 152, 0, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at bottom left, rgba(139, 195, 74, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at top right, rgba(255, 87, 34, 0.1) 0%, transparent 45%);
            pointer-events: none;
            z-index: 1;
            animation: radiationGlow 6s ease-in-out infinite;
        }
        
        @keyframes radiationGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Jemn치 zelen치 mlha */
        body::after {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 20% 50%, rgba(0, 255, 65, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 75% 25%, rgba(0, 200, 50, 0.03) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 85%, rgba(0, 230, 60, 0.035) 0%, transparent 48%);
            pointer-events: none;
            z-index: 2;
            animation: fogDrift 15s ease-in-out infinite;
        }
        
        /* No캜n칤 re쬴m overlay */
        .night-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 20, 50, 0.15);
            pointer-events: none;
            z-index: 3;
            transition: opacity 2s ease;
        }
        
        /* Blik치n칤 p콏i n칤zk칠 HP */
        @keyframes lowHpPulse {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.3; }
        }
        
        .low-hp-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(255, 0, 0, 0.4) 100%);
            pointer-events: none;
            z-index: 9990;
            animation: lowHpPulse 1.5s ease-in-out infinite;
        }
        
        /* Screen shake */
        @keyframes damageShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5px, -3px); }
            20% { transform: translate(5px, 3px); }
            30% { transform: translate(-4px, 2px); }
            40% { transform: translate(4px, -2px); }
            50% { transform: translate(-3px, 3px); }
            60% { transform: translate(3px, -1px); }
            70% { transform: translate(-2px, 1px); }
            80% { transform: translate(2px, -1px); }
            90% { transform: translate(-1px, 1px); }
        }
        
        .damage-shake {
            animation: damageShake 0.4s ease-out;
        }
        
        /* Radia캜n칤 zkreslen칤 */
        @keyframes radiationWave {
            0%, 100% { filter: none; }
            25% { filter: hue-rotate(10deg); }
            50% { filter: hue-rotate(-10deg) saturate(1.2); }
            75% { filter: hue-rotate(5deg); }
        }
        
        .radiation-zone {
            animation: radiationWave 3s ease-in-out infinite;
        }
        
        /* Blesky p콏i bou콏ce */
        @keyframes stormFlash {
            0%, 90%, 100% { opacity: 0; }
            92%, 96% { opacity: 0.7; }
            94% { opacity: 0; }
        }
        
        .storm-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            pointer-events: none;
            z-index: 9995;
            opacity: 0;
        }
        
        /* Level up z치콏e */
        @keyframes levelUpGlow {
            0% { opacity: 0; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        .levelup-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.6) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9994;
            animation: levelUpGlow 0.8s ease-out forwards;
        }
        
        /* Mini glitch */
        @keyframes miniGlitch {
            0%, 100% { transform: translate(0); filter: none; }
            20% { transform: translate(-4px, 2px); filter: hue-rotate(90deg) brightness(1.3); }
            40% { transform: translate(4px, -2px); filter: hue-rotate(-90deg) saturate(2); }
            60% { transform: translate(-3px, -2px); filter: brightness(0.7) contrast(1.5); }
            80% { transform: translate(3px, 1px); filter: hue-rotate(180deg) brightness(1.2); }
        }
        
        .mini-glitch {
            animation: miniGlitch 0.15s ease-out;
        }
        
        /* Efekt smrti */
        @keyframes deathEffect {
            0% { filter: none; opacity: 1; }
            30% { filter: grayscale(0.5) brightness(0.8); }
            60% { filter: grayscale(0.8) brightness(0.5) blur(1px); }
            100% { filter: grayscale(1) brightness(0) blur(3px); opacity: 0; }
        }
        
        .death-screen {
            animation: deathEffect 1.5s ease-out forwards;
        }
        
        /* Modal scan efekt */
        @keyframes modalScan {
            0% { height: 0; opacity: 1; }
            100% { height: 100%; opacity: 0; }
        }
        
        .modal-scan {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 65, 0.1) 0px,
                rgba(0, 255, 65, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            animation: modalScan 0.2s ease-out forwards;
        }
        
        @keyframes fogDrift {
            0%, 100% { transform: translate(0, 0); }
            33% { transform: translate(-5%, 3%); }
            66% { transform: translate(3%, -3%); }
        }
        
        /* Fallout terminal efekt p콏i p콏epnut칤 */
        @keyframes terminalSwitch {
            0% { filter: brightness(1); opacity: 1; }
            10% { filter: brightness(0.2); opacity: 0.8; }
            25% { filter: brightness(1.4) contrast(1.2); opacity: 1; }
            40% { filter: brightness(0.9); }
            60% { filter: brightness(1.1); }
            100% { filter: brightness(1); opacity: 1; }
        }
        
        .terminal-switch {
            animation: terminalSwitch 0.3s ease-out;
        }
        
        /* Scanline 코um efekt od spodu i shora - zelen칳 */
        @keyframes scanUp {
            0% { bottom: 0; height: 0; }
            50% { height: 100%; bottom: 0; }
            51% { height: 100%; bottom: 0; opacity: 1; }
            100% { height: 100%; bottom: 0; opacity: 0; }
        }
        
        @keyframes scanDown {
            0% { top: 0; height: 0; }
            50% { height: 100%; top: 0; }
            51% { height: 100%; top: 0; opacity: 1; }
            100% { height: 100%; top: 0; opacity: 0; }
        }
        
        .scan-overlay {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 65, 0.12) 0px,
                rgba(0, 255, 65, 0.12) 1px,
                rgba(0, 50, 20, 0.25) 1px,
                rgba(0, 50, 20, 0.25) 3px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanUp 0.25s ease-out forwards;
        }
        
        .scan-overlay-top {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            height: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 65, 0.12) 0px,
                rgba(0, 255, 65, 0.12) 1px,
                rgba(0, 50, 20, 0.25) 1px,
                rgba(0, 50, 20, 0.25) 3px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanDown 0.25s ease-out forwards;
        }
        
        .container { 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
        }
        
        /* === HEADER - Terminal Style === */
        header { 
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            padding: 0.5rem;
            border-bottom: 3px solid var(--rust);
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.3), inset 0 -2px 10px rgba(0,0,0,0.5);
            flex-shrink: 0;
            position: relative;
        }
        
        .stats { 
            display: flex; 
            gap: 0.8rem; 
            flex-wrap: wrap; 
            font-size: 0.75rem; 
            align-items: center;
            padding-top: 0.8rem;
        }
        
        .stat { 
            background: rgba(0,0,0,0.4);
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            border: 1px solid var(--metal-light);
            position: relative;
            transition: all 0.2s;
        }
        
        .stat.clickable {
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .stat.clickable:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--toxic-green);
            transform: scale(1.02);
        }
        
        .stat strong { 
            color: var(--toxic-green);
            text-shadow: 0 0 5px var(--toxic-green);
        }
        
        #statusBars { 
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            border: 1px solid var(--metal-light);
        }
        
        /* === MAIN CONTENT === */
        main { 
            flex: 1; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
            padding: 0.5rem;
            padding-bottom: var(--main-bottom-padding, 100px);
        }
        
        /* === NAVIGATION - Spodn칤 li코ta === */
        nav { 
            position: fixed !important;
            bottom: 0 !important;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            background: linear-gradient(0deg, #000 0%, #1a1a1a 100%);
            padding: 0.4rem 0.2rem;
            padding-bottom: var(--nav-bottom-padding, 35px);
            border-top: 2px solid var(--rust);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.9);
            z-index: 100;
            gap: 0.15rem;
        }
        
        .nav-btn { 
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid var(--metal-light);
            color: #888;
            padding: 0.4rem 0.1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.45rem;
            font-family: 'Share Tech Mono', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.05rem;
            text-transform: uppercase;
            letter-spacing: 0px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.3s ease;
        }
        
        .nav-btn:hover::before {
            left: 100%;
        }
        
        .nav-btn .icon { font-size: 0.9rem; filter: grayscale(0.5); }
        
        .nav-btn.active { 
            background: linear-gradient(180deg, var(--rust) 0%, #5a3510 100%);
            border-color: var(--rust-light);
            color: #fff;
            box-shadow: 0 0 10px rgba(139, 69, 19, 0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .nav-btn.active .icon { filter: none; }
        
        /* === TABS - Weathered Panel === */
        .tab { 
            display: none; 
            background: linear-gradient(135deg, #1a1a1a 0%, #151515 50%, #1a1a1a 100%);
            padding: 1rem; 
            border-radius: 8px;
            border: 2px solid var(--metal-light);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 4px 20px rgba(0,0,0,0.3);
            min-height: calc(100vh - 220px);
            position: relative;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--rust), transparent);
        }
        
        .tab.active { display: block; }
        
        /* === BUTTONS === */
        .btn { 
            background: linear-gradient(180deg, var(--rust-light) 0%, var(--rust) 50%, #5a3510 100%);
            color: #fff;
            border: 2px solid var(--rust-light);
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover { 
            background: linear-gradient(180deg, #e09050 0%, var(--rust-light) 50%, var(--rust) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(139, 69, 19, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* === GRID & CARDS === */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 0.8rem; 
            margin: 1rem 0; 
        }
        
        .card { 
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid var(--metal-light);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--metal-light), transparent);
        }
        
        .card:hover { 
            border-color: var(--rust);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4), 0 0 20px rgba(139, 69, 19, 0.2);
        }
        
        .card.selected { 
            border-color: var(--toxic-green);
            background: linear-gradient(135deg, #1a2a1a 0%, #152515 100%);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
        }
        
        /* === INPUTS === */
        input, textarea { 
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 2px solid var(--metal-light);
            border-radius: 4px;
            color: var(--toxic-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0.5rem 0;
            transition: border-color 0.2s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--toxic-green);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.2);
        }
        
        /* === ATTRIBUTES === */
        .attr-row { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            border-left: 3px solid var(--rust);
        }
        
        .attr-btn { 
            background: linear-gradient(180deg, var(--metal-light) 0%, var(--metal-dark) 100%);
            border: 2px solid var(--rust);
            color: var(--toxic-green);
            width: 35px;
            height: 35px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .attr-btn:hover {
            background: linear-gradient(180deg, var(--rust) 0%, #5a3510 100%);
            color: #fff;
        }
        
        .attr-btn:disabled { 
            background: #1a1a1a;
            border-color: #333;
            color: #444;
            cursor: not-allowed;
        }
        
        /* === MODAL === */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.9); 
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal.show { display: flex; align-items: center; justify-content: center; }
        
        /* Scroll to top button */
        #scrollToTop {
            position: fixed;
            bottom: 100px;
            right: 15px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--rust) 0%, #8B4513 100%);
            border: 2px solid var(--metal-light);
            border-radius: 50%;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 99;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s, opacity 0.2s;
        }
        #scrollToTop:hover { transform: scale(1.1); }
        #scrollToTop.visible { display: flex; }
        
        .modal-content { 
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            padding: 1.5rem;
            border-radius: 8px;
            border: 3px solid var(--rust);
            box-shadow: 0 0 50px rgba(139, 69, 19, 0.3), inset 0 2px 20px rgba(0,0,0,0.5);
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        
        .modal-content::before {
            content: '';
            display: none;
        }
        
        /* === HEADINGS === */
        h2 { 
            color: var(--rust-light);
            font-family: 'Russo One', sans-serif;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            border-bottom: 2px solid var(--rust);
            padding-bottom: 0.5rem;
        }
        
        h3 { 
            color: var(--warning-yellow);
            font-family: 'Share Tech Mono', monospace;
            margin: 1rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* === STATUS BARS === */
        .status-bar { 
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 1px solid var(--metal-light);
            background: linear-gradient(180deg, rgba(30,30,30,0.9) 0%, rgba(15,15,15,0.9) 100%);
            min-width: 100px;
            transition: all 0.2s;
        }
        
        .status-bar:hover {
            transform: scale(1.05);
            border-color: #666;
        }
        
        .status-bar .icon {
            font-size: 1.1rem;
        }
        
        .status-bar .value {
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 32px;
        }
        
        .status-bar .bar-container { 
            flex: 1;
            height: 8px;
            background: #0a0a0a;
            border-radius: 4px;
            position: relative;
            border: 1px solid #333;
            overflow: hidden;
            min-width: 50px;
        }
        
        .status-bar .bar-container::after { 
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .hunger-bar::after { background: linear-gradient(90deg, #cc4400, #ff6600, #ff9900); width: var(--val); box-shadow: 0 0 8px #ff6600; }
        .thirst-bar::after { background: linear-gradient(90deg, #004488, #0066cc, #00aaff); width: var(--val); box-shadow: 0 0 8px #00aaff; }
        .energy-bar::after { background: linear-gradient(90deg, #448800, #66cc00, #99ff00); width: var(--val); box-shadow: 0 0 8px #99ff00; }
        .mood-bar::after { background: linear-gradient(90deg, #660088, #9900cc, #cc66ff); width: var(--val); box-shadow: 0 0 8px #cc66ff; }
        .radiation-bar::after { background: linear-gradient(90deg, #660000, #990000, #ff0000); width: var(--val); box-shadow: 0 0 8px #ff0000; }
        
        /* === CANVAS === */
        canvas { 
            display: block; 
            cursor: crosshair;
            border: 2px solid var(--rust);
            border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        canvas:active { cursor: grabbing; }
        
        /* === RESPONSIVE LAYOUTS === */
        .equipment-layout { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .char-info-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .shop-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; max-height: 500px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .combat-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin: 1rem 0; }
        
        /* Glob치ln칤 pravidlo pro plynul칠 scrollov치n칤 na mobilu */
        [style*="overflow-y: auto"], [style*="overflow-y:auto"], 
        [style*="overflow: auto"], [style*="overflow:auto"] {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile-first responsive grids */
        .responsive-2col { display: grid; grid-template-columns: 1fr; gap: 0.8rem; }
        .responsive-3col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; }
        .responsive-4col { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; }
        .responsive-6col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; }
        
        /* Scrollable container helper - pro plynul칠 scrollov치n칤 na mobilu */
        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* Hide on mobile */
        .hide-mobile { display: none; }
        
        /* Smaller text on mobile */
        .mobile-compact { font-size: 0.7rem !important; }
        .mobile-compact h2 { font-size: 1rem !important; }
        .mobile-compact h3 { font-size: 0.85rem !important; }
        
        @media (min-width: 769px) {
            header { padding: 0.8rem 1rem; }
            header::before { font-size: 0.7rem; }
            .stats { font-size: 0.85rem; gap: 1rem; padding-top: 1rem; }
            .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
            main { padding: 0; margin-bottom: 1rem; overflow-y: visible; padding-bottom: 0; }
            nav { 
                position: static !important;
                bottom: auto !important;
                display: flex;
                gap: 0.5rem;
                padding: 0.5rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                border-top: none;
                border: 2px solid var(--rust);
            }
            .nav-btn { 
                padding: 1rem 1.5rem;
                flex: 1;
                font-size: 0.85rem;
                flex-direction: row;
                gap: 0.5rem;
            }
            .nav-btn .icon { font-size: 1.1rem; }
            .tab { padding: 1.5rem; min-height: auto; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .equipment-layout { grid-template-columns: 300px 1fr; }
            .char-info-grid { grid-template-columns: 1fr 1fr 1fr; }
            .shop-grid { grid-template-columns: 1fr 1fr; }
            .combat-grid { grid-template-columns: 1fr 1fr; }
            .modal-content { padding: 2rem; }
            
            /* Desktop responsive grids */
            .responsive-2col { grid-template-columns: 1fr 1fr; }
            .responsive-6col { grid-template-columns: repeat(6, 1fr); gap: 0.4rem; }
            .hide-mobile { display: block; }
            .mobile-compact { font-size: inherit !important; }
            .mobile-compact h2 { font-size: inherit !important; }
            .mobile-compact h3 { font-size: inherit !important; }
        }
        
        /* === ANIMATIONS === */
        @keyframes flash-red {
            0%, 100% { background: transparent; }
            50% { background: rgba(139, 0, 0, 0.3); }
        }
        
        @keyframes flash-green {
            0%, 100% { opacity: 1; text-shadow: none; }
            50% { opacity: 0.5; text-shadow: 0 0 10px #76ff03, 0 0 20px #76ff03; }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px var(--toxic-green); }
            50% { box-shadow: 0 0 20px var(--toxic-green); }
        }
        
        @keyframes war-zone-pulse {
            0%, 100% { box-shadow: 0 0 60px #ff0000, 0 0 120px #ff0000dd, 0 0 180px #ff0000aa, 0 0 240px #ff000066, inset 0 0 60px #ff000088; transform: scale(1); filter: brightness(1.5); background: radial-gradient(circle, #ff000055 0%, #ff000022 50%, transparent 70%); }
            50% { box-shadow: 0 0 80px #ff3333, 0 0 160px #ff0000, 0 0 240px #ff0000cc, 0 0 320px #ff000088, inset 0 0 80px #ff0000cc; transform: scale(1.05); filter: brightness(2); background: radial-gradient(circle, #ff000088 0%, #ff000044 50%, transparent 70%); }
        }
        
        @keyframes treasure-pulse {
            0%, 100% { box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700aa, 0 0 90px #ffd70066; transform: scale(1); filter: brightness(1.2); }
            50% { box-shadow: 0 0 45px #ffd700, 0 0 90px #ffd700cc, 0 0 120px #ffd70088; transform: scale(1.06); filter: brightness(1.4); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.85; }
        }
        
        @keyframes scan-line {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        
        /* === PvP ANIMACE === */
        @keyframes pvpArenaGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(244, 67, 54, 0.3); }
            50% { box-shadow: 0 0 40px rgba(244, 67, 54, 0.6); }
        }
        
        @keyframes swordClash {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        
        @keyframes eloUp {
            0% { transform: translateY(0); color: #8bc34a; }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        
        @keyframes eloDown {
            0% { transform: translateY(0); color: #f44336; }
            50% { transform: translateY(10px); }
            100% { transform: translateY(0); }
        }
        
        @keyframes rankGlow {
            0%, 100% { filter: drop-shadow(0 0 5px currentColor); }
            50% { filter: drop-shadow(0 0 15px currentColor); }
        }
        
        @keyframes streakFire {
            0%, 100% { text-shadow: 0 0 5px #ff9800, 0 0 10px #f44336; }
            50% { text-shadow: 0 0 15px #ff9800, 0 0 25px #f44336, 0 0 35px #ffeb3b; }
        }
        
        @keyframes battleReady {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes criticalHit {
            0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
            25% { transform: scale(1.3) rotate(-5deg); filter: brightness(1.5); }
            50% { transform: scale(1.5) rotate(5deg); filter: brightness(2); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
        }
        
        @keyframes damageNumber {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(0.8); }
        }
        
        /* === NOV칄 ANIMACE === */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes hitFlash {
            0% { filter: brightness(1); }
            50% { filter: brightness(2) saturate(2); }
            100% { filter: brightness(1); }
        }
        
        @keyframes goldShine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        @keyframes particleFloat {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        .shake { animation: shake 0.5s ease-in-out; }
        .bounce { animation: bounce 0.6s ease-in-out; }
        .fade-in-up { animation: fadeInUp 0.4s ease-out; }
        .fade-in-scale { animation: fadeInScale 0.3s ease-out; }
        .sparkle { animation: sparkle 1s ease-in-out infinite; }
        .hit-flash { animation: hitFlash 0.2s ease-out; }
        .damage-shake { animation: damageShake 0.3s ease-in-out; }
        
        /* === ADVANCED VISUAL EFFECTS v2.4 === */
        
        /* Rare item glow effect */
        .item-rare { 
            animation: rareGlow 2s ease-in-out infinite;
            border: 1px solid #2196f3 !important;
        }
        .item-epic { 
            animation: epicGlow 2s ease-in-out infinite;
            border: 1px solid #9c27b0 !important;
        }
        .item-legendary { 
            animation: legendaryGlow 1.5s ease-in-out infinite;
            border: 2px solid #ffd700 !important;
        }
        
        @keyframes rareGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(33, 150, 243, 0.3); }
            50% { box-shadow: 0 0 15px rgba(33, 150, 243, 0.6); }
        }
        
        @keyframes epicGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(156, 39, 176, 0.4); }
            50% { box-shadow: 0 0 20px rgba(156, 39, 176, 0.8); }
        }
        
        @keyframes legendaryGlow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 165, 0, 0.3);
                filter: brightness(1);
            }
            50% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 165, 0, 0.5);
                filter: brightness(1.1);
            }
        }
        
        /* Elite enemy effect */
        .elite-enemy {
            animation: eliteAura 1.5s ease-in-out infinite;
            position: relative;
        }
        
        .elite-enemy::after {
            content: '游';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
            animation: elitePulse 1s ease-in-out infinite;
        }
        
        @keyframes eliteAura {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(139, 0, 0, 0.5);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 15px rgba(139, 0, 0, 0.8), 0 0 25px rgba(255, 0, 0, 0.3);
                transform: scale(1.02);
            }
        }
        
        @keyframes elitePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        /* Screen damage flash */
        @keyframes screenFlashRed {
            0% { background-color: rgba(139, 0, 0, 0); }
            50% { background-color: rgba(139, 0, 0, 0.3); }
            100% { background-color: rgba(139, 0, 0, 0); }
        }
        
        @keyframes screenFlashGreen {
            0% { background-color: rgba(0, 139, 0, 0); }
            50% { background-color: rgba(0, 139, 0, 0.2); }
            100% { background-color: rgba(0, 139, 0, 0); }
        }
        
        .screen-flash-red { animation: screenFlashRed 0.3s ease-out; }
        .screen-flash-green { animation: screenFlashGreen 0.3s ease-out; }
        
        /* Button hover effects */
        .btn {
            transition: all 0.2s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .btn:active::after {
            width: 200px;
            height: 200px;
        }
        
        /* Smooth transitions for UI elements */
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* Chat container - zajisti scroll na mobilech */
        #chatMessagesContainer {
            -webkit-overflow-scrolling: touch !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            touch-action: pan-y !important;
            overscroll-behavior: contain !important;
            overscroll-behavior-y: contain !important;
        }
        
        /* Zabra켿 pull-to-refresh na mod치lech s chatem */
        .modal-content {
            overscroll-behavior: contain !important;
            overscroll-behavior-y: contain !important;
        }
        
        /* Kdy je modal otev콏en칳, zabra켿 pull-to-refresh na body */
        body.modal-open {
            overscroll-behavior: none !important;
            overscroll-behavior-y: none !important;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        /* Progress bar animations */
        .progress-bar-animated {
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-animated::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            100% { left: 100%; }
        }
        
        /* Dust fall animation */
        @keyframes dustFall {
            0% { 
                transform: translateY(0) translateX(0); 
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: translateY(100vh) translateX(var(--drift)); 
                opacity: 0;
            }
        }
        
        /* Damage flash animation */
        @keyframes damageFlashAnim {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* Elite enemy glow */
        .elite-glow {
            animation: eliteGlowPulse 2s ease-in-out infinite;
        }
        
        @keyframes eliteGlowPulse {
            0%, 100% { 
                filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.5));
            }
            50% { 
                filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
            }
        }
        
        /* Rare item shimmer */
        .rare-shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .rare-shimmer::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                transparent 0%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 100%
            );
            transform: rotate(30deg);
            animation: rareShimmer 3s ease-in-out infinite;
        }
        
        @keyframes rareShimmer {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }
        
        /* Combat damage number pop */
        .damage-pop {
            animation: damagePop 0.3s ease-out;
        }
        
        @keyframes damagePop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Abyss portal effect */
        .abyss-portal {
            animation: abyssPortal 4s linear infinite;
            border-radius: 50%;
        }
        
        @keyframes abyssPortal {
            0% { 
                box-shadow: 0 0 10px #9c27b0, inset 0 0 20px rgba(156, 39, 176, 0.5);
                transform: rotate(0deg);
            }
            50% { 
                box-shadow: 0 0 30px #9c27b0, inset 0 0 40px rgba(156, 39, 176, 0.8);
            }
            100% { 
                box-shadow: 0 0 10px #9c27b0, inset 0 0 20px rgba(156, 39, 176, 0.5);
                transform: rotate(360deg);
            }
        }
        
        /* Radiation warning pulse */
        .radiation-warning {
            animation: radiationPulse 1s ease-in-out infinite;
        }
        
        @keyframes radiationPulse {
            0%, 100% { 
                text-shadow: 0 0 5px #7FFF00;
                opacity: 1;
            }
            50% { 
                text-shadow: 0 0 20px #7FFF00, 0 0 30px #ADFF2F;
                opacity: 0.8;
            }
        }
        
        /* Combat unit hover */
        .combat-unit {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .combat-unit:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            z-index: 10;
        }
        
        /* Terrain tile effects */
        .terrain-fire {
            animation: fireFlicker 0.5s ease-in-out infinite;
        }
        
        .terrain-toxic {
            animation: toxicBubble 2s ease-in-out infinite;
        }
        
        .terrain-water {
            animation: waterRipple 3s ease-in-out infinite;
        }
        
        @keyframes fireFlicker {
            0%, 100% { opacity: 0.8; filter: brightness(1); }
            50% { opacity: 1; filter: brightness(1.3); }
        }
        
        @keyframes toxicBubble {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes waterRipple {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.8; }
        }
        
        /* XP gain floating number */
        .xp-float {
            position: fixed;
            pointer-events: none;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: xpFloatUp 1.5s ease-out forwards;
            z-index: 10000;
        }
        
        @keyframes xpFloatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-80px) scale(1.5); 
            }
        }
        
        /* Level up celebration */
        .level-up-celebration {
            animation: levelUpBurst 0.8s ease-out;
        }
        
        @keyframes levelUpBurst {
            0% { 
                transform: scale(0.5);
                opacity: 0;
                filter: brightness(2);
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% { 
                transform: scale(1);
                opacity: 1;
                filter: brightness(1);
            }
        }
        
        /* Floating damage/heal numbers */
        .floating-number {
            position: fixed;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 10000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: floatUp 1.5s ease-out forwards;
        }
        
        .floating-number.damage { color: #ff4444; }
        .floating-number.heal { color: #4CAF50; }
        .floating-number.xp { color: #ffd700; }
        .floating-number.crit { color: #ff6600; font-size: 2rem; }
        .floating-number.money { color: #ffeb3b; }
        
        /* Particle container */
        .particle-container {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }
        
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: particleFloat 1s ease-out forwards;
        }
        
        /* Level up glow effect */
        .levelup-glow {
            animation: goldShine 2s linear infinite;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.3), transparent);
            background-size: 200% 100%;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--metal-dark);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--rust);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--rust-light);
        }
        
        /* === SPECIAL ELEMENTS === */
        .danger-zone {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.2) 0%, rgba(0,0,0,0.3) 100%);
            border: 2px solid var(--blood-red);
            border-radius: 6px;
            padding: 1rem;
        }
        
        .safe-zone {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2) 0%, rgba(0,0,0,0.3) 100%);
            border: 2px solid var(--toxic-dark);
            border-radius: 6px;
            padding: 1rem;
        }
        
        .warning-zone {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(0,0,0,0.3) 100%);
            border: 2px solid var(--warning-yellow);
            border-radius: 6px;
            padding: 1rem;
        }
        
        /* Glowing text for important values */
        .glow-green { color: var(--toxic-green); text-shadow: 0 0 10px var(--toxic-green); }
        .glow-red { color: #ff4444; text-shadow: 0 0 10px #ff4444; }
        .glow-yellow { color: var(--warning-yellow); text-shadow: 0 0 10px var(--warning-yellow); }
        .glow-orange { color: var(--danger-orange); text-shadow: 0 0 10px var(--danger-orange); }
        
        /* === NOTIFIKACE === */
        #notificationContainer {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
            pointer-events: none;
        }
        
        .notification {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid var(--rust);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            animation: notifySlideIn 0.3s ease-out, notifyFadeOut 0.5s ease-in 3.5s forwards;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
        }
        
        .notification.success { border-color: var(--toxic-green); }
        .notification.warning { border-color: var(--warning-yellow); }
        .notification.danger { border-color: #c62828; }
        .notification.info { border-color: #2196f3; }
        .notification.epic { border-color: #9c27b0; background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); }
        .notification.legendary { border-color: #ffd700; background: linear-gradient(135deg, #2a2a1a 0%, #3a3a2a 100%); animation: notifySlideIn 0.3s ease-out, legendaryGlow 1s ease-in-out infinite, notifyFadeOut 0.5s ease-in 4.5s forwards; }
        
        .notification-icon {
            font-size: 1.8rem;
            min-width: 40px;
            text-align: center;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 0.95rem;
            color: #fff;
            margin-bottom: 2px;
        }
        
        .notification-text {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        @keyframes notifySlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes notifyFadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(50%); }
        }
        
        /* === ADVANCED VISUAL EFFECTS === */
        
        /* Parallax wasteland background */
        .parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(139, 69, 19, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(57, 255, 20, 0.05) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(30, 30, 30, 1) 0%, rgba(10, 10, 10, 1) 100%);
        }
        
        /* Screen shake effect */
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-3px) translateY(2px); }
            20% { transform: translateX(3px) translateY(-2px); }
            30% { transform: translateX(-2px) translateY(1px); }
            40% { transform: translateX(2px) translateY(-1px); }
            50% { transform: translateX(-1px); }
            60% { transform: translateX(1px); }
        }
        
        .screen-shake {
            animation: screenShake 0.4s ease-out;
        }
        
        /* Combat damage flash */
        @keyframes damageFlash {
            0% { background-color: rgba(255, 0, 0, 0.4); }
            100% { background-color: transparent; }
        }
        
        .damage-flash {
            animation: damageFlash 0.3s ease-out;
        }
        
        /* Heal effect */
        @keyframes healPulse {
            0% { box-shadow: inset 0 0 20px rgba(76, 175, 80, 0.5); }
            100% { box-shadow: inset 0 0 0px rgba(76, 175, 80, 0); }
        }
        
        .heal-pulse {
            animation: healPulse 0.5s ease-out;
        }
        
        /* Radiation warning - uses @keyframes radiationPulse defined above */
        .radiation-warning {
            animation: radiationPulse 1s ease-in-out infinite;
            color: #ff9800 !important;
        }
        
        .radiation-critical {
            animation: radiationPulse 0.5s ease-in-out infinite;
            color: #ff4444 !important;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        /* Map location hover effect */
        .map-location {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        
        .map-location:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        /* Progress bar smooth animation */
        .progress-bar-fill {
            transition: width 0.5s ease-out;
        }
        
        /* Tab switch animation */
        @keyframes tabFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content {
            animation: tabFadeIn 0.3s ease-out;
        }
        
        /* Modal entrance - uses @keyframes modalSlideIn defined above */
        .modal.show .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* Combat grid cell hover */
        .combat-cell {
            transition: all 0.15s ease-out;
        }
        
        .combat-cell:hover {
            filter: brightness(1.3);
            z-index: 5;
        }
        
        /* Abyss special effects */
        @keyframes abyssGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(156, 39, 176, 0.3), inset 0 0 30px rgba(0, 0, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(156, 39, 176, 0.6), inset 0 0 50px rgba(0, 0, 0, 0.7); }
        }
        
        .abyss-portal {
            animation: abyssGlow 3s ease-in-out infinite;
            border-radius: 50%;
        }
        
        /* Loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--toxic-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Text typing effect class */
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        
        .typing-text {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 2s steps(40, end);
        }
        
        /* Inventory item hover */
        .inv-item {
            transition: all 0.2s ease-out;
        }
        
        .inv-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* Color blind friendly mode - add class to body */
        body.colorblind-mode .radiation-warning,
        body.colorblind-mode .radiation-critical {
            text-decoration: underline wavy;
        }
        
        body.colorblind-mode .item-rare { border: 2px dashed #2196f3; }
        body.colorblind-mode .item-epic { border: 2px dotted #9c27b0; }
        body.colorblind-mode .item-legendary { border: 3px double #ffd700; }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <div class="container">
        <header>
            <div id="headerStats" style="background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%); border: 1px solid #333; border-radius: 8px; padding: 0.4rem; margin-bottom: 0.3rem;">
                <!-- 콎치dek 1: Jm칠no + HP + Level -->
                <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 0.25rem; margin-bottom: 0.3rem; align-items: center;">
                    <div class="stat clickable" data-stat="name" onclick="showStatInfo('name')" style="display: flex; align-items: center; gap: 0.2rem; background: linear-gradient(180deg, #2a2a1a 0%, #1a1a0a 100%); padding: 0.25rem 0.4rem; border-radius: 5px; border: 1px solid #4a4a2a; cursor: pointer; overflow: hidden;">
                        <span style="font-size: 0.85rem;">驕뮖잺</span>
                        <span id="name" style="font-size: 0.7rem; font-weight: bold; color: #ffd700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
                    </div>
                    <div class="stat clickable" data-stat="hp" onclick="showStatInfo('hp')" style="display: flex; align-items: center; gap: 0.15rem; background: linear-gradient(180deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.25rem 0.4rem; border-radius: 5px; border: 1px solid #4a2a2a; cursor: pointer;">
                        <span style="font-size: 0.8rem;">仇벒잺</span>
                        <span id="hp" style="font-size: 0.7rem; font-weight: bold; color: #ff6b6b;"></span>
                    </div>
                    <div class="stat clickable" data-stat="level" onclick="showStatInfo('level')" style="display: flex; align-items: center; gap: 0.15rem; background: linear-gradient(180deg, #1a2a1a 0%, #0a1a0a 100%); padding: 0.25rem 0.4rem; border-radius: 5px; border: 1px solid #2a4a2a; cursor: pointer;">
                        <span style="font-size: 0.8rem;">丘덢잺</span>
                        <span style="font-size: 0.7rem; font-weight: bold; color: #8bc34a;">Lv.<span id="level"></span></span>
                    </div>
                    <div style="display: flex; gap: 0.15rem;">
                        <div id="onlineIndicator" onclick="switchTab('multiplayer')" style="padding: 0.2rem 0.35rem; font-size: 0.75rem; background: #222; border: 1px solid #444; border-radius: 4px; min-width: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Online status">
                            <span id="onlineStatusIcon">丘</span>
                        </div>
                        <button class="btn" onclick="toggleSound()" id="soundBtn" style="padding: 0.2rem 0.35rem; font-size: 0.75rem; background: #222; border: 1px solid #444; min-width: 28px;">游댉</button>
                        <button class="btn" onclick="showGameInfo()" style="padding: 0.2rem 0.35rem; font-size: 0.75rem; background: #222; border: 1px solid #444; min-width: 28px;">游</button>
                    </div>
                </div>
                <!-- 콎치dek 2: V치ha + 캛as -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem;">
                    <div class="stat clickable" data-stat="weight" onclick="showStatInfo('weight')" style="display: flex; align-items: center; justify-content: center; gap: 0.15rem; background: #151515; padding: 0.2rem; border-radius: 4px; border: 1px solid #2a2a2a; cursor: pointer;">
                        <span style="font-size: 0.7rem;">游닍</span>
                        <span id="weight" style="font-size: 0.65rem; color: #aaa;"></span><span style="font-size: 0.6rem; color: #666;">kg</span>
                    </div>
                    <div class="stat clickable" data-stat="time" onclick="showStatInfo('time')" style="display: flex; align-items: center; justify-content: center; gap: 0.15rem; background: #151515; padding: 0.2rem; border-radius: 4px; border: 1px solid #2a2a2a; cursor: pointer;">
                        <span style="font-size: 0.7rem;">游뎷</span>
                        <span id="time" style="font-size: 0.65rem; color: #aaa;"></span>
                    </div>
                </div>
            </div>
            <div id="statusBars"></div>
        </header>
        
        <main id="main"></main>
    </div>
    
    <nav id="nav"></nav>
    
    <!-- Scroll to top button -->
    <button id="scrollToTop" onclick="scrollToTop()">拘勇</button>
    
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>
    
    <script>
        // === GLOBAL CLEANUP REGISTRY ===
        // Pro spr치vn칠 uvoln캩n칤 zdroj콢 p콏i ukon캜en칤
        const _cleanupRegistry = {
            intervals: [],
            timeouts: [],
            listeners: [],
            
            addInterval(id) { this.intervals.push(id); return id; },
            addTimeout(id) { this.timeouts.push(id); return id; },
            addListener(target, event, handler) { 
                this.listeners.push({ target, event, handler }); 
                return handler;
            },
            
            cleanup() {
                this.intervals.forEach(clearInterval);
                this.timeouts.forEach(clearTimeout);
                this.listeners.forEach(({ target, event, handler }) => {
                    target.removeEventListener(event, handler);
                });
                this.intervals = [];
                this.timeouts = [];
                this.listeners = [];
                console.log('游빛 Cleanup completed');
            }
        };
        
        // Safe interval/timeout wrappers
        function safeSetInterval(fn, delay) {
            return _cleanupRegistry.addInterval(setInterval(fn, delay));
        }
        
        function safeSetTimeout(fn, delay) {
            return _cleanupRegistry.addTimeout(setTimeout(fn, delay));
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => _cleanupRegistry.cleanup());
        
        // === SECURITY UTILITIES ===
        // Escape HTML to prevent XSS attacks in user-generated content
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Sanitizace jm칠na pro Firebase cesty (/ . # $ [ ] nejsou povoleny v kl칤캜칤ch)
        function sanitizeFirebasePath(name) {
            if (!name) return 'unknown';
            return String(name).replace(/[\/\.#$\[\]]/g, '_');
        }
        
        // === GAME CONSTANTS ===
        // Centralizovan칠 konstanty m칤sto magic numbers
        const GAME_CONSTANTS = {
            // Limity hodnot
            MAX_MONEY: 999999999,
            MAX_XP: Number.MAX_SAFE_INTEGER,
            MAX_HP: 9999,
            MAX_LEVEL: 100,
            MAX_INVENTORY_WEIGHT: 999,
            MAX_STACK_SIZE: 999,
            
            // 캛asov칠 konstanty (ms)
            AUTOSAVE_INTERVAL: 60000,           // 1 minuta
            DEBOUNCE_SAVE: 2000,                // 2 sekundy
            HOTEL_COOLDOWN: 4 * 60 * 60 * 1000, // 4 hodiny
            FORTUNE_COOLDOWN: 12 * 60 * 60 * 1000, // 12 hodin
            RADIO_COOLDOWN: 30 * 60 * 1000,     // 30 minut
            SLEEP_DURATION: 8 * 60 * 60 * 1000, // 8 hodin
            
            // Hern칤 mechaniky
            BASE_XP_REQUIREMENT: 350,
            XP_MULTIPLIER: 1.5,
            CRIT_MULTIPLIER: 1.5,
            INFLATION_RATE_PER_DAY: 0.01,       // 1%
            MAX_INFLATION: 0.5,                  // 50%
            
            // Status decay (per game hour)
            HUNGER_DECAY: 1,
            THIRST_DECAY: 1.5,
            ENERGY_DECAY: 0.5,
            
            // Limity UI
            MAX_LOG_ENTRIES: 50,
            MAX_SETTLEMENT_EVENTS: 15,
            MAX_CHAT_MESSAGES: 100,
            
            // Storage keys
            STORAGE_KEYS: {
                SAVE: 'survival_hero_save',
                SAVE_V2: 'survival_hero_save_v2',
                BACKUP: 'survival_hero_backup',
                FRIENDS: 'friendsList_'
            }
        };
        
        // Freeze to prevent accidental modification
        Object.freeze(GAME_CONSTANTS);
        Object.freeze(GAME_CONSTANTS.STORAGE_KEYS);
        
        // === SAFE NUMBER UTILITIES ===
        function safeNumber(value, defaultValue = 0, min = -Infinity, max = Infinity) {
            const num = Number(value);
            if (isNaN(num) || !isFinite(num)) return defaultValue;
            return Math.max(min, Math.min(max, num));
        }
        
        function safeInteger(value, defaultValue = 0, min = -Infinity, max = Infinity) {
            return Math.floor(safeNumber(value, defaultValue, min, max));
        }
        
        // Debounce utility for performance optimization
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Throttle utility - execute at most once per wait period
        function throttle(func, wait) {
            let lastTime = 0;
            return function executedFunction(...args) {
                const now = Date.now();
                if (now - lastTime >= wait) {
                    lastTime = now;
                    func(...args);
                }
            };
        }
        
        // === GAME LOGGER ===
        // Centralizovan칠 logov치n칤 s 칰rovn캩mi a form치tov치n칤m
        const GameLogger = {
            levels: {
                DEBUG: 0,
                INFO: 1,
                WARN: 2,
                ERROR: 3
            },
            
            currentLevel: 1, // INFO by default
            history: [],
            maxHistory: 100,
            
            // Ikony pro r콢zn칠 kategorie
            icons: {
                combat: '丘덢잺',
                inventory: '游',
                money: '游눯',
                xp: '救',
                quest: '游닆',
                multiplayer: '游깷',
                save: '游',
                error: '仇',
                warning: '丘멆잺',
                info: '좶잺',
                debug: '游댢'
            },
            
            /**
             * Nastav칤 칰rove켿 logov치n칤
             */
            setLevel(level) {
                if (typeof level === 'string') {
                    this.currentLevel = this.levels[level.toUpperCase()] ?? 1;
                } else {
                    this.currentLevel = level;
                }
            },
            
            /**
             * Form치tovan칳 log s kategori칤
             */
            log(category, message, data = null, level = 1) {
                if (level < this.currentLevel) return;
                
                const timestamp = new Date().toLocaleTimeString('cs-CZ');
                const icon = this.icons[category] || '游닇';
                const levelName = Object.keys(this.levels).find(k => this.levels[k] === level) || 'INFO';
                
                const logEntry = {
                    timestamp,
                    category,
                    message,
                    data,
                    level: levelName
                };
                
                // P콏idej do historie
                this.history.push(logEntry);
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                }
                
                // Console output
                const formattedMsg = `[${timestamp}] ${icon} [${category.toUpperCase()}] ${message}`;
                
                switch(level) {
                    case 0: console.debug(formattedMsg, data || ''); break;
                    case 1: console.log(formattedMsg, data || ''); break;
                    case 2: console.warn(formattedMsg, data || ''); break;
                    case 3: console.error(formattedMsg, data || ''); break;
                }
            },
            
            // Shortcut metody
            debug(category, message, data) { this.log(category, message, data, 0); },
            info(category, message, data) { this.log(category, message, data, 1); },
            warn(category, message, data) { this.log(category, message, data, 2); },
            error(category, message, data) { this.log(category, message, data, 3); },
            
            // Combat specific
            combat(message, data) { this.log('combat', message, data, 1); },
            
            // Money specific
            money(message, data) { this.log('money', message, data, 1); },
            
            /**
             * Export logu pro debugging
             */
            export() {
                return JSON.stringify(this.history, null, 2);
            },
            
            /**
             * Vy캜ist칤 historii
             */
            clear() {
                this.history = [];
            }
        };
        
        // === EVENT BUS ===
        // Centr치ln칤 syst칠m pro komunikaci mezi 캜치stmi aplikace
        const EventBus = {
            events: {},
            
            /**
             * Registruje poslucha캜e ud치losti
             * @param {string} event - N치zev ud치losti
             * @param {function} callback - Callback funkce
             * @returns {function} Unsubscribe funkce
             */
            on(event, callback) {
                if (!this.events[event]) {
                    this.events[event] = [];
                }
                this.events[event].push(callback);
                
                // Vra콘 unsubscribe funkci
                return () => {
                    this.events[event] = this.events[event].filter(cb => cb !== callback);
                };
            },
            
            /**
             * Jednor치zov칳 poslucha캜
             */
            once(event, callback) {
                const unsubscribe = this.on(event, (...args) => {
                    unsubscribe();
                    callback(...args);
                });
                return unsubscribe;
            },
            
            /**
             * Emituje ud치lost
             * @param {string} event - N치zev ud치losti
             * @param {*} data - Data ud치losti
             */
            emit(event, data) {
                if (!this.events[event]) return;
                
                this.events[event].forEach(callback => {
                    try {
                        callback(data);
                    } catch (error) {
                        console.error(`EventBus error in "${event}":`, error);
                    }
                });
            },
            
            /**
             * Odstran칤 v코echny poslucha캜e ud치losti
             */
            off(event) {
                delete this.events[event];
            },
            
            /**
             * Debug: vyp칤코e v코echny registrovan칠 ud치losti
             */
            debug() {
                console.log('EventBus registered events:');
                Object.entries(this.events).forEach(([event, listeners]) => {
                    console.log(`  ${event}: ${listeners.length} listeners`);
                });
            }
        };
        
        // P콏eddefinovan칠 ud치losti
        const GameEvents = {
            PLAYER_DAMAGED: 'player:damaged',
            PLAYER_HEALED: 'player:healed',
            PLAYER_DEATH: 'player:death',
            PLAYER_LEVEL_UP: 'player:levelUp',
            ITEM_ADDED: 'inventory:itemAdded',
            ITEM_REMOVED: 'inventory:itemRemoved',
            MONEY_CHANGED: 'player:moneyChanged',
            COMBAT_START: 'combat:start',
            COMBAT_END: 'combat:end',
            QUEST_COMPLETE: 'quest:complete',
            ACHIEVEMENT_UNLOCKED: 'achievement:unlocked',
            SAVE_GAME: 'game:save',
            LOAD_GAME: 'game:load'
        };
        
        Object.freeze(GameEvents);
        
        // === RATE LIMITER ===
        // Prevence p콏칤li코 캜ast칳ch API/Firebase vol치n칤
        const RateLimiter = {
            limits: {},
            
            /**
             * Kontroluje zda lze prov칠st akci
             * @param {string} key - Unik치tn칤 kl칤캜 akce
             * @param {number} cooldownMs - Minim치ln칤 interval mezi akcemi v ms
             * @returns {boolean} true pokud lze prov칠st, false pokud je v cooldownu
             */
            canProceed(key, cooldownMs) {
                const now = Date.now();
                const lastTime = this.limits[key] || 0;
                
                if (now - lastTime < cooldownMs) {
                    return false;
                }
                
                this.limits[key] = now;
                return true;
            },
            
            /**
             * 캛as zb칳vaj칤c칤 do konce cooldownu
             * @param {string} key - Unik치tn칤 kl칤캜 akce
             * @param {number} cooldownMs - Cooldown v ms
             * @returns {number} Zb칳vaj칤c칤 캜as v ms (0 pokud lze prov칠st)
             */
            getRemaining(key, cooldownMs) {
                const now = Date.now();
                const lastTime = this.limits[key] || 0;
                const remaining = cooldownMs - (now - lastTime);
                return Math.max(0, remaining);
            },
            
            /**
             * Resetuje cooldown pro dan칳 kl칤캜
             */
            reset(key) {
                delete this.limits[key];
            },
            
            /**
             * Wrapper pro funkci s rate limitingem
             * @param {string} key - Unik치tn칤 kl칤캜
             * @param {number} cooldownMs - Cooldown v ms
             * @param {function} fn - Funkce k proveden칤
             * @param {function} onBlocked - Callback p콏i blokov치n칤 (optional)
             */
            wrap(key, cooldownMs, fn, onBlocked) {
                return (...args) => {
                    if (!this.canProceed(key, cooldownMs)) {
                        const remaining = this.getRemaining(key, cooldownMs);
                        console.log(`낍 Rate limited: ${key} (${Math.ceil(remaining/1000)}s remaining)`);
                        if (onBlocked) onBlocked(remaining);
                        return;
                    }
                    return fn(...args);
                };
            }
        };
        
        // === V칈CEJAZY캛N칗 SYST칄M ===
        const currentLang = 'cs';
        
        const TRANSLATIONS = {
            // === 캛ETINA ===
            cs: {
                // UI - Hlavn칤 navigace
                ui: {
                    play: 'Hr치t',
                    inventory: 'V칳bava',
                    map: 'Mapa',
                    settlement: 'Osada',
                    craft: 'Craft',
                    quests: 'Questy',
                    settings: 'Nastaven칤',
                    close: 'Zav콏칤t',
                    back: 'Zp캩t',
                    next: 'Dal코칤',
                    confirm: 'Potvrdit',
                    cancel: 'Zru코it',
                    save: 'Ulo쬴t',
                    load: 'Na캜칤st',
                    yes: 'Ano',
                    no: 'Ne',
                    ok: 'OK',
                    buy: 'Koupit',
                    sell: 'Prodat',
                    use: 'Pou쮂셦',
                    equip: 'Vyzbrojit',
                    unequip: 'Odlo쬴t',
                    drop: 'Zahodit',
                    repair: 'Opravit',
                    upgrade: 'Vylep코it',
                    travel: 'Cestovat',
                    rest: 'Odpo캜칤vat',
                    search: 'Hledat',
                    attack: '칔tok',
                    defend: 'Obrana',
                    flee: '칔t캩k',
                    skip: 'P콏esko캜it',
                    // Nov칠 kl칤캜e pro invent치콏
                    items: 'P콏edm캩ty',
                    capacity: 'Kapacita',
                    sleep: 'Sp치nek',
                    poison: 'Jed',
                    fire: 'Ohe켿',
                    bow: 'Luk',
                    crossbowAmmo: '말pky',
                    pistolAmmo: '9mm n치boje',
                    rifleAmmo: '5.56 n치boje',
                    sniperAmmo: '7.62 n치boje',
                    shotgunAmmo: 'Broky',
                    flameAmmo: 'Palivo',
                    ammo: 'Munice',
                    readStatus: 'P콏e캜teno',
                    unread: 'Nep콏e캜teno',
                    read: '캛칤st',
                    survivor: 'P콏e쬴v코칤',
                    look: 'Vzhled',
                    skills: 'Dovednosti'
                },
                // Statistiky
                stats: {
                    health: 'Zdrav칤',
                    hunger: 'Hlad',
                    thirst: '콯칤ze켿',
                    radiation: 'Radiace',
                    energy: 'Energie',
                    level: 'Level',
                    exp: 'Zku코enosti',
                    money: 'Pen칤ze',
                    damage: 'Po코kozen칤',
                    defense: 'Obrana',
                    day: 'Den',
                    time: '캛as'
                },
                // Atributy
                attrs: {
                    str: 'S칤la',
                    end: 'V칳dr',
                    agi: 'Obratnost',
                    int: 'Inteligence',
                    per: 'Vn칤m치n칤',
                    cha: 'Charisma',
                    lck: '맚캩st칤'
                },
                // Vytv치콏en칤 postavy
                charCreate: {
                    title: 'Vytvo콏en칤 Postavy',
                    name: 'Jm칠no',
                    gender: 'Pohlav칤',
                    class: 'Povol치n칤',
                    attributes: 'Atributy',
                    pointsLeft: 'Zb칳vaj칤c칤 body',
                    startGame: 'Za캜칤t hru',
                    whatIsThis: 'Co je to za hru?',
                    male: 'Mu',
                    female: '콯ena'
                },
                // Invent치콏
                inv: {
                    title: 'Invent치콏',
                    equipment: 'Vybaven칤',
                    resources: 'Suroviny',
                    consumables: 'Spot콏ebn칤',
                    weapons: 'Zbran캩',
                    armor: 'Zbroj',
                    weight: 'V치ha',
                    empty: 'Pr치zdn칳 invent치콏',
                    equipped: 'Vybaveno'
                },
                // Mapa
                mapUI: {
                    title: 'Mapa sv캩ta',
                    yourPosition: 'Tv치 pozice',
                    destination: 'C칤l',
                    distance: 'Vzd치lenost',
                    travelTime: '캛as cesty',
                    goHere: 'J칤t sem',
                    exploring: 'Prozkoum치v치n칤...',
                    discovered: 'Objeveno',
                    unknown: 'Nezn치m칠'
                },
                // Osada
                settlementUI: {
                    title: 'Osada',
                    buildings: 'Budovy',
                    settlers: 'Osadn칤ci',
                    resources: 'Z치soby',
                    defense: 'Obrana',
                    morale: 'Mor치lka',
                    prosperity: 'Prosperita',
                    build: 'Stav캩t',
                    hire: 'Najmout',
                    storage: 'Sklad',
                    food: 'J칤dlo',
                    water: 'Voda',
                    power: 'Energie',
                    maintenance: '칔dr쬭a',
                    income: 'P콏칤jem',
                    population: 'Obyvatel칠'
                },
                // Crafting
                craftUI: {
                    title: 'V칳roba',
                    recipes: 'Recepty',
                    materials: 'Materi치ly',
                    craft: 'Vyrobit',
                    required: 'Pot콏eba',
                    result: 'V칳sledek'
                },
                // Boj
                combat: {
                    title: 'Boj',
                    yourTurn: 'Tv칠 kolo',
                    enemyTurn: 'Kolo nep콏칤tele',
                    victory: 'V칤t캩zstv칤!',
                    defeat: 'Prohra!',
                    flee: '칔t캩k!',
                    actions: 'Akce',
                    actionsLeft: 'Zb칳v치 akc칤',
                    move: 'Pohyb',
                    attack: '칔tok',
                    defend: 'Obrana',
                    item: 'P콏edm캩t',
                    swap: 'Vym캩nit zbra켿',
                    range: 'Dosah',
                    melee: 'Na bl칤zko',
                    ranged: 'Na d치lku',
                    ammo: 'Munice',
                    critical: 'Kritick칳 z치sah!',
                    miss: 'Minul!',
                    blocked: 'Zablokov치no!',
                    round: 'Kolo'
                },
                // Spole캜n칤ci
                companions: {
                    title: 'Spole캜n칤ci',
                    loyalty: 'Loajalita',
                    feed: 'Nakrmit',
                    water: 'Napojit',
                    dismiss: 'Propustit',
                    stats: 'Statistiky',
                    abilities: 'Schopnosti',
                    hungry: 'Hladov칳',
                    thirsty: '콯칤zniv칳',
                    happy: 'Spokojen칳',
                    // Jm칠na spole캜n칤k콢
                    dog: 'V캩rn칳 pes',
                    cat: 'Mazan치 ko캜ka',
                    crow: 'Bystr칳 havran',
                    scout: 'Zv캩d',
                    medic_npc: 'Poln칤 medik',
                    warrior: 'V치le캜n칤k',
                    trader_npc: 'Obchodn칤k',
                    engineer_npc: 'Technik',
                    // Schopnosti
                    sniffing: '캛much치n칤',
                    mousing: 'My코ilov',
                    scouting: 'Pr콢zkum',
                    quickScout: 'Rychl칳 pr콢zkum',
                    healing: 'L칠캜en칤',
                    fighter: 'Bojovn칤k',
                    bargaining: 'Smlouv치n칤',
                    repairs: 'Opravy'
                },
                // Questy
                questsUI: {
                    title: '칔koly',
                    active: 'Aktivn칤',
                    completed: 'Dokon캜en칠',
                    daily: 'Denn칤',
                    main: 'Hlavn칤',
                    side: 'Vedlej코칤',
                    reward: 'Odm캩na',
                    progress: 'Postup',
                    accept: 'P콏ijmout',
                    abandon: 'Vzd치t se'
                },
                // Obecn칠
                general: {
                    loading: 'Na캜칤t치n칤...',
                    saving: 'Ukl치d치n칤...',
                    error: 'Chyba',
                    success: '칔sp캩ch',
                    warning: 'Varov치n칤',
                    info: 'Info',
                    notEnough: 'Nedostatek',
                    full: 'Pln칳',
                    empty: 'Pr치zdn칳',
                    locked: 'Zam캜eno',
                    unlocked: 'Odem캜eno',
                    new: 'Nov칠',
                    rare: 'Vz치cn칠',
                    common: 'B캩쬹칠',
                    epic: 'Epick칠',
                    legendary: 'Legend치rn칤'
                },
                // Tutorial
                tutorial: {
                    welcome: 'V칤tej v pustin캩!',
                    skip: 'P콏esko캜it tutorial',
                    finish: 'Dokon캜it',
                    tip: 'Tip'
                },
                // 캛as
                time: {
                    morning: 'R치no',
                    day: 'Den',
                    evening: 'Ve캜er',
                    night: 'Noc',
                    dawn: '칔svit',
                    dusk: 'Soumrak'
                },
                // Povol치n칤
                classes: {
                    raider: { name: 'N치jezdn칤k', desc: 'Brut치ln칤 bojovn칤k z pustiny', ability: '+25% damage v boji' },
                    berserker: { name: 'Berserkr', desc: '먞셟en칳 v치le캜n칤k bez strachu', ability: '+40% damage, -25% obrana' },
                    survivor: { name: 'P콏e쬴v코칤', desc: 'Otrl칳 veter치n apokalypsy', ability: '+50 max HP' },
                    tank: { name: 'Tank', desc: 'Nepr콢st콏eln치 ze캞 masa', ability: '+80 max HP, -15% rychlost' },
                    stalker: { name: 'Stopa콏', desc: 'Tich칳 lovec st칤n콢', ability: '-30% spot콏eba zdroj콢' },
                    assassin: { name: 'Assassin', desc: 'Mistr rychl칳ch zabit칤', ability: '+40% crit 코ance' },
                    medic: { name: 'Poln칤 Medik', desc: 'Expert na p콏e쬴t칤 a l칠캜bu', ability: 'L칠캜iva +50% efektivn캩j코칤' },
                    alchemist: { name: 'Alchymista', desc: 'Mistr lektvar콢 a jed콢', ability: 'Lektvary +100% efekt' },
                    scavenger: { name: 'Sb캩ra캜', desc: 'Specialista na hled치n칤 zdroj콢', ability: '+50% 코ance naj칤t p콏edm캩ty' },
                    hunter: { name: 'Lovec', desc: 'Mistr lovu a p콏칤rody', ability: '+100% loot ze zv칤콏at' },
                    engineer: { name: 'Mechanik', desc: 'Technik a vyn치lezce', ability: 'Crafting -50% surovin' },
                    demolitionist: { name: 'Demoli캜치콏', desc: 'Expert na v칳bu코niny', ability: 'V칳buchy +100% damage' },
                    trader: { name: 'Obchodn칤k', desc: 'Charismatick칳 dealer', ability: '-30% ceny v obchodech' },
                    nomad: { name: 'Nom치d', desc: 'Pou코tn칤 tul치k', ability: '-5% 캜as cestov치n칤' },
                    mutant: { name: 'Mutant', desc: 'Ob콏칤 zmutovan칳 p콏e쬴v코칤', ability: 'Imunn칤 na radiaci' },
                    psychic: { name: 'Psychik', desc: 'Ment치ln칤 schopnosti', ability: 'Vid칤코 skryt칠 lokace na map캩' }
                },
                // Nep콏치tel칠
                enemies: {
                    dog: 'Divok칳 pes', rat: 'Ob콏칤 krysa', snake: 'Jedovat칳 had', wolf: 'Vlk',
                    raider: 'N치jezdn칤k', bandit: 'Bandita', thief: 'Zlod캩j', marauder: 'Maraud칠r',
                    ghoul: 'Gh칰l', zombie: 'Zombie', crawler: 'Plazivec',
                    mutant: 'Mutant', abomination: 'Zr콢da', beast: 'Bestie',
                    robot: 'Robot', drone: 'Dron', turret: 'V캩쬴캜ka',
                    boss: 'Boss', warlord: 'V치le캜n칤k', alpha: 'Alfa'
                },
                // Lokace
                locations: {
                    shelter: '칔kryt', settlement: 'Osada', city: 'M캩sto', village: 'Vesnice',
                    ruins: 'Ruiny', bunker: 'Bunkr', factory: 'Tov치rna', hospital: 'Nemocnice',
                    forest: 'Les', desert: 'Pou코콘', mountains: 'Hory', swamp: 'Ba쬴na',
                    lake: 'Jezero', river: '콎eka', bridge: 'Most', road: 'Silnice',
                    cave: 'Jeskyn캩', mine: 'D콢l', military: 'Vojensk치 z치kladna', lab: 'Laborato콏',
                    trader: 'Obchodn칤k', casino: 'Kasino', arena: 'Ar칠na', church: 'Kostel'
                },
                // Budovy
                buildings: {
                    bed: 'L콢쬶o', firepit: 'Ohni코t캩', garden: 'Zahrada', water: 'Sb캩ra캜 vody',
                    workshop: 'D칤lna', storage: 'Sklad', well: 'Studna', farmland: 'Pole',
                    infirmary: 'O코et콏ovna', kitchen: 'Kuchy켿', wall: 'Hradby', tower: 'Str치쬹칤 v캩',
                    market: 'Tr쬴코t캩', barracks: 'Kas치rny', forge: 'Kov치rna', training: 'Cvi캜i코t캩',
                    armory: 'Zbrojnice', tavern: 'Hospoda', chapel: 'Kaple', generator: 'Gener치tor',
                    solar: 'Sol치rn칤 panely', purifier: '캛isti캜ka vody', hydrofarm: 'Hydroponick치 farma',
                    reactor: 'Reaktor', medbay: 'Zdravotn칤 st콏edisko', turret: 'Automatick치 v캩',
                    university: 'Univerzita', monument: 'Monument'
                },
                // Osadn칤ci
                settlers: {
                    farmer: 'Farm치콏', guard: 'Str치쬮e', scavenger: 'Sb캩ra캜', medic: 'Medik',
                    builder: 'Stavitel', blacksmith: 'Kov치콏', cook: 'Kucha콏', scout: 'Zv캩d',
                    trader: 'Obchodn칤k', alchemist: 'Alchymista', hunter: 'Lovec', waterCarrier: 'Nosi캜 vody'
                },
                // Suroviny
                resources: {
                    wood: 'D콏evo', metal: 'Kov', stone: 'K치men', cloth: 'L치tka',
                    herbs: 'Byliny', chemicals: 'Chemik치lie', electronics: 'Elektronika',
                    glass: 'Sklo', scrap: 'rot', fuel: 'Palivo', leather: 'K콢쬰',
                    rope: 'Lano', gunpowder: 'St콏eln칳 prach', copper: 'M캩캞', silver: 'St콏칤bro',
                    gold: 'Zlato', gems: 'Drahokamy', crystal: 'Krystal', acid: 'Kyselina'
                },
                // Obecn칠 hern칤 texty
                game: {
                    newGame: 'Nov치 hra',
                    loadGame: 'Na캜칤st hru',
                    saveGame: 'Ulo쬴t hru',
                    continue: 'Pokra캜ovat',
                    options: 'Mo쬹osti',
                    quit: 'Ukon캜it',
                    paused: 'Pozastaveno',
                    gameOver: 'Konec hry',
                    youDied: 'Zem콏el jsi',
                    youWon: 'Vyhr치l jsi',
                    restart: 'Znovu',
                    mainMenu: 'Hlavn칤 menu'
                },
                // Notifikace
                notifications: {
                    saved: 'Hra ulo쬰na',
                    loaded: 'Hra na캜tena',
                    levelUp: 'Level Up!',
                    newQuest: 'Nov칳 칰kol',
                    questComplete: '칔kol spln캩n',
                    itemFound: 'P콏edm캩t nalezen',
                    notEnoughMoney: 'Nedostatek pen캩z',
                    notEnoughResources: 'Nedostatek surovin',
                    inventoryFull: 'Pln칳 invent치콏',
                    equipped: 'Vybaveno',
                    unequipped: 'Odlo쬰no',
                    repaired: 'Opraveno',
                    crafted: 'Vyrobeno',
                    sold: 'Prod치no',
                    bought: 'Koupeno'
                },
                // Detailn칤 UI texty
                uiDetail: {
                    newGame: 'Nov치 hra',
                    continueGame: 'Pokra캜ovat',
                    loadGame: 'Na캜칤st hru',
                    settings: 'Nastaven칤',
                    emptySlot: 'Pr치zdn칳 slot',
                    durability: 'Odolnost',
                    damage: 'Po코kozen칤',
                    defense: 'Obrana',
                    weight: 'V치ha',
                    value: 'Hodnota',
                    quantity: 'Mno쬽tv칤',
                    unexplored: 'Neprozkoum치no',
                    explored: 'Prozkoum치no',
                    currentLocation: 'Aktu치ln칤 pozice',
                    travelTo: 'Cestovat do',
                    distance: 'Vzd치lenost',
                    travelTime: '캛as cesty',
                    danger: 'Nebezpe캜칤',
                    buildCost: 'Cena stavby',
                    upgradeLevel: '칔rove켿 vylep코en칤',
                    production: 'Produkce',
                    consumption: 'Spot콏eba',
                    storageCapacity: 'Kapacita skladu',
                    defenseValue: 'Hodnota obrany',
                    moraleBonus: 'Bonus mor치lky',
                    ingredients: 'Ingredience',
                    craftTime: '캛as v칳roby',
                    successChance: '마nce na 칰sp캩ch',
                    yourHP: 'Tv칠 HP',
                    enemyHP: 'HP nep콏칤tele',
                    round: 'Kolo',
                    actionsRemaining: 'Zb칳vaj칤c칤 akce',
                    weaponRange: 'Dosah zbran캩',
                    ammoLeft: 'Zb칳v치 munice',
                    dawn: '칔svit',
                    day: 'Den',
                    dusk: 'Soumrak',
                    night: 'Noc',
                    morning: 'R치no',
                    evening: 'Ve캜er',
                    weather: 'Po캜as칤',
                    clear: 'Jasno',
                    rain: 'D칠코콘',
                    storm: 'Bou콏ka',
                    fog: 'Mlha',
                    perDay: 'denn캩',
                    perHour: 'za hodinu',
                    seconds: 'sekund',
                    minutes: 'minut',
                    hours: 'hodin',
                    days: 'dn칤',
                    km: 'km',
                    kg: 'kg'
                },
                dialogs: {
                    confirmDelete: 'Opravdu chce코 smazat?',
                    confirmSell: 'Prodat tento p콏edm캩t?',
                    confirmBuy: 'Koupit tento p콏edm캩t?',
                    confirmTravel: 'Cestovat na toto m칤sto?',
                    confirmRest: 'Odpo캜칤vat zde?',
                    confirmDismiss: 'Propustit tohoto spole캜n칤ka?',
                    confirmAbandon: 'Vzd치t se tohoto 칰kolu?',
                    gameOverText: 'Zem콏el jsi. Pustina si vy쮂멳ala dal코칤 ob캩콘.',
                    restartPrompt: 'Za캜칤t novou hru?',
                    noAmmo: '콯치dn치 munice!',
                    tooHeavy: 'P콏칤li코 t캩쬶칠 na nesen칤!',
                    cantAfford: 'Na tohle nem치코 pen칤ze!',
                    inventoryFull: 'Invent치콏 je pln칳!',
                    questAccepted: '칔kol p콏ijat!',
                    questCompleted: '칔kol spln캩n!',
                    levelUp: 'Level up! Tv치 nov치 칰rove켿 je',
                    newAbility: 'Odem캜ena nov치 schopnost!',
                    companionJoined: 'se p콏idal k tv칠 skupin캩!',
                    companionLeft: 'opustil tvou skupinu.',
                    itemFound: 'Na코el jsi:',
                    enemyDefeated: 'Nep콏칤tel pora쬰n!',
                    youFled: 'Utekl jsi z boje!',
                    enemyFled: 'Nep콏칤tel utekl!',
                    resting: 'Odpo캜칤v치코...',
                    traveling: 'Cestuje코...',
                    exploring: 'Prozkoum치v치코...',
                    crafting: 'Vyr치b칤코...',
                    building: 'Stav칤코...',
                    repairing: 'Opravuje코...'
                },
                // Denn칤 questy
                dailyQuests: {
                    kill_enemies: { name: 'Lovec', desc: 'Zabij 3 nep콏치tele' },
                    kill_many: { name: 'Vyhlazova캜', desc: 'Zabij 8 nep콏치tel' },
                    explore_hexes: { name: 'Pr콢zkumn칤k', desc: 'Objevuj 2 nov칠 lokace' },
                    collect_money: { name: 'Sb캩ratel', desc: 'Z칤skej 150 pen캩z' },
                    collect_loot: { name: 'Hleda캜', desc: 'Najdi 5 p콏edm캩t콢' },
                    craft_items: { name: '콎emesln칤k', desc: 'Vyrob 2 v캩ci' },
                    cook_food: { name: 'Kucha콏', desc: 'Upe캜/uva콏 3 j칤dla' },
                    trade_items: { name: 'Obchodn칤k', desc: 'Prodej 3 v캩ci' },
                    buy_items: { name: 'N치kup캜칤', desc: 'Kup 2 v캩ci' },
                    feed_companion: { name: 'Krmitel', desc: 'Nakrm spole캜n칤ka' },
                    heal_self: { name: 'P콏e쬴v코칤', desc: 'Vyl칠캜 se 50 HP' }
                },
                events: {
                    ambush: 'P콏epaden칤!',
                    found: 'Nalezeno!',
                    discovery: 'Objev!',
                    encounter: 'Setk치n칤!',
                    danger: 'Nebezpe캜칤!',
                    success: '칔sp캩ch!',
                    failure: 'Selh치n칤!',
                    reward: 'Odm캩na',
                    choice: 'Vyber si:',
                    accept: 'P콏ijmout',
                    decline: 'Odm칤tnout',
                    fight: 'Bojovat',
                    run: 'Ut칠ct',
                    negotiate: 'Vyjedn치vat',
                    search: 'Prohledat',
                    rest: 'Odpo캜칤vat',
                    continue: 'Pokra캜ovat'
                },
            },
            
        };
        
        // Lokalizace n치zv콢 lokac칤
        // Funkce pro z칤sk치n칤 lokalizovan칠ho n치zvu t콏칤dy (pouze 캜e코tina)
        function getClassName(classId) {
            return CLASSES[classId]?.name || classId;
        }
        
        function getClassDesc(classId) {
            return CLASSES[classId]?.desc || '';
        }
        
        function getClassAbility(classId) {
            return CLASSES[classId]?.ability || '';
        }
        
        function getClassPassive(classId) {
            return CLASSES[classId]?.passive || '';
        }
        
        // P콏eklady po캜as칤
        // Funkce pro po캜as칤 (pouze 캜e코tina)
        function getWeatherName(weatherId) {
            const w = WEATHER_TYPES?.find(w => w.id === weatherId);
            return w?.name || weatherId;
        }
        
        function getWeatherDesc(weatherId) {
            const w = WEATHER_TYPES?.find(w => w.id === weatherId);
            return w?.desc || '';
        }
        
        // Funkce pro spole캜n칤ky (pouze 캜e코tina)
        function getCompanionName(companionId) {
            const c = COMPANIONS?.find(c => c.id === companionId);
            return c?.name || companionId;
        }
        
        // P콏eklady p콏edm캩t콢
        // P콏eklady p콏edm캩t콢 - pouze 캜e코tina, bereme p콏칤mo z ITEMS
        function getItemName(itemIdOrItem) {
            // Pokud je to objekt s id, pou쬴j id
            const itemId = typeof itemIdOrItem === 'object' ? itemIdOrItem?.id : itemIdOrItem;
            const item = ITEMS?.find(i => i.id === itemId);
            
            // Vra콘 캜esk칠 jm칠no z ITEMS pokud existuje
            if (item?.name) return item.name;
            
            // Fallback - pokud byl p콏ed치n objekt, vra콘 jeho name
            if (typeof itemIdOrItem === 'object' && itemIdOrItem?.name) {
                return itemIdOrItem.name;
            }
            
            // Posledn칤 fallback - vra콘 ID
            return itemId || 'Nezn치m칳 p콏edm캩t';
        }
        
        // Kontrola jestli je item vybaven
        function isItemEquipped(item) {
            if (!item || !state.equipped) return false;
            
            // Najdi index itemu v invent치콏i
            const itemIndex = state.inv.indexOf(item);
            
            // Pomocn치 funkce - kontrola jestli equipped item je stejn칳 objekt (reference)
            // NEBO je to stejn칳 index v invent치콏i (pro p콏칤pad po load)
            const isEquippedItem = (equippedItem) => {
                if (!equippedItem) return false;
                if (equippedItem === item) return true; // P콏칤m치 reference
                // Po load: equipped item by m캩l b칳t propojen칳 s inv, tak쬰 kontroluj index
                const equippedIndex = state.inv.indexOf(equippedItem);
                return equippedIndex !== -1 && equippedIndex === itemIndex;
            };
            
            // Kontrola v코ech slot콢
            if (isEquippedItem(state.equipped.weapon)) return true;
            if (isEquippedItem(state.equipped.armor)) return true;
            if (isEquippedItem(state.equipped.helmet)) return true;
            if (isEquippedItem(state.equipped.gloves)) return true;
            if (isEquippedItem(state.equipped.boots)) return true;
            
            // Kontrola accessory (accessory se ukl치d치 jako ID, ne jako reference)
            if (item.type === 'accessory' && state.equippedAccessory === item.id) return true;
            
            return false;
        }
        
        // NPC jm칠na - p콏칤mo z definice
        function getNpcName(npcId) {
            // Pro b캩쬹칠 NPC se jm칠na berou p콏칤mo z k칩du kde jsou definov치na
            return npcId;
        }
        
        // Quest popisy - p콏칤mo z MAIN_QUESTS
        function getQuestDesc(questId) {
            const quest = MAIN_QUESTS?.find(q => q.id === questId);
            return quest?.description || '';
        }
        
        // Enemy jm칠na - p콏칤mo z ENEMIES
        function getEnemyName(enemyId) {
            const enemy = ENEMIES?.find(e => e.id === enemyId);
            return enemy?.name || enemyId;
        }
        
        // Skill jm칠na - p콏칤mo z definice
        function getSkillName(skillId) {
            for (const branch of Object.values(SKILL_TREE || {})) {
                const skill = branch.skills?.find(s => s.id === skillId);
                if (skill) return skill.name;
            }
            return skillId;
        }
        
        function getSkillBranchName(branchId) {
            return SKILL_TREE?.[branchId]?.name || branchId;
        }
        
        // Mutation jm칠na - p콏칤mo z MUTATIONS
        function getMutationName(mutationId) {
            const mutation = MUTATIONS?.find(m => m.id === mutationId);
            return mutation?.name || mutationId;
        }
        
        function getMutationDesc(mutationId) {
            const mutation = MUTATIONS?.find(m => m.id === mutationId);
            return mutation?.desc || '';
        }
        
        // Z칤sk치n칤 bonus콢 z aktivn칤ch mutac칤
        function getMutationBonuses() {
            const bonuses = {
                defense: 0,
                dodgeChance: 0,
                maxHp: 0,
                damageBonus: 0,
                damageTaken: 0,
                healRate: 0,
                radResist: 0,
                str: 0,
                agi: 0,
                int: 0,
                perception: 0,
                travelSpeed: 0,
                speed: 0,
                hungerRate: 0,
                energyDrain: 0
            };
            
            if (!state.mutations || state.mutations.length === 0) return bonuses;
            
            state.mutations.forEach(mutId => {
                const mutation = MUTATIONS?.find(m => m.id === mutId);
                if (mutation?.effect) {
                    Object.entries(mutation.effect).forEach(([key, value]) => {
                        if (typeof value === 'number' && bonuses.hasOwnProperty(key)) {
                            bonuses[key] += value;
                        }
                    });
                }
            });
            
            return bonuses;
        }
        
        // Faction jm칠na - p콏칤mo z FACTIONS
        function getFactionName(factionId) {
            const faction = FACTIONS?.find(f => f.id === factionId);
            return faction?.name || factionId;
        }
        
        function getFactionDesc(factionId) {
            const f = FACTIONS?.find(f => f.id === factionId);
            return f?.desc || '';
        }
        
        // Event jm칠na - p콏칤mo z SETTLEMENT_EVENTS
        function getEventName(eventId) {
            const evt = SETTLEMENT_EVENTS?.find(e => e.id === eventId);
            return evt?.name || eventId;
        }
        
        function getEventDesc(eventId) {
            const evt = SETTLEMENT_EVENTS?.find(e => e.id === eventId);
            return evt?.desc || '';
        }
        
        // Dungeon jm칠na - p콏칤mo z definice
        function getDungeonName(dungeonId) {
            return dungeonId;
        }
        
        // Achievement jm칠na - p콏칤mo z ACHIEVEMENTS
        function getAchievementName(achId) {
            const ach = ACHIEVEMENTS?.find(a => a.id === achId);
            return ach?.name || achId;
        }
        
        function getAchievementDesc(achId) {
            const ach = ACHIEVEMENTS?.find(a => a.id === achId);
            return ach?.desc || '';
        }
        
        // Resource jm칠na - p콏칤mo z RESOURCES
        function getResourceName(resourceId) {
            const res = RESOURCES?.find(r => r.id === resourceId);
            return res?.name || resourceId;
        }
        
        // Building jm칠na - p콏칤mo z BUILDINGS
        function getBuildingName(buildingId) {
            const building = BUILDINGS?.find(b => b.id === buildingId);
            return building?.name || buildingId;
        }
        
        function getBuildingDesc(buildingId) {
            const building = BUILDINGS?.find(b => b.id === buildingId);
            return building?.desc || '';
        }
        
        // Funkce pro t() - p콏eklad text콢
        function t(category, key) {
            return TRANSLATIONS?.cs?.[category]?.[key] || key;
        }
        
        // Zkratka pro UI p콏eklady
        function ui(key) {
            return t('ui', key);
        }
        
        function hasTranslation(category, key) {
            return TRANSLATIONS?.cs?.[category]?.[key] !== undefined;
        }
        
        // Funkce pro z칤sk치n칤 aktu치ln칤ho jazyka
        function getLanguage() {
            return 'cs';
        }

        // === SAFE AREA DETECTION PRO MOBILY ===
        (function() {
            // Detekce v칳코ky syst칠mov칠 navigace
            function updateSafeArea() {
                var root = document.documentElement;
                
                // Zkus z칤skat safe-area-inset-bottom
                var safeBottom = parseInt(getComputedStyle(root).getPropertyValue('--sab') || '0');
                
                // Pokud CSS env() nefunguje, pou쬴j fallback
                if (!safeBottom) {
                    // Detekce podle pom캩ru obrazovky (mobily s gesture nav maj칤 obvykle vysok칳 pom캩r)
                    var ratio = window.innerHeight / window.innerWidth;
                    if (ratio > 2) {
                        // Pravd캩podobn캩 mobil s gesture navigation
                        safeBottom = 34;
                    } else if (ratio > 1.7) {
                        safeBottom = 20;
                    } else {
                        safeBottom = 10;
                    }
                }
                
                // Nastav CSS prom캩nn칠
                root.style.setProperty('--nav-bottom-padding', (safeBottom + 10) + 'px');
                root.style.setProperty('--main-bottom-padding', (safeBottom + 80) + 'px');
            }
            
            // Spus콘 p콏i na캜ten칤 a p콏i zm캩n캩 orientace
            updateSafeArea();
            window.addEventListener('resize', updateSafeArea);
            window.addEventListener('orientationchange', updateSafeArea);
        })();
        
        // === MOBILE PUSH NOTIFICATIONS ===
        const MobileNotifications = {
            permission: 'default',
            enabled: false,
            swRegistration: null,
            
            init: function() {
                var self = this;
                
                if (!('Notification' in window)) {
                    console.log('Notifications not supported');
                    return false;
                }
                
                this.permission = Notification.permission;
                
                if (this.permission === 'granted') {
                    this.enabled = true;
                }
                
                // Registrace Service Worker pro PWA notifikace
                if ('serviceWorker' in navigator) {
                    // Vytvo콏 inline service worker
                    const swCode = `
                        self.addEventListener('push', function(event) {
                            const data = event.data ? event.data.json() : {};
                            const title = data.title || 'Survival Hero';
                            const options = {
                                body: data.body || '',
                                icon: '/icon-192.png',
                                badge: '/icon-192.png',
                                tag: data.tag || 'survival-game',
                                renotify: true,
                                vibrate: [200, 100, 200]
                            };
                            event.waitUntil(self.registration.showNotification(title, options));
                        });
                        
                        self.addEventListener('notificationclick', function(event) {
                            event.notification.close();
                            event.waitUntil(clients.openWindow('/'));
                        });
                    `;
                    
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    navigator.serviceWorker.register(swUrl, { scope: '/' })
                        .then(function(reg) {
                            self.swRegistration = reg;
                            console.log('Service Worker registered for notifications');
                        })
                        .catch(function(err) {
                            console.log('SW registration failed:', err);
                        });
                }
                
                return this.enabled;
            },
            
            requestPermission: function() {
                var self = this;
                if (!('Notification' in window)) {
                    return Promise.resolve(false);
                }
                
                return Notification.requestPermission().then(function(result) {
                    self.permission = result;
                    self.enabled = result === 'granted';
                    console.log('Notification permission:', result);
                    
                    // Test notifikace
                    if (self.enabled) {
                        setTimeout(function() {
                            self.send('九 Notifikace aktivov치ny!', {
                                body: 'Bude코 dost치vat upozorn캩n칤 i kdy nen칤 hra aktivn칤.',
                                tag: 'test-notification'
                            });
                        }, 1000);
                    }
                    
                    return self.enabled;
                }).catch(function(e) {
                    console.log('Notification permission error:', e);
                    return false;
                });
            },
            
            send: function(title, options) {
                options = options || {};
                
                // Pos칤lej i kdy je viditeln치 - pro testov치n칤
                // V produkci: if (!this.enabled || document.visibilityState === 'visible') return;
                if (!this.enabled) {
                    console.log('Notifications not enabled');
                    return;
                }
                
                console.log('Sending notification:', title);
                
                try {
                    // Zkus Service Worker notifikaci (funguje l칠pe na mobilu)
                    if (this.swRegistration) {
                        this.swRegistration.showNotification(title, {
                            body: options.body || '',
                            icon: '驕뮖잺',
                            tag: options.tag || 'survival-game',
                            renotify: options.renotify || true,
                            silent: options.silent || false,
                            vibrate: [200, 100, 200]
                        });
                        return;
                    }
                    
                    // Fallback na klasick칠 notifikace
                    var notification = new Notification(title, {
                        icon: '驕뮖잺',
                        badge: '驕뮖잺',
                        tag: options.tag || 'survival-game',
                        renotify: options.renotify || false,
                        silent: options.silent || false,
                        body: options.body || ''
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    setTimeout(function() { notification.close(); }, 5000);
                    
                    return notification;
                } catch (e) {
                    console.log('Notification error:', e);
                }
            },
            
            // Testovac칤 funkce
            test: function() {
                this.send('游빍 Test notifikace', {
                    body: 'Pokud toto vid칤코, notifikace funguj칤!',
                    tag: 'test'
                });
            },
            
            notifyCompanionHungry: function(names) {
                this.send('游냇 Hladov칤 spole캜n칤ci!', {
                    body: names + ' pot콏ebuj칤 j칤dlo a vodu!',
                    tag: 'companion-hungry',
                    renotify: true
                });
            },
            
            notifyLowHealth: function() {
                this.send('仇벒잺 Kritick칠 zdrav칤!', {
                    body: 'Tv칠 HP je velmi n칤zk칠! Vyl칠캜 se!',
                    tag: 'low-health',
                    renotify: true
                });
            },
            
            notifyLowHunger: function() {
                this.send('游꼤 Um칤r치코 hlady!', {
                    body: 'Rychle n캩co sn캩z nebo zem콏e코!',
                    tag: 'low-hunger',
                    renotify: true
                });
            },
            
            notifyLowThirst: function() {
                this.send('游눦 Um칤r치코 쮂셬n칤!', {
                    body: 'Rychle se napij nebo zem콏e코!',
                    tag: 'low-thirst',
                    renotify: true
                });
            },
            
            notifyRaid: function() {
                this.send('丘덢잺 N츼JEZD NA OSADU!', {
                    body: 'Tv치 osada je pod 칰tokem! Vra콘 se a bra켿 ji!',
                    tag: 'raid',
                    renotify: true
                });
            },
            
            notifyTravelComplete: function(locationName) {
                this.send('游딬勇 Cesta dokon캜ena!', {
                    body: 'Dorazil jsi do: ' + locationName,
                    tag: 'travel-complete'
                });
            },
            
            notifyCaravan: function() {
                this.send('游냙 Karavana dorazila!', {
                    body: 'Obchodn칤 karavana je ve tv칠 osad캩!',
                    tag: 'caravan'
                });
            },
            
            notifyNewDay: function(day) {
                this.send('游깬 Nov칳 den!', {
                    body: 'Den ' + day + ' - Spole캜n칤ci spot콏ebovali j칤dlo a vodu.',
                    tag: 'new-day'
                });
            },
            
            notifyTravelEvent: function(eventName, eventIcon) {
                this.send((eventIcon || '仇') + ' Ud치lost na cest캩!', {
                    body: eventName,
                    tag: 'travel-event',
                    renotify: true
                });
            },
            
            notifyLootFound: function(itemName, itemIcon) {
                this.send((itemIcon || '游꾸') + ' N치lez!', {
                    body: 'Na코el jsi: ' + itemName,
                    tag: 'loot-found'
                });
            },
            
            notifyCombat: function(enemyName) {
                this.send('丘덢잺 Souboj!', {
                    body: 'Narazil jsi na: ' + enemyName,
                    tag: 'combat',
                    renotify: true
                });
            }
        };
        
        // Inicializace notifikac칤
        MobileNotifications.init();
        
        // === ANTI-CHEAT SYSTEM ===
        
        // Detekce DevTools
        let devToolsOpen = false;
        const devToolsCheck = () => {
            const threshold = 160;
            const widthThreshold = window.outerWidth - window.innerWidth > threshold;
            const heightThreshold = window.outerHeight - window.innerHeight > threshold;
            
            if (widthThreshold || heightThreshold) {
                if (!devToolsOpen) {
                    devToolsOpen = true;
                    console.log('%c丘멆잺 VAROV츼N칈', 'color: red; font-size: 30px; font-weight: bold;');
                    console.log('%cTato konzole je ur캜ena pro v칳voj치콏e.', 'font-size: 16px;');
                    console.log('%cPokud v치s n캩kdo po쮂멳al, abyste sem n캩co vlo쬴li, je to podvod.', 'color: orange; font-size: 14px;');
                    console.log('%cManipulace s hrou m콢쬰 po코kodit v치코 ulo쬰n칳 postup!', 'color: red; font-size: 14px;');
                }
            } else {
                devToolsOpen = false;
            }
        };
        
        // Checksum pro kritick칠 hodnoty
        function calculateChecksum(data) {
            let hash = 0;
            const str = JSON.stringify(data);
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }
        
        // Ulo쬰n칤 checksumu p콏i zm캩n캩 stavu
        let lastValidChecksum = 0;
        let lastValidValues = {};
        
        function updateIntegrityCheck() {
            const criticalValues = {
                money: state.money,
                hp: state.char?.hp,
                maxHp: state.char?.maxHp,
                level: state.char?.level,
                xp: state.char?.xp
            };
            lastValidChecksum = calculateChecksum(criticalValues);
            lastValidValues = {...criticalValues};
        }
        
        // Kontrola integrity
        function verifyIntegrity() {
            if (!state.confirmed) return true; // P콏ed potvrzen칤m postavy nekontroluj
            
            const criticalValues = {
                money: state.money,
                hp: state.char?.hp,
                maxHp: state.char?.maxHp,
                level: state.char?.level,
                xp: state.char?.xp
            };
            
            // Detekce nerealistick칳ch hodnot
            if (state.money > 1000000) {
                console.warn('游뚿 Detekov치na anom치lie: p콏칤li코 mnoho pen캩z:', state.money);
                // Resetuj na rozumnou hodnotu (ne na 0!)
                const safeValue = lastValidValues.money && lastValidValues.money < 1000000 
                    ? lastValidValues.money 
                    : 10000; // Fallback na 10k
                console.warn('游댢 Pen칤ze opraveny na:', safeValue);
                state.money = safeValue;
                return false;
            }
            
            if (state.char?.hp > state.char?.maxHp * 2) {
                console.warn('游뚿 Detekov치na anom치lie: p콏칤li코 mnoho HP');
                state.char.hp = state.char.maxHp;
                return false;
            }
            
            if (state.char?.level > 100) {
                console.warn('游뚿 Detekov치na anom치lie: p콏칤li코 vysok칳 level');
                state.char.level = lastValidValues.level || 1;
                return false;
            }
            
            return true;
        }
        
        // 말frov치n칤 pro localStorage (s podporou Unicode)
        const encKey = 'P0st4p0_S3cr3t_K3y_2024!';
        
        function encryptData(data) {
            try {
                const str = JSON.stringify(data);
                // Pou쬴j base64 bez XOR pro kompatibilitu
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                console.error('Encrypt error:', e);
                return null;
            }
        }
        
        function decryptData(encrypted) {
            try {
                const str = decodeURIComponent(escape(atob(encrypted)));
                return JSON.parse(str);
            } catch (e) {
                console.error('Decrypt error:', e);
                return null;
            }
        }
        
        // === KONTROLA RE츼LN칄HO 캛ASU ===
        async function verifyRealTime() {
            const localTime = Date.now();
            const lastSaveTime = state.lastSaveTime || 0;
            const gameStartTime = state.time?.realStart || localTime;
            
            // 1. Kontrola zda lok치ln칤 캜as nen칤 v minulosti oproti ulo쬰n칤
            if (lastSaveTime > 0 && localTime < lastSaveTime - 60000) {
                // Lok치ln칤 캜as je v칤c ne 1 minutu v minulosti = podez콏el칠
                console.warn('丘멆잺 Podez콏el칳 캜as: lok치ln칤 캜as je star코칤 ne posledn칤 save');
                showTimeWarning('past', lastSaveTime - localTime);
                return;
            }
            
            // 2. Kontrola zda 캜as nesko캜il p콏칤li코 dop콏edu (v칤c ne 7 dn칤)
            const timeSinceLastSave = localTime - lastSaveTime;
            if (lastSaveTime > 0 && timeSinceLastSave > 7 * 24 * 60 * 60 * 1000) {
                console.warn('丘멆잺 Dlouh치 prodleva od posledn칤ho ulo쬰n칤:', Math.floor(timeSinceLastSave / (24*60*60*1000)), 'dn칤');
                // Toto je OK - hr치캜 jen dlouho nehr치l
            }
            
            // 3. Zkus ov캩콏it 캜as online (pokud je dostupn칠 Firebase)
            if (typeof firebaseDB !== 'undefined' && firebaseDB) {
                try {
                    const serverTimeRef = await firebaseDB.ref('.info/serverTimeOffset').once('value');
                    const offset = serverTimeRef.val() || 0;
                    const serverTime = localTime + offset;
                    
                    // Pokud je rozd칤l v캩t코칤 ne 5 minut, varuj
                    if (Math.abs(offset) > 5 * 60 * 1000) {
                        console.warn('丘멆잺 Rozd칤l mezi lok치ln칤m a serverov칳m 캜asem:', Math.round(offset / 60000), 'minut');
                        
                        // Ulo spr치vn칳 offset pro pozd캩j코칤 pou쬴t칤
                        state.serverTimeOffset = offset;
                    }
                    
                    console.log('九 캛as ov캩콏en: lok치ln칤=' + new Date(localTime).toLocaleTimeString() + 
                                ', server=' + new Date(serverTime).toLocaleTimeString() + 
                                ', offset=' + Math.round(offset/1000) + 's');
                } catch (e) {
                    console.log('좶잺 Nelze ov캩콏it serverov칳 캜as (offline?)');
                }
            }
        }
        
        function showTimeWarning(type, diff) {
            const diffMins = Math.abs(Math.round(diff / 60000));
            const diffHours = Math.round(diffMins / 60);
            
            let message = '';
            if (type === 'past') {
                message = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">낋</div>
                        <h3 style="color: #f44336;">Probl칠m s 캜asem!</h3>
                        <p style="color: #888;">캛as tv칠ho za콏칤zen칤 je <strong>${diffHours > 0 ? diffHours + ' hodin' : diffMins + ' minut'}</strong> v minulosti oproti posledn칤mu ulo쬰n칤.</p>
                        <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #f44336;">
                            <p style="color: #ff9800; margin: 0; font-size: 0.9rem;">丘멆잺 Mo쬹칠 p콏칤캜iny:</p>
                            <ul style="color: #888; text-align: left; margin: 0.5rem 0 0 1rem; font-size: 0.85rem;">
                                <li>맗atn캩 nastaven칳 캜as za콏칤zen칤</li>
                                <li>Zm캩na 캜asov칠ho p치sma</li>
                                <li>N캩kdo jin칳 hr치l na tv칠m 칰캜tu</li>
                            </ul>
                        </div>
                        <p style="color: #888; font-size: 0.85rem;">Pros칤m zkontroluj nastaven칤 캜asu na sv칠m za콏칤zen칤.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; background: #4CAF50;">OK, rozum칤m</button>
                `;
            }
            
            if (message) {
                showModal('낋 Varov치n칤', message);
            }
        }
        
        // Inicializace anti-cheat syst칠mu (vol치 se a po na캜ten칤 hry)
        function initAntiCheat() {
            // Spus콘 detekci DevTools - pou쮂셨치me safe interval pro spr치vn칳 cleanup
            safeSetInterval(devToolsCheck, 1000);
            
            // Pravideln치 kontrola integrity
            safeSetInterval(() => {
                if (state.confirmed) {
                    verifyIntegrity();
                }
            }, 5000);
        }
        
        // === VISUAL EFFECTS SYSTEM ===
        
        // Terminal 코um zvuk p콏i p콏epnut칤
        let audioCtx = null;
        function getAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        }
        
        function playTerminalSound() {
            try {
                const ctx = getAudioContext();
                const bufferSize = ctx.sampleRate * 0.08;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * 0.2;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 2000;
                filter.Q.value = 1;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + 0.08);
            } catch (e) {}
        }
        
        // === COMBAT SOUNDS ===
        
        // Zvuk 칰deru/z치sahu
        function playSoundHit(isCrit = false) {
            try {
                const ctx = getAudioContext();
                const duration = isCrit ? 0.15 : 0.1;
                
                // Noise burst pro "dopad"
                const bufferSize = ctx.sampleRate * duration;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const env = Math.exp(-i / (bufferSize * 0.2));
                    data[i] = (Math.random() * 2 - 1) * env;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = isCrit ? 800 : 500;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(isCrit ? 0.25 : 0.15, ctx.currentTime);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + duration);
            } catch (e) {}
        }
        
        // Zvuk st콏elby
        function playSoundGunshot() {
            try {
                const ctx = getAudioContext();
                
                // Ostr칳 noise burst
                const bufferSize = ctx.sampleRate * 0.12;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const env = Math.exp(-i / (bufferSize * 0.05));
                    data[i] = (Math.random() * 2 - 1) * env;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 1000;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + 0.12);
            } catch (e) {}
        }
        
        // Zvuk me캜e/se캜n칠 zbran캩
        function playSoundSlash() {
            try {
                const ctx = getAudioContext();
                
                const osc = ctx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 2000;
                filter.Q.value = 2;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.12, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } catch (e) {}
        }
        
        // Zvuk smrti nep콏칤tele
        function playSoundEnemyDeath() {
            try {
                const ctx = getAudioContext();
                
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.3);
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) {}
        }
        
        // Zvuk z치sahu hr치캜e (bolest)
        function playSoundPlayerHit() {
            try {
                const ctx = getAudioContext();
                
                // N칤zk칳 "ugh" zvuk
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.15);
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.12, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
            } catch (e) {}
        }
        
        // Zvuk mine/t캩쬶치 r치na
        function playSoundMiss() {
            try {
                const ctx = getAudioContext();
                
                const bufferSize = ctx.sampleRate * 0.08;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const env = Math.exp(-i / (bufferSize * 0.3));
                    data[i] = (Math.random() * 2 - 1) * env * 0.3;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 2000;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.08, ctx.currentTime);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + 0.08);
            } catch (e) {}
        }
        
        // Zvuk v칤t캩zstv칤 v boji
        function playSoundVictory() {
            try {
                const ctx = getAudioContext();
                
                // V칤t캩zn치 fanf치ra - t콏i t칩ny
                [0, 0.15, 0.3].forEach((delay, i) => {
                    const osc = ctx.createOscillator();
                    osc.type = 'square';
                    osc.frequency.value = [262, 330, 392][i]; // C, E, G
                    
                    const gain = ctx.createGain();
                    gain.gain.setValueAtTime(0, ctx.currentTime + delay);
                    gain.gain.linearRampToValueAtTime(0.08, ctx.currentTime + delay + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + delay + 0.2);
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    osc.start(ctx.currentTime + delay);
                    osc.stop(ctx.currentTime + delay + 0.2);
                });
            } catch (e) {}
        }
        
        // Zvuk prohry/smrti
        function playSoundDefeat() {
            try {
                const ctx = getAudioContext();
                
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(30, ctx.currentTime + 0.8);
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.8);
            } catch (e) {}
        }
        
        // Hlavn칤 funkce pro combat zvuky
        function playCombatSound(type, weaponType = 'melee') {
            switch(type) {
                case 'playerAttack':
                    if (weaponType === 'ranged' || weaponType === 'gun') {
                        playSoundGunshot();
                    } else {
                        playSoundSlash();
                    }
                    break;
                case 'playerHit':
                    playSoundPlayerHit();
                    break;
                case 'enemyHit':
                    playSoundHit(false);
                    break;
                case 'crit':
                    playSoundHit(true);
                    break;
                case 'miss':
                    playSoundMiss();
                    break;
                case 'enemyDeath':
                    playSoundEnemyDeath();
                    break;
                case 'victory':
                    playSoundVictory();
                    break;
                case 'defeat':
                    playSoundDefeat();
                    break;
            }
        }
        
        // Univerz치ln칤 scan efekt
        function triggerScanEffect() {
            const scan = document.createElement('div');
            scan.className = 'scan-overlay';
            document.body.appendChild(scan);
            // playTerminalSound(); // Odstran캩no - ru코iv칳 zvuk
            setTimeout(() => scan.remove(), 300);
        }
        
        // 1. Blik치n칤 p콏i n칤zk칠 HP
        let lowHpOverlay = null;
        function updateLowHpEffect() {
            const hpPercent = (state.hp / state.maxHp) * 100;
            if (hpPercent <= 25 && !lowHpOverlay) {
                lowHpOverlay = document.createElement('div');
                lowHpOverlay.className = 'low-hp-overlay';
                document.body.appendChild(lowHpOverlay);
            } else if (hpPercent > 25 && lowHpOverlay) {
                lowHpOverlay.remove();
                lowHpOverlay = null;
            }
        }
        
        // 2. Screen shake p콏i z치sahu
        function triggerDamageShake() {
            const container = document.querySelector('.container');
            if (container) {
                container.classList.add('damage-shake');
                setTimeout(() => container.classList.remove('damage-shake'), 400);
            }
        }
        
        // 3. Radia캜n칤 zkreslen칤
        let radiationActive = false;
        function updateRadiationEffect() {
            const container = document.querySelector('.container');
            if (!container) return;
            
            // Pou쬴j WORLD_LOCATIONS nebo p콏esko캜 pokud neexistuje
            if (typeof WORLD_LOCATIONS === 'undefined') return;
            
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world?.currentLocation);
            const isRadZone = loc && (loc.radiation > 0 || loc.danger >= 4);
            
            if (isRadZone && !radiationActive) {
                container.classList.add('radiation-zone');
                radiationActive = true;
            } else if (!isRadZone && radiationActive) {
                container.classList.remove('radiation-zone');
                radiationActive = false;
            }
        }
        
        // 4. Blesky p콏i bou콏ce
        let stormFlashElement = null;
        let stormInterval = null;
        function updateStormEffect() {
            // Efekt bou콏e vypnut - ru코iv칳
            return;
        }
        
        // 5. Zelen칠 probuzen칤 p콏i na캜ten칤
        function triggerBootEffect() {
            const scanBottom = document.createElement('div');
            scanBottom.className = 'scan-overlay';
            scanBottom.style.animationDuration = '0.6s';
            document.body.appendChild(scanBottom);
            
            const scanTop = document.createElement('div');
            scanTop.className = 'scan-overlay-top';
            scanTop.style.animationDuration = '0.6s';
            document.body.appendChild(scanTop);
            
            // playTerminalSound(); // Odstran캩no - ru코iv칳 zvuk
            
            setTimeout(() => {
                scanBottom.remove();
                scanTop.remove();
            }, 700);
        }
        
        // 6. Efekt p콏i smrti
        function triggerDeathEffect() {
            const container = document.querySelector('.container');
            if (container) {
                container.classList.add('death-screen');
            }
        }
        
        // 7. Level up z치콏e
        function triggerLevelUpEffect() {
            const flash = document.createElement('div');
            flash.className = 'levelup-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 800);
        }
        
        // 8. N치hodn칠 mini glitche - VYPNUTO
        function startRandomGlitches() {
            // Disabled
        }
        
        // 9. Modal scan efekt
        function addModalScanEffect(modalContent) {
            // Efekt vypnut - ru코iv칳
            return;
        }
        
        // 10. No캜n칤 re쬴m
        let nightOverlay = null;
        function updateNightEffect() {
            const hour = state.time ? state.time.hour : 12;
            const isNight = hour >= 21 || hour < 6;
            
            if (isNight && !nightOverlay) {
                nightOverlay = document.createElement('div');
                nightOverlay.className = 'night-overlay';
                document.body.appendChild(nightOverlay);
            } else if (!isNight && nightOverlay) {
                nightOverlay.style.opacity = '0';
                setTimeout(() => {
                    if (nightOverlay) {
                        nightOverlay.remove();
                        nightOverlay = null;
                    }
                }, 2000);
            }
        }
        
        // Inicializace v코ech efekt콢
        function initAllEffects() {
            // triggerBootEffect(); // Odstran캩no - ru코iv칳 zelen칳 efekt
            startRandomGlitches();
            
            // Pravideln치 kontrola efekt콢
            setInterval(() => {
                updateLowHpEffect();
                updateRadiationEffect();
                updateStormEffect();
                updateNightEffect();
            }, 1000);
        }
        const VisualEffects = {
            init() {
                // Vytvo콏 parallax pozad칤
                const parallax = document.createElement('div');
                parallax.className = 'parallax-bg';
                document.body.prepend(parallax);
            },
            
            // Legacy funkce - nic ned캩l치
            startDustParticles() {},
            createDustParticle() {},
            
            screenShake(intensity = 'medium') {
                const container = document.querySelector('.container');
                if (!container) return;
                
                container.classList.add('screen-shake');
                setTimeout(() => container.classList.remove('screen-shake'), 400);
            },
            
            damageFlash(element) {
                if (!element) return;
                element.classList.add('damage-flash');
                setTimeout(() => element.classList.remove('damage-flash'), 300);
            },
            
            healPulse(element) {
                if (!element) return;
                element.classList.add('heal-pulse');
                setTimeout(() => element.classList.remove('heal-pulse'), 500);
            },
            
            createExplosion(x, y) {
                const explosion = document.createElement('div');
                explosion.innerHTML = '游눤';
                explosion.style.cssText = `
                    position: fixed;
                    left: ${x}px;
                    top: ${y}px;
                    font-size: 3rem;
                    pointer-events: none;
                    z-index: 10000;
                    animation: explode 0.5s ease-out forwards;
                `;
                document.body.appendChild(explosion);
                setTimeout(() => explosion.remove(), 500);
            },
            
            toggleDust(enabled) {
                this.dustEnabled = enabled;
                if (!enabled) {
                    this.dustParticles.forEach(p => p.remove());
                    this.dustParticles = [];
                } else {
                    this.startDustParticles();
                }
            },
            
            toggleColorBlindMode(enabled) {
                document.body.classList.toggle('colorblind-mode', enabled);
            }
        };
        
        // Inicializuj visual effects po na캜ten칤
        document.addEventListener('DOMContentLoaded', () => {
            // Check jestli u쬴vatel vytv치콏칤 novou postavu
            if (localStorage.getItem('creatingNewCharacter') === 'true') {
                window.creatingNewCharacter = true;
                localStorage.removeItem('creatingNewCharacter');
                console.log('游 Re쬴m vytv치콏en칤 nov칠 postavy aktivn칤');
            }
            
            setTimeout(() => VisualEffects.init(), 1000);
            setTimeout(() => initAllEffects(), 1500);
            setTimeout(() => initAntiCheat(), 2000);
            
            // Scroll to top button visibility
            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.addEventListener('scroll', () => {
                    const scrollBtn = document.getElementById('scrollToTop');
                    if (scrollBtn) {
                        if (mainEl.scrollTop > 300) {
                            scrollBtn.classList.add('visible');
                        } else {
                            scrollBtn.classList.remove('visible');
                        }
                    }
                });
            }
        });
        
        function scrollToTop() {
            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // === SOUND SYSTEM ===
        const SoundSystem = {
            context: null,
            enabled: true,
            initialized: false,
            
            init() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                } catch (e) {
                    console.log('Web Audio API not supported');
                    this.enabled = false;
                }
            },
            
            // Resume context on user interaction (required by browsers)
            async resume() {
                if (this.context && this.context.state === 'suspended') {
                    try {
                        await this.context.resume();
                        console.log('AudioContext resumed');
                    } catch (e) {
                        console.log('Failed to resume AudioContext');
                    }
                }
            },
            
            play(type) {
                if (!this.enabled || !this.context) return;
                
                // Try to resume if suspended
                if (this.context.state === 'suspended') {
                    this.context.resume();
                }
                
                const ctx = this.context;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                const now = ctx.currentTime;
                
                switch(type) {
                    case 'levelup':
                        // Ascending happy beeps
                        oscillator.frequency.setValueAtTime(523, now); // C
                        oscillator.frequency.setValueAtTime(659, now + 0.1); // E
                        oscillator.frequency.setValueAtTime(784, now + 0.2); // G
                        gainNode.gain.setValueAtTime(0.3, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                        oscillator.start(now);
                        oscillator.stop(now + 0.4);
                        break;
                        
                    case 'rare_item':
                        // Shimmering high tone
                        oscillator.frequency.setValueAtTime(1046, now); // High C
                        oscillator.frequency.exponentialRampToValueAtTime(1568, now + 0.3); // High G
                        gainNode.gain.setValueAtTime(0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                        oscillator.start(now);
                        oscillator.stop(now + 0.3);
                        break;
                        
                    case 'death':
                        // Descending sad tone
                        oscillator.frequency.setValueAtTime(440, now); // A
                        oscillator.frequency.exponentialRampToValueAtTime(220, now + 0.5); // Low A
                        gainNode.gain.setValueAtTime(0.3, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                        oscillator.start(now);
                        oscillator.stop(now + 0.5);
                        break;
                        
                    case 'quest_complete':
                        // Victory fanfare
                        oscillator.frequency.setValueAtTime(523, now); // C
                        oscillator.frequency.setValueAtTime(659, now + 0.1); // E
                        oscillator.frequency.setValueAtTime(523, now + 0.2); // C
                        oscillator.frequency.setValueAtTime(784, now + 0.3); // G
                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                        oscillator.start(now);
                        oscillator.stop(now + 0.5);
                        break;
                        
                    case 'combat_hit':
                        // Quick hit sound
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(200, now);
                        gainNode.gain.setValueAtTime(0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        oscillator.start(now);
                        oscillator.stop(now + 0.1);
                        break;
                        
                    case 'critical':
                        // Critical hit - powerful impact
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(400, now);
                        oscillator.frequency.setValueAtTime(200, now + 0.05);
                        oscillator.frequency.setValueAtTime(600, now + 0.1);
                        gainNode.gain.setValueAtTime(0.3, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        oscillator.start(now);
                        oscillator.stop(now + 0.2);
                        break;
                        
                    case 'damage':
                        // Taking damage - lower thud
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(150, now);
                        oscillator.frequency.exponentialRampToValueAtTime(80, now + 0.15);
                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                        oscillator.start(now);
                        oscillator.stop(now + 0.15);
                        break;
                        
                    case 'pickup':
                        // Quick pickup beep
                        oscillator.frequency.setValueAtTime(800, now);
                        gainNode.gain.setValueAtTime(0.15, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                        oscillator.start(now);
                        oscillator.stop(now + 0.15);
                        break;
                        
                    case 'error':
                        // Error buzz
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(150, now);
                        gainNode.gain.setValueAtTime(0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        oscillator.start(now);
                        oscillator.stop(now + 0.2);
                        break;
                        
                    case 'click':
                        // UI click
                        oscillator.frequency.setValueAtTime(600, now);
                        gainNode.gain.setValueAtTime(0.1, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                        oscillator.start(now);
                        oscillator.stop(now + 0.05);
                        break;
                        
                    case 'raid':
                        // Raid alarm
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(400, now);
                        oscillator.frequency.setValueAtTime(600, now + 0.15);
                        oscillator.frequency.setValueAtTime(400, now + 0.3);
                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                        oscillator.start(now);
                        oscillator.stop(now + 0.4);
                        break;
                }
            },
            
            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        };
        
        // Initialize sound system
        SoundSystem.init();
        
        // === GAME DATA ===
        // Funkce pro lokalizovan치 pohlav칤
        function getGenders() {
            const names = {
                cs: { male: 'Mu', female: '콯ena' },
                en: { male: 'Male', female: 'Female' }
            };
            const lang = currentLang || 'cs';
            return {
                male: {
                    name: names[lang]?.male || names.cs.male,
                    icon: '游녿',
                    desc: lang === 'en' ? 'Physically stronger and tougher' : 
                          lang === 'sk' ? 'Fyzicky silnej코칤 a odolnej코칤' : 'Fyzicky siln캩j코칤 a odoln캩j코칤',
                    bonuses: { str: 1, end: 1 },
                    special: lang === 'en' ? '+5% max HP' : '+5% max HP'
                },
                female: {
                    name: names[lang]?.female || names.cs.female,
                    icon: '游놀',
                    desc: lang === 'en' ? 'More charismatic and perceptive' :
                          lang === 'sk' ? 'Charizmatickej코ia a vn칤mavej코ia' : 'Charismati캜t캩j코칤 a vn칤mav캩j코칤',
                    bonuses: { lck: 1, per: 1 },
                    special: lang === 'en' ? '+10% better shop prices' : '+10% lep코칤 ceny v obchod캩'
                }
            };
        }
        
        const GENDERS = {
            male: {
                name: 'Mu',
                name_en: 'Male',
                icon: '游녿',
                desc: 'Fyzicky siln캩j코칤 a odoln캩j코칤',
                bonuses: {
                    str: 1,
                    end: 1
                },
                special: '+5% max HP'
            },
            female: {
                name: '콯ena',
                name_en: 'Female',
                icon: '游놀',
                desc: 'Charismati캜t캩j코칤 a vn칤mav캩j코칤',
                bonuses: {
                    lck: 1,
                    per: 1
                },
                special: '+10% lep코칤 ceny v obchod캩'
            }
        };
        
        const CLASSES = {
            // === BOJOV칄 T콎칈DY ===
            raider: { 
                name: 'N치jezdn칤k', 
                icon: '丘덢잺', 
                desc: 'Brut치ln칤 bojovn칤k z pustiny', 
                ability: '+25% damage v boji',
                passive: 'Rage: Pod 30% HP +40% damage',
                weapon: { name: 'Palc치t', icon: '游댣', dmg: 12 },
                bonuses: { str: 2, end: 1 },
                color: '#c62828'
            },
            berserker: { 
                name: 'Berserkr', 
                icon: '游뿝', 
                desc: '먞셟en칳 v치le캜n칤k bez strachu', 
                ability: '+40% damage, -25% obrana',
                passive: 'Frenzy: Ka쬯칳 kill +8% damage (max 5 stack콢, 45s)',
                weapon: { name: 'Bojov치 sekera', icon: '游뿝', dmg: 15 },
                bonuses: { str: 3 },
                color: '#b71c1c'
            },
            
            // === OBRANN칄 T콎칈DY ===
            survivor: { 
                name: 'P콏e쬴v코칤', 
                icon: '游띠勇', 
                desc: 'Otrl칳 veter치n apokalypsy', 
                ability: '+50 max HP',
                passive: 'Last Stand: 20% 코ance p콏e쮂셦 smrteln칳 칰der s 1 HP',
                weapon: { name: 'Sekera', icon: '游뿝', dmg: 9 },
                bonuses: { end: 2, str: 1 },
                color: '#388e3c'
            },
            tank: { 
                name: 'Tank', 
                icon: '游끪勇', 
                desc: 'Nepr콢st콏eln치 ze캞 masa', 
                ability: '+80 max HP, -15% rychlost',
                passive: 'Fortress: Blokuje 25% p콏칤choz칤ho damage',
                weapon: { name: '맚칤t', icon: '游띠勇', dmg: 6 },
                bonuses: { end: 3 },
                color: '#1565c0'
            },
            
            // === SKAUTSK칄 T콎칈DY ===
            stalker: { 
                name: 'Stopa콏', 
                icon: '游꿢', 
                desc: 'Tich칳 lovec st칤n콢', 
                ability: '-30% spot콏eba zdroj콢',
                passive: 'Stealth: 50% 코ance vyhnout se p콏epaden칤',
                weapon: { name: 'Luk', icon: '游낓', dmg: 10 },
                bonuses: { agi: 2, per: 1 },
                color: '#5d4037'
            },
            assassin: { 
                name: 'Assassin', 
                icon: '游디勇', 
                desc: 'Mistr rychl칳ch zabit칤', 
                ability: '+30% crit chance',
                passive: 'Execute: Kritick칳 z치sah d캩l치 2.5x damage',
                weapon: { name: 'D칳ky', icon: '游디勇', dmg: 8 },
                bonuses: { agi: 3 },
                color: '#263238'
            },
            
            // === PODP콡RN칄 T콎칈DY ===
            medic: { 
                name: 'Poln칤 Medik', 
                icon: '丘됊잺', 
                desc: 'Expert na p콏e쬴t칤 a l칠캜bu', 
                ability: 'L칠캜iva +50% efektivn캩j코칤',
                passive: 'Regeneration: +3 HP za minutu, +10% heal v boji',
                weapon: { name: 'Skalpel', icon: '游디勇', dmg: 6 },
                bonuses: { int: 2, end: 1 },
                color: '#d32f2f'
            },
            alchemist: { 
                name: 'Alchymista', 
                icon: '丘勇', 
                desc: 'Mistr lektvar콢 a jed콢', 
                ability: 'Lektvary +100% efekt, trvaj칤 2x d칠le',
                passive: 'Poison: 칔toky zp콢sobuj칤 otravu (8 DOT)',
                weapon: { name: 'Jedov칳 n콢', icon: '游댥', dmg: 7 },
                bonuses: { int: 3 },
                color: '#7b1fa2'
            },
            
            // === SB캨RA캛SK칄 T콎칈DY ===
            scavenger: { 
                name: 'Sb캩ra캜', 
                icon: '游댌', 
                desc: 'Specialista na hled치n칤 zdroj콢', 
                ability: '+50% 코ance naj칤t p콏edm캩ty',
                passive: 'Lucky Find: 15% 코ance na dvojit칳 loot',
                weapon: { name: 'Rezav칳 N콢', icon: '游댥', dmg: 5 },
                bonuses: { per: 2, agi: 1 },
                color: '#ff9800'
            },
            hunter: { 
                name: 'Lovec', 
                icon: '游낓', 
                desc: 'Mistr lovu a p콏칤rody', 
                ability: '+100% loot ze zv칤콏at',
                passive: 'Tracker: Vid칤코 zv칤콏ata na map캩, +20% crit na zv칤콏ata',
                weapon: { name: 'Loveck칳 luk', icon: '游낓', dmg: 11 },
                bonuses: { per: 3 },
                color: '#33691e'
            },
            
            // === TECHNICK칄 T콎칈DY ===
            engineer: { 
                name: 'Mechanik', 
                icon: '游댢', 
                desc: 'Technik a vyn치lezce', 
                ability: 'Crafting -50% surovin',
                passive: 'Repair: Zbran캩 a zbroje se neni캜칤, +15% DMG s craft캩n칳mi zbran캩mi',
                weapon: { name: 'Kl칤캜', icon: '游댢', dmg: 7 },
                bonuses: { int: 2, str: 1 },
                color: '#455a64'
            },
            demolitionist: { 
                name: 'Demoli캜치콏', 
                icon: '游눢', 
                desc: 'Expert na v칳bu코niny', 
                ability: 'V칳buchy +100% damage',
                passive: 'Boom: 12% 코ance na AoE damage p콏i 칰toku (40% splash)',
                weapon: { name: 'Z치paln치 bomba', icon: '游댠', dmg: 14 },
                bonuses: { str: 2, int: 1 },
                color: '#e65100'
            },
            
            // === SPECI츼LN칈 T콎칈DY ===
            trader: { 
                name: 'Obchodn칤k', 
                icon: '游눯', 
                desc: 'Charismatick칳 dealer', 
                ability: '-30% ceny v obchodech, +10% 코ance na rare v obchodech',
                passive: 'Barter: Prodej za +50% ceny, NPC d치vaj칤 lep코칤 questy',
                weapon: { name: 'Revolver', icon: '游댦', dmg: 8 },
                bonuses: { lck: 3 },
                color: '#ffd600'
            },
            nomad: { 
                name: 'Nom치d', 
                icon: '游끺勇', 
                desc: 'Pou코tn칤 tul치k', 
                ability: '-5% 캜as cestov치n칤',
                passive: 'Endurance: 콯칤ze켿 a hlad kles치 50% pomaleji',
                weapon: { name: '마vle', icon: '丘덢잺', dmg: 10 },
                bonuses: { end: 1, agi: 2 },
                color: '#8d6e63'
            },
            mutant: { 
                name: 'Mutant', 
                icon: '驕뮖잺', 
                desc: 'Ob콏칤 zmutovan칳 p콏e쬴v코칤', 
                ability: 'Imunn칤 na radiaci, +15% damage v rad z칩n치ch, +10 p콏irozen치 obrana',
                passive: 'Regenerace: +3 HP p콏i z치sahu, dr치py +20 DMG jako z치lo쬹칤 zbra켿',
                restrictions: 'Nem콢쬰 nosit brn캩n칤 ani helmy (p콏칤li코 velk칳)',
                weapon: { name: 'Mutant칤 dr치py', icon: '游붍', dmg: 20 },
                bonuses: { end: 3, str: 3 },
                baseDefense: 10,
                color: '#76ff03'
            },
            psychic: { 
                name: 'Psychik', 
                icon: '游댩', 
                desc: 'Ment치ln칤 schopnosti', 
                ability: 'Vid칤코 skryt칠 lokace na map캩',
                passive: 'Mind Control: 15% 코ance 쬰 nep콏칤tel ute캜e nebo se omr치캜칤',
                weapon: { name: 'Psychick치 캜epel', icon: '游디勇', dmg: 9 },
                bonuses: { int: 2, lck: 1 },
                color: '#aa00ff'
            }
        };
        
        // === SETY PRO POVOL츼N칈 ===
        // Ka쬯칠 povol치n칤 m치 unik치tn칤 3-d칤ln칳 set
        // 1 d칤l = z치kladn칤 bonus, 2 d칤ly = extra bonus, 3 d칤ly = pln칳 bonus
        const CLASS_SETS = {
            // N츼JEZDN칈K - Krvav칳 set
            raider: {
                name: 'Krvav칳 set',
                icon: '游뽖',
                class: 'raider',
                pieces: {
                    helmet: {
                        id: 'raider_set_helmet',
                        name: 'Krvav치 p콏ilba',
                        icon: '游뿠',
                        slot: 'helmet',
                        defense: 8,
                        weight: 2.5,
                        price: 800,
                        rarity: 'legendary',
                        bonus: { str: 2 },
                        bonusDesc: '+2 S칤la'
                    },
                    armor: {
                        id: 'raider_set_armor',
                        name: 'Krvav칳 panc칤콏',
                        icon: '游붴',
                        slot: 'armor',
                        defense: 18,
                        weight: 8,
                        price: 1200,
                        rarity: 'legendary',
                        bonus: { damageBonus: 0.15 },
                        bonusDesc: '+15% damage'
                    },
                    weapon: {
                        id: 'raider_set_weapon',
                        name: 'Krvav칳 palc치t',
                        icon: '游댣',
                        slot: 'weapon',
                        damage: 45,
                        weight: 4,
                        price: 1500,
                        rarity: 'legendary',
                        bonus: { lifesteal: 0.1 },
                        bonusDesc: '10% lifesteal'
                    }
                },
                setBonus2: { critChance: 0.15, desc: '+15% 코ance na kritick칳 z치sah' },
                setBonus3: { rage: true, desc: '+40% damage kdy m치코 m칠n캩 ne 50% HP' }
            },
            
            // BERSERKR - Zu콏iv칳 set
            berserker: {
                name: 'Zu콏iv칳 set',
                icon: '游댠',
                class: 'berserker',
                pieces: {
                    helmet: {
                        id: 'berserker_set_helmet',
                        name: 'V치le캜n치 maska',
                        icon: '游놏',
                        slot: 'helmet',
                        defense: 5,
                        weight: 1.5,
                        price: 750,
                        rarity: 'legendary',
                        bonus: { str: 3 },
                        bonusDesc: '+3 S칤la'
                    },
                    armor: {
                        id: 'berserker_set_armor',
                        name: 'Zu콏iv치 zbroj',
                        icon: '游붴',
                        slot: 'armor',
                        defense: 12,
                        weight: 6,
                        price: 1100,
                        rarity: 'legendary',
                        bonus: { lowHpDamage: 0.2 },
                        bonusDesc: '+20% damage pod 50% HP'
                    },
                    weapon: {
                        id: 'berserker_set_weapon',
                        name: 'Sekera 코칤lenstv칤',
                        icon: '游뿝',
                        slot: 'weapon',
                        damage: 55,
                        weight: 5,
                        price: 1600,
                        rarity: 'legendary',
                        bonus: { damageBonus: 0.2 },
                        bonusDesc: '+20% damage'
                    }
                },
                setBonus2: { frenzyDamage: 0.25, desc: '+25% damage po ka쬯칠m zabit칤 (45s)' },
                setBonus3: { unstoppable: true, desc: 'Imunita na omr치캜en칤 a zpomalen칤' }
            },
            
            // P콎E콯IV먞 - Veter치nsk칳 set
            survivor: {
                name: 'Veter치nsk칳 set',
                icon: '游끤',
                class: 'survivor',
                pieces: {
                    helmet: {
                        id: 'survivor_set_helmet',
                        name: 'Veter치nsk치 p콏ilba',
                        icon: '游뿠',
                        slot: 'helmet',
                        defense: 12,
                        weight: 2,
                        price: 850,
                        rarity: 'legendary',
                        bonus: { end: 2 },
                        bonusDesc: '+2 V칳dr'
                    },
                    armor: {
                        id: 'survivor_set_armor',
                        name: 'Veter치nsk칳 panc칤콏',
                        icon: '游띠勇',
                        slot: 'armor',
                        defense: 25,
                        weight: 10,
                        price: 1400,
                        rarity: 'legendary',
                        bonus: { maxHp: 30 },
                        bonusDesc: '+30 max HP'
                    },
                    weapon: {
                        id: 'survivor_set_weapon',
                        name: 'Veter치n콢v brokovnice',
                        icon: '游댦',
                        slot: 'weapon',
                        damage: 40,
                        ammoType: 'shell',
                        weight: 4,
                        price: 1300,
                        rarity: 'legendary',
                        bonus: { knockback: true },
                        bonusDesc: 'Odhod칤 nep콏칤tele'
                    }
                },
                setBonus2: { damageReduction: 0.15, desc: 'Dost치v치코 o 15% m칠n캩 damage' },
                setBonus3: { lastStandImproved: true, desc: '35% 코ance p콏e쮂셦 smrteln칳 칰der s 1 HP' }
            },
            
            // TANK - Pevnostn칤 set
            tank: {
                name: 'Pevnostn칤 set',
                icon: '游낋',
                class: 'tank',
                pieces: {
                    helmet: {
                        id: 'tank_set_helmet',
                        name: 'T캩쬶치 p콏ilba',
                        icon: '久놾잺',
                        slot: 'helmet',
                        defense: 18,
                        weight: 4,
                        price: 900,
                        rarity: 'legendary',
                        bonus: { end: 3 },
                        bonusDesc: '+3 V칳dr'
                    },
                    armor: {
                        id: 'tank_set_armor',
                        name: 'Pevnostn칤 brn캩n칤',
                        icon: '游띠勇',
                        slot: 'armor',
                        defense: 35,
                        weight: 15,
                        price: 1800,
                        rarity: 'legendary',
                        bonus: { maxHp: 50 },
                        bonusDesc: '+50 max HP'
                    },
                    weapon: {
                        id: 'tank_set_weapon',
                        name: 'Obrann칳 코t칤t',
                        icon: '游띠勇',
                        slot: 'weapon',
                        damage: 25,
                        weight: 8,
                        price: 1000,
                        rarity: 'legendary',
                        bonus: { blockChance: 0.2 },
                        bonusDesc: '20% 코ance blokovat 칰tok'
                    }
                },
                setBonus2: { thorns: 0.15, desc: 'Vr치t칤코 15% damage zp캩t 칰to캜n칤kovi' },
                setBonus3: { fortressImproved: true, desc: 'Blokuje코 40% ve코ker칠ho damage' }
            },
            
            // STOPA콎 - St칤nov칳 set
            stalker: {
                name: 'St칤nov칳 set',
                icon: '游깸',
                class: 'stalker',
                pieces: {
                    helmet: {
                        id: 'stalker_set_helmet',
                        name: 'St칤nov치 kapuce',
                        icon: '游꿠',
                        slot: 'helmet',
                        defense: 6,
                        weight: 0.8,
                        price: 700,
                        rarity: 'legendary',
                        bonus: { per: 3 },
                        bonusDesc: '+3 Vn칤m치n칤'
                    },
                    armor: {
                        id: 'stalker_set_armor',
                        name: 'St칤nov칳 pl치코콘',
                        icon: '游빈',
                        slot: 'armor',
                        defense: 10,
                        weight: 3,
                        price: 1000,
                        rarity: 'legendary',
                        bonus: { stealth: 0.2 },
                        bonusDesc: '+20% 코ance vyhnout se boji'
                    },
                    weapon: {
                        id: 'stalker_set_weapon',
                        name: 'Tich칳 luk',
                        icon: '游낓',
                        slot: 'weapon',
                        damage: 38,
                        ammoType: 'arrow',
                        weight: 2,
                        price: 1200,
                        rarity: 'legendary',
                        bonus: { critDamage: 0.5 },
                        bonusDesc: '+50% crit damage'
                    }
                },
                setBonus2: { ambush: true, desc: 'Prvn칤 칰tok v boji je v쬯y kritick칳' },
                setBonus3: { stealthImproved: true, desc: '70% 코ance vyhnout se nep콏치tel콢m' }
            },
            
            // ASSASSIN - Vra쬰dn칳 set
            assassin: {
                name: 'Vra쬰dn칳 set',
                icon: '游',
                class: 'assassin',
                pieces: {
                    helmet: {
                        id: 'assassin_set_helmet',
                        name: 'Maska vraha',
                        icon: '游꿠',
                        slot: 'helmet',
                        defense: 4,
                        weight: 0.5,
                        price: 750,
                        rarity: 'legendary',
                        bonus: { agi: 3 },
                        bonusDesc: '+3 Obratnost'
                    },
                    armor: {
                        id: 'assassin_set_armor',
                        name: 'Vra쬰dn치 kazajka',
                        icon: '游봉',
                        slot: 'armor',
                        defense: 8,
                        weight: 2,
                        price: 950,
                        rarity: 'legendary',
                        bonus: { dodgeChance: 0.15 },
                        bonusDesc: '+15% 칰hyb'
                    },
                    weapon: {
                        id: 'assassin_set_weapon',
                        name: 'Dvojit칠 캜epele',
                        icon: '游디勇',
                        slot: 'weapon',
                        damage: 32,
                        weight: 1.5,
                        price: 1400,
                        rarity: 'legendary',
                        bonus: { critChance: 0.2 },
                        bonusDesc: '+20% kritick치 코ance'
                    }
                },
                setBonus2: { bleed: true, desc: 'Kritick칠 z치sahy zp콢sob칤 krv치cen칤 (5 DMG/kolo)' },
                setBonus3: { executeImproved: true, desc: 'Kritick칠 z치sahy d캩laj칤 3x damage' }
            },
            
            // MEDIK - L칠캜itelsk칳 set
            medic: {
                name: 'L칠캜itelsk칳 set',
                icon: '仇벒잺',
                class: 'medic',
                pieces: {
                    helmet: {
                        id: 'medic_set_helmet',
                        name: 'Chirurgick치 캜epice',
                        icon: '游녿꽥뚯勇',
                        slot: 'helmet',
                        defense: 5,
                        weight: 0.5,
                        price: 600,
                        rarity: 'legendary',
                        bonus: { int: 2 },
                        bonusDesc: '+2 Inteligence'
                    },
                    armor: {
                        id: 'medic_set_armor',
                        name: 'L칠ka콏sk칳 pl치코콘',
                        icon: '游봎',
                        slot: 'armor',
                        defense: 10,
                        weight: 2,
                        price: 900,
                        rarity: 'legendary',
                        bonus: { healBonus: 0.25 },
                        bonusDesc: '+25% l칠캜en칤'
                    },
                    weapon: {
                        id: 'medic_set_weapon',
                        name: 'Chirurgick칳 laser',
                        icon: '游댡',
                        slot: 'weapon',
                        damage: 28,
                        weight: 1,
                        price: 1100,
                        rarity: 'legendary',
                        bonus: { healOnHit: 5 },
                        bonusDesc: '+5 HP p콏i z치sahu'
                    }
                },
                setBonus2: { groupHeal: true, desc: 'L칠캜iva l칠캜칤 i tv칠 spole캜n칤ky (50%)' },
                setBonus3: { regenImproved: true, desc: 'Regeneruje코 +6 HP za minutu' }
            },
            
            // ALCHYMISTA - Toxick칳 set
            alchemist: {
                name: 'Toxick칳 set',
                icon: '驕멆잺',
                class: 'alchemist',
                pieces: {
                    helmet: {
                        id: 'alchemist_set_helmet',
                        name: 'Plynov치 maska mistra',
                        icon: '游땽',
                        slot: 'helmet',
                        defense: 6,
                        weight: 1,
                        price: 700,
                        rarity: 'legendary',
                        bonus: { int: 3, radResist: 30 },
                        bonusDesc: '+3 Int, +30 rad odolnost'
                    },
                    armor: {
                        id: 'alchemist_set_armor',
                        name: 'Laboratorn칤 pl치코콘',
                        icon: '游봎',
                        slot: 'armor',
                        defense: 8,
                        weight: 2,
                        price: 850,
                        rarity: 'legendary',
                        bonus: { potionDuration: 0.5 },
                        bonusDesc: '+50% trv치n칤 lektvar콢'
                    },
                    weapon: {
                        id: 'alchemist_set_weapon',
                        name: 'Jedov치 injekce',
                        icon: '游눌',
                        slot: 'weapon',
                        damage: 25,
                        weight: 0.5,
                        price: 1000,
                        rarity: 'legendary',
                        bonus: { poisonDamage: 12 },
                        bonusDesc: '+12 jed damage/kolo'
                    }
                },
                setBonus2: { acidSplash: true, desc: '20% 코ance otr치vit v코echny nep콏치tele' },
                setBonus3: { poisonImproved: true, desc: 'Jedy d캩laj칤 15 DMG/kolo a trvaj칤 d칠le' }
            },
            
            // SB캨RA캛 - Hleda캜sk칳 set
            scavenger: {
                name: 'Hleda캜sk칳 set',
                icon: '游눑',
                class: 'scavenger',
                pieces: {
                    helmet: {
                        id: 'scavenger_set_helmet',
                        name: 'Hleda캜sk칠 br칳le',
                        icon: '游봏',
                        slot: 'helmet',
                        defense: 4,
                        weight: 0.3,
                        price: 650,
                        rarity: 'legendary',
                        bonus: { per: 4 },
                        bonusDesc: '+4 Vn칤m치n칤'
                    },
                    armor: {
                        id: 'scavenger_set_armor',
                        name: 'Hleda캜sk치 vesta',
                        icon: '游붴',
                        slot: 'armor',
                        defense: 8,
                        weight: 3,
                        price: 800,
                        rarity: 'legendary',
                        bonus: { carryWeight: 15 },
                        bonusDesc: '+15 kg nosnost'
                    },
                    weapon: {
                        id: 'scavenger_set_weapon',
                        name: 'V칤ce칰캜elov칳 n치stroj',
                        icon: '游댢',
                        slot: 'weapon',
                        damage: 20,
                        weight: 1,
                        price: 900,
                        rarity: 'legendary',
                        bonus: { lootBonus: 0.25 },
                        bonusDesc: '+25% 코ance na loot'
                    }
                },
                setBonus2: { rareFind: 0.1, desc: '+10% 코ance naj칤t vz치cn칠 p콏edm캩ty' },
                setBonus3: { luckyFindImproved: true, desc: '30% 코ance na dvojit칳 loot z nep콏치tel' }
            },
            
            // LOVEC - Loveck칳 set
            hunter: {
                name: 'Loveck칳 set',
                icon: '游붋',
                class: 'hunter',
                pieces: {
                    helmet: {
                        id: 'hunter_set_helmet',
                        name: 'Loveck치 캜apka',
                        icon: '游꿜',
                        slot: 'helmet',
                        defense: 5,
                        weight: 0.5,
                        price: 700,
                        rarity: 'legendary',
                        bonus: { per: 3 },
                        bonusDesc: '+3 Vn칤m치n칤'
                    },
                    armor: {
                        id: 'hunter_set_armor',
                        name: 'Loveck치 kazajka',
                        icon: '游빈',
                        slot: 'armor',
                        defense: 12,
                        weight: 4,
                        price: 950,
                        rarity: 'legendary',
                        bonus: { animalDamage: 0.3 },
                        bonusDesc: '+30% damage na zv칤콏ata'
                    },
                    weapon: {
                        id: 'hunter_set_weapon',
                        name: 'Loveck치 pu코ka',
                        icon: '游댦',
                        slot: 'weapon',
                        damage: 48,
                        ammoType: '762',
                        weight: 4,
                        price: 1500,
                        rarity: 'legendary',
                        bonus: { critOnAnimals: 0.3 },
                        bonusDesc: '+30% crit na zv칤콏ata'
                    }
                },
                setBonus2: { tracking: true, desc: '+30% crit na zv칤콏ata, +50% XP z lovu' },
                setBonus3: { animalLootImproved: true, desc: '3x v칤ce surovin ze zv칤콏at' }
            },
            
            // MECHANIK - Technick칳 set
            engineer: {
                name: 'Technick칳 set',
                icon: '丘뙖잺',
                class: 'engineer',
                pieces: {
                    helmet: {
                        id: 'engineer_set_helmet',
                        name: 'Sv치콏e캜sk치 maska',
                        icon: '游봏',
                        slot: 'helmet',
                        defense: 8,
                        weight: 1.5,
                        price: 750,
                        rarity: 'legendary',
                        bonus: { int: 2 },
                        bonusDesc: '+2 Inteligence'
                    },
                    armor: {
                        id: 'engineer_set_armor',
                        name: 'Pracovn칤 kombin칠za',
                        icon: '游농',
                        slot: 'armor',
                        defense: 14,
                        weight: 5,
                        price: 1000,
                        rarity: 'legendary',
                        bonus: { craftBonus: 0.2 },
                        bonusDesc: '+20% kvalita craftingu'
                    },
                    weapon: {
                        id: 'engineer_set_weapon',
                        name: 'Plazmov칳 sv치콏e캜',
                        icon: '游댠',
                        slot: 'weapon',
                        damage: 35,
                        weight: 3,
                        price: 1300,
                        rarity: 'legendary',
                        bonus: { robotDamage: 0.5 },
                        bonusDesc: '+50% damage na roboty'
                    }
                },
                setBonus2: { repairBonus: 0.5, desc: 'Opravy stoj칤 o 50% m칠n캩' },
                setBonus3: { masterCrafter: true, desc: 'Crafting spot콏ebuje jen 25% surovin' }
            },
            
            // DEMOLI캛츼콎 - V칳bu코n칳 set
            demolitionist: {
                name: 'V칳bu코n칳 set',
                icon: '游눤',
                class: 'demolitionist',
                pieces: {
                    helmet: {
                        id: 'demolitionist_set_helmet',
                        name: 'Ochrann치 p콏ilba',
                        icon: '久놾잺',
                        slot: 'helmet',
                        defense: 10,
                        weight: 2,
                        price: 800,
                        rarity: 'legendary',
                        bonus: { explosionResist: 0.5 },
                        bonusDesc: '-50% damage z exploz칤'
                    },
                    armor: {
                        id: 'demolitionist_set_armor',
                        name: 'Pyrotechnick치 vesta',
                        icon: '游빋',
                        slot: 'armor',
                        defense: 16,
                        weight: 6,
                        price: 1100,
                        rarity: 'legendary',
                        bonus: { grenadeDamage: 0.5 },
                        bonusDesc: '+50% damage gran치t콢'
                    },
                    weapon: {
                        id: 'demolitionist_set_weapon',
                        name: 'Raketov칳 granatomet',
                        icon: '游',
                        slot: 'weapon',
                        damage: 60,
                        ammoType: 'rocket',
                        weight: 8,
                        price: 2000,
                        rarity: 'legendary',
                        bonus: { aoeRadius: 0.5 },
                        bonusDesc: '+50% radius v칳buchu'
                    }
                },
                setBonus2: { chainExplosion: true, desc: '20% 코ance na 콏et캩zov칳 v칳buch' },
                setBonus3: { boomImproved: true, desc: '25% 코ance na v칳buch zasahuj칤c칤 v코echny' }
            },
            
            // OBCHODN칈K - Obchodnick칳 set
            trader: {
                name: 'Obchodnick칳 set',
                icon: '游눳',
                class: 'trader',
                pieces: {
                    helmet: {
                        id: 'trader_set_helmet',
                        name: 'Luxusn칤 klobouk',
                        icon: '游꿜',
                        slot: 'helmet',
                        defense: 3,
                        weight: 0.3,
                        price: 500,
                        rarity: 'legendary',
                        bonus: { lck: 3 },
                        bonusDesc: '+3 맚캩st칤'
                    },
                    armor: {
                        id: 'trader_set_armor',
                        name: 'Obchodnick칳 kab치t',
                        icon: '游빈',
                        slot: 'armor',
                        defense: 6,
                        weight: 2,
                        price: 700,
                        rarity: 'legendary',
                        bonus: { shopDiscount: 0.15 },
                        bonusDesc: '-15% ceny v obchodech'
                    },
                    weapon: {
                        id: 'trader_set_weapon',
                        name: 'Pozlacen칳 revolver',
                        icon: '游댦',
                        slot: 'weapon',
                        damage: 30,
                        ammoType: '9mm',
                        weight: 1.5,
                        price: 1200,
                        rarity: 'legendary',
                        bonus: { moneyFind: 0.25 },
                        bonusDesc: '+25% nalezen칳ch pen캩z'
                    }
                },
                setBonus2: { haggle: true, desc: 'Nakupuje코 o 15% levn캩ji' },
                setBonus3: { barterImproved: true, desc: 'Prod치v치코 za 75% ceny (m칤sto 35%)' }
            },
            
            // NOM츼D - Pou코tn칤 set
            nomad: {
                name: 'Pou코tn칤 set',
                icon: '游끺勇',
                class: 'nomad',
                pieces: {
                    helmet: {
                        id: 'nomad_set_helmet',
                        name: 'Pou코tn칤 turban',
                        icon: '游븻',
                        slot: 'helmet',
                        defense: 5,
                        weight: 0.3,
                        price: 600,
                        rarity: 'legendary',
                        bonus: { radResist: 40, per: 2 },
                        bonusDesc: '+40 rad odolnost, +2 Vn칤m치n칤'
                    },
                    armor: {
                        id: 'nomad_set_armor',
                        name: 'Cestovatelsk칳 pl치코콘',
                        icon: '游빈',
                        slot: 'armor',
                        defense: 10,
                        weight: 2,
                        price: 850,
                        rarity: 'legendary',
                        bonus: { travelSpeed: 0.15 },
                        bonusDesc: '-15% 캜as cestov치n칤'
                    },
                    weapon: {
                        id: 'nomad_set_weapon',
                        name: 'Pou코tn칤 orel',
                        icon: '游댦',
                        slot: 'weapon',
                        damage: 42,
                        ammoType: '762',
                        weight: 3,
                        price: 1400,
                        rarity: 'legendary',
                        bonus: { per: 3, lck: 2 },
                        bonusDesc: '+3 Vn칤m치n칤, +2 맚캩st칤'
                    }
                },
                setBonus2: { desertWalker: true, desc: '+15% 칰hyb, 쮂셬e켿 kles치 o 30% pomaleji' },
                setBonus3: { npcTrust: 30, desc: 'Nov칤 NPC ti hned d콢v캩콏uj칤 (+30)' }
            },
            
            // MUTANT - Mutantsk칳 set (speci치ln칤 - pouze zbra켿, proto쬰 nem콢쬰 nosit zbroj)
            mutant: {
                name: 'Mutantsk칳 set',
                icon: '驕뮖잺',
                class: 'mutant',
                pieces: {
                    accessory1: {
                        id: 'mutant_set_accessory1',
                        name: 'Radioaktivn칤 j치dro',
                        icon: '游눜',
                        slot: 'accessory',
                        defense: 0,
                        weight: 0.5,
                        price: 1000,
                        rarity: 'legendary',
                        bonus: { radHeal: true, str: 2 },
                        bonusDesc: 'Radiace t캩 l칠캜칤, +2 S칤la'
                    },
                    accessory2: {
                        id: 'mutant_set_accessory2',
                        name: 'Mutantsk칳 krystal',
                        icon: '游눑',
                        slot: 'accessory',
                        defense: 0,
                        weight: 0.3,
                        price: 1200,
                        rarity: 'legendary',
                        bonus: { regenBonus: 5, end: 2 },
                        bonusDesc: '+5 HP regenerace/z치sah, +2 V칳dr'
                    },
                    weapon: {
                        id: 'mutant_set_weapon',
                        name: 'Radioaktivn칤 dr치py',
                        icon: '驕뮖잺',
                        slot: 'weapon',
                        damage: 55,
                        weight: 0,
                        price: 1500,
                        rarity: 'legendary',
                        bonus: { radDamage: 15 },
                        bonusDesc: '+15 radia캜n칤 damage'
                    }
                },
                setBonus2: { radAura: true, desc: 'Nep콏치tel칠 dost치vaj칤 5 radia캜n칤ho DMG/kolo' },
                setBonus3: { radRegenImproved: true, desc: '+8 HP p콏i z치sahu, +50% DMG v rad. z칩n치ch' }
            },
            
            // PSYCHIK - Ment치ln칤 set
            psychic: {
                name: 'Ment치ln칤 set',
                icon: '游댩',
                class: 'psychic',
                pieces: {
                    helmet: {
                        id: 'psychic_set_helmet',
                        name: 'Telepatick치 캜elenka',
                        icon: '游녬',
                        slot: 'helmet',
                        defense: 4,
                        weight: 0.2,
                        price: 800,
                        rarity: 'legendary',
                        bonus: { int: 4 },
                        bonusDesc: '+4 Inteligence'
                    },
                    armor: {
                        id: 'psychic_set_armor',
                        name: 'Psychick치 r칩ba',
                        icon: '游븿',
                        slot: 'armor',
                        defense: 6,
                        weight: 1.5,
                        price: 900,
                        rarity: 'legendary',
                        bonus: { mindShield: 0.3 },
                        bonusDesc: '30% 코ance ignorovat damage'
                    },
                    weapon: {
                        id: 'psychic_set_weapon',
                        name: 'Ment치ln칤 쬰zlo',
                        icon: '游댩',
                        slot: 'weapon',
                        damage: 35,
                        weight: 1,
                        price: 1300,
                        rarity: 'legendary',
                        bonus: { confuseChance: 0.2 },
                        bonusDesc: '20% 코ance zm치st nep콏칤tele'
                    }
                },
                setBonus2: { psychicVision: true, desc: '+25% 코ance na vz치cn칠 eventy, +20% loot' },
                setBonus3: { mindControlImproved: true, desc: '30% 코ance ovl치dnout nep콏칤tele na 1 kolo' }
            }
        };
        
        // Funkce pro z칤sk치n칤 lokalizovan칳ch atribut콢
        function getAttrs() {
            const names = {
                cs: { str: 'S칤la', end: 'V칳dr', agi: 'Obratnost', per: 'Vn칤m치n칤', int: 'Inteligence', lck: '맚캩st칤' },
                en: { str: 'Strength', end: 'Endurance', agi: 'Agility', per: 'Perception', int: 'Intelligence', lck: 'Luck' }
            };
            const lang = currentLang || 'cs';
            const n = names[lang] || names.cs;
            return {
                // Fyzick칠 atributy
                str: { 
                    name: n.str, 
                    icon: '游눩', 
                    desc: lang === 'en' ? '+2 damage per point' : '+2 damage za bod',
                    effect: 'damage',
                    perPoint: 2
                },
                end: { 
                    name: n.end, 
                    icon: '仇벒잺', 
                    desc: lang === 'en' ? '+10 max HP per point' : '+10 max HP za bod',
                    effect: 'maxHp',
                    perPoint: 10
                },
                agi: { 
                    name: n.agi, 
                    icon: '丘', 
                    desc: lang === 'en' ? '+5% speed, +2% dodge' : '+5% rychlost, +2% 칰hyb',
                    effect: 'speed',
                    perPoint: 0.05
                },
                
                // Ment치ln칤 atributy
                per: { 
                    name: n.per, 
                    icon: '游녜勇', 
                    desc: lang === 'en' ? '+5% loot, +3% crit' : '+5% loot, +3% crit',
                    effect: 'loot',
                    perPoint: 0.05
                },
                int: { 
                    name: n.int, 
                    icon: '游', 
                    desc: lang === 'en' ? '+10% XP, better crafting' : '+10% XP, lep코칤 crafting',
                    effect: 'xp',
                    perPoint: 0.10
                },
                lck: { 
                    name: n.lck, 
                    icon: '游', 
                    desc: lang === 'en' ? '+3% rare loot, +2% crit' : '+3% vz치cn칳 loot, +2% crit',
                    effect: 'luck',
                    perPoint: 0.03
                }
            };
        }
        
        // Pro zp캩tnou kompatibilitu
        const ATTRS = {
            // Fyzick칠 atributy
            str: { 
                name: 'S칤la', 
                icon: '游눩', 
                desc: '+2 damage za bod',
                effect: 'damage',
                perPoint: 2
            },
            end: { 
                name: 'V칳dr', 
                icon: '仇벒잺', 
                desc: '+10 max HP za bod',
                effect: 'maxHp',
                perPoint: 10
            },
            agi: { 
                name: 'Obratnost', 
                icon: '丘', 
                desc: '+5% rychlost, +2% 칰hyb',
                effect: 'speed',
                perPoint: 0.05
            },
            
            // Ment치ln칤 atributy
            per: { 
                name: 'Vn칤m치n칤', 
                icon: '游녜勇', 
                desc: '+5% loot, +3% crit',
                effect: 'loot',
                perPoint: 0.05
            },
            int: { 
                name: 'Inteligence', 
                icon: '游', 
                desc: '+10% XP, lep코칤 crafting',
                effect: 'xp',
                perPoint: 0.10
            },
            lck: { 
                name: '맚캩st칤', 
                icon: '游', 
                desc: '+3% vz치cn칳 loot, +2% crit',
                effect: 'luck',
                perPoint: 0.03
            }
        };
        
        // Funkce pro v칳po캜et bonus콢 z atribut콢
        function getAttrBonus(attr) {
            const base = state.char.attrs[attr] || 5;
            const attrData = ATTRS[attr];
            if (!attrData) return 0;
            return (base - 5) * attrData.perPoint; // Bonus nad base 5
        }
        
        // === HUMORN칄 TEXTY (Fallout style) ===
        const HUMOR = {
            // Pasti
            trap: [
                "맓치pl jsi do pasti! N캩kdo ji nastavil na idioty. Funguje skv캩le.",
                "Past! Kdo sakra d치v치 medv캩d칤 past do supermarketu?!",
                "Dr치t캩n치 past ti elegantn캩 roz콏칤zla kalhoty. A nohu. Hlavn캩 nohu.",
                "Gratuluji, na코el jsi past. Bohu쬰l nohou.",
                "Past sklapla. Tv치 hrdost utrp캩la v칤c ne tvoje noha.",
                "Na코el jsi skrytou past! Plot twist: Ona na코la tebe.",
                "N캩kdo tu nechal d치rek. Bol칤 to.",
                "Past 1, Ty 0. Zkus to p콏칤코t캩 o캜ima.",
                "P콏edv치le캜n치 past st치le funguje. Kvalita!",
                "Tv치 noha pr치v캩 objevila lok치ln칤 atrakci.",
                "Krok, cvak, au. V tomto po콏ad칤.",
                "Na코el jsi past. Tv치 noha nesouhlas칤 s metodou.",
                "N캩kdo m캩l moc 캜asu a dr치tu. Ty m치코 m칠n캩 krve.",
                "Past aktivov치na! Achievement unlocked: Idiot.",
                "Detekce past칤: F. Bolest: A+."
            ],
            
            // Kr치de쬰 - kdy T캨 okradli
            theftFail: [
                "Sakra! M캩l jsi l칠pe hl칤dat kapsy.",
                "Zlod캩j byl rychlej코칤. A 코ikovn캩j코칤.",
                "Okraden! Aspo켿 m치코 d콢vod k paranoi.",
                "Tvoje pen칤ze maj칤 nov칠ho majitele.",
                "Kapsy pr치zdn캩j코칤 ne tv콢j v칳raz.",
                "N캩kdo ti pr치v캩 uleh캜il invent치콏.",
                "Profesion치l! (On, ne ty.)",
                "M캩l jsi d치vat pozor. Te캞 je pozd캩.",
                "Zlod캩j 1, Tv치 ostra쬴tost 0.",
                "Tv칠 pen칤ze utekly. S pomoc칤.",
                "Pickpocket skill: 100. Tv치 pozornost: 0.",
                "Na코el ses. Bez pen캩z.",
                "Karma? Ne, jen 코ikovn칠 prsty cizince."
            ],
            
            // Smrt nep콏치tel
            kill: [
                "je mrtv칳. Nem캩l si vyb칤rat tuhle kari칠ru.",
                "ode코el na v캩캜nost. Bez doporu캜en칤.",
                "u netr치p칤. R.I.P. = Rest In Pieces.",
                "padl. Gravitace op캩t v칤t캩z칤.",
                "je po n캩m. Dal코칤 z치kazn칤k pro zdej코칤 krysy.",
                "skon캜il. P콏칤roda d캩kuje za recyklaci.",
                "zem콏el jak 쬴l - blb캩.",
                "u nebude obt캩쬺vat. Nikdy.",
                "ode코el. Poslal jsi ho do d콢chodu. Permanentn칤ho.",
                "je toast. Doslova pokud m치코 plamenomet.",
                "se rozpadl na sou캜치stky. Neopraviteln칠.",
                "obdr쬰l fat치ln칤 chybu. Nelze restartovat.",
                "se odpojil. Permanentn캩.",
                "dostal rychlokurz anatomie. Zevnit콏.",
                "p콏estal existovat. Jak poetick칠.",
                "na코el klid. A 6 stop pod zem칤.",
                "zm캩nil stav na 'mrtv칳'. Update complete.",
                "ode코el do offline re쬴mu. Nav쬯y."
            ],
            
            // J칤dlo - divn칠
            foodWeird: [
                "Sn캩dl jsi 200 let starou konzervu. Nem치코 co ztratit.",
                "Maso nezn치m칠ho p콢vodu. Chu콘? Taky nezn치m치.",
                "Recept babi캜ky. Pokud babi캜ka byla kanibal.",
                "Jedl칠? Technicky ano. Chutn칠? Neptej se.",
                "Tv콢j 쬬ludek t캩 pr치v캩 odsoudil k smrti.",
                "Expirov치no p콏ed v치lkou. Asi. Mo쬹치. Kdo v칤.",
                "Chutnalo to jako l칤tost a zka쬰n칠 sny.",
                "Gordon Ramsay by plakal. Ty taky, ale z jin칳ch d콢vod콢.",
                "Nutri캜n칤 hodnota: Existuje. Asi.",
                "Sn캩dl jsi to. Pro캜? S치m nev칤코.",
                "Mystery meat! Chu콘 p콏ekvapen칤. A bakteri칤.",
                "Konzervovan치 nostalgie. A salmonela.",
                "Jedl jsi hor코칤. Asi. Doufej.",
                "Tv칠 chu콘ov칠 poh치rky podaly rezignaci.",
                "To bylo j칤dlo? Tv콢j 쬬ludek m치 pochybnosti."
            ],
            
            // Hlad
            hunger: [
                "Tv콢j 쬬ludek hraje symfonii um칤raj칤c칤ch velryb.",
                "Tak hladov칳, 쬰 i ten mutant vypad치 chutn캩.",
                "Posledn칤 j칤dlo: P콏ed 2 dny. P콏칤코t칤: Kdy najde코.",
                "Hlad level: Seral bych vlastn칤 botu.",
                "Tv치 tr치vic칤 soustava podala v칳pov캩캞.",
                "콯aludek: 'Hele, pamatuje코 si j칤dlo? J치 taky ne.'",
                "Hladov캩n칤 jako 쬴votn칤 styl. Nevolunt칠rn캩.",
                "J칤dlo je p콏ece켿ovan칠. 콎칤k치 tvoje pr치zdn칠 b콏icho.",
                "Kru캜칤 ti v b콏i코e jako motor od tanku.",
                "Tv칠 vnit콏nosti hraj칤 heavy metal."
            ],
            
            // Radiace
            radiation: [
                "Sv캩t칠lkuje코! Na p치rty bys byl hv캩zda.",
                "Dal코칤 d치vka radiace. Mo쬹치 z칤sk치코 superschopnosti. Asi ne.",
                "Tvoje vlasy: 'Tak j치 jdu, 캜au.'",
                "Geiger 콏칤k치, 쬰 jsi top. Doktor by 콏ekl n캩co jin칠ho.",
                "Radiace t캩 objala jako star치 zn치m치. Jedovat치 zn치m치.",
                "Sv칤t칤코 ve tm캩! Romantick칠 a smrteln칠.",
                "Oz치콏en! Evoluce za 5 minut. Darwin by plakal.",
                "Gratulujeme k d치vce vitam칤nu R(adiace)!",
                "Tv칠 bu켿ky pr치v캩 콏ekly 'what the f***'.",
                "Dal코칤 krok k tomu st치t se lucernou.",
                "Z치콏칤코! Doslova. A ne v dobr칠m smyslu.",
                "Tv치 DNA pr치v캩 provedla jazz improvizaci.",
                "Bonus radiace! Tv칠 org치ny nejsou nad코en칠.",
                "Geiger counter goes brrrrr.",
                "Oz치콏en a neinformov치n. Klasika."
            ],
            
            // Loot - nic
            lootEmpty: [
                "Pr치zdn칠. Jako tv콢j bankovn칤 칰캜et p콏ed v치lkou.",
                "Nic. N캩kdo tu byl rychlej코칤. Nebo tu nikdy nic nebylo.",
                "Na코el jsi prach, zklam치n칤 a existenci치ln칤 krizi.",
                "Obsah: Vzduch a zklam치n칤.",
                "Pr치zdn캩j코칤 ne sliby politik콢.",
                "Nic. Absolutn칤, kosmick칠 nic.",
                "Loot: 404 Not Found.",
                "N캩kdo tu uklidil. V apokalypse. V치쬹캩.",
                "Pr치zdno. Vakuum. Void. Nic.",
                "Nalezeno: Prach. Hodn캩 prachu.",
                "Expected loot: Something. Actual loot: Nothing.",
                "Pr치zdn칠 jako tv칠 nad캩je.",
                "Zero. Zilch. Nada. Nic."
            ],
            
            // Loot - bordel
            lootJunk: [
                "Nalezeno: Hromada sra캜ek a jedna funk캜n칤 tu쬶a.",
                "Jackpot! ...pokud sb칤r치코 rezav칠 plechovky.",
                "Poklad! Pro n캩koho, kdo sb칤r치 odpadky.",
                "Wow, tolik... nevyu쬴teln칳ch v캩c칤.",
                "Sb캩ratel odpadu by byl v ext치zi.",
                "Technicky je to loot. Technicky.",
                "Haraburd칤 deluxe edition.",
                "N캩kdo tohle schoval. Pro캜?",
                "Retro odpad. Vintage smet칤.",
                "Sb칤r치코 bordel? Tak se raduj!"
            ],
            
            // Loot - dobr칳
            lootGood: [
                "Svat칳 gr치l pustiny: N캩co u쬴te캜n칠ho!",
                "Na코el jsi n캩co dobr칠ho! Zapi코 do kroniky.",
                "Loot goblini by byli hrd칤.",
                "Kone캜n캩 n캩co, co nen칤 tot치ln칤 odpad!",
                "Jackpot! Skute캜n칳, tentokr치t!",
                "RNG bohov칠 se usm치li!",
                "V치noce p콏i코ly brzy!",
                "Ko콏ist! A u쬴te캜n치!",
                "N캩kdo tu nechal poklad. D칤ky!",
                "맚캩st칤 existuje. D콢kaz v ruce."
            ],
            
            // Vstup do lokac칤
            locations: {
                obchod: "Otev콏eno 24/7. U 200 let bez person치lu.",
                nemocnice: "Vstup na vlastn칤 nebezpe캜칤. Doktor mo쬹치 p콏e쬴l. Jako ghoul.",
                tovarna: "Kde se sny m캩nily na produkty. Te캞 se m캩n칤 v tetanus.",
                kostel: "B콢h mo쬹치 odpou코t칤. Mutanti v krypt캩 ne.",
                skola: "Vzd캩l치n칤 je d콢le쬴t칠. Kulky taky.",
                byt: "Domov n캩koho. Te캞 domov prachu a vzpom칤nek.",
                sklep: "Temn칳, vlhk칳, pln칳 p콏ekvapen칤. V캩t코inou nemil칳ch."
            },
            
            // Obchodn칤k dialogy
            trader: [
                "V칤tej! Kup n캩co nebo vypadni. Nejl칤p oboj칤.",
                "Ceny jsou kone캜n칠. Jako v캩t코ina m칳ch z치kazn칤k콢.",
                "Slevu? Ha! Dobrej vtip. M치코 n캩co na prodej?",
                "Cash only. Karty neberem od roku... no, od v쬯ycky.",
                "Nakupuj, nebo se koukej. Ale neo코ah치vej zbo쮂.",
                "Kvalitn칤 zbo쮂! V캩t코inou. N캩kdy. Ob캜as.",
                "V칤t치m! Pen칤ze nahoru, ot치zky dol콢.",
                "Z치kazn칤k je kr치l. S pr치zdnou kapsou je 쬰br치k.",
                "M치m co pot콏ebuje코. Za cenu co nechce코.",
                "Nakup nebo uhni. 캛as jsou pen칤ze.",
                "V코echno na prodej. I moje babi캜ka. Vtip. Mo쬹치."
            ],
            
            // Doktor dialogy
            doctor: [
                "Nem치m anestezii, ale m치m kus d콏eva na kous치n칤.",
                "Co t캩 bol칤? V코echno? Typick칠.",
                "Progn칩za: Bude코 쮂셦. Mo쬹치. Zaplat칤코 p콏edem.",
                "Tohle bude bolet. Tebe v칤c ne m캩.",
                "Jsem doktor, ne kouzeln칤k. Ale zkus칤m to.",
                "Vid캩l jsem hor코칤. Ale ne o moc.",
                "Operace? Jasn캩. Kde je n콢 od chleba?",
                "Diagn칩za: 콯ije코. L칠캜ba: Pla콘.",
                "Neboj, tohle jsem d캩lal u dvakr치t. Jednou 칰sp캩코n캩.",
                "V칳born캩, dal코칤 pacient! M치코 poji코t캩n칤? Vtip."
            ],
            
            // No캜n칤 ud치losti
            night: [
                "Sly코칤코 kroky. Mo쬹치 mutant. Mo쬹치 v칤tr. Mo쬹치 paranoie.",
                "N캩co se h칳be ve tm캩. Tvoje p콏edstavivost? Doufejme.",
                "Hv캩zdy jsou kr치sn칠. Radiace je rozsv칤tila.",
                "Noc je temn치 a pln치... no, v코eho mo쬹칠ho.",
                "Ka쬯칳 zvuk = potenci치ln칤 smrt. Dobrou noc!",
                "Tma. Ticho. A ten pocit, 쬰 nejsi s치m.",
                "No캜n칤 sm캩na. Nep콏치tel칠 maj칤 v칳hodu.",
                "Ve tm캩 jsou v코echny ko캜ky 코ed칠. A nebezpe캜n칠.",
                "M캩s칤c sv칤t칤. Mutanti taky.",
                "Noc je mlad치. Ty mo쬹치 nebude코 star칳.",
                "Ticho p콏ed bou콏칤. Nebo p콏ed 칰tokem.",
                "Vid칤코 st칤ny. N캩kter칠 vid칤 tebe."
            ],
            
            // Zvl치코tn칤 n치lezy
            finds: [
                "Na코el jsi kostru obj칤maj칤c칤 pr치zdnou l치hev whisky. Mood.",
                "Kostra sed칤 na z치chod캩. Zem콏el jak 쬴l.",
                "Nalezena cedule: 'Den 1: V코echno bude ok.' Nebyla.",
                "Den칤k: 'Den 47 - sousedi u nevon칤, ale jsou v칳쬴vn칤.'",
                "N치pis na zdi: 'Byl jsem tu. Te캞 nejsem. RIP.'",
                "Fotka rodiny. V코ichni se usm칤vaj칤. D치vno.",
                "Seznam 칰kol콢: 1) P콏e쮂셦. (nedokon캜eno)",
                "Posledn칤 SMS: 'Miluji t캩. P콏ijdu dom...' (nedoru캜eno)",
                "Den칤k: 'Den 1: Jsem optimista!' Den 200: (pr치zdn칠 str치nky)",
                "Nalezena pozn치mka: 'Pokud tohle 캜te코, ut칤kej.'",
                "Foto psa. Na rubu: 'Jedin칳 p콏칤tel.' Smutn칠.",
                "Kresba d칤t캩te: Dome캜ek, slun칤캜ko, houba... atomov치.",
                "N치pis: 'Zde bydlel 코t캩st칤. Odst캩hovalo se.'",
                "Kostra s den칤kem: 'Jsem fajn, jen odpo캜칤v치m...'"
            ],
            
            // Mutace
            mutation: [
                "Gratuluji k mutaci! Matka p콏칤roda ti pos칤l치 'd치rek'.",
                "Nov치 mutace! Tv칠 t캩lo si 콏칤k치: 'Dr쬾e mi pivo.'",
                "Zmutoval jsi! Aspo켿 bude코 zaj칤mav칳 na poh콏bu.",
                "Evoluce za 5 minut. Darwin by plakal. Nebo aplaudoval.",
                "Nov치 funkce odem캜ena! Vedlej코칤 efekty se mohou li코it.",
                "Mutace! Tv칠 DNA pr치v캩 콏eklo 'yolo'.",
                "P콏ekvapen칤 od radiace! Mo쬹치 dobr칳. Mo쬹치 ne.",
                "Level up! ...zp콢sobem, kter칳 jsi nepl치noval.",
                "Gratulujeme! Jsi te캞 o krok bl칤 k X-Men.",
                "Mutace aktivov치na! Vedlej코칤 칰캜inky: P콏ekvapen칤!",
                "Tv칠 geny: 'Hold my beer.'",
                "Nov치 schopnost! Cena: Tv치 normalita.",
                "Evoluce speedrun! WR pace!"
            ],
            
            // Boj - za캜치tek
            combatStart: [
                "캛as na bolest! (Jejich, doufejme.)",
                "Iniciativa! A콘 쬴je ten, kdo p콏e쬴je!",
                "Boj! Diplomacie selhala. Jak obvykle.",
                "N캩kdo chce zem콏칤t. A콘 to nejsi ty.",
                "Violence is the answer. What was the question?",
                "Round 1, FIGHT!",
                "캛as 콏e코it v캩ci po zl칠m.",
                "Konverzace skon캜ila. Kulky mluv칤.",
                "Smrt nebo sl치va! Preferuji sl치vu.",
                "P콏iprav se! Tohle bude bolestiv칠.",
                "칔tok! Nebo 칰t캩k. Tv치 volba.",
                "Boj na 쬴vot a na smrt. Hlavn캩 jejich."
            ],
            
            // Boj - 칰t캩k
            fleeSuccess: [
                "Utekl jsi! Zbab캩lost = p콏e쬴t칤. Matematika.",
                "Strategick칳 칰stup! (캛ti: Panika콏il jsi a b캩쬰l.)",
                "P콏e쬴l jsi! Hrdost ne, ale whatever.",
                "Run! Funguje od prav캩ku.",
                "Nohy > Hrdost. V쬯ycky.",
                "Taktick칳 odvrat! Zn칤 l칤p ne 칰t캩k.",
                "콯ije코! Ute캜 a bojuj jindy.",
                "Speed boost: Activated by fear.",
                "Ut칤kej, Forrest, ut칤kej!",
                "Odvaha je p콏ece켿ovan치. Nohy ne."
            ],
            fleeFail: [
                "칔t캩k selhal! Mus칤코 bojovat.",
                "Nedostal ses daleko. Te캞 to bude bolet.",
                "B캩쬰l jsi, ale ne dost rychle. Boj!",
                "Nep콏칤tel t캩 dostihl! Nen칤 칰niku.",
                "칔t캩k zam칤tnut! 캛as vyt치hnout zbra켿.",
                "Zakopnut칤! Te캞 mus칤코 bojovat.",
                "맗atn칳 sm캩r! A te캞 boj.",
                "Slep치 uli캜ka! Oto캜ka a bojuj!",
                "Nohy selhaly. Ruce mus칤 zabrat."
            ],
            
            // Vy캜erp치n칤
            exhaustion: [
                "Jsi unaven칳 jak pes po maratonu. V pou코ti. Bez vody.",
                "Tv칠 nohy 콏칤kaj칤 'ne'. Tv칠 t캩lo 콏칤k치 'N칄칄칄'.",
                "Vy캜erpan칳! Pot콏ebuje코 odpo캜inek. A terapii.",
                "Energie: 404 Not Found.",
                "Running on empty. Doslova.",
                "Tv칠 t캩lo pr치v캩 podalo dvout칳denn칤 v칳pov캩캞.",
                "Baterie vybita. Nab칤jen칤 nutn칠.",
                "Error: Energy.exe stopped working.",
                "Vy캜erpan칳 jak baterka v zombie apokalypse.",
                "Sp치nek je pro slab칠. Ty jsi slab칳.",
                "칔nava level: Zombie bez k치vy.",
                "Tv칠 svaly st치vkuj칤. A vyhr치vaj칤."
            ],
            
            // Obecn칠 hl치코ky p콏i akc칤ch
            general: [
                "Dal코칤 den v r치ji. Radioaktivn칤m r치ji.",
                "Aspo켿 nen칤 pond캩l칤. Mysl칤m.",
                "Mohl bys b칳t mrtv칳. Progress!",
                "P콏e쬴l jsi! Zat칤m. D콢raz na 'zat칤m'.",
                "Ka쬯칳 den nad zem칤 je dobr칳 den.",
                "Apokalypsa: 1, Ty: 0.5. Ale po콏치d hraje코!",
                "콯ije코! To je v칤c ne v캩t코ina.",
                "Dal코칤 den, dal코칤 pokus nezem콏칤t.",
                "Survival mode: Aktivn칤. St치le.",
                "Pozitivn칤 my코len칤: Aspo켿 nepr코칤. Kyselinou.",
                "Keep calm and... no, kdo si d캩l치m srandu.",
                "Dnes neum콏e코! Mo쬹치. Snad. Doufej."
            ],
            
            // Casino - prohry (50+ hl치코ek)
            casinoLose: [
                "D콢m v쬯ycky vyhr치v치. Jako v쬯ycky.",
                "Tv칠 pen칤ze 코ly na lep코칤 m칤sto. No, vlastn캩 ne.",
                "Kostky ti 콏ekly 'ne'. Dost d콢razn캩.",
                "맚캩st캩na je mrcha. Dnes obzvl치코콘.",
                "Bohov칠 n치hody nejsou pot캩코eni.",
                "Kapit치n Sm콢la ude콏il znovu!",
                "N캩kde se sm캩je krupi칠r. A nen칤 to s tebou.",
                "Matematick치 pravd캩podobnost: Proti tob캩.",
                "Prohr치l jsi. 맔ejd vzadu u t콏epe rukama.",
                "Bankrot se bl칤쮂. C칤t칤코 to?",
                "Tv치 strategie: Existovala v콢bec?",
                "Kasino d캩kuje za p콏칤sp캩vek.",
                "Ho캞 minci a pokra캜uj... moment.",
                "Finan캜n칤 poradce by plakal.",
                "To bolelo. Hlavn캩 pen캩쬰nku.",
                "N치hoda je krut치 pan칤.",
                "Dal코칤 prohra do sb칤rky!",
                "Pen칤ze jsou p콏ece켿ovan칠. Prej.",
                "Sm콢la? Ne, to je talent.",
                "Tv치 pen캩쬰nka pos칤l치 S.O.S.",
                "Aspo켿 m치코 zdrav칤. Zat칤m.",
                "Prohra 캜칤slo... kolik vlastn캩?",
                "맚캩st칤 se na tebe vyka코lalo.",
                "Mo쬹치 p콏칤코t캩. Mo쬹치. Asi ne.",
                "Dej si pauzu. Nebo ne, je to tvoje volba.",
                "Krupi칠r poslal d칤ky.",
                "Dal코칤 lekce pokory.",
                "Hra t캩 nem치 r치da. Je to vz치jemn칠?",
                "맔ejd si u brous칤 ruce.",
                "Investice do z치bavy. Bolestiv칠 z치bavy.",
                "Tv칠 코t캩st칤 je na dovolen칠.",
                "N치hoda rozhodla. 맗atn캩.",
                "Zase nic. P콏ekvapen칤?",
                "Pen칤ze utekly. Rychle.",
                "Kasino: 1, Ty: 0. Zase.",
                "Dal코칤 den, dal코칤 prohra.",
                "Tv치 s칠rie... neskon캜ila dob콏e.",
                "N캩kdo musel prohr치t. Ty jsi se p콏ihl치sil.",
                "Prohr치v치코 s gr치ci칤. Skoro.",
                "마nce byly proti tob캩. Potvrzeno.",
                "Mo쬹치 zkus n캩co jin칠ho. T콏eba pr치ci.",
                "N치hoda nen칤 tv콢j kamar치d.",
                "Prohr치l jsi. Sv캩t se to캜칤 d치l.",
                "Dal코칤 kapitola v knize proher.",
                "Kasino prosperuje. D칤ky tob캩.",
                "Tv치 strategie pot콏ebuje strategii.",
                "Sm콢la loves you.",
                "Prachy jsou fu캜. Jako v쬯ycky.",
                "Zkus to znovu. V칳sledek bude stejn칳.",
                "Hazard: 1, Rozum: 0."
            ],
            
            // Casino - v칳hry (40+ hl치코ek)
            casinoWin: [
                "VYHR츼L JSI! Nezapome켿 na dan캩. Vtip, apokalypsa.",
                "Pen칤ze! Te캞 je rychle prom캩켿 v dal코칤 prohru!",
                "맚캩st칤 p콏eje odv치쬹칳m! Nebo blb칳m. Jedno z toho.",
                "V칳hra! 맔ejd vzadu vypad치 zklaman캩.",
                "V칤t캩z v칤t캩z, rad코v치b칤 ve캜e콏e!",
                "Na moment jsi bohat코칤. U쬴j si to.",
                "Kostky t캩 maj칤 r치dy! Prozat칤m.",
                "Z치zrak! Zapi코 datum do kalend치콏e.",
                "Kasino je v 코oku. Ty taky.",
                "Jde to nahoru! Ale nadlouho?",
                "Dobr치 hra! Te캞 to vsa캞 znovu!",
                "Chytr칳 tah! Nebo n치hoda. Asi n치hoda.",
                "Dnes m치코 코t캩st칤. U쬴j si to, z칤tra nebude.",
                "Kone캜n캩 v칳hra! Bylo to t캩쬶칠, co?",
                "Pen캩쬰nka se usm칤v치!",
                "N치hoda byla na tv칠 stran캩!",
                "맔ejd pl치캜e v kout캩.",
                "Kdo by to byl 콏ekl? Ty ne.",
                "V칳hra! Ne캜ekan치, ale v칤tan치.",
                "Bohov칠 gamblingu t캩 po쬰hnali!",
                "맚캩st캩na mrkla. Rychle, ne si to rozmysl칤!",
                "Prachy jsou tvoje! Na chv칤li.",
                "Kasino pr치v캩 ztratilo. Vz치cn칠.",
                "Tv치 s칠rie za캜칤n치! Nebo kon캜칤. Uvid칤me.",
                "Dob콏e zahr치no! Nebo dob콏e hozeno. Jedno z toho.",
                "Pen칤ze p콏ibyly! Jako by to bylo t캩쬶칠.",
                "V칳hra je v칳hra. I mal치.",
                "맔ejd si kou코e nehty.",
                "맚캩st칤 kone캜n캩 dorazilo!",
                "Krupi칠r nen칤 nad코en칳. Ty jo.",
                "N치hoda se usm치la. Vz치cn칳 jev.",
                "Bohatstv칤! No, relativn캩.",
                "Vyhr치l jsi! Zapamatuj si ten pocit.",
                "Pen캩쬰nka tloustne!",
                "Z치zraky se d캩j칤. Tady. Te캞.",
                "Dal코칤 v칳hra do sb칤rky!",
                "맚캩st캩na je s tebou. Dnes.",
                "Kasino truchl칤. Ty slav칤코.",
                "Dobrej! Ale nezvykej si.",
                "Prachy v kapse. Lep코칤 ne v kasinu."
            ],
            
            // Casino - jackpot (30+ hl치코ek)
            casinoJackpot: [
                "游꿣 JACKPOT!!! 맔ejd omdlel!",
                "KRUCIN츼L! To se fakt stalo?!",
                "MEGA V칗HRA! Ud캩lej si fotku, nikdo ti neuv캩콏칤!",
                "Z치zrak v pustin캩! B콢h gamblingu existuje!",
                "Chyba v syst칠mu ve tv콢j prosp캩ch!",
                "Bo쬰 n치hody, d칤ky za po쬰hn치n칤!",
                "Kasino pr치v캩 zaplatilo tv콢j d콢chod. Na t칳den.",
                "LEGEND츼RN칈 V칗HRA! N캩kde pl치캜e pravd캩podobnost.",
                "Tohle se st치v치 jednou za 쬴vot!",
                "맔ejd vol치 sanitku. Pro sebe.",
                "NEUV캨콎ITELN칄! Statistika l쬰!",
                "Jackpot! Te캞 rychle ut칤kej!",
                "Kasino vyhla코uje bankrot. Vtip. Nebo ne?",
                "BOMBA! Pen칤ze v코ude!",
                "Krupi칠r dostal infarkt. Skoro.",
                "Tohle je sen, ne? NE! Je to realita!",
                "MEGA JACKPOT! 맔ejd bre캜칤.",
                "Z치zrak! P칤코ou o tob캩 legendy!",
                "Vyhr치l jsi v칤c ne cel치 vesnice za rok!",
                "맚캩st캩na t캩 pol칤bila. Francouzsky.",
                "ASTRONOMICK츼 V칗HRA!",
                "Kasino t캩 nen치vid칤. Tento jeden trik...",
                "Jackpot! Pov캩z n치m tv칠 tajemstv칤!",
                "Neuv캩콏iteln칠! Nepravd캩podobn칠! Ale pravdiv칠!",
                "맔ejd nab칤z칤 partnerstv칤. Odm칤tni.",
                "BRUT츼LN칈 V칗HRA! Respekt!",
                "Bohov칠 gamblingu jsou s tebou!",
                "Tohle se d캩je jednou za tis칤c her!",
                "V칗HRA STOLET칈! No, dne코ka.",
                "Kasino kontroluje kostky. Jsou v pohod캩."
            ],
            
            // Casino - blackjack bust (25+ hl치코ek)
            casinoBust: [
                "P콎ETAH! Chamtivost zab칤j칤. A pen캩쬰nky.",
                "21 bylo tak bl칤zko... a tak daleko.",
                "P콏et치hl jsi. Jako v쬯ycky u baru.",
                "Karty 콏ekly 'Ne.' Dost jasn캩.",
                "M캩l jsi st치t. 콎칤kal jsem to? Ne? M캩l jsem.",
                "Matematika je t캩쬶치. Pro tebe obzvl치코콘.",
                "22 nen칤 21. P콏ekvapiv칠, co?",
                "Dal코칤 karta byla 코patn칳 n치pad.",
                "Chamtivost t캩 zni캜ila. Znovu.",
                "Cht캩l jsi moc. Dostal jsi nic.",
                "P콏eta쬰n칤 je um캩n칤. Zvl치d치코 ho.",
                "21? Ne, 22. Velk칳 rozd칤l.",
                "Dealer se usm칤v치. Ty ne.",
                "P콏칤li코 mnoho karet, p콏칤li코 m치lo 코t캩st칤.",
                "St치t bylo spr치vn칠 rozhodnut칤. Neud캩lal jsi ho.",
                "P콏ekro캜il jsi limit. Jako v쬯ycky.",
                "Karty t캩 zradily. Nebo ty je?",
                "P콏etah! Klasika.",
                "Jedna karta nav칤c = jedna v칳hra m칤켿.",
                "21 je maximum. Ty jsi ho p콏esko캜il.",
                "Dealer d캩kuje za snadnou v칳hru.",
                "P콏et치hl jsi. P콏ekvapen칤? Ne.",
                "Chamtivost: 1, Ty: 0.",
                "M캩l jsi p콏estat d콏칤v. Mnohem d콏칤v.",
                "Dal코칤 p콏etah do sb칤rky."
            ],
            
            // Casino - automaty (35+ hl치코ek)
            casinoSlots: [
                "游뉧릜游 Skoro! ...po캜kej, ne.",
                "Symboly: N치hodn칠. V칳hra: 콯치dn치.",
                "Automat si z tebe d캩l치 srandu.",
                "To캜, to캜, to캜... prohra.",
                "Jednou to vyjde! Statisticky. Jednou.",
                "Zato캜il jsi. Prohr치l jsi. Klasika.",
                "Symboly ti uk치zaly prost콏edn칤캜ek.",
                "Jackpot je m칳tus! ...nebo ne?",
                "Zase nic. Automat se checht치.",
                "Symboly nespolupracuj칤. Jako v쬯y.",
                "Automat spolykal dal코칤 mince.",
                "T콏e코n캩, citr칩ny, nic. Obvykl칠.",
                "Symboly se rozhodly jinak.",
                "Dal코칤 zato캜en칤, dal코칤 zklam치n칤.",
                "Automat 콏칤k치 ne. D콢razn캩.",
                "Skoro jackpot! Skoro.",
                "Symboly tancuj칤. Ale ne pro tebe.",
                "Zase vedle. Automat je krut칳.",
                "Mechanick치 코elma spolkla dal코칤 ob캩콘.",
                "To캜칤코 a to캜칤코. V칳sledek stejn칳.",
                "Sedmi캜ky? Ne dnes.",
                "Automat m치 hlad. Na tv칠 pen칤ze.",
                "Symboly: Chaos. V칳sledek: Prohra.",
                "Dal코칤 pokus, dal코칤 fail.",
                "Jackpot z콢st치v치 m칳tem.",
                "Automat: 'D칤ky za prachy!'",
                "Symboly se neshodly. Jako obvykle.",
                "To캜en칤 캜칤slo... mnoho. V칳hra: 0.",
                "Automat vyhr치v치. Ty ne.",
                "Skoro! Ale skoro nesta캜칤.",
                "Symboly jsou proti tob캩.",
                "Dal코칤 mince do nenasytn칠 bestie.",
                "Automat se sm캩je. Sly코칤코 to?",
                "V칳hra? P콏칤코t캩. Mo쬹치. Asi ne.",
                "Symboly: Random. 맚캩st칤: Nula."
            ],
            
            // 맔ejd (25+ hl치코ek)
            pawnShop: [
                "맔ejd: 'Dobr칳 k코eft!' (Pro n캩j.)",
                "Prod치no! Tv치 ztr치ta, jeho zisk.",
                "맔ejd se cul칤. Nikdy dobr칳 znak.",
                "'V칳hodn치 cena!' Vyprav캩캜: Nebyla.",
                "Prachy vl치dnou v코emu kolem m캩.",
                "N캩kdo tu d캩l치 dobr칳 byznys. Nejsi to ty.",
                "50%? Sp칤코 50% z 50%. Ale kdo po캜칤t치.",
                "맔ejd: 'Pot캩코en칤 jednat s v치mi!'",
                "Pen칤ze jsou pen칤ze. I kdy m치lo.",
                "Rychl칳 prachy, rychl치 ztr치ta.",
                "맔ejd si mne ruce. Mastn칠 ruce.",
                "Prodej uskute캜n캩n. V칳hodn캩. Pro n캩j.",
                "맔ejd: 'P콏ij캞 zas!' (Douf치.)",
                "Tv콢j odpad, jeho poklad.",
                "V칳kupn칤 cena: Sm캩코n치. Ale co nad캩l치코.",
                "맔ejd z치콏칤. Tv치 pen캩쬰nka ne.",
                "Dal코칤 obchod, dal코칤 ztr치ta hodnoty.",
                "맔ejd: 'F칠r cena!' Lol.",
                "Prod치no pod cenou. P콏ekvapen칤?",
                "맔ejd po캜칤t치 prachy. Tvoje prachy.",
                "Rychl치 transakce. Pomal칠 uv캩dom캩n칤.",
                "맔ejd: 'Kvalitn칤 zbo쮂!' Hned ho prod치 dr치.",
                "Pen칤ze v kapse. M칠n캩 ne by m캩lo b칳t.",
                "맔ejd m치 radost. Ty m칠n캩.",
                "Dal코칤 v캩c pry캜. Dal코칤 p치r minc칤."
            ]
        };
        
        // Funkce pro z칤sk치n칤 n치hodn칠ho humoru z kategorie
        function getRandomHumor(category) {
            if (!HUMOR[category]) {
                console.warn('getRandomHumor: Unknown category:', category);
                return '';
            }
            
            const texts = HUMOR[category];
            if (Array.isArray(texts)) {
                return texts[Math.floor(Math.random() * texts.length)];
            } else if (typeof texts === 'object') {
                // Pro vno콏en칠 objekty jako 'locations'
                const keys = Object.keys(texts);
                const randomKey = keys[Math.floor(Math.random() * keys.length)];
                return texts[randomKey];
            }
            return '';
        }
        
        // Barvy rarit
        const RARITY_COLORS = {
            'common': '#9e9e9e',      // 만d치
            'uncommon': '#8bc34a',    // Zelen치
            'rare': '#2196f3',        // Modr치
            'epic': '#9c27b0',        // Fialov치
            'legendary': '#ffd700'    // Zlat치
        };
        
        const RARITY_NAMES_CS = {
            'common': 'B캩쬹칳',
            'uncommon': 'Neobvykl칳',
            'rare': 'Vz치cn칳',
            'epic': 'Epick칳',
            'legendary': 'Legend치rn칤'
        };
        
        function getRarityName(rarity) {
            return RARITY_NAMES_CS[rarity] || rarity;
        }
        
        // Zp캩tn치 kompatibilita
        const RARITY_NAMES = RARITY_NAMES_CS;
        
        // 캛esk칠 n치zvy surovin
        const RESOURCE_NAMES = {
            wood: 'D콏evo', metal: 'Kov', stone: 'K치men', cloth: 'L치tka',
            leather: 'K콢쬰', herbs: 'Byliny', rope: 'Provaz', glass: 'Sklo',
            scrap: 'rot', fuel: 'Benz칤n', copper: 'M캩캞', electronics: 'Elektronika',
            chemicals: 'Chemik치lie', gunpowder: 'St콏eln칳 prach', crystal: 'Krystal',
            raw_meat: 'Syrov칠 maso', fish: 'Ryba', radaway: 'Radaway', radx: 'Rad-X',
            ammo: 'Munice', medkit: 'L칠k치rni캜ka', plutonium_core: 'Plutoniov칠 j치dro',
            fusion_cell: 'F칰zn칤 캜l치nek', ai_chip: 'AI 캜ip',
            fur: 'Ko쬰코ina', mutant_blood: 'Mutant칤 krev', silver: 'St콏칤bro', gold: 'Zlato',
            acid: 'Kyselina', gems: 'Drahokamy'
        };
        
        const RESOURCE_ICONS = {
            wood: '游뿻', metal: '丘뙖잺', stone: '游뿯', cloth: '游빗',
            leather: '游붮', herbs: '游', rope: '俱', glass: '游댩',
            scrap: '游댤', fuel: '久', copper: '游릯', electronics: '游',
            chemicals: '游빍', gunpowder: '游눤', crystal: '游눑',
            raw_meat: '游볼', fish: '游', radaway: '驕뮖잺', radx: '游눍',
            ammo: '游댦', medkit: '丘됊잺', plutonium_core: '驕뮖잺',
            fusion_cell: '游댊', ai_chip: '游뱄',
            fur: '游붉', mutant_blood: '游뽖', silver: '拘', gold: '游리',
            acid: '游릭', gems: '游눑'
        };
        
        const ITEMS = [
            // Food & Consumables (Common - 60-80% chance)
            { id: 'water', name: 'L치hev vody', icon: '游눦', type: 'consumable', effect: 'thirst', value: 40, weight: 1, price: 15, rarity: 'common', findChance: 0.8 },
            { id: 'food', name: 'Konzervovan칠 j칤dlo', icon: '游볾', type: 'consumable', effect: 'hunger', value: 35, weight: 1, price: 20, rarity: 'common', findChance: 0.75 },
            { id: 'beans', name: 'Fazole v konzerv캩', icon: '游삊', type: 'consumable', effect: 'hunger', value: 45, weight: 1, price: 25, rarity: 'common', findChance: 0.7 },
            { id: 'juice', name: 'Ovocn칳 d쬿s', icon: '游븪', type: 'consumable', effect: 'thirst', value: 50, weight: 0.5, price: 20, rarity: 'common', findChance: 0.65 },
            { id: 'coffee', name: 'K치va', icon: '驕', type: 'consumable', effect: 'energy', value: 40, weight: 0.3, price: 20, rarity: 'common', findChance: 0.6 },
            { id: 'alcohol', name: 'Alkohol', icon: '游꽄', type: 'consumable', effect: 'special_alcohol', value: 0, weight: 0.5, price: 25, rarity: 'common', findChance: 0.4, desc: '+30 energie, -20 쮂셬e켿, +15% DMG na 2h' },
            { id: 'vodka', name: 'Vodka', icon: '游볚', type: 'consumable', effect: 'special_alcohol', value: 1, weight: 0.5, price: 40, rarity: 'uncommon', findChance: 0.25, desc: '+40 energie, -25 쮂셬e켿, +20% DMG na 2h' },
            { id: 'wine', name: 'V칤no', icon: '游꽁', type: 'consumable', effect: 'special_alcohol', value: 2, weight: 0.8, price: 50, rarity: 'uncommon', findChance: 0.2, desc: '+25 energie, +15 HP, -15 쮂셬e켿' },
            
            // Uncommon consumables (30-50%)
            { id: 'medkit', name: 'L칠k치rni캜ka', icon: '丘됊잺', type: 'consumable', effect: 'health', cures: ['cold', 'flu', 'infection'], healsInjuries: ['bruise', 'cut', 'sprain', 'burn', 'concussion'], value: 50, weight: 1, price: 40, rarity: 'uncommon', findChance: 0.5, desc: 'L칠캜칤 50 HP, nemoci a v캩t코inu zran캩n칤.' },
            { id: 'energy', name: 'Energetick칳 n치poj', icon: '游댊', type: 'consumable', effect: 'energy', healsInjuries: ['exhaustion'], value: 50, weight: 0.5, price: 25, rarity: 'uncommon', findChance: 0.45, desc: '+50% energie, l칠캜칤 vy캜erp치n칤.' },
            { id: 'meat', name: 'Su코en칠 maso', icon: '游볩', type: 'consumable', effect: 'hunger', value: 55, weight: 0.5, price: 35, rarity: 'uncommon', findChance: 0.4 },
            { id: 'vitamins', name: 'Vitam칤ny', icon: '游눍', type: 'consumable', effect: 'energy', value: 30, weight: 0.2, price: 30, rarity: 'uncommon', findChance: 0.35 },
            { id: 'antibiotics', name: 'Antibiotika', icon: '游눍', type: 'consumable', effect: 'health', cures: ['flu', 'infection', 'cold'], healsInjuries: ['cut'], value: 25, weight: 0.2, price: 40, rarity: 'uncommon', findChance: 0.4, desc: 'L칠캜칤 25 HP, infekce a 콏ezn칠 r치ny.' },
            { id: 'water_purified', name: '캛ist치 voda', icon: '游눑', type: 'consumable', effect: 'thirst', value: 60, weight: 1, price: 25, rarity: 'uncommon', findChance: 0.35 },
            
            // Rare consumables (10-25%)
            { id: 'radx', name: 'Rad-X', icon: '游눍', type: 'consumable', effect: 'radiation', value: -30, weight: 0.5, price: 55, rarity: 'uncommon', findChance: 0.3, desc: 'Sn칤쮂 radiaci o 30.' },
            { id: 'radaway', name: 'RadAway', icon: '驕뮖잺', type: 'consumable', effect: 'radiation', cures: ['radiation_sickness'], value: -40, weight: 0.5, price: 85, rarity: 'rare', findChance: 0.25, desc: 'Sn칤쮂 radiaci o 40 a l칠캜칤 nemoc z oz치콏en칤.' },
            { id: 'stimpack', name: 'Stimpak', icon: '游눌', type: 'consumable', effect: 'health', healsInjuries: ['bruise', 'cut', 'sprain', 'burn', 'concussion', 'exhaustion'], value: 80, weight: 0.3, price: 75, rarity: 'rare', findChance: 0.2, desc: 'L칠캜칤 80 HP a v캩t코inu zran캩n칤.' },
            { id: 'mre', name: 'Vojensk치 d치vka', icon: '游닍', type: 'consumable', effect: 'hunger', value: 70, weight: 1.5, price: 50, rarity: 'rare', findChance: 0.15 },
            { id: 'radaway_super', name: 'RadAway Plus', icon: '驕뮖잺', type: 'consumable', effect: 'radiation', cures: ['radiation_sickness'], value: -50, weight: 0.5, price: 120, rarity: 'epic', findChance: 0.1, desc: 'Sn칤쮂 radiaci o 50 a l칠캜칤 nemoc z oz치콏en칤.' },
            
            // L칠ky na nemoci
            { id: 'herbal_tea', name: 'Bylinn칳 캜aj', icon: '游꼿', type: 'consumable', effect: 'cure_disease', cures: ['cold', 'food_poisoning'], value: 0, weight: 0.2, price: 30, rarity: 'common', findChance: 0, desc: 'L칠캜칤 nachlazen칤 a otravu j칤dlem.' },
            { id: 'purified_water', name: '캛ist치 voda', icon: '游눦', type: 'consumable', effect: 'cure_disease', cures: ['food_poisoning'], value: 20, weight: 0.5, price: 25, rarity: 'uncommon', findChance: 0.2, desc: 'Hydratuje a l칠캜칤 otravu j칤dlem.' },
            
            // L칠ky na zran캩n칤
            { id: 'bandage', name: 'Obvaz', icon: '游뽗', type: 'consumable', effect: 'heal_injury', healsInjuries: ['bruise', 'cut', 'sprain', 'burn'], value: 15, weight: 0.2, price: 20, rarity: 'common', findChance: 0.4, desc: 'L칠캜칤 15 HP a men코칤 zran캩n칤.' },
            { id: 'splint', name: 'Dlaha', icon: '游붮', type: 'consumable', effect: 'heal_injury', healsInjuries: ['fracture', 'sprain'], value: 0, weight: 0.5, price: 50, rarity: 'uncommon', findChance: 0.15, desc: 'Fixuje zlomeniny a v칳rony.' },
            { id: 'burn_cream', name: 'Mast na pop치leniny', icon: '游빖', type: 'consumable', effect: 'heal_injury', healsInjuries: ['burn'], value: 10, weight: 0.2, price: 35, rarity: 'uncommon', findChance: 0.2, desc: 'L칠캜칤 pop치leniny.' },
            { id: 'painkillers', name: 'L칠ky proti bolesti', icon: '游눍', type: 'consumable', effect: 'heal_injury', healsInjuries: ['bruise', 'concussion', 'exhaustion'], value: 0, weight: 0.1, price: 30, rarity: 'common', findChance: 0.3, desc: 'Zm칤r켿uje bolest a 칰navu.' },
            
            // Craftable consumables (pro spr치vn칠 zobrazen칤 po v칳rob캩)
            { id: 'herbal_medicine', name: 'Bylinn칳 l칠k', icon: '游', type: 'consumable', effect: 'health', cures: ['infection', 'food_poisoning'], value: 30, weight: 0.3, price: 25, rarity: 'common', findChance: 0, desc: 'L칠캜칤 30 HP, infekci a otravu j칤dlem.' },
            { id: 'cooked_meat', name: 'Pe캜en칠 maso', icon: '游꼤', type: 'consumable', effect: 'hunger', value: 50, weight: 0.5, price: 20, rarity: 'common', findChance: 0 },
            { id: 'settlement_water', name: 'Z치soby vody', icon: '游눦', type: 'consumable', effect: 'thirst', value: 30, weight: 0.5, price: 10, rarity: 'common', findChance: 0 },
            
            // Weapons - Common (40-60%)
            { id: 'wooden_bow', name: 'D콏ev캩n칳 luk', icon: '游낓', type: 'weapon', damage: 6, weight: 1, price: 40, rarity: 'common', findChance: 0.25, ammoType: 'arrow' },
            { id: 'knife', name: 'Bojov칳 n콢', icon: '游댥', type: 'weapon', damage: 8, weight: 0.5, price: 60, rarity: 'common', findChance: 0.25 },
            { id: 'bat', name: 'Baseballov치 p치lka', icon: '丘', type: 'weapon', damage: 12, weight: 2, price: 80, rarity: 'common', findChance: 0.25 },
            
            // Weapons - Uncommon (20-35%)
            { id: 'pistol', name: 'Pistole 9mm', icon: '游댦', type: 'weapon', damage: 15, weight: 2, price: 150, rarity: 'uncommon', findChance: 0.25, ammoType: '9mm' },
            { id: 'machete', name: 'Ma캜eta', icon: '游디勇', type: 'weapon', damage: 18, weight: 1.5, price: 120, rarity: 'uncommon', findChance: 0.25 },
            { id: 'hammer', name: 'V치le캜n칠 kladivo', icon: '游댣', type: 'weapon', damage: 20, weight: 3, price: 150, rarity: 'uncommon', findChance: 0.25 },
            { id: 'crossbow', name: 'Ku코e', icon: '游낓', type: 'weapon', damage: 22, weight: 3, price: 200, rarity: 'uncommon', findChance: 0.05, ammoType: 'bolt' },
            
            // Weapons - Rare (8-15%)
            { id: 'rifle', name: '칔to캜n치 pu코ka', icon: '游댦', type: 'weapon', damage: 25, weight: 4, price: 300, rarity: 'rare', findChance: 0.15, ammoType: '556' },
            { id: 'sword', name: 'Me캜', icon: '丘덢잺', type: 'weapon', damage: 24, weight: 2.5, price: 250, rarity: 'rare', findChance: 0.03 },
            { id: 'shotgun', name: 'Brokovnice', icon: '游댦', type: 'weapon', damage: 30, weight: 4.5, price: 350, rarity: 'rare', findChance: 0.05, ammoType: 'shell' },
            { id: 'chainsaw', name: '콎et캩zov치 pila', icon: '游뿤', type: 'weapon', damage: 35, weight: 6, price: 400, rarity: 'rare', findChance: 0.005, ammoType: 'fuel' },
            
            // Weapons - Epic (3-5%)
            { id: 'sniper', name: 'Sniper pu코ka', icon: '游댦', type: 'weapon', damage: 40, weight: 5, price: 500, rarity: 'epic', findChance: 0.05, ammoType: '762' },
            
            // === N츼BOJE ===
            { id: 'ammo_arrow', name: '먞셣y', icon: '俱', type: 'ammo', ammoType: 'arrow', weight: 0.1, price: 2, rarity: 'common', findChance: 0.5, stackable: true },
            { id: 'ammo_bolt', name: '말pky do ku코e', icon: '游댤', type: 'ammo', ammoType: 'bolt', weight: 0.1, price: 3, rarity: 'common', findChance: 0.4, stackable: true },
            { id: 'ammo_9mm', name: 'N치boje 9mm', icon: '游댲', type: 'ammo', ammoType: '9mm', weight: 0.05, price: 3, rarity: 'common', findChance: 0.4, stackable: true },
            { id: 'ammo_556', name: 'N치boje 5.56', icon: '游댰', type: 'ammo', ammoType: '556', weight: 0.05, price: 5, rarity: 'uncommon', findChance: 0.25, stackable: true },
            { id: 'ammo_762', name: 'N치boje 7.62', icon: '游댱', type: 'ammo', ammoType: '762', weight: 0.08, price: 8, rarity: 'uncommon', findChance: 0.15, stackable: true },
            { id: 'ammo_shell', name: 'Brokov칠 n치boje', icon: '游댮', type: 'ammo', ammoType: 'shell', weight: 0.1, price: 6, rarity: 'uncommon', findChance: 0.2, stackable: true },
            { id: 'ammo_fuel', name: 'Kanystr paliva', icon: '久', type: 'ammo', ammoType: 'fuel', weight: 2, price: 20, rarity: 'uncommon', findChance: 0.2, stackable: true },
            
            // Armor - Common (starter)
            { id: 'worn_jacket', name: 'Opot콏ebovan치 bunda', icon: '游빈', type: 'armor', defense: 6, weight: 2, price: 30, rarity: 'common', findChance: 0 },
            
            // Armor - Uncommon (25-40%)
            { id: 'helmet_basic', name: 'Helma', icon: '游뿠', type: 'helmet', defense: 10, weight: 2, price: 120, rarity: 'uncommon', findChance: 0.5 },
            
            // Armor - Rare (10-15%)
            { id: 'vest', name: 'Nepr콢st콏eln치 vesta', icon: '游붴', type: 'armor', defense: 20, weight: 3, price: 200, rarity: 'rare', findChance: 0.3 },
            
            // Armor - Epic (5%)
            { id: 'armor_heavy', name: 'T캩쬶치 zbroj', icon: '游띠勇', type: 'armor', defense: 30, weight: 8, price: 350, rarity: 'epic', findChance: 0.1 },
            
            // Tools - Common (50-70%)
            { id: 'flashlight', name: 'Baterka', icon: '游댡', type: 'tool', bonus: 'vision', weight: 0.5, price: 40, rarity: 'common', findChance: 0.7 },
            { id: 'rope', name: 'Lano', icon: '俱', type: 'tool', bonus: 'escape', weight: 2, price: 30, rarity: 'common', findChance: 0.65 },
            { id: 'sleeping_bag', name: 'Spac치k', icon: '游띒勇', type: 'tool', effect: 'sleep', value: 1, weight: 2, price: 60, rarity: 'common', findChance: 0, stackable: false, unique: true }, // Only one allowed
            
            // Tools - Uncommon (30-45%)
            { id: 'compass', name: 'Kompas', icon: '游빐', type: 'tool', bonus: 'navigation', weight: 0.3, price: 50, rarity: 'uncommon', findChance: 0.45, unique: true, maxStack: 1 },
            { id: 'binoculars', name: 'Dalekohled', icon: '游댨', type: 'tool', bonus: 'vision', weight: 1, price: 70, rarity: 'uncommon', findChance: 0.35, unique: true, maxStack: 1 },
            { id: 'backpack', name: 'Batoh', icon: '游', type: 'tool', bonus: 'capacity', weight: 1, price: 80, rarity: 'uncommon', findChance: 0.3, unique: true, maxStack: 1 },
            
            // === Z츼KLADN칈 SUROVINY (80-95%) ===
            { id: 'wood', name: 'D콏evo', icon: '游', type: 'resource', weight: 1, price: 5, rarity: 'common', findChance: 0.95 },
            { id: 'stone', name: 'K치men', icon: '游', type: 'resource', weight: 2, price: 5, rarity: 'common', findChance: 0.9 },
            { id: 'cloth', name: 'L치tka', icon: '游빗', type: 'resource', weight: 0.5, price: 8, rarity: 'common', findChance: 0.85 },
            { id: 'metal', name: 'Kov', icon: '丘뙖잺', type: 'resource', weight: 2, price: 10, rarity: 'common', findChance: 0.8 },
            
            // === ORGANICK칄 SUROVINY (40-70%) ===
            { id: 'herbs', name: 'Bylinky', icon: '游', type: 'resource', weight: 0.2, price: 15, rarity: 'common', findChance: 0.6, terrain: [0, 1] }, // les, louka
            { id: 'berries', name: 'Bor콢vky', icon: '游삃', type: 'consumable', effect: 'hunger', value: 15, weight: 0.2, price: 8, rarity: 'common', findChance: 0.5 },
            { id: 'leather', name: 'K콢쬰', icon: '游붮', type: 'resource', weight: 1, price: 20, rarity: 'common', findChance: 0.4 },
            { id: 'raw_meat', name: 'Syrov칠 maso', icon: '游볼', type: 'resource', weight: 1, price: 12, rarity: 'common', findChance: 0.5 },
            { id: 'fish', name: 'Ryba', icon: '游', type: 'resource', weight: 0.5, price: 10, rarity: 'common', findChance: 0 }, // jen ryba콏en칤
            { id: 'rope', name: 'Provaz', icon: '俱', type: 'resource', weight: 0.3, price: 12, rarity: 'common', findChance: 0.5 },
            
            // === PR콡MYSLOV칄 SUROVINY (20-40%) ===
            { id: 'fuel', name: 'Benz칤n', icon: '久', type: 'resource', weight: 1, price: 25, rarity: 'uncommon', findChance: 0.3, terrain: [2, 5] }, // ruiny, tov치rna
            { id: 'chemicals', name: 'Chemik치lie', icon: '游빍', type: 'resource', weight: 0.5, price: 35, rarity: 'uncommon', findChance: 0.25, terrain: [2, 5] },
            { id: 'glass', name: 'Sklo', icon: '游댩', type: 'resource', weight: 0.5, price: 15, rarity: 'common', findChance: 0.4, terrain: [2] },
            { id: 'electronics', name: 'Elektronika', icon: '游', type: 'resource', weight: 0.3, price: 50, rarity: 'rare', findChance: 0.15, terrain: [2, 5] },
            { id: 'gunpowder', name: 'St콏eln칳 prach', icon: '游눤', type: 'resource', weight: 0.2, price: 40, rarity: 'uncommon', findChance: 0.2, terrain: [2, 3] },
            
            // === VZ츼CN칄 RUDY (5-15%, jen t캩쬭a) ===
            { id: 'copper', name: 'M캩캞', icon: '游릯', type: 'resource', weight: 1.5, price: 20, rarity: 'uncommon', findChance: 0, terrain: [3] }, // hory
            { id: 'silver', name: 'St콏칤bro', icon: '拘', type: 'resource', weight: 1, price: 50, rarity: 'rare', findChance: 0, terrain: [3] },
            { id: 'gold', name: 'Zlato', icon: '游리', type: 'resource', weight: 0.5, price: 150, rarity: 'epic', findChance: 0, terrain: [3] },
            { id: 'gems', name: 'Drahokamy', icon: '游눑', type: 'resource', weight: 0.1, price: 100, rarity: 'rare', findChance: 0.05, terrain: [3] },
            
            // === SPECI츼LN칈 SUROVINY ===
            { id: 'mutant_blood', name: 'Mutant칤 krev', icon: '游뽖', type: 'material', weight: 0.2, price: 80, rarity: 'rare', findChance: 0, desc: 'Krev mutanta. Pou쬴teln치 pro alchymii.' }, // z mutant콢
            { id: 'fur', name: 'Ko쬰코ina', icon: '游붉', type: 'material', weight: 0.5, price: 50, rarity: 'uncommon', findChance: 0, desc: 'Kvalitn칤 ko쬰코ina. Prodej nebo craft.' }, // z vlk콢 a medv캩d콢
            { id: 'acid', name: 'Kyselina', icon: '游릭', type: 'resource', weight: 0.5, price: 60, rarity: 'rare', findChance: 0.1, terrain: [5] },
            { id: 'crystal', name: 'Krystal', icon: '游', type: 'resource', weight: 0.3, price: 120, rarity: 'epic', findChance: 0.03, terrain: [3] },
            { id: 'scrap', name: 'rot', icon: '游댤', type: 'resource', weight: 1.5, price: 8, rarity: 'common', findChance: 0.7, terrain: [2, 5] },
            
            // === KNIHY - P콎칈B캨H ===
            { id: 'lore_1', name: 'Den칤k v캩dce I', icon: '游늿', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_2', name: 'Den칤k v캩dce II', icon: '游닁', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_3', name: 'Den칤k v캩dce III', icon: '游닂', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_4', name: 'Den칤k v캩dce IV', icon: '游닃', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_5', name: 'Den칤k v캩dce V', icon: '游늽', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            
            // === N츼STROJE ===
            { id: 'fishing_rod', name: 'Ryb치콏sk칳 prut', icon: '游꿖', type: 'tool', bonus: 'fishing', bonusValue: 1, weight: 1, price: 50, rarity: 'common', findChance: 0.2, stackable: true },
            { id: 'fishing_rod_uncommon', name: 'Kvalitn칤 ryb치콏sk칳 prut', icon: '游꿖', type: 'tool', bonus: 'fishing', bonusValue: 2, weight: 1, price: 120, rarity: 'uncommon', findChance: 0.08 },
            { id: 'fishing_rod_rare', name: 'Profesion치ln칤 prut', icon: '游꿖', type: 'tool', bonus: 'fishing', bonusValue: 3, weight: 1, price: 250, rarity: 'rare', findChance: 0.03 },
            { id: 'fishing_rod_epic', name: 'Mistrovsk칳 prut', icon: '游꿖', type: 'tool', bonus: 'fishing', bonusValue: 4, weight: 1, price: 500, rarity: 'epic', findChance: 0.01 },
            { id: 'pickaxe', name: 'Krump치캜', icon: '久勇', type: 'tool', bonus: 'mining', weight: 3, price: 100, rarity: 'uncommon', findChance: 0.12 },
            { id: 'hunting_bow', name: 'Loveck칳 luk', icon: '游낓', type: 'weapon', damage: 15, bonus: 'hunting', weight: 2, price: 120, rarity: 'uncommon', findChance: 0.10, ammoType: 'arrow' },
            { id: 'radio', name: 'R치dio', icon: '游닡', type: 'tool', bonus: 'radio', weight: 1, price: 200, rarity: 'rare', findChance: 0.05 },
            { id: 'cooking_pot', name: 'Hrnec', icon: '游꼽', type: 'tool', bonus: 'cooking', weight: 2, price: 60, rarity: 'common', findChance: 0.2 },
            { id: 'alchemy_set', name: 'Alchymistick치 sada', icon: '丘勇', type: 'tool', bonus: 'alchemy', weight: 2, price: 150, rarity: 'rare', findChance: 0.08 },
            
            // === CRAFTOVAC칈 ZBRAN캨 (vz치cn캩j코칤 - lze vyrobit) ===
            // Common - z치kladn칤
            { id: 'stone_axe', name: 'Kamenn치 sekera', icon: '游뿝', type: 'weapon', damage: 10, weight: 2, price: 30, rarity: 'common', findChance: 0.15 },
            { id: 'club', name: 'Kyj', icon: '游끮', type: 'weapon', damage: 12, weight: 2, price: 25, rarity: 'common', findChance: 0.2 },
            { id: 'spear', name: 'Kop칤', icon: '游댬', type: 'weapon', damage: 15, weight: 2, price: 50, rarity: 'common', findChance: 0.03 },
            { id: 'bow', name: 'Luk', icon: '游낓', type: 'weapon', damage: 18, weight: 1.5, price: 80, rarity: 'common', findChance: 0.05, ammoType: 'arrow' },
            { id: 'slingshot', name: 'Prak', icon: '游꿢', type: 'weapon', damage: 10, weight: 0.5, price: 20, rarity: 'common', findChance: 0.25 },
            
            // Uncommon - pokro캜il칠
            { id: 'crossbow_craft', name: 'Ku코e', icon: '游낓', type: 'weapon', damage: 22, weight: 3, price: 180, rarity: 'uncommon', findChance: 0.015, ammoType: 'bolt' },
            { id: 'hammer_craft', name: 'V치le캜n칠 kladivo', icon: '游댣', type: 'weapon', damage: 20, weight: 3.5, price: 150, rarity: 'uncommon', findChance: 0.04 },
            { id: 'axe_craft', name: 'Bojov치 sekera', icon: '游뿝', type: 'weapon', damage: 24, weight: 3, price: 200, rarity: 'uncommon', findChance: 0.03 },
            { id: 'serrated_blade', name: 'Zubat치 캜epel', icon: '游댥', type: 'weapon', damage: 18, weight: 1, price: 130, rarity: 'uncommon', findChance: 0.07, special: 'bleed' },
            { id: 'barbed_club', name: 'Ostnat칳 kyj', icon: '游끮', type: 'weapon', damage: 16, weight: 2.5, price: 100, rarity: 'uncommon', findChance: 0.005, special: 'bleed' },
            { id: 'pipe_pistol', name: 'Improvizovan치 pistole', icon: '游댦', type: 'weapon', damage: 22, weight: 1.5, price: 160, rarity: 'uncommon', findChance: 0.05, ammoType: '9mm' },
            { id: 'pipe_rifle', name: 'Trubkov치 pu코ka', icon: '游댦', type: 'weapon', damage: 30, weight: 3, price: 220, rarity: 'uncommon', findChance: 0.005, ammoType: '9mm' },
            { id: 'pipe_shotgun', name: 'Trubkov치 brokovnice', icon: '游댦', type: 'weapon', damage: 35, weight: 4, price: 280, rarity: 'uncommon', findChance: 0.005, ammoType: 'shell' },
            
            // Rare - vz치cn칠
            { id: 'sword_craft', name: 'Me캜', icon: '丘덢잺', type: 'weapon', damage: 26, weight: 2.5, price: 300, rarity: 'rare', findChance: 0.03 },
            { id: 'poisoned_blade', name: 'Otr치ven치 캜epel', icon: '游디勇', type: 'weapon', damage: 20, weight: 1.5, price: 250, rarity: 'rare', findChance: 0.015, special: 'poison' },
            { id: 'hunting_rifle', name: 'Loveck치 pu코ka', icon: '游꿢', type: 'weapon', damage: 45, weight: 4, price: 450, rarity: 'rare', findChance: 0.005, ammoType: '762' },
            
            // Epic - epick칠
            { id: 'electric_baton', name: 'Elektrick치 palice', icon: '丘', type: 'weapon', damage: 28, weight: 2, price: 400, rarity: 'epic', findChance: 0.015, special: 'stun' },
            { id: 'assault_rifle_craft', name: '칔to캜n치 pu코ka', icon: '游댦', type: 'weapon', damage: 38, weight: 4, price: 550, rarity: 'epic', findChance: 0.005, ammoType: '556' },
            { id: 'double_barrel', name: 'Dvojhlav켿ov치 brokovnice', icon: '游댦', type: 'weapon', damage: 50, weight: 5, price: 600, rarity: 'epic', findChance: 0.005, ammoType: 'shell' },
            
            // Legendary - legend치rn칤
            { id: 'flamethrower', name: 'Plamenomet', icon: '游댠', type: 'weapon', damage: 40, weight: 8, price: 800, rarity: 'legendary', findChance: 0.005, ammoType: 'fuel', special: 'fire' },
            
            // === CRAFTOVAC칈 ZBROJE ===
            // Common
            { id: 'leather_armor', name: 'Ko쬰n치 zbroj', icon: '游붴', type: 'armor', defense: 16, weight: 3, price: 100, rarity: 'common', findChance: 0.24 },
            { id: 'helmet_craft', name: 'Kovan치 helma', icon: '游뿠', type: 'helmet', defense: 10, weight: 1.5, price: 80, rarity: 'common', findChance: 0.3 },
            { id: 'wooden_shield', name: 'D콏ev캩n칳 코t칤t', icon: '游뿻', type: 'armor', defense: 16, weight: 4, price: 90, rarity: 'common', findChance: 0.2, special: 'block' },
            
            // Uncommon
            { id: 'light_armor', name: 'Lehk치 zbroj', icon: '游띠勇', type: 'armor', defense: 20, weight: 4, price: 180, rarity: 'uncommon', findChance: 0.12 },
            { id: 'gas_mask_craft', name: 'Improviz. maska', icon: '游땽', type: 'helmet', defense: 6, weight: 1, price: 120, rarity: 'uncommon', findChance: 0.16, special: 'rad_resist', desc: '-30% radiace' },
            { id: 'arm_guards', name: 'Chr치ni캜e rukou', icon: '游볡', type: 'gloves', defense: 6, weight: 1.5, price: 140, rarity: 'uncommon', findChance: 0.14, special: 'block_bonus' },
            { id: 'leg_guards', name: 'Chr치ni캜e nohou', icon: '游', type: 'boots', defense: 6, weight: 2, price: 140, rarity: 'uncommon', findChance: 0.14, special: 'dodge_bonus' },
            { id: 'work_gloves', name: 'Pracovn칤 rukavice', icon: '游빇', type: 'gloves', defense: 2, weight: 0.5, price: 40, rarity: 'common', findChance: 0.3 },
            { id: 'combat_gloves', name: 'Bojov칠 rukavice', icon: '游볡', type: 'gloves', defense: 8, weight: 1, price: 200, rarity: 'rare', findChance: 0.1, special: 'unarmed_bonus', desc: '+5 damage beze zbran캩' },
            { id: 'tactical_gloves', name: 'Taktick칠 rukavice', icon: '游빇', type: 'gloves', defense: 10, weight: 1, price: 350, rarity: 'epic', findChance: 0.05, special: 'grip', desc: '+10% p콏esnost st콏elby' },
            { id: 'hiking_boots', name: 'Turistick칠 boty', icon: '游', type: 'boots', defense: 3, weight: 1.5, price: 60, rarity: 'common', findChance: 0.25, special: 'speed_bonus', desc: '+2% rychlost' },
            { id: 'combat_boots', name: 'Bojov칠 boty', icon: '游', type: 'boots', defense: 8, weight: 2.5, price: 220, rarity: 'rare', findChance: 0.1, special: 'combat_stance', desc: '+5% kritick칳 z치sah' },
            { id: 'stealth_boots', name: 'Tich칠 boty', icon: '游', type: 'boots', defense: 4, weight: 1, price: 300, rarity: 'epic', findChance: 0.06, special: 'stealth_move', desc: '-20% 코ance na p콏epaden칤' },
            // Nov칠 gloves
            { id: 'leather_gloves', name: 'Ko쬰n칠 rukavice', icon: '游빇', type: 'gloves', defense: 4, weight: 0.5, price: 80, rarity: 'common', findChance: 0.25 },
            { id: 'spiked_gloves', name: 'Ostnat칠 rukavice', icon: '游볡', type: 'gloves', defense: 6, weight: 1, price: 180, rarity: 'uncommon', findChance: 0.12, special: 'bleed_punch', desc: '칔tok p캩st칤 zp콢sob칤 krv치cen칤' },
            { id: 'power_gloves', name: 'Silov칠 rukavice', icon: '游눩', type: 'gloves', defense: 12, weight: 2, price: 500, rarity: 'epic', findChance: 0.04, special: 'power_punch', desc: '+10 damage v boji zbl칤zka' },
            { id: 'surgeon_gloves', name: 'Chirurgick칠 rukavice', icon: '游빇', type: 'gloves', defense: 1, weight: 0.1, price: 100, rarity: 'uncommon', findChance: 0.15, special: 'medic_bonus', desc: '+20% efektivita l칠캜en칤' },
            { id: 'rad_gloves', name: 'Protirad. rukavice', icon: '驕뮖잺', type: 'gloves', defense: 5, weight: 1, price: 250, rarity: 'rare', findChance: 0.08, special: 'rad_resist', desc: '-20% radiace' },
            // Nov칠 boots
            { id: 'sandals', name: 'Sand치ly', icon: '游뽒', type: 'boots', defense: 1, weight: 0.3, price: 20, rarity: 'common', findChance: 0.35, special: 'light_feet', desc: '+1% rychlost' },
            { id: 'running_shoes', name: 'B캩쬰ck칠 boty', icon: '游', type: 'boots', defense: 2, weight: 0.5, price: 90, rarity: 'common', findChance: 0.2, special: 'run_bonus', desc: '+15% 코ance na 칰t캩k' },
            { id: 'steel_boots', name: 'Ocelov칠 boty', icon: '游붰', type: 'boots', defense: 12, weight: 4, price: 350, rarity: 'rare', findChance: 0.08, special: 'stomp', desc: 'Siln칳 kop (+8 damage)' },
            { id: 'jump_boots', name: 'Skokov칠 boty', icon: '游붖', type: 'boots', defense: 6, weight: 1.5, price: 400, rarity: 'epic', findChance: 0.05, special: 'jump', desc: '+25% dodge' },
            { id: 'winter_boots', name: 'Zimn칤 boty', icon: '仇勇', type: 'boots', defense: 5, weight: 2, price: 150, rarity: 'uncommon', findChance: 0.15, special: 'warm_feet', desc: '-15% ztr치ta energie' },
            { id: 'power_boots', name: 'Exo boty', icon: '游', type: 'boots', defense: 14, weight: 3, price: 600, rarity: 'epic', findChance: 0.03, special: 'power_kick', desc: '+4% rychlost, +10 defense' },
            
            // === HELMY ===
            { id: 'cap', name: '캛epice', icon: '游빅', type: 'helmet', defense: 1, weight: 0.2, price: 15, rarity: 'common', findChance: 0.4 },
            { id: 'hard_hat', name: 'Stavebn칤 helma', icon: '久놾잺', type: 'helmet', defense: 4, weight: 1, price: 80, rarity: 'common', findChance: 0.25 },
            { id: 'motorcycle_helmet', name: 'Motork치콏sk치 helma', icon: '游뿠', type: 'helmet', defense: 8, weight: 1.5, price: 180, rarity: 'uncommon', findChance: 0.15, special: 'headshot_protect', desc: '-50% damage na hlavu' },
            { id: 'gas_mask', name: 'Plynov치 maska', icon: '游땽', type: 'helmet', defense: 3, weight: 1, price: 200, rarity: 'uncommon', findChance: 0.12, special: 'gas_filter', desc: 'Imunita na jedy' },
            { id: 'tactical_helmet', name: 'Taktick치 helma', icon: '游뿠', type: 'helmet', defense: 16, weight: 2, price: 300, rarity: 'rare', findChance: 0.06, special: 'night_vision', desc: 'No캜n칤 vid캩n칤' },
            { id: 'ballistic_helmet', name: 'Balistick치 helma', icon: '久놾잺', type: 'helmet', defense: 24, weight: 2.5, price: 380, rarity: 'epic', findChance: 0.04, special: 'crit_immune', desc: 'Imunita na kritick칠 z치sahy' },
            { id: 'rad_helmet', name: 'Protirad. helma', icon: '驕뮖잺', type: 'helmet', defense: 10, weight: 2, price: 280, rarity: 'rare', findChance: 0.08, special: 'rad_resist', desc: '-30% radiace' },
            
            // Rare Armor
            { id: 'heavy_armor', name: 'T캩쬶치 zbroj', icon: '游띠勇', type: 'armor', defense: 30, weight: 10, price: 350, rarity: 'rare', findChance: 0.06 },
            { id: 'riot_shield', name: '맚칤t', icon: '游띠勇', type: 'armor', defense: 24, weight: 5, price: 280, rarity: 'rare', findChance: 0.08, special: 'block' },
            { id: 'reinforced_vest', name: 'Zpevn캩n치 vesta', icon: '游붴', type: 'armor', defense: 36, weight: 6, price: 420, rarity: 'rare', findChance: 0.05 },
            
            // Epic Armor
            { id: 'hazmat_suit', name: 'Protichemick칳 oblek', icon: '游봎', type: 'armor', defense: 10, weight: 4, price: 400, rarity: 'epic', findChance: 0.04, special: 'rad_immune' },
            { id: 'combat_armor', name: 'Bojov치 zbroj', icon: '游띠勇', type: 'armor', defense: 44, weight: 12, price: 550, rarity: 'epic', findChance: 0.03 },
            { id: 'tower_shield', name: 'V캩쬺v칳 코t칤t', icon: '游띠勇', type: 'armor', defense: 40, weight: 10, price: 500, rarity: 'epic', findChance: 0.03, special: 'block' },
            
            // Legendary Armor
            { id: 'power_armor', name: 'Panc칠콏ov치 zbroj', icon: '游뱄', type: 'armor', defense: 60, weight: 20, price: 1200, rarity: 'legendary', findChance: 0.01, special: 'powered' },
            { id: 'stealth_suit', name: 'Stealth oblek', icon: '游봉', type: 'armor', defense: 24, weight: 3, price: 900, rarity: 'legendary', findChance: 0.02, special: 'stealth', desc: 'Neviditelnost v boji. -50% 코ance na p콏epaden칤.' },
            { id: 'berserker_armor', name: 'Zbroj berserkra', icon: '游놏', type: 'armor', defense: 50, weight: 15, price: 1100, rarity: 'legendary', findChance: 0.01, special: 'berserker', desc: '+30% damage ale -10% defense.' },
            { id: 'phoenix_cloak', name: 'Pl치코콘 F칠nixe', icon: '游댠', type: 'armor', defense: 36, weight: 2, price: 1500, rarity: 'legendary', findChance: 0.01, special: 'phoenix', desc: 'Jednou za boj: pokud bys zem콏el, obnov칤코 30% HP.' },
            { id: 'titan_plate', name: 'Titanov치 pl치t', icon: '游', type: 'armor', defense: 70, weight: 25, price: 1800, rarity: 'legendary', findChance: 0.01, special: 'titan', desc: 'Nejvy코코칤 obrana. Imunita na kritick칠 z치sahy.' },
            
            // Epic Armor - v칤ce variant
            { id: 'scout_armor', name: 'Zv캩dova zbroj', icon: '游끢', type: 'armor', defense: 20, weight: 3, price: 320, rarity: 'epic', findChance: 0.04, special: 'scout', desc: '+4% rychlost pohybu, +15% dodge.' },
            { id: 'medic_vest', name: 'Zdravotn칤 vesta', icon: '游낀', type: 'armor', defense: 16, weight: 4, price: 380, rarity: 'epic', findChance: 0.04, special: 'medic', desc: 'L칠캜en칤 je o 50% efektivn캩j코칤.' },
            { id: 'mutant_hide', name: 'Mutant칤 k콢쬰', icon: '游빏', type: 'armor', defense: 32, weight: 6, price: 450, rarity: 'epic', findChance: 0.03, special: 'mutant', desc: '+50% odolnost v콢캜i radiaci a jed콢m.' },
            { id: 'exoskeleton', name: 'Exoskelet', icon: '游', type: 'boots', defense: 40, weight: 8, price: 600, rarity: 'epic', findChance: 0.02, special: 'exo', desc: '+50% nosnost, +10% damage' },
            { id: 'nano_armor', name: 'Nano zbroj', icon: '游댧', type: 'armor', defense: 36, weight: 4, price: 700, rarity: 'epic', findChance: 0.02, special: 'nano', desc: 'Regeneruje 2 HP ka쬯칠 kolo v boji.' },
            
            // Rare Armor - v칤ce variant
            { id: 'raider_gear', name: 'N치jezdnick치 zbroj', icon: '游', type: 'armor', defense: 24, weight: 5, price: 220, rarity: 'rare', findChance: 0.08, special: 'intimidate', desc: '+10% damage, nep콏치tel칠 maj칤 -5% mor치lky.' },
            { id: 'scavenger_coat', name: 'Sb캩ra캜콢v kab치t', icon: '游빈', type: 'armor', defense: 14, weight: 2, price: 180, rarity: 'rare', findChance: 0.1, special: 'scavenger', desc: '+25% 코ance na bonus loot.' },
            { id: 'camo_suit', name: 'Maskovac칤 oblek', icon: '游', type: 'armor', defense: 12, weight: 2, price: 200, rarity: 'rare', findChance: 0.09, special: 'camo', desc: '-30% 코ance na n치hodn칠 souboje.' },
            { id: 'flame_retardant', name: 'Ohnivzdorn칳 oblek', icon: '游댠', type: 'armor', defense: 18, weight: 5, price: 250, rarity: 'rare', findChance: 0.07, special: 'fireproof', desc: 'Imunita na pop치leniny a ohniv칠 칰toky.' },
            { id: 'shock_resistant', name: 'Izola캜n칤 oblek', icon: '丘', type: 'armor', defense: 18, weight: 5, price: 250, rarity: 'rare', findChance: 0.07, special: 'insulated', desc: 'Imunita na elektrick칠 칰toky.' },
            { id: 'winter_gear', name: 'Zimn칤 v칳stroj', icon: '仇勇', type: 'armor', defense: 20, weight: 6, price: 230, rarity: 'rare', findChance: 0.08, special: 'endurance', desc: '-30% ztr치ta energie p콏i cestov치n칤.' },
            { id: 'night_stalker', name: 'No캜n칤 lovec', icon: '游깿', type: 'armor', defense: 22, weight: 4, price: 280, rarity: 'rare', findChance: 0.06, special: 'nightvision', desc: 'Bonus +15% damage v noci.' },
            
            // Uncommon Armor - v칤ce variant
            { id: 'padded_jacket', name: 'Vycpan치 bunda', icon: '游빈', type: 'armor', defense: 10, weight: 2, price: 80, rarity: 'uncommon', findChance: 0.24 },
            { id: 'sports_gear', name: 'Sportovn칤 v칳stroj', icon: '游꿯', type: 'armor', defense: 8, weight: 1.5, price: 70, rarity: 'uncommon', findChance: 0.3, special: 'agile', desc: '+10% dodge.' },
            { id: 'work_boots', name: 'Pracovn칤 boty', icon: '游녹', type: 'boots', defense: 6, weight: 1.5, price: 60, rarity: 'uncommon', findChance: 0.36, special: 'sturdy', desc: '+5% stability.' },
            { id: 'knee_pads', name: 'Chr치ni캜e kolen', icon: '游붯', type: 'armor', defense: 8, weight: 1, price: 65, rarity: 'uncommon', findChance: 0.32 },
            { id: 'welding_mask', name: 'Sv치콏e캜sk치 maska', icon: '游꿠', type: 'helmet', defense: 8, weight: 1, price: 75, rarity: 'uncommon', findChance: 0.28, special: 'flash_protect', desc: 'Ochrana p콏ed oslepen칤m' },
            { id: 'biker_jacket', name: 'Motork치콏sk치 bunda', icon: '游빈', type: 'armor', defense: 14, weight: 3, price: 110, rarity: 'uncommon', findChance: 0.2 },
            { id: 'chainmail', name: 'Krou쬶ov치 zbroj', icon: '久勇', type: 'armor', defense: 18, weight: 7, price: 150, rarity: 'uncommon', findChance: 0.16, desc: 'St콏edov캩k치 klasika. St치le funk캜n칤.' },
            
            // Common Armor
            { id: 'torn_jacket', name: 'Roztrhan치 bunda', icon: '游볢', type: 'armor', defense: 4, weight: 1, price: 25, rarity: 'common', findChance: 0.5 },
            { id: 'makeshift_vest', name: 'Provizorn칤 vesta', icon: '游녯', type: 'armor', defense: 6, weight: 1.5, price: 40, rarity: 'common', findChance: 0.4 },
            { id: 'cardboard_armor', name: 'Kartonov치 zbroj', icon: '游닍', type: 'armor', defense: 2, weight: 0.5, price: 10, rarity: 'common', findChance: 0.5, desc: 'Lep코칤 ne nic... asi.' },
            
            // === 游꿡 EASTER EGG ZBRAN캨 - 5 legend치rn칤ch p콏edm캩t콢 z kultovn칤ch her ===
            
            // Half-Life - Gordon Freeman's iconic weapon
            { id: 'crowbar', name: '캛erven칠 p치캜idlo', icon: '游댢', type: 'weapon', damage: 42, weight: 2, price: 1337, rarity: 'legendary', findChance: 0.005, special: 'freeman', desc: 'Ikonick치 zbra켿 dr. Freemana z Black Mesa. P콏e쬴la Rezona캜n칤 kask치du i invazi Combine. Nikdy nezklame.' },
            
            // The Witcher - Ciri's sword
            { id: 'zirael', name: 'Zirael', icon: '丘덢잺', type: 'weapon', damage: 65, weight: 2, price: 3000, rarity: 'legendary', findChance: 0.005, special: 'silver', desc: 'Me캜 vla코tovky. Gn칩msk치 ocel s runami star코칤 krve. "N캩co kon캜칤, n캩co za캜칤n치." - Z콢stal po Ciri, kter치 zmizela mezi sv캩ty.' },
            
            // Cyberpunk 2077 - Johnny Silverhand's gun
            { id: 'malorian', name: 'Malorian Arms 3516', icon: '游댦', type: 'weapon', damage: 68, weight: 2, price: 2077, rarity: 'legendary', findChance: 0.005, ammoType: '9mm', special: 'silverhand', desc: 'Pistole Johnnyho Silverhanda. Vyrobena na zak치zku, zni캜ila Arasaku v roce 2023. "Wake the fuck up, Samurai. We have a city to burn."' },
            
            // Doom - The BFG
            { id: 'bfg', name: 'B.F.G. 9000', icon: '游댦', type: 'weapon', damage: 100, weight: 15, price: 6666, rarity: 'legendary', findChance: 0.005, special: 'devastation', ammoType: 'fuel', desc: 'Bio Force Gun z UAC laborato콏칤 na Marsu. Devastuj칤c칤 plasmov칳 v칳boj. RIP AND TEAR, dokud to nebude hotov칠.' },
            { id: 'deathclaw_gauntlet', name: 'Rukavice Deathclawa', icon: '游붔', type: 'weapon', damage: 55, weight: 4, price: 5000, rarity: 'legendary', findChance: 0, special: 'bleed', critBonus: 15, cantBuy: true, desc: 'Brut치ln칤 zbra켿 vyroben치 z dr치pu Deathclawa. +15% krit, zp콢sobuje krv치cen칤.' },
            
            // Zelda - The Master Sword
            { id: 'master_sword', name: 'Me캜 mistr콢', icon: '游디勇', type: 'weapon', damage: 55, weight: 2, price: 3000, rarity: 'legendary', findChance: 0.005, special: 'evil_bane', desc: 'Posv치tn칳 me캜 vykovan칳 bohy Hyrule. 캛epel zah치n캩j칤c칤 zlo sp칤 v Zapomenut칠m lese a 캜ek치 na sv칠ho hrdinu. Hyaaah!' },
            
            // === BOSS TROPHY ITEMS ===
            { id: 'queen_crown', name: 'Koruna mutant칤 kr치lovny', icon: '游녬', type: 'trophy', weight: 1, price: 5000, rarity: 'legendary', desc: 'Groteskn칤 koruna z mutant칤ho chitinu. D콢kaz v칤t캩zstv칤 nad kr치lovnou hn칤zda.' },
            { id: 'deathclaw_hand', name: 'Dr치p Deathclawa', icon: '游붔', type: 'component', weight: 3, price: 3000, rarity: 'legendary', desc: 'Obrovsk칳 dr치p nejnebezpe캜n캩j코칤ho pred치tora. Lze pou쮂셦 k v칳rob캩 legend치rn칤 zbran캩 v Craftingu!' },
            { id: 'mutant_heart', name: 'Srdce Behemotha', icon: '游눞', type: 'trophy', weight: 5, price: 4000, rarity: 'legendary', desc: 'Masivn칤 pulzuj칤c칤 srdce. Pou쬴j pro +50 max HP (jednor치zov캩) nebo prodej.', usable: true },
            { id: 'ai_chip', name: 'AI Procesorov칠 j치dro', icon: '游', type: 'component', weight: 0.5, price: 2500, rarity: 'epic', desc: 'Pokro캜il칳 kvantov칳 procesor p콏edv치le캜n칠 AI. Pou쬴j v invent치콏i pro vylep코en칤 zbran캩 (+10 DMG) nebo zbroje (+10 DEF).' },
            { id: 'ai_module', name: 'AI Pam캩콘ov칳 modul', icon: '游', type: 'component', weight: 1, price: 1800, rarity: 'rare', desc: 'Pam캩콘ov칳 modul obsahuj칤c칤 fragmenty AI v캩dom칤. Prodejn칳 p콏edm캩t.' },
            { id: 'unique_artifact', name: 'Prastar칳 artefakt', icon: '游낔', type: 'artifact', weight: 2, price: 10000, rarity: 'legendary', desc: 'Z치hadn칳 p콏edm캩t z doby p콏ed v치lkou. Jeho 칰캜el z콢st치v치 nezn치m칳, ale vyza콏uje podivnou energii.' },
            { id: 'documents', name: 'Tajn칠 dokumenty', icon: '游닆', type: 'quest', weight: 0.5, price: 500, rarity: 'rare', desc: '말frovan칠 vojensk칠 dokumenty. Spr치vn칤 lid칠 za n캩 zaplat칤 hodn캩.' },
            
            // === SETY POVOL츼N칈 (Legendary) ===
            // N츼JEZDN칈K - Krvav칳 set
            { id: 'raider_set_helmet', name: 'Krvav치 p콏ilba', icon: '游뿠', type: 'helmet', defense: 8, weight: 2.5, price: 800, rarity: 'legendary', classRequired: 'raider', setId: 'raider', desc: 'Set N치jezdn칤ka (1/3): +2 S칤la' },
            { id: 'raider_set_armor', name: 'Krvav칳 panc칤콏', icon: '游붴', type: 'armor', defense: 18, weight: 8, price: 1200, rarity: 'legendary', classRequired: 'raider', setId: 'raider', desc: 'Set N치jezdn칤ka (2/3): +15% damage' },
            { id: 'raider_set_weapon', name: 'Krvav칳 palc치t', icon: '游댣', type: 'weapon', damage: 45, weight: 4, price: 1500, rarity: 'legendary', classRequired: 'raider', setId: 'raider', desc: 'Set N치jezdn칤ka (3/3): 10% lifesteal' },
            // BERSERKR - Zu콏iv칳 set
            { id: 'berserker_set_helmet', name: 'V치le캜n치 maska', icon: '游놏', type: 'helmet', defense: 5, weight: 1.5, price: 750, rarity: 'legendary', classRequired: 'berserker', setId: 'berserker', desc: 'Set Berserkra (1/3): +3 S칤la' },
            { id: 'berserker_set_armor', name: 'Zu콏iv치 zbroj', icon: '游붴', type: 'armor', defense: 12, weight: 6, price: 1100, rarity: 'legendary', classRequired: 'berserker', setId: 'berserker', desc: 'Set Berserkra (2/3): +20% rychlost 칰toku' },
            { id: 'berserker_set_weapon', name: 'Sekera 코칤lenstv칤', icon: '游뿝', type: 'weapon', damage: 55, weight: 5, price: 1600, rarity: 'legendary', classRequired: 'berserker', setId: 'berserker', desc: 'Set Berserkra (3/3): +20% damage' },
            // P콎E콯IV먞 - Veter치nsk칳 set
            { id: 'survivor_set_helmet', name: 'Veter치nsk치 p콏ilba', icon: '游뿠', type: 'helmet', defense: 12, weight: 2, price: 850, rarity: 'legendary', classRequired: 'survivor', setId: 'survivor', desc: 'Set P콏e쬴v코칤ho (1/3): +2 V칳dr' },
            { id: 'survivor_set_armor', name: 'Veter치nsk칳 panc칤콏', icon: '游띠勇', type: 'armor', defense: 25, weight: 10, price: 1400, rarity: 'legendary', classRequired: 'survivor', setId: 'survivor', desc: 'Set P콏e쬴v코칤ho (2/3): +30 max HP' },
            { id: 'survivor_set_weapon', name: 'Veter치nova brokovnice', icon: '游댦', type: 'weapon', damage: 40, ammoType: 'shell', weight: 4, price: 1300, rarity: 'legendary', classRequired: 'survivor', setId: 'survivor', desc: 'Set P콏e쬴v코칤ho (3/3): Odhod칤 nep콏칤tele' },
            // TANK - Pevnostn칤 set
            { id: 'tank_set_helmet', name: 'T캩쬶치 p콏ilba', icon: '久놾잺', type: 'helmet', defense: 18, weight: 4, price: 900, rarity: 'legendary', classRequired: 'tank', setId: 'tank', desc: 'Set Tanku (1/3): +3 V칳dr' },
            { id: 'tank_set_armor', name: 'Pevnostn칤 brn캩n칤', icon: '游띠勇', type: 'armor', defense: 35, weight: 15, price: 1800, rarity: 'legendary', classRequired: 'tank', setId: 'tank', desc: 'Set Tanku (2/3): +50 max HP' },
            { id: 'tank_set_weapon', name: 'Obrann칳 코t칤t', icon: '游띠勇', type: 'weapon', damage: 25, weight: 8, price: 1000, rarity: 'legendary', classRequired: 'tank', setId: 'tank', desc: 'Set Tanku (3/3): 20% 코ance blokovat' },
            // STOPA콎 - St칤nov칳 set
            { id: 'stalker_set_helmet', name: 'St칤nov치 kapuce', icon: '游꿠', type: 'helmet', defense: 6, weight: 0.8, price: 700, rarity: 'legendary', classRequired: 'stalker', setId: 'stalker', desc: 'Set Stopa콏e (1/3): +3 Vn칤m치n칤' },
            { id: 'stalker_set_armor', name: 'St칤nov칳 pl치코콘', icon: '游빈', type: 'armor', defense: 10, weight: 3, price: 1000, rarity: 'legendary', classRequired: 'stalker', setId: 'stalker', desc: 'Set Stopa콏e (2/3): +20% 코ance vyhnout se boji' },
            { id: 'stalker_set_weapon', name: 'Tich칳 luk', icon: '游낓', type: 'weapon', damage: 38, ammoType: 'arrow', weight: 2, price: 1200, rarity: 'legendary', classRequired: 'stalker', setId: 'stalker', desc: 'Set Stopa콏e (3/3): +50% crit damage' },
            // ASSASSIN - Vra쬰dn칳 set
            { id: 'assassin_set_helmet', name: 'Maska vraha', icon: '游꿠', type: 'helmet', defense: 4, weight: 0.5, price: 750, rarity: 'legendary', classRequired: 'assassin', setId: 'assassin', desc: 'Set Assassina (1/3): +3 Obratnost' },
            { id: 'assassin_set_armor', name: 'Vra쬰dn치 kazajka', icon: '游봉', type: 'armor', defense: 8, weight: 2, price: 950, rarity: 'legendary', classRequired: 'assassin', setId: 'assassin', desc: 'Set Assassina (2/3): +15% 칰hyb' },
            { id: 'assassin_set_weapon', name: 'Dvojit칠 캜epele', icon: '游디勇', type: 'weapon', damage: 32, weight: 1.5, price: 1400, rarity: 'legendary', classRequired: 'assassin', setId: 'assassin', desc: 'Set Assassina (3/3): +20% kritick치 코ance' },
            // MEDIK - L칠캜itelsk칳 set
            { id: 'medic_set_helmet', name: 'Chirurgick치 캜epice', icon: '游녿꽥뚯勇', type: 'helmet', defense: 5, weight: 0.5, price: 600, rarity: 'legendary', classRequired: 'medic', setId: 'medic', desc: 'Set Medika (1/3): +2 Inteligence' },
            { id: 'medic_set_armor', name: 'L칠ka콏sk칳 pl치코콘', icon: '游봎', type: 'armor', defense: 10, weight: 2, price: 900, rarity: 'legendary', classRequired: 'medic', setId: 'medic', desc: 'Set Medika (2/3): +25% l칠캜en칤' },
            { id: 'medic_set_weapon', name: 'Chirurgick칳 laser', icon: '游댡', type: 'weapon', damage: 28, weight: 1, price: 1100, rarity: 'legendary', classRequired: 'medic', setId: 'medic', desc: 'Set Medika (3/3): +5 HP p콏i z치sahu' },
            // ALCHYMISTA - Toxick칳 set
            { id: 'alchemist_set_helmet', name: 'Plynov치 maska mistra', icon: '游땽', type: 'helmet', defense: 6, weight: 1, price: 700, rarity: 'legendary', classRequired: 'alchemist', setId: 'alchemist', desc: 'Set Alchymisty (1/3): +3 Int, +30 rad odolnost' },
            { id: 'alchemist_set_armor', name: 'Laboratorn칤 pl치코콘', icon: '游봎', type: 'armor', defense: 8, weight: 2, price: 850, rarity: 'legendary', classRequired: 'alchemist', setId: 'alchemist', desc: 'Set Alchymisty (2/3): +50% trv치n칤 lektvar콢' },
            { id: 'alchemist_set_weapon', name: 'Jedov치 injekce', icon: '游눌', type: 'weapon', damage: 25, weight: 0.5, price: 1000, rarity: 'legendary', classRequired: 'alchemist', setId: 'alchemist', desc: 'Set Alchymisty (3/3): +12 jed damage/kolo' },
            // SB캨RA캛 - Hleda캜sk칳 set
            { id: 'scavenger_set_helmet', name: 'Hleda캜sk칠 br칳le', icon: '游봏', type: 'helmet', defense: 4, weight: 0.3, price: 650, rarity: 'legendary', classRequired: 'scavenger', setId: 'scavenger', desc: 'Set Sb캩ra캜e (1/3): +4 Vn칤m치n칤' },
            { id: 'scavenger_set_armor', name: 'Hleda캜sk치 vesta', icon: '游붴', type: 'armor', defense: 8, weight: 3, price: 800, rarity: 'legendary', classRequired: 'scavenger', setId: 'scavenger', desc: 'Set Sb캩ra캜e (2/3): +15 kg nosnost' },
            { id: 'scavenger_set_weapon', name: 'V칤ce칰캜elov칳 n치stroj', icon: '游댢', type: 'weapon', damage: 20, weight: 1, price: 900, rarity: 'legendary', classRequired: 'scavenger', setId: 'scavenger', desc: 'Set Sb캩ra캜e (3/3): +25% 코ance na loot' },
            // LOVEC - Loveck칳 set
            { id: 'hunter_set_helmet', name: 'Loveck치 캜apka', icon: '游꿜', type: 'helmet', defense: 5, weight: 0.5, price: 700, rarity: 'legendary', classRequired: 'hunter', setId: 'hunter', desc: 'Set Lovce (1/3): +3 Vn칤m치n칤' },
            { id: 'hunter_set_armor', name: 'Loveck치 kazajka', icon: '游빈', type: 'armor', defense: 12, weight: 4, price: 950, rarity: 'legendary', classRequired: 'hunter', setId: 'hunter', desc: 'Set Lovce (2/3): +30% damage na zv칤콏ata' },
            { id: 'hunter_set_weapon', name: 'Loveck치 pu코ka', icon: '游댦', type: 'weapon', damage: 48, ammoType: '762', weight: 4, price: 1500, rarity: 'legendary', classRequired: 'hunter', setId: 'hunter', desc: 'Set Lovce (3/3): +30% crit na zv칤콏ata' },
            // MECHANIK - Technick칳 set
            { id: 'engineer_set_helmet', name: 'Sv치콏e캜sk치 maska', icon: '游봏', type: 'helmet', defense: 8, weight: 1.5, price: 750, rarity: 'legendary', classRequired: 'engineer', setId: 'engineer', desc: 'Set Mechanika (1/3): +2 Inteligence' },
            { id: 'engineer_set_armor', name: 'Pracovn칤 kombin칠za', icon: '游농', type: 'armor', defense: 14, weight: 5, price: 1000, rarity: 'legendary', classRequired: 'engineer', setId: 'engineer', desc: 'Set Mechanika (2/3): +20% kvalita craftingu' },
            { id: 'engineer_set_weapon', name: 'Plazmov칳 sv치콏e캜', icon: '游댠', type: 'weapon', damage: 35, weight: 3, price: 1300, rarity: 'legendary', classRequired: 'engineer', setId: 'engineer', desc: 'Set Mechanika (3/3): +50% damage na roboty' },
            // DEMOLI캛츼콎 - V칳bu코n칳 set
            { id: 'demolitionist_set_helmet', name: 'Ochrann치 p콏ilba', icon: '久놾잺', type: 'helmet', defense: 10, weight: 2, price: 800, rarity: 'legendary', classRequired: 'demolitionist', setId: 'demolitionist', desc: 'Set Demoli캜치콏e (1/3): -50% damage z exploz칤' },
            { id: 'demolitionist_set_armor', name: 'Pyrotechnick치 vesta', icon: '游빋', type: 'armor', defense: 16, weight: 6, price: 1100, rarity: 'legendary', classRequired: 'demolitionist', setId: 'demolitionist', desc: 'Set Demoli캜치콏e (2/3): +50% damage gran치t콢' },
            { id: 'demolitionist_set_weapon', name: 'Raketov칳 granatomet', icon: '游', type: 'weapon', damage: 60, ammoType: 'rocket', weight: 8, price: 2000, rarity: 'legendary', classRequired: 'demolitionist', setId: 'demolitionist', desc: 'Set Demoli캜치콏e (3/3): +50% radius v칳buchu' },
            // OBCHODN칈K - Obchodnick칳 set
            { id: 'trader_set_helmet', name: 'Luxusn칤 klobouk', icon: '游꿜', type: 'helmet', defense: 3, weight: 0.3, price: 500, rarity: 'legendary', classRequired: 'trader', setId: 'trader', desc: 'Set Obchodn칤ka (1/3): +3 맚캩st칤' },
            { id: 'trader_set_armor', name: 'Obchodnick칳 kab치t', icon: '游빈', type: 'armor', defense: 6, weight: 2, price: 700, rarity: 'legendary', classRequired: 'trader', setId: 'trader', desc: 'Set Obchodn칤ka (2/3): -15% ceny v obchodech' },
            { id: 'trader_set_weapon', name: 'Pozlacen칳 revolver', icon: '游댦', type: 'weapon', damage: 30, ammoType: '9mm', weight: 1.5, price: 1200, rarity: 'legendary', classRequired: 'trader', setId: 'trader', desc: 'Set Obchodn칤ka (3/3): +25% nalezen칳ch pen캩z' },
            // NOM츼D - Pou코tn칤 set
            { id: 'nomad_set_helmet', name: 'Pou코tn칤 turban', icon: '游븻', type: 'helmet', defense: 5, weight: 0.3, price: 600, rarity: 'legendary', classRequired: 'nomad', setId: 'nomad', desc: 'Set Nom치da (1/3): +40 rad odolnost, +2 Vn칤m치n칤' },
            { id: 'nomad_set_armor', name: 'Cestovatelsk칳 pl치코콘', icon: '游빈', type: 'armor', defense: 10, weight: 2, price: 850, rarity: 'legendary', classRequired: 'nomad', setId: 'nomad', desc: 'Set Nom치da (2/3): -15% 캜as cestov치n칤' },
            { id: 'nomad_set_weapon', name: 'Pou코tn칤 orel', icon: '游댦', type: 'weapon', damage: 42, ammoType: '762', weight: 3, price: 1400, rarity: 'legendary', classRequired: 'nomad', setId: 'nomad', desc: 'Set Nom치da (3/3): +3 Vn칤m치n칤, +2 맚캩st칤' },
            // MUTANT - Mutantsk칳 set (accessory m칤sto armor)
            { id: 'mutant_set_accessory1', name: 'Radioaktivn칤 j치dro', icon: '游눜', type: 'accessory', defense: 0, weight: 0.5, price: 1000, rarity: 'legendary', classRequired: 'mutant', setId: 'mutant', desc: 'Set Mutanta (1/3): Radiace t캩 l칠캜칤, +2 S칤la' },
            { id: 'mutant_set_accessory2', name: 'Mutantsk칳 krystal', icon: '游눑', type: 'accessory', defense: 0, weight: 0.3, price: 1200, rarity: 'legendary', classRequired: 'mutant', setId: 'mutant', desc: 'Set Mutanta (2/3): +5 HP regen/z치sah, +2 V칳dr' },
            { id: 'mutant_set_weapon', name: 'Radioaktivn칤 dr치py', icon: '驕뮖잺', type: 'weapon', damage: 55, weight: 0, price: 1500, rarity: 'legendary', classRequired: 'mutant', setId: 'mutant', desc: 'Set Mutanta (3/3): +15 radia캜n칤 damage' },
            // PSYCHIK - Ment치ln칤 set
            { id: 'psychic_set_helmet', name: 'Telepatick치 캜elenka', icon: '游녬', type: 'helmet', defense: 4, weight: 0.2, price: 800, rarity: 'legendary', classRequired: 'psychic', setId: 'psychic', desc: 'Set Psychika (1/3): +4 Inteligence' },
            { id: 'psychic_set_armor', name: 'Psychick치 r칩ba', icon: '游븿', type: 'armor', defense: 6, weight: 1.5, price: 900, rarity: 'legendary', classRequired: 'psychic', setId: 'psychic', desc: 'Set Psychika (2/3): 30% 코ance ignorovat damage' },
            { id: 'psychic_set_weapon', name: 'Ment치ln칤 쬰zlo', icon: '游댩', type: 'weapon', damage: 35, weight: 1, price: 1300, rarity: 'legendary', classRequired: 'psychic', setId: 'psychic', desc: 'Set Psychika (3/3): 20% 코ance zm치st nep콏칤tele' }
        ];
        
        // === SN칈콯EN칈 ㅁNCE NA NALEZEN칈 VZ츼CN칗CH ZBRAN칈/BRN캨N칈 ===
        // Aplikuje se na: weapon, armor, helmet, gloves, boots
        ITEMS.forEach(item => {
            const isEquipment = ['weapon', 'armor', 'helmet', 'gloves', 'boots'].includes(item.type);
            if (isEquipment && item.findChance && item.findChance > 0) {
                if (item.rarity === 'uncommon') {
                    item.findChance = 0.05; // Uncommon fixn캩 na 0.05
                } else if (['rare', 'epic', 'legendary'].includes(item.rarity)) {
                    item.findChance = Math.max(0.001, item.findChance * 0.2); // Sn칤쬰n칤 o 80%
                }
            }
        });
        
        const BUILDINGS = [
            // === Z츼KLADN칈 (Level 1) - Osobn칤 z치zem칤 ===
            { id: 'bed', name: 'L콢쬶o', icon: '游띒勇', desc: '+2 HP/min, +2 energie/min', cost: { wood: 25, cloth: 15, rope: 5 }, effect: { hp: 2, energy: 2 }, category: 'living', level: 1, maintenance: 0 },
            { id: 'firepit', name: 'Ohni코t캩', icon: '游댠', desc: '+10 morale, va콏en칤', cost: { stone: 30, wood: 15 }, effect: { morale: 10, cooking: true }, category: 'living', level: 1, maintenance: 0 },
            { id: 'garden', name: 'Zahrada', icon: '游꺔', desc: '+1 j칤dlo/den', cost: { wood: 20, stone: 15, rope: 5 }, production: { food: 1 }, category: 'production', level: 1, maintenance: 0 },
            { id: 'water', name: 'Sb캩ra캜 vody', icon: '游눦', desc: '+3 voda/den', cost: { metal: 25, stone: 30, cloth: 10 }, production: { water: 3 }, category: 'production', level: 1, maintenance: 0 },
            { id: 'workshop', name: 'D칤lna', icon: '游댢', desc: 'Umo쮄갓je crafting', cost: { wood: 40, metal: 20, stone: 15 }, effect: { crafting: true }, category: 'utility', level: 1, maintenance: 0 },
            { id: 'storage', name: 'Sklad', icon: '游닍', desc: '+30 kapacity', cost: { wood: 50, stone: 30, metal: 10 }, effect: { baseCapacity: 30 }, category: 'utility', level: 1, maintenance: 0 },
            
            // Osada Level 1
            { id: 'well', name: 'Studna', icon: '游뛇', desc: '+6 vody/den pro osadu', cost: { stone: 80, metal: 30, rope: 15 }, production: { water: 6 }, category: 'settlement', level: 1, maintenance: 1 },
            { id: 'farmland', name: 'Pole', icon: '游', desc: 'Farm치콏i +50% produkce', cost: { wood: 60, stone: 40, rope: 10 }, effect: { farmBonus: 0.5 }, category: 'settlement', level: 1, maintenance: 1 },
            
            // === Level 2 - Rozvoj ===
            { id: 'infirmary', name: 'O코et콏ovna', icon: '游낀', desc: '+5 HP/min', cost: { wood: 50, metal: 30, cloth: 25, herbs: 10 }, effect: { hp: 5 }, category: 'living', level: 2, maintenance: 1 },
            { id: 'kitchen', name: 'Kuchy켿', icon: '游꼽', desc: '+2 j칤dlo/den', cost: { wood: 40, metal: 25, stone: 20 }, production: { food: 2 }, category: 'production', level: 2, maintenance: 1 },
            { id: 'wall', name: 'Hradby', icon: '游빔', desc: '+25 obrany', cost: { stone: 100, metal: 40, wood: 30 }, effect: { defense: 25 }, category: 'defense', level: 2, maintenance: 2 },
            { id: 'tower', name: 'Str치쬹칤 v캩', icon: '游딮', desc: '+15 obrany, varov치n칤', cost: { wood: 70, stone: 50, metal: 20 }, effect: { defense: 15, raidWarning: true }, category: 'defense', level: 2, maintenance: 1 },
            
            // Osada Level 2
            { id: 'market', name: 'Tr쬴코t캩', icon: '游낅', desc: '+20% prodejn칤 ceny', cost: { wood: 80, stone: 60, cloth: 40, metal: 20 }, effect: { tradingBonus: 0.2 }, category: 'settlement', level: 2, maintenance: 3 },
            { id: 'barracks', name: 'Kas치rny', icon: '游띠勇', desc: 'Str치쬮i +50% efektivity', cost: { wood: 100, metal: 80, stone: 60, cloth: 30 }, effect: { guardBonus: 0.5 }, category: 'settlement', level: 2, maintenance: 3 },
            
            // === Level 3 - Specializace ===
            { id: 'forge', name: 'Kov치rna', icon: '丘뉦잺', desc: '+5 DMG ze zbran칤', cost: { metal: 80, stone: 50, wood: 30, fuel: 20 }, effect: { weaponBonus: 5 }, category: 'utility', level: 3, maintenance: 3 },
            { id: 'training', name: 'Cvi캜i코t캩', icon: '游꿢', desc: '+10% XP', cost: { wood: 90, stone: 60, rope: 20, metal: 15 }, effect: { xpBonus: 0.1 }, category: 'utility', level: 3, maintenance: 2 },
            { id: 'armory', name: 'Zbrojnice', icon: '丘덢잺', desc: '+10% damage', cost: { metal: 70, stone: 40, wood: 30, leather: 15 }, effect: { damageBonus: 10 }, category: 'defense', level: 3, maintenance: 2 },
            
            // Osada Level 3
            { id: 'tavern', name: 'Hospoda', icon: '游꽄', desc: '+25 morale osady, +20游눯/den', cost: { wood: 80, cloth: 40, stone: 30, glass: 15 }, effect: { settlementMorale: 25 }, income: 20, category: 'settlement', level: 3, maintenance: 2 },
            { id: 'chapel', name: 'Kaple', icon: '久', desc: '+20 morale, l칠캜칤 nemoci', cost: { wood: 90, stone: 70, cloth: 30, glass: 10 }, effect: { settlementMorale: 20, cureDisease: true }, category: 'settlement', level: 3, maintenance: 3 },
            
            // === Level 4 - Elekt콏ina ===
            { id: 'generator', name: 'Gener치tor', icon: '丘', desc: '15 丘/den (pot콏ebuje palivo)', cost: { metal: 100, stone: 50, electronics: 20, copper: 30 }, production: { power: 15 }, consumption: { fuel: 2 }, category: 'utility', level: 4, maintenance: 5 },
            { id: 'solar', name: 'Sol치rn칤 panely', icon: '驕勇', desc: '8 丘/den zdarma', cost: { metal: 120, glass: 40, electronics: 30, copper: 25 }, production: { power: 8 }, category: 'utility', level: 4, maintenance: 2 },
            { id: 'windmill_power', name: 'V캩trn치 turb칤na', icon: '游', desc: '6 丘/den zdarma', cost: { metal: 90, wood: 60, electronics: 15, rope: 20 }, production: { power: 6 }, category: 'utility', level: 4, maintenance: 2 },
            { id: 'purifier', name: '캛isti캜ka vody', icon: '游눑游눦', desc: '+10 vody/den', cost: { metal: 80, stone: 50, electronics: 25, chemicals: 15 }, production: { water: 10 }, requiresPower: 2, category: 'production', level: 4, maintenance: 3 },
            { id: 'hydrofarm', name: 'Hydroponick치 farma', icon: '游游눠', desc: '+8 j칤dlo/den', cost: { metal: 100, glass: 50, electronics: 30, chemicals: 20 }, production: { food: 8 }, requiresPower: 3, category: 'production', level: 4, maintenance: 4 },
            
            // Osada Level 4
            { id: 'comms', name: 'Komunika캜n칤 v캩', icon: '游니', desc: 'Obchodn칤ci +50% 캜ast캩ji, +15游눯/den', cost: { metal: 90, electronics: 50, copper: 40, glass: 20 }, effect: { merchantBonus: 0.5 }, income: 15, requiresPower: 2, category: 'settlement', level: 4, maintenance: 3 },
            { id: 'bunker', name: 'Bunker', icon: '游끸勇', desc: '+60 obrany', cost: { stone: 200, metal: 120, wood: 50 }, effect: { defense: 60 }, category: 'settlement', level: 4, maintenance: 6 },
            
            // === Level 5 - Endgame ===
            { id: 'reactor', name: 'Reaktor', icon: '驕뮖잺丘', desc: '25 丘/den', cost: { metal: 200, electronics: 80, copper: 60, chemicals: 40 }, production: { power: 25 }, category: 'utility', level: 5, maintenance: 8 },
            { id: 'medbay', name: 'Zdravotn칤 st콏edisko', icon: '游낀丘', desc: '+15 HP/min v코em', cost: { metal: 120, cloth: 60, electronics: 40, chemicals: 30, herbs: 20 }, effect: { hp: 15, healAll: true }, requiresPower: 3, category: 'living', level: 5, maintenance: 7 },
            { id: 'cryo', name: 'Kryogenn칤 sklad', icon: '仇勇游닍', desc: 'J칤dlo se nekaz칤', cost: { metal: 140, electronics: 50, chemicals: 30, glass: 25 }, effect: { foodPreserve: true, baseCapacity: 50 }, requiresPower: 2, category: 'utility', level: 5, maintenance: 5 },
            { id: 'turret', name: 'Automatick치 v캩', icon: '游댦', desc: '+50 obrany, st콏칤l칤', cost: { metal: 150, electronics: 60, gunpowder: 40, copper: 30 }, effect: { defense: 50, autoAttack: true }, requiresPower: 3, category: 'defense', level: 5, maintenance: 7 },
            
            // Osada Level 5
            { id: 'university', name: 'Univerzita', icon: '游꿉', desc: '+20% XP v코em, +25游눯/den', cost: { wood: 150, stone: 120, cloth: 80, glass: 40, metal: 30 }, effect: { xpBonus: 0.2 }, income: 25, category: 'settlement', level: 5, maintenance: 5 },
            { id: 'monument', name: 'Monument', icon: '游딯', desc: '+50 morale, symbol nad캩je', cost: { stone: 250, metal: 100, copper: 50, glass: 30 }, effect: { morale: 50, settlementMorale: 30 }, category: 'settlement', level: 5, maintenance: 5 }
        ];
        
        const SETTLER_TYPES = [
            { id: 'farmer', name: 'Farm치콏', icon: '游', cost: 250, consumption: { food: 1, water: 1 }, desc: 'Produkuje j칤dlo (od +3/den)', skill: 'farming' },
            { id: 'guard', name: 'Str치쬮e', icon: '游띠勇', cost: 400, consumption: { food: 2, water: 1 }, desc: 'P콏id치v치 obranu (od +10)', skill: 'combat' },
            { id: 'scavenger_s', name: 'Sb캩ra캜', icon: '游', cost: 350, consumption: { food: 1, water: 1 }, desc: 'Sb칤r치 suroviny (2-4/den)', skill: 'scavenging' },
            { id: 'medic_s', name: 'Medik', icon: '游눌', cost: 500, consumption: { food: 1, water: 1 }, desc: 'L칠캜칤 v코echny (od +3 HP/den)', skill: 'medicine', unique: true },
            { id: 'builder', name: 'Stavitel', icon: '游댣', cost: 300, consumption: { food: 1, water: 2 }, desc: 'Urychl칤 stavby o 10%', skill: 'building', unique: true },
            { id: 'blacksmith', name: 'Kov치콏', icon: '丘뉦잺', cost: 600, consumption: { food: 2, water: 1 }, desc: 'Opravuje vybaven칤 zdarma', skill: 'smithing', unique: true },
            { id: 'cook', name: 'Kucha콏', icon: '游꼤', cost: 300, consumption: { food: 1, water: 1 }, desc: 'J칤dlo d치v치 v칤ce (od +25%)', skill: 'cooking', unique: true },
            { id: 'scout', name: 'Zv캩d', icon: '游녜勇', cost: 450, consumption: { food: 1, water: 1 }, desc: 'Varuje p콏ed n치jezdy', skill: 'scouting', unique: true },
            { id: 'trader_s', name: 'Obchodn칤k', icon: '游눯', cost: 750, consumption: { food: 1, water: 1 }, desc: 'Lep코칤 ceny (od +15%)', skill: 'trading' },
            { id: 'alchemist', name: 'Alchymista', icon: '丘勇', cost: 650, consumption: { food: 1, water: 1 }, desc: 'Sb칤r치 byliny a chemik치lie', skill: 'alchemy', unique: true },
            { id: 'hunter', name: 'Lovec', icon: '游낓', cost: 400, consumption: { food: 1, water: 1 }, desc: 'Produkuje maso (od +2/den)', skill: 'hunting' },
            { id: 'water_carrier', name: 'Nosi캜 vody', icon: '游뿪', cost: 200, consumption: { food: 1, water: 0 }, desc: 'Produkuje vodu (od +2/den)', skill: 'labor' },
            { id: 'lumberjack', name: 'D콏evorubec', icon: '游뿝', cost: 300, consumption: { food: 2, water: 1 }, desc: 'Produkuje d콏evo (od +3/den)', skill: 'woodcutting' }
        ];
        
        // Fallback pro p콏eklady osadn칤k콢 (pou쮂셨치 se .desc p콏칤mo z SETTLER_TYPES)
        const SETTLER_TRANSLATIONS = { cs: {} };
        
        // === DOVEDNOSTI OSADN칈K콡 ===
        // Vyv치쬰n칤: ni쮄뫆 produkce, vy코코칤 spot콏eba na vy코코칤ch 칰rovn칤ch, dra쮄뫆 upgrady
        // consumption = { food: X, water: Y } - kolik osadn칤k spot콏ebuje na t칠to 칰rovni
        const SETTLER_SKILLS = {
            farming: {
                name: 'Zem캩d캩lstv칤', icon: '游',
                levels: [
                    { level: 1, name: 'Za캜치te캜n칤k', bonus: '+3 j칤dla', effect: { food: 3 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Zahradn칤k', bonus: '+4 j칤dla', effect: { food: 4 }, cost: 400, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Farm치콏', bonus: '+6 j칤dla', effect: { food: 6 }, cost: 800, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '+8 j칤dla', effect: { food: 8, seedChance: 0.05 }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr zem캩d캩lec', bonus: '+12 j칤dla', effect: { food: 12, rareChance: 0.1 }, cost: 3000, consumption: { food: 3, water: 2 } }
                ]
            },
            combat: {
                name: 'Boj', icon: '丘덢잺',
                levels: [
                    { level: 1, name: 'Nov치캜ek', bonus: '+10 obrany', effect: { defense: 10 }, consumption: { food: 2, water: 1 } },
                    { level: 2, name: 'Str치쬮e', bonus: '+15 obrany', effect: { defense: 15 }, cost: 500, consumption: { food: 2, water: 1 } },
                    { level: 3, name: 'Voj치k', bonus: '+22 obrany', effect: { defense: 22, attack: 3 }, cost: 1000, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Veter치n', bonus: '+30 obrany', effect: { defense: 30, attack: 6 }, cost: 2000, consumption: { food: 3, water: 2 } },
                    { level: 5, name: '마mpion', bonus: '+40 obrany', effect: { defense: 40, attack: 10, command: true }, cost: 4000, consumption: { food: 3, water: 3 } }
                ]
            },
            scavenging: {
                name: 'Sb캩r', icon: '游댌',
                levels: [
                    { level: 1, name: 'Hleda캜', bonus: '2-4 surovin', effect: { minRes: 2, maxRes: 4 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Sb캩ra캜', bonus: '3-5 surovin', effect: { minRes: 3, maxRes: 5 }, cost: 400, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Pr콢zkumn칤k', bonus: '4-7 surovin', effect: { minRes: 4, maxRes: 7, rareChance: 0.1 }, cost: 800, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '5-9 surovin', effect: { minRes: 5, maxRes: 9, electronics: true }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr sb캩ra캜', bonus: '7-12 surovin', effect: { minRes: 7, maxRes: 12, itemChance: 0.05 }, cost: 3000, consumption: { food: 3, water: 2 } },
                    { level: 6, name: 'Legend치rn칤 sb캩ra캜', bonus: '10-15 surovin', effect: { minRes: 10, maxRes: 15, itemChance: 0.1, electronics: true }, cost: 6000, consumption: { food: 3, water: 2 } }
                ]
            },
            medicine: {
                name: 'Medic칤na', icon: '游눍',
                levels: [
                    { level: 1, name: 'O코et콏ovatel', bonus: '+3 HP/den', effect: { healing: 3 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Sanit치콏', bonus: '+5 HP/den', effect: { healing: 5 }, cost: 500, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Doktor', bonus: '+8 HP/den', effect: { healing: 8, cureDisease: true }, cost: 1000, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Chirurg', bonus: '+12 HP/den', effect: { healing: 12, craftMeds: true }, cost: 2000, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Hlavn칤 l칠ka콏', bonus: '+18 HP/den', effect: { healing: 18, revive: true }, cost: 4000, consumption: { food: 3, water: 2 } }
                ]
            },
            building: {
                name: 'Stavitelstv칤', icon: '游끵勇',
                levels: [
                    { level: 1, name: 'D캩ln칤k', bonus: '-15% cena staveb', effect: { discount: 0.15 }, consumption: { food: 1, water: 2 } },
                    { level: 2, name: 'Zedn칤k', bonus: '-25% cena staveb', effect: { discount: 0.25 }, cost: 400, consumption: { food: 1, water: 2 } },
                    { level: 3, name: 'Stavitel', bonus: '-35% cena', effect: { discount: 0.35, wallBonus: 5 }, cost: 800, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Architekt', bonus: '-45% cena', effect: { discount: 0.45, wallBonus: 10 }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Hlavn칤 in쬰n칳r', bonus: '-55% cena', effect: { discount: 0.55, wallBonus: 15 }, cost: 3000, consumption: { food: 3, water: 2 } }
                ]
            },
            smithing: {
                name: 'Kov치콏stv칤', icon: '游댣',
                levels: [
                    { level: 1, name: 'U캜e켿', bonus: 'Opravy zdarma', effect: { freeRepair: true }, consumption: { food: 2, water: 1 } },
                    { level: 2, name: 'Kov치콏', bonus: '+1 vylep코en칤', effect: { freeRepair: true, upgrade: 1 }, cost: 600, consumption: { food: 2, water: 1 } },
                    { level: 3, name: 'Zbroj칤콏', bonus: '+2 vylep코en칤', effect: { freeRepair: true, upgrade: 2 }, cost: 1200, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Mistr kov치콏', bonus: '+3 vylep코en칤', effect: { freeRepair: true, upgrade: 3, craftWeapons: true }, cost: 2500, consumption: { food: 3, water: 2 } },
                    { level: 5, name: 'Legend치rn칤 kov치콏', bonus: '+5 vylep코en칤', effect: { freeRepair: true, upgrade: 5, legendary: true }, cost: 5000, consumption: { food: 3, water: 3 } }
                ]
            },
            cooking: {
                name: 'Va콏en칤', icon: '游꼽',
                levels: [
                    { level: 1, name: 'Pomocn칤k', bonus: '+25% efekt j칤dla', effect: { foodBonus: 1.25 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Kucha콏', bonus: '+40% efekt j칤dla', effect: { foodBonus: 1.40 }, cost: 350, consumption: { food: 1, water: 1 } },
                    { level: 3, name: '먞뼍kucha콏', bonus: '+60% efekt', effect: { foodBonus: 1.60 }, cost: 700, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '+80% efekt', effect: { foodBonus: 1.80, specialFood: true }, cost: 1400, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr kucha콏', bonus: '+100% efekt', effect: { foodBonus: 2.0, buffFood: true }, cost: 2800, consumption: { food: 3, water: 2 } }
                ]
            },
            scouting: {
                name: 'Pr콢zkum', icon: '游댨',
                levels: [
                    { level: 1, name: 'Pozorovatel', bonus: 'Varov치n칤 p콏ed n치jezdy', effect: { raidWarning: true }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Zv캩d', bonus: '+info o nep콏치tel칤ch', effect: { raidWarning: true, enemyInfo: true }, cost: 450, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Stopa콏', bonus: '+mapov칠 bonusy', effect: { raidWarning: true, mapBonus: true }, cost: 900, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Ranger', bonus: '+10% karavany', effect: { raidWarning: true, caravanBonus: 0.1 }, cost: 1800, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr zv캩d', bonus: 'Sabot치 n치jezd콢', effect: { raidWarning: true, sabotage: true }, cost: 3500, consumption: { food: 3, water: 2 } }
                ]
            },
            trading: {
                name: 'Obchodov치n칤', icon: '游눷',
                levels: [
                    { level: 1, name: 'Prodava캜', bonus: '+15% ceny', effect: { tradeBonus: 0.15 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Obchodn칤k', bonus: '+25% ceny', effect: { tradeBonus: 0.25 }, cost: 600, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Makl칠콏', bonus: '+35% ceny', effect: { tradeBonus: 0.35, rareGoods: true }, cost: 1200, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Velkobchodn칤k', bonus: '+50% ceny', effect: { tradeBonus: 0.50, moreCaravans: true }, cost: 2500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Magn치t', bonus: '+70% ceny', effect: { tradeBonus: 0.70, exclusive: true }, cost: 5000, consumption: { food: 3, water: 2 } }
                ]
            },
            alchemy: {
                name: 'Alchymie', icon: '丘勇',
                levels: [
                    { level: 1, name: 'U캜edn칤k', bonus: '+1 byliny, +1 chem', effect: { herbs: 1, chemicals: 1 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Alchymista', bonus: '+2 byliny, +1 chem', effect: { herbs: 2, chemicals: 1, potions: true }, cost: 500, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'L칠k치rn칤k', bonus: '+3 byliny, +2 chem', effect: { herbs: 3, chemicals: 2, stimpacks: true }, cost: 1000, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Mistr alchymista', bonus: '+4 byliny, +3 chem', effect: { herbs: 4, chemicals: 3, radaway: true }, cost: 2000, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Arcialchymista', bonus: '+5 byliny, +4 chem', effect: { herbs: 5, chemicals: 4, mutantSerum: true }, cost: 4000, consumption: { food: 3, water: 2 } }
                ]
            },
            hunting: {
                name: 'Lov', icon: '游꿢',
                levels: [
                    { level: 1, name: 'Stopa콏', bonus: '+2 masa', effect: { meat: 2 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Lovec', bonus: '+3 masa, +1 k콢쬰', effect: { meat: 3, leather: 1 }, cost: 400, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Myslivec', bonus: '+5 masa, +2 k콢쬰', effect: { meat: 5, leather: 2 }, cost: 800, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '+7 masa, +3 k콢쬰', effect: { meat: 7, leather: 3, trophies: true }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Legend치rn칤 lovec', bonus: '+10 masa, +4 k콢쬰', effect: { meat: 10, leather: 4, rareHunt: true }, cost: 3000, consumption: { food: 3, water: 2 } }
                ]
            },
            labor: {
                name: 'Pr치ce', icon: '游눩',
                levels: [
                    { level: 1, name: 'Nosi캜', bonus: '+2 vody', effect: { water: 2 }, consumption: { food: 1, water: 0 } },
                    { level: 2, name: 'D캩ln칤k', bonus: '+3 vody', effect: { water: 3 }, cost: 250, consumption: { food: 1, water: 0 } },
                    { level: 3, name: 'Pomocn칤k', bonus: '+5 vody', effect: { water: 5, food: 1 }, cost: 500, consumption: { food: 2, water: 0 } },
                    { level: 4, name: 'Veter치n', bonus: '+7 vody, +1 j칤dlo', effect: { water: 7, food: 1 }, cost: 1000, consumption: { food: 2, water: 1 } },
                    { level: 5, name: 'Ne칰navn칳', bonus: '+10 vody, +2 j칤dlo', effect: { water: 10, food: 2 }, cost: 2000, consumption: { food: 3, water: 1 } },
                    { level: 6, name: 'Mistr nosi캜', bonus: '+14 vody, +3 j칤dlo', effect: { water: 14, food: 3 }, cost: 4000, consumption: { food: 3, water: 1 } }
                ]
            },
            woodcutting: {
                name: 'D콏evorubectv칤', icon: '游뿝',
                levels: [
                    { level: 1, name: 'U캜e켿', bonus: '+3 d콏eva', effect: { wood: 3 }, consumption: { food: 2, water: 1 } },
                    { level: 2, name: 'D콏evorubec', bonus: '+5 d콏eva', effect: { wood: 5 }, cost: 350, consumption: { food: 2, water: 1 } },
                    { level: 3, name: 'Lesn칤k', bonus: '+7 d콏eva, +1 provaz', effect: { wood: 7, rope: 1 }, cost: 700, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Mistr d콏evorubec', bonus: '+10 d콏eva, +2 provaz', effect: { wood: 10, rope: 2, scrap: 1 }, cost: 1400, consumption: { food: 3, water: 2 } },
                    { level: 5, name: 'Legend치rn칤 d콏evorubec', bonus: '+15 d콏eva, +3 provaz', effect: { wood: 15, rope: 3, scrap: 2, rareWood: true }, cost: 2800, consumption: { food: 3, water: 2 } }
                ]
            }
        };
        
        // === KNIHY - P콎칈B캨H ZK츼ZY ===
        const LORE_BOOKS = [
            { id: 'lore_1', name: 'Den칤k Dr. Nov치ka I', icon: '游늿', title: 'Projekt AURORA',
              text: `V캨DECK칗 DEN칈K - Z츼ZNAM 001
Datum: 15. b콏ezna 2031
Autor: Dr. Karel Nov치k, vedouc칤 projektu AURORA
M칤sto: V칳zkumn칠 st콏edisko AURORA, Brno

Dnes je historick칳 den. Po dvaceti letech v칳zkumu byl Projekt AURORA ofici치ln캩 schv치len vl치dou 캛esk칠 republiky a Evropskou uni칤.

Sed칤m ve sv칠 kancel치콏i a d칤v치m se na fotografii na stole. Moje 쬰na Eva. Moji synov칠. Moje dcera Eli코ka - teprve 코estn치ct, ale u chyt콏ej코칤 ne v캩t코ina m칳ch koleg콢.

Mus칤m za캜칤t od za캜치tku, pro p콏칤pad, 쬰 n캩kdy n캩kdo najde tyto z치pisky.

AURORA m캩la b칳t vakc칤na. Univerz치ln칤 ochrana proti v코em zn치m칳m nemocem. Genetick치 modifikace imunitn칤ho syst칠mu pomoc칤 upraven칳ch retrovir콢. Teoreticky dokonal칠. Prakticky... pracujeme ve tm캩.

M콢j t칳m 캜칤t치 47 v캩dc콢. Vynikaj칤c칤 lid칠. Ale dva z nich jsou moji synov칠 a to komplikuje v캩ci v칤c, ne jsem 캜ekal.

Star코칤 Korvin - "Kory" - je brilantn칤 genetik. M치 dar vid캩t vzorce tam, kde ostatn칤 vid칤 chaos. Ale v캜era mi 콏ekl n캩co, co m캩 d캩s칤 dodnes:

"Ot캜e, vid캩l jsi n캩kdy, jak lesn칤 po쮂r obnov칤 ekosyst칠m? Zni캜en칤 nen칤 konec. Je to za캜치tek. Lidstvo je p콏erostl칳 les. Pot콏ebuje ohe켿."

Je mu 28. V jeho o캜칤ch nevid칤m mlad칤ka. Vid칤m n캩koho, kdo se rozhodl p콏칤li코 brzy.

Mlad코칤 Karel - "Koudy" - je jin칳. Ve sv칳ch 25 letech je opatrn칳, metodick칳, neust치le pochybuj칤c칤. "Jeden 코patn칳 v칳po캜et zabije miliony," opakuje jako mantru. N캩kdy m캩 jeho pesimismus unavuje, ale dnes... dnes jsem vd캩캜n칳 za jeho opatrnost.

A pak je tu Marta.

Marta Svobodov치. Sedmdes치tilet치 bylink치콏ka z vesnice u Slavkova. Nev칤m pro캜 ji sem vl치da poslala - pr칳 "lidov칳 pohled na medic칤nu." Sm캩코n칠. Ale ta 쬰na... vid칤 v캩ci. V캜era mi 콏ekla:

"Pane doktore, vid칤m smrt v o캜칤ch va코eho star코칤ho. A smutek v o캜칤ch mlad코칤ho. D치vejte pozor."

Zasm치l jsem se. Te캞 si nejsem jist칳, jestli to bylo moudr칠.

Prvn칤 testy na zv칤콏atech za캜칤naj칤 p콏칤코t칤 t칳den. Modl칤m se, aby Marta nem캩la pravdu.

- Dr. Karel Nov치k

P.S. - Eva mi dnes volala. Ptala se, kdy p콏ijedu dom콢. 콎ekl jsem "brzy." Oba v칤me, 쬰 jsem lhal.` },
            
            { id: 'lore_2', name: 'Den칤k Dr. Nov치ka II', icon: '游닁', title: 'St칤ny v laborato콏i',
              text: `V캨DECK칗 DEN칈K - Z츼ZNAM 047
Datum: 3. 캜ervna 2031
Autor: Dr. Karel Nov치k

Dva m캩s칤ce od schv치len칤. Sv캩t slav칤. J치 nesp칤m.

Testy na zv칤콏atech uk치zaly... anom치lie. N캩kte콏칤 jedinci pro코li zm캩nami, kter칠 jsme nep콏edpokl치dali. Mutace. N캩kte콏칤 jedinci se stali agresivn칤mi. Jin칤 vyvinuli schopnosti, kter칠 by nem캩ly existovat. Jeden 코impanz p콏e쬴l smrtelnou d치vku radiace.

Vl치da 콏칤k치: "Pokra캜ujte."

Kory mi dnes uk치zal sv칠 soukrom칠 pozn치mky. Projekt, kter칳 naz칳v치 "Genesis."

"AURORA je za캜치tek," vysv캩tloval nad코en캩. "Genesis je dal코칤 krok. Dok치쬰me p콏etvo콏it celou biosf칠ru. Vy캜istit radiaci, obnovit ekosyst칠my, dokonce 콏칤zen캩 evoluovat druhy."

Jeho v칳po캜ty jsou geni치ln칤. Ale v konfigura캜n칤ch parametrech jsem na코el n캩co znepokojiv칠ho.

"Kory," zeptal jsem se, "pro캜 jsou v konfiguraci LET츼LN칈 parametry?"

Usm치l se. Ten 칰sm캩v m캩 pron치sleduje ve snech.

"Ka쬯칳 n치stroj m치 dv캩 strany, ot캜e. Skalpel l칠캜칤 i zab칤j칤. Z치le쮂 na chirurgovi."

---

Mezit칤m se kolem laborato콏e pohybuj칤 nov칤 lid칠.

Kapit치n Martin Nov치k (쮂멳n칳 p콏칤buzn칳, jen shoda jmen) vede vojenskou ochranu. Profesion치l. Jeho mlad코칤 bratr Pavel slou쮂 tak칠, ale na jin칠m odd캩len칤. Nikdy je nevid칤m spolu.

Anna Hor치kov치 - mlad치 jepti코ka, kter치 p콏i코la jako "duchovn칤 podpora person치lu." Tich치, pozorn치. V코칤m치 si v캩c칤, kter칠 ostatn칤 p콏ehl칤쬰j칤. V캜era se m캩 zeptala: "Doktore, pro캜 v치코 syn Korvin pracuje i v noci, kdy v코ichni ostatn칤 sp칤?"

Nem캩l jsem odpov캩캞.

---

Dnes p콏i코la zpr치va z Braz칤lie. Pacienti v testovac칤 skupin캩 vykazuj칤 "neobvykl칠 derm치ln칤 zm캩ny." Vojensk치 cenzura. Ofici치ln칤 verze: "lok치ln칤 alergick치 reakce."

Koudy str치vil celou noc kontrolou Koryho dat. R치no p콏i코el s o캜ima 캜erven칳ma od 칰navy.

"Tati," 콏ekl ti코e, "bratr n캩co skr칳v치. M치m strach."

J치 taky, synu. J치 taky.

- Dr. Karel Nov치k

P.S. - Marta dnes odm칤tla vstoupit do Koryho laborato콏e. "Tam c칤t칤m smrt," 콏ekla. U se nesm캩ju jej칤m p콏edtuch치m.` },
            
            { id: 'lore_3', name: 'Den칤k Dr. Nov치ka III', icon: '游닂', title: 'P치d sv캩ta',
              text: `V캨DECK칗 DEN칈K - Z츼ZNAM 089
Datum: 28. srpna 2031
Autor: Dr. Karel Nov치k

P칤코u ve sp캩chu. Ruce se mi t콏esou. Venku jsou v칳buchy.

AURORA selhala. Nebo usp캩la, z치le쮂 na 칰hlu pohledu.

Virus mutoval. P콏esko캜il. P콏en치코칤 se vzduchem. Miliardy lid칤 po cel칠m sv캩t캩 dostaly vakc칤nu - a te캞 se m캩n칤. N캩kte콏칤 um칤raj칤. N캩kte콏칤 se st치vaj칤... n캩캜칤m jin칳m. Mutanty. Ale ne v코ichni ztr치cej칤 rozum.

Praha padla p콏ed t콏emi dny. Brno ho콏칤. Arm치da dostala rozkaz "vy캜istit" - vid캩l jsem, jak st콏칤leli do dav콢. Do d캩t칤.

Dukovany jsou bez obsluhy. V칳buchy nebyly v치le캜n칠 - byly jadern칠.

A uprost콏ed toho v코eho - moji synov칠.

Kory zmizel. Na코el jsem v jeho laborato콏i pozn치mky:

"GENESIS - F츼ZE 2
AURORA splnila sv콢j 칰캜el. Selekce za캜ala. Slab칤 budou eliminov치ni. Siln칤 p콏e쬴j칤 a budou transformov치ni. Tohle je evoluce v p콏칤m칠m p콏enosu.

Otec nepochop칤. Koudy nepochop칤. Ale jednou... jednou uvid칤, 쬰 jsem m캩l pravdu."

Bo쬰 m콢j. M콢j syn. ON TO V캨D캨L. On to PL츼NOVAL.

---

Koudy se pokusil zni캜it Genesis. Konfrontace s Korym. V칳buch v laborato콏i - budova B je pry캜. Oba p콏e쬴li, ale...

Vid캩l jsem Koudyho naposledy, jak prch치 s 캜치st칤 dokument콢. M캩l pop치leniny na rukou. Plakal.

"Promi켿, tati," 콏ekl. "Nedok치zal jsem ho zastavit."

Kory zmizel jin칳m sm캩rem. Jeho posledn칤 slova ke mn캩:

"Nejsi m콢j otec. Otcov칠 chr치n칤 sv칠 d캩ti. Ty jsi vytvo콏il sv캩t pln칳 slaboch콢 a te캞 se div칤코, 쬰 n캩kdo mus칤 uklidit?"

---

Eva je mrtv치. Eli코ka zmizela. Posledn칤 zpr치va od n칤 byla z okol칤 Slavkova - pom치hala uprchl칤k콢m. Pros칤m... pros칤m, a콘 je na쬴vu.

Marta m캩 na코la ve sklep캩, kde jsem se schoval. Ta star치 쬰na pro코la peklem, aby se ke mn캩 dostala.

"Mus칤te p콏e쮂셦," 콏ekla. "Mus칤te zaznamenat pravdu. Sv캩t bude pot콏ebovat v캩d캩t, co se stalo."

Dala mi bylinn칳 odvar proti radiaci. Funguje - trochu.

Kapit치n Nov치k organizuje evakuaci civilist콢. Jeho bratr Pavel 칰dajn캩 odm칤tl rozkaz st콏칤let do lid칤 a dezertoval. Nikdo nev칤, kde je.

Anna se modl칤 za mrtv칠. Je jich p콏칤li코 mnoho.

- Dr. Karel Nov치k` },
            
            { id: 'lore_4', name: 'Den칤k Dr. Nov치ka IV', icon: '游닃', title: 'Z popela',
              text: `V캨DECK칗 DEN칈K - Z츼ZNAM 127
Datum: 15. 콏칤jna 2031
Autor: Dr. Karel Nov치k
M칤sto: Sklep pod Bu캜ovicemi

Dva m캩s칤ce od kolapsu. Sv캩t, jak jsme ho znali, je pry캜.

Podle m칳ch odhad콢 p콏e쬴lo 2-3% populace. V캩t코ina zem콏ela na virus, radiaci, nebo na sebe navz치jem. M캩sta jsou radioaktivn칤 pustina pln치 mutant콢 - n캩kte콏칤 divoc칤 jako zv칤콏ata, jin칤 si zachovali rozum.

Ale 쬴vot nach치z칤 cestu. A lid칠 tak칠.

---

P콎E콯IV먞, KTER칄 JSEM POTKAL:

MARTA SVOBODOV츼 - star치 bylink치콏ka m캩 st치le doprov치z칤. Je mi jako matka. U캜칤 mlad칠ho l칠ka콏e jm칠nem Thomas Harris v코echno, co v칤 o bylin치ch a l칠캜en칤. Ten mlad칤k m치 talent.

KAPIT츼N MARTIN NOV츼K - dr쮂 checkpoint severn캩 od Bu캜ovic. Disciplinovan칳, tvrd칳, ale spravedliv칳. St치le hled치 svou dceru Emmu - zmizela den p콏ed bombami. Je to zlomen칳 mu v uniform캩.

PAVEL NOV츼K - Martin콢v bratr. B칳val칳 voj치k. Te캞 vede bandu... ne n치jezdn칤k콢, ne p콏esn캩. Ochr치nc콢? Odm칤tl st콏칤let do civilist콢 a stal se vyhnancem. Ironicky, jeho "n치jezdn칤ci" chr치n칤 vesnice p콏ed skute캜n칳mi bandity. Martin to nev칤. Nebo nechce v캩d캩t.

ANNA HOR츼KOV츼 - sestra Anna te캞 쬴je ve star칠m kostele. L칠캜칤 du코e tam, kde Thomas l칠캜칤 t캩la. Modl칤 se za 쬰nu, kterou m칤stn칤 naz칳vaj칤 "z치hadn치" - pr칳 ji n캩kdo vid캩l u severn칤ch ruin.

---

FRAKCE:

Vznikaj칤 organizace. Lid칠 se shlukuj칤.

ORL칈 N츼ROD - b칳val칤 voj치ci a policist칠. V캩콏칤 v po콏치dek. Jejich v콢dce je plukovn칤k Havl칤k.

RUD칗 칔SVIT - v캩dci. Pracujeme na pochopen칤 mutac칤. Na l칠ku. Na nad캩ji.

VOLN칈 OBCHODN칈CI - p콏e쬴t칤 skrze obchod. Star칳 mu jm칠nem pouze "Obchodn칤k" vede nejv캩t코칤 karavanu. M치 mlad칠ho inform치tora - sirotka jm칠nem P칠콘a, kter칳 sly코칤 v코echno.

LOVCI ST칈N콡 - 쬺ld치ci. Viktor, samot치콏sk칳 lovec, s nimi ob캜as spolupracuje. M치 pov캩st, 쬰 ho nelze sledovat.

---

A moji synov칠?

Kory se etabloval v Trading Postu. Charismatick칳 v콢dce s viz칤 "nov칠ho lidstva." M치 n치sledovn칤ky. Mluv칤 o "o캜i코t캩n칤" a "nov칠 evoluci." Lid칠 mu v캩콏칤. To m캩 d캩s칤 nejv칤c.

Koudy se skr칳v치 v tajn칠 laborato콏i. Pracuje na zp콢sobu, jak Genesis rekonfigurovat pro OBNOVU m칤sto zni캜en칤. Mlad치 in쬰n칳rka jm칠nem Kl치ra mu pom치h치 - nebo pom치hala. Sly코el jsem, 쬰 ode코la. Pr칳 zjistila n캩co, co ji vyd캩silo.

Oba hledaj칤 캜ty콏i komponenty k dokon캜en칤 Genesis. Oba v캩콏칤, 쬰 zachra켿uj칤 sv캩t.

Jeden z nich m치 pravdu.

- Dr. Karel Nov치k

P.S. - Viktor mi dnes p콏inesl zpr치vu. Pr칳 vid캩l mu쬰 v ba쬴n치ch, kter칳 "mluv칤 s치m se sebou o pravd캩." 콎칤kaj칤 mu 먞셟en칳 Jirka. Pr칳 byl v laborato콏i NOC P콎ED BOMBAMI. Jestli je to pravda... mo쬹치 v칤 n캩co, co nev칤m ani j치.` },
            
            { id: 'lore_5', name: 'Den칤k Dr. Nov치ka V', icon: '游늽', title: 'Pravda a nad캩je',
              text: `V캨DECK칗 DEN칈K - Z츼ZNAM 158 (POSLEDN칈)
Datum: 1. ledna 2032
Autor: Dr. Karel Nov치k

Nov칳 rok. Nov칳 sv캩t. M콢j posledn칤 z치pis.

Radiace si vyb칤r치 da켿. M치m mo쬹치 t칳den. Marta mi d치v치 bylinky, ale ob캩 v칤me, 쬰 u jen oddalujeme nevyhnuteln칠.

Ne odejdu, mus칤m zanechat pravdu. Pro tebe. Pro toho, kdo toto 캜te.

---

PRAVDA O PROJEKTU GENESIS:

Genesis je za콏칤zen칤 schopn칠 planet치rn칤 transformace. M치 DV캨 konfigurace:

OBNOVA - Vy캜ist칤 radiaci, regeneruje p콢du, stabilizuje mutace. Sv캩t bude jin칳, ale 쬴v칳.

O캛ISTA - 콎et캩zov치 reakce, kter치 zabije v코e krom캩 t캩ch s "kompatibiln칤 genetikou." V praxi: ti, kte콏칤 pro코li kontrolovanou mutac칤 AURORA, p콏e쬴j칤. Zbytek zem콏e.

캛ty콏i komponenty jsou nutn칠: Plutoniov칠 j치dro, Kvantov칳 stabiliz치tor, F칰zn칤 캜l치nek, 콎칤dic칤 modul AI. Rozpt칳lil jsem je po kraji.

---

PRAVDA O M칗CH SYNECH:

Kory... m콢j star코칤. V캩콏칤, 쬰 lidstvo v sou캜asn칠 form캩 je "evolu캜n캩 zastaral칠." Chce Genesis pou쮂셦 k O캛IST캨. Ne ze zlomyslnosti - on opravdu v캩콏칤, 쬰 t칤m zachra켿uje budoucnost. "Slab칤 mus칤 odej칤t, aby siln칤 mohli 쮂셦," 콏칤k치.

Je to monstrum? Nebo vizion치콏, kter칠mu nerozum칤me?

Koudy... m콢j mlad코칤. Chce Genesis nakonfigurovat pro OBNOVU. I za cenu, 쬰 mutanti z콢stanou mutanty nav쬯y. "L칠pe zm캩n캩n칤 ne mrtv칤," argumentuje.

Je to hrdina? Nebo zbab캩lec, kter칳 se boj칤 t캩쬶칳ch rozhodnut칤?

NEV칈M. Po v코ech t캩ch letech, po v코ech t캩ch studi칤ch a experimentech... NEV칈M, kdo m치 pravdu.

---

CO V칈M JIST캨:

1. Jirka v ba쬴n치ch N캨CO VID캨L. V코ichni 콏칤kaj칤, 쬰 je bl치zen. Ale j치 zn치m tu laborato콏. Byl tam n캩kdo TU NOC. Jirka mo쬹치 v칤 v칤c ne kdokoli jin칳.

2. Z치hadn치 쬰na u severn칤ch ruin... pozn치v치m jej칤 ch콢zi. Jej칤 gesta. Ale to je nemo쬹칠. Eva je mrtv치. Vid캩l jsem t캩lo. Nebo... vid캩l jsem t캩lo, kter칠 VYPADALO jako Eva.

3. Kl치ra opustila Koudyho laborato콏. Pro캜? Co zjistila? Kde jsou jej칤 pozn치mky?

4. Kapit치n Nov치k hled치 dceru. Pavel "캛ern칳" Nov치k vede n치jezdn칤ky. Dva brat콏i na opa캜n칳ch stran치ch. Zn칤 to pov캩dom캩?

5. Star칳 Tom치코 - poustevn칤k z chaty v lese - zn치 historii tohoto m칤sta. Je tu d칠le ne kdokoli jin칳. ON V칈 V캨Ci, kter칠 ostatn칤 zapomn캩li.

---

TOB캨, KDO TOTO 캛TE:

Ne콏칤k치m ti, komu v캩콏it. To mus칤코 zjistit s치m. Mluv s lidmi. POSLOUCHEJ jejich p콏칤b캩hy. Pravda nen칤 v jednom den칤ku nebo jednom 캜lov캩ku - je rozpt칳len치 mezi v코emi.

Jirka. Tom치코. Kl치ra. Anna. Marta. Viktor. P칠콘a - ano, i ten mal칳 sirotek V칈 v캩ci.

Moje dcera Eli코ka... jestli je na쬴vu, bude n캩kde pom치hat lidem. Takov치 byla v쬯ycky. Najdi ji. 콎ekni j칤, 쬰 tati myslel na ni do posledn칤 chv칤le.

A Maya - ta mlad치 zv캩dka, kter치 pr칳 b캩h치 po kraji. Nev칤m pro캜, ale kdy jsem ji vid캩l... p콏ipomn캩la mi n캩koho. O캜i. M캩la Emminy o캜i. Nov치kovny o캜i.

Sv캩t je zni캜en칳, ale ne mrtv칳.

TY jsi d콢kaz, 쬰 nad캩je p콏e쮂셨치.

S l치skou k budoucnosti, kterou u neuvid칤m,

Dr. Karel Nov치k
Vedouc칤 projektu AURORA
Otec Korvina, Karla ml. a Eli코ky
Man쬰l Evy (nav쬯y)

P.S. - Genesis vy쬬duje LIDSK칄 rozhodnut칤. Stroj se s치m nezapne. Osud sv캩ta bude v rukou toho, kdo shrom치쬯칤 v코echny komponenty.

Zvol moud콏e.

Nebo nezvoluj v콢bec.

N캩kdy je nejlep코칤 volba - nepodlehnout iluzi, 쬰 mus칤me volit.`}
        ];
        
        // Funkce pro 캜ten칤 knihy
        function readLoreBook(bookId) {
            try {
                console.log('游늿 readLoreBook called with bookId:', bookId);
                console.log('游늿 LORE_BOOKS exists:', typeof LORE_BOOKS !== 'undefined');
                console.log('游늿 LORE_BOOKS length:', LORE_BOOKS?.length);
                
                const book = LORE_BOOKS.find(b => b.id === bookId);
                console.log('游늿 Found book:', book ? book.title : 'NOT FOUND');
                
                if (!book) {
                    showModal('仇 Chyba', 'Kniha nebyla nalezena: ' + bookId);
                    return;
                }
                
                // Kontrola cooldownu - ka쬯칳 den칤k m치 sv콢j vlastn칤 cooldown
                const now = Date.now();
                if (!state.loreCooldowns) state.loreCooldowns = {};
                const lastRead = state.loreCooldowns[bookId] || 0;
                const cooldown = 5 * 60 * 1000; // 5 minut
                const remaining = cooldown - (now - lastRead);
                
                if (remaining > 0) {
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    showModal('游늿 Den칤k zam캜en', `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">游</div>
                            <p style="color: #ff9800;">Tento d칤l den칤ku jsi pr치v캩 캜etl.</p>
                            <p style="color: #ffd700; font-size: 1.5rem; margin: 1rem 0;">${mins}:${String(secs).padStart(2, '0')}</p>
                            <p style="color: #888; font-size: 0.85rem;">Po캜kej, ne si ho bude코 moct p콏e캜칤st znovu.</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                    return;
                }
                
                // Nastav cooldown pro tento konkr칠tn칤 den칤k
                state.loreCooldowns[bookId] = now;
                
                // Ozna캜 jako p콏e캜ten칠 a dej XP pouze poprv칠
                if (!state.readBooks) state.readBooks = [];
                const alreadyRead = state.readBooks.includes(bookId);
                
                if (!alreadyRead) {
                    state.readBooks.push(bookId);
                    addXP(50); // Bonus XP za prvn칤 p콏e캜ten칤
                    notifySuccess('Nov칳 p콏칤b캩h!', '+50 XP za p콏e캜ten칤');
                }
                
                // Ulo hned po p콏e캜ten칤
                saveGame(true);
                
                showModal(book.icon + ' ' + book.title, 
                    '<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; text-align: left; line-height: 1.6; white-space: pre-wrap; font-size: 0.9rem; color: #ccc; background: #0a0a0a; padding: 1rem; border-radius: 8px; border: 1px solid #333;">' +
                    book.text +
                    '</div>' +
                    '<p style="text-align: center; margin-top: 1rem; color: #888; font-size: 0.8rem;">游닄 D칤l ' + (LORE_BOOKS.findIndex(b => b.id === bookId) + 1) + ' z ' + LORE_BOOKS.length + '</p>' +
                    (alreadyRead ? '<p style="text-align: center; color: #666; font-size: 0.75rem;">游닀 Ji p콏e캜teno</p>' : '') +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">' + t('ui', 'close') + '</button>'
                );
            } catch (error) {
                console.error('仇 Chyba v readLoreBook:', error);
                showModal('仇 Chyba', 'Nepoda콏ilo se p콏e캜칤st knihu: ' + error.message);
            }
        }
        
        // Funkce pro zobrazen칤 sb칤rky knih
        function showLoreCollection() {
            if (!state.readBooks) state.readBooks = [];
            if (!state.loreCooldowns) state.loreCooldowns = {};
            const collected = state.inv.filter(i => i.id?.startsWith('lore_')).map(i => i.id);
            const now = Date.now();
            const cooldown = 5 * 60 * 1000; // 5 minut
            
            let html = '<p style="color: #888; margin-bottom: 1rem;">Sb칤rej den칤ky Dr. Nov치ka a odhal pravdu o zk치ze sv캩ta a o bratrech Korym a Koudym.</p>';
            html += '<div style="display: grid; gap: 0.5rem;">';
            
            LORE_BOOKS.forEach((book, idx) => {
                const hasBook = collected.includes(book.id);
                const wasRead = state.readBooks.includes(book.id);
                const lastRead = state.loreCooldowns[book.id] || 0;
                const remaining = cooldown - (now - lastRead);
                const isOnCooldown = remaining > 0;
                
                html += '<div style="background: ' + (hasBook ? '#1a2a1a' : '#1a1a1a') + '; padding: 0.8rem; border-radius: 8px; border: 1px solid ' + (hasBook ? '#2a4a2a' : '#333') + '; display: flex; align-items: center; gap: 0.8rem;">';
                html += '<span style="font-size: 2rem;">' + (hasBook ? book.icon : '仇') + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; color: ' + (hasBook ? '#8bc34a' : '#666') + ';">' + (hasBook ? book.name : '???') + '</div>';
                html += '<div style="font-size: 0.8rem; color: #888;">' + (hasBook ? book.title : 'Nenalezeno') + '</div>';
                if (hasBook && isOnCooldown) {
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    html += '<div style="font-size: 0.75rem; color: #ff9800;">游 ' + mins + ':' + String(secs).padStart(2, '0') + '</div>';
                }
                html += '</div>';
                if (hasBook) {
                    if (isOnCooldown) {
                        html += '<button class="btn" disabled style="padding: 0.4rem 0.8rem; font-size: 0.8rem; opacity: 0.5; cursor: not-allowed;">游</button>';
                    } else {
                        html += '<button class="btn" onclick="readLoreBook(\'' + book.id + '\')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">' + (wasRead ? '游닀' : '游늿 Nov칠!') + '</button>';
                    }
                }
                html += '</div>';
            });
            
            html += '</div>';
            html += '<p style="text-align: center; margin-top: 1rem; color: #ffd700;">游닄 Sebr치no: ' + collected.length + '/' + LORE_BOOKS.length + '</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">' + t('ui', 'close') + '</button>';
            
            showModal('游닄 P콏칤b캩h zk치zy', html);
        }
        
        // === UD츼LOSTI V OSAD캨 ===
        const SETTLEMENT_EVENTS = [
            // === POZITIVN칈 EVENTY === (zv칳코en칠 코ance)
            { id: 'birth', name: 'Narozen칤', icon: '游꽆', chance: 0.10, effect: 'newSettler', desc: 'Narodil se nov칳 obyvatel!' },
            { id: 'wedding', name: 'Svatba', icon: '游눐', chance: 0.06, effect: 'morale', desc: 'Dva osadn칤ci se vzali!', morale: 20 },
            { id: 'discovery', name: 'Objev', icon: '游댡', chance: 0.15, effect: 'bonus', desc: 'Osadn칤k n캩co objevil!', resources: true },
            { id: 'celebration', name: 'Oslava', icon: '游꿀', chance: 0.18, effect: 'party', desc: 'Osadn칤ci slav칤!', morale: 25 },
            { id: 'harvest', name: 'Sklize켿', icon: '游', chance: 0.20, effect: 'food', desc: 'Bohat치 sklize켿!', food: 20, condition: 'hasFarm' },
            { id: 'inspiration', name: 'Inspirace', icon: '丘', chance: 0.10, effect: 'skill', desc: 'Osadn칤k se zlep코il!', skillUp: true },
            { id: 'merchant', name: 'Obchodn칤k', icon: '游', chance: 0.35, effect: 'trade', desc: 'P콏ijela karavana obchodn칤k콢!', duration: 10 },
            
            // === NEGATIVN칈 EVENTY === (m칤rn캩 sn칤쬰n칠) - prosperity penalties z콢st치vaj칤
            { id: 'disease', name: 'Nemoc', icon: '游', chance: 0.08, effect: 'sickness', desc: 'Nemoc se 코칤콏칤 osadou!', prosperity: -10 },
            { id: 'dispute', name: 'Spor', icon: '游눡', chance: 0.12, effect: 'conflict', desc: 'Osadn칤ci se h치daj칤!', morale: -15 },
            { id: 'runaway', name: '칔t캩k', icon: '游끢', chance: 0.05, effect: 'loseSettler', desc: 'Osadn칤k utekl!', prosperity: -5, condition: 'lowMorale' },
            { id: 'accident', name: 'Nehoda', icon: '游뽖', chance: 0.06, effect: 'injury', desc: 'Osadn칤k se zranil.', condition: 'noMedic' },
            { id: 'theft', name: 'Kr치de', icon: '游붛', chance: 0.06, effect: 'theft', desc: 'N캩kdo okradl z치soby!', condition: 'noGuard' },
            { id: 'fire', name: 'Po쮂r', icon: '游댠', chance: 0.03, effect: 'fire', desc: 'V osad캩 ho콏칤!', prosperity: -15 },
            
            // === ROZHODOVAC칈 EVENTY === (zv칳코en칠 코ance)
            { id: 'refugee', name: 'Uprchl칤k', icon: '游', chance: 0.15, effect: 'choice_refugee', desc: 'Uprchl칤k hled치 칰to캜i코t캩.', choice: true },
            { id: 'stray_dog', name: 'Toulav칳 pes', icon: '游냇', chance: 0.12, effect: 'choice_dog', desc: 'Toulav칳 pes se zatoulal k osad캩.', choice: true },
            { id: 'mysterious_trader', name: 'Z치hadn칳 obchodn칤k', icon: '游꿠', chance: 0.08, effect: 'choice_mystery', desc: 'Z치hadn치 postava nab칤z칤 obchod...', choice: true },
            { id: 'wounded_stranger', name: 'Zran캩n칳 cizinec', icon: '游뽗', chance: 0.12, effect: 'choice_wounded', desc: 'Zran캩n칳 cizinec pros칤 o pomoc.', choice: true },
            { id: 'bandit_offer', name: 'Nab칤dka bandity', icon: '游', chance: 0.06, effect: 'choice_bandit', desc: 'Bandita nab칤z칤 "ochranu" za 칰platu.', choice: true },
            { id: 'lost_child', name: 'Ztracen칠 d칤t캩', icon: '游놌', chance: 0.08, effect: 'choice_child', desc: 'Ztracen칠 d칤t캩 hled치 domov.', choice: true },
            { id: 'trader_dispute', name: 'Obchodn칤 spor', icon: '丘뒲잺', chance: 0.12, effect: 'choice_dispute', desc: 'Dva osadn칤ci se h치daj칤 o zbo쮂.', choice: true },
            { id: 'scavenger_find', name: 'N치lez sb캩ra캜e', icon: '游닍', chance: 0.15, effect: 'choice_scavenger', desc: 'Sb캩ra캜 na코el n캩co zaj칤mav칠ho...', choice: true },
            
            // === VZ츼CN칄 EVENTY === - zlat칳 v캩k z콢st치v치 jako jedin칳 pozitivn칤 zdroj prosperity z event콢
            { id: 'golden_age', name: 'Zlat칳 v캩k', icon: '九', chance: 0.04, effect: 'golden', desc: 'Osada vzkv칠t치!', prosperity: 15, morale: 30 },
            { id: 'plague', name: 'Mor', icon: '驕멆잺', chance: 0.02, effect: 'plague', desc: 'Smrteln치 nemoc zas치hla osadu!', prosperity: -20, condition: 'noMedic' },
            { id: 'treasure', name: 'Poklad', icon: '游눑', chance: 0.05, effect: 'treasure', desc: 'N캩kdo na코el ukryt칳 poklad!' }
        ];
        
        // P콏eklady settlement event콢
        function getSettlementEventName(eventId) {
            const event = SETTLEMENT_EVENTS.find(e => e.id === eventId);
            return event?.name || eventId;
        }
        
        function getSettlementEventDesc(eventId) {
            const event = SETTLEMENT_EVENTS.find(e => e.id === eventId);
            return event?.desc || '';
        }
        
        // === N츼JEZDY NA OSADU ===
        const RAID_WAVES = [
            { wave: 1, name: 'Zv캩dov칠', enemies: [{ type: 'raider', count: 2 }], reward: { money: 50, xp: 30 } },
            { wave: 2, name: 'Mal칳 n치jezd', enemies: [{ type: 'raider', count: 3 }, { type: 'bandit', count: 1 }], reward: { money: 100, xp: 60 } },
            { wave: 3, name: '칔to캜n치 vlna', enemies: [{ type: 'raider', count: 4 }, { type: 'bandit', count: 2 }], reward: { money: 200, xp: 100 } },
            { wave: 4, name: 'Velk칳 n치jezd', enemies: [{ type: 'bandit', count: 4 }, { type: 'raider_boss', count: 1 }], reward: { money: 350, xp: 150 } },
            { wave: 5, name: 'Invaze', enemies: [{ type: 'bandit', count: 5 }, { type: 'raider_boss', count: 2 }], reward: { money: 500, xp: 250, item: 'rare' } }
        ];
        
        // === DUNGEONY S PATRY ===
        const DUNGEON_FLOORS = {
            'old_cellar': {
                name: 'Star칳 sklep',
                floors: [
                    { floor: 1, name: 'Vstupn칤 chodba', enemies: ['rat', 'giant_rat'], loot: ['food', 'scrap'], boss: null },
                    { floor: 2, name: 'Skladi코t캩', enemies: ['giant_rat', 'feral'], loot: ['metal', 'cloth', 'medkit'], boss: null },
                    { floor: 3, name: 'Tajn치 m칤stnost', enemies: ['feral', 'zombie'], loot: ['weapon', 'ammo', 'money'], boss: 'cellar_king' }
                ]
            },
            'nuclear_plant': {
                name: 'Jadern치 elektr치rna',
                floors: [
                    { floor: 1, name: 'Vn캩j코칤 perimetr', enemies: ['ghoul', 'soldier_zombie'], loot: ['ammo', 'medkit'], boss: null },
                    { floor: 2, name: 'Kontroln칤 m칤stnost', enemies: ['glowing_ghoul', 'robot'], loot: ['electronics', 'radaway'], boss: null },
                    { floor: 3, name: 'Reaktorov치 hala', enemies: ['glowing_ghoul', 'mutant_brute'], loot: ['fuel', 'crystal', 'radx'], boss: null },
                    { floor: 4, name: 'Chladic칤 v캩쬰', enemies: ['glowing_one', 'irradiated_beast'], loot: ['chemicals', 'legendary'], boss: null },
                    { floor: 5, name: 'J치dro reaktoru', enemies: ['glowing_one'], loot: ['plutonium_core', 'legendary'], boss: 'nuclear_abomination' }
                ]
            },
            'abandoned_mine': {
                name: 'Opu코t캩n칳 d콢l',
                floors: [
                    { floor: 1, name: 'Vstup', enemies: ['rat', 'zombie'], loot: ['metal', 'stone'], boss: null },
                    { floor: 2, name: 'Star칠 코toly', enemies: ['zombie', 'mutant_rat'], loot: ['metal', 'copper'], boss: null },
                    { floor: 3, name: 'Zatopen칠 tunely', enemies: ['mutant_rat', 'raider'], loot: ['copper', 'silver'], boss: null },
                    { floor: 4, name: 'Hlubiny', enemies: ['raider', 'bandit'], loot: ['silver', 'gold'], boss: 'mine_foreman' }
                ]
            },
            'military_base': {
                name: 'Vojensk치 z치kladna',
                floors: [
                    { floor: 1, name: 'Br치na', enemies: ['soldier', 'raider'], loot: ['ammo', 'metal'], boss: null },
                    { floor: 2, name: 'Kas치rny', enemies: ['soldier', 'bandit'], loot: ['weapon', 'armor'], boss: null },
                    { floor: 3, name: 'Zbrojnice', enemies: ['soldier', 'raider_boss'], loot: ['weapon', 'ammo'], boss: null },
                    { floor: 4, name: 'Velitelstv칤', enemies: ['soldier', 'soldier'], loot: ['rare_weapon', 'documents'], boss: 'commander' }
                ]
            },
            'military_outpost': {
                name: 'Vojensk치 hl칤dka',
                floors: [
                    { floor: 1, name: 'Str치쬹ice', enemies: ['soldier_zombie', 'raider'], loot: ['ammo', 'medkit'], boss: null },
                    { floor: 2, name: 'Muni캜n칤 sklad', enemies: ['soldier_zombie', 'robot'], loot: ['ammo', 'weapon'], boss: null },
                    { floor: 3, name: 'Velitelsk칳 bunkr', enemies: ['robot', 'turret'], loot: ['rare_weapon', 'armor'], boss: 'sergeant' }
                ]
            },
            'underground_bunker': {
                name: 'Tajn칳 bunkr',
                floors: [
                    { floor: 1, name: 'Vstupn칤 hala', enemies: ['robot', 'turret'], loot: ['electronics', 'metal'], boss: null },
                    { floor: 2, name: 'Laborato콏e', enemies: ['mutant', 'robot'], loot: ['chemicals', 'electronics'], boss: null },
                    { floor: 3, name: 'Reaktor', enemies: ['mutant', 'giant_mutant'], loot: ['fuel', 'crystal'], boss: null },
                    { floor: 4, name: 'Tajn치 sekce', enemies: ['robot', 'robot'], loot: ['legendary'], boss: 'ai_core' },
                    { floor: 5, name: 'Srdce bunkru', enemies: ['elite_robot'], loot: ['legendary', 'unique'], boss: 'general_morrison' }
                ]
            },
            'old_bunker': {
                name: 'Star칳 bunkr',
                floors: [
                    { floor: 1, name: 'Zreziv캩l칳 vchod', enemies: ['ghoul', 'rat'], loot: ['scrap', 'metal'], boss: null },
                    { floor: 2, name: 'Skladi코t캩', enemies: ['ghoul', 'zombie'], loot: ['food', 'medkit'], boss: null },
                    { floor: 3, name: 'Obytn치 sekce', enemies: ['zombie', 'feral'], loot: ['cloth', 'electronics'], boss: null },
                    { floor: 4, name: 'Tajn치 laborato콏', enemies: ['experiment', 'robot'], loot: ['chemicals', 'rare_item'], boss: 'mad_scientist' }
                ]
            },
            'factory': {
                name: 'Toxick치 tov치rna',
                floors: [
                    { floor: 1, name: 'V칳robn칤 hala', enemies: ['zombie', 'mutant'], loot: ['scrap', 'chemicals'], boss: null },
                    { floor: 2, name: 'Sklady', enemies: ['mutant', 'raider'], loot: ['fuel', 'chemicals'], boss: null },
                    { floor: 3, name: 'Chemick칳 sklad', enemies: ['mutant', 'zombie_hulk'], loot: ['acid', 'chemicals'], boss: 'toxic_beast' }
                ]
            },
            'power_plant': {
                name: 'Elektr치rna',
                floors: [
                    { floor: 1, name: 'Transform치tory', enemies: ['electric_mutant', 'robot'], loot: ['electronics', 'copper'], boss: null },
                    { floor: 2, name: 'Gener치tory', enemies: ['electric_mutant', 'turret'], loot: ['fuel', 'electronics'], boss: null },
                    { floor: 3, name: '콎칤d칤c칤 centrum', enemies: ['robot', 'elite_robot'], loot: ['rare_electronics', 'crystal'], boss: 'power_core' }
                ]
            },
            'chemical_plant': {
                name: 'Chemick치 tov치rna',
                floors: [
                    { floor: 1, name: 'Vstupn칤 hala', enemies: ['toxic_zombie', 'mutant'], loot: ['chemicals', 'scrap'], boss: null },
                    { floor: 2, name: 'V칳robn칤 linka', enemies: ['toxic_zombie', 'acid_beast'], loot: ['acid', 'chemicals'], boss: null },
                    { floor: 3, name: 'Sklad chemik치li칤', enemies: ['acid_beast', 'toxic_beast'], loot: ['rare_chemicals', 'antidote'], boss: 'chemical_horror' }
                ]
            },
            'police_station': {
                name: 'Policejn칤 stanice',
                floors: [
                    { floor: 1, name: 'Recepce', enemies: ['zombie_cop', 'zombie'], loot: ['ammo', 'medkit'], boss: null },
                    { floor: 2, name: 'Cely', enemies: ['zombie_cop', 'feral'], loot: ['weapon', 'armor'], boss: null },
                    { floor: 3, name: 'Zbrojnice', enemies: ['zombie_cop', 'raider'], loot: ['rare_weapon', 'ammo'], boss: 'zombie_chief' }
                ]
            },
            'secret_lab': {
                name: 'Tajn치 laborato콏',
                floors: [
                    { floor: 1, name: 'Dezinfek캜n칤 komora', enemies: ['experiment', 'robot'], loot: ['chemicals', 'electronics'], boss: null },
                    { floor: 2, name: 'V칳zkumn칠 odd캩len칤', enemies: ['experiment', 'mutant'], loot: ['rare_chemicals', 'documents'], boss: null },
                    { floor: 3, name: 'Testovac칤 komory', enemies: ['mutant_brute', 'experiment'], loot: ['mutant_blood', 'crystal'], boss: null },
                    { floor: 4, name: 'J치dro laborato콏e', enemies: ['elite_robot', 'ai_guardian'], loot: ['legendary', 'ai_module'], boss: 'project_x' }
                ]
            },
            'ancient_vault': {
                name: 'Starov캩k칳 trezor',
                floors: [
                    { floor: 1, name: 'Zape캜et캩n칳 vchod', enemies: ['robot', 'turret'], loot: ['electronics', 'crystal'], boss: null },
                    { floor: 2, name: 'Str치쬹칤 chodba', enemies: ['sentinel', 'robot'], loot: ['rare_electronics', 'gold'], boss: null },
                    { floor: 3, name: 'Archiv v캩k콢', enemies: ['sentinel', 'ai_guardian'], loot: ['documents', 'legendary'], boss: null },
                    { floor: 4, name: 'Chr치m poklad콢', enemies: ['ancient_guardian', 'elite_robot'], loot: ['legendary_weapon', 'legendary_armor'], boss: null },
                    { floor: 5, name: 'Srdce trezoru', enemies: ['ancient_guardian'], loot: ['unique_artifact', 'legendary'], boss: 'vault_keeper' }
                ]
            }
        };
        
        // Dungeon bossov칠
        const DUNGEON_BOSSES = {
            'cellar_king': { name: 'Kr치l sklepa', icon: '游', hp: 120, damage: 15, defense: 8, xp: 100, loot: ['food', 'medkit', 'money', 'scrap', 'cloth', 'leather'], lootCount: 3 },
            'nuclear_abomination': { name: 'Jadern치 zr콢da', icon: '驕뮖잺', hp: 600, damage: 50, defense: 20, xp: 600, loot: ['legendary_weapon', 'legendary_armor', 'radx', 'crystal', 'electronics', 'gems'], lootCount: 4, radiation: 30 },
            'vault_keeper': { name: 'Str치쬮e trezoru', icon: '游', hp: 500, damage: 45, defense: 35, xp: 700, loot: ['legendary_weapon', 'legendary_armor', 'rare_weapon', 'electronics', 'crystal', 'gems', 'gold'], lootCount: 5 },
            'mine_foreman': { name: 'D콢ln칤 p콏ed치k', icon: '久勇', hp: 180, damage: 22, defense: 12, xp: 180, loot: ['metal', 'copper', 'rare_weapon', 'money', 'gold'], lootCount: 3 },
            'commander': { name: 'Velitel', icon: '游꿌勇', hp: 220, damage: 28, defense: 18, xp: 250, loot: ['rare_weapon', 'rare_armor', 'ammo', 'medkit', 'money'], lootCount: 4 },
            'sergeant': { name: 'Ser쬬nt', icon: '游눅', hp: 160, damage: 24, defense: 15, xp: 180, loot: ['ammo', 'weapon', 'medkit', 'armor', 'money'], lootCount: 3 },
            'ai_core': { name: 'AI J치dro', icon: '游뱄', hp: 300, damage: 35, defense: 25, xp: 400, loot: ['electronics', 'legendary_weapon', 'rare_armor', 'crystal', 'gems'], lootCount: 4 },
            'toxic_beast': { name: 'Toxick치 bestie', icon: '驕勇', hp: 250, damage: 30, defense: 15, xp: 300, loot: ['mutant_blood', 'chemicals', 'rare_armor', 'herbs'], lootCount: 3 },
            'general_morrison': { name: 'Gener치l Morrison', icon: '救', hp: 400, damage: 40, defense: 30, xp: 500, loot: ['legendary_weapon', 'legendary_armor', 'electronics', 'ammo', 'rare_weapon', 'gems'], lootCount: 5 },
            'mad_scientist': { name: '먞셟en칳 v캩dec', icon: '游빍', hp: 150, damage: 20, defense: 8, xp: 200, loot: ['chemicals', 'rare', 'electronics', 'stimpak'], lootCount: 3 },
            'power_core': { name: 'Energetick칠 j치dro', icon: '丘', hp: 200, damage: 35, defense: 20, xp: 250, loot: ['electronics', 'crystal', 'copper', 'rare_weapon'], lootCount: 3 },
            'chemical_horror': { name: 'Chemick치 hr콢za', icon: '游빎', hp: 280, damage: 32, defense: 12, xp: 280, loot: ['chemicals', 'mutant_blood', 'rare_armor', 'herbs'], lootCount: 3 },
            'zombie_chief': { name: 'Zombie n치캜eln칤k', icon: '游놅', hp: 180, damage: 25, defense: 14, xp: 200, loot: ['weapon', 'armor', 'ammo', 'medkit', 'money'], lootCount: 3 },
            'project_x': { name: 'Projekt X', icon: '游빏', hp: 350, damage: 38, defense: 18, xp: 400, loot: ['legendary', 'electronics', 'rare_weapon', 'crystal', 'chemicals', 'gems'], lootCount: 4 }
        };
        
        // === NPC PRO VZTAHY ===
        const FRIENDLY_NPCS = [
            // === P콡VODN칈 NPC ===
            { id: 'old_merchant', name: 'Star칳 obchodn칤k', icon: '游놊', location: 'trader_camp', 
              personality: 'Moudr칳 a zku코en칳 obchodn칤k. Pamatuje 캜asy p콏ed v치lkou.',
              background: 'P콏ed v치lkou vlastnil obchodn칤 콏et캩zec. Te캞 obchoduje jen proto, aby lid칠 p콏e쬴li.',
              gifts: ['food', 'water', 'medicine'],
              quests: ['find_goods', 'protect_caravan'], 
              rewards: { trust50: 'Sleva 20%', trust100: 'Sleva 25%' },
              relationships: { 'smuggler_radek': 'partner', 'kid_peta': 'inform치tor' }
            },
            { id: 'scout_maya', name: 'Zv캩dka Maya', icon: '游끢꽥勇', location: 'watchtower', 
              personality: 'Rychl치 a odv치쬹치 pr콢zkumnice. V쬯y v pohybu.',
              background: 'Sirotkem od p캩ti let. Nau캜ila se p콏e쮂셦 sama v pustin캩.',
              gifts: ['weapon', 'ammo', 'map'],
              quests: ['explore_area', 'find_survivor'], 
              rewards: { trust50: 'Odhalen칤 mapy', trust100: 'Companion' },
              relationships: { 'hunter_viktor': 'obdiv', 'captain_novak': 'mo쬹칳 otec?' }
            },
            { id: 'doc_harris', name: 'Doktor Harris', icon: '游녿꽥뚯勇', location: 'hospital',
              personality: 'Laskav칳 l칠캜itel. Nikdy neodm칤tne pomoc.',
              background: 'U캜il se u Babi캜ky Marty. Jedin칳 skute캜n칳 doktor v kraji.',
              gifts: ['medicine', 'herbs', 'chemicals'],
              quests: ['gather_herbs', 'rescue_patient'], 
              rewards: { trust50: 'L칠캜en칤 zdarma', trust100: 'Med. tr칠nink' },
              relationships: { 'grandma_marta': 'u캜itelka', 'sister_anna': 'spolupr치ce' }
            },
            { id: 'blacksmith_ivan', name: 'Kov치콏 Ivan', icon: '游댣', location: 'workshop',
              personality: 'Hrub칳, ale zru캜n칳 콏emesln칤k. M치lomluvn칳.',
              background: 'B칳val칳 voj치k. S kapit치nem Nov치kem slou쬴li ve stejn칠 jednotce.',
              gifts: ['metal', 'scrap', 'tools'],
              quests: ['bring_metal', 'test_weapon'], 
              rewards: { trust50: 'Upgrade zbran캩', trust100: 'Legendary craft' },
              relationships: { 'captain_novak': 'kamar치d', 'mechanic_pepa': 'dodavatel' }
            },
            { id: 'mysterious_woman', name: 'Z치hadn치 쬰na', icon: '游댩', location: 'ruins_north',
              personality: 'Nikdo nev칤 odkud p콏i코la. Mluv칤 v h치dank치ch.',
              background: 'Pr칳 byla v캩dkyn칤 p콏ed v치lkou. N캩kte콏칤 콏칤kaj칤, 쬰 vid캩la budoucnost.',
              gifts: ['crystal', 'rare_item', 'book'],
              quests: ['find_artifact', 'solve_riddle'], 
              rewards: { trust50: 'Proroctv칤', trust100: 'Tajn치 lokace' },
              relationships: { 'fortune_rosa': 'rivalka', 'elder_tomas': 'v칤 pravdu', 'sister_anna': 'modl칤 se za ni' }
            },
            
            // === KORY & KOUDY - HLAVN칈 P콎칈B캨H ===
            { id: 'kory', name: 'Kory', icon: '游붳', location: 'trading_post', 
              personality: 'Charismatick칳 vizion치콏. Mluv칤 o "o캜i코t캩n칤" sv캩ta.',
              background: 'Bratr Koudyho. V캩콏칤, 쬰 star칳 sv캩t mus칤 b칳t zni캜en, aby mohl vzniknout nov칳.',
              rival: 'koudy', faction: 'kory_followers',
              gifts: ['weapon', 'ammo', 'explosive'],
              quests: ['sabotage_koudy', 'steal_supplies', 'spread_chaos'], 
              rewards: { trust50: 'V칳bu코niny zdarma', trust100: 'Vyvolen칳' },
              relationships: { 'koudy': 'bratr/rival', 'crazy_jirka': 'v칤 p콏칤li코', 'grandma_marta': 'nen치vist' }
            },
            { id: 'koudy', name: 'Koudy', icon: '游녿꽳릢', location: 'research_facility', 
              personality: 'Unaven칳 v캩dec. V캩콏칤 v z치chranu pomoc칤 v캩dy.',
              background: 'Bratr Koryho. Pracuje na l칠ku proti radiaci. Za jakou cenu?',
              rival: 'kory', faction: 'koudy_hope',
              gifts: ['medicine', 'food', 'tech'],
              quests: ['disrupt_kory', 'gather_intel', 'restore_order'], 
              rewards: { trust50: 'L칠캜en칤 zdarma', trust100: 'Spolutv콢rce' },
              relationships: { 'kory': 'bratr/rival', 'engineer_klara': 'kolegyn캩', 'captain_novak': 'respekt' }
            },
            
            // === NOV칗CH 13 NPC ===
            { id: 'grandma_marta', name: 'Babi캜ka Marta', icon: '游놋', location: 'old_farm',
              personality: 'Star치 bylink치콏ka. Pamatuje si v코echno a v코echny.',
              background: 'U캜ila Harrise v코emu co v칤 o bylin치ch. Ztratila celou rodinu ve v치lce.',
              gifts: ['herbs', 'food', 'cloth'],
              quests: ['gather_herbs', 'find_family_photo'],
              rewards: { trust50: 'Bylinky zdarma', trust100: 'Tajn칳 recept' },
              relationships: { 'doc_harris': '쮂멺', 'teacher_vera': 'p콏칤telkyn캩', 'kory': 'nen치vist' }
            },
            { id: 'captain_novak', name: 'Kapit치n Nov치k', icon: '游꿌勇', location: 'checkpoint',
              personality: 'Disciplinovan칳 voj치k. Hled치 svou ztracenou dceru.',
              background: 'Velel jednotce p콏ed v치lkou. Jeho dcera zmizela den p콏ed bombami.',
              gifts: ['ammo', 'weapon', 'armor'],
              quests: ['find_daughter', 'clear_outpost'],
              rewards: { trust50: 'Vojensk칳 v칳cvik', trust100: 'Tajemstv칤 o 캛ern칠m' },
              relationships: { 'blacksmith_ivan': 'kamar치d', 'commander_cerny': 'bratr!', 'koudy': 'respekt', 'scout_maya': 'dcera?' }
            },
            { id: 'hunter_viktor', name: 'Lovec Viktor', icon: '游낓', location: 'dense_forest',
              personality: 'Samot치콏. Mluv칤 m치lo, sleduje hodn캩.',
              background: '콯ije v lese u 10 let. Lid칠 ho unavuj칤. Zv칤콏ata jsou up콏칤mn캩j코칤.',
              gifts: ['meat', 'leather', 'herbs'],
              quests: ['hunt_alpha', 'track_beast'],
              rewards: { trust50: 'Loveck칠 tipy', trust100: 'Vz치cn치 ko콏ist' },
              relationships: { 'scout_maya': 'ignoruje ji', 'crazy_jirka': 'jedin칳 p콏칤tel' }
            },
            { id: 'mechanic_pepa', name: 'Mechanik Pepa', icon: '游댢', location: 'junkyard',
              personality: 'G칠nius na stroje. Mluv칤 v칤c s motory ne s lidmi.',
              background: 'Opravil prvn칤 auto po v치lce. Sn칤 o tom, 쬰 jednou znovu pojede vlak.',
              gifts: ['scrap', 'electronics', 'fuel'],
              quests: ['find_parts', 'repair_generator'],
              rewards: { trust50: 'Opravy levn캩ji', trust100: 'Opravy zdarma' },
              relationships: { 'blacksmith_ivan': 'dodavatel', 'engineer_klara': 'obdiv' }
            },
            { id: 'sister_anna', name: 'Sestra Anna', icon: '久', location: 'old_church',
              personality: 'Tich치 a laskav치. V캩콏칤, 쬰 dobro p콏e쬴je.',
              background: 'Jedin치 p콏e쬴v코칤 z kl치코tera. L칠캜칤 du코e tam, kde Harris l칠캜칤 t캩la.',
              gifts: ['medicine', 'food', 'book'],
              quests: ['help_refugees', 'find_relic'],
              rewards: { trust50: 'Po쬰hn치n칤', trust100: 'Svat치 relikvie' },
              relationships: { 'doc_harris': 'spolupr치ce', 'mysterious_woman': 'modl칤 se za ni', 'teacher_vera': 'p콏칤telkyn캩' }
            },
            { id: 'smuggler_radek', name: 'Pa코er치k Radek', icon: '游꿠', location: 'highway',
              personality: '만d치 eminence. V칤 v코echno o v코ech.',
              background: 'P콏ed v치lkou pracoval pro vl치du. Nebo proti n칤. Nikdo nev칤 jist캩.',
              gifts: ['rare_item', 'ammo', 'medicine'],
              quests: ['deliver_package', 'gather_intel'],
              rewards: { trust50: '캛ern칳 trh', trust100: 'Velk칠 tajemstv칤' },
              relationships: { 'old_merchant': 'partner', 'kid_peta': 'inform치tor', 'commander_cerny': 'obchod' }
            },
            { id: 'teacher_vera', name: 'U캜itelka V캩ra', icon: '游닄', location: 'ruined_village',
              personality: 'Ochr치nkyn캩 d캩t칤. Vede jedinou 코kolu v pustin캩.',
              background: 'Zachr치nila 12 sirotk콢. U캜칤 je 캜칤st, po캜칤tat a hlavn캩 p콏e쮂셦.',
              gifts: ['book', 'food', 'cloth'],
              quests: ['find_books', 'protect_children'],
              rewards: { trust50: 'Vzd캩l치n칤 (+XP)', trust100: 'Sirotek companion' },
              relationships: { 'grandma_marta': 'p콏칤telkyn캩', 'sister_anna': 'p콏칤telkyn캩', 'kid_peta': '쮂멺' }
            },
            { id: 'crazy_jirka', name: '먞셟en칳 Jirka', icon: '游뱕', location: 'swamp',
              personality: 'Bl치zen? Nebo jedin칳, kdo vid칤 pravdu?',
              background: 'Tvrd칤, 쬰 vid캩l co Kory opravdu pl치nuje. Nikdo mu nev캩콏칤.',
              gifts: ['herbs', 'crystal', 'strange_item'],
              quests: ['listen_to_truth', 'find_proof'],
              rewards: { trust50: 'Varov치n칤', trust100: 'PRAVDA O KORYM' },
              relationships: { 'hunter_viktor': 'jedin칳 p콏칤tel', 'kory': 'v칤 pravdu' }
            },
            { id: 'elder_tomas', name: 'Sta콏ec Tom치코', icon: '游븹', location: 'hermit_hut',
              personality: 'Poustevn칤k. Zn치 historii tohoto m칤sta.',
              background: '콯il tu cel칳 쬴vot. V칤 v캩ci, kter칠 ostatn칤 zapomn캩li nebo nikdy nev캩d캩li.',
              gifts: ['book', 'crystal', 'rare_item'],
              quests: ['hear_history', 'find_old_place'],
              rewards: { trust50: 'Historie kraje', trust100: 'Pravda o Z치hadn칠 쬰n캩' },
              relationships: { 'mysterious_woman': 'v칤 kdo je', 'fortune_rosa': 'ne콏ekne pravdu' }
            },
            { id: 'engineer_klara', name: 'In쬰n칳rka Kl치ra', icon: '游놀꽳릢', location: 'power_plant',
              personality: 'V캩dkyn캩. Kritick치, ale f칠rov치.',
              background: 'Pracovala s Koudym. Ode코la, kdy zjistila... n캩co.',
              gifts: ['electronics', 'chemicals', 'tech'],
              quests: ['repair_reactor', 'investigate_koudy'],
              rewards: { trust50: 'Tech vylep코en칤', trust100: 'D콢kazy proti Koudymu' },
              relationships: { 'koudy': 'b칳val치 kolegyn캩', 'mechanic_pepa': 'obdivovatel' }
            },
            { id: 'commander_cerny', name: 'Velitel 캛ern칳', icon: '游', location: 'raider_camp',
              personality: 'V콢dce n치jezdn칤k콢. Ale je opravdu zl칳?',
              background: 'Bratr kapit치na Nov치ka. Pro캜 se stal t칤m, 캜칤m je?',
              gifts: ['weapon', 'ammo', 'rare_item'],
              quests: ['prove_yourself', 'hear_his_story'],
              rewards: { trust50: 'P콏칤m캩콏칤', trust100: 'Pravda o v치lce' },
              relationships: { 'captain_novak': 'bratr!', 'smuggler_radek': 'obchod' }
            },
            { id: 'kid_peta', name: 'P칠콘a', icon: '游녽', location: 'safehouse',
              personality: 'Sirotek. V코ude proleze, v코echno sly코칤.',
              background: 'Rodi캜e zem콏eli. P콏e쮂셨치 t칤m, 쬰 prod치v치 informace.',
              gifts: ['food', 'water', 'toy'],
              quests: ['find_toy', 'deliver_message'],
              rewards: { trust50: 'Drby', trust100: 'Tajn치 cesta' },
              relationships: { 'old_merchant': 'inform치tor', 'smuggler_radek': 'inform치tor', 'teacher_vera': '쮂멺' }
            },
            { id: 'fortune_rosa', name: 'Kart치콏ka Rosa', icon: '游', location: 'bucovice',
              personality: 'V캩코tkyn캩 v hospod캩. Rivalka Z치hadn칠 쬰ny.',
              background: 'Tvrd칤, 쬰 jej칤 v캩코tby jsou pravdiv칠. Z치hadnou 쬰nu nen치vid칤.',
              gifts: ['crystal', 'rare_item', 'money'],
              quests: ['get_reading', 'discredit_rival'],
              rewards: { trust50: 'V캩코tba', trust100: 'Le o Z치hadn칠 쬰n캩' },
              relationships: { 'mysterious_woman': 'rivalka', 'elder_tomas': 'chce pravdu' }
            },
            
            // === NOV칈 NPC PRO SPECI츼LN칈 QUESTY ===
            { id: 'sheriff_kowalski', name: '만rif Kowalski', icon: '游꿌勇', location: 'crossroads',
              personality: 'Star칳 str치쬮e z치kona. Jedin칳, kdo se sna쮂 udr쬰t po콏치dek.',
              background: 'B칳val칳 policista. St치le nos칤 odznak a v캩콏칤 ve spravedlnost.',
              gifts: ['ammo', 'weapon', 'food'],
              quests: ['detective_quest'],  // Speci치ln칤 - d치v치 detektivn칤 questy
              rewards: { trust50: 'P콏칤stup k d콢kaz콢m', trust100: 'Z치stupce 코erifa' },
              relationships: { 'captain_novak': 'respekt', 'commander_cerny': 'nep콏칤tel' },
              specialQuests: ['murdered_trader', 'missing_child', 'poisoned_well']  // Detektivn칤 questy
            },
            { id: 'messenger_jin', name: 'Posel Jin', icon: '游닏', location: 'broken_bridge',
              personality: 'Rychl칳 a spolehliv칳. P콏in치코칤 zpr치vy z cel칠ho kraje.',
              background: 'B캩h치 mezi osadami a p콏in치코칤 zpr치vy. Zn치 ka쬯ou cestu.',
              gifts: ['food', 'water', 'money'],
              quests: ['urgent_quest'],  // Speci치ln칤 - d치v치 캜asov칠 questy
              rewards: { trust50: 'Rychlej코칤 cestov치n칤', trust100: 'Tajn칠 zkratky' },
              relationships: { 'old_merchant': 'z치kazn칤k', 'kid_peta': 'konkurent' },
              specialQuests: ['rescue_hostage', 'deliver_medicine', 'defuse_bomb', 'escape_horde']  // 캛asov칠 questy
            }
        ];
        
        // === PROPRACOVAN칄 DIALOGY ===
        const NPC_DIALOGUES = {
            // Ka쬯칠 NPC m치 dialogy podle 칰rovn캩 d콢v캩ry a kontextu
            'old_merchant': {
                greeting: {
                    low: [
                        "Hmm, dal코칤 z치kazn칤k? Co pot콏ebuje코?",
                        "Obchod je obchod. Co nab칤z칤코?"
                    ],
                    medium: [
                        "츼, to jsi ty! Jak se da콏칤 v pustin캩?",
                        "V칤tej zp캩t, p콏칤teli. M치m pro tebe n캩co zaj칤mav칠ho."
                    ],
                    high: [
                        "Star칳 p콏칤teli! Poj캞 d치l, pov칤me si u ohn캩.",
                        "T캩코칤 m캩, 쬰 t캩 vid칤m. M치lo je lid칤, kter칳m m콢쬿 v캩콏it."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "*povzdech* P콏ed v치lkou jsem vlastnil dvacet obchod콢. Te캞 m치m jen tento st치nek a vzpom칤nky.",
                            "Obchoduji u pades치t let. Vid캩l jsem, jak lid칠 dok치쬺u b칳t krut칤. Ale i laskav칤.",
                            "Pen칤ze? Nezaj칤maj칤 m캩. Chci jen, aby lid칠 m캩li co j칤st a 캜칤m se br치nit."
                        ],
                        trustRequired: 0
                    },
                    'about_radek': {
                        lines: [
                            "Radek? *rozhl칠dne se* Ten chlap v칤 v캩ci. Nebezpe캜n칠 v캩ci.",
                            "Spolupracujeme. On se쬰ne, j치 prod치m. Neptej se na v칤c.",
                            "Jestli chce코 n캩co speci치ln칤ho... Radek to m콢쬰 sehnat. Za cenu."
                        ],
                        trustRequired: 30
                    },
                    'about_kory': {
                        lines: [
                            "Kory... *zavrt칤 hlavou* Ten mlad칤k m치 v o캜칤ch ohe켿. Ale ne ten dobr칳.",
                            "Vid캩l jsem takov칠 jako on p콏ed v치lkou. V쬯ycky to skon캜ilo 코patn캩.",
                            "Poslouchej, v칤m 쬰 je charismatick칳. Ale pozor na ty, kdo slibuj칤 r치j."
                        ],
                        trustRequired: 50
                    },
                    'secret': {
                        lines: [
                            "*코ept치* V칤코 pro캜 vlastn캩 v치lka za캜ala? Nebyla to n치hoda.",
                            "N캩kdo ji cht캩l. A mysl칤m, 쬰 Kory v칤 kdo. Nebo je jeho sou캜치st칤.",
                            "Najdi Jirku v ba쬴n치ch. Je bl치zen, ale... on tam BYL. On to VID캨L."
                        ],
                        trustRequired: 80
                    }
                },
            },
            
            'grandma_marta': {
                greeting: {
                    low: [
                        "*p콏imhou콏칤 o캜i* Dal코칤 tul치k. Co chce코, mlad칤ku?",
                        "Nem치m 캜as na pov칤d치n칤. Co pot콏ebuje코?"
                    ],
                    medium: [
                        "Ty jsi ten, co pom치h치 lidem. Poj캞 d치l.",
                        "Uva콏칤m ti 캜aj. Posa캞 se a pov칤me si."
                    ],
                    high: [
                        "D칤t캩 moje! *obejme t캩* Tak r치d t캩 vid칤m!",
                        "Poj캞, poj캞. M치m pro tebe n캩co dobr칠ho z bylinek."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "콯iju tu sedmdes치t let. Pamatuju 캜asy, kdy tu kvetly jablon캩.",
                            "M캩la jsem t콏i d캩ti. V코echny mi je vzala v치lka. *slza*",
                            "Te캞 u캜칤m mlad칠, co v칤m. Harris byl m콢j nejlep코칤 쮂멺."
                        ],
                        trustRequired: 0
                    },
                    'about_harris': {
                        lines: [
                            "Mal칳 Thomas... teda doktor Harris. P콏i코el ke mn캩 jako chlapec.",
                            "Nau캜ila jsem ho v코echno o bylin치ch. O l칠캜en칤. O lidech.",
                            "Je to dobr칳 캜lov캩k. Mo쬹치 jedin칳 opravdu dobr칳 v tomhle proklet칠m sv캩t캩."
                        ],
                        trustRequired: 20
                    },
                    'about_vera': {
                        lines: [
                            "V캩ra je jako dcera, kterou jsem ztratila. Chr치n칤 ty d캩ti jako lvice.",
                            "Chod칤m j칤 pom치hat u캜it. Star칠 recepty, star칠 p콏칤b캩hy...",
                            "V t캩ch d캩tech je nad캩je. Jedin치 nad캩je."
                        ],
                        trustRequired: 30
                    },
                    'about_kory': {
                        lines: [
                            "*zho콏kne* Ten had! Ne콏칤kej to jm칠no v m칠m dom캩!",
                            "Znala jsem ho jako d칤t캩. U tehdy m캩l v o캜칤ch tmu.",
                            "On a jeho bratr... rozbili sv캩t. A te캞 ho cht캩j칤 znovu."
                        ],
                        trustRequired: 40
                    },
                    'secret': {
                        lines: [
                            "*코ept치* Kory nen칤 ten, za koho se vyd치v치.",
                            "P콏ed v치lkou... pracoval pro VL츼DU. Na tom projektu.",
                            "Projekt Genesis. On ho nezastavil. On ho SPUSTIL."
                        ],
                        trustRequired: 90
                    }
                },
                mentions: {
                    'doc_harris': "M콢j 쮂멺. Hrd치 jsem na n캩j.",
                    'teacher_vera': "Jako m치 vlastn칤 dcera.",
                    'kory': "캝치bel v lidsk칠 k콢쬴."
                }
            },
            
            'captain_novak': {
                greeting: {
                    low: [
                        "*salutuje* Civilista. Identifikuj se.",
                        "Toto je vojensk치 z칩na. Co tu pohled치v치코?"
                    ],
                    medium: [
                        "츼, ty. Sly코el jsem o tob캩 dobr칠 v캩ci. Pohod캩.",
                        "Vstup povolen. M치코 p캩t minut."
                    ],
                    high: [
                        "P콏칤teli! *pod치 ruku* Poj캞 d치l, m치me co probrat.",
                        "R치d t캩 vid칤m. Pot콏eboval bych tvou pomoc s n캩캜칤m... osobn칤m."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "Kapit치n Nov치k. T콏et칤 mechanizovan치. Nebo to, co z n칤 zbylo.",
                            "Velel jsem stovce mu쮄. Te캞 jich m치m osm.",
                            "Dr쮂셠e linii. Chr치n칤me civilisty. To je n치코 칰캜el."
                        ],
                        trustRequired: 0
                    },
                    'about_daughter': {
                        lines: [
                            "*hlas se zlom칤* M치 dcera... Emma. Zmizela den p콏ed bombami.",
                            "Hled치m ji deset let. DESET LET.",
                            "N캩kdy si 콏칤k치m... mo쬹치 je mrtv치. Ale nem콢쬿 p콏estat hledat."
                        ],
                        trustRequired: 40
                    },
                    'about_ivan': {
                        lines: [
                            "Ivan? Slou쬴li jsme spolu. Zachr치nil mi 쬴vot. Dvakr치t.",
                            "Dobr칳 voj치k. Lep코칤 p콏칤tel. Jeden z m치la, kter칳m v캩콏칤m.",
                            "Te캞 kove m칤sto toho, aby bojoval. Mo쬹치 je moud콏ej코칤 ne j치."
                        ],
                        trustRequired: 20
                    },
                    'about_cerny': {
                        lines: [
                            "*dlouh칠 ticho* 캛ern칳... je m콢j bratr.",
                            "Martin 캛ern칳. M콢j mlad코칤 bratr. Te캞 vede n치jezdn칤ky.",
                            "Nev칤m co se stalo. Co ho zlomilo. Ale jednou... mus칤me si promluvit."
                        ],
                        trustRequired: 70
                    },
                    'secret': {
                        lines: [
                            "M치 dcera... na코el jsem stopu. Maya...",
                            "*ticho* Ona nev칤 kdo je. Ale ty rysy. Ten v캩k. To mus칤 b칳t ona.",
                            "Nem콢쬿 j칤 to 콏칤ct. Je코t캩 ne. Pot콏ebuji d콢kaz."
                        ],
                        trustRequired: 95
                    }
                },
                mentions: {
                    'blacksmith_ivan': "Bratr ve zbrani. V캩콏칤m mu 쬴votem.",
                    'commander_cerny': "M콢j bratr. *bolestn칳 pohled*",
                    'scout_maya': "Ta d칤vka... p콏ipom칤n치 mi n캩koho."
                }
            },
            
            'crazy_jirka': {
                greeting: {
                    low: [
                        "*bl치boliv캩* ONI p콏ich치zej칤! ONI V칈!",
                        "TY! Jsi jeden z NICH? Ne? DOKAA콯 TO!"
                    ],
                    medium: [
                        "*klidn캩ji* 츼. Ty. Ty aspo켿 poslouch치코.",
                        "P콏i코el jsi sly코et pravdu? Nebo jen dal코칤 l쬴?"
                    ],
                    high: [
                        "*jasn캩* P콏칤teli. Ty mi v캩콏칤코, 쬰?",
                        "Poj캞 bl칤. M치m ti co 콏칤ct. Ale ONI nesm칤 sly코et."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "콎칤kaj칤 mi 코칤lenec. ALE J츼 JSEM TAM BYL!",
                            "Vid캩l jsem to. V laborato콏i. V NOC P콎ED BOMBAMI.",
                            "Nikdo mi nev캩콏칤. *pl치캜e* Nikdo..."
                        ],
                        trustRequired: 0
                    },
                    'about_viktor': {
                        lines: [
                            "Viktor? On je jedin칳, kdo m캩 nepova쬿je za bl치zna.",
                            "Nos칤 mi j칤dlo. Nemluv칤, ale... ch치pe.",
                            "On taky v칤, 쬰 sv캩t je zka쬰n칳. Proto 쬴je se zv칤콏aty."
                        ],
                        trustRequired: 20
                    },
                    'what_he_saw': {
                        lines: [
                            "*t콏ese se* Ta laborato콏... pod m캩stem... VID캨L JSEM JE!",
                            "Kory. A dal코칤. Kolem TLA캛칈TKA. Sm치li se!",
                            "Oni to CHT캨LI! Bomby! V코echno! BYL TO PL츼N!"
                        ],
                        trustRequired: 50
                    },
                    'secret': {
                        lines: [
                            "*칰pln캩 jasn캩* Poslouchej pozorn캩. M치m d콢kaz.",
                            "Schoval jsem dokumenty. V ba쬴n치ch. Pod mrtv칳m stromem.",
                            "Projekt Genesis. Kory ho nevynalezl. On ho SPUSTIL. Z치m캩rn캩."
                        ],
                        trustRequired: 80
                    }
                },
                mentions: {
                    'hunter_viktor': "M콢j jedin칳 p콏칤tel. On ch치pe.",
                    'kory': "캝츼BEL! V칈M CO JSI UD캨LAL!"
                }
            },
            
            'mysterious_woman': {
                greeting: {
                    low: [
                        "*ti코e* Pro캜 jsi p콏i코el? Co hled치코?",
                        "Vid칤m... temnotu. A sv캩tlo. Oboj칤 v tob캩."
                    ],
                    medium: [
                        "Tv치 cesta je zaj칤mav치. Poj캞 bl칤.",
                        "캛as je 콏eka. Ty jsi k치men. Zm캩n칤코 jej칤 tok?"
                    ],
                    high: [
                        "*칰sm캩v* Kone캜n캩 jsi p콏ipraven sly코et.",
                        "V칤m pro캜 jsi p콏i코el. A m치m pro tebe odpov캩di."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "Kdo jsem? *z치hadn칳 칰sm캩v* Kdo jsme v코ichni?",
                            "Byla jsem n캩k칳m jin칳m. P콏ed v치lkou. P콏ed v코칤m.",
                            "Te캞 jsem jen ta, kter치 V칈. A 캜ek치."
                        ],
                        trustRequired: 0
                    },
                    'about_rosa': {
                        lines: [
                            "Rosa? *lehk칳 sm칤ch* V캩코tkyn캩, kter치 nevid칤.",
                            "Ona 캜te karty. J치 캜tu osud.",
                            "Nen치vid칤 m캩, proto쬰 v칤, 쬰 m치m pravdu."
                        ],
                        trustRequired: 30
                    },
                    'about_tomas': {
                        lines: [
                            "Sta콏ec Tom치코... jeden z m치la, kdo si pamatuje.",
                            "On v칤 kdo jsem. Ale ne콏ekne. Dobr칳 mu.",
                            "A bude코 p콏ipraven, jdi za n칤m. On ti pov칤 zbytek."
                        ],
                        trustRequired: 60
                    },
                    'secret': {
                        lines: [
                            "*sund치 kapuci* Pozn치v치코 m캩?",
                            "Jmenovala jsem se... Dr. Eva Nov치kov치. Vedla jsem Projekt Genesis.",
                            "Cht캩la jsem zachr치nit sv캩t. M칤sto toho jsem ho zni캜ila. *slzy*"
                        ],
                        trustRequired: 100
                    }
                },
                mentions: {
                    'fortune_rosa': "Slep치 v캩코tkyn캩. Nev칤 nic.",
                    'elder_tomas': "Star칳 p콏칤tel. Str치쬮e m칠ho tajemstv칤."
                }
            },
            
            'commander_cerny': {
                greeting: {
                    low: [
                        "*ruka na zbrani* St콢j! Pro캜 bych t캩 nem캩l zab칤t?",
                        "Dal코칤 hrdina? Posledn칤 t콏i jsou zakop치ni tamhle."
                    ],
                    medium: [
                        "*p콏imhou콏칤 o캜i* Ty m치코 koule. Respektuju to.",
                        "P콏i코el jsi obchodovat? Nebo zem콏칤t?"
                    ],
                    high: [
                        "*m치vne str치쬰 pry캜* Nech n치s. Tohle je... p콏칤tel.",
                        "Poj캞 ke mn캩. M치me si co 콏칤ct. O minulosti."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "Jsem 캛ern칳. V콢dce t캩chto mu쮄. To je v코e co pot콏ebuje코 v캩d캩t.",
                            "N치jezdn칤ci? Mo쬹치. P콏e쮂셨aj칤c칤? Ur캜it캩.",
                            "D캩l치m co mus칤m. Jako v쬯ycky."
                        ],
                        trustRequired: 0
                    },
                    'about_novak': {
                        lines: [
                            "*dlouh칠 ticho* M콢j bratr. Kapit치n spravedliv칳.",
                            "Nevid캩l jsem ho deset let. Nechci.",
                            "On nech치pe. NIKDY nepochopil pro캜 jsem ode코el."
                        ],
                        trustRequired: 50
                    },
                    'why_raider': {
                        lines: [
                            "Chce코 v캩d캩t pro캜? *ho콏k칳 sm칤ch*",
                            "Vid캩l jsem co ARM츼DA ud캩lala. NAE arm치da. Civilist콢m.",
                            "Rozkazy shora. 'Vy캜istit oblast.' V캩d캩l jsem co to znamen치."
                        ],
                        trustRequired: 70
                    },
                    'secret': {
                        lines: [
                            "Neode코el jsem, proto쬰 jsem zbab캩lec. Ode코el jsem, proto쬰 jsem ODM칈TL.",
                            "Rozkaz byl... zab칤t vesnici. 콯eny. D캩ti. 'Potenci치ln칤 naka쬰n칤.'",
                            "Tak jsem vzal ty, kte콏칤 taky odm칤tli. A stal jsem se 'zlo캜incem'."
                        ],
                        trustRequired: 90
                    }
                },
                mentions: {
                    'captain_novak': "M콢j bratr. *bolest* K칠 by pochopil.",
                    'smuggler_radek': "Obchodn칤 partner. Spolehliv칳."
                }
            },
            
            // Ostatn칤 NPC maj칤 jednodu코코칤 dialogy
            'scout_maya': {
                greeting: {
                    low: ["Kdo jsi? Vypad치코... *prohl칤쮂 t캩* ...pou쬴teln캩."],
                    medium: ["Hej! M치코 pro m캩 n캩jakou pr치ci? Nud칤m se."],
                    high: ["*zam치v치* K치mo! Poj캞, m치m co uk치zat!"]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem Maya. Pr콢zkumnice. Nejrychlej코칤 v pustin캩.", "Rodi캜e? *pokr캜칤 rameny* Nepamatuju je."],
                        trustRequired: 0
                    },
                    'about_viktor': {
                        lines: ["Viktor? *z캜erven치* Je... dobr칳 lovec. Nic v칤c.", "Cht캩la bych aby m캩 u캜il. Ale ignoruje m캩."],
                        trustRequired: 20
                    }
                },
                mentions: { 'hunter_viktor': "*z캜erven치* On je... prost캩 dobr칳." }
            },
            
            'doc_harris': {
                greeting: {
                    low: ["Jsi zran캩n칳? Uka. Pom콢쬿."],
                    medium: ["츼, p콏칤teli! Poj캞 d치l, d치m ti 캜aj."],
                    high: ["*코irok칳 칰sm캩v* Tak r치d t캩 vid칤m zdrav칠ho!"]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem doktor. Jedin칳 tady kolem. Marta m캩 u캜ila, kdy jsem byl mlad칳.", "L칠캜칤m v코echny. N치jezdn칤ky, voj치ky... bolest je stejn치."],
                        trustRequired: 0
                    },
                    'about_marta': {
                        lines: ["Marta? *n캩쬹캩* Ta 쬰na mi dala v코echno. Nad캩ji, znalosti, smysl.", "Bez n칤 bych byl jen dal코칤 loupe쬹칤k."],
                        trustRequired: 20
                    }
                },
                mentions: { 'grandma_marta': "M치 u캜itelka. Dlu쮂셠 j칤 쬴vot." }
            },
            
            'blacksmith_ivan': {
                greeting: {
                    low: ["*bouchne kladivem* Co chce코?"],
                    medium: ["*p콏ik칳vne* Zbra켿 nebo zbroj?"],
                    high: ["*odlo쮂 kladivo* Po캜kej. D치m si s tebou pauzu."]
                },
                topics: {
                    'about_self': {
                        lines: ["Kov치콏. B칳val칳 voj치k. To je v코e.", "*ukazuje jizvu* Tohle mi zachr치nil Nov치k. Dlu쮂셠 mu."],
                        trustRequired: 0
                    },
                    'about_novak': {
                        lines: ["Slou쬴li jsme spolu. Dobr칳 velitel. Lep코칤 캜lov캩k.", "Hled치 dceru. Deset let. *zavrt칤 hlavou* Smutn칠."],
                        trustRequired: 30
                    }
                },
                mentions: { 'captain_novak': "Kamar치d. Bratr ve zbrani." }
            },
            
            'hunter_viktor': {
                greeting: {
                    low: ["*ticho, jen p콏ik칳vne*"],
                    medium: ["*p콏ik칳vne* N캩co chce코?"],
                    high: ["*poprv칠 칰sm캩v* Posa캞 se. M치m maso."]
                },
                topics: {
                    'about_self': {
                        lines: ["*dlouh칠 ticho* Les. To je v코e co pot콏ebuju.", "Lid칠 l쬺u. Zv칤콏ata ne."],
                        trustRequired: 0
                    },
                    'about_jirka': {
                        lines: ["Jirka nen칤 bl치zen. *v치쬹캩* On n캩co vid캩l.", "Nos칤m mu j칤dlo. Ostatn칤 ho ignoruj칤."],
                        trustRequired: 40
                    }
                },
                mentions: { 'crazy_jirka': "Nen칤 bl치zen. Jen vid캩l p콏칤li코." }
            },
            
            'kory': {
                greeting: {
                    low: ["*charismaticky* V칤tej, poutn칤ku! Hled치코 pravdu?"],
                    medium: ["*polo쮂 ruku na rameno* V캩d캩l jsem, 쬰 se vr치t칤코."],
                    high: ["Brat콏e! *obejme t캩* Jsi p콏ipraven zm캩nit sv캩t?"]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem Kory. Vizion치콏. Ten, kdo vid칤 cestu.", "Star칳 sv캩t byl zka쬰n칳. Zni캜ili jsme ho. Te캞 budujeme nov칳."],
                        trustRequired: 0
                    },
                    'about_koudy': {
                        lines: ["M콢j bratr... *zavrt칤 hlavou* Ztratil se ve v캩d캩.", "On chce OPRAVIT star칳 sv캩t. J치 chci NOV칗.", "Jednou pochop칤. Nebo... nepochop칤."],
                        trustRequired: 30
                    }
                },
                mentions: { 'koudy': "M콢j bratr. Zaslepen칳 v캩dou." }
            },
            
            'koudy': {
                greeting: {
                    low: ["*unaven캩* Dal코칤 p콏eru코en칤. Co pot콏ebuje코?"],
                    medium: ["*odlo쮂 n치stroje* Dob콏e. M치m p치r minut."],
                    high: ["*up콏칤mn칳 칰sm캩v* P콏칤teli. Poj캞, uk치쬿 ti pokroky."]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem v캩dec. Pracuji na l칠ku proti radiaci.", "M콢j bratr... zni캜il sv캩t. J치 ho oprav칤m."],
                        trustRequired: 0
                    },
                    'about_kory': {
                        lines: ["Kory... *dlouh칠 ticho* Je nemocn칳. V hlav캩.", "On CHT캨L tu v치lku. J치 jsem... pomohl. *ho콏ce*", "Te캞 se to sna쮂셠 napravit."],
                        trustRequired: 50
                    }
                },
                mentions: { 'kory': "M콢j bratr. Moje selh치n칤." }
            }
        };
        
        // Vztahy mezi NPC - kdo o kom mluv칤
        const NPC_RELATIONSHIP_HINTS = {
            'scout_maya': { 'captain_novak': 'M치 podobn칠 o캜i jako on... zvl치코tn칤.' },
            'captain_novak': { 'scout_maya': 'Ta d칤vka... m치 Emminy o캜i.' },
            'mysterious_woman': { 'kory': 'On v칤 kdo jsem. A boj칤 se t칠 pravdy.' },
            'crazy_jirka': { 'kory': 'VID캨L JSEM CO UD캨LAL! M츼M D콡KAZ!' },
            'grandma_marta': { 'doc_harris': 'M콢j nejlep코칤 쮂멺. Jsem na n캩j hrd치.' },
            'elder_tomas': { 'mysterious_woman': 'V칤m kdo je. Ale to tajemstv칤 mus칤 odhalit sama.' }
        };
        
        // NPC questy
        const NPC_QUESTS = {
            'find_goods': { 
                name: 'Dones z치soby', 
                desc: 'M콢j zn치m칳 pot콏ebuje z치soby. Donese코 mu je?', 
                details: '游닍 Nasb칤rej 10 surovin a dones je c칤lov칠mu NPC. C칤l se ti zobraz칤 po nasb칤r치n칤.',
                requirement: { resources: 10, deliver: true }, 
                reward: { money: 200, trust: 15 },
                deliverTargets: ['elder_tomas', 'mysterious_woman', 'blacksmith_ivan', 'doc_harris', 'grandma_marta', 'teacher_vera']
            },
            'protect_caravan': { 
                name: 'Ochra켿 karavanu', 
                desc: 'Doprovo캞 mou karavanu.', 
                details: '游냙 Cestuj na 3 r콢zn칠 lokace a p콏e쬴j p콏칤padn칠 souboje. Pak se vra콘 pro odm캩nu.',
                requirement: { escort: true, travels: 3 }, 
                reward: { money: 300, trust: 20, item: 'rare' } 
            },
            'explore_area': { 
                name: 'Prozkoumej oblast', 
                desc: 'Pot콏ebuji 캜erstv칠 informace o okol칤.', 
                details: '游딬勇 Nav코tiv 5 NOV칗CH lokac칤 po p콏ijet칤 칰kolu. Star칠 mapy jsou k ni캜emu.',
                requirement: { explore: 5 }, 
                reward: { xp: 150, trust: 15 } 
            },
            'find_survivor': { 
                name: 'Najdi p콏e쬴v코칤ho', 
                desc: 'Hled치m sv칠ho bratra.', 
                details: '游녻 Prozkoumej okoln칤 lokace. Bratr byl naposledy vid캩n u opu코t캩n칳ch budov.',
                requirement: { find_npc: true }, 
                reward: { trust: 30, companion: true } 
            },
            'gather_herbs': { 
                name: 'Sb캩r 캜erstv칳ch bylin', 
                desc: 'Pot콏ebuji 캛ERSTV칄 byliny, ne su코en칠!', 
                details: '游 Nasb칤rej 15 bylin PO p콏ijet칤 칰kolu. Na l칠ky pot콏ebuji 캜erstv칠 - star칠 ztratily 칰캜innost.',
                requirement: { herbs: 15 }, 
                reward: { money: 100, trust: 10, item: 'medkit' } 
            },
            'rescue_patient': { 
                name: 'Zachra켿 pacienta', 
                desc: 'Pacient je uv캩zn캩n n치jezdn칤ky.', 
                details: '丘덢잺 Najdi t치bor n치jezdn칤k콢, poraz je a osvobo캞 zajatce.',
                requirement: { rescue: true }, 
                reward: { trust: 25, medical_training: true } 
            },
            'bring_metal': { 
                name: '캛erstv칳 kovov칳 코rot', 
                desc: 'Pot콏ebuji nerezav칳 kov, 캜erstv캩 sebran칳!', 
                details: '游댤 Nasb칤rej 20 kovu PO p콏ijet칤 칰kolu. Star칳 코rot z invent치콏e je u zkorodovan칳.',
                requirement: { metal: 20 }, 
                reward: { money: 150, trust: 10 } 
            },
            'test_weapon': { 
                name: 'Otestuj zbra켿', 
                desc: 'Zabij 10 nep콏치tel mou novou zbran칤.', 
                details: '丘덢잺 Zabij 10 nep콏치tel PO p콏ijet칤 칰kolu. Pot콏ebuji v캩d캩t jak zbra켿 funguje v akci.',
                requirement: { kills: 10 }, 
                reward: { trust: 20, weapon: 'upgraded' } 
            },
            'find_artifact': { 
                name: 'Najdi artefakt', 
                desc: 'Hled치m starobyl칳 p콏edm캩t...', 
                details: '游끹勇 Prozkoumej star칠 ruiny a hrobky. Artefakt je ukryt칳 hluboko v podzem칤.',
                requirement: { artifact: true }, 
                reward: { trust: 30, prophecy: true } 
            },
            'solve_riddle': { 
                name: 'Vy콏e코 h치danku', 
                desc: 'Odpov캩z spr치vn캩 na 3 ot치zky.', 
                details: '游빌 Promluv si se mnou a odpov캩z na m칠 h치danky. M치코 3 pokusy.',
                requirement: { riddles: 3 }, 
                reward: { trust: 25, secret: true } 
            },
            
            // === KORY QUESTY (Chaos) ===
            'sabotage_koudy': { name: 'Sabot치!', desc: 'P콏ines 10 v칳bu코nin (gunpowder).', 
                requirement: { resource: 'gunpowder', amount: 10 }, 
                reward: { money: 300, trust: 25, karma_kory: 10, karma_koudy: -15 },
                rival: 'koudy' },
            'steal_supplies': { name: 'Kr치de z치sob', desc: 'P콏ines 150 pen캩z.', 
                requirement: { money: 150 }, 
                reward: { money: 250, trust: 20, karma_kory: 8, karma_koudy: -10 },
                rival: 'koudy' },
            'spread_chaos': { name: '먞솬뗜n칤 chaosu', desc: 'Zabij 5 nep콏치tel kdekoliv.', 
                requirement: { kills: 5 }, 
                reward: { money: 400, trust: 30, karma_kory: 15, karma_koudy: -20 },
                rival: 'koudy' },
                
            // === KOUDY QUESTY (콎치d) ===
            'disrupt_kory': { name: 'Naru코it operace', desc: 'P콏ines 15 kovu na barik치dy.', 
                requirement: { resource: 'metal', amount: 15 }, 
                reward: { money: 300, trust: 25, karma_koudy: 10, karma_kory: -15 },
                rival: 'kory' },
            'gather_intel': { name: 'Sb캩r informac칤', desc: 'Prozkoumej 3 lokace (nav코tiv nov칠 m칤sta).', 
                requirement: { explore: 3 }, 
                reward: { money: 200, trust: 20, karma_koudy: 8, karma_kory: -10 },
                rival: 'kory' },
            'restore_order': { name: 'Obnovit po콏치dek', desc: 'Zabij 5 nep콏치tel kdekoliv.', 
                requirement: { kills: 5 }, 
                reward: { money: 400, trust: 30, karma_koudy: 15, karma_kory: -20 },
                rival: 'kory' },
            
            // === CHYB캨J칈C칈 NPC QUESTY ===
            'clear_outpost': {
                name: 'Vy캜isti z치kladnu',
                desc: 'Vy캜isti nep콏치telskou z치kladnu od n치jezdn칤k콢.',
                details: '丘덢잺 Zabij 8 nep콏치tel v nep콏치telsk칳ch lokac칤ch.',
                requirement: { kills: 8 },
                reward: { money: 350, trust: 25, xp: 100 }
            },
            'deliver_message': {
                name: 'Doru캜 zpr치vu',
                desc: 'Doru캜 d콢le쬴tou zpr치vu do obchodn칤ho postu.',
                details: '游닆 Cestuj do obchodn칤ho postu (trading_post) a vra콘 se.',
                requirement: { visit: 'trading_post' },
                reward: { money: 150, trust: 15 }
            },
            'deliver_package': {
                name: 'Doru캜 bal칤k',
                desc: 'Doru캜 tajn칳 bal칤k na domluven칠 m칤sto.',
                details: '游닍 Nav코tiv 2 r콢zn칠 lokace s bal칤kem.',
                requirement: { travels: 2 },
                reward: { money: 200, trust: 20 }
            },
            'detective_quest': {
                name: 'Vy코et콏ov치n칤',
                desc: 'Prozkoumej stopy a najdi vin칤ka.',
                details: '游댌 Prozkoumej 4 lokace a najdi d콢kazy.',
                requirement: { explore: 4 },
                reward: { money: 300, trust: 25, xp: 150 }
            },
            'discredit_rival': {
                name: 'Diskredituj rivala',
                desc: 'Najdi kompromituj칤c칤 materi치ly na m칠ho konkurenta.',
                details: '游늬 Prozkoumej 3 lokace a najdi tajn칠 dokumenty.',
                requirement: { explore: 3 },
                reward: { money: 250, trust: 20 }
            },
            'find_books': {
                name: 'Sb캩r knih',
                desc: 'Najdi star칠 knihy pro mou sb칤rku.',
                details: '游닄 Prozkoumej star칠 budovy a najdi 3 knihy.',
                requirement: { explore: 3 },
                reward: { money: 200, trust: 15, xp: 100 }
            },
            'find_daughter': {
                name: 'Najdi mou dceru',
                desc: 'Moje dcera zmizela, pros칤m najdi ji.',
                details: '游녾 Prozkoumej 5 lokac칤 a najdi stopy.',
                requirement: { explore: 5 },
                reward: { money: 400, trust: 35 }
            },
            'find_family_photo': {
                name: 'Najdi rodinnou fotku',
                desc: 'Moje jedin치 pam치tka na rodinu se ztratila.',
                details: '游뒆勇 Prozkoumej star칠 domy a najdi fotku.',
                requirement: { explore: 2 },
                reward: { trust: 25, item: 'family_photo' }
            },
            'find_old_place': {
                name: 'Najdi star칠 m칤sto',
                desc: 'Hled치m m칤sto z m칳ch vzpom칤nek.',
                details: '游끸勇 Nav코tiv 4 r콢zn칠 lokace.',
                requirement: { explore: 4 },
                reward: { money: 200, trust: 20, secret: true }
            },
            'find_parts': {
                name: 'Najdi d칤ly',
                desc: 'Pot콏ebuji n치hradn칤 d칤ly na opravu.',
                details: '游댢 Nasb칤rej 15 kovu a 5 elektroniky.',
                requirement: { metal: 15 },
                reward: { money: 250, trust: 20 }
            },
            'find_proof': {
                name: 'Najdi d콢kazy',
                desc: 'Pot콏ebuji d콢kazy o zlo캜inu.',
                details: '游댌 Prozkoumej podez콏el칠 lokace.',
                requirement: { explore: 3 },
                reward: { money: 300, trust: 25 }
            },
            'find_relic': {
                name: 'Najdi relikvii',
                desc: 'Hled치m prastar칳 artefakt.',
                details: '游낔 Prozkoumej ruiny a hrobky.',
                requirement: { explore: 4 },
                reward: { money: 500, trust: 30, item: 'ancient_relic' }
            },
            'find_toy': {
                name: 'Najdi hra캜ku',
                desc: 'Ztratila se obl칤ben치 hra캜ka m칠ho d칤t캩te.',
                details: '游빚 Prozkoumej okol칤 a najdi ply코치ka.',
                requirement: { explore: 2 },
                reward: { trust: 20, item: 'old_toy' }
            },
            'get_reading': {
                name: 'Z칤skej 캜ten칤',
                desc: 'Pot콏ebuji, abys mi p콏e캜etl budoucnost.',
                details: '游댩 Nav코tiv v캩코tce (Severn칤 ruiny nebo Bu캜ovice) a vra콘 se s proroctv칤m.',
                requirement: { visit: 'ruins_north' },
                reward: { trust: 15, prophecy: true }
            },
            'hear_his_story': {
                name: 'Vyslechni p콏칤b캩h',
                desc: 'Star칳 mu chce vypr치v캩t sv콢j p콏칤b캩h.',
                details: '游놊 Pohovo콏 si a vyslechni si jeho 쬴votn칤 p콏칤b캩h.',
                requirement: { talk: true },
                reward: { trust: 10, xp: 50, lore: true }
            },
            'hear_history': {
                name: 'Vyslechni historii',
                desc: 'Chci ti vypr치v캩t o star칳ch 캜asech.',
                details: '游닆 Vyslechni historii tohoto m칤sta.',
                requirement: { talk: true },
                reward: { trust: 15, xp: 75, lore: true }
            },
            'help_refugees': {
                name: 'Pomoz uprchl칤k콢m',
                desc: 'Skupina uprchl칤k콢 pot콏ebuje pomoc.',
                details: '游끢 P콏ines 10 j칤dla a 10 vody pro uprchl칤ky.',
                requirement: { resources: 20 },
                reward: { trust: 30, karma: 10 }
            },
            'hunt_alpha': {
                name: 'Ulov alfa pred치tora',
                desc: 'Obrovsk치 bestie terorizuje oblast.',
                details: '游냨 Najdi a zabij alfa mutanta (vlka, medv캩da nebo jin칠ho alfa pred치tora). Hledej v nebezpe캜n칳ch z칩n치ch.',
                requirement: { killAlpha: true },
                reward: { money: 500, trust: 35, item: 'rare' }
            },
            'investigate_koudy': {
                name: 'Vy코et콏i Koudyho',
                desc: 'Zjisti co Koudy ve skute캜nosti pl치nuje.',
                details: '游댌 Prozkoumej Koudyho teritorium.',
                requirement: { explore: 3 },
                reward: { money: 300, trust: 20, karma_kory: 10 }
            },
            'listen_to_truth': {
                name: 'Vyslechni pravdu',
                desc: 'Chci ti 콏칤ct n캩co d콢le쬴t칠ho.',
                details: '游녝 Vyslechni tajemstv칤.',
                requirement: { talk: true },
                reward: { trust: 20, secret: true }
            },
            'protect_children': {
                name: 'Ochra켿 d캩ti',
                desc: 'D캩ti jsou v nebezpe캜칤, ochra켿 je!',
                details: '游놌 Doprovo캞 d캩ti do bezpe캜칤 (3 cesty).',
                requirement: { escort: true, travels: 3 },
                reward: { trust: 35, karma: 15 }
            },
            'prove_yourself': {
                name: 'Doka svou hodnotu',
                desc: 'Uka 쬰 jsi hoden m칠 d콢v캩ry.',
                details: '丘덢잺 Zabij 5 nep콏치tel a p콏e쬴j.',
                requirement: { kills: 5 },
                reward: { trust: 25, respect: true }
            },
            'repair_generator': {
                name: 'Oprav gener치tor',
                desc: 'N치코 gener치tor je rozbit칳.',
                details: '游댢 P콏ines 10 kovu a 5 elektroniky.',
                requirement: { metal: 10 },
                reward: { money: 200, trust: 20 }
            },
            'repair_reactor': {
                name: 'Oprav reaktor',
                desc: 'Jadern칳 reaktor pot콏ebuje opravu.',
                details: '驕뮖잺 P콏ines 20 kovu a 10 elektroniky.',
                requirement: { metal: 20 },
                reward: { money: 500, trust: 30, xp: 200 }
            },
            'track_beast': {
                name: 'Sleduj bestii',
                desc: 'Sleduj stopy obrovsk칠 bestie.',
                details: '游 Prozkoumej 4 lokace a najdi stopy.',
                requirement: { explore: 4 },
                reward: { money: 300, trust: 25 }
            },
            'urgent_quest': {
                name: 'Nal칠hav칳 칰kol',
                desc: 'Pot콏ebuji tvou pomoc HNED!',
                details: '丘 Spl켿 칰kol rychle - 캜asov칳 limit!',
                requirement: { kills: 3 },
                reward: { money: 400, trust: 30, item: 'rare' }
            }
        };
        
        // === SPECIALIZACE OSADY ===
        const SETTLEMENT_SPECIALIZATIONS = [
            { id: 'military', name: 'Vojensk치 pevnost', nameEn: 'Military Fortress', icon: '丘덢잺', bonus: { defense: 50, guardBonus: 25 }, requirement: { guards: 3, barracks: true }, desc: '+50 obrana, str치쬮i +25%', descEn: '+50 defense, guards +25%' },
            { id: 'trading', name: 'Obchodn칤 centrum', nameEn: 'Trading Hub', icon: '游눯', bonus: { tradeBonus: 0.25, income: 50 }, requirement: { traders: 2, market: true }, desc: '+25% ceny, +50 pen캩z/den', descEn: '+25% prices, +50 money/day' },
            { id: 'farming', name: 'Zem캩d캩lsk치 osada', nameEn: 'Farming Settlement', icon: '游', bonus: { foodBonus: 100, waterBonus: 50 }, requirement: { farmers: 3, farmland: true }, desc: 'Dvojn치sobn치 produkce j칤dla', descEn: 'Double food production' },
            { id: 'medical', name: 'L칠캜itelsk칠 st콏edisko', nameEn: 'Medical Center', icon: '游낀', bonus: { healing: 20, diseaseResist: 0.8 }, requirement: { medics: 2, infirmary: true }, desc: '+20 HP/den, -80% nemoci', descEn: '+20 HP/day, -80% disease' },
            { id: 'industrial', name: 'Pr콢myslov치 z칩na', nameEn: 'Industrial Zone', icon: '游낈', bonus: { productionBonus: 2 }, requirement: { builders: 2, workshop: true, forge: true }, desc: 'Dvojn치sobn치 produkce surovin', descEn: 'Double resource production' }
        ];
        
        // === MISE OD OSADN칈K콡 ===
        const SETTLER_QUESTS = [
            { id: 'gather_wood', name: 'Sb칤r치n칤 d콏eva', icon: '游뿻', settler: 'builder', request: { wood: 20 }, reward: { money: 100, prosperity: 5 }, desc: 'Pot콏ebuji d콏evo na opravu.' },
            { id: 'find_medicine', name: 'Najdi l칠ky', icon: '游눍', settler: 'medic_s', request: { item: 'medkit' }, reward: { money: 150, xp: 50 }, desc: 'Pot콏ebuji l칠k치rni캜ku pro pacienta.' },
            { id: 'hunt_meat', name: 'Ulov maso', icon: '游볼', settler: 'cook', request: { meat: 5 }, reward: { food: 30, prosperity: 3 }, desc: 'Pot콏ebuji maso na va콏en칤.' },
            { id: 'patrol', name: 'Hl칤dka', icon: '游녜勇', settler: 'guard', request: { action: 'explore', count: 3 }, reward: { money: 200, defense: 10 }, desc: 'Prohl칠dni okol칤 osady.' },
            { id: 'trade_mission', name: 'Obchodn칤 mise', icon: '游눺', settler: 'trader_s', request: { money: 500 }, reward: { item: 'rare', prosperity: 10 }, desc: 'Investuj do obchodu.' },
            { id: 'repair_tools', name: 'Oprava n치stroj콢', icon: '游댢', settler: 'blacksmith', request: { metal: 10 }, reward: { item: 'weapon', prosperity: 5 }, desc: 'Pot콏ebuji kov na opravu.' }
        ];
        
        
        const SKILLS = [
            { id: 'iron_stomach', name: '콯elezn칳 쬬ludek', icon: '游꼤', desc: '-20% spot콏eba hladu', maxLevel: 3, type: 'hunger_efficiency', value: 0.2 },
            { id: 'water_saver', name: '칔sporn칳 pij치k', icon: '游눦', desc: '-20% spot콏eba 쮂셬n캩', maxLevel: 3, type: 'thirst_efficiency', value: 0.2 },
            { id: 'endurance', name: 'V칳dr', icon: '丘', desc: '-20% spot콏eba energie', maxLevel: 3, type: 'energy_efficiency', value: 0.2 },
            { id: 'scavenger', name: 'Sb캩ra캜', icon: '游댌', desc: '+15% 코ance naj칤t loot', maxLevel: 5, type: 'loot_chance', value: 0.15 },
            { id: 'fast_travel', name: 'Rychl칳 pochod', icon: '游끢', desc: '-1% 캜as cestov치n칤 / level', maxLevel: 5, type: 'travel_speed', value: 0.01 },
            { id: 'rad_resistance', name: 'Odolnost radiaci', icon: '驕뮖잺', desc: '-30% zisku radiace', maxLevel: 3, type: 'radiation_resistance', value: 0.3 },
            { id: 'tough', name: 'Otrlost', icon: '游눩', desc: '+20 max HP', maxLevel: 5, type: 'max_health', value: 20 },
            { id: 'efficient', name: 'Efektivita', icon: '丘뙖잺', desc: '+25% XP ze v코ech zdroj콢', maxLevel: 3, type: 'xp_bonus', value: 0.25 },
            { id: 'lucky', name: '맚캩st칤', icon: '游', desc: '+10% kvalita lootu', maxLevel: 3, type: 'loot_quality', value: 0.1 },
            { id: 'survivor', name: 'P콏e쬴v코칤', icon: '游띠勇', desc: '+1 HP/min regenerace', maxLevel: 5, type: 'health_regen', value: 1 },
            { id: 'repair', name: 'Oprav치콏', icon: '游댢', desc: 'Oprava zbran칤 a zbroje (-50% cost)', maxLevel: 3, type: 'repair', value: 0.5 },
            { id: 'auto_consume', name: 'Pud sebez치chovy', icon: '游', desc: 'Auto-j칤/pije kdy um칤r치코', maxLevel: 1, type: 'auto_consume', value: 1 }
        ];
        
        const ENEMIES = [
            // === TIER 1 - Slab칤 (divok치 zv캩콏) === (2x HP, +defense)
            { id: 'rat', name: 'Krysa', icon: '游', hp: 80, damage: 5, defense: 3, xp: 10, loot: ['food'], chance: 0.4, minCount: 2, maxCount: 5, tier: 1, weapon: 'zuby' },
            { id: 'giant_rat', name: 'Ob콏칤 krysa', icon: '游', hp: 100, damage: 8, defense: 5, xp: 15, loot: ['food', 'cloth'], chance: 0.35, minCount: 1, maxCount: 3, tier: 1, weapon: 'tes치ky' },
            { id: 'mutant_rat', name: 'Mutantn칤 krysa', icon: '游', hp: 120, damage: 8, defense: 5, xp: 18, loot: ['food', 'cloth'], chance: 0.3, minCount: 2, maxCount: 4, tier: 1, weapon: 'tes치ky', canPoison: true },
            { id: 'wild_dog', name: 'Divok칳 pes', icon: '游냇', hp: 170, damage: 12, defense: 8, xp: 30, loot: ['food', 'cloth'], chance: 0.4, minCount: 1, maxCount: 3, tier: 1, weapon: 'dr치py' },
            { id: 'feral_cat', name: 'Zdivo캜el치 ko캜ka', icon: '游낻', hp: 140, damage: 10, defense: 7, xp: 25, loot: ['cloth'], chance: 0.35, minCount: 1, maxCount: 3, tier: 1, weapon: 'dr치py' },
            { id: 'feral', name: 'Zdivo캜el칳 캜lov캩k', icon: '游', hp: 150, damage: 11, defense: 7, xp: 28, loot: ['cloth', 'food'], chance: 0.3, minCount: 1, maxCount: 3, tier: 1, weapon: 'n콢' },
            
            // === TIER 2 - St콏edn칤 === (2x HP, +defense)
            { id: 'zombie', name: 'Zombie', icon: '游', hp: 220, damage: 12, defense: 10, xp: 35, loot: ['cloth', 'medkit'], chance: 0.3, minCount: 2, maxCount: 4, tier: 2, weapon: 'dr치py', canInfect: true },
            { id: 'raider_weak', name: 'Slab칳 n치jezdn칤k', icon: '游', hp: 180, damage: 14, defense: 12, xp: 35, loot: ['food', 'metal'], chance: 0.3, minCount: 1, maxCount: 3, tier: 2, faction: 'raiders', weapon: 'n콢' },
            { id: 'raider', name: 'N치jezdn칤k', icon: '游', hp: 190, damage: 14, defense: 14, xp: 40, loot: ['pistol', 'food', 'metal'], chance: 0.2, minCount: 1, maxCount: 3, tier: 2, faction: 'raiders', weapon: 'me캜' },
            { id: 'wolf', name: 'Mutantn칤 vlk', icon: '游냨', hp: 200, damage: 17, defense: 12, xp: 45, loot: ['food', 'fur', 'leather'], chance: 0.25, minCount: 1, maxCount: 2, tier: 2, weapon: 'tes치ky' },
            { id: 'soldier', name: 'Voj치k', icon: '游꿌勇', hp: 240, damage: 18, defense: 20, xp: 50, loot: ['ammo', 'metal', 'medkit'], chance: 0.15, minCount: 1, maxCount: 2, tier: 2, faction: 'military', weapon: 'pistole' },
            { id: 'soldier_zombie', name: 'Zombie voj치k', icon: '游꿌勇', hp: 260, damage: 16, defense: 18, xp: 48, loot: ['ammo', 'metal'], chance: 0.15, minCount: 1, maxCount: 3, tier: 2, weapon: 'p치lka', canInfect: true },
            { id: 'turret', name: 'St콏eleck치 v캩', icon: '游댦', hp: 180, damage: 25, defense: 30, xp: 55, loot: ['metal', 'electronics', 'ammo'], chance: 0.1, minCount: 1, maxCount: 1, tier: 2, weapon: 'laser' },
            { id: 'cave_spider', name: 'Jeskynn칤 pavouk', icon: '游동勇', hp: 170, damage: 15, defense: 8, xp: 35, loot: ['cloth', 'poison'], chance: 0.2, minCount: 2, maxCount: 4, tier: 2, weapon: 'tes치ky', canPoison: true },
            { id: 'ghost', name: 'P콏칤zrak', icon: '游놑', hp: 150, damage: 15, defense: 0, xp: 40, loot: ['crystal'], chance: 0.1, minCount: 1, maxCount: 2, tier: 2, canConfuse: true },
            { id: 'mutant_dog', name: 'Mutantn칤 pes', icon: '游냇', hp: 170, damage: 14, defense: 10, xp: 38, loot: ['food', 'mutant_blood'], chance: 0.2, minCount: 1, maxCount: 3, tier: 2, weapon: 'dr치py' },
            { id: 'mutant_frog', name: 'Mutantn칤 쮂멱a', icon: '游냦', hp: 140, damage: 10, defense: 8, xp: 32, loot: ['food', 'poison'], chance: 0.25, minCount: 2, maxCount: 4, tier: 2, canPoison: true },
            { id: 'zombie_cop', name: 'Zombie policista', icon: '游놅', hp: 230, damage: 14, defense: 16, xp: 42, loot: ['ammo', 'pistol'], chance: 0.15, minCount: 1, maxCount: 2, tier: 2, weapon: 'p치lka', canInfect: true },
            { id: 'mutant_fish', name: 'Mutantn칤 ryba', icon: '游', hp: 150, damage: 12, defense: 10, xp: 35, loot: ['food', 'mutant_blood'], chance: 0.2, minCount: 2, maxCount: 4, tier: 2 },
            
            // === TIER 3 - Siln칤 ===
            { id: 'mutant', name: 'Mutant', icon: '游놏', hp: 145, damage: 18, defense: 12, xp: 60, loot: ['metal', 'radx'], chance: 0.2, minCount: 1, maxCount: 1, tier: 3, faction: 'mutants', weapon: 'dr치py', canStun: true },
            { id: 'bandit', name: 'Bandita', icon: '游댦', hp: 130, damage: 22, defense: 14, xp: 55, loot: ['rifle', 'food', 'money'], chance: 0.3, minCount: 1, maxCount: 1, tier: 3, faction: 'raiders', weapon: 'pistole' },
            { id: 'ghoul', name: 'Gh칰l', icon: '游놑', hp: 160, damage: 19, defense: 10, xp: 65, loot: ['radx', 'stimpack'], chance: 0.15, minCount: 1, maxCount: 2, tier: 3, faction: 'mutants', weapon: 'dr치py', canInfect: true },
            { id: 'raider_boss', name: 'V콢dce n치jezdn칤k콢', icon: '驕멆잺', hp: 180, damage: 24, defense: 16, xp: 80, loot: ['shotgun', 'vest', 'money'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3, faction: 'raiders', weapon: 'me캜' },
            { id: 'robot', name: 'Bojov칳 robot', icon: '游뱄', hp: 220, damage: 28, defense: 25, xp: 90, loot: ['electronics', 'metal', 'ammo'], chance: 0.08, minCount: 1, maxCount: 1, tier: 3, weapon: 'laser', canStun: true },
            { id: 'slaver', name: 'Otrok치콏', icon: '久勇', hp: 135, damage: 20, defense: 12, xp: 70, loot: ['weapon', 'money', 'metal'], chance: 0.15, minCount: 1, maxCount: 2, tier: 3, faction: 'raiders', weapon: 'p치lka', canStun: true },
            { id: 'experiment', name: 'Experiment', icon: '游빏', hp: 150, damage: 22, defense: 8, xp: 75, loot: ['chemicals', 'mutant_blood'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3, canPoison: true, canConfuse: true },
            { id: 'swamp_creature', name: 'Ba쬴nn치 p콏칤코era', icon: '游낽', hp: 165, damage: 20, defense: 14, xp: 72, loot: ['food', 'leather'], chance: 0.12, minCount: 1, maxCount: 1, tier: 3, weapon: 'tes치ky', canPoison: true },
            { id: 'ice_mutant', name: 'Ledov칳 mutant', icon: '游봈', hp: 160, damage: 21, defense: 16, xp: 78, loot: ['crystal', 'radx'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3, canStun: true },
            { id: 'toxic_zombie', name: 'Toxick칳 zombie', icon: '驕勇', hp: 145, damage: 18, defense: 8, xp: 68, loot: ['chemicals', 'radx'], chance: 0.12, minCount: 1, maxCount: 2, tier: 3, canPoison: true, canInfect: true },
            { id: 'electric_mutant', name: 'Elektrick칳 mutant', icon: '丘', hp: 150, damage: 24, defense: 10, xp: 80, loot: ['electronics', 'copper'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3, weapon: 'elekt콏ina', canStun: true },
            
            // === TIER 4 - Bossov칠 === (+50% HP, +defense)
            { id: 'slaver_boss', name: 'V콢dce otrok치콏콢', icon: '久勇', hp: 240, damage: 28, defense: 18, xp: 120, loot: ['rare_weapon', 'money', 'armor'], chance: 0.05, minCount: 1, maxCount: 1, tier: 4, isBoss: true, weapon: 'kladivo', canStun: true },
            { id: 'giant_mutant', name: 'Ob콏칤 Mutant', icon: '游', hp: 360, damage: 36, defense: 20, xp: 200, loot: ['sniper', 'armor_heavy', 'radaway'], chance: 0.03, minCount: 1, maxCount: 1, tier: 4, isBoss: true, faction: 'mutants', canStun: true },
            { id: 'alpha_wolf', name: 'Alfa Vlk', icon: '游냨', hp: 270, damage: 30, defense: 16, xp: 150, loot: ['meat', 'fur', 'leather', 'stimpack'], chance: 0.04, minCount: 1, maxCount: 1, tier: 4, isBoss: true, weapon: 'tes치ky' },
            { id: 'zombie_hulk', name: 'Zombie Hulk', icon: '游', hp: 450, damage: 42, defense: 15, xp: 250, loot: ['stimpack', 'radx', 'armor_heavy'], chance: 0.02, minCount: 1, maxCount: 1, tier: 4, isBoss: true, canStun: true, canInfect: true },
            { id: 'elite_robot', name: 'Elitn칤 robot', icon: '游뱄', hp: 500, damage: 45, defense: 40, xp: 350, loot: ['electronics', 'legendary_weapon', 'ai_chip'], chance: 0.01, minCount: 1, maxCount: 1, tier: 4, isBoss: true, weapon: 'laser', canStun: true },
            { id: 'toxic_beast', name: 'Toxick치 bestie', icon: '驕勇', hp: 330, damage: 32, defense: 16, xp: 180, loot: ['chemicals', 'mutant_blood', 'rare_armor'], chance: 0.03, minCount: 1, maxCount: 1, tier: 4, isBoss: true, canPoison: true },
            { id: 'acid_beast', name: 'Kyselinov치 bestie', icon: '游빍', hp: 300, damage: 35, defense: 12, xp: 170, loot: ['chemicals', 'acid'], chance: 0.03, minCount: 1, maxCount: 1, tier: 4, isBoss: true, canPoison: true, canBurn: true },
            { id: 'swamp_beast', name: 'Ba쬴nn치 bestie', icon: '游낽', hp: 375, damage: 38, defense: 18, xp: 190, loot: ['food', 'leather', 'rare_item'], chance: 0.02, minCount: 1, maxCount: 1, tier: 4, isBoss: true, weapon: 'tes치ky', canPoison: true },
            { id: 'glowing_ghoul', name: 'Z치콏칤c칤 gh칰l', icon: '游놑', hp: 270, damage: 30, defense: 12, xp: 160, loot: ['radaway', 'radx'], chance: 0.02, minCount: 1, maxCount: 1, tier: 4, radiation: 15, canBurn: true },
            { id: 'mutant_brute', name: 'Mutant Brutus', icon: '游놏', hp: 480, damage: 45, defense: 22, xp: 300, loot: ['rare_weapon', 'mutant_blood'], chance: 0.01, minCount: 1, maxCount: 1, tier: 4, isBoss: true, canStun: true },
            
            // === TIER 5 - Legend치rn칤 === (+50% HP, +defense)
            { id: 'glowing_one', name: 'Z치콏칤c칤', icon: '驕뮖잺', hp: 420, damage: 40, defense: 15, xp: 280, loot: ['radaway', 'legendary_item', 'crystal'], chance: 0.01, minCount: 1, maxCount: 1, tier: 5, isBoss: true, radiation: 20, canBurn: true },
            { id: 'irradiated_beast', name: 'Oz치콏en치 bestie', icon: '驕뮖잺', hp: 390, damage: 38, defense: 16, xp: 220, loot: ['radaway', 'mutant_blood', 'crystal'], chance: 0.02, minCount: 1, maxCount: 1, tier: 5, isBoss: true, radiation: 18, canBurn: true },
            { id: 'mutant_behemoth', name: 'Mutant Behemoth', icon: '游놏', hp: 750, damage: 55, defense: 32, xp: 500, loot: ['legendary_weapon', 'legendary_armor', 'mutant_heart'], chance: 0.005, minCount: 1, maxCount: 1, tier: 5, isBoss: true, canStun: true },
            { id: 'deathclaw', name: 'Deathclaw', icon: '游붔', hp: 680, damage: 60, defense: 28, xp: 450, loot: ['deathclaw_hand', 'legendary_item'], chance: 0.005, minCount: 1, maxCount: 1, tier: 5, isBoss: true, weapon: 'dr치py' },
            { id: 'mutant_giant', name: 'Mutant칤 obr', icon: '游', hp: 600, damage: 50, defense: 28, xp: 400, loot: ['legendary_weapon', 'mutant_blood'], chance: 0.008, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            { id: 'mutant_queen', name: 'Mutant칤 kr치lovna', icon: '游녬', hp: 820, damage: 48, defense: 35, xp: 600, loot: ['legendary_weapon', 'legendary_armor', 'queen_crown'], chance: 0.003, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            { id: 'ai_guardian', name: 'AI Str치쬮e', icon: '游띠勇', hp: 570, damage: 42, defense: 45, xp: 380, loot: ['electronics', 'ai_chip', 'legendary_item'], chance: 0.008, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            
            // === TAJN칗 TREZOR - Speci치ln칤 nep콏치tel칠 === (+50% HP)
            { id: 'sentinel', name: 'Str치쬹칳 sentinel', icon: '游', hp: 300, damage: 35, defense: 32, xp: 200, loot: ['electronics', 'crystal', 'gold', 'gems'], chance: 0.05, minCount: 1, maxCount: 1, tier: 4 },
            { id: 'ancient_guardian', name: 'Prastar칳 str치쬮e', icon: '丘덢잺', hp: 525, damage: 48, defense: 38, xp: 400, loot: ['legendary_item', 'crystal', 'gold', 'gems'], chance: 0.02, minCount: 1, maxCount: 1, tier: 5, isBoss: true }
        ];
        
        const CRAFTING = [
            // === ZBRAN캨 - Z치kladn칤 (portable = lze vyrobit na cest캩) ===
            { id: 'spear', name: 'Kop칤', icon: '游댬', result: { type: 'weapon', damage: 15, rarity: 'common' }, requires: { wood: 3, metal: 2 }, category: 'weapon', portable: true },
            { id: 'bow', name: 'Luk', icon: '游낓', result: { type: 'weapon', damage: 18, ammoType: 'arrow', rarity: 'common' }, requires: { wood: 5, cloth: 3 }, category: 'weapon', portable: true },
            { id: 'machete', name: 'Ma캜eta', icon: '游디勇', result: { type: 'weapon', damage: 18, rarity: 'common' }, requires: { metal: 4, cloth: 1 }, category: 'weapon', portable: true },
            { id: 'club', name: 'Kyj', icon: '游끮', result: { type: 'weapon', damage: 12, rarity: 'common' }, requires: { wood: 4 }, category: 'weapon', portable: true },
            
            // === ZBRAN캨 - Pokro캜il칠 (vy쬬duj칤 d칤lnu) ===
            { id: 'crossbow', name: 'Ku코e', icon: '游낓', result: { type: 'weapon', damage: 22, ammoType: 'bolt', rarity: 'uncommon' }, requires: { wood: 6, metal: 4, rope: 2 }, category: 'weapon', portable: false },
            { id: 'hammer', name: 'V치le캜n칠 kladivo', icon: '游댣', result: { type: 'weapon', damage: 20, rarity: 'uncommon' }, requires: { metal: 5, wood: 3, leather: 1 }, category: 'weapon', portable: false },
            { id: 'axe', name: 'Bojov치 sekera', icon: '游뿝', result: { type: 'weapon', damage: 24, rarity: 'uncommon' }, requires: { metal: 6, wood: 4 }, category: 'weapon', portable: false },
            { id: 'sword', name: 'Me캜', icon: '丘덢잺', result: { type: 'weapon', damage: 26, rarity: 'uncommon' }, requires: { metal: 8, leather: 2 }, category: 'weapon', portable: false },
            { id: 'serrated_blade', name: 'Zubat치 캜epel', icon: '游댥', result: { type: 'weapon', damage: 18, special: 'bleed', rarity: 'uncommon' }, requires: { metal: 5, scrap: 3 }, category: 'weapon', portable: false },
            { id: 'barbed_club', name: 'Ostnat칳 kyj', icon: '游끮', result: { type: 'weapon', damage: 16, special: 'bleed', rarity: 'uncommon' }, requires: { wood: 4, metal: 3, scrap: 2 }, category: 'weapon', portable: true },
            
            // === ZBRAN캨 - St콏eln칠 (v코echny vy쬬duj칤 d칤lnu) ===
            { id: 'slingshot', name: 'Prak', icon: '游꿢', result: { type: 'weapon', damage: 10, rarity: 'common' }, requires: { wood: 2, leather: 1 }, category: 'weapon', portable: true },
            { id: 'throwing_knives', name: 'Vrhac칤 no쬰', icon: '游디勇', result: { type: 'weapon', damage: 16, rarity: 'common' }, requires: { metal: 4 }, category: 'weapon', portable: false },
            { id: 'pipe_rifle', name: 'Trubkov치 pu코ka', icon: '游댦', result: { type: 'weapon', damage: 30, ammoType: '9mm', rarity: 'uncommon' }, requires: { metal: 8, scrap: 5, gunpowder: 3 }, category: 'weapon', portable: false },
            { id: 'pipe_shotgun', name: 'Trubkov치 brokovnice', icon: '游댦', result: { type: 'weapon', damage: 35, ammoType: 'shell', rarity: 'uncommon' }, requires: { metal: 10, scrap: 6, gunpowder: 4 }, category: 'weapon', portable: false },
            { id: 'pipe_pistol', name: 'Improvizovan치 pistole', icon: '游댦', result: { type: 'weapon', damage: 22, ammoType: '9mm', rarity: 'uncommon' }, requires: { metal: 6, scrap: 4, gunpowder: 2 }, category: 'weapon', portable: false },
            
            // === VYLEPEN칈 ZBRAN칈 ===
            { id: 'weapon_poison', name: 'Jed na zbra켿', icon: '游빍', result: { type: 'weapon_coating', effect: 'poison', uses: 5, desc: 'Otr치v칤코 zbra켿 na 5 boj콢' }, requires: { herbs: 4, chemicals: 3 }, category: 'special', portable: false },
            { id: 'weapon_fire', name: 'Z치paln치 pasta', icon: '游댠', result: { type: 'weapon_coating', effect: 'fire', uses: 5, desc: 'Zbra켿 ho콏칤 5 boj콢' }, requires: { fuel: 2, chemicals: 2, cloth: 1 }, category: 'special', portable: true },
            
            // === ZBROJE ===
            { id: 'leather_armor', name: 'Ko쬰n치 zbroj', icon: '游붴', result: { type: 'armor', defense: 16, rarity: 'common' }, requires: { leather: 6, rope: 2 }, category: 'armor', portable: true },
            { id: 'light_armor', name: 'Lehk치 zbroj', icon: '游띠勇', result: { type: 'armor', defense: 20, rarity: 'uncommon' }, requires: { metal: 5, leather: 3, cloth: 2 }, category: 'armor', portable: false },
            { id: 'gas_mask', name: 'Plynov치 maska', icon: '游땽', result: { type: 'helmet', defense: 6, special: 'gas_filter', rarity: 'uncommon' }, requires: { glass: 2, cloth: 3, chemicals: 1 }, category: 'armor', portable: false },
            { id: 'helmet', name: 'Helma', icon: '游뿠', result: { type: 'helmet', defense: 10, rarity: 'common' }, requires: { metal: 4, leather: 1 }, category: 'armor', portable: false },
            
            // === POKRO캛IL칄 ZBROJE (max uncommon) ===
            { id: 'arm_guards', name: 'Chr치ni캜e rukou', icon: '游볡', result: { type: 'gloves', defense: 6, special: 'block_bonus', rarity: 'uncommon' }, requires: { leather: 4, metal: 3 }, category: 'armor', portable: false },
            { id: 'leg_guards', name: 'Chr치ni캜e nohou', icon: '游', result: { type: 'boots', defense: 6, special: 'dodge_bonus', rarity: 'uncommon' }, requires: { leather: 4, metal: 3 }, category: 'armor', portable: false },
            { id: 'leather_gloves', name: 'Ko쬰n칠 rukavice', icon: '游빇', result: { type: 'gloves', defense: 4, rarity: 'common' }, requires: { leather: 3, cloth: 1 }, category: 'armor', portable: true },
            { id: 'spiked_gloves', name: 'Ostnat칠 rukavice', icon: '游볡', result: { type: 'gloves', defense: 6, special: 'bleed_punch', rarity: 'uncommon' }, requires: { leather: 3, metal: 4, scrap: 2 }, category: 'armor', portable: false },
            { id: 'hiking_boots', name: 'Turistick칠 boty', icon: '游', result: { type: 'boots', defense: 3, special: 'speed_bonus', rarity: 'common' }, requires: { leather: 4, cloth: 2 }, category: 'armor', portable: true },
            { id: 'winter_boots', name: 'Zimn칤 boty', icon: '仇勇', result: { type: 'boots', defense: 5, special: 'warm_feet', rarity: 'uncommon' }, requires: { leather: 4, cloth: 4, fur: 2 }, category: 'armor', portable: false },
            
            // === T칈TY ===
            { id: 'wooden_shield', name: 'D콏ev캩n칳 코t칤t', icon: '游뿻', result: { type: 'armor', defense: 16, special: 'block', rarity: 'common' }, requires: { wood: 8, leather: 2 }, category: 'armor', portable: true },
            { id: 'metal_shield', name: 'Kovov칳 코t칤t', icon: '游띠勇', result: { type: 'armor', defense: 22, special: 'block', rarity: 'uncommon' }, requires: { metal: 8, wood: 3, leather: 2 }, category: 'armor', portable: false },
            
            // === B캨콯N칄 ZBROJE ===
            { id: 'chainmail', name: 'Krou쬶ov치 zbroj', icon: '久勇', result: { type: 'armor', defense: 18, rarity: 'uncommon' }, requires: { metal: 12, leather: 2 }, category: 'armor', portable: false },
            { id: 'biker_jacket', name: 'Motork치콏sk치 bunda', icon: '游빈', result: { type: 'armor', defense: 14, rarity: 'uncommon' }, requires: { leather: 6, metal: 2, cloth: 2 }, category: 'armor', portable: false },
            { id: 'padded_jacket', name: 'Vycpan치 bunda', icon: '游빈', result: { type: 'armor', defense: 10, rarity: 'uncommon' }, requires: { cloth: 6, leather: 2 }, category: 'armor', portable: true },
            
            // === L칄캛IVA (v캩t코ina portable) ===
            { id: 'bandage', name: 'Obvaz', icon: '游뽗', result: { type: 'consumable', effect: 'heal_injury', healsInjuries: ['bruise', 'cut', 'sprain', 'burn'], value: 15, desc: 'L칠캜칤 15 HP a men코칤 zran캩n칤.' }, requires: { cloth: 2 }, category: 'medical', portable: true },
            { id: 'splint', name: 'Dlaha', icon: '游붮', result: { type: 'consumable', effect: 'heal_injury', healsInjuries: ['fracture', 'sprain'], desc: 'Fixuje zlomeniny a v칳rony.' }, requires: { wood: 3, cloth: 2 }, category: 'medical', portable: true },
            { id: 'burn_cream', name: 'Mast na pop치leniny', icon: '游빖', result: { type: 'consumable', effect: 'heal_injury', healsInjuries: ['burn'], value: 10, desc: 'L칠캜칤 pop치leniny.' }, requires: { herbs: 3, chemicals: 1 }, category: 'medical', portable: true },
            { id: 'painkillers', name: 'L칠ky proti bolesti', icon: '游눍', result: { type: 'consumable', effect: 'heal_injury', healsInjuries: ['bruise', 'concussion', 'exhaustion'], desc: 'Zm칤r켿uje bolest a 칰navu.' }, requires: { herbs: 2, chemicals: 2 }, category: 'medical', portable: true },
            { id: 'herbal_tea', name: 'Bylinn칳 캜aj', icon: '游꼿', result: { type: 'consumable', effect: 'cure_disease', cures: ['cold', 'food_poisoning'], desc: 'L칠캜칤 nachlazen칤 a otravu j칤dlem.' }, requires: { herbs: 2, wood: 1 }, category: 'medical', portable: true },
            { id: 'herbal_medicine', name: 'Bylinn칳 l칠k', icon: '游', result: { type: 'consumable', effect: 'health', value: 30, cures: ['infection', 'food_poisoning'], desc: 'L칠캜칤 30 HP, infekci a otravu.' }, requires: { herbs: 3 }, category: 'medical', portable: true },
            { id: 'medkit_craft', name: 'L칠k치rni캜ka', icon: '丘됊잺', result: { type: 'consumable', effect: 'health', value: 40, cures: ['cold', 'flu', 'infection'], desc: 'L칠캜칤 40 HP a v캩t코inu nemoc칤.' }, requires: { cloth: 3, herbs: 2, chemicals: 1 }, category: 'medical', portable: false },
            { id: 'stimpack_craft', name: 'Stimpak', icon: '游눌', result: { type: 'consumable', effect: 'health', value: 60 }, requires: { chemicals: 3, glass: 1, herbs: 2 }, category: 'medical', portable: false },
            { id: 'antidote', name: 'Antidotum', icon: '游눍', result: { type: 'consumable', effect: 'radiation', value: -30 }, requires: { herbs: 4, chemicals: 2 }, category: 'medical', portable: true },
            { id: 'super_stim', name: 'Super Stimpak', icon: '游눌', result: { type: 'consumable', effect: 'health', value: 100 }, requires: { chemicals: 6, herbs: 3, glass: 2 }, category: 'medical', portable: false },
            { id: 'rad_x', name: 'Rad-X', icon: '驕뮖잺', result: { type: 'consumable', effect: 'rad_resist', value: 50 }, requires: { chemicals: 4, herbs: 2 }, category: 'medical', portable: false },
            
            // === J칈DLO & PIT칈 (v캩t코ina portable - va콏en칤 u t치bor치ku) ===
            { id: 'water_filter', name: '캛ist치 voda', icon: '游눑', result: { type: 'consumable', effect: 'thirst', value: 60 }, requires: { glass: 1, cloth: 1, stone: 2 }, category: 'food', portable: false },
            { id: 'cooked_meat', name: 'Pe캜en칠 maso', icon: '游꼤', result: { type: 'consumable', effect: 'hunger', value: 50 }, requires: { raw_meat: 1, wood: 1 }, category: 'food', portable: true },
            { id: 'grilled_fish', name: 'Grilovan치 ryba', icon: '游', result: { type: 'consumable', effect: 'hunger', value: 45, secondary: { thirst: 10 } }, requires: { fish: 1, wood: 1 }, category: 'food', portable: true },
            { id: 'steak', name: 'Steak', icon: '游볼', result: { type: 'consumable', effect: 'hunger', value: 60, secondary: { hp: 20 } }, requires: { raw_meat: 2, wood: 1 }, category: 'food', portable: true },
            { id: 'stew', name: 'Gul치코', icon: '游', result: { type: 'consumable', effect: 'hunger', value: 100, secondary: { hp: 65, energy: 10 } }, requires: { raw_meat: 4, herbs: 2, wood: 2 }, category: 'food', portable: true },
            { id: 'energy_drink', name: 'Energetick칳 n치poj', icon: '游댊', result: { type: 'consumable', effect: 'energy', value: 50 }, requires: { chemicals: 2, glass: 1 }, category: 'food', portable: false },
            { id: 'coffee_brew', name: 'Siln치 k치va', icon: '驕', result: { type: 'consumable', effect: 'energy', value: 40 }, requires: { herbs: 2, wood: 1 }, category: 'food', portable: true },
            { id: 'mutant_steak', name: 'Mutant칤 steak', icon: '游꼤', result: { type: 'consumable', effect: 'hunger', value: 90, secondary: { hp: 25, energy: 20 } }, requires: { leather: 2, herbs: 3 }, category: 'food', portable: true, rarity: 'uncommon' },
            
            // === N츼STROJE ===
            { id: 'trap', name: 'Past na zv캩콏', icon: '游돚勇', result: { type: 'tool', bonus: 'food', desc: '+2 j칤dla/den pro osadu (max 2 pasti, dr v invent치콏i)' }, requires: { wood: 4, metal: 3, rope: 2 }, category: 'tool', portable: true },
            { id: 'backpack', name: 'Batoh', icon: '游', result: { type: 'tool', bonus: 'capacity', desc: '+10 kapacita invent치콏e' }, requires: { leather: 5, cloth: 4, rope: 2 }, category: 'tool', portable: true },
            { id: 'binoculars', name: 'Dalekohled', icon: '游댨', result: { type: 'tool', bonus: 'vision', desc: 'V캩t코칤 viditelnost mapy' }, requires: { glass: 4, metal: 2, leather: 1 }, category: 'tool', portable: false },
            { id: 'compass', name: 'Kompas', icon: '游빐', result: { type: 'tool', bonus: 'navigation', desc: 'Rychlej코칤 cestov치n칤' }, requires: { metal: 3, glass: 1 }, category: 'tool', portable: false },
            { id: 'fishing_rod', name: 'Ryb치콏sk칳 prut', icon: '游꿖', result: { type: 'tool', bonus: 'fishing', bonusValue: 1, weight: 1, desc: 'Pro ryba콏en칤', rarity: 'common' }, requires: { wood: 4, rope: 3 }, category: 'tool', portable: true },
            { id: 'fishing_rod_rare', name: 'Profesion치ln칤 prut', icon: '游꿖', result: { type: 'tool', bonus: 'fishing', bonusValue: 3, weight: 1, desc: 'Lep코칤 칰lovky (+100%)', rarity: 'rare' }, requires: { wood: 8, rope: 5, metal: 3 }, category: 'tool', portable: false },
            { id: 'fishing_rod_epic', name: 'Mistrovsk칳 prut', icon: '游꿖', result: { type: 'tool', bonus: 'fishing', bonusValue: 4, weight: 1, desc: 'V칳jime캜n칠 칰lovky (+150%)', rarity: 'epic' }, requires: { wood: 12, rope: 8, metal: 5, leather: 3 }, category: 'tool', portable: false },
            { id: 'pickaxe', name: 'Krump치캜', icon: '久勇', result: { type: 'tool', bonus: 'mining', desc: 'Pro t캩쬭u' }, requires: { metal: 5, wood: 3 }, category: 'tool', portable: false },
            { id: 'cooking_pot', name: 'Hrnec', icon: '游꼽', result: { type: 'tool', bonus: 'cooking', desc: 'Pro va콏en칤 j칤dla' }, requires: { metal: 4, wood: 1 }, category: 'tool', portable: true },
            { id: 'alchemy_set', name: 'Alchymistick치 sada', icon: '丘勇', result: { type: 'tool', bonus: 'alchemy', desc: 'Pro v칳robu lektvar콢' }, requires: { glass: 3, metal: 2, herbs: 1 }, category: 'tool', portable: false },
            { id: 'geiger_counter', name: 'Geiger콢v po캜칤ta캜', icon: '驕뮖잺', result: { type: 'tool', bonus: 'radiation', desc: 'Zobrazuje radiaci' }, requires: { electronics: 4, copper: 3, glass: 2 }, category: 'tool', portable: false },
            
            // === MUNICE & BOMBY ===
            // === ST콎ELIVO (portable = jednoduch칠, false = slo쬴t칠) ===
            { id: 'craft_gunpowder', name: 'St콏eln칳 prach (5x)', icon: '游눤', result: { type: 'resource', resource: 'gunpowder', amount: 5 }, requires: { chemicals: 3, wood: 2 }, category: 'ammo', portable: false },
            { id: 'craft_arrows', name: '먞셣y (15x)', icon: '俱', result: { type: 'ammo', itemId: 'ammo_arrow', count: 15 }, requires: { wood: 2 }, category: 'ammo', portable: true },
            { id: 'craft_bolts', name: '말pky do ku코e (10x)', icon: '游댤', result: { type: 'ammo', itemId: 'ammo_bolt', count: 10 }, requires: { wood: 1, metal: 1 }, category: 'ammo', portable: true },
            { id: 'craft_9mm', name: 'N치boje 9mm (15x)', icon: '游댲', result: { type: 'ammo', itemId: 'ammo_9mm', count: 15 }, requires: { metal: 2 }, category: 'ammo', portable: false },
            { id: 'craft_556', name: 'N치boje 5.56 (10x)', icon: '游댰', result: { type: 'ammo', itemId: 'ammo_556', count: 10 }, requires: { metal: 2, copper: 1 }, category: 'ammo', portable: false },
            { id: 'craft_762', name: 'N치boje 7.62 (8x)', icon: '游댱', result: { type: 'ammo', itemId: 'ammo_762', count: 8 }, requires: { metal: 3, copper: 1 }, category: 'ammo', portable: false },
            { id: 'craft_shells', name: 'Brokov칠 n치boje (8x)', icon: '游댮', result: { type: 'ammo', itemId: 'ammo_shell', count: 8 }, requires: { metal: 2, scrap: 1 }, category: 'ammo', portable: false },
            { id: 'poison_arrows', name: 'Otr치ven칠 코칤py (5x)', icon: '驕멆잺', result: { type: 'ammo', itemId: 'ammo_arrow', count: 5, special: 'poison' }, requires: { wood: 1, herbs: 2 }, category: 'ammo', portable: true },
            { id: 'molotov', name: 'Molotov', icon: '游댠', result: { type: 'throwable', damage: 30, aoe: true }, requires: { glass: 1, cloth: 1, fuel: 1 }, category: 'ammo', portable: true },
            { id: 'smoke_bomb', name: 'D칳movnice', icon: '游눧', result: { type: 'throwable', effect: 'escape' }, requires: { chemicals: 2, cloth: 1 }, category: 'ammo', portable: true },
            { id: 'grenade', name: 'Gran치t', icon: '游눢', result: { type: 'throwable', damage: 50, aoe: true }, requires: { metal: 3, chemicals: 2 }, category: 'ammo', portable: false },
            { id: 'acid_bomb', name: 'Kyselinov치 bomba', icon: '游릭', result: { type: 'throwable', damage: 40, special: 'acid' }, requires: { acid: 2, glass: 1 }, category: 'ammo', portable: false },
            { id: 'emp_grenade', name: 'EMP gran치t', icon: '丘', result: { type: 'throwable', damage: 20, special: 'emp' }, requires: { electronics: 3, copper: 2 }, category: 'ammo', portable: false },
            
            // === SPECI츼LN칈 (v캩t코ina vy쬬duje d칤lnu) ===
            { id: 'torch', name: 'Pochode켿', icon: '游댠', result: { type: 'tool', bonus: 'light', desc: 'Sv캩tlo v noci' }, requires: { wood: 2, cloth: 1, fuel: 1 }, category: 'special', portable: true },
            { id: 'repair_kit', name: 'Opravn치 sada', icon: '游댢', result: { type: 'consumable', effect: 'repair', value: 50 }, requires: { metal: 3, scrap: 4, cloth: 1 }, category: 'special', portable: false },
            { id: 'sleeping_bag', name: 'Spac치k', icon: '游띒勇', result: { type: 'tool', effect: 'sleep', value: 1, stackable: false }, requires: { cloth: 8, leather: 2 }, category: 'special', portable: true },
            { id: 'camouflage', name: 'Maskovac칤 pl치코콘', icon: '游봉', result: { type: 'tool', bonus: 'stealth', desc: '-30% 코ance na p콏epaden칤' }, requires: { cloth: 8, leather: 4, herbs: 3 }, category: 'special', portable: false },
            { id: 'water_purifier', name: '캛isti캜ka vody', icon: '游눦', result: { type: 'tool', bonus: 'water', desc: 'Pasivn캩 캜ist칤 vodu' }, requires: { glass: 4, chemicals: 3, metal: 4 }, category: 'special', portable: false },
            { id: 'solar_panel', name: 'Sol치rn칤 panel', icon: '驕勇', result: { type: 'tool', bonus: 'power', desc: 'Energie pro z치kladnu' }, requires: { electronics: 6, glass: 4, copper: 4 }, category: 'special', portable: false },
            { id: 'radio_transmitter', name: 'Vys칤la캜ka', icon: '游니', result: { type: 'tool', bonus: 'signal', desc: 'P콏ivol치 obchodn칤ky' }, requires: { electronics: 5, copper: 4, metal: 3 }, category: 'special', portable: false },
            
            // === LUXUSN칈 P콎EDM캨TY (v코echny vy쬬duj칤 d칤lnu) ===
            { id: 'silver_ring', name: 'St콏칤brn칳 prsten', icon: '游눐', result: { type: 'accessory', bonus: 'luck', value: 10, desc: '+10% 코ance na loot' }, requires: { silver: 3, glass: 1 }, category: 'special', portable: false },
            { id: 'golden_amulet', name: 'Zlat칳 amulet', icon: '游', result: { type: 'accessory', bonus: 'xp', value: 15, desc: '+15% XP ze v코eho' }, requires: { gold: 2, electronics: 2, leather: 1 }, category: 'special', portable: false },
            { id: 'crystal_focus', name: 'Krystalov칳 zam캩콏ova캜', icon: '游댩', result: { type: 'accessory', bonus: 'crit', value: 15, desc: '+15% kritick칳 z치sah' }, requires: { crystal: 2, electronics: 2 }, category: 'special', portable: false },
            { id: 'gem_pendant', name: 'Drahokamov칳 p콏칤v캩sek', icon: '游눑', result: { type: 'accessory', bonus: 'defense', value: 15, desc: '+15 obrana' }, requires: { gems: 2, gold: 1, leather: 1 }, category: 'special', portable: false },
            { id: 'gem_ring', name: 'Drahokamov칳 prsten', icon: '游눐', result: { type: 'accessory', bonus: 'luck', value: 10, desc: '+10% 코ance na vz치cn칳 loot' }, requires: { gems: 1, silver: 1 }, category: 'special', portable: false },
            
            // === LEGEND츼RN칈 P콎EDM캨TY (z trofej칤) - vy쬬duje skill Legend치rn칤 kov치콏 ===
            { id: 'deathclaw_gauntlet', name: 'Rukavice Deathclawa', icon: '游붔', result: { type: 'weapon', damage: 55, rarity: 'legendary', special: 'bleed', critBonus: 15, desc: '+15% krit, zp콢sobuje krv치cen칤' }, requires: { deathclaw_hand: 1, metal: 10, leather: 5 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'legendary_blade', name: 'Legend치rn칤 캜epel', icon: '游디勇', result: { type: 'weapon', damage: 48, rarity: 'legendary', critChance: 0.15, desc: 'Mistrovsk칳 me캜 s +15% krit' }, requires: { metal: 80, scrap: 30, gems: 1 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'legendary_rifle', name: 'Legend치rn칤 pu코ka', icon: '游댦', result: { type: 'weapon', damage: 52, rarity: 'legendary', ammoType: '556', accuracy: 0.95, desc: '95% p콏esnost, devastuj칤c칤 damage' }, requires: { metal: 60, electronics: 15, scrap: 40 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'legendary_armor', name: 'Legend치rn칤 zbroj', icon: '游띠勇', result: { type: 'armor', defense: 45, rarity: 'legendary', hp: 30, desc: '+30 max HP, vysok치 obrana' }, requires: { metal: 100, leather: 20, chemicals: 10 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'mutant_heart_amulet', name: 'Amulet mutant칤ho srdce', icon: '游눞', result: { type: 'accessory', rarity: 'legendary', bonus: 'hp_regen', value: 3, desc: '+3 HP/min regenerace' }, requires: { mutant_heart: 1, gold: 2, gems: 1 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'crystal_blade', name: 'Krystalov치 캜epel', icon: '游', result: { type: 'weapon', damage: 42, rarity: 'epic', special: 'energy', desc: 'Energetick칳 damage ignoruje 25% zbroje' }, requires: { crystal: 5, metal: 20, electronics: 5 }, category: 'legendary', portable: false, legendaryRequired: true },
            
            // === KAMENN칄 P콎EDM캨TY ===
            { id: 'stone_wall', name: 'Kamenn치 ze캞', icon: '游빔', result: { type: 'defense', bonus: 'base_defense', value: 20, desc: '+20 obrana osady' }, requires: { stone: 15, wood: 5 }, category: 'special', portable: false },
            { id: 'stone_axe', name: 'Kamenn치 sekera', icon: '游뿝', result: { type: 'weapon', damage: 10, rarity: 'common' }, requires: { stone: 4, wood: 2 }, category: 'weapon', portable: true },
            { id: 'grindstone', name: 'Brus', icon: '丘뙖잺', result: { type: 'tool', bonus: 'sharpen', desc: '+5 damage zbran칤 do캜asn캩' }, requires: { stone: 6, metal: 2 }, category: 'tool', portable: false },
            { id: 'stone_furnace', name: 'Kamenn치 pec', icon: '游댠', result: { type: 'tool', bonus: 'smelt', desc: 'Taven칤 rud na kovy' }, requires: { stone: 12, metal: 4, wood: 6 }, category: 'special', portable: false },
            
            // === Z츼KLADN칈 SUROVINY (lze vyr치b캩t z jin칳ch) ===
            { id: 'craft_rope', name: 'Lano (3x)', icon: '俱', result: { type: 'resource', resource: 'rope', amount: 3 }, requires: { cloth: 4 }, category: 'special', portable: true },
            { id: 'craft_glass', name: 'Sklo (2x)', icon: '游댩', result: { type: 'resource', resource: 'glass', amount: 2 }, requires: { stone: 5 }, category: 'special', portable: false },
            { id: 'craft_leather', name: 'Vyd캩lan치 k콢쬰 (2x)', icon: '游붮', result: { type: 'resource', resource: 'leather', amount: 2 }, requires: { cloth: 2, chemicals: 1 }, category: 'special', portable: false },
            { id: 'craft_scrap', name: 'rot (3x)', icon: '鮫勇', result: { type: 'resource', resource: 'scrap', amount: 3 }, requires: { metal: 2 }, category: 'special', portable: true },
            { id: 'craft_fuel', name: 'Palivo (2x)', icon: '久', result: { type: 'resource', resource: 'fuel', amount: 2 }, requires: { wood: 3, chemicals: 1 }, category: 'special', portable: false },
            
            // === ELIX칈RY S KRYSTALY (vy쬬duj칤 d칤lnu) ===
            { id: 'crystal_elixir', name: 'Siln칳 elix칤r', icon: '九', result: { type: 'consumable', effect: 'all_stats', value: 20, desc: '+20 ke v코em stat콢m' }, requires: { herbs: 5, chemicals: 4, glass: 1 }, category: 'medical', portable: false },
            { id: 'silver_bullet', name: 'St콏칤brn칠 n치boje (5x)', icon: '游댦', result: { type: 'ammo', ammoType: 'bullet', count: 5, damage: 50 }, requires: { silver: 2, gunpowder: 3 }, category: 'ammo', portable: false },
            { id: 'gold_coating', name: 'Zes칤len칳 povlak', icon: '九', result: { type: 'consumable', effect: 'weapon_buff', value: 10, desc: '+10 damage na 10 boj콢' }, requires: { metal: 2, chemicals: 2 }, category: 'special', portable: false }
        ];
        
        const ACHIEVEMENTS = [
            // Boj
            { id: 'first_blood', name: 'Prvn칤 krev', icon: '丘덢잺', desc: 'Zabij prvn칤ho nep콏칤tele', check: () => state.stats.kills >= 1 },
            { id: 'warrior', name: 'Bojovn칤k', icon: '游디勇', desc: 'Zabij 25 nep콏치tel', check: () => state.stats.kills >= 25 },
            { id: 'slayer', name: 'Zabij치k', icon: '游', desc: 'Zabij 100 nep콏치tel', check: () => state.stats.kills >= 100 },
            { id: 'boss_hunter', name: 'Lovec boss콢', icon: '游', desc: 'Poraz sv칠ho prvn칤ho bosse', check: () => state.stats.bossKills >= 1 },
            { id: 'boss_slayer', name: 'Ni캜itel boss콢', icon: '游낼', desc: 'Poraz 5 boss콢', check: () => state.stats.bossKills >= 5 },
            { id: 'untouchable', name: 'Nedotknuteln칳', icon: '游띠勇', desc: 'Vyhraj boj bez zran캩n칤', check: () => state.stats.flawlessWins >= 1 },
            { id: 'combo_master', name: 'Kritick칳 칰to캜n칤k', icon: '游댠', desc: 'Dej 10 kritick칳ch 칰der콢', check: () => (state.stats.criticalHits || 0) >= 10 },
            
            // Pr콢zkum - opraveno na visitedLocations
            { id: 'explorer', name: 'Pr콢zkumn칤k', icon: '游딬勇', desc: 'Nav코tiv 5 r콢zn칳ch lokac칤', check: () => (state.world?.visitedLocations?.length || 0) >= 5 },
            { id: 'adventurer', name: 'Dobrodruh', icon: '游빐', desc: 'Nav코tiv 15 r콢zn칳ch lokac칤', check: () => (state.world?.visitedLocations?.length || 0) >= 15 },
            { id: 'world_traveler', name: 'Sv캩tob캩쬹칤k', icon: '游깴', desc: 'Nav코tiv 30 r콢zn칳ch lokac칤', check: () => (state.world?.visitedLocations?.length || 0) >= 30 },
            { id: 'treasure_hunter', name: 'Sb캩ratel vz치cnost칤', icon: '游눑', desc: 'Najdi 5 vz치cn칳ch p콏edm캩t콢', check: () => (state.stats.rareFound || 0) >= 5 },
            
            // P콏e쬴t칤
            { id: 'survivor_3', name: 'P콏e쬴v코칤', icon: '游깬', desc: 'P콏e쬴j 3 dny', check: () => state.time.days >= 3 },
            { id: 'survivor_7', name: 'T칳denn칤 p콏e쬴t칤', icon: '游늰', desc: 'P콏e쬴j 7 dn칤', check: () => state.time.days >= 7 },
            { id: 'survivor_30', name: 'M캩s칤캜n칤 veter치n', icon: '游끥', desc: 'P콏e쬴j 30 dn칤', check: () => state.time.days >= 30 },
            { id: 'survivor_100', name: 'Legenda pustiny', icon: '游녬', desc: 'P콏e쬴j 100 dn칤', check: () => state.time.days >= 100 },
            { id: 'near_death', name: 'Na pokraji smrti', icon: '游', desc: 'P콏e쬴j s m칠n캩 ne 5 HP', check: () => state.stats.nearDeathExp >= 1 },
            { id: 'rad_survivor', name: 'Radia캜n칤 veter치n', icon: '驕뮖잺', desc: 'P콏e쬴j s 80+ radiac칤', check: () => state.stats.maxRadiation >= 80 },
            { id: 'weather_survivor', name: 'Bou콏kov칳 p콏e쬴v코칤', icon: '久걾잺', desc: 'P콏e쬴j radia캜n칤 bou콏i', check: () => state.stats.radstormsSurvived >= 1 },
            
            // Ekonomika
            { id: 'saver', name: 'Spo콏ivec', icon: '游뿣', desc: 'Nasb칤rej 500 pen캩z', check: () => state.money >= 500 },
            { id: 'rich', name: 'Boh치캜', icon: '游눯', desc: 'Nasb칤rej 2000 pen캩z', check: () => state.money >= 2000 },
            { id: 'millionaire', name: 'Milion치콏', icon: '游눑', desc: 'Vyd캩lej celkem 10000 pen캩z', check: () => (state.stats.totalMoneyEarned || 0) >= 10000 },
            { id: 'trader_novice', name: 'Za캜칤naj칤c칤 obchodn칤k', icon: '游', desc: 'Prodej 10 p콏edm캩t콢', check: () => (state.stats.itemsSold || 0) >= 10 },
            { id: 'trader_pro', name: 'Obchodn칤k profesion치l', icon: '游낅', desc: 'Prodej 50 p콏edm캩t콢', check: () => (state.stats.itemsSold || 0) >= 50 },
            
            // Crafting
            { id: 'crafter', name: '콎emesln칤k', icon: '游댣', desc: 'Vyrob 10 p콏edm캩t콢', check: () => (state.stats.itemsCrafted || 0) >= 10 },
            { id: 'master_crafter', name: 'Mistr 콏emesla', icon: '丘뉦잺', desc: 'Vyrob 50 p콏edm캩t콢', check: () => (state.stats.itemsCrafted || 0) >= 50 },
            
            // Vybaven칤
            { id: 'collector', name: 'Sb캩ratel', icon: '游닍', desc: 'M캩j 30+ item콢 v invent치콏i', check: () => state.inv.length >= 30 },
            { id: 'legendary_finder', name: 'Legend치rn칤 n치lez', icon: '救', desc: 'Najdi legend치rn칤 p콏edm캩t', check: () => (state.stats.legendaryFound || 0) >= 1 },
            { id: 'fully_equipped', name: 'Pln캩 vybaven', icon: '游꿌勇', desc: 'M캩j zbra켿, brn캩n칤 a helmu', check: () => state.equipped?.weapon && state.equipped?.armor && state.equipped?.helmet },
            
            // Osada
            { id: 'builder', name: 'Stavitel', icon: '游끵勇', desc: 'Postav 5 budov', check: () => (state.base?.length || 0) >= 5 },
            { id: 'architect', name: 'Architekt', icon: '游끹勇', desc: 'Postav 15 budov', check: () => (state.base?.length || 0) >= 15 },
            { id: 'settler', name: 'Zakladatel', icon: '游끶勇', desc: 'P콏ijmi prvn칤ho osadn칤ka', check: () => (state.settlement?.settlers?.length || 0) >= 1 },
            { id: 'community_leader', name: 'V콢dce komunity', icon: '游논', desc: 'M캩j 5 osadn칤k콢', check: () => (state.settlement?.settlers?.length || 0) >= 5 },
            
            // Level
            { id: 'level_5', name: 'Zku코en칳', icon: '游늳', desc: 'Dos치hni level 5', check: () => state.char.level >= 5 },
            { id: 'level_10', name: 'Veter치n', icon: '游꿢', desc: 'Dos치hni level 10', check: () => state.char.level >= 10 },
            { id: 'level_20', name: 'Hrdina', icon: '游끤', desc: 'Dos치hni level 20', check: () => state.char.level >= 20 },
            { id: 'max_level', name: 'Mistr', icon: '游녬', desc: 'Dos치hni level 30', check: () => state.char.level >= 30 },
            
            // Speci치ln칤
            { id: 'pacifist', name: 'Pacifista', icon: '驕쉺잺', desc: 'P콏e쬴j 3 dny bez zabit칤', check: () => (state.stats.pacifistDays || 0) >= 3 },
            { id: 'companion_friend', name: 'P콏칤tel zv칤콏at', icon: '游냇', desc: 'Z칤skej prvn칤ho spole캜n칤ka', check: () => (state.companions?.length || 0) >= 1 },
            { id: 'companion_master', name: 'P치n spole캜n칤k콢', icon: '游뱋', desc: 'M캩j 3 spole캜n칤ky', check: () => (state.companions?.length || 0) >= 3 },
            { id: 'quest_complete', name: 'Dobrodinec', icon: '游닆', desc: 'Dokon캜i hlavn칤 quest', check: () => (state.mainQuest?.completedQuests?.length || 0) >= 1 },
            { id: 'story_master', name: 'Mistr p콏칤b캩hu', icon: '游닀', desc: 'Dokon캜i 10 quest콢', check: () => (state.mainQuest?.completedQuests?.length || 0) >= 10 },
            
            // Nemoci
            { id: 'disease_survivor', name: 'P콏ekonal jsem', icon: '游', desc: 'Vyl칠캜 se z prvn칤 nemoci', check: () => (state.diseases?.totalCured || 0) >= 1 },
            { id: 'plague_doctor', name: 'Morov칳 doktor', icon: '游낀', desc: 'Vyl칠캜 se z 10 nemoc칤', check: () => (state.diseases?.totalCured || 0) >= 10 },
            { id: 'iron_constitution', name: '콯elezn치 konstituce', icon: '游눩', desc: 'P콏e쬴j radia캜n칤 bou콏i bez nemoci', check: () => (state.stats?.radstormsSurvived || 0) >= 3 && (state.diseases?.totalCured || 0) === 0 }
        ];
        
        // 游닀 BESTI츼콎 - Popisy nep콏치tel
        const BESTIARY_DESCRIPTIONS = {
            // Tier 1 - Divok치 zv캩콏
            rat: 'Oby캜ejn치 krysa, kter치 se po apokalypse rozmno쬴la do ob콏칤ch sme캜ek. Slab치, ale nebezpe캜n치 ve velk칠m po캜tu.',
            giant_rat: 'Mutac칤 zv캩t코en치 krysa. Jej칤 zuby dok치쮂 prokousnout i ko쬰n칠 boty.',
            mutant_rat: 'Radiac칤 pozm캩n캩n치 krysa se sv칤t칤c칤ma o캜ima. Jej칤 kousnut칤 m콢쬰 zp콢sobit infekci.',
            wild_dog: 'Kdysi v캩rn칳 spole캜n칤k 캜lov캩ka, nyn칤 zdivo캜el칳 pred치tor lov칤c칤 v sme캜k치ch.',
            feral_cat: 'Zdivo캜el치 ko캜ka s ostr칳mi dr치py. Rychl치 a nep콏edv칤dateln치.',
            feral: '캛lov캩k, kter칳 ztratil rozum v pustin캩. 칔to캜칤 na v코e 쬴v칠.',
            
            // Tier 2 - St콏edn칤
            zombie: 'O쬴vl치 mrtvola poh치n캩n치 nezn치mou silou. Pomal치, ale vytrval치.',
            raider_weak: 'Za캜칤naj칤c칤 n치jezdn칤k s improvizovanou v칳zbroj칤. Nebezpe캜n칳 ve skupin캩.',
            raider: 'Zku코en칳 n치jezdn칤k, kter칳 p콏e쬴l d칤ky kr치de쬴 a n치sil칤.',
            wolf: 'Mutantn칤 vlk s ocelov캩 코edou srst칤. Alfa pred치tor pustiny.',
            soldier: 'Voj치k p콏e쬴v코칤 z vojensk칠 z치kladny. Dob콏e vycvi캜en칳 a ozbrojen칳.',
            soldier_zombie: 'O쬴vl칳 voj치k st치le v uniform캩. Nebezpe캜n캩j코칤 ne b캩쬹칳 zombie.',
            turret: 'Automatick치 st콏eleck치 v캩. St콏칤l칤 na v코e co se h칳be.',
            cave_spider: 'Ob콏칤 pavouk 쬴j칤c칤 v temn칳ch jeskyn칤ch. Jeho jed paralyzuje ob캩ti.',
            ghost: 'P콏칤zra캜n치 bytost bez fyzick칠 formy. 콎칤k치 se, 쬰 jsou to du코e ob캩t칤 apokalypsy.',
            mutant_dog: 'Pes pozm캩n캩n칳 radiac칤. Jeho 캜enich c칤t칤 ko콏ist na kilometry.',
            mutant_frog: 'Ob콏칤 쮂멱a s jedovatou k콢쮂. Jej칤 jazyk dok치쬰 zas치hnout na n캩kolik metr콢.',
            zombie_cop: 'Zombie v policejn칤 uniform캩. St치le nos칤 slu쬰bn칤 zbra켿.',
            mutant_fish: 'Ryba s nohama, kter치 vy코la z vody. Apokalypsa zm캩nila i oce치ny.',
            
            // Tier 3 - Siln칤
            mutant: '캛lov캩k zcela p콏em캩n캩n칳 radiac칤. Siln칳, odoln칳 a nep콏치telsk칳.',
            bandit: 'Profesion치ln칤 zlo캜inec p콏e쬴v코칤 d칤ky bezcitnosti. Dob콏e ozbrojen칳.',
            ghoul: 'Kdysi 캜lov캩k, nyn칤 rozpadaj칤c칤 se stvo콏en칤 쬴v칤c칤 se masem.',
            raider_boss: 'V콢dce bandy n치jezdn칤k콢. Bezohledn칳 a nebezpe캜n칳.',
            robot: 'Vojensk칳 robot st치le pln칤c칤 sv칠 naprogramovan칠 rozkazy.',
            slaver: 'Obchodn칤k s lidmi. Jeden z nejodporn캩j코칤ch tvor콢 pustiny.',
            experiment: 'Utekl칳 laboratorn칤 experiment. Nikdo nev칤, co p콏esn캩 je.',
            swamp_creature: 'Prastar칳 tvor z ba쬴n. Mo쬹치 p콏e쬴l z doby dinosaur콢.',
            ice_mutant: 'Mutant adaptovan칳 na extr칠mn칤 chlad. Jeho dotek mraz칤.',
            toxic_zombie: 'Zombie nas치kl칳 toxick칳mi l치tkami. Jeho p콏칤tomnost otravuje vzduch.',
            electric_mutant: 'Mutant generuj칤c칤 elekt콏inu. Nebezpe캜n칠 se ho dotknout.',
            
            // Tier 4 - Bossov칠
            slaver_boss: 'V콢dce otrok치콏sk칠ho syndik치tu. M치 arm치du v캩rn칳ch slu쬰bn칤k콢.',
            giant_mutant: 'Ob콏칤 mutant vysok칳 p콏es 3 metry. Legenda pustiny.',
            alpha_wolf: 'V콢dce vl캜칤 sme캜ky. Nejv캩t코칤 a nejsiln캩j코칤 z vlk콢.',
            zombie_hulk: 'Masivn칤 zombie mutant. Jeho s칤la dok치쬰 prorazit zdi.',
            elite_robot: 'Pokro캜il칳 vojensk칳 robot s AI. T칠m캩콏 nezni캜iteln칳.',
            toxic_beast: 'Bestie z toxick칠 z칩ny. Jej칤 krev je 캜ist칳 jed.',
            acid_beast: 'Tvor plivaj칤c칤 kyselinu. Rozpou코t칤 v코e ve sv칠 cest캩.',
            swamp_beast: 'Prastar칳 str치쬮e ba쬴n. M칤stn칤 ho uct칤vaj칤 jako boha.',
            glowing_ghoul: 'Ghoul nas치kl칳 radiac칤. Z치콏칤 ve tm캩 zelen칳m sv캩tlem.',
            mutant_brute: 'Nejsiln캩j코칤 z mutant콢. 콎칤k치 se, 쬰 byl kdysi olympijsk칳 atlet.',
            
            // Tier 5 - Legend치rn칤
            glowing_one: 'Legend치rn칤 z치콏칤c칤 bytost. Samotn치 radiace z칤skala v캩dom칤.',
            irradiated_beast: 'Bestie z centra v칳buchu. Jej칤 t캩lo je 캜ist치 radiace.',
            mutant_behemoth: 'Kolos치ln칤 mutant. N캩kte콏칤 v캩콏칤, 쬰 je nesmrteln칳.',
            deathclaw: 'Legend치rn칤 dravec. Nejv칤ce ob치van칳 tvor cel칠 pustiny.',
            mutant_giant: 'Obr mezi mutanty. Jeho kroky ot콏치saj칤 zem칤.',
            mutant_queen: 'Kr치lovna mutant콢. Pr칳 ovl치d치 v코echny ostatn칤 mutanty.',
            ai_guardian: 'Str치쬮e starov캩k칠 technologie. Chr치n칤 tajemstv칤 p콏ed apokalypsy.',
            
            // Speci치ln칤
            sentinel: 'Kamenn칳 str치쬮e tajn칠ho trezoru. Stoj칤 zde stalet칤.',
            ancient_guardian: 'Prastar칳 str치쬮e poklad콢. Posledn칤 obr치nce ztracen칠 civilizace.'
        };
        
        // Funkce pro zobrazen칤 besti치콏e
        function showBestiary() {
            const killsByType = state.stats.killsByType || {};
            const discoveredEnemies = Object.keys(killsByType).filter(k => killsByType[k] > 0);
            const totalEnemyTypes = ENEMIES.length;
            
            // Seskup nep콏치tele podle tieru
            const enemiesByTier = {};
            ENEMIES.forEach(enemy => {
                if (!enemiesByTier[enemy.tier]) enemiesByTier[enemy.tier] = [];
                enemiesByTier[enemy.tier].push(enemy);
            });
            
            const tierNames = {
                1: '游 Tier 1 - Divok치 zv캩콏',
                2: '游 Tier 2 - St콏edn칤 hrozby', 
                3: '游놏 Tier 3 - Siln칤 nep콏치tel칠',
                4: '游 Tier 4 - Bossov칠',
                5: '游녬 Tier 5 - Legend치rn칤'
            };
            
            const tierColors = {
                1: '#8bc34a',
                2: '#ff9800',
                3: '#f44336',
                4: '#9c27b0',
                5: '#ffd700'
            };
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; color: #888;">Objeveno nep콏치tel</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f44336;">${discoveredEnemies.length} / ${totalEnemyTypes}</div>
                    <div style="background: #333; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #f44336, #ff9800); height: 100%; width: ${(discoveredEnemies.length / totalEnemyTypes * 100).toFixed(1)}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            `;
            
            for (let tier = 1; tier <= 5; tier++) {
                const enemies = enemiesByTier[tier] || [];
                const discovered = enemies.filter(e => killsByType[e.id] > 0).length;
                
                html += `
                    <details ${tier <= 2 ? 'open' : ''} style="margin-bottom: 0.5rem;">
                        <summary style="background: linear-gradient(135deg, ${tierColors[tier]}22, #1a1a1a); padding: 0.6rem; border-radius: 6px; cursor: pointer; border-left: 3px solid ${tierColors[tier]};">
                            <span style="color: ${tierColors[tier]}; font-weight: bold;">${tierNames[tier]}</span>
                            <span style="color: #888; font-size: 0.8rem; margin-left: 0.5rem;">(${discovered}/${enemies.length})</span>
                        </summary>
                        <div style="padding: 0.5rem; display: grid; gap: 0.4rem;">
                `;
                
                enemies.forEach(enemy => {
                    const kills = killsByType[enemy.id] || 0;
                    const discovered = kills > 0;
                    const desc = BESTIARY_DESCRIPTIONS[enemy.id] || 'Nezn치m칳 nep콏칤tel.';
                    
                    if (discovered) {
                        html += `
                            <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 0.6rem; border-radius: 6px; border: 1px solid ${tierColors[tier]}44;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                                    <span style="font-size: 1.5rem;">${enemy.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="color: #fff; font-weight: bold; font-size: 0.9rem;">${enemy.name}</div>
                                        <div style="color: ${tierColors[tier]}; font-size: 0.7rem;">Zabito: ${kills}x</div>
                                    </div>
                                    ${enemy.isBoss ? '<span style="background: #9c27b0; color: #fff; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem;">BOSS</span>' : ''}
                                </div>
                                <div style="color: #888; font-size: 0.75rem; font-style: italic; margin-bottom: 0.4rem;">${desc}</div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.7rem; color: #666;">
                                    <span>仇벒잺 ${enemy.hp}</span>
                                    <span>丘덢잺 ${enemy.damage}</span>
                                    <span>游띠勇 ${enemy.defense}</span>
                                    <span>救 ${enemy.xp} XP</span>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 6px; border: 1px solid #222; opacity: 0.5;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">仇</span>
                                    <div>
                                        <div style="color: #444; font-weight: bold; font-size: 0.9rem;">???</div>
                                        <div style="color: #333; font-size: 0.7rem;">Zat칤m neobjeveno</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `</div></details>`;
            }
            
            html += `</div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">Zav콏칤t</button>
            `;
            
            showModal('游닀 Besti치콏', html);
        }
        
        const RANDOM_EVENTS = [
            {
                id: 'abandoned_camp',
                name: 'Opu코t캩n칳 kemp',
                icon: '游끳勇',
                chance: 0.15,
                trigger: () => {
                    const loot = ITEMS.filter(i => i.findChance > 0 && (i.rarity === 'common' || i.rarity === 'uncommon'));
                    const found = loot[Math.floor(Math.random() * loot.length)];
                    if (found && canAddItem(found, 1)) {
                        const existing = state.inv.find(i => i.id === found.id);
                        if (existing && found.type === 'consumable') {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            state.inv.push({...found, count: found.type === 'consumable' ? 1 : undefined});
                        }
                        showModal('游끳勇 Opu코t캩n칳 kemp!', 
                            '<p>Na코el jsi opu코t캩n칳 kemp cestovatel콢...</p>' +
                            '<p style="color: #8bc34a;">九 Na코el jsi: ' + found.icon + ' ' + found.name + '</p>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>'
                        );
                    }
                }
            },
            {
                id: 'radiation_storm',
                name: 'Radia캜n칤 bou콏e',
                icon: '驕뮖잺',
                chance: 0.10,
                trigger: () => {
                    addRadiation(20);
                    // Track pro achievement
                    state.stats.radstormsSurvived = (state.stats.radstormsSurvived || 0) + 1;
                    showModal('驕뮖잺 Radia캜n칤 bou콏e!', 
                        ('<p style="color: #c62828;">Dostal ses do radia캜n칤 bou콏e!</p>') +
                        '<p>+20 radiace</p>' +
                        ('<p style="color: #ff9800;">丘멆잺 Pot콏ebuje코 RadAway!</p>') +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>'
                    );
                    addLog('Radia캜n칤 bou콏e! +20 radiace', '驕뮖잺');
                }
            },
            {
                id: 'friendly_trader',
                name: 'P콏치telsk칳 obchodn칤k',
                icon: '游뱋',
                chance: 0.08,
                trigger: () => {
                    showModal('游뱋 P콏치telsk칳 obchodn칤k!', 
                        '<p>Potkal jsi p콏치telsk칠ho obchodn칤ka na cest캩!</p>' +
                        ('<p style="color: #8bc34a;">Nab칤z칤 speci치ln칤 ceny...</p>') +
                        '<button class="btn" onclick="closeModal(); openShop();" style="width: 100%; margin-top: 1rem;">游낅 ' + ('Otev콏칤t obchod') + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 ' + ('Ne, d캩kuji') + '</button>'
                    );
                }
            },
            {
                id: 'mystery_box',
                name: 'Z치hadn칳 bal칤캜ek',
                icon: '游닍',
                chance: 0.12,
                trigger: () => {
                    const roll = Math.random();
                    if (roll < 0.6) {
                        // Good item
                        const rare = ITEMS.filter(i => i.rarity === 'rare' && i.findChance > 0);
                        if (rare.length > 0) {
                            const item = rare[Math.floor(Math.random() * rare.length)];
                            if (canAddItem(item, 1)) {
                                state.inv.push({...item, count: item.type === 'consumable' ? 1 : undefined});
                                showModal('游닍 Z치hadn칳 bal칤캜ek!', 
                                    '<p>Na코el jsi z치hadn칳 bal칤캜ek!</p>' +
                                    '<p style="color: #2196f3;">九 ' + item.icon + ' ' + item.name + '</p>' +
                                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>'
                                );
                            }
                        }
                    } else {
                        // Trap!
                        state.char.hp = Math.max(1, state.char.hp - 20);
                        showModal('游닍 Past!', 
                            ('<p style="color: #c62828;">Byl to trap!</p>') +
                            '<p>-20 HP</p>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>'
                        );
                        addLog('Chytil ses do pasti! -20 HP', '游눤');
                    }
                }
            },
            {
                id: 'find_money',
                name: 'Pen칤ze',
                icon: '游눯',
                chance: 0.12,
                trigger: () => {
                    const amount = Math.floor(Math.random() * 40) + 15; // 15-55 (sn칤쬰no z 50-150)
                    addMoney(amount);
                    showModal('游눯 N치hodn칳 n치lez!', 
                        '<p>Na코el jsi trochu pen캩z na zemi!</p>' +
                        '<p style="color: #ffd700;">+' + amount + ' pen캩z</p>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>'
                    );
                }
            },
            {
                id: 'survivor_help',
                name: 'P콏e쬴v코칤 v nouzi',
                icon: '游',
                chance: 0.08,
                trigger: () => {
                    showModal('游 P콏e쬴v코칤 v nouzi!', 
                        '<p>Sly코칤코 vol치n칤 o pomoc z nedaleka...</p>' +
                        '<p>P콏e쬴v코칤 je v ohro쬰n칤 mutanty!</p>' +
                        '<button class="btn" onclick="helpSurvivor()" style="width: 100%; margin-top: 1rem; background: #4caf50;">游뱋 Pomoct (boj)</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">游끢 ' + ('Ignorovat') + '</button>'
                    );
                }
            },
            {
                id: 'treasure_map',
                name: 'Mapa k pokladu',
                icon: '游딬勇',
                chance: 0.05,
                trigger: () => {
                    // Pou쬴j nov칳 WORLD_LOCATIONS syst칠m
                    const treasureLocations = WORLD_LOCATIONS.filter(l => 
                        l.type !== 'home' && l.type !== 'empty' && l.zone !== 'safe' &&
                        !state.world.visitedLocations?.includes(l.id)
                    );
                    if (treasureLocations.length === 0) return;
                    
                    const treasureLoc = treasureLocations[Math.floor(Math.random() * treasureLocations.length)];
                    state.treasureLocation = { 
                        locationId: treasureLoc.id,
                        locationName: treasureLoc.name,
                        expiresAt: Date.now() + 30 * 60 * 1000 // 30 minut
                    };
                    showModal('游딬勇 Nalezena mapa!', 
                        '<p>Na코el jsi starou mapu s ozna캜en칳m m칤stem!</p>' +
                        '<p style="color: #ffd700;">游늸 Poklad je v lokaci: <strong>' + treasureLoc.name + '</strong></p>' +
                        '<p style="color: #999; font-size: 0.85rem;">M치코 30 minut na nalezen칤 pokladu!</p>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 Zapamatov치no!</button>'
                    );
                    addLog('Na코el jsi mapu k pokladu! Lokace: ' + treasureLoc.name, '游딬勇');
                }
            },
            {
                id: 'caravan',
                name: 'Obchodn칤 karavana',
                icon: '游냙',
                chance: 0.10,
                trigger: () => {
                    // Aktivuj glob치ln칤 karavanu
                    state.caravan = state.caravan || { active: false, until: 0, lastCheck: Date.now() };
                    state.caravan.active = true;
                    state.caravan.until = Date.now() + 300000; // 5 minut
                    
                    showModal('游냙 Obchodn칤 karavana!', 
                        '<p>Potkal jsi obchodn칤 karavanu!</p>' +
                        '<p style="color: #8bc34a;">Nab칤zej칤 vz치cn칠 zbo쮂 za dobr칠 ceny...</p>' +
                        '<p style="color: #888;">Karavana z콢stane 5 minut.</p>' +
                        '<button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 1rem;">游 ' + ('Prohl칠dnout zbo쮂') + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">游녦 ' + ('Rozlou캜it se') + '</button>'
                    );
                    addLog('Potkal jsi obchodn칤 karavanu!', '游냙');
                }
            },
            {
                id: 'animal_attack',
                name: '칔tok divok칳ch zv칤콏at',
                icon: '游냨',
                chance: 0.12,
                trigger: () => {
                    const animals = ENEMIES.filter(e => e.tier === 1);
                    const animal = animals[Math.floor(Math.random() * animals.length)];
                    showModal('游냨 칔tok zv칤콏at!', 
                        ('<p style="color: #ff9800;">Divok치 zv칤콏ata t캩 napadla!</p>') +
                        '<p>' + animal.icon + ' ' + animal.name + ' 칰to캜칤!</p>' +
                        '<button class="btn" onclick="startCombat({id: \'' + animal.id + '\'});" style="width: 100%; margin-top: 1rem;">丘덢잺 ' + ('Bojovat!') + '</button>'
                    );
                }
            },
            {
                id: 'hidden_stash',
                name: 'Skryt치 skr칳코',
                icon: '游돕勇',
                chance: 0.08,
                trigger: () => {
                    const resources = ['wood', 'metal', 'stone', 'cloth'];
                    const found = {};
                    resources.forEach(r => {
                        const amount = 1 + Math.floor(Math.random() * 2); // 1-2 (sn칤쬰no z 1-5)
                        found[r] = amount;
                        state.resources[r] = (state.resources[r] || 0) + amount;
                    });
                    showModal('游돕勇 Skryt치 skr칳코!', 
                        '<p>Objevil jsi malou skr칳코 se z치sobami!</p>' +
                        '<p style="color: #8bc34a;">' +
                        '游 +' + found.wood + ' d콏eva<br>' +
                        '丘뙖잺 +' + found.metal + ' kovu<br>' +
                        '游 +' + found.stone + ' kamene<br>' +
                        '游빗 +' + found.cloth + ' l치tky</p>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 ' + ('Dob콏e!') + '</button>'
                    );
                }
            },
            {
                id: 'wounded_companion',
                name: 'Zran캩n칳 spole캜n칤k',
                icon: '游뱃',
                chance: 0.04,
                trigger: () => {
                    if (state.companions && state.companions.length >= getMaxCompanions()) return; // Max companions based on level
                    const availableCompanions = COMPANIONS.filter(c => !state.companions?.find(sc => sc.id === c.id));
                    if (availableCompanions.length === 0) return;
                    const companion = availableCompanions[Math.floor(Math.random() * availableCompanions.length)];
                    showModal('游뱃 Zran캩n칳 spole캜n칤k!', 
                        '<p>Na코el jsi zran캩n칠ho ' + companion.name + '!</p>' +
                        '<p>' + companion.icon + ' ' + companion.abilityDesc + '</p>' +
                        '<p style="color: #8bc34a;">Pokud ho vyl칠캜칤코, p콏ipoj칤 se k tob캩!</p>' +
                        '<button class="btn" onclick="rescueCompanion(\'' + companion.id + '\')" style="width: 100%; margin-top: 1rem; background: #4caf50;">游눍 ' + ('Vyl칠캜it (1x L칠k치rni캜ka)') + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">游땞 ' + ('Nechat b칳t') + '</button>'
                    );
                }
            }
        ];
        
        const DAILY_QUEST_POOL = [
            // === BOJOV칄 ===
            { id: 'kill_enemies', name: 'Lovec', desc: 'Zabij 3 nep콏치tele', icon: '丘덢잺', 
              target: 3, progressKey: 'kills',
              check: () => (state.dailyQuests.progress?.kills || 0) >= 3, 
              reward: () => { addMoney(80); addXP(30); } },
            { id: 'kill_many', name: 'Vyhlazova캜', desc: 'Zabij 8 nep콏치tel', icon: '游', 
              target: 8, progressKey: 'kills',
              check: () => (state.dailyQuests.progress?.kills || 0) >= 8, 
              reward: () => { addMoney(150); addXP(60); } },
            
            // === PR콡ZKUM ===
            { id: 'explore_hexes', name: 'Pr콢zkumn칤k', desc: 'Nav코tiv 2 NOV칄 lokace (kter칠 jsi je코t캩 nikdy nenav코t칤vil)', icon: '游딬勇', 
              target: 2, progressKey: 'explored',
              check: () => (state.dailyQuests.progress?.explored || 0) >= 2, 
              reward: () => { addXP(50); } },
            
            // === SB캨R ===
            { id: 'collect_money', name: 'Sb캩ratel', desc: 'Z칤skej 150 pen캩z', icon: '游눯', 
              target: 150, progressKey: 'moneyEarned',
              check: () => (state.dailyQuests.progress?.moneyEarned || 0) >= 150, 
              reward: () => { addXP(40); } },
            { id: 'collect_loot', name: 'Hleda캜', desc: 'Najdi 5 p콏edm캩t콢', icon: '游', 
              target: 5, progressKey: 'itemsFound',
              check: () => (state.dailyQuests.progress?.itemsFound || 0) >= 5, 
              reward: () => { addMoney(70); } },
            
            // === V칗ROBA ===
            { id: 'craft_items', name: '콎emesln칤k', desc: 'Vyrob 2 v캩ci', icon: '游댣', 
              target: 2, progressKey: 'crafted',
              check: () => (state.dailyQuests.progress?.crafted || 0) >= 2, 
              reward: () => { state.settlement.resources.wood = (state.settlement?.resources?.wood || 0) + 10; state.settlement.resources.metal = (state.settlement?.resources?.metal || 0) + 5; } },
            { id: 'cook_food', name: 'Kucha콏', desc: 'Upe캜/uva콏 3 j칤dla', icon: '游꼤', 
              target: 3, progressKey: 'cooked',
              check: () => (state.dailyQuests.progress?.cooked || 0) >= 3, 
              reward: () => { addXP(25); } },
            
            // === OBCHOD ===
            { id: 'trade_items', name: 'Obchodn칤k', desc: 'Prodej 3 v캩ci', icon: '游눺', 
              target: 3, progressKey: 'sold',
              check: () => (state.dailyQuests.progress?.sold || 0) >= 3, 
              reward: () => { addMoney(100); } },
            { id: 'buy_items', name: 'N치kup캜칤', desc: 'Kup 2 v캩ci', icon: '游', 
              target: 2, progressKey: 'bought',
              check: () => (state.dailyQuests.progress?.bought || 0) >= 2, 
              reward: () => { addXP(30); } },
            
            // === OSADA ===
            { id: 'feed_companion', name: 'Krmitel', desc: 'Nakrm spole캜n칤ka', icon: '游붮', 
              target: 1, progressKey: 'fedCompanion',
              check: () => (state.dailyQuests.progress?.fedCompanion || 0) >= 1, 
              reward: () => { addXP(20); addMoney(30); } },
            { id: 'heal_self', name: 'P콏e쬴v코칤', desc: 'Vyl칠캜 se 50 HP', icon: '游눜', 
              target: 50, progressKey: 'healed',
              check: () => (state.dailyQuests.progress?.healed || 0) >= 50, 
              reward: () => { addMoney(50); } },
            
            // === SPECI츼LN칈 ===
            // PvP quest odstran캩n - PvP je zam캜eno
            { id: 'gamble', name: 'Hr치캜', desc: 'Zahraj si v kasinu', icon: '游꿣', 
              target: 1, progressKey: 'gambled',
              check: () => (state.dailyQuests.progress?.gambled || 0) >= 1, 
              reward: () => { addXP(15); } }
        ];
        
        // P콏eklady daily quest콢
        function getDailyQuestName(questId) {
            const quest = DAILY_QUEST_POOL.find(q => q.id === questId);
            return quest?.name || questId;
        }
        
        function getDailyQuestDesc(questId) {
            const quest = DAILY_QUEST_POOL.find(q => q.id === questId);
            return quest?.desc || '';
        }
        
        // === FRAKCE SYST칄M ===
        const FACTIONS = [
            { 
                id: 'traders', 
                name: 'Obchodn칤 gilda', 
                icon: '游낅', 
                color: '#ffd700',
                desc: 'Obchodn칤ci a karavan치콏i. Ovl치daj칤 obchod v pustin캩.',
                bonuses: {
                    friendly: { priceDiscount: 0.05, specialItems: true, desc: '-5% ceny, speci치ln칤 zbo쮂' },
                    allied: { priceDiscount: 0.10, freeHealing: true, desc: '-10% ceny, l칠캜en칤 zdarma' }
                },
                penalties: {
                    hostile: { priceIncrease: 0.5, noTrade: false, desc: '+50% ceny' },
                    enemy: { noTrade: true, attackOnSight: true, desc: 'Neobchoduj칤, 칰to캜칤' }
                },
                locations: ['trading_post', 'bazaar']
            },
            { 
                id: 'scientists', 
                name: 'V캩dci Enkl치vy', 
                icon: '游댧', 
                color: '#00bcd4',
                desc: 'Hledaj칤 odpov캩di v trosk치ch star칠 civilizace.',
                bonuses: {
                    friendly: { craftBonus: 0.05, techAccess: true, desc: '+5% efektivita craftingu, tech' },
                    allied: { mutations: true, labAccess: true, desc: 'L칠캜en칤 mutac칤, p콏칤stup do lab' }
                },
                penalties: {
                    hostile: { noHelp: true, desc: 'Nepom치haj칤' },
                    enemy: { sabotage: true, desc: 'Sabotuj칤 tv칠 vybaven칤' }
                },
                locations: ['lab', 'bunker']
            },
            { 
                id: 'raiders', 
                name: 'N치jezdn칤ci', 
                icon: '游', 
                color: '#f44336',
                desc: 'Brut치ln칤 gangy 쬴j칤c칤 z loupe쮂 a n치sil칤.',
                bonuses: {
                    friendly: { safePassage: true, blackMarket: true, desc: 'Bezpe캜n칳 pr콢chod, 캜ern칳 trh' },
                    allied: { mercenaries: true, intimidation: true, desc: '콯old치ci, zastra코ov치n칤' }
                },
                penalties: {
                    hostile: { ambushChance: 0.3, desc: '30% 코ance na p콏epaden칤' },
                    enemy: { ambushChance: 0.6, raidSettlement: true, desc: '60% p콏epaden칤, raidy na osadu' }
                },
                locations: ['raider_camp', 'wasteland']
            },
            { 
                id: 'mutants', 
                name: 'Mutant칤 kmen', 
                icon: '驕勇', 
                color: '#8bc34a',
                desc: 'P콏e쬴v코칤 transformovan칤 radiac칤. Mist콏i pustiny.',
                bonuses: {
                    friendly: { radResist: 0.1, mutantTrade: true, desc: '-10% radiace, obchod s mutanty' },
                    allied: { radResist: 0.25, mutantAllies: true, desc: '-25% radiace, spojenci v boji' }
                },
                penalties: {
                    hostile: { mutantAggro: true, desc: 'Mutanti 칰to캜칤 na potk치n칤' },
                    enemy: { mutantHunters: true, desc: 'Pos칤laj칤 lovce' }
                },
                locations: ['mutant_village', 'toxic_zone']
            },
            { 
                id: 'military', 
                name: 'Vojensk칳 remnant', 
                icon: '游꿌勇', 
                color: '#607d8b',
                desc: 'Zbytky star칠 arm치dy. Discipl칤na a po콏치dek.',
                bonuses: {
                    friendly: { weaponAccess: true, training: true, desc: 'P콏칤stup ke zbran칤m, tr칠nink' },
                    allied: { eliteWeapons: true, tacticalBonus: 0.05, desc: 'Elitn칤 zbran캩, +5% damage' }
                },
                penalties: {
                    hostile: { noWeapons: true, desc: 'Neobchoduj칤 zbran캩' },
                    enemy: { hunted: true, desc: 'Aktivn캩 t캩 lov칤' }
                },
                locations: ['military_base', 'checkpoint']
            }
        ];
        
        // Reputa캜n칤 칰rovn캩
        const REPUTATION_LEVELS = [
            { id: 'enemy', name: 'Nep콏칤tel', min: -100, max: -61, color: '#8B0000', icon: '游' },
            { id: 'hostile', name: 'Nep콏치telsk칳', min: -60, max: -21, color: '#f44336', icon: '游' },
            { id: 'neutral', name: 'Neutr치ln칤', min: -20, max: 19, color: '#9e9e9e', icon: '游땛' },
            { id: 'friendly', name: 'P콏치telsk칳', min: 20, max: 49, color: '#4caf50', icon: '游땕' },
            { id: 'trusted', name: 'D콢v캩ryhodn칳', min: 50, max: 99, color: '#8bc34a', icon: '游뱋' },
            { id: 'allied', name: 'Spojenec', min: 100, max: 100, color: '#ffd700', icon: '救' }
        ];
        
        // === PO캛AS칈 SYST칄M ===
        const WEATHER_TYPES = [
            { id: 'sunny', name: 'Slune캜no', icon: '驕勇', effect: { speedMod: 1.0, radMod: 1.0, moodMod: 1.1, playerDmgMod: 1.05, enemyDmgMod: 1.0 }, chance: 0.4, desc: 'Ide치ln칤 po캜as칤. +5% damage' },
            { id: 'cloudy', name: 'Zata쬰no', icon: '驕勇', effect: { speedMod: 1.0, radMod: 0.8, moodMod: 1.0, playerDmgMod: 1.0, enemyDmgMod: 1.0 }, chance: 0.25, desc: 'Norm치ln칤 podm칤nky' },
            { id: 'rain', name: 'D칠코콘', icon: '游꺊勇', effect: { speedMod: 0.8, radMod: 0.5, moodMod: 0.9, playerDmgMod: 0.95, enemyDmgMod: 1.0 }, chance: 0.15, desc: '-20% rychlost, -5% damage' },
            { id: 'storm', name: 'Bou콏ka', icon: '久걾잺', effect: { speedMod: 0.6, radMod: 0.3, moodMod: 0.7, playerDmgMod: 0.9, enemyDmgMod: 1.0 }, chance: 0.08, desc: '-40% rychlost, -10% damage' },
            { id: 'fog', name: 'Mlha', icon: '游꺎勇', effect: { speedMod: 0.7, radMod: 1.0, moodMod: 0.85, playerDmgMod: 1.0, enemyDmgMod: 1.1 }, chance: 0.07, desc: 'Nep콏치tel칠 +10% damage' },
            { id: 'radstorm', name: 'Radia캜n칤 bou콏e', icon: '驕뮖잺', effect: { speedMod: 0.5, radMod: 3.0, moodMod: 0.5, playerDmgMod: 1.0, enemyDmgMod: 1.15 }, chance: 0.05, desc: '3x radiace! Nep콏치tel칠 +15% damage' }
        ];
        
        // === SYST칄M NEMOC칈 ===
        const DISEASES = [
            { 
                id: 'cold', 
                name: 'Nachlazen칤', 
                icon: '游뱒', 
                causes: ['rain', 'storm'],
                causeDesc: 'D칠코콘 nebo bou콏ka bez p콏칤st콏e코칤',
                chance: 0.12,
                duration: 86400000, // 24 hodin (1 den)
                effects: { 
                    energyDrain: 1.3,
                    speedMod: 0.9
                },
                cures: ['herbal_tea', 'medkit', 'antibiotics'],
                desc: 'K칳ch치n칤 a r칳ma. -10% rychlost, +30% 칰bytek energie.',
                severity: 1
            },
            { 
                id: 'flu', 
                name: 'Ch콏ipka', 
                icon: '游', 
                causes: ['rain', 'storm', 'cold_untreated'],
                causeDesc: 'Dlouh칠 vystaven칤 de코ti nebo nel칠캜en칠 nachlazen칤',
                chance: 0.06,
                duration: 172800000, // 48 hodin (2 dny)
                effects: { 
                    maxHpMod: 0.85,
                    damageMod: 0.9,
                    energyDrain: 1.5
                },
                cures: ['antibiotics', 'medkit'],
                desc: 'Hore캜ka a slabost. -15% max HP, -10% damage, +50% 칰bytek energie.',
                severity: 2
            },
            { 
                id: 'radiation_sickness', 
                name: 'Nemoc z oz치콏en칤', 
                icon: '驕뮖잺', 
                causes: ['radstorm', 'high_radiation'],
                causeDesc: 'Radia캜n칤 bou콏e nebo vysok치 radiace (60+)',
                chance: 0.20,
                duration: 259200000, // 72 hodin (3 dny)
                effects: { 
                    hpDrain: 2,
                    maxHpMod: 0.7,
                    radGain: 1.5
                },
                cures: ['radaway', 'radaway_super'],
                desc: 'T캩쬶치 nemoc z radiace. -2 HP/30min, -30% max HP, +50% zisk radiace.',
                severity: 3
            },
            { 
                id: 'infection', 
                name: 'Infekce', 
                icon: '游', 
                causes: ['combat_wound'],
                causeDesc: 'Zran캩n칤 v boji (HP pod 30%)',
                chance: 0.15,
                duration: 129600000, // 36 hodin (1.5 dne)
                effects: { 
                    hpDrain: 1,
                    maxHpMod: 0.9
                },
                cures: ['antibiotics', 'herbal_medicine', 'medkit'],
                desc: 'Infikovan치 r치na. -1 HP/30min, -10% max HP.',
                severity: 2
            },
            { 
                id: 'food_poisoning', 
                name: 'Otrava j칤dlem', 
                icon: '游뱙', 
                causes: ['spoiled_food', 'raw_meat'],
                causeDesc: 'Zka쬰n칠 j칤dlo nebo syrov칠 maso',
                chance: 0.35,
                duration: 86400000, // 24 hodin (1 den)
                effects: { 
                    hungerDrain: 2.0,
                    energyDrain: 1.5,
                    moodMod: 0.7
                },
                cures: ['herbal_tea', 'purified_water', 'herbal_medicine'],
                desc: '콯alude캜n칤 pot칤쬰. 2x rychlej코칤 hlad, n칤zk치 n치lada.',
                severity: 1
            }
        ];
        
        // === SYST칄M ZRAN캨N칈 ===
        const INJURIES = [
            { 
                id: 'bruise', 
                name: 'Mod콏ina', 
                icon: '游릮', 
                causes: ['combat', 'travel'],
                causeDesc: 'Lehk칳 칰der v boji nebo p치d p콏i cestov치n칤',
                chance: 0.15,
                duration: 43200000, // 12 hodin
                effects: { 
                    damageMod: 0.95
                },
                cures: ['bandage', 'medkit', 'rest'],
                desc: 'Bolestiv치 mod콏ina. -5% damage.',
                severity: 1
            },
            { 
                id: 'cut', 
                name: '콎ezn치 r치na', 
                icon: '游뽖', 
                causes: ['combat'],
                causeDesc: 'Z치sah ostrou zbran칤 v boji',
                chance: 0.12,
                duration: 86400000, // 24 hodin
                effects: { 
                    hpDrain: 1,
                    bleedChance: 0.1
                },
                cures: ['bandage', 'medkit', 'herbal_medicine'],
                desc: 'Krv치cej칤c칤 r치na. -1 HP/30min, 코ance na krv치cen칤 v boji.',
                severity: 2
            },
            { 
                id: 'sprain', 
                name: 'V칳ron', 
                icon: '游붰', 
                causes: ['travel', 'combat'],
                causeDesc: '맗atn칳 do코lap p콏i cestov치n칤 nebo boji',
                chance: 0.08,
                duration: 172800000, // 48 hodin
                effects: { 
                    speedMod: 0.7,
                    dodgeMod: 0.8
                },
                cures: ['bandage', 'medkit', 'rest'],
                desc: 'Vyvrtnut칳 kotn칤k. -30% rychlost, -20% 칰hyb.',
                severity: 2
            },
            { 
                id: 'fracture', 
                name: 'Zlomenina', 
                icon: '游붮', 
                causes: ['combat_heavy', 'fall'],
                causeDesc: 'T캩쬶칳 칰der v boji nebo p치d z v칳코ky',
                chance: 0.05,
                duration: 259200000, // 72 hodin (3 dny)
                effects: { 
                    damageMod: 0.7,
                    speedMod: 0.5,
                    defenseMod: 0.8
                },
                cures: ['splint', 'medkit', 'doctor'],
                desc: 'Zlomen치 kost. -30% damage, -50% rychlost, -20% obrana.',
                severity: 3
            },
            { 
                id: 'concussion', 
                name: 'Ot콏es mozku', 
                icon: '游뱃', 
                causes: ['combat_head'],
                causeDesc: '칔der do hlavy v boji',
                chance: 0.06,
                duration: 129600000, // 36 hodin
                effects: { 
                    critMod: 0.5,
                    perceptionMod: 0.7,
                    energyDrain: 1.3
                },
                cures: ['medkit', 'rest', 'doctor'],
                desc: 'Ot콏es mozku. -50% kritick치 코ance, -30% vn칤m치n칤.',
                severity: 3
            },
            { 
                id: 'burn', 
                name: 'Pop치lenina', 
                icon: '游댠', 
                causes: ['fire', 'explosion'],
                causeDesc: 'Ohe켿 nebo exploze',
                chance: 0.10,
                duration: 172800000, // 48 hodin
                effects: { 
                    hpDrain: 1,
                    defenseMod: 0.85
                },
                cures: ['bandage', 'medkit', 'burn_cream'],
                desc: 'Pop치len치 k콢쬰. -1 HP/30min, -15% obrana.',
                severity: 2
            },
            { 
                id: 'exhaustion', 
                name: 'Vy캜erp치n칤', 
                icon: '游땰', 
                causes: ['travel_long', 'combat_long'],
                causeDesc: 'Dlouh칠 cestov치n칤 nebo vy캜erp치vaj칤c칤 boj',
                chance: 0.10,
                duration: 86400000, // 24 hodin
                effects: { 
                    energyDrain: 2.0,
                    damageMod: 0.9,
                    speedMod: 0.85
                },
                cures: ['rest', 'energy', 'stimpack'],
                desc: 'Fyzick칠 vy캜erp치n칤. 2x 칰bytek energie, -10% damage.',
                severity: 1
            }
        ];
        
        // === VOZIDLA ===
        // === KOMPANIONI ===
        const COMPANIONS = [
            // === QUESTOV칈 SPOLE캛N칈CI ===
            { id: 'survivor', name: 'P콏e쬴v코칤', icon: '游똂', hp: 80, damage: 12, defense: 8, 
              ability: 'P콏e쬴v코칤', abilityDesc: 'Osvobozen칳 zajatec, vd캩캜n칳 za z치chranu', cost: 0, type: 'human' },
            
            // === ZV칈콎ATA (z event콢 - zdarma) ===
            { id: 'dog', name: 'V캩rn칳 pes', icon: '游냇', hp: 40, damage: 8, defense: 3, 
              ability: '캛much치n칤', abilityDesc: '+15% 코ance na vyhnut칤 se boji', cost: 0, type: 'animal' },
            { id: 'cat', name: 'Mazan치 ko캜ka', icon: '游낻', hp: 25, damage: 5, defense: 2,
              ability: 'My코ilov', abilityDesc: '+10% 코ance na loot', cost: 0, type: 'animal' },
            { id: 'crow', name: 'Bystr칳 havran', icon: '游분', hp: 20, damage: 4, defense: 1,
              ability: 'Pr콢zkum', abilityDesc: '+20% 코ance naj칤t skryt칠 v캩ci', cost: 0, type: 'animal' },
            
            // === LID칄 (kupovateln칤) ===
            { id: 'scout', name: 'Zv캩d', icon: '游끢', hp: 60, damage: 10, defense: 5, 
              ability: 'Rychl칳 pr콢zkum', abilityDesc: '+3% rychlost cestov치n칤', cost: 800, type: 'human' },
            { id: 'medic_npc', name: 'Poln칤 medik', icon: '游녿꽥뚯勇', hp: 45, damage: 5, defense: 3, 
              ability: 'L칠캜en칤', abilityDesc: '+5 HP po ka쬯칠m boji', cost: 1000, type: 'human' },
            { id: 'warrior', name: 'V치le캜n칤k', icon: '丘덢잺', hp: 80, damage: 15, defense: 8, 
              ability: 'Bojovn칤k', abilityDesc: '+20% damage v boji', cost: 1200, type: 'human' },
            { id: 'trader_npc', name: 'Obchodn칤k', icon: '游눺', hp: 35, damage: 5, defense: 2, 
              ability: 'Smlouv치n칤', abilityDesc: '+15% lep코칤 ceny', cost: 600, type: 'human' },
            { id: 'engineer_npc', name: 'Technik', icon: '游댢', hp: 50, damage: 7, defense: 4, 
              ability: 'Opravy', abilityDesc: 'Opravuje vybaven칤 zdarma', cost: 900, type: 'human' }
        ];
        
        // === COMPANION SKILL TREES ===
        const COMPANION_SKILL_TREES = {
            // === PES ===
            dog: {
                name: 'V캩rn칳 pes',
                icon: '游냇',
                trees: {
                    combat: {
                        name: 'Bojovn칤k',
                        icon: '丘덢잺',
                        color: '#c62828',
                        skills: [
                            { id: 'bite', name: 'Siln칳 kousanec', icon: '游붱', desc: '+1 damage', effect: { damage: 1 }, tier: 1 },
                            { id: 'pack_hunter', name: 'Sme캜kov칳 lovec', icon: '游냨', desc: '+3% crit 코ance', effect: { critChance: 0.03 }, tier: 2, requires: 'bite' },
                            { id: 'savage', name: 'Divokost', icon: '游눡', desc: '+2 damage, -1 defense', effect: { damage: 2, defense: -1 }, tier: 3, requires: 'pack_hunter' }
                        ]
                    },
                    survival: {
                        name: 'P콏e쬴t칤',
                        icon: '游눜',
                        color: '#4caf50',
                        skills: [
                            { id: 'thick_fur', name: 'Hust치 srst', icon: '游붉', desc: '+5 HP', effect: { hp: 5 }, tier: 1 },
                            { id: 'scavenger_nose', name: '캛much치n칤', icon: '游녞', desc: '+5% 코ance na loot', effect: { lootChance: 0.05 }, tier: 2, requires: 'thick_fur' },
                            { id: 'loyal', name: 'V캩rnost', icon: '仇벒잺', desc: '+1 HP regenerace po boji', effect: { regenAfterCombat: 1 }, tier: 3, requires: 'scavenger_nose' }
                        ]
                    },
                    utility: {
                        name: 'U쬴te캜nost',
                        icon: '游댢',
                        color: '#ff9800',
                        skills: [
                            { id: 'guard', name: 'Hl칤da캜', icon: '游녜勇', desc: '-5% 코ance na p콏epaden칤', effect: { ambushReduction: 0.05 }, tier: 1 },
                            { id: 'tracker', name: 'Stopa콏', icon: '游', desc: '+1% rychlost cestov치n칤', effect: { travelSpeed: 0.01 }, tier: 2, requires: 'guard' },
                            { id: 'fetch', name: 'Aport', icon: '游붮', desc: 'Mal치 코ance naj칤t loot po boji', effect: { fetchLoot: true }, tier: 3, requires: 'tracker' }
                        ]
                    }
                }
            },
            // === KO캛KA ===
            cat: {
                name: 'Mazan치 ko캜ka',
                icon: '游낻',
                trees: {
                    stealth: {
                        name: 'Nen치padnost',
                        icon: '游녻',
                        color: '#9c27b0',
                        skills: [
                            { id: 'silent_paws', name: 'Tich칠 tlapky', icon: '游', desc: '-3% 코ance na p콏epaden칤', effect: { ambushReduction: 0.03 }, tier: 1 },
                            { id: 'shadow', name: 'St칤n', icon: '游깸', desc: '+5% 칰hyb v boji', effect: { dodgeChance: 0.05 }, tier: 2, requires: 'silent_paws' },
                            { id: 'assassin', name: 'Zabij치k', icon: '游디勇', desc: '+10% crit damage', effect: { critDamage: 0.1 }, tier: 3, requires: 'shadow' }
                        ]
                    },
                    hunter: {
                        name: 'Lovec',
                        icon: '游꿢',
                        color: '#ff5722',
                        skills: [
                            { id: 'mouser', name: 'My코ilov', icon: '游냜', desc: '+3% 코ance na loot', effect: { lootChance: 0.03 }, tier: 1 },
                            { id: 'predator', name: 'Pred치tor', icon: '游낹', desc: '+2 damage', effect: { damage: 2 }, tier: 2, requires: 'mouser' },
                            { id: 'nine_lives', name: 'Dev캩t 쬴vot콢', icon: '九', desc: '5% 코ance p콏e쮂셦 smrteln칳 칰tok', effect: { surviveChance: 0.05 }, tier: 3, requires: 'predator' }
                        ]
                    },
                    charm: {
                        name: '마rm',
                        icon: '游눗',
                        color: '#e91e63',
                        skills: [
                            { id: 'cute', name: 'Roztomilost', icon: '游떁', desc: '+3% lep코칤 ceny', effect: { priceBonus: 0.03 }, tier: 1 },
                            { id: 'luck_cat', name: 'Ko캜i캜칤 코t캩st칤', icon: '游', desc: '+3% 코ance na vz치cn칳 loot', effect: { rareChance: 0.03 }, tier: 2, requires: 'cute' },
                            { id: 'blessing', name: 'Po쬰hn치n칤', icon: '救', desc: '+2% XP bonus', effect: { xpBonus: 0.02 }, tier: 3, requires: 'luck_cat' }
                        ]
                    }
                }
            },
            // === HAVRAN ===
            crow: {
                name: 'Bystr칳 havran',
                icon: '游분',
                trees: {
                    scout: {
                        name: 'Pr콢zkum',
                        icon: '游댨',
                        color: '#2196f3',
                        skills: [
                            { id: 'eagle_eye', name: 'Orl칤 zrak', icon: '游녜勇', desc: '-3% 코ance na p콏epaden칤', effect: { ambushReduction: 0.03 }, tier: 1 },
                            { id: 'warning', name: 'Varov치n칤', icon: '丘멆잺', desc: 'Upozorn칤 na nep콏치tele p콏edem', effect: { enemyWarning: true }, tier: 2, requires: 'eagle_eye' },
                            { id: 'treasure_hunter', name: 'Lovec poklad콢', icon: '游눑', desc: '+5% 코ance naj칤t skryt칠 v캩ci', effect: { hiddenChance: 0.05 }, tier: 3, requires: 'warning' }
                        ]
                    },
                    trickster: {
                        name: '말bal',
                        icon: '游꿠',
                        color: '#673ab7',
                        skills: [
                            { id: 'distract', name: 'Rozpt칳len칤', icon: '游눪', desc: 'Nep콏칤tel m치 -3% p콏esnost', effect: { enemyAccuracy: -0.03 }, tier: 1 },
                            { id: 'steal', name: 'Kr치de', icon: '游봉', desc: '3% 코ance ukr치st item v boji', effect: { stealChance: 0.03 }, tier: 2, requires: 'distract' },
                            { id: 'mimic', name: 'Napodoben칤', icon: '游딖勇', desc: 'M콢쬰 zastra코it slab코칤 nep콏치tele', effect: { intimidate: true }, tier: 3, requires: 'steal' }
                        ]
                    },
                    wisdom: {
                        name: 'Moudrost',
                        icon: '游닄',
                        color: '#009688',
                        skills: [
                            { id: 'memory', name: 'Pam캩콘', icon: '游', desc: '+3% XP z boj콢', effect: { xpBonus: 0.03 }, tier: 1 },
                            { id: 'ancient', name: 'Starod치vn칳', icon: '游닆', desc: 'Odhal칤 quest lokace', effect: { questReveal: true }, tier: 2, requires: 'memory' },
                            { id: 'oracle', name: 'V캩코tec', icon: '游댩', desc: 'P콏edpov칤 po캜as칤 a eventy', effect: { prediction: true }, tier: 3, requires: 'ancient' }
                        ]
                    }
                }
            },
            // === ZV캨D ===
            scout: {
                name: 'Zv캩d',
                icon: '游끢',
                trees: {
                    speed: {
                        name: 'Rychlost',
                        icon: '游눧',
                        color: '#00bcd4',
                        skills: [
                            { id: 'swift', name: 'Hbitost', icon: '游끢', desc: '+1% rychlost cestov치n칤', effect: { travelSpeed: 0.01 }, tier: 1 },
                            { id: 'parkour', name: 'Parkour', icon: '游븽', desc: 'Ignoruje ter칠nn칤 postihy', effect: { ignoreTerrrain: true }, tier: 2, requires: 'swift' },
                            { id: 'flash', name: 'Blesk', icon: '丘', desc: 'Prvn칤 칰tok v boji m치 +50% crit', effect: { firstStrikeCrit: true }, tier: 3, requires: 'parkour' }
                        ]
                    },
                    combat: {
                        name: 'Boj',
                        icon: '丘덢잺',
                        color: '#f44336',
                        skills: [
                            { id: 'dual_wield', name: 'Dvoj칤 zbra켿', icon: '游디勇', desc: '+2 damage', effect: { damage: 2 }, tier: 1 },
                            { id: 'precision', name: 'P콏esnost', icon: '游꿢', desc: '+3% crit 코ance', effect: { critChance: 0.03 }, tier: 2, requires: 'dual_wield' },
                            { id: 'deadly', name: 'Smrt칤c칤', icon: '游', desc: '+15% crit damage', effect: { critDamage: 0.15 }, tier: 3, requires: 'precision' }
                        ]
                    },
                    survival: {
                        name: 'P콏e쬴t칤',
                        icon: '游끳勇',
                        color: '#8bc34a',
                        skills: [
                            { id: 'endurance', name: 'V칳dr', icon: '游눩', desc: '+8 HP', effect: { hp: 8 }, tier: 1 },
                            { id: 'resourceful', name: 'Vynal칠zavost', icon: '游', desc: '+5% 코ance na dvojit칳 loot', effect: { doubleLoot: 0.05 }, tier: 2, requires: 'endurance' },
                            { id: 'survivor', name: 'P콏e쬴v코칤', icon: '游끥', desc: 'Regeneruje 3 HP po boji', effect: { regenAfterCombat: 3 }, tier: 3, requires: 'resourceful' }
                        ]
                    }
                }
            },
            // === MEDIK ===
            medic_npc: {
                name: 'Poln칤 medik',
                icon: '游녿꽥뚯勇',
                trees: {
                    healing: {
                        name: 'L칠캜en칤',
                        icon: '游눜',
                        color: '#4caf50',
                        skills: [
                            { id: 'first_aid', name: 'Prvn칤 pomoc', icon: '游뽗', desc: '+3 HP hr치캜i po boji', effect: { healPlayerAfterCombat: 3 }, tier: 1 },
                            { id: 'medic_expert', name: 'Expert', icon: '游눌', desc: '+15% efekt l칠캜iv칳ch item콢', effect: { healingBonus: 0.15 }, tier: 2, requires: 'first_aid' },
                            { id: 'resurrection', name: 'Vzk콏칤코en칤', icon: '九', desc: '5% 코ance p콏e쮂셦 smrt', effect: { resurrectChance: 0.05 }, tier: 3, requires: 'medic_expert' }
                        ]
                    },
                    support: {
                        name: 'Podpora',
                        icon: '游띠勇',
                        color: '#2196f3',
                        skills: [
                            { id: 'inspire', name: 'Inspirace', icon: '游닉', desc: '+1 damage v코em', effect: { partyDamage: 1 }, tier: 1 },
                            { id: 'protect', name: 'Ochrana', icon: '游띠勇', desc: '+1 defense hr치캜i', effect: { playerDefense: 1 }, tier: 2, requires: 'inspire' },
                            { id: 'aura', name: 'L칠캜iv치 aura', icon: '游눪', desc: '+1 HP/min regenerace', effect: { regenPerMin: 1 }, tier: 3, requires: 'protect' }
                        ]
                    },
                    alchemy: {
                        name: 'Alchymie',
                        icon: '丘勇',
                        color: '#9c27b0',
                        skills: [
                            { id: 'herbs', name: 'Bylink치콏', icon: '游', desc: '+1 herbs p콏i sb캩ru', effect: { herbBonus: 1 }, tier: 1 },
                            { id: 'antidote', name: 'Protijed', icon: '游빍', desc: '-5% radiace po boji', effect: { radReduction: 0.05 }, tier: 2, requires: 'herbs' },
                            { id: 'elixir', name: 'Elix칤ry', icon: '游꽁', desc: 'M콢쬰 vytvo콏it vz치cn칠 lektvary', effect: { rareRecipes: true }, tier: 3, requires: 'antidote' }
                        ]
                    }
                }
            },
            // === V츼LE캛N칈K ===
            warrior: {
                name: 'V치le캜n칤k',
                icon: '丘덢잺',
                trees: {
                    offense: {
                        name: '칔tok',
                        icon: '丘덢잺',
                        color: '#c62828',
                        skills: [
                            { id: 'power', name: 'S칤la', icon: '游눩', desc: '+3 damage', effect: { damage: 3 }, tier: 1 },
                            { id: 'cleave', name: 'Rozseknout', icon: '游뿝', desc: '칔to캜칤 na 2 nep콏치tele', effect: { multiTarget: 2 }, tier: 2, requires: 'power' },
                            { id: 'execute', name: 'Poprava', icon: '游', desc: '+25% damage na nep콏치tele pod 20% HP', effect: { executeBonus: 0.25 }, tier: 3, requires: 'cleave' }
                        ]
                    },
                    defense: {
                        name: 'Obrana',
                        icon: '游띠勇',
                        color: '#1976d2',
                        skills: [
                            { id: 'armor', name: 'Zbroj', icon: '游띠勇', desc: '+2 defense', effect: { defense: 2 }, tier: 1 },
                            { id: 'tank', name: 'Tank', icon: '游낋', desc: '+10 HP', effect: { hp: 10 }, tier: 2, requires: 'armor' },
                            { id: 'shield_wall', name: '맚칤tov치 ze캞', icon: '游빔', desc: '10% 코ance blokovat 칰tok na hr치캜e', effect: { blockForPlayer: 0.1 }, tier: 3, requires: 'tank' }
                        ]
                    },
                    rage: {
                        name: 'Zu콏ivost',
                        icon: '游눡',
                        color: '#ff5722',
                        skills: [
                            { id: 'fury', name: 'Zu콏ivost', icon: '游땫', desc: '+5% damage p콏i n칤zk칠m HP', effect: { lowHpDamage: 0.05 }, tier: 1 },
                            { id: 'berserk', name: 'Berserk', icon: '游댠', desc: '+8% damage, -3% defense', effect: { damage: 0.08, defense: -0.03 }, tier: 2, requires: 'fury' },
                            { id: 'unstoppable', name: 'Nezastaviteln칳', icon: '丘', desc: 'Nem콢쬰 b칳t omr치캜en', effect: { stunImmune: true }, tier: 3, requires: 'berserk' }
                        ]
                    }
                }
            },
            // === OBCHODN칈K ===
            trader_npc: {
                name: 'Obchodn칤k',
                icon: '游눺',
                trees: {
                    bargain: {
                        name: 'Smlouv치n칤',
                        icon: '游눯',
                        color: '#ffd700',
                        skills: [
                            { id: 'haggle', name: 'Smlouv치n칤', icon: '游딖勇', desc: '-3% n치kupn칤 ceny', effect: { buyDiscount: 0.03 }, tier: 1 },
                            { id: 'sell_high', name: 'Prodat draze', icon: '游늳', desc: '+5% prodejn칤 ceny', effect: { sellBonus: 0.05 }, tier: 2, requires: 'haggle' },
                            { id: 'master_trader', name: 'Mistr obchodu', icon: '游녬', desc: 'Speci치ln칤 zbo쮂 v obchodech', effect: { specialItems: true }, tier: 3, requires: 'sell_high' }
                        ]
                    },
                    connections: {
                        name: 'Kontakty',
                        icon: '游뱋',
                        color: '#9c27b0',
                        skills: [
                            { id: 'network', name: 'S칤콘 kontakt콢', icon: '游님', desc: '+5% 코ance na karavanu', effect: { caravanChance: 0.05 }, tier: 1 },
                            { id: 'reputation', name: 'Reputace', icon: '救', desc: '+1 reputace se v코emi frakcemi', effect: { repBonus: 1 }, tier: 2, requires: 'network' },
                            { id: 'diplomat', name: 'Diplomat', icon: '游뎱勇', desc: 'M콢쬰 usm칤콏it nep콏치telsk칠 frakce', effect: { peacemaker: true }, tier: 3, requires: 'reputation' }
                        ]
                    },
                    appraisal: {
                        name: 'Odhad',
                        icon: '游댌',
                        color: '#00bcd4',
                        skills: [
                            { id: 'identify', name: 'Identifikace', icon: '游낑勇', desc: 'Uk치쬰 pravou hodnotu item콢', effect: { showValue: true }, tier: 1 },
                            { id: 'treasure_sense', name: 'Smysl pro poklady', icon: '游눑', desc: '+5% 코ance na vz치cn칳 loot', effect: { rareChance: 0.05 }, tier: 2, requires: 'identify' },
                            { id: 'golden_touch', name: 'Zlat칳 dotyk', icon: '九', desc: '+8% pen캩z z lootu', effect: { moneyBonus: 0.08 }, tier: 3, requires: 'treasure_sense' }
                        ]
                    }
                }
            },
            // === TECHNIK ===
            engineer_npc: {
                name: 'Technik',
                icon: '游댢',
                trees: {
                    repair: {
                        name: 'Opravy',
                        icon: '游댢',
                        color: '#ff9800',
                        skills: [
                            { id: 'quick_fix', name: 'Rychl치 oprava', icon: '游댤', desc: 'Oprav칤 vybaven칤 po boji', effect: { autoRepair: true }, tier: 1 },
                            { id: 'reinforce', name: 'Zpevn캩n칤', icon: '游멆잺', desc: '+5% trvanlivost vybaven칤', effect: { durabilityBonus: 0.05 }, tier: 2, requires: 'quick_fix' },
                            { id: 'masterwork', name: 'Mistrovsk치 pr치ce', icon: '救', desc: 'M콢쬰 vylep코it vybaven칤', effect: { canUpgrade: true }, tier: 3, requires: 'reinforce' }
                        ]
                    },
                    crafting: {
                        name: 'V칳roba',
                        icon: '游낈',
                        color: '#795548',
                        skills: [
                            { id: 'efficient', name: 'Efektivita', icon: '游닍', desc: '-5% surovin na crafting', effect: { craftCostReduction: 0.05 }, tier: 1 },
                            { id: 'quality', name: 'Kvalita', icon: '游눑', desc: '+5% stats vyroben칳m v캩cem', effect: { craftBonus: 0.05 }, tier: 2, requires: 'efficient' },
                            { id: 'innovate', name: 'Inovace', icon: '游눠', desc: 'Odemkne speci치ln칤 recepty', effect: { specialRecipes: true }, tier: 3, requires: 'quality' }
                        ]
                    },
                    gadgets: {
                        name: 'Gadgety',
                        icon: '丘뙖잺',
                        color: '#607d8b',
                        skills: [
                            { id: 'trap', name: 'Bojov칠 pasti', icon: '游뿫', desc: 'Na za캜치tku boje past automaticky zas치hne nep콏칤tele za 15-30 DMG', effect: { canTrap: true }, tier: 1 },
                            { id: 'turret', name: 'V캩쬴캜ka', icon: '游댦', desc: 'Automaticky +5 DMG ka쬯칠 kolo boje', effect: { turretDamage: 5 }, tier: 2, requires: 'trap' },
                            { id: 'robot', name: 'Bojov칳 robot', icon: '游뱄', desc: 'Robot bojuje na tv칠 stran캩 (+20 DMG ka쬯칠 kolo, automaticky)', effect: { canBuildRobot: true }, tier: 3, requires: 'turret' }
                        ]
                    }
                }
            },
            // === GENERICK칗 SURVIVOR (pro dynamick칠 companiony jako freed_slave) ===
            survivor: {
                name: 'P콏e쬴v코칤',
                icon: '游똂',
                trees: {
                    combat: {
                        name: 'Boj',
                        icon: '丘덢잺',
                        color: '#c62828',
                        skills: [
                            { id: 'desperate_strike', name: 'Zoufal칳 칰der', icon: '游눡', desc: '+4 damage', effect: { damage: 4 }, tier: 1 },
                            { id: 'will_to_live', name: 'V콢le k 쬴votu', icon: '游눩', desc: '+20 HP', effect: { hp: 20 }, tier: 2, requires: 'desperate_strike' },
                            { id: 'revenge', name: 'Pomsta', icon: '游댠', desc: '+25% damage kdy pod 50% HP', effect: { lowHpDamage: 0.25 }, tier: 3, requires: 'will_to_live' }
                        ]
                    },
                    survival: {
                        name: 'P콏e쬴t칤',
                        icon: '游끳勇',
                        color: '#4caf50',
                        skills: [
                            { id: 'scavenger', name: 'Sb캩ra캜', icon: '游', desc: '+15% 코ance na loot', effect: { lootChance: 0.15 }, tier: 1 },
                            { id: 'resourceful', name: 'Vynal칠zavost', icon: '游댢', desc: '-20% spot콏eba j칤dla/vody', effect: { consumptionReduction: 0.2 }, tier: 2, requires: 'scavenger' },
                            { id: 'hardened', name: 'Zocelen칳', icon: '游띠勇', desc: '+5 defense', effect: { defense: 5 }, tier: 3, requires: 'resourceful' }
                        ]
                    },
                    support: {
                        name: 'Podpora',
                        icon: '游뱋',
                        color: '#2196f3',
                        skills: [
                            { id: 'gratitude', name: 'Vd캩캜nost', icon: '仇벒잺', desc: '+10 loajalita', effect: { loyalty: 10 }, tier: 1 },
                            { id: 'teamwork', name: 'T칳mov치 pr치ce', icon: '游논', desc: '+2 damage v코em spole캜n칤k콢m', effect: { partyDamage: 2 }, tier: 2, requires: 'gratitude' },
                            { id: 'guardian', name: 'Str치쬮e', icon: '游띠勇', desc: '20% 코ance zablokovat 칰tok na hr치캜e', effect: { blockForPlayer: 0.2 }, tier: 3, requires: 'teamwork' }
                        ]
                    }
                }
            }
        };
        
        // XP pot콏ebn칠 pro level spole캜n칤ka
        const COMPANION_XP_TABLE = [0, 50, 120, 220, 350, 520, 730, 980, 1280, 1630]; // Level 1-10
        
        // Max po캜et spole캜n칤k콢 podle levelu hr치캜e
        function getMaxCompanions() {
            const level = state.char?.level || 1;
            if (level >= 10) return 5;
            if (level >= 7) return 4;
            if (level >= 5) return 3;
            if (level >= 3) return 2;
            return 1;
        }
        
        // P콏id치 spole캜n칤ka s mo쬹ost칤 v칳m캩ny pokud je plno
        function addCompanionWithSwap(newCompanion, source = 'event') {
            state.companions = state.companions || [];
            
            if (state.companions.length < getMaxCompanions()) {
                // M칤sto je voln칠 - rovnou p콏idej
                state.companions.push(newCompanion);
                notifySuccess('Nov칳 spole캜n칤k!', `${newCompanion.name} se p콏idal k tob캩!`);
                addLog(`${newCompanion.icon || '游녻'} ${newCompanion.name} se p콏ipojil!`, newCompanion.icon || '游녻');
                saveGame();
                renderFull();
                return true;
            }
            
            // Plno - nab칤dni v칳m캩nu
            showCompanionSwapModal(newCompanion, source);
            return false;
        }
        
        function showCompanionSwapModal(newCompanion, source) {
            const newIcon = newCompanion.icon || '游녻';
            const newName = newCompanion.name || 'Nov칳 spole캜n칤k';
            
            let companionsHtml = state.companions.map(comp => {
                const compIcon = comp.icon || COMPANIONS.find(c => c.id === comp.id)?.icon || '游녻';
                const compName = comp.name || COMPANIONS.find(c => c.id === comp.id)?.name || 'Spole캜n칤k';
                const level = comp.level || 1;
                const compUniqueId = comp.uniqueId || comp.id;
                
                return `
                    <div onclick="swapCompanion('${compUniqueId}')" 
                         style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border: 2px solid #444; transition: all 0.2s;"
                         onmouseover="this.style.borderColor='#c62828'; this.style.background='#3a2a2a';"
                         onmouseout="this.style.borderColor='#444'; this.style.background='#2a2a2a';">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <div style="font-size: 2rem;">${compIcon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${compName}</div>
                                <div style="font-size: 0.8rem; color: #888;">
                                    Level ${level} | 仇벒잺 ${comp.hp}/${comp.maxHp} | 丘덢잺 ${getCompanionStat(comp, 'damage')} | 游띠勇 ${getCompanionStat(comp, 'defense')}
                                </div>
                            </div>
                            <div style="color: #c62828; font-size: 0.8rem;">游녦 Propustit</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ulo nov칠ho spole캜n칤ka pro swap
            window.pendingNewCompanion = newCompanion;
            
            showModal('游논 V칳m캩na spole캜n칤ka', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${newIcon}</div>
                    <h3 style="margin: 0.5rem 0; color: #4caf50;">${newName}</h3>
                    <p style="color: #888;">chce se k tob캩 p콏ipojit!</p>
                    <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0; font-size: 0.85rem;">
                        仇벒잺 ${newCompanion.hp || newCompanion.maxHp} HP | 丘덢잺 ${newCompanion.damage} DMG | 游띠勇 ${newCompanion.defense} DEF
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c62828;">
                    <p style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 0.9rem;">丘멆잺 M치코 u maximum spole캜n칤k콢 (${getMaxCompanions()})!</p>
                    <p style="color: #888; margin: 0; font-size: 0.85rem;">Vyber koho propust칤코, aby se ${newName} mohl p콏idat:</p>
                </div>
                
                <div style="max-height: 40vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${companionsHtml}
                </div>
                
                <button class="btn" onclick="cancelCompanionSwap()" style="width: 100%; margin-top: 1rem; background: #555;">
                    仇 Odm칤tnout ${newName}
                </button>
            `);
        }
        
        function swapCompanion(oldCompanionId) {
            const newCompanion = window.pendingNewCompanion;
            if (!newCompanion) {
                closeModal();
                return;
            }
            
            // Pokud je to placen칳 swap (z hire), ode캜ti pen칤ze
            if (window.pendingHireCompanion && window.pendingHireCompanion.companion === newCompanion) {
                removeMoney(window.pendingHireCompanion.cost);
                window.pendingHireCompanion = null;
            }
            
            // Najdi a odeber star칠ho spole캜n칤ka - hledej podle id nebo uniqueId
            const oldIndex = state.companions.findIndex(c => c.id === oldCompanionId || c.uniqueId === oldCompanionId);
            if (oldIndex === -1) {
                closeModal();
                return;
            }
            
            const oldCompanion = state.companions[oldIndex];
            const oldIcon = oldCompanion.icon || COMPANIONS.find(c => c.id === oldCompanion.id)?.icon || '游녻';
            const oldName = oldCompanion.name || COMPANIONS.find(c => c.id === oldCompanion.id)?.name || 'Spole캜n칤k';
            
            // Vra콘 vybaven칤 star칠ho spole캜n칤ka do invent치콏e
            if (oldCompanion.equipped) {
                Object.values(oldCompanion.equipped).forEach(item => {
                    if (item) {
                        const existing = state.inv.find(i => i.id === item.id);
                        if (existing) {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            state.inv.push({...item, count: 1});
                        }
                    }
                });
            }
            
            // Odeber star칠ho
            state.companions.splice(oldIndex, 1);
            addLog(`${oldIcon} ${oldName} ode코el`, '游녦');
            
            // P콏idej nov칠ho s unik치tn칤m ID
            newCompanion.uniqueId = newCompanion.uniqueId || `${newCompanion.id}_${Date.now()}`;
            state.companions.push(newCompanion);
            const newIcon = newCompanion.icon || '游녻';
            const newName = newCompanion.name || 'Spole캜n칤k';
            
            notifySuccess('V칳m캩na!', `${oldName} ode코el, ${newName} se p콏idal!`);
            addLog(`${newIcon} ${newName} se p콏ipojil!`, newIcon);
            
            window.pendingNewCompanion = null;
            closeModal();
            saveGame();
            renderFull();
        }
        
        function cancelCompanionSwap() {
            // Pokud je to placen칳 swap, neode캜칤tej pen칤ze
            window.pendingHireCompanion = null;
            const newCompanion = window.pendingNewCompanion;
            if (newCompanion) {
                const newName = newCompanion.name || 'Spole캜n칤k';
                notifyWarning('Odm칤tnuto', `${newName} ode코el.`);
                addLog(`Odm칤tnut: ${newName}`, '游녦');
            }
            window.pendingNewCompanion = null;
            closeModal();
        }
        
        // === SPECI츼LN칈 SCHOPNOSTI POVOL츼N칈 ===
        const CLASS_ABILITIES = {
            scavenger: { name: 'Bystr칳 zrak', icon: '游녜勇', cooldown: 300, desc: 'Odhal칤 v코echen loot na aktu치ln칤m hexu', action: 'revealLoot' },
            raider: { name: 'Zu콏ivost', icon: '游눡', cooldown: 180, desc: '+50% damage na 1 boj', action: 'rage' },
            berserker: { name: 'Krvav치 l치ze켿', icon: '游뽖', cooldown: 240, desc: 'P콏칤코t칤 칰tok zas치hne v코echny nep콏치tele', action: 'bloodbath' },
            medic: { name: 'Rychl칠 l칠캜en칤', icon: '游눌', cooldown: 240, desc: 'Okam쬴t캩 +40 HP', action: 'quickHeal' },
            engineer: { name: 'Nouzov치 oprava', icon: '游댢', cooldown: 300, desc: 'Oprav칤 vybaven칤 o 30%', action: 'emergencyRepair' },
            stalker: { name: 'Neviditelnost', icon: '游녻', cooldown: 360, desc: 'Vyhne코 se dal코칤mu nep콏칤teli', action: 'stealth' },
            survivor: { name: 'Druh칳 dech', icon: '游눧', cooldown: 600, desc: 'Obnov칤 50% HP kdy pod 20%', action: 'secondWind' },
            trader: { name: 'Zlat칳 jazyk', icon: '游딖勇', cooldown: 180, desc: '-30% ceny na 5 minut', action: 'haggle' },
            assassin: { name: 'Smrt칤c칤 칰der', icon: '游디勇', cooldown: 300, desc: 'Garantovan칳 kritick칳 z치sah', action: 'deathStrike' },
            tank: { name: '콯elezn치 k콢쬰', icon: '游띠勇', cooldown: 240, desc: 'Blokuje 100% damage na 1 kolo', action: 'ironSkin' },
            alchemist: { name: 'Jedovat칳 oblak', icon: '驕멆잺', cooldown: 300, desc: 'Otr치v칤코 v코echny nep콏치tele na 3 kola', action: 'poisonCloud' },
            hunter: { name: 'Stopov치n칤', icon: '游', cooldown: 180, desc: 'Najde nejbli쮄뫆 zv칤콏e na map캩', action: 'track' },
            demolitionist: { name: 'Mega bomba', icon: '游눢', cooldown: 360, desc: '100 damage v코em nep콏치tel콢m', action: 'megaBomb' },
            nomad: { name: 'Pou코tn칤 v칤tr', icon: '游끺勇', cooldown: 120, desc: 'Okam쬴t캩 dokon캜칤 cestov치n칤', action: 'desertWind' },
            mutant: { name: 'Radia캜n칤 v칳buch', icon: '驕뮖잺', cooldown: 300, desc: '50 damage + radiace nep콏치tel콢m', action: 'radBurst' },
            psychic: { name: 'Ment치ln칤 칰tok', icon: '游댩', cooldown: 240, desc: 'Nep콏칤tel p콏esko캜칤 tah', action: 'mindBlast' }
        };
        
        // === ALCHYMIE/VA콎EN칈 ===
        const RECIPES = [
            // Va콏en칤
            { id: 'cooked_meat', name: 'Pe캜en칠 maso', icon: '游꼤', type: 'cooking', requires: { raw_meat: 1 }, result: { effect: 'hunger', value: 50 }, desc: 'V칳쬴vn캩j코칤 ne syrov칠' },
            { id: 'grilled_fish', name: 'Grilovan치 ryba', icon: '游', type: 'cooking', requires: { fish: 1 }, result: { effect: 'hunger', value: 45, bonus: 'thirst', bonusValue: 10 }, desc: 'Lehk칠 j칤dlo' },
            { id: 'steak', name: 'Steak', icon: '游볼', type: 'cooking', requires: { raw_meat: 2 }, result: { effect: 'hunger', value: 60, bonus: 'hp', bonusValue: 20 }, desc: 'Po콏치dn칠 j칤dlo' },
            { id: 'stew', name: 'Gul치코', icon: '游', type: 'cooking', requires: { raw_meat: 4, herbs: 2 }, result: { effect: 'hunger', value: 100, bonus: 'hp', bonusValue: 65 }, desc: 'Nejlep코칤 j칤dlo!' },
            { id: 'fish_soup', name: 'Ryb칤 pol칠vka', icon: '游꼪', type: 'cooking', requires: { fish: 2 }, result: { effect: 'hunger', value: 60, bonus: 'thirst', bonusValue: 40 }, desc: 'Zah콏eje a nasyt칤' },
            { id: 'jerky', name: 'Su코en칠 maso', icon: '游볩', type: 'cooking', requires: { raw_meat: 2 }, result: { effect: 'hunger', value: 55, stackable: true }, desc: 'Vydr쮂 dlouho' },
            
            // Lektvary
            { id: 'health_potion', name: 'L칠캜iv칳 lektvar', icon: '仇벒잺', type: 'alchemy', requires: { herbs: 2 }, result: { effect: 'health', value: 50 }, desc: 'Rychl칠 l칠캜en칤' },
            { id: 'energy_potion', name: 'Energetick칳 lektvar', icon: '丘', type: 'alchemy', requires: { herbs: 1 }, result: { effect: 'energy', value: 70 }, desc: 'Obnov칤 energii' },
            { id: 'antidote', name: 'Protijed', icon: '游빍', type: 'alchemy', requires: { herbs: 3 }, result: { effect: 'radiation', value: -40 }, desc: 'Siln칳 anti-rad' },
            { id: 'strength_elixir', name: 'Elix칤r s칤ly', icon: '游눩', type: 'alchemy', requires: { herbs: 2, raw_meat: 1 }, result: { effect: 'buff', buff: 'strength', value: 3, duration: 7200 }, desc: '+3 s칤la na 2 hodiny' },
            { id: 'speed_elixir', name: 'Elix칤r rychlosti', icon: '游끢', type: 'alchemy', requires: { herbs: 2 }, result: { effect: 'buff', buff: 'agility', value: 3, duration: 7200 }, desc: '+3 obratnost na 2 hodiny' },
            { id: 'luck_potion', name: 'Lektvar 코t캩st칤', icon: '游', type: 'alchemy', requires: { herbs: 3 }, result: { effect: 'buff', buff: 'luck', value: 20, duration: 7200 }, desc: '+20% loot na 2 hodiny' }
        ];
        
        // === RYBY ===
        const FISH_TYPES = [
            { id: 'small_fish', name: 'Mal치 ryba', icon: '游', rarity: 'common', chance: 0.5, value: 10, hunger: 15 },
            { id: 'medium_fish', name: 'Kapr', icon: '游', rarity: 'uncommon', chance: 0.3, value: 25, hunger: 30 },
            { id: 'big_fish', name: 'Sumec', icon: '游냐', rarity: 'rare', chance: 0.15, value: 50, hunger: 50 },
            { id: 'golden_fish', name: 'Zlat치 rybka', icon: '九', rarity: 'epic', chance: 0.04, value: 200, hunger: 20, special: 'wish' },
            { id: 'mutant_fish', name: 'Mutantn칤 ryba', icon: '驕뮖잺', rarity: 'rare', chance: 0.08, value: 30, hunger: 40, radiation: 5 },
            { id: 'boot', name: 'Star치 bota', icon: '游녹', rarity: 'common', chance: 0.2, value: 0, junk: true },
            { id: 'treasure_chest', name: 'Truhli캜ka', icon: '游닍', rarity: 'epic', chance: 0.02, value: 0, special: 'treasure' }
        ];
        
        // === RUDY A DRAHOKAMY ===
        const ORES = [
            { id: 'iron_ore', name: '콯elezn치 ruda', icon: '丘뙖잺', rarity: 'common', chance: 0.40, value: 15, smeltTo: 'metal' },
            { id: 'stone_chunk', name: 'K치men', icon: '游뿯', rarity: 'common', chance: 0.30, value: 10, smeltTo: 'stone' },
            { id: 'coal', name: 'Uhl칤', icon: '拘', rarity: 'uncommon', chance: 0.12, value: 20, smeltTo: 'fuel' },
            { id: 'scrap_metal', name: 'Star칳 코rot', icon: '鮫勇', rarity: 'uncommon', chance: 0.08, value: 15, smeltTo: 'scrap' },
            { id: 'sulfur', name: 'S칤ra', icon: '游눝', rarity: 'rare', chance: 0.05, value: 40, smeltTo: 'chemicals' },
            { id: 'quartz', name: 'K콏emen', icon: '游눑', rarity: 'rare', chance: 0.03, value: 50, smeltTo: 'glass' },
            { id: 'uranium_ore', name: 'Uranov치 ruda', icon: '驕뮖잺', rarity: 'epic', chance: 0.02, value: 200, smeltTo: 'chemicals', radiation: 15 }
        ];
        
        // === ZV캨콎 PRO LOV ===
        const HUNTABLE_ANIMALS = [
            { id: 'rabbit', name: 'Kr치l칤k', icon: '游냟', hp: 10, speed: 8, loot: { meat: 1, cloth: 1 }, xp: 5 },
            { id: 'deer', name: 'Jelen', icon: '游붋', hp: 30, speed: 7, loot: { meat: 3, leather: 2 }, xp: 15 },
            { id: 'boar', name: 'Divo캜치k', icon: '游냉', hp: 50, speed: 5, loot: { meat: 4, leather: 2 }, xp: 25, aggressive: true },
            { id: 'bear', name: 'Medv캩d', icon: '游냩', hp: 100, speed: 4, loot: { meat: 6, leather: 4, fur: 3 }, xp: 50, aggressive: true },
            { id: 'wolf_pack', name: 'Sme캜ka vlk콢', icon: '游냨', hp: 80, speed: 6, loot: { meat: 3, leather: 2, fur: 2 }, xp: 40, aggressive: true, count: 3 },
            { id: 'mutant_beast', name: 'Mutantn칤 bestie', icon: '游', hp: 150, speed: 5, loot: { meat: 5, leather: 3, radx: 1 }, xp: 80, aggressive: true, radiation: 10 }
        ];
        
        // === MUTACE ===
        const MUTATIONS = [
            // Sm칤코en칠 mutace (v칳hoda + nev칳hoda)
            { id: 'thick_skin', name: 'Tlust치 k콢쬰', icon: '游붍', type: 'mixed', 
              effect: { defense: 8, agi: -1 }, 
              desc: '+8 obrany, -1 obratnost', chance: 0.15,
              positive: 'Tv치 k콢쬰 je tvrd코칤 jako krun칳콏',
              negative: 'Jsi pomalej코칤' },
              
            { id: 'eagle_eyes', name: 'Orl칤 zrak', icon: '游분', type: 'mixed', 
              effect: { perception: 3, nightPenalty: true }, 
              desc: '+3 vn칤mavost, -30% vid캩n칤 v noci', chance: 0.12,
              positive: 'Vid칤코 d치l a ost콏eji',
              negative: 'V noci jsi t칠m캩콏 slep칳' },
              
            { id: 'fast_metabolism', name: 'Rychl칳 metabolismus', icon: '丘', type: 'mixed', 
              effect: { travelSpeed: 0.1, hungerRate: 1.5, energyDrain: 1.3 }, 
              desc: '-10% 캜as cestov치n칤, +50% hlad, +30% 칰bytek energie', chance: 0.10,
              positive: 'Cestuje코 mnohem rychleji',
              negative: 'Pot콏ebuje코 v칤ce j칤dla a energie' },
              
            { id: 'night_vision', name: 'No캜n칤 vid캩n칤', icon: '游녜勇', type: 'mixed', 
              effect: { nightBonus: 0.3, dayPenalty: 0.15 }, 
              desc: '+30% stats v noci, -15% ve dne', chance: 0.08,
              positive: 'V noci vid칤코 jako ve dne',
              negative: 'Denn칤 sv캩tlo t캩 osl켿uje' },
              
            { id: 'rad_immunity', name: 'Radia캜n칤 adaptace', icon: '驕뮖잺', type: 'mixed', 
              effect: { radResist: 0.7, appearance: 'ghoul' }, 
              desc: '-70% radiace, vypad치코 jako ghoul', chance: 0.05,
              positive: 'Radiace ti t칠m캩콏 neubli쬿je',
              negative: 'Lid칠 se t캩 boj칤 (-20% ceny u obchodn칤k콢)' },
              
            { id: 'berserker_blood', name: 'Berserk콏칤 krev', icon: '游댮', type: 'mixed', 
              effect: { damageBonus: 0.25, damageTaken: 0.15 }, 
              desc: '+25% damage, +15% p콏ijat칠 damage', chance: 0.10,
              positive: 'Zasahuje코 siln캩ji',
              negative: 'Sn치ze se zran칤코' },
              
            { id: 'iron_bones', name: '콯elezn칠 kosti', icon: '游붮', type: 'mixed', 
              effect: { maxHp: 30, speed: -0.2 }, 
              desc: '+30 max HP, -20% rychlost cestov치n칤', chance: 0.12,
              positive: 'Jsi odoln캩j코칤',
              negative: 'Tv칠 t캩쬶칠 kosti t캩 zpomaluj칤' },
              
            { id: 'sixth_sense', name: '만st칳 smysl', icon: '游댩', type: 'mixed', 
              effect: { dodgeChance: 0.15, paranoia: true }, 
              desc: '+15% 칰hyb, 캜ast캩j코칤 n치hodn칠 boje', chance: 0.08,
              positive: 'C칤t칤코 nebezpe캜칤 d콏칤v',
              negative: 'Jsi paranoidn칤 a p콏itahuje코 probl칠my' },
              
            { id: 'regenerator', name: 'Regener치tor', icon: '游눜', type: 'mixed', 
              effect: { healRate: 5, energyDrain: 1.3 }, 
              desc: '+5 HP/min, +30% 칰bytek energie', chance: 0.07,
              positive: 'Regeneruje코 se neuv캩콏iteln캩 rychle',
              negative: 'Regenerace t캩 vy캜erp치v치' },
              
            { id: 'mutant_strength', name: 'Mutant칤 s칤la', icon: '游눩', type: 'mixed', 
              effect: { str: 3, int: -2 }, 
              desc: '+3 s칤la, -2 inteligence', chance: 0.10,
              positive: 'Jsi siln캩j코칤 ne d콏칤v',
              negative: 'My코len칤 je t캩쮄뫆' }
        ];
        
        // === DEN/NOC ===
        const DAY_PHASES = [
            { id: 'dawn', name: '칔svit', icon: '游깬', hours: [5, 6, 7], moodBonus: 5, enemyMod: 0.8 },
            { id: 'day', name: 'Den', icon: '驕勇', hours: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17], moodBonus: 10, enemyMod: 1.0 },
            { id: 'dusk', name: 'Soumrak', icon: '游깭', hours: [18, 19, 20], moodBonus: 0, enemyMod: 1.2 },
            { id: 'night', name: 'Noc', icon: '游깿', hours: [21, 22, 23, 0, 1, 2, 3, 4], moodBonus: -10, enemyMod: 1.5, visibility: 0.5 }
        ];
        
        // === HORDA M칍D ===
        const HORDE_WAVES = [
            { wave: 1, enemies: ['mutant_rat', 'mutant_rat', 'wild_dog'], reward: 100 },
            { wave: 2, enemies: ['zombie', 'zombie', 'wild_dog', 'wild_dog'], reward: 150 },
            { wave: 3, enemies: ['raider', 'raider', 'zombie', 'zombie'], reward: 200 },
            { wave: 4, enemies: ['mutant', 'bandit', 'raider', 'zombie'], reward: 300 },
            { wave: 5, enemies: ['giant_mutant', 'raider_boss'], reward: 500, boss: true }
        ];
        
        // === ENCHANTMENTY ===
        const ENCHANTMENTS = [
            { id: 'fire', name: 'Ohe켿', icon: '游댠', type: 'weapon', effect: { bonusDamage: 5, element: 'fire' }, desc: '+5 ohniv칠ho po코kozen칤' },
            { id: 'ice', name: 'Led', icon: '仇勇', type: 'weapon', effect: { bonusDamage: 3, slow: 20 }, desc: '+3 damage, -20% rychlost nep콏칤tele' },
            { id: 'poison', name: 'Jed', icon: '游빍', type: 'weapon', effect: { dot: 3, duration: 3 }, desc: '3 damage/kolo po 3 kola' },
            { id: 'lifesteal', name: 'Vys치v치n칤 쬴vota', icon: '游빁', type: 'weapon', effect: { lifesteal: 0.1 }, desc: '10% damage se vr치t칤 jako HP' },
            { id: 'critical', name: 'Kritick칳 칰der', icon: '游눤', type: 'weapon', effect: { critChance: 0.15, critDamage: 2 }, desc: '+15% 코ance na 2x damage' },
            { id: 'fortify', name: 'Zpevn캩n칤', icon: '游띠勇', type: 'armor', effect: { bonusDefense: 5 }, desc: '+5 obrany' },
            { id: 'regeneration', name: 'Regenerace', icon: '游눜', type: 'armor', effect: { regenHp: 1 }, desc: '+1 HP/min' },
            { id: 'rad_shield', name: 'Radia캜n칤 코t칤t', icon: '驕뮖잺', type: 'armor', effect: { radResist: 0.3 }, desc: '-30% radiace' }
        ];
        
        // === R츼DIO ZPR츼VY ===
        const RADIO_MESSAGES = [
            { id: 'sos', type: 'quest', message: 'SOS! P콏e쬴v코칤 pot콏ebuje pomoc na pozici...', questType: 'rescue' },
            { id: 'trader', type: 'event', message: 'Karavana m칤콏칤 do oblasti...', eventType: 'caravan' },
            { id: 'warning', type: 'danger', message: 'VAROV츼N칈: Horda mutant콢 se bl칤쮂!', eventType: 'horde' },
            { id: 'treasure', type: 'quest', message: 'Sly코el jsem o skryt칠m skladu na...', questType: 'treasure' },
            { id: 'weather', type: 'info', message: 'P콏edpov캩캞: O캜ek치v치 se radia캜n칤 bou콏e...', eventType: 'weather' }
        ];
        
        // === HLAVN칈 P콎칈B캨H ===
        // STORY_NPCS jsou definov치ni n칤쬰 s nov칳m p콏칤b캩hem
        
        // P콏eklady hlavn칤ch quest콢
        function getMainQuestTitle(questId) {
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            return quest?.title || questId;
        }
        
        function getMainQuestDesc(questId) {
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            return quest?.description || '';
        }
        
        const MAIN_QUESTS = [
            // === KAPITOLA 0: PROBUZEN칈 ===
            {
                id: 'intro',
                chapter: 0,
                title: 'Probuzen칤',
                description: 'Probu캞 se a zjisti co se stalo',
                objectives: [
                    { id: 'wake_up', text: 'Prozkoumej okol칤 (nav코tiv 3 lokace)', type: 'visit_locations', target: 3, progress: 0 }
                ],
                reward: { xp: 50, money: 0 },
                nextQuest: 'find_stranger',
                dialog: {
                    start: "Hlava t캩 bol칤... Co se stalo? Kde to jsi? Sv캩t kolem je v trosk치ch. Mus칤코 prozkoumat okol칤.",
                    complete: "Za캜칤n치코 si vzpom칤nat. Byla tu exploze... Projekt Genesis... a pak tma. Mus칤코 naj칤t n캩koho, kdo v칤 v칤c."
                }
            },
            {
                id: 'find_stranger',
                chapter: 0,
                title: 'Z치hadn칳 cizinec',
                description: 'Najdi z치hadn칠ho cizince v opu코t캩n칠m dom캩',
                objectives: [
                    { id: 'go_to_stranger', text: 'Jdi do Opu코t캩n칠ho domu', type: 'location', target: 'abandoned_house', progress: 0 }
                ],
                reward: { xp: 100, money: 50 },
                nextQuest: 'meet_brothers',
                npc: 'mysterious_stranger',
                dialog: {
                    start: "V opu코t캩n칠m dom캩 potk치코 star칠ho mu쬰...",
                    complete: "\"Dva brat콏i,\" 코ept치 sta콏ec. \"Kory a Koudy. Oba hledaj칤 tot칠 - Projekt Genesis. Jeden chce sv캩t zachr치nit, druh칳 zni캜it. Ale kter칳 je kter칳? Mluv s ob캩ma a zjisti pravdu s치m. Pak sesb칤rej v코echny 4 komponenty a rozhodni se v Bu캜ovic칤ch.\""
                }
            },
            {
                id: 'meet_brothers',
                chapter: 1,
                title: 'Dva brat콏i',
                description: 'Nav코tiv oba bratry a vyslechni jejich verzi p콏칤b캩hu',
                objectives: [
                    { id: 'meet_kory', text: 'Mluv s Korym (Trading Post)', type: 'location', target: 'trading_post', progress: 0 },
                    { id: 'meet_koudy', text: 'Mluv s Koudym (Research Facility)', type: 'location', target: 'research_facility', progress: 0 }
                ],
                reward: { xp: 150, money: 100 },
                nextQuest: 'first_component',
                dialog: {
                    start: "Najdi oba bratry a vyslechni si, co ka쬯칳 z nich 콏칤k치 o Projektu Genesis.",
                    complete: "Oba brat콏i cht캩j칤 to sam칠 - komponenty Projektu Genesis. Kory mluv칤 o \"o캜ist캩\" sv캩ta, Koudy o \"obnov캩\". Kdo 콏칤k치 pravdu? Mus칤코 naj칤t komponenty a zjistit v칤c."
                }
            },
            
            // === KAPITOLA 1: SB캨R KOMPONENT콡 ===
            {
                id: 'first_component',
                chapter: 1,
                title: 'Plutoniov칠 j치dro',
                description: 'Najdi prvn칤 komponent - Plutoniov칠 j치dro',
                objectives: [
                    { id: 'go_to_military', text: 'Jdi do Vojensk칠 z치kladny', type: 'location', target: 'military_base', progress: 0 },
                    { id: 'get_plutonium', text: 'Z칤skej Plutoniov칠 j치dro', type: 'item', target: 'plutonium_core', progress: 0 }
                ],
                reward: { xp: 200, money: 150 },
                nextQuest: 'second_component',
                spawnItem: { id: 'plutonium_core', location: 'military_base' },
                dialog: {
                    start: "Prvn칤 komponent - Plutoniov칠 j치dro - je ukryt칳 ve Vojensk칠 z치kladn캩. Bude to nebezpe캜n칠.",
                    complete: "M치코 j치dro! Radioaktivn칤 z치콏e z n캩j pulzuje zelen칳m sv캩tlem. Schovej ho a pokra캜uj v hled치n칤 dal코칤ch komponent콢."
                }
            },
            
            // === KAPITOLA 2: POCHYBNOSTI ===
            {
                id: 'second_component',
                chapter: 2,
                title: 'Kvantov칳 stabiliz치tor',
                description: 'Najdi druh칳 komponent - Kvantov칳 stabiliz치tor',
                objectives: [
                    { id: 'investigate_lab', text: 'Prozkoumej Secret Lab', type: 'location', target: 'secret_lab', progress: 0 },
                    { id: 'get_stabilizer', text: 'Z칤skej Kvantov칳 stabiliz치tor', type: 'item', target: 'quantum_stabilizer', progress: 0 }
                ],
                reward: { xp: 250, money: 200 },
                nextQuest: 'find_document',
                spawnItem: { id: 'quantum_stabilizer', location: 'secret_lab' },
                dialog: {
                    start: "Druh칳 komponent je v tajn칠 laborato콏i. Cesta bude nebezpe캜n치.",
                    complete: "Stabiliz치tor je tv콢j! V laborato콏i jsi ale na코el i n캩co jin칠ho - zm칤nku o roztrhan칠 dokumentaci..."
                }
            },
            {
                id: 'find_document',
                chapter: 2,
                title: 'Roztrhan칠 dokumenty',
                description: 'Najdi zbyl칠 캜치sti dokumentu o Projektu Genesis',
                objectives: [
                    { id: 'search_hospital', text: 'Prohledej Nemocnici', type: 'location', target: 'hospital', progress: 0 },
                    { id: 'get_document', text: 'Najdi chyb캩j칤c칤 str치nky', type: 'item', target: 'genesis_document', progress: 0 }
                ],
                reward: { xp: 200, money: 150 },
                nextQuest: 'third_component',
                spawnItem: { id: 'genesis_document', location: 'hospital' },
                dialog: {
                    start: "V trosk치ch laborato콏e jsi na코el zm칤nku o dokumentech v nemocnici...",
                    complete: "Dokument odhaluje pravdu: Projekt Genesis m콢쬰 BU캝 vy캜istit radiaci a obnovit p콏칤rodu, NEBO vyvolat 콏et캩zovou reakci kter치 zni캜칤 v코e 쬴v칠. Z치le쮂 na konfiguraci. Kdo z bratr콢 콏칤k치 pravdu?"
                }
            },
            
            // === KAPITOLA 3: ODHALEN칈 ===
            {
                id: 'third_component',
                chapter: 3,
                title: 'F칰zn칤 캜l치nek',
                description: 'Najdi t콏et칤 komponent - F칰zn칤 캜l치nek',
                objectives: [
                    { id: 'go_to_power', text: 'Jdi do Power Plant', type: 'location', target: 'power_plant', progress: 0 },
                    { id: 'get_fusion', text: 'Z칤skej F칰zn칤 캜l치nek', type: 'item', target: 'fusion_cell', progress: 0 }
                ],
                reward: { xp: 300, money: 250 },
                nextQuest: 'truth_revealed',
                spawnItem: { id: 'fusion_cell', location: 'power_plant' },
                dialog: {
                    start: "Elektr치rna je pln치 radiace a nebezpe캜칤. Ale F칰zn칤 캜l치nek je tam.",
                    complete: "M치코 캜l치nek! V elektr치rn캩 jsi na코el star칳 termin치l s video z치znamy, kter칠 odkazuj칤 na podzemn칤 bunkr..."
                }
            },
            {
                id: 'truth_revealed',
                chapter: 3,
                title: 'Pravda odhalena',
                description: 'P콏ehraj video z치znamy z termin치lu v podzemn칤m bunkru',
                objectives: [
                    { id: 'watch_video', text: 'Prozkoumej Underground Bunker', type: 'location', target: 'underground_bunker', progress: 0 }
                ],
                reward: { xp: 300, money: 200 },
                nextQuest: 'fourth_component',
                dialog: {
                    start: "Video z치znamy odk치zaly na hlavn칤 archiv v podzemn칤m bunkru...",
                    complete: "PRAVDA ODHALENA: Kory byl vedouc칤m vojensk칠ho projektu. V캩콏il, 쬰 lidstvo je \"nemoc\" a Genesis je \"l칠k\". Koudy byl jeho asistent, kter칳 se pokusil projekt sabotovat - proto do코lo k explozi. Koudy se sna쮂 opravit chyby sv칠ho bratra. Kory chce dokon캜it to, co za캜al - vymazat \"slab칠\" a vytvo콏it novou rasu vyvolen칳ch. Te캞 v칤코 pravdu. Zb칳v치 naj칤t posledn칤 komponent."
                }
            },
            
            // === KAPITOLA 4: ROZHODNUT칈 ===
            {
                id: 'fourth_component',
                chapter: 4,
                title: '콎칤dic칤 modul AI',
                description: 'Najdi posledn칤 komponent - 콎칤dic칤 modul AI',
                objectives: [
                    { id: 'go_to_bunker', text: 'Prozkoumej Star칳 bunkr', type: 'location', target: 'old_bunker', progress: 0 },
                    { id: 'get_ai', text: 'Z칤skej 콎칤dic칤 modul AI', type: 'item', target: 'ai_module', progress: 0 }
                ],
                reward: { xp: 400, money: 300 },
                nextQuest: 'final_choice',
                spawnItem: { id: 'ai_module', location: 'old_bunker' },
                dialog: {
                    start: "Posledn칤 komponent je v Star칠m bunkru. Toto rozhodne osud sv캩ta.",
                    complete: "M치코 v코echny 캜ty콏i komponenty Projektu Genesis! Je 캜as pro fin치ln칤 rozhodnut칤. Oba brat콏i se dozv캩d캩li a 캜ekaj칤 na tebe v Bu캜ovic칤ch. Komu sv캩콏칤코 osud lidstva?"
                }
            },
            {
                id: 'final_choice',
                chapter: 4,
                title: 'Osud sv캩ta',
                description: 'Jdi do Bu캜ovic a rozhodni o osudu sv캩ta',
                objectives: [
                    { id: 'go_to_bucovice', text: 'Jdi do Bu캜ovic', type: 'location', target: 'bucovice', progress: 0 },
                    { id: 'final_decision', text: 'Rozhodni: Kory, Koudy, nebo zni캜it?', type: 'final_choice', targets: ['kory', 'koudy', 'destroy'], progress: 0 }
                ],
                reward: { xp: 500, money: 500 },
                nextQuest: null,
                isFinalChoice: true,
                dialog: {
                    start: "M치코 v코echny 4 komponenty Projektu Genesis. Oba brat콏i se dozv캩d캩li a 캜ekaj칤 v Bu캜ovic칤ch. Je 캜as rozhodnout o osudu sv캩ta.",
                    complete: "Tv치 volba zm캩nila sv캩t nav쬯y..."
                },
                choiceEffects: {
                    kory: { ending: 'dark', dialog: "Kory se sm캩je jako 코칤lenec. \"KONE캛N캨! Nov칳 sv캩t se rod칤!\" Aktivuje Genesis..." },
                    koudy: { ending: 'hope', dialog: "Koudy se usm칤v치. \"D캩kuji, p콏칤teli. Dnes za캜칤n치 obnova.\" Aktivuje Genesis v re쬴mu l칠캜en칤..." },
                    destroy: { ending: 'neutral', dialog: "Rozb칤j칤코 modul na kusy. Oba brat콏i k콏i캜칤. Projekt Genesis je nav쬯y ztracen..." }
                }
            }
        ];
        
        // Quest itemy - 4 komponenty + dokumenty
        const QUEST_ITEMS = [
            { id: 'plutonium_core', name: 'Plutoniov칠 j치dro', icon: '驕뮖잺', type: 'quest', weight: 0, cantDrop: true, cantSell: true, desc: 'Radioaktivn칤 j치dro pulzuj칤c칤 zelen칳m sv캩tlem. Prvn칤 komponent Projektu Genesis. Sesb칤rej v코echny 4 komponenty a dones je do Bu캜ovic pro fin치ln칤 rozhodnut칤.' },
            { id: 'quantum_stabilizer', name: 'Kvantov칳 stabiliz치tor', icon: '游댧', type: 'quest', weight: 0, cantDrop: true, cantSell: true, desc: 'Slo쬴t칠 za콏칤zen칤 pro stabilizaci kvantov칳ch fluktuac칤. Druh칳 komponent Projektu Genesis. Sesb칤rej v코echny 4 komponenty a dones je do Bu캜ovic.' },
            { id: 'fusion_cell', name: 'F칰zn칤 캜l치nek', icon: '丘', type: 'quest', weight: 0, cantDrop: true, cantSell: true, desc: 'Miniaturn칤 f칰zn칤 reaktor. T콏et칤 komponent Projektu Genesis. Sesb칤rej v코echny 4 komponenty a dones je do Bu캜ovic.' },
            { id: 'ai_module', name: '콎칤dic칤 modul AI', icon: '游', type: 'quest', weight: 0, cantDrop: true, cantSell: true, desc: 'Pokro캜il치 um캩l치 inteligence v p콏enosn칠m modulu. 캛tvrt칳 a posledn칤 komponent Projektu Genesis. Dones v코echny 4 komponenty do Bu캜ovic.' },
            { id: 'genesis_document', name: 'Dokumenty Genesis', icon: '游닆', type: 'quest', weight: 0, cantDrop: true, cantSell: true, desc: 'Roztrhan칠 dokumenty odhaluj칤c칤 pravdu o Projektu Genesis. P콏e캜ti si je v invent치콏i.' },
            // Companion quest items
            { id: 'old_collar', name: 'Star칳 obojek', icon: '游', type: 'quest', weight: 0.1, desc: 'Star칳, opot콏ebovan칳 ps칤 obojek s vybledl칳m jm칠nem.' },
            { id: 'dogtags', name: 'Identifika캜n칤 zn치mky', icon: '游뿱', type: 'quest', weight: 0.1, desc: 'Vojensk칠 identifika캜n칤 zn치mky padl칳ch voj치k콢.' },
            { id: 'medical_records', name: 'L칠ka콏sk칠 z치znamy', icon: '游늶', type: 'quest', weight: 0.2, desc: 'Star칠 nemocni캜n칤 z치znamy z doby p콏ed v치lkou.' },
            { id: 'lab_samples', name: 'Laboratorn칤 vzorky', icon: '游빍', type: 'quest', weight: 0.5, desc: 'Vzorky z v칳zkumn칠 laborato콏e v ochrann칳ch n치dob치ch.' },
            { id: 'secret_documents', name: 'Tajn칠 dokumenty', icon: '游늬', type: 'quest', weight: 0.3, desc: 'Utajovan칠 vojensk칠 dokumenty ozna캜en칠 jako "TOP SECRET". Quest item pro spole캜n칤ka V치le캜n칤ka - mluv s n칤m pro dokon캜en칤 questu.' },
            { id: 'family_photo', name: 'Rodinn치 fotka', icon: '游뒆勇', type: 'quest', weight: 0.1, desc: 'Vybledl치 fotografie 코콘astn칠 rodiny z dob p콏ed v치lkou.' },
            { id: 'old_toy', name: 'Star칳 ply코치k', icon: '游빚', type: 'quest', weight: 0.2, desc: 'Otrhan칳 ply코ov칳 medv칤dek, stopy po slz치ch.' },
            { id: 'ancient_relic', name: 'Prastar칳 artefakt', icon: '游낔', type: 'quest', weight: 1, desc: 'Z치hadn칳 p콏edm캩t nezn치m칠ho p콢vodu.' }
        ];
        
        // P콏칤b캩hov칤 NPC - Kory a Koudy
        const STORY_NPCS = {
            kory: {
                id: 'kory',
                name: 'Kory',
                icon: '游붳',
                location: 'trading_post',
                description: 'Charismatick칳 mu s pronikav칳ma o캜ima. Mluv칤 o "o캜ist캩" a "nov칠m sv캩t캩".',
                dialogs: {
                    first_meet: [
                        "Ach, nov칳 p콏e쬴v코칤! Sly코el jsem o tob캩.",
                        "V칤코, tento sv캩t je zka쬰n칳. Slab칤 t치hnou siln칠 dol콢.",
                        "Projekt Genesis m콢쬰 v코e zm캩nit. O캜istit sv캩t od slabosti.",
                        "Pomoz mi naj칤t komponenty a j치 t캩 vezmu s sebou do nov칠ho, lep코칤ho sv캩ta.",
                        "Neposlouchej m칠ho bratra Koudyho. Je naivn칤 a slab칳."
                    ],
                    quest_active: [
                        "U jsi na코el n캩jak칠 komponenty?",
                        "캛as se kr치t칤. Mus칤me jednat rychle."
                    ],
                    quest_complete: [
                        "V칳born캩. Jsi cenn칳 spojenec.",
                        "Nov칳 sv캩t se bl칤쮂. A ty v n캩m bude코 m칤t m칤sto."
                    ]
                }
            }
        };
        
        // Ending definice
        const STORY_ENDINGS = {
            dark: {
                title: '游깸 Temn칳 konec: Nov칳 sv캩tov칳 콏치d',
                description: 'Kory aktivoval Genesis v destruk캜n칤m re쬴mu. Vlna energie se 코칤콏칤 sv캩tem a ni캜칤 v코e "slab칠". Jen hrstka "vyvolen칳ch" p콏e쬴la v Koryho bunkru. Ty jsi mezi nimi - ale za jakou cenu?',
                effects: { reputation: -50, ending_type: 'dark' }
            },
            hope: {
                title: '游깬 Konec nad캩je: Obnova',
                description: 'Koudy aktivoval Genesis v l칠캜ebn칠m re쬴mu. Radiace se pomalu rozptyluje, mrtv치 zem캩 za캜칤n치 znovu zelenat. Je to pomal칳 proces, ale poprv칠 za dlouhou dobu je tu nad캩je.',
                effects: { reputation: 50, ending_type: 'hope' }
            },
            neutral: {
                title: '丘뒲잺 Neutr치ln칤 konec: Status quo',
                description: 'Zni캜il jsi posledn칤 komponent. Projekt Genesis je nav쬯y ztracen. Sv캩t z콢st치v치 takov칳 jak칳 je - rozbit칳, ale 쬴v칳. Nen칤 tu nad캩je na rychlou obnovu, ale ani hrozba zk치zy.',
                effects: { reputation: 0, ending_type: 'neutral' }
            }
        };
        
        // === CUSTOMIZACE POSTAVY ===
        const HAIRSTYLES = [
            { id: 'bald', name: 'Hol치 hlava', icon: '游녿꽳릱' },
            { id: 'short', name: 'Kr치tk칠', icon: '游녿' },
            { id: 'medium', name: 'St콏edn칤', icon: '游븸' },
            { id: 'long', name: 'Dlouh칠', icon: '游븺' },
            { id: 'mohawk', name: 'Mohawk', icon: '游놀꽳릝' },
            { id: 'ponytail', name: 'Cul칤k', icon: '游놀' }
        ];
        
        const HAIR_COLORS = [
            { id: 'black', name: '캛ern치', color: '#1a1a1a' },
            { id: 'brown', name: 'Hn캩d치', color: '#8B4513' },
            { id: 'blonde', name: 'Blond', color: '#FFD700' },
            { id: 'red', name: 'Zrzav치', color: '#B22222' },
            { id: 'gray', name: '만div치', color: '#808080' },
            { id: 'white', name: 'B칤l치', color: '#F5F5F5' },
            { id: 'blue', name: 'Modr치', color: '#4169E1' },
            { id: 'green', name: 'Zelen치', color: '#228B22' },
            { id: 'pink', name: 'R콢쬺v치', color: '#FF69B4' }
        ];
        
        const SKIN_TONES = [
            { id: 'light', name: 'Sv캩tl치', color: '#FFDFC4' },
            { id: 'medium_light', name: 'Sv캩tle hn캩d치', color: '#F0C8A0' },
            { id: 'medium', name: 'St콏edn칤', color: '#D4A574' },
            { id: 'medium_dark', name: 'Tmav캩 hn캩d치', color: '#A67B5B' },
            { id: 'dark', name: 'Tmav치', color: '#8D5524' }
        ];
        
        const OUTFITS = [
            { id: 'survivor', name: 'P콏e쬴v코칤', icon: '游빈', desc: 'Z치kladn칤 oble캜en칤' },
            { id: 'military', name: 'Vojensk칠', icon: '游꿌勇', desc: 'Mask치캜ov치 uniforma', unlock: 'kill_50' },
            { id: 'scientist', name: 'V캩deck칠', icon: '游봎', desc: 'Laboratorn칤 pl치코콘', unlock: 'story_ch2' },
            { id: 'raider', name: 'N치jezdnick칠', icon: '游', desc: 'Ko쬰n칠 brn캩n칤', unlock: 'kill_100' },
            { id: 'hero', name: 'Hrdinsk칠', icon: '游붲', desc: 'Pl치코콘 hrdiny', unlock: 'story_complete' },
            { id: 'wasteland', name: 'Pou코tn칤', icon: '游끺勇', desc: 'Pou코tn칤 oble캜en칤', unlock: 'explore_100' }
        ];
        
        const TITLES = [
            { id: 'survivor', name: 'P콏e쬴v코칤', unlock: 'default' },
            { id: 'explorer', name: 'Pr콢zkumn칤k', unlock: 'explore_50' },
            { id: 'warrior', name: 'V치le캜n칤k', unlock: 'kill_100' },
            { id: 'champion', name: '마mpion', unlock: 'kill_200' },
            { id: 'legend', name: 'Legenda', unlock: 'explore_150' },
            { id: 'scientist', name: 'V캩dec', unlock: 'alchemy_10' },
            { id: 'hunter', name: 'Lovec', unlock: 'hunting_10' },
            { id: 'merchant', name: 'Obchodn칤k', unlock: 'money_10000' },
            { id: 'savior', name: 'Zachr치nce lidstva', unlock: 'story_complete' },
            { id: 'mutant', name: 'Mutant', unlock: 'mutations_3' }
        ];
        
        const BADGES = [
            { id: 'first_blood', name: 'Prvn칤 krev', icon: '游뽖', desc: 'Zabil prvn칤ho nep콏칤tele' },
            { id: 'boss_slayer', name: 'Zabij치k boss콢', icon: '游', desc: 'Zabil bosse' },
            { id: 'survivor_7', name: 'T칳den p콏e쬴t칤', icon: '游늰', desc: 'P콏e쬴l 7 dn칤' },
            { id: 'rich', name: 'Boh치캜', icon: '游눯', desc: 'M캩l 1000+ pen캩z' },
            { id: 'explorer', name: 'Objevitel', icon: '游딬勇', desc: 'Prozkoumal 50 hex콢' },
            { id: 'chef', name: '먞뼍kucha콏', icon: '游녿꽳릜', desc: 'Uva콏il 10 j칤del' },
            { id: 'alchemist', name: 'Alchymista', icon: '丘勇', desc: 'Nam칤chal 10 lektvar콢' },
            { id: 'fisherman', name: 'Ryb치콏', icon: '游꿖', desc: 'Chytil 20 ryb' },
            { id: 'miner', name: 'Horn칤k', icon: '久勇', desc: 'Vyt캩쬴l 20 rud' },
            { id: 'story_complete', name: 'Hrdina', icon: '游끥', desc: 'Dokon캜il p콏칤b캩h' }
        ];
        
        // === SKILL TREE ===
        const SKILL_TREE = {
            combat: {
                name: 'Boj',
                icon: '丘덢잺',
                color: '#c62828',
                skills: [
                    { id: 'power_strike', name: 'Siln칳 칰der', icon: '游눩', desc: '+10% damage', maxLevel: 5, effect: { damageBonus: 0.1 }, requires: null, tier: 1 },
                    { id: 'critical_hit', name: 'Kritick칳 z치sah', icon: '游눤', desc: '+5% 코ance na krit', maxLevel: 5, effect: { critChance: 0.05 }, requires: 'power_strike', tier: 2 },
                    { id: 'armor_pierce', name: 'Pr콢raz zbroje', icon: '游디勇', desc: 'Ignoruje 10% obrany', maxLevel: 3, effect: { armorPierce: 0.1 }, requires: 'power_strike', tier: 2 },
                    { id: 'berserker', name: 'Berserk', icon: '游땫', desc: '+20% dmg kdy HP < 30%', maxLevel: 3, effect: { berserkerBonus: 0.2 }, requires: 'critical_hit', tier: 3 },
                    { id: 'execute', name: 'Poprava', icon: '丘썶잺', desc: '+50% dmg na nep콏치tele pod 20% HP', maxLevel: 1, effect: { executeBonus: 0.5 }, requires: 'berserker', tier: 4 }
                ]
            },
            defense: {
                name: 'Obrana',
                icon: '游띠勇',
                color: '#1976d2',
                skills: [
                    { id: 'tough_skin', name: 'Tvrd치 k콢쬰', icon: '游붍', desc: '+5 obrany', maxLevel: 5, effect: { defense: 5 }, requires: null, tier: 1 },
                    { id: 'block', name: 'Blokov치n칤', icon: '游띠勇', desc: '10% 코ance blokovat 칰tok', maxLevel: 5, effect: { blockChance: 0.1 }, requires: 'tough_skin', tier: 2 },
                    { id: 'regeneration', name: 'Regenerace', icon: '游눜', desc: '+1 HP/min', maxLevel: 5, effect: { hpRegen: 1 }, requires: 'tough_skin', tier: 2 },
                    { id: 'last_stand', name: 'Posledn칤 v칳dr', icon: '游눩', desc: '20% 코ance p콏e쮂셦 smrteln칳 칰der s 1 HP', maxLevel: 3, effect: { lastStand: 0.2 }, requires: 'block', tier: 3 },
                    { id: 'fortress', name: 'Pevnost', icon: '游낋', desc: '+20% max HP', maxLevel: 1, effect: { maxHpBonus: 0.2 }, requires: 'last_stand', tier: 4 }
                ]
            },
            survival: {
                name: 'P콏e쬴t칤',
                icon: '游끳勇',
                color: '#388e3c',
                skills: [
                    { id: 'scavenger', name: 'Sb캩ra캜', icon: '游댌', desc: '+15% 코ance na loot', maxLevel: 5, effect: { lootChance: 0.15 }, requires: null, tier: 1 },
                    { id: 'efficient', name: 'Efektivita', icon: '游늵', desc: '-10% spot콏eba j칤dla/vody', maxLevel: 5, effect: { consumeReduction: 0.1 }, requires: 'scavenger', tier: 2 },
                    { id: 'pack_rat', name: 'K콏e캜ek', icon: '游', desc: '+10 nosnost', maxLevel: 5, effect: { carryWeight: 10 }, requires: 'scavenger', tier: 2 },
                    { id: 'auto_consume', name: 'Pud sebez치chovy', icon: '游', desc: 'Auto-j칤/pije kdy um칤r치코', maxLevel: 1, effect: { autoConsume: true }, requires: 'efficient', tier: 3 },
                    { id: 'lucky', name: '맚캩st캩na', icon: '游', desc: '+5% 코ance na vz치cn칳 loot', maxLevel: 3, effect: { rareChance: 0.05 }, requires: 'efficient', tier: 3 }
                ]
            },
            exploration: {
                name: 'Pr콢zkum',
                icon: '游딬勇',
                color: '#f57c00',
                skills: [
                    { id: 'pathfinder', name: 'Pr콢zkumn칤k', icon: '游녺', desc: '-1% 캜as cestov치n칤 / level', maxLevel: 5, effect: { travelSpeed: 0.01 }, requires: null, tier: 1 },
                    { id: 'scout', name: 'Zv캩d', icon: '游녜勇', desc: '+5% 코ance naj칤t vz치cn칠 p콏edm캩ty', maxLevel: 3, effect: { rareLootBonus: 0.05 }, requires: 'pathfinder', tier: 2 },
                    { id: 'stealth', name: 'Nen치padnost', icon: '游녻', desc: '-15% 코ance na p콏epaden칤', maxLevel: 5, effect: { ambushReduction: 0.15 }, requires: 'pathfinder', tier: 2 },
                    { id: 'tracker', name: 'Stopa콏', icon: '游', desc: '+20% 칰sp캩코nost lovu', maxLevel: 3, effect: { huntingBonus: 0.2 }, requires: 'scout', tier: 3 },
                    { id: 'nomad', name: 'Nom치d', icon: '游끺勇', desc: '콯치dn칠 postihy za ter칠n', maxLevel: 1, effect: { noTerrainPenalty: true }, requires: 'tracker', tier: 4 }
                ]
            },
            crafting: {
                name: '콎emeslo',
                icon: '游댢',
                color: '#7b1fa2',
                skills: [
                    { id: 'tinkerer', name: 'Kutil', icon: '游댢', desc: '-10% cena craftingu', maxLevel: 5, effect: { craftCostReduction: 0.1 }, requires: null, tier: 1 },
                    { id: 'chef', name: 'Kucha콏', icon: '游녿꽳릜', desc: '+20% efekt j칤dla', maxLevel: 5, effect: { foodBonus: 0.2 }, requires: 'tinkerer', tier: 2 },
                    { id: 'alchemist', name: 'Alchymista', icon: '丘勇', desc: '+20% efekt lektvar콢', maxLevel: 5, effect: { potionBonus: 0.2 }, requires: 'tinkerer', tier: 2 },
                    { id: 'master_craft', name: 'Mistr 콏emesla', icon: '救', desc: '20% 코ance na double v칳stup', maxLevel: 3, effect: { doubleCraft: 0.2 }, requires: 'chef', tier: 3 },
                    { id: 'legendary_smith', name: 'Legend치rn칤 kov치콏', icon: '游댣', desc: 'M콢쬰 vytv치콏et legend치rn칤 p콏edm캩ty', maxLevel: 1, effect: { legendaryUnlock: true }, requires: 'master_craft', tier: 4 }
                ]
            }
        };
        
        function generateDailyQuests() {
            // Reset check - once per real day
            const now = Date.now();
            const lastReset = state.dailyQuests.lastReset || 0;
            const daysPassed = Math.floor((now - lastReset) / (24 * 60 * 60 * 1000));
            
            // Kontrola: pokud je moneyEarned p콏칤li코 vysok칠, progress nebyl resetov치n
            const progressCorrupted = state.dailyQuests.progress?.moneyEarned > 10000 ||
                                      state.dailyQuests.progress?.kills > 500 ||
                                      state.dailyQuests.progress?.explored > 100;
            
            if (daysPassed >= 1 || state.dailyQuests.quests.length === 0 || progressCorrupted) {
                if (progressCorrupted) {
                    console.warn('丘멆잺 Daily quest progress byl corrupted, resetuji...');
                }
                // Generate 3 random quests
                const shuffled = [...DAILY_QUEST_POOL].sort(() => Math.random() - 0.5);
                state.dailyQuests.quests = shuffled.slice(0, 3);
                state.dailyQuests.completed = [];
                state.dailyQuests.lastReset = now;
                state.dailyQuests.progress = {
                    kills: 0,
                    explored: 0,
                    crafted: 0,
                    moneyEarned: 0,
                    travelled: 0,
                    itemsFound: 0,
                    cooked: 0,
                    sold: 0,
                    bought: 0,
                    fedCompanion: 0,
                    healed: 0,
                    pvpWins: 0,
                    gambled: 0
                };
                addLog('Nov칠 denn칤 칰koly dostupn칠!', '游늶');
            } else {
                // Odfiltruj neexistuj칤c칤 questy (nap콏. travel_distance ze star칳ch sav콢)
                const validQuestIds = DAILY_QUEST_POOL.map(q => q.id);
                const invalidQuests = state.dailyQuests.quests.filter(q => !validQuestIds.includes(q.id));
                if (invalidQuests.length > 0) {
                    console.log('游빛 Odstra켿uji neplatn칠 questy:', invalidQuests.map(q => q.id));
                    state.dailyQuests.quests = state.dailyQuests.quests.filter(q => validQuestIds.includes(q.id));
                    // Pokud zbylo m칠n캩 ne 3 questy, dopl켿
                    while (state.dailyQuests.quests.length < 3) {
                        const availableQuests = DAILY_QUEST_POOL.filter(q => 
                            !state.dailyQuests.quests.some(sq => sq.id === q.id)
                        );
                        if (availableQuests.length === 0) break;
                        const randomQuest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
                        state.dailyQuests.quests.push(randomQuest);
                    }
                }
            }
        }
        
        function checkDailyQuests() {
            if (!state.dailyQuests.quests || state.dailyQuests.quests.length === 0) return;
            
            state.dailyQuests.quests.forEach(quest => {
                // Najdi origin치ln칤 quest z poolu (funkce se nezachovaj칤 p콏i save/load)
                const originalQuest = DAILY_QUEST_POOL.find(q => q.id === quest.id);
                if (!originalQuest || !originalQuest.check) return;
                
                // Zajisti 쬰 completed existuje
                if (!state.dailyQuests.completed) state.dailyQuests.completed = [];
                
                if (!state.dailyQuests.completed.includes(quest.id) && originalQuest.check()) {
                    state.dailyQuests.completed.push(quest.id);
                    
                    // Po캜칤tadlo celkov칳ch spln캩n칳ch denn칤ch quest콢 (pro sk칩re)
                    state.stats = state.stats || {};
                    state.stats.totalDailyQuestsCompleted = (state.stats.totalDailyQuestsCompleted || 0) + 1;
                    
                    // Spo캜칤tej odm캩nu P콎ED vol치n칤m (pro zobrazen칤)
                    const moneyBefore = getMoney();
                    const levelBefore = state.char.level;
                    const xpBefore = state.char.xp;
                    
                    // Zavolej reward funkci
                    console.log('游닆 Denn칤 quest dokon캜en:', quest.name, '- vol치m reward()');
                    originalQuest.reward();
                    
                    const moneyGained = getMoney() - moneyBefore;
                    // XP m콢쬰 b칳t resetovan칠 p콏i level upu, tak spo캜칤tej jinak
                    let xpGained = 0;
                    if (state.char.level > levelBefore) {
                        xpGained = state.char.xp + (state.char.xpNeed || 350); // P콏ibli쬹캩
                    } else {
                        xpGained = Math.max(0, state.char.xp - xpBefore);
                    }
                    
                    console.log('游닆 Odm캩ny:', moneyGained, '游눯,', xpGained, 'XP');
                    
                    SoundSystem.play('quest_complete');
                    
                    // Sestaven칤 textu odm캩ny
                    let rewardText = '';
                    if (moneyGained > 0) rewardText += `+${moneyGained} 游눯 `;
                    if (xpGained > 0) rewardText += `+${xpGained} XP `;
                    if (!rewardText) rewardText = 'Suroviny p콏id치ny!';
                    
                    // B캩hem boje pou쬴j jen notifikaci, jinak modal
                    if (isInCombat()) {
                        notifySuccess('九 ' + quest.name, 'Denn칤 칰kol spln캩n! ' + rewardText);
                    } else {
                        showModal('九 칔kol spln캩n!', 
                            '<div style="text-align: center;">' +
                            '<div style="font-size: 3rem;">' + quest.icon + '</div>' +
                            '<h3>' + quest.name + '</h3>' +
                            '<p>' + quest.desc + '</p>' +
                            '<p style="color: #8bc34a; margin-top: 1rem; font-size: 1.2rem;">九 ' + rewardText + '</p>' +
                            '</div>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>'
                        );
                    }
                    addLog('Denn칤 칰kol spln캩n: ' + quest.name + ' (' + rewardText.trim() + ')', '九');
                    saveGame(true);
                }
            });
        }
        
        // === GAME VERSION ===
        // ============================================================
        // === 游 DYNAMICK칄 N츼HODN칄 EVENTY ===
        // ============================================================
        const DYNAMIC_EVENTS = [
            // === RESCUE EVENTS - Z치chrann칠 mise ===
            {
                id: 'burning_village',
                name: 'Ho콏칤c칤 vesnice',
                icon: '游댠',
                type: 'rescue',
                triggerChance: 0.08,
                minLevel: 3,
                description: 'Vid칤코 kou콏 stoupaj칤c칤 z nedalek칠 vesnice!',
                choices: [
                    { 
                        id: 'help', 
                        text: '游끢 B캩 pomoci!', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.7, reward: { money: 150, xp: 100, reputation: { traders: 10 } }, text: 'Zachr치nil jsi 3 vesni캜any! Jsou ti nesm칤rn캩 vd캩캜n칤.' },
                            failure: { chance: 0.3, penalty: { hp: -30 }, text: 'Dostal jsi pop치leniny, ale zachr치nil jsi jednoho 캜lov캩ka.' }
                        }
                    },
                    { 
                        id: 'loot', 
                        text: '游눯 Vyu쬴j chaosu a lootuj', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.9, reward: { money: 250, items: ['medkit', 'food'] }, penalty: { reputation: { traders: -15 } }, text: 'Na코el jsi cennosti, ale n캩kdo t캩 vid캩l...' }
                        }
                    },
                    { 
                        id: 'ignore', 
                        text: '游뛌 Jdi d치l', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, text: 'Pokra캜uje코 v cest캩. V칳k콏iky za tebou utichaj칤...' }
                        }
                    }
                ]
            },
            {
                id: 'dying_stranger',
                name: 'Um칤raj칤c칤 cizinec',
                icon: '游',
                type: 'rescue',
                triggerChance: 0.1,
                minLevel: 1,
                description: 'Na zemi le쮂 zran캩n칳 캜lov캩k. St칠n치 bolest칤 a dr쮂 n캩co v ruce...',
                choices: [
                    { 
                        id: 'help_heal', 
                        text: '游눍 O코et콏i ho (pot콏ebuje코 medkit)', 
                        requirements: { item: 'medkit' },
                        consumeItem: true,
                        outcome: {
                            success: { chance: 0.8, reward: { xp: 80, money: 100, unlockEvent: 'stranger_reward' }, text: '"D캩kuji... Vezmi si tohle." D치 ti mapu k pokladu.' },
                            failure: { chance: 0.2, text: 'P콏es tvou snahu um칤r치. V ruce dr쮂 kl칤캜...' , reward: { items: ['mystery_key'] } }
                        }
                    },
                    { 
                        id: 'search', 
                        text: '游댌 Prohledej ho', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, reward: { money: 50, items: ['mystery_note'] }, text: 'Najde코 z치hadn칳 dopis a p치r minc칤.' }
                        }
                    },
                    { 
                        id: 'mercy', 
                        text: '游디勇 Ukon캜i jeho utrpen칤', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, reward: { items: ['dogtag'] }, penalty: { karma: -5 }, text: 'Rychl치 smrt. Najde코 u n캩j identifika캜n칤 zn치mku.' }
                        }
                    }
                ]
            },
            {
                id: 'caravan_attack',
                name: 'Karavana pod 칰tokem',
                icon: '丘덢잺',
                type: 'combat',
                triggerChance: 0.07,
                minLevel: 5,
                description: 'Sly코칤코 st콏elbu! Karavana obchodn칤k콢 je napadena bandity!',
                choices: [
                    { 
                        id: 'help_fight', 
                        text: '丘덢잺 Pomoz karavann캩!', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['raider', 'raider', 'bandit'], allies: 2 },
                            victory: { reward: { money: 300, xp: 150, reputation: { traders: 20 }, items: ['rare_weapon'] }, text: 'Obchodn칤ci ti d치vaj칤 odm캩nu!' },
                            defeat: { penalty: { hp: -50 }, text: 'Byl jsi t캩쬮e zran캩n, ale obchodn칤ci p콏e쬴li.' }
                        }
                    },
                    { 
                        id: 'help_bandits', 
                        text: '游 Pomoz bandit콢m (p콏idej se k 칰toku)', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['trader', 'guard'], allies: 3 },
                            victory: { reward: { money: 500 }, penalty: { reputation: { traders: -30, raiders: 15 } }, text: 'Banditi se s tebou pod캩l칤 o ko콏ist.' }
                        }
                    },
                    { 
                        id: 'wait', 
                        text: '游녜勇 Po캜kej a oloupej v칤t캩ze', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.5, reward: { money: 200 }, text: 'Vy캜kals a sebral co zbylo.' },
                            failure: { chance: 0.5, penalty: { hp: -20 }, text: 'N캩kdo t캩 zpozoroval a napadl!' }
                        }
                    }
                ]
            },
            {
                id: 'child_lost',
                name: 'Ztracen칠 d칤t캩',
                icon: '游놌',
                type: 'rescue',
                triggerChance: 0.06,
                minLevel: 2,
                description: 'Mal칠 d칤t캩 sed칤 samo u cesty a pl치캜e. Hled치 svou matku.',
                choices: [
                    { 
                        id: 'help_find', 
                        text: '游댌 Pomoz naj칤t matku', 
                        requirements: null,
                        outcome: {
                            quest: 'find_mother',
                            text: 'D칤t캩 ti ukazuje sm캩r. Mus칤코 naj칤t jeho matku do 20 minut!'
                        }
                    },
                    { 
                        id: 'give_food', 
                        text: '游꼤 Dej mu j칤dlo', 
                        requirements: { item: 'food' },
                        consumeItem: true,
                        outcome: {
                            success: { chance: 1.0, reward: { xp: 30, karma: 5 }, text: 'D칤t캩 se uklidn칤. Mo쬹치 ho n캩kdo najde.' }
                        }
                    },
                    { 
                        id: 'ignore_child', 
                        text: '游뛌 Jdi d치l', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, penalty: { karma: -3 }, text: 'Nech치v치코 d칤t캩 za sebou. Pl치캜 utich치 v d치lce.' }
                        }
                    }
                ]
            },
            
            // === MYSTERY EVENTS - Z치hadn칠 ud치losti ===
            {
                id: 'strange_signal',
                name: 'Z치hadn칳 sign치l',
                icon: '游니',
                type: 'mystery',
                triggerChance: 0.05,
                minLevel: 4,
                description: 'Tv칠 r치dio zachytilo 코ifrovanou zpr치vu. N캩kdo vol치 o pomoc!',
                choices: [
                    { 
                        id: 'follow', 
                        text: '游늸 Vysleduj sign치l', 
                        requirements: null,
                        outcome: {
                            quest: 'trace_signal',
                            text: 'Sign치l poch치z칤 z opu코t캩n칠 tov치rny severn캩 odsud...'
                        }
                    },
                    { 
                        id: 'decode', 
                        text: '游눹 Pokus se de코ifrovat (INT 7+)', 
                        requirements: { attr: { int: 7 } },
                        outcome: {
                            success: { chance: 0.7, reward: { xp: 50 }, text: 'Zpr치va zn칤: "Trezor... 4-7-2-9... pomoc..."', unlockLocation: 'hidden_vault' },
                            failure: { chance: 0.3, text: 'Nedok치쬰코 zpr치vu rozlu코tit.' }
                        }
                    },
                    { 
                        id: 'ignore_signal', 
                        text: '游닡 Vypni r치dio', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, text: 'Mo쬹치 past, mo쬹치 z치chrana. Nikdy se nedozv칤코.' }
                        }
                    }
                ]
            },
            {
                id: 'mysterious_trader',
                name: 'Z치hadn칳 obchodn칤k',
                icon: '游꿠',
                type: 'trade',
                triggerChance: 0.04,
                minLevel: 3,
                description: 'Podivn칳 mu v pl치코ti ti nab칤z칤 obchod. "M치m n캩co, co hled치코..."',
                choices: [
                    { 
                        id: 'trade_money', 
                        text: '游눯 Zapla콘 200 pen캩z', 
                        requirements: { money: 200 },
                        outcome: {
                            random: [
                                { chance: 0.3, reward: { items: ['legendary_weapon'] }, text: 'Dost치v치코 LEGEND츼RN칈 zbra켿!' },
                                { chance: 0.4, reward: { items: ['rare_armor'] }, text: 'Dost치v치코 vz치cnou zbroj.' },
                                { chance: 0.3, reward: { items: ['junk'] }, penalty: { money: -200 }, text: 'Je to jen haramp치d칤! Byl jsi okraden.' }
                            ]
                        }
                    },
                    { 
                        id: 'trade_item', 
                        text: '游꾸 Nab칤dni vz치cn칳 p콏edm캩t', 
                        requirements: { hasRareItem: true },
                        outcome: {
                            success: { chance: 0.8, reward: { money: 500, xp: 100 }, text: '"Zaj칤mav칠... Zde je tv치 odm캩na."' }
                        }
                    },
                    { 
                        id: 'attack_trader', 
                        text: '丘덢잺 Okra캞 ho', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['mysterious_trader'] },
                            victory: { reward: { money: 400, items: ['mystery_box'] }, penalty: { karma: -10 }, text: 'Porazil jsi ho. Co skr칳val?' },
                            defeat: { text: 'Miz칤 v d칳mu... "Uvid칤me se zase."' }
                        }
                    },
                    { 
                        id: 'decline', 
                        text: '游뛌 Odm칤tni', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, text: '"맒oda... P콏칤코t캩 mo쬹치." Miz칤 ve st칤nech.' }
                        }
                    }
                ]
            },
            
            // === OPPORTUNITY EVENTS - P콏칤le쬴tosti ===
            {
                id: 'abandoned_cache',
                name: 'Opu코t캩n치 skr칳코',
                icon: '游닍',
                type: 'loot',
                triggerChance: 0.1,
                minLevel: 1,
                description: 'V코칤m치코 si nen치padn칠ho vchodu do podzemn칤 skr칳코e.',
                choices: [
                    { 
                        id: 'enter_careful', 
                        text: '游댡 Vstup opatrn캩', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.6, reward: { money: 100, items: ['food', 'medkit'], resources: { metal: 5, electronics: 3 } }, text: 'Na코el jsi starou z치sob치rnu!' },
                            failure: { chance: 0.4, penalty: { hp: -15 }, text: 'Past! Aktivoval jsi alarm a zranil se.' }
                        }
                    },
                    { 
                        id: 'enter_force', 
                        text: '游눩 Vraz dovnit콏 (STR 6+)', 
                        requirements: { attr: { str: 6 } },
                        outcome: {
                            success: { chance: 0.8, reward: { money: 150, items: ['weapon', 'ammo'] }, text: 'Rozbil jsi dve콏e a vzal co bylo.' },
                            failure: { chance: 0.2, penalty: { hp: -25 }, text: 'Strop se z콏칤til!' }
                        }
                    },
                    { 
                        id: 'mark_location', 
                        text: '游딬勇 Ozna캜 na map캩 a jdi d치l', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, reward: { unlockLocation: 'marked_cache' }, text: 'Vr치t칤코 se sem pozd캩ji s lep코칤 v칳bavou.' }
                        }
                    }
                ]
            },
            {
                id: 'faction_conflict',
                name: 'Frak캜n칤 konflikt',
                icon: '丘덢잺',
                type: 'faction',
                triggerChance: 0.05,
                minLevel: 5,
                description: 'Voj치ci a n치jezdn칤ci se st콏etli! Ob캩 strany cht캩j칤 tvou pomoc.',
                choices: [
                    { 
                        id: 'help_military', 
                        text: '游꿌勇 Pomoz vojensk칳m', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['raider', 'raider', 'bandit'], allies: 2 },
                            victory: { reward: { money: 200, reputation: { military: 25, raiders: -20 } }, text: 'Voj치ci ti d캩kuj칤.' }
                        }
                    },
                    { 
                        id: 'help_raiders', 
                        text: '游 Pomoz n치jezdn칤k콢m', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['soldier', 'soldier'], allies: 3 },
                            victory: { reward: { money: 300, reputation: { raiders: 25, military: -20 } }, text: 'N치jezdn칤ci se s tebou pod캩l칤.' }
                        }
                    },
                    { 
                        id: 'wait_loot', 
                        text: '游녜勇 Po캜kej a seber ko콏ist', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.7, reward: { money: 150, items: ['ammo', 'medkit'] }, text: 'Sebral jsi co zbylo po boji.' },
                            failure: { chance: 0.3, text: 'P콏e쬴v코칤 t캩 zahl칠dl. Utekl jsi.' }
                        }
                    }
                ]
            }
        ];
        
        // ============================================================
        // === 낋 캛ASOV캨 LIMITOVAN칄 QUESTY ===
        // ============================================================
        const TIMED_QUESTS = [
            {
                id: 'find_mother',
                name: 'Najdi matku',
                icon: '游놌',
                description: 'Ztracen칠 d칤t캩 ti uk치zalo sm캩r. Najdi jeho matku ne bude pozd캩!',
                timeLimit: 45 * 60 * 1000, // 45 minut - realistick칳 캜as na cestu + hled치n칤
                objectives: [
                    { id: 'search_village', text: 'Prohledej okoln칤 vesnici', type: 'location', target: 'ruined_village' },
                    { id: 'find_mother', text: 'Najdi matku d칤t캩te', type: 'interact' }
                ],
                reward: { xp: 100, karma: 15, money: 150 },
                failureConsequence: {
                    text: 'Nepoda콏ilo se ti naj칤t matku v캜as. D칤t캩 z콢stalo samo...',
                    penalty: { karma: -10 }
                }
            },
            {
                id: 'trace_signal',
                name: 'Vysleduj sign치l',
                icon: '游니',
                description: 'Zachytil jsi nouzov칳 sign치l! N캩kdo pot콏ebuje pomoc!',
                timeLimit: 60 * 60 * 1000, // 60 minut - tov치rna je daleko
                objectives: [
                    { id: 'go_to_factory', text: 'Jdi k opu코t캩n칠 tov치rn캩', type: 'location', target: 'factory' },
                    { id: 'find_survivor', text: 'Najdi zdroj sign치lu', type: 'interact' }
                ],
                reward: { xp: 150, money: 200, items: ['rare_item'] },
                failureConsequence: {
                    text: 'Sign치l utichl... P콏i코el jsi pozd캩.',
                    penalty: { karma: -5 }
                }
            },
            {
                id: 'rescue_hostage',
                name: 'Z치chrana rukojm칤',
                icon: '낋',
                description: 'Banditi dr쮂 rukojm칤! Mus칤코 ho zachr치nit ne ho zabij칤!',
                timeLimit: 90 * 60 * 1000, // 90 minut - raider_camp je daleko + combat
                location: 'raider_camp',
                objectives: [
                    { id: 'go_to_camp', text: 'Jdi do t치bora n치jezdn칤k콢', type: 'location', target: 'raider_camp' },
                    { id: 'defeat_raiders', text: 'Poraz n치jezdn칤ky', type: 'combat', enemies: ['raider', 'raider', 'raider_boss'] },
                    { id: 'free_hostage', text: 'Osvobo캞 rukojm칤', type: 'interact' }
                ],
                reward: { money: 400, xp: 200, reputation: { traders: 20 }, companion: 'rescued_survivor' },
                failureConsequence: { 
                    text: 'Rukojm칤 byl zabit... Jeho rodina t캩 nikdy neodpust칤.',
                    penalty: { reputation: { traders: -15 }, karma: -10 }
                }
            },
            {
                id: 'deliver_medicine',
                name: 'Z치silka l칠k콢',
                icon: '游눍',
                description: 'Nemocn칳 osadn칤k um칤r치! Dones mu l칠ky z nemocnice!',
                timeLimit: 75 * 60 * 1000, // 75 minut - hospital je daleko (7,2) + zp캩t
                requiresItem: 'antibiotics',
                objectives: [
                    { id: 'get_medicine', text: 'Z칤skej antibiotika z nemocnice', type: 'item', target: 'antibiotics' },
                    { id: 'return_to_settlement', text: 'Dones l칠ky do osady', type: 'location', target: 'shelter' }
                ],
                reward: { xp: 150, reputation: { settlers: 15 }, unlockNPC: 'grateful_healer' },
                failureConsequence: {
                    text: 'Osadn칤k zem콏el. Mohl jsi ho zachr치nit...',
                    penalty: { settlers: -1, morale: -20 }
                }
            },
            {
                id: 'defuse_bomb',
                name: 'Tikaj칤c칤 bomba',
                icon: '游눢',
                description: 'N캩kdo um칤stil bombu v obchodn칤m centru! Mus칤코 ji zne코kodnit!',
                timeLimit: 45 * 60 * 1000, // 45 minut - trading_post (4,2) + hled치n칤
                location: 'trading_post',
                objectives: [
                    { id: 'find_bomb', text: 'Najdi bombu', type: 'search', location: 'trading_post' },
                    { id: 'defuse', text: 'Zne코kodni bombu (INT 6+ nebo n치stroje)', type: 'skill_check', attr: 'int', difficulty: 6 }
                ],
                reward: { money: 500, xp: 300, reputation: { traders: 30 } },
                failureConsequence: {
                    text: 'BOOM! Trading Post je zni캜en. Obchodn칤ci evakuovali ale ztratili v코e.',
                    penalty: { reputation: { traders: -25 }, destroyLocation: 'trading_post_destroyed' }
                }
            },
            {
                id: 'escape_horde',
                name: 'Zombie horda',
                icon: '游',
                description: 'Obrovsk치 horda zombie m칤콏칤 k tv칠 osad캩! M치코 m치lo 캜asu na p콏칤pravu!',
                timeLimit: 90 * 60 * 1000, // 90 minut - pot콏ebuje코 sehnat materi치l
                objectives: [
                    { id: 'build_defenses', text: 'Postav barik치dy (50 d콏eva, 30 kovu)', type: 'build', resources: { wood: 50, metal: 30 } },
                    { id: 'gather_weapons', text: 'P콏iprav zbran캩 pro osadn칤ky', type: 'collect', items: ['weapon', 'weapon', 'ammo'] },
                    { id: 'defend', text: 'P콏e쬴j 칰tok hordy', type: 'siege_combat' }
                ],
                reward: { xp: 500, money: 300, achievement: 'horde_survivor' },
                failureConsequence: {
                    text: 'Horda zni캜ila osadu. Mus칤코 za캜칤t znovu...',
                    penalty: { destroyBuildings: 2, settlers: -2 }
                }
            }
        ];
        
        // ============================================================
        // === 游댌 DETEKTIVN칈 QUESTY ===
        // ============================================================
        const DETECTIVE_QUESTS = [
            {
                id: 'murdered_trader',
                name: 'Vra쬯a obchodn칤ka',
                icon: '游댌',
                description: 'Star칳 obchodn칤k byl nalezen mrtv칳. Kdo ho zabil?',
                suspects: [
                    { id: 'jealous_rival', name: '콯치rliv칳 konkurent', icon: '游', clues: ['bloody_knife', 'torn_cloth'], motive: 'Obchodn칤 rivalita', isGuilty: false },
                    { id: 'angry_customer', name: 'Na코tvan칳 z치kazn칤k', icon: '游땫', clues: ['angry_letter', 'witness_testimony'], motive: 'Podveden칳 obchod', isGuilty: true },
                    { id: 'mysterious_woman', name: 'Z치hadn치 쬰na', icon: '游댩', clues: ['perfume_bottle', 'love_letter'], motive: 'Odm칤tnut치 l치ska', isGuilty: false },
                    { id: 'debt_collector', name: 'Vymaha캜 dluh콢', icon: '游눯', clues: ['debt_note', 'brass_knuckles'], motive: 'Nesplacen칳 dluh', isGuilty: false }
                ],
                clueLocations: {
                    'bloody_knife': 'trading_post',
                    'torn_cloth': 'old_farm',
                    'angry_letter': 'abandoned_house',
                    'witness_testimony': 'trader_camp',
                    'perfume_bottle': 'hospital',
                    'love_letter': 'shelter',
                    'debt_note': 'bucovice',
                    'brass_knuckles': 'police_station'
                },
                interrogationQuestions: [
                    { question: 'Kde jsi byl v noci vra쬯y?', truthful: ['angry_customer'], lie: ['jealous_rival', 'debt_collector'] },
                    { question: 'Znal jsi ob캩콘 osobn캩?', truthful: ['jealous_rival', 'mysterious_woman'], lie: ['angry_customer'] },
                    { question: 'M치코 alibi?', truthful: ['mysterious_woman', 'jealous_rival'], lie: ['angry_customer', 'debt_collector'] }
                ],
                requiredClues: 3,
                reward: { money: 500, xp: 300, reputation: { traders: 25 }, title: 'Detektiv' },
                wrongAccusation: { penalty: { reputation: { traders: -20 }, karma: -5 }, text: 'Obvinil jsi nevinn칠ho!' }
            },
            {
                id: 'missing_child',
                name: 'Zmizen칤 d칤t캩te',
                icon: '游놌',
                description: 'D칤t캩 zmizelo z osady. Rodi캜e jsou zoufal칤. Najdi ho!',
                suspects: [
                    { id: 'creepy_hermit', name: 'Podivn칳 poustevn칤k', icon: '游븿', clues: ['child_toy', 'footprints'], motive: 'Samota', isGuilty: false },
                    { id: 'slaver_gang', name: 'Gang otrok치콏콢', icon: '久勇', clues: ['slaver_note', 'cage_marks'], motive: 'Prodej', isGuilty: true },
                    { id: 'wild_animals', name: 'Divok치 zv칤콏ata', icon: '游냨', clues: ['torn_clothes', 'blood_trail'], motive: 'Lov', isGuilty: false }
                ],
                clueLocations: {
                    'child_toy': 'forest_edge',
                    'footprints': 'old_farm',
                    'slaver_note': 'raider_camp',
                    'cage_marks': 'abandoned_mine',
                    'torn_clothes': 'dense_forest',
                    'blood_trail': 'hunters_cabin'
                },
                timeLimit: 60 * 60 * 1000, // 1 hodina - d칤t캩 je v nebezpe캜칤!
                requiredClues: 2,
                reward: { xp: 400, reputation: { settlers: 30 }, companion: 'grateful_parent', karma: 20 },
                wrongAccusation: { penalty: { time: -15 * 60 * 1000 }, text: 'Ztratil jsi 캜as! D칤t캩 je st치le v nebezpe캜칤!' },
                failureConsequence: { text: 'D칤t캩 nebylo nalezeno v캜as...', penalty: { karma: -15, reputation: { settlers: -20 } } }
            },
            {
                id: 'poisoned_well',
                name: 'Otr치ven치 studna',
                icon: '游',
                description: 'N캩kdo otr치vil hlavn칤 zdroj vody! Lid칠 um칤raj칤. Najdi vin칤ka!',
                suspects: [
                    { id: 'mad_scientist', name: '먞셟en칳 v캩dec', icon: '游빍', clues: ['chemical_residue', 'lab_notes'], motive: 'Experiment', isGuilty: false },
                    { id: 'enemy_faction', name: 'Nep콏치telsk치 frakce', icon: '游', clues: ['faction_symbol', 'poison_vial'], motive: 'Oslaben칤', isGuilty: true },
                    { id: 'revenge_seeker', name: 'Mstitel', icon: '游땓', clues: ['revenge_letter', 'family_photo'], motive: 'Pomsta za smrt rodiny', isGuilty: false }
                ],
                clueLocations: {
                    'chemical_residue': 'water_well',
                    'lab_notes': 'research_facility',
                    'faction_symbol': 'military_outpost',
                    'poison_vial': 'chemical_plant',
                    'revenge_letter': 'old_bunker',
                    'family_photo': 'abandoned_house'
                },
                requiredClues: 3,
                reward: { money: 400, xp: 350, reputation: { settlers: 25 }, unlockCure: 'antidote_recipe' },
                wrongAccusation: { penalty: { reputation: { settlers: -15 } }, text: 'Skute캜n칳 vin칤k unikl!' }
            }
        ];
        
        // ============================================================
        // === 游논 COMPANION QUESTY ===
        // ============================================================
        const COMPANION_QUESTS = {
            'dog': {
                name: 'V캩rn칳 p콏칤tel',
                icon: '游냇',
                chapters: [
                    {
                        id: 'dog_past',
                        title: 'Stopy minulosti',
                        description: 'Tv콢j pes se chov치 divn캩 pobl칤 star칠 farmy. M치 tam n캩jakou vazbu?',
                        trigger: { location: 'old_farm', loyalty: 30 },
                        objectives: [
                            { text: 'Prozkoumej starou farmu s psem', type: 'explore', target: 'old_farm' },
                            { text: 'Najdi star칳 obojek', type: 'item', target: 'old_collar' }
                        ],
                        dialog: {
                            start: 'Tv콢j pes za캜ne k켿u캜et a hrabat v trosk치ch. Zd치 se, 쬰 tu kdysi 쬴l...',
                            complete: 'Na코el jsi star칳 obojek. Pes se na tebe vd캩캜n캩 pod칤v치. Kone캜n캩 v칤, k칳m byl.'
                        },
                        reward: { companionXP: 100, skill: 'tracking', bond: 20 }
                    },
                    {
                        id: 'dog_revenge',
                        title: 'Pomsta za p치na',
                        description: 'Pes vy캜enichal stopu t캩ch, kdo zabili jeho p콢vodn칤 rodinu.',
                        trigger: { previousQuest: 'dog_past', loyalty: 60 },
                        objectives: [
                            { text: 'Sleduj psovu stopu k t치boru', type: 'location', target: 'raider_camp' },
                            { text: 'Pomoz psovi porazit n치jezdn칤ky', type: 'combat', enemies: ['raider', 'raider_boss'] }
                        ],
                        dialog: {
                            start: 'Pes vr캜칤. Poznal pach t캩ch, kte콏칤 mu vzali v코e...',
                            complete: 'Spravedlnosti bylo u캜in캩no zadost. Pes ti l칤z치 ruku - jste te캞 rodina.'
                        },
                        reward: { companionXP: 200, skill: 'fury', bond: 30 }
                    }
                ]
            },
            'warrior': {
                name: 'Cesta v치le캜n칤ka',
                icon: '丘덢잺',
                chapters: [
                    {
                        id: 'warrior_honor',
                        title: 'Ztracen치 캜est',
                        description: 'V치le캜n칤k ti vypr치v칤 o bitv캩, kde ztratil svou jednotku.',
                        trigger: { location: 'military_base', loyalty: 35 },
                        objectives: [
                            { text: 'Prozkoumej vojenskou z치kladnu', type: 'explore', target: 'military_base' },
                            { text: 'Najdi identifika캜n칤 zn치mky padl칳ch', type: 'item', target: 'dogtags' }
                        ],
                        dialog: {
                            start: '"Tady to bylo... V코ichni padli. Jen j치 jsem p콏e쬴l. Mo쬹치... mo쬹치 bychom je mohli poh콏b칤t."',
                            complete: '"D캩kuji. Kone캜n캩 mohou odpo캜칤vat v pokoji. A j치... j치 mohu j칤t d치l."'
                        },
                        reward: { companionXP: 150, skill: 'veteran', bond: 25 }
                    },
                    {
                        id: 'warrior_redemption',
                        title: 'Vykoupen칤 v boji',
                        description: 'V치le캜n칤k chce dokon캜it posledn칤 misi sv칠 jednotky.',
                        trigger: { previousQuest: 'warrior_honor', loyalty: 70 },
                        objectives: [
                            { text: 'Jdi do tajn칠ho bunkru', type: 'location', target: 'underground_bunker' },
                            { text: 'Poraz velitele mutant콢', type: 'combat', target: 'mutant_boss' },
                            { text: 'Z칤skej tajn칠 dokumenty', type: 'item', target: 'secret_documents' }
                        ],
                        dialog: {
                            start: '"Na코e mise byla z칤skat tyto dokumenty. Te캞 ji dokon캜칤me - spole캜n캩."',
                            complete: '"Mise spln캩na. Po tolika letech... Jsi nejlep코칤 velitel, jak칠ho jsem kdy m캩l."'
                        },
                        reward: { companionXP: 300, stats: { damage: 5, defense: 3 }, bond: 40 }
                    }
                ]
            },
            'medic_npc': {
                name: 'L칠캜itelovo tajemstv칤',
                icon: '游녿꽥뚯勇',
                chapters: [
                    {
                        id: 'medic_past',
                        title: 'Nemocnice hr콢zy',
                        description: 'Medik nechce mluvit o tom, co se stalo v nemocnici b캩hem apokalypsy.',
                        trigger: { location: 'hospital', loyalty: 30 },
                        objectives: [
                            { text: 'Prozkoumej nemocnici', type: 'explore', target: 'hospital' },
                            { text: 'Najdi medic칤nsk칠 z치znamy', type: 'item', target: 'medical_records' }
                        ],
                        dialog: {
                            start: '"Ne... Nechci sem. Ale... mo쬹치 je 캜as se s t칤m vyrovnat."',
                            complete: '"Nemohl jsem je zachr치nit. Ale te캞... te캞 zachr치n칤m tolik lid칤, kolik bude mo쬹칠."'
                        },
                        reward: { companionXP: 100, skill: 'trauma_surgeon', bond: 20 }
                    },
                    {
                        id: 'medic_cure',
                        title: 'Hled치n칤 l칠ku',
                        description: 'Medik v캩콏칤, 쬰 existuje l칠k na mutaci. Pomoz mu ho naj칤t.',
                        trigger: { previousQuest: 'medic_past', loyalty: 65 },
                        objectives: [
                            { text: 'Jdi do v칳zkumn칠ho za콏칤zen칤', type: 'location', target: 'research_facility' },
                            { text: 'Z칤skej vzorky z laborato콏e', type: 'item', target: 'lab_samples' },
                            { text: 'Vra콘 se do osady', type: 'location', target: 'shelter' }
                        ],
                        dialog: {
                            start: '"Vid캩l jsem v z치znamech zm칤nku o experiment치ln칤m l칠ku. Mus칤me ho naj칤t!"',
                            complete: '"M치me ho! S t칤mhle m콢쬰me l칠캜it prvn칤 st치dia mutace. Zachr치nili jsme budoucnost."'
                        },
                        reward: { companionXP: 250, skill: 'miracle_worker', bond: 35, unlockRecipe: 'mutation_cure' }
                    }
                ]
            }
        };
        
        // Helper pro kontrolu podm칤nek companion quest콢
        function checkCompanionQuestTrigger(companionId, questChapter) {
            const comp = state.companions?.find(c => c.id === companionId);
            if (!comp) return false;
            
            const trigger = questChapter.trigger;
            
            if (trigger.location && state.world.currentLocation !== trigger.location) return false;
            if (trigger.loyalty && (comp.loyalty || 0) < trigger.loyalty) return false;
            if (trigger.daysWithCompanion && (comp.daysActive || 0) < trigger.daysWithCompanion) return false;
            if (trigger.previousQuest && !comp.completedQuests?.includes(trigger.previousQuest)) return false;
            if (trigger.choice && comp.questChoices?.[trigger.previousQuest] !== trigger.choice) return false;
            
            return true;
        }
        
        const GAME_VERSION = '2.5.1';
        const VERSION_DATE = '2025-01-11';
        
        // === NOV칗 MAPOV칗 SYST칄M - LOKACE ===
        // === VELK츼 MAPA SV캨TA - 50+ LOKAC칈 ===
        // Pozice: x,y kde shelter je 0,0. Ka쬯칳 bod m콏칤쬶y = 0.5 km
        // Rychlost ch콢ze: 1 km = 6 minut (10 km/h je b캩h, 5 km/h ch콢ze)
        const GRID_SIZE_KM = 2; // Ka쬯칳 bod m콏칤쬶y = 2 km
        const WALK_SPEED_MIN_PER_KM = 12; // 12 minut na 1 km ch콢ze (5 km/h)
        
        const WORLD_LOCATIONS = [
            // === CENTRUM - 칔KRYT (0,0) ===
            { id: 'shelter', name: 'Tv콢j 칰kryt', icon: '游', type: 'home', zone: 'safe', x: 0, y: 0,
              desc: 'Tvoje z치kladna. Bezpe캜n칠 m칤sto pro odpo캜inek a spr치vu osady.' },
            
            // === BEZPE캛N츼 Z칍NA (bl칤zko 칰krytu) - do 1 km ===
            { id: 'water_well', name: 'Star치 studna', icon: '游눦', type: 'resource', zone: 'safe', x: 1, y: 0,
              desc: 'Zdroj relativn캩 캜ist칠 vody.', resource: 'water' },
            { id: 'forest_edge', name: 'Okraj lesa', icon: '游', type: 'explore', zone: 'safe', x: 0, y: -1,
              desc: 'Klidn칳 les. Dobr칳 pro lov a sb캩r d콏eva.', enemies: ['rat', 'wild_dog'], dangerLevel: 1 },
            { id: 'old_farm', name: 'Star치 farma', icon: '游끸勇', type: 'explore', zone: 'safe', x: -1, y: 0,
              desc: 'Opu코t캩n치 farma. J칤dlo a l치tky.', enemies: ['rat', 'wild_dog', 'feral'], dangerLevel: 1 },
            { id: 'trader_camp', name: 'T치bor obchodn칤k콢', icon: '久', type: 'shop', zone: 'safe', x: 2, y: 1,
              desc: 'Mal칳 obchodn칤 t치bor. Z치kladn칤 zbo쮂.' },
            { id: 'small_pond', name: 'Mal칳 rybn칤k', icon: '游', type: 'resource', zone: 'safe', x: -1, y: -1,
              desc: 'Klidn칠 m칤sto na ryba콏en칤.', actions: ['fish'], spots: 2 },
            { id: 'berry_bushes', name: 'K콏ov칤 s bobulemi', icon: '游삃', type: 'resource', zone: 'safe', x: 0, y: 1,
              desc: 'Jedl칠 bobule a byliny.' },
            { id: 'old_shed', name: 'Star치 k콢lna', icon: '游띘', type: 'explore', zone: 'safe', x: 1, y: -1,
              desc: 'Rozpadl치 k콢lna. N치stroje a d콏evo.', dangerLevel: 1 },
            { id: 'campsite', name: 'T치bo콏i코t캩', icon: '游끳勇', type: 'rest', zone: 'safe', x: -2, y: -1,
              desc: 'Bezpe캜n칠 m칤sto pro odpo캜inek.' },
            
            // === NOV칗 ZA캛츼TE캛NICK칗 DUNGEON ===
            { id: 'old_cellar', name: 'Star칳 sklep', icon: '游뛁', type: 'dungeon', zone: 'safe', x: -1, y: 2,
              desc: 'Podzemn칤 sklep pod z콏칤cenou budovou. Tv콢j prvn칤 dungeon!', enemies: ['rat', 'giant_rat'], dangerLevel: 1 },
              
            // === ST콎EDN칈 Z칍NA - SEVER (1-3 km) ===
            { id: 'dense_forest', name: 'Hust칳 les', icon: '游꺕', type: 'explore', zone: 'medium', x: 0, y: -3,
              desc: 'Temn칳 les pln칳 zv캩콏e.', enemies: ['wild_dog', 'wolf'], dangerLevel: 2 },
            { id: 'hunters_cabin', name: 'Loveck치 chata', icon: '游끳勇', type: 'rest', zone: 'medium', x: 2, y: -3,
              desc: 'Opu코t캩n치 chata lovce. Odpo캜inek a loot.', enemies: ['wild_dog'], dangerLevel: 2 },
            { id: 'old_sawmill', name: 'Star치 pila', icon: '游뿤', type: 'explore', zone: 'medium', x: -2, y: -3,
              desc: 'Zdroj d콏eva a n치stroj콢.', enemies: ['raider_weak'], dangerLevel: 2 },
            { id: 'mountain_pass', name: 'Horsk칳 pr콢smyk', icon: '久썶잺', type: 'explore', zone: 'medium', x: 0, y: -5,
              desc: 'Nebezpe캜n치 cesta p콏es hory.', enemies: ['wolf', 'bandit'], dangerLevel: 3 },
            { id: 'abandoned_mine', name: 'Opu코t캩n칳 d콢l', icon: '久勇', type: 'dungeon', zone: 'medium', x: -3, y: -4,
              desc: 'Temn칳 d콢l. Kovy a nebezpe캜칤.', enemies: ['mutant_rat', 'cave_spider'], dangerLevel: 3, radiation: 5 },
            
            // === ST콎EDN칈 Z칍NA - JIH (1-3 km) ===
            { id: 'ruined_village', name: 'Zni캜en치 vesnice', icon: '游끶勇', type: 'explore', zone: 'medium', x: 0, y: 3,
              desc: 'Opu코t캩n치 vesnice. Loot v domech.', enemies: ['raider_weak', 'wild_dog'], dangerLevel: 2 },
            { id: 'old_church', name: 'Star칳 kostel', icon: '久', type: 'explore', zone: 'medium', x: 2, y: 3,
              desc: 'Posv치tn칠 m칤sto, te캞 opu코t캩n칠.', enemies: ['ghost'], dangerLevel: 2 },
            { id: 'cemetery', name: 'H콏bitov', icon: '游뿭', type: 'explore', zone: 'medium', x: -2, y: 3,
              desc: 'D캩siv칠 m칤sto. Vz치cn칳 loot.', enemies: ['ghoul'], dangerLevel: 3 },
            { id: 'swamp', name: 'Ba쬴na', icon: '游낽', type: 'dangerous', zone: 'medium', x: 0, y: 5,
              desc: 'Nebezpe캜n치 ba쬴na. Radiace a mutanti.', enemies: ['mutant_frog', 'swamp_creature'], dangerLevel: 3, radiation: 8 },
            
            // === ST콎EDN칈 Z칍NA - Z츼PAD (1-3 km) ===
            { id: 'highway', name: 'Star치 d치lnice', icon: '游띢勇', type: 'explore', zone: 'medium', x: -3, y: 0,
              desc: 'Opu코t캩n치 d치lnice. Vraky aut.', enemies: ['raider'], dangerLevel: 2 },
            { id: 'gas_station', name: 'Benz칤nka', icon: '久', type: 'resource', zone: 'medium', x: -3, y: 2,
              desc: 'Zdroj paliva.', enemies: ['raider'], dangerLevel: 2, resource: 'fuel' },
            { id: 'motel', name: 'Opu코t캩n칳 motel', icon: '游낃', type: 'explore', zone: 'medium', x: -3, y: -2,
              desc: 'Rozpadl칳 motel. Mo쬹치 p콏e쬴v코칤?', enemies: ['raider_weak', 'feral'], dangerLevel: 2 },
            { id: 'junkyard', name: 'Vrakovi코t캩', icon: '游뚱', type: 'explore', zone: 'medium', x: -5, y: 0,
              desc: 'Hromady 코rotu. Kov a d칤ly.', enemies: ['wild_dog', 'raider'], dangerLevel: 2 },
            
            // === ST콎EDN칈 Z칍NA - V칗CHOD (1-3 km) ===
            { id: 'radio_tower', name: 'Vys칤la캜', icon: '游니', type: 'radio', zone: 'medium', x: 3, y: 0,
              desc: 'Star치 r치diov치 v캩. Lze tu zachytit sign치ly.', enemies: ['raider'], dangerLevel: 2 },
            { id: 'workshop', name: 'D칤lna mechanika', icon: '游댢', type: 'service', zone: 'medium', x: 3, y: -2,
              desc: 'Opravy zbran칤 a zbroje.' },
            { id: 'warehouse', name: 'Sklad', icon: '游닍', type: 'explore', zone: 'medium', x: 5, y: 0,
              desc: 'Velk칳 sklad. Hodn캩 lootu.', enemies: ['raider', 'mutant_dog'], dangerLevel: 2 },
            
            // === NEBEZPE캛N츼 Z칍NA - SEVER (3-5 km) ===
            { id: 'frozen_lake', name: 'Zamrzl칠 jezero', icon: '游븱', type: 'dangerous', zone: 'danger', x: 0, y: -7,
              desc: 'Nebezpe캜n칳 led. Mutantn칤 ryby.', enemies: ['ice_mutant'], dangerLevel: 4, radiation: 5 },
            { id: 'military_outpost', name: 'Vojensk치 hl칤dka', icon: '游꿌勇', type: 'dungeon', zone: 'danger', x: 3, y: -6,
              desc: 'Opu코t캩n치 vojensk치 pozice.', enemies: ['soldier_zombie', 'robot'], dangerLevel: 4 },
            { id: 'research_camp', name: 'V칳zkumn칳 t치bor', icon: '游댧', type: 'explore', zone: 'danger', x: -3, y: -6,
              desc: 'V캩deck치 expedice zmizela...', enemies: ['mutant', 'experiment'], dangerLevel: 4, radiation: 10 },
            
            // === NEBEZPE캛N츼 Z칍NA - JIH (3-5 km) ===
            { id: 'toxic_lake', name: 'Toxick칠 jezero', icon: '驕뮖잺', type: 'dangerous', zone: 'danger', x: 0, y: 7,
              desc: 'Siln캩 radioaktivn칤 voda.', enemies: ['mutant_fish', 'swamp_beast'], dangerLevel: 4, radiation: 15 },
            { id: 'raider_camp', name: 'T치bor n치jezdn칤k콢', icon: '丘덢잺', type: 'hostile', zone: 'danger', x: 3, y: 6,
              desc: 'Hlavn칤 z치kladna n치jezdn칤k콢.', enemies: ['raider', 'raider_boss'], dangerLevel: 4, isRaid: true },
            { id: 'slave_camp', name: 'Otrok치콏sk칳 t치bor', icon: '久勇', type: 'hostile', zone: 'danger', x: -3, y: 6,
              desc: 'Osvobo캞 zajatce!', enemies: ['slaver', 'slaver_boss'], dangerLevel: 4, isRaid: true },
            
            // === NEBEZPE캛N츼 Z칍NA - Z츼PAD (3-5 km) ===
            { id: 'factory', name: 'Toxick치 tov치rna', icon: '游낈', type: 'dungeon', zone: 'danger', x: -7, y: 0,
              desc: 'Chemick치 tov치rna. Jedy a mutanti.', enemies: ['mutant', 'toxic_beast'], dangerLevel: 4, radiation: 12 },
            { id: 'power_plant', name: 'Elektr치rna', icon: '丘', type: 'dungeon', zone: 'danger', x: -7, y: 2,
              desc: 'Nebezpe캜n치, ale cenn치.', enemies: ['robot', 'electric_mutant'], dangerLevel: 4, radiation: 8 },
            { id: 'chemical_plant', name: 'Chemi캜ka', icon: '游빍', type: 'dungeon', zone: 'danger', x: -7, y: -2,
              desc: 'Chemik치lie a nebezpe캜칤.', enemies: ['toxic_zombie', 'acid_beast'], dangerLevel: 4, radiation: 10 },
            
            // === NEBEZPE캛N츼 Z칍NA - V칗CHOD (3-5 km) ===
            { id: 'ruined_city', name: 'Zni캜en칠 m캩sto', icon: '游끸勇', type: 'explore', zone: 'danger', x: 7, y: 0,
              desc: 'Velk칠 m캩sto v ruin치ch.', enemies: ['raider', 'mutant', 'feral'], dangerLevel: 4 },
            { id: 'hospital', name: 'Nemocnice', icon: '游낀', type: 'medical', zone: 'danger', x: 7, y: 2,
              desc: 'L칠ky a nebezpe캜칤.', enemies: ['feral', 'mutant'], dangerLevel: 4 },
            { id: 'police_station', name: 'Policejn칤 stanice', icon: '游뚮', type: 'dungeon', zone: 'danger', x: 7, y: -2,
              desc: 'Zbran캩 a munice.', enemies: ['zombie_cop', 'feral'], dangerLevel: 4 },
            { id: 'shopping_mall', name: 'N치kupn칤 centrum', icon: '游', type: 'explore', zone: 'danger', x: 9, y: 0,
              desc: 'Obrovsk칠, pln칠 lootu i nebezpe캜칤.', enemies: ['raider', 'feral', 'mutant'], dangerLevel: 4 },
            
            // === SMRTELN츼 Z칍NA (5+ km) ===
            { id: 'military_base', name: 'Vojensk치 z치kladna', icon: '游꿌勇', type: 'dungeon', zone: 'deadly', x: 0, y: -10,
              desc: 'T캩쬮e st콏e쬰n치. Nejlep코칤 v칳bava.', enemies: ['soldier', 'robot', 'turret'], dangerLevel: 5, isBoss: true },
            { id: 'nuclear_plant', name: 'Jadern치 elektr치rna', icon: '驕뮖잺', type: 'dungeon', zone: 'deadly', x: -10, y: 0,
              desc: 'Extr칠mn칤 radiace. Legend치rn칤 loot.', enemies: ['glowing_one', 'mutant_behemoth'], dangerLevel: 5, radiation: 25 },
            { id: 'underground_bunker', name: 'Tajn칳 bunkr', icon: '游뛁', type: 'dungeon', zone: 'deadly', x: 10, y: -3,
              desc: 'P콏edv치le캜n칳 bunkr. Kdo v칤 co je uvnit콏?', enemies: ['robot', 'turret', 'ai_guardian'], dangerLevel: 5, isSecret: true },
            { id: 'crater', name: 'Kr치ter', icon: '游눤', type: 'dangerous', zone: 'deadly', x: 0, y: 10,
              desc: 'M칤sto dopadu bomby. Extr칠mn캩 nebezpe캜n칠.', enemies: ['glowing_ghoul', 'irradiated_beast'], dangerLevel: 5, radiation: 30 },
            { id: 'wasteland_depths', name: 'Hlubiny pustiny', icon: '游', type: 'explore', zone: 'deadly', x: -6, y: -8,
              desc: 'Nejnebezpe캜n캩j코칤 oblast sv캩ta.', enemies: ['deathclaw', 'mutant_giant'], dangerLevel: 5, radiation: 20 },
            { id: 'mutant_nest', name: 'Hn칤zdo mutant콢', icon: '游돕勇', type: 'hostile', zone: 'deadly', x: 6, y: 8,
              desc: 'Hlavn칤 hn칤zdo mutant콢.', enemies: ['mutant', 'mutant_brute', 'mutant_queen'], dangerLevel: 5, isBoss: true },
            
            // === SPECI츼LN칈 LOKACE ===
            { id: 'abandoned_house', name: 'Opu코t캩n칳 d콢m', icon: '游끸勇', type: 'npc', zone: 'safe', x: 2, y: -1,
              desc: 'Tajemn칳 opu코t캩n칳 d콢m. N캩kdo tu mo쬹치 쬴je...', enemies: ['rat'], dangerLevel: 1 },
            { id: 'research_facility', name: 'V칳zkumn칠 za콏칤zen칤', icon: '游댧', type: 'npc', zone: 'danger', x: 5, y: -5,
              desc: 'V캩deck치 laborato콏. Koudy tu pracuje na z치chran캩 sv캩ta.', enemies: ['mutant', 'experiment'], dangerLevel: 4, radiation: 8 },
            { id: 'trading_post', name: 'Obchodn칤 stanice', icon: '游낅', type: 'shop', zone: 'medium', x: 4, y: 2,
              desc: 'Hlavn칤 obchodn칤 centrum oblasti. Kory m치 tu svou z치kladnu.' },
            { id: 'secret_lab', name: 'Tajn치 laborato콏', icon: '游빎', type: 'dungeon', zone: 'danger', x: -5, y: -6,
              desc: 'Skryt치 laborato콏 pln치 tajemstv칤 o Projektu Genesis.', enemies: ['mutant', 'robot', 'experiment'], dangerLevel: 4, radiation: 12 },
            { id: 'old_bunker', name: 'Star칳 bunkr', icon: '游뛁', type: 'dungeon', zone: 'deadly', x: 8, y: -8,
              desc: 'P콏edv치le캜n칳 bunkr. M칤sto kde v코e za캜alo...', enemies: ['robot', 'turret', 'ai_guardian'], dangerLevel: 5, isSecret: true },
            { id: 'wandering_merchant', name: 'Potuln칳 obchodn칤k', icon: '游냙', type: 'shop', zone: 'medium', x: -4, y: 4,
              desc: 'Vz치cn칳 obchodn칤k s exotick칳m zbo쮂셠.' },
            { id: 'hermit_hut', name: 'Poustevn칤kova chata', icon: '游븿', type: 'npc', zone: 'medium', x: 4, y: -4,
              desc: 'Star칳 mudrc. Mo쬹치 m치 quest?' },
            { id: 'safehouse', name: '칔kryt p콏e쬴v코칤ch', icon: '游', type: 'settlement', zone: 'medium', x: -5, y: 4,
              desc: 'Mal치 osada p콏e쬴v코칤ch. Bezpe캜n칠 m칤sto.' },
            
            // === DAL먞 M칈STA PRO HUSTOTU MAPY ===
            { id: 'crossroads', name: 'K콏i쬺vatka', icon: '游', type: 'npc', zone: 'safe', x: 2, y: 2,
              desc: 'K콏i쬺vatka cest. 만rif Kowalski tu hl칤d치 po콏치dek.' },
            { id: 'empty_field', name: 'Pr치zdn칠 pole', icon: '游', type: 'empty', zone: 'safe', x: -2, y: 1,
              desc: 'Opu코t캩n칠 pole. Klid.' },
            { id: 'broken_bridge', name: 'Rozbit칳 most', icon: '游깰', type: 'npc', zone: 'medium', x: 4, y: 4,
              desc: 'Most p콏es 콏eku. Posel Jin tu p콏ed치v치 zpr치vy.' },
            { id: 'dried_riverbed', name: 'Vyschl칠 koryto', icon: '游끺勇', type: 'explore', zone: 'medium', x: -4, y: -3,
              desc: 'Star치 콏eka. Ob캜as se tu n캩co najde.', dangerLevel: 1 },
            { id: 'watchtower', name: 'Str치쬹칤 v캩', icon: '游딮', type: 'explore', zone: 'medium', x: 5, y: -4,
              desc: 'Star치 v캩. Dobr칳 rozhled.', enemies: ['raider'], dangerLevel: 2 },
            { id: 'roadside_camp', name: 'T치bor u cesty', icon: '久', type: 'rest', zone: 'medium', x: -5, y: -3,
              desc: 'Opu코t캩n칳 t치bor. Mo쬹치 odpo캜inek?' },
            { id: 'old_bridge', name: 'Star칳 most', icon: '游깰', type: 'empty', zone: 'medium', x: 0, y: -2,
              desc: 'Kamenn칳 most p콏es potok.' },
            { id: 'ruins_north', name: 'Severn칤 ruiny', icon: '游끹勇', type: 'explore', zone: 'danger', x: 2, y: -5,
              desc: 'Star칠 ruiny. Nebezpe캜n칠.', enemies: ['ghoul', 'raider'], dangerLevel: 3 },
            { id: 'ruins_south', name: 'Ji쬹칤 ruiny', icon: '游끹勇', type: 'explore', zone: 'danger', x: -2, y: 5,
              desc: 'Rozpadl칠 budovy.', enemies: ['mutant', 'feral'], dangerLevel: 3 },
            
            // === PR츼ZDN칄 LOKACE - HUSTOTA MAPY ===
            // Bezpe캜n치 z칩na
            { id: 'empty_01', name: 'Pra코n치 cesta', icon: '游띣勇', type: 'empty', zone: 'safe', x: 1, y: 1, desc: 'Jen prach a kamen칤.' },
            { id: 'empty_02', name: 'Such칠 k콏ov칤', icon: '游', type: 'empty', zone: 'safe', x: -1, y: 1, desc: 'Uschl칠 ke콏e.' },
            { id: 'empty_03', name: 'Rozbit치 cesta', icon: '游띣勇', type: 'empty', zone: 'safe', x: 0, y: 2, desc: 'Popraskan칳 asfalt.' },
            { id: 'empty_04', name: 'Hol치 pl치켿', icon: '游끺勇', type: 'empty', zone: 'safe', x: 2, y: 0, desc: 'Pr치zdn치 pustina.' },
            { id: 'empty_05', name: 'Spadl칳 strom', icon: '游뿻', type: 'empty', zone: 'safe', x: -2, y: -2, desc: 'Star칳 padl칳 strom.' },
            { id: 'empty_06', name: 'P칤se캜n치 duna', icon: '游끴勇', type: 'empty', zone: 'safe', x: 1, y: 2, desc: 'Mal치 p칤se캜n치 duna.' },
            
            // === BU캛OVICE - HLAVN칈 M캨STO ===
            { id: 'bucovice', name: 'Bu캜ovice', icon: '游낋', type: 'city', zone: 'safe', x: -2, y: 2,
              desc: 'Starobyl칠 m캩sto, jedno z m치la kter칠 p콏e쬴lo apokalypsu vcelku. Centrum obchodu a civilizace v pustin캩.',
              special: 'main_city' },
            
            // St콏edn칤 z칩na - sever
            { id: 'quarry_01', name: 'Skalnat치 str치켿', icon: '游뿯', type: 'mine', zone: 'medium', x: 1, y: -2, desc: 'Strm칠 sk치ly bohat칠 na k치men a rudu. Ide치ln칤 m칤sto pro t캩쬭u.', danger: 0.1 },
            { id: 'empty_09', name: 'Mrtv칳 les', icon: '游', type: 'empty', zone: 'medium', x: -1, y: -2, desc: 'Uschl칠 stromy.' },
            { id: 'empty_10', name: 'Zarostl치 cesta', icon: '游', type: 'empty', zone: 'medium', x: 1, y: -3, desc: 'Cesta zarostl치 plevelem.' },
            { id: 'empty_11', name: 'Opu코t캩n칳 t치bor', icon: '游끸勇', type: 'empty', zone: 'medium', x: -1, y: -3, desc: 'Pr치zdn칠 stanovi코t캩.' },
            { id: 'empty_12', name: 'Rozbit칠 auto', icon: '游뚱', type: 'empty', zone: 'medium', x: 1, y: -4, desc: 'Rezav칳 vrak auta.' },
            { id: 'empty_13', name: 'Kamenn칠 trosky', icon: '游빔', type: 'empty', zone: 'medium', x: -1, y: -4, desc: 'Zbytky n캩jak칠 stavby.' },
            { id: 'empty_14', name: 'Pr치zdn치 j치ma', icon: '游돕勇', type: 'empty', zone: 'medium', x: 0, y: -4, desc: 'Hlubok치 d칤ra v zemi.' },
            
            // St콏edn칤 z칩na - jih
            { id: 'empty_15', name: 'Sp치leni코t캩', icon: '游댠', type: 'empty', zone: 'medium', x: 1, y: 3, desc: 'Sp치len치 zem캩.' },
            { id: 'empty_16', name: 'Rezav칳 plot', icon: '游뚾', type: 'empty', zone: 'medium', x: -1, y: 3, desc: 'Star칳 kovov칳 plot.' },
            { id: 'empty_17', name: 'Rozpadl치 ze캞', icon: '游빔', type: 'empty', zone: 'medium', x: 1, y: 4, desc: 'Zbytky cihlov칠 zdi.' },
            { id: 'empty_18', name: 'Bahnit치 lou쬰', icon: '游눦', type: 'empty', zone: 'medium', x: -1, y: 4, desc: '맗inav치 voda.' },
            { id: 'empty_19', name: 'Opu코t캩n치 코achta', icon: '拘', type: 'empty', zone: 'medium', x: 0, y: 4, desc: 'Zasypan칠 dno.' },
            
            // St콏edn칤 z칩na - z치pad
            { id: 'empty_20', name: 'Pr치zdn칳 parking', icon: '游勇', type: 'empty', zone: 'medium', x: -2, y: 0, desc: 'Opu코t캩n칠 parkovi코t캩.' },
            { id: 'empty_21', name: 'Rozbit칳 billboard', icon: '游늶', type: 'empty', zone: 'medium', x: -4, y: 0, desc: 'Vybledl치 reklama.' },
            { id: 'empty_22', name: 'Opu코t캩n치 zast치vka', icon: '游뚪', type: 'empty', zone: 'medium', x: -4, y: 1, desc: 'Autobusov치 zast치vka.' },
            { id: 'empty_23', name: 'Rozbit칳 st치nek', icon: '游낅', type: 'empty', zone: 'medium', x: -4, y: -1, desc: 'Pr치zdn칳 kiosk.' },
            { id: 'empty_24', name: '콯elezn칳 코rot', icon: '丘뙖잺', type: 'empty', zone: 'medium', x: -6, y: 0, desc: 'Hromada kovu.' },
            
            // St콏edn칤 z칩na - v칳chod
            { id: 'empty_25', name: 'Such치 studna', icon: '游뿪', type: 'empty', zone: 'medium', x: 4, y: 0, desc: 'Pr치zdn치 studna.' },
            { id: 'empty_26', name: 'Star칠 pneumatiky', icon: '救', type: 'empty', zone: 'medium', x: 4, y: 1, desc: 'Hromada gum.' },
            { id: 'empty_27', name: 'Rozbit치 br치na', icon: '游뛁', type: 'empty', zone: 'medium', x: 4, y: -1, desc: 'Zni캜en치 vrata.' },
            { id: 'empty_28', name: 'Opu코t캩n치 bouda', icon: '游띘', type: 'empty', zone: 'medium', x: 6, y: 0, desc: 'Pr치zdn치 chatr캜.' },
            { id: 'empty_29', name: 'Zreziv캩l칳 tank', icon: '游뿠', type: 'empty', zone: 'medium', x: 6, y: 1, desc: 'Vrak tanku.' },
            
            // Nebezpe캜n치 z칩na - rohy
            { id: 'empty_30', name: 'Toxick치 lou쬰', icon: '驕뮖잺', type: 'empty', zone: 'danger', x: 2, y: -6, desc: 'Radioaktivn칤 voda.', radiation: 3 },
            { id: 'empty_31', name: 'Sp치len칳 les', icon: '游댠', type: 'empty', zone: 'danger', x: -2, y: -6, desc: 'Oho콏el칠 kmeny.' },
            { id: 'empty_32', name: 'Kost콏ice', icon: '游', type: 'empty', zone: 'danger', x: 2, y: 6, desc: 'Poz콢statky ob캩t칤.' },
            { id: 'empty_33', name: 'Jed. oblak', icon: '游눧', type: 'empty', zone: 'danger', x: -2, y: 6, desc: 'Toxick칳 plyn.', radiation: 5 },
            { id: 'empty_34', name: 'Zni캜en칳 konvoj', icon: '游뚵', type: 'empty', zone: 'danger', x: -6, y: 3, desc: 'Rozst콏칤len칠 kamiony.' },
            { id: 'empty_35', name: 'Vybuchl치 stanice', icon: '久', type: 'empty', zone: 'danger', x: -6, y: -3, desc: 'Ruiny benz칤nky.' },
            { id: 'empty_36', name: 'Masov칳 hrob', icon: '丘썶잺', type: 'empty', zone: 'danger', x: 6, y: 3, desc: 'D캩siv칠 m칤sto.' },
            { id: 'empty_37', name: 'Zamo콏en치 z칩na', icon: '驕勇', type: 'empty', zone: 'danger', x: 6, y: -3, desc: 'Chemick칳 칰nik.', radiation: 5 },
            
            // Smrteln치 z칩na - okraje
            { id: 'empty_38', name: 'Kr치ter bomby', icon: '游눤', type: 'empty', zone: 'deadly', x: 0, y: -8, desc: 'M칤sto dopadu.', radiation: 15 },
            { id: 'empty_39', name: 'Mrtv치 z칩na', icon: '驕멆잺', type: 'empty', zone: 'deadly', x: 0, y: 8, desc: 'Nic tu ne쬴je.', radiation: 20 },
            { id: 'empty_40', name: 'Rozpadl칳 most', icon: '游깰', type: 'empty', zone: 'deadly', x: -8, y: 0, desc: 'Z콏칤cen칳 p콏echod.' },
            { id: 'empty_41', name: 'Atomov칠 ruiny', icon: '驕뮖잺', type: 'empty', zone: 'deadly', x: 8, y: 0, desc: 'Siln치 radiace.', radiation: 20 },
            { id: 'empty_42', name: 'Vyp치len치 vesnice', icon: '游끸勇', type: 'empty', zone: 'deadly', x: -8, y: -4, desc: 'Jen popel.' },
            { id: 'empty_43', name: 'Opu코t캩n칳 sklad', icon: '游닍', type: 'empty', zone: 'deadly', x: 8, y: 4, desc: 'Pr치zdn칠 reg치ly.' },
            { id: 'empty_44', name: 'Z콏칤cen치 v캩', icon: '游딮', type: 'empty', zone: 'deadly', x: -4, y: -7, desc: 'Zbytky ant칠ny.' },
            { id: 'empty_45', name: 'Zasypan칠 metro', icon: '游뚢', type: 'empty', zone: 'deadly', x: 4, y: 7, desc: 'Zavalen칳 vchod.' },
            
            // === FRAK캛N칈 LOKACE ===
            { id: 'bazaar', name: 'Velk칳 bazar', icon: '游낅', type: 'faction', zone: 'medium', x: 6, y: 2,
              desc: 'Hlavn칤 tr쬴코t캩 Obchodn칤 gildy. Nejlep코칤 ceny a vz치cn칠 zbo쮂.', 
              faction: 'traders', enemies: [], dangerLevel: 0 },
            { id: 'bunker', name: 'V캩deck칳 bunkr', icon: '游댧', type: 'faction', zone: 'danger', x: -6, y: -5,
              desc: 'Tajn치 laborato콏 V캩dc콢 Enkl치vy. Pokro캜il칳 v칳zkum a technologie.',
              faction: 'scientists', enemies: ['robot', 'experiment'], dangerLevel: 3, radiation: 5 },
            { id: 'mutant_village', name: 'Mutant칤 vesnice', icon: '驕勇', type: 'faction', zone: 'danger', x: -6, y: 6,
              desc: 'Osada Mutant칤ho kmene. P콏ekvapiv캩 m칤rumilovn칤... pokud je neroz캜칤l칤코.',
              faction: 'mutants', enemies: [], dangerLevel: 2, radiation: 10 },
            { id: 'toxic_zone', name: 'Toxick치 z칩na', icon: '驕뮖잺', type: 'faction', zone: 'deadly', x: -8, y: 5,
              desc: '칔zem칤 ovl치dan칠 mutanty. Extr칠mn칤 radiace, ale cenn칠 suroviny.',
              faction: 'mutants', enemies: ['mutant', 'toxic_beast'], dangerLevel: 5, radiation: 25 },
            { id: 'checkpoint', name: 'Vojensk칳 checkpoint', icon: '游꿌勇', type: 'faction', zone: 'medium', x: 3, y: -5,
              desc: 'Hl칤dkov칠 stanovi코t캩 Vojensk칠ho remnantu. Discipl칤na a po콏치dek.',
              faction: 'military', enemies: [], dangerLevel: 1 },
            
            // === TAJN츼 LOKACE - odhalena Z치hadnou 쬰nou ===
            { id: 'ancient_vault', name: 'Starov캩k칳 trezor', icon: '游끹勇', type: 'dungeon', zone: 'deadly', x: 8, y: -7,
              desc: 'Prad치vn칳 trezor pln칳 poklad콢 a nebezpe캜칤. Odhaleno Z치hadnou 쬰nou.',
              enemies: ['robot', 'sentinel', 'ancient_guardian'], dangerLevel: 5, radiation: 15,
              secret: true, loot: ['legendary', 'rare', 'tech'] },
            
            // Dal코칤 v칳pl켿 pro hustotu
            { id: 'empty_46', name: 'Star칳 kan치l', icon: '游뛇', type: 'empty', zone: 'medium', x: 2, y: -2, desc: 'Vyschl칳 odtok.' },
            { id: 'empty_47', name: 'Rozbit칳 hang치r', icon: '游끵勇', type: 'empty', zone: 'medium', x: -3, y: -3, desc: 'Pr치zdn치 hala.' },
            { id: 'empty_48', name: 'Kovov칳 odpad', icon: '游딈勇', type: 'empty', zone: 'medium', x: 4, y: 3, desc: 'Hromada odpadu.' },
            { id: 'empty_49', name: 'Opu코t캩n칳 bunkr', icon: '游뛁', type: 'empty', zone: 'medium', x: -3, y: 3, desc: 'Zabetonovan칳 vchod.' },
            { id: 'empty_50', name: 'Zni캜en치 silnice', icon: '游띢勇', type: 'empty', zone: 'medium', x: 3, y: -3, desc: 'Rozbit칳 asfalt.' }
        ];
        
        // === PVP FRAK캛N칈 SYST칄M ===
        const PVP_FACTIONS = {
            kory: { 
                id: 'kory', 
                name: 'Koryho n치sledovn칤ci', 
                icon: '游댮', 
                color: '#e53935', 
                colorLight: '#ff6659',
                desc: 'Chaos a destrukce. Star칳 sv캩t mus칤 sho콏et!',
                bonus: { damage: 0.05 } // +5% damage
            },
            koudy: { 
                id: 'koudy', 
                name: 'Koudyho nad캩je', 
                icon: '游댯', 
                color: '#1e88e5', 
                colorLight: '#6ab7ff',
                desc: '콎치d a v캩da. Zachr치n칤me lidstvo!',
                bonus: { xp: 0.05 } // +5% XP
            },
            independent: { 
                id: 'independent', 
                name: 'Nez치visl칤', 
                icon: '游릮', 
                color: '#9c27b0', 
                colorLight: '#ce93d8',
                desc: 'Svoboda a neutralita. Nikomu nedlu쮂셠e!',
                bonus: { loot: 0.05 } // +5% loot chance
            }
        };
        
        // Helper funkce pro z칤sk치n칤 n치zvu a popisu lokace
        function getLocName(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            return loc ? loc.name : locId;
        }
        
        function getLocDesc(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            return loc ? (loc.desc || '') : '';
        }
        
        // Helper funkce pro z칤sk치n칤 n치zvu crafting receptu
        function getCraftingName(recipeId) {
            const recipe = CRAFTING.find(r => r.id === recipeId);
            return recipe ? recipe.name : recipeId;
        }
        
        // Helper funkce pro z칤sk치n칤 celkov칠ho po캜tu suroviny (invent치콏 hr치캜e + sklad osady)
        function getTotalResource(resourceId, includeSettlement = true) {
            let playerAmount = state.resources[resourceId] || 0;
            
            // Speci치ln칤 komponenty jsou v invent치콏i, ne v resources
            const specialComponents = ['deathclaw_hand', 'mutant_heart', 'crystal', 'gold', 'gems'];
            if (specialComponents.includes(resourceId)) {
                const invCount = state.inv?.filter(i => i.id === resourceId).reduce((sum, i) => sum + (i.count || 1), 0) || 0;
                playerAmount += invCount;
            }
            
            if (!includeSettlement) return playerAmount;
            const settlementAmount = state.settlement?.resources?.[resourceId] || 0;
            return playerAmount + settlementAmount;
        }
        
        // Helper funkce pro z칤sk치n칤 n치zvu osadn칤ka
        function getSettlerName(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            return type ? type.name : typeId;
        }
        
        // Helper funkce pro z칤sk치n칤 n치zvu vlny n치jezdu
        function getRaidWaveName(waveNumber) {
            const waveNames = ['Prvn칤 vlna', 'Druh치 vlna', 'T콏et칤 vlna', '캛tvrt치 vlna', 'P치t치 vlna', '만st치 vlna'];
            return waveNames[waveNumber - 1] || `Vlna ${waveNumber}`;
        }
        
        // Funkce pro v칳po캜et vzd치lenosti v km mezi dv캩ma lokacemi
        function getDistanceKm(loc1, loc2) {
            const dx = (loc2.x - loc1.x) * GRID_SIZE_KM;
            const dy = (loc2.y - loc1.y) * GRID_SIZE_KM;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // Funkce pro v칳po캜et Z츼KLADN칈HO 캜asu cesty (bez vozidla - to se po캜칤t치 pozd캩ji)
        function getBaseTravelTime(loc1, loc2) {
            const distKm = getDistanceKm(loc1, loc2);
            let timeMin = distKm * WALK_SPEED_MIN_PER_KM;
            
            // Zpomalen칤 v nebezpe캜n칳ch z칩n치ch (opatrnost)
            if (loc2.zone === 'danger') timeMin *= 1.2;
            if (loc2.zone === 'deadly') timeMin *= 1.5;
            
            return Math.ceil(timeMin);
        }
        
        // Funkce pro z칤sk치n칤 sousedn칤ch lokac칤 (max vzd치lenost 3 km)
        function getAdjacentLocations(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            if (!loc) return [];
            
            return WORLD_LOCATIONS.filter(l => {
                if (l.id === locId) return false;
                const dist = getDistanceKm(loc, l);
                return dist <= 8; // Max 8 km pro p콏칤mou cestu
            }).sort((a, b) => getDistanceKm(loc, a) - getDistanceKm(loc, b)); // Se콏adit podle vzd치lenosti
        }
        
        // Generov치n칤 cest dynamicky
        function generatePaths() {
            const paths = [];
            
            WORLD_LOCATIONS.forEach(loc => {
                const neighbors = getAdjacentLocations(loc.id);
                neighbors.forEach(neighbor => {
                    // Zkontroluj jestli cesta u neexistuje
                    const exists = paths.some(p => 
                        (p.from === loc.id && p.to === neighbor.id) ||
                        (p.from === neighbor.id && p.to === loc.id)
                    );
                    
                    if (!exists) {
                        const distKm = getDistanceKm(loc, neighbor);
                        const timeMin = getBaseTravelTime(loc, neighbor);
                        const dangerLevel = Math.max(
                            loc.zone === 'deadly' ? 5 : loc.zone === 'danger' ? 3 : loc.zone === 'medium' ? 1 : 0,
                            neighbor.zone === 'deadly' ? 5 : neighbor.zone === 'danger' ? 3 : neighbor.zone === 'medium' ? 1 : 0
                        );
                        
                        paths.push({
                            from: loc.id,
                            to: neighbor.id,
                            distance: Math.round(distKm * 10) / 10, // Vzd치lenost v km (1 desetinn칠 m칤sto)
                            time: timeMin, // 캛as v minut치ch (z치kladn칤, bez vozidla)
                            danger: dangerLevel,
                            name: loc.name + '  ' + neighbor.name
                        });
                    }
                });
            });
            
            return paths;
        }
        
        const WORLD_PATHS = generatePaths();
        
        // === EVENTY NA CEST츼CH ===
        const TRAVEL_EVENTS = [
            // === POZITIVN칈 EVENTY ===
            { id: 'find_loot', name: 'N치lez!', icon: '游꾸', type: 'loot', chance: 0.20,
              text: 'Na cest캩 vid칤코 n캩co lesknouc칤ho se v tr치v캩...' },
            { id: 'friendly_trader', name: 'Potuln칳 obchodn칤k', icon: '游빕', type: 'trader', chance: 0.08,
              text: 'Potk치v치코 potuln칠ho obchodn칤ka s batohem pln칳m zbo쮂.' },
            { id: 'hidden_cache', name: 'Skryt치 skr칳코', icon: '游닍', type: 'cache', chance: 0.06,
              text: 'V코imne코 si nen치padn칠ho vstupu do skryt칠 skr칳코e!' },
            { id: 'injured_survivor', name: 'Zran캩n칳 p콏e쬴v코칤', icon: '游뱃', type: 'choice', chance: 0.10,
              text: 'Na cest캩 le쮂 zran캩n칳 캜lov캩k. Pom콢쬰코 mu?' },
            
            // === J칈DLO/PIT칈 - SN칈콯EN칄 ㅁNCE, MEN먞 HODNOTY ===
            { id: 'water_source', name: '캛ist칳 pramen', icon: '游눦', type: 'resource', chance: 0.03,
              text: 'Nach치z칤코 mal칳 pramen 캜ist칠 vody!' },
            { id: 'dirty_puddle', name: 'Kaln치 lou쬰', icon: '游눥', type: 'dirty_water', chance: 0.06,
              text: 'Nach치z칤코 kalnou lou쬴. Riskne코 napit칤?' },
            { id: 'food_scraps', name: 'Zbytky j칤dla', icon: '游꼤', type: 'food_scraps', chance: 0.05,
              text: 'Nach치z칤코 nap콢l sn캩den칠 konzervy a zbytky j칤dla.' },
            
            { id: 'herb_patch', name: 'Pole bylin', icon: '游', type: 'resource', chance: 0.10,
              text: 'Naraz칤코 na m칤sto porostl칠 l칠캜iv칳mi bylinami.' },
            { id: 'abandoned_vehicle', name: 'Opu코t캩n칠 vozidlo', icon: '游뚱', type: 'explore', chance: 0.05,
              text: 'U cesty stoj칤 opu코t캩n칠 auto. Mo쬹치 je v n캩m n캩co u쬴te캜n칠ho.' },
            
            // === SPOLE캛N칈CI ===
            { id: 'stray_dog', name: 'Zatoulan칳 pes', icon: '游냇', type: 'companion', chance: 0.12,
              text: 'Z k콏ov칤 vyl칠z치 vychrtl칳 pes a prosebn캩 na tebe hled칤.', 
              firstOnly: true, companionId: 'dog' },
            { id: 'lost_cat', name: 'Zatoulan치 ko캜ka', icon: '游낻', type: 'companion', chance: 0.08,
              text: 'Naraz칤코 na ko캜ku, kter치 se k tob캩 p콏itul칤.',
              firstOnly: true, companionId: 'cat' },
            { id: 'injured_crow', name: 'Zran캩n칳 havran', icon: '游분', type: 'companion', chance: 0.05,
              text: 'Na zemi le쮂 zran캩n칳 havran. Vyl칠캜칤코 ho?',
              firstOnly: true, companionId: 'crow' },
            
            // === NEGATIVN칈 EVENTY ===
            { id: 'ambush', name: 'P콏epaden칤!', icon: '游눤', type: 'combat', chance: 0.18,
              text: 'Z 칰krytu vysko캜ili nep콏치tel칠!' },
            { id: 'trap', name: 'Past!', icon: '游뿫', type: 'trap', chance: 0.08,
              text: '맓치pne코 do pasti!' },
            { id: 'rad_storm', name: 'Radia캜n칤 bou콏e', icon: '驕뮖잺', type: 'radiation', chance: 0.06,
              text: 'Obloha se zbarvila do zelena. Radia캜n칤 bou콏e!' },
            { id: 'breakdown', name: 'Vy캜erp치n칤', icon: '游땷', type: 'exhaustion', chance: 0.12,
              text: 'Cesta t캩 vy캜erp치v치 v칤c ne jsi 캜ekal.' },
            { id: 'spoiled_food', name: 'Zka쬰n칠 j칤dlo', icon: '游뱍', type: 'sickness', chance: 0.05,
              text: 'N캩co ti nesedlo v 쬬ludku...' },
            { id: 'thief', name: 'Zlod캩j!', icon: '游봉', type: 'theft', chance: 0.04,
              text: 'N캩kdo t캩 okradl, zat칤mco jsi nebyl ve st콏ehu!' },
            
            // === NEUTR츼LN칈/VOLBA ===
            { id: 'strange_noise', name: 'Podivn칳 zvuk', icon: '游녝', type: 'choice', chance: 0.12,
              text: 'Sly코칤코 podivn칳 zvuk z k콏ov칤. Prozkoum치코 to?' },
            { id: 'shortcut', name: 'Zkratka', icon: '游띣勇', type: 'choice', chance: 0.08,
              text: 'Vid칤코 mo쬹ou zkratku, ale vypad치 nebezpe캜n캩.' },
            { id: 'abandoned_camp', name: 'Opu코t캩n칳 t치bor', icon: '游끳勇', type: 'explore', chance: 0.10,
              text: 'Naraz칤코 na 캜erstv캩 opu코t캩n칳 t치bor.' },
            { id: 'mysterious_stranger', name: 'Z치hadn칳 cizinec', icon: '游빈', type: 'choice', chance: 0.05,
              text: 'Potk치v치코 z치hadn칠ho cizince v kapuci. Promluv칤 s tebou?' },
            { id: 'hidden_bunker_entrance', name: 'Skryt칳 vchod do bunkru', icon: '游뛁', type: 'explore', chance: 0.03,
              text: 'V코imne코 si zamaskovan칠ho vchodu do bunkru.' },
            { id: 'campfire_remains', name: 'Zbytky ohni코t캩', icon: '游댠', type: 'rest', chance: 0.04,
              text: 'Nach치z칤코 zbytky ned치vn칠ho ohni코t캩. M콢쬰코 si kr치tce odpo캜inout.' }
        ];
        
        // Pomocn치 funkce pro z칤sk치n칤 companion dat
        function getCompanionData(companionId) {
            return COMPANIONS.find(c => c.id === companionId);
        }
        
        // === MULTIPLAYER GLOBAL VARIABLES ===
        let firebaseApp = null;
        let firebaseDB = null;
        let firebaseAuth = null;
        let currentUser = null; // P콏ihl치코en칳 u쬴vatel
        let isGuest = true; // Hraje jako host?
        let multiplayerEnabled = false;
        let chatMessages = [];
        let marketplaceOffers = [];
        let pvpChallenges = [];
        let chatListener = null;
        let privateMessages = {}; // Soukrom칠 zpr치vy
        let unreadPMCount = 0; // Po캜et nep콏e캜ten칳ch soukrom칳ch zpr치v (glob치ln칤)
        let friendsList = []; // Seznam p콏치tel
        let friendRequests = []; // 콯치dosti o p콏치telstv칤
        
        // === XP KONSTANTA ===
        // xpNeed = 350 + (level * 50)
        // Level 12: 400 XP, Level 23: 450 XP, atd.
        
        // === STATE ===
        let state = {
            char: { name: '', gender: null, level: 1, xp: 0, xpNeed: 400, totalXP: 0, classId: null, points: 10, levelUpPoints: 0, skillPoints: 0,
                    hp: 100, maxHp: 100, attrs: { str: 5, int: 5, agi: 5, per: 5, end: 5, lck: 5 },
                    abilityLastUsed: 0 }, // Cooldown pro speci치ln칤 schopnost
            status: { hunger: 100, thirst: 100, energy: 100, mood: 100, radiation: 0 },
            time: { gameStart: Date.now(), realStart: Date.now(), last: Date.now(), days: 0, hours: 0, mins: 0, totalElapsed: 0 },
            
            // === NOV칗 WORLD SYST칄M ===
            world: {
                currentLocation: 'shelter',
                visitedLocations: ['shelter'],
                unlockedPaths: [],
                discoveredSecrets: [],
                traveling: false,
                travelTo: null,
                travelPath: null,
                travelStart: 0,
                travelDuration: 0,
                travelProgress: 0,
                pendingEvent: null,
                locationCooldowns: {},
                exploredRooms: {},
                bossesDefeated: [],
                questItems: {}, // Quest itemy na lokac칤ch
                groundLoot: {} // P콏edm캩ty na zemi (lokace -> [items])
            },
            
            // Minim치ln칤 zp캩tn치 kompatibilita (pouze pro star칠 ulo쬰n칠 hry)
            map: { inBase: true, traveling: false },
            
            inv: [
                // Prvn칤 kniha - nalezen치 v 칰krytu
                { id: 'lore_1', name: 'Den칤k v캩dce I', icon: '游늿', type: 'lore', weight: 0, price: 0, rarity: 'rare' }
            ],
            equipped: {
                weapon: null,
                armor: null,
                gloves: null,
                boots: null
            },
            starterToolChosen: false, // Flag pro v칳b캩r po캜치te캜n칤ho n치stroje
            money: 0, // 游눯 M캩na
            carryWeight: 0,
            maxCarryWeight: 50,
            lastSleepTime: 0, // Track when player last slept
            sleepEndTime: null, // When sleep will end
            isSleeping: false, // Player is currently sleeping
            currentAction: null, // Current timed action (hunt, mine, fish, explore)
            resources: { 
                wood: 0,      // 游 D콏evo - z치kladn칤
                metal: 0,     // 丘뙖잺 Kov - z치kladn칤
                stone: 0,     // 游뿯 K치men - z치kladn칤
                cloth: 0,     // 游빗 L치tka - z치kladn칤
                fuel: 0,      // 久 Palivo - pro vozidla
                leather: 0,   // 游붮 K콢쬰 - ze zv칤콏at
                herbs: 0,     // 游 Byliny - pro lektvary
                chemicals: 0, // 游빍 Chemik치lie - pro pokro캜il칠
                electronics: 0, // 游 Elektronika - vz치cn칠
                glass: 0,     // 游댩 Sklo - pro optiku
                rope: 0,      // 俱 Provaz - pro crafting
                gunpowder: 0, // 游눤 St콏eln칳 prach - pro munici
                scrap: 0,     // 游딈勇 rot - z ruin
                copper: 0,     // 游댰 M캩캞 - pro elektroniku
                silver: 0,    // 拘 St콏칤bro - pro 코perky
                gold: 0,      // 游리 Zlato - pro luxusn칤 v캩ci
                crystal: 0,   // 游 Krystal - pro magick칠 v캩ci
                acid: 0,      // 游릭 Kyselina - z mutant콢
                fur: 0,       // 游붉 Ko쬰코ina - ze zv칤콏at
                mutant_blood: 0, // 游뽖 Mutant칤 krev
                raw_meat: 0,  // 游볼 Syrov칠 maso
                fish: 0       // 游 Ryba
            },
            baseStorage: { food: 0, water: 0 },
            baseCapacity: 40,
            baseItems: [],
            base: ['wall'],
            buildQueue: [], // Fronta budov ve stavb캩
            skills: {},
            stats: { 
                kills: 0, deaths: 0, travelled: 0, itemsCrafted: 0, totalMoneyEarned: 0,
                bossKills: 0, flawlessWins: 0, maxCombo: 0, treasuresFound: 0,
                nearDeathExp: 0, maxRadiation: 0, itemsSold: 0, legendaryFound: 0,
                pacifistDays: 0, radstormsSurvived: 0, lastKillDay: -1,
                chatMessagesSent: 0, // Po캜et odeslan칳ch zpr치v v chatu
                // Combat tracking
            },
            achievements: [],
            readBooks: [],
            casinoTokens: 1000,
            casinoLastTokenDay: 0,
            casinoLastTokenTime: Date.now(), // Nastavit na te캞, aby nedostal bonus hned po startu
            lastFreeHerbs: Date.now(), // 캛as posledn칤ch bylin od Marty - nastavit na te캞 aby nedostal hned
            dailyQuests: {
                lastReset: 0,
                quests: [],
                completed: [],
                progress: {
                    kills: 0,
                    explored: 0,
                    crafted: 0,
                    moneyEarned: 0,
                    travelled: 0
                }
            },
            diary: '',
            log: [],
            traderQuests: [], // 칔koly od obchodn칤k콢
            confirmed: false,
            activeTab: 'multiplayer',
            craftFilter: 'all', // Filtr pro crafting
            lootFilter: {
                // Auto-loot filtr - co sb칤rat automaticky
                consumables: true,
                weapons: true,
                armor: true,
                ammo: true,
                resources: true,
                tools: true,
                minRarity: 'common' // common, uncommon, rare, epic, legendary
            },
            buildingCooldowns: {
                // Track last visit timestamp for special buildings
                hospitals: {}, // { "q,r": timestamp }
                workshops: {}, // { "q,r": timestamp }
                factories: {}  // { "q,r": timestamp }
            },
            shopMoney: {
                // Denn칤 limit pen캩z obchodn칤k콢 { locationId: { money: number, lastReset: timestamp } }
            },
            settlement: {
                level: 1,
                prosperity: 10, // Za캜칤n치me s malou prosperitou d칤ky budov치m
                settlers: [], // Array of settler objects with { id, type, name, hp, maxHp, morale, skill, assignedTo }
                buildings: ['garden', 'water'], // Za캜칤n치me se zahradou a sb캩ra캜em vody
                lastRaid: 0, // Timestamp of last raid
                resources: { 
                    food: 3, water: 3, fuel: 0,
                    // Suroviny ve skladu osady
                    wood: 0, metal: 0, stone: 0, cloth: 0, leather: 0,
                    herbs: 0, chemicals: 0, electronics: 0, glass: 0,
                    rope: 0, gunpowder: 0, scrap: 0, copper: 0
                },
                power: { produced: 0, consumed: 0, stored: 0, maxStorage: 20 }, // Elektrick칳 syst칠m
                defense: 0, // Total defense value
                morale: 50, // 0-100 celkov치 mor치lka osady
                specialization: null, // Vybran치 specializace
                activeEvent: null, // Aktu치ln칤 ud치lost
                lastEventCheck: 0, // Posledn칤 kontrola ud치lost칤
                visitingMerchant: null, // Obchodn칤k na n치v코t캩v캩 { until: timestamp, items: [] }
                activeQuests: [], // Aktivn칤 mise od osadn칤k콢
                completedQuests: [], // Dokon캜en칠 mise
                raidWave: 0, // Aktu치ln칤 vlna p콏i raidu
                lastDailyUpdate: 0, // Posledn칤 denn칤 aktualizace
                firstVisit: true, // Pro zobrazen칤 v칳b캩ru prvn칤ho osadn칤ka
                raidCooldown: 0, // 캛as do dal코칤ho mo쬹칠ho n치jezdu
                raidsDefended: 0, // Po캜et odra쬰n칳ch n치jezd콢
                eventLog: [] // Historie ud치lost칤 osady
            },
            // === DUNGEON SYST칄M ===
            dungeon: {
                active: null, // ID aktivn칤ho dungeonu
                floor: 0, // Aktu치ln칤 patro (0 = p콏칤zem칤)
                maxFloor: 0, // Nejhlub코칤 dosa쬰n칠 patro
                cleared: {}, // { dungeonId: { floors: [clearedFloors], clearedAt: timestamp } }
                loot: [] // Nasb칤ran칳 loot v dungeonu
            },
            // === NPC VZTAHY ===
            npcRelations: {
                // { npcId: { trust: 0-100, gifts: 0, quests: 0, lastTalk: timestamp } }
            },
            npcQuests: {}, // Aktivn칤 questy od NPC { npcId: { id: questId, startKills, startExplored, completed: [] } }
            npcTrust: {}, // D콢v캩ra u NPC { npcId: number }
            // === NOV칄 SYST칄MY ===
            weather: {
                current: 'sunny',
                lastChange: Date.now(),
                duration: 3600000 // 1 hodina v ms
            },
            // === SYST칄M NEMOC칈 ===
            diseases: {
                active: [], // [{ id, startTime, duration }]
                immune: [], // Do캜asn칠 imunity [{ diseaseId, until }]
                lastWeatherCheck: 0, // Posledn칤 kontrola po캜as칤 pro nemoci
                totalCured: 0 // Statistika - celkem vyl칠캜eno
            },
            // === SYST칄M ZRAN캨N칈 ===
            injuries: {
                active: [], // [{ id, startTime, duration }]
                totalHealed: 0 // Statistika - celkem vyl칠캜eno
            },
            companions: [], // [{ id, hp, maxHp }]
            treasureLocation: null, // { q, r } - m칤sto pokladu z mapy
            equippedAccessory: null, // ID nasazen칠ho dopl켿ku (prsten, amulet, atd.)
            weaponCoating: null, // { effect: 'poison'/'fire', uses: 5 }
            combatBonuses: { // Do캜asn칠 bonusy
                damageBonus: 0,
                defenseBonus: 0,
                expires: 0
            },
            // === DAL먞 NOV칄 SYST칄MY ===
            factions: { // Reputace s frakcemi (-100 a +100)
                traders: 0,
                scientists: 0,
                raiders: -20, // Za캜칤n치me trochu nep콏치telsky s bandity
                mutants: 0,
                military: 0
            },
            mutations: [], // Pole aktivn칤ch mutac칤
            buffs: [], // Do캜asn칠 buffy [{ id, value, expires }]
            stashes: {}, // Skr칳코e na map캩 { "q,r": [items] }
            horde: {
                active: false,
                wave: 0,
                lastHorde: 0, // Timestamp posledn칤 hordy
                nextHorde: Date.now() + 86400000 // Za 1 den
            },
            radio: {
                hasRadio: false,
                messages: [],
                lastMessage: 0
            },
            skills_secondary: { // Sekund치rn칤 skilly
                fishing: 0,
                mining: 0,
                hunting: 0,
                cooking: 0,
                alchemy: 0
            },
            // === HLAVN칈 P콎칈B캨H ===
            mainQuest: {
                currentQuest: 'intro',
                completedQuests: [],
                questProgress: {},
                npcMet: [],
                storyComplete: false,
                chapter: 0
            },
            // === CUSTOMIZACE ===
            appearance: {
                hairstyle: 'short',
                hairColor: 'brown',
                skinTone: 'medium',
                outfit: 'survivor',
                title: 'P콏e쬴v코칤'
            },
            badges: [],
            unlockedOutfits: ['survivor'],
            unlockedTitles: ['survivor'],
            // === SKILL TREE ===
            skillTree: {
                combat: {},
                defense: {},
                survival: {},
                exploration: {},
                crafting: {}
            },
            skillTreePoints: 0,
            // === STORY KARMA SYST칄M - Kory vs Koudy ===
            storyKarma: {
                kory: 0,   // -100 a +100, karma u Koryho
                koudy: 0,  // -100 a +100, karma u Koudyho
                componentsGiven: { kory: 0, koudy: 0 }, // Kolik komponent콢 d치no komu
                ending: null // 'dark', 'hope', 'neutral'
            }
        };
        
        // Helper functions
        function updateCarryWeight() {
            state.carryWeight = 0;
            
            // Invent치콏 - pouze p콏edm캩ty, NE suroviny (ty jsou v osad캩/skladu)
            state.inv.forEach(item => {
                state.carryWeight += (item.weight || 0) * (item.count || 1);
            });
            
            // P콏i캜ti v치hu item콢 vystaven칳ch na tr쬴코ti (dokud se neprodaj칤, st치le je "nese코")
            const myName = getPlayerName();
            if (typeof marketplaceOffers !== 'undefined' && marketplaceOffers) {
                marketplaceOffers.forEach(offer => {
                    if (offer.seller === myName && offer.status === 'active') {
                        const itemWeight = offer.item?.weight || 0;
                        const itemCount = offer.count || offer.item?.count || 1;
                        state.carryWeight += itemWeight * itemCount;
                    }
                });
            }
            
            // Nosnost: z치klad 50kg + 5kg za ka쬯칳 bod s칤ly nad 5 + batoh + skill + exoskelet
            const strBonus = Math.max(0, (state.char.attrs?.str || 5) - 5) * 5; // +5kg za ka쬯칳 bod s칤ly nad 5
            const backpack = state.inv.find(i => i.id === 'backpack');
            const backpackBonus = backpack ? 20 : 0;
            // Skill K콏e캜ek - hledej v skillTree i v star칠m syst칠mu
            const packRatLevel = state.skillTree?.survival?.pack_rat || state.skills?.['pack_rat'] || getSkillLevel('pack_rat') || 0;
            const skillBonus = packRatLevel * 10;
            
            // Exoskelet bonus (+50% nosnost)
            const boots = state.equipped?.boots;
            const exoBonus = (boots?.special === 'exo') ? 0.5 : 0;
            
            const baseCapacity = 50 + strBonus + backpackBonus + skillBonus;
            state.maxCarryWeight = Math.floor(baseCapacity * (1 + exoBonus));
        }
        
        // Wrapper funkce pro kompatibilitu
        function calculateCurrentWeight() {
            updateCarryWeight();
            return state.carryWeight || 0;
        }
        
        // Glow efekt pro rare itemy
        function addRareGlow(element, rarity) {
            const glowColors = {
                common: 'none',
                uncommon: '0 0 5px rgba(76, 175, 80, 0.5)',
                rare: '0 0 10px rgba(33, 150, 243, 0.7)',
                epic: '0 0 15px rgba(156, 39, 176, 0.8)',
                legendary: '0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.5)'
            };
            
            if (glowColors[rarity]) {
                element.style.boxShadow = glowColors[rarity];
            }
        }
        
        // Damage flash efekt
        function damageFlash() {
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 0, 0, 0.3);
                pointer-events: none;
                z-index: 9995;
                animation: damageFlashAnim 0.2s ease-out forwards;
            `;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 200);
        }
        
        // Heal flash efekt
        function healFlash() {
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(76, 175, 80, 0.2);
                pointer-events: none;
                z-index: 9995;
                animation: damageFlashAnim 0.3s ease-out forwards;
            `;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
        }
        
        function calculateMaxWeight() {
            updateCarryWeight();
            return state.maxCarryWeight || 50;
        }
        
        function canAddItem(item, count = 1) {
            const weight = (item.weight || 0) * count;
            return (state.carryWeight + weight) <= state.maxCarryWeight;
        }
        
        // Modal pro vybr치n칤 p콏edm캩tu k vyhozen칤 kdy je invent치콏 pln칳
        let pendingPickupItem = null;
        let pendingPickupCount = 0;
        
        function showDropItemModal(item, count) {
            pendingPickupItem = item;
            pendingPickupCount = count;
            
            const neededWeight = (item.weight || 0) * count;
            const currentWeight = state.carryWeight || 0;
            const maxWeight = state.maxCarryWeight || 50;
            
            // Se콏a캞 invent치콏 podle v치hy (nejt캩쮄뫆 prvn칤)
            const sortedInv = [...state.inv].sort((a, b) => ((b.weight || 0) * (b.count || 1)) - ((a.weight || 0) * (a.count || 1)));
            
            let itemsHtml = sortedInv.slice(0, 15).map((invItem, idx) => {
                const itemWeight = (invItem.weight || 0) * (invItem.count || 1);
                const itemName = invItem.name || getItemName(invItem.id) || invItem.id;
                const realIdx = state.inv.indexOf(invItem);
                return `
                    <button class="btn" onclick="dropItemAndPickup(${realIdx})" 
                            style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #2a2a2a; text-align: left;">
                        <span>${invItem.icon || '游닍'} ${itemName} ${(invItem.count || 1) > 1 ? 'x' + (invItem.count || 1) : ''}</span>
                        <span style="color: #f44336;">${itemWeight.toFixed(1)}kg</span>
                    </button>
                `;
            }).join('');
            
            showModal('丘멆잺 Pln칳 invent치콏!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #ff9800;">Chce코 vz칤t:</p>
                    <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0;">
                        <span style="font-size: 1.5rem;">${item.icon || '游닍'}</span>
                        <strong style="color: #4caf50;"> ${item.name || getItemName(item.id)}</strong>
                        <span style="color: #888;"> (${neededWeight.toFixed(1)}kg)</span>
                    </div>
                    <p style="color: #888; font-size: 0.85rem;">
                        Nosnost: ${currentWeight.toFixed(1)}/${maxWeight}kg
                    </p>
                    <p style="color: #f44336; font-size: 0.85rem;">
                        Pot콏ebuje코 uvolnit: ${(currentWeight + neededWeight - maxWeight).toFixed(1)}kg
                    </p>
                </div>
                
                <p style="color: #aaa; margin-bottom: 0.5rem;">Vyber co vyhod칤코:</p>
                <div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${itemsHtml}
                </div>
                
                <button class="btn" onclick="closeModal(); pendingPickupItem = null;" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    仇 Nevz칤t p콏edm캩t
                </button>
            `);
        }
        
        function dropItemAndPickup(invIndex) {
            if (invIndex < 0 || invIndex >= state.inv.length) return;
            
            const droppedItem = state.inv[invIndex];
            const droppedName = droppedItem.name || getItemName(droppedItem.id) || droppedItem.id;
            
            // Odeber p콏edm캩t z invent치콏e
            state.inv.splice(invIndex, 1);
            updateCarryWeight();
            
            addLog('Vyhodil jsi: ' + droppedName, '游딈勇');
            notifyWarning('Vyhozeno', droppedName);
            
            // Zkus znovu p콏idat nov칳 p콏edm캩t
            if (pendingPickupItem) {
                const item = pendingPickupItem;
                const count = pendingPickupCount;
                pendingPickupItem = null;
                pendingPickupCount = 0;
                
                if (canAddItem(item, count)) {
                    closeModal();
                    addItemToInventory(item, count);
                    notifySuccess('Vzato!', item.name || getItemName(item.id));
                } else {
                    // St치le nedost m칤sta - zobraz znovu
                    showDropItemModal(item, count);
                }
            }
        }
        
        // Pomocn치 funkce pro z칤sk치n칤 levelu skillu
        // === HELPER FUNKCE PRO MAPU (kompatibilita star칳/nov칳 syst칠m) ===
        function isInBase() {
            return state.world.currentLocation === 'shelter';
        }
        
        function isPlayerTraveling() {
            return state.world.traveling || state.map.traveling;
        }
        
        function getCurrentLocationId() {
            return state.world.currentLocation;
        }
        
        function getCurrentLocation() {
            return WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
        }
        
        // Synchronizace star칠ho map.inBase s nov칳m syst칠mem
        function syncMapState() {
            state.map.inBase = (state.world.currentLocation === 'shelter');
            state.map.traveling = state.world.traveling;
        }
        
        function getSkillLevel(skillId) {
            // Nejprve zkus star칳 SKILLS syst칠m
            if (state.skills && state.skills[skillId]) {
                return state.skills[skillId];
            }
            
            // Pak zkus SKILL_TREE
            if (state.skillTree) {
                for (const branchId of Object.keys(state.skillTree)) {
                    if (state.skillTree[branchId][skillId]) {
                        return state.skillTree[branchId][skillId];
                    }
                }
            }
            
            return 0;
        }
        
        // Automatick칠 konzumov치n칤 kdy hr치캜 um칤r치 (pokud m치 perk)
        function autoConsumeIfDying() {
            // Zkontroluj jestli m치 hr치캜 perk "Pud sebez치chovy"
            const hasAutoConsume = getSkillLevel('auto_consume') > 0;
            if (!hasAutoConsume) return;
            
            // Pr치h pro automatick칠 konzumov치n칤
            const DANGER_THRESHOLD = 15;
            
            // Auto-j칤dlo kdy hlad pod prahem
            if (state.status.hunger < DANGER_THRESHOLD) {
                const foodItems = state.inv.filter(i => 
                    i.type === 'consumable' && 
                    (i.effect === 'hunger' || (i.effect === 'health' && i.id.includes('food')))
                ).sort((a, b) => (a.value || 0) - (b.value || 0)); // Nejslab코칤 prvn칤
                
                if (foodItems.length > 0) {
                    const food = foodItems[0];
                    const value = food.value || 30;
                    state.status.hunger = Math.min(100, state.status.hunger + value);
                    
                    // Odeber z invent치콏e
                    if (food.count && food.count > 1) {
                        food.count--;
                    } else {
                        const idx = state.inv.indexOf(food);
                        if (idx > -1) state.inv.splice(idx, 1);
                    }
                    
                    addLog(`游 Pud sebez치chovy: Automaticky sn캩dl ${food.name}`, food.icon);
                }
            }
            
            // Auto-pit칤 kdy 쮂셬e켿 pod prahem
            if (state.status.thirst < DANGER_THRESHOLD) {
                const drinkItems = state.inv.filter(i => 
                    i.type === 'consumable' && i.effect === 'thirst'
                ).sort((a, b) => (a.value || 0) - (b.value || 0)); // Nejslab코칤 prvn칤
                
                if (drinkItems.length > 0) {
                    const drink = drinkItems[0];
                    const value = drink.value || 30;
                    state.status.thirst = Math.min(100, state.status.thirst + value);
                    
                    // Odeber z invent치콏e
                    if (drink.count && drink.count > 1) {
                        drink.count--;
                    } else {
                        const idx = state.inv.indexOf(drink);
                        if (idx > -1) state.inv.splice(idx, 1);
                    }
                    
                    addLog(`游 Pud sebez치chovy: Automaticky vypil ${drink.name}`, drink.icon);
                }
            }
            
            // Auto-l칠캜en칤 kdy HP pod 20%
            if (state.status.hp < getMaxHp() * 0.2) {
                const healItems = state.inv.filter(i => 
                    i.type === 'consumable' && i.effect === 'health'
                ).sort((a, b) => (a.value || 0) - (b.value || 0)); // Nejslab코칤 prvn칤
                
                if (healItems.length > 0) {
                    const heal = healItems[0];
                    const value = heal.value || 20;
                    state.status.hp = Math.min(getMaxHp(), state.status.hp + value);
                    
                    // Odeber z invent치콏e
                    if (heal.count && heal.count > 1) {
                        heal.count--;
                    } else {
                        const idx = state.inv.indexOf(heal);
                        if (idx > -1) state.inv.splice(idx, 1);
                    }
                    
                    addLog(`游 Pud sebez치chovy: Automaticky pou쬴l ${heal.name}`, heal.icon);
                }
            }
        }
        
        // === LOOT FILTR ===
        const RARITY_ORDER = ['common', 'uncommon', 'rare', 'epic', 'legendary'];
        
        // Zkontroluje jestli item projde loot filtrem
        function passesLootFilter(item) {
            if (!state.lootFilter) return true; // 콯치dn칳 filtr = sb칤rej v코e
            
            const filter = state.lootFilter;
            const itemType = item.type;
            const itemRarity = item.rarity || 'common';
            
            // Kontrola typu
            if (itemType === 'consumable' && !filter.consumables) return false;
            if (itemType === 'weapon' && !filter.weapons) return false;
            if (itemType === 'armor' && !filter.armor) return false;
            if (itemType === 'ammo' && !filter.ammo) return false;
            if (itemType === 'resource' && !filter.resources) return false;
            if (itemType === 'tool' && !filter.tools) return false;
            
            // Kontrola rarity
            const minRarityIdx = RARITY_ORDER.indexOf(filter.minRarity || 'common');
            const itemRarityIdx = RARITY_ORDER.indexOf(itemRarity);
            if (itemRarityIdx < minRarityIdx) return false;
            
            return true;
        }
        
        // Zobraz칤 nastaven칤 loot filtru
        function showLootFilterSettings() {
            const filter = state.lootFilter || {
                consumables: true, weapons: true, armor: true,
                ammo: true, resources: true, tools: true, minRarity: 'common'
            };
            
            const rarityOptions = [
                { id: 'common', name: '丘 Common+', desc: 'Sb칤rej v코e' },
                { id: 'uncommon', name: '游릭 Uncommon+', desc: 'Ignoruj common' },
                { id: 'rare', name: '游댯 Rare+', desc: 'Jen vz치cn칠' },
                { id: 'epic', name: '游릮 Epic+', desc: 'Jen epick칠' },
                { id: 'legendary', name: '游리 Legendary', desc: 'Jen legend치rn칤' }
            ];
            
            showModal('游 Nastaven칤 Auto-Lootu', `
                <p style="color: #888; font-size: 0.85rem; margin-bottom: 1rem;">
                    Vyber co chce코 automaticky sb칤rat. Ostatn칤 z콢stane na zemi.
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterConsumables" ${filter.consumables ? 'checked' : ''} onchange="updateLootFilter('consumables', this.checked)">
                        <span>游꼤 Spot콏ebn칤</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterWeapons" ${filter.weapons ? 'checked' : ''} onchange="updateLootFilter('weapons', this.checked)">
                        <span>丘덢잺 Zbran캩</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterArmor" ${filter.armor ? 'checked' : ''} onchange="updateLootFilter('armor', this.checked)">
                        <span>游띠勇 Zbroje</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterAmmo" ${filter.ammo ? 'checked' : ''} onchange="updateLootFilter('ammo', this.checked)">
                        <span>游댲 Munice</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterResources" ${filter.resources ? 'checked' : ''} onchange="updateLootFilter('resources', this.checked)">
                        <span>游닍 Suroviny</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterTools" ${filter.tools ? 'checked' : ''} onchange="updateLootFilter('tools', this.checked)">
                        <span>游댢 N치stroje</span>
                    </label>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.8rem;">Minim치ln칤 vz치cnost:</label>
                    <select id="filterMinRarity" onchange="updateLootFilter('minRarity', this.value)" 
                            style="width: 100%; padding: 0.5rem; margin-top: 0.3rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        ${rarityOptions.map(r => `
                            <option value="${r.id}" ${filter.minRarity === r.id ? 'selected' : ''}>${r.name} - ${r.desc}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="resetLootFilter()" style="background: #555;">游댃 Reset</button>
                    <button class="btn" onclick="closeModal()" style="background: #4caf50;">九 Hotovo</button>
                </div>
            `);
        }
        
        function updateLootFilter(key, value) {
            if (!state.lootFilter) state.lootFilter = {
                consumables: true, weapons: true, armor: true,
                ammo: true, resources: true, tools: true, minRarity: 'common'
            };
            state.lootFilter[key] = value;
            saveGame();
        }
        
        function resetLootFilter() {
            state.lootFilter = {
                consumables: true, weapons: true, armor: true,
                ammo: true, resources: true, tools: true, minRarity: 'common'
            };
            showLootFilterSettings();
        }
        
        // === RECYKLACE ITEM콡 ===
        function recycleItem(itemIndex) {
            const item = state.inv[itemIndex];
            if (!item) return;
            
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            
            // Nelze recyklovat consumables a n캩kter칠 speci치ln칤 itemy
            if (itemData.type === 'consumable' || itemData.type === 'ammo' || itemData.type === 'resource') {
                notifyWarning('Nelze recyklovat', 'Tento typ p콏edm캩tu nelze recyklovat');
                return;
            }
            
            // Vypo캜칤tej materi치ly
            const materials = calculateRecycleMaterials(itemData);
            
            if (Object.keys(materials).length === 0) {
                notifyWarning('Nelze recyklovat', 'Z tohoto p콏edm캩tu nez칤sk치코 쮂멳n칠 materi치ly');
                return;
            }
            
            // Zobraz potvrzen칤
            let materialsHtml = '';
            for (const [mat, amount] of Object.entries(materials)) {
                const matIcon = { metal: '游댤', wood: '游뿻', cloth: '游빗', leather: '游붍', electronics: '游님', chemicals: '游빍', scrap: '丘뙖잺', glass: '游', stone: '游뿯' }[mat] || '游닍';
                materialsHtml += `<div style="display: inline-block; background: #2a2a2a; padding: 0.3rem 0.6rem; border-radius: 4px; margin: 0.2rem;">${matIcon} ${amount}x ${mat}</div>`;
            }
            
            showModal(`鮫勇 Recyklovat ${item.icon} ${item.name}?`, `
                <p style="color: #888;">Rozlo쮂솬 p콏edm캩t a z칤sk치코 suroviny:</p>
                <div style="margin: 1rem 0;">${materialsHtml}</div>
                <p style="color: #ff9800; font-size: 0.85rem;">丘멆잺 P콏edm캩t bude zni캜en!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="confirmRecycle(${itemIndex})" style="background: #4caf50;">鮫勇 Recyklovat</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">九 Zru코it</button>
                </div>
            `);
        }
        
        function calculateRecycleMaterials(itemData) {
            const materials = {};
            const price = itemData.price || 50;
            const rarity = itemData.rarity || 'common';
            
            // Z치kladn칤 materi치ly podle typu
            if (itemData.type === 'weapon') {
                materials.metal = Math.max(1, Math.floor(price / 40));
                if (itemData.ammoType) materials.scrap = Math.max(1, Math.floor(price / 60));
                if (rarity === 'rare' || rarity === 'epic') materials.electronics = 1;
            } else if (itemData.type === 'armor') {
                if (itemData.id?.includes('leather') || itemData.defense < 10) {
                    materials.leather = Math.max(1, Math.floor(price / 35));
                    materials.cloth = Math.max(1, Math.floor(price / 50));
                } else {
                    materials.metal = Math.max(1, Math.floor(price / 40));
                    materials.cloth = Math.max(1, Math.floor(price / 60));
                }
                if (rarity === 'rare' || rarity === 'epic') materials.chemicals = 1;
            } else if (itemData.type === 'tool') {
                materials.metal = Math.max(1, Math.floor(price / 50));
                materials.wood = Math.max(1, Math.floor(price / 60));
            }
            
            // Bonus za vy코코칤 rarity
            const rarityMultiplier = { common: 0.5, uncommon: 0.6, rare: 0.75, epic: 0.85, legendary: 1 }[rarity] || 0.5;
            
            for (const key of Object.keys(materials)) {
                materials[key] = Math.max(1, Math.floor(materials[key] * rarityMultiplier));
            }
            
            return materials;
        }
        
        function confirmRecycle(itemIndex) {
            const item = state.inv[itemIndex];
            if (!item) { closeModal(); return; }
            
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const materials = calculateRecycleMaterials(itemData);
            
            // P콏idej materi치ly
            const gained = [];
            for (const [mat, amount] of Object.entries(materials)) {
                state.resources[mat] = (state.resources[mat] || 0) + amount;
                const matName = RESOURCE_NAMES[mat] || mat;
                const matIcon = RESOURCE_ICONS[mat] || '游닍';
                gained.push(`+${amount} ${matIcon} ${matName}`);
            }
            
            // Odeber item
            if (item.count && item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            notifySuccess('鮫勇 Recyklov치no!', gained.join(', '));
            addLog(`鮫勇 Recykloval jsi ${item.name}: ${gained.join(', ')}`, '鮫勇');
            
            closeModal();
            renderFull();
            saveGame();
        }
        
        // Z칤sk치 v코echny bojov칠 bonusy hr치캜e ze skill콢
        function getPlayerCombatSkillEffects() {
            const effects = {
                damageBonus: 0,      // +X% damage
                critChance: 0,       // +X 코ance na krit
                armorPierce: 0,      // Ignoruje X% obrany
                berserkerBonus: 0,   // +X% damage p콏i n칤zk칠m HP
                executeBonus: 0,     // +X% damage na nep콏치tele pod 20% HP
                defense: 0,          // +X obrany
                blockChance: 0,      // X% 코ance blokovat 칰tok
                lastStand: 0         // X% 코ance p콏e쮂셦 smrteln칳 칰der
            };
            
            if (!state.skills) return effects;
            
            // Projdi v코echny skill v캩tve
            for (const [branchId, branch] of Object.entries(SKILL_TREE)) {
                branch.skills.forEach(skill => {
                    const level = state.skills[skill.id] || 0;
                    if (level > 0 && skill.effect) {
                        Object.entries(skill.effect).forEach(([key, value]) => {
                            if (typeof value === 'number' && effects.hasOwnProperty(key)) {
                                effects[key] += value * level;
                            }
                        });
                    }
                });
            }
            
            return effects;
        }
        
        // V칳po캜et bonus콢 z budov
        function getBuildingBonuses() {
            const bonuses = {
                morale: 0,
                settlementMorale: 0,
                hp: 0,
                energy: 0,
                defense: 0,
                baseCapacity: 0,
                foodBonus: 0,
                tradingBonus: 0,
                damageBonus: 0,
                weaponBonus: 0,
                xpBonus: 0,
                guardBonus: 0,
                vision: 0,
                cooking: false,
                weatherProtection: false,
                hygiene: false,
                crafting: false,
                foodPreserve: false
            };
            
            // Base budovy
            if (state.base) {
                state.base.forEach(buildingId => {
                    const building = BUILDINGS.find(b => b.id === buildingId);
                    if (building && building.effect) {
                        Object.keys(building.effect).forEach(key => {
                            if (typeof bonuses[key] === 'number') {
                                bonuses[key] += building.effect[key];
                            } else if (typeof bonuses[key] === 'boolean') {
                                bonuses[key] = bonuses[key] || building.effect[key];
                            }
                        });
                    }
                });
            }
            
            // Settlement budovy
            if (state.settlement?.buildings) {
                state.settlement.buildings.forEach(buildingId => {
                    const building = BUILDINGS.find(b => b.id === buildingId);
                    if (building && building.effect) {
                        Object.keys(building.effect).forEach(key => {
                            if (typeof bonuses[key] === 'number') {
                                bonuses[key] += building.effect[key];
                            } else if (typeof bonuses[key] === 'boolean') {
                                bonuses[key] = bonuses[key] || building.effect[key];
                            }
                        });
                    }
                });
            }
            
            return bonuses;
        }
        
        // Kontrola jestli m치코 budovu
        function hasBuilding(buildingId) {
            return state.base?.includes(buildingId) || state.settlement?.buildings?.includes(buildingId);
        }
        
        // === INVENTORY UTILITIES ===
        
        /**
         * Validuje integritu invent치콏e a oprav칤 chyby
         * @returns {object} Report o nalezen칳ch a opraven칳ch probl칠mech
         */
        function validateInventory() {
            const report = {
                checked: 0,
                fixed: 0,
                removed: 0,
                issues: []
            };
            
            if (!Array.isArray(state.inv)) {
                state.inv = [];
                report.issues.push('Invent치콏 nebyl pole - resetov치n');
                return report;
            }
            
            // Filtruj neplatn칠 polo쬶y
            const validItems = [];
            
            state.inv.forEach((item, index) => {
                report.checked++;
                
                // Z치kladn칤 validace
                if (!item || typeof item !== 'object') {
                    report.removed++;
                    report.issues.push(`Index ${index}: Neplatn칳 item (null/undefined)`);
                    return;
                }
                
                if (!item.id) {
                    report.removed++;
                    report.issues.push(`Index ${index}: Item bez ID`);
                    return;
                }
                
                // Oprav count
                if (item.count !== undefined) {
                    const originalCount = item.count;
                    item.count = safeInteger(item.count, 1, 1, GAME_CONSTANTS.MAX_STACK_SIZE);
                    if (item.count !== originalCount) {
                        report.fixed++;
                        report.issues.push(`${item.id}: count ${originalCount}  ${item.count}`);
                    }
                }
                
                // Oprav durability
                if (item.durability !== undefined) {
                    item.durability = safeInteger(item.durability, 100, 0, 100);
                }
                
                // Oprav damage/defense
                if (item.damage !== undefined) {
                    item.damage = safeInteger(item.damage, 0, 0);
                }
                if (item.defense !== undefined) {
                    item.defense = safeInteger(item.defense, 0, 0);
                }
                
                validItems.push(item);
            });
            
            state.inv = validItems;
            
            if (report.issues.length > 0) {
                GameLogger.warn('inventory', `Inventory validation: ${report.fixed} fixed, ${report.removed} removed`, report.issues);
            }
            
            return report;
        }
        
        /**
         * Najde item v invent치콏i podle ID nebo predik치tu
         * @param {string|function} idOrPredicate - ID itemu nebo predik치tov치 funkce
         * @returns {object|null} Nalezen칳 item nebo null
         */
        function findInventoryItem(idOrPredicate) {
            if (!state.inv) return null;
            
            if (typeof idOrPredicate === 'function') {
                return state.inv.find(idOrPredicate) || null;
            }
            
            return state.inv.find(i => i.id === idOrPredicate) || null;
        }
        
        /**
         * Spo캜칤t치 celkov칳 po캜et item콢 dan칠ho ID
         * @param {string} itemId - ID itemu
         * @returns {number} Celkov칳 po캜et
         */
        function countInventoryItems(itemId) {
            if (!state.inv) return 0;
            
            return state.inv
                .filter(i => i.id === itemId)
                .reduce((sum, i) => sum + (i.count || 1), 0);
        }
        
        // Bezpe캜n칠 odebr치n칤 itemu z invent치콏e (spr치vn캩 zpracuje count)
        function removeItemFromInventory(item, amount = 1) {
            if (!item) return false;
            
            // Validace amount
            amount = safeInteger(amount, 1, 1);
            
            // Zajisti 쬰 count existuje
            const currentCount = item.count || 1;
            
            if (currentCount <= amount) {
                // Odeber cel칳 item podle reference
                const idx = state.inv.indexOf(item);
                if (idx > -1) {
                    state.inv.splice(idx, 1);
                    updateCarryWeight();
                    GameLogger.debug('inventory', `Removed: ${item.name || item.id}`, { amount });
                    return true;
                }
                return false;
            } else {
                // Sni po캜et
                item.count = currentCount - amount;
                updateCarryWeight();
                GameLogger.debug('inventory', `Reduced: ${item.name || item.id}`, { from: currentCount, to: item.count });
                return true;
            }
        }
        
        // === GROUND LOOT SYST칄M ===
        // P콏id치 p콏edm캩t na zem na danou lokaci (nebo aktu치ln칤)
        function addToGroundLoot(item, targetLocation = null) {
            if (!item) return;
            const location = targetLocation || state.world?.currentLocation || 'shelter';
            if (!state.world.groundLoot) state.world.groundLoot = {};
            if (!state.world.groundLoot[location]) state.world.groundLoot[location] = [];
            
            // P콏idej timestamp pro p콏칤padn칠 expirov치n칤
            item.droppedAt = Date.now();
            state.world.groundLoot[location].push(item);
            
            addLog(`游닍 ${item.icon || '游닍'} ${item.name} z콢stalo na zemi`, '游닍');
        }
        
        // Z칤sk치 p콏edm캩ty na zemi na aktu치ln칤 lokaci
        function getGroundLoot() {
            const location = state.world?.currentLocation || 'shelter';
            return state.world.groundLoot?.[location] || [];
        }
        
        // Sebere p콏edm캩t ze zem캩
        function pickupGroundLoot(index) {
            const location = state.world?.currentLocation || 'shelter';
            const groundItems = state.world.groundLoot?.[location];
            if (!groundItems || !groundItems[index]) return;
            
            const item = groundItems[index];
            const count = item.count || 1;
            
            if (canAddItem(item, count)) {
                // Vytvo콏 kopii bez droppedAt
                const itemCopy = {...item};
                delete itemCopy.droppedAt;
                
                addItemToInventory(itemCopy, count);
                groundItems.splice(index, 1);
                notifySuccess('Sebr치no!', `${item.icon} ${item.name}`);
                
                // Pokud je코t캩 n캩co z콢stalo, znovu zobraz modal
                if (groundItems.length > 0) {
                    showGroundLoot();
                } else {
                    closeModal();
                    renderFull();
                }
            } else {
                notifyWarning('Pln칳 invent치콏!', 'Uvolni m칤sto v invent치콏i');
            }
        }
        
        // Sebere v코e ze zem캩
        function pickupAllGroundLoot() {
            const location = state.world?.currentLocation || 'shelter';
            const groundItems = state.world.groundLoot?.[location];
            if (!groundItems || groundItems.length === 0) return;
            
            let picked = 0;
            let remaining = [];
            
            groundItems.forEach(item => {
                const count = item.count || 1;
                if (canAddItem(item, count)) {
                    // Vytvo콏 kopii bez droppedAt
                    const itemCopy = {...item};
                    delete itemCopy.droppedAt;
                    
                    addItemToInventory(itemCopy, count, true);
                    picked++;
                } else {
                    remaining.push(item);
                }
            });
            
            state.world.groundLoot[location] = remaining;
            
            if (picked > 0) {
                notifySuccess('Sebr치no!', `${picked} p콏edm캩t콢`);
            }
            if (remaining.length > 0) {
                notifyWarning('Pln칳 invent치콏', `${remaining.length} p콏edm캩t콢 z콢stalo na zemi`);
                // Znovu zobraz modal s t칤m co zbylo
                showGroundLoot();
            } else {
                closeModal();
                renderFull();
            }
        }
        
        // Zobraz칤 modal s p콏edm캩ty na zemi
        function showGroundLoot() {
            const groundItems = getGroundLoot();
            
            if (groundItems.length === 0) {
                notifyWarning('Pr치zdno', 'Na zemi nic nen칤');
                return;
            }
            
            let itemsHtml = groundItems.map((item, idx) => {
                const count = item.count || 1;
                const countText = count > 1 ? ` x${count}` : '';
                const rarityColors = { common: '#888', uncommon: '#4caf50', rare: '#2196f3', epic: '#9c27b0', legendary: '#ffd700' };
                const color = rarityColors[item.rarity] || '#888';
                
                return `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.5rem;">${item.icon || '游닍'}</span>
                        <div style="flex: 1;">
                            <div style="color: ${color}; font-weight: bold;">${item.name}${countText}</div>
                            ${item.damage ? `<span style="color: #c62828; font-size: 0.8rem;">丘덢잺 ${item.damage}</span>` : ''}
                            ${item.defense ? `<span style="color: #2196f3; font-size: 0.8rem;">游띠勇 ${item.defense}</span>` : ''}
                        </div>
                        <button class="btn" onclick="pickupGroundLoot(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4caf50;">Vz칤t</button>
                    </div>
                `;
            }).join('');
            
            showModal('游닍 P콏edm캩ty na zemi', `
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    ${itemsHtml}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="pickupAllGroundLoot()" style="background: #ff9800;">游닌 Vz칤t v코e</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">九 Zav콏칤t</button>
                </div>
            `);
        }
        
        // Centr치ln칤 funkce pro p콏id치n칤 p콏edm캩tu do invent치콏e se stackov치n칤m
        function addItemToInventory(item, count = 1, silent = false) {
            if (!item) return false;
            
            // Resources jdou do state.resources, ne do inv
            if (item.type === 'resource') {
                const resourceId = item.id;
                state.resources[resourceId] = (state.resources[resourceId] || 0) + count;
                SoundSystem.play('pickup');
                if (!silent) {
                    notifySuccess(item.icon + ' +' + count, item.name);
                }
                return true;
            }
            
            // Kontrola unique item콢 (kompas, dalekohled, batoh) - max 1
            if (item.unique || item.maxStack === 1) {
                const alreadyHas = state.inv.some(i => i.id === item.id);
                if (alreadyHas) {
                    if (!silent) {
                        notifyWarning('U m치코 ' + item.name, 'M콢쬰코 m칤t pouze jeden');
                    }
                    return false;
                }
            }
            
            // Kontrola v치hy
            if (!canAddItem(item, count)) {
                if (!silent) {
                    SoundSystem.play('error');
                    // Nab칤dni mo쬹ost vyhodit n캩co
                    showDropItemModal(item, count);
                }
                return false;
            }
            
            // Stackovateln칠 typy: consumable, ammo, food, throwable
            const stackableTypes = ['consumable', 'ammo', 'food', 'throwable'];
            
            if (stackableTypes.includes(item.type) || item.stackable) {
                // Hledej existuj칤c칤 stack podle ID, ale ne pokud m치 stackId (rozd캩len칳 stack)
                const existing = state.inv.find(i => i.id === item.id && !i.stackId);
                if (existing && !item.stackId) {
                    existing.count = (existing.count || 1) + count;
                    SoundSystem.play('pickup');
                    updateCarryWeight();
                    return true;
                }
            }
            
            // P콏idej nov칳 p콏edm캩t
            const newItem = {...item};
            
            // Dopl켿 chyb캩j칤c칤 vlastnosti z ITEMS definice (price, weight, atd.)
            if (!newItem.price || !newItem.weight || !newItem.special) {
                const itemDef = ITEMS.find(i => i.id === item.id);
                if (itemDef) {
                    if (!newItem.price && itemDef.price) newItem.price = itemDef.price;
                    if (!newItem.weight && itemDef.weight) newItem.weight = itemDef.weight;
                    if (!newItem.rarity && itemDef.rarity) newItem.rarity = itemDef.rarity;
                    if (!newItem.special && itemDef.special) newItem.special = itemDef.special;
                    if (!newItem.defense && itemDef.defense) newItem.defense = itemDef.defense;
                }
            }
            
            if (stackableTypes.includes(item.type) || item.stackable) {
                newItem.count = count;
                newItem.stackable = true;
            }
            state.inv.push(newItem);
            SoundSystem.play('pickup');
            updateCarryWeight();
            
            // === ACHIEVEMENT TRACKING ===
            // Legendary item found
            if (item.rarity === 'legendary') {
                state.stats.legendaryFound = (state.stats.legendaryFound || 0) + 1;
            }
            // Rare+ items found
            if (item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary') {
                state.stats.rareFound = (state.stats.rareFound || 0) + 1;
            }
            
            // === COMPANION QUEST - item objective ===
            if (typeof checkCompanionQuestObjectives === 'function') {
                checkCompanionQuestObjectives('item', item.id);
            }
            
            return true;
        }
        
        // Bezpe캜n칠 p콏id치n칤 s upozorn캩n칤m - pro loot, odm캩ny atd.
        function tryAddItemToInventory(item, count = 1) {
            if (!item) return { success: false, reason: 'no_item' };
            
            const weight = (item.weight || 0) * count;
            const freeSpace = state.maxCarryWeight - state.carryWeight;
            
            if (weight > freeSpace) {
                // Kolik se vejde?
                const canFit = item.weight > 0 ? Math.floor(freeSpace / item.weight) : count;
                
                if (canFit > 0) {
                    // P콏idej kolik se vejde
                    addItemToInventory(item, canFit, true);
                    notifyWarning('Invent치콏 skoro pln칳!', 'Vzal jsi jen ' + canFit + 'x ' + item.name);
                    return { success: true, added: canFit, dropped: count - canFit };
                } else {
                    notifyWarning(t('notifications', 'inventoryFull'), 'Nem콢쬰코 vz칤t ' + item.name);
                    return { success: false, reason: 'full', dropped: count };
                }
            }
            
            addItemToInventory(item, count, true);
            return { success: true, added: count, dropped: 0 };
        }
        
        // === VIZU츼LN칈 EFEKTY ===
        
        // Floating number effect (damage, heal, XP, money)
        function showFloatingNumber(value, type = 'damage', x = null, y = null) {
            const el = document.createElement('div');
            el.className = `floating-number ${type}`;
            
            // Prefix based on type
            let prefix = '';
            if (type === 'heal' || type === 'xp' || type === 'money') prefix = '+';
            if (type === 'damage') prefix = '-';
            if (type === 'crit') prefix = '游눤';
            
            el.textContent = prefix + value;
            
            // Position - center of screen or custom
            if (x === null) x = window.innerWidth / 2 + (Math.random() - 0.5) * 100;
            if (y === null) y = window.innerHeight / 2;
            
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            
            document.body.appendChild(el);
            
            // Remove after animation
            setTimeout(() => el.remove(), 1500);
        }
        
        // Screen shake effect
        function screenShake(intensity = 5, duration = 300) {
            const container = document.querySelector('.container');
            if (!container) return;
            
            container.style.transition = 'none';
            const startTime = Date.now();
            
            function shake() {
                const elapsed = Date.now() - startTime;
                if (elapsed < duration) {
                    const x = (Math.random() - 0.5) * intensity * 2;
                    const y = (Math.random() - 0.5) * intensity * 2;
                    container.style.transform = `translate(${x}px, ${y}px)`;
                    requestAnimationFrame(shake);
                } else {
                    container.style.transform = '';
                    container.style.transition = '';
                }
            }
            shake();
        }
        
        // Particle burst effect
        function particleBurst(x, y, color = '#ffd700', count = 10) {
            const container = document.createElement('div');
            container.className = 'particle-container';
            container.style.left = x + 'px';
            container.style.top = y + 'px';
            document.body.appendChild(container);
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.background = color;
                particle.style.left = '0px';
                particle.style.top = '0px';
                
                // Random direction
                const angle = (Math.PI * 2 / count) * i;
                const distance = 30 + Math.random() * 50;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                particle.style.animation = `particleFloat 0.8s ease-out forwards`;
                particle.style.transform = `translate(${tx}px, ${ty}px)`;
                
                container.appendChild(particle);
            }
            
            setTimeout(() => container.remove(), 1000);
        }
        
        // Flash element effect
        function flashElement(element, color = '#fff', duration = 200) {
            if (!element) return;
            const original = element.style.filter;
            element.style.filter = `brightness(2) drop-shadow(0 0 10px ${color})`;
            setTimeout(() => {
                element.style.filter = original;
            }, duration);
        }
        
        // Level up celebration effect
        function levelUpEffect() {
            // Nov칳 level up efekt
            if (typeof triggerLevelUpEffect === 'function') triggerLevelUpEffect();
            
            // Screen flash
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, transparent 70%);
                pointer-events: none; z-index: 9998;
                animation: fadeInScale 0.3s ease-out forwards;
            `;
            document.body.appendChild(flash);
            
            // Particles
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const x = window.innerWidth / 2 + (Math.random() - 0.5) * 200;
                    const y = window.innerHeight / 2 + (Math.random() - 0.5) * 200;
                    particleBurst(x, y, ['#ffd700', '#ff9800', '#ffeb3b'][Math.floor(Math.random() * 3)], 8);
                }, i * 100);
            }
            
            setTimeout(() => flash.remove(), 1000);
        }
        
        // Craft success effect
        function craftSuccessEffect(element) {
            if (element) {
                element.classList.add('fade-in-scale');
                setTimeout(() => element.classList.remove('fade-in-scale'), 400);
            }
            particleBurst(window.innerWidth / 2, window.innerHeight / 2, '#8bc34a', 8);
        }
        
        // Combat hit effect
        function combatHitEffect(isPlayer = false, damage = 0, isCrit = false) {
            if (isPlayer) {
                screenShake(isCrit ? 8 : 4, 200);
                showFloatingNumber(damage, 'damage');
                if (typeof triggerDamageShake === 'function') triggerDamageShake();
                if (typeof playCombatSound === 'function') playCombatSound('playerHit');
            } else {
                showFloatingNumber(damage, isCrit ? 'crit' : 'damage');
                if (typeof playCombatSound === 'function') playCombatSound(isCrit ? 'crit' : 'enemyHit');
                if (isCrit) {
                    screenShake(3, 150);
                }
            }
        }
        
        // === COMBAT DETECTION ===
        /**
         * Zjist칤 jestli pr치v캩 prob칤h치 boj
         * @returns {boolean} True pokud prob칤h치 boj
         */
        function isInCombat() {
            return !!(window.combatState || state.inCombat || window.combatInProgress);
        }
        
        // === CENTRALIZOVAN칄 HP UTILITY ===
        // Pou쬴j tyto funkce m칤sto p콏칤m칠ho p콏칤stupu k state.char.hp
        
        /**
         * Bezpe캜n캩 z칤sk치 aktu치ln칤 HP
         * @returns {number} Aktu치ln칤 HP
         */
        function getPlayerHP() {
            return safeInteger(state.char?.hp, 0, 0, getPlayerMaxHP());
        }
        
        /**
         * Bezpe캜n캩 z칤sk치 maxim치ln칤 HP
         * @returns {number} Maxim치ln칤 HP
         */
        function getPlayerMaxHP() {
            return safeInteger(state.char?.maxHp, 100, 1, GAME_CONSTANTS.MAX_HP);
        }
        
        /**
         * Vyl칠캜칤 hr치캜e o zadan칠 mno쬽tv칤 HP
         * @param {number} amount - Mno쬽tv칤 HP k vyl칠캜en칤
         * @param {boolean} allowOverheal - Povolit p콏ekro캜en칤 maxHP (default: false)
         * @returns {number} Skute캜n캩 vyl칠캜en칠 HP
         */
        function healPlayer(amount, allowOverheal = false) {
            amount = safeInteger(amount, 0, 0);
            if (amount <= 0) return 0;
            
            const currentHP = getPlayerHP();
            const maxHP = getPlayerMaxHP();
            
            // Companion bonus pro l칠캜en칤
            let bonusMultiplier = 1;
            if (typeof getAllCompanionBonuses === 'function') {
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.healingBonus > 0) {
                    bonusMultiplier = 1 + compBonuses.healingBonus;
                }
            }
            
            const finalAmount = Math.floor(amount * bonusMultiplier);
            const maxHeal = allowOverheal ? GAME_CONSTANTS.MAX_HP : maxHP;
            const newHP = Math.min(currentHP + finalAmount, maxHeal);
            const actualHeal = newHP - currentHP;
            
            state.char.hp = newHP;
            
            return actualHeal;
        }
        
        /**
         * Zp콢sob칤 damage hr치캜i
         * @param {number} amount - Mno쬽tv칤 damage
         * @param {string} source - Zdroj damage (pro logging)
         * @param {boolean} canKill - M콢쬰 zab칤t hr치캜e? (default: true)
         * @returns {number} Skute캜n칳 damage
         */
        function damagePlayer(amount, source = 'unknown', canKill = true) {
            amount = safeInteger(amount, 0, 0);
            if (amount <= 0) return 0;
            
            const currentHP = getPlayerHP();
            const minHP = canKill ? 0 : 1;
            const newHP = Math.max(minHP, currentHP - amount);
            const actualDamage = currentHP - newHP;
            
            state.char.hp = newHP;
            
            // Log pro debugging
            if (actualDamage > 0) {
                console.log(`游눖 Damage: -${actualDamage} HP from ${source} (${currentHP}  ${newHP})`);
            }
            
            // Trigger efekty p콏i n칤zk칠m HP
            if (newHP <= state.char.maxHp * 0.25 && newHP > 0) {
                // N칤zk칠 HP warning efekt
                if (typeof addLowHPEffect === 'function') addLowHPEffect();
            }
            
            return actualDamage;
        }
        
        /**
         * Nastav칤 HP na pln칠
         */
        function fullHealPlayer() {
            state.char.hp = getPlayerMaxHP();
        }
        
        /**
         * Kontrola zda je hr치캜 na쬴vu
         * @returns {boolean}
         */
        function isPlayerAlive() {
            return getPlayerHP() > 0;
        }
        
        function getMoney() {
            // Z치kladn칤 pen칤ze
            let total = state.money || 0;
            
            // P콏i캜ti pen칤ze z invent치콏e (pokud tam n캩jak칠 jsou jako item)
            if (state.inv) {
                state.inv.forEach(item => {
                    if (item.id === 'money' && item.count) {
                        total += item.count;
                    }
                });
            }
            
            return total;
        }
        
        // === CASINO 콯ETONY ===
        const MAX_CASINO_TOKENS = 9999999;
        
        function getCasinoTokens() {
            return safeInteger(state.casinoTokens, 0, 0);
        }
        
        function addCasinoTokens(amount) {
            amount = safeInteger(amount);
            const newTotal = (state.casinoTokens || 0) + amount;
            state.casinoTokens = Math.max(0, Math.min(newTotal, MAX_CASINO_TOKENS));
        }
        
        function checkDailyCasinoTokens() {
            const now = Date.now();
            const lastTokenTime = state.casinoLastTokenTime || 0;
            const oneDayMs = 24 * 60 * 60 * 1000; // 24 hodin v ms
            
            // Bonus jen jednou za 24 re치ln칳ch hodin
            if (now - lastTokenTime >= oneDayMs) {
                state.casinoLastTokenTime = now;
                addCasinoTokens(1000);
                addLog('游꿣 Denn칤 bonus: +1000 쬰ton콢 do kasina!', '游꿣');
                notifySuccess('Casino bonus!', '+1000 游꿞 쬰ton콢');
                saveGame();
                return true;
            }
            return false;
        }
        
        function exchangeTokensForMoney() {
            const tokensBefore = getCasinoTokens();
            const moneyBefore = state.money || 0;
            
            console.log('游눰 Exchange: tokeny p콏ed:', tokensBefore, 'pen칤ze p콏ed:', moneyBefore);
            
            if (tokensBefore < 5000) {
                notifyWarning('M치lo 쬰ton콢!', 'Pot콏ebuje코 5000 游꿞');
                return false;
            }
            
            addCasinoTokens(-5000);
            
            // P콏idej pen칤ze P콎칈MO m칤sto p콏es addMoney (kter치 m치 ochranu proti <=0)
            state.money = (state.money || 0) + 200;
            
            const tokensAfter = getCasinoTokens();
            const moneyAfter = state.money;
            
            console.log('游눰 Exchange: tokeny po:', tokensAfter, 'pen칤ze po:', moneyAfter);
            console.log('游눰 Exchange: zm캩na token콢:', tokensAfter - tokensBefore, 'zm캩na pen캩z:', moneyAfter - moneyBefore);
            
            notifySuccess('V칳m캩na!', `-5000 游꿞  +200 游눯 (m치코 ${moneyAfter} 游눯)`);
            saveGame();
            renderGame();
            return true;
        }
        
        // Bezpe캜n칠 p콏i캜ten칤 casino gambled progress
        function addCasinoGambledProgress() {
            if (!state.dailyQuests) state.dailyQuests = {};
            if (!state.dailyQuests.progress) state.dailyQuests.progress = {};
            state.dailyQuests.progress.gambled = (state.dailyQuests.progress.gambled || 0) + 1;
            if (typeof checkDailyQuests === 'function') checkDailyQuests();
        }
        
        // P콏id치n칤 radiace s ohledem na buff odolnosti
        function addRadiation(amount) {
            if (amount <= 0) return;
            
            // MUTANT je imunn칤 na radiaci
            if (state.char.classId === 'mutant' || state.char.class === 'mutant') {
                return; // 콯치dn치 radiace
            }
            
            let finalAmount = amount;
            
            // Kontrola rad_resist buffu
            if (state.buffs?.radResist && state.buffs.radResist.until > Date.now()) {
                const reduction = state.buffs.radResist.value / 100; // nap콏. 50 = 50%
                finalAmount = Math.floor(amount * (1 - reduction));
                if (finalAmount < amount) {
                    console.log(`Rad-X: sn칤쬰no z ${amount} na ${finalAmount} radiace`);
                }
            }
            
            // Kontrola plynov칠 masky nebo hazmat obleku
            const armor = state.equipped?.armor;
            if (armor?.special === 'rad_resist') {
                finalAmount = Math.floor(finalAmount * 0.7); // -30%
            } else if (armor?.special === 'rad_immune') {
                finalAmount = Math.floor(finalAmount * 0.5); // -50% (ne 100% imunita)
            }
            
            // 驕勇 Mutant칤 frakce - radResist bonus
            const factionBonuses = getFactionBonuses();
            if (factionBonuses.radResist > 0) {
                finalAmount = Math.floor(finalAmount * (1 - factionBonuses.radResist));
            }
            
            // 驕뮖잺 Exotic bonus - Radia캜n칤 talisman (-50% radiace trvale)
            if (state.exoticBonuses?.radResistPermanent > 0) {
                finalAmount = Math.floor(finalAmount * (1 - state.exoticBonuses.radResistPermanent));
            }
            
            state.status.radiation = Math.min(100, state.status.radiation + finalAmount);
            
            // Track max radiation pro achievement
            if (state.status.radiation > (state.stats.maxRadiation || 0)) {
                state.stats.maxRadiation = state.status.radiation;
            }
        }
        
        // Konsolidace invent치콏e - slou캜칤 duplicitn칤 stacky stejn칳ch item콢
        function consolidateInventory() {
            const stackableTypes = ['consumable', 'resource', 'ammo', 'food', 'throwable'];
            const consolidated = [];
            const seen = {};
            
            state.inv.forEach(item => {
                // P콏esko캜 "money" itemy - pen칤ze jsou v state.money
                if (item.id === 'money') {
                    // P콏eve캞 na skute캜n칠 pen칤ze pokud existuj칤
                    if (item.count) {
                        state.money = (state.money || 0) + item.count;
                    }
                    return; // Nep콏id치vej do invent치콏e
                }
                
                // Itemy s stackId jsou rozd캩len칠 stacky - NESLU캛OVAT
                if (item.stackId) {
                    consolidated.push(item);
                    return;
                }
                
                // Stackovateln칠 itemy slou캜it (pouze ty bez stackId)
                if ((stackableTypes.includes(item.type) || item.stackable) && !item.durability) {
                    if (seen[item.id]) {
                        // P콏idej k existuj칤c칤mu stacku
                        seen[item.id].count = (seen[item.id].count || 1) + (item.count || 1);
                    } else {
                        // Nov칳 stack
                        const newItem = {...item, count: item.count || 1, stackable: true};
                        seen[item.id] = newItem;
                        consolidated.push(newItem);
                    }
                } else {
                    // Ne-stackovateln칠 itemy (zbran캩, brn캩n칤 s durability)
                    consolidated.push(item);
                }
            });
            
            state.inv = consolidated;
            updateCarryWeight();
        }
        
        function addMoney(amount) {
            // Validace vstupu
            amount = safeInteger(amount, 0);
            if (amount <= 0) return;
            
            // DEBUG: Log pro sledov치n칤 VECH v캩t코칤ch pen캩쬹칤ch p콏칤jm콢
            if (amount > 100) {
                console.warn(`游눯 Pen캩쬹칤 p콏칤jem: ${amount}游눯 (celkem bude: ${(state.money || 0) + amount})`);
                console.trace('Zdroj pen캩z:');
            }
            
            // Ochrana proti extr칠mn칤m hodnot치m (max 5000 najednou)
            const MAX_SINGLE_TRANSACTION = 5000;
            if (amount > MAX_SINGLE_TRANSACTION) {
                console.error(`游뚿 EXTR칄MN칈 pen캩쬹칤 p콏칤jem omezen: ${amount}游눯  ${MAX_SINGLE_TRANSACTION}`);
                amount = MAX_SINGLE_TRANSACTION;
            }
            
            // === DAN캨 PRO RADU P콎E콯IV먞껚H ===
            // P콏idej pen칤ze
            const newTotal = (state.money || 0) + amount;
            state.money = Math.min(newTotal, GAME_CONSTANTS.MAX_MONEY);
            
            // Pokud bylo dosa쬰no maxima, loguj
            if (newTotal > GAME_CONSTANTS.MAX_MONEY) {
                console.warn(`游눯 Dosa쬰n limit pen캩z: ${GAME_CONSTANTS.MAX_MONEY}`);
            }
            
            // Statistiky
            state.stats = state.stats || {};
            state.stats.totalMoneyEarned = (state.stats.totalMoneyEarned || 0) + amount;
            
            // Daily quests
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.moneyEarned = (state.dailyQuests.progress.moneyEarned || 0) + amount;
                checkDailyQuests();
            }
            checkAchievements();
            
            // Floating money number (only for significant amounts)
            if (amount >= 10) {
                showFloatingNumber(amount, 'money');
            }
        }
        
        function removeMoney(amount) {
            // Validace
            amount = safeInteger(amount, 0);
            if (amount <= 0) return false;
            
            // Nejprve p콏eve캞 pen칤ze z invent치콏e do state.money
            if (state.inv) {
                state.inv = state.inv.filter(item => {
                    if (item.id === 'money' && item.count) {
                        state.money = (state.money || 0) + item.count;
                        return false; // Odstra켿 z invent치콏e
                    }
                    return true;
                });
            }
            
            if ((state.money || 0) < amount) return false;
            state.money = (state.money || 0) - amount;
            return true;
        }
        
        // === AMMO SYSTEM ===
        function getAmmoCount(ammoType) {
            // Mapov치n칤 ammoType na mo쬹치 ID item콢 a n치zvy
            const ammoIds = {
                'arrow': ['ammo_arrow'],
                'bolt': ['ammo_bolt'],
                '9mm': ['ammo_9mm'],
                '556': ['ammo_556'],
                '762': ['ammo_762'],
                'shell': ['ammo_shell'],
                'fuel': ['ammo_fuel', 'fuel']
            };
            const ammoNames = {
                'arrow': ['먞셣y', '먞셣', 'Arrow'],
                'bolt': ['말pky', '말pka', 'Bolt'],
                '9mm': ['N치boje 9mm', '9mm'],
                '556': ['N치boje 5.56', '5.56'],
                '762': ['N치boje 7.62', '7.62'],
                'shell': ['Brokov칠 n치boje', 'Broky', 'Shell'],
                'fuel': ['Palivo', 'Benz칤n', 'Kanystr', 'Fuel']
            };
            
            const possibleIds = ammoIds[ammoType] || [];
            const possibleNames = ammoNames[ammoType] || [];
            
            // 1. Hledej podle ammoType
            let ammoItem = state.inv.find(i => i.type === 'ammo' && i.ammoType === ammoType);
            if (ammoItem) return ammoItem.count || 1;
            
            // 2. Hledej podle ID
            ammoItem = state.inv.find(i => possibleIds.includes(i.id));
            if (ammoItem) return ammoItem.count || 1;
            
            // 3. Hledej podle n치zvu (fallback pro star칠 save)
            ammoItem = state.inv.find(i => possibleNames.some(n => i.name?.includes(n)));
            if (ammoItem) return ammoItem.count || 1;
            
            // Speci치ln칤 p콏칤pad: fuel m콢쬰 b칳t i jako resource (Benz칤n/Palivo)
            if (ammoType === 'fuel') {
                const fuelResource = state.inv.find(i => 
                    i.id === 'fuel' || 
                    (i.type === 'resource' && (i.name === 'Benz칤n' || i.name === 'Palivo' || i.name?.toLowerCase().includes('palivo') || i.name?.toLowerCase().includes('benz칤n')))
                );
                if (fuelResource) return fuelResource.count || 1;
                // Nebo v resources
                if (state.resources?.fuel) return state.resources.fuel;
            }
            
            return 0;
        }
        
        function consumeAmmo(ammoType, amount = 1) {
            // Mapov치n칤 ammoType na mo쬹치 ID item콢
            const ammoIds = {
                'arrow': ['ammo_arrow'],
                'bolt': ['ammo_bolt'],
                '9mm': ['ammo_9mm'],
                '556': ['ammo_556'],
                '762': ['ammo_762'],
                'shell': ['ammo_shell'],
                'fuel': ['ammo_fuel', 'fuel']
            };
            
            const possibleIds = ammoIds[ammoType] || [];
            
            // Hledej podle ammoType
            let ammoItem = state.inv.find(i => i.type === 'ammo' && i.ammoType === ammoType);
            
            // Hledej podle ID
            if (!ammoItem) {
                ammoItem = state.inv.find(i => possibleIds.includes(i.id));
            }
            
            // Speci치ln칤 p콏칤pad: fuel m콢쬰 b칳t i jako resource (Benz칤n/Palivo)
            if (!ammoItem && ammoType === 'fuel') {
                ammoItem = state.inv.find(i => 
                    i.id === 'fuel' || 
                    (i.type === 'resource' && (i.name === 'Benz칤n' || i.name === 'Palivo' || i.name?.toLowerCase().includes('palivo') || i.name?.toLowerCase().includes('benz칤n')))
                );
                // Nebo z resources
                if (!ammoItem && state.resources?.fuel >= amount) {
                    state.resources.fuel -= amount;
                    return true;
                }
            }
            
            if (!ammoItem || (ammoItem.count || 1) < amount) return false;
            
            ammoItem.count = (ammoItem.count || 1) - amount;
            if (ammoItem.count <= 0) {
                state.inv = state.inv.filter(i => i !== ammoItem);
            }
            return true;
        }
        
        function addAmmo(ammoType, amount) {
            const ammoItem = state.inv.find(i => i.type === 'ammo' && i.ammoType === ammoType);
            if (ammoItem) {
                ammoItem.count = (ammoItem.count || 0) + amount;
            } else {
                // Najdi definici n치boje v ITEMS
                const ammoData = ITEMS.find(i => i.type === 'ammo' && i.ammoType === ammoType);
                if (ammoData) {
                    state.inv.push({...ammoData, count: amount});
                }
            }
        }
        
        function getAmmoName(ammoType) {
            const names = {
                'arrow': '먞셣y',
                'bolt': '말pky',
                '9mm': 'N치boje 9mm',
                '556': 'N치boje 5.56',
                '762': 'N치boje 7.62',
                'shell': 'Brokov칠 n치boje',
                'fuel': 'Palivo'
            };
            return names[ammoType] || ammoType;
        }
        
        function pad(n) { return String(n).padStart(2, '0'); }
        
        function addLog(text, icon = '') {
            const time = `Den ${state.time.days}, ${pad(state.time.hours)}:${pad(state.time.mins)}`;
            state.log = state.log || [];
            state.log.push({ time, text: (icon ? icon + ' ' : '') + text, timestamp: Date.now() });
            if (state.log.length > 50) state.log = state.log.slice(-50);
        }
        
        function clearGameLog() {
            state.log = [];
            if (state.settlement) state.settlement.eventLog = [];
            notifySuccess('Den칤k vymaz치n');
            renderFull();
        }
        
        // === NOTIFIKACE SYST칄M ===
        // === SYST칄MOV칄 NOTIFIKACE (pro mobil) ===
        let systemNotificationsEnabled = false;
        let notificationQueue = [];
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Tento prohl칤쬰캜 nepodporuje notifikace');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                systemNotificationsEnabled = true;
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                systemNotificationsEnabled = permission === 'granted';
                return systemNotificationsEnabled;
            }
            
            return false;
        }
        
        function sendSystemNotification(title, body, icon) {
            icon = icon || '游꿡';
            // Pou쬴j nov칳 MobileNotifications syst칠m
            MobileNotifications.send(icon + ' ' + title, {
                body: body,
                tag: 'survival-hero-' + Date.now(),
                renotify: true
            });
            
            // Fallback na star칳 syst칠m pokud MobileNotifications nen칤 aktivn칤
            if (!MobileNotifications.enabled && systemNotificationsEnabled && Notification.permission === 'granted') {
                try {
                    var notification = new Notification('游꿡 ' + title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">驕뮖잺</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">驕뮖잺</text></svg>',
                        tag: 'survival-hero-' + Date.now(),
                        requireInteraction: true,
                        vibrate: [200, 100, 200],
                        renotify: true,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    setTimeout(function() { notification.close(); }, 10000);
                } catch (e) {
                    console.log('Notifikace error:', e);
                }
            }
        }
        
        // Kontrola jestli b캩쮂셠e jako PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }
        
        // Inicializace notifikac칤 p콏i na캜ten칤
        document.addEventListener('DOMContentLoaded', () => {
            // Event delegation pro header stats - zabr치n칤 Google vyhled치v치n칤
            const headerStats = document.getElementById('headerStats');
            if (headerStats) {
                headerStats.addEventListener('click', (e) => {
                    const statEl = e.target.closest('.stat.clickable');
                    if (statEl) {
                        e.preventDefault();
                        e.stopPropagation();
                        const statType = statEl.dataset.stat;
                        if (statType && typeof window.showStatInfo === 'function') {
                            window.showStatInfo(statType);
                        } else {
                            console.log('showStatInfo not ready, statType:', statType);
                        }
                    }
                });
                
                // Tak칠 pro touch eventy na mobilu
                headerStats.addEventListener('touchend', (e) => {
                    const statEl = e.target.closest('.stat.clickable');
                    if (statEl) {
                        e.preventDefault();
                        const statType = statEl.dataset.stat;
                        if (statType && typeof window.showStatInfo === 'function') {
                            window.showStatInfo(statType);
                        }
                    }
                });
            }
            
            // Pokud je PWA, hned po쮂멳ej o povolen칤
            if (isPWA()) {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        console.log('九 Notifikace povoleny pro PWA');
                    }
                });
            } else {
                // Po쮂멳at o povolen칤 po prvn칤 interakci
                document.addEventListener('click', function enableNotifications() {
                    requestNotificationPermission();
                    document.removeEventListener('click', enableNotifications);
                }, { once: true });
            }
            
            // Zobraz banner pro povolen칤 notifikac칤
            setTimeout(() => {
                if (Notification.permission === 'default') {
                    showNotificationPrompt();
                }
            }, 5000);
        });
        
        function showNotificationPrompt() {
            if (localStorage.getItem('notificationPromptDismissed')) return;
            
            const banner = document.createElement('div');
            banner.id = 'notificationBanner';
            banner.style.cssText = `
                position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
                background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
                border: 2px solid #39FF14; border-radius: 10px; padding: 1rem;
                z-index: 10000; max-width: 90%; width: 350px; text-align: center;
                box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
            `;
            banner.innerHTML = `
                <p style="margin-bottom: 0.8rem; color: #fff;">游댒 Chce코 dost치vat notifikace o ud치lostech ve h콏e?</p>
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button onclick="enableNotificationsFromBanner()" style="padding: 0.5rem 1rem; background: #39FF14; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Povolit</button>
                    <button onclick="dismissNotificationBanner()" style="padding: 0.5rem 1rem; background: #555; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Ne, d칤ky</button>
                </div>
            `;
            document.body.appendChild(banner);
        }
        
        function enableNotificationsFromBanner() {
            requestNotificationPermission().then(granted => {
                if (granted) {
                    sendSystemNotification('Notifikace zapnuty!', 'Bude코 dost치vat upozorn캩n칤 o ud치lostech ve h콏e.');
                }
            });
            dismissNotificationBanner();
        }
        
        function dismissNotificationBanner() {
            const banner = document.getElementById('notificationBanner');
            if (banner) banner.remove();
            localStorage.setItem('notificationPromptDismissed', 'true');
        }
        
        function showNotification(title, text, type = 'info', icon = '游닉') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${text ? `<div class="notification-text">${text}</div>` : ''}
                </div>
            `;
            
            container.appendChild(notif);
            
            // P콏ehr치t zvuk podle typu
            if (type === 'legendary' || type === 'epic') {
                SoundSystem.play('rare_item');
            } else if (type === 'success') {
                SoundSystem.play('pickup');
            } else if (type === 'danger') {
                SoundSystem.play('error');
            }
            
            // Automatick칠 odstran캩n칤 po animaci
            setTimeout(() => {
                if (notif.parentNode) {
                    notif.parentNode.removeChild(notif);
                }
            }, 6000); // Prodlou쬰no z 4s na 6s pro lep코칤 캜itelnost
        }
        
        // Pomocn칠 funkce pro r콢zn칠 typy notifikac칤
        function notifySuccess(title, text = '') {
            showNotification(title, text, 'success', '九');
            addLog(title, '九');
        }
        
        function notifyWarning(title, text = '') {
            showNotification(title, text, 'warning', '丘멆잺');
            addLog(title, '丘멆잺');
        }
        
        function notifyDanger(title, text = '') {
            showNotification(title, text, 'danger', '仇');
            addLog(title, '仇');
        }
        
        // Alias pro notifyError
        function notifyError(title, text = '') {
            showNotification(title, text, 'danger', '仇');
            addLog(title, '仇');
        }
        
        function notifyInfo(title, text = '') {
            showNotification(title, text, 'info', '좶잺');
            addLog(title, '좶잺');
        }
        
        function notifyLoot(itemName, rarity = 'common', icon = '游꾸') {
            const rarityTypes = {
                'common': 'info',
                'uncommon': 'success', 
                'rare': 'info',
                'epic': 'epic',
                'legendary': 'legendary'
            };
            const type = rarityTypes[rarity] || 'info';
            showNotification('Nalezeno!', itemName, type, icon);
            addLog(`Nalezeno: ${itemName}`, icon);
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.itemsFound = (state.dailyQuests.progress.itemsFound || 0) + 1;
                checkDailyQuests();
            }
        }
        
        function notifyBuild(buildingName, icon = '游끵勇') {
            showNotification('Postaveno!', buildingName, 'success', icon);
            addLog(`Postaveno: ${buildingName}`, icon);
        }
        
        function notifyTravel(locationName, icon = '游딬勇') {
            showNotification('C칤l dosa쬰n', locationName, 'success', icon);
            addLog(`Dorazil na: ${locationName}`, '游딬勇');
        }
        
        function notifyLevel(level) {
            showNotification(t('notifications', 'levelUp'), `Dosa쬰n level ${level}`, 'legendary', '救');
            addLog(`Level up! Nyn칤 level ${level}`, '救');
        }
        
        function notifyQuest(questName, icon = '游닆') {
            showNotification('Quest spln캩n!', questName, 'epic', icon);
            addLog(`Quest spln캩n: ${questName}`, '游닆');
        }
        
        function notifyCombat(message, isVictory = true) {
            if (isVictory) {
                showNotification(t('combat', 'victory'), message, 'success', '丘덢잺');
            } else {
                showNotification('Boj!', message, 'warning', '丘덢잺');
            }
        }
        
        function notifySettlement(message, icon = '游끶勇') {
            showNotification('Osada', message, 'info', icon);
            addLog(message, icon);
        }
        
        // === PO캛AS칈 SYST칄M ===
        function updateWeather() {
            const now = Date.now();
            if (now - state.weather.lastChange > state.weather.duration) {
                // Zm캩na po캜as칤
                const roll = Math.random();
                let cumulative = 0;
                for (const weather of WEATHER_TYPES) {
                    cumulative += weather.chance;
                    if (roll < cumulative) {
                        if (state.weather.current !== weather.id) {
                            state.weather.current = weather.id;
                            state.weather.lastChange = now;
                            state.weather.duration = (30 + Math.random() * 60) * 60 * 1000; // 30-90 minut
                            addLog('Po캜as칤 se zm캩nilo na: ' + getWeatherName(weather.id), weather.icon);
                            
                            // Radia캜n칤 bou콏e - speci치ln칤 efekt
                            if (weather.id === 'radstorm' && !state.map.inBase) {
                                state.status.radiation = Math.min(100, state.status.radiation + 15);
                                addLog('Radia캜n칤 bou콏e! +15 radiace', '驕뮖잺');
                            }
                        }
                        break;
                    }
                }
            }
            
            // Kontrola nemoc칤 z po캜as칤
            checkWeatherDisease();
        }
        
        // === SYST칄M NEMOC칈 ===
        
        // Inicializace diseases pokud neexistuje
        function initDiseases() {
            if (!state.diseases) {
                state.diseases = {
                    active: [],
                    immune: [],
                    lastWeatherCheck: 0,
                    totalCured: 0
                };
            }
            if (!state.diseases.active) state.diseases.active = [];
            if (!state.diseases.immune) state.diseases.immune = [];
        }
        
        // Z칤sk치n칤 aktivn칤 nemoci podle ID
        function getActiveDisease(diseaseId) {
            initDiseases();
            return state.diseases.active.find(d => d.id === diseaseId);
        }
        
        // M치 hr치캜 n캩jakou nemoc?
        function hasDisease(diseaseId) {
            initDiseases();
            return state.diseases.active.some(d => d.id === diseaseId);
        }
        
        // M치 hr치캜 jakoukoliv nemoc?
        function hasAnyDisease() {
            initDiseases();
            return state.diseases.active.length > 0;
        }
        
        // Je hr치캜 imunn칤 v콢캜i nemoci?
        function isImmuneTo(diseaseId) {
            initDiseases();
            const now = Date.now();
            return state.diseases.immune.some(i => i.diseaseId === diseaseId && i.until > now);
        }
        
        // P콏id치n칤 imunity
        function addDiseaseImmunity(diseaseId, duration = 3600000) {
            initDiseases();
            // Odstra켿 starou imunitu pokud existuje
            state.diseases.immune = state.diseases.immune.filter(i => i.diseaseId !== diseaseId);
            state.diseases.immune.push({ diseaseId, until: Date.now() + duration });
        }
        
        // Pokus o naka쬰n칤 nemoc칤
        function tryInfectDisease(diseaseId, customChance = null) {
            initDiseases();
            
            // U m치 tuto nemoc?
            if (hasDisease(diseaseId)) return false;
            
            // Je imunn칤?
            if (isImmuneTo(diseaseId)) return false;
            
            const disease = DISEASES.find(d => d.id === diseaseId);
            if (!disease) return false;
            
            const chance = customChance !== null ? customChance : disease.chance;
            
            // Bonus odolnost z vybaven칤 nebo skill콢
            let resistance = 0;
            
            // Plynov치 maska / hazmat - odolnost v콢캜i nemocem
            const helmet = state.equipped?.helmet;
            if (helmet) {
                const helmetData = ITEMS.find(i => i.id === helmet.id);
                if (helmetData?.special === 'rad_resist') resistance += 0.2;
                if (helmetData?.id === 'hazmat_helmet' || helmet.id === 'gas_mask_craft') resistance += 0.3;
            }
            
            // Skill odolnost (pokud existuje)
            const enduranceBonus = ((state.char?.attrs?.end || 5) - 5) * 0.02; // +2% za ka쬯칳 bod v칳dr쬰 nad 5
            resistance += enduranceBonus;
            
            // Kaple v osad캩 sni쬿je 코anci na nemoc
            if (state.base?.includes('chapel')) resistance += 0.15;
            
            const finalChance = Math.max(0.01, chance * (1 - resistance));
            
            if (Math.random() < finalChance) {
                // Naka쬰n!
                state.diseases.active.push({
                    id: diseaseId,
                    startTime: Date.now(),
                    duration: disease.duration
                });
                
                addLog(`游 Chytil jsi ${disease.name}!`, disease.icon);
                notifyWarning('Nemoc!', `${disease.icon} ${disease.name}: ${disease.desc}`);
                
                return true;
            }
            
            return false;
        }
        
        // Vyl칠캜en칤 nemoci
        function cureDisease(diseaseId) {
            initDiseases();
            
            const diseaseIndex = state.diseases.active.findIndex(d => d.id === diseaseId);
            if (diseaseIndex === -1) return false;
            
            const disease = DISEASES.find(d => d.id === diseaseId);
            state.diseases.active.splice(diseaseIndex, 1);
            state.diseases.totalCured = (state.diseases.totalCured || 0) + 1;
            
            // Do캜asn치 imunita po vyl칠캜en칤 (30 minut)
            addDiseaseImmunity(diseaseId, 1800000);
            
            if (disease) {
                addLog(`九 Vyl칠캜il ses z: ${disease.name}`, '游눍');
                notifySuccess('Vyl칠캜en!', `${disease.icon} ${disease.name} byla vyl칠캜ena`);
            }
            
            return true;
        }
        
        // Vyl칠캜en칤 v코ech nemoc칤
        function cureAllDiseases() {
            initDiseases();
            const count = state.diseases.active.length;
            
            state.diseases.active.forEach(d => {
                addDiseaseImmunity(d.id, 1800000);
            });
            
            state.diseases.active = [];
            state.diseases.totalCured = (state.diseases.totalCured || 0) + count;
            
            if (count > 0) {
                addLog(`九 V코echny nemoci vyl칠캜eny! (${count})`, '游눍');
                notifySuccess('Pln캩 zdr치v!', `Vyl칠캜eno ${count} nemoc칤`);
            }
            
            return count;
        }
        
        // Kontrola po캜as칤 a 코ance na nemoc
        function checkWeatherDisease() {
            initDiseases();
            const now = Date.now();
            
            // Kontroluj ka쬯칳ch 5 minut
            if (now - (state.diseases.lastWeatherCheck || 0) < 300000) return;
            state.diseases.lastWeatherCheck = now;
            
            // Pokud je hr치캜 v 칰krytu (v z치kladn캩), nem콢쬰 chytit nemoc z po캜as칤
            const inShelter = state.world?.currentLocation === 'shelter' || 
                             state.world?.currentLocation === 'settlement' ||
                             state.base?.includes('house');
            
            if (inShelter) return;
            
            const weather = state.weather?.current;
            
            // D칠코콘 nebo bou콏ka - 코ance na nachlazen칤/ch콏ipku
            if (weather === 'rain' || weather === 'storm') {
                const coldChance = weather === 'storm' ? 0.15 : 0.08;
                const fluChance = weather === 'storm' ? 0.06 : 0.03;
                
                // Nachlazen칤
                if (!hasDisease('cold') && !hasDisease('flu')) {
                    tryInfectDisease('cold', coldChance);
                }
                
                // Ch콏ipka (t캩쮄뫆, men코칤 코ance)
                if (!hasDisease('flu') && hasDisease('cold')) {
                    // Pokud u m치 nachlazen칤, vy코코칤 코ance na ch콏ipku
                    tryInfectDisease('flu', fluChance * 1.5);
                } else if (!hasDisease('flu')) {
                    tryInfectDisease('flu', fluChance);
                }
            }
            
            // Radia캜n칤 bou콏e - nemoc z oz치콏en칤
            if (weather === 'radstorm') {
                tryInfectDisease('radiation_sickness', 0.25);
            }
            
            // Vysok치 radiace (60+) - nemoc z oz치콏en칤
            if (state.status?.radiation >= 60) {
                tryInfectDisease('radiation_sickness', 0.10);
            }
        }
        
        // Kontrola nemoci po boji (infekce z ran)
        function checkCombatDisease() {
            initDiseases();
            
            // 마nce na infekci pokud HP pod 30%
            const hpPercent = state.char.hp / state.char.maxHp;
            if (hpPercent < 0.3) {
                const infectionChance = (0.3 - hpPercent) * 0.5; // Max 15% p콏i 0% HP
                tryInfectDisease('infection', infectionChance);
            }
        }
        
        // Kontrola otravy z j칤dla
        function checkFoodPoisoning(itemId) {
            initDiseases();
            
            // Syrov칠 maso
            if (itemId === 'raw_meat') {
                tryInfectDisease('food_poisoning', 0.4);
            }
            
            // Zka쬰n칠 j칤dlo (pokud by takov칳 syst칠m byl)
            if (itemId === 'spoiled_food' || itemId === 'rotten_meat') {
                tryInfectDisease('food_poisoning', 0.6);
            }
        }
        
        // Aplikace efekt콢 nemoc칤 (vol치 se v hern칤 smy캜ce)
        function applyDiseaseEffects() {
            initDiseases();
            const now = Date.now();
            
            // Projdi v코echny aktivn칤 nemoci
            state.diseases.active = state.diseases.active.filter(activeDisease => {
                const disease = DISEASES.find(d => d.id === activeDisease.id);
                if (!disease) return false;
                
                // Zkontroluj jestli nevypr코ela
                const elapsed = now - activeDisease.startTime;
                if (elapsed >= activeDisease.duration) {
                    addLog(`游눩 ${disease.name} p콏e코lo samo.`, disease.icon);
                    addDiseaseImmunity(disease.id, 1800000);
                    return false; // Odstra켿 z pole
                }
                
                // Aplikuj efekty (HP drain atd.)
                if (disease.effects.hpDrain) {
                    // HP drain ka쬯칳ch 30 minut
                    if (!activeDisease.lastHpDrain || now - activeDisease.lastHpDrain >= 1800000) {
                        activeDisease.lastHpDrain = now;
                        state.char.hp = Math.max(1, state.char.hp - disease.effects.hpDrain);
                        
                        addLog(`${disease.icon} ${disease.name} ti ubli쬿je... (-${disease.effects.hpDrain} HP)`, '游눖');
                    }
                }
                
                return true; // Ponech v poli
            });
        }
        
        // Z칤sk치n칤 celkov칳ch modifik치tor콢 z nemoc칤
        function getDiseaseModifiers() {
            initDiseases();
            
            const mods = {
                maxHpMod: 1.0,
                damageMod: 1.0,
                speedMod: 1.0,
                energyDrain: 1.0,
                hungerDrain: 1.0,
                moodMod: 1.0,
                radGain: 1.0
            };
            
            state.diseases.active.forEach(activeDisease => {
                const disease = DISEASES.find(d => d.id === activeDisease.id);
                if (!disease?.effects) return;
                
                if (disease.effects.maxHpMod) mods.maxHpMod *= disease.effects.maxHpMod;
                if (disease.effects.damageMod) mods.damageMod *= disease.effects.damageMod;
                if (disease.effects.speedMod) mods.speedMod *= disease.effects.speedMod;
                if (disease.effects.energyDrain) mods.energyDrain *= disease.effects.energyDrain;
                if (disease.effects.hungerDrain) mods.hungerDrain *= disease.effects.hungerDrain;
                if (disease.effects.moodMod) mods.moodMod *= disease.effects.moodMod;
                if (disease.effects.radGain) mods.radGain *= disease.effects.radGain;
            });
            
            return mods;
        }
        
        // Z칤sk치n칤 seznamu aktivn칤ch nemoc칤 pro UI
        function getActiveDiseases() {
            initDiseases();
            const now = Date.now();
            
            return state.diseases.active.map(activeDisease => {
                const disease = DISEASES.find(d => d.id === activeDisease.id);
                if (!disease) return null;
                
                const elapsed = now - activeDisease.startTime;
                const remaining = Math.max(0, activeDisease.duration - elapsed);
                const remainingMins = Math.ceil(remaining / 60000);
                const remainingHours = Math.floor(remaining / 3600000);
                const remainingMinsOnly = Math.ceil((remaining % 3600000) / 60000);
                
                return {
                    ...disease,
                    remaining,
                    remainingMins,
                    remainingHours,
                    remainingMinsOnly,
                    remainingText: remainingHours > 0 ? `${remainingHours}h ${remainingMinsOnly}m` : `${remainingMins}m`,
                    startTime: activeDisease.startTime
                };
            }).filter(d => d !== null);
        }
        
        // Zobrazen칤 UI pro nemoci
        function showDiseasesUI() {
            initDiseases();
            const diseases = getActiveDiseases();
            
            if (diseases.length === 0) {
                showModal('游낀 Zdravotn칤 stav', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游눜</div>
                        <h3 style="color: #4caf50;">Jsi zdrav칳!</h3>
                        <p style="color: #888; margin: 1rem 0;">콯치dn칠 aktivn칤 nemoci.</p>
                        <p style="color: #666; font-size: 0.85rem;">Celkem vyl칠캜eno: ${state.diseases.totalCured || 0} nemoc칤</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const diseasesHtml = diseases.map(d => {
                // Najdi l칠ky v invent치콏i
                const curesInInventory = state.inv.filter(item => {
                    const itemData = ITEMS.find(i => i.id === item.id);
                    return itemData?.cures?.includes(d.id);
                });
                
                const cureButtons = curesInInventory.length > 0 
                    ? curesInInventory.map(item => 
                        `<button class="btn" onclick="useDiseaseItem('${item.id}', '${d.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4caf50;">
                            ${ITEMS.find(i => i.id === item.id)?.icon || '游눍'} Pou쮂셦 ${ITEMS.find(i => i.id === item.id)?.name || item.id}
                        </button>`
                    ).join(' ')
                    : `<span style="color: #f44336; font-size: 0.8rem;">Nem치코 l칠k! Pot콏ebuje코: ${d.cures.map(c => ITEMS.find(i => i.id === c)?.name || c).join(', ')}</span>`;
                
                const severityColor = d.severity === 1 ? '#ffeb3b' : d.severity === 2 ? '#ff9800' : '#f44336';
                
                return `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${severityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;">${d.icon} <strong>${d.name}</strong></span>
                            <span style="color: #888;">낌勇 ${d.remainingText}</span>
                        </div>
                        <p style="color: #aaa; margin: 0.5rem 0; font-size: 0.85rem;">${d.desc}</p>
                        <div style="margin-top: 0.5rem;">
                            ${cureButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
            showModal('游낀 Zdravotn칤 stav', `
                <div style="margin-bottom: 1rem;">
                    <p style="color: #f44336; margin: 0;">丘멆잺 M치코 ${diseases.length} aktivn칤 ${diseases.length === 1 ? 'nemoc' : 'nemoci'}!</p>
                </div>
                ${diseasesHtml}
                <div style="margin-top: 1rem; padding: 0.5rem; background: #0a1a0a; border-radius: 8px;">
                    <p style="color: #888; margin: 0; font-size: 0.8rem;">游눠 Tip: Nemoci m콢쬰코 l칠캜it l칠ky, u doktora, nebo po캜kat a p콏ejdou samy.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">Zav콏칤t</button>
            `);
        }
        
        // Pou쬴t칤 l칠ku na nemoc
        function useDiseaseItem(itemId, diseaseId) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) {
                notifyWarning('Chyba', 'Tento p콏edm캩t nem치코!');
                return;
            }
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === itemId);
            
            if (!itemData?.cures?.includes(diseaseId)) {
                notifyWarning('Nefunguje', 'Tento l칠k na tuto nemoc nezab칤r치!');
                return;
            }
            
            // Vyl칠캜 nemoc
            cureDisease(diseaseId);
            
            // Aplikuj i norm치ln칤 efekt l칠ku (HP, radiace atd.)
            if (itemData.effect === 'health' && itemData.value) {
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + itemData.value);
                addLog(`+${itemData.value} HP`, '仇벒잺');
            }
            if (itemData.effect === 'radiation' && itemData.value) {
                state.status.radiation = Math.max(0, state.status.radiation + itemData.value);
                addLog(`${itemData.value} radiace`, '驕뮖잺');
            }
            if (itemData.effect === 'thirst' && itemData.value) {
                state.status.thirst = Math.min(100, state.status.thirst + itemData.value);
            }
            
            // Odeber item
            if (item.count && item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            closeModal();
            showDiseasesUI();
            renderFull();
        }
        
        // Export funkc칤 pro glob치ln칤 pou쬴t칤
        window.showDiseasesUI = showDiseasesUI;
        window.useDiseaseItem = useDiseaseItem;
        window.cureDisease = cureDisease;
        window.cureAllDiseases = cureAllDiseases;
        
        // === SYST칄M SET콡 POVOL츼N칈 ===
        
        // Zkontroluj jestli hr치캜 m콢쬰 nasadit set item (pouze pro sv칠 povol치n칤)
        function canEquipSetItem(itemId) {
            const playerClass = state.char?.classId;
            if (!playerClass) return false;
            
            // Najdi ke kter칠mu setu item pat콏칤
            for (const [classId, setData] of Object.entries(CLASS_SETS)) {
                for (const piece of Object.values(setData.pieces)) {
                    if (piece.id === itemId) {
                        // Pat콏칤 k tomuto setu - m콢쬰 nasadit jen dan치 t콏칤da
                        return classId === playerClass;
                    }
                }
            }
            
            // Nen칤 to set item - m콢쬰 nasadit kdokoliv
            return true;
        }
        
        // Z칤skej po캜et nasazen칳ch d칤l콢 setu
        function getEquippedSetPieces() {
            const playerClass = state.char?.classId;
            if (!playerClass || !CLASS_SETS[playerClass]) return { count: 0, pieces: [] };
            
            const setData = CLASS_SETS[playerClass];
            const equippedPieces = [];
            
            // Projdi v코echny d칤ly setu
            for (const [slot, piece] of Object.entries(setData.pieces)) {
                // Zkontroluj podle slotu
                if (slot === 'weapon' && state.equipped?.weapon?.id === piece.id) {
                    equippedPieces.push(piece);
                } else if (slot === 'helmet' && state.equipped?.helmet?.id === piece.id) {
                    equippedPieces.push(piece);
                } else if (slot === 'armor' && state.equipped?.armor?.id === piece.id) {
                    equippedPieces.push(piece);
                } else if ((slot === 'accessory1' || slot === 'accessory2') && 
                          (state.equipped?.accessory?.id === piece.id || state.equipped?.accessory2?.id === piece.id)) {
                    equippedPieces.push(piece);
                } else if (slot === 'boots' && state.equipped?.boots?.id === piece.id) {
                    equippedPieces.push(piece);
                }
            }
            
            return { count: equippedPieces.length, pieces: equippedPieces };
        }
        
        // Z칤skej aktivn칤 set bonusy
        function getSetBonuses() {
            const playerClass = state.char?.classId;
            if (!playerClass || !CLASS_SETS[playerClass]) return null;
            
            const setData = CLASS_SETS[playerClass];
            const { count, pieces } = getEquippedSetPieces();
            
            if (count === 0) return null;
            
            const bonuses = {
                setName: setData.name,
                setIcon: setData.icon,
                piecesCount: count,
                pieceBonuses: pieces.map(p => ({ ...p.bonus, desc: p.bonusDesc })),
                setBonus2: count >= 2 ? setData.setBonus2 : null,
                setBonus3: count >= 3 ? setData.setBonus3 : null
            };
            
            return bonuses;
        }
        
        // Z칤skej VECHNY aktivn칤 set efekty (pro pou쬴t칤 v boji, l칠캜en칤, atd.)
        function getActiveSetEffects() {
            const effects = {
                // Piece bonuses (jednotliv칠 d칤ly)
                str: 0, end: 0, agi: 0, per: 0, int: 0, lck: 0,
                damageBonus: 0, critChance: 0, critDamage: 0, dodgeChance: 0,
                maxHp: 0, healBonus: 0, lifesteal: 0, radResist: 0,
                travelSpeed: 0, lootBonus: 0, shopDiscount: 0, carryWeight: 0,
                
                // Set (2) bonuses
                extraCritChance: 0,          // raider
                frenzyDamage: 0,             // berserker
                damageReduction: 0,          // survivor
                thorns: 0,                   // tank
                ambush: false,               // stalker
                bleed: false,                // assassin
                groupHeal: false,            // medic
                acidSplash: false,           // alchemist
                rareFind: 0,                 // scavenger
                tracking: false,             // hunter
                repairBonus: 0,              // engineer
                chainExplosion: false,       // demolitionist
                haggle: false,               // trader
                desertWalker: false,         // nomad
                radAura: false,              // mutant
                psychicVision: false,        // psychic
                
                // Set (3) bonuses
                rageImproved: false,         // raider - rage od 50% HP
                unstoppable: false,          // berserker - nelze omr치캜it
                lastStandImproved: false,    // survivor - 35% 코ance
                fortressImproved: false,     // tank - 40% block
                stealthImproved: false,      // stalker - 70% stealth
                executeImproved: false,      // assassin - 3x crit
                regenImproved: false,        // medic - +6 HP/min
                poisonImproved: false,       // alchemist - 15 DOT
                luckyFindImproved: false,    // scavenger - 30% double
                animalLootImproved: false,   // hunter - +200%
                masterCrafter: false,        // engineer - 25% surovin
                boomImproved: false,         // demolitionist - 25%/60%
                barterImproved: false,       // trader - +75%
                npcTrust: 0,                 // nomad - +30 trust
                radRegenImproved: false,     // mutant - +8 HP/z치sah
                mindControlImproved: false   // psychic - 30%
            };
            
            const bonuses = getSetBonuses();
            if (!bonuses) return effects;
            
            // Aplikuj piece bonusy
            bonuses.pieceBonuses.forEach(pb => {
                if (pb.str) effects.str += pb.str;
                if (pb.end) effects.end += pb.end;
                if (pb.agi) effects.agi += pb.agi;
                if (pb.per) effects.per += pb.per;
                if (pb.int) effects.int += pb.int;
                if (pb.lck) effects.lck += pb.lck;
                if (pb.damageBonus) effects.damageBonus += pb.damageBonus;
                if (pb.critChance) effects.critChance += pb.critChance;
                if (pb.critDamage) effects.critDamage += pb.critDamage;
                if (pb.dodgeChance) effects.dodgeChance += pb.dodgeChance;
                if (pb.maxHp) effects.maxHp += pb.maxHp;
                if (pb.healBonus) effects.healBonus += pb.healBonus;
                if (pb.lifesteal) effects.lifesteal += pb.lifesteal;
                if (pb.radResist) effects.radResist += pb.radResist;
                if (pb.travelSpeed) effects.travelSpeed += pb.travelSpeed;
                if (pb.lootBonus) effects.lootBonus += pb.lootBonus;
                if (pb.shopDiscount) effects.shopDiscount += pb.shopDiscount;
                if (pb.carryWeight) effects.carryWeight += pb.carryWeight;
                if (pb.lowHpDamage) effects.lowHpDamage = (effects.lowHpDamage || 0) + pb.lowHpDamage;
                if (pb.critOnAnimals) effects.critOnAnimals = (effects.critOnAnimals || 0) + pb.critOnAnimals;
                if (pb.radHeal) effects.radHeal = true;
            });
            
            // Aplikuj set (2) bonusy
            if (bonuses.setBonus2) {
                const sb2 = bonuses.setBonus2;
                if (sb2.critChance) effects.extraCritChance += sb2.critChance;
                if (sb2.frenzyDamage) effects.frenzyDamage = sb2.frenzyDamage;
                if (sb2.damageReduction) effects.damageReduction = sb2.damageReduction;
                if (sb2.thorns) effects.thorns = sb2.thorns;
                if (sb2.ambush) effects.ambush = true;
                if (sb2.bleed) effects.bleed = true;
                if (sb2.groupHeal) effects.groupHeal = true;
                if (sb2.acidSplash) effects.acidSplash = true;
                if (sb2.rareFind) effects.rareFind = sb2.rareFind;
                if (sb2.tracking) effects.tracking = true;
                if (sb2.repairBonus) effects.repairBonus = sb2.repairBonus;
                if (sb2.chainExplosion) effects.chainExplosion = true;
                if (sb2.haggle) effects.haggle = true;
                if (sb2.desertWalker) effects.desertWalker = true;
                if (sb2.radAura) effects.radAura = true;
                if (sb2.psychicVision) effects.psychicVision = true;
            }
            
            // Aplikuj set (3) bonusy
            if (bonuses.setBonus3) {
                const sb3 = bonuses.setBonus3;
                if (sb3.rage) effects.rageImproved = true;
                if (sb3.unstoppable) effects.unstoppable = true;
                if (sb3.lastStandImproved) effects.lastStandImproved = true;
                if (sb3.fortressImproved) effects.fortressImproved = true;
                if (sb3.stealthImproved) effects.stealthImproved = true;
                if (sb3.executeImproved) effects.executeImproved = true;
                if (sb3.regenImproved) effects.regenImproved = true;
                if (sb3.poisonImproved) effects.poisonImproved = true;
                if (sb3.luckyFindImproved) effects.luckyFindImproved = true;
                if (sb3.animalLootImproved) effects.animalLootImproved = true;
                if (sb3.masterCrafter) effects.masterCrafter = true;
                if (sb3.boomImproved) effects.boomImproved = true;
                if (sb3.barterImproved) effects.barterImproved = true;
                if (sb3.npcTrust) effects.npcTrust = sb3.npcTrust;
                if (sb3.radRegenImproved) effects.radRegenImproved = true;
                if (sb3.mindControlImproved) effects.mindControlImproved = true;
            }
            
            return effects;
        }
        window.getActiveSetEffects = getActiveSetEffects;
        
        // Z칤skej text o set bonusech pro UI
        function getSetBonusText() {
            const bonuses = getSetBonuses();
            if (!bonuses) return '';
            
            const playerClass = state.char?.classId;
            const setData = CLASS_SETS[playerClass];
            const totalPieces = Object.keys(setData.pieces).length;
            
            let text = `<div style="background: linear-gradient(135deg, #2a1a3a 0%, #1a0a2a 100%); padding: 0.8rem; border-radius: 8px; border: 1px solid #9c27b0; margin: 0.5rem 0;">`;
            text += `<h4 style="margin: 0 0 0.5rem 0; color: #ce93d8;">${bonuses.setIcon} ${bonuses.setName} (${bonuses.piecesCount}/${totalPieces})</h4>`;
            
            // Bonusy jednotliv칳ch d칤l콢
            bonuses.pieceBonuses.forEach(b => {
                text += `<p style="margin: 0.2rem 0; color: #81c784; font-size: 0.85rem;">九 ${b.desc}</p>`;
            });
            
            // Set bonus za 2 d칤ly
            if (setData.setBonus2) {
                const active2 = bonuses.piecesCount >= 2;
                text += `<p style="margin: 0.3rem 0 0.1rem 0; color: ${active2 ? '#ffd700' : '#666'}; font-size: 0.85rem;">(2) ${setData.setBonus2.desc} ${active2 ? '九' : ''}</p>`;
            }
            
            // Set bonus za 3 d칤ly
            if (setData.setBonus3) {
                const active3 = bonuses.piecesCount >= 3;
                text += `<p style="margin: 0.1rem 0; color: ${active3 ? '#ff9800' : '#666'}; font-size: 0.85rem;">(3) ${setData.setBonus3.desc} ${active3 ? '九' : ''}</p>`;
            }
            
            text += `</div>`;
            return text;
        }
        
        // Zjisti jestli je item sou캜치st칤 setu
        function isSetItem(itemId) {
            for (const setData of Object.values(CLASS_SETS)) {
                for (const piece of Object.values(setData.pieces)) {
                    if (piece.id === itemId) return true;
                }
            }
            return false;
        }
        
        // Z칤skej info o set itemu
        function getSetItemInfo(itemId) {
            for (const [classId, setData] of Object.entries(CLASS_SETS)) {
                for (const piece of Object.values(setData.pieces)) {
                    if (piece.id === itemId) {
                        return {
                            setName: setData.name,
                            setIcon: setData.icon,
                            className: CLASSES[classId]?.name || classId,
                            classIcon: CLASSES[classId]?.icon || '游녻',
                            classId: classId,
                            piece: piece,
                            setBonus2: setData.setBonus2,
                            setBonus3: setData.setBonus3,
                            totalPieces: Object.keys(setData.pieces).length
                        };
                    }
                }
            }
            return null;
        }
        
        // Export set funkc칤
        window.canEquipSetItem = canEquipSetItem;
        window.getEquippedSetPieces = getEquippedSetPieces;
        window.getSetBonuses = getSetBonuses;
        window.getSetBonusText = getSetBonusText;
        window.isSetItem = isSetItem;
        window.getSetItemInfo = getSetItemInfo;
        
        // Zobrazen칤 UI pro set povol치n칤
        function showClassSetUI() {
            const playerClass = state.char?.classId;
            const className = CLASSES[playerClass]?.name || 'Nezn치m칠';
            const classIcon = CLASSES[playerClass]?.icon || '游녻';
            
            if (!playerClass || !CLASS_SETS[playerClass]) {
                showModal('救 Set povol치n칤', `
                    <div style="text-align: center;">
                        <p style="color: #888;">Tv칠 povol치n칤 nem치 speci치ln칤 set.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">Zav콏칤t</button>
                `);
                return;
            }
            
            const setData = CLASS_SETS[playerClass];
            const { count, pieces: equippedPieces } = getEquippedSetPieces();
            const totalPieces = Object.keys(setData.pieces).length;
            
            // Sestaven칤 HTML pro v코echny d칤ly setu
            let piecesHtml = '';
            for (const [slot, piece] of Object.entries(setData.pieces)) {
                const isEquipped = equippedPieces.some(p => p.id === piece.id);
                const hasInInventory = state.inv.some(i => i.id === piece.id);
                
                piecesHtml += `
                    <div style="background: ${isEquipped ? '#1a3a1a' : '#1a1a1a'}; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; border: 1px solid ${isEquipped ? '#4caf50' : '#333'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-size: 1.2rem;">${piece.icon}</span>
                                <span style="color: ${isEquipped ? '#4caf50' : '#fff'}; margin-left: 0.3rem;">${piece.name}</span>
                                ${isEquipped ? '<span style="color: #4caf50; font-size: 0.75rem; margin-left: 0.3rem;">九 NASAZENO</span>' : ''}
                                ${!isEquipped && hasInInventory ? '<span style="color: #ff9800; font-size: 0.75rem; margin-left: 0.3rem;">游닍 V invent치콏i</span>' : ''}
                            </div>
                            <span style="color: #888; font-size: 0.75rem;">${slot === 'weapon' ? '丘덢잺' : slot === 'helmet' ? '久놾잺' : slot === 'armor' ? '游띠勇' : slot.includes('accessory') ? '游눐' : '游'}</span>
                        </div>
                        <p style="color: #81c784; font-size: 0.8rem; margin: 0.3rem 0 0 0;">九 ${piece.bonusDesc}</p>
                        ${piece.damage ? `<p style="color: #f44336; font-size: 0.75rem; margin: 0.2rem 0 0 0;">丘덢잺 ${piece.damage} damage</p>` : ''}
                        ${piece.defense ? `<p style="color: #2196f3; font-size: 0.75rem; margin: 0.2rem 0 0 0;">游띠勇 ${piece.defense} obrana</p>` : ''}
                    </div>
                `;
            }
            
            // Set bonusy
            let setBonusHtml = `
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; margin-top: 0.8rem; border: 1px solid #444;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ce93d8;">Set bonusy:</h4>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
                        <span style="color: ${count >= 2 ? '#ffd700' : '#555'}; font-weight: bold;">(2)</span>
                        <span style="color: ${count >= 2 ? '#ffd700' : '#666'};">${setData.setBonus2.desc}</span>
                        ${count >= 2 ? '<span style="color: #4caf50;">九</span>' : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: ${count >= 3 ? '#ff9800' : '#555'}; font-weight: bold;">(3)</span>
                        <span style="color: ${count >= 3 ? '#ff9800' : '#666'};">${setData.setBonus3.desc}</span>
                        ${count >= 3 ? '<span style="color: #4caf50;">九</span>' : ''}
                    </div>
                </div>
            `;
            
            showModal(`${setData.icon} ${setData.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <span style="font-size: 2rem;">${classIcon}</span>
                    <h3 style="margin: 0.3rem 0; color: #ce93d8;">${className}</h3>
                    <p style="color: ${count >= 3 ? '#ff9800' : count > 0 ? '#ce93d8' : '#666'}; font-size: 1.1rem; margin: 0;">
                        ${count}/${totalPieces} d칤l콢 nasazeno
                    </p>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto;">
                    ${piecesHtml}
                </div>
                
                ${setBonusHtml}
                
                <p style="color: #888; font-size: 0.75rem; margin-top: 0.8rem; text-align: center;">
                    游눠 Set itemy padaj칤 z boss콢 (8% 코ance). Pouze pro tv칠 povol치n칤!
                </p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">Zav콏칤t</button>
            `);
        }
        window.showClassSetUI = showClassSetUI;
        
        // === SYST칄M ZRAN캨N칈 ===
        
        // Inicializace injuries pokud neexistuje
        function initInjuries() {
            if (!state.injuries) {
                state.injuries = {
                    active: [],
                    immune: [],
                    totalHealed: 0
                };
            }
            if (!state.injuries.active) state.injuries.active = [];
            if (!state.injuries.immune) state.injuries.immune = [];
        }
        
        // Je hr치캜 imunn칤 v콢캜i zran캩n칤? (po vyl칠캜en칤)
        function isImmuneToInjury(injuryId) {
            initInjuries();
            const now = Date.now();
            // Vy캜isti pro코l칠 imunity
            state.injuries.immune = state.injuries.immune.filter(i => i.until > now);
            return state.injuries.immune.some(i => i.injuryId === injuryId);
        }
        
        // P콏idej do캜asnou imunitu v콢캜i zran캩n칤
        function addInjuryImmunity(injuryId, duration = 1800000) { // Default 30 minut
            initInjuries();
            // Odeber starou imunitu pokud existuje
            state.injuries.immune = state.injuries.immune.filter(i => i.injuryId !== injuryId);
            state.injuries.immune.push({ injuryId, until: Date.now() + duration });
        }
        
        // M치 hr치캜 n캩jak칠 zran캩n칤?
        function hasInjury(injuryId) {
            initInjuries();
            return state.injuries.active.some(i => i.id === injuryId);
        }
        
        // M치 hr치캜 jak칠koliv zran캩n칤?
        function hasAnyInjury() {
            initInjuries();
            return state.injuries.active.length > 0;
        }
        
        // Pokus o zp콢soben칤 zran캩n칤
        function tryInflictInjury(injuryId, customChance = null) {
            initInjuries();
            
            // U m치 toto zran캩n칤?
            if (hasInjury(injuryId)) return false;
            
            // Je imunn칤? (ned치vno vyl칠캜en)
            if (isImmuneToInjury(injuryId)) return false;
            
            const injury = INJURIES.find(i => i.id === injuryId);
            if (!injury) return false;
            
            const chance = customChance !== null ? customChance : injury.chance;
            
            // Bonus odolnost z vybaven칤
            let resistance = 0;
            
            // Zbroj sni쬿je 코anci na zran캩n칤
            const armor = state.equipped?.armor;
            if (armor?.defense) {
                resistance += Math.min(0.3, armor.defense * 0.01); // Max 30% z brn캩n칤
            }
            
            // Helmet chr치n칤 p콏ed ot콏esem mozku
            if (injuryId === 'concussion' && state.equipped?.helmet) {
                resistance += 0.4;
            }
            
            // Boty chr치n칤 p콏ed v칳ronem
            if (injuryId === 'sprain' && state.equipped?.boots) {
                resistance += 0.2;
            }
            
            // Skill tree bonus
            if (typeof getSkillTreeBonus === 'function') {
                resistance += getSkillTreeBonus('injuryResist') || 0;
            }
            
            const finalChance = Math.max(0.01, chance * (1 - resistance));
            
            if (Math.random() < finalChance) {
                // Zran캩n!
                state.injuries.active.push({
                    id: injuryId,
                    startTime: Date.now(),
                    duration: injury.duration
                });
                
                addLog(`游뱃 Utrp캩l jsi ${injury.name}!`, injury.icon);
                notifyWarning('Zran캩n칤!', `${injury.icon} ${injury.name}: ${injury.desc}`);
                
                return true;
            }
            
            return false;
        }
        
        // Vyl칠캜en칤 zran캩n칤
        function healInjury(injuryId) {
            initInjuries();
            
            const injuryIndex = state.injuries.active.findIndex(i => i.id === injuryId);
            if (injuryIndex === -1) return false;
            
            const injury = INJURIES.find(i => i.id === injuryId);
            state.injuries.active.splice(injuryIndex, 1);
            state.injuries.totalHealed = (state.injuries.totalHealed || 0) + 1;
            
            // Do캜asn치 imunita po vyl칠캜en칤 (30 minut)
            addInjuryImmunity(injuryId, 1800000);
            
            if (injury) {
                addLog(`九 Vyl칠캜il ses ze zran캩n칤: ${injury.name}`, '游뽗');
                notifySuccess('Vyl칠캜eno!', `${injury.icon} ${injury.name} bylo o코et콏eno (30 min imunita)`);
            }
            
            return true;
        }
        
        // Vyl칠캜en칤 v코ech zran캩n칤
        function healAllInjuries() {
            initInjuries();
            const count = state.injuries.active.length;
            
            // P콏idej imunitu pro ka쬯칠 vyl칠캜en칠 zran캩n칤
            state.injuries.active.forEach(activeInjury => {
                addInjuryImmunity(activeInjury.id, 1800000);
            });
            
            state.injuries.active = [];
            state.injuries.totalHealed = (state.injuries.totalHealed || 0) + count;
            
            if (count > 0) {
                addLog(`九 V코echna zran캩n칤 o코et콏ena! (${count})`, '游뽗');
                notifySuccess('Pln캩 zdr치v!', `O코et콏eno ${count} zran캩n칤 (30 min imunita)`);
            }
            
            return count;
        }
        
        // Kontrola zran캩n칤 z boje - podle typu zbran캩 nep콏칤tele
        function checkCombatInjury(damageReceived, enemyType = null, enemyWeapon = null) {
            initInjuries();
            
            // Z치kladn칤 코ance podle obdr쬰n칠ho damage (% z max HP)
            const baseDamageRatio = damageReceived / state.char.maxHp;
            
            // Pokud damage je p콏칤li코 mal칳, 쮂멳n칠 zran캩n칤
            if (baseDamageRatio < 0.05) return;
            
            // === DETEKCE TYPU ZBRAN캨 NEP콎칈TELE ===
            const enemyLower = (enemyType || '').toLowerCase();
            const weaponLower = (enemyWeapon || '').toLowerCase();
            
            // Kategorie zbran칤
            const isBlunt = weaponLower.includes('palice') || weaponLower.includes('p치lka') || 
                           weaponLower.includes('kladivo') || weaponLower.includes('h콢l') ||
                           weaponLower.includes('klacek') || weaponLower.includes('p캩st') ||
                           enemyLower.includes('behemoth') || enemyLower.includes('robot') ||
                           enemyLower.includes('golem');
                           
            const isSharp = weaponLower.includes('me캜') || weaponLower.includes('n콢') ||
                          weaponLower.includes('ma캜eta') || weaponLower.includes('sekera') ||
                          weaponLower.includes('dr치p') || weaponLower.includes('tes치k') ||
                          enemyLower.includes('deathclaw') || enemyLower.includes('vlk') ||
                          enemyLower.includes('wolf') || enemyLower.includes('mutant');
                          
            const isRanged = weaponLower.includes('pistol') || weaponLower.includes('pu코ka') ||
                           weaponLower.includes('ku코e') || weaponLower.includes('luk') ||
                           weaponLower.includes('brokov') || weaponLower.includes('코칤p');
                           
            const isFire = weaponLower.includes('ohe켿') || weaponLower.includes('plamen') ||
                         weaponLower.includes('molotov') || weaponLower.includes('laser') ||
                         enemyLower.includes('fire') || enemyLower.includes('flame');
                         
            const isHeavy = enemyLower.includes('behemoth') || enemyLower.includes('deathclaw') ||
                          enemyLower.includes('boss') || enemyLower.includes('giant') ||
                          enemyLower.includes('tank');
            
            // === V칗PO캛ET ㅁNC칈 PODLE TYPU ZBRAN캨 ===
            
            // 游릮 MOD콎INA - tup칠 zbran캩, p캩sti, p치dy
            // Base: 8% + 20% za ka쬯칳ch 10% HP ztr치ty
            // Tup칠 zbran캩: 2x 코ance
            let bruiseChance = 0.08 + baseDamageRatio * 0.2;
            if (isBlunt) bruiseChance *= 2.0;
            if (isRanged) bruiseChance *= 0.3; // St콏eln칠 zbran캩 m치lokdy d캩laj칤 mod콏iny
            if (baseDamageRatio > 0.05) {
                tryInflictInjury('bruise', bruiseChance);
            }
            
            // 游뽖 콎EZN츼 R츼NA - ostr칠 zbran캩, dr치py
            // Base: 10% + 15% za ka쬯칳ch 10% HP ztr치ty
            // Ostr칠 zbran캩: 2.5x 코ance
            let cutChance = 0.10 + baseDamageRatio * 0.15;
            if (isSharp) cutChance *= 2.5;
            if (isBlunt) cutChance *= 0.2; // Tup칠 zbran캩 m치lokdy 콏e쬺u
            if (isRanged) cutChance *= 0.5; // St콏ely m콢쬺u 콏칤znout
            if (baseDamageRatio > 0.08) {
                tryInflictInjury('cut', cutChance);
            }
            
            // 游붰 V칗RON - p콏i t캩쬶칠m z치sahu, p치du, 칰niku
            // Base: 5% + 10% za ka쬯칳ch 10% HP ztr치ty
            // T캩쬮칤 nep콏치tel칠 (odhod칤 t캩): 2x 코ance
            let sprainChance = 0.05 + baseDamageRatio * 0.1;
            if (isHeavy) sprainChance *= 2.0;
            if (baseDamageRatio > 0.15) {
                tryInflictInjury('sprain', sprainChance);
            }
            
            // 游붮 ZLOMENINA - velmi t캩쬶칠 칰dery, p치dy z v칳코ky
            // Base: 3% + 10% za ka쬯칳ch 10% HP ztr치ty
            // Tup칠 zbran캩 od t캩쬶칳ch nep콏치tel: 3x 코ance
            let fractureChance = 0.03 + baseDamageRatio * 0.1;
            if (isBlunt && isHeavy) fractureChance *= 3.0;
            else if (isBlunt) fractureChance *= 1.5;
            else if (isHeavy) fractureChance *= 2.0;
            if (isSharp) fractureChance *= 0.3; // Ostr칠 zbran캩 m치lokdy l치mou kosti
            if (baseDamageRatio > 0.25) {
                tryInflictInjury('fracture', fractureChance);
            }
            
            // 游뱃 OT콎ES MOZKU - 칰der do hlavy
            // Base: 4% + 8% za ka쬯칳ch 10% HP ztr치ty
            // Tup칠 zbran캩: 3x 코ance
            // 30% 코ance 쬰 z치sah byl do hlavy
            let concussionChance = 0.04 + baseDamageRatio * 0.08;
            if (isBlunt) concussionChance *= 3.0;
            if (isSharp) concussionChance *= 0.5;
            if (isRanged) concussionChance *= 0.3; // Headshot je vz치cn칳
            if (baseDamageRatio > 0.2 && Math.random() < 0.3) {
                tryInflictInjury('concussion', concussionChance);
            }
            
            // 游댠 POP츼LENINA - ohe켿, laser, exploze
            // Base: 15% p콏i ohniv칠m 칰toku
            let burnChance = 0.15;
            if (isFire) {
                tryInflictInjury('burn', burnChance);
            }
            
            // 游땰 VY캛ERP츼N칈 - dlouh칳 boj (5+ kol)
            // Base: 10% + 2% za ka쬯칠 kolo nad 5
            if (window.combatState?.round > 5) {
                const exhaustionChance = 0.1 + (window.combatState.round - 5) * 0.02;
                tryInflictInjury('exhaustion', exhaustionChance);
            }
        }
        
        // Kontrola zran캩n칤 z cestov치n칤 - podle vzd치lenosti, nebezpe캜칤 a ter칠nu
        function checkTravelInjury(distance, danger) {
            initInjuries();
            
            // Mapa m치 vzd치lenosti typicky 2-8 km mezi lokacemi
            // Z치kladn칤 코ance: vzd치lenost/10 * (1 + danger*0.3)
            // Nap콏: 3km, danger 1 = 0.3 * 1.3 = 0.39 base
            // Nap콏: 6km, danger 3 = 0.6 * 1.9 = 1.14 base
            // Nap콏: 8km, danger 4 = 0.8 * 2.2 = 1.76 base
            const baseChance = (distance / 10) * (1 + danger * 0.3);
            
            // 游릮 MOD콎INA - p치d, klop칳tnut칤, n치raz
            // 마nce: base * 8%
            // Nap콏: 3km, danger 1 = 0.39 * 0.08 = 3.1%
            // Nap콏: 6km, danger 3 = 1.14 * 0.08 = 9.1%
            // Nap콏: 8km, danger 4 = 1.76 * 0.08 = 14%
            const bruiseChance = baseChance * 0.08;
            if (Math.random() < bruiseChance) {
                tryInflictInjury('bruise');
            }
            
            // 游붰 V칗RON - 코patn칳 ter칠n, kluzko, nerovnosti
            // 마nce: base * 5% * (1 + danger*0.3)
            // Vy코코칤 nebezpe캜칤 = hor코칤 ter칠n
            // Nap콏: 3km, danger 1 = 0.39 * 0.05 * 1.3 = 2.5%
            // Nap콏: 6km, danger 3 = 1.14 * 0.05 * 1.9 = 10.8%
            const sprainChance = baseChance * 0.05 * (1 + danger * 0.3);
            if (Math.random() < sprainChance) {
                tryInflictInjury('sprain');
            }
            
            // 游땰 VY캛ERP츼N칈 - jen p콏i vysok칠m nebezpe캜칤 (danger 3+) nebo del코칤 cest캩 (5+ km)
            // 마nce: base * 6%
            if (danger >= 3 || distance >= 5) {
                const exhaustionChance = baseChance * 0.06;
                if (Math.random() < exhaustionChance) {
                    tryInflictInjury('exhaustion');
                }
            }
            
            // 游붮 ZLOMENINA - p치d z v칳코ky na velmi nebezpe캜n칠 cest캩 (danger 4+)
            // Velmi vz치cn칠: base * 1.5%
            if (danger >= 4) {
                const fractureChance = baseChance * 0.015;
                if (Math.random() < fractureChance) {
                    tryInflictInjury('fracture');
                }
            }
            
            // 游뽖 콎EZN츼 R츼NA - pr콢chod hust칳m porostem na nebezpe캜n칠 cest캩 (danger 2+)
            // 마nce: base * 3%
            if (danger >= 2) {
                const cutChance = baseChance * 0.03;
                if (Math.random() < cutChance) {
                    tryInflictInjury('cut');
                }
            }
        }
        
        // Aplikace efekt콢 zran캩n칤 (vol치 se v hern칤 smy캜ce)
        function applyInjuryEffects() {
            initInjuries();
            const now = Date.now();
            
            // Projdi v코echna aktivn칤 zran캩n칤
            state.injuries.active = state.injuries.active.filter(activeInjury => {
                const injury = INJURIES.find(i => i.id === activeInjury.id);
                if (!injury) return false;
                
                // Zkontroluj jestli nevypr코elo
                const elapsed = now - activeInjury.startTime;
                if (elapsed >= activeInjury.duration) {
                    // Do캜asn치 imunita po p콏irozen칠m zahojen칤 (30 minut)
                    addInjuryImmunity(activeInjury.id, 1800000);
                    addLog(`游눩 ${injury.name} se zahojilo. (30 min imunita)`, injury.icon);
                    return false; // Odstra켿 z pole
                }
                
                // Aplikuj efekty (HP drain atd.)
                if (injury.effects.hpDrain) {
                    // HP drain ka쬯칳ch 30 minut
                    if (!activeInjury.lastHpDrain || now - activeInjury.lastHpDrain >= 1800000) {
                        activeInjury.lastHpDrain = now;
                        state.char.hp = Math.max(1, state.char.hp - injury.effects.hpDrain);
                        addLog(`${injury.icon} ${injury.name} krv치c칤... (-${injury.effects.hpDrain} HP)`, '游눖');
                    }
                }
                
                return true; // Ponech v poli
            });
        }
        
        // Z칤sk치n칤 celkov칳ch modifik치tor콢 ze zran캩n칤
        function getInjuryModifiers() {
            initInjuries();
            
            const mods = {
                damageMod: 1.0,
                defenseMod: 1.0,
                speedMod: 1.0,
                critMod: 1.0,
                dodgeMod: 1.0,
                energyDrain: 1.0,
                perceptionMod: 1.0
            };
            
            state.injuries.active.forEach(activeInjury => {
                const injury = INJURIES.find(i => i.id === activeInjury.id);
                if (!injury?.effects) return;
                
                if (injury.effects.damageMod) mods.damageMod *= injury.effects.damageMod;
                if (injury.effects.defenseMod) mods.defenseMod *= injury.effects.defenseMod;
                if (injury.effects.speedMod) mods.speedMod *= injury.effects.speedMod;
                if (injury.effects.critMod) mods.critMod *= injury.effects.critMod;
                if (injury.effects.dodgeMod) mods.dodgeMod *= injury.effects.dodgeMod;
                if (injury.effects.energyDrain) mods.energyDrain *= injury.effects.energyDrain;
                if (injury.effects.perceptionMod) mods.perceptionMod *= injury.effects.perceptionMod;
            });
            
            return mods;
        }
        
        // Z칤sk치n칤 seznamu aktivn칤ch zran캩n칤 pro UI
        function getActiveInjuries() {
            initInjuries();
            const now = Date.now();
            
            return state.injuries.active.map(activeInjury => {
                const injury = INJURIES.find(i => i.id === activeInjury.id);
                if (!injury) return null;
                
                const elapsed = now - activeInjury.startTime;
                const remaining = Math.max(0, activeInjury.duration - elapsed);
                const remainingHours = Math.floor(remaining / 3600000);
                const remainingMinsOnly = Math.ceil((remaining % 3600000) / 60000);
                
                return {
                    ...injury,
                    remaining,
                    remainingHours,
                    remainingMinsOnly,
                    remainingText: remainingHours > 0 ? `${remainingHours}h ${remainingMinsOnly}m` : `${remainingMinsOnly}m`,
                    startTime: activeInjury.startTime
                };
            }).filter(i => i !== null);
        }
        
        // Zobrazen칤 UI pro zran캩n칤
        function showInjuriesUI() {
            initInjuries();
            const injuries = getActiveInjuries();
            
            if (injuries.length === 0) {
                showModal('游뽗 Zran캩n칤', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游눩</div>
                        <h3 style="color: #4caf50;">콯치dn치 zran캩n칤!</h3>
                        <p style="color: #888; margin: 1rem 0;">Jsi v po콏치dku.</p>
                        <p style="color: #666; font-size: 0.85rem;">Celkem vyl칠캜eno: ${state.injuries.totalHealed || 0} zran캩n칤</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const injuriesHtml = injuries.map(inj => {
                // Najdi l칠ky v invent치콏i
                const curesInInventory = state.inv.filter(item => {
                    const itemData = ITEMS.find(i => i.id === item.id);
                    return itemData?.healsInjuries?.includes(inj.id);
                });
                
                const cureButtons = curesInInventory.length > 0 
                    ? curesInInventory.map(item => 
                        `<button class="btn" onclick="useInjuryItem('${item.id}', '${inj.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4caf50;">
                            ${ITEMS.find(i => i.id === item.id)?.icon || '游뽗'} ${ITEMS.find(i => i.id === item.id)?.name || item.id}
                        </button>`
                    ).join(' ')
                    : `<span style="color: #f44336; font-size: 0.8rem;">Nem치코 l칠k! Pot콏ebuje코: ${inj.cures.map(c => {
                        if (c === 'rest') return 'Odpo캜inek';
                        if (c === 'doctor') return 'Doktor';
                        return ITEMS.find(i => i.id === c)?.name || c;
                    }).join(', ')}</span>`;
                
                const severityColor = inj.severity === 1 ? '#ffeb3b' : inj.severity === 2 ? '#ff9800' : '#f44336';
                
                return `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${severityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;">${inj.icon} <strong>${inj.name}</strong></span>
                            <span style="color: #888;">낌勇 ${inj.remainingText}</span>
                        </div>
                        <p style="color: #aaa; margin: 0.5rem 0; font-size: 0.85rem;">${inj.desc}</p>
                        <div style="margin-top: 0.5rem;">
                            ${cureButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
            showModal('游뽗 Zran캩n칤', `
                <div style="margin-bottom: 1rem;">
                    <p style="color: #ff9800; margin: 0;">丘멆잺 M치코 ${injuries.length} aktivn칤 ${injuries.length === 1 ? 'zran캩n칤' : 'zran캩n칤'}!</p>
                </div>
                ${injuriesHtml}
                <div style="margin-top: 1rem; padding: 0.5rem; background: #0a1a0a; border-radius: 8px;">
                    <p style="color: #888; margin: 0; font-size: 0.8rem;">游눠 Tip: Zran캩n칤 m콢쬰코 l칠캜it obvazy, l칠k치rni캜kami, u doktora, nebo po캜kat a se zahoj칤.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">Zav콏칤t</button>
            `);
        }
        
        // Pou쬴t칤 l칠ku na zran캩n칤
        function useInjuryItem(itemId, injuryId) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) {
                notifyWarning('Chyba', 'Tento p콏edm캩t nem치코!');
                return;
            }
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === itemId);
            
            if (!itemData?.healsInjuries?.includes(injuryId)) {
                notifyWarning('Nefunguje', 'Tento l칠k na toto zran캩n칤 nezab칤r치!');
                return;
            }
            
            // Vyl칠캜 zran캩n칤
            healInjury(injuryId);
            
            // Aplikuj i norm치ln칤 efekt l칠ku (HP atd.)
            if (itemData.value && itemData.value > 0) {
                if (itemData.effect === 'health' || itemData.effect === 'heal_injury') {
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + itemData.value);
                    addLog(`+${itemData.value} HP`, '仇벒잺');
                }
            }
            
            // Odeber item
            if (item.count && item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            closeModal();
            showInjuriesUI();
            renderFull();
        }
        
        // Kombinovan칠 UI pro zdravotn칤 stav (nemoci + zran캩n칤)
        function showHealthStatusUI() {
            initDiseases();
            initInjuries();
            
            const diseases = getActiveDiseases();
            const injuries = getActiveInjuries();
            
            if (diseases.length === 0 && injuries.length === 0) {
                showModal('游낀 Zdravotn칤 stav', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游눜</div>
                        <h3 style="color: #4caf50;">Jsi zcela zdrav칳!</h3>
                        <p style="color: #888; margin: 1rem 0;">콯치dn칠 nemoci ani zran캩n칤.</p>
                        <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <div style="color: #666; font-size: 0.8rem;">Vyl칠캜eno nemoc칤</div>
                                <div style="color: #4caf50; font-size: 1.2rem; font-weight: bold;">${state.diseases.totalCured || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #666; font-size: 0.8rem;">O코et콏eno zran캩n칤</div>
                                <div style="color: #4caf50; font-size: 1.2rem; font-weight: bold;">${state.injuries.totalHealed || 0}</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            let content = '<div style="max-height: 60vh; overflow-y: auto;">';
            
            // Nemoci
            if (diseases.length > 0) {
                content += `<h4 style="color: #f44336; margin: 0 0 0.5rem 0;">游 Nemoci (${diseases.length})</h4>`;
                diseases.forEach(d => {
                    content += `
                        <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem; display: flex; justify-content: space-between; align-items: center;">
                            <span>${d.icon} ${d.name}</span>
                            <span style="color: #888; font-size: 0.8rem;">낌勇 ${d.remainingText}</span>
                        </div>
                    `;
                });
                content += `<button class="btn" onclick="closeModal(); showDiseasesUI();" style="width: 100%; margin: 0.5rem 0 1rem 0; padding: 0.4rem; font-size: 0.85rem; background: #c62828;">游눍 L칠캜it nemoci</button>`;
            }
            
            // Zran캩n칤
            if (injuries.length > 0) {
                content += `<h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">游뽗 Zran캩n칤 (${injuries.length})</h4>`;
                injuries.forEach(inj => {
                    content += `
                        <div style="background: #2a2a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem; display: flex; justify-content: space-between; align-items: center;">
                            <span>${inj.icon} ${inj.name}</span>
                            <span style="color: #888; font-size: 0.8rem;">낌勇 ${inj.remainingText}</span>
                        </div>
                    `;
                });
                content += `<button class="btn" onclick="closeModal(); showInjuriesUI();" style="width: 100%; margin: 0.5rem 0 1rem 0; padding: 0.4rem; font-size: 0.85rem; background: #ff9800;">游뽗 O코et콏it zran캩n칤</button>`;
            }
            
            content += '</div>';
            content += `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav콏칤t</button>`;
            
            showModal('游낀 Zdravotn칤 stav', content);
        }
        
        // Export funkc칤 pro glob치ln칤 pou쬴t칤
        window.showInjuriesUI = showInjuriesUI;
        window.useInjuryItem = useInjuryItem;
        window.healInjury = healInjury;
        window.healAllInjuries = healAllInjuries;
        window.showHealthStatusUI = showHealthStatusUI;
        window.hasAnyInjury = hasAnyInjury;
        window.getActiveInjuries = getActiveInjuries;
        window.getInjuryModifiers = getInjuryModifiers;
        
        // === OTEV칈RAC칈 DOBA ===
        const SHOP_HOURS = {
            settlement: { open: 6, close: 22, name: 'Obchod v osad캩' },
            caravan: { open: 8, close: 20, name: 'Karavana' },
            military: { open: 6, close: 18, name: 'Vojensk칳 t치bor' },
            scientists: { open: 0, close: 24, name: 'Laborato콏' }, // Non-stop
            mutants: { open: 20, close: 6, name: 'Mutant칤 trh' }, // No캜n칤!
            blacksmith: { open: 7, close: 19, name: 'Kov치콏' },
            wandering: { open: 10, close: 16, name: 'Potuln칳 obchodn칤k' } // Jen p치r hodin denn캩
        };
        
        function isShopOpen(shopType) {
            const hours = SHOP_HOURS[shopType];
            if (!hours) return true; // Nezn치m칳 typ = v쬯y otev콏eno
            
            const currentHour = new Date().getHours();
            
            // Speci치ln칤 p콏칤pad pro no캜n칤 obchody (open > close, nap콏. 20-6)
            if (hours.open > hours.close) {
                return currentHour >= hours.open || currentHour < hours.close;
            }
            
            // Non-stop (0-24)
            if (hours.open === 0 && hours.close === 24) return true;
            
            return currentHour >= hours.open && currentHour < hours.close;
        }
        
        function getShopClosedMessage(shopType) {
            const hours = SHOP_HOURS[shopType];
            if (!hours) return 'Zav콏eno';
            
            const currentHour = new Date().getHours();
            const openTime = hours.open.toString().padStart(2, '0') + ':00';
            const closeTime = hours.close === 24 ? '24:00' : hours.close.toString().padStart(2, '0') + ':00';
            
            // Kdy otev콏e?
            let opensIn;
            if (hours.open > hours.close) {
                // No캜n칤 obchod
                if (currentHour < hours.close) {
                    opensIn = hours.open - currentHour + 24;
                } else {
                    opensIn = hours.open - currentHour;
                }
            } else {
                if (currentHour < hours.open) {
                    opensIn = hours.open - currentHour;
                } else {
                    opensIn = 24 - currentHour + hours.open;
                }
            }
            
            return `游깿 ${hours.name} je zav콏eno!\n\n낋 Otev칤rac칤 doba: ${openTime} - ${closeTime}\n낍 Otev콏e za: ${opensIn} hodin`;
        }
        
        // === FRAKCE FUNKCE ===
        function getReputation(factionId) {
            return state.factions[factionId] || 0;
        }
        
        function getReputationLevel(factionId) {
            const rep = getReputation(factionId);
            return REPUTATION_LEVELS.find(l => rep >= l.min && rep <= l.max) || REPUTATION_LEVELS[2]; // default neutral
        }
        
        function getReputationLevelName(levelId) {
            const levelNames = {
                enemy: 'Nep콏칤tel', hostile: 'Nep콏치telsk칳', neutral: 'Neutr치ln칤', friendly: 'P콏치telsk칳', allied: 'Spojenec'
            };
            return levelNames[levelId] || levelId;
        }
        
        function changeReputation(factionId, amount, reason) {
            if (!state.factions) state.factions = {};
            const oldRep = state.factions[factionId] || 0;
            const oldLevel = getReputationLevel(factionId);
            
            state.factions[factionId] = Math.max(-100, Math.min(100, oldRep + amount));
            
            const newLevel = getReputationLevel(factionId);
            const faction = FACTIONS.find(f => f.id === factionId);
            
            // Notifikace
            const sign = amount > 0 ? '+' : '';
            const color = amount > 0 ? '#8bc34a' : '#f44336';
            addLog(`${faction?.icon || '游논'} ${faction?.name || factionId}: ${sign}${amount} reputace${reason ? ' (' + reason + ')' : ''}`, faction?.icon || '游논');
            
            // Zm캩na 칰rovn캩
            if (oldLevel.id !== newLevel.id) {
                const isImproved = REPUTATION_LEVELS.indexOf(newLevel) > REPUTATION_LEVELS.indexOf(oldLevel);
                const factionName = getFactionName(factionId);
                const oldLevelName = getReputationLevelName(oldLevel.id);
                const newLevelName = getReputationLevelName(newLevel.id);
                showModal(
                    isImproved ? ('游꿀 Reputace vzrostla!') : ('丘멆잺 Reputace klesla!'),
                    `<div style="text-align: center;">
                        <div style="font-size: 3rem;">${faction?.icon || '游논'}</div>
                        <h3 style="color: ${faction?.color || '#888'};">${factionName}</h3>
                        <p style="margin: 1rem 0;">
                            <span style="color: ${oldLevel.color};">${oldLevel.icon} ${oldLevelName}</span>
                            <span style="margin: 0 0.5rem;"></span>
                            <span style="color: ${newLevel.color};">${newLevel.icon} ${newLevelName}</span>
                        </p>
                        <p style="color: #888; font-size: 0.9rem;">
                            ${isImproved ? getFactionBonusText(factionId) : getFactionPenaltyText(factionId)}
                        </p>
                    </div>`
                );
            }
            
            // Rivalov칠 - n캩kter칠 frakce jsou protich콢dn칠
            if (amount > 0) {
                // Pomoc obchodn칤k콢m zhor코칤 vztahy s n치jezdn칤ky
                if (factionId === 'traders' && amount > 5) {
                    state.factions.raiders = Math.max(-100, (state.factions.raiders || 0) - Math.floor(amount / 2));
                }
                // Pomoc n치jezdn칤k콢m zhor코칤 vztahy s obchodn칤ky a vojensk칳m
                if (factionId === 'raiders' && amount > 5) {
                    state.factions.traders = Math.max(-100, (state.factions.traders || 0) - Math.floor(amount / 2));
                    state.factions.military = Math.max(-100, (state.factions.military || 0) - Math.floor(amount / 3));
                }
                // Pomoc v캩dc콢m zlep코칤 vztahy s vojensk칳m
                if (factionId === 'scientists' && amount > 5) {
                    state.factions.military = Math.min(100, (state.factions.military || 0) + Math.floor(amount / 3));
                }
            }
        }
        
        function getFactionBonusText(factionId) {
            const faction = FACTIONS.find(f => f.id === factionId);
            const rep = getReputation(factionId);
            
            if (rep >= 100 && faction?.bonuses?.allied) {
                return '游 ' + faction.bonuses.allied.desc;
            }
            if (rep >= 50 && faction?.bonuses?.friendly) {
                return '九 ' + faction.bonuses.friendly.desc;
            }
            return '';
        }
        
        function getFactionPenaltyText(factionId) {
            const level = getReputationLevel(factionId);
            
            const penaltyTexts = {
                traders: { hostile: '+50% ceny', enemy: 'Neobchoduj칤, 칰to캜칤' },
                scientists: { hostile: 'Nepom치haj칤', enemy: 'Sabotuj칤 tv칠 vybaven칤' },
                raiders: { hostile: '30% 코ance na p콏epaden칤', enemy: '60% p콏epaden칤, raidy na osadu' },
                mutants: { hostile: '칔to캜칤 v rad. z칩n치ch', enemy: 'Lov칤 t캩' },
                military: { hostile: 'Neobchoduj칤 zbran캩', enemy: 'St콏elba na potk치n칤' }
            };
            
            if (level.id === 'hostile' && penaltyTexts[factionId]?.hostile) {
                return '丘멆잺 ' + penaltyTexts[factionId].hostile;
            }
            if (level.id === 'enemy' && penaltyTexts[factionId]?.enemy) {
                return '游 ' + penaltyTexts[factionId].enemy;
            }
            return '';
        }
        
        // === AKTIVN칈 FRAK캛N칈 BONUSY ===
        function getFactionBonuses() {
            const bonuses = {
                // Traders
                priceDiscount: 0,
                specialItems: false,
                freeHealing: false,
                // Scientists  
                craftBonus: 0,
                techAccess: false,
                labAccess: false,
                // Raiders
                safePassage: false,
                blackMarket: false,
                // Mutants
                radResist: 0,
                mutantAllies: false,
                // Military
                weaponAccess: false,
                training: false,
                eliteWeapons: false,
                tacticalBonus: 0
            };
            
            // Traders
            const tradersRep = getReputation('traders');
            const tradersFaction = FACTIONS.find(f => f.id === 'traders');
            if (tradersRep >= 100 && tradersFaction?.bonuses?.allied) {
                bonuses.priceDiscount = tradersFaction.bonuses.allied.priceDiscount || 0;
                bonuses.freeHealing = true;
                bonuses.specialItems = true;
            } else if (tradersRep >= 50 && tradersFaction?.bonuses?.friendly) {
                bonuses.priceDiscount = tradersFaction.bonuses.friendly.priceDiscount || 0;
                bonuses.specialItems = true;
            }
            
            // Scientists
            const scientistsRep = getReputation('scientists');
            const scientistsFaction = FACTIONS.find(f => f.id === 'scientists');
            if (scientistsRep >= 100 && scientistsFaction?.bonuses?.allied) {
                bonuses.craftBonus = 0.05;
                bonuses.techAccess = true;
                bonuses.labAccess = true;
            } else if (scientistsRep >= 50 && scientistsFaction?.bonuses?.friendly) {
                bonuses.craftBonus = scientistsFaction.bonuses.friendly.craftBonus || 0;
                bonuses.techAccess = true;
            }
            
            // Mutants
            const mutantsRep = getReputation('mutants');
            const mutantsFaction = FACTIONS.find(f => f.id === 'mutants');
            if (mutantsRep >= 100 && mutantsFaction?.bonuses?.allied) {
                bonuses.radResist = mutantsFaction.bonuses.allied.radResist || 0;
                bonuses.mutantAllies = true;
            } else if (mutantsRep >= 50 && mutantsFaction?.bonuses?.friendly) {
                bonuses.radResist = mutantsFaction.bonuses.friendly.radResist || 0;
            }
            
            // Military
            const militaryRep = getReputation('military');
            const militaryFaction = FACTIONS.find(f => f.id === 'military');
            if (militaryRep >= 100 && militaryFaction?.bonuses?.allied) {
                bonuses.weaponAccess = true;
                bonuses.training = true;
                bonuses.eliteWeapons = true;
                bonuses.tacticalBonus = militaryFaction.bonuses.allied.tacticalBonus || 0;
            } else if (militaryRep >= 50 && militaryFaction?.bonuses?.friendly) {
                bonuses.weaponAccess = true;
                bonuses.training = true;
            }
            
            return bonuses;
        }
        
        function getPriceModifier() {
            const traderLevel = getReputationLevel('traders');
            const faction = FACTIONS.find(f => f.id === 'traders');
            
            let modifier = 1;
            if (traderLevel.id === 'allied') modifier = 1 - (faction.bonuses.allied.priceDiscount || 0);
            else if (traderLevel.id === 'friendly') modifier = 1 - (faction.bonuses.friendly.priceDiscount || 0);
            else if (traderLevel.id === 'hostile') modifier = 1 + (faction.penalties.hostile.priceIncrease || 0);
            else if (traderLevel.id === 'enemy') modifier = 2; // 2x ceny
            
            // Companion skills price bonus (lep코칤 ceny)
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.priceBonus > 0) {
                modifier -= compBonuses.priceBonus; // Sn칤쬰n칤 cen
            }
            
            return Math.max(0.5, modifier); // Minimum 50% ceny
        }
        
        // === JEDNOTN츼 FUNKCE PRO V칗PO캛ET CENY ===
        // Pou쮂셨치 se v obchod캩, n치kupn칤m dialogu i p콏i n치kupu
        function calculateItemPrice(basePrice) {
            let price = basePrice;
            
            // 1. Sb칤rej v코echny slevy NEJD콎칈VE (p콏ed markup!)
            let totalDiscount = 0;
            
            // Pohlav칤 - 쬰ny maj칤 5% slevu
            if (state.char?.gender === 'female') {
                totalDiscount += 0.05;
            }
            
            // Trader class passive - sleva z dovednosti (-30%)
            const traderDiscount = getClassPassiveValue('shopDiscount');
            if (traderDiscount) {
                totalDiscount += traderDiscount;
            }
            
            // Reputace s obchodn칤ky (max 10%)
            const repMod = getPriceModifier();
            if (repMod < 1) {
                totalDiscount += (1 - repMod);
            }
            
            // Osadn칤k obchodn칤k - 10% sleva
            const hasTraderSettler = state.settlement?.settlers?.some(s => s.type === 'trader_s');
            if (hasTraderSettler) {
                totalDiscount += 0.10;
            }
            
            // N치v코t캩vuj칤c칤 obchodn칤k - 10% sleva
            if (state.settlement?.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until) {
                totalDiscount += 0.10;
            }
            
            // NPC bonus (Star칳 obchodn칤k apod.)
            const npcBonuses = getNPCBonuses();
            if (npcBonuses.shopDiscount > 0) {
                totalDiscount += npcBonuses.shopDiscount;
            }
            
            // 游빐 Exotic bonus - Obchodnick칳 kompas
            if (state.exoticBonuses?.shopDiscount > 0) {
                totalDiscount += state.exoticBonuses.shopDiscount;
            }
            
            // Trader set (2) - haggle (-15% n치kupn칤 ceny)
            const setEffectsBuy = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            if (setEffectsBuy.haggle) {
                totalDiscount += 0.15;
            }
            
            // MAX 50% sleva celkem! (zv칳코eno z 40%)
            totalDiscount = Math.min(0.50, totalDiscount);
            
            // 2. Aplikuj slevu na Z츼KLADN칈 cenu
            price = Math.floor(price * (1 - totalDiscount));
            
            // 3. MARKUP - obchodn칤ci maj칤 mar쬴 (+30%, sn칤쬰no z +50%)
            // Ale jen pokud hr치캜 NEM츼 trader class (trader nakupuje za velkoobchodn칤 ceny)
            if (state.char?.classId !== 'trader') {
                price = Math.floor(price * 1.3);
            }
            
            // 4. Inflace (+1% za den, max +20%, sn칤쬰no z +30%)
            const inflationRate = Math.min(0.2, (state.time?.days || 0) * 0.01);
            price = Math.floor(price * (1 + inflationRate));
            
            return Math.max(1, price); // Minimum 1 coin
        }
        
        function canTradeWith(factionId) {
            const level = getReputationLevel(factionId);
            const faction = FACTIONS.find(f => f.id === factionId);
            if (level.id === 'enemy' && faction?.penalties?.enemy?.noTrade) return false;
            return true;
        }
        
        function showFactionsModal() {
            const facTexts = {
                noBonusPenalty: '콯치dn칠 bonusy ani postihy',
                howToGetRep: 'Jak z칤skat reputaci',
                traders: 'Obchodn칤ci', tradersDesc: 'Obchoduj, pl켿 jejich questy',
                scientists: 'V캩dci', scientistsDesc: 'P콏ines artefakty, pom치hej s v칳zkumem',
                raiders: 'N치jezdn칤ci', raidersDesc: 'P콏epad치vej karavany (zhor코칤 ostatn칤)',
                mutants: 'Mutanti', mutantsDesc: 'Pom치hej v zamo콏en칳ch z칩n치ch',
                military: 'Vojensk칳', militaryDesc: 'Eliminuj hrozby, pl켿 rozkazy'
            };
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            FACTIONS.forEach(faction => {
                const rep = getReputation(faction.id);
                const level = getReputationLevel(faction.id);
                const percentage = ((rep + 100) / 200) * 100;
                const factionName = getFactionName(faction.id);
                const factionDesc = getFactionDesc(faction.id);
                const levelName = getReputationLevelName(level.id);
                
                html += `
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 1rem; border-radius: 10px; margin-bottom: 0.8rem; border: 2px solid ${faction.color}40;">
                        <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 2rem;">${faction.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${faction.color};">${factionName}</div>
                                <div style="font-size: 0.75rem; color: #888;">${factionDesc}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${level.color}; font-weight: bold;">${level.icon} ${levelName}</div>
                                <div style="font-size: 0.8rem; color: #666;">${rep > 0 ? '+' : ''}${rep}</div>
                            </div>
                        </div>
                        
                        <!-- Progress bar -->
                        <div style="height: 8px; background: #0a0a0a; border-radius: 4px; overflow: hidden; position: relative; border: 1px solid #333;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${percentage}%; background: linear-gradient(90deg, #8B0000, #f44336, #ff9800, #4caf50, #ffd700); border-radius: 3px;"></div>
                            <div style="position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: #666;"></div>
                        </div>
                        
                        <!-- Bonusy/Penalty -->
                        <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                            ${level.id === 'allied' || level.id === 'friendly' ? 
                                `<span style="color: #8bc34a;">${getFactionBonusText(faction.id)}</span>` : 
                                (level.id === 'hostile' || level.id === 'enemy' ? 
                                    `<span style="color: #f44336;">${getFactionPenaltyText(faction.id)}</span>` : 
                                    `<span style="color: #666;">${facTexts.noBonusPenalty}</span>`
                                )
                            }
                        </div>
                    </div>
                `;
            });
            
            // Tipy
            html += `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-top: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">游눠 ${facTexts.howToGetRep}</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">
                        <li>游낅 <strong>${facTexts.traders}:</strong> ${facTexts.tradersDesc}</li>
                        <li>游댧 <strong>${facTexts.scientists}:</strong> ${facTexts.scientistsDesc}</li>
                        <li>游 <strong>${facTexts.raiders}:</strong> ${facTexts.raidersDesc}</li>
                        <li>驕勇 <strong>${facTexts.mutants}:</strong> ${facTexts.mutantsDesc}</li>
                        <li>游꿌勇 <strong>${facTexts.military}:</strong> ${facTexts.militaryDesc}</li>
                    </ul>
                </div>
            `;
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + ('Zav콏칤t') + '</button>';
            
            showModal('游논 Frakce a reputace', html);
        }
        
        // === FRAK캛N칈 INTERAKCE ===
        function showFactionInteraction(factionId) {
            const faction = FACTIONS.find(f => f.id === factionId);
            if (!faction) return;
            
            const rep = getReputation(factionId);
            const level = getReputationLevel(factionId);
            
            // Bonusy podle levelu
            let bonusesHtml = '<div style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">';
            bonusesHtml += '<h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">游꾸 Bonusy vztahu:</h4>';
            
            const bonusLevels = [
                { id: 'friendly', name: 'P콏치telsk칳 (50+)', bonus: faction.bonuses?.friendly?.desc || 'Speci치ln칤 v칳hody', minRep: 50 },
                { id: 'allied', name: 'Spojenec (100+)', bonus: faction.bonuses?.allied?.desc || 'Maxim치ln칤 v칳hody', minRep: 100 }
            ];
            
            bonusLevels.forEach(bl => {
                const achieved = rep >= bl.minRep;
                bonusesHtml += `<div style="padding: 0.4rem; margin-bottom: 0.3rem; background: ${achieved ? '#1a2a1a' : '#1a1a1a'}; border-radius: 4px; border-left: 3px solid ${achieved ? '#4caf50' : '#333'};">
                    <span style="color: ${achieved ? '#8bc34a' : '#666'};">${achieved ? '九' : '餃'} ${bl.name}</span>
                    <div style="font-size: 0.75rem; color: #888; margin-left: 1.2rem;">${bl.bonus}</div>
                </div>`;
            });
            bonusesHtml += '</div>';
            
            // Progress bar
            const nextLevel = rep < 50 ? 50 : (rep < 100 ? 100 : 100);
            const progress = Math.min(100, Math.max(0, ((rep + 100) / 200) * 100)); // -100 to 100 range
            
            // Specifick칠 tipy pro ka쬯ou frakci
            const factionTips = {
                traders: 'Nakupuj v obchodech, pl켿 obchodn칤 questy, investuj pen칤ze',
                military: 'Zab칤jej mutanty a n치jezdn칤ky, tr칠nuj v t치bo콏e, pl켿 mise',
                survivors: 'Zachra켿uj p콏e쬴v코칤, pom치hej osad치m, d치vej j칤dlo a vodu',
                scientists: 'P콏ines vzorky a dokumenty, pomoz s v칳zkumem, najdi data',
                mutants: 'P콏ines mutantn칤 krev nebo org치ny, ne칰to캜칤 na mutanty, obchoduj',
                raiders: 'Pozor: N치jezdn칤ci jsou nep콏치tel칠! Reputace kles치 p콏i boji.'
            };
            
            const tip = factionTips[factionId] || 'Pl켿 questy a obchoduj';
            
            // Dary pro zlep코en칤 reputace
            const giftOptions = {
                traders: { item: 'money', amount: 100, repGain: 5, text: '游눯 Investovat 100 pen캩z (+5 rep)' },
                military: { item: 'ammo', ammoType: '9mm', amount: 20, repGain: 3, text: '游댦 Darovat 20 munice 9mm (+3 rep)' },
                survivors: { item: 'food', amount: 5, repGain: 4, text: '游꼤 Darovat 5 j칤dla (+4 rep)' },
                scientists: { item: 'chemicals', amount: 10, repGain: 5, text: '游빍 Darovat 10 chemik치li칤 (+5 rep)' },
                mutants: { item: 'mutant_blood', amount: 3, repGain: 8, text: '游뽖 Darovat 3 mutantn칤 krev (+8 rep)' }
            };
            
            const gift = giftOptions[factionId];
            let giftHtml = '';
            if (gift && factionId !== 'raiders') {
                let hasResource = false;
                if (gift.item === 'money') {
                    hasResource = getMoney() >= gift.amount;
                } else if (gift.item === 'ammo') {
                    const ammoType = gift.ammoType || '9mm';
                    const ammoInState = state.ammo?.[ammoType] || 0;
                    const ammoInInv = state.inv.filter(i => i.ammoType === ammoType || i.id === 'ammo_' + ammoType).reduce((sum, i) => sum + (i.count || 1), 0);
                    hasResource = (ammoInState + ammoInInv) >= gift.amount;
                } else if (gift.item === 'food') {
                    const foodItems = state.inv.filter(i => i.type === 'food' || i.id === 'canned_food' || i.id === 'dried_meat' || i.id === 'bread');
                    const totalFood = foodItems.reduce((sum, i) => sum + (i.count || 1), 0);
                    hasResource = totalFood >= gift.amount;
                } else {
                    // Ostatn칤 itemy z invent치콏e
                    const resourceItem = state.inv.find(i => i.id === gift.item);
                    hasResource = resourceItem && (resourceItem.count || 1) >= gift.amount;
                }
                
                giftHtml = `
                    <button class="btn" onclick="giveFactionGift('${factionId}')" style="width: 100%; margin-top: 0.5rem; background: ${hasResource ? '#4caf50' : '#555'};" ${hasResource ? '' : 'disabled'}>
                        ${gift.text}
                    </button>
                `;
            }
            
            showModal(faction.icon + ' ' + faction.name, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${faction.icon}</div>
                    <p style="color: #888; font-size: 0.9rem;">${faction.desc}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: ${level.color}; font-weight: bold;">${level.icon} ${level.name}</span>
                        <span style="color: #ffd700;">${rep} / 100</span>
                    </div>
                    <div style="background: #0a0a0a; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #f44336, #ff9800, #4caf50);"></div>
                    </div>
                </div>
                
                ${bonusesHtml}
                
                <div style="background: #1a1a2a; padding: 0.6rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <p style="color: #64b5f6; font-size: 0.85rem; margin: 0;">
                        游눠 <strong>Jak zv칳코it reputaci:</strong> ${tip}
                    </p>
                </div>
                
                ${giftHtml}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${t('ui', 'close')}</button>
            `);
        }
        
        // Darov치n칤 pro zlep코en칤 reputace
        function giveFactionGift(factionId) {
            const giftOptions = {
                traders: { item: 'money', amount: 100, repGain: 5 },
                military: { item: 'ammo', ammoType: '9mm', amount: 20, repGain: 3 },
                survivors: { item: 'food', amount: 5, repGain: 4 },
                scientists: { item: 'chemicals', amount: 10, repGain: 5 },
                mutants: { item: 'mutant_blood', amount: 3, repGain: 8 }
            };
            
            const gift = giftOptions[factionId];
            if (!gift) return;
            
            // Kontrola zdroj콢
            if (gift.item === 'money') {
                if (getMoney() < gift.amount) {
                    notifyWarning('Nedostatek pen캩z!', `Pot콏ebuje코 ${gift.amount} 游눯`);
                    return;
                }
                addMoney(-gift.amount);
            } else if (gift.item === 'ammo') {
                // Speci치ln칤 handling pro munici - kontroluj state.ammo A invent치콏
                const ammoType = gift.ammoType || '9mm';
                const ammoInState = state.ammo?.[ammoType] || 0;
                // Tak칠 kontroluj invent치콏 - vyroben칠 n치boje
                const ammoInInv = state.inv.filter(i => i.ammoType === ammoType || (i.id === 'ammo_' + ammoType)).reduce((sum, i) => sum + (i.count || 1), 0);
                const totalAmmo = ammoInState + ammoInInv;
                
                if (totalAmmo < gift.amount) {
                    notifyWarning('Nedostatek munice!', `Pot콏ebuje코 ${gift.amount}x ${ammoType} n치boj콢 (m치코 ${totalAmmo})`);
                    return;
                }
                
                // Odeber nejd콏칤v z state.ammo, pak z invent치콏e
                let toRemove = gift.amount;
                if (state.ammo?.[ammoType] > 0) {
                    const fromState = Math.min(toRemove, state.ammo[ammoType]);
                    state.ammo[ammoType] -= fromState;
                    toRemove -= fromState;
                }
                // Zbytek z invent치콏e
                if (toRemove > 0) {
                    const ammoItems = state.inv.filter(i => i.ammoType === ammoType || i.id === 'ammo_' + ammoType);
                    for (const item of ammoItems) {
                        if (toRemove <= 0) break;
                        const count = item.count || 1;
                        if (count <= toRemove) {
                            toRemove -= count;
                            state.inv = state.inv.filter(i => i !== item);
                        } else {
                            item.count -= toRemove;
                            toRemove = 0;
                        }
                    }
                }
            } else if (gift.item === 'food') {
                // J칤dlo m콢쬰 b칳t v invent치콏i jako canned_food, dried_meat, atd.
                const foodItems = state.inv.filter(i => i.type === 'food' || i.id === 'canned_food' || i.id === 'dried_meat' || i.id === 'bread');
                const totalFood = foodItems.reduce((sum, i) => sum + (i.count || 1), 0);
                if (totalFood < gift.amount) {
                    notifyWarning('Nedostatek j칤dla!', `Pot콏ebuje코 ${gift.amount}x j칤dlo`);
                    return;
                }
                // Odeber j칤dlo z invent치콏e
                let toRemove = gift.amount;
                for (const item of foodItems) {
                    if (toRemove <= 0) break;
                    const count = item.count || 1;
                    if (count <= toRemove) {
                        toRemove -= count;
                        state.inv = state.inv.filter(i => i !== item);
                    } else {
                        item.count -= toRemove;
                        toRemove = 0;
                    }
                }
            } else {
                // Ostatn칤 zdroje (chemicals, mutant_blood, atd.) - hledej v invent치콏i
                const resourceItem = state.inv.find(i => i.id === gift.item);
                const currentAmount = resourceItem ? (resourceItem.count || 1) : 0;
                if (currentAmount < gift.amount) {
                    notifyWarning('Nedostatek zdroj콢!', `Pot콏ebuje코 ${gift.amount}x ${gift.item}`);
                    return;
                }
                if (resourceItem.count && resourceItem.count > gift.amount) {
                    resourceItem.count -= gift.amount;
                } else {
                    state.inv = state.inv.filter(i => i !== resourceItem);
                }
            }
            
            // P콏idej reputaci
            changeReputation(factionId, gift.repGain, 'dar frakci');
            
            const faction = FACTIONS.find(f => f.id === factionId);
            notifySuccess('Dar p콏ijat!', `+${gift.repGain} reputace s ${faction?.name || factionId}`);
            
            // Refresh modal
            closeModal();
            setTimeout(() => showFactionDetail(factionId), 100);
        }
        
        function openFactionShop(factionId) {
            const faction = FACTIONS.find(f => f.id === factionId);
            if (!faction) return;
            
            const level = getReputationLevel(factionId);
            
            // Sleva/p콏ir치쬶a podle reputace
            let priceMultiplier = 1;
            let discountText = '';
            if (level.id === 'allied') {
                priceMultiplier = 0.6;
                discountText = '<span style="color: #8bc34a;">-40% sleva (Spojenec)</span>';
            } else if (level.id === 'friendly') {
                priceMultiplier = 0.8;
                discountText = '<span style="color: #8bc34a;">-20% sleva (P콏치telsk칳)</span>';
            } else if (level.id === 'hostile') {
                priceMultiplier = 1.5;
                discountText = '<span style="color: #f44336;">+50% p콏ir치쬶a (Nep콏치telsk칳)</span>';
            }
            
            // Speci치ln칤 zbo쮂 podle frakce
            let specialItems = [];
            if (factionId === 'traders') {
                specialItems = ITEMS.filter(i => 
                    i.rarity === 'rare' || 
                    i.rarity === 'uncommon' ||
                    i.type === 'food' ||
                    i.type === 'medicine' ||
                    i.type === 'weapon'
                ).slice(0, 15);
            } else if (factionId === 'scientists') {
                specialItems = ITEMS.filter(i => 
                    i.id.includes('stim') || 
                    i.id.includes('rad') || 
                    i.id.includes('chem') ||
                    i.type === 'medicine'
                ).slice(0, 10);
            } else if (factionId === 'military') {
                specialItems = ITEMS.filter(i => 
                    i.type === 'weapon' || 
                    i.type === 'armor' ||
                    i.type === 'ammo'
                ).slice(0, 10);
            } else if (factionId === 'mutants') {
                specialItems = ITEMS.filter(i => 
                    i.id.includes('mutant') || 
                    i.id.includes('rad') ||
                    i.type === 'food'
                ).slice(0, 8);
            } else {
                specialItems = ITEMS.slice(0, 10);
            }
            
            // Filtruj prodejn칠 polo쬶y z invent치콏e (ne nasazen칠)
            const sellableItems = state.inv.filter(item => 
                !item.equipped && 
                !isItemEquipped(item) &&
                item.id !== 'water_bottle' &&
                item.id !== 'flashlight'
            );
            
            // Stav shopu - co zobrazujeme
            state.factionShopTab = state.factionShopTab || 'buy';
            state.factionShopPage = state.factionShopPage || 0;
            
            const ITEMS_PER_PAGE = 6;
            const tab = state.factionShopTab;
            
            let contentHtml = '';
            
            if (tab === 'buy') {
                // NAKUPOV츼N칈
                const startIdx = state.factionShopPage * ITEMS_PER_PAGE;
                const pageItems = specialItems.slice(startIdx, startIdx + ITEMS_PER_PAGE);
                const totalPages = Math.ceil(specialItems.length / ITEMS_PER_PAGE);
                
                contentHtml = '<div style="min-height: 280px;">';
                pageItems.forEach(item => {
                    // Pou쬴j item.price, ne item.value (value je efekt, ne cena!)
                    const basePrice = item.price || item.value || 50;
                    // Ujisti se 쬰 cena je kladn치
                    const price = Math.floor(Math.abs(basePrice) * priceMultiplier);
                    const canAfford = getMoney() >= price;
                    
                    contentHtml += `
                        <div style="display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem; border: 1px solid #333;">
                            <span style="font-size: 1.3rem; width: 30px; text-align: center;">${item.icon}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
                                <div style="font-size: 0.7rem; color: #888;">${item.type || ''}</div>
                            </div>
                            <button class="btn" onclick="buyFromFactionShop('${factionId}', '${item.id}', ${price})" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; white-space: nowrap; ${canAfford ? '' : 'opacity: 0.5;'}"
                                    ${canAfford ? '' : 'disabled'}>
                                Koupit ${price}游눯
                            </button>
                        </div>
                    `;
                });
                contentHtml += '</div>';
                
                // Navigace str치nek
                if (totalPages > 1) {
                    contentHtml += `
                        <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn" onclick="state.factionShopPage = Math.max(0, state.factionShopPage - 1); openFactionShop('${factionId}')" 
                                    style="padding: 0.2rem 0.5rem;" ${state.factionShopPage === 0 ? 'disabled style="opacity:0.5"' : ''}>餃</button>
                            <span style="color: #888;">${state.factionShopPage + 1} / ${totalPages}</span>
                            <button class="btn" onclick="state.factionShopPage = Math.min(${totalPages - 1}, state.factionShopPage + 1); openFactionShop('${factionId}')" 
                                    style="padding: 0.2rem 0.5rem;" ${state.factionShopPage >= totalPages - 1 ? 'disabled style="opacity:0.5"' : ''}>郊</button>
                        </div>
                    `;
                }
            } else {
                // PROD츼V츼N칈
                if (sellableItems.length === 0) {
                    contentHtml = '<p style="text-align: center; color: #888; padding: 2rem;">Nem치코 nic na prodej.</p>';
                } else {
                    const startIdx = state.factionShopPage * ITEMS_PER_PAGE;
                    const pageItems = sellableItems.slice(startIdx, startIdx + ITEMS_PER_PAGE);
                    const totalPages = Math.ceil(sellableItems.length / ITEMS_PER_PAGE);
                    
                    contentHtml = '<div style="min-height: 280px;">';
                    pageItems.forEach((item, idx) => {
                        // Najdi skute캜n칳 index v state.inv (ne v sellableItems!)
                        const realInvIndex = state.inv.indexOf(item);
                        if (realInvIndex === -1) return; // Bezpe캜nostn칤 kontrola
                        
                        // Pou쬴j item.price, ne item.value
                        const basePrice = item.price || Math.abs(item.value) || 20;
                        const sellPrice = Math.max(1, Math.floor(basePrice * 0.35)); // 35% hodnoty, min 1
                        const count = item.count || 1;
                        
                        contentHtml += `
                            <div style="display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem; border: 1px solid #333;">
                                <span style="font-size: 1.3rem; width: 30px; text-align: center;">${item.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: bold; font-size: 0.9rem;">${item.name} ${count > 1 ? `(${count}x)` : ''}</div>
                                    <div style="font-size: 0.7rem; color: #888;">${item.type || ''}</div>
                                </div>
                                <div style="display: flex; gap: 0.3rem;">
                                    <button class="btn" onclick="sellToFactionShop('${factionId}', ${realInvIndex}, 1, ${sellPrice})" 
                                            style="padding: 0.25rem 0.4rem; font-size: 0.75rem;">
                                        1x ${sellPrice}游눯
                                    </button>
                                    ${count > 1 ? `
                                        <button class="btn" onclick="sellToFactionShop('${factionId}', ${realInvIndex}, ${count}, ${sellPrice * count})" 
                                                style="padding: 0.25rem 0.4rem; font-size: 0.75rem; background: #4a4a2a;">
                                            V코e ${sellPrice * count}游눯
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    contentHtml += '</div>';
                    
                    // Navigace str치nek
                    if (totalPages > 1) {
                        contentHtml += `
                            <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <button class="btn" onclick="state.factionShopPage = Math.max(0, state.factionShopPage - 1); openFactionShop('${factionId}')" 
                                        style="padding: 0.2rem 0.5rem;" ${state.factionShopPage === 0 ? 'disabled style="opacity:0.5"' : ''}>餃</button>
                                <span style="color: #888;">${state.factionShopPage + 1} / ${totalPages}</span>
                                <button class="btn" onclick="state.factionShopPage = Math.min(${totalPages - 1}, state.factionShopPage + 1); openFactionShop('${factionId}')" 
                                        style="padding: 0.2rem 0.5rem;" ${state.factionShopPage >= totalPages - 1 ? 'disabled style="opacity:0.5"' : ''}>郊</button>
                            </div>
                        `;
                    }
                }
            }
            
            showModal(faction.icon + ' ' + ('Obchod - ') + faction.name, `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span>游눯 <strong style="color: #ffd700;">${state.money}</strong></span>
                    ${discountText}
                </div>
                
                <div style="display: flex; gap: 0.3rem; margin-bottom: 0.8rem;">
                    <button class="btn" onclick="state.factionShopTab = 'buy'; state.factionShopPage = 0; openFactionShop('${factionId}')" 
                            style="flex: 1; ${tab === 'buy' ? 'background: var(--rust);' : 'background: #333;'}">
                        游 ${'Nakoupit'}
                    </button>
                    <button class="btn" onclick="state.factionShopTab = 'sell'; state.factionShopPage = 0; openFactionShop('${factionId}')" 
                            style="flex: 1; ${tab === 'sell' ? 'background: var(--rust);' : 'background: #333;'}">
                        游눳 ${'Prodat'}
                    </button>
                </div>
                
                ${contentHtml}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.8rem; background: #555;">${'Zav콏칤t'}</button>
            `);
        }
        
        function buyFromFactionShop(factionId, itemId, price) {
            const item = ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // Kontrola unique item콢
            if (item.unique) {
                const alreadyHas = state.inv.some(i => i.id === itemId);
                if (alreadyHas) {
                    notifyWarning('U m치코 ' + item.name, 'M콢쬰코 m칤t pouze jeden');
                    return;
                }
            }
            
            if (state.money < price) {
                showModal('仇 Nedostatek pen캩z', ('Nem치코 dost pen캩z na tento n치kup!'));
                return;
            }
            
            // Kontrola v치hy
            const itemWeight = item.weight || 1;
            const currentWeight = calculateCurrentWeight();
            const maxWeight = calculateMaxWeight();
            
            if (currentWeight + itemWeight > maxWeight) {
                showModal('仇 Pln칳 invent치콏', ('Nem치코 m칤sto v invent치콏i!'));
                return;
            }
            
            state.money -= price;
            // P콏idej item s fromShop flagem
            const boughtItem = {
                ...item,
                fromShop: true,
                boughtPrice: price
            };
            addItemToInventory(boughtItem);
            addLog(`Koupil jsi ${item.name} za ${price} 游눯`, '游');
            notifySuccess('N치kup', `${item.icon} ${item.name}`);
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            renderFull();
            openFactionShop(factionId); // Refresh shopu
        }
        
        function sellToFactionShop(factionId, invIndex, amount, totalPrice) {
            const item = state.inv[invIndex];
            if (!item) return;
            
            const count = item.count || 1;
            const toSell = Math.min(amount, count);
            
            addMoney(totalPrice); // Pou쬴j addMoney m칤sto p콏칤m칠ho p콏i콏azen칤
            
            if (toSell >= count) {
                state.inv.splice(invIndex, 1);
            } else {
                item.count = count - toSell;
            }
            
            addLog(`Prodal jsi ${item.name}${toSell > 1 ? ` (${toSell}x)` : ''} za ${totalPrice} 游눯`, '游눳');
            notifySuccess('Prod치no', `+${totalPrice} 游눯`);
            
            // Daily quest progress - sold
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + toSell;
                checkDailyQuests();
            }
            
            renderFull();
            openFactionShop(factionId); // Refresh shopu
        }
        
        function investInFaction(factionId) {
            const amounts = [100, 500, 1000];
            const level = getReputationLevel('traders');
            const currentRep = state.factions?.traders || 0;
            
            // Bonus info podle levelu
            let bonusInfo = '';
            if (level.id === 'allied') {
                bonusInfo = '<div style="background: #1a3a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #4caf50;"><span style="color: #8bc34a;">九 SPOJENEC: -40% ceny v obchod캩, l칠캜en칤 zdarma</span></div>';
            } else if (level.id === 'friendly') {
                bonusInfo = '<div style="background: #2a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #ffd700;"><span style="color: #ffd700;">游녨 P콎츼TELSK칗: -20% ceny, speci치ln칤 zbo쮂</span></div>';
            } else {
                bonusInfo = '<div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #666;"><span style="color: #888;">Investuj pro lep코칤 vztahy a slevy!</span></div>';
            }
            
            showModal('游눯 Investice do Obchodn칤 gildy', `
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <span>游눯 Tv칠 pen칤ze:</span>
                    <strong style="color: #ffd700;">${state.money}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <span>游늵 Reputace:</span>
                    <strong style="color: ${level.color || '#888'};">${currentRep} (${level.name})</strong>
                </div>
                ${bonusInfo}
                
                <div style="display: grid; gap: 0.5rem;">
                    ${amounts.map(a => `
                        <button class="btn" onclick="doInvestment(${a})" style="display: flex; justify-content: space-between; align-items: center; ${state.money >= a ? '' : 'opacity: 0.5; cursor: not-allowed;'}" ${state.money >= a ? '' : 'disabled'}>
                            <span>Investovat ${a} 游눯</span>
                            <span style="color: #8bc34a;">+${Math.floor(a/20)} rep</span>
                        </button>
                    `).join('')}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function doInvestment(amount) {
            if (state.money < amount) {
                notifyWarning(t('notifications', 'notEnoughMoney'), 'Nem치코 dost pen캩z!');
                return;
            }
            state.money -= amount;
            const repGain = Math.floor(amount / 20);
            changeReputation('traders', repGain, 'investice');
            
            notifySuccess('Investice!', `+${repGain} reputace u Obchodn칤 gildy`);
            renderFull();
            
            // Znovu otev콏i dialog s aktualizovan칳mi hodnotami
            investInFaction('traders');
        }
        
        function showFactionResearch(factionId) {
            showModal('游댧 V캩deck칳 v칳zkum', `
                <p style="color: #888; margin-bottom: 1rem;">V캩dci Enkl치vy nab칤zej칤 pokro캜il칳 v칳zkum a vylep코en칤.</p>
                
                <div style="display: grid; gap: 0.8rem;">
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 6px; border: 1px solid #00bcd4;">
                        <h4 style="color: #00bcd4; margin: 0;">游눌 Genetick칠 vylep코en칤</h4>
                        <p style="color: #888; font-size: 0.85rem;">Trvale +5 max HP.</p>
                        <button class="btn" onclick="buyGeneticUpgrade()" style="margin-top: 0.5rem;">Koupit (150 游눯)</button>
                    </div>
                    
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 6px; border: 1px solid #00bcd4;">
                        <h4 style="color: #00bcd4; margin: 0;">游늵 Mapa radiace</h4>
                        <p style="color: #888; font-size: 0.85rem;">Z칤skej informace o radiaci v oblasti.</p>
                        <button class="btn" onclick="getRadiationMap()" style="margin-top: 0.5rem;">Koupit (100 游눯)</button>
                    </div>
                    
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 6px; border: 1px solid #00bcd4;">
                        <h4 style="color: #00bcd4; margin: 0;">游빏 Stabiliz치tor mutac칤</h4>
                        <p style="color: #888; font-size: 0.85rem;">Trval치 imunita v콢캜i nov칳m mutac칤m.</p>
                        <button class="btn" onclick="buyMutationStabilizer()" style="margin-top: 0.5rem;" ${state.mutationImmunity === 'permanent' ? 'disabled' : ''}>
                            ${state.mutationImmunity === 'permanent' ? '九 Ji zakoupeno' : 'Koupit (750 游눯)'}
                        </button>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function buyGeneticUpgrade() {
            if (getMoney() < 150) {
                notifyError(t('notifications', 'notEnoughMoney'), 'Pot콏ebuje코 150 游눯');
                return;
            }
            addMoney(-150);
            state.char.maxHp = (state.char.maxHp || 100) + 5;
            state.char.hp = Math.min(state.char.hp + 5, state.char.maxHp);
            
            // Ulo po캜et zakoupen칳ch vylep코en칤 pro perzistenci
            state.geneticUpgrades = (state.geneticUpgrades || 0) + 1;
            
            saveGame(true);
            
            showModal('游눌 Genetick칠 vylep코en칤!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游눌</div>
                    <p style="color: #8bc34a; font-weight: bold;">+5 maxim치ln칤 HP!</p>
                    <p style="color: #888;">Nov칠 maximum: ${state.char.maxHp} HP</p>
                </div>
                <button class="btn" onclick="closeModal(); showFactionResearch('scientists');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function buyMutationStabilizer() {
            if (state.mutationImmunity === 'permanent') {
                notifyWarning('Ji m치코', 'U m치코 trvalou imunitu v콢캜i mutac칤m!');
                return;
            }
            if (getMoney() < 750) {
                notifyError(t('notifications', 'notEnoughMoney'), 'Pot콏ebuje코 750 游눯');
                return;
            }
            addMoney(-750);
            state.mutationImmunity = 'permanent';
            
            saveGame(true);
            
            showModal('游빏 Stabiliz치tor aplikov치n!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游빏</div>
                    <p style="color: #8bc34a; font-weight: bold;">TRVAL츼 imunita v콢캜i mutac칤m!</p>
                    <p style="color: #888;">U nikdy nez칤sk치코 nov칠 mutace.</p>
                </div>
                <button class="btn" onclick="closeModal(); showFactionResearch('scientists');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function openMutantTrade() {
            // Kontrola otev칤rac칤 doby - mutanti obchoduj칤 v NOCI!
            if (!isShopOpen('mutants')) {
                showModal('驕勇 Mutanti se skr칳vaj칤', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">驕勇游깬</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Mutanti se skr칳vaj칤 p콏ed sluncem!</p>
                        <p style="color: #888; margin: 1rem 0;">낋 Obchod: 20:00 - 06:00 (noc)</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu치ln칤 캜as: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #8bc34a; font-size: 0.8rem; margin-top: 0.5rem;">游깿 Vra콘 se po setm캩n칤.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            showModal('游빏 Mutant칤 obchod', `
                <p style="color: #888; margin-bottom: 1rem;">Mutanti obchoduj칤 s unik치tn칤mi surovinami.</p>
                
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">驕勇 Mutant칤 krev</span>
                            <p style="color: #888; font-size: 0.75rem; margin: 0;">Pro crafting speci치ln칤ch p콏edm캩t콢</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('mutant_blood')" style="padding: 0.3rem 0.6rem;">50 游눯</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">游볼 Mutant칤 maso</span>
                            <p style="color: #8bc34a; font-size: 0.75rem; margin: 0;">-80 hlad, +20 HP</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('mutant_meat')" style="padding: 0.3rem 0.6rem;">30 游눯</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">游 Radaway</span>
                            <p style="color: #ff9800; font-size: 0.75rem; margin: 0;">-50 radiace</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('radaway')" style="padding: 0.3rem 0.6rem;">80 游눯</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">游눑 Mutant칤 krystal</span>
                            <p style="color: #9c27b0; font-size: 0.75rem; margin: 0;">Vz치cn치 surovina pro v칳zkum</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('mutant_crystal')" style="padding: 0.3rem 0.6rem;">120 游눯</button>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function buyMutantItem(itemId) {
            const prices = {
                'mutant_blood': 50,
                'mutant_meat': 30,
                'radaway': 80,
                'mutant_crystal': 120
            };
            const price = prices[itemId];
            if (!price) return;
            
            if (state.money < price) {
                notifyError(t('notifications', 'notEnoughMoney'), `Pot콏ebuje코 ${price} 游눯`);
                return;
            }
            
            state.money -= price;
            
            const itemNames = {
                'mutant_blood': '驕勇 Mutant칤 krev',
                'mutant_meat': '游볼 Mutant칤 maso',
                'radaway': '游 Radaway',
                'mutant_crystal': '游눑 Mutant칤 krystal'
            };
            
            if (itemId === 'mutant_blood' || itemId === 'mutant_crystal') {
                // P콏idat jako item do invent치콏e, ne do resources
                const itemDef = ITEMS.find(i => i.id === itemId);
                if (itemDef) {
                    const newItem = { ...itemDef, count: 1, fromShop: true, boughtPrice: price };
                    addItemToInventory(newItem, 1);
                } else {
                    // Fallback pokud nen칤 v ITEMS
                    state.resources[itemId] = (state.resources[itemId] || 0) + 1;
                }
            } else if (itemId === 'mutant_meat') {
                // P콏idej jako konzumovateln칳 p콏edm캩t
                const meat = {
                    id: 'mutant_meat',
                    name: 'Mutant칤 maso',
                    icon: '游볼',
                    type: 'consumable',
                    effect: 'hunger',
                    value: 80,
                    healValue: 20,
                    count: 1,
                    fromShop: true,
                    boughtPrice: price
                };
                addItemToInventory(meat, 1);
            } else {
                const item = ITEMS.find(i => i.id === itemId);
                if (item) {
                    const boughtItem = { ...item, fromShop: true, boughtPrice: price };
                    addItemToInventory(boughtItem, 1);
                }
            }
            
            notifySuccess('Koupeno!', `Z칤skal jsi ${itemNames[itemId]}`);
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            openMutantTrade(); // Refresh
        }
        
        function getRadiationMap() {
            if (getMoney() < 100) {
                notifyError(t('notifications', 'notEnoughMoney'), 'Pot콏ebuje코 100 游눯');
                return;
            }
            addMoney(-100);
            saveGame(true);
            
            // Uk치 radia캜n칤 info o okoln칤ch lokac칤ch
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const connectedLocs = currentLoc?.connections || [];
            
            let radInfo = connectedLocs.map(locId => {
                const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                if (!loc) return '';
                const radLevel = loc.radiation || (loc.zone === 'deadly' ? 'Vysok치' : loc.zone === 'danger' ? 'St콏edn칤' : 'N칤zk치');
                const radColor = radLevel === 'Vysok치' || loc.zone === 'deadly' ? '#f44336' : 
                                 radLevel === 'St콏edn칤' || loc.zone === 'danger' ? '#ff9800' : '#8bc34a';
                return `<div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin: 0.3rem 0;">
                    <span>${loc.name}</span>
                    <span style="color: ${radColor};">驕뮖잺 ${radLevel}</span>
                </div>`;
            }).join('');
            
            if (!radInfo) radInfo = '<p style="color: #888;">' + ('콯치dn칠 dostupn칠 lokace.') + '</p>';
            
            showModal('游늵 Mapa radiace', `
                <p style="color: #888; margin-bottom: 1rem;">Radia캜n칤 칰rovn캩 okoln칤ch lokac칤:</p>
                ${radInfo}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function showMilitaryTraining() {
            // Kontrola otev칤rac칤 doby
            if (!isShopOpen('military')) {
                showModal('游깿 T치bor odpo캜칤v치', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游꿌勇游눣</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Voj치ci odpo캜칤vaj칤!</p>
                        <p style="color: #888; margin: 1rem 0;">낋 V칳cvik: 06:00 - 18:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu치ln칤 캜as: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #555; font-size: 0.8rem; margin-top: 0.5rem;">游눠 Vra콘 se r치no na tr칠nink.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Kontrola 쬰 m치 hr치캜 p콏칤stup k tr칠ninku
            const factionBonuses = getFactionBonuses();
            if (!factionBonuses.training) {
                notifyWarning('游 P콏칤stup odep콏en', 'Pot콏ebuje코 alespo켿 50 reputace u Vojensk칠ho remnantu!');
                return;
            }
            
            // Elitn칤 zbran캩 jako Allied bonus?
            const eliteWeaponsInfo = factionBonuses.eliteWeapons 
                ? '<p style="color: #ffd700; font-size: 0.85rem; margin-bottom: 0.5rem;">救 Spojenec: +5% bonus damage v boji!</p>'
                : '<p style="color: #666; font-size: 0.8rem; margin-bottom: 0.5rem;">游눠 Na 100 rep z칤sk치코 +5% damage bonus</p>';
            
            showModal('游꿌勇 Vojensk칳 tr칠nink', `
                <p style="color: #888; margin-bottom: 0.5rem;">Vojensk칳 remnant nab칤z칤 bojov칳 v칳cvik.</p>
                ${eliteWeaponsInfo}
                <p style="color: #4caf50; font-size: 0.85rem; margin-bottom: 1rem;">九 Bonusy jsou permanentn칤!</p>
                
                <div style="display: grid; gap: 0.8rem;">
                    <button class="btn" onclick="doMilitaryTraining('combat')" ${state.money >= 100 && (state.trainingBonuses?.combat || 0) < 0.15 ? '' : 'disabled style="opacity: 0.5;"'}>
                        丘덢잺 Bojov칳 tr칠nink (100 游눯)  +5% damage
                        <span style="font-size: 0.75rem; display: block; color: #888;">${state.trainingBonuses?.combat ? Math.round(state.trainingBonuses.combat * 100) + '% / 15% max' : '0% / 15% max'}</span>
                    </button>
                    <button class="btn" onclick="doMilitaryTraining('defense')" ${state.money >= 100 && (state.trainingBonuses?.defense || 0) < 0.15 ? '' : 'disabled style="opacity: 0.5;"'}>
                        游띠勇 Obrann칳 tr칠nink (100 游눯)  +5% obrana
                        <span style="font-size: 0.75rem; display: block; color: #888;">${state.trainingBonuses?.defense ? Math.round(state.trainingBonuses.defense * 100) + '% / 15% max' : '0% / 15% max'}</span>
                    </button>
                    <button class="btn" onclick="doMilitaryTraining('survival')" ${state.money >= 75 && (state.trainingBonuses?.survival || 0) < 0.05 ? '' : 'disabled style="opacity: 0.5;"'}>
                        游끳勇 P콏e쬴t칤 (75 游눯)  +5% efektivita j칤dla/vody
                        <span style="font-size: 0.75rem; display: block; color: #888;">${state.trainingBonuses?.survival ? '九 Dokon캜eno' : 'Jednor치zov칳'}</span>
                    </button>
                </div>
                
                <p style="color: #666; font-size: 0.8rem; margin-top: 1rem; text-align: center;">游눯 Tv칠 pen칤ze: ${state.money}</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function doMilitaryTraining(type) {
            // Validace typu tr칠ninku
            const validTypes = ['combat', 'defense', 'survival'];
            if (!validTypes.includes(type)) {
                console.error('doMilitaryTraining: Neplatn칳 typ tr칠ninku:', type);
                return;
            }
            
            const costs = { combat: 100, defense: 100, survival: 75 };
            const bonuses = { combat: 0.05, defense: 0.05, survival: 0.05 };
            const maxBonuses = { combat: 0.15, defense: 0.15, survival: 0.05 }; // 3x combat/defense, 1x survival
            const cost = costs[type];
            
            if (!cost || state.money < cost) {
                notifyWarning('Nedostatek pen캩z', `Pot콏ebuje코 ${cost} 游눯`);
                return;
            }
            
            // Kontrola limitu
            if (!state.trainingBonuses) state.trainingBonuses = {};
            const currentBonus = state.trainingBonuses[type] || 0;
            const maxBonus = maxBonuses[type];
            
            if (currentBonus >= maxBonus) {
                notifyWarning('Maximum dosa쬰no', 'U jsi dos치hl maxim치ln칤 칰rovn캩 tohoto tr칠ninku!');
                return;
            }
            
            state.money -= cost;
            changeReputation('military', 5, 'tr칠nink');
            
            // P콏idej bonus (5% za tr칠nink)
            const bonusAmount = bonuses[type];
            state.trainingBonuses[type] = Math.min(maxBonus, currentBonus + bonusAmount);
            
            closeModal();
            const typeNames = { combat: 'bojov칳', defense: 'obrann칳', survival: 'p콏e쬴t칤' };
            const newTotal = Math.round(state.trainingBonuses[type] * 100);
            showModal('九 Tr칠nink dokon캜en!', `
                <p>Dokon캜il jsi ${typeNames[type] || type} tr칠nink!</p>
                <p style="color: #8bc34a;">+5% bonus! (celkem ${newTotal}%)</p>
                ${state.trainingBonuses[type] >= maxBonus ? '<p style="color: #ffd700;">游꿌勇 Maximum dosa쬰no!</p>' : ''}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function hireMercenary() {
            const cost = 500;
            
            showModal('丘덢잺 Najmi 쬺ld치ka', `
                <p style="color: #888; margin-bottom: 1rem;">Vojensk칳 remnant nab칤z칤 쬺ld치ky na do캜asnou pomoc.</p>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 6px; border: 1px solid #607d8b; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                        <span style="font-size: 2rem;">游꿌勇</span>
                        <div>
                            <div style="font-weight: bold;">Vojensk칳 쬺ld치k</div>
                            <div style="font-size: 0.8rem; color: #888;">+30 damage, +20 obrana na 5 bitev</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="doHireMercenary()" ${state.money >= cost ? '' : 'disabled style="opacity: 0.5;"'}>
                    Najmout za ${cost} 游눯
                </button>
                <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">游눯 Tv칠 pen칤ze: ${state.money}</p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;"> ${'Zru코it'}</button>
            `);
        }
        
        function doHireMercenary() {
            if (state.money < 500) return;
            state.money -= 500;
            
            state.mercenary = { battles: 5, damage: 30, defense: 20 };
            changeReputation('military', 5, 'tr칠nink');
            
            closeModal();
            showModal('九 콯old치k najat!', `
                <p>Vojensk칳 쬺ld치k t캩 bude doprov치zet dal코칤ch 5 bitev.</p>
                <p style="color: #8bc34a;">+30 damage, +20 obrana</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // === LABORATO콎 V캨DC콡 ===
        function openScientistsLab() {
            const factionBonuses = getFactionBonuses();
            if (!factionBonuses.techAccess) {
                notifyWarning('游 P콏칤stup odep콏en', 'Pot콏ebuje코 alespo켿 50 reputace u V캩dc콢!');
                return;
            }
            
            const isAllied = factionBonuses.labAccess; // 100+ rep
            
            showModal('游빍 Laborato콏 Enkl치vy', `
                <p style="color: #00bcd4; margin-bottom: 1rem;">V캩dci ti nab칤z칤 sv칠 slu쬭y.</p>
                ${isAllied ? '<p style="color: #ffd700; font-size: 0.85rem; margin-bottom: 1rem;">救 Spojenec: Pr칠miov칠 slu쬭y odem캜eny!</p>' : ''}
                
                <div style="display: grid; gap: 0.8rem;">
                    <button class="btn" onclick="labAnalyzeItem()" style="background: linear-gradient(135deg, #00bcd4, #0097a7);">
                        游댧 Analyzovat item (50 游눯)
                        <span style="font-size: 0.75rem; display: block; color: #b2ebf2;">Odhal칤 skryt칠 vlastnosti</span>
                    </button>
                    
                    <button class="btn" onclick="labUpgradeWeapon()" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                        丘 Vylep코it zbra켿 (200 游눯)
                        <span style="font-size: 0.75rem; display: block; color: #ffe0b2;">+10% damage</span>
                    </button>
                    
                    <button class="btn" onclick="labUpgradeArmor()" style="background: linear-gradient(135deg, #3f51b5, #303f9f);">
                        游띠勇 Vylep코it brn캩n칤 (200 游눯)
                        <span style="font-size: 0.75rem; display: block; color: #c5cae9;">+10% defense</span>
                    </button>
                    
                    ${isAllied ? `
                        <button class="btn" onclick="labCreateStimpack()" style="background: linear-gradient(135deg, #4caf50, #388e3c);">
                            游눌 Vyrobit Super Stimpak (100 游눯 + 5 chemik치li칤)
                            <span style="font-size: 0.75rem; display: block; color: #c8e6c9;">L칠캜칤 150 HP</span>
                        </button>
                        
                        <button class="btn" onclick="labCreateRadaway()" style="background: linear-gradient(135deg, #8bc34a, #689f38);">
                            驕뮖잺 Vyrobit Rad-Away+ (75 游눯 + 3 chemik치li칤)
                            <span style="font-size: 0.75rem; display: block; color: #dcedc8;">Odstran칤 60 radiace</span>
                        </button>
                    ` : `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px dashed #333; text-align: center;">
                            <p style="color: #666; margin: 0;">游 Pr칠miov칠 slu쬭y</p>
                            <p style="color: #444; font-size: 0.75rem; margin: 0.3rem 0 0 0;">Vy쬬duje 100 reputace</p>
                        </div>
                    `}
                </div>
                
                <p style="color: #666; font-size: 0.8rem; margin-top: 1rem; text-align: center;">游눯 Tv칠 pen칤ze: ${state.money} | 游빍 Chemik치lie: ${state.resources?.chemicals || 0}</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">Zav콏칤t</button>
            `);
        }
        
        function labAnalyzeItem() {
            if (state.money < 50) {
                notifyWarning('Nedostatek pen캩z', 'Pot콏ebuje코 50 游눯');
                return;
            }
            
            // Najdi item k anal칳ze (zbra켿 nebo brn캩n칤 bez analyzed flagu)
            const analyzableItems = state.inv.filter(i => 
                ['weapon', 'armor', 'helmet', 'gloves', 'boots'].includes(i.type) && !i.analyzed
            );
            
            if (analyzableItems.length === 0) {
                notifyWarning('Nic k anal칳ze', 'Nem치코 쮂멳n칠 vybaven칤 k anal칳ze');
                return;
            }
            
            // Vyber n치hodn칳 item
            const item = analyzableItems[Math.floor(Math.random() * analyzableItems.length)];
            state.money -= 50;
            item.analyzed = true;
            
            // Odhal skryt칳 bonus
            const bonusRoll = Math.random();
            let bonusText = '';
            if (bonusRoll < 0.3) {
                // +5% damage/defense
                if (item.damage) { item.damage = Math.ceil(item.damage * 1.05); bonusText = '+5% damage'; }
                else if (item.defense) { item.defense = Math.ceil(item.defense * 1.05); bonusText = '+5% defense'; }
            } else if (bonusRoll < 0.5) {
                // Durability bonus
                if (item.maxDurability) { item.maxDurability += 20; item.durability = Math.min(item.durability + 20, item.maxDurability); }
                bonusText = '+20 max v칳dr';
            } else {
                bonusText = '콯치dn칳 skryt칳 potenci치l';
            }
            
            item.name = item.name + ' 游댧';
            
            showModal('游댧 Anal칳za dokon캜ena', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${item.icon}</div>
                    <h3 style="color: #00bcd4;">${item.name}</h3>
                    <p style="color: ${bonusText.includes('콯치dn칳') ? '#888' : '#8bc34a'}; margin: 1rem 0;">${bonusText}</p>
                </div>
                <button class="btn" onclick="openScientistsLab()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>
            `);
            renderFull();
        }
        
        function labUpgradeWeapon() {
            if (state.money < 200) {
                notifyWarning('Nedostatek pen캩z', 'Pot콏ebuje코 200 游눯');
                return;
            }
            
            const weapon = state.equipped?.weapon;
            if (!weapon) {
                notifyWarning('콯치dn치 zbra켿', 'Nasa캞 zbra켿 kterou chce코 vylep코it');
                return;
            }
            
            if (weapon.labUpgraded) {
                notifyWarning('Ji vylep코eno', 'Tato zbra켿 u byla vylep코ena v laborato콏i');
                return;
            }
            
            state.money -= 200;
            weapon.damage = Math.ceil(weapon.damage * 1.1);
            weapon.labUpgraded = true;
            weapon.name = weapon.name + ' 丘';
            
            showModal('丘 Zbra켿 vylep코ena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${weapon.icon}</div>
                    <h3 style="color: #ff9800;">${weapon.name}</h3>
                    <p style="color: #8bc34a; margin: 1rem 0;">Damage: ${weapon.damage} (+10%)</p>
                </div>
                <button class="btn" onclick="openScientistsLab()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>
            `);
            renderFull();
        }
        
        function labUpgradeArmor() {
            if (state.money < 200) {
                notifyWarning('Nedostatek pen캩z', 'Pot콏ebuje코 200 游눯');
                return;
            }
            
            const armor = state.equipped?.armor;
            if (!armor) {
                notifyWarning('콯치dn칠 brn캩n칤', 'Nasa캞 brn캩n칤 kter칠 chce코 vylep코it');
                return;
            }
            
            if (armor.labUpgraded) {
                notifyWarning('Ji vylep코eno', 'Toto brn캩n칤 u bylo vylep코eno v laborato콏i');
                return;
            }
            
            state.money -= 200;
            armor.defense = Math.ceil(armor.defense * 1.1);
            armor.labUpgraded = true;
            armor.name = armor.name + ' 丘';
            
            showModal('丘 Brn캩n칤 vylep코eno!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${armor.icon}</div>
                    <h3 style="color: #3f51b5;">${armor.name}</h3>
                    <p style="color: #8bc34a; margin: 1rem 0;">Defense: ${armor.defense} (+10%)</p>
                </div>
                <button class="btn" onclick="openScientistsLab()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>
            `);
            renderFull();
        }
        
        function labCreateStimpack() {
            if (state.money < 100) {
                notifyWarning('Nedostatek pen캩z', 'Pot콏ebuje코 100 游눯');
                return;
            }
            if ((state.resources?.chemicals || 0) < 5) {
                notifyWarning('Nedostatek chemik치li칤', 'Pot콏ebuje코 5 chemik치li칤');
                return;
            }
            
            state.money -= 100;
            state.resources.chemicals -= 5;
            
            const superStim = {
                id: 'super_stimpack_lab',
                name: 'Super Stimpak 丘勇',
                icon: '游눌',
                type: 'consumable',
                effect: 'health',
                value: 150,
                weight: 0.3,
                price: 200
            };
            
            addItemToInventory(superStim, 1);
            notifySuccess('游눌 Vyrobeno!', 'Super Stimpak (150 HP)');
            openScientistsLab();
        }
        
        function labCreateRadaway() {
            if (state.money < 75) {
                notifyWarning('Nedostatek pen캩z', 'Pot콏ebuje코 75 游눯');
                return;
            }
            if ((state.resources?.chemicals || 0) < 3) {
                notifyWarning('Nedostatek chemik치li칤', 'Pot콏ebuje코 3 chemik치li칤');
                return;
            }
            
            state.money -= 75;
            state.resources.chemicals -= 3;
            
            const radawayPlus = {
                id: 'radaway_plus_lab',
                name: 'Rad-Away+ 丘勇',
                icon: '驕뮖잺',
                type: 'consumable',
                effect: 'radiation',
                value: -60,
                weight: 0.2,
                price: 150
            };
            
            addItemToInventory(radawayPlus, 1);
            notifySuccess('驕뮖잺 Vyrobeno!', 'Rad-Away+ (-60 radiace)');
            openScientistsLab();
        }
        
        function cureMutations() {
            const repLevel = getReputationLevel('scientists');
            if (repLevel.id !== 'allied') {
                showModal('仇 P콏칤stup odep콏en', `
                    <p>L칠캜ba mutac칤 vy쬬duje status Spojenec u V캩dc콢 Enkl치vy.</p>
                    <p style="color: #888;">Aktu치ln칤 status: ${repLevel.name}</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const mutations = state.mutations || [];
            if (mutations.length === 0) {
                showModal('驕勇 L칠캜ba mutac칤', `
                    <p style="color: #8bc34a;">Nem치코 쮂멳n칠 mutace k vyl칠캜en칤!</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const cost = mutations.length * 200;
            
            let mutationsHtml = mutations.map(m => {
                const mut = MUTATIONS?.find(mut => mut.id === m) || { name: m, icon: '游빏' };
                return `<div style="padding: 0.3rem; background: #2a1a2a; margin: 0.2rem 0; border-radius: 4px;">${mut.icon || '游빏'} ${mut.name || m}</div>`;
            }).join('');
            
            showModal('驕勇 L칠캜ba mutac칤', `
                <p style="color: #888; margin-bottom: 1rem;">V캩dci Enkl치vy mohou odstranit tv칠 mutace experiment치ln칤 l칠캜bou.</p>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Tv칠 mutace (${mutations.length}):</div>
                    ${mutationsHtml}
                </div>
                
                <p style="color: #ff9800;">Cena: ${cost} 游눯</p>
                <p style="color: #666; font-size: 0.8rem;">游눯 Tv칠 pen칤ze: ${state.money}</p>
                
                <button class="btn" onclick="doCureMutations()" ${state.money >= cost ? '' : 'disabled style="opacity: 0.5;"'} style="width: 100%; margin-top: 0.5rem; background: #8bc34a;">
                    游빏 Vyl칠캜it v코echny mutace
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;"> ${'Zru코it'}</button>
            `);
        }
        
        function doCureMutations() {
            const mutations = state.mutations || [];
            const cost = mutations.length * 200;
            
            if (state.money < cost) {
                notifyError('M치lo pen캩z!', `Pot콏ebuje코 ${cost} 游눯`);
                return;
            }
            
            state.money -= cost;
            const cured = mutations.length;
            state.mutations = [];
            
            // Pokud byl mutant (5 mutac칤), p콏eve캞 zp캩t na p콢vodn칤 povol치n칤
            if (state.char.class === 'mutant') {
                state.char.class = 'survivor'; // V칳choz칤 povol치n칤
                notifySuccess('Prom캩na!', 'U nejsi mutant!');
            }
            
            closeModal();
            showModal('九 Mutace vyl칠캜eny!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">游빏</div>
                    <p style="color: #8bc34a; font-weight: bold;">Vyl칠캜eno ${cured} mutac칤!</p>
                    <p style="color: #888;">Tv칠 t캩lo je op캩t 캜ist칠.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getFactionReputationLevel(factionId) {
            return getReputationLevel(factionId);
        }
        
        function getCurrentWeather() {
            return WEATHER_TYPES.find(w => w.id === state.weather.current) || WEATHER_TYPES[0];
        }
        
        function showWeatherInfo() {
            const weather = getCurrentWeather();
            const timeRemaining = Math.max(0, Math.ceil((state.weather.lastChange + state.weather.duration - Date.now()) / 60000));
            
            // Zjisti jestli m치 havrana s prediction
            const compBonuses = getAllCompanionBonuses();
            const hasPrediction = compBonuses.prediction;
            
            const weatherTexts = {
                weatherEffects: 'Efekty po캜as칤:', speed: 'Rychlost', radiation: 'Radiace', mood: 'N치lada',
                combatEffects: 'Bojov칠 efekty:', yourDamage: 'Tv콢j damage', enemyDamage: 'Enemy damage',
                weatherChange: 'Zm캩na po캜as칤 za ~', minutes: 'minut'
            };
            
            // Bojov칠 modifik치tory
            const playerDmgText = weather.effect.playerDmgMod !== 1.0 
                ? `${weather.effect.playerDmgMod > 1 ? '+' : ''}${Math.round((weather.effect.playerDmgMod - 1) * 100)}%`
                : '0%';
            const enemyDmgText = weather.effect.enemyDmgMod !== 1.0 
                ? `${weather.effect.enemyDmgMod > 1 ? '+' : ''}${Math.round((weather.effect.enemyDmgMod - 1) * 100)}%`
                : '0%';
            
            // P콏edpov캩캞 p콏칤코t칤ho po캜as칤 (pokud m치 havrana s prediction)
            let predictionHtml = '';
            if (hasPrediction) {
                // Simuluj p콏칤코t칤 po캜as칤 na z치klad캩 코anc칤
                const nextWeatherOptions = WEATHER_TYPES.filter(w => w.chance > 0).sort((a, b) => b.chance - a.chance);
                const topPredictions = nextWeatherOptions.slice(0, 3);
                
                predictionHtml = `
                    <div style="background: linear-gradient(135deg, #1a2a3a, #0a1a2a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #2196f3;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2196f3;">游분游댩 Havranovo proroctv칤</h4>
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">Mo쬹칠 zm캩ny po캜as칤:</p>
                        ${topPredictions.map(w => `
                            <div style="display: flex; justify-content: space-between; margin: 0.2rem 0;">
                                <span>${w.icon} ${getWeatherName(w.id)}</span>
                                <span style="color: #ffd700;">${Math.round(w.chance * 100)}%</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            showModal(weather.icon + ' ' + getWeatherName(weather.id), `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${weather.icon}</div>
                    <p style="color: #999; margin-top: 0.5rem;">${getWeatherDesc(weather.id)}</p>
                </div>
                
                <h4 style="margin-bottom: 0.5rem;">游늵 ${weatherTexts.weatherEffects}</h4>
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="margin: 0.3rem 0;">游뛌 <strong>${weatherTexts.speed}:</strong> ${Math.round(weather.effect.speedMod * 100)}%</p>
                    <p style="margin: 0.3rem 0;">驕뮖잺 <strong>${weatherTexts.radiation}:</strong> ${weather.effect.radMod > 1 ? '+' : ''}${Math.round((weather.effect.radMod - 1) * 100)}%</p>
                    <p style="margin: 0.3rem 0;">游땕 <strong>${weatherTexts.mood}:</strong> ${weather.effect.moodMod > 1 ? '+' : ''}${Math.round((weather.effect.moodMod - 1) * 100)}%</p>
                </div>
                
                <h4 style="margin-bottom: 0.5rem;">丘덢잺 ${weatherTexts.combatEffects}</h4>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a4a2a;">
                    <p style="margin: 0.3rem 0; color: ${weather.effect.playerDmgMod >= 1 ? '#8bc34a' : '#ff9800'};">丘덢잺 <strong>${weatherTexts.yourDamage}:</strong> ${playerDmgText}</p>
                    <p style="margin: 0.3rem 0; color: ${weather.effect.enemyDmgMod <= 1 ? '#8bc34a' : '#ff4444'};">游놏 <strong>${weatherTexts.enemyDamage}:</strong> ${enemyDmgText}</p>
                </div>
                
                ${predictionHtml}
                
                <p style="color: #999; font-size: 0.85rem; text-align: center;">
                    낌勇 ${weatherTexts.weatherChange}${timeRemaining} ${weatherTexts.minutes}
                </p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>
            `);
        }
        
        function showClassAbilityInfo() {
            const classData = CLASSES[state.char.classId];
            if (!classData) return;
            
            showModal(`${classData.icon} ${classData.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${classData.icon}</div>
                    <h3 style="margin: 0; color: ${classData.color};">${classData.name}</h3>
                    <p style="color: #888; margin: 0.3rem 0;">${classData.desc}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffd700;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">丘 Aktivn칤 schopnost</h4>
                    <p style="color: #fff; margin: 0; font-size: 1rem;">${classData.ability}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #2a1a2a, #1a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #9c27b0;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #9c27b0;">游댩 Pasivn칤 schopnost</h4>
                    <p style="color: #fff; margin: 0; font-size: 1rem;">${classData.passive}</p>
                </div>
                
                ${classData.bonuses ? `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--toxic-green);">游늵 Bonusy k atribut콢m</h4>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            ${Object.entries(classData.bonuses).map(([attr, bonus]) => {
                                const attrNames = { str: '游눩 S칤la', end: '仇벒잺 V칳dr', agi: '游끢 Obratnost', per: '游녜勇 Vn칤m치n칤', int: '游 Inteligence', lck: '游 맚캩st칤' };
                                return '<div style="text-align: center;"><div style="color: var(--toxic-green); font-weight: bold;">+' + bonus + '</div><div style="font-size: 0.75rem; color: #888;">' + (attrNames[attr] || attr) + '</div></div>';
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${classData.weapon ? `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--rust-light);">游디勇 Startovn칤 zbra켿</h4>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <span style="font-size: 1.5rem;">${classData.weapon.icon}</span>
                            <span>${classData.weapon.name}</span>
                            <span style="color: #ff4444;">(+${classData.weapon.dmg} DMG)</span>
                        </div>
                    </div>
                ` : ''}
                
                ${classData.restrictions ? `
                    <div style="background: linear-gradient(135deg, #2a1a1a, #1a0a0a); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #c62828;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #c62828;">丘멆잺 Omezen칤</h4>
                        <p style="color: #ff6666; margin: 0; font-size: 0.9rem;">${classData.restrictions}</p>
                    </div>
                ` : ''}
                
                ${classData.baseDefense ? `
                    <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #76ff03;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #76ff03;">游띠勇 P콏irozen치 obrana</h4>
                        <p style="color: #76ff03; margin: 0; font-size: 1rem;">+${classData.baseDefense} DEF (mutant칤 k콢쬰)</p>
                    </div>
                ` : ''}
                
                ${state.char.classId === 'mutant' ? `
                    <div style="background: linear-gradient(135deg, #1a2a2a, #0a1a1a); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #00bcd4;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #00bcd4;">游빏 Mutant칤 odolnost</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">驕뮖잺</span>
                                <span style="color: #76ff03;">-50% radiace</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">游빍</span>
                                <span style="color: #76ff03;">50% odolnost na jedy</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">游눩</span>
                                <span style="color: #76ff03;">+15% DMG v radioaktivn칤ch z칩n치ch</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">仇벒잺</span>
                                <span style="color: #76ff03;">+3 HP regenerace p콏i z치sahu</span>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: ${classData.color};">${t('ui', 'close')}</button>
            `);
        }
        
        function showAttackInfo() {
            const weapon = state.equipped?.weapon || null;
            const baseAttack = 5;
            const strBonus = state.char.attrs.str;
            
            // Mutant m치 v쬯y dr치py jako z치lo쬹칤 zbra켿
            let weaponDmg = 0;
            let weaponName = '';
            let weaponIcon = '';
            if (weapon) {
                weaponDmg = weapon.damage;
                weaponName = weapon.name;
                weaponIcon = weapon.icon;
            } else if (state.char.class === 'mutant') {
                weaponDmg = 20;
                weaponName = 'Mutant칤 dr치py';
                weaponIcon = '游붍';
            }
            
            let classBonus = 0;
            let classBonusText = '';
            if (state.char.classId === 'raider') {
                classBonus = Math.floor((baseAttack + strBonus + weaponDmg) * 0.3);
                classBonusText = 'Raider (+30%)';
            } else if (state.char.classId === 'berserker') {
                classBonus = Math.floor((baseAttack + strBonus + weaponDmg) * 0.5);
                classBonusText = 'Berserker (+50%)';
            }
            
            let buildingBonus = 0;
            if (state.base.includes('armory')) {
                buildingBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus) * 0.1);
            }
            
            // Mutace bonusy
            let mutationBonus = 0;
            let mutationBonusText = '';
            if (state.mutations?.includes('berserker_blood')) {
                mutationBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus + buildingBonus) * 0.25);
                mutationBonusText = '游댮 Berserk콏칤 krev (+25%)';
            }
            
            // Skill tree bonus
            const skillTreeBonus = getSkillTreeBonus('damageBonus');
            let skillBonus = 0;
            if (skillTreeBonus > 0) {
                skillBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus + buildingBonus) * skillTreeBonus);
            }
            
            // Training bonus
            let trainingBonus = 0;
            if (state.trainingBonuses?.combat > 0) {
                trainingBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus + buildingBonus + mutationBonus) * state.trainingBonuses.combat);
            }
            
            const total = baseAttack + strBonus + weaponDmg + classBonus + buildingBonus + mutationBonus + skillBonus + trainingBonus;
            
            const coatingInfo = state.weaponCoating ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>${state.weaponCoating.effect === 'poison' ? '游빍 Jedov칳 povlak' : '游댠 Z치paln칳 povlak'}</span>
                    <span style="color: ${state.weaponCoating.effect === 'poison' ? '#9c27b0' : '#ff5722'};">${state.weaponCoating.uses} pou쬴t칤</span>
                </div>
            ` : '';
            
            const specialInfo = weapon?.special ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>救 Speci치ln칤 efekt</span>
                    <span style="color: #ffd700;">${
                        weapon.special === 'poison' ? '驕멆잺 Jed 30%' :
                        weapon.special === 'bleed' ? '游뽖 Krv치cen칤 25%' :
                        weapon.special === 'stun' ? '游눪 Omr치캜en칤 20%' :
                        weapon.special
                    }</span>
                </div>
            ` : '';
            
            // Mutant regenerace info
            const mutantInfo = state.char.class === 'mutant' ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>游붍 Regenerace</span>
                    <span style="color: #76ff03;">+2 HP/z치sah</span>
                </div>
            ` : '';
            
            showModal('丘덢잺 칔tok - Detaily', `
                <div style="background: linear-gradient(135deg, #2a1a1a, #1a0a0a); padding: 1rem; border-radius: 10px; border: 2px solid #8B0000; margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: #ff4444; font-weight: bold;">丘덢잺 ${total}</div>
                    <div style="text-align: center; color: #888;">Celkov칳 칰tok</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #ff6666;">游늵 Slo쬰n칤 칰toku:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>游볡 Z치kladn칤 칰tok</span>
                        <span style="color: #8bc34a;">+${baseAttack}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>游눩 S칤la (STR ${state.char.attrs.str})</span>
                        <span style="color: #8bc34a;">+${strBonus}</span>
                    </div>
                    ${weaponDmg > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${weaponIcon} ${weaponName}</span>
                            <span style="color: #8bc34a;">+${weaponDmg}</span>
                        </div>
                    ` : `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>九 Hol칠 ruce</span>
                            <span style="color: #666;">+0</span>
                        </div>
                    `}
                    ${classBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游꿠 ${classBonusText}</span>
                            <span style="color: #ffd700;">+${classBonus}</span>
                        </div>
                    ` : ''}
                    ${buildingBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游끹勇 Zbrojnice (+10%)</span>
                            <span style="color: #ffd700;">+${buildingBonus}</span>
                        </div>
                    ` : ''}
                    ${mutationBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${mutationBonusText}</span>
                            <span style="color: #f44336;">+${mutationBonus}</span>
                        </div>
                    ` : ''}
                    ${skillBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游닄 Skill tree (+${Math.round(skillTreeBonus * 100)}%)</span>
                            <span style="color: #64b5f6;">+${skillBonus}</span>
                        </div>
                    ` : ''}
                    ${trainingBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游꿌勇 Vojensk칳 tr칠nink (+${Math.round(state.trainingBonuses.combat * 100)}%)</span>
                            <span style="color: #9c27b0;">+${trainingBonus}</span>
                        </div>
                    ` : ''}
                    ${coatingInfo}
                    ${specialInfo}
                    ${mutantInfo}
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">游눠 Jak zv칳코it 칰tok</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy코 atribut S칤la (STR)</li>
                        <li>Vyrob칤 si lep코칤 zbra켿</li>
                        <li>Postav Zbrojnici v osad캩 (+10%)</li>
                        <li>Pou쬴j povlak na zbra켿</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function showDefenseInfo() {
            const armor = state.equipped?.armor || null;
            const helmet = state.equipped?.helmet || null;
            const gloves = state.equipped?.gloves || null;
            const boots = state.equipped?.boots || null;
            const accessory = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
            
            const endBonus = Math.floor(state.char.attrs.end * 0.5);
            const armorDef = armor ? armor.defense : 0;
            const helmetDef = helmet ? helmet.defense : 0;
            const glovesDef = gloves ? gloves.defense : 0;
            const bootsDef = boots ? boots.defense : 0;
            const accDef = (accessory?.bonus === 'defense') ? accessory.value : 0;
            const mutantDef = state.char.class === 'mutant' ? 10 : 0;
            
            const total = endBonus + armorDef + helmetDef + glovesDef + bootsDef + accDef + mutantDef;
            
            // Mutant info
            const mutantInfo = state.char.class === 'mutant' ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>游붍 Mutant칤 k콢쬰</span>
                    <span style="color: #76ff03;">+10</span>
                </div>
                <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; border: 1px solid #76ff03;">
                    <p style="color: #76ff03; margin: 0; font-size: 0.8rem;">丘멆잺 Nem콢쬰코 nosit brn캩n칤 ani helmy - jsi p콏칤li코 velk칳!</p>
                </div>
            ` : '';
            
            showModal('游띠勇 Obrana - Detaily', `
                <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 10px; border: 2px solid var(--toxic-dark); margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: var(--toxic-green); font-weight: bold;">游띠勇 ${total}</div>
                    <div style="text-align: center; color: #888;">Celkov치 obrana</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #8bc34a;">游늵 Slo쬰n칤 obrany:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>游눜 V칳dr (END ${state.char.attrs.end})</span>
                        <span style="color: #8bc34a;">+${endBonus}</span>
                    </div>
                    ${mutantInfo}
                    ${armor && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${armor.icon} ${armor.name}</span>
                            <span style="color: #8bc34a;">+${armorDef}</span>
                        </div>
                    ` : (state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游녯 Bez zbroje</span>
                            <span style="color: #666;">+0</span>
                        </div>
                    ` : '')}
                    ${helmet && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${helmet.icon} ${helmet.name}</span>
                            <span style="color: #8bc34a;">+${helmetDef}</span>
                        </div>
                    ` : ''}
                    ${gloves && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${gloves.icon} ${gloves.name}</span>
                            <span style="color: #ff9800;">+${glovesDef}</span>
                        </div>
                    ` : ''}
                    ${boots && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${boots.icon} ${boots.name}</span>
                            <span style="color: #00bcd4;">+${bootsDef}</span>
                        </div>
                    ` : ''}
                    ${accDef > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${accessory.icon} ${accessory.name}</span>
                            <span style="color: #ffd700;">+${accDef}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">游눠 Jak zv칳코it obranu</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy코 atribut V칳dr (END)</li>
                        ${state.char.class !== 'mutant' ? '<li>Vyrob칤 si lep코칤 zbroj a helmu</li>' : ''}
                        <li>Nasa캞 Drahokamov칳 p콏칤v캩sek (+10)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function showCritInfo() {
            const perBonus = (state.char.attrs.per - 5) * 3;
            const lckBonus = (state.char.attrs.lck - 5) * 2;
            const baseCrit = 5;
            
            let classBonus = 0;
            let classBonusText = '';
            if (state.char.classId === 'assassin') {
                classBonus = 40;
                classBonusText = 'Assassin (+40%)';
            }
            
            const accessory = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
            const accBonus = (accessory?.bonus === 'crit') ? accessory.value : 0;
            
            const total = Math.min(75, baseCrit + Math.max(0, perBonus) + Math.max(0, lckBonus) + classBonus + accBonus);
            
            showModal('游눤 Kritick칳 z치sah - Detaily', `
                <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 1rem; border-radius: 10px; border: 2px solid var(--warning-yellow); margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: var(--warning-yellow); font-weight: bold;">游눤 ${total}%</div>
                    <div style="text-align: center; color: #888;">마nce na kritick칳 z치sah</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #ffd700;">游늵 Slo쬰n칤 kritu:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>游꿢 Z치kladn칤 코ance</span>
                        <span style="color: #8bc34a;">+${baseCrit}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>游녜勇 Vn칤m치n칤 (PER ${state.char.attrs.per})</span>
                        <span style="color: ${perBonus >= 0 ? '#8bc34a' : '#ff6666'};">${perBonus >= 0 ? '+' : ''}${perBonus}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>游 맚캩st칤 (LCK ${state.char.attrs.lck})</span>
                        <span style="color: ${lckBonus >= 0 ? '#8bc34a' : '#ff6666'};">${lckBonus >= 0 ? '+' : ''}${lckBonus}%</span>
                    </div>
                    ${classBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游꿠 ${classBonusText}</span>
                            <span style="color: #ffd700;">+${classBonus}%</span>
                        </div>
                    ` : ''}
                    ${accBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${accessory.icon} ${accessory.name}</span>
                            <span style="color: #ffd700;">+${accBonus}%</span>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #8B0000; margin-bottom: 1rem;">
                    <div style="color: #ff6666; font-weight: bold;">丘덢잺 Kritick칳 z치sah = 2x damage!</div>
                    <div style="color: #aaa; font-size: 0.85rem;">Maximum: 75%</div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">游눠 Jak zv칳코it krit</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy코 atribut Vn칤m치n칤 (PER) - +3% za bod</li>
                        <li>Zvy코 atribut 맚캩st칤 (LCK) - +2% za bod</li>
                        <li>Nasa캞 Krystalov칳 fokus (+15%)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function showDodgeInfo() {
            const baseDodge = 2;
            const agiBonus = (state.char.attrs.agi - 5) * 2;
            
            const total = Math.min(40, baseDodge + Math.max(0, agiBonus));
            
            showModal('游눧 칔hyb - Detaily', `
                <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 1rem; border-radius: 10px; border: 2px solid #3949AB; margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: #7986CB; font-weight: bold;">游눧 ${total}%</div>
                    <div style="text-align: center; color: #888;">마nce na 칰hyb</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #7986CB;">游늵 Slo쬰n칤 칰hybu:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>游붰 Z치kladn칤 코ance</span>
                        <span style="color: #8bc34a;">+${baseDodge}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>丘 Obratnost (AGI ${state.char.attrs.agi})</span>
                        <span style="color: ${agiBonus >= 0 ? '#8bc34a' : '#ff6666'};">${agiBonus >= 0 ? '+' : ''}${agiBonus}%</span>
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--toxic-dark); margin-bottom: 1rem;">
                    <div style="color: #8bc34a; font-weight: bold;">游띠勇 칔hyb = 콯치dn칠 zran캩n칤!</div>
                    <div style="color: #aaa; font-size: 0.85rem;">Maximum: 40%</div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">游눠 Jak zv칳코it 칰hyb</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy코 atribut Obratnost (AGI) - +2% za bod nad 5</li>
                        <li>V boji pou쬴j akci 游눧 칔hyb (100% na 1 kolo)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        // === INFO O SUROVIN캨 ===
        function showResourceInfo(key, icon, name, desc, color) {
            const amount = state.resources[key] || 0;
            
            // Najdi craftingy kter칠 tuto surovinu pou쮂셨aj칤
            const usedIn = CRAFTING.filter(c => c.requires && c.requires[key]).slice(0, 5);
            
            // Najdi zbran캩 kter칠 pou쮂셨aj칤 tuto surovinu jako munici (nap콏. palivo pro 콏et캩zovou pilu)
            const weaponsUsing = ITEMS.filter(i => i.type === 'weapon' && i.ammoType === key);
            
            // Kontrola trvanlivosti
            const perishable = {
                'raw_meat': { days: 2, name: 'Syrov칠 maso' },
                'fish': { days: 2, name: 'Ryba' },
                'herbs': { days: 5, name: 'Byliny' }
            };
            
            let freshness = '';
            if (perishable[key] && amount > 0) {
                const timestamp = state.foodTimestamps?.[key] || state.time.days;
                const daysSince = state.time.days - timestamp;
                const daysLeft = perishable[key].days - daysSince;
                
                let freshColor = '#8bc34a';
                let freshText = '캛erstv칠';
                if (daysLeft <= 1) {
                    freshColor = '#f44336';
                    freshText = '丘멆잺 ZKAZ칈 SE DNES!';
                } else if (daysLeft <= 2) {
                    freshColor = '#ff9800';
                    freshText = '丘멆잺 Brzy se zkaz칤!';
                } else if (daysLeft <= 4) {
                    freshColor = '#ffc107';
                    freshText = 'Je코t캩 캜erstv칠';
                }
                
                const daysWord = daysLeft === 1 ? 'den' : daysLeft < 5 ? 'dny' : 'dn칤';
                freshness = `
                    <div style="background: #1a1a0a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid ${freshColor};">
                        <div style="color: ${freshColor}; font-weight: bold; font-size: 1.1rem;">游뎷 ${freshText}</div>
                        <div style="color: #888; font-size: 0.8rem; margin-top: 0.3rem;">${'Zb칳v치'} ${daysLeft} ${daysWord}</div>
                        <div style="background: #0a0a0a; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="height: 100%; width: ${(daysLeft / perishable[key].days) * 100}%; background: linear-gradient(90deg, ${freshColor}, ${daysLeft > 4 ? '#8bc34a' : freshColor}); transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }
            
            showModal(`${icon} ${name}`, `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${icon}</div>
                    <h2 style="color: ${color}; margin: 0.5rem 0;">${name}</h2>
                    <p style="color: #888; font-size: 0.9rem;">${desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${color};">
                        <div style="font-size: 2rem; font-weight: bold; color: ${color};">${amount}</div>
                        <div style="color: #888; font-size: 0.8rem;">${'v invent치콏i'}</div>
                    </div>
                    
                    ${freshness}
                    
                    ${usedIn.length > 0 ? `
                        <div style="text-align: left; margin-top: 1rem;">
                            <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">游댢 ${'Pou쮂셨치 se na:'}</div>
                            ${usedIn.map(c => `
                                <div style="background: #0a0a0a; padding: 0.4rem; margin: 0.3rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${c.icon || '游닍'} ${c.name || c.id}</span>
                                    <span style="color: ${c.requires[key] <= amount ? '#8bc34a' : '#f44336'}; font-size: 0.8rem;">${c.requires[key]}x</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${weaponsUsing.length > 0 ? `
                        <div style="text-align: left; margin-top: 1rem;">
                            <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">丘덢잺 ${'Munice pro zbran캩:'}</div>
                            ${weaponsUsing.map(w => `
                                <div style="background: #0a0a0a; padding: 0.4rem; margin: 0.3rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${w.icon} ${w.name}</span>
                                    <span style="color: #ff9800; font-size: 0.8rem;">丘덢잺 ${w.damage} DMG</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${'Zav콏칤t'}</button>
            `);
        }
        
        function showEquipmentSlot(slotType) {
            // Najdi aktu치ln캩 nasazen칠 vybaven칤
            let equipped = null;
            let available = [];
            let slotName = '';
            let slotIcon = '';
            let statName = '';
            let statIcon = '';
            
            // Lokalizovan칠 n치zvy
            const slotNames = {
                helmet: 'Helma',
                weapon: 'Zbra켿',
                armor: 'Zbroj',
                gloves: 'Rukavice',
                boots: 'Boty'
            };
            const statNames = {
                defense: 'Obrana',
                attack: '칔tok'
            };
            
            if (slotType === 'helmet') {
                equipped = state.equipped?.helmet || null;
                available = state.inv.filter(i => i.type === 'helmet');
                slotName = slotNames.helmet;
                slotIcon = '久놾잺';
                statName = statNames.defense;
                statIcon = '游띠勇';
            } else if (slotType === 'weapon') {
                equipped = state.equipped?.weapon || null;
                available = state.inv.filter(i => i.type === 'weapon');
                slotName = slotNames.weapon;
                slotIcon = '丘덢잺';
                statName = statNames.attack;
                statIcon = '丘덢잺';
            } else if (slotType === 'armor') {
                equipped = state.equipped?.armor || null;
                available = state.inv.filter(i => i.type === 'armor');
                slotName = slotNames.armor;
                slotIcon = '游띠勇';
                statName = statNames.defense;
                statIcon = '游띠勇';
            } else if (slotType === 'gloves') {
                equipped = state.equipped?.gloves || null;
                available = state.inv.filter(i => i.type === 'gloves');
                slotName = slotNames.gloves;
                slotIcon = '游볡';
                statName = statNames.defense;
                statIcon = '游띠勇';
            } else if (slotType === 'boots') {
                equipped = state.equipped?.boots || null;
                available = state.inv.filter(i => i.type === 'boots');
                slotName = slotNames.boots;
                slotIcon = '游';
                statName = statNames.defense;
                statIcon = '游띠勇';
            }
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Aktu치ln캩 nasazen칠
            html += `<h4 style="color: var(--toxic-green); margin-bottom: 0.5rem;">${slotIcon} ${'Nasazeno:'} ${slotName}</h4>`;
            if (equipped) {
                const statValue = slotType === 'weapon' ? equipped.damage : equipped.defense;
                const durabilityBar = equipped.durability !== undefined ? `
                    <div style="margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.2rem;">
                            <span>游댢 Stav</span>
                            <span>${equipped.durability}/${equipped.maxDurability}</span>
                        </div>
                        <div style="height: 6px; background: #1a1a1a; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${(equipped.durability/equipped.maxDurability)*100}%; background: ${(equipped.durability/equipped.maxDurability) > 0.5 ? '#8bc34a' : (equipped.durability/equipped.maxDurability) > 0.2 ? '#ff9800' : '#f44336'};"></div>
                        </div>
                    </div>
                ` : '';
                
                const specialText = equipped.special ? `<div style="color: #ffd700; font-size: 0.8rem; margin-top: 0.3rem;">救 Speci치l: ${
                    equipped.special === 'poison' ? '驕멆잺 Jed (30% otr치v칤)' :
                    equipped.special === 'bleed' ? '游뽖 Krv치cen칤 (25%)' :
                    equipped.special === 'stun' ? '游눪 Omr치캜en칤 (20%)' :
                    equipped.special === 'rad_resist' ? '驕뮖잺 Odolnost radiaci' :
                    equipped.special === 'rad_immune' ? '驕뮖잺 -50% radiace' :
                    equipped.special
                }</div>` : '';
                
                // Zobraz coating pokud je weapon
                const coatingText = (slotType === 'weapon' && state.weaponCoating) ? `
                    <div style="color: ${state.weaponCoating.effect === 'poison' ? '#9c27b0' : '#ff5722'}; font-size: 0.8rem; margin-top: 0.3rem;">
                        ${state.weaponCoating.effect === 'poison' ? '游빍 Jedov칳 povlak' : '游댠 Z치paln칳 povlak'}: ${state.weaponCoating.uses} pou쬴t칤
                    </div>
                ` : '';
                
                // Zobraz n치boje pokud je weapon s ammoType
                const ammoText = (slotType === 'weapon' && equipped.ammoType) ? `
                    <div style="color: ${getAmmoCount(equipped.ammoType) > 0 ? '#4caf50' : '#f44336'}; font-size: 0.85rem; margin-top: 0.3rem;">
                        游댲 N치boje (${getAmmoName(equipped.ammoType)}): <strong>${getAmmoCount(equipped.ammoType)}</strong>
                        ${getAmmoCount(equipped.ammoType) === 0 ? ' <span style="color: #ff9800;">丘멆잺 Nelze st콏칤let!</span>' : ''}
                    </div>
                ` : '';
                
                html += `
                    <div style="background: linear-gradient(135deg, #2a2a2a, #1a1a1a); padding: 1rem; border-radius: 10px; border: 2px solid var(--toxic-dark); margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 3rem;">${equipped.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #fff; font-size: 1.1rem;">${equipped.name}</div>
                                <div style="color: #8bc34a; font-size: 0.9rem;">${statIcon} ${statName}: +${statValue}</div>
                                ${specialText}
                                ${coatingText}
                                ${ammoText}
                                ${durabilityBar}
                            </div>
                        </div>
                        <button class="btn" onclick="unequipItem('${slotType}')" style="width: 100%; margin-top: 0.8rem; background: #c62828; padding: 0.5rem;">
                            仇 ${'Sundat'}
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; border: 2px dashed #444; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 2rem; color: #555;">${slotIcon}</div>
                        <div style="color: #666;">${'Nic nenasazeno'}</div>
                    </div>
                `;
            }
            
            // Dostupn칠 v invent치콏i
            html += `<h4 style="color: var(--warning-yellow); margin-bottom: 0.5rem;">游닍 ${'Dostupn칠 v invent치콏i'}</h4>`;
            if (available.length > 0) {
                html += '<div style="display: grid; gap: 0.5rem;">';
                available.forEach(item => {
                    const isEquipped = (slotType === 'weapon' && state.equipped?.weapon?.id === item.id) ||
                                       (slotType === 'armor' && state.equipped?.armor?.id === item.id) ||
                                       (slotType === 'helmet' && state.equipped?.helmet?.id === item.id) ||
                                       (slotType === 'gloves' && state.equipped?.gloves?.id === item.id) ||
                                       (slotType === 'boots' && state.equipped?.boots?.id === item.id);
                    const statValue = slotType === 'weapon' ? item.damage : item.defense;
                    const specialIcon = item.special ? ' 救' : '';
                    const clickAction = isEquipped ? '' : `equipItem('${item.id}', '${slotType}')`;
                    const cursor = isEquipped ? 'default' : 'pointer';
                    
                    // Po캜et n치boj콢 pro zbran캩
                    const ammoInfo = (slotType === 'weapon' && item.ammoType) ? 
                        `<span style="color: ${getAmmoCount(item.ammoType) > 0 ? '#4caf50' : '#f44336'}; font-size: 0.75rem; margin-left: 0.5rem;">游댲${getAmmoCount(item.ammoType)}</span>` : '';
                    
                    html += `
                        <div onclick="${clickAction}" style="background: ${isEquipped ? '#1a2a1a' : '#2a2a2a'}; padding: 0.8rem; border-radius: 8px; border: 2px solid ${isEquipped ? '#8bc34a' : '#444'}; display: flex; align-items: center; gap: 0.8rem; cursor: ${cursor}; ${!isEquipped ? 'transition: all 0.2s; ' : ''}">
                            <div style="font-size: 2rem;">${item.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${isEquipped ? '#8bc34a' : '#fff'};">${getItemName(item.id)}${specialIcon}${ammoInfo}</div>
                                <div style="font-size: 0.85rem; color: #888;">${statIcon} +${statValue} ${statName}</div>
                            </div>
                            ${isEquipped ? '<span style="color: #8bc34a; font-size: 0.8rem;">九 ' + ('Nasazeno') + '</span>' : '<span style="color: #666; font-size: 0.8rem;">' + ('Klikni pro nasazen칤') + '</span>'}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center;">' + ('Nem치코 쮂멳n칠 p콏edm캩ty tohoto typu.') + '</p>';
            }
            
            const equipTips = {
                weapon: 'Vyrob si lep코칤 zbra켿 v craftingu! Speci치ln칤 zbran캩 maj칤 bonusov칠 efekty jako jed nebo krv치cen칤.',
                armor: 'T캩쮄뫆 zbroj m치 lep코칤 obranu, ale v치쮂 v칤ce. Nezapome켿 na opravu!',
                helmet: 'Helmy chr치n칤 hlavu a n캩kter칠 maj칤 speci치ln칤 efekty jako no캜n칤 vid캩n칤.',
                gloves: 'Rukavice zvy코uj칤 obranu a n캩kter칠 d치vaj칤 bonusy k boji beze zbran캩.',
                boots: 'Boty zvy코uj칤 obranu a n캩kter칠 d치vaj칤 bonusy k 칰hybu nebo rychlosti.',
                default: 'Vybaven칤 zlep코uje tv칠 statistiky v boji.'
            };
            
            // Tipy
            html += `
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-top: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">游눠 ${'Tip'}</h4>
                    <p style="margin: 0; font-size: 0.8rem; color: #aaa;">
                        ${equipTips[slotType] || equipTips.default}
                    </p>
                </div>
            `;
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal(`${slotIcon} ${slotName}`, html);
        }
        
        function showAccessoryModal() {
            // Najdi v코echny accessory v invent치콏i
            const accessories = state.inv.filter(i => i.type === 'accessory');
            const equipped = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Aktu치ln캩 nasazen칳
            html += '<h4 style="color: var(--toxic-green); margin-bottom: 0.5rem;">游눐 ' + ('Nasazen칳 dopln캩k') + '</h4>';
            if (equipped) {
                html += `
                    <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 1rem; border-radius: 10px; border: 2px solid #ffd700; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 3rem;">${equipped.icon}</div>
                        <div style="font-weight: bold; color: #ffd700; margin-top: 0.5rem;">${getItemName(equipped.id)}</div>
                        <div style="color: #8bc34a; font-size: 0.9rem;">${equipped.desc || ''}</div>
                        <button class="btn" onclick="unequipAccessory()" style="margin-top: 0.8rem; background: #555;">九 ${'Sundat'}</button>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; border: 2px dashed #444; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 2rem; color: #555;">游눐</div>
                        <div style="color: #666;">${'콯치dn칳 dopln캩k'}</div>
                    </div>
                `;
            }
            
            // Dostupn칠 dopl켿ky
            html += '<h4 style="color: var(--warning-yellow); margin-bottom: 0.5rem;">游닍 ' + ('Dostupn칠 dopl켿ky') + '</h4>';
            if (accessories.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">';
                accessories.forEach(acc => {
                    const isEquipped = state.equippedAccessory === acc.id;
                    html += `
                        <div onclick="${isEquipped ? '' : `equipAccessory('${acc.id}')`}" style="background: ${isEquipped ? '#1a2a1a' : '#2a2a2a'}; padding: 0.8rem; border-radius: 8px; text-align: center; cursor: ${isEquipped ? 'default' : 'pointer'}; border: 2px solid ${isEquipped ? '#8bc34a' : '#444'};">
                            <div style="font-size: 2rem;">${acc.icon}</div>
                            <div style="font-weight: bold; font-size: 0.9rem; color: ${isEquipped ? '#8bc34a' : '#fff'};">${getItemName(acc.id)}</div>
                            <div style="font-size: 0.75rem; color: #888;">${acc.desc || ''}</div>
                            ${isEquipped ? '<div style="color: #8bc34a; font-size: 0.7rem; margin-top: 0.3rem;">九 ' + ('Nasazeno') + '</div>' : ''}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center;">' + ('Nem치코 쮂멳n칠 dopl켿ky. Vyrob je z drah칳ch kov콢!') + '</p>';
            }
            
            const accTexts = {
                types: 'Typy dopl켿k콢', silverRing: 'St콏칤brn칳 prsten', goldAmulet: 'Zlat칳 amulet', crystalFocus: 'Krystalov칳 fokus', gemPendant: 'Drahokamov칳 p콏칤v캩sek',
                loot: 'loot', crit: 'kritick칳 z치sah', defense: 'obrana'
            };
            
            // Info o bonusech
            html += `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-top: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">游눠 ${accTexts.types}</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">
                        <li>游눐 <strong>${accTexts.silverRing}:</strong> +10% ${accTexts.loot}</li>
                        <li>游 <strong>${accTexts.goldAmulet}:</strong> +15% XP</li>
                        <li>游댩 <strong>${accTexts.crystalFocus}:</strong> +15% ${accTexts.crit}</li>
                        <li>游눑 <strong>${accTexts.gemPendant}:</strong> +10 ${accTexts.defense}</li>
                    </ul>
                </div>
            `;
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('游눐 Dopl켿ky', html);
        }
        
        function equipItem(itemId, slotType) {
            // Zamkni v칳m캩nu vybaven칤 b캩hem cestov치n칤
            if (state.map?.traveling) {
                notifyWarning('Nelze zm캩nit', 'B캩hem cestov치n칤 nelze m캩nit vybaven칤!');
                return;
            }
            
            // Mutant nem콢쬰 nosit brn캩n칤
            if ((slotType === 'armor' || slotType === 'gloves' || slotType === 'boots') && state.char.class === 'mutant') {
                showModal('仇 Nelze nasadit', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">游붍</div>
                        <p>Jsi p콏칤li코 velk칳 a zdeformovan칳 na b캩쬹칠 vybaven칤!</p>
                        <p style="color: #76ff03;">Tv치 mutant칤 k콢쬰 ti d치v치 +10 p콏irozen칠 obrany.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const item = state.inv.find(i => i.id === itemId && i.type === slotType);
            if (!item) {
                // Zkus칤me naj칤t jen podle ID pokud se neshoduje typ
                const itemAny = state.inv.find(i => i.id === itemId);
                if (itemAny) {
                    if (slotType === 'weapon' && itemAny.type === 'weapon') {
                        state.equipped = state.equipped || {};
                        state.equipped.weapon = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'armor' && itemAny.type === 'armor') {
                        state.equipped = state.equipped || {};
                        state.equipped.armor = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'gloves' && itemAny.type === 'gloves') {
                        state.equipped = state.equipped || {};
                        state.equipped.gloves = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'boots' && itemAny.type === 'boots') {
                        state.equipped = state.equipped || {};
                        state.equipped.boots = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'helmet' && itemAny.type === 'helmet') {
                        state.equipped = state.equipped || {};
                        state.equipped.helmet = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    }
                }
                return;
            }
            
            // Nastav do state.equipped
            state.equipped = state.equipped || {};
            if (slotType === 'weapon') {
                state.equipped.weapon = item;
            } else if (slotType === 'armor') {
                state.equipped.armor = item;
            } else if (slotType === 'helmet') {
                state.equipped.helmet = item;
            } else if (slotType === 'gloves') {
                state.equipped.gloves = item;
            } else if (slotType === 'boots') {
                state.equipped.boots = item;
            }
            
            addLog('Nasazeno: ' + item.name, item.icon);
            notifySuccess('Nasazeno!', item.name);
            
            // Zav콏i modal a p콏ekresli
            closeModal();
            renderFull();
        }
        
        function equipAccessoryByIndex(idx) {
            const accessory = state.inv[idx];
            if (!accessory) return;
            equipAccessory(accessory.id);
        }
        
        function equipAccessory(accId) {
            const accessory = state.inv.find(i => i.id === accId && i.type === 'accessory');
            if (!accessory) return;
            
            state.equippedAccessory = accId;
            addLog('Nasazen dopln캩k: ' + accessory.name, accessory.icon);
            notifySuccess('Nasazeno!', accessory.name);
            showAccessoryModal();
            renderFull();
        }
        
        function unequipAccessory() {
            if (!state.equippedAccessory) return;
            
            const accessory = state.inv.find(i => i.id === state.equippedAccessory);
            state.equippedAccessory = null;
            addLog('Sund치n dopln캩k: ' + (accessory?.name || '?'), '游눐');
            showAccessoryModal();
            renderFull();
        }
        
        function showCompanionsInfo() {
            const compTexts = {
                noCompanions: 'Zat칤m nem치코 쮂멳n칠 spole캜n칤ky.',
                companionInfo: 'Spole캜n칤ci nepot콏ebuj칤 j칤dlo ani vodu automaticky. Bojuj칤 samostatn캩!',
                availableCompanions: 'Dostupn칤 spole캜n칤ci:',
                event: 'Event', hireTip: 'Najmi spole캜n칤ky v OSAD캨 (游냇) nebo je potkej p콏i cestov치n칤!',
                skills: 'dovednost칤', fed: 'Nakrmen', hungry: 'Hladov칳', watered: 'Napojen', thirsty: '콯칤zniv칳',
                loyalty: 'Loajalita', feed: 'Krmit', equipment: 'V칳bava', skillTree: 'Dovednosti', dismiss: 'Propustit',
                nextQuest: 'P콏칤코t칤 quest', goTo: 'Jdi na', allQuestsDone: 'V코echny questy dokon캜eny!'
            };
            
            if (!state.companions || state.companions.length === 0) {
                // Nem치m spole캜n칤ky - zobrazit n치hled
                showModal('游논 Spole캜n칤ci', `
                    <p style="color: #999; text-align: center; margin-bottom: 1rem;">${compTexts.noCompanions}</p>
                    <p style="color: #4caf50; font-size: 0.8rem; text-align: center; margin-bottom: 1rem;">좶잺 ${compTexts.companionInfo}</p>
                    
                    <h4 style="margin-bottom: 0.5rem;">${compTexts.availableCompanions}</h4>
                    <div style="max-height: 45vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${COMPANIONS.map(c => {
                            const compName = c.name;
                            const compAbility = c.ability;
                            return `
                            <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.8rem;">
                                    <div style="font-size: 2rem;">${c.icon}</div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0; font-size: 0.95rem;">${compName}</h4>
                                        <p style="color: #8bc34a; font-size: 0.75rem; margin: 0.2rem 0;">${compAbility}</p>
                                        <p style="font-size: 0.75rem; margin: 0.2rem 0; color: #888;">
                                            仇벒잺 ${c.hp} | 丘덢잺 ${c.damage} | 游띠勇 ${c.defense}
                                        </p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="color: #ffd700; font-weight: bold; margin: 0;">${c.cost > 0 ? c.cost + ' 游눯' : '游꾸 ' + compTexts.event}</p>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">
                        游눠 ${compTexts.hireTip}
                    </p>
                    
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${'Zav콏칤t'}</button>
                `);
                return;
            }
            
            // M치m spole캜n칤ky - zobrazit jejich info
            const currentCount = state.companions.filter(c => !c.isDead).length;
            
            showModal('游논 Tvoji spole캜n칤ci', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${state.companions.map(comp => {
                        // Oprav chyb캩j칤c칤 atributy p콏칤mo p콏i renderov치n칤 (pro star칠 save)
                        if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                            if (!comp.id) comp.id = 'survivor';
                            if (!comp.type) comp.type = 'human';
                            if (comp.canEquip === undefined) comp.canEquip = true;
                        }
                        
                        const companion = COMPANIONS.find(c => c.id === comp.id) || comp; // Fallback na samotn칠ho comp
                        const compIcon = companion.icon || comp.icon || '游녻';
                        const compName = comp.name || companion.name || 'Spole캜n칤k';
                        // Priorita: comp.type (ulo쬰n칳), companion.type (z definice), fallback 'human'
                        const compType = comp.type || companion.type || 'human';
                        const hpPercent = comp.maxHp > 0 ? Math.round((comp.hp / comp.maxHp) * 100) : 0;
                        const level = comp.level || 1;
                        const xp = comp.xp || 0;
                        const nextLevelXp = COMPANION_XP_TABLE[level] || 9999;
                        const xpPercent = nextLevelXp > 0 ? Math.min(100, Math.round((xp / nextLevelXp) * 100)) : 0;
                        const skillPoints = comp.skillPoints || 0;
                        const learnedSkills = comp.skills || [];
                        
                        return `
                            <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border: 2px solid ${skillPoints > 0 ? '#ffd700' : '#333'};">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="font-size: 2.5rem;">${compIcon}</div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <h4 style="margin: 0;">${compName}</h4>
                                            <span style="background: #ff9800; color: #000; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">Lv.${level}</span>
                                        </div>
                                        <p style="color: #8bc34a; font-size: 0.8rem; margin: 0.2rem 0;">游꿢 ${learnedSkills.length} dovednost칤</p>
                                    </div>
                                    ${skillPoints > 0 ? `<div style="background: #ffd700; color: #000; padding: 0.3rem 0.6rem; border-radius: 6px; font-weight: bold; animation: pulse 1s infinite;">+${skillPoints} SP</div>` : ''}
                                </div>
                                
                                <!-- HP bar -->
                                <div style="margin-top: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                        <span>仇벒잺 ${comp.hp}/${comp.maxHp}</span>
                                        <span>丘덢잺 ${getCompanionStat(comp, 'damage')}</span>
                                        <span>游띠勇 ${getCompanionStat(comp, 'defense')}</span>
                                    </div>
                                    <div style="background: #1a1a1a; height: 6px; border-radius: 3px; margin-top: 0.2rem; overflow: hidden;">
                                        <div style="background: ${hpPercent > 50 ? '#4caf50' : hpPercent > 25 ? '#ff9800' : '#c62828'}; height: 100%; width: ${hpPercent}%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Vybaven칤 (jen pro lidi) -->
                                ${(compType === 'human' || comp.canEquip) && comp.equipped && (comp.equipped.weapon || comp.equipped.armor || comp.equipped.helmet || comp.equipped.gloves || comp.equipped.boots || comp.equipped.accessory) ? `
                                    <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem; flex-wrap: wrap;">
                                        ${comp.equipped.weapon ? `<span style="background: #3a2a2a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.weapon.icon || '丘덢잺'} ${comp.equipped.weapon.name}</span>` : ''}
                                        ${comp.equipped.armor ? `<span style="background: #2a3a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.armor.icon || '游띠勇'} ${comp.equipped.armor.name}</span>` : ''}
                                        ${comp.equipped.helmet ? `<span style="background: #2a2a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.helmet.icon || '游뿠'} ${comp.equipped.helmet.name}</span>` : ''}
                                        ${comp.equipped.gloves ? `<span style="background: #3a2a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.gloves.icon || '游빇'} ${comp.equipped.gloves.name}</span>` : ''}
                                        ${comp.equipped.boots ? `<span style="background: #2a3a2a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.boots.icon || '游녹'} ${comp.equipped.boots.name}</span>` : ''}
                                        ${comp.equipped.accessory ? `<span style="background: #3a3a2a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.accessory.icon || '游눐'} ${comp.equipped.accessory.name}</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                <!-- Stav sytosti -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.3rem;">
                                    <div style="background: #1a1a1a; padding: 0.3rem; border-radius: 4px; text-align: center;">
                                        ${(() => {
                                            const now = Date.now();
                                            const DAY_MS = 24 * 60 * 60 * 1000;
                                            const timeSinceFed = now - (comp.lastFedTime || 0);
                                            const needsFood = timeSinceFed >= DAY_MS;
                                            const hoursLeft = Math.max(0, Math.floor((DAY_MS - timeSinceFed) / (60 * 60 * 1000)));
                                            
                                            if (needsFood || !comp.lastFedTime) {
                                                return `<span style="font-size: 0.75rem; color: #c62828;">游꼤 九 Hladov칳</span>`;
                                            } else {
                                                return `<span style="font-size: 0.75rem; color: #4caf50;">游꼤 九 OK (${hoursLeft}h)</span>`;
                                            }
                                        })()}
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.3rem; border-radius: 4px; text-align: center;">
                                        ${(() => {
                                            const now = Date.now();
                                            const DAY_MS = 24 * 60 * 60 * 1000;
                                            const timeSinceWatered = now - (comp.lastWateredTime || 0);
                                            const needsWater = timeSinceWatered >= DAY_MS;
                                            const hoursLeft = Math.max(0, Math.floor((DAY_MS - timeSinceWatered) / (60 * 60 * 1000)));
                                            
                                            if (needsWater || !comp.lastWateredTime) {
                                                return `<span style="font-size: 0.75rem; color: #c62828;">游눦 九 콯칤zniv칳</span>`;
                                            } else {
                                                return `<span style="font-size: 0.75rem; color: #2196f3;">游눦 九 OK (${hoursLeft}h)</span>`;
                                            }
                                        })()}
                                    </div>
                                </div>
                                
                                <!-- XP bar -->
                                <div style="margin-top: 0.3rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #888;">
                                        <span>救 XP</span>
                                        <span>${xp}/${nextLevelXp}</span>
                                    </div>
                                    <div style="background: #1a1a1a; height: 4px; border-radius: 2px; margin-top: 0.1rem; overflow: hidden;">
                                        <div style="background: #ffd700; height: 100%; width: ${xpPercent}%;"></div>
                                    </div>
                                </div>
                                
                                <!-- QUEST INFO -->
                                ${(() => {
                                    const questData = COMPANION_QUESTS[comp.id];
                                    if (!questData) return '';
                                    
                                    if (comp.activeQuest) {
                                        const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
                                        return `
                                            <div style="background: #2a1a3a; padding: 0.5rem; border-radius: 6px; margin-top: 0.4rem; border: 1px solid #9c27b0;">
                                                <div style="color: #ce93d8; font-size: 0.8rem; font-weight: bold;">游닆 ${chapter?.title || 'Aktivn칤 quest'}</div>
                                                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">${chapter?.description || ''}</div>
                                            </div>
                                        `;
                                    } else {
                                        // Najdi dal코칤 quest a jeho podm칤nky
                                        const completedQuests = comp.completedQuests || [];
                                        const nextQuest = questData.chapters.find(c => !completedQuests.includes(c.id));
                                        if (nextQuest) {
                                            const trigger = nextQuest.trigger;
                                            const needLoyalty = trigger.loyalty || 0;
                                            const currentLoyalty = comp.loyalty || 0;
                                            const needLocation = trigger.location;
                                            const locName = needLocation ? WORLD_LOCATIONS.find(l => l.id === needLocation)?.name : null;
                                            
                                            return `
                                                <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.4rem; border: 1px solid #4a6a4a;">
                                                    <div style="color: #8bc34a; font-size: 0.75rem; font-weight: bold;">游눬 P콏칤코t칤 quest: ${nextQuest.title}</div>
                                                    <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                                                        ${needLoyalty > 0 ? `<span style="color: ${currentLoyalty >= needLoyalty ? '#4caf50' : '#ff9800'};">仇벒잺 Loajalita: ${currentLoyalty}/${needLoyalty}</span> ` : ''}
                                                        ${locName ? `<span style="color: #2196f3;">游늸 Jdi na: ${locName}</span>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        } else if (completedQuests.length > 0) {
                                            return `<div style="background: #1a1a1a; padding: 0.3rem; border-radius: 4px; margin-top: 0.4rem; text-align: center; font-size: 0.75rem; color: #ffd700;">九 V코echny questy dokon캜eny!</div>`;
                                        }
                                        return '';
                                    }
                                })()}
                                
                                <!-- Loyalty bar -->
                                <div style="margin-top: 0.3rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #888;">
                                        <span>仇벒잺 Loajalita</span>
                                        <span>${comp.loyalty || 0}/100</span>
                                    </div>
                                    <div style="background: #1a1a1a; height: 4px; border-radius: 2px; margin-top: 0.1rem; overflow: hidden;">
                                        <div style="background: #e91e63; height: 100%; width: ${comp.loyalty || 0}%;"></div>
                                    </div>
                                </div>
                                
                                ${(() => {
                                    const pendingItem = getCompanionPendingQuestItem(comp.uniqueId || comp.id);
                                    if (pendingItem) {
                                        return `
                                            <div style="background: linear-gradient(135deg, #4caf50, #2e7d32); padding: 0.6rem; border-radius: 6px; margin-top: 0.4rem; text-align: center;">
                                                <button class="btn" onclick="deliverQuestItemToCompanion('${comp.uniqueId || comp.id}')" style="background: #fff; color: #2e7d32; font-size: 0.85rem; padding: 0.5rem 1rem; width: 100%;">
                                                    游닍 P콏edat ${pendingItem.itemIcon} ${pendingItem.itemName}
                                                </button>
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}
                                
                                <div style="display: grid; grid-template-columns: ${(compType === 'human' || comp.canEquip || comp.id === 'survivor') ? 'repeat(5, 1fr)' : 'repeat(4, 1fr)'}; gap: 0.4rem; margin-top: 0.5rem;">
                                    <button class="btn" onclick="showFeedCompanionDialog('${comp.uniqueId || comp.id}')" style="background: #ff9800; font-size: 0.75rem; padding: 0.4rem;">游꼤 ${currentLang === "en" ? "Feed" : "Krmit"}</button>
                                    ${(compType === 'human' || comp.canEquip || comp.id === 'survivor') ? `<button class="btn" onclick="showCompanionEquipment('${comp.uniqueId || comp.id}')" style="background: #9c27b0; font-size: 0.75rem; padding: 0.4rem;">游꿯 V칳bava</button>` : ''}
                                    <button class="btn" onclick="showCompanionSkillTree('${comp.uniqueId || comp.id}')" style="background: ${skillPoints > 0 ? 'var(--rust)' : '#444'}; font-size: 0.75rem; padding: 0.4rem;">游꺕 Skill</button>
                                    <button class="btn" onclick="renameCompanion('${comp.uniqueId || comp.id}')" style="background: #2196f3; font-size: 0.75rem; padding: 0.4rem;">九勇 ${currentLang === "en" ? "Name" : "Jm칠no"}</button>
                                    <button class="btn" onclick="confirmDismissCompanion('${comp.uniqueId || comp.id}')" style="background: #333; font-size: 0.75rem; padding: 0.4rem;">游녦 ${currentLang === "en" ? "Dismiss" : "Pry캜"}</button>
                                </div>
                                ${comp.id === 'engineer_npc' ? (comp.skills?.includes('masterwork') ? `
                                    <button class="btn" onclick="technicianUpgradeEquipment()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #ff9800, #f57c00);">
                                        丘 Vylep코it vybaven칤 (+5 DMG/DEF, 20丘뙖잺)
                                    </button>
                                ` : `
                                    <div style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: #333; border-radius: 6px; text-align: center; font-size: 0.8rem;">
                                        游 Vylep코en칤 vybaven칤 - odemkni skill "Mistrovsk치 pr치ce" (Tier 3)
                                    </div>
                                `) : ''}
                                ${comp.id === 'engineer_npc' ? `
                                    <div style="margin-top: 0.5rem; padding: 0.4rem; background: #1a2a1a; border-radius: 4px; font-size: 0.75rem; color: #8bc34a;">
                                        ${comp.skills?.includes('trap') ? '九 游뿫 Bojov칠 pasti aktivn칤 (15-30 DMG na za캜치tku boje)' : '游 游뿫 Bojov칠 pasti (Tier 1)'}<br>
                                        ${comp.skills?.includes('turret') ? '九 游댦 V캩쬴캜ka aktivn칤 (+5 DMG ka쬯칠 kolo)' : '游 游댦 V캩쬴캜ka (Tier 2)'}<br>
                                        ${comp.skills?.includes('robot') ? '九 游뱄 Robot aktivn칤 (+20 DMG ka쬯칠 kolo)' : '游 游뱄 Bojov칳 robot (Tier 3)'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <p style="color: #999; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">
                    ${'Spole캜n칤ci:'} ${state.companions.length}/${getMaxCompanions()} | ${'Spole캜n칤ci z칤sk치vaj칤 XP z boj콢!'}
                </p>
                <p style="color: #ff9800; font-size: 0.8rem; text-align: center; margin: 0.3rem 0;">
                    丘멆잺 ${'Denn칤 spot콏eba:'} ${state.companions.filter(c => !c.isDead).length}x 游꼤 ${'j칤dlo'} + ${state.companions.filter(c => !c.isDead).length}x 游눦 ${'voda'}
                </p>
                
                ${currentCount < getMaxCompanions() ? `
                    <p style="color: #888; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">
                        游눠 ${'Dal코칤 spole캜n칤ky najmi v OSAD캨 (游냇) nebo je potkej p콏i cestov치n칤!'}
                    </p>
                ` : `
                    <p style="color: #888; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">
                        拘勇 ${'Zvy코 level pro v칤ce spole캜n칤k콢!'}
                    </p>
                `}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${'Zav콏칤t'}</button>
            `);
        }
        
        function getCompanionStat(comp, stat) {
            const base = COMPANIONS.find(c => c.id === comp.id) || comp;
            
            let value = base[stat] || comp[stat] || 0;
            
            // P콏idej bonus z levelu spole캜n칤ka
            const level = comp.level || 1;
            if (stat === 'damage') {
                value += (level - 1) * 2; // +2 damage za ka쬯칳 level
            }
            if (stat === 'defense') {
                value += (level - 1) * 1; // +1 defense za ka쬯칳 level
            }
            
            // P콏idej bonusy z vybaven칤
            if (comp.equipped) {
                if (stat === 'damage' && comp.equipped.weapon) {
                    value += comp.equipped.weapon.damage || 0;
                }
                if (stat === 'defense') {
                    if (comp.equipped.armor) value += comp.equipped.armor.defense || 0;
                    if (comp.equipped.helmet) value += comp.equipped.helmet.defense || 0;
                    if (comp.equipped.gloves) value += comp.equipped.gloves.defense || 0;
                    if (comp.equipped.boots) value += comp.equipped.boots.defense || 0;
                }
            }
            
            // P콏idej bonusy ze skill콢 - pou쬴j survivor tree pro dynamick칠 companiony
            let skillTree = COMPANION_SKILL_TREES[comp.id];
            if (!skillTree && (base.type === 'human' || comp.type === 'human')) {
                skillTree = COMPANION_SKILL_TREES['survivor'];
            }
            
            if (skillTree && comp.skills) {
                comp.skills.forEach(skillId => {
                    Object.values(skillTree.trees).forEach(tree => {
                        const skill = tree.skills.find(s => s.id === skillId);
                        if (skill?.effect?.[stat]) {
                            value += skill.effect[stat];
                        }
                    });
                });
            }
            
            return value;
        }
        
        // Z칤skej travelSpeed bonus ze v코ech companion skills
        function getCompanionTravelSpeedBonus() {
            if (!state.companions || state.companions.length === 0) return 0;
            
            let totalBonus = 0;
            
            state.companions.forEach(comp => {
                if (!comp.skills || comp.skills.length === 0) return;
                
                const base = COMPANIONS.find(c => c.id === comp.id) || comp;
                let skillTree = COMPANION_SKILL_TREES[comp.id];
                if (!skillTree && (base.type === 'human' || comp.type === 'human')) {
                    skillTree = COMPANION_SKILL_TREES['survivor'];
                }
                
                if (skillTree) {
                    comp.skills.forEach(skillId => {
                        Object.values(skillTree.trees).forEach(tree => {
                            const skill = tree.skills.find(s => s.id === skillId);
                            if (skill?.effect?.travelSpeed) {
                                totalBonus += skill.effect.travelSpeed;
                            }
                        });
                    });
                }
            });
            
            return totalBonus;
        }
        
        // Z칤skej VECHNY bonusy ze v코ech companion skills
        function getAllCompanionBonuses() {
            const bonuses = {
                damage: 0,
                defense: 0,
                hp: 0,
                critChance: 0,
                critDamage: 0,
                dodgeChance: 0,
                lootChance: 0,
                xpBonus: 0,
                priceBonus: 0,
                ambushReduction: 0,
                travelSpeed: 0,
                healingBonus: 0,
                rareChance: 0,
                doubleLoot: 0,
                healPlayerAfterCombat: 0,
                regenAfterCombat: 0,
                visionRange: 0,
                partyDamage: 0,
                hiddenChance: 0,
                // Boolean efekty
                fetchLoot: false,
                surviveChance: 0,
                resurrectChance: 0,
                stealChance: 0,
                enemyWarning: false,
                firstStrikeCrit: false,
                ignoreTerrrain: false,
                prediction: false, // Havran - p콏edpov캩캞 po캜as칤 a event콢
                questReveal: false, // Havran - odhalen칤 quest lokac칤
                // Technik efekty
                autoRepair: false,
                canUpgrade: false,
                durabilityBonus: 0,
                craftCostReduction: 0,
                craftBonus: 0,
                specialRecipes: false,
                canTrap: false,
                turretDamage: 0,
                canBuildRobot: false,
                freeRepair: false // Z치kladn칤 schopnost technika
            };
            
            if (!state.companions || state.companions.length === 0) return bonuses;
            
            // Kontrola z치kladn칤ch schopnost칤 spole캜n칤k콢
            state.companions.forEach(comp => {
                const base = COMPANIONS.find(c => c.id === comp.id) || comp;
                // Technik m치 z치kladn칤 schopnost opravy zdarma
                if (comp.id === 'engineer_npc' || base.id === 'engineer_npc') {
                    bonuses.freeRepair = true;
                }
            });
            
            state.companions.forEach(comp => {
                if (!comp.skills || comp.skills.length === 0) return;
                
                const base = COMPANIONS.find(c => c.id === comp.id) || comp;
                let skillTree = COMPANION_SKILL_TREES[comp.id];
                if (!skillTree && (base.type === 'human' || comp.type === 'human')) {
                    skillTree = COMPANION_SKILL_TREES['survivor'];
                }
                
                if (skillTree) {
                    comp.skills.forEach(skillId => {
                        Object.values(skillTree.trees).forEach(tree => {
                            const skill = tree.skills.find(s => s.id === skillId);
                            if (skill?.effect) {
                                Object.entries(skill.effect).forEach(([key, value]) => {
                                    if (typeof value === 'boolean') {
                                        bonuses[key] = value;
                                    } else if (typeof value === 'number') {
                                        bonuses[key] = (bonuses[key] || 0) + value;
                                    }
                                });
                            }
                        });
                    });
                }
            });
            
            return bonuses;
        }
        
        function showCompanionSkillTree(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Oprav chyb캩j칤c칤 atributy pro star칠 freed_slave spole캜n칤ky
            if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                if (!comp.id) comp.id = 'survivor';
                if (!comp.type) comp.type = 'human';
            }
            
            const companion = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compIcon = companion.icon || comp.icon || '游녻';
            const compName = comp.name || companion.name || 'Spole캜n칤k';
            
            // Najdi skill tree - pou쬴j comp.id pro mapov치n칤 na skill tree
            // Pro freed_slave v쬯y pou쬴j survivor tree
            let skillTree = COMPANION_SKILL_TREES[comp.id];
            let treeId = comp.id;
            
            // Fallback na survivor tree pro freed_slave nebo human type
            if (!skillTree) {
                // Dynamick칳 companion - pou쬴j survivor tree pro lidi, jinak zobraz zpr치vu
                const compType = companion.type || comp.type || 'human';
                if (compType === 'human') {
                    skillTree = COMPANION_SKILL_TREES['survivor'];
                    treeId = 'survivor';
                }
            }
            
            if (!skillTree) {
                showModal(`${compIcon} ${compName}`, `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">${compIcon}</div>
                        <p style="color: #888;">Tento spole캜n칤k nem치 strom dovednost칤.</p>
                        <p style="color: #666; font-size: 0.85rem;">Z칤sk치v치 XP z boj콢 a pom치h치 ti v boji.</p>
                    </div>
                    <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; margin-top: 1rem; background: #555;"> ${'Zp캩t'}</button>
                `);
                return;
            }
            
            const level = comp.level || 1;
            const skillPoints = comp.skillPoints || 0;
            const learnedSkills = comp.skills || [];
            
            let treesHtml = '';
            Object.entries(skillTree.trees).forEach(([treeId, tree]) => {
                treesHtml += `
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid ${tree.color};">
                        <h4 style="margin: 0 0 0.5rem 0; color: ${tree.color};">${tree.icon} ${tree.name}</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${tree.skills.map(skill => {
                                const isLearned = learnedSkills.includes(skill.id);
                                const canLearn = !isLearned && skillPoints > 0 && level >= skill.tier && 
                                    (!skill.requires || learnedSkills.includes(skill.requires));
                                const isLocked = !isLearned && !canLearn;
                                
                                return `
                                    <div onclick="${canLearn ? `learnCompanionSkill('${companionId}', '${skill.id}')` : ''}" 
                                         style="background: ${isLearned ? '#1a3a1a' : canLearn ? '#2a2a1a' : '#0a0a0a'}; 
                                                padding: 0.5rem; border-radius: 6px; text-align: center; min-width: 80px;
                                                border: 2px solid ${isLearned ? '#4caf50' : canLearn ? '#ffd700' : '#333'};
                                                cursor: ${canLearn ? 'pointer' : 'default'};
                                                opacity: ${isLocked ? '0.5' : '1'};">
                                        <div style="font-size: 1.5rem;">${skill.icon}</div>
                                        <div style="font-size: 0.7rem; font-weight: bold; color: ${isLearned ? '#8bc34a' : '#fff'};">${skill.name}</div>
                                        <div style="font-size: 0.6rem; color: #888;">${skill.desc}</div>
                                        <div style="font-size: 0.6rem; color: #ff9800;">Tier ${skill.tier}</div>
                                        ${isLearned ? '<div style="color: #4caf50; font-size: 0.7rem;">九</div>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            showModal(`${compIcon} ${compName} - ${'Dovednosti'}`, `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem; background: #1a1a1a; border-radius: 8px;">
                    <div>
                        <span style="color: #ff9800; font-weight: bold;">Level ${level}</span>
                        <span style="color: #888; margin-left: 0.5rem;">|</span>
                        <span style="color: #888; margin-left: 0.5rem;">${learnedSkills.length} ${'dovednost칤'}</span>
                    </div>
                    <div style="background: ${skillPoints > 0 ? '#ffd700' : '#333'}; color: ${skillPoints > 0 ? '#000' : '#666'}; padding: 0.3rem 0.8rem; border-radius: 6px; font-weight: bold;">
                        ${skillPoints} SP
                    </div>
                </div>
                
                <div style="max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${treesHtml}
                </div>
                
                <p style="color: #888; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">
                    ${skillPoints > 0 ? ('游눠 Klikni na dovednost pro nau캜en칤') : ('游눠 Z칤skej SP levelov치n칤m spole캜n칤ka')}
                </p>
                
                <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${'Zp캩t'}</button>
            `);
        }
        
        function learnCompanionSkill(companionId, skillId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            const skillPoints = comp.skillPoints || 0;
            if (skillPoints <= 0) {
                notifyWarning('Nedostatek SP', 'Nem치코 body dovednost칤!');
                return;
            }
            
            // Pro dynamick칠 spole캜n칤ky (survivor) pou쬴j survivor skill tree
            let treeId = comp.id;
            if (!COMPANION_SKILL_TREES[treeId] && (comp.type === 'human')) {
                treeId = 'survivor';
            }
            
            const skillTree = COMPANION_SKILL_TREES[treeId];
            if (!skillTree) {
                notifyWarning('Chyba', 'Skill tree nenalezen');
                return;
            }
            
            let skill = null;
            let treeName = '';
            
            Object.values(skillTree.trees).forEach(tree => {
                const found = tree.skills.find(s => s.id === skillId);
                if (found) {
                    skill = found;
                    treeName = tree.name;
                }
            });
            
            if (!skill) return;
            
            // Zkontroluj requirements
            comp.skills = comp.skills || [];
            if (skill.requires && !comp.skills.includes(skill.requires)) {
                notifyWarning('Zam캜eno', 'Mus칤코 nejd콏칤v nau캜it p콏edchoz칤 dovednost!');
                return;
            }
            
            // Nau캜 skill
            comp.skills.push(skillId);
            comp.skillPoints--;
            
            // Aplikuj efekty na staty
            if (skill.effect.hp) comp.maxHp = (comp.maxHp || 80) + skill.effect.hp;
            
            notifySuccess('Dovednost nau캜ena!', `${skill.icon} ${skill.name}`);
            SoundSystem.play('levelup');
            
            showCompanionSkillTree(comp.uniqueId || comp.id);
        }
        
        function addCompanionXP(amount) {
            if (!state.companions || state.companions.length === 0) return;
            
            state.companions.forEach(comp => {
                comp.xp = (comp.xp || 0) + amount;
                comp.level = comp.level || 1;
                
                // === P콎IDEJ LOAJALITU ZA BOJ ===
                const loyaltyGain = Math.max(1, Math.floor(amount / 20)); // 1 loajalita za ka쬯칳ch 20 XP
                comp.loyalty = Math.min(100, (comp.loyalty || 0) + loyaltyGain);
                
                // Check level up
                const nextLevelXp = COMPANION_XP_TABLE[comp.level] || 9999;
                if (comp.xp >= nextLevelXp && comp.level < 10) {
                    comp.xp -= nextLevelXp;
                    comp.level++;
                    comp.skillPoints = (comp.skillPoints || 0) + 1;
                    
                    // Bonus HP p콏i level up
                    const baseCompanion = COMPANIONS.find(c => c.id === comp.id);
                    comp.maxHp = (comp.maxHp || baseCompanion.hp) + 5;
                    comp.hp = Math.min(comp.hp + 10, comp.maxHp);
                    
                    // Bonus loajalita za level up
                    comp.loyalty = Math.min(100, (comp.loyalty || 0) + 5);
                    
                    const companion = COMPANIONS.find(c => c.id === comp.id) || comp;
                    const compIcon = companion.icon || comp.icon || '游녻';
                    const compName = comp.name || companion.name || 'Spole캜n칤k';
                    notifySuccess(`${compIcon} Level UP!`, `${compName} je level ${comp.level}! +1 SP`);
                    addLog(`${compIcon} ${compName} dos치hl level ${comp.level}!`, '救');
                }
            });
        }
        
        // === VYBAVEN칈 SPOLE캛N칈K콡 ===
        function showCompanionEquipment(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Oprav chyb캩j칤c칤 atributy pro star칠 freed_slave spole캜n칤ky
            if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                if (!comp.id) comp.id = 'survivor';
                if (!comp.type) comp.type = 'human';
                if (comp.canEquip === undefined) comp.canEquip = true;
            }
            
            const companion = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compType = comp.type || companion.type || 'human';
            
            // Povol vybaven칤 pro lidi, survivor, freed_slave a ty s canEquip
            const isFreedSlave = comp.uniqueId && comp.uniqueId.startsWith('freed_slave');
            if (compType !== 'human' && comp.id !== 'survivor' && !comp.canEquip && !isFreedSlave) {
                notifyError('Nelze vybavit', 'Pouze lid코t칤 spole캜n칤ci mohou nosit vybaven칤.');
                return;
            }
            
            // Inicializuj equipped pokud neexistuje
            if (!comp.equipped) {
                comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null };
            }
            
            // Z칤skej ID p콏edm캩t콢 vybaven칳ch JIN칗MI companiony (ne t칤mto)
            const otherCompanionEquipped = new Set();
            state.companions.forEach(c => {
                if ((c.id !== companionId && c.uniqueId !== companionId) && c.equipped) {
                    ['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].forEach(slot => {
                        if (c.equipped[slot]?.id) {
                            otherCompanionEquipped.add(c.equipped[slot].id);
                        }
                    });
                }
            });
            
            // Najdi dostupn칠 p콏edm캩ty v invent치콏i (vyfiltruj ty co maj칤 jin칤 companioni)
            const weapons = state.inv.filter(i => i.type === 'weapon' && !otherCompanionEquipped.has(i.id));
            const armors = state.inv.filter(i => i.type === 'armor' && !otherCompanionEquipped.has(i.id));
            const helmets = state.inv.filter(i => i.type === 'helmet' && !otherCompanionEquipped.has(i.id));
            const gloves = state.inv.filter(i => i.type === 'gloves' && !otherCompanionEquipped.has(i.id));
            const boots = state.inv.filter(i => i.type === 'boots' && !otherCompanionEquipped.has(i.id));
            const accessories = state.inv.filter(i => (i.type === 'accessory' || i.id === 'compass' || i.id === 'binoculars') && !otherCompanionEquipped.has(i.id));
            
            const currentWeapon = comp.equipped.weapon;
            const currentArmor = comp.equipped.armor;
            const currentHelmet = comp.equipped.helmet;
            const currentGloves = comp.equipped.gloves;
            const currentBoots = comp.equipped.boots;
            const currentAccessory = comp.equipped.accessory;
            
            const compIcon = companion.icon || comp.icon || '游녻';
            const compName = comp.name || companion.name || 'Spole캜n칤k';
            
            showModal(`游꿯 ${'Vybaven칤:'} ${compName}`, `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- Header -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; background: #1a2a1a; padding: 0.8rem; border-radius: 8px;">
                        <div style="font-size: 2.5rem;">${compIcon}</div>
                        <div>
                            <h4 style="margin: 0;">${compName}</h4>
                            <div style="font-size: 0.8rem; color: #888;">
                                丘덢잺 ${getCompanionStat(comp, 'damage')} | 游띠勇 ${getCompanionStat(comp, 'defense')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ZBRA켾 -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #ff6b6b; font-weight: bold;">丘덢잺 ${'Zbra켿'}</span>
                            ${currentWeapon ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'weapon')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentWeapon ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #ff6b6b;">
                                ${currentWeapon.icon || '丘덢잺'} ${getItemName(currentWeapon.id)} - 丘덢잺+${currentWeapon.damage || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'콯치dn치 zbra켿'}</div>
                        `}
                        ${weapons.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${weapons.map(w => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'weapon', '${w.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #2a3a4a; text-align: left; font-size: 0.8rem;">
                                        ${w.icon || '丘덢잺'} ${getItemName(w.id)} (丘덢잺+${w.damage || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : `<div style="color: #555; font-size: 0.75rem;">${'콯치dn칠 zbran캩 v invent치콏i'}</div>`}
                    </div>
                    
                    <!-- ZBROJ -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #4ecdc4; font-weight: bold;">游띠勇 ${'Zbroj'}</span>
                            ${currentArmor ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'armor')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentArmor ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #4ecdc4;">
                                ${currentArmor.icon || '游띠勇'} ${getItemName(currentArmor.id)} - 游띠勇+${currentArmor.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'콯치dn치 zbroj'}</div>
                        `}
                        ${armors.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${armors.map(a => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'armor', '${a.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #2a4a4a; text-align: left; font-size: 0.8rem;">
                                        ${a.icon || '游띠勇'} ${getItemName(a.id)} (游띠勇+${a.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : `<div style="color: #555; font-size: 0.75rem;">${'콯치dn칠 zbroje v invent치콏i'}</div>`}
                    </div>
                    
                    <!-- HELMA -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #795548; font-weight: bold;">久놾잺 ${'Helma'}</span>
                            ${currentHelmet ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'helmet')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentHelmet ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #795548;">
                                ${currentHelmet.icon || '久놾잺'} ${getItemName(currentHelmet.id)} - 游띠勇+${currentHelmet.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'콯치dn치 helma'}</div>
                        `}
                        ${helmets.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${helmets.map(h => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'helmet', '${h.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #4a3a2a; text-align: left; font-size: 0.8rem;">
                                        ${h.icon || '久놾잺'} ${getItemName(h.id)} (游띠勇+${h.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">' + ('콯치dn칠 helmy v invent치콏i') + '</div>'}
                    </div>
                    
                    <!-- DOPLN캨K -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #ffd700; font-weight: bold;">游눐 ${'Dopln캩k'}</span>
                            ${currentAccessory ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'accessory')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentAccessory ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #ffd700;">
                                ${currentAccessory.icon || '游눐'} ${getItemName(currentAccessory.id)}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'콯치dn칳 dopln캩k'}</div>
                        `}
                        ${accessories.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${accessories.map(acc => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'accessory', '${acc.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #4a4a2a; text-align: left; font-size: 0.8rem;">
                                        ${acc.icon || '游눐'} ${getItemName(acc.id)}
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">' + ('콯치dn칠 dopl켿ky v invent치콏i') + '</div>'}
                    </div>
                    
                    <!-- RUKAVICE -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #ff9800; font-weight: bold;">游볡 Rukavice</span>
                            ${currentGloves ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'gloves')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">Sundat</button>` : ''}
                        </div>
                        ${currentGloves ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #ff9800;">
                                ${currentGloves.icon || '游볡'} ${currentGloves.name} - 游띠勇+${currentGloves.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">콯치dn칠 rukavice</div>
                        `}
                        ${gloves.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${gloves.map(g => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'gloves', '${g.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #4a3a2a; text-align: left; font-size: 0.8rem;">
                                        ${g.icon || '游볡'} ${g.name} (游띠勇+${g.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">콯치dn칠 rukavice v invent치콏i</div>'}
                    </div>
                    
                    <!-- BOTY -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #00bcd4; font-weight: bold;">游 Boty</span>
                            ${currentBoots ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'boots')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">Sundat</button>` : ''}
                        </div>
                        ${currentBoots ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #00bcd4;">
                                ${currentBoots.icon || '游'} ${currentBoots.name} - 游띠勇+${currentBoots.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">콯치dn칠 boty</div>
                        `}
                        ${boots.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${boots.map(b => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'boots', '${b.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #2a3a4a; text-align: left; font-size: 0.8rem;">
                                        ${b.icon || '游'} ${b.name} (游띠勇+${b.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">콯치dn칠 boty v invent치콏i</div>'}
                    </div>
                    
                    <!-- N츼BOJE -->
                    ${comp.equipped?.weapon?.ammoType ? `
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #ffeb3b; font-weight: bold;">游댦 N치boje (${getAmmoName(comp.equipped.weapon.ammoType)})</span>
                            <span style="color: #4caf50;">${comp.ammo || 0} ks</span>
                        </div>
                        <div style="color: #888; font-size: 0.75rem; margin-top: 0.4rem; text-align: center; padding: 0.3rem; background: #1a1a1a; border-radius: 4px;">
                            九 Automaticky bere z tv칠ho invent치콏e v boji
                        </div>
                        <div style="color: #666; font-size: 0.7rem; margin-top: 0.3rem; text-align: center;">
                            Tv칠 n치boje: ${getAmmoCount(comp.equipped.weapon.ammoType)} ks
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${'Zp캩t'}</button>
            `);
        }
        
        function equipCompanionItem(companionId, slot, itemId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) {
                notifyError('Chyba', ('Spole캜n칤k nenalezen'));
                return;
            }
            
            // Najdi p콏edm캩t v invent치콏i
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) {
                notifyError('Chyba', ('P콏edm캩t nenalezen v invent치콏i'));
                return;
            }
            
            const item = state.inv[itemIndex];
            
            // Inicializuj equipped pokud neexistuje
            if (!comp.equipped) {
                comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null };
            }
            
            // Pokud u m치 n캩co vybaven칠ho, vra콘 to do invent치콏e
            if (comp.equipped[slot]) {
                const oldItem = {...comp.equipped[slot]};
                // P콏idej star칳 p콏edm캩t zp캩t do invent치콏e
                const existingOld = state.inv.find(i => i.id === oldItem.id);
                if (existingOld) {
                    existingOld.count = (existingOld.count || 1) + 1;
                } else {
                    oldItem.count = 1;
                    state.inv.push(oldItem);
                }
            }
            
            // Vybav칤 nov칳 p콏edm캩t
            comp.equipped[slot] = {...item, count: 1};
            
            // Odeber z invent치콏e (jen 1 kus)
            if (item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            updateCarryWeight();
            notifySuccess('Vybaveno!', `${comp.name} m치 nyn칤 ${item.name}`);
            addLog(`${comp.name} vybaven: ${item.name}`, item.icon || '游꿯');
            saveGame(true);
            
            // P콏ekresli cel칠 UI aby se invent치콏 spr치vn캩 aktualizoval
            renderFull();
            
            showCompanionEquipment(companionId);
        }
        
        function unequipCompanionItem(companionId, slot) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.equipped || !comp.equipped[slot]) {
                notifyError('Chyba', ('Nelze sundat - nic nen칤 vybaveno'));
                return;
            }
            
            const item = {...comp.equipped[slot]};
            
            // Pokud sund치v치me zbra켿 a spole캜n칤k m치 n치boje, vr치t칤me je hr치캜i
            if (slot === 'weapon' && comp.ammo > 0 && item.ammoType) {
                addAmmo(item.ammoType, comp.ammo);
                notifyInfo('N치boje vr치ceny', `+${comp.ammo} ${getAmmoName(item.ammoType)}`);
                comp.ammo = 0;
            }
            
            // Kontrola v치hy
            if (!canAddItem(item, 1)) {
                notifyWarning(t('notifications', 'inventoryFull'), 'Neunese코 ' + item.name);
                return;
            }
            
            // Vra콘 do invent치콏e
            const existing = state.inv.find(i => i.id === item.id);
            if (existing) {
                existing.count = (existing.count || 1) + 1;
            } else {
                item.count = 1;
                state.inv.push(item);
            }
            
            // Odeber z vybaven칤
            comp.equipped[slot] = null;
            
            updateCarryWeight();
            notifySuccess('Sund치no!', `${item.name} vr치ceno do invent치콏e`);
            saveGame();
            
            showCompanionEquipment(companionId);
        }
        
        // Dej n치boje spole캜n칤kovi
        function giveAmmoToCompanion(companionId, amount) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) {
                notifyError('Chyba', 'Spole캜n칤k nenalezen');
                return;
            }
            
            // Zjisti typ n치boj콢 ze zbran캩
            const ammoType = comp.equipped?.weapon?.ammoType;
            if (!ammoType) {
                notifyError('Chyba', 'Spole캜n칤k nem치 zbra켿 vy쬬duj칤c칤 n치boje');
                return;
            }
            
            // Zkontroluj jestli hr치캜 m치 dost n치boj콢
            const playerAmmo = getAmmoCount(ammoType);
            if (playerAmmo < amount) {
                notifyWarning('Nedostatek n치boj콢', `M치코 jen ${playerAmmo} n치boj콢`);
                return;
            }
            
            // Odeber n치boje hr치캜i
            consumeAmmo(ammoType, amount);
            
            // P콏idej n치boje spole캜n칤kovi
            if (!comp.ammo) comp.ammo = 0;
            comp.ammo += amount;
            
            notifySuccess('N치boje p콏ed치ny', `${comp.name} m치 nyn칤 ${comp.ammo} n치boj콢`);
            saveGame();
            
            showCompanionEquipment(companionId);
        }
        
        // Z칤sk치 celkov칳 stat spole캜n칤ka v캜etn캩 vybaven칤
        function confirmDismissCompanion(companionId) {
            const companion = COMPANIONS.find(c => c.id === companionId);
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            const level = comp?.level || 1;
            const displayName = comp?.name || companion?.name || 'Spole캜n칤k';
            
            showModal('Propustit spole캜n칤ka?', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${companion?.icon || '游'}</div>
                    <h3>${displayName}</h3>
                    <p style="color: #ff9800;">Level ${level}</p>
                </div>
                <p style="color: #c62828; text-align: center;">丘멆잺 Ztrat칤코 v코echny jeho dovednosti a level!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showCompanionsInfo()" style="background: #555;">仇 Ne</button>
                    <button class="btn" onclick="dismissCompanion('${companionId}'); closeModal();" style="background: #c62828;">九 Propustit</button>
                </div>
            `);
        }
        
        // Technik companion - vylep코en칤 vybaven칤 (skill Mistrovsk치 pr치ce)
        function technicianUpgradeEquipment() {
            const metalCost = 20;
            
            if ((state.resources?.metal || 0) < metalCost) {
                notifyWarning('M치lo kovu!', `Technik pot콏ebuje ${metalCost}丘뙖잺 kovu`);
                return;
            }
            
            // Vyber co vylep코it
            const hasWeapon = state.equipped?.weapon;
            const hasArmor = state.equipped?.armor;
            
            if (!hasWeapon && !hasArmor) {
                notifyWarning('콯치dn칠 vybaven칤!', 'Nasa캞 zbra켿 nebo zbroj k vylep코en칤');
                return;
            }
            
            // Z칤skej bonus od kov치콏e osadn칤ka
            const blacksmithBonus = getSettlerUpgradeBonus();
            const totalBonus = 5 + blacksmithBonus;
            const bonusText = blacksmithBonus > 0 ? ` (+${blacksmithBonus} kov치콏)` : '';
            
            showModal('丘 Technik vylep코uje', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游댢</div>
                    <p style="color: #ff9800;">Vyber vybaven칤 k vylep코en칤 (+${totalBonus}${bonusText})</p>
                    <p style="color: #888; font-size: 0.85rem;">Cena: ${metalCost}丘뙖잺 kovu</p>
                </div>
                <div style="display: grid; gap: 0.5rem;">
                    ${hasWeapon ? `
                        <button class="btn" onclick="doTechnicianUpgrade('weapon')" style="background: #ff5722;">
                            丘덢잺 ${state.equipped.weapon.name} (+${totalBonus} DMG)
                        </button>
                    ` : ''}
                    ${hasArmor ? `
                        <button class="btn" onclick="doTechnicianUpgrade('armor')" style="background: #2196f3;">
                            游띠勇 ${state.equipped.armor.name} (+${totalBonus} DEF)
                        </button>
                    ` : ''}
                    <button class="btn" onclick="showCompanionsInfo()" style="background: #555;">仇 Zru코it</button>
                </div>
            `);
        }
        
        function doTechnicianUpgrade(type) {
            const metalCost = 20;
            
            if ((state.resources?.metal || 0) < metalCost) {
                notifyWarning('M치lo kovu!', `Pot콏ebuje코 ${metalCost}丘뙖잺`);
                return;
            }
            
            state.resources.metal -= metalCost;
            
            const blacksmithBonus = getSettlerUpgradeBonus();
            const totalBonus = 5 + blacksmithBonus;
            
            if (type === 'weapon' && state.equipped?.weapon) {
                state.equipped.weapon.damage = (state.equipped.weapon.damage || 10) + totalBonus;
                state.equipped.weapon.name = state.equipped.weapon.name + ' 丘';
                notifySuccess('丘 Vylep코eno!', `${state.equipped.weapon.name}: +${totalBonus} DMG`);
            } else if (type === 'armor' && state.equipped?.armor) {
                state.equipped.armor.defense = (state.equipped.armor.defense || 5) + totalBonus;
                state.equipped.armor.name = state.equipped.armor.name + ' 丘';
                notifySuccess('丘 Vylep코eno!', `${state.equipped.armor.name}: +${totalBonus} DEF`);
            }
            
            closeModal();
            renderFull();
        }
        
        function renameCompanion(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            const companion = COMPANIONS.find(c => c.id === companionId);
            
            showModal(`九勇 ${'P콏ejmenovat spole캜n칤ka'}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${companion?.icon || comp.icon || '游'}</div>
                    <p style="color: #888;">${'Aktu치ln칤 jm칠no:'} ${comp.name}</p>
                </div>
                <input type="text" id="renameCompanionInput" value="${comp.name}" 
                       style="width: 100%; padding: 0.8rem; margin-bottom: 1rem; background: #1a1a1a; 
                              border: 2px solid var(--rust); border-radius: 8px; color: #fff; font-size: 1rem;"
                       placeholder="${'Nov칠 jm칠no...'}" maxlength="20">
                <button class="btn" onclick="confirmRenameCompanion('${companionId}')" 
                        style="width: 100%; background: var(--toxic-dark);">九 ${'P콏ejmenovat'}</button>
                <button class="btn" onclick="showCompanionsInfo()" 
                        style="width: 100%; margin-top: 0.5rem; background: #555;">九 ${'Zru코it'}</button>
            `);
        }
        
        function confirmRenameCompanion(companionId) {
            const nameInput = document.getElementById('renameCompanionInput');
            const newName = nameInput ? nameInput.value.trim() : null;
            
            if (newName && newName.length > 0) {
                const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
                if (comp) {
                    const oldName = comp.name;
                    comp.name = newName;
                    notifySuccess('P콏ejmenov치no!', `${oldName}  ${newName}`);
                    addLog(`P콏ejmenoval spole캜n칤ka: ${newName}`, comp.icon || '游');
                }
            }
            showCompanionsInfo();
        }
        
        // Dialog pro ru캜n칤 krmen칤 spole캜n칤ka
        function showFeedCompanionDialog(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            const companion = COMPANIONS.find(c => c.id === companionId);
            
            // Najdi j칤dlo a pit칤 v invent치콏i - roz코칤콏en칳 filtr
            const foodItems = state.inv.filter(i => {
                // P콏칤mo podle type
                if (i.type === 'food') return true;
                // Consumables kter칠 d치vaj칤 hunger/health/energy
                if (i.type === 'consumable') {
                    const itemData = ITEMS.find(d => d.id === i.id);
                    const effect = i.effect || itemData?.effect;
                    return effect === 'hunger' || effect === 'health' || effect === 'energy';
                }
                // P콏칤mo zkontroluj effect na itemu
                if (i.effect === 'hunger' || i.effect === 'health' || i.effect === 'energy') return true;
                return false;
            });
            
            // P콏idej syrov칠 maso z resources (jen pro zv칤콏ec칤 spole캜n칤ky)
            if ((state.resources?.raw_meat || 0) > 0) {
                foodItems.push({
                    id: 'raw_meat',
                    name: 'Syrov칠 maso',
                    icon: '游볼',
                    count: state.resources.raw_meat,
                    isResource: true // Ozna캜en칤 쬰 je to z resources
                });
            }
            
            const waterItems = state.inv.filter(i => {
                // P콏칤mo podle type
                if (i.type === 'drink' || i.type === 'water') return true;
                // Consumables kter칠 d치vaj칤 thirst
                if (i.type === 'consumable') {
                    const itemData = ITEMS.find(d => d.id === i.id);
                    const effect = i.effect || itemData?.effect;
                    return effect === 'thirst';
                }
                // P콏칤mo zkontroluj effect na itemu
                if (i.effect === 'thirst') return true;
                // Itemy s "voda/water" v n치zvu
                if (i.name?.toLowerCase().includes('voda') || i.id?.includes('water')) return true;
                return false;
            });
            
            const hpPercent = comp.maxHp > 0 ? Math.round((comp.hp / comp.maxHp) * 100) : 0;
            const needsFood = comp.hunger === undefined || comp.hunger < 100;
            const needsWater = comp.thirst === undefined || comp.thirst < 100;
            
            let html = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${companion?.icon || '游'}</div>
                    <h3 style="margin: 0;">${comp.name || companion?.name || 'Spole캜n칤k'}</h3>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span>仇벒잺 HP:</span>
                            <span style="color: ${hpPercent > 50 ? '#4caf50' : hpPercent > 25 ? '#ff9800' : '#c62828'};">${comp.hp}/${comp.maxHp}</span>
                        </div>
                        <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${hpPercent}%; background: ${hpPercent > 50 ? '#4caf50' : hpPercent > 25 ? '#ff9800' : '#c62828'};"></div>
                        </div>
                    </div>
                </div>
                
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">游꼤 D치t j칤dlo:</h4>
                <div style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem;">
            `;
            
            if (foodItems.length === 0) {
                html += `<p style="color: #666; text-align: center; padding: 0.5rem;">${currentLang === "en" ? "You have no food" : "Nem치코 쮂멳n칠 j칤dlo"}</p>`;
            } else {
                foodItems.forEach(item => {
                    const itemData = ITEMS.find(d => d.id === item.id);
                    const count = item.count || 1;
                    // Speci치ln칤 hodnota pro syrov칠 maso
                    const healAmount = item.id === 'raw_meat' ? 30 : (itemData?.value || 20);
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="font-size: 1.3rem;">${item.icon || itemData?.icon || '游꼤'}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-size: 0.9rem;">${item.name} ${count > 1 ? `<span style="color: #ffd700;">칑${count}</span>` : ''}</div>
                                <div style="color: #4caf50; font-size: 0.75rem;">+${healAmount} HP ${item.id === 'raw_meat' ? '<span style="color: #ff9800;">(syrov칠)</span>' : ''}</div>
                            </div>
                            <button class="btn" onclick="feedCompanionItem('${companionId}', '${item.id}', 'food')" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">` + (currentLang === "en" ? "Give" : "D치t") + `</button>
                        </div>
                    `;
                });
            }
            
            html += `</div>
                <h4 style="color: #2196f3; margin-bottom: 0.5rem;">游눦 D치t pit칤:</h4>
                <div style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem;">
            `;
            
            if (waterItems.length === 0) {
                html += `<p style="color: #666; text-align: center; padding: 0.5rem;">${currentLang === "en" ? "You have no drinks" : "Nem치코 쮂멳n칠 pit칤"}</p>`;
            } else {
                waterItems.forEach(item => {
                    const itemData = ITEMS.find(d => d.id === item.id);
                    const count = item.count || 1;
                    const healAmount = Math.floor((itemData?.value || 20) / 2);
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="font-size: 1.3rem;">${item.icon}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-size: 0.9rem;">${item.name} ${count > 1 ? `<span style="color: #ffd700;">칑${count}</span>` : ''}</div>
                                <div style="color: #2196f3; font-size: 0.75rem;">+${healAmount} HP</div>
                            </div>
                            <button class="btn" onclick="feedCompanionItem('${companionId}', '${item.id}', 'water')" style="background: #2196f3; padding: 0.3rem 0.6rem; font-size: 0.8rem;">` + (currentLang === "en" ? "Give" : "D치t") + `</button>
                        </div>
                    `;
                });
            }
            
            html += `</div>
                <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; background: #555;"> ${'Zp캩t'}</button>
            `;
            
            showModal(`游꼤 ${'Nakrmit'} ${comp.name || companion?.name}`, html);
        }
        
        // Nakrmit spole캜n칤ka konkr칠tn칤m itemem
        function feedCompanionItem(companionId, itemId, type) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Speci치ln칤 p콏칤pad pro raw_meat z resources
            if (itemId === 'raw_meat') {
                if ((state.resources?.raw_meat || 0) <= 0) {
                    notifyWarning('Chyba', 'Nem치코 syrov칠 maso');
                    return;
                }
                
                const healAmount = 30;
                const oldHp = comp.hp;
                comp.hp = Math.min(comp.maxHp, comp.hp + healAmount);
                const actualHeal = comp.hp - oldHp;
                
                // Odeber z resources
                state.resources.raw_meat--;
                
                // Loajalita
                const loyaltyGain = 3;
                comp.loyalty = Math.min(100, (comp.loyalty || 0) + loyaltyGain);
                comp.lastFed = true;
                comp.lastFedTime = Date.now(); // Timestamp pro 24h syst칠m
                
                const companion = COMPANIONS.find(c => c.id === companionId);
                const compName = comp.name || companion?.name || 'Spole캜n칤k';
                
                notifySuccess(`${compName} nakrmen!`, `+${actualHeal} HP, +${loyaltyGain} 仇벒잺 loajalita`);
                addLog(`游볼 ${compName} nakrmen syrov칳m masem: +${actualHeal} HP, +${loyaltyGain} 仇벒잺`, companion?.icon || '游');
                
                // Daily quest progress
                if (state.dailyQuests?.progress) {
                    state.dailyQuests.progress.fedCompanion = (state.dailyQuests.progress.fedCompanion || 0) + 1;
                    checkDailyQuests();
                }
                
                saveGame();
                showFeedCompanionDialog(companionId);
                return;
            }
            
            const item = state.inv.find(i => i.id === itemId);
            if (!item) {
                notifyWarning('Chyba', 'Item nenalezen');
                return;
            }
            
            const itemData = ITEMS.find(d => d.id === itemId);
            const healAmount = type === 'food' ? (itemData?.value || 20) : Math.floor((itemData?.value || 20) / 2);
            
            // P콏idej HP
            const oldHp = comp.hp;
            comp.hp = Math.min(comp.maxHp, comp.hp + healAmount);
            const actualHeal = comp.hp - oldHp;
            
            // Nastav stav nakrmen칤/napojen칤 + timestamp
            const now = Date.now();
            if (type === 'food') {
                comp.lastFed = true;
                comp.lastFedTime = now;
            } else if (type === 'water') {
                comp.lastWatered = true;
                comp.lastWateredTime = now;
            }
            
            // === P콎IDEJ LOAJALITU ===
            const loyaltyGain = type === 'food' ? 3 : 2;
            comp.loyalty = Math.min(100, (comp.loyalty || 0) + loyaltyGain);
            
            // Odeber item - najdi ho znovu podle indexu pro jistotu
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex !== -1) {
                const invItem = state.inv[itemIndex];
                if (invItem.count && invItem.count > 1) {
                    invItem.count--;
                } else {
                    state.inv.splice(itemIndex, 1);
                }
            }
            
            const companion = COMPANIONS.find(c => c.id === companionId);
            const compName = comp.name || companion?.name || 'Spole캜n칤k';
            
            const actionText = type === 'food' ? 'nakrmen' : 'napojen';
            notifySuccess(`${compName} ${actionText}!`, `+${actualHeal} HP, +${loyaltyGain} 仇벒잺 loajalita`);
            addLog(`${type === 'food' ? '游꼤' : '游눦'} ${compName} ${actionText}: +${actualHeal} HP, +${loyaltyGain} 仇벒잺`, companion?.icon || '游');
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.fedCompanion = (state.dailyQuests.progress.fedCompanion || 0) + 1;
                checkDailyQuests();
            }
            
            saveGame();
            showFeedCompanionDialog(companionId);
        }
        
        // Denn칤 spot콏eba j칤dla a vody pro spole캜n칤ky (ka쬯칳ch 24 hodin re치ln칠ho 캜asu)
        function feedCompanions() {
            if (!state.companions || state.companions.length === 0) return;
            
            const now = Date.now();
            const DAY_MS = 24 * 60 * 60 * 1000; // 24 hodin v ms
            
            const aliveCompanions = state.companions.filter(c => !c.isDead);
            if (aliveCompanions.length === 0) return;
            
            let fedCompanions = [];
            let hungryCompanions = [];
            
            aliveCompanions.forEach(comp => {
                // Inicializace timestamp콢 pokud chyb칤
                if (!comp.lastFedTime) comp.lastFedTime = now;
                if (!comp.lastWateredTime) comp.lastWateredTime = now;
                
                // Zkontroluj jestli uplynulo 24 hodin od posledn칤ho nakrmen칤
                const needsFood = (now - comp.lastFedTime) >= DAY_MS;
                const needsWater = (now - comp.lastWateredTime) >= DAY_MS;
                
                if (!needsFood && !needsWater) {
                    // Je코t캩 nepot콏ebuje krmit
                    return;
                }
                
                let fed = !needsFood; // Pokud nepot콏ebuje, pova쬿j za najeden칠ho
                let watered = !needsWater;
                
                // Pot콏ebuje j칤dlo?
                if (needsFood) {
                    const foodItems = state.inv.filter(i => {
                        const itemData = ITEMS.find(d => d.id === i.id);
                        return itemData && itemData.type === 'consumable' && itemData.effect === 'hunger';
                    });
                    
                    if (foodItems.length > 0) {
                        const food = foodItems[0];
                        if (food.count && food.count > 1) {
                            food.count--;
                        } else {
                            state.inv = state.inv.filter(i => i !== food);
                        }
                        fed = true;
                        comp.lastFed = true;
                        comp.lastFedTime = now;
                    } else {
                        comp.lastFed = false;
                    }
                }
                
                // Pot콏ebuje vodu?
                if (needsWater) {
                    const waterItems = state.inv.filter(i => {
                        const itemData = ITEMS.find(d => d.id === i.id);
                        return itemData && itemData.type === 'consumable' && itemData.effect === 'thirst';
                    });
                    
                    if (waterItems.length > 0) {
                        const water = waterItems[0];
                        if (water.count && water.count > 1) {
                            water.count--;
                        } else {
                            state.inv = state.inv.filter(i => i !== water);
                        }
                        watered = true;
                        comp.lastWatered = true;
                        comp.lastWateredTime = now;
                    } else {
                        comp.lastWatered = false;
                    }
                }
                
                if (fed && watered) {
                    fedCompanions.push(comp.name);
                } else {
                    hungryCompanions.push(comp.name);
                    // Penalizace za hlad/쮂셬e켿
                    if (!fed) {
                        comp.hp = Math.max(1, (comp.hp || comp.maxHp || 50) - 10);
                    }
                    if (!watered) {
                        comp.hp = Math.max(1, (comp.hp || comp.maxHp || 50) - 15);
                    }
                }
            });
            
            // Notifikace
            if (fedCompanions.length > 0) {
                addLog(`游꼤游눦 Spole캜n칤ci nakrmeni: ${fedCompanions.join(', ')}`, '游');
            }
            if (hungryCompanions.length > 0) {
                notifyWarning('Hladov칤 spole캜n칤ci!', `${hungryCompanions.join(', ')} nemaj칤 co j칤st/p칤t!`);
                addLog(`丘멆잺 Hladov칤 spole캜n칤ci: ${hungryCompanions.join(', ')}`, '游땩');
                // Push notifikace na mobil
                MobileNotifications.notifyCompanionHungry(hungryCompanions.join(', '));
            }
            
            updateCarryWeight();
        }
        
        // === RYBA콎EN칈 ===
        function startFishing(skipLocationCheck = false) {
            // Hledej jak칳koliv prut - podle ID nebo bonus === 'fishing'
            const hasFishingRod = state.inv.find(i => 
                i.id === 'fishing_rod' || 
                i.id === 'fishing_rod_uncommon' || 
                i.id?.includes('fishing_rod') ||
                i.bonus === 'fishing' ||
                i.name?.toLowerCase().includes('prut')
            );
            
            if (!hasFishingRod) {
                showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 游꿖 Ryb치콏sk칳 prut pro ryba콏en칤!');
                return;
            }
            
            if (!skipLocationCheck) {
                // Nov칳 syst칠m - kontrola zda lokace umo쮄갓je ryba콏en칤
                const currentLoc = getCurrentLocation();
                const canFish = currentLoc?.actions?.includes('fish') || 
                               currentLoc?.resource === 'water' || 
                               currentLoc?.id === 'small_pond' ||
                               currentLoc?.type === 'resource' && currentLoc?.id?.includes('pond');
                if (!canFish) {
                    showModal('仇 맗atn칠 m칤sto', 'M콢쬰코 ryba콏it pouze u vody (rybn칤k, jezero)!');
                    return;
                }
            }
            
            // Pokud p콏eskakujeme kontrolu (z timed action), rovnou dej v칳sledek
            if (skipLocationCheck) {
                completeFishing();
                return;
            }
            
            showModal('游꿖 Ryba콏en칤...', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; animation: bounce 1s infinite;">游꿖</div>
                    <p>캛ek치코 na 칰lovek...</p>
                    <div class="progress-bar" style="margin: 1rem 0;">
                        <div id="fishingProgress" style="width: 0%; height: 20px; background: #2196f3; border-radius: 10px; transition: width 0.1s;"></div>
                    </div>
                </div>
            `);
            
            let progress = 0;
            const fishingInterval = setInterval(() => {
                progress += 2;
                const progressBar = document.getElementById('fishingProgress');
                if (progressBar) progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(fishingInterval);
                    completeFishing();
                }
            }, 100);
        }
        
        function completeFishing() {
            const skillBonus = (state.skills_secondary?.fishing || 0) * 0.05;
            
            // Bonus z ryb치콏sk칠ho prutu - hledej jak칳koliv prut
            let rodBonus = 0;
            const rod = state.inv.find(i => 
                i.bonus === 'fishing' || 
                i.id?.includes('fishing_rod') ||
                i.name?.toLowerCase().includes('prut')
            );
            if (rod) {
                const rodData = ITEMS.find(it => it.id === rod.id);
                // Vy코코칤 rarita = vy코코칤 bonus
                let rarityMultiplier = 1;
                const rarity = rod.rarity || rodData?.rarity || 'common';
                if (rarity === 'uncommon') rarityMultiplier = 1.5;
                else if (rarity === 'rare') rarityMultiplier = 2;
                else if (rarity === 'epic') rarityMultiplier = 2.5;
                else if (rarity === 'legendary') rarityMultiplier = 3;
                
                rodBonus = ((rodData?.bonusValue || rod.bonusValue || 1) * 0.05) * rarityMultiplier;
            }
            
            const roll = Math.random() + skillBonus + rodBonus;
            
            // 30% 코ance 쬰 nic nechyt칤코 (sn칤쬰no bonusem z prutu)
            const failChance = Math.max(0.10, 0.30 - rodBonus);
            if (Math.random() < failChance) {
                showModal('游꿖 Nic!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游깱</div>
                        <p style="color: #888;">Tentokr치t nic... Ryby jsou chyt콏ej코칤.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showActionModal('fish');" style="width: 100%; margin-top: 0.5rem;">游꿖 Zkusit znovu</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                `);
                return;
            }
            
            let caught = null;
            let cumulative = 0;
            
            for (const fish of FISH_TYPES) {
                cumulative += fish.chance;
                if (roll < cumulative) {
                    caught = fish;
                    break;
                }
            }
            
            if (!caught) caught = FISH_TYPES[0]; // Fallback na malou rybu
            
            // Zvy코 fishing skill
            state.skills_secondary = state.skills_secondary || { fishing: 0, mining: 0, hunting: 0, cooking: 0, alchemy: 0 };
            state.skills_secondary.fishing = Math.min(10, (state.skills_secondary.fishing || 0) + 0.1);
            
            if (caught.junk) {
                showModal('游꿖 칔lovek!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">${caught.icon}</div>
                        <p>Chytil jsi ${caught.name}... to nen칤 moc u쬴te캜n칠.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            if (caught.special === 'treasure') {
                const money = Math.floor(Math.random() * 200) + 100;
                addMoney(money);
                const rareItem = ITEMS.filter(i => i.rarity === 'rare')[Math.floor(Math.random() * ITEMS.filter(i => i.rarity === 'rare').length)];
                if (rareItem && canAddItem(rareItem, 1)) {
                    state.inv.push({...rareItem, count: 1});
                }
                showModal('游꿖 POKLAD!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游닍</div>
                        <p style="color: #ffd700;">Vyt치hl jsi truhli캜ku s pokladem!</p>
                        <p>+${money} 游눯</p>
                        ${rareItem ? `<p>+${rareItem.icon} ${rareItem.name}</p>` : ''}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${currentLang === "en" ? "Great!" : "Skv캩l칠!"}</button>
                `);
                return;
            }
            
            if (caught.special === 'wish') {
                showModal('游꿖 ZLAT츼 RYBKA!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">九뻟릟九</div>
                        <p style="color: #ffd700;">Chytil jsi zlatou rybku! Spln칤 ti p콏치n칤!</p>
                    </div>
                    <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="wishHealth()" style="background: #c62828;">仇벒잺 ${currentLang === "en" ? "Full health" : "Pln칠 zdrav칤"}</button>
                        <button class="btn" onclick="wishMoney()" style="background: #ffd700; color: #000;">游눯 500 pen캩z</button>
                        <button class="btn" onclick="wishXP()" style="background: #9c27b0;">救 200 XP</button>
                    </div>
                `);
                return;
            }
            
            // Norm치ln칤 ryba
            state.resources.fish = (state.resources.fish || 0) + 1;
            markFoodAsNew('fish');
            if (caught.radiation) {
                state.status.radiation = Math.min(100, state.status.radiation + caught.radiation);
            }
            
            showModal('游꿖 칔lovek!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${caught.icon}</div>
                    <h3>${caught.name}</h3>
                    <p style="color: #8bc34a;">+1 ryba</p>
                    <p style="color: #999;">Hodnota: ${caught.value} 游눯</p>
                    ${caught.radiation ? `<p style="color: #ff9800;">+${caught.radiation} radiace</p>` : ''}
                </div>
                <button class="btn" onclick="closeModal(); showActionModal('fish');" style="width: 100%; margin-top: 0.5rem;">游꿖 Ryba콏it znovu</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
            `);
        }
        
        function wishHealth() { state.char.hp = state.char.maxHp; closeModal(); addLog('Zlat치 rybka ti vyl칠캜ila v코echna zran캩n칤!', '九'); }
        function wishMoney() { addMoney(500); closeModal(); addLog('Zlat치 rybka ti dala 500 pen캩z!', '九'); }
        function wishXP() { addXP(200); closeModal(); addLog('Zlat치 rybka ti dala 200 XP!', '九'); }
        
        // === 캛ASOVAN칄 AKCE ===
        function calculateActionTimeModifier(actionType) {
            let modifier = 1.0;
            
            // Po캜as칤
            const weather = getCurrentWeather();
            if (weather) {
                if (weather.id === 'rain') modifier *= 1.3;
                else if (weather.id === 'storm') modifier *= 1.5;
                else if (weather.id === 'fog') modifier *= 1.2;
                else if (weather.id === 'radstorm') modifier *= 1.4;
            }
            
            // Skilly postavy
            const per = state.char.attrs?.per || 5;
            const agi = state.char.attrs?.agi || 5;
            const str = state.char.attrs?.str || 5;
            
            // R콢zn칠 skilly pro r콢zn칠 akce
            if (actionType === 'hunt') {
                modifier *= 1 - ((per - 5) * 0.05); // Vn칤mavost zrychluje lov
            } else if (actionType === 'mine') {
                modifier *= 1 - ((str - 5) * 0.05); // S칤la zrychluje t캩쬭u
            } else if (actionType === 'explore') {
                modifier *= 1 - ((per - 5) * 0.04); // Vn칤mavost zrychluje pr콢zkum
                modifier *= 1 - ((agi - 5) * 0.03); // Obratnost tak칠
            } else if (actionType === 'fish') {
                const lck = state.char.attrs?.lck || 5;
                modifier *= 1 - ((lck - 5) * 0.04); // 맚캩st칤 zrychluje rybolov
            }
            
            // Skill fast_travel sni쬿je 캜as v코ech akc칤
            const fastTravelLevel = state.skills?.['fast_travel'] || 0;
            if (fastTravelLevel > 0) {
                modifier *= 1 - (fastTravelLevel * 0.05);
            }
            
            // Minimum 0.5, maximum 2.0
            return Math.max(0.5, Math.min(2.0, modifier));
        }
        
        // P콏eklad n치zvu akce
        function getActionName(actionType) {
            const names = {
                'hunt': 'lov',
                'mine': 't캩쬭u',
                'fish': 'ryba콏en칤',
                'explore': 'pr콢zkum',
                'gather': 'sb캩r'
            };
            return names[actionType] || actionType;
        }
        
        function startTimedAction(actionType) {
            console.log('startTimedAction called with:', actionType);
            
            // Kontrola zda neprob칤h치 cestov치n칤
            if (state.world.traveling || state.map.traveling) {
                notifyWarning('Cestuje코!', 'Nejd콏칤ve dokon캜i nebo zru코 cestov치n칤!');
                return;
            }
            
            // Kontrola zda u neprob칤h치 jin치 akce
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                notifyWarning('Akce prob칤h치', 'Nejd콏칤ve dokon캜i nebo zru코 prob칤haj칤c칤 akci!');
                return;
            }
            
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // Kontrola vybaven칤 P콎ED zapo캜et칤m akce
            if (actionType === 'hunt') {
                const huntingWeapon = state.inv.find(i => 
                    i.id === 'hunting_bow' || i.id === 'crossbow' || i.id === 'wooden_bow' || i.id === 'bow' ||
                    (i.type === 'weapon' && i.icon === '游낓')
                );
                if (!huntingWeapon) {
                    showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 游낓 Luk nebo Ku코i pro lov!');
                    return;
                }
                // Kontrola 코칤p콢/코ipek
                if (huntingWeapon.ammoType) {
                    const ammoCount = getAmmoCount(huntingWeapon.ammoType);
                    if (ammoCount < 1) {
                        showModal('仇 Chyb칤 munice', `Pot콏ebuje코 ${getAmmoName(huntingWeapon.ammoType)} pro ${huntingWeapon.name}!`);
                        return;
                    }
                }
            }
            if (actionType === 'mine') {
                if (!state.inv.find(i => i.id === 'pickaxe')) {
                    showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 久勇 Krump치캜 pro t캩쬭u!');
                    return;
                }
            }
            if (actionType === 'fish') {
                const hasFishingRod = state.inv.find(i => 
                    i.id === 'fishing_rod' || 
                    i.id === 'fishing_rod_uncommon' || 
                    i.id?.includes('fishing_rod') ||
                    i.bonus === 'fishing' ||
                    i.name?.toLowerCase().includes('prut')
                );
                if (!hasFishingRod) {
                    showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 游꿖 Ryb치콏sk칳 prut pro rybolov!');
                    return;
                }
            }
            if (actionType === 'alchemy') {
                if (!state.inv.find(i => i.id === 'alchemy_set')) {
                    showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 丘勇 Alchymistickou sadu!');
                    return;
                }
                // Kontrola surovin
                const herbs = state.resources?.herbs || 0;
                const chemicals = state.resources?.chemicals || 0;
                if (herbs + chemicals < 2) {
                    showModal('仇 Nedostatek surovin', `Pot콏ebuje코 alespo켿 2 suroviny (byliny nebo chemik치lie).<br><br>M치코: 游 ${herbs} bylin, 游빍 ${chemicals} chemik치li칤`);
                    return;
                }
            }
            
            // Kontrola energie P콎ED ode캜ten칤m pokusu
            if (state.status.energy < 10) {
                showModal('仇 Vy캜erp치n칤', 'Nem치코 dost energie! Pot콏ebuje코 alespo켿 10 丘');
                return;
            }
            
            // Kontrola a pou쬴t칤 denn칤ho limitu
            const limitedActions = ['hunt', 'mine', 'fish', 'explore', 'gather'];
            if (limitedActions.includes(actionType) && location) {
                const limit = checkDailyActionLimit(actionType, location.id);
                if (!limit.canDo) {
                    notifyWarning('Denn칤 limit', 'Tuto akci zde u nelze prov칠st (3/3)');
                    return;
                }
                useActionLimit(actionType, location.id);
            }
            
            const timeModifier = calculateActionTimeModifier(actionType);
            console.log('timeModifier:', timeModifier);
            // Z치kladn칤 캜asy v minut치ch
            const baseTimes = { hunt: 5, mine: 4, fish: 6, explore: 5, gather: 3, alchemy: 7 };
            const baseTime = baseTimes[actionType] || 5;
            const actualTime = Math.max(1, Math.round(baseTime * timeModifier));
            const durationMs = actualTime * 60 * 1000; // Minuty na ms
            
            // Ulo stav akce
            state.currentAction = {
                type: actionType,
                startTime: Date.now(),
                duration: durationMs,
                endTime: Date.now() + durationMs
            };
            
            // Auto-save aby se akce zachovala p콏i refreshi
            saveGame(true);
            
            // Aktualizuj UI aby se zak치zaly ostatn칤 akce
            renderFull();
            
            // Zobraz progress (v minut치ch)
            showActionProgress(actionType, actualTime);
        }
        
        // Obnoven칤 prob칤haj칤c칤 akce po refreshi/na캜ten칤 hry
        function resumeCurrentAction() {
            if (!state.currentAction) return;
            
            const now = Date.now();
            const action = state.currentAction;
            
            // Akce u skon캜ila b캩hem doby co byla str치nka zav콏en치
            if (now >= action.endTime) {
                console.log('낋 Akce dokon캜ena b캩hem offline:', action.type);
                // Dokon캜i akci
                setTimeout(() => completeTimedAction(action.type), 500);
                return;
            }
            
            // Akce st치le prob칤h치 - obnov ji
            const remainingMs = action.endTime - now;
            const remainingMins = Math.ceil(remainingMs / 60000);
            console.log(`郊윒잺 Obnovuji akci: ${action.type}, zb칳v치 ${remainingMins} min`);
            
            // Spus콘 progress tracking (bez zobrazen칤 modalu)
            showActionProgress(action.type, remainingMins, true);
            
            // Informuj hr치캜e
            const icons = { hunt: '游낓', mine: '久勇', fish: '游꿖', explore: '游댌', gather: '游빜' };
            const names = { hunt: 'Lov', mine: 'T캩쬭a', fish: 'Rybolov', explore: 'Pr콢zkum', gather: 'Sb칤r치n칤' };
            notifySuccess(
                'Akce obnovena',
                `${icons[action.type]} ${names[action.type]} pokra캜uje...`
            );
        }
        
        function showActionProgress(actionType, totalMinutes, isResumed = false) {
            const icons = { hunt: '游낓', mine: '久勇', fish: '游꿖', explore: '游댌', gather: '游빜', alchemy: '丘勇' };
            const names = { hunt: 'Lov', mine: 'T캩쬭a', fish: 'Rybolov', explore: 'Pr콢zkum', gather: 'Sb칤r치n칤', alchemy: 'Alchymie' };
            
            // Spust칤me interval pro kontrolu dokon캜en칤 A aktualizaci UI
            const checkProgress = () => {
                if (!state.currentAction || state.currentAction.type !== actionType) return;
                
                const now = Date.now();
                if (now >= state.currentAction.endTime) {
                    completeTimedAction(actionType);
                } else {
                    setTimeout(checkProgress, 1000); // Ka쬯ou sekundu
                }
                
                // P콏ekresli mapu kv콢li progress baru KA콯DOU SEKUNDU
                if (state.activeTab === 'map' && document.getElementById('mapContainer')) {
                    const modal = document.getElementById('modal');
                    if (!modal?.classList.contains('show')) {
                        renderWorldMap();
                    }
                }
            };
            
            // Spus콘 kontrolu na pozad칤
            setTimeout(checkProgress, 1000);
            
            // P콏ekresli mapu aby se zobrazil progress bar
            renderWorldMap();
            
            // Po refreshi nezobrazuj modal znovu, jen ti코e pokra캜uj
            if (isResumed) return;
            
            // Zobraz velk칳 modal s progress barem
            const now = Date.now();
            const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            
            showModal(icons[actionType] + ' ' + names[actionType], `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${icons[actionType]}</div>
                    <p style="margin-bottom: 1rem;">Prob칤h치 ${names[actionType].toLowerCase()}...</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="height: 20px; background: #333; border-radius: 10px; overflow: hidden;">
                            <div id="actionProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.3s;"></div>
                        </div>
                        <p id="actionProgressText" style="margin: 0.5rem 0 0 0; color: #ffd700; font-size: 1.2rem;">${mins}:${String(secs).padStart(2, '0')}</p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #4caf50;">九 Zav콏칤t (b캩쮂 na pozad칤)</button>
                        <button class="btn" onclick="cancelTimedAction()" style="flex: 1; background: #c62828;">仇 Zru코it</button>
                    </div>
                    <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem;">Progress bar vid칤코 nad mapou</p>
                </div>
            `);
            
            // Update progress bar v modalu
            const updateModalProgress = () => {
                if (!state.currentAction || state.currentAction.type !== actionType) return;
                
                const now = Date.now();
                const elapsed = now - state.currentAction.startTime;
                const progress = Math.min(100, (elapsed / state.currentAction.duration) * 100);
                const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
                
                const progressBar = document.getElementById('actionProgressBar');
                const progressText = document.getElementById('actionProgressText');
                
                if (progressBar) progressBar.style.width = progress + '%';
                if (progressText) {
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    progressText.textContent = `${mins}:${String(secs).padStart(2, '0')}`;
                }
                
                if (progress < 100 && progressBar) {
                    setTimeout(updateModalProgress, 100);
                }
            };
            
            setTimeout(updateModalProgress, 100);
        }
        
        // Zobraz칤 modal s progress barem pro akce (kliknut칤m na progress bar)
        function showActionProgressModal() {
            if (!state.currentAction) return;
            
            const icons = { hunt: '游낓', mine: '久勇', fish: '游꿖', explore: '游댌', gather: '游빜' };
            const names = { hunt: 'Lov', mine: 'T캩쬭a', fish: 'Rybolov', explore: 'Pr콢zkum', gather: 'Sb칤r치n칤' };
            const actionType = state.currentAction.type;
            
            const now = Date.now();
            const elapsed = now - state.currentAction.startTime;
            const progress = Math.min(100, (elapsed / state.currentAction.duration) * 100);
            const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            
            showModal(icons[actionType] + ' ' + names[actionType], `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${icons[actionType]}</div>
                    <p style="margin-bottom: 1rem;">Prob칤h치 ${names[actionType].toLowerCase()}...</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="height: 20px; background: #333; border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #4caf50, #8bc34a);"></div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #ffd700; font-size: 1.2rem;">${mins}:${String(secs).padStart(2, '0')}</p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #4caf50;">九 Zav콏칤t (b캩쮂 na pozad칤)</button>
                        <button class="btn" onclick="cancelTimedAction()" style="flex: 1; background: #c62828;">仇 Zru코it</button>
                    </div>
                </div>
            `);
        }
        
        function cancelTimedAction() {
            // Potvrzovac칤 dialog
            const confirmTitle = '丘멆잺 Zru코it akci?';
            const confirmText = 'Opravdu chce코 zru코it tuto akci? Toto se po캜칤t치 jako vyu쬴t칤 denn칤ho limitu!';
            
            showModal(confirmTitle, `
                <div style="text-align: center;">
                    <p style="color: #ff9800; margin-bottom: 1rem;">${confirmText}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">
                             ${'Zp캩t'}
                        </button>
                        <button class="btn" onclick="confirmCancelTimedAction()" style="background: #c62828;">
                            仇 ${'Ano, zru코it'}
                        </button>
                    </div>
                </div>
            `);
        }
        
        function confirmCancelTimedAction() {
            state.currentAction = null;
            closeModal();
            notifyWarning('Akce zru코ena');
            renderWorldMap();
        }
        
        function completeTimedAction(actionType) {
            const icons = { hunt: '游낓', mine: '久勇', fish: '游꿖', explore: '游댌', gather: '游빜', alchemy: '丘勇' };
            const names = { hunt: 'Lov', mine: 'T캩쬭a', fish: 'Rybolov', explore: 'Pr콢zkum', gather: 'Sb칤r치n칤', alchemy: 'Alchymie' };
            
            state.currentAction = null;
            
            // Notifikace o dokon캜en칤
            notifySuccess(`${icons[actionType]} ${names[actionType]} dokon캜en!`, '');
            
            // Spus콘 skute캜nou akci
            if (actionType === 'hunt') {
                executeHunting();
            } else if (actionType === 'mine') {
                executeMining();
            } else if (actionType === 'fish') {
                executeFishing();
            } else if (actionType === 'explore') {
                executeExploring();
            } else if (actionType === 'gather') {
                executeGathering();
            } else if (actionType === 'alchemy') {
                executeAlchemy();
            }
            
            // P콏ekresli mapu
            renderWorldMap();
        }
        
        function executeHunting() {
            startHunting();
        }
        
        function executeMining() {
            startMining();
        }
        
        function executeFishing() {
            startFishing(true); // true = skip location check (already done)
        }
        
        function executeGathering() {
            // Spust칤 sb칤r치n칤 - limit u je odebr치n v startTimedAction
            gatherResources(true); // true = skip limit check
        }
        
        function executeExploring() {
            // Mal칠 zpo쬯캩n칤 aby se spr치vn캩 zav콏el p콏edchoz칤 modal
            setTimeout(() => {
                exploreLocation(true); // Skip limit check - already done in startTimedAction
            }, 100);
        }
        
        function executeAlchemy() {
            // Kontrola alchymistick칠 sady
            if (!state.inv.find(i => i.id === 'alchemy_set')) {
                showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 丘勇 Alchymistickou sadu!');
                return;
            }
            
            // Zjisti dostupn칠 suroviny
            const herbs = state.resources?.herbs || 0;
            const chemicals = state.resources?.chemicals || 0;
            const totalMaterials = herbs + chemicals;
            
            if (totalMaterials < 2) {
                showModal('丘勇 Nedostatek surovin', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游</div>
                        <p style="color: #888;">Nem치코 dostatek bylin nebo chemik치li칤.</p>
                        <p style="color: #666; font-size: 0.85rem;">M치코: 游 ${herbs} bylin, 游빍 ${chemicals} chemik치li칤</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">OK</button>
                `);
                return;
            }
            
            // Skill bonus
            const alchemySkill = state.skills_secondary?.alchemy || 0;
            const skillBonus = alchemySkill * 0.1; // +10% za level
            
            // Ur캜칤me co vyrob칤me podle dostupn칳ch surovin
            let results = [];
            let herbsUsed = 0;
            let chemsUsed = 0;
            
            // Z치kladn칤 코ance na r콢zn칠 produkty
            const roll = Math.random() + skillBonus;
            
            // Spot콏eba surovin (2-4 podle skillu)
            const baseConsumption = Math.max(2, Math.floor(4 - alchemySkill * 0.3));
            
            if (roll > 0.85 && chemicals >= 2 && herbs >= 2) {
                // Vz치cn칠 - RadAway
                results.push({ id: 'radaway', name: 'RadAway', icon: '驕뮖잺', count: 1 });
                herbsUsed = 2;
                chemsUsed = 2;
            } else if (roll > 0.6 && herbs >= 2) {
                // L칠k치rni캜ka
                results.push({ id: 'medkit', name: 'L칠k치rni캜ka', icon: '丘됊잺', count: 1 });
                herbsUsed = 2;
                chemsUsed = Math.min(1, chemicals);
            } else if (roll > 0.4 && chemicals >= 2) {
                // Stimpak
                results.push({ id: 'stimpack', name: 'Stimpak', icon: '游눌', count: 1 });
                herbsUsed = Math.min(1, herbs);
                chemsUsed = 2;
            } else if (herbs >= 1) {
                // Z치kladn칤 band치
                results.push({ id: 'bandage', name: 'Band치', icon: '游뽗', count: 1 + Math.floor(Math.random() * 2) });
                herbsUsed = Math.min(baseConsumption, herbs);
                chemsUsed = 0;
            } else {
                // Jen chemik치lie - antidotum
                results.push({ id: 'antidote', name: 'Antidotum', icon: '游눍', count: 1 });
                herbsUsed = 0;
                chemsUsed = Math.min(baseConsumption, chemicals);
            }
            
            // Bonus 코ance na extra item p콏i vysok칠m skillu
            if (alchemySkill >= 3 && Math.random() < 0.25) {
                results.push({ id: 'bandage', name: 'Band치', icon: '游뽗', count: 1 });
            }
            
            // Ode캜ti suroviny
            state.resources.herbs = Math.max(0, herbs - herbsUsed);
            state.resources.chemicals = Math.max(0, chemicals - chemsUsed);
            
            // P콏idej v칳sledky do invent치콏e
            results.forEach(item => {
                const existing = state.inv.find(i => i.id === item.id);
                if (existing) {
                    existing.count = (existing.count || 1) + item.count;
                } else {
                    const itemDef = ITEMS.find(i => i.id === item.id) || {};
                    state.inv.push({
                        id: item.id,
                        name: item.name,
                        icon: item.icon,
                        type: 'consumable',
                        effect: itemDef.effect || 'hp',
                        value: itemDef.value || 20,
                        count: item.count,
                        weight: itemDef.weight || 0.3
                    });
                }
            });
            
            // Zvy코 alchemy skill
            state.skills_secondary.alchemy = Math.min(10, (state.skills_secondary.alchemy || 0) + 0.15);
            
            // Statistiky
            state.stats.itemsCrafted = (state.stats.itemsCrafted || 0) + results.reduce((sum, r) => sum + r.count, 0);
            
            // V칳sledn칳 modal
            let resultsHtml = results.map(r => `<div style="display: flex; align-items: center; gap: 0.5rem; margin: 0.3rem 0;">
                <span style="font-size: 1.5rem;">${r.icon}</span>
                <span>${r.name} x${r.count}</span>
            </div>`).join('');
            
            showModal('丘勇 Alchymie dokon캜ena!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">丘勇</div>
                </div>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">Vyrobeno:</h4>
                    ${resultsHtml}
                </div>
                <p style="color: #888; font-size: 0.85rem; text-align: center;">
                    Spot콏ebov치no: 游 ${herbsUsed} bylin, 游빍 ${chemsUsed} chemik치li칤
                </p>
                <p style="color: #666; font-size: 0.8rem; text-align: center;">
                    Zb칳v치: 游 ${state.resources.herbs} bylin, 游빍 ${state.resources.chemicals} chemik치li칤
                </p>
                <button class="btn" onclick="closeModal(); showActionModal('alchemy');" style="width: 100%; margin-top: 0.5rem;">丘勇 M칤chat znovu</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Hotovo</button>
            `);
            
            checkAchievements();
        }
        
        // === T캨콯BA ===
        function startMining() {
            // Kontrola krump치캜e
            if (!state.inv.find(i => i.id === 'pickaxe')) {
                showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 久勇 Krump치캜 pro t캩쬭u!');
                return;
            }
            
            // 30% 코ance 쬰 nic nenajde코
            if (Math.random() < 0.30) {
                showModal('久勇 Nic!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游뿯</div>
                        <p style="color: #888;">Jen pr치zdn치 sk치la... Zkus jinde.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showActionModal('mine');" style="width: 100%; margin-top: 0.5rem;">久勇 Zkusit znovu</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                `);
                return;
            }
            
            const skillBonus = (state.skills_secondary?.mining || 0) * 0.05;
            const roll = Math.random() + skillBonus;
            
            let found = null;
            let cumulative = 0;
            
            for (const ore of ORES) {
                cumulative += ore.chance;
                if (roll < cumulative) {
                    found = ore;
                    break;
                }
            }
            
            if (!found) found = ORES[0]; // Fallback na 쬰lezo
            
            // Zvy코 mining skill
            state.skills_secondary.mining = Math.min(10, (state.skills_secondary.mining || 0) + 0.1);
            
            // P콏idej surovinu
            if (found.smeltTo) {
                state.resources[found.smeltTo] = (state.resources[found.smeltTo] || 0) + 1;
            }
            
            // Bonusov치 코ance na m캩캞 (15%)
            if (Math.random() < 0.15) {
                state.resources.copper = (state.resources.copper || 0) + 1;
                addLog('+1 游릯 M캩캞 (bonus)', '游릯');
            }
            
            if (found.radiation) {
                state.status.radiation = Math.min(100, state.status.radiation + found.radiation);
            }
            
            showModal('久勇 Vyt캩쬰no!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${found.icon}</div>
                    <h3>${found.name}</h3>
                    <p style="color: #8bc34a;">+1 ${found.smeltTo}</p>
                    ${found.radiation ? `<p style="color: #ff9800;">+${found.radiation} radiace</p>` : ''}
                </div>
                <button class="btn" onclick="closeModal(); showActionModal('mine');" style="width: 100%; margin-top: 0.5rem;">久勇 T캩쬴t znovu</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
            `);
        }
        
        // === LOV ===
        function startHunting() {
            // Povolen칠 zbran캩 pro lov: loveck칳 luk, ku코e, d콏ev캩n칳 luk, nebo jak치koliv zbra켿 s ikonou 游낓
            const huntingWeapon = state.inv.find(i => 
                i.id === 'hunting_bow' || 
                i.id === 'crossbow' || 
                i.id === 'wooden_bow' ||
                i.id === 'bow' ||
                (i.type === 'weapon' && i.icon === '游낓')
            );
            
            if (!huntingWeapon) {
                showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 luk nebo ku코i pro lov! 游낓');
                return;
            }
            
            // Vyber zv칤콏e
            const animal = HUNTABLE_ANIMALS[Math.floor(Math.random() * HUNTABLE_ANIMALS.length)];
            
            showModal(('游낓 Lov: ') + animal.name, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${animal.icon}</div>
                    <p>Spat콏il jsi ${animal.name}!</p>
                    <p style="color: #999;">HP: ${animal.hp} | Rychlost: ${animal.speed}</p>
                    ${animal.aggressive ? '<p style="color: #ff9800;">丘멆잺 Agresivn칤 - m콢쬰 za칰to캜it!</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="huntAnimal('${animal.id}')" style="background: #c62828;">游낓 St콏칤let</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">游끢 Nechat b칳t</button>
                </div>
            `);
        }
        
        function huntAnimal(animalId) {
            const animal = HUNTABLE_ANIMALS.find(a => a.id === animalId);
            if (!animal) {
                console.error('huntAnimal: Animal not found:', animalId);
                notifyError('Chyba', 'Zv칤콏e nebylo nalezeno.');
                return;
            }
            
            // Spot콏eba 코칤p콢/코ipek - zkontroluj EQUIPPED weapon
            const equippedWeapon = state.equipped?.weapon;
            const huntingWeapon = equippedWeapon && (
                equippedWeapon.id === 'hunting_bow' || equippedWeapon.id === 'crossbow' || 
                equippedWeapon.id === 'wooden_bow' || equippedWeapon.id === 'bow' ||
                equippedWeapon.ammoType === 'arrow' || equippedWeapon.ammoType === 'bolt'
            ) ? equippedWeapon : state.inv.find(i => 
                i.id === 'hunting_bow' || i.id === 'crossbow' || i.id === 'wooden_bow' || i.id === 'bow' ||
                (i.type === 'weapon' && i.icon === '游낓')
            );
            
            if (huntingWeapon?.ammoType) {
                if (!consumeAmmo(huntingWeapon.ammoType, 1)) {
                    showModal('仇 Chyb칤 munice', `Nem치코 ${getAmmoName(huntingWeapon.ammoType)}!<br><button class="btn" onclick="closeModal()" style="width:100%; margin-top:1rem;">OK</button>`);
                    return;
                }
            }
            
            const skillBonus = (state.skills_secondary?.hunting || 0) * 5;
            const hitChance = 0.6 + (state.char.attrs.per * 0.02) + (skillBonus * 0.01);
            
            if (Math.random() < hitChance) {
                // 칔sp캩코n칳 z치sah
                state.skills_secondary.hunting = Math.min(10, (state.skills_secondary.hunting || 0) + 0.15);
                
                // Loot - sn칤쬰no o 30%
                let lootDisplay = [];
                Object.entries(animal.loot).forEach(([item, baseAmount]) => {
                    const amount = Math.max(1, Math.floor(baseAmount * 0.7)); // -30%, min 1
                    if (item === 'meat') {
                        state.resources.raw_meat = (state.resources.raw_meat || 0) + amount;
                        markFoodAsNew('raw_meat', amount);
                        lootDisplay.push({ item: '游볼 Syrov칠 maso', amount });
                    } else if (item === 'cloth') {
                        state.resources.cloth = (state.resources.cloth || 0) + amount;
                        lootDisplay.push({ item: '游빗 L치tka', amount });
                    } else if (item === 'leather') {
                        state.resources.leather = (state.resources.leather || 0) + amount;
                        lootDisplay.push({ item: '游붮 K콢쬰', amount });
                    } else {
                        // Ostatn칤 p콏edm캩ty (radx, atd.)
                        state.resources[item] = (state.resources[item] || 0) + amount;
                        const icons = { radx: '游눍', radaway: '驕뮖잺' };
                        lootDisplay.push({ item: (icons[item] || '游닍') + ' ' + item, amount });
                    }
                });
                
                addXP(animal.xp);
                
                if (animal.radiation) {
                    state.status.radiation = Math.min(100, state.status.radiation + animal.radiation);
                }
                
                showModal('游낓 칔sp캩코n칳 lov!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游꿢</div>
                        <h3>Ulovil jsi ${animal.name}!</h3>
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            ${lootDisplay.map(l => `<p style="color: #8bc34a; margin: 0.3rem 0;">+${l.amount} ${l.item}</p>`).join('')}
                        </div>
                        <p style="color: #ffd700;">+${animal.xp} XP</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showActionModal('hunt');" style="width: 100%; margin-top: 0.5rem;">游낓 Lovit znovu</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                `);
            } else {
                // Minut칤
                if (animal.aggressive) {
                    // Zv칤콏e 칰to캜칤!
                    closeModal();
                    startCombat({ 
                        id: 'hunt_' + animal.id, 
                        name: animal.name, 
                        icon: animal.icon, 
                        hp: animal.hp, 
                        damage: Math.floor(animal.hp / 5), 
                        defense: 2, 
                        xp: animal.xp,
                        loot: animal.loot
                    });
                } else {
                    showModal('游낓 Minul!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">游눧</div>
                            <p>${animal.name} utekl!</p>
                        </div>
                        <button class="btn" onclick="closeModal(); showActionModal('hunt');" style="width: 100%; margin-top: 0.5rem;">游낓 Zkusit znovu</button>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                    `);
                }
            }
        }
        
        // === VA콎EN칈 A ALCHYMIE ===
        function openCookingMenu() {
            if (!state.inv.find(i => i.id === 'cooking_pot')) {
                showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 游꼽 Hrnec pro va콏en칤!');
                return;
            }
            
            const cookingRecipes = RECIPES.filter(r => r.type === 'cooking');
            
            showModal('游꼽 Va콏en칤', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${cookingRecipes.map(recipe => {
                        const canCraft = Object.entries(recipe.requires).every(([res, amt]) => 
                            (state.resources[res] || 0) >= amt || state.inv.some(i => i.id === res && (i.count || 1) >= amt)
                        );
                        return `
                            <div style="background: #2a2a2a; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 8px; ${!canCraft ? 'opacity: 0.5;' : ''}">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 2rem;">${recipe.icon}</span>
                                    <div style="flex: 1;">
                                        <strong>${recipe.name}</strong>
                                        <p style="font-size: 0.8rem; color: #999;">${recipe.desc}</p>
                                        <p style="font-size: 0.75rem; color: #ff9800;">
                                            Pot콏eba: ${Object.entries(recipe.requires).map(([r, a]) => `${a}x ${r}`).join(', ')}
                                        </p>
                                    </div>
                                    <button class="btn" onclick="cook('${recipe.id}')" ${!canCraft ? 'disabled' : ''} style="padding: 0.4rem 0.8rem;">Va콏it</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function openAlchemyMenu() {
            if (!state.inv.find(i => i.id === 'alchemy_set')) {
                showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 丘勇 Alchymistickou sadu!');
                return;
            }
            
            const alchemyRecipes = RECIPES.filter(r => r.type === 'alchemy');
            
            showModal('丘勇 Alchymie', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${alchemyRecipes.map(recipe => {
                        const canCraft = Object.entries(recipe.requires).every(([res, amt]) => 
                            (state.resources[res] || 0) >= amt || state.inv.some(i => i.id === res && (i.count || 1) >= amt)
                        );
                        return `
                            <div style="background: #2a2a2a; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 8px; ${!canCraft ? 'opacity: 0.5;' : ''}">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 2rem;">${recipe.icon}</span>
                                    <div style="flex: 1;">
                                        <strong>${recipe.name}</strong>
                                        <p style="font-size: 0.8rem; color: #999;">${recipe.desc}</p>
                                        <p style="font-size: 0.75rem; color: #ff9800;">
                                            Pot콏eba: ${Object.entries(recipe.requires).map(([r, a]) => `${a}x ${r}`).join(', ')}
                                        </p>
                                    </div>
                                    <button class="btn" onclick="brew('${recipe.id}')" ${!canCraft ? 'disabled' : ''} style="padding: 0.4rem 0.8rem;">M칤chat</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function cook(recipeId) {
            const recipe = RECIPES.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Spot콏ebuj ingredience
            Object.entries(recipe.requires).forEach(([res, amt]) => {
                if (state.resources[res] >= amt) {
                    state.resources[res] -= amt;
                    // Pokud do코lo j칤dlo kter칠 se kaz칤, sma timestamp
                    if (state.resources[res] === 0 && state.foodTimestamps?.[res]) {
                        delete state.foodTimestamps[res];
                    }
                } else {
                    const item = state.inv.find(i => i.id === res);
                    if (item) {
                        if (item.count > amt) item.count -= amt;
                        else state.inv = state.inv.filter(i => i.id !== res);
                    }
                }
            });
            
            // Vytvo콏 j칤dlo
            const food = {
                id: recipe.id,
                name: recipe.name,
                icon: recipe.icon,
                type: 'consumable',
                effect: recipe.result.effect,
                value: recipe.result.value,
                count: 1
            };
            
            const existing = state.inv.find(i => i.id === recipe.id);
            if (existing) existing.count = (existing.count || 1) + 1;
            else state.inv.push(food);
            
            state.skills_secondary.cooking = Math.min(10, (state.skills_secondary.cooking || 0) + 0.1);
            
            // Daily quest progress - cooked
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.cooked = (state.dailyQuests.progress.cooked || 0) + 1;
            }
            checkDailyQuests();
            
            addLog('Uva콏il jsi ' + recipe.name, recipe.icon);
            openCookingMenu();
        }
        
        function brew(recipeId) {
            const recipe = RECIPES.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Spot콏ebuj ingredience
            Object.entries(recipe.requires).forEach(([res, amt]) => {
                if (state.resources[res] >= amt) {
                    state.resources[res] -= amt;
                    // Pokud do코lo j칤dlo kter칠 se kaz칤, sma timestamp
                    if (state.resources[res] === 0 && state.foodTimestamps?.[res]) {
                        delete state.foodTimestamps[res];
                    }
                } else {
                    const item = state.inv.find(i => i.id === res);
                    if (item) {
                        if (item.count > amt) item.count -= amt;
                        else state.inv = state.inv.filter(i => i.id !== res);
                    }
                }
            });
            
            // Vytvo콏 lektvar
            const potion = {
                id: recipe.id,
                name: recipe.name,
                icon: recipe.icon,
                type: 'consumable',
                effect: recipe.result.effect,
                value: recipe.result.value,
                buff: recipe.result.buff,
                duration: recipe.result.duration,
                count: 1
            };
            
            const existing = state.inv.find(i => i.id === recipe.id);
            if (existing) existing.count = (existing.count || 1) + 1;
            else state.inv.push(potion);
            
            state.skills_secondary.alchemy = Math.min(10, (state.skills_secondary.alchemy || 0) + 0.15);
            
            addLog('Nam칤chal jsi ' + recipe.name, recipe.icon);
            openAlchemyMenu();
        }
        
        // === MUTACE ===
        function checkForMutation() {
            if (state.status.radiation < 50) return;
            
            // Imunita proti mutac칤m (z Bu캜ovic)
            if (state.mutationImmunity === 'permanent') return;
            
            // 마nce na mutaci p콏i vysok칠 radiaci (0.05% - 2.5% za check) - ZPOMALENO
            const chance = (state.status.radiation - 50) * 0.0005;
            if (Math.random() > chance) return;
            
            // 游빏 Exotic bonus - Mutant칤 쬷치za (blokuje mutaci)
            if (state.exoticBonuses?.mutationResist > 0) {
                state.exoticBonuses.mutationResist--;
                notifySuccess('游빏 Mutace zablokov치na!', 'Mutant칤 쬷치za t캩 ochr치nila!');
                return;
            }
            
            // Vyber n치hodnou mutaci kterou je코t캩 nem치m
            const availableMutations = MUTATIONS.filter(m => !state.mutations?.includes(m.id));
            if (availableMutations.length === 0) return;
            
            const mutation = availableMutations[Math.floor(Math.random() * availableMutations.length)];
            
            state.mutations = state.mutations || [];
            state.mutations.push(mutation.id);
            
            // Aplikuj efekty
            if (mutation.effect.maxHp) state.char.maxHp += mutation.effect.maxHp;
            if (mutation.effect.defense) state.char.baseDefense = (state.char.baseDefense || 0) + mutation.effect.defense;
            if (mutation.effect.perception) state.char.attrs.per += mutation.effect.perception;
            if (mutation.effect.str) state.char.attrs.str += mutation.effect.str;
            if (mutation.effect.agi) state.char.attrs.agi += mutation.effect.agi;
            if (mutation.effect.int) state.char.attrs.int += mutation.effect.int;
            
            // Zvuky a notifikace
            SoundSystem.play('mutation');
            
            const humor = getRandomHumor('mutation');
            
            showModal('驕뮖잺 MUTACE!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${mutation.icon}</div>
                    <h3 style="color: #ff9800; margin-bottom: 0.5rem;">${mutation.name}</h3>
                    <p style="color: #666; font-style: italic; font-size: 0.8rem; margin-bottom: 1rem;">"${humor}"</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #4caf50;">
                        <p style="margin: 0; color: #8bc34a;">九 ${mutation.positive}</p>
                    </div>
                    
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #f44336;">
                        <p style="margin: 0; color: #ef5350;">九 ${mutation.negative}</p>
                    </div>
                    
                    <p style="color: #888; font-size: 0.85rem;">${mutation.desc}</p>
                    <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">Mutace: ${state.mutations.length}/5</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">游빏 P콏ijmout osud...</button>
            `);
            
            addLog('驕뮖잺 Z칤skal jsi mutaci: ' + mutation.name, '驕뮖잺');
            notifyWarning('Mutace!', mutation.name);
            
            // P콏i 5 mutac칤ch AUTOMATICK츼 transformace na mutanta
            if (state.mutations.length >= 5 && state.char.classId !== 'mutant') {
                setTimeout(() => {
                    autoTransformToMutant();
                }, 1500);
            }
        }
        
        // Automatick치 transformace na mutanta p콏i 5 mutac칤ch
        function autoTransformToMutant() {
            // Sundej brn캩n칤 a helmu
            if (state.equipped?.armor) {
                addItemToInventory(state.equipped.armor, 1);
                addLog('Sund치no: ' + state.equipped.armor.name + ' (p콏칤li코 velk칳)', '游뛂');
                state.equipped.armor = null;
            }
            if (state.equipped?.helmet) {
                addItemToInventory(state.equipped.helmet, 1);
                addLog('Sund치no: ' + state.equipped.helmet.name, '游뛂');
                state.equipped.helmet = null;
            }
            
            // Zm캩켿 t콏칤du
            const oldClass = state.char.class;
            state.char.class = 'mutant';
            state.char.classId = 'mutant';
            
            // Bonusy mutanta
            state.char.str = (state.char.str || 5) + 3;
            state.char.end = (state.char.end || 5) + 3;
            state.char.maxHp += 30;
            state.char.hp = Math.min(state.char.hp + 30, state.char.maxHp);
            
            saveGame();
            renderFull();
            
            // Zobraz ozn치men칤
            showModal('游붍 TRANSFORMACE DOKON캛ENA!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; animation: pulse 1s infinite;">游붍</div>
                    <h2 style="color: #76ff03; margin: 0.5rem 0; text-shadow: 0 0 20px #76ff03;">Stal ses MUTANTEM!</h2>
                    <p style="color: #888;">Tv칠 t캩lo pro코lo kompletn칤 transformac칤 po nashrom치쬯캩n칤 5 mutac칤.</p>
                    <p style="color: #666; font-size: 0.85rem;">Byl jsi: ${oldClass}</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #76ff03;">
                    <h4 style="color: #76ff03; margin: 0 0 0.5rem 0;">九 Nov칠 schopnosti:</h4>
                    <div style="font-size: 0.85rem; color: #aaa; line-height: 1.6;">
                        游붍 Dr치py +20 DMG (z치lo쬹칤 zbra켿)<br>
                        游띠勇 Mutant칤 k콢쬰 +10 DEF<br>
                        驕뮖잺 -50% radiace<br>
                        丘덢잺 +20% damage v rad z칩n치ch<br>
                        仇벒잺 +2 HP p콏i ka쬯칠m z치sahu<br>
                        游눩 +3 STR, +3 END, +30 HP
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c62828;">
                    <div style="font-size: 0.85rem; color: #ff9800;">
                        丘멆잺 U nem콢쬰코 nosit brn캩n칤 ani helmy<br>
                        丘멆잺 Transformace je TRVAL츼!
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #76ff03; color: #000; font-weight: bold;">
                    游붍 P콏ijmout sv콢j nov칳 osud
                </button>
            `);
            
            addLog('游붍 TRANSFORMACE: Stal ses plnohodnotn칳m mutantem!', '游붍');
        }
        
        // Nab칤dka transformace na mutanta (zachov치no pro kompatibilitu)
        function showMutantTransformOffer() {
            autoTransformToMutant();
        }
        
        // Transformace na mutanta (zachov치no pro kompatibilitu)
        function becomeMutant() {
            autoTransformToMutant();
        }
        
        // === STASH/SKR칗E ===
        function openStashMenu() {
            // Pou쬴j ID aktu치ln칤 lokace jako kl칤캜 pro stash
            const key = state.world.currentLocation || 'shelter';
            const locationName = getCurrentLocation()?.name || 'Nezn치m치 lokace';
            const stash = state.stashes?.[key] || [];
            
            const cacheTexts = {
                desc: 'M콢쬰코 zde schovat p콏edm캩ty. 丘멆잺 Ka쬯치 lokace m치 vlastn칤 skr칳코!',
                inCache: 'Ve skr칳코i', empty: 'Pr치zdn치', yourInv: 'Tv콢j invent치콏',
                emptyInv: 'Pr치zdn칳', part: '캛치st', all: 'V코e'
            };
            
            showModal('游닍 Skr칳코: ' + locationName, `
                <p style="color: #999; margin-bottom: 0.5rem;">${cacheTexts.desc}</p>
                <p style="color: #666; font-size: 0.75rem; margin-bottom: 1rem;">游늸 Aktu치ln칤 lokace: ${locationName}</p>
                
                <h4>${cacheTexts.inCache} (${stash.length}):</h4>
                <div style="background: #2a2a2a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${stash.length > 0 ? stash.map((item, i) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem; gap: 0.3rem;">
                            <span style="flex: 1;">${item.icon || '游닍'} ${item.name || getItemName(item.id)} ${item.count > 1 ? `(${item.count}x)` : ''}</span>
                            ${item.count > 1 ? `<button class="btn" onclick="showStashQuantity('take', ${i}, ${item.count})" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; background: #666;">${cacheTexts.part}</button>` : ''}
                            <button class="btn" onclick="takeFromStash(${i}, ${item.count || 1})" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">${cacheTexts.all}</button>
                        </div>
                    `).join('') : '<p style="color: #666; text-align: center;">' + cacheTexts.empty + '</p>'}
                </div>
                
                <h4>${cacheTexts.yourInv}:</h4>
                <div style="background: #2a2a2a; padding: 0.5rem; border-radius: 8px; max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${state.inv.length > 0 ? state.inv.map((item, i) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem; gap: 0.3rem;">
                            <span style="flex: 1;">${item.icon || '游닍'} ${item.name || getItemName(item.id)} ${item.count > 1 ? `(${item.count}x)` : ''}</span>
                            ${item.count > 1 ? `<button class="btn" onclick="showStashQuantity('put', ${i}, ${item.count})" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; background: #666;">${cacheTexts.part}</button>` : ''}
                            <button class="btn" onclick="putInStash(${i}, ${item.count || 1})" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">${cacheTexts.all}</button>
                        </div>
                    `).join('') : '<p style="color: #666; text-align: center;">' + cacheTexts.emptyInv + '</p>'}
                </div>
                
                <button class="btn" onclick="showAllStashes()" style="width: 100%; margin-top: 0.5rem; background: #333; font-size: 0.8rem;">游댌 Zobrazit v코echny skr칳코e</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function showAllStashes() {
            const stashes = state.stashes || {};
            const keys = Object.keys(stashes);
            
            if (keys.length === 0) {
                showModal('游닍 V코echny skr칳코e', '<p style="color: #888; text-align: center;">Nem치코 쮂멳n칠 v캩ci ve skr칳코칤ch.</p><button class="btn" onclick="openStashMenu()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>');
                return;
            }
            
            const currentLoc = state.world.currentLocation || 'shelter';
            
            let html = '<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            keys.forEach(key => {
                const items = stashes[key];
                if (items && items.length > 0) {
                    // Zkus naj칤t lokaci podle kl칤캜e
                    const locDef = WORLD_LOCATIONS?.find(l => l.id === key);
                    const locName = locDef?.name || key;
                    
                    // Kontrola jestli je hr치캜 na t칠to lokaci
                    const isCurrentLoc = key === currentLoc;
                    
                    const totalWeight = items.reduce((sum, item) => {
                        const itemDef = ITEMS.find(i => i.id === item.id);
                        return sum + ((item.weight || itemDef?.weight || 0) * (item.count || 1));
                    }, 0);
                    
                    html += `<div style="background: ${isCurrentLoc ? '#1a2a1a' : '#1a1a1a'}; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid ${isCurrentLoc ? '#4a7a4a' : '#333'};">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">`;
                    html += `<h4 style="margin: 0; color: ${isCurrentLoc ? '#8bc34a' : '#ff9800'};">游늸 ${locName} ${isCurrentLoc ? '(jsi zde)' : ''}</h4>`;
                    html += `<span style="color: #666; font-size: 0.75rem;">丘뒲잺 ${totalWeight.toFixed(1)}kg</span>`;
                    html += `</div>`;
                    
                    items.forEach((item, idx) => {
                        const itemDef = ITEMS.find(i => i.id === item.id);
                        const weight = item.weight || itemDef?.weight || 0;
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; color: #ccc; font-size: 0.85rem; padding: 0.3rem 0; border-bottom: 1px solid #222;">`;
                        html += `<span style="flex: 1;">${item.icon || '游닍'} ${item.name || item.id} ${item.count > 1 ? '(' + item.count + 'x)' : ''}</span>`;
                        html += `<span style="color: #555; font-size: 0.7rem; margin-right: 0.5rem;">${(weight * (item.count || 1)).toFixed(1)}kg</span>`;
                        if (isCurrentLoc) {
                            html += `<button class="btn" onclick="takeFromStashByKey('${key}', ${idx})" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #4CAF50;">Vz칤t</button>`;
                        }
                        html += `</div>`;
                    });
                    
                    if (!isCurrentLoc) {
                        html += `<div style="text-align: center; margin-top: 0.5rem; padding: 0.4rem; background: #2a2a2a; border-radius: 4px; color: #888; font-size: 0.75rem;">游뛌 Mus칤코 tam doj칤t pro vyzvednut칤</div>`;
                    }
                    
                    html += '</div>';
                }
            });
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>';
            
            showModal('游닍 V코echny skr칳코e', html);
        }
        
        // Vyzvednut칤 v캩ci ze skr칳코e podle kl칤캜e (pro showAllStashes)
        function takeFromStashByKey(stashKey, itemIndex) {
            // Kontrola lokace
            const currentLoc = state.world.currentLocation || 'shelter';
            const isAtLocation = stashKey === currentLoc || (stashKey === 'shelter' && (!currentLoc || currentLoc === 'shelter'));
            
            if (!isAtLocation) {
                notifyWarning('游늸 맗atn치 lokace', 'Mus칤코 b칳t na m칤st캩 kde m치코 skr칳코!');
                return;
            }
            
            if (!state.stashes?.[stashKey]?.[itemIndex]) {
                notifyWarning('Chyba', 'Polo쬶a nenalezena');
                return;
            }
            
            const item = state.stashes[stashKey][itemIndex];
            const count = item.count || 1;
            
            // Kontrola v치hy - z칤skej v치hu z ITEMS definice pokud item nem치 weight
            const itemDef = ITEMS.find(i => i.id === item.id);
            const itemWeight = (item.weight || itemDef?.weight || 0) * count;
            const currentWeight = calculateCurrentWeight();
            const maxWeight = calculateMaxWeight();
            
            if (currentWeight + itemWeight > maxWeight) {
                notifyWarning('仇 Pln칳 invent치콏', `Neunese코 to! (${currentWeight.toFixed(1)}/${maxWeight}kg)`);
                return;
            }
            
            // P콏idej weight do itemu pokud chyb칤
            if (!item.weight && itemDef?.weight) {
                item.weight = itemDef.weight;
            }
            
            // Najdi existuj칤c칤 stack v invent치콏i
            const existingInv = state.inv.find(i => i.id === item.id);
            
            if (existingInv) {
                existingInv.count = (existingInv.count || 1) + count;
            } else {
                state.inv.push({...item, count: count});
            }
            
            // Odeber ze skr칳코e
            state.stashes[stashKey].splice(itemIndex, 1);
            
            // Vy캜isti pr치zdn칠 skr칳코e
            if (state.stashes[stashKey].length === 0) {
                delete state.stashes[stashKey];
            }
            
            updateCarryWeight();
            notifySuccess('游닍 Vzato', `${item.name || item.id} ${count > 1 ? '(' + count + 'x)' : ''}`);
            
            // Obnov seznam skr칳코칤
            showAllStashes();
        }
        
        function showStashQuantity(action, index, maxCount) {
            const key = state.world.currentLocation || 'shelter';
            const item = action === 'take' ? state.stashes[key][index] : state.inv[index];
            
            showModal('游닍 Kolik kus콢?', `
                <div style="text-align: center;">
                    <p>${item.icon || '游닍'} ${item.name || getItemName(item.id)}</p>
                    <p style="color: #888;">${'Dostupn칠'}: ${maxCount}x</p>
                    
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 1rem 0;">
                        <button class="btn" onclick="adjustStashQty(-10)" style="padding: 0.3rem 0.6rem;">-10</button>
                        <button class="btn" onclick="adjustStashQty(-1)" style="padding: 0.3rem 0.6rem;">-1</button>
                        <input type="number" id="stashQtyInput" value="1" min="1" max="${maxCount}" style="width: 60px; text-align: center; padding: 0.3rem; background: #1a1a1a; border: 1px solid #555; color: #fff; border-radius: 4px;">
                        <button class="btn" onclick="adjustStashQty(1)" style="padding: 0.3rem 0.6rem;">+1</button>
                        <button class="btn" onclick="adjustStashQty(10)" style="padding: 0.3rem 0.6rem;">+10</button>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="document.getElementById('stashQtyInput').value = ${maxCount}" style="flex: 1; background: #666;">Max</button>
                        <button class="btn" onclick="${action}FromStash(${index}, parseInt(document.getElementById('stashQtyInput').value))" style="flex: 2; background: var(--rust);">
                            ${action === 'take' ? ('Vz칤t') : ('Schovat')}
                        </button>
                    </div>
                    
                    <button class="btn" onclick="openStashMenu()" style="width: 100%; margin-top: 0.5rem; background: #333;"> ${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function adjustStashQty(delta) {
            const input = document.getElementById('stashQtyInput');
            const max = parseInt(input.max);
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            if (val > max) val = max;
            input.value = val;
        }
        
        function putFromStash(itemIndex, amount) {
            // Alias pro kompatibilitu s showStashQuantity
            putInStash(itemIndex, amount);
        }
        
        function putInStash(itemIndex, amount = null) {
            const key = state.world.currentLocation || 'shelter';
            state.stashes = state.stashes || {};
            state.stashes[key] = state.stashes[key] || [];
            
            const item = state.inv[itemIndex];
            if (!item) return;
            
            const count = item.count || 1;
            const toMove = amount ? Math.min(amount, count) : count;
            
            // Najdi existuj칤c칤 stack ve skr칳코i - porovnej podle id a typu (a ammoType pro munici)
            const existingStash = state.stashes[key].find(i => 
                i.id === item.id && 
                i.type === item.type &&
                (item.type !== 'ammo' || i.ammoType === item.ammoType) &&
                !item.durability && !i.durability // Nestackuj po코koditeln칠 v캩ci
            );
            
            if (existingStash && (item.stackable || item.type === 'ammo' || item.type === 'consumable' || item.type === 'material' || item.type === 'resource')) {
                existingStash.count = (existingStash.count || 1) + toMove;
            } else {
                state.stashes[key].push({...item, count: toMove});
            }
            
            // Odeber z invent치콏e
            if (toMove >= count) {
                state.inv.splice(itemIndex, 1);
            } else {
                item.count = count - toMove;
            }
            
            updateCarryWeight();
            addLog('Schoval jsi ' + item.name + (toMove > 1 ? ` (${toMove}x)` : '') + ' do skr칳코e', '游닍');
            openStashMenu();
        }
        
        function takeFromStash(itemIndex, amount = null) {
            const key = state.world.currentLocation || 'shelter';
            if (!state.stashes?.[key]?.[itemIndex]) return;
            
            const item = state.stashes[key][itemIndex];
            const count = item.count || 1;
            const toMove = amount ? Math.min(amount, count) : count;
            
            // Kontrola v치hy - z칤skej v치hu z ITEMS definice pokud item nem치 weight
            const itemDef = ITEMS.find(i => i.id === item.id);
            const itemWeight = (item.weight || itemDef?.weight || 0) * toMove;
            const currentWeight = calculateCurrentWeight();
            const maxWeight = calculateMaxWeight();
            
            if (currentWeight + itemWeight > maxWeight) {
                showModal('仇 Pln칳 invent치콏', `Nem치코 m칤sto v invent치콏i! (${currentWeight.toFixed(1)}/${maxWeight}kg, item v치쮂 ${itemWeight.toFixed(1)}kg)`);
                return;
            }
            
            // P콏idej weight do itemu pokud chyb칤
            if (!item.weight && itemDef?.weight) {
                item.weight = itemDef.weight;
            }
            
            // Najdi existuj칤c칤 stack v invent치콏i - porovnej podle id a typu (a ammoType pro munici)
            const existingInv = state.inv.find(i => 
                i.id === item.id && 
                i.type === item.type &&
                (item.type !== 'ammo' || i.ammoType === item.ammoType) &&
                !item.durability && !i.durability // Nestackuj po코koditeln칠 v캩ci
            );
            
            if (existingInv && (item.stackable || item.type === 'ammo' || item.type === 'consumable' || item.type === 'material' || item.type === 'resource')) {
                existingInv.count = (existingInv.count || 1) + toMove;
            } else {
                state.inv.push({...item, count: toMove});
            }
            
            // Odeber ze skr칳코e
            if (toMove >= count) {
                state.stashes[key].splice(itemIndex, 1);
            } else {
                item.count = count - toMove;
            }
            
            updateCarryWeight();
            addLog('Vzal jsi ' + item.name + (toMove > 1 ? ` (${toMove}x)` : '') + ' ze skr칳코e', '游닍');
            openStashMenu();
        }
        
        // === SPOJEN칈 STACK콡 V INVENT츼콎I ===
        function mergeInventoryStacks() {
            const merged = {};
            const nonStackable = [];
            let mergedCount = 0;
            
            state.inv.forEach(item => {
                // V캩ci s durability nebo unique se nestackuj칤
                if (item.durability !== undefined || item.unique || item._uniqueId) {
                    nonStackable.push(item);
                    return;
                }
                
                // Stackovateln칠 typy
                const stackableTypes = ['ammo', 'consumable', 'material', 'resource'];
                if (!stackableTypes.includes(item.type) && !item.stackable) {
                    nonStackable.push(item);
                    return;
                }
                
                // Vytvo콏 unik치tn칤 kl칤캜 pro stack
                const key = item.type === 'ammo' 
                    ? `${item.id}_${item.ammoType}` 
                    : item.id;
                
                if (merged[key]) {
                    merged[key].count = (merged[key].count || 1) + (item.count || 1);
                    mergedCount++;
                } else {
                    merged[key] = {...item, count: item.count || 1};
                }
            });
            
            // Sestav nov칳 invent치콏
            state.inv = [...Object.values(merged), ...nonStackable];
            
            updateCarryWeight();
            
            if (mergedCount > 0) {
                notifySuccess('Invent치콏 optimalizov치n!', `Spojeno ${mergedCount} stack콢`);
                addLog(`游닍 Spojeno ${mergedCount} rozd캩len칳ch stack콢`, '九');
            } else {
                notifyWarning('Nic ke spojen칤', 'V코echny stacky jsou ji spojen칠');
            }
            
            renderFull();
        }
        
        // === DEN/NOC F츼ZE ===
        function getCurrentDayPhase() {
            const hour = state.time.hours;
            return DAY_PHASES.find(p => p.hours.includes(hour)) || DAY_PHASES[1];
        }
        
        // === MUTANT INFO ===
        function showMutantInfo() {
            const isMutant = state.char.class === 'mutant';
            const mutations = state.mutations || [];
            const mutationCount = mutations.length;
            
            const mutTexts = {
                progress: 'Progres k transformaci', mutations: 'mutac칤',
                transform: 'TRANSFORMOVAT SE V MUTANTA!', yourActiveMutations: 'Tv칠 aktivn칤 mutace',
                noMutations: 'Zat칤m nem치코 쮂멳n칠 mutace', getMutations: 'Mutace z칤sk치v치코 p콏i radiaci nad 50%',
                allMutations: 'V코echny mutace (klikni pro detail)', whatYouGet: 'Co z칤sk치코 jako mutant', yourBonuses: 'Tv칠 mutant칤 bonusy',
                drawbacks: 'Nev칳hody mutanta', yourLimitations: 'Tv치 omezen칤',
                cantWearArmor: 'Nem콢쬰코 nosit brn캩n칤', cantWearHelmets: 'Nem콢쬰코 nosit helmy',
                loseClass: 'Ztrat칤코 p콢vodn칤 t콏칤du', irreversible: 'Transformace je NEVRATN츼!',
                youAreMutant: 'JSI MUTANT!', readyToTransform: 'P콎IPRAVEN K TRANSFORMACI!', mutationsTitle: 'MUTACE & MUTANT'
            };
            
            // Z칤skej detaily mutac칤 hr치캜e
            const playerMutations = mutations.map(mId => MUTATIONS.find(m => m.id === mId)).filter(m => m);
            
            // Progress bar
            const progressPercent = (mutationCount / 5) * 100;
            const progressBar = !isMutant ? `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span style="color: #888; font-size: 0.85rem;">${mutTexts.progress}</span>
                        <span style="color: ${mutationCount >= 5 ? '#76ff03' : '#ff9800'}; font-size: 0.85rem; font-weight: bold;">${mutationCount}/5 ${mutTexts.mutations}</span>
                    </div>
                    <div style="background: #333; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #ff9800, ${mutationCount >= 5 ? '#76ff03' : '#ffb74d'}); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                    </div>
                </div>
            ` : '';
            
            // Tla캜칤tko transformace
            const transformButton = (!isMutant && mutationCount >= 5) ? `
                <button class="btn" onclick="closeModal(); showMutantTransformOffer();" style="width: 100%; margin-bottom: 1rem; background: linear-gradient(135deg, #76ff03, #4caf50); color: #000; font-weight: bold; font-size: 1rem; padding: 0.8rem;">
                    游붍 ${mutTexts.transform}
                </button>
            ` : '';
            
            // Hr치캜ovy mutace
            const playerMutationsHtml = playerMutations.length > 0 ? `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 0.9rem;">驕뮖잺 ${mutTexts.yourActiveMutations} (${playerMutations.length}):</h4>
                    <div style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${playerMutations.map(m => `
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem; border-bottom: 1px solid #333;">
                                <span style="font-size: 1.2rem;">${m.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.85rem; color: #fff;">${m.name}</div>
                                    <div style="font-size: 0.7rem; color: #8bc34a;">九 ${m.positive}</div>
                                    <div style="font-size: 0.7rem; color: #ef5350;">九 ${m.negative}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.3rem;">游빏</div>
                    <p style="color: #666; margin: 0;">${mutTexts.noMutations}</p>
                    <p style="color: #888; font-size: 0.75rem; margin: 0.3rem 0 0 0;">${mutTexts.getMutations}</p>
                </div>
            `;
            
            // V코echny dostupn칠 mutace
            const allMutationsHtml = `
                <details style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: #64b5f6; font-size: 0.9rem; padding: 0.5rem; background: #1a1a2a; border-radius: 8px;">
                        游닀 ${mutTexts.allMutations}
                    </summary>
                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem;">
                            ${MUTATIONS.map(m => {
                                const hasMutation = mutations.includes(m.id);
                                return `
                                    <div onclick="showMutationDetail('${m.id}')" style="cursor: pointer; text-align: center; padding: 0.4rem; background: ${hasMutation ? '#1a2a1a' : '#0a0a0a'}; border-radius: 6px; border: 1px solid ${hasMutation ? '#4caf50' : '#333'};">
                                        <div style="font-size: 1.3rem; ${hasMutation ? '' : 'opacity: 0.4;'}">${m.icon}</div>
                                        <div style="font-size: 0.6rem; color: ${hasMutation ? '#8bc34a' : '#666'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${m.name.split(' ')[0]}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </details>
            `;
            
            // Mutant bonusy
            const mutantBonusesHtml = `
                <details ${isMutant ? 'open' : ''} style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: #76ff03; font-size: 0.9rem; padding: 0.5rem; background: #1a2a1a; border-radius: 8px;">
                        游붍 ${isMutant ? mutTexts.yourBonuses : mutTexts.whatYouGet}
                    </summary>
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 0 0 8px 8px; border: 1px solid #2a3a2a;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; font-size: 0.8rem;">
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">游붍 ${'Dr치py'} <span style="color: #ff4444;">+20 DMG</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">游띠勇 ${'K콢쬰'} <span style="color: #76ff03;">+10 DEF</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">驕뮖잺 ${'Radiace'} <span style="color: #76ff03;">-50%</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">丘덢잺 ${'Rad z칩ny'} <span style="color: #ff4444;">+20%</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">仇벒잺 ${'Regen'} <span style="color: #ff4444;">+2 HP/hit</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">游눩 ${'Atributy'} <span style="color: #76ff03;">+3 STR/END</span></div>
                        </div>
                    </div>
                </details>
            `;
            
            // Mutant nev칳hody
            const mutantDrawbacksHtml = `
                <details ${isMutant ? 'open' : ''} style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: #c62828; font-size: 0.9rem; padding: 0.5rem; background: #2a1a1a; border-radius: 8px;">
                        丘멆잺 ${isMutant ? mutTexts.yourLimitations : mutTexts.drawbacks}
                    </summary>
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 0 0 8px 8px; border: 1px solid #3a2a2a;">
                        <div style="font-size: 0.85rem; color: #ff6666;">
                            <div style="padding: 0.2rem 0;">游뛂 ${mutTexts.cantWearArmor}</div>
                            <div style="padding: 0.2rem 0;">游뛂 ${mutTexts.cantWearHelmets}</div>
                            ${!isMutant ? '<div style="padding: 0.2rem 0;">丘멆잺 ' + mutTexts.loseClass + '</div><div style="padding: 0.2rem 0;">丘멆잺 ' + mutTexts.irreversible + '</div>' : ''}
                        </div>
                    </div>
                </details>
            `;
            
            // Hlavi캜ka
            const headerHtml = isMutant ? `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游붍</div>
                    <h2 style="color: #76ff03; margin: 0.3rem 0; font-size: 1.3rem;">${mutTexts.youAreMutant}</h2>
                </div>
            ` : `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem; ${mutationCount >= 5 ? '' : 'opacity: 0.6;'}">${mutationCount >= 5 ? '游붍' : '驕뮖잺'}</div>
                    <h2 style="color: ${mutationCount >= 5 ? '#76ff03' : '#ff9800'}; margin: 0.3rem 0; font-size: 1.2rem;">
                        ${mutationCount >= 5 ? mutTexts.readyToTransform : mutTexts.mutationsTitle}
                    </h2>
                </div>
            `;
            
            showModal('游붍 Mutace & Mutant', `
                ${headerHtml}
                ${progressBar}
                ${transformButton}
                ${playerMutationsHtml}
                ${allMutationsHtml}
                ${mutantBonusesHtml}
                ${mutantDrawbacksHtml}
                <button class="btn" onclick="closeModal()" style="width: 100%; background: ${isMutant ? '#76ff03' : '#555'}; color: ${isMutant ? '#000' : '#fff'};">${t('ui', 'close')}</button>
            `);
        }
        
        // Detail jednotliv칠 mutace
        function showMutationDetail(mutationId) {
            const m = MUTATIONS.find(mut => mut.id === mutationId);
            if (!m) return;
            
            const hasMutation = (state.mutations || []).includes(m.id);
            
            showModal(`${m.icon} ${m.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${m.icon}</div>
                    <div style="color: ${hasMutation ? '#76ff03' : '#888'}; font-size: 0.9rem;">${hasMutation ? '九 M치코 tuto mutaci' : '九 Nem치코 tuto mutaci'}</div>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #4caf50;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #8bc34a; font-size: 0.9rem;">九 V칳hoda</h4>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">${m.positive}</p>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #f44336;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #ef5350; font-size: 0.9rem;">九 Nev칳hoda</h4>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">${m.negative}</p>
                </div>
                
                <p style="color: #666; font-size: 0.8rem; text-align: center; margin-bottom: 1rem;">${m.desc}</p>
                
                <button class="btn" onclick="showMutantInfo()" style="width: 100%;"<>${' Zp캩t na p콏ehled'}<</button>
            `);
        }
        
        // === STATUS DETAILY ===
        function showStatusDetails(type) {
            const status = state.status;
            const nomadBonus = hasClassPassive('consumptionReduction') ? 0.5 : 1.0;
            
            // Najdi itemy kter칠 mohou doplnit dan칳 status
            const relevantItems = state.inv.filter(item => {
                if (item.type !== 'consumable') return false;
                if (type === 'hunger') return item.effect === 'hunger';
                if (type === 'thirst') return item.effect === 'thirst';
                if (type === 'energy') return item.effect === 'energy';
                if (type === 'radiation') return item.effect === 'radiation' && item.value < 0;
                return false;
            });
            
            // Z치kladn칤 spot콏eby
            const baseConsumption = {
                hunger: { base: 0.5, travel: 0.7, name: 'Hlad', icon: '游꼤', unit: '%/min' },
                thirst: { base: 0.7, travel: 1.0, name: '콯칤ze켿', icon: '游눦', unit: '%/min' },
                energy: { base: 0.3, travel: 1.5, name: 'Energie', icon: '丘', unit: '%/min' },
                mood: { base: 0, travel: 0, name: 'N치lada', icon: '游땕', unit: '' },
                radiation: { base: 0, travel: 0.1, name: 'Radiace', icon: '驕뮖잺', unit: '/min' }
            };
            
            const statusTexts = {
                critical: '游 KRITICK칄! Hroz칤 smrt!', dangerLow: '丘멆잺 Nebezpe캜n캩 n칤zk칠!',
                refillSoon: '丘 Dopl켿 brzy', ok: '九 V po콏치dku',
                radLethal: '驕멆잺 SMRTELN츼! Um칤r치코! (-5 HP/hod)', radCritical: '游 KRITICK칄! (0.3-1 HP/min, mutace!)',
                radDanger: '丘멆잺 Vysok치! (0.1-0.3 HP/min) - pot콏ebuje코 RadAway!', radMild: '驕뮖잺 M칤rn치 radiace (min. po코kozen칤)',
                radSafe: '九 Bezpe캜n치 칰rove켿',
                timeLeft: 'Vydr쮂 je코t캩', currentConsumption: 'Aktu치ln칤 spot콏eba',
                nomadPassive: 'Nom치d pasivka', inShelter: 'V 칰krytu', traveling: 'Cestov치n칤',
                howToRefill: 'Jak doplnit', howToReduce: 'Jak sn칤쬴t',
                foodItems: 'J칤dlo - konzervovan칠, maso, fazole', cooking: 'Va콏en칤 - lep코칤 j칤dlo z recept콢',
                farmInShelter: 'Farma v 칰krytu - pasivn칤 j칤dlo',
                water: 'Voda - l치hve, d쬿sy', cleanWater: '캛ist치 voda - lep코칤 efekt',
                wellInShelter: 'Studna v 칰krytu - pasivn칤 voda',
                energyDrinks: 'Energetick칠 n치poje', coffee: 'K치va - rychl칳 boost',
                sleepingBag: 'Spac치k - sp치nek (1 hodina)', restInShelter: 'Odpo캜inek v 칰krytu',
                radaway: 'RadAway - sni쬿je radiaci', antidote: 'Antidote lektvar - alchymie',
                hospital: 'Nemocnice - l칠캜ba radiace', avoidRad: 'Vyh칳bej se vod캩 a radioaktivn칤m z칩n치m',
                dayTime: 'Denn칤 doba ovliv켿uje n치ladu', stayInShelter: 'Pobyt v 칰krytu', completeQuests: 'Dokon캜ov치n칤 quest콢',
                inInventory: 'M치코 v invent치콏i'
            };
            
            const info = baseConsumption[type];
            const currentValue = Math.round(status[type]);
            
            // V칳po캜et aktu치ln칤 spot콏eby
            let currentRate = state.map.traveling ? info.travel : info.base;
            let rateModifiers = [];
            
            if (type === 'hunger' || type === 'thirst') {
                if (nomadBonus < 1) {
                    currentRate *= nomadBonus;
                    rateModifiers.push({ text: statusTexts.nomadPassive, value: '-50%', color: '#8bc34a' });
                }
            }
            
            if (state.map.inBase) {
                currentRate = 0;
                rateModifiers.push({ text: statusTexts.inShelter, value: '0', color: '#4caf50' });
            }
            
            if (state.map.traveling) {
                rateModifiers.push({ text: statusTexts.traveling, value: `+${Math.round((info.travel - info.base) * 100)}%`, color: '#ff9800' });
            }
            
            // V칳straha + humor
            let warningText = '';
            let warningColor = '#8bc34a';
            let humorText = '';
            if (type !== 'radiation' && type !== 'mood') {
                if (currentValue <= 0) {
                    warningText = statusTexts.critical;
                    warningColor = '#c62828';
                    if (type === 'hunger') humorText = getRandomHumor('hunger');
                } else if (currentValue <= 20) {
                    warningText = statusTexts.dangerLow;
                    warningColor = '#ff9800';
                    if (type === 'hunger') humorText = getRandomHumor('hunger');
                } else if (currentValue <= 40) {
                    warningText = statusTexts.refillSoon;
                    warningColor = '#ffd700';
                } else {
                    warningText = statusTexts.ok;
                    warningColor = '#8bc34a';
                }
            } else if (type === 'radiation') {
                if (currentValue >= 100) {
                    warningText = statusTexts.radLethal;
                    warningColor = '#76ff03'; // Zelen치 - toxick치 smrt
                } else if (currentValue >= 80) {
                    warningText = statusTexts.radCritical;
                    warningColor = '#c62828';
                } else if (currentValue >= 50) {
                    warningText = statusTexts.radDanger;
                    warningColor = '#ff9800';
                } else if (currentValue >= 25) {
                    warningText = statusTexts.radMild;
                    warningColor = '#ffd700';
                } else {
                    warningText = statusTexts.radSafe;
                    warningColor = '#8bc34a';
                }
            }
            
            // 캛as do vy캜erp치n칤
            let timeToEmpty = '';
            if (currentRate > 0 && currentValue > 0 && type !== 'radiation') {
                const minutesLeft = Math.floor(currentValue / currentRate);
                if (minutesLeft < 60) {
                    timeToEmpty = `${minutesLeft} min`;
                } else {
                    timeToEmpty = `${Math.floor(minutesLeft / 60)}h ${minutesLeft % 60}min`;
                }
            }
            
            showModal(`${info.icon} ${info.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${info.icon}</div>
                    <div style="font-size: 2rem; font-weight: bold; color: ${warningColor};">${currentValue}%</div>
                    <div style="color: ${warningColor}; font-size: 0.9rem;">${warningText}</div>
                    ${humorText ? `<div style="color: #888; font-style: italic; font-size: 0.8rem; margin-top: 0.3rem;">${humorText}</div>` : ''}
                    ${timeToEmpty && type !== 'radiation' ? `<div style="color: #999; font-size: 0.85rem; margin-top: 0.3rem;">낌勇 ${statusTexts.timeLeft}: ${timeToEmpty}</div>` : ''}
                </div>
                
                <!-- Progress bar -->
                <div style="background: #1a1a1a; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 1rem;">
                    <div style="height: 100%; width: ${currentValue}%; background: ${type === 'radiation' ? 
                        (currentValue > 50 ? '#c62828' : currentValue > 25 ? '#ff9800' : '#8bc34a') : 
                        (currentValue < 20 ? '#c62828' : currentValue < 40 ? '#ff9800' : '#8bc34a')}; transition: width 0.3s;"></div>
                </div>
                
                <!-- Aktu치ln칤 spot콏eba -->
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0;">游늵 ${statusTexts.currentConsumption}</h4>
                    <p style="margin: 0.3rem 0; font-size: 1.1rem;">
                        <strong>${type === 'radiation' ? '+' : '-'}${currentRate.toFixed(2)}</strong> ${info.unit}
                    </p>
                    ${rateModifiers.length > 0 ? `
                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #3a3a3a;">
                            ${rateModifiers.map(mod => `
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin: 0.2rem 0;">
                                    <span style="color: #999;">${mod.text}</span>
                                    <span style="color: ${mod.color};">${mod.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Jak doplnit -->
                <div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游눠 ${type === 'radiation' ? statusTexts.howToReduce : statusTexts.howToRefill}</h4>
                    ${type === 'hunger' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游볾 ${statusTexts.foodItems}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游꼽 ${statusTexts.cooking}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游끼 ${statusTexts.farmInShelter}</p>
                    ` : type === 'thirst' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游눦 ${statusTexts.water}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游눑 ${statusTexts.cleanWater}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游뛇 ${statusTexts.wellInShelter}</p>
                    ` : type === 'energy' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游댊 ${statusTexts.energyDrinks}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">驕 ${statusTexts.coffee}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游띒勇 ${statusTexts.sleepingBag}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游 ${statusTexts.restInShelter}</p>
                    ` : type === 'radiation' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">驕뮖잺 ${statusTexts.radaway}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">丘勇 ${statusTexts.antidote}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游낀 ${statusTexts.hospital}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">丘멆잺 ${statusTexts.avoidRad}</p>
                    ` : type === 'mood' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游깬 ${statusTexts.dayTime}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游 ${statusTexts.stayInShelter}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">游꿀 ${statusTexts.completeQuests}</p>
                    ` : ''}
                </div>
                
                <!-- Dostupn칠 itemy -->
                ${relevantItems.length > 0 ? `
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">游 ${statusTexts.inInventory}</h4>
                        <div style="max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${relevantItems.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.3rem;">${item.icon}</span>
                                        <div>
                                            <div style="font-weight: bold;">${item.name}</div>
                                            <div style="font-size: 0.8rem; color: #8bc34a;">+${Math.abs(item.value)}${type === 'radiation' ? '' : '%'}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: #999;">${item.count || 1}x</span>
                                        <button class="btn" onclick="closeModal(); confirmUseItem('${item.id}');" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;">${'Pou쮂셦'}</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div style="background: #3a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <p style="color: #ff9800; margin: 0;">丘멆잺 ${'Nem치코 쮂멳n칠 polo쬶y pro'} ${type === 'radiation' ? ('sn칤쬰n칤') : ('dopln캩n칤')}!</p>
                        <p style="color: #999; font-size: 0.85rem; margin: 0.5rem 0 0 0;">${'Najdi je p콏i pr콢zkumu nebo v obchod캩.'}</p>
                    </div>
                `}
                
                <!-- Aktivn칤 nemoci -->
                ${(typeof getActiveDiseases === 'function' && getActiveDiseases().length > 0) ? `
                    <div style="background: #3a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f44336;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #f44336;">游 Aktivn칤 nemoci</h4>
                        ${getActiveDiseases().map(d => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem 0; border-bottom: 1px solid #2a2a2a;">
                                <span>${d.icon} ${d.name}</span>
                                <span style="color: #888; font-size: 0.85rem;">낌勇 ${d.remainingText}</span>
                            </div>
                        `).join('')}
                        <button class="btn" onclick="closeModal(); showDiseasesUI();" style="width: 100%; margin-top: 0.5rem; padding: 0.4rem; font-size: 0.85rem; background: #c62828;">游낀 Zobrazit detaily</button>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">${t('ui', 'close')}</button>
            `);
        }

        // showMutationsInfo odstran캩no - pou쮂셨치me showMutantInfo()
        // Star치 showMutationDetail odstran캩na - m치me novou v showMutantInfo sekci
        
        // === R츼DIO ===
        function useRadio() {
            // Na vys칤la캜i funguje r치dio v쬯y, jinde pot콏ebuje코 m칤t r치dio
            const atRadioTower = state.world.currentLocation === 'radio_tower';
            const hasRadio = state.inv.find(i => i.id === 'radio');
            
            const radioTexts = {
                noRadio: 'Nem치코 r치dio!',
                whatRadioDoes: 'Co r치dio um칤:',
                radioNews: 'R치diov칠 zpr치vy', radioNewsDesc: 'tipy, varov치n칤, p콏칤b캩hy',
                treasureCoords: 'Sou콏adnice poklad콢', treasureDesc: 'ob캜as zachyt칤코 polohu pokladu!',
                quests: 'Questy', questsDesc: 'mise od p콏e쬴v코칤ch',
                warnings: 'Varov치n칤', warningsDesc: 'info o nebezpe캜n칳ch oblastech',
                caravanInfo: 'Info o karavan치ch', caravanDesc: 'kdy a kde jsou',
                howToGet: 'Jak z칤skat r치dio:',
                findExploring: 'Najdi p콏i pr콢zkumu budov',
                buyFromMerchant: 'Kup od obchodn칤ka (~200 游눯)',
                lootFromEnemies: 'Loot z nep콏치tel',
                orGoToTower: 'Nebo jdi na', tower: 'Vys칤la캜'
            };
            
            if (!atRadioTower && !hasRadio) {
                showModal('游닡 R치dio', `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem; margin-bottom: 0.5rem;">游닡</div>
                        <div style="color: #ff6666; font-size: 1.1rem;">${radioTexts.noRadio}</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #333;">
                        <h4 style="margin: 0 0 0.8rem 0; color: #64b5f6;">游니 ${radioTexts.whatRadioDoes}</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; line-height: 1.8; color: #ccc;">
                            <li>游닆 <strong>${radioTexts.radioNews}</strong> - ${radioTexts.radioNewsDesc}</li>
                            <li>游눑 <strong>${radioTexts.treasureCoords}</strong> - ${radioTexts.treasureDesc}</li>
                            <li>游꿢 <strong>${radioTexts.quests}</strong> - ${radioTexts.questsDesc}</li>
                            <li>丘멆잺 <strong>${radioTexts.warnings}</strong> - ${radioTexts.warningsDesc}</li>
                            <li>游냙 <strong>${radioTexts.caravanInfo}</strong> - ${radioTexts.caravanDesc}</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--toxic-dark);">
                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">游눠 ${radioTexts.howToGet}</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem; color: #aaa;">
                            <li>游댌 ${radioTexts.findExploring}</li>
                            <li>游 ${radioTexts.buyFromMerchant}</li>
                            <li>游닍 ${radioTexts.lootFromEnemies}</li>
                            <li>游니 ${radioTexts.orGoToTower} <strong>${radioTexts.tower}</strong>!</li>
                        </ul>
                    </div>
                    
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const message = RADIO_MESSAGES[Math.floor(Math.random() * RADIO_MESSAGES.length)];
            let content = message.message;
            
            // P콏idej lokaci pro questy (nov칳 syst칠m)
            if (message.type === 'quest') {
                // Vyber n치hodnou lokaci z WORLD_LOCATIONS
                const questLocations = WORLD_LOCATIONS.filter(l => 
                    l.type !== 'home' && l.type !== 'empty' && l.zone !== 'safe'
                );
                if (questLocations.length > 0) {
                    const questLoc = questLocations[Math.floor(Math.random() * questLocations.length)];
                    content += ` [${questLoc.name}]`;
                    
                    if (message.questType === 'treasure') {
                        state.treasureLocation = { 
                            locationId: questLoc.id,
                            locationName: questLoc.name,
                            expiresAt: Date.now() + 30 * 60 * 1000
                        };
                    }
                }
            }
            
            state.radio.messages = state.radio.messages || [];
            state.radio.messages.push({ message: content, time: Date.now() });
            
            // Z칤skej info o karavan치ch
            const caravanActive = state.caravan?.active || state.caravanPresent;
            const caravanTimeLeft = caravanActive && state.caravan?.until ? Math.max(0, Math.ceil((state.caravan.until - Date.now()) / 1000)) : 0;
            const nextCaravanCheck = state.caravan?.nextCheck ? Math.max(0, Math.ceil((state.caravan.nextCheck - Date.now()) / 60000)) : 60;
            const caravanInfo = caravanActive ? 
                `<div style="color: #ffd700;">游냙 ${'Karavana je v oblasti!'} (${Math.floor(caravanTimeLeft/60)}:${String(caravanTimeLeft%60).padStart(2,'0')})</div>
                 <button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 0.5rem; background: #8B4513;">游냙 ${'Nav코t칤vit karavanu'}</button>` : 
                `<div style="color: #888;">游냙 ${'콯치dn치 karavana v dosahu'}</div>
                 <div style="color: #666; font-size: 0.8rem;">${'Dal코칤 코ance za'} ~${nextCaravanCheck} min (25-70%)</div>`;
            
            // Denn칤 캜as
            const hour = new Date().getHours();
            const dayTime = hour >= 6 && hour < 20 ? ('驕勇 Den') : ('游깿 Noc');
            const dayTimeDesc = hour >= 6 && hour < 20 ? ('Bezpe캜n캩j코칤 cestov치n칤') : ('V칤ce nep콏치tel, ale lep코칤 loot');
            
            // Poklad info
            let treasureInfo = '';
            if (state.treasureLocation && state.treasureLocation.locationId) {
                const timeLeft = state.treasureLocation.expiresAt ? Math.max(0, Math.ceil((state.treasureLocation.expiresAt - Date.now()) / 60000)) : 0;
                if (timeLeft > 0) {
                    treasureInfo = `<div style="color: #ffd700; margin-top: 0.5rem;">游눑 ${'Poklad v'}: <strong>${state.treasureLocation.locationName}</strong> <span style="color: #888;">(${timeLeft} min)</span></div>`;
                } else {
                    // Vypr코elo
                    state.treasureLocation = null;
                }
            }
            
            showModal('游닡 R치dio', `
                <!-- R치diov치 zpr치va -->
                <div style="background: #0a0a0a; padding: 1rem; border-radius: 8px; font-family: monospace; border: 1px solid #333; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">游닡 ${'Zachycen치 zpr치va'}</h4>
                    <p style="color: #666; font-size: 0.85rem;">*${'코um'}* ... *${'prask치n칤'}* ...</p>
                    <p style="margin: 0.5rem 0; color: #fff;">"${content}"</p>
                    <p style="color: #666; font-size: 0.85rem;">*${'코um'}* ...</p>
                </div>
                
                <!-- Obecn칠 info -->
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.9rem;">游늵 Info</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                        <div>${dayTime}</div>
                        <div style="color: #888;">${dayTimeDesc}</div>
                        <div>游늸 ${'Lokace'}</div>
                        <div style="color: #888;">${WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation)?.name || ('Nezn치m치')}</div>
                        <div>游늰 ${'Den'}</div>
                        <div style="color: #888;">${state.time.days + 1}</div>
                    </div>
                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                        ${caravanInfo}
                        ${treasureInfo}
                    </div>
                </div>
                
                <button class="btn" onclick="useRadio()" style="width: 100%; margin-top: 0.5rem;">游닡 ${'Hledat dal코칤 frekvenci'}</button>
                <button class="btn" onclick="closeModal(); showExportImport();" style="width: 100%; margin-top: 0.5rem; background: #6A1B9A;">游님 ${'P콏enos postavy'}</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Vypnout'}</button>
            `);
        }
        
        // Speci치ln칤 akce na vys칤la캜i - siln캩j코칤 sign치l
        function useRadioTowerSignal() {
            // Cooldown 30 minut
            const cooldownKey = 'radio_tower_signal';
            const lastUse = state.cooldowns?.[cooldownKey] || 0;
            const cooldownTime = 30 * 60 * 1000; // 30 minut
            const now = Date.now();
            
            if (now - lastUse < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastUse)) / 60000);
                showModal('游니 Vys칤la캜', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游니</div>
                        <p style="color: #ff9800;">Vys칤la캜 se nab칤j칤...</p>
                        <p style="color: #888;">Dal코칤 pou쬴t칤 za ${remaining} minut</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Nastav cooldown
            if (!state.cooldowns) state.cooldowns = {};
            state.cooldowns[cooldownKey] = now;
            
            // N치hodn칳 efekt
            const effects = [
                { type: 'caravan', weight: 30, name: 'P콏ivol치n칤 karavany', icon: '游냙' },
                { type: 'treasure', weight: 20, name: 'Sou콏adnice pokladu', icon: '游눑' },
                { type: 'bonus_xp', weight: 25, name: 'Motivuj칤c칤 zpr치va', icon: '救' },
                { type: 'item', weight: 15, name: 'Z치silka z 칠teru', icon: '游닍' },
                { type: 'enemy_info', weight: 10, name: 'Intel o nep콏치tel칤ch', icon: '游꿢' }
            ];
            
            const totalWeight = effects.reduce((sum, e) => sum + e.weight, 0);
            let roll = Math.random() * totalWeight;
            let selectedEffect = effects[0];
            
            for (const effect of effects) {
                roll -= effect.weight;
                if (roll <= 0) {
                    selectedEffect = effect;
                    break;
                }
            }
            
            let resultHtml = '';
            
            switch (selectedEffect.type) {
                case 'caravan':
                    state.caravanPresent = true;
                    state.caravan = state.caravan || {};
                    state.caravan.active = true;
                    state.caravan.until = now + 10 * 60 * 1000; // 10 minut
                    resultHtml = `
                        <p style="color: #8bc34a;">Sign치l p콏il치kal karavanu!</p>
                        <p>Obchodn칤k bude v oblasti 10 minut.</p>
                        <button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 0.5rem; background: #8B4513;">游냙 Nav코t칤vit karavanu</button>
                    `;
                    break;
                    
                case 'treasure':
                    // Vyber n치hodnou lokaci pro poklad (ne aktu치ln칤, ne shelter)
                    const treasureLocations = WORLD_LOCATIONS.filter(l => 
                        l.id !== state.world.currentLocation && 
                        l.id !== 'shelter' &&
                        !l.id.includes('bunker') // ne bunkry - t캩쬶o dostupn칠
                    );
                    const treasureLoc = treasureLocations[Math.floor(Math.random() * treasureLocations.length)];
                    
                    if (treasureLoc) {
                        state.treasureLocation = { 
                            locationId: treasureLoc.id, 
                            locationName: treasureLoc.name,
                            expiresAt: Date.now() + (60 * 60 * 1000) // 1 hodina na nalezen칤
                        };
                        resultHtml = `
                            <p style="color: #ffd700;">Zachyceny sou콏adnice pokladu!</p>
                            <p>Poklad je v lokaci: <strong>${treasureLoc.icon} ${treasureLoc.name}</strong></p>
                            <p style="color: #888; font-size: 0.8rem;">M치코 1 hodinu ne zmiz칤!</p>
                        `;
                    } else {
                        // Fallback - dej hr치캜i p콏칤mo n캩co
                        addXP(75);
                        resultHtml = `
                            <p style="color: #ffd700;">Sou콏adnice byly po코kozen칠...</p>
                            <p style="color: #8bc34a;">Ale z칤skal jsi +75 XP za dek칩dov치n칤!</p>
                        `;
                    }
                    break;
                    
                case 'bonus_xp':
                    const xpBonus = 50 + Math.floor(Math.random() * 50);
                    addXP(xpBonus);
                    resultHtml = `
                        <p style="color: #64b5f6;">Zachytil jsi motivuj칤c칤 zpr치vu od p콏e쬴v코칤ch!</p>
                        <p style="color: #8bc34a;">+${xpBonus} XP</p>
                    `;
                    break;
                    
                case 'item':
                    const items = ['stimpak', 'bandage', 'canned_food', 'water_bottle', 'ammo_9mm'];
                    const itemId = items[Math.floor(Math.random() * items.length)];
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) {
                        const existing = state.inv.find(i => i.id === itemId);
                        if (existing) {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            state.inv.push({...item, count: 1});
                        }
                        resultHtml = `
                            <p style="color: #8bc34a;">N캩kdo ti poslal z치silku!</p>
                            <p>${item.icon} ${item.name}</p>
                        `;
                    }
                    break;
                    
                case 'enemy_info':
                    addXP(25);
                    resultHtml = `
                        <p style="color: #ff9800;">Zachytil jsi vojenskou frekvenci!</p>
                        <p>Intel o pohybu nep콏치tel v oblasti.</p>
                        <p style="color: #8bc34a;">+25 XP, +10% damage na 1 hodinu</p>
                    `;
                    // Do캜asn칳 bonus
                    state.tempBonuses = state.tempBonuses || {};
                    state.tempBonuses.damage = { value: 1.1, until: now + 60 * 60 * 1000 };
                    break;
            }
            
            SoundSystem.play('pickup');
            showModal('游니 Sign치l z vys칤la캜e', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${selectedEffect.icon}</div>
                    <h3 style="color: #64b5f6;">${selectedEffect.name}</h3>
                    ${resultHtml}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            
            addLog(`Pou쬴l jsi vys칤la캜: ${selectedEffect.name}`, '游니');
            renderFull();
        }
        
        // === QUEST SYST칄M ===
        function getCurrentQuest() {
            if (!state.mainQuest?.currentQuest) return null;
            return MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
        }
        
        function openAllQuests() {
            const quest = getCurrentQuest();
            const completedStoryCount = state.mainQuest?.completedQuests?.length || 0;
            const dailyCompleted = state.dailyQuests.completed?.length || 0;
            const dailyTotal = state.dailyQuests.quests?.length || 0;
            
            // Spo캜칤tej aktivn칤 NPC questy
            const activeNpcQuests = Object.entries(state.npcQuests || {}).filter(([npcId, q]) => q && q.id);
            const activeSettlerQuests = state.settlement?.activeQuests || [];
            
            showModal('游늶 P콏ehled 칰kol콢', `
                <style>
                    .quest-tabs { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem; }
                    .quest-tab { flex: 1; min-width: 60px; padding: 0.5rem 0.3rem; background: #1a1a1a; border: 2px solid #333; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.7rem; transition: all 0.2s; }
                    .quest-tab:hover { border-color: #555; }
                    .quest-tab.active { border-color: var(--rust-light); background: linear-gradient(180deg, #2a2018, #1a1510); }
                    .quest-tab .tab-icon { font-size: 1.2rem; display: block; }
                    .quest-content { display: none; max-height: 350px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
                    .quest-content.active { display: block; }
                    .quest-card { background: #1a1a1a; padding: 0.7rem; border-radius: 6px; border: 1px solid #333; margin-bottom: 0.5rem; }
                    .quest-card.completed { background: linear-gradient(135deg, #1a3a1a, #0a2a0a); border-color: #4caf50; }
                    .quest-card.active-quest { 
                        border-color: #ff9800; 
                        border-width: 2px; 
                        background: linear-gradient(135deg, #2a2a1a, #1a1a0a);
                        box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
                    }
                    .quest-card.active-quest::before {
                        content: '游늷 AKTIVN칈';
                        display: block;
                        font-size: 0.65rem;
                        color: #ff9800;
                        font-weight: bold;
                        margin-bottom: 0.3rem;
                        text-transform: uppercase;
                    }
                </style>
                
                <div class="quest-tabs">
                    <div class="quest-tab active" onclick="switchQuestTab('daily')" id="tab-btn-daily">
                        <span class="tab-icon">游늶</span>
                        ${'Denn칤'} <span style="color: ${dailyCompleted >= dailyTotal ? '#8bc34a' : '#7986CB'};">${dailyCompleted}/${dailyTotal}</span>
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('story')" id="tab-btn-story">
                        <span class="tab-icon">游닆</span>
                        ${'P콏칤b캩h'}
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('npc')" id="tab-btn-npc">
                        <span class="tab-icon">游논</span>
                        NPC <span style="color: #ff9800;">${activeNpcQuests.length > 0 ? '(' + activeNpcQuests.length + ')' : ''}</span>
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('settler')" id="tab-btn-settler">
                        <span class="tab-icon">游끶勇</span>
                        ${'Osada'} <span style="color: #ff9800;">${activeSettlerQuests.length > 0 ? '(' + activeSettlerQuests.length + ')' : ''}</span>
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('faction')" id="tab-btn-faction">
                        <span class="tab-icon">游끹勇</span>
                        ${'Frakce'}
                    </div>
                </div>
                
                <!-- DENN칈 칔KOLY -->
                <div class="quest-content active" id="quest-daily">
                    <div style="margin-bottom: 0.8rem; padding: 0.5rem; background: linear-gradient(90deg, #1a1a2a, #2a1a3a); border-radius: 6px; border: 1px solid #3949AB;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #7986CB; font-size: 0.85rem;">${currentLang === "en" ? "Completed:" : "Spln캩no:"}</span>
                            <span style="color: ${dailyCompleted >= dailyTotal ? '#8bc34a' : '#ffd700'}; font-weight: bold;">${dailyCompleted}/${dailyTotal}</span>
                        </div>
                        <p style="color: #666; font-size: 0.7rem; margin-top: 0.2rem;">${currentLang === "en" ? "낋 Resets every 24 hours" : "낋 Resetuje se ka쬯칳ch 24 hodin"}</p>
                    </div>
                    
                    ${state.dailyQuests.quests && state.dailyQuests.quests.length > 0 ? 
                        state.dailyQuests.quests.map(dq => {
                            const completed = state.dailyQuests.completed?.includes(dq.id);
                            const progress = state.dailyQuests.progress || {};
                            
                            // Najdi origin치ln칤 quest pro target a progressKey
                            const originalQuest = DAILY_QUEST_POOL.find(q => q.id === dq.id);
                            let currentProgress = 0, targetProgress = 1;
                            
                            if (originalQuest && originalQuest.progressKey) {
                                currentProgress = progress[originalQuest.progressKey] || 0;
                                targetProgress = originalQuest.target || 1;
                            }
                            
                            const progressPercent = Math.min(100, (currentProgress / targetProgress) * 100);
                            
                            // P콏eklad quest name a desc
                            const questTranslation = TRANSLATIONS[currentLang]?.dailyQuests?.[dq.id];
                            const questName = questTranslation?.name || dq.name;
                            const questDesc = questTranslation?.desc || dq.desc;
                            
                            return '<div class="quest-card ' + (completed ? 'completed' : '') + '">' +
                                '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                    '<span style="font-size: 1.3rem;">' + dq.icon + '</span>' +
                                    '<div style="flex: 1;">' +
                                        '<div style="font-weight: bold; color: ' + (completed ? '#8bc34a' : '#fff') + '; font-size: 0.9rem;">' + questName + '</div>' +
                                        '<div style="font-size: 0.75rem; color: #888;">' + questDesc + '</div>' +
                                    '</div>' +
                                    '<span style="font-size: 1.2rem;">' + (completed ? '九' : '낍') + '</span>' +
                                '</div>' +
                                (!completed ? '<div style="margin-top: 0.4rem;"><div style="height: 4px; background: #0a0a0a; border-radius: 2px; overflow: hidden;"><div style="height: 100%; width: ' + progressPercent + '%; background: ' + (progressPercent >= 100 ? '#8bc34a' : '#ff9800') + ';"></div></div><div style="text-align: right; font-size: 0.65rem; color: #666;">' + currentProgress + '/' + targetProgress + '</div></div>' : '') +
                            '</div>';
                        }).join('')
                        : `<p style="text-align: center; color: #666;">${'콯치dn칠 denn칤 칰koly'}</p>`
                    }
                </div>
                
                <!-- P콎칈B캨HOV칄 칔KOLY -->
                <div class="quest-content" id="quest-story">
                    <div style="margin-bottom: 0.8rem; padding: 0.4rem; background: linear-gradient(90deg, #1a1a2e, #16213e); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                            <span style="color: #ffd700;">游닀 ${'Kapitola'} ${state.mainQuest?.chapter || 0}/4</span>
                            <span style="color: #888;">${completedStoryCount}/${MAIN_QUESTS.length}</span>
                        </div>
                        <div style="background: #333; height: 5px; border-radius: 3px; overflow: hidden; margin-top: 0.4rem;">
                            <div style="background: linear-gradient(90deg, #ffd700, #ff9800); height: 100%; width: ${(state.mainQuest?.chapter || 0) * 25}%;"></div>
                        </div>
                    </div>
                    
                    ${state.mainQuest?.storyComplete ? 
                        '<div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #1a3a1a, #2a4a2a); border-radius: 8px;"><div style="font-size: 3rem;">游끥</div><h3 style="color: #ffd700; margin: 0.5rem 0;">' + ('P콎칈B캨H DOKON캛EN!') + '</h3><p style="color: #8bc34a; font-size: 0.9rem;">' + ('Zachr치nil jsi lidstvo!') + '</p></div>'
                    : quest ? 
                        (function() {
                            // Kontrola zda jsou v코echny c칤le spln캩n칠
                            var allComplete = quest.objectives.every(function(obj) {
                                var prog = state.mainQuest?.questProgress?.[obj.id] || 0;
                                if (obj.type === 'visit_locations') return state.world.visitedLocations.length >= obj.target;
                                if (obj.type === 'location') return prog >= 1;
                                if (obj.type === 'explore') return prog >= obj.target;
                                if (obj.type === 'item') return state.inv.some(function(i) { return i.id === obj.target; });
                                if (obj.type === 'kill') return prog >= 1;
                                return prog >= 1;
                            });
                            
                            // Kontrola po쬬dovan칠ho itemu
                            var hasRequiredItem = !quest.requiresItem || state.inv.some(function(i) { return i.id === quest.requiresItem; });
                            var canComplete = allComplete && hasRequiredItem;
                            
                            return '<div class="quest-card active-quest">' +
                                '<h3 style="margin: 0; color: #d4722e; font-size: 1rem;">游늷 ' + getMainQuestTitle(quest.id) + '</h3>' +
                                '<p style="color: #888; margin: 0.3rem 0; font-size: 0.8rem;">' + getMainQuestDesc(quest.id) + '</p>' +
                                '<div style="margin-top: 0.6rem;">' +
                                    quest.objectives.map(function(obj) {
                                        var prog = state.mainQuest?.questProgress?.[obj.id] || 0;
                                        var complete = false;
                                        var displayProg = '';
                                        var locationName = '';
                                        
                                        if (obj.type === 'visit_locations') { prog = state.world.visitedLocations.length; complete = prog >= obj.target; displayProg = Math.min(prog, obj.target) + '/' + obj.target; }
                                        else if (obj.type === 'location') { 
                                            complete = prog >= 1;
                                            // Zobraz n치zev lokace
                                            var loc = WORLD_LOCATIONS.find(function(l) { return l.id === obj.target; });
                                            if (loc && !complete) locationName = ' <span style="color: #ff9800;">(游늸' + loc.name + ')</span>';
                                        }
                                        else if (obj.type === 'explore') { complete = prog >= obj.target; displayProg = prog + '/' + obj.target; }
                                        else if (obj.type === 'item') { complete = state.inv.some(function(i) { return i.id === obj.target; }); }
                                        else if (obj.type === 'kill') { complete = prog >= 1; }
                                        else { complete = prog >= 1; }
                                        
                                        return '<div style="display: flex; align-items: center; gap: 0.3rem; margin: 0.2rem 0; padding: 0.2rem 0.4rem; background: ' + (complete ? '#1a3a1a' : '#0a0a0a') + '; border-radius: 3px; font-size: 0.8rem;">' +
                                            '<span style="color: ' + (complete ? '#8bc34a' : '#666') + ';">' + (complete ? '九' : '餃') + '</span>' +
                                            '<span style="flex: 1; ' + (complete ? 'text-decoration: line-through; color: #666;' : '') + '">' + obj.text + locationName + '</span>' +
                                            (displayProg ? '<span style="color: #888; font-size: 0.7rem;">' + displayProg + '</span>' : '') +
                                        '</div>';
                                    }).join('') +
                                '</div>' +
                                '<div style="margin-top: 0.5rem; padding: 0.3rem; background: #0a1a0a; border-radius: 3px; font-size: 0.75rem; color: #8bc34a;">游꾸 ' + quest.reward.xp + ' XP, ' + quest.reward.money + ' 游눯</div>' +
                                (canComplete ? '<button class="btn" onclick="manualCompleteQuest(\'' + quest.id + '\')" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #4caf50, #2e7d32); font-weight: bold;">九 ' + ('Dokon캜it 칰kol') + '</button>' : '') +
                            '</div>';
                        })()
                    : '<p style="text-align: center; color: #666;">' + ('콯치dn칳 aktivn칤 p콏칤b캩hov칳 quest') + '</p>'
                    }
                    
                    ${completedStoryCount > 0 ? 
                        '<details style="margin-top: 0.6rem;"><summary style="cursor: pointer; color: #888; font-size: 0.8rem;">游닄 ' + ('Dokon캜en칠') + ' (' + completedStoryCount + ')</summary><div style="margin-top: 0.4rem;">' +
                        (state.mainQuest?.completedQuests || []).map(function(qId) {
                            var q = MAIN_QUESTS.find(function(mq) { return mq.id === qId; });
                            return q ? '<div style="padding: 0.2rem 0.4rem; color: #666; font-size: 0.75rem;">九 ' + getMainQuestTitle(qId) + '</div>' : '';
                        }).join('') + '</div></details>'
                    : ''}
                    
                    <!-- ZJIT캨N칄 INFORMACE O P콎칈B캨HU -->
                    ${(function() {
                        const completed = state.mainQuest?.completedQuests || [];
                        const currentQuest = state.mainQuest?.currentQuest;
                        const karma = state.storyKarma || { kory: 0, koudy: 0, componentsGiven: { kory: 0, koudy: 0 } };
                        
                        // Informace podle progressu
                        const discoveries = [];
                        
                        // Po 칰vodu
                        if (completed.includes('intro') || ['find_stranger', 'meet_brothers'].includes(currentQuest) || completed.includes('find_stranger')) {
                            discoveries.push({
                                icon: '游눤',
                                title: 'Apokalypsa',
                                text: 'Sv캩t byl zni캜en n캩jakou katastrofou. Projekt Genesis...'
                            });
                        }
                        
                        // Po setk치n칤 se starcem
                        if (completed.includes('find_stranger') || completed.includes('meet_brothers')) {
                            discoveries.push({
                                icon: '游논',
                                title: 'Dva brat콏i',
                                text: 'Kory a Koudy - oba hledaj칤 Projekt Genesis. Jeden z nich l쬰. Ale kter칳?'
                            });
                        }
                        
                        // Po setk치n칤 s ob캩ma bratry
                        if (completed.includes('meet_brothers') || completed.includes('first_component')) {
                            discoveries.push({
                                icon: '游붳',
                                title: 'Kory',
                                text: 'Charismatick칳 mu. Mluv칤 o "o캜ist캩" a "nov칠m sv캩t캩". S칤dl칤 v Trading Post.'
                            });
                            discoveries.push({
                                icon: '游녿꽳릢',
                                title: 'Koudy',
                                text: 'Unaven칳 v캩dec. Tvrd칤, 쬰 jeho bratr je nebezpe캜n칳. S칤dl칤 v Research Facility.'
                            });
                        }
                        
                        // Po prvn칤m komponentu
                        if (completed.includes('first_component') || completed.includes('second_component')) {
                            discoveries.push({
                                icon: '驕뮖잺',
                                title: 'Plutoniov칠 j치dro',
                                text: 'Prvn칤 ze 캜ty콏 komponent콢 Projektu Genesis. Radioaktivn칤 a nebezpe캜n칠.'
                            });
                        }
                        
                        // Po dokumentech
                        if (completed.includes('find_document') || completed.includes('third_component')) {
                            discoveries.push({
                                icon: '游닆',
                                title: 'Tajn칠 dokumenty',
                                text: 'Projekt Genesis m콢쬰 BU캝 vy캜istit radiaci, NEBO vyvolat zk치zu. Z치le쮂 na konfiguraci!'
                            });
                        }
                        
                        // Po odhalen칤 pravdy
                        if (completed.includes('truth_revealed') || completed.includes('fourth_component')) {
                            discoveries.push({
                                icon: '游댌',
                                title: 'PRAVDA ODHALENA',
                                text: 'Kory byl vedouc칤m vojensk칠ho projektu. V캩콏칤, 쬰 lidstvo je "nemoc". Koudy se pokusil projekt sabotovat - proto do코lo k explozi!'
                            });
                        }
                        
                        // Po 캜tvrt칠m komponentu - info o Bu캜ovic칤ch
                        if (completed.includes('fourth_component') || currentQuest === 'final_choice') {
                            discoveries.push({
                                icon: '游낋',
                                title: 'Bu캜ovice - M칤sto rozhodnut칤',
                                text: 'Oba brat콏i se dozv캩d캩li, 쬰 m치코 v코echny komponenty. 캛ekaj칤 na tebe v Bu캜ovic칤ch, hlavn칤m m캩st캩 pustiny.'
                            });
                        }
                        
                        // Komponenty p콏ed치ny
                        if (karma.componentsGiven.kory > 0 || karma.componentsGiven.koudy > 0) {
                            discoveries.push({
                                icon: '游닍',
                                title: 'Komponenty p콏ed치ny',
                                text: 'Kory: ' + (karma.componentsGiven.kory || 0) + '/4 | Koudy: ' + (karma.componentsGiven.koudy || 0) + '/4'
                            });
                        }
                        
                        // Ending
                        if (state.storyKarma?.ending) {
                            const endingText = {
                                dark: '游깸 Kory aktivoval Genesis. Sv캩t byl "o캜i코t캩n".',
                                hope: '游깬 Koudy aktivoval Genesis. Sv캩t se za캜칤n치 uzdravovat.',
                                neutral: '丘뒲잺 Projekt Genesis byl zni캜en. Sv캩t z콢st치v치 takov칳, jak칳 je.'
                            };
                            discoveries.push({
                                icon: '游끥',
                                title: 'KONEC P콎칈B캨HU',
                                text: endingText[state.storyKarma.ending]
                            });
                        }
                        
                        if (discoveries.length === 0) return '';
                        
                        return '<details style="margin-top: 0.8rem; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 8px; padding: 0.5rem;" open>' +
                            '<summary style="cursor: pointer; color: #64b5f6; font-size: 0.9rem; font-weight: bold;">游댍 Zji코t캩n칠 informace (' + discoveries.length + ')</summary>' +
                            '<div style="margin-top: 0.5rem;">' +
                                discoveries.map(function(d) {
                                    return '<div style="padding: 0.5rem; margin: 0.3rem 0; background: #0a0a1a; border-radius: 6px; border-left: 3px solid #64b5f6;">' +
                                        '<div style="display: flex; align-items: center; gap: 0.4rem;">' +
                                            '<span style="font-size: 1.2rem;">' + d.icon + '</span>' +
                                            '<span style="color: #fff; font-weight: bold; font-size: 0.85rem;">' + d.title + '</span>' +
                                        '</div>' +
                                        '<p style="margin: 0.3rem 0 0 0; color: #aaa; font-size: 0.75rem;">' + d.text + '</p>' +
                                    '</div>';
                                }).join('') +
                            '</div>' +
                        '</details>';
                    })()}
                </div>
                
                <!-- NPC 칔KOLY -->
                <div class="quest-content" id="quest-npc">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">Aktivn칤 칰koly od NPC:</p>
                    
                    ${activeNpcQuests.length > 0 ? activeNpcQuests.map(function([npcId, npcQuest]) {
                        const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                        if (!npc) return '';
                        const trust = state.npcRelations?.[npcId]?.trust || 0;
                        const questDef = NPC_QUESTS[npcQuest.id];
                        
                        return '<div class="quest-card active-quest">' +
                            '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                '<span style="font-size: 1.5rem;">' + npc.icon + '</span>' +
                                '<div style="flex: 1;">' +
                                    '<div style="font-weight: bold; color: #fff; font-size: 0.9rem;">' + npc.name + '</div>' +
                                    '<div style="font-size: 0.7rem; color: #888;">游늸 ' + (WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location) + '</div>' +
                                    '<div style="font-size: 0.7rem; color: #ffd700;">仇벒잺 D콢v캩ra: ' + trust + '</div>' +
                                '</div>' +
                            '</div>' +
                            (function() {
                                const progress = getNPCQuestProgress(npcQuest, questDef);
                                
                                const progressHtml = '<div style="margin-top: 0.3rem;">' +
                                    '<div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #888;">' +
                                    '<span>' + progress.label + ':</span>' +
                                    '<span style="color: ' + (progress.complete ? '#8bc34a' : '#ff9800') + ';">' + progress.current + '/' + progress.required + '</span>' +
                                    '</div>' +
                                    '<div style="height: 6px; background: #333; border-radius: 3px; overflow: hidden;">' +
                                    '<div style="height: 100%; width: ' + progress.percent + '%; background: linear-gradient(90deg, ' + (progress.complete ? '#4caf50, #8bc34a' : '#ff9800, #ffd700') + ');"></div>' +
                                    '</div>' +
                                    (progress.complete ? '<div style="text-align: center; color: #8bc34a; font-size: 0.7rem; margin-top: 0.2rem;">九 Spln캩no! Vra콘 se pro odm캩nu.</div>' : '') +
                                    '</div>';
                                
                                return '<div style="margin-top: 0.5rem; padding: 0.4rem; background: #0a0a0a; border-radius: 4px; border-left: 3px solid ' + (progress.complete ? '#4caf50' : '#ff9800') + ';">' +
                                    '<div style="color: ' + (progress.complete ? '#8bc34a' : '#ff9800') + '; font-size: 0.85rem; font-weight: bold;">游늷 ' + (questDef?.name || 'Aktivn칤 칰kol') + '</div>' +
                                    '<div style="color: #888; font-size: 0.75rem;">' + (questDef?.desc || '') + '</div>' +
                                    (questDef?.details ? '<div style="color: #64b5f6; font-size: 0.7rem; margin-top: 0.3rem; padding: 0.3rem; background: #1a1a2a; border-radius: 3px;">' + questDef.details + '</div>' : '') +
                                    progressHtml +
                                '</div>';
                            })() +
                        '</div>';
                    }).join('') : '<div style="text-align: center; padding: 1rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">游논</div><p>콯치dn칠 aktivn칤 NPC 칰koly</p><p style="font-size: 0.8rem; color: #888;">Nav코tiv NPC a zeptej se na 칰koly</p></div>'}
                </div>
                
                <!-- OSADNICK칄 칔KOLY -->
                <div class="quest-content" id="quest-settler">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">칔koly od obyvatel tv칠 osady:</p>
                    
                    ${activeSettlerQuests.length > 0 ? 
                        activeSettlerQuests.map(function(sq, sqIdx) {
                            const questDef = SETTLER_QUESTS.find(q => q.id === sq.questId);
                            const settler = state.settlement?.settlers?.find(s => s.name === sq.settlerName);
                            const settlerType = settler ? SETTLER_TYPES.find(t => t.id === settler.type) : null;
                            
                            return '<div class="quest-card active-quest" onclick="showSettlerQuestDetail(' + sqIdx + ')" style="cursor: pointer;">' +
                                '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                    '<span style="font-size: 1.3rem;">' + (questDef?.icon || '游늶') + '</span>' +
                                    '<div style="flex: 1;">' +
                                        '<div style="font-weight: bold; color: #ff9800; font-size: 0.9rem;">' + (questDef?.name || '칔kol') + '</div>' +
                                        '<div style="font-size: 0.75rem; color: #888;">Od: ' + (sq.settlerName || 'Osadn칤k') + ' ' + (settlerType?.icon || '') + '</div>' +
                                        '<div style="font-size: 0.75rem; color: #aaa;">' + (questDef?.desc || '') + '</div>' +
                                    '</div>' +
                                    '<span style="color: #4caf50;"></span>' +
                                '</div>' +
                            '</div>';
                        }).join('')
                    : '<div style="text-align: center; padding: 1rem; color: #666;">' +
                        '<div style="font-size: 2rem; margin-bottom: 0.5rem;">游끶勇</div>' +
                        '<p>콯치dn칠 aktivn칤 칰koly od osadn칤k콢</p>' +
                        '<p style="font-size: 0.75rem;">Osadn칤ci ti ob캜as nab칤dnou mise</p>' +
                      '</div>'
                    }
                    
                    <div style="margin-top: 1rem; padding: 0.5rem; background: #0a0a0a; border-radius: 4px;">
                        <div style="color: #888; font-size: 0.75rem;">游논 Osadn칤k콢: ${state.settlement?.settlers?.length || 0}</div>
                        <div style="color: #888; font-size: 0.75rem;">游 Budov: ${(state.base?.length || 0) + (state.settlement?.buildings?.length || 0)}</div>
                    </div>
                </div>
                
                <!-- FRAKCE -->
                <div class="quest-content" id="quest-faction">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">Tv칠 vztahy s frakcemi v pustin캩:</p>
                    
                    ${FACTIONS.map(function(faction) {
                        const rep = state.factions?.[faction.id]?.reputation || 0;
                        const level = REPUTATION_LEVELS.find(l => rep >= l.min && rep <= l.max) || REPUTATION_LEVELS[2];
                        
                        return '<div class="quest-card" style="border-left: 3px solid ' + faction.color + ';">' +
                            '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                '<span style="font-size: 1.5rem;">' + faction.icon + '</span>' +
                                '<div style="flex: 1;">' +
                                    '<div style="font-weight: bold; color: ' + faction.color + '; font-size: 0.9rem;">' + faction.name + '</div>' +
                                    '<div style="font-size: 0.7rem; color: #888;">' + faction.desc.substring(0, 50) + '...</div>' +
                                '</div>' +
                                '<div style="text-align: right;">' +
                                    '<div style="font-size: 1rem;">' + level.icon + '</div>' +
                                    '<div style="font-size: 0.7rem; color: ' + level.color + ';">' + level.name + '</div>' +
                                    '<div style="font-size: 0.65rem; color: #666;">' + rep + '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    }).join('')}
                    
                    <div style="margin-top: 1rem; padding: 0.6rem; background: linear-gradient(135deg, #1a1520, #201525); border-radius: 6px; border: 1px solid #9c27b0;">
                        <div style="font-weight: bold; color: #ce93d8; margin-bottom: 0.5rem;">丘덢잺 Projekt Genesis</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div style="text-align: center; padding: 0.4rem; background: #1a0a0a; border-radius: 4px;">
                                <div style="font-size: 1.5rem;">游붳</div>
                                <div style="color: #ff5252; font-size: 0.85rem;">Kory</div>
                                <div style="color: #888; font-size: 0.7rem;">Karma: ${state.storyKarma?.kory || 0}</div>
                            </div>
                            <div style="text-align: center; padding: 0.4rem; background: #0a0a1a; border-radius: 4px;">
                                <div style="font-size: 1.5rem;">游녿꽳릢</div>
                                <div style="color: #64b5f6; font-size: 0.85rem;">Koudy</div>
                                <div style="color: #888; font-size: 0.7rem;">Karma: ${state.storyKarma?.koudy || 0}</div>
                            </div>
                        </div>
                        ${state.activeQuest ? 
                            '<div style="margin-top: 0.5rem; padding: 0.3rem; background: #0a0a0a; border-radius: 3px; text-align: center;"><span style="color: #ff9800; font-size: 0.8rem;">游늷 Aktivn칤: ' + (NPC_QUESTS[state.activeQuest.questId]?.name || 'Quest') + '</span></div>'
                        : ''}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function switchQuestTab(tab) {
            // Deaktivuj v코echny taby
            document.querySelectorAll('.quest-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.quest-content').forEach(c => c.classList.remove('active'));
            
            // Aktivuj vybran칳 tab
            document.getElementById('tab-btn-' + tab)?.classList.add('active');
            document.getElementById('quest-' + tab)?.classList.add('active');
        }
        
        // Zachov치me star칠 funkce pro kompatibilitu
        function openDailyQuests() {
            openAllQuests();
        }
        
        // P콏esm캩rov치n칤 na novou slou캜enou funkci
        function openQuestLog() {
            openAllQuests();
            // Automaticky p콏epnout na p콏칤b캩hov칳 tab
            setTimeout(() => switchQuestTab('story'), 50);
        }
        
        function updateQuestProgress(type, value) {
            if (!state.mainQuest?.currentQuest) return;
            
            const quest = getCurrentQuest();
            if (!quest) return;
            
            state.mainQuest.questProgress = state.mainQuest.questProgress || {};
            
            quest.objectives.forEach(obj => {
                if (obj.type === type) {
                    if (type === 'visit_locations') {
                        // Po캜칤t치 nav코t칤ven칠 lokace
                        state.mainQuest.questProgress[obj.id] = state.world.visitedLocations.length;
                    } else if (type === 'location') {
                        // Nov칳 syst칠m - kontrola podle location ID
                        if (state.world.currentLocation === obj.target) {
                            state.mainQuest.questProgress[obj.id] = 1;
                        }
                    } else if (type === 'explore') {
                        state.mainQuest.questProgress[obj.id] = (state.mainQuest.questProgress[obj.id] || 0) + 1;
                    } else if (type === 'item') {
                        if (state.inv.some(i => i.id === obj.target)) {
                            state.mainQuest.questProgress[obj.id] = 1;
                        }
                    } else if (type === 'kill' && value === obj.target) {
                        state.mainQuest.questProgress[obj.id] = 1;
                    } else if (type === 'choice') {
                        // Choice quest - hr치캜 vyb칤r치 mezi mo쬹ostmi (nap콏. komu p콏edat komponenty)
                        if (obj.targets && obj.targets.includes(value)) {
                            state.mainQuest.questProgress[obj.id] = 1;
                            state.mainQuest.choiceMade = value; // Ulo jakou volbu hr치캜 ud캩lal
                        }
                    } else if (type === 'interact') {
                        // Interakce s NPC nebo objektem
                        if (value === obj.id || value === obj.target) {
                            state.mainQuest.questProgress[obj.id] = 1;
                        }
                    } else if (type === 'build') {
                        // Stavba - kontrola zdroj콢
                        if (obj.resources) {
                            const hasAll = Object.entries(obj.resources).every(([res, amt]) => state.resources[res] >= amt);
                            if (hasAll && value === obj.id) {
                                // Odeber zdroje
                                Object.entries(obj.resources).forEach(([res, amt]) => {
                                    state.resources[res] -= amt;
                                });
                                state.mainQuest.questProgress[obj.id] = 1;
                            }
                        }
                    } else if (type === 'collect') {
                        // Sb칤r치n칤 item콢 - kontrola invent치콏e
                        if (obj.items) {
                            const hasAll = obj.items.every(itemType => 
                                state.inv.some(i => i.type === itemType || i.id === itemType)
                            );
                            if (hasAll) {
                                state.mainQuest.questProgress[obj.id] = 1;
                            }
                        }
                    }
                }
                
                // Speci치ln칤 handling pro choice questy - vol치 se i p콏i location zm캩n캩
                if (obj.type === 'choice' && type === 'location') {
                    if (obj.targets && obj.targets.includes(value)) {
                        state.mainQuest.questProgress[obj.id] = 1;
                        state.mainQuest.choiceMade = value;
                    }
                }
            });
            
            checkQuestComplete();
        }
        
        function checkQuestComplete() {
            const quest = getCurrentQuest();
            if (!quest) return;
            
            const allComplete = quest.objectives.every(obj => {
                const progress = state.mainQuest.questProgress?.[obj.id] || 0;
                if (obj.type === 'location') return progress >= 1;
                if (obj.type === 'visit_locations') return state.world.visitedLocations.length >= obj.target;
                if (obj.type === 'explore') return progress >= obj.target;
                if (obj.type === 'item') return state.inv.some(i => i.id === obj.target);
                if (obj.type === 'kill') return progress >= 1;
                if (obj.type === 'choice') return progress >= 1;
                if (obj.type === 'interact') return progress >= 1;
                if (obj.type === 'build') return progress >= 1;
                if (obj.type === 'collect') return progress >= 1;
                return progress >= 1;
            });
            
            // Kontrola po쬬dovan칳ch item콢
            if (quest.requiresItem && !state.inv.some(i => i.id === quest.requiresItem)) {
                return;
            }
            
            if (allComplete) {
                completeQuest(quest);
            }
        }
        
        // Manu치ln칤 dokon캜en칤 questu (tla캜칤tko)
        function manualCompleteQuest(questId) {
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            // Ov캩콏en칤 쬰 je opravdu spln캩n칳
            const allComplete = quest.objectives.every(obj => {
                const progress = state.mainQuest?.questProgress?.[obj.id] || 0;
                if (obj.type === 'location') return progress >= 1;
                if (obj.type === 'visit_locations') return state.world.visitedLocations.length >= obj.target;
                if (obj.type === 'explore') return progress >= obj.target;
                if (obj.type === 'item') return state.inv.some(i => i.id === obj.target);
                if (obj.type === 'kill') return progress >= 1;
                if (obj.type === 'choice') return progress >= 1;
                if (obj.type === 'interact') return progress >= 1;
                if (obj.type === 'build') return progress >= 1;
                if (obj.type === 'collect') return progress >= 1;
                return progress >= 1;
            });
            
            if (!allComplete) {
                showModal('仇 Nelze dokon캜it', 'Nesplnil jsi v코echny c칤le questu!');
                return;
            }
            
            // Kontrola po쬬dovan칳ch item콢
            if (quest.requiresItem && !state.inv.some(i => i.id === quest.requiresItem)) {
                showModal('仇 Chyb칤 p콏edm캩t', `Pot콏ebuje코: ${quest.requiresItem}`);
                return;
            }
            
            closeModal();
            completeQuest(quest);
        }
        
        function completeQuest(quest) {
            // KRITICK칄: Nejd콏칤v p콏idat do completedQuests aby se zabr치nilo opakovan칠mu dokon캜en칤!
            if (!state.mainQuest) state.mainQuest = {};
            if (!state.mainQuest.completedQuests) state.mainQuest.completedQuests = [];
            
            // Kontrola zda u nen칤 dokon캜en (ochrana proti duplicit치m)
            if (state.mainQuest.completedQuests.includes(quest.id)) {
                console.warn('丘멆잺 Quest u byl dokon캜en:', quest.id);
                return;
            }
            
            // P콏idat do completed IHNED
            state.mainQuest.completedQuests.push(quest.id);
            state.mainQuest.questProgress = {};
            
            // Te캞 odm캩ny - s validac칤
            if (quest.reward?.xp) addXP(quest.reward.xp);
            if (quest.reward?.money) addMoney(quest.reward.money);
            
            // Odeber quest itemy
            if (quest.requiresItem) {
                state.inv = state.inv.filter(i => i.id !== quest.requiresItem);
            }
            
            // P콏idej quest item odm캩nu
            if (quest.reward.item) {
                const item = QUEST_ITEMS.find(i => i.id === quest.reward.item);
                if (item) {
                    state.inv.push({...item, count: 1});
                }
            }
            
            // NOV칄: Companion reward
            if (quest.reward?.companion) {
                const companionNames = ['Max', 'Elena', 'Viktor', 'Anna', 'Karel', 'Marie', 'Pavel', 'Zuzana'];
                const newCompanion = {
                    id: 'survivor',
                    uniqueId: 'companion_' + Date.now(),
                    name: companionNames[Math.floor(Math.random() * companionNames.length)],
                    icon: '游븸',
                    type: 'human',
                    hp: 50 + Math.floor(Math.random() * 30),
                    maxHp: 80,
                    damage: 8 + Math.floor(Math.random() * 5),
                    defense: 4 + Math.floor(Math.random() * 3),
                    level: 1,
                    xp: 0,
                    skillPoints: 1,
                    skills: [],
                    equipped: { weapon: null, armor: null, helmet: null, gloves: null, boots: null },
                    loyalty: 60 + Math.floor(Math.random() * 20),
                    ability: 'P콏e쬴v코칤',
                    abilityDesc: 'Zku코en칳 p콏e쬴v코칤 apokalypsy',
                    canEquip: true,
                    inCombat: true
                };
                addCompanionWithSwap(newCompanion, 'quest');
            }
            
            // Zjisti nextQuest - m콢쬰 b칳t statick칳 nebo z choiceEffects
            let nextQuestId = quest.nextQuest;
            let choiceDialog = null;
            
            // Pokud je to choice quest, pou쬴j nextQuest z choiceEffects podle volby hr치캜e
            if (quest.isChoice && quest.choiceEffects && state.mainQuest.choiceMade) {
                const choice = state.mainQuest.choiceMade;
                const choiceEffect = quest.choiceEffects[choice];
                if (choiceEffect) {
                    if (choiceEffect.nextQuest) nextQuestId = choiceEffect.nextQuest;
                    if (choiceEffect.dialog) choiceDialog = choiceEffect.dialog;
                    // Aplikuj karma efekty
                    if (choiceEffect.karma) {
                        state.storyKarma = state.storyKarma || { kory: 0, koudy: 0 };
                        Object.entries(choiceEffect.karma).forEach(([key, val]) => {
                            state.storyKarma[key] = (state.storyKarma[key] || 0) + val;
                        });
                    }
                }
                state.mainQuest.choiceMade = null; // Reset volby
            }
            
            if (quest.ending) {
                // Konec p콏칤b캩hu!
                state.mainQuest.storyComplete = true;
                state.mainQuest.currentQuest = null;
                
                showModal('游끥 P콎칈B캨H DOKON캛EN!', `
                    <div style="text-align: center;">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">游끥</div>
                        <h2 style="color: #ffd700;">GRATULACE!</h2>
                        <p style="margin: 1rem 0;">Dokon캜il jsi hlavn칤 p콏칤b캩h!</p>
                        <p style="color: #8bc34a;">Zachr치nil jsi lidstvo p콏ed vyhynut칤m.</p>
                        <p style="color: #999; margin-top: 1rem;">S antivirem v rukou m콢쬰코 za캜칤t l칠캜it p콏e쬴v코칤 a budovat nov칳 sv캩t.</p>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #ffd700;">游꾸 Bonusov치 odm캩na:</p>
                            <p>+1000 XP, +1000 游눯</p>
                            <p style="color: #9c27b0;">+ Titul: "Zachr치nce lidstva"</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">游꿀 Pokra캜ovat ve h콏e</button>
                `);
                
                addLog('游끥 P콎칈B캨H DOKON캛EN! Zachr치nil jsi lidstvo!', '游끥');
                state.char.title = 'Zachr치nce lidstva';
            } else if (nextQuestId) {
                // Automaticky nastav dal코칤 quest
                const nextQuest = MAIN_QUESTS.find(q => q.id === nextQuestId);
                if (nextQuest) {
                    state.mainQuest.currentQuest = nextQuestId;
                    state.mainQuest.chapter = nextQuest.chapter;
                    
                    // Spawn quest item pokud je pot콏eba
                    if (nextQuest.spawnItem) {
                        const loc = WORLD_LOCATIONS.find(l => l.id === nextQuest.spawnItem.location);
                        if (loc) {
                            if (!state.world.questItems) state.world.questItems = {};
                            state.world.questItems[nextQuest.spawnItem.location] = nextQuest.spawnItem.id;
                            console.log(`游닍 Quest item ${nextQuest.spawnItem.id} spawnut na lokaci ${nextQuest.spawnItem.location}`);
                        }
                    }
                }
                
                // Zobraz modal s informac칤
                showModal('九 Quest dokon캜en!', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">九</div>
                        <h3 style="color: #8bc34a;">${quest.title}</h3>
                        <p style="color: #999;">${choiceDialog || quest.dialog?.complete || 'Quest spln캩n!'}</p>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #ffd700;">游꾸 Odm캩na:</p>
                            <p>+${quest.reward.xp} XP${quest.reward.money ? `, +${quest.reward.money} 游눯` : ''}</p>
                        </div>
                        
                        ${nextQuestId ? (() => {
                            const nextQ = MAIN_QUESTS.find(q => q.id === nextQuestId);
                            const firstObj = nextQ?.objectives?.[0];
                            let locationHint = '';
                            if (firstObj?.type === 'location' && firstObj.target) {
                                const loc = WORLD_LOCATIONS.find(l => l.id === firstObj.target);
                                if (loc) locationHint = `<p style="color: #ff9800; margin: 0.5rem 0 0 0; font-size: 0.9rem;">游늸 C칤l: ${loc.name}</p>`;
                            }
                            return `
                            <div style="background: #1a2a3a; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #4a90d9;">
                                <p style="color: #4a90d9; margin: 0;">游닆 Nov칳 quest:</p>
                                <p style="color: #fff; margin: 0.5rem 0 0 0; font-weight: bold;">${nextQ?.title || 'Dal코칤 칰kol'}</p>
                                <p style="color: #aaa; margin: 0.3rem 0 0 0; font-size: 0.85rem;">${nextQ?.description || ''}</p>
                                ${locationHint}
                            </div>
                        `;
                        })() : ''}
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">九 OK</button>
                `);
            } else {
                // 콯치dn칳 dal코칤 quest
                state.mainQuest.currentQuest = null;
                showModal('九 Quest dokon캜en!', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">九</div>
                        <h3 style="color: #8bc34a;">${quest.title}</h3>
                        <p style="color: #999;">${quest.dialog?.complete || 'Quest spln캩n!'}</p>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #ffd700;">游꾸 Odm캩na:</p>
                            <p>+${quest.reward.xp} XP${quest.reward.money ? `, +${quest.reward.money} 游눯` : ''}</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">九 OK</button>
                `);
            }
            
            addLog('Quest dokon캜en: ' + quest.title, '九');
            renderFull();
        }
        
        function startNextQuest(questId) {
            if (!questId) return;
            
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            state.mainQuest.currentQuest = questId;
            state.mainQuest.chapter = quest.chapter;
            state.mainQuest.questProgress = {};
            
            showModal('游닆 Nov칳 quest!', `
                <div style="text-align: center;">
                    <p style="color: #ff9800; font-size: 0.9rem;">Kapitola ${quest.chapter}</p>
                    <h2 style="color: #d4722e; margin: 0.5rem 0;">${quest.title}</h2>
                    <p style="color: #999;">${quest.description}</p>
                    
                    ${quest.dialog?.start ? `
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-top: 1rem; font-style: italic; color: #aaa;">
                            "${quest.dialog.start}"
                        </div>
                    ` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">P콏ijmout quest</button>
            `);
            
            addLog('Nov칳 quest: ' + quest.title, '游닆');
            
            // Spawn quest item pokud je pot콏eba
            if (quest.spawnItem) {
                // Najdi lokaci podle ID
                const loc = WORLD_LOCATIONS.find(l => l.id === quest.spawnItem.location);
                if (loc) {
                    // Ulo quest item do world lokace
                    if (!state.world.questItems) state.world.questItems = {};
                    state.world.questItems[quest.spawnItem.location] = quest.spawnItem.id;
                    console.log(`游닍 Quest item ${quest.spawnItem.id} spawnut na lokaci ${quest.spawnItem.location}`);
                }
            }
        }
        
        function talkToNPC(npcId) {
            const npc = STORY_NPCS[npcId];
            if (!npc) return;
            
            const quest = getCurrentQuest();
            let dialogKey = 'first_meet';
            
            if (state.mainQuest?.npcMet?.includes(npcId)) {
                if (quest?.npc === npcId) {
                    dialogKey = 'quest_active';
                } else {
                    dialogKey = 'quest_complete';
                }
            }
            
            const dialogs = npc.dialogs[dialogKey] || npc.dialogs.first_meet;
            
            // Zajisti 쬰 dialogs je pole
            const dialogArray = Array.isArray(dialogs) ? dialogs : [dialogs];
            
            if (!state.mainQuest.npcMet) state.mainQuest.npcMet = [];
            if (!state.mainQuest.npcMet.includes(npcId)) {
                state.mainQuest.npcMet.push(npcId);
            }
            
            // Nastav quest progress pro location objective pokud je to NPC questu
            if (quest && quest.npc === npcId) {
                quest.objectives.forEach(obj => {
                    if (obj.type === 'location' && obj.target === npc.location) {
                        if (!state.mainQuest.questProgress) state.mainQuest.questProgress = {};
                        state.mainQuest.questProgress[obj.id] = 1;
                    }
                });
            }
            
            // === CHOICE QUEST CHECK ===
            // Pokud je aktivn칤 isChoice quest a hr치캜 m치 po쬬dovan칳 item, nab칤dni p콏ed치n칤
            if (quest?.isChoice && quest.requiresItem) {
                const hasItem = state.inv.some(i => i.id === quest.requiresItem);
                if (hasItem && (npcId === 'kory' || npcId === 'koudy')) {
                    // Uk치 dialog a pak nab칤dni p콏ed치n칤
                    showNPCDialogWithChoice(npc, dialogArray, 0, quest, npcId);
                    return;
                }
            }
            
            showNPCDialog(npc, dialogArray, 0);
        }
        
        // Dialog s mo쬹ost칤 p콏ed치n칤 quest itemu
        function showNPCDialogWithChoice(npc, dialogs, index, quest, npcId) {
            if (index >= dialogs.length) {
                // Po dialogu nab칤dni p콏ed치n칤
                showDeliveryChoice(npcId, quest);
                return;
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; min-height: 100px;">
                    <p style="font-size: 1.1rem; line-height: 1.6;">"${dialogs[index]}"</p>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                    <span style="color: #666;">${index + 1}/${dialogs.length}</span>
                    <button class="btn" onclick="showNPCDialogWithChoice(${JSON.stringify(npc).replace(/"/g, '&quot;')}, ${JSON.stringify(dialogs).replace(/"/g, '&quot;')}, ${index + 1}, ${JSON.stringify(quest).replace(/"/g, '&quot;')}, '${npcId}')" style="padding: 0.5rem 2rem;">
                        Dal코칤 
                    </button>
                </div>
            `);
        }
        
        // Nab칤dka p콏ed치n칤 quest itemu
        function showDeliveryChoice(npcId, quest) {
            const npc = STORY_NPCS[npcId];
            const item = QUEST_ITEMS.find(i => i.id === quest.requiresItem);
            if (!item || !npc) {
                closeModal();
                return;
            }
            
            const otherNpcId = npcId === 'kory' ? 'koudy' : 'kory';
            const otherNpc = STORY_NPCS[otherNpcId];
            
            showModal(`${item.icon} P콏edat komponent?`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${item.icon}</div>
                    <h3 style="color: #ffd700;">${item.name}</h3>
                    <p style="color: #888; margin: 0.5rem 0;">M치코 komponent, kter칳 ${npc.name} pot콏ebuje.</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                    <p style="margin: 0; color: #8bc34a;"><strong>丘멆잺 D콢le쬴t칠 rozhodnut칤!</strong></p>
                    <p style="margin: 0.5rem 0 0 0; color: #aaa; font-size: 0.9rem;">
                        Komu d치코 ${item.name} ovlivn칤 p콏칤b캩h.<br>
                        M콢쬰코 j칤t za ${otherNpc.icon} ${otherNpc.name} m칤sto toho.
                    </p>
                </div>
                
                <button class="btn" onclick="deliverComponent('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, ${npcId === 'kory' ? '#c62828' : '#1565c0'} 0%, ${npcId === 'kory' ? '#8b0000' : '#0d47a1'} 100%);">
                    ${npc.icon} P콏edat ${npc.name}
                </button>
                <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    九 Je코t캩 ne
                </button>
            `);
        }
        
        // P콏ed치n칤 komponenty NPC
        function deliverComponent(npcId) {
            const quest = getCurrentQuest();
            const npc = STORY_NPCS[npcId];
            
            if (!quest || !npc || !quest.isChoice) {
                closeModal();
                return;
            }
            
            // Odeber item z invent치콏e
            const itemIndex = state.inv.findIndex(i => i.id === quest.requiresItem);
            if (itemIndex === -1) {
                notifyError('Chyba', ('Nem치코 pot콏ebn칳 p콏edm캩t!'));
                closeModal();
                return;
            }
            
            const item = state.inv[itemIndex];
            if (item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            // Update quest progress
            state.mainQuest.questProgress = state.mainQuest.questProgress || {};
            quest.objectives.forEach(obj => {
                if (obj.type === 'choice') {
                    state.mainQuest.questProgress[obj.id] = 1;
                }
            });
            
            // Ulo volbu
            state.mainQuest.choiceMade = npcId;
            state.mainQuest.choices = state.mainQuest.choices || [];
            state.mainQuest.choices.push({ quest: quest.id, choice: npcId });
            
            // Aplikuj karma efekty
            const effect = quest.choiceEffects?.[npcId];
            if (effect?.karma) {
                state.storyKarma = state.storyKarma || {};
                Object.entries(effect.karma).forEach(([k, v]) => {
                    state.storyKarma[k] = (state.storyKarma[k] || 0) + v;
                });
            }
            
            // Log
            addLog(`P콏edal jsi ${QUEST_ITEMS.find(i => i.id === quest.requiresItem)?.name} ${npc.name}!`, npc.icon);
            
            // Zobraz reakci NPC
            const responseDialog = effect?.dialog || `${npc.name} p콏ij칤m치 komponent.`;
            
            closeModal();
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${npc.icon}</div>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                    <p style="font-size: 1.1rem; line-height: 1.6;">"${responseDialog}"</p>
                </div>
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                    <p style="margin: 0; color: #8bc34a;">九 Quest pokra캜uje...</p>
                    <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                        Karma ${npc.name}: ${effect?.karma?.[npcId] > 0 ? '+' : ''}${effect?.karma?.[npcId] || 0}
                    </p>
                </div>
                <button class="btn" onclick="closeModal(); checkQuestComplete(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">
                    九 Pokra캜ovat
                </button>
            `);
            
            saveGame();
        }
        
        function showNPCDialog(npc, dialogs, index) {
            if (index >= dialogs.length) {
                closeModal();
                checkQuestComplete();
                return;
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; min-height: 100px;">
                    <p style="font-size: 1.1rem; line-height: 1.6;">"${dialogs[index]}"</p>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                    <span style="color: #666;">${index + 1}/${dialogs.length}</span>
                    <button class="btn" onclick="showNPCDialog(${JSON.stringify(npc).replace(/"/g, '&quot;')}, ${JSON.stringify(dialogs).replace(/"/g, '&quot;')}, ${index + 1})" style="padding: 0.5rem 2rem;">
                        ${index < dialogs.length - 1 ? 'Dal코칤 ' : 'Zav콏칤t'}
                    </button>
                </div>
            `);
        }
        
        function checkForNPCAtLocation() {
            const currentLocation = state.world.currentLocation;
            
            for (const [npcId, npc] of Object.entries(STORY_NPCS)) {
                // Nov칳 syst칠m - NPC maj칤 location jako string ID
                if (npc.location === currentLocation) {
                    // Je tu NPC
                    setTimeout(() => {
                        showModal(`${npc.icon} Setk치n칤!`, `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">${npc.icon}</div>
                                <h3>${npc.name}</h3>
                                <p style="color: #999;">Na코el jsi n캩koho!</p>
                            </div>
                            <button class="btn" onclick="talkToNPC('${npcId}')" style="width: 100%; margin-top: 1rem;">游딖勇 Promluvit</button>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Ignorovat</button>
                        `);
                    }, 500);
                    return true;
                }
            }
            
            // Kontrola quest itemu - pou쬴j nov칳 syst칠m
            if (state.world.questItems?.[currentLocation]) {
                const itemId = state.world.questItems[currentLocation];
                const item = QUEST_ITEMS.find(i => i.id === itemId);
                if (item && !state.inv.some(i => i.id === itemId)) {
                    setTimeout(() => {
                        showModal(`游닍 N치lez!`, `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">${item.icon}</div>
                                <h3 style="color: #ffd700;">${item.name}</h3>
                                <p style="color: #999;">${item.desc}</p>
                            </div>
                            <button class="btn" onclick="pickupQuestItem('${itemId}')" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">九 Vz칤t</button>
                        `);
                    }, 500);
                    return true;
                }
            }
            
            return false;
        }
        
        function pickupQuestItem(itemId) {
            const item = QUEST_ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            state.inv.push({...item, count: 1});
            
            // Odeber z aktu치ln칤 lokace (nov칳 syst칠m)
            const currentLocation = state.world.currentLocation;
            if (state.world.questItems?.[currentLocation]) {
                delete state.world.questItems[currentLocation];
            }
            
            closeModal();
            addLog('Z칤skal jsi: ' + item.name, item.icon);
            updateQuestProgress('item', itemId);
        }
        
        // === CUSTOMIZACE POSTAVY ===
        function openCustomization() {
            const currentHair = HAIRSTYLES.find(h => h.id === state.appearance?.hairstyle) || HAIRSTYLES[1];
            const currentHairColor = HAIR_COLORS.find(c => c.id === state.appearance?.hairColor) || HAIR_COLORS[1];
            const currentSkin = SKIN_TONES.find(s => s.id === state.appearance?.skinTone) || SKIN_TONES[2];
            const currentOutfit = OUTFITS.find(o => o.id === state.appearance?.outfit) || OUTFITS[0];
            const currentTitle = TITLES.find(t => t.id === state.appearance?.title) || TITLES[0];
            
            showModal('游꿛 Customizace postavy', `
                <div style="max-height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- Avatar Preview -->
                    <div style="text-align: center; background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">${currentHair.icon}</div>
                        <h3 style="margin: 0.5rem 0 0 0;">${state.char.name}</h3>
                        <p style="color: #ffd700; margin: 0;">${currentTitle.name}</p>
                        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.5rem;">
                            ${(state.badges || []).slice(0, 5).map(b => {
                                const badge = BADGES.find(ba => ba.id === b);
                                return badge ? `<span title="${badge.name}">${badge.icon}</span>` : '';
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Hairstyle -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">游눊 칔캜es</h4>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.3rem;">
                            ${HAIRSTYLES.map(h => `
                                <button onclick="setAppearance('hairstyle', '${h.id}')" 
                                    style="padding: 0.5rem; font-size: 1.5rem; border-radius: 8px; border: 2px solid ${h.id === state.appearance?.hairstyle ? '#ffd700' : '#333'}; background: #2a2a2a; cursor: pointer;">
                                    ${h.icon}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Hair Color -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">游꿛 Barva vlas콢</h4>
                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                            ${HAIR_COLORS.map(c => `
                                <button onclick="setAppearance('hairColor', '${c.id}')" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 3px solid ${c.id === state.appearance?.hairColor ? '#ffd700' : '#333'}; background: ${c.color}; cursor: pointer;">
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Skin Tone -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">游녻 Odst칤n pleti</h4>
                        <div style="display: flex; gap: 0.3rem;">
                            ${SKIN_TONES.map(s => `
                                <button onclick="setAppearance('skinTone', '${s.id}')" 
                                    style="width: 40px; height: 40px; border-radius: 8px; border: 3px solid ${s.id === state.appearance?.skinTone ? '#ffd700' : '#333'}; background: ${s.color}; cursor: pointer;">
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Outfit -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">游녯 Oble캜en칤</h4>
                        <div style="display: grid; gap: 0.3rem;">
                            ${OUTFITS.map(o => {
                                const unlocked = state.unlockedOutfits?.includes(o.id) || o.id === 'survivor';
                                return `
                                    <button onclick="${unlocked ? `setAppearance('outfit', '${o.id}')` : ''}" 
                                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 8px; border: 2px solid ${o.id === state.appearance?.outfit ? '#ffd700' : '#333'}; background: ${unlocked ? '#2a2a2a' : '#1a1a1a'}; cursor: ${unlocked ? 'pointer' : 'not-allowed'}; opacity: ${unlocked ? 1 : 0.5};">
                                        <span style="font-size: 1.5rem;">${o.icon}</span>
                                        <div style="text-align: left;">
                                            <div>${o.name}</div>
                                            <div style="font-size: 0.75rem; color: #999;">${unlocked ? o.desc : '游 Zam캜eno'}</div>
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">游낑勇 Titul</h4>
                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                            ${TITLES.map(t => {
                                const unlocked = state.unlockedTitles?.includes(t.id) || t.id === 'survivor';
                                return `
                                    <button onclick="${unlocked ? `setAppearance('title', '${t.id}')` : ''}" 
                                        style="padding: 0.4rem 0.8rem; border-radius: 15px; border: 2px solid ${t.id === state.appearance?.title ? '#ffd700' : '#333'}; background: ${unlocked ? '#2a2a2a' : '#1a1a1a'}; cursor: ${unlocked ? 'pointer' : 'not-allowed'}; opacity: ${unlocked ? 1 : 0.5}; font-size: 0.85rem;">
                                        ${unlocked ? t.name : '游'}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Badges -->
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0;">游꿌勇 Odznaky (${state.badges?.length || 0}/${BADGES.length})</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${BADGES.map(b => {
                                const earned = state.badges?.includes(b.id);
                                return `
                                    <div title="${b.name}: ${b.desc}" style="padding: 0.5rem; border-radius: 8px; background: ${earned ? '#2a3a2a' : '#1a1a1a'}; border: 2px solid ${earned ? '#4caf50' : '#333'}; opacity: ${earned ? 1 : 0.4};">
                                        <span style="font-size: 1.5rem;">${b.icon}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function setAppearance(key, value) {
            state.appearance = state.appearance || {};
            state.appearance[key] = value;
            openCustomization(); // Refresh
        }
        
        function checkUnlocks() {
            // Check outfit unlocks
            if (state.stats.kills >= 50 && !state.unlockedOutfits?.includes('military')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('military');
                addLog('Odemknuto oble캜en칤: Vojensk칠!', '游꿌勇');
            }
            if (state.mainQuest?.chapter >= 2 && !state.unlockedOutfits?.includes('scientist')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('scientist');
                addLog('Odemknuto oble캜en칤: V캩deck칠!', '游봎');
            }
            if ((state.stats?.kills || 0) >= 100 && !state.unlockedOutfits?.includes('raider')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('raider');
                addLog('Odemknuto oble캜en칤: N치jezdnick칠!', '游');
            }
            if (state.mainQuest?.storyComplete && !state.unlockedOutfits?.includes('hero')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('hero');
                addLog('Odemknuto oble캜en칤: Hrdinsk칠!', '游붲');
            }
            
            // Check title unlocks
            if (state.stats.travelled >= 50 && !state.unlockedTitles?.includes('explorer')) {
                state.unlockedTitles = state.unlockedTitles || ['survivor'];
                state.unlockedTitles.push('explorer');
                addLog('Odemknut titul: Pr콢zkumn칤k!', '游딬勇');
            }
            if (state.stats.kills >= 100 && !state.unlockedTitles?.includes('warrior')) {
                state.unlockedTitles = state.unlockedTitles || ['survivor'];
                state.unlockedTitles.push('warrior');
                addLog('Odemknut titul: V치le캜n칤k!', '丘덢잺');
            }
            
            // Check badges
            if (state.stats.kills >= 1 && !state.badges?.includes('first_blood')) {
                state.badges = state.badges || [];
                state.badges.push('first_blood');
                showBadgeEarned(BADGES.find(b => b.id === 'first_blood'));
            }
            if (state.stats.bossKills >= 1 && !state.badges?.includes('boss_slayer')) {
                state.badges = state.badges || [];
                state.badges.push('boss_slayer');
                showBadgeEarned(BADGES.find(b => b.id === 'boss_slayer'));
            }
        }
        
        function showBadgeEarned(badge) {
            if (!badge) return;
            
            if (isInCombat()) {
                notifySuccess(`游꿌勇 ${badge.name}`, badge.desc);
                return;
            }
            
            showModal('游꿌勇 Odznak z칤sk치n!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${badge.icon}</div>
                    <h3 style="color: #ffd700;">${badge.name}</h3>
                    <p style="color: #999;">${badge.desc}</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${currentLang === "en" ? "Great!" : "Skv캩l칠!"}</button>
            `);
        }
        
        // === SKILL TREE ===
        function openSkillTree() {
            const points = state.skillTreePoints || 0;
            
            showModal('游꺕 Strom schopnost칤', `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="color: #ffd700; font-size: 1.1rem;">救 Body: <strong>${points}</strong></span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                    ${Object.entries(SKILL_TREE).map(([key, branch]) => `
                        <button onclick="showSkillBranch('${key}')" class="btn" style="padding: 0.8rem; background: ${branch.color}; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem;">
                            <span style="font-size: 1.5rem;">${branch.icon}</span>
                            <span>${branch.name}</span>
                        </button>
                    `).join('')}
                </div>
                
                <div id="skillBranchContent">
                    <p style="text-align: center; color: #666;">${'Vyber v캩tev schopnost칤'}</p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function showSkillBranch(branchId) {
            const branch = SKILL_TREE[branchId];
            if (!branch) return;
            
            const points = state.skillTreePoints || 0;
            const branchSkills = state.skillTree?.[branchId] || {};
            
            // Group skills by tier
            const tiers = [1, 2, 3, 4];
            
            document.getElementById('skillBranchContent').innerHTML = `
                <div style="background: linear-gradient(135deg, ${branch.color}22, ${branch.color}11); padding: 1rem; border-radius: 8px; border-left: 4px solid ${branch.color};">
                    <h3 style="margin: 0 0 1rem 0;">${branch.icon} ${branch.name}</h3>
                    
                    ${tiers.map(tier => {
                        const tierSkills = branch.skills.filter(s => s.tier === tier);
                        if (tierSkills.length === 0) return '';
                        
                        return `
                            <div style="margin-bottom: 1rem;">
                                <div style="color: #666; font-size: 0.8rem; margin-bottom: 0.3rem;">${'Tier'} ${tier}</div>
                                <div style="display: grid; gap: 0.5rem;">
                                    ${tierSkills.map(skill => {
                                        const level = branchSkills[skill.id] || 0;
                                        const maxed = level >= skill.maxLevel;
                                        
                                        // Check if requirements met
                                        let canUnlock = true;
                                        if (skill.requires) {
                                            canUnlock = (branchSkills[skill.requires] || 0) > 0;
                                        }
                                        
                                        const canUpgrade = points > 0 && !maxed && canUnlock;
                                        
                                        return `
                                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 8px; opacity: ${canUnlock ? 1 : 0.5}; border: 2px solid ${maxed ? '#ffd700' : level > 0 ? '#4caf50' : '#333'};">
                                                <div style="font-size: 1.5rem;">${skill.icon}</div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: bold;">${skill.name}</div>
                                                    <div style="font-size: 0.8rem; color: #999;">${skill.desc}</div>
                                                    <div style="font-size: 0.75rem; color: ${maxed ? '#ffd700' : '#4caf50'};">
                                                        ${'Level:'} ${level}/${skill.maxLevel}
                                                    </div>
                                                </div>
                                                <button onclick="upgradeSkillTree('${branchId}', '${skill.id}')" 
                                                    class="btn" 
                                                    style="padding: 0.3rem 0.6rem; font-size: 0.8rem; ${canUpgrade ? '' : 'opacity: 0.5; cursor: not-allowed;'}"
                                                    ${canUpgrade ? '' : 'disabled'}>
                                                    ${maxed ? '九' : '+'}
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function upgradeSkillTree(branchId, skillId) {
            if ((state.skillTreePoints || 0) <= 0) return;
            
            const branch = SKILL_TREE[branchId];
            const skill = branch?.skills.find(s => s.id === skillId);
            if (!skill) return;
            
            state.skillTree = state.skillTree || {};
            state.skillTree[branchId] = state.skillTree[branchId] || {};
            
            const currentLevel = state.skillTree[branchId][skillId] || 0;
            if (currentLevel >= skill.maxLevel) return;
            
            // Check requirements
            if (skill.requires) {
                const reqLevel = state.skillTree[branchId][skill.requires] || 0;
                if (reqLevel <= 0) return;
            }
            
            state.skillTree[branchId][skillId] = currentLevel + 1;
            state.skillTreePoints--;
            
            notifySuccess('Vylep코eno!', skill.name + ' ' + (currentLevel + 1) + '/' + skill.maxLevel);
            addLog('Vylep코eno: ' + skill.name + ' (' + (currentLevel + 1) + '/' + skill.maxLevel + ')', skill.icon);
            
            // Aktualizuj nosnost pokud se zm캩nil pack_rat skill
            if (skill.effect?.carryWeight) {
                updateCarryWeight();
            }
            
            // Refresh cel칳 skill tree modal
            openSkillTree();
            // Pak znovu zobraz v캩tev
            setTimeout(() => showSkillBranch(branchId), 50);
        }
        
        function getSkillTreeBonus(effectKey) {
            let total = 0;
            
            for (const [branchId, branch] of Object.entries(SKILL_TREE)) {
                const branchSkills = state.skillTree?.[branchId] || {};
                
                for (const skill of branch.skills) {
                    const level = branchSkills[skill.id] || 0;
                    if (level > 0 && skill.effect[effectKey]) {
                        total += skill.effect[effectKey] * level;
                    }
                }
            }
            
            return total;
        }
        
        // Speci치ln칤 efekty brn캩n칤
        // === DETAILN칈 POPISY SPECI츼LN칈CH EFEKT콡 ===
        const SPECIAL_EFFECT_DETAILS = {
            // Armor
            'powered': { name: 'Pohon', effects: ['+5 obrana', '+5 칰tok'], color: '#ffd700' },
            'stealth': { name: 'Stealth', effects: ['-50% 코ance na n치hodn칳 souboj', '+15% dodge'], color: '#9c27b0' },
            'berserker': { name: 'Berserker', effects: ['+30% obrany jako 칰tok', '-3 obrana'], color: '#f44336' },
            'phoenix': { name: 'F칠nix', effects: ['1x za boj: P콏e쬴je코 smrteln칳 z치sah s 1 HP'], color: '#ff9800' },
            'titan': { name: 'Tit치n', effects: ['+5 obrana', 'Imunita na kritick칠 z치sahy'], color: '#2196f3' },
            'scout': { name: 'Zv캩d', effects: ['+15% dodge'], color: '#4caf50' },
            'medic': { name: 'Medik', effects: ['+50% efektivita l칠캜en칤'], color: '#e91e63' },
            'mutant': { name: 'Mutant', effects: ['-50% radiace'], color: '#8bc34a' },
            'exo': { name: 'Exoskeleton', effects: ['+10% celkov칳 damage'], color: '#ff5722' },
            'nano': { name: 'Nano', effects: ['+2 HP regenerace za kolo v boji'], color: '#00bcd4' },
            'intimidate': { name: 'Zastra코en칤', effects: ['+2 칰tok'], color: '#795548' },
            'scavenger': { name: 'Sb캩ra캜', effects: ['+25% loot'], color: '#607d8b' },
            'camo': { name: 'Kamufl치', effects: ['-30% 코ance na n치hodn칳 souboj'], color: '#3f51b5' },
            'nightvision': { name: 'No캜n칤 vid캩n칤', effects: ['Bonus v noci', '콯치dn칳 postih ve tm캩'], color: '#1a237e' },
            'agile': { name: 'Hbitost', effects: ['+10% dodge'], color: '#00e676' },
            'endurance': { name: 'V칳dr', effects: ['-30% spot콏eba energie p콏i cestov치n칤'], color: '#ff7043' },
            'block': { name: 'Blok', effects: ['+15% 코ance na blok'], color: '#5d4037' },
            'rad_resist': { name: 'Proti-rad', effects: ['-30% radiace'], color: '#ffeb3b' },
            'rad_immune': { name: 'Rad. ochrana', effects: ['-50% radiace'], color: '#76ff03' },
            // Gloves
            'block_bonus': { name: 'Blokov치n칤', effects: ['+10% 코ance na blok'], color: '#5d4037' },
            'unarmed_bonus': { name: 'Boj beze zbran캩', effects: ['+5 damage bez zbran캩'], color: '#ff5722' },
            'grip': { name: 'Pevn칳 칰chop', effects: ['+10% p콏esnost st콏elby', '+2 damage'], color: '#607d8b' },
            'bleed_punch': { name: 'Krvav칳 칰der', effects: ['칔tok p캩st칤 zp콢sob칤 krv치cen칤', '+3 damage'], color: '#c62828' },
            'power_punch': { name: 'Silov칳 칰der', effects: ['+10 damage v boji zbl칤zka'], color: '#d32f2f' },
            'medic_bonus': { name: 'Chirurg', effects: ['+20% efektivita l칠캜en칤'], color: '#e91e63' },
            // Boots
            'dodge_bonus': { name: '칔hyb', effects: ['+10% dodge'], color: '#4caf50' },
            'speed_bonus': { name: 'Rychlost', effects: ['+2% rychlost cestov치n칤'], color: '#2196f3' },
            'stealth_move': { name: 'Tich칳 pohyb', effects: ['-20% 코ance na p콏epaden칤'], color: '#9c27b0' },
            'run_bonus': { name: 'B캩쬰c', effects: ['+15% 코ance na 칰t캩k z boje'], color: '#03a9f4' },
            'stomp': { name: 'Dupnut칤', effects: ['+8 damage kopem'], color: '#795548' },
            'jump': { name: 'Skok', effects: ['+25% dodge', 'Vysok칳 v칳skok'], color: '#ffc107' },
            'warm_feet': { name: 'Tepl칠 nohy', effects: ['-15% spot콏eba energie'], color: '#ff7043' },
            'power_kick': { name: 'Silov칳 kop', effects: ['+20% rychlost', '+10 obrana'], color: '#e65100' }
        };
        
        // Funkce pro zobrazen칤 detailu speci치ln칤ho efektu
        function showSpecialEffectDetail(special) {
            const detail = SPECIAL_EFFECT_DETAILS[special];
            if (!detail) {
                showModal('仇 Nezn치m칳 efekt', `<p>Efekt "${special}" nem치 popis.</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>`);
                return;
            }
            
            let effectsHtml = detail.effects.map(e => `<div style="padding: 0.3rem 0; border-bottom: 1px solid #333;">九 ${e}</div>`).join('');
            
            showModal(`九 ${detail.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="display: inline-block; padding: 0.5rem 1rem; background: ${detail.color}33; border: 2px solid ${detail.color}; border-radius: 8px; color: ${detail.color}; font-weight: bold;">
                        ${detail.name}
                    </div>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游늵 Efekty:</h4>
                    ${effectsHtml}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
            `);
        }
        
        function getArmorSpecialEffects() {
            const effects = {
                bonusDefense: 0,
                bonusDamage: 0,
                bonusDodge: 0,
                bonusBlock: 0,
                radResist: 0,
                healBonus: 0,
                lootBonus: 0,
                xpBonus: 0,
                regenPerTurn: 0,
                encounterReduction: 0,
                energySaver: 0,
                speedBonus: 0,
                escapeBonus: 0,
                carryBonus: 0,
                critBonus: 0,
                damageMultiplier: 1.0,
                phoenix: false,
                stealth: false,
                nightBonus: false,
                critImmune: false
            };
            
            // Kontroluj armor, helmet, gloves a boots
            const equipment = [
                state.equipped?.armor,
                state.equipped?.helmet,
                state.equipped?.gloves,
                state.equipped?.boots
            ].filter(e => e && e.special);
            
            equipment.forEach(item => {
                switch (item.special) {
                    // Armor efekty
                    case 'powered': effects.bonusDefense += 5; effects.bonusDamage += 5; break;
                    case 'stealth': effects.stealth = true; effects.encounterReduction += 0.5; effects.bonusDodge += 0.15; break;
                    case 'berserker': effects.bonusDamage += Math.floor((item.defense || 0) * 0.3); effects.bonusDefense -= 3; break;
                    case 'phoenix': effects.phoenix = true; break;
                    case 'titan': effects.bonusDefense += 5; effects.critImmune = true; break;
                    case 'scout': effects.bonusDodge += 0.15; break;
                    case 'medic': effects.healBonus += 0.5; break;
                    case 'mutant': effects.radResist += 0.5; break;
                    case 'exo': effects.damageMultiplier = 1.1; break; // +10% damage
                    case 'nano': effects.regenPerTurn += 2; break;
                    case 'intimidate': effects.bonusDamage += 2; break;
                    case 'scavenger': effects.lootBonus += 0.25; break;
                    case 'camo': effects.encounterReduction += 0.3; break;
                    case 'nightvision': effects.nightBonus = true; break;
                    case 'agile': effects.bonusDodge += 0.1; break;
                    case 'endurance': effects.energySaver += 0.3; break;
                    case 'block': effects.bonusBlock += 0.15; break;
                    case 'rad_resist': effects.radResist += 0.3; break;
                    case 'rad_immune': effects.radResist += 1.0; break;
                    // Gloves efekty
                    case 'block_bonus': effects.bonusBlock += 0.1; break;
                    case 'unarmed_bonus': effects.bonusDamage += 5; break; // +5 damage beze zbran캩
                    case 'grip': effects.bonusDamage += 2; break; // +10% p콏esnost = +2 dmg
                    case 'bleed_punch': effects.bonusDamage += 3; break; // krv치cen칤
                    case 'power_punch': effects.bonusDamage += 10; break;
                    case 'medic_bonus': effects.healBonus += 0.2; break;
                    // Boots efekty
                    case 'dodge_bonus': effects.bonusDodge += 0.1; break;
                    case 'speed_bonus': effects.speedBonus += 0.02; break;
                    case 'stealth_move': effects.encounterReduction += 0.2; break;
                    case 'run_bonus': effects.escapeBonus += 0.15; break;
                    case 'stomp': effects.bonusDamage += 8; break;
                    case 'jump': effects.bonusDodge += 0.25; break;
                    case 'warm_feet': effects.energySaver += 0.15; break;
                    case 'power_kick': effects.speedBonus += 0.04; effects.bonusDefense += 10; break;
                    case 'exo': effects.damageMultiplier = 1.1; effects.carryBonus = 0.5; break;
                    case 'sturdy': effects.bonusDefense += 2; break;
                    case 'combat_stance': effects.critBonus = 0.05; break; // +5% crit
                    case 'light_feet': effects.speedBonus += 0.01; break; // +1% rychlost
                }
            });
            
            // Bonusy z n치stroj콢 v invent치콏i
            if (state.inv) {
                // Dalekohled - sni쬿je 코anci na p콏epaden칤 (vid칤코 nep콏치tele d콏칤v)
                if (state.inv.some(i => i.bonus === 'vision')) {
                    effects.encounterReduction += 0.15;
                }
                // Lano - bonus k 칰t캩ku
                if (state.inv.some(i => i.bonus === 'escape')) {
                    effects.escapeBonus += 0.2;
                }
            }
            
            return effects;
        }
        
        // === VOZIDLA ===
        // === KOMPANIONI ===
        // Adopce psa p콏i prvn칤 cest캩
        function adoptDog() {
            const dogCompanion = COMPANIONS.find(c => c.id === 'dog');
            if (!dogCompanion) return;
            
            // P콏idej psa jako kompaniona s kompletn칤mi atributy
            state.companions = state.companions || [];
            state.companions.push({
                id: dogCompanion.id,
                name: dogCompanion.name,
                icon: dogCompanion.icon,
                type: dogCompanion.type || 'animal',
                hp: dogCompanion.hp,
                maxHp: dogCompanion.hp,
                damage: dogCompanion.damage || 8,
                defense: dogCompanion.defense || 3,
                level: 1,
                xp: 0,
                skillPoints: 0,
                skills: [],
                loyalty: 60,
                inCombat: true
            });
            
            closeModal();
            addLog('游냇 V캩rn칳 pes se p콏ipojil k tob캩!', '游냇');
            showModal('游꿀 Nov칳 spole캜n칤k!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">游냇</div>
                </div>
                <p style="color: var(--warning-yellow); font-weight: bold; text-align: center; font-size: 1.2rem;">V캩rn칳 pes se p콏ipojil k tob캩!</p>
                <p style="text-align: center; margin: 1rem 0;">Pes radostn캩 sk치캜e kolem tebe. Kone캜n캩 m치 zase p치na!</p>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--toxic-dark);">
                    <p style="margin: 0.3rem 0; color: var(--toxic-green);"><strong>游댌 캛muchal</strong></p>
                    <p style="margin: 0.3rem 0; font-size: 0.85rem; color: #aaa;">+25% 코ance naj칤t vz치cn캩j코칤 p콏edm캩ty p콏i pr콢zkumu</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%;">九 ' + ('Skv캩l칠!') + '</button>
            `);
            renderFull();
        }
        
        function showReviveCompanionModal() {
            const deadCompanion = state.companions?.find(c => c.isDead);
            if (!deadCompanion) {
                showModal('콯치dn칳 mrtv칳 spole캜n칤k', 'V코ichni tvoji spole캜n칤ci jsou na쬴vu!');
                return;
            }
            
            const compInfo = COMPANIONS.find(c => c.id === deadCompanion.id) || deadCompanion;
            const compName = deadCompanion.name || compInfo?.name || 'Spole캜n칤k';
            const compIcon = deadCompanion.icon || compInfo?.icon || '游녻';
            
            const reviveCost = compInfo?.cost > 0 ? Math.floor(compInfo.cost / 2) : 100;
            const hasMedkit = state.inv.find(i => i.id === 'medkit');
            const hasMoney = state.money >= reviveCost;
            
            showModal('游 Mrtv칳 spole캜n칤k', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; opacity: 0.5;">${compIcon}</div>
                    <h3 style="color: #888;">${compName}</h3>
                    <p style="color: #c62828;">驕멆잺 Padl v boji</p>
                </div>
                <p style="margin-bottom: 1rem; text-align: center; color: #888;">Tv콢j spole캜n칤k padl v boji. M콢쬰코 ho o쬴vit nebo se s n칤m rozlou캜it.</p>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--warning-yellow);">Mo쬹osti o쬴ven칤:</h4>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="reviveCompanionWithMedkit('${deadCompanion.uniqueId || deadCompanion.id}')" 
                            style="flex: 1; background: ${hasMedkit ? '#4caf50' : '#555'};" ${!hasMedkit ? 'disabled' : ''}>
                            游눍 L칠k치rni캜ka ${hasMedkit ? '九' : '(nem치코)'}
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="reviveCompanionWithMoney('${deadCompanion.uniqueId || deadCompanion.id}', ${reviveCost})" 
                            style="flex: 1; background: ${hasMoney ? 'var(--warning-yellow)' : '#555'}; color: ${hasMoney ? '#000' : '#888'};" ${!hasMoney ? 'disabled' : ''}>
                            游눯 ${reviveCost} pen캩z ${hasMoney ? '九' : '(nem치코)'}
                        </button>
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a2a2a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #c62828;">Nebo se rozlou캜it:</h4>
                    <button class="btn" onclick="buryCompanion('${deadCompanion.uniqueId || deadCompanion.id}')" 
                        style="width: 100%; background: #4a2a2a; color: #c62828;">
                        丘썶잺 Poh콏b칤t ${compName}
                    </button>
                    <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">Spole캜n칤k bude odstran캩n natrvalo</p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;"> Zav콏칤t</button>
            `);
        }
        
        function buryCompanion(companionId) {
            const compIndex = state.companions?.findIndex(c => (c.uniqueId === companionId || c.id === companionId) && c.isDead);
            if (compIndex === -1 || compIndex === undefined) {
                notifyWarning('Chyba', 'Spole캜n칤k nenalezen');
                return;
            }
            
            const comp = state.companions[compIndex];
            const compInfo = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compName = comp.name || compInfo?.name || 'Spole캜n칤k';
            const compIcon = comp.icon || compInfo?.icon || '游녻';
            
            // Odstra켿 spole캜n칤ka
            state.companions.splice(compIndex, 1);
            
            closeModal();
            addLog(`丘썶잺 ${compName} byl poh콏ben. Odpo캜칤vej v pokoji.`, '游');
            
            showModal('丘썶잺 Sbohem', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; opacity: 0.3;">${compIcon}</div>
                    <h3 style="color: #888;">${compName}</h3>
                    <p style="color: #666; font-style: italic; margin: 1rem 0;">"Odpo캜칤vej v pokoji, v캩rn칳 p콏칤teli."</p>
                    <p style="color: #555; font-size: 0.85rem;">Spole캜n칤k byl poh콏ben a odstran캩n z tv칠 skupiny.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">九 Zav콏칤t</button>
            `);
            renderFull();
        }
        
        function reviveCompanionWithMedkit(companionId) {
            const comp = state.companions?.find(c => (c.uniqueId === companionId || c.id === companionId) && c.isDead);
            if (!comp) return;
            
            const medkit = state.inv.find(i => i.id === 'medkit');
            if (!medkit) {
                showModal('Chyb칤 l칠k치rni캜ka', 'Nem치코 l칠k치rni캜ku!');
                return;
            }
            
            // Spot콏ebuj l칠k치rni캜ku
            if (medkit.count > 1) {
                medkit.count--;
            } else {
                state.inv = state.inv.filter(i => i.id !== 'medkit');
            }
            
            // O쬴vit spole캜n칤ka
            const compInfo = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compName = comp.name || compInfo?.name || 'Spole캜n칤k';
            const compIcon = comp.icon || compInfo?.icon || '游녻';
            const maxHp = comp.maxHp || compInfo?.hp || 50;
            
            comp.isDead = false;
            comp.hp = Math.floor(maxHp / 2); // O쬴v칤 se s polovinou HP
            comp.lastFed = false; // Reset - bude pot콏eba nakrmit
            comp.lastWatered = false; // Reset - bude pot콏eba napojit
            
            closeModal();
            addLog(`游눍 ${compName} byl o쬴ven l칠k치rni캜kou!`, '游눜');
            showModal('游눜 Spole캜n칤k o쬴ven!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${compIcon}</div>
                    <h3 style="color: var(--toxic-green);">${compName} je zp캩t!</h3>
                    <p style="color: #888;">HP: ${comp.hp}/${maxHp}</p>
                    <p style="color: #ff9800; font-size: 0.85rem;">游꼤 Nakrm ho a napoj!</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 Skv캩l칠!</button>
            `);
            renderFull();
        }
        
        function reviveCompanionWithMoney(companionId, cost) {
            const comp = state.companions?.find(c => (c.uniqueId === companionId || c.id === companionId) && c.isDead);
            if (!comp) return;
            
            if (state.money < cost) {
                showModal(t('notifications', 'notEnoughMoney'), `Pot콏ebuje코 ${cost} pen캩z!`);
                return;
            }
            
            // Zapla콘
            state.money -= cost;
            
            // O쬴vit spole캜n칤ka
            const compInfo = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compName = comp.name || compInfo?.name || 'Spole캜n칤k';
            const compIcon = comp.icon || compInfo?.icon || '游녻';
            const maxHp = comp.maxHp || compInfo?.hp || 50;
            
            comp.isDead = false;
            comp.hp = maxHp; // Pln칠 HP za pen칤ze
            comp.lastFed = false; // Reset - bude pot콏eba nakrmit
            comp.lastWatered = false; // Reset - bude pot콏eba napojit
            
            closeModal();
            addLog(`游눯 ${compName} byl o쬴ven za ${cost} pen캩z!`, '游눜');
            showModal('游눜 Spole캜n칤k o쬴ven!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${compIcon}</div>
                    <h3 style="color: var(--toxic-green);">${compName} je zp캩t!</h3>
                    <p style="color: #888;">HP: ${comp.hp}/${maxHp} (pln칠 zdrav칤)</p>
                    <p style="color: var(--warning-yellow);">-${cost} 游눯</p>
                    <p style="color: #ff9800; font-size: 0.85rem;">游꼤 Nakrm ho a napoj!</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 Skv캩l칠!</button>
            `);
            renderFull();
        }
        
        function rescueCompanion(companionId) {
            const companion = COMPANIONS.find(c => c.id === companionId);
            if (!companion) return;
            
            // Pot콏ebuje l칠k치rni캜ku
            const medkit = state.inv.find(i => i.id === 'medkit');
            if (!medkit) {
                showModal('Chyb칤 l칠k치rni캜ka', 'Pot콏ebuje코 l칠k치rni캜ku k vyl칠캜en칤!');
                return;
            }
            
            // Spot콏ebuj l칠k치rni캜ku
            if (medkit.count > 1) {
                medkit.count--;
            } else {
                state.inv = state.inv.filter(i => i.id !== 'medkit');
            }
            
            // P콏idej kompaniona s kompletn칤mi atributy
            state.companions = state.companions || [];
            state.companions.push({
                id: companion.id,
                name: companion.name,
                icon: companion.icon,
                type: companion.type || 'animal',
                hp: companion.hp,
                maxHp: companion.hp,
                damage: companion.damage || 10,
                defense: companion.defense || 5,
                level: 1,
                xp: 0,
                skillPoints: 0,
                skills: [],
                loyalty: 50,
                inCombat: true,
                equipped: companion.type === 'human' ? { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null } : null,
                canEquip: companion.type === 'human'
            });
            
            closeModal();
            addLog(companion.name + ' se p콏ipojil k tob캩!', companion.icon);
            checkAchievements();
            showModal('游꿀 Nov칳 spole캜n칤k!', 
                '<p>' + companion.icon + ' ' + companion.name + ' se p콏ipojil k tob캩!</p>' +
                '<p style="color: #8bc34a;"><strong>Schopnost:</strong> ' + companion.ability + '</p>' +
                '<p style="color: #999;">' + companion.abilityDesc + '</p>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 ' + ('Skv캩l칠!') + '</button>'
            );
            renderFull();
        }
        
        function hireCompanion(companionId) {
            const companion = COMPANIONS.find(c => c.id === companionId);
            if (!companion) return;
            
            if (getMoney() < companion.cost) {
                showModal(t('notifications', 'notEnoughMoney'), 'Nem치코 dost pen캩z na najmut칤 ' + companion.name + '! Pot콏ebuje코 ' + companion.cost + ' 游눯');
                return;
            }
            
            if (state.companions?.find(c => c.id === companionId)) {
                showModal('U m치코', 'Tohoto spole캜n칤ka u m치코!');
                return;
            }
            
            const newCompanion = {
                id: companion.id,
                uniqueId: `${companion.id}_${Date.now()}`, // Unik치tn칤 ID
                name: companion.name,
                icon: companion.icon,
                type: companion.type || 'animal',
                hp: companion.hp,
                maxHp: companion.hp,
                damage: companion.damage || 10,
                defense: companion.defense || 5,
                level: 1,
                xp: 0,
                skillPoints: 0,
                skills: [],
                loyalty: 50,
                equipped: companion.type === 'human' ? { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null } : null
            };
            
            state.companions = state.companions || [];
            
            if (state.companions.length >= getMaxCompanions()) {
                // Plno - ulo info o n치kupu a nab칤dni v칳m캩nu
                window.pendingHireCompanion = { companion: newCompanion, cost: companion.cost };
                showCompanionSwapModal(newCompanion, 'hire');
                return;
            }
            
            // M칤sto voln칠 - rovnou najmi
            removeMoney(companion.cost);
            state.companions.push(newCompanion);
            
            addLog('Najal jsi ' + companion.name + '!', companion.icon);
            notifySuccess('Nov칳 spole캜n칤k!', companion.name + ' se k tob캩 p콏idal!');
            checkAchievements();
            saveGame(true);
            showHireCompanionsModal();
        }
        
        function showHireCompanionsModal() {
            const currentCount = state.companions?.filter(c => !c.isDead).length || 0;
            const maxCount = getMaxCompanions();
            const canHire = currentCount < maxCount;
            
            // Dostupn칤 spole캜n칤ci k najmut칤 (ti co nem치코)
            const availableCompanions = COMPANIONS.filter(c => !state.companions?.find(sc => sc.id === c.id));
            
            let html = '<div style="margin-bottom: 1rem;">';
            html += '<p style="text-align: center; color: #8bc34a;">游논 Spole캜n칤ci: ' + currentCount + '/' + maxCount + '</p>';
            if (!canHire) {
                html += '<p style="text-align: center; color: #ff9800; font-size: 0.85rem;">丘멆잺 M치코 maximum spole캜n칤k콢! Zvy코 level pro v칤ce m칤st.</p>';
            }
            html += '<p style="text-align: center; color: #ff9800; font-size: 0.8rem; margin-top: 0.5rem;">游꼤游눦 Ka쬯칳 spole캜n칤k spot콏ebuje 1 j칤dlo + 1 vodu denn캩!</p>';
            html += '</div>';
            
            if (availableCompanions.length === 0) {
                html += '<p style="text-align: center; color: #888;">V코echny spole캜n칤ky u m치코!</p>';
            } else {
                html += '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                availableCompanions.forEach(comp => {
                    const canAfford = getMoney() >= comp.cost;
                    const disabled = !canHire || !canAfford;
                    
                    html += '<div style="background: #2a2a2a; padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; border: 1px solid ' + (disabled ? '#444' : '#4a7c5a') + '; ' + (disabled ? 'opacity: 0.6;' : '') + '">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                    html += '<span style="font-size: 2rem;">' + comp.icon + '</span>';
                    html += '<div>';
                    html += '<div style="font-weight: bold; color: #fff;">' + comp.name + '</div>';
                    html += '<div style="font-size: 0.8rem; color: #888;">仇벒잺 ' + comp.hp + ' HP | 丘덢잺 ' + comp.damage + ' DMG</div>';
                    html += '<div style="font-size: 0.75rem; color: #4caf50;">' + comp.ability + '</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '<button class="btn" onclick="hireCompanion(\'' + comp.id + '\')" ' + (disabled ? 'disabled' : '') + ' style="padding: 0.5rem 1rem; background: ' + (canAfford && canHire ? '#2e7d32' : '#555') + '; ' + (disabled ? 'pointer-events: none;' : '') + '">' + comp.cost + ' 游눯</button>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            html += '<p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 0.5rem;">M치코: ' + getMoney() + ' 游눯</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">' + t('ui', 'close') + '</button>';
            
            showModal('游냇 Najmout spole캜n칤ka', html);
        }
        
        function dismissCompanion(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Vra콘 vybaven칤 do invent치콏e
            if (comp?.equipped) {
                ['weapon', 'armor', 'accessory'].forEach(slot => {
                    if (comp.equipped[slot]) {
                        const item = {...comp.equipped[slot]};
                        const existing = state.inv.find(i => i.id === item.id);
                        if (existing) {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            item.count = 1;
                            state.inv.push(item);
                        }
                    }
                });
                updateCarryWeight();
            }
            
            // Odeber spole캜n칤ka - pou쬴j uniqueId pokud existuje, jinak id
            const compUniqueId = comp.uniqueId || comp.id;
            state.companions = state.companions.filter(c => {
                const cUniqueId = c.uniqueId || c.id;
                return cUniqueId !== compUniqueId;
            });
            
            const companion = COMPANIONS.find(c => c.id === comp.id);
            addLog((companion?.name || comp.name || 'Spole캜n칤k') + ' ode코el', companion?.icon || '游녦');
            saveGame(true);
            renderFull();
        }
        
        // === SPECI츼LN칈 SCHOPNOSTI POVOL츼N칈 ===
        function useClassAbility() {
            if (!state.char.classId) return;
            
            const ability = CLASS_ABILITIES[state.char.classId];
            if (!ability) return;
            
            const now = Date.now();
            const cooldownRemaining = (state.char.abilityLastUsed + ability.cooldown * 1000) - now;
            
            if (cooldownRemaining > 0) {
                showModal('낋 Cooldown', 'Schopnost bude dostupn치 za ' + Math.ceil(cooldownRemaining / 1000) + ' sekund.');
                return;
            }
            
            state.char.abilityLastUsed = now;
            
            switch (ability.action) {
                case 'revealLoot':
                    // Sb캩ra캜 - odhal칤 loot na aktu치ln칤 lokaci
                    const loot = ITEMS.filter(i => i.findChance > 0.3);
                    const found = loot[Math.floor(Math.random() * loot.length)];
                    if (found && canAddItem(found, 1)) {
                        state.inv.push({...found, count: found.type === 'consumable' ? 1 : undefined});
                        showModal(ability.icon + ' ' + ability.name, 'Na코el jsi: ' + found.icon + ' ' + found.name);
                    }
                    break;
                    
                case 'rage':
                    // N치jezdn칤k - bonus damage
                    state.combatBonuses.damageBonus = 50;
                    state.combatBonuses.expires = now + 60000;
                    showModal(ability.icon + ' ' + ability.name, '+50% damage na p콏칤코t칤 boj!');
                    break;
                    
                case 'quickHeal':
                    // Medik - rychl칠 l칠캜en칤
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + 40);
                    showModal(ability.icon + ' ' + ability.name, '+40 HP!');
                    break;
                    
                case 'emergencyRepair':
                    // Mechanik - oprava
                    state.inv.forEach(item => {
                        if (item.durability !== undefined) {
                            item.durability = Math.min(item.maxDurability || 100, item.durability + 30);
                        }
                    });
                    showModal(ability.icon + ' ' + ability.name, 'Vybaven칤 opraveno o 30%!');
                    break;
                    
                case 'stealth':
                    // Stopa콏 - vyhnut칤 se nep콏칤teli
                    state.combatBonuses.stealth = true;
                    state.combatBonuses.expires = now + 300000;
                    showModal(ability.icon + ' ' + ability.name, 'Vyhne코 se dal코칤mu nep콏칤teli!');
                    break;
                    
                case 'secondWind':
                    // P콏e쬴v코칤 - druh칳 dech
                    if (state.char.hp < state.char.maxHp * 0.2) {
                        state.char.hp = Math.floor(state.char.maxHp * 0.5);
                        showModal(ability.icon + ' ' + ability.name, 'HP obnoveno na 50%!');
                    } else {
                        showModal('仇 Nelze pou쮂셦', 'M콢쬰코 pou쮂셦 pouze kdy m치코 m칠n캩 ne 20% HP!');
                        state.char.abilityLastUsed = 0; // Reset cooldown
                    }
                    break;
                    
                case 'haggle':
                    // Obchodn칤k - lep코칤 ceny
                    state.combatBonuses.haggle = true;
                    state.combatBonuses.expires = now + 300000;
                    showModal(ability.icon + ' ' + ability.name, '-30% ceny na 5 minut!');
                    break;
                    
                case 'bloodbath':
                    // Berserkr - AoE 칰tok
                    state.combatBonuses.aoeNextAttack = true;
                    showModal(ability.icon + ' ' + ability.name, 'P콏칤코t칤 칰tok zas치hne v코echny nep콏치tele!');
                    break;
                    
                case 'deathStrike':
                    // Assassin - garantovan칳 crit
                    state.combatBonuses.guaranteedCrit = true;
                    showModal(ability.icon + ' ' + ability.name, 'P콏칤코t칤 칰tok je garantovan칳 kritick칳 z치sah!');
                    break;
                    
                case 'ironSkin':
                    // Tank - blokuje damage
                    state.combatBonuses.ironSkin = true;
                    state.combatBonuses.expires = now + 60000;
                    showModal(ability.icon + ' ' + ability.name, 'Blokuje코 ve코ker칳 damage na p콏칤코t칤m kole!');
                    break;
                    
                case 'poisonCloud':
                    // Alchymista - jedovat칳 oblak
                    state.combatBonuses.poisonCloud = 3; // 3 kola
                    showModal(ability.icon + ' ' + ability.name, 'Jedovat칳 oblak otr치vil v코echny nep콏치tele na 3 kola!');
                    break;
                    
                case 'track':
                    // Lovec - najde zv칤콏e
                    showModal(ability.icon + ' ' + ability.name, '游 Na코el jsi stopy zv칤콏ete! Bonus na dal코칤 lov.');
                    state.combatBonuses.trackingBonus = true;
                    break;
                    
                case 'megaBomb':
                    // Demoli캜치콏 - velk칳 v칳buch
                    state.combatBonuses.megaBomb = 100; // 100 damage v코em
                    showModal(ability.icon + ' ' + ability.name, '游눤 MEGA BOMBA p콏ipravena! 100 damage v코em nep콏치tel콢m!');
                    break;
                    
                case 'desertWind':
                    // Nom치d - okam쬴t칠 cestov치n칤
                    if (state.map.traveling) {
                        state.map.traveling = false;
                        state.map.travelProgress = 0;
                        showModal(ability.icon + ' ' + ability.name, 'Dorazil jsi okam쬴t캩!');
                    } else {
                        showModal('仇 Nelze pou쮂셦', 'Nejsi na cest치ch!');
                        state.char.abilityLastUsed = 0;
                    }
                    break;
                    
                case 'radBurst':
                    // Mutant - radia캜n칤 v칳buch
                    state.combatBonuses.radBurst = { damage: 50, radiation: 20 };
                    showModal(ability.icon + ' ' + ability.name, 'Radia캜n칤 energie p콏ipravena! 50 damage + 20 radiace nep콏치tel콢m!');
                    break;
                    
                case 'mindBlast':
                    // Psychik - ment치ln칤 칰tok
                    state.combatBonuses.mindBlast = true;
                    showModal(ability.icon + ' ' + ability.name, 'Nep콏칤tel p콏esko캜칤 sv콢j p콏칤코t칤 tah!');
                    break;
            }
            
            addLog('Pou쬴l jsi schopnost: ' + ability.name, ability.icon);
            renderFull();
        }
        
        // === POMOC P콎E콯IV먞껤U EVENT ===
        function helpSurvivor() {
            closeModal();
            // N치hodn칳 nep콏칤tel
            const enemies = ENEMIES.filter(e => e.tier <= 2);
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            
            // Po boji odm캩na
            state.helpingSurvivor = true;
            startCombat({ id: enemy.id });
        }
        
        // === NEBEZPE캛N칄 SETK츼N칈 (DANGER/DEADLY Z칍NY) ===
        function triggerDangerousEncounter(zone) {
            let tierFilter;
            let title;
            let description;
            
            if (zone === 'danger') {
                // Tier 3 nep콏치tel칠
                tierFilter = e => e.tier === 3;
                title = '丘멆잺 Nebezpe캜n칠 setk치n칤!';
                description = 'V t칠to nebezpe캜n칠 oblasti na tebe 캜칤h치 siln칳 nep콏칤tel!';
            } else {
                // Deadly z칩na - tier 4-5 (bossov칠)
                tierFilter = e => e.tier >= 4;
                title = '游 Smrteln칠 nebezpe캜칤!';
                description = 'Narazil jsi na extr칠mn캩 nebezpe캜n칠ho protivn칤ka!';
            }
            
            const enemies = ENEMIES.filter(tierFilter);
            if (enemies.length === 0) {
                // Fallback na tier 3
                const fallback = ENEMIES.filter(e => e.tier === 3);
                if (fallback.length > 0) {
                    const enemy = fallback[Math.floor(Math.random() * fallback.length)];
                    showDangerousEnemyModal(enemy, title, description);
                }
                return;
            }
            
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            showDangerousEnemyModal(enemy, title, description);
        }
        
        function showDangerousEnemyModal(enemy, title, description) {
            const isBoss = enemy.isBoss || enemy.tier >= 4;
            const borderColor = isBoss ? '#ff0000' : '#ff9800';
            
            showModal(title, `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem; ${isBoss ? 'animation: pulse 1s infinite;' : ''}">${enemy.icon}</div>
                    <h2 style="color: ${borderColor}; margin: 0.5rem 0;">${enemy.name}</h2>
                    ${isBoss ? '<span style="background: #8B0000; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">游놏 BOSS</span>' : ''}
                    <p style="color: #888; margin-top: 0.5rem;">${description}</p>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${borderColor};">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                            <div>
                                <div style="color: #f44336; font-size: 1.2rem; font-weight: bold;">${enemy.hp}</div>
                                <div style="color: #888; font-size: 0.8rem;">仇벒잺 HP</div>
                            </div>
                            <div>
                                <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${enemy.damage}</div>
                                <div style="color: #888; font-size: 0.8rem;">丘덢잺 DMG</div>
                            </div>
                            <div>
                                <div style="color: #2196f3; font-size: 1.2rem; font-weight: bold;">${enemy.defense}</div>
                                <div style="color: #888; font-size: 0.8rem;">游띠勇 DEF</div>
                            </div>
                        </div>
                    </div>
                    
                    <p style="color: #ffd700; font-size: 0.9rem;">游꾸 Odm캩na: ${enemy.xp} XP + vz치cn칳 loot</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal(); startCombat({id: '${enemy.id}'});" style="background: #8B0000;">
                        丘덢잺 Bojovat!
                    </button>
                    <button class="btn" onclick="tryToFlee('${enemy.id}')" style="background: #555;">
                        游끢 Pokusit se ut칠ct (${isBoss ? '30%' : '50%'} 코ance)
                    </button>
                </div>
            `);
        }
        
        function tryToFlee(enemyId) {
            const enemy = ENEMIES.find(e => e.id === enemyId);
            const isBoss = enemy?.isBoss || enemy?.tier >= 4;
            const fleeChance = isBoss ? 0.30 : 0.50;
            
            // 游댠 Reset kill streak p콏i 칰t캩ku
            state.stats.killStreak = 0;
            
            if (Math.random() < fleeChance) {
                closeModal();
                showModal('游끢 Utekl jsi!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游끢</div>
                        <p style="color: #8bc34a;">Poda콏ilo se ti ut칠ct!</p>
                        <p style="color: #888;">Ale ztratil jsi n캩jak칠 suroviny...</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>
                `);
                // Ztr치ta surovin
                const resources = ['wood', 'metal', 'cloth', 'food'];
                resources.forEach(r => {
                    if (state.resources[r] > 0) {
                        const loss = Math.floor(state.resources[r] * 0.1);
                        state.resources[r] = Math.max(0, state.resources[r] - loss);
                    }
                });
                addLog('Utekl jsi p콏ed ' + enemy.name + '!', '游끢');
            } else {
                closeModal();
                showModal('仇 Neusp캩l jsi!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游땷</div>
                        <p style="color: #f44336;">Nepoda콏ilo se ti ut칠ct!</p>
                        <p style="color: #888;">${enemy.icon} ${enemy.name} t캩 dostihl!</p>
                    </div>
                    <button class="btn" onclick="closeModal(); startCombat({id: '${enemyId}'})" style="width: 100%; margin-top: 1rem; background: #8B0000;">丘덢잺 Mus칤코 bojovat!</button>
                `);
            }
            renderFull();
        }
        
        // === KARAVANA OBCHOD ===
        function openCaravanShop() {
            // Kontrola otev칤rac칤 doby
            if (!isShopOpen('caravan')) {
                showModal('游깿 Karavana odpo캜칤v치', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游냙游눣</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Obchodn칤ci odpo캜칤vaj칤!</p>
                        <p style="color: #888; margin: 1rem 0;">낋 Otev칤rac칤 doba: 08:00 - 20:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu치ln칤 캜as: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #555; font-size: 0.8rem; margin-top: 0.5rem;">游눠 Karavana cestuje p콏es noc, vrac칤 se r치no.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Filtruj rare/epic itemy, ale VYLU캛 lore a cantBuy
            const rareItems = ITEMS.filter(i => 
                (i.rarity === 'rare' || i.rarity === 'epic') && 
                !i.cantBuy && 
                i.type !== 'lore'
            );
            const playerMoney = getMoney();
            
            // Zjisti jestli je hr치캜 v osad캩 - pouze podle currentLocation
            const currentLoc = state.world?.currentLocation || '';
            const inSettlement = currentLoc === 'shelter' || currentLoc === 'settlement';
            
            console.log('游냙 Karavana - inSettlement:', inSettlement, 'currentLocation:', currentLoc);
            
            // Inicializuj z치soby karavany pokud neexistuj칤 nebo je nov치 karavana
            if (!state.caravanStock || state.caravanStock.generated !== state.caravan?.until) {
                state.caravanStock = {
                    generated: state.caravan?.until || Date.now(),
                    items: {}
                };
                // Ka쬯칳 item m치 n치hodn칠 mno쬽tv칤 1-5
                rareItems.forEach(item => {
                    state.caravanStock.items[item.id] = Math.floor(Math.random() * 5) + 1;
                });
            }
            
            // Rozd캩l na kategorie (jen ty co maj칤 z치soby)
            const hasStock = (item) => (state.caravanStock.items[item.id] || 0) > 0;
            const consumables = rareItems.filter(i => i.type === 'consumable' && hasStock(i));
            const weapons = rareItems.filter(i => i.type === 'weapon' && hasStock(i));
            const armors = rareItems.filter(i => i.type === 'armor' && hasStock(i));
            const tools = rareItems.filter(i => i.type === 'tool' && hasStock(i));
            const others = rareItems.filter(i => !['consumable', 'weapon', 'armor', 'tool'].includes(i.type) && hasStock(i));
            
            const caravanShopTexts = {
                intro: 'Speci치ln칤 nab칤dka vz치cn칠ho zbo쮂!', youHave: 'M치코', buy: 'Koupit'
            };
            
            const renderCaravanItem = (item) => {
                // Pou쬴j jednotnou funkci + extra 10% sleva od karavany
                const basePrice = calculateItemPrice(item.price);
                const price = Math.floor(basePrice * 0.9); // Karavana m치 nav칤c 10% slevu
                const originalPrice = item.price;
                const stock = state.caravanStock.items[item.id] || 0;
                return `
                    <div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <span style="font-size: 1.3rem;">${item.icon}</span>
                            <strong>${getItemName(item.id)}</strong>
                            <span style="color: #888; font-size: 0.8rem; margin-left: 0.3rem;">(${stock}x)</span>
                            <span style="color: #ffd700; margin-left: 0.5rem;">游눯 ${price}</span>
                            <span style="color: #999; text-decoration: line-through; margin-left: 0.3rem;">${originalPrice}</span>
                        </div>
                        <button class="btn" onclick="buyCaravanItem('${item.id}')" ${playerMoney < price || stock <= 0 ? 'disabled style="opacity:0.5;"' : ''} style="padding: 0.3rem 0.8rem;">${caravanShopTexts.buy}</button>
                    </div>
                `;
            };
            
            // Prodejn칤 sekce - karavana kupuje v코e s bonusem +25%
            // Pokud hr치캜 NEN칈 v osad캩, prod치v치 se ze skladu osady
            const renderCaravanSellItems = () => {
                const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25;
                let html = '';
                
                if (inSettlement) {
                    // Hr치캜 JE v osad캩 - m콢쬰 prodat z invent치콏e
                    // Prodejn칠 v캩ci
                    const sellableInv = state.inv.filter(i => !i.crafted && !i.fromCaravan && !i.fromShop && !isItemEquipped(i));
                    // Zam캜en칠 v캩ci
                    const lockedInv = state.inv.filter(i => (i.crafted || i.fromCaravan || i.fromShop) && !isItemEquipped(i));
                    
                    if (sellableInv.length === 0) {
                        return html + '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem치코 co prodat</p>';
                    }
                    
                    sellableInv.forEach((item, idx) => {
                        // P콏esko캜 nasazen칠 p콏edm캩ty
                        if (isItemEquipped(item)) return;
                        
                        // Najdi skute캜n칳 index v p콢vodn칤m invent치콏i
                        const realIdx = state.inv.indexOf(item);
                        
                        const itemData = ITEMS.find(i => i.id === item.id) || item;
                        const basePrice = itemData.price || item.price;
                        if (!basePrice) return;
                        
                        // Karavana kupuje v코e - i po코kozen칠, za upravenou cenu
                        let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
                        
                        // Sn칤쬰n칤 ceny za po코kozen칤
                        if (item.durability !== undefined && item.maxDurability) {
                            const durabilityRatio = item.durability / item.maxDurability;
                            sellPrice = Math.floor(sellPrice * durabilityRatio);
                            if (sellPrice < 1) sellPrice = 1;
                        }
                        
                        // Gender bonus
                        if (state.char.gender === 'female') {
                            sellPrice = Math.floor(sellPrice * 1.1);
                        }
                        
                        const countText = item.count > 1 ? ` (${item.count}x)` : '';
                        const durabilityText = item.durability !== undefined ? 
                            ` <span style="color: ${item.durability < 30 ? '#f44336' : '#888'}; font-size: 0.7rem;">[${item.durability}%]</span>` : '';
                        
                        html += `
                            <div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                                    <span style="font-size: 1.3rem;">${item.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 0.85rem;">${item.name}${durabilityText}</div>
                                        <div style="font-size: 0.8rem; color: #4caf50;">游눯 ${sellPrice}${countText}</div>
                                    </div>
                                </div>
                                <button class="btn" onclick="sellToCaravan(${realIdx}, 'inv')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>
                            </div>
                        `;
                    });
                    
                    // Zobraz zam캜en칠 v캩ci
                    if (lockedInv.length > 0) {
                        html += `<div style="border-top: 1px solid #444; margin-top: 0.5rem; padding-top: 0.5rem;">
                            <p style="color: #666; font-size: 0.75rem; text-align: center; margin-bottom: 0.3rem;">游 Nelze prodat:</p>`;
                        lockedInv.slice(0, 5).forEach((item) => {
                            const lockReason = item.crafted ? '游댣' : (item.fromCaravan ? '游냙' : '游');
                            html += `<div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.3rem; border-radius: 4px; margin-bottom: 0.2rem; opacity: 0.5;">
                                <span style="font-size: 0.8rem; color: #666;">${item.icon} ${item.name}</span>
                                <span style="font-size: 0.7rem; color: #ff9800;">${lockReason}</span>
                            </div>`;
                        });
                        if (lockedInv.length > 5) {
                            html += `<p style="color: #555; font-size: 0.7rem; text-align: center;">...a ${lockedInv.length - 5} dal코칤ch</p>`;
                        }
                        html += `</div>`;
                    }
                    
                    return html || '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem치코 co prodat</p>';
                } else {
                    // Hr치캜 NEN칈 v osad캩 - prod치v치 se ze skladu osady (baseItems)
                    html += '<p style="color: #ff9800; font-size: 0.85rem; margin-bottom: 0.5rem; text-align: center;">游닍 Prodej ze skladu osady (nejsi v osad캩)</p>';
                    
                    // baseItems je sklad osady, ne stashes (to jsou skr칳코e)
                    const storageItems = state.baseItems || [];
                    if (storageItems.length === 0) {
                        return html + '<p style="text-align: center; color: #666; font-size: 0.85rem;">Sklad osady je pr치zdn칳</p>';
                    }
                    
                    // Filtruj prodejn칠 v캩ci (ne crafted, ne fromCaravan, ne fromShop)
                    const sellableItems = storageItems.filter(i => !i.crafted && !i.fromCaravan && !i.fromShop);
                    
                    if (sellableItems.length === 0) {
                        return html + '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem치코 co prodat ze skladu</p>';
                    }
                    
                    sellableItems.forEach((item) => {
                        // Najdi skute캜n칳 index v baseItems
                        const realIdx = state.baseItems.indexOf(item);
                        
                        const itemData = ITEMS.find(i => i.id === item.id) || item;
                        const basePrice = itemData.price || item.price;
                        if (!basePrice) return;
                        
                        let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
                        
                        // Sn칤쬰n칤 ceny za po코kozen칤
                        if (item.durability !== undefined && item.maxDurability) {
                            const durabilityRatio = item.durability / item.maxDurability;
                            sellPrice = Math.floor(sellPrice * durabilityRatio);
                            if (sellPrice < 1) sellPrice = 1;
                        }
                        
                        // Gender bonus
                        if (state.char.gender === 'female') {
                            sellPrice = Math.floor(sellPrice * 1.1);
                        }
                        
                        const countText = item.count > 1 ? ` (${item.count}x)` : '';
                        const durabilityText = item.durability !== undefined ? 
                            ` <span style="color: ${item.durability < 30 ? '#f44336' : '#888'}; font-size: 0.7rem;">[${item.durability}%]</span>` : '';
                        
                        html += `
                            <div style="background: #1a2a1a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #2a4a2a;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                                    <span style="font-size: 1.3rem;">${item.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 0.85rem;">${item.name}${durabilityText}</div>
                                        <div style="font-size: 0.8rem; color: #4caf50;">游눯 ${sellPrice}${countText}</div>
                                    </div>
                                </div>
                                <button class="btn" onclick="sellToCaravan(${realIdx}, 'base')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>
                            </div>
                        `;
                    });
                    
                    return html || '<p style="text-align: center; color: #666; font-size: 0.85rem;">Sklad osady je pr치zdn칳</p>';
                }
            };
            
            showModal('游냙 Karavana - Vz치cn칠 zbo쮂', `
                <p style="color: #ff9800; margin-bottom: 0.5rem;">${caravanShopTexts.intro} 游눯 ${caravanShopTexts.youHave}: ${playerMoney}</p>
                
                <div style="background: #1a1a1a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('caravanHoursInfo').style.display = document.getElementById('caravanHoursInfo').style.display === 'none' ? 'block' : 'none'">
                        <span style="color: #888; font-size: 0.75rem;">游뎷 Otev칤rac칤 doby 郊</span>
                        <span style="color: #666; font-size: 0.7rem;">${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</span>
                    </div>
                    <div id="caravanHoursInfo" style="display: none; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #333; font-size: 0.7rem;">
                        <div style="display: grid; gap: 0.2rem;">
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('settlement') ? '#8bc34a' : '#666'};">游 Osada <span>06-22</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('caravan') ? '#8bc34a' : '#666'};">游냙 Karavana <span>08-20</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('military') ? '#8bc34a' : '#666'};">游꿌勇 Vojensk칳 <span>06-18</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('mutants') ? '#8bc34a' : '#666'};">驕勇 Mutanti <span>20-06游깿</span></div>
                            <div style="display: flex; justify-content: space-between; color: #8bc34a;">游빍 Laborato콏 <span>non-stop</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('wandering') ? '#8bc34a' : '#666'};">游냙 Potuln칳 <span>10-16</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Taby pro Koupit/Prodat -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button id="caravanTabBuy" class="btn" onclick="switchCaravanTab('buy')" style="flex: 1; background: #8B4513;">游 Koupit</button>
                    <button id="caravanTabSell" class="btn" onclick="switchCaravanTab('sell')" style="flex: 1; background: #555;">游눯 Prodat (+25%)</button>
                </div>
                
                <!-- Koupit sekce -->
                <div id="caravanBuySection">
                    <!-- Filtry -->
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.5rem;">
                        <button class="btn caravan-filter active" onclick="filterCaravan('all')" data-filter="all" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #8B4513;">V코e</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('consumable')" data-filter="consumable" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游꼤</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('weapon')" data-filter="weapon" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">丘덢잺</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('armor')" data-filter="armor" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游띠勇</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('tool')" data-filter="tool" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游댢</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('other')" data-filter="other" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游닍</button>
                    </div>
                    
                    <div style="max-height: 40vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <div class="caravan-category" data-type="consumable">
                            ${consumables.length > 0 ? `
                                <h4 style="color: #ff9800; font-size: 0.8rem; margin: 0.5rem 0;">游꼤 Spot콏ebn칤 (${consumables.length})</h4>
                                ${consumables.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="weapon">
                            ${weapons.length > 0 ? `
                                <h4 style="color: #c62828; font-size: 0.8rem; margin: 0.5rem 0;">丘덢잺 Zbran캩 (${weapons.length})</h4>
                                ${weapons.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="armor">
                            ${armors.length > 0 ? `
                                <h4 style="color: #2196f3; font-size: 0.8rem; margin: 0.5rem 0;">游띠勇 Zbroje (${armors.length})</h4>
                                ${armors.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="tool">
                            ${tools.length > 0 ? `
                                <h4 style="color: #9c27b0; font-size: 0.8rem; margin: 0.5rem 0;">游댢 N치stroje (${tools.length})</h4>
                                ${tools.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="other">
                            ${others.length > 0 ? `
                                <h4 style="color: #8bc34a; font-size: 0.8rem; margin: 0.5rem 0;">游닍 Ostatn칤 (${others.length})</h4>
                                ${others.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Prodat sekce -->
                <div id="caravanSellSection" style="display: none;">
                    <p style="color: #4caf50; font-size: 0.85rem; margin-bottom: 0.5rem;">游냙 Karavana kupuje VECHNO - i po코kozen칠 v캩ci!</p>
                    <div style="max-height: 45vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${renderCaravanSellItems()}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zav콏칤t'}</button>
            `);
        }
        
        function switchCaravanTab(tab) {
            const buySection = document.getElementById('caravanBuySection');
            const sellSection = document.getElementById('caravanSellSection');
            const buyTab = document.getElementById('caravanTabBuy');
            const sellTab = document.getElementById('caravanTabSell');
            
            if (tab === 'buy') {
                buySection.style.display = 'block';
                sellSection.style.display = 'none';
                buyTab.style.background = '#8B4513';
                sellTab.style.background = '#555';
            } else {
                buySection.style.display = 'none';
                sellSection.style.display = 'block';
                buyTab.style.background = '#555';
                sellTab.style.background = '#d4722e';
            }
        }
        
        function sellToCaravan(itemIdx, source = 'inv') {
            // Zjisti odkud se prod치v치 - z invent치콏e, skladu osady nebo skr칳코e
            let item, itemList;
            
            if (source === 'base') {
                // Ze skladu osady (baseItems)
                if (!state.baseItems) {
                    notifyWarning('Chyba', 'Sklad osady neexistuje');
                    return;
                }
                itemList = state.baseItems;
                item = itemList[itemIdx];
            } else if (source === 'stash') {
                // Ze skr칳코e
                if (!state.stashes?.shelter) {
                    notifyWarning('Chyba', 'Skr칳코 neexistuje');
                    return;
                }
                itemList = state.stashes.shelter;
                item = itemList[itemIdx];
            } else {
                // Z invent치콏e
                itemList = state.inv;
                item = itemList[itemIdx];
            }
            
            if (!item) return;
            
            // Quest itemy nelze prodat
            if (item.cantSell || item.type === 'quest') {
                notifyWarning('Nelze prodat', 'Tento p콏edm캩t je pot콏ebn칳 pro quest a nelze ho prodat!');
                return;
            }
            
            // Vycraft캩n칠 p콏edm캩ty nelze prodat obchodn칤k콢m
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoru캜n캩 vyroben칠 v캩ci obchodn칤ci neberou. Zkus online tr쬴코t캩!');
                return;
            }
            
            // V캩ci koupen칠 od karavany nelze prodat zp캩t (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od karavany nelze prodat. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            // V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const basePrice = itemData.price || item.price;
            if (!basePrice) {
                notifyWarning('Nelze prodat', 'Tento p콏edm캩t nem치 hodnotu');
                return;
            }
            
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25; // +25% ceny p콏i prodeji karavan치m
            let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
            
            // Sn칤쬰n칤 ceny za po코kozen칤
            if (item.durability !== undefined && item.maxDurability) {
                const durabilityRatio = item.durability / item.maxDurability;
                sellPrice = Math.floor(sellPrice * durabilityRatio);
                if (sellPrice < 1) sellPrice = 1;
            }
            
            // Gender bonus
            if (state.char.gender === 'female') {
                sellPrice = Math.floor(sellPrice * 1.1);
            }
            
            // P콏idej pen칤ze
            addMoney(sellPrice);
            
            // Odeber z p콏칤slu코n칠ho seznamu
            if (item.count && item.count > 1) {
                item.count--;
            } else {
                itemList.splice(itemIdx, 1);
            }
            
            const sourceText = source === 'stash' ? ' (ze skladu)' : '';
            notifySuccess('Prod치no!', `${item.name}${sourceText} +${sellPrice} 游눯`);
            
            if (source === 'inv') {
                updateCarryWeight();
            }
            
            // Daily quest progress - sold
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + 1;
                checkDailyQuests();
            }
            
            // Refresh karavana shop a z콢sta켿 na prodejn칤m tabu
            openCaravanShop();
            setTimeout(() => switchCaravanTab('sell'), 50);
        }
        
        function filterCaravan(type) {
            // Aktualizuj aktivn칤 tla캜칤tko
            document.querySelectorAll('.caravan-filter').forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.style.background = '#8B4513';
                    btn.classList.add('active');
                } else {
                    btn.style.background = '#333';
                    btn.classList.remove('active');
                }
            });
            
            // Filtruj kategorie
            document.querySelectorAll('.caravan-category').forEach(cat => {
                if (type === 'all' || cat.dataset.type === type) {
                    cat.style.display = 'block';
                } else {
                    cat.style.display = 'none';
                }
            });
        }
        
        function buyCaravanItem(itemId) {
            const item = ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // Kontrola unique item콢 (spac치k, kompas, atd.)
            if (item.unique) {
                const alreadyHas = state.inv.some(i => i.id === itemId);
                if (alreadyHas) {
                    notifyWarning('U m치코 ' + item.name, 'M콢쬰코 m칤t pouze jeden');
                    return;
                }
            }
            
            // Kontrola z치sob
            if (!state.caravanStock?.items?.[itemId] || state.caravanStock.items[itemId] <= 0) {
                notifyWarning('Vyprod치no!', 'Karavana u nem치 ' + item.name);
                return;
            }
            
            // Vypo캜칤tej cenu stejn캩 jako v renderCaravanItem
            const basePrice = calculateItemPrice(item.price);
            const price = Math.floor(basePrice * 0.9); // Karavana m치 nav칤c 10% slevu
            
            if (getMoney() < price) {
                notifyWarning('Nedostatek pen캩z!', 'Pot콏ebuje코 ' + price + ' 游눯');
                return;
            }
            
            // Sni z치soby karavany
            state.caravanStock.items[itemId]--;
            
            // Zjisti jestli jsme v osad캩
            const inSettlement = state.currentTab === 'settlement' ||
                                 (state.settlement?.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until);
            
            if (inSettlement) {
                // V osad캩 - ukl치dej VECHNO do skladu osady
                removeMoney(price);
                
                if (item.type === 'resource') {
                    // Suroviny do settlement.resources
                    state.settlement.resources[item.id] = (state.settlement.resources[item.id] || 0) + 1;
                    notifySuccess('Do skladu!', '+1 ' + item.icon + ' ' + item.name);
                } else {
                    // Ostatn칤 p콏edm캩ty do baseItems (sklad osady)
                    // Ozna캜칤me jako "z karavany" - ni쮄뫆 prodejn칤 cena
                    if (!state.baseItems) state.baseItems = [];
                    const newItem = {
                        ...item,
                        count: 1,
                        fromCaravan: true, // Ozna캜en칤 pro ni쮄뫆 prodejn칤 cenu
                        boughtPrice: price // Za kolik byl koupen
                    };
                    const existing = state.baseItems.find(i => i.id === item.id && i.fromCaravan && (item.stackable || item.type === 'consumable' || item.type === 'ammo'));
                    if (existing) {
                        existing.count = (existing.count || 1) + 1;
                    } else {
                        state.baseItems.push(newItem);
                    }
                    notifySuccess('Do skladu!', item.icon + ' ' + item.name);
                }
                
                addLog('Koupil jsi ' + item.name + ' od karavany (do skladu osady)', '游냙');
            } else {
                // Mimo osadu - norm치ln칤 n치kup do invent치콏e
                if (!canAddItem(item, 1)) {
                    notifyWarning('Pln칳 invent치콏!', 'Neunese코 ' + item.name);
                    return;
                }
                
                removeMoney(price);
                // Ozna캜칤me jako "z karavany"
                const newItem = {
                    ...item,
                    count: 1,
                    fromCaravan: true,
                    boughtPrice: price
                };
                addItemToInventory(newItem, 1);
                addLog('Koupil jsi ' + item.name + ' od karavany', '游냙');
                notifySuccess('Zakoupeno!', item.icon + ' ' + item.name);
            }
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            openCaravanShop(); // Refresh
        }
        
        // === RENDER ===
        function render() {
            // Always update header
            document.getElementById('name').textContent = state.char.name;
            document.getElementById('level').textContent = state.char.level;
            const hpElement = document.getElementById('hp');
            hpElement.textContent = `${Math.round(state.char.hp)}/${state.char.maxHp}`;
            // Blik치n칤 p콏i kritick칠m HP nebo smrteln칠 radiaci
            const hpCritical = state.char.hp < state.char.maxHp * 0.2;
            const radLethalHP = state.status.radiation >= 100;
            if (radLethalHP) {
                // Zelen칠 blik치n칤 p콏i 100% radiaci
                hpElement.style.animation = 'flash-green 0.5s infinite';
                hpElement.style.color = '#76ff03';
            } else if (hpCritical) {
                // 캛erven칠 blik치n칤 p콏i kritick칠m HP
                hpElement.style.animation = 'flash-red 0.5s infinite';
                hpElement.style.color = '#ff0000';
            } else {
                hpElement.style.animation = 'none';
                hpElement.style.color = '';
            }
            updateCarryWeight();
            document.getElementById('weight').textContent = `${state.carryWeight.toFixed(1)}/${state.maxCarryWeight}kg`;
            const dayText = 'Den';
            document.getElementById('time').textContent = `${dayText} ${state.time.days}, ${pad(state.time.hours)}:${pad(state.time.mins)}`;
            
            // Update status bars
            if (state.confirmed) {
                const weather = getCurrentWeather();
                const dayPhase = getCurrentDayPhase();
                
                // Determine danger levels for glowing effects
                const hungerDanger = state.status.hunger < 25;
                const thirstDanger = state.status.thirst < 25;
                const energyDanger = state.status.energy < 25;
                const radDanger = state.status.radiation > 50;
                const radCritical = state.status.radiation >= 80;
                const radLethal = state.status.radiation >= 100;
                
                document.getElementById('statusBars').innerHTML = `
                    <!-- Kompaktn칤 unified panel -->
                    <div style="background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%); border: 1px solid #333; border-radius: 8px; padding: 0.4rem;">
                        <!-- Rychl치 tla캜칤tka - 1 콏치dek -->
                        <div style="display: flex; gap: 0.25rem; margin-bottom: 0.4rem;">
                            <span onclick="showWeatherInfo()" style="flex: 1; background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid #444; color: #ffd700; text-align: center;">
                                ${weather.icon} ${getWeatherName(weather.id)}
                            </span>
                            <span style="flex: 1; background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; border: 1px solid #333; color: #888; text-align: center;">
                                ${dayPhase.icon} ${t('uiDetail', dayPhase.id) || dayPhase.name}
                            </span>
                            <span onclick="showCompanionsInfo()" style="flex: 1; background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${state.companions?.filter(c => !c.isDead).length ? '#4a6a4a' : '#333'}; color: ${state.companions?.filter(c => !c.isDead).length ? 'var(--toxic-green)' : '#666'}; text-align: center;">
                                游논 ${state.companions?.filter(c => !c.isDead).length || 0}/${getMaxCompanions()}
                            </span>
                            <span onclick="showMutantInfo()" style="flex: 1; background: linear-gradient(180deg, ${state.char.class === 'mutant' ? '#1a2a1a' : '#252525'} 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${state.char.class === 'mutant' ? '#76ff03' : (state.mutations?.length > 0 ? '#666' : '#333')}; color: ${state.char.class === 'mutant' ? '#76ff03' : (state.mutations?.length > 0 ? '#ff9800' : '#666')}; text-align: center;">
                                游붍 ${state.mutations?.length || 0}/5
                            </span>
                            <span onclick="showHealthStatusUI()" style="flex: 1; background: linear-gradient(180deg, ${(hasAnyDisease() || hasAnyInjury()) ? '#2a1a1a' : '#252525'} 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${hasAnyDisease() ? '#f44336' : (hasAnyInjury() ? '#ff9800' : '#333')}; color: ${hasAnyDisease() ? '#f44336' : (hasAnyInjury() ? '#ff9800' : '#666')}; text-align: center; ${(hasAnyDisease() || hasAnyInjury()) ? 'animation: pulse-glow 1.5s infinite;' : ''}">
                                游낀 ${(state.diseases?.active?.length || 0) + (state.injuries?.active?.length || 0)}
                            </span>
                            <span onclick="showClassSetUI()" style="flex: 1; background: linear-gradient(180deg, ${getEquippedSetPieces().count > 0 ? '#2a1a3a' : '#252525'} 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${getEquippedSetPieces().count >= 3 ? '#ff9800' : (getEquippedSetPieces().count > 0 ? '#9c27b0' : '#333')}; color: ${getEquippedSetPieces().count >= 3 ? '#ff9800' : (getEquippedSetPieces().count > 0 ? '#ce93d8' : '#666')}; text-align: center;">
                                救 ${getEquippedSetPieces().count}/3
                            </span>
                        </div>
                        
                        <!-- Ak캜n칤 tla캜칤tka - men코칤 -->
                        <div style="display: flex; gap: 0.25rem; margin-bottom: 0.4rem;">
                            <span onclick="showFactionsModal()" style="flex: 1; background: linear-gradient(180deg, #2a2a1a 0%, #1a1a0a 100%); padding: 0.3rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid #4a4a2a; color: #ffd700; text-align: center; font-weight: bold;">
                                游끹勇 ${'Frakce'}
                            </span>
                            <span onclick="openAllQuests()" style="flex: 1; background: linear-gradient(180deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.3rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${(state.dailyQuests.completed?.length || 0) >= (state.dailyQuests.quests?.length || 3) ? '#4a6a4a' : '#4a2a2a'}; color: ${(state.dailyQuests.completed?.length || 0) >= (state.dailyQuests.quests?.length || 3) ? '#8bc34a' : '#ff9800'}; text-align: center; font-weight: bold;">
                                游늶 ${'칔koly'}
                            </span>
                            <span onclick="showCasino()" style="flex: 1; background: linear-gradient(180deg, #2a2a0a 0%, #1a1a00 100%); padding: 0.3rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid #6a6a2a; color: #ffd700; text-align: center; font-weight: bold;">
                                游꿣 Casino
                            </span>
                        </div>
                        
                        <!-- Status bary - horizont치ln칤 -->
                        <div style="display: flex; gap: 0.15rem;">
                            <div onclick="showStatusDetails('hunger')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${hungerDanger ? '#ff4444' : '#2a2a2a'}; ${hungerDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">游꼤 <span style="color: ${hungerDanger ? '#ff4444' : '#ff9900'};">${Math.round(state.status.hunger)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.hunger}%; background: linear-gradient(90deg, #ff6600, #ff9900); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('thirst')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${thirstDanger ? '#ff4444' : '#2a2a2a'}; ${thirstDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">游눦 <span style="color: ${thirstDanger ? '#ff4444' : '#00aaff'};">${Math.round(state.status.thirst)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.thirst}%; background: linear-gradient(90deg, #0066ff, #00aaff); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('energy')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${energyDanger ? '#ff4444' : '#2a2a2a'}; ${energyDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">丘 <span style="color: ${energyDanger ? '#ff4444' : '#99ff00'};">${Math.round(state.status.energy)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.energy}%; background: linear-gradient(90deg, #66cc00, #99ff00); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('mood')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid #2a2a2a;">
                                <div style="font-size: 0.65rem;">游 <span style="color: #cc66ff;">${Math.round(state.status.mood)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.mood}%; background: linear-gradient(90deg, #9933ff, #cc66ff); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('radiation')" style="flex: 1; background: ${radLethal ? '#0a1a0a' : '#151515'}; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${radLethal ? '#76ff03' : radCritical ? '#ff6600' : radDanger ? '#ff9900' : '#2a2a2a'}; ${radLethal ? 'animation: flash-green 0.5s infinite;' : radCritical ? 'animation: pulse-glow 0.5s infinite;' : radDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">驕뮖잺 <span style="color: ${radLethal ? '#76ff03' : radCritical ? '#ff4400' : radDanger ? '#ff9900' : '#76ff03'};">${Math.round(state.status.radiation)}%${radLethal ? ' 驕멆잺' : radCritical ? '!' : ''}</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.radiation}%; background: ${radLethal ? '#76ff03' : 'linear-gradient(90deg, #76ff03, #ff9900, #ff0000)'}; border-radius: 1px;"></div></div>
                            </div>
                        </div>
                        
                        <!-- Aktivn칤 buffy -->
                        ${(() => {
                            const activeBuffs = [];
                            const now = Date.now();
                            if (state.buffs?.luck && state.buffs.luck.until > now) {
                                activeBuffs.push({ icon: '游', name: '맚캩st칤', value: `+${state.buffs.luck.value}%`, time: Math.ceil((state.buffs.luck.until - now) / 60000), color: '#4caf50' });
                            }
                            if (state.buffs?.strength && state.buffs.strength.until > now) {
                                activeBuffs.push({ icon: '游눩', name: 'S칤la', value: `+${state.buffs.strength.value}`, time: Math.ceil((state.buffs.strength.until - now) / 60000), color: '#f44336' });
                            }
                            if (state.buffs?.agility && state.buffs.agility.until > now) {
                                activeBuffs.push({ icon: '游끢', name: 'Obratnost', value: `+${state.buffs.agility.value}`, time: Math.ceil((state.buffs.agility.until - now) / 60000), color: '#2196f3' });
                            }
                            if (state.buffs?.alcoholDamage && state.buffs.alcoholDamage.until > now) {
                                activeBuffs.push({ icon: '游꽄', name: 'DMG', value: `+${state.buffs.alcoholDamage.value}%`, time: Math.ceil((state.buffs.alcoholDamage.until - now) / 60000), color: '#ff9800' });
                            }
                            if (state.buffs?.allStats && state.buffs.allStats.until > now) {
                                activeBuffs.push({ icon: '九', name: 'V코e', value: `+${state.buffs.allStats.value}`, time: Math.ceil((state.buffs.allStats.until - now) / 60000), color: '#ffd700' });
                            }
                            if (state.buffs?.radResist && state.buffs.radResist.until > now) {
                                activeBuffs.push({ icon: '驕뮖잺', name: 'Odolnost', value: `+${state.buffs.radResist.value}%`, time: Math.ceil((state.buffs.radResist.until - now) / 60000), color: '#76ff03' });
                            }
                            if (state.weaponBuff?.fights > 0) {
                                activeBuffs.push({ icon: '丘덢잺', name: 'Zbra켿', value: `+${state.weaponBuff.damage}`, time: state.weaponBuff.fights + ' boj콢', color: '#ffd700' });
                            }
                            
                            if (activeBuffs.length === 0) return '';
                            
                            return `
                                <div onclick="showCharacter()" style="display: flex; flex-wrap: wrap; gap: 0.2rem; margin-top: 0.3rem; cursor: pointer;" title="Klikni pro detaily">
                                    ${activeBuffs.map(b => `
                                        <span style="background: ${b.color}22; border: 1px solid ${b.color}; padding: 0.15rem 0.3rem; border-radius: 4px; font-size: 0.6rem; color: ${b.color}; white-space: nowrap;">
                                            ${b.icon} ${b.value} <span style="color: #888;">(${typeof b.time === 'number' ? b.time + 'm' : b.time})</span>
                                        </span>
                                    `).join('')}
                                </div>
                            `;
                        })()}
                    </div>
                `;
                
                // Update travel timer if traveling
                if (state.map.traveling && state.activeTab === 'map') {
                    const remainingSec = Math.max(0, Math.ceil((state.map.travelStart + state.map.travelDuration - Date.now()) / 1000));
                    const mins = Math.floor(remainingSec / 60);
                    const secs = remainingSec % 60;
                    const timeText = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                    const timerEl = document.querySelector('.tab.active p');
                    if (timerEl && timerEl.textContent.includes('Zb칳v치:')) {
                        timerEl.textContent = `Zb칳v치: ${timeText}`;
                    }
                }
            }
            
            // Only render full UI on state change
            if (!state.confirmed) renderCreation();
        }
        
        function renderFull() {
            // Debug log pouze p콏i prvn칤m renderov치n칤
            if (!window._renderFullLogged) {
                console.log('游꿛 renderFull() - confirmed:', state.confirmed);
                if (state.confirmed) window._renderFullLogged = true;
            }
            
            // KONTROLA XP syst칠mu - p콏epo캜칤tej level z totalXP
            if (state.confirmed && state.char?.level >= 1) {
                // Zajisti 쬰 totalXP existuje
                if (state.char.totalXP === undefined || state.char.totalXP === null) {
                    state.char.totalXP = state.char.xp || 0;
                }
                
                // P콏epo캜칤tej level z totalXP (t칤m se oprav칤 i bugnut칠 ulo쬰n칠 hry)
                if (typeof recalculateLevelFromTotalXP === 'function') {
                    recalculateLevelFromTotalXP();
                }
                
                // Debug log (jen jednou)
                if (!window._xpDebugLogged) {
                    console.log(`游꿡 XP Status: Level ${state.char.level}, XP: ${state.char.xp}/${state.char.xpNeed}, TotalXP: ${state.char.totalXP}`);
                    window._xpDebugLogged = true;
                }
            }
            
            // Aktualizuj maxHp podle skill콢 a atribut콢
            if (state.confirmed && typeof calculateMaxHp === 'function') {
                const newMaxHp = calculateMaxHp();
                if (newMaxHp !== state.char.maxHp) {
                    const diff = newMaxHp - state.char.maxHp;
                    state.char.maxHp = newMaxHp;
                    // Pokud se maxHp zv칳코ilo, p콏idej HP
                    if (diff > 0) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + diff);
                    }
                }
            }
            
            // Aktualizuj nosnost podle skill콢 (pack_rat, s칤la, batoh, exoskelet)
            if (state.confirmed && typeof updateCarryWeight === 'function') {
                updateCarryWeight();
            }
            
            // Migration: Fix ALL companions - runs on every render to ensure correctness
            if (state.companions && state.companions.length > 0) {
                state.companions.forEach(comp => {
                    // Najdi definici spole캜n칤ka
                    const baseDef = COMPANIONS.find(c => c.id === comp.id);
                    
                    // Oprava freed_slave spole캜n칤k콢 (speci치ln칤 p콏칤pad)
                    if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                        comp.id = 'survivor';
                        comp.type = 'human';
                        comp.canEquip = true;
                    }
                    
                    // Dopl켿 chyb캩j칤c칤 atributy z definice nebo pou쬴j v칳choz칤 hodnoty
                    if (!comp.type) comp.type = baseDef?.type || 'human';
                    if (!comp.name) comp.name = baseDef?.name || 'Spole캜n칤k';
                    if (!comp.icon) comp.icon = baseDef?.icon || '游녻';
                    if (!comp.damage) comp.damage = baseDef?.damage || 10;
                    if (!comp.defense) comp.defense = baseDef?.defense || 5;
                    if (!comp.maxHp) comp.maxHp = baseDef?.hp || 50;
                    if (!comp.hp) comp.hp = comp.maxHp;
                    if (comp.level === undefined) comp.level = 1;
                    if (comp.xp === undefined) comp.xp = 0;
                    if (comp.skillPoints === undefined) comp.skillPoints = 0;
                    if (!comp.skills) comp.skills = [];
                    if (comp.loyalty === undefined) comp.loyalty = 50;
                    if (comp.inCombat === undefined) comp.inCombat = true;
                    
                    // Equipped jen pro lidi
                    if (comp.type === 'human' || comp.id === 'survivor') {
                        if (!comp.equipped) comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null };
                        if (comp.canEquip === undefined) comp.canEquip = true;
                    }
                });
            }
            
            // Migration: Add durability to weapons/armor that don't have it (runs once per render, safe)
            if (state.inv) {
                state.inv.forEach(item => {
                    if ((item.type === 'weapon' || item.type === 'armor') && item.durability === undefined) {
                        item.durability = 100;
                        item.maxDurability = 100;
                    }
                });
                
                // Konsoliduj invent치콏 - slou캜 duplicitn칤 stacky
                consolidateInventory();
            }
            
            // Migration: Add settlement if missing
            if (!state.settlement) {
                state.settlement = {
                    level: 1,
                    prosperity: 0,
                    settlers: [],
                    buildings: [],
                    lastRaid: 0,
                    resources: { food: 10, water: 10 },
                    defense: 0,
                    lastUpdateDay: 0
                };
            }
            // Zajisti 쬰 v코echny properties existuj칤
            if (!state.settlement.settlers) state.settlement.settlers = [];
            if (!state.settlement.buildings) state.settlement.buildings = [];
            if (!state.settlement.resources) state.settlement.resources = { food: 10, water: 10 };
            
            render();
            if (state.confirmed) renderGame();
            
            // Show sleep overlay if sleeping
            if (state.isSleeping && state.sleepEndTime) {
                const now = Date.now();
                const remaining = state.sleepEndTime - now;
                
                if (remaining > 0) {
                    const mins = Math.ceil(remaining / (60 * 1000));
                    const progress = ((state.sleepEndTime - state.lastSleepTime - remaining) / (state.sleepEndTime - state.lastSleepTime)) * 100;
                    
                    document.getElementById('modalContent').innerHTML = `
                        <div style="text-align: center;">
                            <h2 style="font-size: 3rem; margin: 0;">游눣</h2>
                            <h2 style="margin: 0.5rem 0;">Sp칤코...</h2>
                            <p style="font-size: 1.2rem; color: #ff9800; margin: 1rem 0;">
                                낌勇 Zb칳v치: <strong>${mins}</strong> minut
                            </p>
                            
                            <div style="background: #1a1a1a; height: 30px; border-radius: 15px; overflow: hidden; margin: 1.5rem 0; border: 2px solid #3a3a3a;">
                                <div style="background: linear-gradient(90deg, #8bc34a, #4caf50); height: 100%; width: ${progress}%; transition: width 1s;"></div>
                            </div>
                            
                            <p style="color: #999; font-size: 0.9rem;">
                                游 Hra je zablokovan치 b캩hem sp치nku<br>
                                B캩hem t칠to doby nem콢쬰코 d캩lat nic
                            </p>
                        </div>
                    `;
                    document.getElementById('modal').classList.add('show');
                }
            }
        }
        
        function renderCreation() {
            // Use name from state - pokud pr치zdn칠, zobraz placeholder
            const currentName = state.char.name || '(klikni pro zad치n칤 jm칠na)';
            
            const selectedClass = state.char.classId ? CLASSES[state.char.classId] : null;
            
            // Lokalizovan칠 texty
            const texts = {
                createFirst: 'Nejprve vytvo콏 postavu',
                gender: 'Pohlav칤',
                selectGender: '丘勇 Vybrat Pohlav칤',
                class: 'Povol치n칤',
                selectClass: '游꿠 Vybrat Povol치n칤',
                attributes: 'Atributy',
                freePoints: 'voln칠 body',
                notSelected: 'Nevybr치no'
            };
            
            document.getElementById('nav').innerHTML = `<div style="padding: 1rem; color: #999;">${texts.createFirst}</div>`;
            document.getElementById('main').innerHTML = `
                <div class="tab active">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <h2 style="margin: 0; flex: 1; min-width: 180px;">${t('charCreate', 'title')}</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="showLanguageSelector()" style="padding: 0.6rem 1rem; background: #333; font-size: 0.85rem;">
                                游깷
                            </button>
                            <button class="btn" onclick="showGameInfo()" style="padding: 0.6rem 1.2rem; background: #2196f3; font-size: 0.85rem; white-space: nowrap;">
                                좶잺 ${t('charCreate', 'whatIsThis')}
                            </button>
                        </div>
                    </div>
                    <label>${t('charCreate', 'name')}:</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                        <div style="flex: 1; background: #2a2a2a; padding: 0.8rem; border-radius: 6px; border: 1px solid #3a3a3a;">
                            <span id="nameDisplay" style="color: #e0e0e0;">${currentName}</span>
                        </div>
                        <button class="btn" onclick="editName()" style="padding: 0.8rem 1.2rem; background: #555;">九勇</button>
                    </div>
                    
                    <h3>${texts.gender}</h3>
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        ${state.char.gender ? `
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="font-size: 3rem;">${getGenders()[state.char.gender].icon}</div>
                                <div>
                                    <h3 style="margin: 0;">${getGenders()[state.char.gender].name}</h3>
                                    <p style="color: #999; margin: 0.3rem 0;">${getGenders()[state.char.gender].desc}</p>
                                    <p style="color: #8bc34a; margin: 0.3rem 0;">
                                        ${Object.entries(GENDERS[state.char.gender].bonuses).map(([attr, bonus]) => 
                                            `+${bonus} ${getAttrs()[attr].name}`
                                        ).join(', ')}
                                    </p>
                                    <p style="color: #ff9800; margin: 0;">${getGenders()[state.char.gender].special}</p>
                                </div>
                            </div>
                        ` : `<p style="color: #999;">${texts.notSelected}</p>`}
                    </div>
                    <button class="btn" onclick="showGenders()" style="width: 100%; margin-bottom: 1rem;">${texts.selectGender}</button>
                    
                    <h3>${texts.class}</h3>
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        ${selectedClass ? `
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="font-size: 3rem;">${selectedClass.icon}</div>
                                <div>
                                    <h3 style="margin: 0;">${selectedClass.name}</h3>
                                    <p style="color: #999; margin: 0.3rem 0;">${selectedClass.desc}</p>
                                    <p style="color: #8bc34a; margin: 0.3rem 0;">${selectedClass.ability}</p>
                                    <p style="color: #ff9800; margin: 0;">${selectedClass.weapon.icon} ${selectedClass.weapon.name}</p>
                                </div>
                            </div>
                        ` : `<p style="color: #999;">${texts.notSelected}</p>`}
                    </div>
                    <button class="btn" onclick="showClasses()" style="width: 100%; margin-bottom: 1rem;">${texts.selectClass}</button>
                    
                    <h3>${texts.attributes} (${texts.freePoints}: ${state.char.points})</h3>
                    ${Object.entries(getAttrs()).map(([key, attr]) => `
                        <div class="attr-row">
                            <span style="flex: 1;">${attr.icon} <strong>${attr.name}</strong> (${attr.desc})</span>
                            <button class="attr-btn" onclick="changeAttr('${key}', -1)" ${state.char.attrs[key] <= 5 ? 'disabled' : ''}></button>
                            <span style="font-size: 1.5rem; font-weight: bold; width: 30px; text-align: center;">${state.char.attrs[key]}</span>
                            <button class="attr-btn" onclick="changeAttr('${key}', 1)" ${state.char.points <= 0 ? 'disabled' : ''}>+</button>
                        </div>
                    `).join('')}
                    
                    <button class="btn" onclick="confirmCharacter()" style="width: 100%; margin-top: 1rem;">九 Potvrdit Postavu</button>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #333;">
                        <button class="btn" onclick="showImportSave()" style="width: 100%; background: #6A1B9A;">游님 ${'Importovat postavu z jin칠ho za콏칤zen칤'}</button>
                    </div>
                </div>
            `;
        }
        
        function renderGame() {
            try {
                console.log('游꿡 renderGame() started');
            document.getElementById('nav').innerHTML = `
                <button class="nav-btn ${state.activeTab === 'map' ? 'active' : ''}" data-tab="map">
                    <span class="icon">游딬勇</span>
                    <span>${t('ui', 'map')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'inv' ? 'active' : ''}" data-tab="inv">
                    <span class="icon">游</span>
                    <span>${t('ui', 'inventory')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'char' ? 'active' : ''}" data-tab="char">
                    <span class="icon">驕뮖잺</span>
                    <span>${'P콏e쬴v코칤'}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'craft' ? 'active' : ''}" data-tab="craft">
                    <span class="icon">游댢</span>
                    <span>${t('ui', 'craft')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'base' ? 'active' : ''}" data-tab="base">
                    <span class="icon">游끸勇</span>
                    <span>${t('ui', 'settlement')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'multiplayer' ? 'active' : ''}" data-tab="multiplayer" style="background: ${multiplayerEnabled ? 'linear-gradient(180deg, #2a1a3a 0%, #1a0a2a 100%)' : ''}; border-color: ${multiplayerEnabled ? '#9c27b0' : ''};">
                    <span class="icon">${multiplayerEnabled ? '游깷' : '游니'}</span>
                    <span>Online</span>
                </button>
            `;
            
            // Add event listeners to nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            document.getElementById('main').innerHTML = `
                <div class="tab ${state.activeTab === 'map' ? 'active' : ''}" id="tabMap">
                    <!-- NOV칗 MAPOV칗 SYST칄M -->
                    ${renderWorldMap()}
                </div>
                <div class="tab ${state.activeTab === 'inv' ? 'active' : ''}" id="tabInv">
                    <!-- HEADER -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--rust); flex-wrap: wrap; gap: 0.3rem;">
                        <h2 style="margin: 0; border: none; padding: 0; font-size: 1rem;">游 ${t('inv', 'title').toUpperCase()}</h2>
                        <div style="display: flex; gap: 0.3rem; align-items: center;">
                            <span style="background: #1a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid var(--metal-light); font-size: 0.7rem;">
                                丘뒲잺<span style="color: ${state.carryWeight > state.maxCarryWeight * 0.8 ? '#ff9800' : 'var(--toxic-green)'};">${state.carryWeight.toFixed(1)}</span>/${state.maxCarryWeight}kg
                            </span>
                            <span style="background: #1a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid var(--warning-yellow); font-size: 0.7rem;">
                                游눯<span style="color: var(--warning-yellow);">${state.money || 0}</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- HLAVN칈 LAYOUT: Equipment + Suroviny -->
                    <div class="responsive-2col" style="margin-bottom: 1rem;">
                        
                        <!-- VYBAVEN칈 - Character Slots -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem; text-align: center;">丘덢잺 ${t('inv', 'equipment').toUpperCase()}</h3>
                            
                            ${(() => {
                                const weapon = state.equipped?.weapon || null;
                                const armor = state.equipped?.armor || null;
                                const gloves = state.equipped?.gloves || null;
                                const boots = state.equipped?.boots || null;
                                const helmet = state.equipped?.helmet || null;
                                const accessory = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
                                
                                let totalAttack = 5 + state.char.attrs.str;
                                if (weapon) totalAttack += weapon.damage || 0;
                                if (state.char.classId === 'raider') totalAttack = Math.floor(totalAttack * 1.3);
                                if (state.base.includes('armory')) totalAttack = Math.floor(totalAttack * 1.1);
                                
                                // Pou쬴j spr치vnou funkci pro v칳po캜et obrany
                                const totalDefense = calculateDefense();
                                
                                return `
                                    <!-- Equipment Grid - 6 slot콢 -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; margin-bottom: 0.5rem;">
                                        <!-- Helmet -->
                                        <div onclick="showEquipmentSlot('helmet')" style="cursor: pointer; background: ${helmet ? 'linear-gradient(135deg, #1a2a1a, #0a1a0a)' : '#0a0a0a'}; border: 1px solid ${helmet ? 'var(--toxic-dark)' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${helmet ? helmet.icon : '游꿠'}</div>
                                            <div style="font-size: 0.45rem; color: ${helmet ? 'var(--toxic-green)' : '#555'};">${helmet ? getItemName(helmet).substring(0,5) : 'Helma'}</div>
                                        </div>
                                        
                                        <!-- Armor -->
                                        <div onclick="showEquipmentSlot('armor')" style="cursor: pointer; background: ${armor ? 'linear-gradient(135deg, #1a1a2a, #0a0a1a)' : '#0a0a0a'}; border: 1px solid ${armor ? '#3949AB' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${armor ? armor.icon : '游녯'}</div>
                                            <div style="font-size: 0.45rem; color: ${armor ? '#7986CB' : '#555'};">${armor ? getItemName(armor).substring(0, 5) : 'Zbroj'}</div>
                                        </div>
                                        
                                        <!-- Accessory -->
                                        <div onclick="showAccessoryModal()" style="cursor: pointer; background: ${accessory ? 'linear-gradient(135deg, #2a2a1a, #1a1a0a)' : '#0a0a0a'}; border: 1px solid ${accessory ? '#ffd700' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${accessory ? accessory.icon : '游눐'}</div>
                                            <div style="font-size: 0.45rem; color: ${accessory ? '#ffd700' : '#555'};">${accessory ? getItemName(accessory).substring(0, 5) : 'Dopln캩k'}</div>
                                        </div>
                                        
                                        <!-- Weapon -->
                                        <div onclick="showEquipmentSlot('weapon')" style="cursor: pointer; background: ${weapon ? 'linear-gradient(135deg, #2a1a1a, #1a0a0a)' : '#0a0a0a'}; border: 1px solid ${weapon ? '#8B0000' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${weapon ? weapon.icon : '九'}</div>
                                            <div style="font-size: 0.45rem; color: ${weapon ? '#ff6666' : '#555'};">${weapon ? getItemName(weapon).substring(0, 5) : 'Zbra켿'}</div>
                                            ${weapon?.ammoType ? `<div style="font-size: 0.4rem; color: ${getAmmoCount(weapon.ammoType) > 0 ? '#4caf50' : '#f44336'};">游댲${getAmmoCount(weapon.ammoType)}</div>` : ''}
                                        </div>
                                        
                                        <!-- Gloves -->
                                        <div onclick="showEquipmentSlot('gloves')" style="cursor: pointer; background: ${gloves ? 'linear-gradient(135deg, #2a2a1a, #1a1a0a)' : '#0a0a0a'}; border: 1px solid ${gloves ? '#ff9800' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${gloves ? gloves.icon : '游볡'}</div>
                                            <div style="font-size: 0.45rem; color: ${gloves ? '#ff9800' : '#555'};">${gloves ? getItemName(gloves).substring(0, 5) : 'Ruce'}</div>
                                        </div>
                                        
                                        <!-- Boots -->
                                        <div onclick="showEquipmentSlot('boots')" style="cursor: pointer; background: ${boots ? 'linear-gradient(135deg, #1a2a2a, #0a1a1a)' : '#0a0a0a'}; border: 1px solid ${boots ? '#00bcd4' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${boots ? boots.icon : '游'}</div>
                                            <div style="font-size: 0.45rem; color: ${boots ? '#00bcd4' : '#555'};">${boots ? getItemName(boots).substring(0, 5) : 'Boty'}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Combat Stats -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                                        <div onclick="showAttackInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid #8B0000;">
                                            <div style="font-size: 1.1rem; color: #ff4444; font-weight: bold;">丘덢잺${totalAttack}</div>
                                            <div style="font-size: 0.55rem; color: #666;">${'칔TOK'}</div>
                                        </div>
                                        <div onclick="showDefenseInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid var(--toxic-dark);">
                                            <div style="font-size: 1.1rem; color: var(--toxic-green); font-weight: bold;">游띠勇${totalDefense}</div>
                                            <div style="font-size: 0.55rem; color: #666;">${'OBRANA'}</div>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                        
                        <!-- SUROVINY -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem; text-align: center;">游닍 ${'SUROVINY'}</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.2rem;">
                                ${[
                                    { key: 'raw_meat', icon: '游볼', name: 'Syrov칠 maso', color: '#D32F2F', desc: 'Syrov칠 maso ze zv칤콏at. 丘멆잺 Kaz칤 se za 6 dn칤! Upe캜 ho nebo prodej.' },
                                    { key: 'fish', icon: '游', name: 'Ryby', color: '#1976D2', desc: '캛erstv칠 ryby. 丘멆잺 Kaz칤 se za 4 dny! Chyt치코 u jezer a 콏ek.' },
                                    { key: 'wood', icon: '游', name: 'D콏evo', color: '#8B4513', desc: 'Z치kladn칤 surovina pro stavbu a topen칤. Najde코 v les칤ch a h치j칤ch.' },
                                    { key: 'metal', icon: '丘뙖잺', name: 'Kov', color: '#607D8B', desc: 'Kovov칳 코rot a sou캜치stky. Najde코 v코ude, nejv칤c v ruin치ch a tov치rn치ch.' },
                                    { key: 'stone', icon: '游', name: 'K치men', color: '#757575', desc: 'Pevn칳 materi치l pro stavbu a n치stroje. B캩쬹캩 dostupn칳.' },
                                    { key: 'cloth', icon: '游빗', name: 'L치tka', color: '#9C27B0', desc: 'Textilie pro v칳robu oble캜en칤 a obvaz콢. Najde코 v obchodech a domech.' },
                                    { key: 'leather', icon: '游붮', name: 'K콢쬰', color: '#795548', desc: 'Vyd캩lan칠 k콢쬰 pro lehkou zbroj. Z칤sk치코 z lovu zv칤콏at v les칤ch.' },
                                    { key: 'herbs', icon: '游', name: 'Bylinky', color: '#4CAF50', desc: 'L칠캜iv칠 rostliny. 丘멆잺 Kaz칤 se za 10 dn칤! Rostou v les칤ch a u laborato콏칤.' },
                                    { key: 'chemicals', icon: '游빍', name: 'Chemik치lie', color: '#00BCD4', desc: 'R콢zn칠 chemick칠 l치tky. Najde코 v nemocnic칤ch, laborato콏칤ch a tov치rn치ch.' },
                                    { key: 'electronics', icon: '游', name: 'Elektronika', color: '#2196F3', desc: 'Sou캜치stky z elektronick칳ch za콏칤zen칤. Hledej ve m캩stech a laborato콏칤ch.' },
                                    { key: 'fuel', icon: '久', name: 'Palivo', color: '#FF5722', desc: 'Ho콏lavina pro gener치tory a motorov칠 zbran캩. Najde코 na benz칤nk치ch a v tov치rn치ch.' },
                                    { key: 'gunpowder', icon: '游눤', name: 'St콏eln칳 prach', color: '#F44336', desc: 'Nebezpe캜n치 l치tka pro v칳robu munice. Vyr치b칤 se z chemik치li칤.' },
                                    { key: 'scrap', icon: '游댤', name: 'rot', color: '#9E9E9E', desc: 'Sm캩s kovu a plast콢. V코ude v ruin치ch, tov치rn치ch a m캩stech.' },
                                    { key: 'glass', icon: '游댩', name: 'Sklo', color: '#03A9F4', desc: 'St콏epy a sklen캩n칠 캜치sti. Najde코 ve m캩stech, obchodech a nemocnic칤ch.' },
                                    { key: 'rope', icon: '俱', name: 'Provaz', color: '#8D6E63', desc: 'Lana a provazy. Vyr치b칤코 z l치tky, najde코 ve skladech a na stavb치ch.' }
                                ].map(r => `
                                    <div onclick="showResourceInfo('${r.key}', '${r.icon}', '${r.name}', '${r.desc}', '${r.color}')" style="cursor: pointer; background: #0a0a0a; padding: 0.2rem; border-radius: 3px; text-align: center; border: 1px solid ${state.resources[r.key] > 0 ? r.color : '#222'}; transition: transform 0.1s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="font-size: 0.8rem;">${r.icon}</div>
                                        <div style="font-size: 0.7rem; font-weight: bold; color: ${state.resources[r.key] > 0 ? r.color : '#333'};">${state.resources[r.key] || 0}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Vz치cn칠 suroviny -->
                            <div style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--metal-light);">
                                <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.4rem; text-align: center;">游눑 ${'VZ츼CN칄'}</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                                    ${[
                                        { key: 'copper', icon: '游릯', name: 'M캩캞', desc: 'Vodiv칳 kov pro elektroniku a munici.' },
                                        { key: 'silver', icon: '拘', name: 'St콏칤bro', desc: 'Vz치cn칳 kov s antimikrobi치ln칤mi vlastnostmi.' },
                                        { key: 'gold', icon: '游리', name: 'Zlato', desc: 'Velmi cenn칳 kov. Pou쮂셨치 se jako m캩na.' },
                                        { key: 'crystal', icon: '游', name: 'Krystal', desc: 'Z치hadn칠 krystaly s energetick칳mi vlastnostmi.' },
                                        { key: 'fur', icon: '游붉', name: 'Ko쬰코ina', desc: 'Tepl치 ko쬰코ina ze zv칤콏at. Pro zimn칤 v칳stroj.' },
                                        { key: 'mutant_blood', icon: '游뽖', name: 'Mutant칤 krev', desc: 'Toxick치 krev mutant콢. Pro speci치ln칤 zbroje.' }
                                    ].map(r => `
                                        <div onclick="showResourceInfo('${r.key}', '${r.icon}', '${r.name}', '${r.desc}', 'var(--warning-yellow)')" style="cursor: pointer; background: #0a0a0a; padding: 0.3rem; border-radius: 4px; text-align: center; border: 1px solid ${state.resources[r.key] > 0 ? 'var(--warning-yellow)' : '#222'}; transition: transform 0.1s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                            <div style="font-size: 0.9rem;">${r.icon}</div>
                                            <div style="font-size: 0.8rem; font-weight: bold; color: ${state.resources[r.key] > 0 ? 'var(--warning-yellow)' : '#333'};">${state.resources[r.key] || 0}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INVENT츼콎 P콎EDM캨T콡 -->
                    <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 1rem; border-radius: 8px; border: 2px solid var(--metal-light);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h3 style="margin: 0; color: var(--rust-light);">游 ${ui('items')} (${state.inv.length})</h3>
                            <div style="display: flex; gap: 0.2rem; flex-wrap: wrap; align-items: center;">
                                <button onclick="mergeInventoryStacks()" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; background: #9c27b0;" title="Spojit rozd캩len칠 stacky">游댕</button>
                                <button onclick="filterInventory('all')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${(window.inventoryFilter || 'all') === 'all' ? 'background: var(--toxic-green); color: #000;' : 'background: var(--metal-mid);'}">V코e</button>
                                <button onclick="filterInventory('healing')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'healing' ? 'background: #E91E63;' : 'background: #880E4F;'}">仇벒잺</button>
                                <button onclick="filterInventory('consumable')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'consumable' ? 'background: #FF6D00;' : 'background: #E65100;'}">游꼤</button>
                                <button onclick="filterInventory('weapon')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'weapon' ? 'background: #D32F2F;' : 'background: #8B0000;'}">丘덢잺</button>
                                <button onclick="filterInventory('armor')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'armor' ? 'background: #5C6BC0;' : 'background: #3949AB;'}">游띠勇</button>
                                <button onclick="filterInventory('helmet')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'helmet' ? 'background: #7B1FA2;' : 'background: #4A148C;'}">久놾잺</button>
                                <button onclick="filterInventory('gloves')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'gloves' ? 'background: #F57C00;' : 'background: #E65100;'}">游볡</button>
                                <button onclick="filterInventory('boots')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'boots' ? 'background: #00ACC1;' : 'background: #00838F;'}">游</button>
                                <button onclick="filterInventory('tool')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'tool' ? 'background: #8D6E63;' : 'background: #5D4037;'}">游댢</button>
                                <button onclick="filterInventory('ammo')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'ammo' ? 'background: #FFA000;' : 'background: #FF8F00;'}">游꿢</button>
                            </div>
                        </div>
                        
                        <!-- Nosnost bar -->
                        <div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.8rem; border: 1px solid var(--metal-light);">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.2rem;">
                                <span>游닍 ${ui('capacity')}</span>
                                <span style="color: ${state.carryWeight > state.maxCarryWeight * 0.8 ? '#ff9800' : 'var(--toxic-green)'};">${state.carryWeight.toFixed(1)} / ${state.maxCarryWeight} kg</span>
                            </div>
                            <div style="background: #1a1a1a; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${Math.min(100, (state.carryWeight / state.maxCarryWeight) * 100)}%; background: linear-gradient(90deg, var(--toxic-green), ${state.carryWeight > state.maxCarryWeight * 0.8 ? '#ff9800' : 'var(--toxic-green)'});"></div>
                            </div>
                            <button onclick="showLootFilterSettings()" style="width: 100%; margin-top: 0.4rem; padding: 0.3rem; font-size: 0.7rem; background: #2a2a3a; border: 1px solid #444; border-radius: 4px; color: #888; cursor: pointer;">
                                游 Auto-loot nastaven칤
                            </button>
                        </div>
                        
                        ${(() => {
                            const currentFilter = window.inventoryFilter || 'all';
                            let filteredInv;
                            if (currentFilter === 'all') {
                                filteredInv = state.inv;
                            } else if (currentFilter === 'healing') {
                                filteredInv = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
                            } else {
                                filteredInv = state.inv.filter(i => i.type === currentFilter);
                            }
                            
                            if (state.inv.length === 0) {
                                return `<div style="text-align: center; padding: 3rem; color: #555;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">游닔</div>
                                    <div>Invent치콏 je pr치zdn칳</div>
                                    <div style="font-size: 0.8rem; margin-top: 0.5rem;">Prozkoumej wasteland a sb칤rej ko콏ist!</div>
                                </div>`;
                            }
                            
                            if (filteredInv.length === 0) {
                                return `<div style="text-align: center; padding: 2rem; color: #666;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">游댌</div>
                                    <div>콯치dn칠 p콏edm캩ty typu "${currentFilter}"</div>
                                    <button onclick="filterInventory('all')" class="btn" style="margin-top: 0.5rem; padding: 0.3rem 0.8rem; font-size: 0.8rem;">Zobrazit v코e</button>
                                </div>`;
                            }
                            
                            return `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.6rem; max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.5rem;">
                                ${filteredInv.map((i) => {
                                    const realIdx = state.inv.indexOf(i);
                                    const typeColors = {
                                        'consumable': { bg: '#1a1a0a', border: '#E65100', glow: 'rgba(230, 81, 0, 0.3)' },
                                        'weapon': { bg: '#1a0a0a', border: '#8B0000', glow: 'rgba(139, 0, 0, 0.3)' },
                                        'armor': { bg: '#0a0a1a', border: '#3949AB', glow: 'rgba(57, 73, 171, 0.3)' },
                                        'tool': { bg: '#1a1510', border: '#5D4037', glow: 'rgba(93, 64, 55, 0.3)' },
                                        'lore': { bg: '#1a1a2a', border: '#9c7cff', glow: 'rgba(156, 124, 255, 0.3)' },
                                        'component': { bg: '#1a0a1a', border: '#9c27b0', glow: 'rgba(156, 39, 176, 0.3)' },
                                        'misc': { bg: '#1a1a1a', border: '#616161', glow: 'rgba(97, 97, 97, 0.3)' }
                                    };
                                    const tc = typeColors[i.type] || typeColors.misc;
                                    
                                    let effectText = '';
                                    if (i.type === 'consumable') {
                                        if (i.effect === 'health') effectText = '仇벒잺+' + i.value;
                                        else if (i.effect === 'hunger') effectText = '游꼤+' + i.value + '%';
                                        else if (i.effect === 'thirst') effectText = '游눦+' + i.value + '%';
                                        else if (i.effect === 'energy') effectText = '丘+' + i.value + '%';
                                        else if (i.effect === 'radiation') effectText = '驕뮖잺' + i.value;
                                        else if (i.effect === 'sleep') effectText = '游눣 ' + ui('sleep');
                                    } else if (i.type === 'weapon') {
                                        effectText = '丘덢잺+' + i.damage + ' DMG';
                                        if (i.ammoType) effectText += ' 游댲' + getAmmoName(i.ammoType);
                                        if (i.special) effectText += ' 救';
                                    } else if (i.type === 'armor') {
                                        effectText = '游띠勇+' + i.defense + ' DEF';
                                    } else if (i.type === 'throwable') {
                                        effectText = '游눤' + (i.damage || '?') + ' DMG';
                                    } else if (i.type === 'weapon_coating') {
                                        effectText = (i.effect === 'poison' ? '驕멆잺 ' + ui('poison') : '游댠 ' + ui('fire')) + ' ' + (i.uses || 5) + 'x';
                                    } else if (i.type === 'accessory') {
                                        effectText = i.desc ? i.desc.substring(0, 15) : '游눐';
                                    } else if (i.type === 'ammo') {
                                        const ammoNames = { 
                                            'arrow': '游낓 ' + ui('bow'), 
                                            'bolt': '游꿢 ' + ui('crossbowAmmo'), 
                                            '9mm': '游댦 ' + ui('pistolAmmo'), 
                                            '556': '游댦 ' + ui('rifleAmmo'), 
                                            '762': '游댦 ' + ui('sniperAmmo'), 
                                            'shell': '游댦 ' + ui('shotgunAmmo'), 
                                            'fuel': '游댠 ' + ui('flameAmmo') 
                                        };
                                        effectText = ammoNames[i.ammoType] || ('游꿢 ' + ui('ammo'));
                                    } else if (i.type === 'lore') {
                                        const isRead = state.readBooks?.includes(i.id);
                                        effectText = isRead ? '游닀 ' + ui('readStatus') : '游늿 ' + ui('unread');
                                    } else if (i.type === 'gloves') {
                                        effectText = '游볡+' + (i.defense || 0) + ' DEF';
                                        if (i.special) effectText += ' 救';
                                    } else if (i.type === 'boots') {
                                        effectText = '游+' + (i.defense || 0) + ' DEF';
                                        if (i.special === 'speed_bonus') effectText += ' 游끢+10%';
                                        else if (i.special === 'dodge_bonus') effectText += ' 游눧+10%';
                                        else if (i.special === 'stealth_move') effectText += ' 游봉-20%';
                                        else if (i.special === 'run_bonus') effectText += ' 游끢+15%';
                                        else if (i.special) effectText += ' 救';
                                    } else if (i.type === 'helmet') {
                                        effectText = '久놾잺+' + (i.defense || 0) + ' DEF';
                                        if (i.special) effectText += ' 救';
                                    } else if (i.type === 'component') {
                                        if (i.id === 'ai_chip') effectText = '游 Vylep코en칤';
                                        else if (i.id === 'mutant_heart') effectText = '游눞 +50 max HP';
                                        else if (i.id === 'deathclaw_hand') effectText = '丘뉦잺 Crafting';
                                        else effectText = '游닆 Quest';
                                    }
                                    
                                    // Clickable types - use index for unique identification
                                    const isClickable = i.type === 'consumable' || i.type === 'weapon_coating' || i.type === 'accessory' || i.type === 'weapon' || i.type === 'tool' || i.type === 'armor' || i.type === 'ammo' || i.type === 'throwable' || i.type === 'lore' || i.type === 'gloves' || i.type === 'boots' || i.type === 'helmet' || i.type === 'component';
                                    let clickAction = '';
                                    if (i.type === 'consumable') clickAction = "confirmUseItemByIndex(" + realIdx + ")";
                                    else if (i.type === 'weapon_coating') clickAction = "applyWeaponCoatingByIndex(" + realIdx + ")";
                                    else if (i.type === 'accessory') clickAction = "equipAccessoryByIndex(" + realIdx + ")";
                                    else if (i.type === 'weapon') clickAction = "showWeaponOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'tool') clickAction = "showToolOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'armor') clickAction = "showArmorOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'gloves') clickAction = "showGlovesOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'boots') clickAction = "showBootsOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'helmet') clickAction = "showHelmetOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'ammo') clickAction = "showAmmoInfoByIndex(" + realIdx + ")";
                                    else if (i.type === 'throwable') clickAction = "showThrowableInfoByIndex(" + realIdx + ")";
                                    else if (i.type === 'lore') clickAction = "readLoreBook('" + i.id + "')";
                                    else if (i.type === 'component') clickAction = "showComponentOptionsByIndex(" + realIdx + ")";
                                    
                                    return `
                                        <div class="card" onclick="${clickAction}" 
                                            style="background: linear-gradient(135deg, ${tc.bg}, #0a0a0a); border-color: ${isItemEquipped(i) ? '#4caf50' : (i.rarity ? RARITY_COLORS[i.rarity] : tc.border)}; padding: 0.6rem; cursor: ${isClickable ? 'pointer' : 'default'}; position: relative; ${isClickable ? 'box-shadow: 0 0 15px ' + (isItemEquipped(i) ? 'rgba(76, 175, 80, 0.5)' : (i.rarity ? RARITY_COLORS[i.rarity] + '44' : tc.glow)) + ';' : ''}">
                                            
                                            ${isItemEquipped(i) ? '<div style="position: absolute; top: 4px; left: 6px; background: #4caf50; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.6rem; font-weight: bold; color: #000;">九 NASAZENO</div>' : ''}
                                            
                                            ${i.count > 1 ? '<div style="position: absolute; top: 4px; right: 6px; background: var(--rust); padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">x' + i.count + '</div>' : ''}
                                            
                                            ${!isItemEquipped(i) && i.rarity ? '<div style="position: absolute; top: 4px; left: 6px; background: ' + RARITY_COLORS[i.rarity] + '22; border: 1px solid ' + RARITY_COLORS[i.rarity] + '; padding: 0.05rem 0.3rem; border-radius: 3px; font-size: 0.55rem; color: ' + RARITY_COLORS[i.rarity] + '; text-transform: uppercase;">' + (getRarityName(i.rarity) || i.rarity) + '</div>' : ''}
                                            
                                            <div style="text-align: center; ${i.rarity ? 'margin-top: 0.8rem;' : ''}">
                                                <div style="font-size: 2rem; margin-bottom: 0.3rem;">${i.icon}</div>
                                                <div style="font-size: 0.75rem; font-weight: bold; color: ${i.rarity ? RARITY_COLORS[i.rarity] : '#ddd'}; margin-bottom: 0.2rem;">${getItemName(i.id) || i.name}</div>
                                                ${effectText ? '<div style="font-size: 0.7rem; color: ' + tc.border + '; margin-bottom: 0.2rem;">' + effectText + '</div>' : ''}
                                                <div style="font-size: 0.65rem; color: #555;">丘뒲잺${i.weight || 0}kg</div>
                                            </div>
                                            
                                            ${i.durability !== undefined ? `
                                                <div style="margin-top: 0.4rem; background: #0a0a0a; height: 4px; border-radius: 2px; overflow: hidden;">
                                                    <div style="height: 100%; width: ${(i.durability/i.maxDurability)*100}%; background: ${(i.durability/i.maxDurability) > 0.5 ? 'var(--toxic-green)' : (i.durability/i.maxDurability) > 0.2 ? 'var(--warning-yellow)' : '#ff4444'};"></div>
                                                </div>
                                            ` : ''}
                                            
                                            ${i.type === 'consumable' ? '<div style="font-size: 0.6rem; color: var(--toxic-green); text-align: center; margin-top: 0.3rem;">郊 ' + ui('use') + '</div>' : ''}
                                            ${i.type === 'lore' ? '<div style="font-size: 0.6rem; color: #9c7cff; text-align: center; margin-top: 0.3rem;">游닀 ' + ui('read') + '</div>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>`;
                        })()}
                    </div>
                    
                    ${state.map.inBase ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #1a2a1a, #0a1a0a); border-radius: 8px; border: 2px solid var(--toxic-dark);">
                            <p style="color: var(--toxic-green); margin: 0; font-size: 0.85rem;">
                                游눠 <strong>${'V 칰krytu'}</strong> - ${'m콢쬰코 ukl치dat v캩ci do skr칳코e p콏es z치lo쬶u Osada'}
                            </p>
                        </div>
                    ` : ''}
                </div>
                <div class="tab ${state.activeTab === 'char' ? 'active' : ''}" id="tabChar">
                    <!-- HEADER -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--rust); flex-wrap: wrap; gap: 0.5rem;">
                        <h2 style="margin: 0; border: none; padding: 0; font-size: 1rem;">驕뮖잺 ${ui('survivor')}</h2>
                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                            <button class="btn" onclick="openCustomization()" style="padding: 0.3rem 0.6rem; font-size: 0.7rem;">游꿛 ${ui('look')}</button>
                            <button class="btn" onclick="openSkillTree()" style="padding: 0.3rem 0.6rem; font-size: 0.7rem; background: var(--toxic-dark);">游꺕 ${ui('skills')} ${state.skillTreePoints ? '(' + state.skillTreePoints + ')' : ''}</button>
                        </div>
                    </div>
                    
                    <!-- PROFIL + BOJOV칄 STATS -->
                    <div class="responsive-2col" style="margin-bottom: 0.8rem;">
                        <!-- Profil -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <div style="display: flex; gap: 0.8rem; align-items: center; margin-bottom: 0.8rem;">
                                <div style="font-size: 2.5rem;">${CLASSES[state.char.classId]?.icon || '游녻'}</div>
                                <div style="min-width: 0; flex: 1;">
                                    <div style="font-size: 1rem; font-weight: bold; color: var(--warning-yellow); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${state.char.name}</div>
                                    <div style="font-size: 0.7rem; color: #888;">${state.char.gender ? (GENDERS[state.char.gender].name) : ''} ${getClassName(state.char.classId)}</div>
                                    <div style="font-size: 0.65rem; color: var(--toxic-green);">${state.appearance?.title ? TITLES.find(t => t.id === state.appearance.title)?.name || '' : ''}</div>
                                </div>
                            </div>
                            
                            <!-- Level bar -->
                            <div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px; border: 1px solid var(--metal-light);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 0.2rem;">
                                    <span>救 Lv.${state.char.level}</span>
                                    <span style="color: var(--toxic-green);">${state.char.xp}/${state.char.xpNeed}</span>
                                </div>
                                <div style="background: #1a1a1a; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${(state.char.xp / state.char.xpNeed) * 100}%; background: linear-gradient(90deg, var(--rust), var(--warning-yellow));"></div>
                                </div>
                            </div>
                            
                            <!-- V칗HODA POVOL츼N칈 -->
                            ${(() => {
                                const classData = CLASSES[state.char.classId];
                                if (!classData) return '';
                                
                                return `
                                    <div onclick="showClassAbilityInfo()" style="cursor: pointer; margin-top: 0.5rem; padding: 0.5rem; background: linear-gradient(135deg, ${classData.color}22, ${classData.color}11); border-radius: 6px; border: 1px solid ${classData.color}55;">
                                        <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.3rem;">
                                            <span style="font-size: 1rem;">${classData.icon}</span>
                                            <span style="font-size: 0.75rem; color: ${classData.color}; font-weight: bold;">${getClassName(state.char.classId)}</span>
                                        </div>
                                        <div style="font-size: 0.7rem; color: #ffd700; margin-bottom: 0.2rem;">丘 ${getClassAbility(state.char.classId)}</div>
                                        <div style="font-size: 0.65rem; color: #9c27b0;">游댩 ${getClassPassive(state.char.classId)}</div>
                                    </div>
                                `;
                            })()}
                            
                            <!-- AKTIVN칈 DOVEDNOSTI ZE SKILL TREE -->
                            ${(() => {
                                // Sb칤rej aktivn칤 dovednosti ze v코ech v캩tv칤 skill tree
                                const activeSkills = [];
                                if (state.skillTree) {
                                    Object.entries(state.skillTree).forEach(([branchId, skills]) => {
                                        const branch = SKILL_TREE[branchId];
                                        if (branch && skills) {
                                            Object.entries(skills).forEach(([skillId, level]) => {
                                                if (level > 0) {
                                                    const skill = branch.skills.find(s => s.id === skillId);
                                                    if (skill) {
                                                        activeSkills.push({ ...skill, level, branchId, branchIcon: branch.icon, branchColor: branch.color });
                                                    }
                                                }
                                            });
                                        }
                                    });
                                }
                                
                                if (activeSkills.length === 0) {
                                    return `
                                        <div style="margin-top: 0.5rem; padding: 0.4rem; background: #0a0a0a; border-radius: 6px; border: 1px solid #333; text-align: center;">
                                            <span style="color: #666; font-size: 0.7rem;">${'游꺕 Nem치코 쮂멳n칠 dovednosti'}</span>
                                        </div>
                                    `;
                                }
                                
                                return `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: linear-gradient(135deg, #0a1a0a, #0a0a0a); border-radius: 6px; border: 1px solid var(--toxic-dark);">
                                        <div style="font-size: 0.7rem; color: var(--toxic-green); font-weight: bold; margin-bottom: 0.4rem;">${'游꺕 Aktivn칤 dovednosti ('}${activeSkills.length})</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                                            ${activeSkills.map(skill => {
                                                return '<div onclick="openSkillTree()" style="cursor: pointer; background: linear-gradient(135deg, ' + skill.branchColor + '33, #0d0d0d); padding: 0.25rem 0.4rem; border-radius: 4px; border: 1px solid ' + skill.branchColor + '55; font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem;" title="' + skill.name + ': ' + skill.desc + '">' +
                                                    '<span>' + skill.icon + '</span>' +
                                                    '<span style="color: #fff; font-size: 0.65rem;">' + skill.name.substring(0, 8) + '</span>' +
                                                    '<span style="color: ' + skill.branchColor + '; font-weight: bold; font-size: 0.65rem;">' + skill.level + '</span>' +
                                                '</div>';
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            })()}
                            
                            <!-- Voln칠 body -->
                            ${state.char.levelUpPoints > 0 || state.skillTreePoints > 0 ? `
                                <div style="margin-top: 0.5rem; padding: 0.4rem; background: linear-gradient(135deg, #1a2a1a, #0a1a0a); border-radius: 4px; border: 1px solid var(--toxic-dark);">
                                    <div style="font-size: 0.65rem; color: var(--toxic-green);">${'Voln칠 body:'}</div>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.2rem; font-size: 0.7rem;">
                                        ${state.char.levelUpPoints > 0 ? '<span style="color: var(--warning-yellow);">游눩' + state.char.levelUpPoints + '</span>' : ''}
                                        ${state.skillTreePoints > 0 ? '<span style="color: var(--toxic-green);">游꺕' + state.skillTreePoints + '</span>' : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Bojov칠 stats -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem;">${'丘덢잺 BOJ'}</h3>
                            ${(() => {
                                let totalAttack = 5 + state.char.attrs.str;
                                const weapon = state.equipped?.weapon || null;
                                if (weapon) totalAttack += weapon.damage || 0;
                                if (state.char.classId === 'raider') totalAttack = Math.floor(totalAttack * 1.3);
                                if (state.base.includes('armory')) totalAttack = Math.floor(totalAttack * 1.1);
                                totalAttack = Math.floor(totalAttack * (1 + getSkillTreeBonus('damageBonus')));
                                
                                // Pou쬴j spr치vnou funkci pro v칳po캜et obrany
                                const totalDefense = calculateDefense();
                                const armor = state.equipped?.armor || null;
                                
                                // Pou쬴j spr치vn칠 v칳po캜etn칤 funkce
                                const critChance = Math.round(calculateCritChance() * 100);
                                const dodgeChance = Math.round(calculateDodgeChance() * 100);
                                
                                return `
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.3rem;">
                                        <div onclick="showAttackInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid #8B0000;">
                                            <div style="font-size: 1.1rem; color: #ff4444; font-weight: bold;">丘덢잺${totalAttack}</div>
                                            <div style="font-size: 0.55rem; color: #666;">칔TOK</div>
                                        </div>
                                        <div onclick="showDefenseInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid var(--toxic-dark);">
                                            <div style="font-size: 1.1rem; color: var(--toxic-green); font-weight: bold;">游띠勇${totalDefense}</div>
                                            <div style="font-size: 0.55rem; color: #666;">DEF</div>
                                        </div>
                                        <div onclick="showCritInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid var(--warning-yellow);">
                                            <div style="font-size: 1rem; color: var(--warning-yellow); font-weight: bold;">游눤${critChance}%</div>
                                            <div style="font-size: 0.55rem; color: #666;">CRIT</div>
                                        </div>
                                        <div onclick="showDodgeInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid #3949AB;">
                                            <div style="font-size: 1rem; color: #7986CB; font-weight: bold;">游눧${dodgeChance}%</div>
                                            <div style="font-size: 0.55rem; color: #666;">칔HYB</div>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    
                    <!-- ATRIBUTY - kompaktn칤 -->
                    <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--metal-light); margin-bottom: 0.8rem;">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem;">${'游눩 ATRIBUTY'}</h3>
                        <div class="responsive-6col">
                            ${Object.entries(ATTRS).map(([key, attr]) => {
                                const value = state.char.attrs[key] || 5;
                                return `
                                    <div onclick="${state.char.levelUpPoints > 0 ? 'levelUpAttr(\'' + key + '\')' : 'showAttrInfo(\'' + key + '\')'}" style="cursor: pointer; background: #0a0a0a; padding: 0.3rem; border-radius: 4px; text-align: center; border: 1px solid ${state.char.levelUpPoints > 0 ? 'var(--toxic-dark)' : 'var(--metal-light)'}; transition: transform 0.1s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="font-size: 1rem;">${attr.icon}</div>
                                        <div style="font-size: 0.9rem; font-weight: bold; color: var(--warning-yellow);">${value}</div>
                                        <div style="font-size: 0.5rem; color: #666;">${attr.name.substring(0,3)}</div>
                                        ${state.char.levelUpPoints > 0 ? '<div style="font-size: 0.5rem; color: var(--toxic-green);">+1</div>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- ACHIEVEMENTY -->
                    <details style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid var(--warning-yellow); margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: var(--warning-yellow); font-weight: bold;">
                            游끥 ${'ACHIEVEMENTY'} (${state.achievements.length}/${ACHIEVEMENTS.length})
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                ${ACHIEVEMENTS.map(ach => {
                                    const unlocked = state.achievements.includes(ach.id);
                                    return `
                                        <div style="background: ${unlocked ? 'linear-gradient(135deg, #1a2a1a, #0a1a0a)' : '#0a0a0a'}; padding: 0.6rem; border-radius: 6px; border: 1px solid ${unlocked ? 'var(--toxic-dark)' : '#222'}; display: flex; align-items: center; gap: 0.5rem; opacity: ${unlocked ? '1' : '0.4'};">
                                            <div style="font-size: 1.5rem;">${unlocked ? ach.icon : '游'}</div>
                                            <div>
                                                <div style="font-size: 0.8rem; font-weight: bold; color: ${unlocked ? 'var(--toxic-green)' : '#555'};">${getAchievementName(ach.id)}</div>
                                                <div style="font-size: 0.65rem; color: #666;">${getAchievementDesc(ach.id)}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                    
                    <!-- BESTI츼콎 -->
                    <details style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid #8B0000; margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: #ff4444; font-weight: bold;">
                            游닀 BESTI츼콎 (${Object.keys(state.stats.killsByType || {}).filter(k => (state.stats.killsByType || {})[k] > 0).length}/${ENEMIES.length})
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">Seznam v코ech nep콏치tel kter칠 jsi porazil.</p>
                            <button class="btn" onclick="showBestiary()" style="width: 100%; background: linear-gradient(135deg, #8B0000, #4a0000);">
                                游닀 Otev콏칤t besti치콏
                            </button>
                        </div>
                    </details>
                    
                    <!-- STATISTIKY -->
                    <details style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid var(--rust); margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: var(--rust-light); font-weight: bold;">
                            游늵 STATISTIKY
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid var(--rust);">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--rust-light);">${state.world?.visitedLocations?.length || 0}</div>
                                    <div style="font-size: 0.7rem; color: #666;">游딬勇 Lokac칤</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid #8B0000;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: #ff4444;">${state.stats.kills}</div>
                                    <div style="font-size: 0.7rem; color: #666;">丘덢잺 Zabit칤</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid var(--warning-yellow);">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--warning-yellow);">${state.stats.totalMoneyEarned || 0}</div>
                                    <div style="font-size: 0.7rem; color: #666;">游눯 Vyd캩lal</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid var(--toxic-dark);">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--toxic-green);">${state.stats.itemsCrafted}</div>
                                    <div style="font-size: 0.7rem; color: #666;">游댣 Crafty</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid #3949AB;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: #7986CB;">${state.time.days}d ${state.time.hours}h</div>
                                    <div style="font-size: 0.7rem; color: #666;">游늰 Hern칤 캜as</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid #6A1B9A;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: #9C27B0;">${Math.floor(state.time.totalElapsed / 3600)}h</div>
                                    <div style="font-size: 0.7rem; color: #666;">낌勇 Real time</div>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <!-- HERN칈 DEN칈K -->
                    <details open style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid #4a4a4a; margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: #aaa; font-weight: bold;">
                            游닆 HERN칈 DEN칈K
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; border-radius: 6px; padding: 0.5rem; border: 1px solid #333;">
                                ${(() => {
                                    const logs = state.log || [];
                                    const settlementLogs = state.settlement?.eventLog || [];
                                    
                                    // Kombinuj logy - p콏idej typ
                                    const allLogs = [
                                        ...logs.map(l => ({ ...l, type: 'player' })),
                                        ...settlementLogs.map(l => ({ 
                                            time: 'Den ' + l.day, 
                                            text: l.icon + ' ' + l.name + ': ' + l.desc,
                                            type: 'settlement',
                                            timestamp: l.timestamp || 0
                                        }))
                                    ];
                                    
                                    // Se콏a캞 podle 캜asu (nejnov캩j코칤 naho콏e)
                                    allLogs.sort((a, b) => {
                                        const timeA = a.timestamp || 0;
                                        const timeB = b.timestamp || 0;
                                        return timeB - timeA;
                                    });
                                    
                                    if (allLogs.length === 0) {
                                        return '<div style="text-align: center; color: #555; padding: 1rem;">Zat칤m 쮂멳n칠 z치znamy...</div>';
                                    }
                                    
                                    // Zobraz posledn칤ch 50 z치znam콢
                                    return allLogs.slice(0, 50).map(log => {
                                        const bgColor = log.type === 'settlement' ? '#1a1a2a' : '#1a1a1a';
                                        const borderColor = log.type === 'settlement' ? '#3949AB' : '#333';
                                        const typeIcon = log.type === 'settlement' ? '游끶勇' : '游녻';
                                        return '<div style="padding: 0.4rem 0.6rem; margin-bottom: 0.3rem; background: ' + bgColor + '; border-radius: 4px; border-left: 3px solid ' + borderColor + '; font-size: 0.75rem;">' +
                                            '<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">' +
                                                '<span style="color: #888; flex-shrink: 0;">' + typeIcon + ' ' + log.time + '</span>' +
                                                '<span style="color: #ccc; text-align: right;">' + log.text + '</span>' +
                                            '</div>' +
                                        '</div>';
                                    }).join('');
                                })()}
                            </div>
                            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.7rem; color: #555;">游녻 Hr치캜 | 游끶勇 Osada</span>
                                <button class="btn" onclick="clearGameLog()" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; background: #333;">游딈勇 Vymazat</button>
                            </div>
                        </div>
                    </details>
                    
                    <!-- OVL츼D츼N칈 HRY - jen p콏enos, hlavn칤 akce v Online sekci -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <button class="btn" onclick="showExportImport()" style="background: #6A1B9A; font-size: 0.8rem; padding: 0.5rem 1rem;">游님 P콏enos save</button>
                        <button class="btn" onclick="showAuthModal()" style="background: #3949AB; font-size: 0.8rem; padding: 0.5rem 1rem;">游녻 Online 칰캜et</button>
                        <span style="margin-left: auto; font-size: 0.7rem; color: #555; align-self: center;">Seed: ${state.worldSeed}</span>
                    </div>
                </div>
                <div class="tab ${state.activeTab === 'craft' ? 'active' : ''}" id="tabCraft">
                    <h2>游댣 ${t('craftUI', 'title')}</h2>
                    <!-- Zobrazen칤 surovin -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.85rem;">
                            ${(() => {
                                const hasCryo = state.settlement?.buildings?.includes('cryo_storage') || state.base?.includes('cryo_storage');
                                const getFreshnessInfo = (itemId, maxDays) => {
                                    const frozen = 'Zmra쬰no';
                                    const spoiled = 'Zka쬰n칠!';
                                    const tomorrow = 'Z칤tra se zkaz칤!';
                                    const daysText = 'dn칤 zb칳v치';
                                    const lastsText = `Vydr쮂 ${maxDays} dn칤`;
                                    
                                    if (hasCryo) return { icon: '仇勇', text: frozen, color: '#00bcd4' };
                                    if (!state.foodTimestamps || !state.foodTimestamps[itemId]) return { icon: '', text: lastsText, color: '#8bc34a' };
                                    const daysLeft = maxDays - (state.time.days - state.foodTimestamps[itemId]);
                                    if (daysLeft <= 0) return { icon: '游', text: spoiled, color: '#c62828' };
                                    if (daysLeft <= 1) return { icon: '丘멆잺', text: tomorrow, color: '#ff9800' };
                                    if (daysLeft <= 2) return { icon: '낋', text: `${daysLeft} ${daysText}`, color: '#ff9800' };
                                    return { icon: '九', text: `${daysLeft} ${daysText}`, color: '#8bc34a' };
                                };
                                const meatInfo = getFreshnessInfo('raw_meat', 6);
                                const fishInfo = getFreshnessInfo('fish', 4);
                                const herbsInfo = getFreshnessInfo('herbs', 10);
                                return `
                                    <span style="cursor: help; ${(state.resources.raw_meat || 0) > 0 ? `color: ${meatInfo.color};` : ''}" 
                                          title="${t('resources', 'meat') || 'Syrov칠 maso'} - ${meatInfo.text}">${meatInfo.icon}游볼 ${state.resources.raw_meat || 0}</span>
                                    <span style="cursor: help; ${(state.resources.fish || 0) > 0 ? `color: ${fishInfo.color};` : ''}" 
                                          title="${'Ryba'} - ${fishInfo.text}">${fishInfo.icon}游 ${state.resources.fish || 0}</span>
                                    <span style="cursor: help; ${(state.resources.herbs || 0) > 0 ? `color: ${herbsInfo.color};` : ''}" 
                                          title="${t('resources', 'herbs')} - ${herbsInfo.text}">${herbsInfo.icon}游 ${state.resources.herbs || 0}</span>
                                `;
                            })()}
                            <span title="${t('resources', 'wood')}">游 ${state.resources.wood || 0}</span>
                            <span title="${t('resources', 'metal')}">丘뙖잺 ${state.resources.metal || 0}</span>
                            <span title="${t('resources', 'stone')}">游 ${state.resources.stone || 0}</span>
                            <span title="${t('resources', 'cloth')}">游빗 ${state.resources.cloth || 0}</span>
                            <span title="${t('resources', 'leather')}">游붮 ${state.resources.leather || 0}</span>
                            <span title="Provaz">俱 ${state.resources.rope || 0}</span>
                            <span title="Chemik치lie">游빍 ${state.resources.chemicals || 0}</span>
                            <span title="Sklo">游댩 ${state.resources.glass || 0}</span>
                            <span title="Elektronika">游 ${state.resources.electronics || 0}</span>
                            <span title="Palivo">久 ${state.resources.fuel || 0}</span>
                            <span title="St콏eln칳 prach">游눤 ${state.resources.gunpowder || 0}</span>
                            <span title="M캩캞">游릯 ${state.resources.copper || 0}</span>
                            <span title="rot">游댤 ${state.resources.scrap || 0}</span>
                        </div>
                    </div>
                    
                    <!-- Filtr kategori칤 -->
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="filterCraft('all')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${!state.craftFilter || state.craftFilter === 'all' ? '' : 'background: #333;'}">游닍 ${'V코e'}</button>
                        <button class="btn" onclick="filterCraft('weapon')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'weapon' ? '' : 'background: #333;'}">丘덢잺 ${'Zbran캩'}</button>
                        <button class="btn" onclick="filterCraft('armor')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'armor' ? '' : 'background: #333;'}">游띠勇 ${'Zbroje'}</button>
                        <button class="btn" onclick="filterCraft('medical')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'medical' ? '' : 'background: #333;'}">丘됊잺 ${'L칠캜iva'}</button>
                        <button class="btn" onclick="filterCraft('food')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'food' ? '' : 'background: #333;'}">游꼤 ${'J칤dlo'}</button>
                        <button class="btn" onclick="filterCraft('tool')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'tool' ? '' : 'background: #333;'}">游댢 ${'N치stroje'}</button>
                        <button class="btn" onclick="filterCraft('ammo')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'ammo' ? '' : 'background: #333;'}">游눢 ${'Munice'}</button>
                        <button class="btn" onclick="filterCraft('special')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'special' ? '' : 'background: #333;'}">九 ${'Speci치ln칤'}</button>
                        ${getSkillLevel('legendary_smith') > 0 ? `<button class="btn" onclick="filterCraft('legendary')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: ${state.craftFilter === 'legendary' ? 'linear-gradient(135deg, #ffd700, #ff8f00)' : '#333'}; ${state.craftFilter === 'legendary' ? 'color: #000;' : ''}">救 Legend치rn칤</button>` : ''}
                    </div>
                    
                    ${renderCraftingRecipes()}
                </div>
                <div class="tab ${state.activeTab === 'base' ? 'active' : ''}" id="tabBase">
                    <!-- HEADER S N츼ZVEM OSADY -->
                    <div style="background: linear-gradient(135deg, #2a1a0a 0%, #1a0a00 100%); padding: 1.2rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #8B4513; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255,100,0,0.1) 0%, transparent 70%);"></div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h2 style="margin: 0; color: #ffd700; text-shadow: 0 0 10px rgba(255,200,0,0.3);">游끶勇 ${state.settlement.name || t('settlementUI', 'title')}</h2>
                                <p style="margin: 0.3rem 0 0 0; color: #a0a0a0; font-size: 0.85rem; font-style: italic;">
                                    ${state.settlement.level === 1 ? ('"Skromn칳 za캜치tek v pustin캩..."') : 
                                      state.settlement.level === 2 ? ('"Rostouc칤 komunita pln치 nad캩je."') :
                                      state.settlement.level >= 3 ? ('"Ba코ta civilizace v divo캜in캩!"') : ''}
                                </p>
                            </div>
                        </div>
                        
                        <!-- LEVEL & PROSPERITY BAR -->
                        <div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="background: #0a0a0a; padding: 0.5rem 1rem; border-radius: 20px; border: 2px solid ${state.settlement.level >= 3 ? '#ffd700' : state.settlement.level >= 2 ? '#c0c0c0' : '#cd7f32'};">
                                <span style="color: #888;">LVL</span> <strong style="font-size: 1.3rem; color: #fff;">${state.settlement.level}</strong>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.2rem;">
                                    <span style="color: #888;">${t('settlementUI', 'prosperity')}</span>
                                    <span style="color: ${state.settlement.prosperity >= 80 ? '#8bc34a' : '#ffd700'};">${state.settlement.prosperity}/100 ${state.settlement.prosperity >= 80 ? '游' : ''}</span>
                                </div>
                                <div style="background: #0a0a0a; height: 12px; border-radius: 6px; overflow: hidden; border: 1px solid #333;">
                                    <div style="width: ${state.settlement.prosperity}%; height: 100%; background: linear-gradient(90deg, #8B4513, #ffd700); transition: width 0.5s; box-shadow: 0 0 10px rgba(255,200,0,0.3);"></div>
                                </div>
                                ${state.settlement.prosperity >= 100 && state.settlement.level < 5 ? 
                                    `<button class="btn" onclick="forceSettlementLevelUp()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(180deg, #ffd700 0%, #ff9800 100%); color: #000; font-weight: bold; padding: 0.5rem; border-radius: 6px;">游꿀 ${'LEVEL UP OSADY!'}</button>` :
                                    (state.settlement.prosperity >= 80 ? `<p style="margin: 0.3rem 0 0 0; font-size: 0.75rem; color: #8bc34a;">九 ${'Bl칤쮂솬 se k dal코칤mu levelu!'}</p>` : '')
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- RYCHL칗 P콎EHLED - 2 콏치dky -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; margin-bottom: 0.4rem;">
                        <div onclick="showSettlementPopulationInfo()" style="background: linear-gradient(180deg, #1a2a1a 0%, #0a150a 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #2d4a2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">游논</div>
                            <div style="font-size: 1rem; font-weight: bold; color: #8bc34a;">${state.settlement?.settlers?.length || 0}</div>
                            <div style="font-size: 0.6rem; color: #666;">${currentLang === "en" ? "Residents" : "Obyvatel칠"}</div>
                        </div>
                        <div onclick="showSettlementDefenseInfo()" style="background: linear-gradient(180deg, #2a1a1a 0%, #150a0a 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #4a2d2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">游띠勇</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${calculateSettlementDefense() > 30 ? '#8bc34a' : calculateSettlementDefense() > 10 ? '#ff9800' : '#c62828'};">${calculateSettlementDefense()}</div>
                            <div style="font-size: 0.6rem; color: #666;">${currentLang === "en" ? "Defense" : "Obrana"}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; margin-bottom: 1rem;">
                        <div onclick="showSettlementFoodInfo()" style="background: linear-gradient(180deg, #2a2a1a 0%, #15150a 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #4a4a2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">游꼤</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${(state.settlement?.resources?.food || 0) > 20 ? '#8bc34a' : (state.settlement?.resources?.food || 0) > 5 ? '#ff9800' : '#c62828'};">${state.settlement?.resources?.food || 0}</div>
                            <div style="font-size: 0.6rem; color: ${calculateSettlementBalance().food >= 0 ? '#8bc34a' : '#c62828'};">${calculateSettlementBalance().food >= 0 ? '+' : ''}${calculateSettlementBalance().food}/den</div>
                        </div>
                        <div onclick="showSettlementWaterInfo()" style="background: linear-gradient(180deg, #1a2a2a 0%, #0a1515 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #2d4a4a; cursor: pointer;">
                            <div style="font-size: 1.1rem;">游눦</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${(state.settlement?.resources?.water || 0) > 20 ? '#8bc34a' : (state.settlement?.resources?.water || 0) > 5 ? '#ff9800' : '#c62828'};">${state.settlement?.resources?.water || 0}</div>
                            <div style="font-size: 0.6rem; color: ${calculateSettlementBalance().water >= 0 ? '#8bc34a' : '#c62828'};">${calculateSettlementBalance().water >= 0 ? '+' : ''}${calculateSettlementBalance().water}/den</div>
                        </div>
                        <div onclick="showSettlementPowerInfo()" style="background: linear-gradient(180deg, #2a2a0a 0%, #151505 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #4a4a2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">丘</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${calculatePowerBalance() >= 0 ? '#ffd700' : '#c62828'};">${calculatePowerProduction()}/${calculatePowerConsumption()}</div>
                            <div style="font-size: 0.6rem; color: #666;">${currentLang === "en" ? "Power" : "Elekt콏ina"}</div>
                        </div>
                    </div>
                    
                    <!-- HISTORIE UD츼LOST칈 -->
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; background: linear-gradient(90deg, #2a2a2a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 8px; border: 1px solid #444; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">游닆</span>
                            <span style="font-weight: bold;">${currentLang === "en" ? "Event History" : "Historie ud치lost칤"}</span>
                            <span style="color: #888; font-size: 0.85rem; margin-left: auto;">(${state.settlement.eventLog?.length || 0})</span>
                        </summary>
                        <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${state.settlement.eventLog && state.settlement.eventLog.length > 0 ? 
                                state.settlement.eventLog.slice(0, 10).map((e, idx) => `
                                    <div onclick="showEventDetailByIndex(${idx})" 
                                         style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #222; cursor: pointer; transition: background 0.2s;"
                                         onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">
                                        <span style="font-size: 1.2rem;">${e.icon}</span>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #ddd;">${e.name}</div>
                                            ${e.details ? `<div style="font-size: 0.75rem; color: #ff9800;">${e.details}</div>` : ''}
                                            <div style="font-size: 0.7rem; color: #666;">Den ${e.day}</div>
                                        </div>
                                        <span style="color: #444; font-size: 0.8rem;"></span>
                                    </div>
                                `).join('') 
                            : '<p style="color: #555; text-align: center; margin: 1rem 0;">Zat칤m 쮂멳n칠 ud치losti...</p>'}
                            
                            <div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid #333;">
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">游늵 ${'마nce na ud치losti (za hern칤 den):'}</div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.2rem; font-size: 0.7rem;">
                                    <span style="color: #8bc34a;">游 ${'Obchodn칤k'}: 25%</span>
                                    <span style="color: #ff9800;">游눡 ${'Spor'}: 15%</span>
                                    <span style="color: #8bc34a;">游 ${'Sklize켿'}: 12%</span>
                                    <span style="color: #8bc34a;">游꿀 ${'Oslava'}: 10%</span>
                                    <span style="color: #c62828;">游 ${'Nemoc'}: 10%</span>
                                    <span style="color: #2196f3;">游 ${'Uprchl칤k'}: 10%</span>
                                    <span style="color: #2196f3;">游닍 ${'N치lez'}: 10%</span>
                                    <span style="color: #8bc34a;">游댡 ${'Objev'}: 8%</span>
                                    <span style="color: #2196f3;">游냇 ${'Pes'}: 8%</span>
                                    <span style="color: #2196f3;">游뽗 ${'Cizinec'}: 8%</span>
                                    <span style="color: #2196f3;">丘뒲잺 ${'Spor'}: 8%</span>
                                    <span style="color: #ff9800;">游붛 ${'Kr치de'}: 8%</span>
                                    <span style="color: #ff9800;">游뽖 ${'Nehoda'}: 8%</span>
                                    <span style="color: #c62828;">游끢 ${'칔t캩k'}: 6%</span>
                                    <span style="color: #8bc34a;">游꽆 ${'Narozen칤'}: 5%</span>
                                    <span style="color: #8bc34a;">丘 ${'Inspirace'}: 5%</span>
                                    <span style="color: #9c27b0;">游꿠 ${'Z치hadn칳'}: 5%</span>
                                    <span style="color: #c62828;">游 ${'Bandita'}: 5%</span>
                                    <span style="color: #2196f3;">游놌 ${'D칤t캩'}: 5%</span>
                                    <span style="color: #c62828;">游댠 ${'Po쮂r'}: 4%</span>
                                    <span style="color: #8bc34a;">游눐 ${'Svatba'}: 3%</span>
                                    <span style="color: #ffd700;">游눑 ${'Poklad'}: 3%</span>
                                    <span style="color: #ffd700;">九 ${'Zlat칳 v캩k'}: 2%</span>
                                    <span style="color: #c62828;">驕멆잺 ${'Mor'}: 2%</span>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <!-- VAROV츼N칈 -->
                    ${calculatePowerBalance() < 0 ? `
                        <div style="background: linear-gradient(90deg, #4a4a1a 0%, #2a2a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffd700;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <span style="font-size: 1.5rem;">丘</span>
                                <div style="flex: 1;">
                                    <strong style="color: #ffd700;">Nedostatek elekt콏iny!</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #888;">Chyb칤 ${Math.abs(calculatePowerBalance())} 丘. N캩kter칠 budovy nefunguj칤!</p>
                                </div>
                                <button onclick="showPowerModal()" style="padding: 0.4rem 0.8rem; background: #ff9800; border: none; color: #000; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold;">丘뙖잺 Spr치va</button>
                            </div>
                        </div>
                    ` : ''}
                    ${calculateSettlementBalance().food < 0 ? `
                        <div style="background: linear-gradient(90deg, #4a1a1a 0%, #2a0a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #c62828; display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 1.5rem;">丘멆잺</span>
                            <div>
                                <strong style="color: #ff6b6b;">${'Nedostatek j칤dla!'}</strong>
                                <p style="margin: 0; font-size: 0.85rem; color: #888;">Denn캩 ubyde ${Math.abs(calculateSettlementBalance().food)} j칤dla. Postav farmu nebo najmi farm치콏e!</p>
                            </div>
                        </div>
                    ` : ''}
                    ${calculateSettlementBalance().water < 0 ? `
                        <div style="background: linear-gradient(90deg, #1a2a4a 0%, #0a1525 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #2196f3; display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 1.5rem;">游눦</span>
                            <div>
                                <strong style="color: #64b5f6;">${'Nedostatek vody!'}</strong>
                                <p style="margin: 0; font-size: 0.85rem; color: #888;">Denn캩 ubyde ${Math.abs(calculateSettlementBalance().water)} vody. Postav studnu nebo sb캩ra캜!</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? `
                        <div style="background: linear-gradient(90deg, #3a3a1a 0%, #2a2a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--warning-yellow); display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <span style="font-size: 2rem;">游</span>
                                <div>
                                    <strong style="color: var(--warning-yellow);">${'Obchodn칤k na n치v코t캩v캩!'}</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #888;">${'Speci치ln칤 slevy. Zb칳v치:'} ${Math.ceil((state.settlement.visitingMerchant.until - Date.now()) / 60000)} min</p>
                                </div>
                            </div>
                            <button class="btn" onclick="openCaravanShop()" style="background: var(--warning-yellow); color: #000; padding: 0.5rem 1rem;">游낅 Obchod</button>
                        </div>
                    ` : ''}
                    
                    <!-- FINAN캛N칈 P콎EHLED OSADY -->
                    ${(() => {
                        const dailyMaintenance = calculateDailyMaintenance();
                        const dailyIncome = calculateDailyIncome();
                        const balance = dailyIncome - dailyMaintenance;
                        const playerMoney = state.money || 0;
                        // Pokud je balance z치porn치, spo캜칤tej kolik dn칤 vydr쮂 pen칤ze
                        const daysCanSurvive = balance < 0 ? Math.floor(playerMoney / Math.abs(balance)) : 999;
                        
                        return '<div onclick="showFinanceModal()" style="cursor: pointer; background: linear-gradient(90deg, #1a2a1a 0%, #0a1a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid ' + (balance >= 0 ? '#4a7c4a' : '#7c4a4a') + ';">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">' +
                                '<span style="font-size: 1rem; font-weight: bold; color: #ffd700;">游눯 ' + ('Finance osady') + ' <span style="font-size: 0.7rem; color: #888;">(klikni)</span></span>' +
                                '<span style="color: #ffd700; font-weight: bold;">' + playerMoney + ' 游눯</span>' +
                            '</div>' +
                            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">' +
                                '<div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px;">' +
                                    '<div style="font-size: 0.65rem; color: #888;">' + ('P콏칤jem/den') + '</div>' +
                                    '<div style="color: #8bc34a; font-weight: bold;">+' + dailyIncome + ' 游눯</div>' +
                                '</div>' +
                                '<div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px;">' +
                                    '<div style="font-size: 0.65rem; color: #888;">' + ('칔dr쬭a/den') + '</div>' +
                                    '<div style="color: #c62828; font-weight: bold;">-' + dailyMaintenance + ' 游눯</div>' +
                                '</div>' +
                                '<div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px;">' +
                                    '<div style="font-size: 0.65rem; color: #888;">' + ('Bilance') + '</div>' +
                                    '<div style="color: ' + (balance >= 0 ? '#8bc34a' : '#c62828') + '; font-weight: bold;">' + (balance >= 0 ? '+' : '') + balance + ' 游눯</div>' +
                                '</div>' +
                            '</div>' +
                            (balance < 0 ? '<div style="margin-top: 0.5rem; padding: 0.3rem; background: #2a0a0a; border-radius: 4px; text-align: center;">' +
                                '<span style="color: #ff6b6b; font-size: 0.75rem;">丘멆잺 ' + ('Dn칤 do bankrotu: ') + '<strong>' + daysCanSurvive + '</strong></span>' +
                            '</div>' : '') +
                        '</div>';
                    })()}
                    
                    <!-- HLAVN칈 AKCE - 8 TLA캛칈TEK -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.6rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="showSettlersModal()" style="background: linear-gradient(135deg, #2d4a2d 0%, #1a2e1a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #4a7c4a; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">游논</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Residents" : "Obyvatel칠"}</span>
                            <span style="font-size: 0.75rem; color: #8bc34a;">${state.settlement?.settlers?.length || 0} ${currentLang === "en" ? "people" : "osob"}</span>
                        </button>
                        
                        <button class="btn" onclick="showBuildingsModal()" style="background: linear-gradient(135deg, #4a3d2d 0%, #2e251a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #7c6a4a; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">游끵勇</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Buildings" : "Budovy"}</span>
                            <span style="font-size: 0.75rem; color: #ff9800;">${(state.base?.length || 0) + (state.settlement?.buildings?.length || 0)} ${currentLang === "en" ? "built" : "postaveno"}</span>
                        </button>
                        
                        <button class="btn" onclick="showDefenseModal()" style="background: linear-gradient(135deg, #4a2d2d 0%, #2e1a1a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #7c4a4a; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">游띠勇</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Defense" : "Obrana"}</span>
                            <span style="font-size: 0.75rem; color: ${calculateSettlementDefense() > 30 ? '#8bc34a' : '#c62828'};">${calculateSettlementDefense()} ${currentLang === "en" ? "points" : "bod콢"}</span>
                        </button>
                        
                        <button class="btn" onclick="showSpecializationModal()" style="background: linear-gradient(135deg, #3d2d4a 0%, #251a2e 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #6a4a7c; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">游끹勇</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Specialization" : "Specializace"}</span>
                            <span style="font-size: 0.75rem; color: #9c27b0;">${state.settlement.specialization ? '九' : ('콯치dn치')}</span>
                        </button>
                        
                        <button class="btn" onclick="showStorageModal()" style="background: linear-gradient(135deg, #2d3d4a 0%, #1a252e 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #4a6a7c; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">游닍</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Storage" : "Sklad"}</span>
                            <span style="font-size: 0.75rem; color: #2196f3;">${state.baseItems?.length || 0} ${currentLang === "en" ? "items" : "v캩c칤"}</span>
                        </button>
                        
                        <button class="btn" onclick="showPowerModal()" style="background: linear-gradient(135deg, #4a4a1a 0%, #2e2e0a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid ${calculatePowerBalance() >= 0 ? '#7c7c2a' : '#7c2a2a'}; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">丘</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Power" : "Elekt콏ina"}</span>
                            <span style="font-size: 0.75rem; color: ${calculatePowerBalance() >= 0 ? '#ffd700' : '#c62828'};">${calculatePowerProduction()}/${calculatePowerConsumption()}</span>
                        </button>
                        
                        <button class="btn" onclick="summonCaravan()" style="background: linear-gradient(135deg, #4a3d2d 0%, #2e251a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid ${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? '#8bc34a' : '#7c6a4a'}; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">游냙</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Caravan" : "Karavana"}</span>
                            <span style="font-size: 0.75rem; color: ${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? '#8bc34a' : '#ffa500'};">${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? ('九 Zde') : '100游눯'}</span>
                        </button>
                        
                        <button class="btn" onclick="showHireCompanionsModal()" style="background: linear-gradient(135deg, #2d4a3d 0%, #1a2e25 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid ${(state.companions?.length || 0) < getMaxCompanions() ? '#4a7c5a' : '#555'}; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">游냇</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Companions" : "Spole캜n칤ci"}</span>
                            <span style="font-size: 0.75rem; color: ${(state.companions?.length || 0) < getMaxCompanions() ? '#8bc34a' : '#888'};">${state.companions?.filter(c => !c.isDead).length || 0}/${getMaxCompanions()}</span>
                        </button>
                        
                        <button class="btn" onclick="showSettlementHelp()" style="background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); padding: 0.4rem 0.6rem; display: flex; align-items: center; justify-content: center; gap: 0.3rem; border: 1px solid #555; border-radius: 6px; font-size: 0.8rem;" title="${'N치pov캩da k osad캩'}">
                            仇 ${'Pomoc'}
                        </button>
                    </div>
                    
                    <!-- OBYVATEL칄 - 콯IV칗 P콎EHLED -->
                    ${(state.settlement?.settlers?.length || 0) > 0 ? `
                        <!-- Rychl칠 akce osady -->
                        ${(() => {
                            const hasBlacksmith = state.settlement.settlers.some(s => s.type === 'blacksmith');
                            const hasMedic = state.settlement.settlers.some(s => s.type === 'medic_s');
                            const hasTrader = state.settlement.settlers.some(s => s.type === 'trader_s');
                            
                            if (hasBlacksmith || hasMedic || hasTrader) {
                                return `
                                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.85rem;">丘 Slu쬭y osadn칤k콢</h4>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                            ${hasBlacksmith ? '<button class="btn" onclick="repairAtBlacksmith()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #5D4037;">丘뉦잺 Opravit vybaven칤</button>' : ''}
                                            ${hasMedic ? '<button class="btn" onclick="healAtMedic()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #c62828;">丘됊잺 L칠캜en칤</button>' : ''}
                                            ${hasTrader ? `<button class="btn" onclick="tradeAtSettlement()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: ${isShopOpen('settlement') ? '#ff9800' : '#555'};">${isShopOpen('settlement') ? '游눯' : '游깿'} Obchod${isShopOpen('settlement') ? '' : ' (zav콏eno)'}</button>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                        
                        <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 1rem; border-radius: 10px; border: 1px solid #333;">
                            <h4 style="margin: 0 0 0.8rem 0; color: var(--toxic-green); display: flex; align-items: center; gap: 0.5rem;">
                                <span>游논 ${'Tvoji lid칠'}</span>
                                <span style="font-size: 0.8rem; color: #666; font-weight: normal;">(${state.settlement?.settlers?.length || 0} ${'osob'})</span>
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                ${(state.settlement?.settlers || []).map((settler, idx) => {
                                    const type = SETTLER_TYPES.find(t => t.id === settler.type);
                                    const moods = ['游땕', '游뗵', '游땛', '游', '游땩'];
                                    const mood = moods[Math.floor(Math.random() * 3)]; // V캩t코inou happy
                                    // Podpora r콢zn칳ch variant ulo쬰n칤 levelu
                                    const skillLevel = settler.skillLevel || settler.level || 1;
                                    const skillData = SETTLER_SKILLS[type?.skill];
                                    const currentSkill = skillData?.levels[skillLevel - 1];
                                    return `
                                        <div onclick="showSettlerDetail(${idx})" style="background: #2a2a2a; padding: 0.6rem; border-radius: 8px; display: flex; align-items: center; gap: 0.6rem; border: 1px solid #3a3a3a; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#8bc34a'; this.style.background='#333'" onmouseout="this.style.borderColor='#3a3a3a'; this.style.background='#2a2a2a'">
                                            <div style="font-size: 1.8rem; position: relative;">
                                                ${type?.icon || '游녻'}
                                                <span style="position: absolute; bottom: -2px; right: -2px; font-size: 0.7rem;">${mood}</span>
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-weight: bold; font-size: 0.9rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${settler.name}</div>
                                                <div style="font-size: 0.75rem; color: #888;">${getSettlerName(type?.id)} <span style="color: #ffd700;">救${skillLevel}</span></div>
                                                <div style="font-size: 0.7rem; color: #8bc34a;">${currentSkill?.bonus || type?.desc || ''}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 2rem; border-radius: 10px; border: 2px dashed #333; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">游끸勇</div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #666;">Osada je pr치zdn치</h3>
                            <p style="color: #555; margin: 0 0 1rem 0;">Najmi prvn칤 obyvatele a za캜ni budovat komunitu!</p>
                            <button class="btn" onclick="showSettlersModal()" style="background: var(--toxic-dark);">游논 Najmi obyvatele</button>
                        </div>
                    `}
                </div>
                
                <!-- MULTIPLAYER TAB -->
                <div class="tab ${state.activeTab === 'multiplayer' ? 'active' : ''}" id="tabMultiplayer">
                    ${renderMultiplayerTab()}
                </div>
            `;
            
            if (state.activeTab === 'map' && document.getElementById('canvas')) initMap();
                console.log('游꿡 renderGame() completed');
            } catch (error) {
                console.error('仇 renderGame error:', error);
                document.getElementById('main').innerHTML = '<div style="padding: 2rem; color: #ff6b6b;"><h2>Chyba p콏i renderov치n칤</h2><pre>' + error.message + '</pre></div>';
            }
        }
        
        function saveDiary() {
            const notes = document.getElementById('diaryNotes');
            if (notes) {
                state.diary = notes.value;
                showModal('游 Ulo쬰no', 'Tvoje pozn치mky byly ulo쬰ny!');
            }
        }
        
        // === ACTIONS ===
        function showGenders() {
            const title = 'V칳b캩r Pohlav칤';
            const closeText = 'Zav콏칤t';
            const genders = getGenders();
            const attrs = getAttrs();
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${title}</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    ${Object.entries(genders).map(([id, gender]) => `
                        <div class="card ${state.char.gender === id ? 'selected' : ''}" onclick="selectGender('${id}')" style="cursor: pointer;">
                            <div style="font-size: 4rem; text-align: center;">${gender.icon}</div>
                            <h3 style="text-align: center; margin: 0.5rem 0;">${gender.name}</h3>
                            <p style="text-align: center; font-size: 0.85rem; color: #999; margin-bottom: 0.5rem;">${gender.desc}</p>
                            <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p style="text-align: center; color: #8bc34a; font-weight: 600; margin: 0; font-size: 0.9rem;">
                                    ${Object.entries(GENDERS[id].bonuses).map(([attr, bonus]) => 
                                        `+${bonus} ${attrs[attr].name}`
                                    ).join('<br>')}
                                </p>
                            </div>
                            <p style="text-align: center; color: #ff9800; font-size: 0.85rem; margin: 0;">${gender.special}</p>
                        </div>
                    `).join('')}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${closeText}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        function selectGender(id) {
            state.char.gender = id;
            closeModal();
            renderFull();
        }
        
        function showClasses() {
            // Lokalizace
            const texts = {
                title: 'V칳b캩r Povol치n칤',
                hint: 'Klikni na povol치n칤 pro v칤ce informac칤',
                close: 'Zav콏칤t',
                combat: '丘덢잺 Bojov칠',
                defense: '游띠勇 Obrann칠',
                scout: '游꿢 Skautsk칠',
                support: '丘됊잺 Podp콢rn칠',
                gather: '游댌 Sb캩ra캜sk칠',
                tech: '游댢 Technick칠',
                special: '九 Speci치ln칤'
            };
            
            // Seskup povol치n칤 do kategori칤
            // Mutant nen칤 ve v칳b캩ru - st치v치 se j칤m hr치캜 po 5 mutac칤ch
            const categories = {
                combat: { name: texts.combat, classes: ['raider', 'berserker'] },
                defense: { name: texts.defense, classes: ['survivor', 'tank'] },
                scout: { name: texts.scout, classes: ['stalker', 'assassin'] },
                support: { name: texts.support, classes: ['medic', 'alchemist'] },
                gather: { name: texts.gather, classes: ['scavenger', 'hunter'] },
                tech: { name: texts.tech, classes: ['engineer', 'demolitionist'] },
                special: { name: texts.special, classes: ['trader', 'nomad', 'psychic'] }
            };
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${texts.title}</h2>
                <p style="color: #999; margin-bottom: 1rem; text-align: center;">${texts.hint}</p>
                
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${Object.entries(categories).map(([catId, cat]) => `
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #d4722e; margin: 0 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.3rem;">${cat.name}</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.5rem;">
                                ${cat.classes.map(id => {
                                    const cls = CLASSES[id];
                                    if (!cls) return '';
                                    return `
                                        <div class="card ${state.char.classId === id ? 'selected' : ''}" 
                                            onclick="showClassDetail('${id}')"
                                            style="padding: 0.8rem; border-left: 4px solid ${cls.color || '#d4722e'}; cursor: pointer; ${state.char.classId === id ? 'background: #2a3a2a;' : ''}">
                                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                                <div style="font-size: 2.5rem;">${cls.icon}</div>
                                                <div style="flex: 1;">
                                                    <h3 style="margin: 0; font-size: 1rem;">${getClassName(id)} ${state.char.classId === id ? '九' : ''}</h3>
                                                    <p style="margin: 0.2rem 0 0 0; font-size: 0.75rem; color: #999;">${getClassDesc(id)}</p>
                                                </div>
                                                <div style="font-size: 1.2rem; color: #666;">좶잺</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${texts.close}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        // Detailn칤 info o povol치n칤
        function showClassDetail(id) {
            const cls = CLASSES[id];
            if (!cls) return;
            
            // Popis v칳hod pro ka쬯칠 povol치n칤 - generov치no z ability a passive
            const classGuides = {
                raider: {
                    playstyle: 'Agresivn칤 bojovn칤k',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['콯치dn칠 obrann칠 bonusy', 'N치ro캜n캩j코칤 na l칠캜iva'],
                    tips: 'Nechej si klesnout HP pod 30% pro RAGE bonus. Nos hodn캩 l칠캜iv.',
                    bestFor: 'Hr치캜e co r치di riskuj칤 a 칰to캜칤'
                },
                berserker: {
                    playstyle: 'Zb캩sil칳 v치le캜n칤k',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Sn칤쬰n치 obrana', 'Velmi k콏ehk칳'],
                    tips: 'Zab칤jej rychle, stackuj Frenzy. Vyu쬴j bonus za zabit칤.',
                    bestFor: 'Zku코en칠 hr치캜e co um칤 vyh칳bat se damage'
                },
                survivor: {
                    playstyle: 'Odoln칳 veter치n',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Ni쮄뫆 damage', 'Pomalej코칤 zab칤jen칤'],
                    tips: 'Last Stand t캩 zachr치n칤 v kritick칳ch situac칤ch. Ide치ln칤 pro za캜치te캜n칤ky.',
                    bestFor: 'Nov칠 hr치캜e a opatrn칳 hern칤 styl'
                },
                tank: {
                    playstyle: 'Nepr콢st콏eln치 ze캞',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Sn칤쬰n치 rychlost', 'Ni쮄뫆 damage'],
                    tips: 'Vyu쬴j svou odolnost k ochran캩 spole캜n칤k콢. Damage d캩lej zbran캩mi.',
                    bestFor: 'Tanky styl, dlouh칠 souboje'
                },
                stalker: {
                    playstyle: 'Tich칳 lovec',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Pr콢m캩rn칳 damage', '콯치dn칠 bojov칠 bonusy'],
                    tips: 'Vyh칳bej se zbyte캜n칳m boj콢m. 만t콏칤코 zdroje na del코칤 v칳pravy.',
                    bestFor: 'Pr콢zkum a survival gameplay'
                },
                assassin: {
                    playstyle: 'Smrt칤c칤 st칤n',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['N칤zk칠 HP', 'Spol칠h치 na kritick칠 z치sahy'],
                    tips: 'S dobr칳m vybaven칤m kritick칠 z치sahy drt칤. Kombinuj s crit zbran캩mi.',
                    bestFor: 'High-risk, high-reward styl'
                },
                medic: {
                    playstyle: 'Poln칤 chirurg',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Slab칳 damage', 'Pomal칠 zab칤jen칤'],
                    tips: 'Tv치 regenerace 코et콏칤 l칠캜iva. Nos minimum zdravotnick칠ho materi치lu.',
                    bestFor: 'Solo hr치캜e, dlouh칠 v칳pravy'
                },
                alchemist: {
                    playstyle: 'Mistr jed콢',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['N칤zk칳 p콏칤m칳 damage', 'DOT pot콏ebuje 캜as'],
                    tips: 'Otrav nep콏칤tele a p콏e쮂셨ej. DOT damage se s캜칤t치!',
                    bestFor: 'Taktick칳 boj, boss fight'
                },
                scavenger: {
                    playstyle: 'Hleda캜 poklad콢',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Slab칳 v boji', 'Z치vis칤 na RNG'],
                    tips: 'Prozkoum치vej v코echno! Dvojit칳 loot = rychl칠 zbohatnut칤.',
                    bestFor: 'Sb캩ra캜e a ekonomick칳 gameplay'
                },
                hunter: {
                    playstyle: 'Mistr lovu',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['M칠n캩 efektivn칤 ve m캩stech', 'Pr콢m캩rn칳 damage'],
                    tips: 'Lov je tv콢j hlavn칤 zdroj j칤dla a materi치l콢. Vyu쬴j mapu.',
                    bestFor: 'Survival a lov'
                },
                engineer: {
                    playstyle: 'Vyn치lezce',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Pr콢m캩rn칳 bojovn칤k', 'Pot콏ebuje materi치ly'],
                    tips: 'Tv칠 vybaven칤 vydr쮂 nav캩ky! Investuj do kvalitn칤ch zbran칤.',
                    bestFor: 'Crafting a base building'
                },
                demolitionist: {
                    playstyle: 'V칳bu코n칳 expert',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Nep콏edv칤dateln칳', 'AoE je n치hodn칠'],
                    tips: 'Nos gran치ty a v칳bu코niny! AoE decimuje skupiny nep콏치tel.',
                    bestFor: 'Boj proti skupin치m'
                },
                trader: {
                    playstyle: 'Ekonomick칳 magn치t',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Slab칳 bojovn칤k', 'Z치vis칤 na obchodov치n칤'],
                    tips: 'Kupuj levn캩, prod치vej draze. Pen칤ze 콏e코칤 v캩t코inu probl칠m콢.',
                    bestFor: 'Ekonomiku a obchodov치n칤'
                },
                nomad: {
                    playstyle: 'Pou코tn칤 tul치k',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Pr콢m캩rn칳 v boji', '콯치dn칠 bojov칠 bonusy'],
                    tips: 'Cestuje코 rychle a levn캩. Prozkoumej celou mapu!',
                    bestFor: 'Pr콢zkum a rychl칠 cestov치n칤'
                },
                mutant: {
                    playstyle: 'Zmutovan치 bestie',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Nem콢쬰 nosit zbroj ani helmu', 'Soci치ln칤 postihy'],
                    tips: 'Radiace t캩 l칠캜칤! Prozkoum치vej radioaktivn칤 z칩ny bez obav.',
                    bestFor: 'Pr콢zkum nebezpe캜n칳ch z칩n'
                },
                psychic: {
                    playstyle: 'Ment치ln칤 manipul치tor',
                    strengths: ['Vid칤코 skryt칠 lokace', '10% nep콏칤tel ute캜e', 'Pr콢zkum'],
                    weaknesses: ['Slab칳 v p콏칤m칠m boji', 'Pasivn칤 schopnosti'],
                    tips: 'Tv칠 ment치ln칤 schopnosti odhal칤 tajn칠 lokace na map캩.',
                    bestFor: 'Pr콢zkum a vyh칳b치n칤 se boji'
                }
            };
            
            const guide = classGuides[id] || {};
            
            document.getElementById('modalContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${cls.icon}</div>
                    <h2 style="margin: 0; color: ${cls.color || '#d4722e'};">${cls.name}</h2>
                    <p style="color: #999; margin: 0.3rem 0;">${cls.desc}</p>
                    <span style="background: ${cls.color || '#333'}; padding: 0.2rem 0.8rem; border-radius: 20px; font-size: 0.8rem;">
                        ${guide.playstyle || 'Univerz치ln칤'}
                    </span>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">九 Hlavn칤 schopnost</h4>
                    <p style="margin: 0; font-size: 0.95rem;">${cls.ability}</p>
                </div>
                
                <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">丘 Pasivn칤 schopnost</h4>
                    <p style="margin: 0; font-size: 0.95rem;">${cls.passive}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #4caf50; font-size: 0.9rem;">游눩 Siln칠 str치nky</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem;">
                            ${(guide.strengths || ['Univerz치ln칤']).map(s => `<li style="margin: 0.2rem 0;">${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #f44336; font-size: 0.9rem;">丘멆잺 Slab칠 str치nky</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem;">
                            ${(guide.weaknesses || ['콯치dn칠 speci치ln칤']).map(w => `<li style="margin: 0.2rem 0;">${w}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                ${guide.tips ? `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">游눠 Tip pro hran칤</h4>
                    <p style="margin: 0; font-size: 0.9rem;">${guide.tips}</p>
                </div>
                ` : ''}
                
                <div style="background: #222; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #c62828; font-size: 1.1rem;">${cls.weapon.icon}</span>
                            <span style="margin-left: 0.3rem;">${cls.weapon.name}</span>
                            <span style="color: #888;"> - ${cls.weapon.dmg} DMG</span>
                        </div>
                        <div style="color: #888; font-size: 0.85rem;">
                            ${cls.bonuses ? Object.entries(cls.bonuses).map(([attr, val]) => 
                                `<span style="color: #8bc34a;">+${val}</span> ${ATTRS[attr]?.icon || ''} ${ATTRS[attr]?.name || attr}`
                            ).join(' &nbsp;|&nbsp; ') : ''}
                        </div>
                    </div>
                </div>
                
                ${guide.bestFor ? `
                <div style="text-align: center; margin-bottom: 1rem; color: #888; font-size: 0.85rem;">
                    游꿢 <strong>Ide치ln칤 pro:</strong> ${guide.bestFor}
                </div>
                ` : ''}
                
                ${cls.restrictions ? `
                <div style="background: #3a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <span style="color: #f44336;">久 ${cls.restrictions}</span>
                </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="showClasses()" style="background: #555;">
                         Zp캩t na v칳b캩r
                    </button>
                    <button class="btn" onclick="selectClass('${id}')" style="background: ${state.char.classId === id ? '#555' : '#4caf50'};">
                        ${state.char.classId === id ? '九 Vybr치no' : '九 Vybrat toto povol치n칤'}
                    </button>
                </div>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        function selectClass(id) {
            state.char.classId = id;
            closeModal();
            renderFull();
        }
        
        function showModal(title, message, persistent = false) {
            // Pokud je aktivn칤 PvP v칳zva, nepovolit jin칠 modaly (krom캩 PvP souvisej칤c칤ch)
            if (typeof pvpChallengeOverlayActive !== 'undefined' && pvpChallengeOverlayActive) {
                if (!title.includes('PvP') && !title.includes('丘덢잺') && !title.includes('Souboj')) {
                    console.log('丘멆잺 showModal blocked - PvP challenge overlay active');
                    return;
                }
            }
            
            // Pokud 캜ek치me na heslo pro chr치n캩n칳 칰캜et, ten m치 p콏ednost
            if (window._pendingPasswordPrompt && !title.includes('Chr치n캩n칳 칰캜et')) {
                console.log('丘멆잺 showModal blocked - waiting for password prompt');
                // Znovu zobraz password prompt
                setTimeout(() => renderProtectedNicknameModal(), 100);
                return;
            }
            
            // Pokud message obsahuje tla캜칤tko, nep콏id치vej OK
            const hasButton = message.includes('<button') || message.includes('onclick=');
            
            // Ulo modal do state pro perzistenci (pokud je persistent nebo obsahuje d콢le쬴t칠 info)
            const isImportant = title.includes('丘덢잺') || title.includes('游') || title.includes('游꿀') || 
                               title.includes('Boj') || title.includes('Nep콏칤tel') || title.includes('칔tok') ||
                               message.includes('startCombat') || message.includes('Bojovat');
            
            if (persistent || isImportant) {
                state.pendingModal = { title, message, timestamp: Date.now() };
            }
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${title}</h2>
                <div style="margin: 1rem 0;">${message}</div>
                ${hasButton ? '' : '<button class="btn" onclick="closeModal()" style="width: 100%;">OK</button>'}
            `;
            document.getElementById('modal').classList.add('show');
            document.body.classList.add('modal-open'); // Zabra켿 pull-to-refresh
            
            // Modal scan efekt
            if (typeof addModalScanEffect === 'function') {
                setTimeout(() => addModalScanEffect(document.getElementById('modalContent')), 50);
            }
        }
        
        // Kontrola a zobrazen칤 pending modalu po na캜ten칤
        function checkPendingModal() {
            if (state.pendingModal) {
                const modal = state.pendingModal;
                // Zobraz ulo쬰n칳 modal (max 5 minut star칳)
                if (Date.now() - modal.timestamp < 5 * 60 * 1000) {
                    setTimeout(() => {
                        document.getElementById('modalContent').innerHTML = `
                            <h2>${modal.title}</h2>
                            <div style="margin: 1rem 0;">${modal.message}</div>
                        `;
                        document.getElementById('modal').classList.add('show');
                    }, 500);
                } else {
                    // Star칳 modal - sma
                    delete state.pendingModal;
                }
            }
        }
        
        function closeModal() {
            // Blokuj zav콏en칤 modalu b캩hem sp치nku
            if (state.isSleeping && state.sleepEndTime && Date.now() < state.sleepEndTime) {
                return; // Nelze zav콏칤t b캩hem sp치nku
            }
            
            document.getElementById('modal').classList.remove('show');
            document.body.classList.remove('modal-open'); // Povol pull-to-refresh zp캩t
            // Vyma pending modal p콏i zav콏en칤
            if (state.pendingModal) {
                delete state.pendingModal;
            }
        }
        
        function editName() {
            const currentName = state.char.name;
            
            document.getElementById('modalContent').innerHTML = `
                <h2>九勇 Zm캩nit jm칠no</h2>
                <label style="display: block; margin-bottom: 0.5rem;">${'Zadej nov칠 jm칠no:'}</label>
                <input type="text" id="nameEditInput" value="${currentName}" placeholder="Tv콢j jedine캜n칳 nick..." maxlength="20" style="width: 100%; padding: 0.8rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; color: #e0e0e0; font-size: 1rem; margin-bottom: 0.5rem;">
                <p style="color: #888; font-size: 0.75rem; margin-bottom: 1rem;">丘멆잺 Jm칠na jako "Zaoo", "Admin" atd. jsou chr치n캩n치</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="saveName()">九 Ulo쬴t</button>
                </div>
            `;
            document.getElementById('modal').classList.add('show');
            
            // Focus input after modal opens
            setTimeout(() => {
                const input = document.getElementById('nameEditInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }
        
        function saveName() {
            const input = document.getElementById('nameEditInput');
            if (input && input.value.trim()) {
                const newName = input.value.trim();
                
                // Kontrola chr치n캩n칳ch jmen
                const protectedNames = ['zaoo', 'admin', 'administrator', 'moderator', 'mod', 'gm', 'gamemaster', 'developer', 'dev', 'system'];
                const nameLower = newName.toLowerCase();
                
                if (protectedNames.includes(nameLower) || nameLower.includes('zaoo') || nameLower.includes('admin')) {
                    notifyWarning('丘멆잺 Chr치n캩n칠 jm칠no!', 'Toto jm칠no nelze pou쮂셦.');
                    return;
                }
                
                state.char.name = newName;
                const display = document.getElementById('nameDisplay');
                if (display) {
                    display.textContent = state.char.name;
                }
            }
            closeModal();
        }
        
        function changeAttr(key, delta) {
            if (delta > 0 && state.char.points <= 0) return;
            if (delta < 0 && state.char.attrs[key] <= 5) return;
            
            state.char.attrs[key] += delta;
            state.char.points -= delta;
            renderFull();
        }
        
        function confirmCharacter() {
            if (!state.char.name || state.char.name.trim() === '') {
                alert('Zadej jm칠no postavy!');
                return;
            }
            if (!state.char.gender) return alert('Vyber pohlav칤!');
            if (!state.char.classId) return alert('Vyber povol치n칤!');
            if (state.char.points > 0) return alert('Rozd캩l v코echny body!');
            
            // Name is already in state.char.name (updated via editName modal)
            if (!state.char.name || state.char.name.trim() === '') {
                state.char.name = 'P콏e쬴v코칤_' + Math.floor(Math.random() * 9000 + 1000);
            }
            
            // === KONTROLA CHR츼N캨N칗CH JMEN ===
            const protectedNames = ['zaoo', 'admin', 'administrator', 'moderator', 'mod', 'gm', 'gamemaster', 'developer', 'dev', 'system'];
            const nameLower = state.char.name.trim().toLowerCase();
            
            // Kontrola p콏esn칠 shody nebo podobnosti
            if (protectedNames.includes(nameLower) || nameLower.includes('zaoo') || nameLower.includes('admin')) {
                alert('丘멆잺 Toto jm칠no je chr치n캩n칠 a nelze ho pou쮂셦! Zvol si jin칠 jm칠no.');
                return;
            }
            
            const cls = CLASSES[state.char.classId];
            
            // Apply gender bonuses to attributes
            const gender = GENDERS[state.char.gender];
            if (gender && gender.bonuses) {
                Object.entries(gender.bonuses).forEach(([attr, bonus]) => {
                    state.char.attrs[attr] += bonus;
                });
            }
            
            // Apply class bonuses to attributes
            if (cls.bonuses) {
                Object.entries(cls.bonuses).forEach(([attr, bonus]) => {
                    state.char.attrs[attr] += bonus;
                });
            }
            
            // Calculate max HP
            state.char.maxHp = 100 + (state.char.attrs.end - 5) * 10;
            
            // Class HP bonuses
            if (state.char.classId === 'survivor') state.char.maxHp += 50;
            if (state.char.classId === 'tank') state.char.maxHp += 100;
            
            // Apply gender HP bonus (male gets +5% max HP)
            if (state.char.gender === 'male') {
                state.char.maxHp = Math.floor(state.char.maxHp * 1.05);
            }
            
            state.char.hp = state.char.maxHp;
            
            // Add starting weapon
            state.inv.push({ 
                id: cls.weapon.name.toLowerCase().replace(/\s+/g, '_'),
                name: cls.weapon.name, 
                icon: cls.weapon.icon, 
                type: 'weapon', 
                damage: cls.weapon.dmg,
                weight: 1
            });
            
            // Add starting armor
            state.inv.push({ 
                id: 'worn_jacket',
                name: 'Opot콏ebovan치 bunda', 
                icon: '游빈', 
                type: 'armor', 
                defense: 6,
                weight: 2,
                durability: 30,
                maxDurability: 50
            });
            
            // Add starting items (medkit + 3x water + 3x food + 2x energy + sleeping bag + 100 money)
            state.inv.push({ id: 'medkit', name: 'L칠k치rni캜ka', icon: '丘됊잺', type: 'consumable', effect: 'health', value: 40, count: 1, weight: 1 });
            state.inv.push({ id: 'water', name: 'L치hev vody', icon: '游눦', type: 'consumable', effect: 'thirst', value: 40, count: 3, weight: 1 });
            state.inv.push({ id: 'food', name: 'Konzervovan칠 j칤dlo', icon: '游볾', type: 'consumable', effect: 'hunger', value: 35, count: 3, weight: 1 });
            state.inv.push({ id: 'energy', name: 'Energetick칳 n치poj', icon: '游댊', type: 'consumable', effect: 'energy', value: 50, count: 2, weight: 0.5 });
            state.inv.push({ id: 'sleeping_bag', name: 'Spac치k', icon: '游띒勇', type: 'tool', effect: 'sleep', value: 1, weight: 2, stackable: false });
            addMoney(100);
            
            // Flag pro prvn칤 cestu - setk치n칤 se psem
            state.firstJourneyDogEvent = true;
            
            // Po캜치te캜n칤 vybaven칤 - 1x RadAway
            const radaway = ITEMS.find(i => i.id === 'radx');
            if (radaway) {
                state.inv.push({...radaway, count: 2});
                addLog('Dostal jsi 2x RadAway na za캜치tek!', '驕뮖잺');
            }
            
            // Po캜치te캜n칤 vybaven칤 - sand치ly
            const sandals = ITEMS.find(i => i.id === 'sandals');
            if (sandals) {
                state.inv.push({...sandals});
                addLog('Dostal jsi sand치ly na za캜치tek!', '游뽒');
            }
            
            // 먞셣y pro t콏칤dy s lukem (hunter, stalker)
            if (state.char.classId === 'hunter' || state.char.classId === 'stalker') {
                const arrows = ITEMS.find(i => i.id === 'arrow' || i.ammoType === 'arrow');
                if (arrows) {
                    state.inv.push({...arrows, count: 20});
                    addLog('Dostal jsi 20 코칤p콢 k luku!', '游낓');
                } else {
                    // Fallback - vytvo콏 코칤py ru캜n캩
                    state.inv.push({
                        id: 'arrow',
                        name: '먞셣y',
                        icon: '俱',
                        type: 'ammo',
                        ammoType: 'arrow',
                        weight: 0.05,
                        count: 20
                    });
                    addLog('Dostal jsi 20 코칤p콢 k luku!', '游낓');
                }
            }
            
            // Initial log
            addLog(`Dobrodru쬽tv칤 za캜칤n치! Stal ses: ${cls.name}`, '游꿡');
            
            state.confirmed = true;
            state.firstTravelDone = false; // Reset pro prvn칤 cestu s psem
            console.log('九 Postava potvrzena - ukl치d치m hru...');
            
            // Generate initial daily quests
            generateDailyQuests();
            
            // Initialize main quest
            state.mainQuest = {
                currentQuest: 'intro',
                completedQuests: [],
                questProgress: {},
                npcMet: [],
                storyComplete: false,
                chapter: 0
            };
            
            // Zobraz 칰vodn칤 quest
            setTimeout(() => {
                const introQuest = MAIN_QUESTS.find(q => q.id === 'intro');
                showModal('游닆 P콏칤b캩h za캜칤n치...', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游깬</div>
                        <p style="font-style: italic; color: #999; margin-bottom: 1rem;">"${introQuest.dialog.start}"</p>
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px;">
                            <h3 style="color: #d4722e; margin: 0 0 0.5rem 0;">${introQuest.title}</h3>
                            <p style="margin: 0;">${introQuest.description}</p>
                        </div>
                        <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #3a3a5a;">
                            <p style="margin: 0; color: #9c7cff; font-size: 0.9rem;">游늿 V 칰krytu jsi na코el star칳 den칤k...</p>
                            <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.8rem;">Pod칤vej se do invent치콏e!</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal(); offerTutorial();" style="width: 100%; margin-top: 1rem;">Za캜칤t dobrodru쬽tv칤</button>
                `);
            }, 500);
            
            // CRITICAL: Save game immediately after confirming character
            saveGame(true);
            console.log('九 Hra ulo쬰na s confirmed=true');
            
            renderFull();
        }
        
        // Nab칤dka tutori치lu pro nov칠 hr치캜e
        function offerTutorial() {
            showModal('游꿉 Tutori치l', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">游닄</div>
                    <h3 style="color: #8bc34a;">Jsi tu nov칳?</h3>
                    <p style="color: #888; margin: 1rem 0;">Chce코 proj칤t kr치tk칳m tutori치lem? Nau캜칤코 se z치klady p콏e쬴t칤 v pustin캩.</p>
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left; font-size: 0.85rem;">
                        <div style="color: #4CAF50;">九 Jak funguj칤 statistiky</div>
                        <div style="color: #4CAF50;">九 Jak pou쮂셨at invent치콏</div>
                        <div style="color: #4CAF50;">九 Jak cestovat po map캩</div>
                        <div style="color: #4CAF50;">九 Jak funguje boj</div>
                        <div style="color: #4CAF50;">九 Jak z칤skat spole캜n칤ky</div>
                        <div style="color: #4CAF50;">九 Jak budovat osadu</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #333;">P콏esko캜it</button>
                    <button class="btn" onclick="closeModal(); showTutorial(0);" style="background: #4CAF50;">Spustit tutori치l</button>
                </div>
            `);
        }
        
        function switchTab(tabName) {
            state.activeTab = tabName;
            
            // P콏epni obsah bez efektu
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active');
            
            const tabId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            const tab = document.getElementById(tabId);
            if (tab) tab.classList.add('active');
            
            if (tabName === 'map') setTimeout(initMap, 50);
            
            // Prvn칤 n치v코t캩va v칳bavy - v칳b캩r po캜치te캜n칤ho n치stroje
            if (tabName === 'inv' && !state.starterToolChosen) {
                setTimeout(() => showStarterToolModal(), 100);
            }
                
            // Prvn칤 n치v코t캩va osady - v칳b캩r prvn칤ho osadn칤ka
            if (tabName === 'base' && state.settlement.firstVisit && state.settlement.settlers.length === 0) {
                setTimeout(() => showFirstSettlerModal(), 100);
            }
        }
        
        function showStarterToolModal() {
            showModal('游꾸 Vyber si po캜치te캜n칤 n치stroj', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #aaa;">Jako p콏e쬴v코칤 za캜칤n치코 s jedn칤m n치strojem. Vyber moud콏e!</p>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    <!-- Luk -->
                    <div onclick="chooseStarterTool('bow')" style="cursor: pointer; background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 8px; border: 2px solid #2E7D32; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">游낓</div>
                            <div style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; color: #8bc34a;">D콏ev캩n칳 luk</h3>
                                <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                                    Umo쮄갓je <strong style="color: #8bc34a;">lovit zv캩콏</strong> v les칤ch a pl치n칤ch.<br>
                                    Z칤sk치코 游볼 maso a 游빗 l치tku z uloven칳ch zv칤콏at.
                                </p>
                                <p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.75rem;">丘덢잺 +6 damage | Lokace: Les, Pl치n캩</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Krump치캜 -->
                    <div onclick="chooseStarterTool('pickaxe')" style="cursor: pointer; background: linear-gradient(135deg, #1a1a1a, #0a0a0a); padding: 1rem; border-radius: 8px; border: 2px solid #5D4037; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">久勇</div>
                            <div style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; color: #8D6E63;">Krump치캜</h3>
                                <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                                    Umo쮄갓je <strong style="color: #8D6E63;">t캩쬴t suroviny</strong> v hor치ch.<br>
                                    Z칤sk치코 游 k치men, 丘뙖잺 kov a vz치cn칠 rudy.
                                </p>
                                <p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.75rem;">游댢 N치stroj | Lokace: Hory, Doly</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prut -->
                    <div onclick="chooseStarterTool('fishing_rod')" style="cursor: pointer; background: linear-gradient(135deg, #0a1a2a, #0a0a1a); padding: 1rem; border-radius: 8px; border: 2px solid #1565C0; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">游꿖</div>
                            <div style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; color: #64B5F6;">Ryb치콏sk칳 prut</h3>
                                <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                                    Umo쮄갓je <strong style="color: #64B5F6;">chytat ryby</strong> u vody.<br>
                                    Z칤sk치코 游 ryby a ob캜as vz치cn칠 칰lovky.
                                </p>
                                <p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.75rem;">游댢 N치stroj | Lokace: Jezero, 콎eka, Pob콏e쮂</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 1rem;">
                    游눠 Ostatn칤 n치stroje m콢쬰코 vyrobit v d칤ln캩 nebo naj칤t ve sv캩t캩.
                </p>
            `);
        }
        
        function chooseStarterTool(toolType) {
            state.starterToolChosen = true;
            closeModal();
            
            if (toolType === 'bow') {
                state.inv.push({ 
                    id: 'wooden_bow', name: 'D콏ev캩n칳 luk', icon: '游낓', type: 'weapon', 
                    damage: 6, weight: 1, price: 40, rarity: 'common', ammoType: 'arrow',
                    durability: 100, maxDurability: 100 
                });
                // Startovn칤 코칤py
                addAmmo('arrow', 20);
                notifySuccess('Z칤skal jsi D콏ev캩n칳 luk!', ('M콢쬰코 lovit zv캩콏 游낓 (+20 코칤p콢)'));
                addLog('Vybral sis d콏ev캩n칳 luk jako po캜치te캜n칤 n치stroj (+20 코칤p콢)', '游낓');
            } else if (toolType === 'pickaxe') {
                state.inv.push({ 
                    id: 'pickaxe', name: 'Krump치캜', icon: '久勇', type: 'tool', 
                    bonus: 'mining', weight: 3, price: 100, rarity: 'uncommon', 
                    durability: 100, maxDurability: 100 
                });
                notifySuccess('Z칤skal jsi Krump치캜!', ('M콢쬰코 t캩쬴t suroviny 久勇'));
                addLog('Vybral sis krump치캜 jako po캜치te캜n칤 n치stroj', '久勇');
            } else if (toolType === 'fishing_rod') {
                state.inv.push({ 
                    id: 'fishing_rod', name: 'Ryb치콏sk칳 prut', icon: '游꿖', type: 'tool', 
                    bonus: 'fishing', bonusValue: 1, weight: 1, price: 50, rarity: 'common', 
                    durability: 100, maxDurability: 100 
                });
                notifySuccess('Z칤skal jsi Ryb치콏sk칳 prut!', ('M콢쬰코 chytat ryby 游꿖'));
                addLog('Vybral sis ryb치콏sk칳 prut jako po캜치te캜n칤 n치stroj', '游꿖');
            }
            
            renderFull();
        }
        
        // Modal pro v칳b캩r prvn칤ho osadn칤ka
        function showFirstSettlerModal() {
            let html = '<div style="text-align: center; margin-bottom: 1.5rem;">';
            html += '<div style="font-size: 4rem; margin-bottom: 0.5rem;">游끶勇</div>';
            html += '<h3 style="margin: 0; color: var(--toxic-green);">V칤tej ve sv칠 osad캩!</h3>';
            html += '<p style="color: #aaa; margin: 0.5rem 0;">Tvoje z치kladna u m치 postavenou <strong style="color: #8bc34a;">游 Zahradu</strong> a <strong style="color: #2196f3;">游눦 Sb캩ra캜 de코콘ov칠 vody</strong>.</p>';
            html += '<p style="color: #ffd700;">Vyber si jednoho obyvatele, kter칳 se k tob캩 p콏id치 zdarma!</p>';
            html += '</div>';
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.8rem; max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0.5rem;">';
            
            SETTLER_TYPES.forEach(type => {
                html += '<div onclick="selectFirstSettler(\'' + type.id + '\')" style="background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer; border: 2px solid #333; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--toxic-green)\'; this.style.transform=\'scale(1.02)\'" onmouseout="this.style.borderColor=\'#333\'; this.style.transform=\'scale(1)\'">';
                html += '<div style="font-size: 2.5rem;">' + type.icon + '</div>';
                html += '<div style="font-weight: bold; margin: 0.3rem 0; color: #fff;">' + type.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: #8bc34a; margin-bottom: 0.3rem;">' + type.desc + '</div>';
                html += '<div style="font-size: 0.7rem; color: #ff9800;">Spot콏eba: -' + type.consumption.food + '游꼤 -' + type.consumption.water + '游눦/den</div>';
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 1rem;">' + ('M콢쬰코 zav콏칤t a vybrat pozd캩ji - nab칤dka z콢stane!') + '</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">' + ('낒勇 Vybrat pozd캩ji') + '</button>';
            
            showModal('游꾸 Vyber sv칠ho prvn칤ho osadn칤ka', html);
        }
        
        function selectFirstSettler(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            if (!type) return;
            
            // Generuj jm칠no
            const names = ['Jan', 'Petr', 'Karel', 'Martin', 'Tom치코', 'Pavel', 'Jakub', 'Ond콏ej', 'Marie', 'Eva', 'Anna', 'Lucie', 'Petra', 'Jana', 'Tereza', 'Kate콏ina', 'Hana', 'Zuzana'];
            const name = names[Math.floor(Math.random() * names.length)];
            
            const settler = {
                id: 'settler_' + Date.now(),
                type: typeId,
                name: name,
                hp: 100,
                maxHp: 100,
                morale: 70, // Za캜칤n치 s dobrou mor치lkou
                skillLevel: 1,
                xp: 0,
                assignedTo: null
            };
            
            state.settlement.settlers.push(settler);
            state.settlement.firstVisit = false; // Te캞 u vybral - u nenab칤zet zdarma
            closeModal();
            
            addLog('游논 ' + name + ' (' + type.name + ') se p콏idal/a k tv칠 osad캩!', '游끶勇');
            
            showModal('游꿀 Nov칳 osadn칤k!', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: 1rem;">${type.icon}</div>
                    <h2 style="margin: 0; color: var(--toxic-green);">${name}</h2>
                    <p style="color: #888; margin: 0.5rem 0;">${type.name}</p>
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                        <p style="margin: 0.3rem 0;"><strong>Schopnost:</strong> <span style="color: #8bc34a;">${type.desc}</span></p>
                        <p style="margin: 0.3rem 0;"><strong>Spot콏eba:</strong> <span style="color: #ff9800;">-${type.consumption.food}游꼤 -${type.consumption.water}游눦 denn캩</span></p>
                    </div>
                    <p style="color: #aaa; font-size: 0.9rem;">Tvoje osada te캞 produkuje zdroje a je p콏ipravena r콢st!</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">九 V칳born캩!</button>
                </div>
            `);
            
            saveGame(true);
            renderFull();
        }
        
        // === NOV칗 MAP SYST칄M ===
        
        // Hlavn칤 renderov치n칤 mapy
        function renderWorldMap() {
            // Zajisti 쬰 currentLocation existuje
            if (!state.world.currentLocation) {
                state.world.currentLocation = 'shelter';
            }
            
            // === NA캛TI FRAK캛N칈 TERITORIA DO CACHE ===
            // Na캜teme teritoria pro zobrazen칤 barev na map캩 (refresh ka쬯칳ch 10s nebo p콏i prvn칤m na캜ten칤)
            const shouldRefreshCache = !window.territoryCache || 
                                       !window.territoryCacheTime || 
                                       (Date.now() - window.territoryCacheTime > 10000);
            
            if (multiplayerEnabled && firebaseDB && shouldRefreshCache) {
                window.territoryCacheTime = Date.now();
                firebaseDB.ref('territories').once('value').then(snapshot => {
                    window.territoryCache = snapshot.val() || {};
                    const ownedCount = Object.values(window.territoryCache).filter(t => t && t.owner).length;
                    console.log('游딬勇 Territory cache loaded:', Object.keys(window.territoryCache).length, 'territories,', ownedCount, 'owned');
                    // Debug: zobraz prvn칤ch p치r 칰zem칤 s vlastn칤kem
                    Object.entries(window.territoryCache).slice(0, 5).forEach(([id, t]) => {
                        if (t && t.owner) console.log('  游낎', id, '-> owner:', t.owner);
                    });
                    // V콯DY p콏ekresli mapu po na캜ten칤 cache
                    if (state.activeTab === 'map') {
                        setTimeout(() => renderFull(), 50);
                    }
                }).catch(e => console.log('Territory cache error:', e));
                
                // === NA캛TI V츼LE캛NOU Z칍NU ===
                firebaseDB.ref('warZone').once('value').then(async snapshot => {
                    const warZone = snapshot.val();
                    if (warZone && warZone.endTime > Date.now()) {
                        window.activeWarZone = warZone;
                        console.log('丘덢잺 War zone active:', warZone.locationId);
                    } else if (warZone && warZone.endTime <= Date.now()) {
                        // War zone expirovala - automaticky vyhodno콘
                        console.log('丘덢잺 War zone expired, auto-evaluating...');
                        window.activeWarZone = null;
                        await autoEvaluateExpiredWarZone(warZone);
                    } else {
                        window.activeWarZone = null;
                    }
                }).catch(e => console.log('War zone cache error:', e));
                
                // === NA캛TI ZTRACEN칗 POKLAD ===
                firebaseDB.ref('treasure').once('value').then(snapshot => {
                    const treasure = snapshot.val();
                    if (treasure && treasure.endTime > Date.now()) {
                        window.activeTreasure = treasure;
                        console.log('游눑 Treasure active:', treasure.locationId);
                    } else {
                        window.activeTreasure = null;
                    }
                }).catch(e => console.log('Treasure cache error:', e));
            }
            
            // === KONTROLA VECH QUEST PROGRESS P콎I ZOBRAZEN칈 MAPY ===
            // Toto zajist칤 쬰 questy se aktualizuj칤 i kdy hr치캜 u je v c칤lov칠 lokaci
            const currentLocationId = state.world.currentLocation;
            
            // 1. Main quest - p콏칤b캩hov칠 questy
            if (state.mainQuest?.currentQuest) {
                updateQuestProgress('location', currentLocationId);
            }
            
            // 2. Timed questy - 캜asov캩 omezen칠
            if (state.timedQuests?.length > 0) {
                checkTimedQuestObjectives('location', currentLocationId);
            }
            
            // 3. Companion questy
            if (state.companions?.length > 0) {
                checkCompanionQuestObjectives('location', currentLocationId);
            }
            
            // Toggle quest tracker sbalen칤/rozbalen칤
            function toggleQuestTracker() {
                state.questTrackerCollapsed = !state.questTrackerCollapsed;
                renderFull();
            }
            window.toggleQuestTracker = toggleQuestTracker;
            
            // === QUEST TRACKER WIDGET ===
            function renderQuestTracker() {
                const activeQuests = [];
                
                // 0. 캛asov캩 limitovan칠 questy - NEJVY먠먞 PRIORITA
                if (state.timedQuests) {
                    const activeTimed = state.timedQuests.filter(q => !q.completed && !q.failed);
                    activeTimed.forEach(tq => {
                        const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                        if (quest) {
                            const remaining = Math.max(0, tq.endTime - Date.now());
                            const minutes = Math.floor(remaining / 60000);
                            activeQuests.push({
                                type: 'timed',
                                icon: '낋',
                                name: quest.name,
                                location: quest.location || null,
                                color: remaining < 5 * 60000 ? '#f44336' : '#ff9800',
                                timer: `${minutes}m`,
                                urgent: remaining < 5 * 60000
                            });
                        }
                    });
                }
                
                // 0b. Detektivn칤 questy
                if (state.detectiveQuests) {
                    Object.entries(state.detectiveQuests).forEach(([questId, dq]) => {
                        if (!dq.solved) {
                            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
                            if (quest) {
                                activeQuests.push({
                                    type: 'detective',
                                    icon: '游댌',
                                    name: quest.name,
                                    location: null,
                                    color: '#9c27b0',
                                    extra: `Stopy: ${dq.cluesFound.length}/${quest.requiredClues}`,
                                    questId: questId
                                });
                            }
                        }
                    });
                }
                
                // 0c. Companion questy
                if (state.companions) {
                    state.companions.forEach(comp => {
                        if (comp.activeQuest) {
                            const questData = COMPANION_QUESTS[comp.id];
                            const chapter = questData?.chapters.find(c => c.id === comp.activeQuest.id);
                            if (chapter) {
                                // Najdi prvn칤 nespln캩n칳 c칤l typu location
                                let targetLocation = null;
                                if (chapter.objectives) {
                                    const incompleteObj = chapter.objectives.find((obj, i) => 
                                        !comp.activeQuest.objectives?.[i]?.completed && 
                                        (obj.type === 'location' || obj.type === 'explore')
                                    );
                                    if (incompleteObj) {
                                        targetLocation = incompleteObj.target;
                                    }
                                }
                                
                                activeQuests.push({
                                    type: 'companion',
                                    icon: comp.icon,
                                    name: chapter.title,
                                    location: targetLocation || chapter.trigger?.location || null,
                                    color: '#e91e63',
                                    extra: comp.name
                                });
                            }
                        }
                    });
                }
                
                // 1. Hlavn칤 p콏칤b캩hov칳 quest
                if (state.mainQuest?.currentQuest && !state.mainQuest.storyComplete) {
                    const quest = MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
                    if (quest) {
                        // Hledej lokaci v objectives - m콢쬰 b칳t jako 'location' nebo 'target'
                        let questLocation = null;
                        if (quest.objectives && quest.objectives.length > 0) {
                            const obj = quest.objectives[0];
                            questLocation = obj.location || obj.target || null;
                        }
                        
                        activeQuests.push({
                            type: 'story',
                            icon: '游닀',
                            name: getMainQuestTitle(quest.id),
                            location: questLocation,
                            color: '#ffd700'
                        });
                    }
                }
                
                // 2. NPC questy
                if (state.npcQuests) {
                    Object.entries(state.npcQuests).forEach(([npcId, questData]) => {
                        if (questData?.id) {
                            const quest = NPC_QUESTS[questData.id];
                            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                            if (quest && npc) {
                                // Zkontroluj jestli je quest spln캩n칳
                                const isComplete = typeof checkNPCQuestProgress === 'function' ? 
                                    checkNPCQuestProgress(questData, quest) : false;
                                
                                activeQuests.push({
                                    type: 'npc',
                                    icon: npc.icon,
                                    name: quest.name,
                                    npcName: npc.name,
                                    location: npc.location,
                                    color: isComplete ? '#4caf50' : '#ff9800',
                                    isQuestComplete: isComplete
                                });
                            }
                        }
                    });
                }
                
                // 3. Denn칤 questy
                if (state.dailyQuests?.quests) {
                    const incomplete = state.dailyQuests.quests.filter(q => 
                        !state.dailyQuests.completed?.includes(q.id)
                    );
                    if (incomplete.length > 0) {
                        activeQuests.push({
                            type: 'daily',
                            icon: '游늰',
                            name: `Denn칤 칰koly (${incomplete.length})`,
                            location: null,
                            color: '#2196f3'
                        });
                    }
                }
                
                // 4. Osadnick칠 questy
                if (state.settlement?.activeQuests?.length > 0) {
                    activeQuests.push({
                        type: 'settler',
                        icon: '游끶勇',
                        name: `칔koly osadn칤k콢 (${state.settlement.activeQuests.length})`,
                        location: 'shelter',
                        color: '#8bc34a'
                    });
                }
                
                if (activeQuests.length === 0) return '';
                
                // Kontrola jestli je quest tracker sbalen칳
                const isCollapsed = state.questTrackerCollapsed || false;
                
                let html = '<div style="background: linear-gradient(135deg, #1a1a2a 0%, #0d0d1a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #3949AB; margin-bottom: 1rem; pointer-events: auto; position: relative; z-index: 100;">';
                html += '<div onclick="toggleQuestTracker()" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ' + (isCollapsed ? '0' : '0.5rem') + '; cursor: pointer; user-select: none;">';
                html += '<span style="color: #7986CB; font-weight: bold; font-size: 0.9rem;">游늷 ' + ('AKTIVN칈 QUESTY') + '</span>';
                html += '<span style="color: #555; font-size: 0.75rem;">' + activeQuests.length + ' ' + ('aktivn칤') + ' ' + (isCollapsed ? '郊' : '郊') + '</span>';
                html += '</div>';
                
                if (!isCollapsed) {
                html += '<div style="display: flex; flex-direction: column; gap: 0.4rem; pointer-events: auto;">';
                activeQuests.forEach(q => {
                    const isHere = q.location === state.world.currentLocation;
                    const locationName = q.location ? (WORLD_LOCATIONS.find(l => l.id === q.location)?.name || q.location) : null;
                    const directionInfo = q.location && !isHere ? getDirectionToLocation(q.location) : null;
                    
                    // Speci치ln칤 onclick pro detektivn칤 questy
                    const onClickAction = q.type === 'detective' ? 
                        `showDetectiveQuestStatus('${q.questId}')` : 
                        `showQuestTrackerDetail('${q.type}')`;
                    
                    html += '<div onclick="event.stopPropagation(); ' + onClickAction + '" style="cursor: pointer; background: ' + (isHere ? q.color + '22' : '#0a0a0a') + '; padding: 0.5rem; border-radius: 6px; border-left: 3px solid ' + q.color + '; display: flex; align-items: center; gap: 0.5rem; position: relative; z-index: 10; ' + (q.urgent ? 'animation: pulse 1s infinite;' : '') + '">';
                    html += '<span style="font-size: 1.2rem;">' + q.icon + '</span>';
                    html += '<div style="flex: 1; min-width: 0;">';
                    html += '<div style="font-size: 0.85rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + q.name + '</div>';
                    if (q.timer) {
                        html += '<div style="font-size: 0.75rem; color: ' + q.color + '; font-weight: bold;">낋 ' + q.timer + ' ' + ('zb칳v치') + '</div>';
                    }
                    if (q.extra) {
                        html += '<div style="font-size: 0.7rem; color: #888;">' + q.extra + '</div>';
                    }
                    if (q.npcName) {
                        html += '<div style="font-size: 0.7rem; color: #888;">' + ('Od:') + ' ' + q.npcName + '</div>';
                    }
                    if (locationName) {
                        html += '<div style="font-size: 0.7rem; color: ' + (isHere ? '#8bc34a' : '#666') + '; display: flex; align-items: center; gap: 0.3rem;">';
                        if (isHere) {
                            html += '<span style="color: #8bc34a;">游늸 ' + ('Jsi tady') + '</span>';
                        } else {
                            html += '<span>游늸 ' + locationName + '</span>';
                            if (directionInfo && directionInfo.distance > 0) {
                                html += '<span style="color: #888;">(' + directionInfo.arrow + ' ' + directionInfo.distance + ')</span>';
                            }
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                    // Fajfka jen pro spln캩n칠 questy, ne jen pro "jsi na lokaci"
                    if (q.isQuestComplete) {
                        html += '<span style="color: #4caf50; font-size: 1.2rem;" title="Quest spln캩n - m콢쬰코 odevzdat!">九</span>';
                    } else if (isHere) {
                        html += '<span style="color: #ff9800; font-size: 0.9rem;" title="Jsi na m칤st캩">游늸</span>';
                    }
                    html += '</div>';
                });
                html += '</div>';
                } // konec if (!isCollapsed)
                
                html += '</div>';
                return html;
            }
            
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation) || WORLD_LOCATIONS[0];
            
            // Ochrana proti neplatn칠 lokaci
            if (!currentLoc || !currentLoc.id) {
                console.error('renderWorldMap: Invalid currentLoc, resetting to shelter. state.world.currentLocation was:', state.world.currentLocation);
                state.world.currentLocation = 'shelter';
                const shelterLoc = WORLD_LOCATIONS.find(l => l.id === 'shelter');
                if (!shelterLoc) {
                    return '<div style="color: #f44336; padding: 1rem;">Chyba: Nelze naj칤t 쮂멳nou platnou lokaci</div>';
                }
                return renderWorldMap(); // Rekurzivn칤 vol치n칤 s opravenou lokac칤
            }
            
            // Debug: pokud lokace nen칤 nalezena v WORLD_LOCATIONS
            if (!WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation)) {
                console.warn('renderWorldMap: Location not found, using fallback. Requested:', state.world.currentLocation, 'Using:', currentLoc.id);
            }
            
            const availablePaths = WORLD_PATHS.filter(p => 
                p.from === state.world.currentLocation || p.to === state.world.currentLocation
            );
            
            console.log('renderWorldMap: currentLocation =', state.world.currentLocation, ', paths found =', availablePaths.length, ', total paths =', WORLD_PATHS.length);
            
            // Debug: zobraz prvn칤 3 cesty ze WORLD_PATHS
            if (availablePaths.length === 0 && WORLD_PATHS.length > 0) {
                console.log('Sample paths:', WORLD_PATHS.slice(0, 3).map(p => p.from + ' -> ' + p.to));
            }
            
            const zoneColors = { safe: '#4CAF50', medium: '#FF9800', danger: '#f44336', deadly: '#9C27B0' };
            const zoneNames = { safe: '游릭 Bezpe캜n치', medium: '游리 St콏edn칤', danger: '游댮 Nebezpe캜n치', deadly: '游 Smrteln치' };
            
            const uiTexts = {
                visited: 'Nav코t칤veno',
                dangerLevel: '칔rove켿 nebezpe캜칤',
                traveling: '游뛌 CESTUJE...',
                hunt: 'LOV',
                mine: 'T캨콯BA',
                fish: 'RYBOLOV',
                explore: 'PR콡ZKUM',
                gather: 'SB칈R츼N칈'
            };
            
            let html = '';
            
            // Aktu치ln칤 lokace header + AKCE V JEDNOM BOXU
            html += '<div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 1rem; border-radius: 8px; border: 2px solid ' + zoneColors[currentLoc.zone] + '; margin-bottom: 1rem;">';
            
            // Header s n치zvem lokace
            html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">';
            html += '<div><div style="font-size: 2.5rem; display: inline-block; margin-right: 0.5rem;">' + currentLoc.icon + '</div>';
            html += '<div style="display: inline-block; vertical-align: top;"><h2 style="margin: 0; color: #fff;">' + getLocName(currentLoc.id) + '</h2>';
            html += '<span style="background: ' + zoneColors[currentLoc.zone] + '22; color: ' + zoneColors[currentLoc.zone] + '; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; border: 1px solid ' + zoneColors[currentLoc.zone] + ';">' + zoneNames[currentLoc.zone] + '</span></div></div>';
            html += '<div style="text-align: right;"><div style="font-size: 0.8rem; color: #888;">' + uiTexts.visited + ': ' + state.world.visitedLocations.length + '/' + WORLD_LOCATIONS.length + '</div></div></div>';
            
            // Popis lokace
            html += '<p style="margin: 0.8rem 0; color: #aaa; font-size: 0.9rem;">' + getLocDesc(currentLoc.id) + '</p>';
            if (currentLoc.dangerLevel) {
                html += '<p style="margin: 0 0 0.8rem 0; color: #ff9800; font-size: 0.8rem;">丘멆잺 ' + uiTexts.dangerLevel + ': ' + '游'.repeat(currentLoc.dangerLevel) + '</p>';
            }
            
            // Po캜as칤 (pokud nen칤 캜isto)
            const weather = getCurrentWeather();
            if (weather && weather.id !== 'clear') {
                const weatherColor = weather.id === 'radstorm' ? '#ff9800' : '#4FC3F7';
                html += '<div style="background: ' + weatherColor + '22; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.8rem; border: 1px solid ' + weatherColor + ';">';
                html += '<span style="color: ' + weatherColor + ';">' + weather.icon + ' ' + weather.name + '</span>';
                if (weather.id === 'radstorm' && !state.map.inBase) {
                    html += ' <span style="color: #ff4444;">(+radiace venku!)</span>';
                }
                html += '</div>';
            }
            
            // AKCE - p콏칤mo v info boxu
            if (!state.world.traveling) {
                html += '<div style="border-top: 1px solid #333; padding-top: 0.8rem; margin-top: 0.5rem;">';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                html += getLocationActionButtons(currentLoc);
                html += '</div>';
                
                // NPC na lokaci
                html += renderLocationNPCs(currentLoc);
                html += '</div>';
            }
            
            html += '</div>';
            
            // === QUEST TRACKER WIDGET ===
            html += renderQuestTracker();
            
            // === PROGRESS BARY (nad mapou) ===
            // Cestov치n칤 progress bar - s kontrolou validity
            if (state.world.traveling) {
                // Auto-reset pokud je traveling stav neplatn칳
                const now = Date.now();
                const travelEnd = (state.world.travelStart || 0) + (state.world.travelDuration || 0);
                
                // Pokud cestov치n칤 m캩lo skon캜it p콏ed v칤ce ne 10 sekundami, resetuj
                if (travelEnd > 0 && now > travelEnd + 10000) {
                    console.log('游댢 Auto-reset: Cestov치n칤 m캩lo skon캜it, resetuji stav');
                    state.world.traveling = false;
                    state.map.traveling = false;
                    state.world.travelTo = null;
                    state.world.scheduledEvents = [];
                } 
                // Pokud chyb칤 c칤lov치 destinace, resetuj
                else if (!state.world.travelTo) {
                    console.log('游댢 Auto-reset: Chyb칤 c칤lov치 destinace, resetuji stav');
                    state.world.traveling = false;
                    state.map.traveling = false;
                }
                // Pokud chyb칤 travel duration, resetuj
                else if (!state.world.travelDuration || state.world.travelDuration <= 0) {
                    console.log('游댢 Auto-reset: Chyb칤 travel duration, resetuji stav');
                    state.world.traveling = false;
                    state.map.traveling = false;
                }
            }
            
            // Zobraz progress bar jen pokud je st치le traveling
            if (state.world.traveling) {
                const targetLoc = WORLD_LOCATIONS.find(l => l.id === state.world.travelTo);
                const progress = Math.min(100, ((Date.now() - state.world.travelStart) / state.world.travelDuration) * 100);
                const remaining = Math.max(0, Math.ceil((state.world.travelStart + state.world.travelDuration - Date.now()) / 1000));
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                const timeDisplay = mins > 0 ? `${mins}:${String(secs).padStart(2, '0')}` : `${secs}s`;
                
                // Zjisti jestli byla c칤lov치 lokace u nav코t칤vena
                const isTargetVisited = targetLoc && state.world.visitedLocations?.includes(targetLoc.id);
                const targetName = isTargetVisited ? getLocName(targetLoc.id) : '??? Nezn치m치 lokace';
                
                html += '<div style="background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%); padding: 1rem; border-radius: 8px; border: 2px solid var(--warning-yellow); margin-bottom: 1rem;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
                html += '<span style="color: var(--warning-yellow); font-weight: bold;">' + uiTexts.traveling + '</span>';
                html += '<span style="color: var(--toxic-green);">' + timeDisplay + '</span></div>';
                html += '<div style="background: #0a0a0a; height: 20px; border-radius: 10px; overflow: hidden; border: 1px solid var(--rust);">';
                html += '<div style="height: 100%; background: linear-gradient(90deg, var(--rust), var(--warning-yellow), var(--toxic-green)); width: ' + progress + '%; transition: width 0.5s;"></div></div>';
                html += '<p style="margin: 0.5rem 0 0 0; color: #888; font-size: 0.85rem; text-align: center;">' + getLocName(currentLoc.id) + '  ' + targetName + '</p>';
                html += '<button class="btn" onclick="cancelTravel()" style="width: 100%; margin-top: 0.5rem; background: #c62828; font-size: 0.85rem;">뾆잺 Vr치tit se</button>';
                html += '</div>';
            }
            
            // Akce progress bar (pr콢zkum, lov, t캩쬭a, rybolov, sb칤r치n칤)
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                const icons = { hunt: '游낓', mine: '久勇', fish: '游꿖', explore: '游댌', gather: '游빜' };
                const names = { hunt: uiTexts.hunt, mine: uiTexts.mine, fish: uiTexts.fish, explore: uiTexts.explore, gather: uiTexts.gather };
                const colors = { hunt: '#4caf50', mine: '#ff9800', fish: '#2196f3', explore: '#9c27b0', gather: '#8bc34a' };
                
                const actionType = state.currentAction.type;
                const now = Date.now();
                const progress = Math.min(100, ((now - state.currentAction.startTime) / state.currentAction.duration) * 100);
                const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                
                html += `<div onclick="showActionProgressModal()" style="cursor: pointer; background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 1rem; border-radius: 8px; border: 2px solid ${colors[actionType]}; margin-bottom: 1rem;">`;
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
                html += `<span style="color: ${colors[actionType]}; font-weight: bold;">${icons[actionType]} ${names[actionType]}...</span>`;
                html += `<span style="color: var(--toxic-green);">${mins}:${String(secs).padStart(2, '0')}</span></div>`;
                html += '<div style="background: #0a0a0a; height: 20px; border-radius: 10px; overflow: hidden; border: 1px solid #333;">';
                html += `<div style="height: 100%; background: linear-gradient(90deg, ${colors[actionType]}, #8bc34a); width: ${progress}%; transition: width 0.5s;"></div></div>`;
                html += `<p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.75rem; text-align: center;">${'Klikni pro detaily nebo zru코en칤'}</p></div>`;
            }
            
            // === OBSAZOV츼N칈 칔ZEM칈 PROGRESS BAR ===
            if (state.territoryCapture) {
                const locationId = state.world?.currentLocation;
                const capture = state.territoryCapture[locationId];
                if (capture && capture.startTime) {
                    // Dynamick칳 v칳po캜et progressu z 캜asu (stejn캩 jako cestov치n칤)
                    const CAPTURE_DURATION = 30 * 60 * 1000; // 30 minut v ms
                    const elapsed = Date.now() - capture.startTime;
                    const progress = Math.min(100, (elapsed / CAPTURE_DURATION) * 100);
                    const remainingMs = Math.max(0, CAPTURE_DURATION - elapsed);
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    const mins = Math.floor(remainingSeconds / 60);
                    const secs = remainingSeconds % 60;
                    
                    const factionData = typeof PVP_FACTIONS !== 'undefined' && capture.faction ? PVP_FACTIONS[capture.faction] : null;
                    const factionColor = factionData?.color || '#ff9800';
                    const factionName = factionData?.name || 'Tv치 frakce';
                    
                    html += `<div onclick="showTerritoryInfo('${locationId}')" style="cursor: pointer; background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; border: 2px solid ${factionColor}; margin-bottom: 1rem;">`;
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
                    html += `<span style="color: ${factionColor}; font-weight: bold;">游낎 Obsazov치n칤 칰zem칤</span>`;
                    html += `<span style="color: var(--toxic-green);">${mins}:${String(secs).padStart(2, '0')}</span></div>`;
                    html += '<div style="background: #0a0a0a; height: 20px; border-radius: 10px; overflow: hidden; border: 1px solid #333;">';
                    html += `<div style="height: 100%; background: linear-gradient(90deg, ${factionColor}, #ffd700); width: ${progress}%; transition: width 0.5s;"></div></div>`;
                    html += `<p style="margin: 0.5rem 0 0 0; color: #888; font-size: 0.75rem; text-align: center;">${progress.toFixed(0)}% pro ${factionName}  Z콢sta켿 na m칤st캩!</p>`;
                    html += '</div>';
                }
            }
            
            // P콎EHLED SV캨TA - mapa
            html += renderWorldOverview(zoneColors);
            
            return html;
        }
        
        // Pomocn치 funkce pro generov치n칤 tla캜칤tek akc칤
        function getLocationActionButtons(location) {
            let html = '';
            
            // === GROUND LOOT - p콏edm캩ty na zemi ===
            const groundItems = getGroundLoot();
            if (groundItems.length > 0) {
                html += `<button onclick="showGroundLoot()" style="
                    background: linear-gradient(135deg, #ff9800, #f57c00);
                    color: white;
                    border: none;
                    padding: 0.6rem 1rem;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.4rem;
                    font-size: 0.9rem;
                    font-weight: bold;
                    animation: pulse 1.5s infinite;
                ">
                    <span style="font-size: 1.2rem;">游닍</span>
                    <span>Na zemi (${groundItems.length})</span>
                </button>`;
            }
            
            // Typy kde NELZE lovit/t캩쬴t (m캩stsk칠/indoor lokace)
            const noHuntingTypes = ['shop', 'service', 'medical', 'home', 'settlement', 'empty', 'city'];
            const noMiningTypes = ['shop', 'service', 'medical', 'home', 'settlement', 'rest', 'empty', 'city'];
            
            // Konkr칠tn칤 lokace bez p콏칤rody (silnice, m캩sta, budovy) - ani lov ani t캩쬭a
            const noNatureLocations = ['highway', 'gas_station', 'metro_entrance', 'subway_tunnels', 'old_bunker', 'power_plant', 'bucovice', 'shopping_mall', 'hospital', 'police_station', 'school'];
            
            // Typy kde lze va콏it (pot콏ebuje코 ohe켿 nebo kuchy켿)
            const canCookTypes = ['home', 'rest', 'settlement', 'explore', 'resource'];
            
            // Typy kde lze d캩lat alchymii (pot콏ebuje코 klid)
            const canAlchemyTypes = ['home', 'medical', 'settlement'];
            
            // === DOMOV (shelter) ===
            if (location.id === 'shelter') {
                // Lokalizovan칠 texty pro akce
                const actionTexts = {
                    out: 'Ven',
                    inside: 'Dovnit콏',
                    sleep: 'Sp치nek',
                    stash: 'Skr칳코',
                    settlement: 'Osada',
                    relations: 'Vztahy',
                    radio: 'R치dio',
                    cooking: 'Va콏en칤',
                    alchemy: 'Alchymie',
                    abyss: 'Propast',
                    revive: 'O쬴vit'
                };
                
                if (state.map.inBase) {
                    html += renderActionButton('游뛁', actionTexts.out, 'toggleBase()', 'var(--rust)');
                } else {
                    html += renderActionButton('游', actionTexts.inside, 'toggleBase()', 'var(--toxic-dark)');
                }
                html += renderActionButton('游띒勇', actionTexts.sleep, "showActionModal('sleep')", '#3949AB');
                html += renderActionButton('游닍', actionTexts.stash, 'openStashMenu()', '#455A64');
                html += renderActionButton('游끶勇', actionTexts.settlement, "switchTab('base')", '#9C27B0');
                html += renderActionButton('游논', actionTexts.relations, 'showNPCRelations()', '#E91E63');
                html += renderActionButton('游닡', actionTexts.radio, 'useRadio()', '#283593');
                html += renderActionButton('游꼽', actionTexts.cooking, "showActionModal('cook')", '#E65100');
                html += renderActionButton('丘勇', actionTexts.alchemy, "showActionModal('alchemy')", '#6A1B9A');
                
                // Propast - endgame dungeon (viditeln칳 od level 10, vstup od 15)
                if ((state.char.level || 1) >= 10) {
                    html += renderActionButton('游돕勇', actionTexts.abyss, 'showAbyssEntrance()', '#1a0a2a');
                }
                
                const deadCompanion = state.companions?.find(c => c.isDead);
                if (deadCompanion) {
                    html += renderActionButton('游', actionTexts.revive, 'showReviveCompanionModal()', '#c62828');
                }
                return html; // Shelter m치 speci치ln칤 akce, konec
            }
            
            // === OBCHODY ===
            if (location.type === 'shop') {
                const shopText = 'Obchod';
                html += renderActionButton('游', shopText, 'openShop()', 'var(--rust-light)');
            }
            
            // === SLU콯BY (d칤lna) ===
            if (location.type === 'service') {
                const repairText = 'Opravit';
                html += renderActionButton('游댢', repairText, 'visitWorkshop()', '#5D4037');
            }
            
            // === ZDRAVOTNICTV칈 ===
            if (location.type === 'medical') {
                const healText = 'L칠캜it se';
                const searchText = 'Prohledat';
                html += renderActionButton('游눍', healText, 'visitHospital()', '#c62828');
                html += renderActionButton('游댌', searchText, "showActionModal('explore')", 'var(--rust)');
            }
            
            // === PR콡ZKUM ===
            if (location.type === 'explore' || location.type === 'dungeon') {
                const searchText = 'Prohledat';
                html += renderActionButton('游댌', searchText, "showActionModal('explore')", 'var(--rust)');
            }
            
            // === DUNGEON S PATRY ===
            if (location.type === 'dungeon') {
                console.log('游낋 Location is dungeon:', location.id);
                console.log('游낋 DUNGEON_FLOORS keys:', Object.keys(DUNGEON_FLOORS || {}));
                console.log('游낋 Has floors:', !!DUNGEON_FLOORS?.[location.id]);
                
                if (DUNGEON_FLOORS && DUNGEON_FLOORS[location.id]) {
                    console.log('游낋 Rendering ENTER button for dungeon:', location.id);
                    const enterText = 'Vstoupit';
                    html += renderActionButton('游낋', enterText, `enterDungeon('${location.id}')`, '#6A1B9A');
                } else {
                    console.warn('游낋 Dungeon without floors:', location.id);
                    // Fallback - zobraz alespo켿 prohled치n칤
                    html += renderActionButton('游댌', 'Prohledat', "showActionModal('explore')", 'var(--rust)');
                }
            }
            
            // === NEP콎츼TELSK칄 ===
            if (location.type === 'hostile' || (location.type === 'dungeon' && !DUNGEON_FLOORS[location.id])) {
                // Zkontroluj zda lokace byla vy캜i코t캩n치
                const isCleared = state.clearedLocations?.includes(location.id);
                
                if (isCleared) {
                    // Lokace vy캜i코t캩n치 - zobraz speci치ln칤 akce
                    const clearedText = '九 Lokace vy캜i코t캩n치';
                    html += `<div style="background: #1a3a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">${clearedText}</div>`;
                    
                    // Speci치ln칤 akce pro r콢zn칠 lokace
                    if (location.id === 'slave_camp') {
                        // Zkontroluj zda zajatci u byli osvobozeni
                        if (!state.freedSlaves) {
                            const freeText = 'Osvobodit zajatce';
                            html += renderActionButton('久勇', freeText, 'freeSlaves()', '#4caf50');
                        } else {
                            const freedText = 'Zajatci u byli osvobozeni';
                            html += `<div style="color: #888; font-size: 0.8rem; text-align: center;">${freedText}</div>`;
                        }
                    } else if (location.id === 'raider_camp') {
                        const searchCampText = 'Prohledat t치bor';
                        html += renderActionButton('游댌', searchCampText, "showActionModal('explore')", 'var(--rust)');
                        
                        // Zkontroluj timed quests pro rescue_hostage
                        const rescueQuest = state.timedQuests?.find(tq => 
                            tq.id === 'rescue_hostage' && !tq.completed && !tq.failed &&
                            tq.objectives.some(o => o.id === 'free_hostage' && !o.completed)
                        );
                        if (rescueQuest) {
                            const freeHostageText = 'Osvobodit rukojm칤';
                            html += renderActionButton('游똂', freeHostageText, "completeInteractObjective('free_hostage')", '#4caf50');
                        }
                    }
                    
                    // Obecn치 kontrola timed quest콢 s interact objectives
                    if (state.timedQuests) {
                        state.timedQuests.filter(tq => !tq.completed && !tq.failed).forEach(tq => {
                            const quest = typeof TIMED_QUESTS !== 'undefined' ? TIMED_QUESTS.find(q => q.id === tq.id) : null;
                            if (quest && quest.location === location.id) {
                                tq.objectives.forEach((obj, i) => {
                                    const questObj = quest.objectives[i];
                                    if (questObj.type === 'interact' && !obj.completed) {
                                        // Zkontroluj zda p콏edchoz칤 c칤le jsou spln캩ny
                                        const prevComplete = tq.objectives.slice(0, i).every(o => o.completed);
                                        if (prevComplete) {
                                            html += renderActionButton('游꿢', questObj.text, `completeInteractObjective('${questObj.id}')`, '#ff9800');
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    // Mo쬹ost znovu raidu (respawn)
                    html += renderActionButton('游댃', 'Raid znovu', 'raidLocation()', '#555');
                } else {
                    html += renderActionButton('丘덢잺', 'Raid', 'raidLocation()', '#8B0000');
                }
            }
            
            // === ZDROJE ===
            if (location.type === 'resource' && location.resource !== 'water') {
                // Pro vodn칤 zdroje je speci치ln칤 tla캜칤tko "Nabrat vodu"
                const gatherLimit = checkDailyActionLimit('gather', location.id);
                if (gatherLimit.canDo) {
                    html += renderActionButton('游빜', 'Sb칤rat (' + gatherLimit.remaining + '/3)', "showActionModal('gather')", '#4CAF50');
                } else {
                    const hours = Math.ceil(gatherLimit.resetIn / (1000 * 60 * 60));
                    html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>游빜 Vy캜erp치no (' + hours + 'h)</button>';
                }
            }
            
            // === NEBEZPE캛N칄 (radiace) - pou쬴j standardn칤 pr콢zkum ===
            if (location.type === 'dangerous') {
                html += renderActionButton('驕뮖잺', 'Prozkoumat', "showActionModal('explore')", '#ff5722');
            }
            
            // === T츼BO콎IT캨 ===
            if (location.type === 'rest') {
                html += renderActionButton('游눣', 'Odpo캜inek', 'restAtCamp()', '#3949AB');
                html += renderActionButton('游댠', 'T치bor치k', 'makeCampfire()', '#E65100');
                html += renderActionButton('游꼽', 'Va콏en칤', "showActionModal('cook')", '#E65100');
                html += renderActionButton('游댌', 'Prohledat', "showActionModal('explore')", 'var(--rust)');
            }
            
            // === VYS칈LA캛 - R츼DIO ===
            if (location.id === 'radio_tower') {
                html += renderActionButton('游닡', 'R치dio', 'useRadio()', '#283593');
                html += renderActionButton('游니', 'Sign치l', 'useRadioTowerSignal()', '#1565C0');
            }
            
            // === FRIENDLY NPC na lokac칤ch ===
            const npcsHere = FRIENDLY_NPCS.filter(n => n.location === location.id);
            if (npcsHere.length > 0) {
                npcsHere.forEach(npc => {
                    html += renderActionButton(npc.icon, npc.name, `showNPCDetail('${npc.id}')`, '#E91E63');
                });
            }
            
            // === OSADY ===
            if (location.type === 'settlement') {
                // Z치kladn칤 settlement akce
                html += renderActionButton('游', 'Obchod', 'openShop()', 'var(--rust-light)');
                html += renderActionButton('游눣', 'Odpo캜inek', 'showRestInfo()', '#3949AB');
            }
            
            // === BU캛OVICE - HLAVN칈 M캨STO ===
            if (location.id === 'bucovice') {
                html += renderActionButton('游', 'Tr쬴코t캩', 'openBucoviceMarket()', 'var(--rust-light)');
                html += renderActionButton('游꽄', 'Hospoda', 'visitBucoviceTavern()', '#8D6E63');
                html += renderActionButton('游낀', 'L칠캜itel', 'visitBucoviceHealer()', '#4CAF50');
                html += renderActionButton('游닆', 'N치st캩nka', 'showBucoviceBounties()', '#ff9800');
                html += renderActionButton('游눣', 'Hotel', 'restAtBucovice()', '#3949AB');
                html += renderActionButton('游댌', 'Prohledat', "showActionModal('explore')", '#607d8b');
                html += renderActionButton('丘뒲잺', 'Karma', 'showStoryKarma()', '#9c27b0');
                
                // Kontrola fin치le - m치 hr치캜 v코echny 4 komponenty?
                const hasAllComponents = ['plutonium_core', 'quantum_stabilizer', 'fusion_cell', 'ai_module'].every(
                    compId => state.inv?.some(i => i.id === compId)
                );
                
                if (hasAllComponents && !state.storyKarma?.ending) {
                    html += '<div style="margin-top: 0.5rem; padding: 0.5rem; background: linear-gradient(135deg, #4a1a4a, #1a4a4a); border-radius: 8px; border: 2px solid #ffd700;">';
                    html += '<div style="text-align: center; color: #ffd700; font-weight: bold; margin-bottom: 0.3rem;">丘멆잺 FIN츼LE P콎칈B캨HU</div>';
                    html += '<p style="color: #aaa; font-size: 0.8rem; margin: 0 0 0.5rem 0; text-align: center;">M치코 v코echny 4 komponenty. Oba brat콏i jsou zde a 캜ekaj칤 na tebe.</p>';
                    html += renderActionButton('游붳', 'Kory', 'showFinalChoice("kory")', '#e91e63');
                    html += renderActionButton('游녿꽳릢', 'Koudy', 'showFinalChoice("koudy")', '#2196f3');
                    html += renderActionButton('游눤', 'Zni캜it v코e', 'showFinalChoice("destroy")', '#f44336');
                    html += '</div>';
                }
            }
            
            // === FRAK캛N칈 LOKACE ===
            if (location.type === 'faction' && location.faction) {
                const faction = FACTIONS.find(f => f.id === location.faction);
                const repLevel = getFactionReputationLevel(location.faction);
                
                // Z치kladn칤 interakce s frakc칤
                html += renderActionButton(faction?.icon || '游끹勇', faction?.name || 'Frakce', "showFactionInteraction('" + location.faction + "')", faction?.color || '#ffd700');
                
                // Obchod pokud nejsou nep콏치tel칠
                if (repLevel.id !== 'enemy' && repLevel.id !== 'hostile') {
                    html += renderActionButton('游', 'Obchod', "openFactionShop('" + location.faction + "')", 'var(--rust-light)');
                }
                
                // Speci치ln칤 akce podle frakce
                if (location.faction === 'traders') {
                    html += renderActionButton('游눯', 'Investovat', "investInFaction('traders')", '#ffd700');
                }
                if (location.faction === 'scientists') {
                    html += renderActionButton('游댧', 'V칳zkum', "showFactionResearch('scientists')", '#00bcd4');
                    
                    // P콏칤stup do laborato콏e vy쬬duje 50+ rep
                    const scientistsBonuses = getFactionBonuses();
                    if (scientistsBonuses.techAccess) {
                        html += renderActionButton('游빍', 'Laborato콏', "openScientistsLab()", '#00bcd4');
                    } else {
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled title="Pot콏ebuje코 50+ reputace u V캩dc콢">游빍 Laborato콏 (游)</button>';
                    }
                    
                    if (repLevel.id === 'allied' || (getReputation('scientists') >= 100)) {
                        html += renderActionButton('驕勇', 'L칠캜ba mutac칤', 'cureMutations()', '#8bc34a');
                    }
                }
                if (location.faction === 'mutants') {
                    html += renderActionButton('游빏', 'Mutant칤 obchod', "openMutantTrade()", '#8bc34a');
                }
                if (location.faction === 'military') {
                    // Tr칠nink vy쬬duje alespo켿 P콏치telsk칳 status (50+ rep)
                    const militaryBonuses = getFactionBonuses();
                    if (militaryBonuses.training) {
                        html += renderActionButton('游꿌勇', 'Tr칠nink', "showMilitaryTraining()", '#607d8b');
                    } else {
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled title="Pot콏ebuje코 50+ reputace u Military">游꿌勇 Tr칠nink (游)</button>';
                    }
                }
                
                // Odpo캜inek pokud p콏치tel코t칤
                if (repLevel.id === 'friendly' || repLevel.id === 'allied') {
                    html += renderActionButton('游눣', 'Odpo캜inek', 'restAtCamp()', '#3949AB');
                }
            }
            
            // === SPECI츼LN칈 ZDROJE ===
            if (location.actions?.includes('fish') || location.id === 'lake' || location.id === 'small_pond' || location.resource === 'fish') {
                const hasFishingRod = state.inv.find(i => i.id === 'fishing_rod' || i.id === 'fishing_rod_uncommon');
                if (!hasFishingRod) {
                    html += '<button class="btn" onclick="notifyWarning(\'Chyb칤 vybaven칤\', \'Pot콏ebuje코 游꿖 Ryb치콏sk칳 prut pro rybolov!\')" style="background: #333; color: #666; flex: 1;">游꿖 Rybolov (游 prut)</button>';
                } else {
                    // showActionModal('fish') automaticky zjist칤 jestli m치 lokace spoty a zobraz칤 v칳b캩r
                    html += renderActionButton('游꿖', 'Rybolov', "showActionModal('fish')", '#1565C0');
                }
            }
            if (location.resource === 'water') {
                html += renderActionButton('游눦', 'Nabrat vodu', 'collectWater()', '#1565C0');
            }
            if (location.resource === 'fuel') {
                html += renderActionButton('久', '캛erpat palivo', 'collectFuel()', '#ff9800');
            }
            
            // === LOV - jen venku v p콏칤rod캩 ===
            if (!noHuntingTypes.includes(location.type) && location.zone !== 'deadly' && !noNatureLocations.includes(location.id)) {
                const hasHuntingWeapon = state.inv.find(i => 
                    i.id === 'hunting_bow' || i.id === 'crossbow' || i.id === 'wooden_bow' || i.id === 'bow' ||
                    (i.type === 'weapon' && i.icon === '游낓')
                );
                if (!hasHuntingWeapon) {
                    html += '<button class="btn" onclick="notifyWarning(\'Chyb칤 vybaven칤\', \'Pot콏ebuje코 游낓 Luk nebo Ku코i pro lov!\')" style="background: #333; color: #666; flex: 1;">游낓 Lov (游 luk)</button>';
                } else {
                    const huntLimit = checkDailyActionLimit('hunt', location.id);
                    if (huntLimit.canDo) {
                        html += renderActionButton('游낓', 'Lov (' + huntLimit.remaining + '/3)', "showActionModal('hunt')", '#2E7D32');
                    } else {
                        const hours = Math.ceil(huntLimit.resetIn / (1000 * 60 * 60));
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>游낓 Vy캜erp치no (' + hours + 'h)</button>';
                    }
                }
            }
            
            // === T캨콯BA - jen tam kde jsou sk치ly/zem ===
            if (!noMiningTypes.includes(location.type) && location.zone !== 'deadly' && !noNatureLocations.includes(location.id)) {
                // T캩쬭a hlavn캩 v explore, resource, dangerous, dungeon, hostile, mine
                if (['explore', 'resource', 'dangerous', 'dungeon', 'hostile', 'mine'].includes(location.type)) {
                    const hasPickaxe = state.inv.find(i => i.id === 'pickaxe');
                    if (!hasPickaxe) {
                        html += '<button class="btn" onclick="notifyWarning(\'Chyb칤 vybaven칤\', \'Pot콏ebuje코 久勇 Krump치캜 pro t캩쬭u!\')" style="background: #333; color: #666; flex: 1;">久勇 T캩쬭a (游 krump치캜)</button>';
                    } else {
                        const mineLimit = checkDailyActionLimit('mine', location.id);
                        if (mineLimit.canDo) {
                            html += renderActionButton('久勇', 'T캩쬭a (' + mineLimit.remaining + '/3)', "showActionModal('mine')", '#5D4037');
                        } else {
                            const hours = Math.ceil(mineLimit.resetIn / (1000 * 60 * 60));
                            html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>久勇 Vy캜erp치no (' + hours + 'h)</button>';
                        }
                    }
                }
            }
            
            // === SB칈R츼N칈 D콎EVA - jen v lesn칤ch lokac칤ch (nikdy na resource lokac칤ch) ===
            if (location.type !== 'resource') {
                const isForestLocation = location.id === 'forest_edge' || location.id === 'dense_forest' || location.icon === '游' || location.icon === '游꺕';
                if (isForestLocation) {
                    const gatherLimit = checkDailyActionLimit('gather', location.id);
                    if (gatherLimit.canDo) {
                        html += renderActionButton('游뿻', 'Sb칤r치n칤 (' + gatherLimit.remaining + '/3)', "showActionModal('gather')", '#6D4C41');
                    } else {
                        const hours = Math.ceil(gatherLimit.resetIn / (1000 * 60 * 60));
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>游뿻 Vy캜erp치no (' + hours + 'h)</button>';
                    }
                }
            }
            
            // === FRAK캛N칈 V츼LKA - na v코ech lokac칤ch krom캩 shelter ===
            if (location.id !== 'shelter') {
                const playerFaction = getPlayerFaction();
                if (playerFaction) {
                    const factionData = PVP_FACTIONS[playerFaction];
                    html += renderActionButton(factionData.icon, '칔zem칤', 'showTerritoryActions()', factionData.color);
                } else {
                    html += renderActionButton('游낎', 'Frakce', 'showFactionSelection()', '#ff9800');
                }
                
                // === V츼LE캛N츼 Z칍NA - pokud je aktivn칤 na t칠to lokaci ===
                if (window.activeWarZone && window.activeWarZone.locationId === location.id) {
                    html += renderActionButton('丘덢잺', 'V츼LKA!', 'showWarZoneUI()', '#f44336');
                }
                
                // === ZTRACEN칗 POKLAD - pokud je aktivn칤 na t칠to lokaci ===
                if (window.activeTreasure && window.activeTreasure.locationId === location.id && window.activeTreasure.endTime > Date.now()) {
                    const myName = state.char?.name || '';
                    const safeName = myName.replace(/[.\[\]#$/]/g, '_');
                    const alreadyClaimed = window.activeTreasure.claimedBy && window.activeTreasure.claimedBy[safeName];
                    
                    if (alreadyClaimed) {
                        html += `<button class="btn" style="background: #333; color: #888; font-size: 0.75rem; padding: 0.6rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 65px; border-radius: 8px; cursor: not-allowed; opacity: 0.6;"><span style="font-size: 1.4rem;">九</span><span>M치코</span></button>`;
                    } else {
                        html += renderActionButton('游눑', 'POKLAD!', 'claimTreasure()', '#ffd700');
                    }
                }
            }
            
            // === PR츼ZDN칄 LOKACE - 쮂멳n칠 akce ===
            // Empty lokace nemaj칤 쮂멳n칠 akce
            
            return html;
        }
        
        // Rozhl칠dnut칤 se na pr치zdn칠 lokaci
        function lookAround() {
            const messages = [
                'Rozhl칠dne코 se kolem... Nic zaj칤mav칠ho. Jako tv콢j 쬴vot.',
                'Pusto a pr치zdno. Jen v칤tr, prach a existenci치ln칤 pr치zdnota.',
                'Ticho. 콯치dn칠 zn치mky 쬴vota. Perfektn칤 m칤sto pro piknik!',
                'M칤sto jako ka쬯칠 jin칠 v pustin캩. Depresivn칤.',
                'Nic k vid캩n칤. Mo쬹치 p콏칤코t캩. Nebo nikdy.',
                'Zd치 se, 쬰 tu opravdu nic nen칤. P콏ekvapen칤!',
                'Na코el jsi... nic. Gratuluji.',
                'Pr치zdnota z칤r치 zp캩t. Mrkla prvn칤.',
                'Rozhl칠dl ses. Litoval jsi. Pokra캜uje코.'
            ];
            
            // Ob캜as p콏idej zvl치코tn칤 n치lez
            if (Math.random() < 0.15) {
                const finds = getRandomHumor('finds');
                addLog(finds, '游');
                notifyInfo('Zvl치코tn칤 n치lez...', finds);
                return;
            }
            
            const msg = messages[Math.floor(Math.random() * messages.length)];
            addLog(msg, '游녜勇');
            notifyInfo('Pr콢zkum', msg);
        }
        
        // P콏ehled sv캩ta - 2D mapa
        // === SV캨TOV칄 STRANY - Helper funkce ===
        function getDirectionToLocation(targetLocationId) {
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const targetLoc = WORLD_LOCATIONS.find(l => l.id === targetLocationId);
            
            if (!currentLoc || !targetLoc) return { direction: '', arrow: '', distance: 0 };
            
            const dx = targetLoc.x - currentLoc.x;
            const dy = targetLoc.y - currentLoc.y;
            const distance = Math.abs(dx) + Math.abs(dy); // Manhattan distance
            
            // Ur캜en칤 sm캩ru
            let direction = '';
            let arrow = '';
            
            if (dx === 0 && dy === 0) {
                direction = 'zde';
                arrow = '游늸';
            } else if (Math.abs(dx) > Math.abs(dy) * 2) {
                // P콏ev치쬹캩 v칳chod/z치pad
                if (dx > 0) { direction = 'na v칳chod캩'; arrow = '俱뫮잺'; }
                else { direction = 'na z치pad캩'; arrow = '拘勇'; }
            } else if (Math.abs(dy) > Math.abs(dx) * 2) {
                // P콏ev치쬹캩 sever/jih
                if (dy > 0) { direction = 'na jihu'; arrow = '拘勇'; }
                else { direction = 'na severu'; arrow = '拘勇'; }
            } else {
                // Diagon치ln칤
                if (dx > 0 && dy < 0) { direction = 'na severov칳chod캩'; arrow = '勇'; }
                else if (dx > 0 && dy > 0) { direction = 'na jihov칳chod캩'; arrow = '떮잺'; }
                else if (dx < 0 && dy < 0) { direction = 'na severoz치pad캩'; arrow = '뒲잺'; }
                else { direction = 'na jihoz치pad캩'; arrow = '뙖잺'; }
            }
            
            return { direction, arrow, distance, dx, dy };
        }
        
        function getDirectionText(targetLocationId) {
            const { direction, arrow, distance } = getDirectionToLocation(targetLocationId);
            if (distance === 0) return '';
            return `${arrow} ${direction} (${distance} ${distance === 1 ? 'pole' : distance < 5 ? 'pole' : 'pol칤'})`;
        }
        
        function renderWorldOverview(zoneColors) {
            let html = '';
            
            // === SOU콎ADNICE HR츼캛E ===
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const coordsText = currentLoc ? `[${currentLoc.x}, ${currentLoc.y}]` : `[${state.map?.x || 0}, ${state.map?.y || 0}]`;
            
            html += '<details open style="background: #1a1a1a; border-radius: 8px; border: 1px solid var(--metal-light); margin-bottom: 1rem;">';
            html += '<summary style="padding: 0.8rem; cursor: pointer; color: var(--rust-light); font-weight: bold; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>游딬勇 ' + ('Mapa sv캩ta') + '</span>';
            html += '<span style="color: #8bc34a; font-size: 0.85rem; font-family: monospace; background: #0a0a0a; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid #333;">游늸 ' + coordsText + '</span>';
            html += '</summary>';
            html += '<div style="padding: 0.5rem; overflow-x: auto;">';
            
            // Najdi rozsah mapy
            let minX = 0, maxX = 0, minY = 0, maxY = 0;
            WORLD_LOCATIONS.forEach(loc => {
                if (loc.x < minX) minX = loc.x;
                if (loc.x > maxX) maxX = loc.x;
                if (loc.y < minY) minY = loc.y;
                if (loc.y > maxY) maxY = loc.y;
            });
            
            const cellSize = 36;
            const width = (maxX - minX + 1) * cellSize;
            const height = (maxY - minY + 1) * cellSize;
            
            // === MAPA S KOMPASEM UVNIT콎 ===
            html += '<div style="position: relative; width: ' + width + 'px; height: ' + height + 'px; margin: 0 auto; background: #0a0a0a; border: 1px solid #333; border-radius: 4px;">';
            
            // === KOMPAS v prav칠m horn칤m rohu mapy ===
            html += '<div style="position: absolute; top: 5px; right: 5px; width: 40px; height: 40px; background: radial-gradient(circle, #1a1a2a 0%, #0d0d1a 100%); border-radius: 50%; border: 1px solid #3a3a5a; display: flex; align-items: center; justify-content: center; z-index: 20; opacity: 0.9;">';
            html += '<div style="position: relative; width: 32px; height: 32px;">';
            html += '<div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); color: #ff4444; font-size: 0.65rem; font-weight: bold;">S</div>';
            html += '<div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); color: #666; font-size: 0.55rem;">J</div>';
            html += '<div style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.55rem;">Z</div>';
            html += '<div style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.55rem;">V</div>';
            html += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 4px; background: #ffd700; border-radius: 50%;"></div>';
            html += '</div></div>';
            
            // Vykreslen칤 lokac칤
            WORLD_LOCATIONS.forEach(loc => {
                const isHere = loc.id === state.world.currentLocation;
                const isVisited = state.world.visitedLocations.includes(loc.id);
                const isRevealed = state.world.revealedLocations?.includes(loc.id);
                const isKnown = isVisited || isRevealed; // Lokace je zn치m치 pokud nav코t칤vena NEBO odhalena
                const left = (loc.x - minX) * cellSize;
                const top = (loc.y - minY) * cellSize;
                
                // Zjisti jestli je lokace dostupn치 (m치 p콏칤mou cestu)
                const hasPath = WORLD_PATHS.some(p => 
                    (p.from === state.world.currentLocation && p.to === loc.id) || 
                    (p.to === state.world.currentLocation && p.from === loc.id)
                );
                
                let bgColor = '#1a1a1a';
                let borderColor = '#333';
                let cursor = 'default';
                let clickAction = '';
                
                if (isHere) {
                    bgColor = 'var(--toxic-dark)';
                    borderColor = 'var(--toxic-green)';
                    // P콏id치me pulsuj칤c칤 efekt pro aktu치ln칤 pozici
                } else if (hasPath) {
                    // Dostupn치 lokace - lze kliknout
                    bgColor = isKnown ? '#2a2a2a' : '#1a1a0a';
                    borderColor = isKnown ? zoneColors[loc.zone] : '#555';
                    cursor = 'pointer';
                    clickAction = isKnown ? "showLocationPreview('" + loc.id + "')" : "quickTravel('" + loc.id + "')";
                } else if (isKnown) {
                    // Nav코t칤ven치/odhalen치 ale nedostupn치 - uk치 info
                    bgColor = isRevealed && !isVisited ? '#2a1a3a' : '#2a2a2a'; // Fialov칠 pozad칤 pro odhalen칠 ale nenav코t칤ven칠
                    borderColor = zoneColors[loc.zone] + '44';
                    cursor = 'pointer';
                    clickAction = "showLocationPreview('" + loc.id + "')";
                } else {
                    // Nezn치m치 a nedostupn치 - zobraz alespo켿 koordin치ty po kliknut칤
                    cursor = 'pointer';
                    clickAction = "showCoordsInfo(" + loc.x + ", " + loc.y + ", '???')";
                }
                
                const opacity = isHere ? 1 : (hasPath ? 1 : (isKnown ? 0.5 : 0.2));
                
                // Tooltip se sou콏adnicemi
                const tooltipText = isKnown ? (loc.name + ' [' + loc.x + ',' + loc.y + ']') : (hasPath ? '??? [' + loc.x + ',' + loc.y + '] (dostupn칠)' : '???');
                
                // Kontrola jestli m치 lokace skr칳코 s v캩cmi
                const hasStash = state.stashes?.[loc.id]?.length > 0;
                
                // Frak캜n칤 barva r치me캜ku (pokud je 칰zem칤 obsazen칠) - zobraz i pro nezn치m칠 lokace!
                let factionBorderColor = null;
                let factionBorderStyle = '';
                let territoryOwnerName = '';
                try {
                    if (window.territoryCache && window.territoryCache[loc.id] && window.territoryCache[loc.id].owner) {
                        const ownerFaction = PVP_FACTIONS[window.territoryCache[loc.id].owner];
                        if (ownerFaction) {
                            factionBorderColor = ownerFaction.color;
                            factionBorderStyle = ` box-shadow: 0 0 5px ${ownerFaction.color}50;`;
                            territoryOwnerName = ownerFaction.name;
                        }
                    }
                } catch(e) {
                    console.log('Territory cache error:', e);
                }
                
                // === V츼LE캛N츼 Z칍NA - v칳razn칠 캜erven칠 sv칤cen칤 ===
                let isWarZone = false;
                if (window.activeWarZone && window.activeWarZone.locationId === loc.id && window.activeWarZone.endTime > Date.now()) {
                    isWarZone = true;
                    factionBorderColor = '#ff0000';
                    factionBorderStyle = ` box-shadow: 0 0 60px #ff0000, 0 0 120px #ff0000dd, 0 0 180px #ff0000aa, inset 0 0 60px #ff000088; animation: war-zone-pulse 1.5s infinite ease-in-out; border-color: #ff0000 !important; z-index: 10; background: radial-gradient(circle, #ff000055 0%, #ff000022 50%, transparent 70%) !important;`;
                    territoryOwnerName = '丘덢잺 V츼LKA';
                }
                
                // === ZTRACEN칗 POKLAD - zlat칠 sv칤cen칤 ===
                let isTreasure = false;
                if (window.activeTreasure && window.activeTreasure.locationId === loc.id && window.activeTreasure.endTime > Date.now()) {
                    isTreasure = true;
                    if (!isWarZone) { // War zone m치 p콏ednost
                        factionBorderColor = '#ffd700';
                        factionBorderStyle = ` box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700aa; animation: treasure-pulse 1.5s infinite ease-in-out; border-color: #ffd700 !important; z-index: 10;`;
                        territoryOwnerName = '游눑 POKLAD';
                    }
                }
                
                // Pou쬴j frak캜n칤 barvu pokud existuje, jinak p콢vodn칤
                const finalBorderColor = factionBorderColor || borderColor;
                const borderWidth = (factionBorderColor || isWarZone || isTreasure) ? '3px' : '2px';
                
                // War zone a treasure styl m치 p콏ednost p콏ed ostatn칤mi
                let finalStyle = factionBorderStyle;
                if (isHere && !isWarZone && !isTreasure) {
                    finalStyle += ' animation: pulse-glow 1.5s infinite; box-shadow: 0 0 10px var(--toxic-green);';
                }
                
                html += '<div onclick="' + clickAction + '" style="position: absolute; left: ' + left + 'px; top: ' + top + 'px; width: ' + (cellSize - 2) + 'px; height: ' + (cellSize - 2) + 'px; background: ' + bgColor + '; border: ' + borderWidth + ' solid ' + finalBorderColor + '; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: ' + cursor + '; opacity: ' + (factionBorderColor ? Math.max(0.6, opacity) : opacity) + ';' + finalStyle + '" title="' + tooltipText + (territoryOwnerName ? ' [' + territoryOwnerName + ']' : '') + '">';
                
                // Zobraz ikonu - pro aktu치ln칤 pozici p콏idej 游늸, pro skr칳코 p콏idej 游닍
                if (isHere) {
                    html += '<span style="position: relative;">' + loc.icon + '<span style="position: absolute; top: -8px; right: -8px; font-size: 0.6rem;">游늸</span>' + (hasStash ? '<span style="position: absolute; bottom: -6px; left: -6px; font-size: 0.5rem;">游닍</span>' : '') + '</span>';
                } else if (hasStash && isKnown) {
                    html += '<span style="position: relative;">' + loc.icon + '<span style="position: absolute; bottom: -6px; left: -6px; font-size: 0.5rem;">游닍</span></span>';
                } else {
                    html += isKnown ? loc.icon : (hasPath ? '仇' : '?');
                }
                html += '</div>';
            });
            
            html += '</div>';
            
            // Legenda s mini kompasem
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.8rem; padding: 0.5rem; background: #0d0d0d; border-radius: 6px;">';
            
            // Lev치 strana - legenda
            html += '<div style="display: flex; gap: 0.6rem; font-size: 0.6rem; flex-wrap: wrap;">';
            html += '<span style="color: var(--toxic-green);">游늸 ' + ('Zde') + '</span>';
            html += '<span style="color: #4CAF50;">游릭 ' + ('Bezpe캜n치') + '</span>';
            html += '<span style="color: #FF9800;">游리 ' + ('St콏edn칤') + '</span>';
            html += '<span style="color: #f44336;">游댮 ' + ('Nebezpe캜n치') + '</span>';
            html += '<span style="color: #8d6e63;">游닍 ' + ('Skr칳코') + '</span>';
            html += '</div>';
            
            // Prav치 strana - mini kompas
            html += '<div style="display: flex; align-items: center; gap: 0.3rem; color: #666; font-size: 0.55rem;">';
            html += '<span style="color: #f44336;">' + ('S') + '</span>';
            html += '<span></span>';
            html += '</div>';
            
            html += '</div>';
            html += '<p style="text-align: center; font-size: 0.55rem; color: #444; margin: 0.3rem 0 0 0;">' + ('Klikni na lokaci pro info a sou콏adnice  仇 = dostupn치') + '</p>';
            
            // Tla캜칤tko n치pov캩dy
            html += '<div style="text-align: center; margin-top: 0.8rem; padding-top: 0.5rem; border-top: 1px solid #333;">';
            html += '<button class="btn" onclick="showMapHelp()" style="background: #3949AB; font-size: 0.8rem; padding: 0.5rem 1rem;">';
            html += '仇 ' + ('N치pov캩da k map캩') + '</button>';
            html += '</div>';
            
            html += '</div></details>';
            
            return html;
        }
        
        // N치pov캩da k map캩
        function showMapHelp() {
            const mapHelpTexts = {
                basics: 'Z치klady mapy', basicsClick: 'Klikni na lokaci', basicsClickFull: 's 仇 pro cestov치n칤',
                basicsPos: 'ozna캜uje tvou aktu치ln칤 pozici', basicsDistant: 'Vzd치len칠 lokace vy쬬duj칤 pr콢chod p콏es mezilokace',
                basicsDiscovered: 'Objeven칠 lokace ukazuj칤 svou ikonu',
                zones: 'Z칩ny nebezpe캜칤', zoneSafe: 'Bezpe캜n치', zoneSafeDesc: 'm치lo nep콏치tel, z치kladn칤 loot',
                zoneMedium: 'St콏edn칤', zoneMediumDesc: '캜ast캩j코칤 boje, lep코칤 odm캩ny',
                zoneDanger: 'Nebezpe캜n치', zoneDangerDesc: 'siln칤 nep콏치tel칠, vz치cn칳 loot',
                zoneDeadly: 'Smrteln치', zoneDeadlyDesc: 'pouze pro zku코en칠, legend치rn칤 ko콏ist',
                locTypes: 'Typy lokac칤', shelter: '칔kryt', shelterDesc: 'tv콢j domov',
                shop: 'Obchod', shopDesc: 'n치kup/prodej', workshop: 'D칤lna', workshopDesc: 'opravy',
                hospital: 'Nemocnice', hospitalDesc: 'l칠캜en칤', ruins: 'Ruiny', ruinsDesc: 'pr콢zkum',
                mine: 'D콢l', mineDesc: 'dungeon', settlement: 'Osada', settlementDesc: 'obchod, odpo캜inek',
                camp: 'T치bor', campDesc: 'odpo캜inek', arena: 'Ar칠na', arenaDesc: 'gladi치torsk칠 boje',
                dangerous: 'Nebezpe캜n칠', dangerousDesc: 'siln칤 nep콏치tel칠',
                actions: 'Akce na lokac칤ch', hunt: 'Lov', huntDesc: 'z칤skej maso a k콢쬰 (p콏칤roda)',
                mining: 'T캩쬭a', miningDesc: 'z칤skej k치men a kov', fishing: 'Rybolov', fishingDesc: 'u vodn칤ch ploch',
                search: 'Prohledat', searchDesc: 'najdi p콏edm캩ty a suroviny', raid: 'Raid', raidDesc: '칰tok na nep콏치telskou lokaci',
                gather: 'Sb칤rat', gatherDesc: 'sb캩r zdroj콢 (resource lokace)', enter: 'Vstoupit', enterDesc: 'vstup do dungeonu s patry',
                rest: 'Odpo캜inek', restDesc: 'regenerace HP a energie',
                travel: 'Cestov치n칤', travelCosts: 'Cestov치n칤 spot콏ebov치v치', travelCostsList: 'energii, hlad a 쮂셬e켿',
                travelRandom: 'B캩hem cesty m콢쬰코 narazit na', travelRandomEvents: 'n치hodn칠 ud치losti',
                travelRad: 'Radia캜n칤 bou콏e', travelRadDesc: '3칑 radiace b캩hem cesty!',
                travelStorm: 'Bou콏ka', travelStormDesc: 'pomalej코칤 cestov치n칤',
                travelDanger: 'Nebezpe캜n캩j코칤 z칩ny = v캩t코칤 코ance na p콏epaden칤',
                npcs: 'NPC na lokac칤ch', npcsHave: 'N캩kter칠 lokace maj칤', npcsFriendly: 'p콏치telsk칠 NPC',
                npcsTalk: 'Mluv', npcsTalkDesc: 's nimi pro zv칳코en칤 d콢v캩ry',
                npcsGifts: 'D치vej dary', npcsGiftsDesc: 'pro rychlej코칤 p콏치telstv칤',
                npcsRewards: 'P콏i vysok칠 d콢v캩콏e odemkne코', npcsRewardsDesc: 'speci치ln칤 odm캩ny',
                dungeons: 'Dungeony', dungeonsFloors: 'N캩kter칠 lokace maj칤', dungeonsFloorsDesc: 'v칤ce pater',
                dungeonsEach: 'Ka쬯칠 patro m치 sv칠 nep콏치tele a loot',
                dungeonsBoss: 'Na posledn칤m pat콏e 캜ek치 BOSS', dungeonsCleared: 'Vy캜i코t캩n치 patra z콢st치vaj칤 pr콢choz칤'
            };
            
            showModal('仇 N치pov캩da k map캩', `
                <div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    
                    <!-- Z츼KLADY -->
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--toxic-dark);">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--toxic-green);">游딬勇 ${mapHelpTexts.basics}</h3>
                        <p style="font-size: 0.85rem; color: #aaa; margin: 0;">
                             <strong>${mapHelpTexts.basicsClick}</strong> ${mapHelpTexts.basicsClickFull}<br>
                             游늸 ${mapHelpTexts.basicsPos}<br>
                             ${mapHelpTexts.basicsDistant}<br>
                             ${mapHelpTexts.basicsDiscovered}
                        </p>
                    </div>
                    
                    <!-- Z칍NY -->
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #333;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #ffd700;">游꿢 ${mapHelpTexts.zones}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;"><span style="color: #4CAF50;">游릭 ${mapHelpTexts.zoneSafe}</span> - ${mapHelpTexts.zoneSafeDesc}</div>
                            <div style="margin-bottom: 0.3rem;"><span style="color: #FF9800;">游리 ${mapHelpTexts.zoneMedium}</span> - ${mapHelpTexts.zoneMediumDesc}</div>
                            <div style="margin-bottom: 0.3rem;"><span style="color: #f44336;">游댮 ${mapHelpTexts.zoneDanger}</span> - ${mapHelpTexts.zoneDangerDesc}</div>
                            <div><span style="color: #9C27B0;">游 ${mapHelpTexts.zoneDeadly}</span> - ${mapHelpTexts.zoneDeadlyDesc}</div>
                        </div>
                    </div>
                    
                    <!-- TYPY LOKAC칈 -->
                    <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #554;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #ff9800;">游늸 ${mapHelpTexts.locTypes}</h3>
                        <div style="font-size: 0.8rem; color: #aaa; display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                            <div>游 <strong>${mapHelpTexts.shelter}</strong> - ${mapHelpTexts.shelterDesc}</div>
                            <div>游 <strong>${mapHelpTexts.shop}</strong> - ${mapHelpTexts.shopDesc}</div>
                            <div>游댢 <strong>${mapHelpTexts.workshop}</strong> - ${mapHelpTexts.workshopDesc}</div>
                            <div>游낀 <strong>${mapHelpTexts.hospital}</strong> - ${mapHelpTexts.hospitalDesc}</div>
                            <div>游끹勇 <strong>${mapHelpTexts.ruins}</strong> - ${mapHelpTexts.ruinsDesc}</div>
                            <div>久勇 <strong>${mapHelpTexts.mine}</strong> - ${mapHelpTexts.mineDesc}</div>
                            <div>游끶勇 <strong>${mapHelpTexts.settlement}</strong> - ${mapHelpTexts.settlementDesc}</div>
                            <div>久 <strong>${mapHelpTexts.camp}</strong> - ${mapHelpTexts.campDesc}</div>
                            <div>游勇 <strong>${mapHelpTexts.arena}</strong> - ${mapHelpTexts.arenaDesc}</div>
                            <div>游 <strong>${mapHelpTexts.dangerous}</strong> - ${mapHelpTexts.dangerousDesc}</div>
                        </div>
                    </div>
                    
                    <!-- AKCE -->
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #335;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #64b5f6;">丘 ${mapHelpTexts.actions}</h3>
                        <div style="font-size: 0.8rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;">游낓 <strong>${mapHelpTexts.hunt}</strong> - ${mapHelpTexts.huntDesc}</div>
                            <div style="margin-bottom: 0.3rem;">久勇 <strong>${mapHelpTexts.mining}</strong> - ${mapHelpTexts.miningDesc}</div>
                            <div style="margin-bottom: 0.3rem;">游꿖 <strong>${mapHelpTexts.fishing}</strong> - ${mapHelpTexts.fishingDesc}</div>
                            <div style="margin-bottom: 0.3rem;">游댌 <strong>${mapHelpTexts.search}</strong> - ${mapHelpTexts.searchDesc}</div>
                            <div style="margin-bottom: 0.3rem;">丘덢잺 <strong>${mapHelpTexts.raid}</strong> - ${mapHelpTexts.raidDesc}</div>
                            <div style="margin-bottom: 0.3rem;">游빜 <strong>${mapHelpTexts.gather}</strong> - ${mapHelpTexts.gatherDesc}</div>
                            <div style="margin-bottom: 0.3rem;">游낋 <strong>${mapHelpTexts.enter}</strong> - ${mapHelpTexts.enterDesc}</div>
                            <div>游눣 <strong>${mapHelpTexts.rest}</strong> - ${mapHelpTexts.restDesc}</div>
                        </div>
                    </div>
                    
                    <!-- CESTOV츼N칈 -->
                    <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #533;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #f44336;">游뛌 ${mapHelpTexts.travel}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;"> ${mapHelpTexts.travelCosts} <strong>${mapHelpTexts.travelCostsList}</strong></div>
                            <div style="margin-bottom: 0.3rem;"> ${mapHelpTexts.travelRandom} <strong>${mapHelpTexts.travelRandomEvents}</strong></div>
                            <div style="margin-bottom: 0.3rem;"> 驕뮖잺 <strong>${mapHelpTexts.travelRad}</strong> - ${mapHelpTexts.travelRadDesc}</div>
                            <div style="margin-bottom: 0.3rem;"> 久걾잺 <strong>${mapHelpTexts.travelStorm}</strong> - ${mapHelpTexts.travelStormDesc}</div>
                            <div> ${mapHelpTexts.travelDanger}</div>
                        </div>
                    </div>
                    
                    <!-- NPC -->
                    <div style="background: #2a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #535;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #E91E63;">游논 ${mapHelpTexts.npcs}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;"> ${mapHelpTexts.npcsHave} <strong>${mapHelpTexts.npcsFriendly}</strong></div>
                            <div style="margin-bottom: 0.3rem;"> 游눫 <strong>${mapHelpTexts.npcsTalk}</strong> ${mapHelpTexts.npcsTalkDesc}</div>
                            <div style="margin-bottom: 0.3rem;"> 游꾸 <strong>${mapHelpTexts.npcsGifts}</strong> ${mapHelpTexts.npcsGiftsDesc}</div>
                            <div> 游닆 ${mapHelpTexts.npcsRewards} <strong>${mapHelpTexts.npcsRewardsDesc}</strong></div>
                        </div>
                    </div>
                    
                    <!-- DUNGEONY -->
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; border: 1px solid #6A1B9A;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #BA68C8;">游낋 ${mapHelpTexts.dungeons}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;"> ${mapHelpTexts.dungeonsFloors} <strong>${mapHelpTexts.dungeonsFloorsDesc}</strong></div>
                            <div style="margin-bottom: 0.3rem;"> ${mapHelpTexts.dungeonsEach}</div>
                            <div style="margin-bottom: 0.3rem;"> ${mapHelpTexts.dungeonsBoss}</div>
                            <div> ${mapHelpTexts.dungeonsCleared}</div>
                        </div>
                    </div>
                    
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        // Pomocn칠 funkce pro renderov치n칤
        // Funkce pro vykreslen칤 ak캜n칤ho tla캜칤tka
        function renderActionButton(icon, name, action, color) {
            // Kontrola zda prob칤h치 akce (blokuj 캜asov캩 n치ro캜n칠 akce)
            const timedActions = ['hunt', 'mine', 'fish', 'explore', 'gather', 'cook', 'sleep'];
            const isTimedAction = timedActions.some(a => action.includes(a));
            const actionInProgress = state.currentAction && state.currentAction.endTime > Date.now();
            
            if (isTimedAction && actionInProgress) {
                // 만d칠 tla캜칤tko s 캜asem a vysv캩tlen칤m
                const remaining = Math.ceil((state.currentAction.endTime - Date.now()) / 1000);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                const actionNames = { hunt: 'Lov', mine: 'T캩쬭a', fish: 'Rybolov', explore: 'Pr콢zkum', gather: 'Sb칤r치n칤', cook: 'Va콏en칤', sleep: 'Sp치nek' };
                const currentActionName = actionNames[state.currentAction.type] || 'Akce';
                return `<button class="btn" onclick="notifyWarning('Prob칤h치 akce', '${currentActionName} pr치v캩 prob칤h치. Po캜kej ${mins}:${String(secs).padStart(2, '0')} nebo ji zru코.')" style="background: #333; color: #666; font-size: 0.75rem; padding: 0.6rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 65px; border-radius: 8px; cursor: pointer; opacity: 0.6;"><span style="font-size: 1.4rem;">낍</span><span>${mins}:${String(secs).padStart(2, '0')}</span></button>`;
            }
            
            return '<button class="btn" onclick="' + action + '" style="background: ' + color + '; font-size: 0.75rem; padding: 0.6rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 65px; border-radius: 8px; transition: transform 0.1s;" onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"><span style="font-size: 1.4rem;">' + icon + '</span><span>' + name + '</span></button>';
        }
        
        // === VYLEPEN칄 AKCE S MODALY ===
        // Kontrola denn칤ho limitu akc칤 (3x za 24 hodin na lokaci)
        function checkDailyActionLimit(actionType, locationId) {
            if (!state.world.actionLimits) state.world.actionLimits = {};
            const key = actionType + '_' + locationId;
            const now = Date.now();
            
            // Pokud neexistuje z치znam, vytvo콏 nov칳
            if (!state.world.actionLimits[key]) {
                state.world.actionLimits[key] = { count: 0, resetTime: now + 24 * 60 * 60 * 1000 };
            }
            
            const data = state.world.actionLimits[key];
            
            // Reset po 24 hodin치ch
            if (now > data.resetTime) {
                data.count = 0;
                data.resetTime = now + 24 * 60 * 60 * 1000;
            }
            
            return { 
                canDo: data.count < 3, 
                remaining: 3 - data.count,
                resetIn: data.resetTime - now 
            };
        }
        
        // === FISHING SPOT SYST칄M ===
        // Umo쮄갓je v칤ce nez치visl칳ch ryb치콏sk칳ch m칤st na jedn칠 lokaci
        let currentFishingSpot = 0;
        
        function showFishingSpotsSelection(location) {
            const spots = location.spots || 1;
            
            let html = '<div style="text-align: center;">';
            html += '<p style="color: #aaa; margin-bottom: 1rem;">Vyber ryb치콏sk칠 m칤sto:</p>';
            html += '<div style="display: grid; grid-template-columns: repeat(' + Math.min(spots, 3) + ', 1fr); gap: 0.5rem;">';
            
            for (let i = 0; i < spots; i++) {
                const spotKey = location.id + '_spot' + i;
                const limit = checkDailyActionLimit('fish', spotKey);
                
                if (limit.canDo) {
                    html += `
                        <div onclick="showFishingSpotModal(${i})" style="cursor: pointer; padding: 1rem; background: linear-gradient(135deg, #1565C0, #0D47A1); border-radius: 8px; border: 2px solid #2196F3;">
                            <div style="font-size: 2rem;">游꿖</div>
                            <div style="font-weight: bold; color: #fff;">M칤sto ${i + 1}</div>
                            <div style="color: #8bc34a; font-size: 0.8rem;">${limit.remaining}/3 zb칳v치</div>
                        </div>`;
                } else {
                    const hours = Math.ceil(limit.resetIn / (1000 * 60 * 60));
                    html += `
                        <div style="padding: 1rem; background: #333; border-radius: 8px; border: 2px solid #555; opacity: 0.6;">
                            <div style="font-size: 2rem; filter: grayscale(1);">游꿖</div>
                            <div style="font-weight: bold; color: #666;">M칤sto ${i + 1}</div>
                            <div style="color: #ff6b6b; font-size: 0.8rem;">VY캛ERP츼NO (${hours}h)</div>
                        </div>`;
                }
            }
            
            html += '</div>';
            html += '<p style="color: #888; font-size: 0.8rem; margin-top: 1rem;">游눠 Ka쬯칠 m칤sto m치 vlastn칤 limit 3 akc칤/24h</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zru코it</button>';
            html += '</div>';
            
            showModal('游꿖 Rybolov - ' + location.name, html);
        }
        
        function showFishingSpotModal(spotIndex) {
            currentFishingSpot = spotIndex;
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const spotKey = location.id + '_spot' + spotIndex;
            const limit = checkDailyActionLimit('fish', spotKey);
            
            if (!limit.canDo) {
                const hours = Math.ceil(limit.resetIn / (1000 * 60 * 60));
                notifyWarning('Vy캜erp치no', `M칤sto ${spotIndex + 1} je vy캜erpan칠. Reset za ${hours}h`);
                return;
            }
            
            // Kontrola vybaven칤
            if (!state.inv.find(i => i.id === 'fishing_rod')) {
                showModal('仇 Chyb칤 vybaven칤', 'Pot콏ebuje코 游꿖 Ryb치콏sk칳 prut pro rybolov!');
                return;
            }
            
            showModal('游꿖 Rybolov - M칤sto ' + (spotIndex + 1), `
                <div style="text-align: center;">
                    <p style="color: #aaa;">Ryb치콏sk칠 m칤sto ${spotIndex + 1} z ${location.spots || 1}</p>
                    <p style="color: #8bc34a;">Zb칳v치 pokus콢: ${limit.remaining}/3</p>
                    <div style="margin: 1rem 0; padding: 1rem; background: #1a1a1a; border-radius: 8px;">
                        <p>游 Mo쬹칠 칰lovky: Mal치 ryba, St콏edn칤 ryba, Velk치 ryba</p>
                        <p style="font-size: 0.8rem; color: #888;">九 Vz치cn캩: Zlat치 rybka, Perla</p>
                    </div>
                    <button class="btn" onclick="startFishingAtSpot(${spotIndex})" style="width: 100%; background: #1565C0;">
                        游꿖 Hodit udici
                    </button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                        Zru코it
                    </button>
                </div>
            `);
        }
        
        function startFishingAtSpot(spotIndex) {
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const spotKey = location.id + '_spot' + spotIndex;
            
            // Kontrola limitu
            const limit = checkDailyActionLimit('fish', spotKey);
            if (!limit.canDo) {
                notifyWarning('Vy캜erp치no', 'Toto m칤sto je vy캜erpan칠!');
                closeModal();
                return;
            }
            
            // Pou쬴j limit pro tento konkr칠tn칤 spot
            useActionLimit('fish', spotKey);
            
            // Spus콘 ryba콏en칤 (pou쬴j existuj칤c칤 syst칠m)
            currentFishingSpot = spotIndex;
            closeModal();
            
            // Zahaj ryba콏en칤 s vlastn칤m callback
            startFishing();
        }
        
        function useActionLimit(actionType, locationId) {
            if (!state.world.actionLimits) state.world.actionLimits = {};
            const key = actionType + '_' + locationId;
            const now = Date.now();
            
            // Pokud neexistuje z치znam, vytvo콏 nov칳
            if (!state.world.actionLimits[key]) {
                state.world.actionLimits[key] = { count: 0, resetTime: now + 24 * 60 * 60 * 1000 };
            }
            
            state.world.actionLimits[key].count++;
        }
        
        function showActionModal(actionType) {
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // === FISH NA LOKAC칈CH SE SPOTY ===
            // Pokud je to ryba콏en칤 a lokace m치 v칤ce spot콢, zobraz v칳b캩r spot콢
            if (actionType === 'fish' && location && location.spots && location.spots > 1) {
                showFishingSpotsSelection(location);
                return;
            }
            
            // Kontrola zda u neprob칤h치 jin치 akce
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                const icons = { hunt: '游낓', mine: '久勇', fish: '游꿖', explore: '游댌', gather: '游빜', alchemy: '丘勇' };
                const names = { hunt: 'Lov', mine: 'T캩쬭a', fish: 'Rybolov', explore: 'Pr콢zkum', gather: 'Sb칤r치n칤', alchemy: 'Alchymie' };
                const currentType = state.currentAction.type;
                const remaining = Math.ceil((state.currentAction.endTime - Date.now()) / 1000);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                
                notifyWarning('Akce prob칤h치', `${icons[currentType]} ${names[currentType]} - zb칳v치 ${mins}:${String(secs).padStart(2, '0')}`);
                showActionProgressModal();
                return;
            }
            
            // Kontrola denn칤ho limitu pro akce na lokaci
            const limitedActions = ['hunt', 'mine', 'fish', 'explore', 'gather'];
            if (limitedActions.includes(actionType)) {
                const limit = checkDailyActionLimit(actionType, location.id);
                if (!limit.canDo) {
                    const hours = Math.floor(limit.resetIn / 3600000);
                    const mins = Math.floor((limit.resetIn % 3600000) / 60000);
                    notifyWarning('Denn칤 limit', `${actionType === 'hunt' ? 'Lov' : actionType === 'mine' ? 'T캩쬭a' : actionType === 'fish' ? 'Rybolov' : actionType === 'gather' ? 'Sb칤r치n칤' : 'Pr콢zkum'} zde u 3x vyu쬴t. Reset za ${hours}h ${mins}m`);
                    return;
                }
            }
            
            // V칳po캜et 캜asov칠ho modifik치toru podle skill콢 a po캜as칤
            const timeModifier = calculateActionTimeModifier(actionType);
            const weather = getCurrentWeather();
            
            const actions = {
                hunt: {
                    icon: '游낓',
                    name: 'Lov',
                    desc: 'Vydej se na lov divok칠 zv캩콏e v okol칤.',
                    baseTime: 5, // 5 minut
                    rewards: ['游꼤 Maso (j칤dlo)', '游붮 K콢쬰 (materi치l)', '游눯 Pen칤ze z prodeje'],
                    risks: ['丘덢잺 Nebezpe캜n치 zv캩콏 m콢쬰 za칰to캜it', '丘 Spot콏eba energie', '낌勇 Zabere 캜as'],
                    requirements: ['游낓 Lep코칤 zbra켿 = lep코칤 칰lovky', '游녜勇 Vn칤mavost pom치h치'],
                    tip: 'V les칤ch a u vody je v칤ce zv캩콏e. Nebezpe캜n칠 z칩ny maj칤 siln캩j코칤 (ale cenn캩j코칤) tvory.',
                    action: "startTimedAction('hunt')",
                    btnText: '游낓 Vydat se na lov',
                    btnColor: '#2E7D32'
                },
                mine: {
                    icon: '久勇',
                    name: 'T캩쬭a',
                    desc: 'Hledej suroviny v zemi a trosk치ch.',
                    baseTime: 4, // 4 minuty
                    rewards: ['游 K치men', '丘뙖잺 Kov', '游눑 Vz치cn칠 rudy (n캩kdy)'],
                    risks: ['游눩 Vy쬬duje s칤lu', '丘 Spot콏eba energie', '驕뮖잺 V n캩kter칳ch z칩n치ch radiace'],
                    requirements: ['久勇 Krump치캜 pom치h치', '游눩 S칤la = v칤ce surovin'],
                    tip: 'Hory a jeskyn캩 maj칤 nejlep코칤 v칳t캩쬹ost. V nebezpe캜n칳ch z칩n치ch m콢쬰코 naj칤t vz치cn칠 kovy.',
                    action: "startTimedAction('mine')",
                    btnText: '久勇 Za캜칤t t캩쬴t',
                    btnColor: '#5D4037'
                },
                fish: {
                    icon: '游꿖',
                    name: 'Rybolov',
                    desc: 'Chytej ryby v bl칤zk칠m vodn칤m zdroji.',
                    baseTime: 6, // 6 minut
                    rewards: ['游 Ryby (j칤dlo)', '九 Vz치cn칠 칰lovky', '游닍 Ob캜as n캩co zvl치코tn칤ho'],
                    risks: ['낌勇 Vy쬬duje trp캩livost', '游꺊勇 Po캜as칤 ovliv켿uje 칰lovky'],
                    requirements: ['游꿖 Prut pom치h치', '游 맚캩st칤 = lep코칤 칰lovky'],
                    tip: 'Jezero m치 nejv캩t코칤 ryby. Zlat치 rybka je velmi vz치cn치 - pr칳 spln칤 p콏치n칤!',
                    action: "startTimedAction('fish')",
                    btnText: '游꿖 Hodit udici',
                    btnColor: '#1565C0'
                },
                cook: {
                    icon: '游꼽',
                    name: 'Va콏en칤',
                    desc: 'P콏iprav j칤dlo z dostupn칳ch surovin.',
                    baseTime: 2, // 2 minuty
                    rewards: ['游꼤 Lep코칤 j칤dlo', '丘 Bonus energie', '仇벒잺 N캩kdy i l칠캜en칤'],
                    risks: ['游댠 Pot콏ebuje코 ohe켿/kuchy켿', '游닍 Spot콏eba surovin'],
                    requirements: ['游꼤 Maso, ryby, byliny', '游댠 Ohe켿 nebo kuchy켿'],
                    tip: 'Va콏en칠 j칤dlo d치v치 v칤c energie ne syrov칠. N캩kter칠 recepty d치vaj칤 speci치ln칤 bonusy.',
                    action: 'openCookingMenu()',
                    btnText: '游꼽 Otev콏칤t va콏en칤',
                    btnColor: '#E65100'
                },
                alchemy: {
                    icon: '丘勇',
                    name: 'Alchymie',
                    desc: 'M칤chej lektvary a l칠ky z bylin.',
                    baseTime: 7, // 7 minut
                    rewards: ['仇벒잺 L칠캜iv칠 lektvary', '驕뮖잺 Anti-radia캜n칤 l칠ky', '游눩 Do캜asn칠 bonusy'],
                    risks: ['游 Spot콏eba bylin', '丘勇 Pot콏eba alchym. sady'],
                    requirements: ['丘勇 Alchymistick치 sada', '游 Byliny', '游빍 Chemik치lie'],
                    tip: '캛칤m v칤ce bylin a chemik치li칤 m치코, t칤m lep코칤 lektvary vyrob칤코!',
                    action: "startTimedAction('alchemy')",
                    btnText: '丘勇 Za캜칤t m칤chat',
                    btnColor: '#6A1B9A'
                },
                explore: {
                    icon: '游댌',
                    name: 'Pr콢zkum',
                    desc: 'Prohledej lokaci a najdi skryt칠 v캩ci.',
                    baseTime: 5, // 5 minut
                    rewards: ['游닍 Loot a p콏edm캩ty', '游눯 Pen칤ze', '游딓勇 Kl칤캜e a vz치cnosti'],
                    risks: ['丘덢잺 M콢쬰코 narazit na nep콏치tele', '낌勇 Zabere 캜as'],
                    requirements: ['游녜勇 Vn칤mavost = v칤ce lootu', '游 맚캩st칤 pom치h치'],
                    tip: 'Ka쬯치 lokace m치 omezenou z치sobu lootu. N캩kter칠 maj칤 skryt칠 m칤stnosti!',
                    action: "startTimedAction('explore')",
                    btnText: '游댌 Prohledat',
                    btnColor: 'var(--rust)'
                },
                gather: {
                    icon: '游빜',
                    name: 'Sb칤r치n칤',
                    desc: 'Sb칤rej suroviny v okol칤.',
                    baseTime: 3, // 3 minuty
                    rewards: ['游뿯 K치men', '游 D콏evo', '游 Byliny', '游눑 Vz치cn칠 materi치ly'],
                    risks: ['丘 Spot콏eba energie', '낌勇 Zabere 캜as'],
                    requirements: ['游녜勇 Vn칤mavost pom치h치', '游눩 S칤la pro t캩쮄뫆 pr치ci'],
                    tip: 'Skalnat칠 oblasti d치vaj칤 k치men a rudy, lesy d콏evo a byliny. Vz치cn칠 materi치ly jsou bonus!',
                    action: "startTimedAction('gather')",
                    btnText: '游빜 Za캜칤t sb칤rat',
                    btnColor: '#4CAF50'
                },
                sleep: {
                    icon: '游띒勇',
                    name: 'Sp치nek',
                    desc: 'Odpo캜i켿 si a regeneruj energii v 칰krytu.',
                    baseTime: 0,
                    rewards: ['丘 Pln치 energie (100%)', '仇벒잺 Regenerace HP (+50%)', '丘 Okam쬴t칳 efekt'],
                    risks: ['游뛂 콯치dn치 rizika v 칰krytu'],
                    requirements: ['游 B칳t v 칰krytu'],
                    tip: 'Sp치nek v 칰krytu je okam쬴t칳 a bez vedlej코칤ch efekt콢. Spac치k venku trv치 1 hodinu.',
                    action: "startSleep()",
                    btnText: '游띒勇 J칤t sp치t',
                    btnColor: '#3949AB'
                },
            };
            
            const a = actions[actionType];
            if (!a) return;
            
            // Vypo캜칤tej skute캜n칳 캜as akce
            let actualTime = a.baseTime || 0;
            if (actualTime > 0) {
                actualTime = Math.max(1, Math.round(actualTime * timeModifier));
            }
            
            let html = '<div style="text-align: left;">';
            html += '<p style="color: #aaa; margin-bottom: 1rem;">' + a.desc + '</p>';
            
            // Zobraz 캜as akce
            if (actualTime > 0) {
                let timeColor = '#8bc34a';
                let timeNote = '';
                if (timeModifier > 1.2) {
                    timeColor = '#ff9800';
                    timeNote = ' (zpomaleno)';
                } else if (timeModifier < 0.8) {
                    timeColor = '#4caf50';
                    timeNote = ' (zrychleno)';
                }
                
                html += '<div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">';
                html += '<span>낌勇 ' + ('Doba trv치n칤:') + '</span>';
                html += '<span style="color: ' + timeColor + '; font-weight: bold;">' + actualTime + ' min' + timeNote + '</span>';
                html += '</div>';
                
                // Po캜as칤 info
                if (weather && weather.id !== 'clear') {
                    let weatherEffect = '';
                    if (weather.id === 'rain') weatherEffect = 'D칠코콘 zpomaluje akce';
                    else if (weather.id === 'fog') weatherEffect = 'Mlha zt캩쬿je pr콢zkum';
                    else if (weather.id === 'radstorm') weatherEffect = '驕뮖잺 Radia캜n칤 bou콏e!';
                    else if (weather.id === 'storm') weatherEffect = 'Bou콏ka zpomaluje v코e';
                    
                    if (weatherEffect) {
                        html += '<div style="background: #2a2a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem;">';
                        html += '<span style="color: #ff9800;">' + weather.icon + ' ' + weatherEffect + '</span>';
                        html += '</div>';
                    }
                }
            }
            
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">';
            
            html += '<div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d4a2d;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">九 ' + ('Odm캩ny') + '</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            a.rewards.forEach(r => html += '<li>' + r + '</li>');
            html += '</ul></div>';
            
            html += '<div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #4a2d2d;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #c62828; font-size: 0.9rem;">丘멆잺 ' + ('Rizika') + '</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            a.risks.forEach(r => html += '<li>' + r + '</li>');
            html += '</ul></div>';
            
            html += '</div>';
            
            html += '<div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-bottom: 1rem;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.9rem;">游늶 ' + ('Po쬬davky') + '</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            a.requirements.forEach(r => html += '<li>' + r + '</li>');
            html += '</ul></div>';
            
            html += '<div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #4a4a2d; margin-bottom: 1rem;">';
            html += '<p style="margin: 0; font-size: 0.85rem;"><span style="color: #ffd700;">游눠 Tip:</span> <span style="color: #aaa;">' + a.tip + '</span></p>';
            html += '</div>';
            
            // Zobraz zb칳vaj칤c칤 pokusy pro limitovan칠 akce (limitedActions definovan칠 na za캜치tku funkce)
            if (limitedActions.includes(actionType)) {
                const limit = checkDailyActionLimit(actionType, location.id);
                html += '<div style="text-align: center; margin-bottom: 0.5rem; font-size: 0.85rem; color: ' + (limit.remaining > 1 ? '#8bc34a' : '#ff9800') + ';">';
                html += '游늵 Zb칳v치: ' + limit.remaining + '/3 dnes na t칠to lokaci';
                html += '</div>';
            }
            
            html += '<div style="display: flex; gap: 0.5rem;">';
            html += '<button class="btn" onclick="closeModal()" style="flex: 1; background: #333;">仇 Zav콏칤t</button>';
            html += '<button class="btn" onclick="closeModal(); setTimeout(() => { ' + a.action + ' }, 50);" style="flex: 2; background: ' + a.btnColor + ';">' + a.btnText + '</button>';
            html += '</div>';
            html += '</div>';
            
            showModal(a.icon + ' ' + a.name, html);
        }
        
        // NPC na aktu치ln칤 lokaci
        function renderLocationNPCs(location) {
            let html = '';
            const npcsHere = [];
            
            // Kontrola NPC podle lokace
            if (typeof STORY_NPCS !== 'undefined') {
                for (const [npcId, npc] of Object.entries(STORY_NPCS)) {
                    // NPC je na t칠to lokaci?
                    if (npc.location === location.id) {
                        // V콢dce p콏e쬴v코칤ch jen po dokon캜en칤 p콏칤b캩hu
                        if (npcId === 'survivor_leader' && !state.mainQuest?.storyComplete) continue;
                        
                        // Gener치l jen pokud m치me spr치vn칳 quest
                        if (npcId === 'general' && state.mainQuest?.currentQuest !== 'find_general') continue;
                        
                        npcsHere.push({ id: npcId, ...npc });
                    }
                }
            }
            
            if (npcsHere.length > 0) {
                html += '<div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid var(--metal-light);">';
                html += '<h4 style="margin: 0 0 0.5rem 0; color: #9C27B0;">游논 Postavy</h4>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                npcsHere.forEach(npc => {
                    html += '<button class="btn" onclick="talkToNPC(\'' + npc.id + '\')" style="background: #6A1B9A; padding: 0.5rem 1rem;">' + npc.icon + ' ' + npc.name + '</button>';
                });
                html += '</div></div>';
            }
            
            return html;
        }
        
        // Bonus hrdiny
        function renderHeroBonus() {
            const cls = CLASSES[state.char.classId];
            if (!cls) return '';
            
            let html = '<div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid var(--metal-light);">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: var(--warning-yellow);">救 ' + cls.name + '</h4>';
            html += '<p style="margin: 0; font-size: 0.8rem; color: #888;">' + (cls.passive || cls.desc || '') + '</p>';
            
            // Speci치ln칤 schopnost cooldown
            const now = Date.now();
            const lastUsed = state.char.abilityLastUsed || 0;
            const cooldown = 300000; // 5 minut
            const remaining = Math.max(0, cooldown - (now - lastUsed));
            
            if (remaining > 0) {
                html += '<p style="margin: 0.3rem 0 0 0; font-size: 0.75rem; color: #666;">Schopnost: ' + Math.ceil(remaining / 1000) + 's</p>';
            } else {
                html += '<button class="btn" onclick="useClassAbility()" style="margin-top: 0.5rem; background: var(--warning-yellow); color: #000; font-size: 0.75rem;">丘 ' + (cls.ability || 'Schopnost') + '</button>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Rychl칳 p콏esun z mapy na lokaci
        // === N츼HLED LOKACE ===
        function showLocationPreview(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            if (!loc) return;
            
            // Pokud lokace nen칤 zn치m치, zobraz jen z치kladn칤 info s mo쬹ost칤 cestovat
            const isVisited = state.world.visitedLocations?.includes(loc.id);
            const isRevealed = state.world.revealedLocations?.includes(loc.id);
            const isKnown = isVisited || isRevealed;
            
            // Zjisti jestli je lokace dostupn치 (m치 p콏칤mou cestu)
            const hasPath = WORLD_PATHS.some(p => 
                (p.from === state.world.currentLocation && p.to === loc.id) || 
                (p.to === state.world.currentLocation && p.from === loc.id)
            );
            
            // Pro nezn치m칠 lokace bez p콏칤m칠 cesty - jen koordin치ty
            if (!isKnown && !hasPath) {
                showCoordsInfo(loc.x, loc.y, '??? Nezn치m치 lokace');
                return;
            }
            
            // Pro nezn치m칠 ale dostupn칠 lokace - pou쬴j quickTravel (m치 vlastn칤 modal)
            if (!isKnown && hasPath) {
                quickTravel(locId);
                return;
            }
            
            // Zjisti co lze na lokaci d캩lat
            let activities = [];
            
            // Z치kladn칤 akce podle typu
            if (loc.type === 'explore' || loc.type === 'dangerous') {
                activities.push({ icon: '游댌', name: 'Pr콢zkum', desc: 'Hledej p콏edm캩ty a suroviny' });
            }
            if (loc.type === 'water' || loc.id?.includes('lake') || loc.id?.includes('river') || loc.id?.includes('pond') || loc.actions?.includes('fish')) {
                activities.push({ icon: '游꿖', name: 'Ryba콏en칤', desc: 'Chytej ryby' });
            }
            if (loc.type === 'water' || loc.id?.includes('lake') || loc.id?.includes('river') || loc.resource === 'water') {
                activities.push({ icon: '游눦', name: 'Sb캩r vody', desc: 'Napl켿 l치hve vodou' });
            }
            if (loc.type === 'forest' || loc.id?.includes('forest') || loc.id?.includes('grove')) {
                activities.push({ icon: '游뿝', name: 'T캩쬭a d콏eva', desc: 'Sb칤rej d콏evo' });
                activities.push({ icon: '游낓', name: 'Lov', desc: 'Lov zv캩콏e' });
                activities.push({ icon: '游', name: 'Sb캩r bylin', desc: 'Sb칤rej l칠캜iv칠 rostliny' });
            }
            if (loc.type === 'mine' || loc.id?.includes('mine') || loc.id?.includes('quarry')) {
                activities.push({ icon: '久勇', name: 'T캩쬭a', desc: 'T캩 k치men a rudu' });
            }
            if (loc.type === 'dungeon') {
                activities.push({ icon: '游낋', name: 'Dungeon', desc: 'Prozkoumej podzem칤 (mus칤코 b칳t na m칤st캩)' });
            }
            if (loc.type === 'npc' || loc.type === 'trader' || loc.type === 'faction') {
                activities.push({ icon: '游딖勇', name: 'NPC', desc: 'Mluv s postavami' });
                activities.push({ icon: '游', name: 'Obchod', desc: 'Nakupuj a prod치vej' });
            }
            if (loc.type === 'medical' || loc.id?.includes('hospital')) {
                activities.push({ icon: '游눍', name: 'L칠k치rna', desc: 'Najdi l칠ky a obvazy' });
            }
            if (loc.type === 'gas_station' || loc.id?.includes('gas')) {
                activities.push({ icon: '久', name: 'Palivo', desc: 'Seber palivo' });
            }
            if (loc.type === 'hostile') {
                activities.push({ icon: '丘덢잺', name: 'Boj', desc: 'Bojuj s nep콏치teli' });
                activities.push({ icon: '游눯', name: 'Loot', desc: 'Z칤skej ko콏ist' });
            }
            
            // Speci치ln칤 suroviny
            if (loc.zone === 'danger' || loc.zone === 'deadly') {
                activities.push({ icon: '驕勇', name: 'Vz치cn칠 suroviny', desc: 'Elektronika, chemie, palivo' });
            }
            
            // Nep콏치tel칠
            let enemiesHtml = '';
            if (loc.enemies && loc.enemies.length > 0) {
                const enemyList = loc.enemies.slice(0, 4).map(eId => {
                    const e = ENEMIES.find(en => en.id === eId);
                    return e ? e.icon : '?';
                }).join(' ');
                enemiesHtml = `
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #8B0000;">
                        <span style="color: #f44336;">丘덢잺 Nep콏치tel칠:</span> ${enemyList}
                    </div>
                `;
            }
            
            // Z칩na
            const zoneInfo = {
                'safe': { color: '#4CAF50', name: '游릭 Bezpe캜n치 z칩na' },
                'medium': { color: '#FF9800', name: '游리 St콏edn칤 riziko' },
                'danger': { color: '#f44336', name: '游댮 Nebezpe캜n치 z칩na' },
                'deadly': { color: '#9C27B0', name: '游 Smrteln치 z칩na' }
            };
            const zone = zoneInfo[loc.zone] || zoneInfo['medium'];
            
            // Najdi cestu a vzd치lenost
            const path = WORLD_PATHS.find(p => 
                (p.from === state.world.currentLocation && p.to === locId) || 
                (p.to === state.world.currentLocation && p.from === locId)
            );
            
            // Sv캩tov치 strana
            const directionInfo = getDirectionToLocation(locId);
            
            let distance = '?';
            let travelTime = '?';
            
            if (path) {
                distance = path.distance + ' km';
                travelTime = path.time;
                
                // Aplikuj po캜as칤
                const weather = getCurrentWeather();
                const weatherMod = weather?.effect?.speedMod || 1.0;
                if (weatherMod !== 1.0) {
                    travelTime = Math.ceil(travelTime / weatherMod);
                }
                
                travelTime = travelTime + ' min';
            } else {
                // Nen칤 p콏칤m치 cesta - spo캜칤tej Manhattan distance jako odhad
                const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
                if (currentLoc) {
                    const manhattanDist = Math.abs(loc.x - currentLoc.x) + Math.abs(loc.y - currentLoc.y);
                    distance = 'cca ' + manhattanDist + ' pol칤';
                    travelTime = ''; // Nezobrazovat - uk치쬰 se v travel modalu
                }
            }
            
            showModal(`${loc.icon} ${loc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${loc.icon}</div>
                    <div style="background: #0a0a0a; padding: 0.3rem 0.8rem; border-radius: 6px; display: inline-block; margin: 0.3rem 0; border: 1px solid #333;">
                        <span style="color: #8bc34a; font-family: monospace; font-size: 0.9rem;">游늸 [${loc.x}, ${loc.y}]</span>
                    </div>
                    <div style="color: ${zone.color}; font-size: 0.8rem; margin-top: 0.3rem;">${zone.name}</div>
                    <div style="color: #888; font-size: 0.8rem; margin-top: 0.2rem;">${directionInfo.arrow} ${directionInfo.distance} pol칤</div>
                    <p style="color: #888; font-size: 0.85rem; margin: 0.5rem 0;">${loc.desc || ''}</p>
                    ${loc.radiation ? `<div style="color: #ff9800;">驕뮖잺 Radiace: ${loc.radiation}/min</div>` : ''}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">游늶 Aktivity:</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem;">
                        ${activities.length > 0 ? activities.map(a => `
                            <div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center;">
                                <div style="font-size: 1.2rem;">${a.icon}</div>
                                <div style="font-size: 0.7rem; color: #aaa;">${a.name}</div>
                            </div>
                        `).join('') : '<div style="color: #555; grid-column: span 2; text-align: center;">콯치dn칠 speci치ln칤 aktivity</div>'}
                    </div>
                    ${enemiesHtml}
                </div>
                
                <div style="display: flex; justify-content: space-between; color: #888; font-size: 0.8rem; margin-bottom: 1rem;">
                    <span>游늸 Vzd치lenost: ${distance}</span>
                    ${travelTime ? `<span>낌勇 Cesta: ${travelTime}</span>` : ''}
                </div>
                
                ${loc.type === 'dungeon' ? `
                    <div style="background: #2a1a3a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.8rem; border: 1px solid #6A1B9A;">
                        <p style="color: #ce93d8; font-size: 0.85rem; margin: 0; text-align: center;">
                            游낋 <strong>Dungeon</strong> - nejd콏칤v sem doputuj, pak m콢쬰코 vstoupit!
                        </p>
                    </div>
                ` : ''}
                
                ${hasPath ? `
                    <button class="btn" onclick="closeModal(); quickTravel('${loc.id}')" style="width: 100%; background: var(--toxic-dark);">
                        游뛌 ${t('ui', 'travel')}
                    </button>
                ` : `
                    <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.8rem; border: 1px solid #ff9800;">
                        <p style="color: #ff9800; font-size: 0.85rem; margin: 0; text-align: center;">
                            丘멆잺 Nen칤 p콏칤m치 cesta - mus칤코 j칤t p콏es bli쮄뫆 lokace
                        </p>
                    </div>
                `}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    九 ${t('ui', 'close')}
                </button>
            `);
        }
        
        // === ZOBRAZEN칈 SOU콎ADNIC PRO MOBIL ===
        // P콏i kliknut칤 na pole zobraz칤 jeho sou콏adnice
        function showCoordsInfo(x, y, name = '???') {
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            let distanceInfo = '';
            let navigationButton = '';
            
            if (currentLoc) {
                const dx = x - currentLoc.x;
                const dy = y - currentLoc.y;
                const manhattanDist = Math.abs(dx) + Math.abs(dy);
                
                // Sm캩r
                let direction = '';
                if (dy < 0) direction += 'S';
                if (dy > 0) direction += 'J';
                if (dx > 0) direction += 'V';
                if (dx < 0) direction += 'Z';
                
                distanceInfo = `
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="color: #888; font-size: 0.75rem;">Vzd치lenost</div>
                                <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${manhattanDist} pol칤</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.75rem;">Sm캩r</div>
                                <div style="color: #4FC3F7; font-size: 1.2rem; font-weight: bold;">${direction || '游늸'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Najdi nejbli쮄뫆 dostupnou lokaci sm캩rem k c칤li
                const availablePaths = WORLD_PATHS.filter(p => 
                    p.from === state.world.currentLocation || p.to === state.world.currentLocation
                );
                
                let bestNext = null;
                let bestScore = Infinity;
                
                availablePaths.forEach(path => {
                    const nextLocId = path.from === state.world.currentLocation ? path.to : path.from;
                    const nextLoc = WORLD_LOCATIONS.find(l => l.id === nextLocId);
                    if (nextLoc) {
                        // Vzd치lenost od dal코칤 lokace k c칤li
                        const distToTarget = Math.abs(nextLoc.x - x) + Math.abs(nextLoc.y - y);
                        if (distToTarget < bestScore) {
                            bestScore = distToTarget;
                            bestNext = nextLoc;
                        }
                    }
                });
                
                if (bestNext && bestScore < manhattanDist) {
                    const isKnown = state.world.visitedLocations?.includes(bestNext.id) || 
                                   state.world.revealedLocations?.includes(bestNext.id);
                    navigationButton = `
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem; border: 1px solid #4caf50;">
                            <p style="color: #8bc34a; font-size: 0.85rem; margin: 0 0 0.5rem 0;">
                                游빐 Nejbli쮄뫆 cesta t칤mto sm캩rem:
                            </p>
                            <button class="btn" onclick="closeModal(); quickTravel('${bestNext.id}')" style="width: 100%; background: var(--toxic-dark);">
                                ${isKnown ? bestNext.icon : '仇'} ${isKnown ? bestNext.name : 'Nezn치m치 lokace'} [${bestNext.x}, ${bestNext.y}]
                            </button>
                        </div>
                    `;
                }
            }
            
            showModal('游늸 Sou콏adnice', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">游딬勇</div>
                    <div style="background: #0d1a0d; padding: 1rem; border-radius: 10px; border: 2px solid #4CAF50; margin: 1rem 0;">
                        <div style="color: #8bc34a; font-family: monospace; font-size: 2rem; font-weight: bold;">
                            [${x}, ${y}]
                        </div>
                    </div>
                    <p style="color: #888; font-size: 0.9rem;">${name}</p>
                    ${distanceInfo}
                    ${navigationButton}
                    <p style="color: #555; font-size: 0.75rem; margin-top: 1rem;">
                        游눠 X = v칳chod/z치pad, Y = sever/jih<br>
                        Z치porn칠 Y = sever, Kladn칠 Y = jih
                    </p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">九 OK</button>
            `);
        }
        
        function quickTravel(targetId) {
            if (state.world.traveling) {
                notifyWarning('Nelze', 'U cestuje코!');
                return;
            }
            if (targetId === state.world.currentLocation) return;
            
            const target = WORLD_LOCATIONS.find(l => l.id === targetId);
            const current = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!target || !current) return;
            
            const isVisited = state.world.visitedLocations.includes(targetId);
            
            // Najdi cestu (p콏칤mou)
            const path = WORLD_PATHS.find(p => 
                (p.from === state.world.currentLocation && p.to === targetId) || 
                (p.to === state.world.currentLocation && p.from === targetId)
            );
            
            if (path) {
                const dangerColor = ['#4CAF50', '#8BC34A', '#FF9800', '#f44336', '#9C27B0'][path.danger] || '#888';
                
                // Z칤skej po캜as칤
                const weather = getCurrentWeather();
                let weatherMod = weather?.effect?.speedMod || 1.0;
                
                // P콏epo캜ti 캜as s vozidlem a po캜as칤m
                let travelTime = path.time;
                let vehicleInfo = '';
                let weatherInfo = '';
                let npcBonusInfo = '';
                
                // NPC bonusy jsou n칤쬰 v sekci "POSEL JIN BONUSY"
                let travelBonus = 1.0;
                
                // Nom치d class bonus - 50% rychlej코칤 cestov치n칤
                let nomadBonusInfo = '';
                if (hasClassPassive('travelSpeedBonus')) {
                    const nomadSpeedBonus = getClassPassiveValue('travelSpeedBonus') || 0;
                    travelBonus -= nomadSpeedBonus; // -50%
                    nomadBonusInfo = `<p style="color: #8d6e63;">游끺勇 Nom치d: -${Math.round(nomadSpeedBonus * 100)}% 캜as</p>`;
                }
                
                // === SKILLS BONUSY ===
                let skillsBonusInfo = '';
                
                // Debug log pro skills
                console.log('游뛌 Travel skills:', {
                    agi: state.char.attrs?.agi,
                    pathfinder: state.skillTree?.exploration?.pathfinder || state.skills?.['pathfinder'],
                    fast_travel: state.skillTree?.exploration?.fast_travel || state.skills?.['fast_travel'],
                    skillTree: state.skillTree,
                    oldSkills: state.skills
                });
                
                // Zobraz sekci bonus콢 v쬯y, i kdy jsou pr치zdn칠
                let hasSomeBonus = false;
                
                // AGILITY BONUS - ka쬯칳 bod AGI nad 5 = -2% 캜as cestov치n칤
                const agiBonus = Math.max(0, (state.char.attrs?.agi || 5) - 5) * 0.02;
                if (agiBonus > 0) {
                    travelBonus -= agiBonus;
                    skillsBonusInfo += `<p style="color: #64b5f6;">游끢 Obratnost (${state.char.attrs?.agi || 5}): -${Math.round(agiBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // pathfinder skill - Pr콢zkumn칤k (-3% per level) - je ve SKILL_TREE v캩tvi EXPLORATION
                const pathfinderLevel = state.skillTree?.exploration?.pathfinder || state.skills?.['pathfinder'] || 0;
                if (pathfinderLevel > 0) {
                    const pathfinderBonus = pathfinderLevel * 0.03;
                    travelBonus -= pathfinderBonus;
                    skillsBonusInfo += `<p style="color: #64b5f6;">游녺 Pr콢zkumn칤k (${pathfinderLevel}): -${Math.round(pathfinderBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // fast_travel skill - Rychl칳 pochod (-5% per level) - pokud existuje
                const fastTravelLevel = state.skillTree?.exploration?.fast_travel || state.skillTree?.survival?.fast_travel || state.skills?.['fast_travel'] || 0;
                if (fastTravelLevel > 0) {
                    const fastTravelBonus = fastTravelLevel * 0.05;
                    travelBonus -= fastTravelBonus;
                    skillsBonusInfo += `<p style="color: #64b5f6;">游끢 Rychl칳 pochod (${fastTravelLevel}): -${Math.round(fastTravelBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // Kompas bonus
                const hasCompass = state.inv?.some(i => i.id === 'compass' || i.bonus === 'navigation');
                if (hasCompass) {
                    travelBonus -= 0.015;
                    skillsBonusInfo += `<p style="color: #ffb74d;">游빐 Kompas: -1.5%</p>`;
                    hasSomeBonus = true;
                }
                
                // Companion skills bonus (Stopa콏/pathfinder atd.)
                const companionTravelBonus = getCompanionTravelSpeedBonus();
                if (companionTravelBonus > 0) {
                    travelBonus -= companionTravelBonus;
                    skillsBonusInfo += `<p style="color: #81c784;">游 Spole캜n칤k: -${Math.round(companionTravelBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // Boots speed bonus (Turistick칠 boty +10%, Exo boty +20%)
                const armorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : { speedBonus: 0 };
                if (armorEffects.speedBonus > 0) {
                    travelBonus -= armorEffects.speedBonus;
                    const bootsName = state.equipped?.boots?.name || 'Boty';
                    skillsBonusInfo += `<p style="color: #2196f3;">游녹 ${bootsName}: -${Math.round(armorEffects.speedBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                } else if (state.equipped?.boots && state.equipped.boots.special) {
                    // Zobraz boty i kdy nemaj칤 speed bonus (ale maj칤 jin칳 efekt)
                    const bootsSpecialNames = {
                        'dodge_bonus': '游눧 +10% 칰hyb',
                        'stealth_move': '游봉 -20% p콏epaden칤',
                        'run_bonus': '游끢 +15% 칰t캩k',
                        'stomp': '游붰 +8 damage',
                        'jump': '游붖 +25% dodge',
                        'warm_feet': '仇勇 -15% energie',
                        'combat_stance': '丘덢잺 +5% krit',
                        'sturdy': '游댢 +2 DEF',
                        'exo': '游 +50% nosnost'
                    };
                    const effectName = bootsSpecialNames[state.equipped.boots.special] || state.equipped.boots.special;
                    skillsBonusInfo += `<p style="color: #9e9e9e;">游녹 ${state.equipped.boots.name}: ${effectName} <span style="font-size: 0.8rem;">(ne rychlost)</span></p>`;
                }
                
                // Mutace bonusy pro cestov치n칤
                const mutBonuses = getMutationBonuses();
                if (mutBonuses.travelSpeed > 0) {
                    travelBonus -= mutBonuses.travelSpeed;
                    skillsBonusInfo += `<p style="color: #9c27b0;">丘 Rychl칳 metabolismus: -${Math.round(mutBonuses.travelSpeed * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                if (mutBonuses.speed < 0) {
                    travelBonus -= mutBonuses.speed; // speed je z치porn칳, tak쬰 -= -0.2 = +0.2
                    skillsBonusInfo += `<p style="color: #f44336;">游붮 콯elezn칠 kosti: +${Math.round(Math.abs(mutBonuses.speed) * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // === POSEL JIN BONUSY ===
                // Rychl칠 cesty (trust 50+) = -5%
                if (state.secrets?.includes('jin_fast_routes')) {
                    travelBonus -= 0.05;
                    skillsBonusInfo += `<p style="color: #00bcd4;">游끢 Rychl칠 cesty (Jin): -5%</p>`;
                    hasSomeBonus = true;
                }
                // Tajn칠 zkratky (trust 100) = -10%
                if (state.secrets?.includes('jin_secret_shortcuts')) {
                    travelBonus -= 0.10;
                    skillsBonusInfo += `<p style="color: #4caf50;">游딬勇 Tajn칠 zkratky (Jin): -10%</p>`;
                    hasSomeBonus = true;
                }
                // P칠콘a temporary bonus
                if (state.secretPathExpires && Date.now() < state.secretPathExpires) {
                    travelBonus -= 0.25;
                    const remainingMs = state.secretPathExpires - Date.now();
                    const remainingMin = Math.ceil(remainingMs / 60000);
                    skillsBonusInfo += `<p style="color: #e91e63;">游꿢 P칠콘ovy zkratky: -25% (${remainingMin} min)</p>`;
                    hasSomeBonus = true;
                }
                
                // Pokud nejsou 쮂멳n칠 bonusy, zobraz info
                if (!hasSomeBonus) {
                    skillsBonusInfo = `<p style="color: #666; font-size: 0.8rem;">游눠 Tip: Zvy코 Obratnost nebo nau캜 se skill Pr콢zkumn칤k pro rychlej코칤 cestov치n칤</p>`;
                }
                
                // === V칗PO캛ET FIN츼LN칈HO 캛ASU ===
                // 1. Z치klad
                const baseTime = path.time;
                let finalTime = baseTime;
                
                // 2. Aplikuj po캜as칤 PRVN칈 (zpomalen칤/zrychlen칤)
                let weatherAddedTime = 0;
                if (weatherMod !== 1.0) {
                    const weatherTime = Math.ceil(baseTime / weatherMod);
                    weatherAddedTime = weatherTime - baseTime;
                    finalTime = weatherTime;
                    if (weatherAddedTime > 0) {
                        weatherInfo = '<p style="color: #ff9800;">' + weather.icon + ' ' + weather.name + ': +' + weatherAddedTime + ' min</p>';
                    } else if (weatherAddedTime < 0) {
                        weatherInfo = '<p style="color: #8bc34a;">' + weather.icon + ' ' + weather.name + ': ' + weatherAddedTime + ' min</p>';
                    }
                }
                
                // 2.5 Aplikuj zpomalen칤 z nemoc칤 a zran캩n칤
                let healthPenalty = 1.0;
                let healthPenaltyInfo = '';
                
                // Nemoci zpomaluj칤
                if (typeof getDiseaseModifiers === 'function') {
                    const diseaseMods = getDiseaseModifiers();
                    if (diseaseMods.speedMod < 1.0) {
                        healthPenalty *= diseaseMods.speedMod;
                    }
                }
                
                // Zran캩n칤 zpomaluj칤
                if (typeof getInjuryModifiers === 'function') {
                    const injuryMods = getInjuryModifiers();
                    if (injuryMods.speedMod < 1.0) {
                        healthPenalty *= injuryMods.speedMod;
                    }
                }
                
                if (healthPenalty < 1.0) {
                    const timeBeforeHealth = finalTime;
                    finalTime = Math.ceil(finalTime / healthPenalty); // Zpomalen칤 = d캩len칤
                    const addedHealthTime = finalTime - timeBeforeHealth;
                    if (addedHealthTime > 0) {
                        healthPenaltyInfo = '<p style="color: #f44336;">游뱃 Zpomalen칤 (nemoc/zran캩n칤): +' + addedHealthTime + ' min</p>';
                    }
                }
                
                // 3. Aplikuj bonusy na 캜as PO po캜as칤 a zdravotn칤ch posti쬰n칤ch
                let savedTime = 0;
                if (travelBonus < 1.0) {
                    const timeBeforeBonuses = finalTime;
                    finalTime = Math.max(1, Math.ceil(finalTime * Math.max(0.1, travelBonus)));
                    savedTime = timeBeforeBonuses - finalTime;
                    npcBonusInfo = '<p style="color: #8bc34a; font-weight: bold;">낌勇 Celkem: ' + finalTime + ' min (칰spora ' + savedTime + ' min)</p>';
                }
                
                // Pou쬴j fin치ln칤 캜as
                travelTime = finalTime;
                
                let dangerWarning = '';
                let travelFunction = 'startTravel';
                let buttonText = '游뛌 Vyrazit';
                let buttonColor = 'var(--rust)';
                
                const travelTexts = {
                    unexplored: 'Neprozkouman치 oblast', unknown: 'Nev칤코, co t캩 tam 캜ek치...',
                    distance: 'Vzd치lenost', time: '캛as', danger: 'Nebezpe캜칤?', unknownDanger: 'Nezn치m칠',
                    dangerWarn: 'NEBEZPE캛N츼 CESTA!', goDanger: 'J칤t (nebezpe캜n칠!)', cancel: 'Zru코it',
                    safe: 'Bezpe캜n칠', noPath: 'Nen칤 p콏칤m치 cesta!', needOther: 'Mus칤코 j칤t p콏es jin칠 lokace.'
                };
                
                if (path.danger >= 3) {
                    dangerWarning = '<p style="color: #f44336; font-weight: bold;">丘멆잺 ' + travelTexts.dangerWarn + '</p>';
                    travelFunction = 'confirmTravel'; // P콏esko캜it druh칳 modal
                    buttonText = '丘덢잺 ' + travelTexts.goDanger;
                    buttonColor = '#8B0000';
                }
                
                // Pokud lokace NEN칈 nav코t칤ven치, skryj detaily
                if (!isVisited) {
                    showModal('游딬勇 Nezn치m치 lokace', 
                        '<div style="text-align: center;">' +
                        '<div style="font-size: 3rem; margin: 0.5rem 0;">仇</div>' +
                        '<h3 style="margin: 0.3rem 0; color: #888;">' + travelTexts.unexplored + '</h3>' +
                        '<p style="color: #666; font-size: 0.85rem;">' + travelTexts.unknown + '</p>' +
                        '<div style="background: #0a0a0a; padding: 0.4rem 0.8rem; border-radius: 6px; display: inline-block; margin: 0.5rem 0; border: 1px solid #333;">' +
                        '<span style="color: #8bc34a; font-family: monospace; font-size: 0.9rem;">游늸 [' + target.x + ', ' + target.y + ']</span>' +
                        '</div>' +
                        '<p style="color: #888;">' + travelTexts.distance + ': ' + path.distance + ' km</p>' +
                        '<p style="color: #888;">낌勇 Z치klad: ' + path.time + ' min</p>' +
                        weatherInfo +
                        nomadBonusInfo +
                        skillsBonusInfo +
                        npcBonusInfo +
                        vehicleInfo +
                        '<p style="color: ' + dangerColor + ';">' + (path.danger > 0 ? '丘멆잺'.repeat(path.danger) + ' ' + travelTexts.danger : '? ' + travelTexts.unknownDanger) + '</p>' +
                        dangerWarning +
                        '</div>' +
                        '<button class="btn" onclick="' + travelFunction + '(\'' + targetId + '\')" style="width: 100%; margin-top: 1rem; background: ' + buttonColor + ';">' + buttonText + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 ' + travelTexts.cancel + '</button>'
                    );
                } else {
                    // Nav코t칤ven치 lokace - zobraz v코echny info
                    showModal('游딬勇 Cestovat?', 
                        '<div style="text-align: center;">' +
                        '<div style="font-size: 3rem; margin: 0.5rem 0;">' + target.icon + '</div>' +
                        '<h3 style="margin: 0.3rem 0;">' + target.name + '</h3>' +
                        '<div style="background: #0a0a0a; padding: 0.3rem 0.6rem; border-radius: 4px; display: inline-block; margin: 0.3rem 0; border: 1px solid #333;">' +
                        '<span style="color: #8bc34a; font-family: monospace; font-size: 0.8rem;">游늸 [' + target.x + ', ' + target.y + ']</span>' +
                        '</div>' +
                        '<p style="color: #888;">' + travelTexts.distance + ': ' + path.distance + ' km</p>' +
                        '<p style="color: #888;">낌勇 Z치klad: ' + path.time + ' min</p>' +
                        weatherInfo +
                        healthPenaltyInfo +
                        nomadBonusInfo +
                        skillsBonusInfo +
                        npcBonusInfo +
                        vehicleInfo +
                        '<p style="color: ' + dangerColor + ';">' + (path.danger > 0 ? '丘멆잺'.repeat(path.danger) + ' ' + travelTexts.danger.replace('?','') : '九 ' + travelTexts.safe) + '</p>' +
                        dangerWarning +
                        // Varov치n칤 o nemocech
                        (typeof getActiveDiseases === 'function' && getActiveDiseases().length > 0 ? 
                            '<div style="background: #3a1a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #f44336;">' +
                            '<p style="color: #f44336; margin: 0; font-size: 0.85rem;">游 Aktivn칤 nemoci: ' + getActiveDiseases().map(d => d.icon + ' ' + d.name).join(', ') + '</p>' +
                            '<p style="color: #888; margin: 0.2rem 0 0 0; font-size: 0.75rem;">' + (getDiseaseModifiers().speedMod < 1 ? '游냑 Rychlost: ' + Math.round(getDiseaseModifiers().speedMod * 100) + '%' : '') + (getDiseaseModifiers().hpDrain ? ' | 游눖 HP drain aktivn칤' : '') + '</p>' +
                            '</div>' : '') +
                        // Varov치n칤 o zran캩n칤ch
                        (typeof getActiveInjuries === 'function' && getActiveInjuries().length > 0 ? 
                            '<div style="background: #3a2a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #ff9800;">' +
                            '<p style="color: #ff9800; margin: 0; font-size: 0.85rem;">游뽗 Aktivn칤 zran캩n칤: ' + getActiveInjuries().map(i => i.icon + ' ' + i.name).join(', ') + '</p>' +
                            '<p style="color: #888; margin: 0.2rem 0 0 0; font-size: 0.75rem;">' + (typeof getInjuryModifiers === 'function' && getInjuryModifiers().speedMod < 1 ? '游냑 Rychlost: ' + Math.round(getInjuryModifiers().speedMod * 100) + '%' : '') + (typeof getInjuryModifiers === 'function' && getInjuryModifiers().damageMod < 1 ? ' | 丘덢잺 Damage: ' + Math.round(getInjuryModifiers().damageMod * 100) + '%' : '') + '</p>' +
                            '</div>' : '') +
                        // Riziko zran캩n칤 na nebezpe캜n칠 cest캩
                        (path.danger >= 2 ? 
                            '<div style="background: #2a1a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #c62828;">' +
                            '<p style="color: #c62828; margin: 0; font-size: 0.85rem;">丘멆잺 Nebezpe캜n칳 ter칠n - riziko: 游릮 mod콏ina, 游붰 v칳ron' + (path.danger >= 3 ? ', 游땰 vy캜erp치n칤' : '') + (path.danger >= 4 ? ', 游붮 zlomenina!' : '') + '</p>' +
                            '</div>' : '') +
                        // Varov치n칤 o po캜as칤 a riziku nemoci
                        ((state.weather?.current === 'rain' || state.weather?.current === 'storm' || state.weather?.current === 'radstorm') ? 
                            '<div style="background: #2a2a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #ff9800;">' +
                            '<p style="color: #ff9800; margin: 0; font-size: 0.85rem;">丘멆잺 Po캜as칤: ' + (state.weather.current === 'radstorm' ? '驕뮖잺 Riziko nemoci z oz치콏en칤!' : '游꺊勇 Riziko nachlazen칤/ch콏ipky!') + '</p>' +
                            '</div>' : '') +
                        '</div>' +
                        '<button class="btn" onclick="' + travelFunction + '(\'' + targetId + '\')" style="width: 100%; margin-top: 1rem; background: ' + buttonColor + ';">' + buttonText + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 ' + travelTexts.cancel + '</button>'
                    );
                }
            } else {
                // Nen칤 p콏칤m치 cesta - spo캜칤tej vzd치lenost
                const dist = getDistanceKm(current, target);
                const noPathTexts = {
                    distance: 'Vzd치lenost', noPath: 'Nen칤 p콏칤m치 cesta!', needOther: 'Mus칤코 j칤t p콏es jin칠 lokace.'
                };
                showModal('游딬勇 ' + (isVisited ? target.name : ('Nezn치m치 lokace')), 
                    '<div style="text-align: center;">' +
                    '<div style="font-size: 3rem; margin: 0.5rem 0;">' + (isVisited ? target.icon : '仇') + '</div>' +
                    '<div style="background: #0a0a0a; padding: 0.4rem 0.8rem; border-radius: 6px; display: inline-block; margin: 0.5rem 0; border: 1px solid #333;">' +
                    '<span style="color: #8bc34a; font-family: monospace; font-size: 0.9rem;">游늸 [' + target.x + ', ' + target.y + ']</span>' +
                    '</div>' +
                    '<p style="color: #888;">' + noPathTexts.distance + ': ' + dist.toFixed(1) + ' km</p>' +
                    '<p style="color: #ff9800;">丘멆잺 ' + noPathTexts.noPath + '</p>' +
                    '<p style="color: #666; font-size: 0.85rem;">' + noPathTexts.needOther + '</p>' +
                    '</div>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
                );
            }
        }
        
        function startTravel(targetLocationId) {
            if (state.world.traveling) return;
            
            // Kontrola zda neprob칤h치 akce (lov, t캩쬭a, ryba콏en칤...)
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                notifyWarning('Akce prob칤h치!', 'Nejd콏칤ve dokon캜i nebo zru코 ' + getActionName(state.currentAction.type) + '!');
                return;
            }
            
            // Kontrola zda neprob칤h치 obsazov치n칤 칰zem칤
            if (state.territoryCapture && Object.keys(state.territoryCapture).length > 0) {
                const captureLocation = Object.keys(state.territoryCapture)[0];
                const capture = state.territoryCapture[captureLocation];
                const progress = capture?.progress || 0;
                const remainingMin = Math.ceil((30 * 60 * 1000 - (Date.now() - capture.startTime)) / 60000);
                showModal('游낎 Obsazov치n칤 prob칤h치!', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游낎</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Prob칤h치 obsazov치n칤 칰zem칤!</p>
                        <p style="color: #888; margin: 1rem 0;">Progress: <span style="color: #4CAF50; font-size: 1.2rem; font-weight: bold;">${progress.toFixed(0)}%</span></p>
                        <p style="color: #666; font-size: 0.85rem;">Zb칳v치: ~${remainingMin} min</p>
                        <p style="color: #c62828; font-size: 0.9rem; margin-top: 1rem;">丘멆잺 Mus칤코 z콢stat na m칤st캩!</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">
                         Z콢stat a pokra캜ovat
                    </button>
                `);
                return;
            }
            
            const currentLoc = state.world.currentLocation;
            const path = WORLD_PATHS.find(p => 
                (p.from === currentLoc && p.to === targetLocationId) || (p.to === currentLoc && p.from === targetLocationId)
            );
            
            if (!path) { showModal('仇 Chyba', 'K t칠to lokaci nevede 쮂멳n치 cesta!'); return; }
            
            const targetLoc = WORLD_LOCATIONS.find(l => l.id === targetLocationId);
            const isVisited = state.world.visitedLocations?.includes(targetLocationId);
            
            if (path.danger >= 3) {
                const hour = new Date().getHours();
                const isNight = hour < 6 || hour >= 20;
                const nightWarning = isNight ? '<p style="color: #9c27b0; font-style: italic; margin-top: 0.5rem;">' + getRandomHumor('night') + '</p>' : '';
                
                showModal('丘멆잺 Nebezpe캜n치 cesta!', 
                    '<div style="text-align: center;"><div style="font-size: 3rem;">' + (isVisited ? (targetLoc?.icon || '仇') : '仇') + '</div>' +
                    '<h3>' + (isVisited ? (targetLoc?.name || '???') : '??? Nezn치m치 lokace') + '</h3>' +
                    '<p style="color: #ff9800;">Nebezpe캜칤: ' + '游'.repeat(path.danger) + '</p>' +
                    '<p style="color: #888;">캛as: ' + path.time + ' min</p>' +
                    (isNight ? '<p style="color: #9c27b0;">游깿 Je noc - v칤ce nep콏치tel!</p>' : '') +
                    nightWarning +
                    '</div>' +
                    '<button class="btn" onclick="confirmTravel(\'' + targetLocationId + '\')" style="width: 100%; margin-top: 1rem; background: #8B0000;">丘덢잺 J칤t (na vlastn칤 nebezpe캜칤)</button>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 Rad코i ne</button>'
                );
                return;
            }
            confirmTravel(targetLocationId);
        }
        
        function confirmTravel(targetLocationId) {
            closeModal();
            const currentLoc = state.world.currentLocation;
            const path = WORLD_PATHS.find(p => 
                (p.from === currentLoc && p.to === targetLocationId) || (p.to === currentLoc && p.from === targetLocationId)
            );
            if (!path) return;
            
            // Z칤skej aktu치ln칤 po캜as칤
            const weather = getCurrentWeather();
            const weatherMod = weather?.effect?.speedMod || 1.0;
            
            // === V칗PO캛ET FIN츼LN칈HO 캛ASU (stejn칠 po콏ad칤 jako v zobrazen칤) ===
            // 1. Z치klad
            const baseTime = path.time;
            let travelTimeMin = baseTime;
            let weatherInfo = '';
            
            // 2. Aplikuj po캜as칤 PRVN칈 (zpomalen칤/zrychlen칤)
            if (weatherMod !== 1.0) {
                travelTimeMin = Math.ceil(travelTimeMin / weatherMod);
                if (weatherMod < 1) {
                    weatherInfo = weather.icon + ' ' + weather.name + ' zpomaluje cestu!';
                }
            }
            
            // 3. Spo캜칤tej v코echny bonusy
            let travelBonus = 1.0;
            
            // Nom치d class bonus - 25% rychlej코칤 cestov치n칤
            if (hasClassPassive('travelSpeedBonus')) {
                const nomadSpeedBonus = getClassPassiveValue('travelSpeedBonus') || 0;
                travelBonus -= nomadSpeedBonus;
            }
            
            // AGILITY BONUS - ka쬯칳 bod AGI nad 5 = -2% 캜as cestov치n칤
            const agiBonus = Math.max(0, (state.char.attrs?.agi || 5) - 5) * 0.02;
            if (agiBonus > 0) {
                travelBonus -= agiBonus;
            }
            
            // pathfinder skill - Pr콢zkumn칤k (-3% per level) - ze SKILL_TREE v캩tev EXPLORATION
            const pathfinderLevel = state.skillTree?.exploration?.pathfinder || state.skills?.['pathfinder'] || 0;
            if (pathfinderLevel > 0) {
                const pathfinderBonus = pathfinderLevel * 0.03;
                travelBonus -= pathfinderBonus;
            }
            
            // fast_travel skill - Rychl칳 pochod (-5% per level, max 5) - ze SKILL_TREE
            const fastTravelLevel = state.skillTree?.exploration?.fast_travel || state.skillTree?.survival?.fast_travel || state.skills?.['fast_travel'] || 0;
            if (fastTravelLevel > 0) {
                const fastTravelBonus = fastTravelLevel * 0.05;
                travelBonus -= fastTravelBonus;
            }
            
            // Kompas bonus
            const hasCompass = state.inv?.some(i => i.id === 'compass' || i.bonus === 'navigation');
            if (hasCompass) {
                travelBonus -= 0.015;
            }
            
            // Companion skills bonus (Stopa콏/pathfinder atd.)
            const companionTravelBonus = getCompanionTravelSpeedBonus();
            if (companionTravelBonus > 0) {
                travelBonus -= companionTravelBonus;
            }
            
            // Boots speed bonus (Turistick칠 boty +2%, Exo boty +4%)
            const armorEffects2 = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : { speedBonus: 0 };
            if (armorEffects2.speedBonus > 0) {
                travelBonus -= armorEffects2.speedBonus;
            }
            
            // NPC bonusy pro cestov치n칤
            if (state.secrets?.includes('jin_fast_routes')) travelBonus -= 0.05;
            if (state.secrets?.includes('jin_secret_shortcuts')) travelBonus -= 0.10;
            if (state.secretPathExpires && Date.now() < state.secretPathExpires) travelBonus -= 0.25;
            
            // Mutace: travelSpeed bonus (fast_metabolism = -10%, iron_bones speed = +20%)
            const mutBonuses = getMutationBonuses();
            if (mutBonuses.travelSpeed > 0) {
                travelBonus -= mutBonuses.travelSpeed; // fast_metabolism: 0.1 = -10%
            }
            if (mutBonuses.speed < 0) {
                travelBonus -= mutBonuses.speed; // iron_bones: -0.2 = +20% 캜as (tak쬰 -= -0.2 = +0.2)
            }
            
            // 4. Aplikuj bonusy na 캜as PO po캜as칤
            if (travelBonus < 1.0) {
                travelTimeMin = Math.max(1, Math.ceil(travelTimeMin * Math.max(0.1, travelBonus)));
            }
            
            // 5. Aplikuj zpomalen칤 z nemoc칤 a zran캩n칤
            let healthPenalty = 1.0;
            if (typeof getDiseaseModifiers === 'function') {
                const diseaseMods = getDiseaseModifiers();
                if (diseaseMods.speedMod < 1.0) {
                    healthPenalty *= diseaseMods.speedMod;
                }
            }
            if (typeof getInjuryModifiers === 'function') {
                const injuryMods = getInjuryModifiers();
                if (injuryMods.speedMod < 1.0) {
                    healthPenalty *= injuryMods.speedMod;
                }
            }
            if (healthPenalty < 1.0) {
                travelTimeMin = Math.ceil(travelTimeMin / healthPenalty); // Zpomalen칤 = d캩len칤 (nap콏. 0.7 = +43% 캜as)
            }
            
            // Minimum 1 minuta
            travelTimeMin = Math.max(1, travelTimeMin);
            
            // Debug log
            console.log(`游뛌 Travel: base=${baseTime}, weatherMod=${weatherMod}, afterWeather=${Math.ceil(baseTime/weatherMod)}, bonus=${travelBonus.toFixed(2)}, final=${travelTimeMin}`);
            
            state.world.traveling = true;
            state.world.travelTo = targetLocationId;
            state.world.travelPath = path;
            state.world.travelStart = Date.now();
            state.world.travelDuration = travelTimeMin * 60 * 1000; // Minuty na ms
            
            // Auto-save aby se cestov치n칤 zachovalo p콏i refreshi
            saveGame(true);
            
            // Nastaven칤 spot콏eby b캩hem cesty (ovlivn캩no po캜as칤m)
            const travelSeconds = travelTimeMin * 60;
            let hungerMod = 2, thirstMod = 2.2, energyMod = 2.5;
            
            // Po캜as칤 ovliv켿uje spot콏ebu
            if (weather) {
                // D칠코콘 a bou콏ka - v캩t코칤 spot콏eba energie
                if (weather.id === 'rain') { energyMod *= 1.3; }
                if (weather.id === 'storm') { energyMod *= 1.5; thirstMod *= 1.2; }
                if (weather.id === 'radstorm') { energyMod *= 2; }
                // Slune캜no - v캩t코칤 쮂셬e켿
                if (weather.id === 'sunny') { thirstMod *= 1.2; }
            }
            
            state.map.travelHungerRate = (100 / 86400) * hungerMod;
            state.map.travelThirstRate = (100 / 86400) * thirstMod;
            state.map.travelEnergyRate = (100 / 86400) * energyMod;
            
            // Radiace podle nebezpe캜칤 a po캜as칤 (v칳razn캩 sn칤쬰no)
            let radMod = weather?.effect?.radMod || 1.0;
            state.map.travelRadRate = (path.danger || 0) * 0.0002 * radMod; // 0.0002 m칤sto 0.001 (5x m칠n캩)
            state.map.travelRadAccumulated = 0; // Reset radiace za cestu (max 20%)
            
            // Synchronizace pro zp캩tnou kompatibilitu
            state.map.traveling = true;
            state.map.inBase = false;
            
            const targetLoc = WORLD_LOCATIONS.find(l => l.id === targetLocationId);
            const isTargetVisited = state.world.visitedLocations?.includes(targetLocationId);
            const targetName = isTargetVisited ? (targetLoc?.name || '???') : '??? Nezn치m치 lokace';
            let logMsg = 'Cesta: ' + (path.distance || '?') + ' km  ' + targetName + ' 游뛌';
            if (weatherInfo) logMsg += ' | ' + weatherInfo;
            
            notifyInfo('Vyd치v치코 se na cestu', targetName + ' (' + travelTimeMin + ' min)');
            addLog(logMsg, '游뛌');
            
            // Napl치nuj eventy (ulo쮂 se do state, p콏e쬴j칤 refresh)
            scheduleTravelEvents(path, travelTimeMin);
            renderFull();
        }
        
        function scheduleTravelEvents(path, travelTimeMin) {
            const duration = travelTimeMin * 60 * 1000; // ms
            const dangerLevel = path.danger || 0;
            const startTime = state.world.travelStart;
            
            console.log('scheduleTravelEvents: duration =', duration, 'ms, danger =', dangerLevel);
            
            // Inicializuj pole napl치novan칳ch event콢
            state.world.scheduledEvents = [];
            
            // Reset faction ambush flag - max 1 za cestu
            state.world.factionAmbushTriggered = false;
            
            // PRVN칈 CESTA - garantovan칳 pes
            if (!state.firstTravelDone && !state.companions?.length && !state.rejectedCompanions?.includes('dog')) {
                state.firstTravelDone = true;
                const eventTime = startTime + (duration * 0.3); // 30% cesty
                state.world.scheduledEvents.push({
                    type: 'companion',
                    eventId: 'stray_dog',
                    triggerAt: eventTime,
                    triggered: false
                });
                console.log('Scheduling DOG event at', duration * 0.3, 'ms (', new Date(eventTime).toLocaleTimeString(), ')');
            } else {
                // Norm치ln칤 eventy - MAX 2 za cestu
                const baseEvents = 1;
                const dangerBonus = Math.random() < (dangerLevel * 0.2) ? 1 : 0; // 20% 코ance za ka쬯칳 danger level
                const eventCount = Math.min(baseEvents + dangerBonus, 2); // MAX 2 eventy
                
                for (let i = 0; i < eventCount; i++) {
                    const eventOffset = duration * (0.2 + (i * 0.25) + Math.random() * 0.15);
                    const eventTime = startTime + eventOffset;
                    state.world.scheduledEvents.push({
                        type: 'random',
                        triggerAt: eventTime,
                        dangerLevel: dangerLevel,
                        triggered: false
                    });
                    console.log('Scheduling event', i, 'at', eventOffset, 'ms (', new Date(eventTime).toLocaleTimeString(), ')');
                }
            }
            
            console.log('Total events scheduled:', state.world.scheduledEvents.length);
        }
        
        // Kontrola event콢 - vol치 se v game loop
        function checkScheduledEvents() {
            if (!state.world.traveling || !state.world.scheduledEvents) return;
            
            // Pokud prob칤h치 boj, nezobrazuj eventy
            if (window.combatState) return;
            
            // Pokud je modal u otev콏en칳, nezobrazuj dal코칤
            const modal = document.getElementById('modal');
            if (modal && modal.classList.contains('show')) return;
            
            const now = Date.now();
            
            for (let event of state.world.scheduledEvents) {
                // Pokud event byl triggered ale ne resolved, znovu zobraz modal
                if (event.triggered && !event.resolved) {
                    console.log('Re-showing unresolved event:', event.type);
                    showUnresolvedEvent(event);
                    return; // Zobraz jen jeden najednou
                }
                
                if (event.triggered) continue;
                if (now < event.triggerAt) continue;
                
                // Spus콘 event
                event.triggered = true;
                console.log('Triggering scheduled event:', event.type);
                
                if (event.type === 'companion') {
                    const dogEvent = TRAVEL_EVENTS.find(e => e.id === event.eventId);
                    if (dogEvent) {
                        handleCompanionEvent(dogEvent);
                    }
                } else if (event.type === 'random') {
                    triggerTravelEvent(event.dangerLevel);
                }
            }
        }
        
        // Znovu zobraz nevy콏e코en칳 event po refreshi
        function showUnresolvedEvent(event) {
            if (event.type === 'companion') {
                const dogEvent = TRAVEL_EVENTS.find(e => e.id === event.eventId);
                if (dogEvent) {
                    handleCompanionEvent(dogEvent);
                }
            } else if (event.type === 'random' && event.selectedEventId) {
                // M치me ulo쬰n칳 konkr칠tn칤 event - najdi ho a zpracuj
                const savedEvent = TRAVEL_EVENTS.find(e => e.id === event.selectedEventId);
                if (savedEvent) {
                    console.log('Restoring saved event:', savedEvent.name);
                    
                    // Ozna캜 jako resolved HNED aby se nezacyklilo
                    event.resolved = true;
                    
                    // Notifikace jen jednou (p콏i refreshi str치nky)
                    if (!event.notified) {
                        event.notified = true;
                        notifySuccess('游댃 Event obnoven', savedEvent.name);
                    }
                    
                    // Zpracuj event podle jeho typu
                    switch (savedEvent.type) {
                        case 'combat':
                            handleCombatEvent(event.dangerLevel);
                            break;
                        case 'loot':
                            handleLootEvent();
                            break;
                        case 'radiation':
                            handleRadiationEvent(event.dangerLevel);
                            break;
                        case 'trap':
                            handleTrapEvent();
                            break;
                        case 'merchant':
                            handleMerchantEvent();
                            break;
                        case 'companion':
                            handleCompanionEvent(savedEvent);
                            break;
                        case 'mystery':
                            handleMysteryEvent();
                            break;
                        case 'treasure':
                            handleTreasureEvent();
                            break;
                        case 'survivor':
                            handleSurvivorEvent();
                            break;
                        case 'weather':
                            handleWeatherEvent();
                            break;
                        default:
                            // Fallback - zobraz jako loot nebo combat
                            if (Math.random() < 0.5) {
                                handleLootEvent();
                            } else {
                                handleCombatEvent(event.dangerLevel);
                            }
                    }
                } else {
                    // Event nenalezen - vygeneruj nov칳
                    triggerTravelEvent(event.dangerLevel);
                }
            } else {
                // Nem치me ulo쬰n칳 event, vygeneruj nov칳
                triggerTravelEvent(event.dangerLevel);
            }
        }
        
        // Ozna캜 aktu치ln칤 event jako vy콏e코en칳
        function resolveCurrentEvent() {
            if (!state.world.scheduledEvents) return;
            
            for (let event of state.world.scheduledEvents) {
                if (event.triggered && !event.resolved) {
                    event.resolved = true;
                    console.log('Event resolved:', event.type);
                    break;
                }
            }
        }
        
        function triggerTravelEvent(dangerLevel) {
            console.log('triggerTravelEvent called, traveling =', state.world.traveling);
            if (!state.world.traveling) return;
            
            // Najdi aktu치ln칤 event a ozna캜 ho jako resolved HNED na za캜치tku
            // (aby se nezacyklil p콏i faction ambush)
            for (let event of state.world.scheduledEvents || []) {
                if (event.triggered && !event.resolved && event.type === 'random') {
                    event.resolved = true;
                    break;
                }
            }
            
            // === FACTION AMBUSH CHECK ===
            // Kontrola nep콏치telsk칳ch frakc칤 - raiders maj칤 ambushChance
            // LIMIT: Max 1 faction ambush za cestu
            if (typeof FACTIONS !== 'undefined' && !state.world.factionAmbushTriggered) {
                const raidersFaction = FACTIONS.find(f => f.id === 'raiders');
                if (raidersFaction && state.factionRep) {
                    const rep = state.factionRep.raiders || 0;
                    let ambushChance = 0;
                    
                    if (rep <= -50) {
                        // Enemy status - 60% ambush
                        ambushChance = 0.6;
                    } else if (rep <= -25) {
                        // Hostile status - 30% ambush
                        ambushChance = 0.3;
                    }
                    
                    if (ambushChance > 0 && Math.random() < ambushChance) {
                        // Faction ambush! Ozna캜 쬰 u prob캩hl
                        state.world.factionAmbushTriggered = true;
                        console.log('Faction ambush triggered! Raiders rep:', rep);
                        addLog('丘멆잺 N치jezdn칤ci ti nastra쬴li past!', '游');
                        
                        // Spawn raiders combat
                        const raiderEnemy = ENEMIES.find(e => e.id === 'raider') || ENEMIES.find(e => e.faction === 'raiders');
                        if (raiderEnemy) {
                            showModal('游 P콏epaden칤 n치jezdn칤k콢!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem;">游</div>
                                    <h3 style="color: #f44336;">N치jezdn칤ci!</h3>
                                    <p style="color: #888;">Tv치 코patn치 pov캩st u n치jezdn칤k콢 t캩 dostihla!</p>
                                    <p style="color: #ff9800; font-size: 0.9rem;">Reputace: ${rep}</p>
                                </div>
                                <button class="btn" onclick="closeModal(); startCombat({id: 'raider'}, true);" style="width: 100%; margin-top: 1rem; background: #c62828;">
                                    丘덢잺 Bojovat!
                                </button>
                            `);
                            return; // Nepokra캜uj s norm치ln칤m eventem
                        }
                    }
                }
            }
            
            // Vyber n치hodn칳 event
            const roll = Math.random();
            let cumulative = 0;
            let selectedEvent = null;
            
            // Filtruj eventy - firstOnly eventy pouze pokud nem치me/neodm칤tli spole캜n칤ka
            const availableEvents = TRAVEL_EVENTS.filter(e => {
                if (e.firstOnly && e.companionId) {
                    // Spole캜n칤ka m콢쬰me z칤skat jen jednou
                    const hasCompanion = state.companions?.some(c => c.id === e.companionId);
                    const rejectedCompanion = state.rejectedCompanions?.includes(e.companionId);
                    return !hasCompanion && !rejectedCompanion;
                }
                return true;
            });
            
            console.log('Available events:', availableEvents.length, 'roll =', roll);
            
            for (const event of availableEvents) {
                cumulative += event.chance;
                if (roll < cumulative) {
                    selectedEvent = event;
                    break;
                }
            }
            
            console.log('Selected event:', selectedEvent?.name || 'none');
            
            if (!selectedEvent) {
                // Fallback - v쬯y n캩jak칳 event
                selectedEvent = availableEvents.find(e => e.type === 'combat') || availableEvents[0];
                console.log('Fallback event:', selectedEvent?.name);
            }
            
            if (!selectedEvent) return;
            
            // Ulo vybran칳 event pro p콏칤pad refreshe
            for (let event of state.world.scheduledEvents) {
                if (event.triggered && !event.resolved && event.type === 'random') {
                    event.selectedEventId = selectedEvent.id;
                    event.selectedEventType = selectedEvent.type;
                    // Ulo hru aby se event zachoval p콏i refreshi
                    saveGame(true);
                    break;
                }
            }
            
            // Syst칠mov치 notifikace o eventu
            sendSystemNotification(selectedEvent.name, selectedEvent.text || 'N캩co se d캩je na cest캩!', selectedEvent.icon);
            
            // Push notifikace na mobil
            MobileNotifications.notifyTravelEvent(selectedEvent.name, selectedEvent.icon);
            
            // Zpracuj event podle typu
            switch (selectedEvent.type) {
                case 'combat':
                    handleCombatEvent(dangerLevel);
                    break;
                case 'loot':
                    handleLootEvent();
                    break;
                case 'radiation':
                    handleRadiationEvent(dangerLevel);
                    break;
                case 'trap':
                    handleTrapEvent();
                    break;
                case 'exhaustion':
                    handleExhaustionEvent();
                    break;
                case 'companion':
                    handleCompanionEvent(selectedEvent);
                    break;
                case 'resource':
                    handleResourceEvent(selectedEvent);
                    break;
                case 'dirty_water':
                    handleResourceEvent(selectedEvent);
                    break;
                case 'food_scraps':
                    handleResourceEvent(selectedEvent);
                    break;
                case 'choice':
                    handleChoiceEvent(selectedEvent);
                    break;
                case 'explore':
                    handleExploreEvent(selectedEvent);
                    break;
                case 'rest':
                    handleRestEvent(selectedEvent);
                    break;
                case 'theft':
                    handleTheftEvent();
                    break;
                case 'sickness':
                    handleSicknessEvent();
                    break;
                case 'cache':
                    handleCacheEvent(selectedEvent);
                    break;
                case 'trader':
                    handleTraderEvent(selectedEvent);
                    break;
                default:
                    // Zobraz generick칳 event
                    showModal(selectedEvent.icon + ' ' + selectedEvent.name,
                        '<p>' + selectedEvent.text + '</p>' +
                        '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>'
                    );
            }
        }
        
        function handleCombatEvent(dangerLevel) {
            const enemyIndex = Math.min(ENEMIES.length - 1, Math.floor(Math.random() * (5 + dangerLevel * 3)));
            const enemy = ENEMIES[enemyIndex];
            const humor = getRandomHumor('combatStart');
            MobileNotifications.notifyCombat(enemy.name);
            showModal('游눤 P콏epaden칤!', 
                '<p>Z 칰krytu vysko캜ili nep콏치tel칠!</p>' +
                '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"' + humor + '"</p>' +
                '<div style="text-align: center; margin: 1rem 0;"><div style="font-size: 3rem;">' + enemy.icon + '</div>' +
                '<h3 style="color: var(--warning-yellow);">' + enemy.name + '</h3>' +
                '<p style="color: #888;">HP: ' + enemy.hp + ' | DMG: ' + enemy.damage + '</p></div>' +
                '<button class="btn" onclick="fightTravelEnemy(\'' + enemy.id + '\')" style="width: 100%; margin-bottom: 0.5rem; background: #8B0000;">丘덢잺 ' + ('Bojovat!') + '</button>' +
                '<button class="btn" onclick="tryToFleeTravel(\'' + enemy.id + '\')" style="width: 100%; background: #555;">游끢 Strategick칳 칰stup!</button>'
            );
        }
        
        function handleLootEvent() {
            // 마nce na lore knihu (3%)
            if (Math.random() < 0.03) {
                const ownedLore = state.inv.filter(i => i.id?.startsWith('lore_')).map(i => i.id);
                const availableLore = ITEMS.filter(i => i.id?.startsWith('lore_') && !ownedLore.includes(i.id));
                
                if (availableLore.length > 0) {
                    availableLore.sort((a, b) => a.id.localeCompare(b.id));
                    const loreBook = availableLore[0];
                    
                    if (canAddItem(loreBook, 1)) {
                        addItemToInventory(loreBook, 1, true);
                        notifyLoot(loreBook.name, 'epic', loreBook.icon);
                        addLog('游늿 Nalezen vz치cn칳 den칤k!', '游늿');
                        
                        showModal('游늿 Vz치cn칳 n치lez!', 
                            '<p>Na cest캩 jsi na코el n캩co zaj칤mav칠ho!</p>' +
                            '<div style="text-align: center; margin: 1rem 0;"><div style="font-size: 3rem;">' + loreBook.icon + '</div>' +
                            '<h3 style="color: #ffd700;">' + loreBook.name + '</h3>' +
                            '<p style="color: #888;">Star칳 den칤k... mo쬹치 obsahuje d콢le쬴t칠 informace.</p></div>' +
                            '<button class="btn" onclick="continueTravel()" style="width: 100%;">九 Skv캩l칠!</button>'
                        );
                        return;
                    }
                }
            }
            
            // Filtruj itemy kter칠 se daj칤 n치hodn캩 naj칤t (ne lore, ne quest itemy, ne cantBuy)
            const lootableItems = ITEMS.filter(i => 
                !i.id?.startsWith('lore_') && 
                !i.id?.startsWith('quest_') && 
                !i.cantBuy &&
                i.type !== 'lore'
            );
            
            const lootItem = lootableItems[Math.floor(Math.random() * lootableItems.length)];
            let humor = '';
            let itemAdded = false;
            let itemName = lootItem?.name || 'Nic u쬴te캜n칠ho';
            let itemIcon = lootItem?.icon || '游닍';
            let extraText = '';
            
            if (lootItem) {
                if (canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1, true);
                    notifyLoot(lootItem.name, lootItem.rarity, lootItem.icon);
                    MobileNotifications.notifyLootFound(lootItem.name, lootItem.icon);
                    addLog(`游꾸 Na cest캩 nalezeno: ${lootItem.icon} ${lootItem.name}`, '游꾸');
                    humor = lootItem.rarity === 'rare' || lootItem.rarity === 'epic' ? getRandomHumor('lootGood') : getRandomHumor('lootJunk');
                    itemAdded = true;
                } else {
                    // Ulo na zem c칤lov칠 lokace
                    addToGroundLoot({...lootItem}, state.map.travelTo || state.world.currentLocation);
                    humor = 'Nem치m m칤sto, ale nech치m to tu le쬰t...';
                    extraText = '<p style="color: #ff9800; font-size: 0.9rem;">游닍 Pln칳 invent치콏! P콏edm캩t z콢stal na zemi.</p>';
                }
            } else {
                humor = getRandomHumor('lootEmpty');
            }
            showModal('游꾸 N치lez!', 
                '<p>Na cest캩 jsi n캩co na코el!</p>' +
                '<div style="text-align: center; margin: 1rem 0;"><div style="font-size: 3rem;">' + itemIcon + '</div>' +
                '<h3 style="color: ' + (itemAdded ? 'var(--toxic-green)' : '#888') + ';">' + itemName + '</h3>' +
                extraText +
                '<p style="color: #666; font-style: italic; margin-top: 0.5rem;">"' + humor + '"</p></div>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%;">九 ' + (itemAdded ? 'Beru!' : 'Jdu d치l...') + '</button>'
            );
        }
        
        function handleRadiationEvent(dangerLevel) {
            const radGain = 5 + dangerLevel * 5;
            
            // Kontrola ochrany na radiaci (hazmat oblek atd.)
            const armor = state.equipped?.armor;
            const hasRadProtection = armor?.special === 'rad_immune' || armor?.special === 'rad_resist';
            const reduction = hasRadProtection ? (armor?.special === 'rad_immune' ? 0.5 : 0.3) : 0;
            const actualRadGain = Math.floor(radGain * (1 - reduction));
            
            addRadiation(actualRadGain);
            const humor = getRandomHumor('radiation');
            
            if (hasRadProtection) {
                const reductionPct = Math.floor(reduction * 100);
                notifyWarning('Radiace (sn칤쬰no)!', `驕뮖잺 Oblek -${reductionPct}%`);
                showModal('驕뮖잺 Radia캜n칤 bou콏e!', 
                    '<p>Obloha se zbarvila do zelena!</p>' +
                    `<p style="color: #76ff03;">游봎 Tv콢j oblek sn칤쬴l radiaci o ${reductionPct}%!</p>` +
                    `<p style="color: #ff9800;">+${actualRadGain} radiace (m칤sto ${radGain})</p>` +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>'
                );
            } else {
                notifyWarning('Radiace!', '+' + actualRadGain + ' 驕뮖잺');
                showModal('驕뮖잺 Radia캜n칤 bou콏e!', 
                    '<p>Obloha se zbarvila do zelena!</p>' +
                    '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + humor + '"</p>' +
                    '<p style="color: #ff9800; font-size: 1.2rem;">+' + actualRadGain + ' radiace</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Sv칤t칤m d치l...</button>'
                );
            }
        }
        
        function handleTrapEvent() {
            const damage = 10 + Math.floor(Math.random() * 15);
            state.char.hp = Math.max(1, state.char.hp - damage);
            const humor = getRandomHumor('trap');
            notifyDanger('Past!', '-' + damage + ' HP');
            showModal('游뿫 Past!', 
                '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"' + humor + '"</p>' +
                '<p style="color: #f44336; font-size: 1.2rem; margin-top: 0.5rem;">-' + damage + ' HP</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Kulh치m d치l...</button>'
            );
        }
        
        function handleExhaustionEvent() {
            state.status.energy = Math.max(0, state.status.energy - 20);
            const humor = getRandomHumor('exhaustion');
            notifyWarning('Vy캜erp치n칤', '-20 ' + ('energie'));
            showModal('游땷 Vy캜erp치n칤', 
                '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"' + humor + '"</p>' +
                '<p style="color: #ff9800; font-size: 1.2rem; margin-top: 0.5rem;">-20 energie</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 *vzdych치* ...d치l</button>'
            );
        }
        
        function handleCompanionEvent(event) {
            const companion = getCompanionData(event.companionId);
            if (!companion) return;
            
            // Syst칠mov치 notifikace
            sendSystemNotification(event.name, event.text || 'Na코el jsi spole캜n칤ka!', event.icon);
            
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' +
                '<div style="text-align: center; margin: 1rem 0;">' +
                '<div style="font-size: 4rem;">' + companion.icon + '</div>' +
                '<h3 style="color: var(--toxic-green);">' + companion.name + '</h3>' +
                '<p style="color: #888; font-size: 0.85rem;">' + companion.abilityDesc + '</p></div>' +
                '<button class="btn" onclick="adoptCompanion(\'' + companion.id + '\')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">仇벒잺 Vz칤t k sob캩</button>' +
                '<button class="btn" onclick="confirmLeaveCompanion(\'' + companion.id + '\', \'' + companion.name + '\', \'' + companion.icon + '\')" style="width: 100%; background: #555;">九 Nechat b칳t</button>'
            );
        }
        
        function confirmLeaveCompanion(companionId, name, icon) {
            showModal('丘멆잺 Opravdu odej칤t?', 
                '<div style="text-align: center; margin: 1rem 0;">' +
                '<div style="font-size: 3rem;">' + icon + '</div>' +
                '<p style="color: #ff9800;">Tohoto spole캜n칤ka u nikdy nepotk치코!</p>' +
                '<p style="color: #888; font-size: 0.85rem;">' + name + ' z콢stane s치m v pustin캩...</p></div>' +
                '<button class="btn" onclick="adoptCompanion(\'' + companionId + '\')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">仇벒잺 Zm캩nit n치zor - vz칤t k sob캩</button>' +
                '<button class="btn" onclick="leaveCompanionForever(\'' + companionId + '\')" style="width: 100%; background: #8B0000;">游눖 Ano, nechat ho</button>'
            );
        }
        
        function leaveCompanionForever(companionId) {
            // Ozna캜 쬰 jsme tohoto spole캜n칤ka odm칤tli (u se neobjev칤)
            if (!state.rejectedCompanions) state.rejectedCompanions = [];
            state.rejectedCompanions.push(companionId);
            
            notifyWarning('Ode코el jsi', 'Spole캜n칤k z콢stal s치m...');
            continueTravel();
        }
        
        function adoptCompanion(companionId, customName = null) {
            const companion = getCompanionData(companionId);
            if (!companion) {
                console.error('adoptCompanion: Unknown companion', companionId);
                return;
            }
            
            if (!state.companions) state.companions = [];
            
            // Max spole캜n칤ci podle levelu
            if (state.companions.length >= getMaxCompanions()) {
                showModal('丘멆잺 Pln칳 t칳m', 
                    '<div style="text-align: center;">' +
                    '<p>U m치코 maxim치ln칤 po캜et spole캜n칤k콢 (' + getMaxCompanions() + ').</p>' +
                    '<p style="color: #888;">Propus콘 jednoho ve spr치v캩 spole캜n칤k콢, pokud chce코 nov칠ho.</p>' +
                    '<p style="color: #4caf50; font-size: 0.85rem; margin-top: 0.5rem;">游눠 Vy코코칤 level = v칤ce spole캜n칤k콢!</p>' +
                    '</div>' +
                    '<button class="btn" onclick="closeModal(); continueTravel();" style="width: 100%; margin-top: 0.5rem; background: #555;">九 OK</button>'
                );
                return;
            }
            
            // P콏idej spole캜n칤ka s defaultn칤m jm칠nem
            const newCompanion = {...companion, hp: companion.hp, maxHp: companion.hp};
            state.companions.push(newCompanion);
            closeModal();
            resolveCurrentEvent(); // Ozna캜 event jako vy콏e코en칳
            notifySuccess('Nov칳 spole캜n칤k!', newCompanion.name + ' se k tob캩 p콏idal!');
            addLog(newCompanion.name + ' se stal tv칳m spole캜n칤kem!', companion.icon);
            
            // Pokud cestujeme, pokra캜uj
            renderFull();
        }
        
        function confirmAdoptCompanion(companionId) {
            adoptCompanion(companionId);
        }
        
        // Renamed to avoid duplicate - for travel context
        function swapCompanionTravel(newCompanionId) {
            const newCompanion = getCompanionData(newCompanionId);
            if (!newCompanion) return;
            
            const oldCompanion = state.companions[0];
            state.companions = [{...newCompanion, hp: newCompanion.hp, maxHp: newCompanion.hp}];
            
            closeModal();
            notifySuccess('V칳m캩na!', oldCompanion.name + '  ' + newCompanion.name);
            addLog('Vym캩nil spole캜n칤ka: ' + newCompanion.name, newCompanion.icon);
            renderFull();
        }
        
        function handleResourceEvent(event) {
            let resourceType = 'herbs';
            let amount = 2 + Math.floor(Math.random() * 3);
            
            if (event.id === 'water_source') {
                // Dopl켿 쮂셬e켿 - SN칈콯ENO
                state.status.thirst = Math.min(100, state.status.thirst + 15);
                renderFull(); // Aktualizuj UI
                
                // Men코칤 코ance na l치hev vody (50%)
                if (Math.random() < 0.5) {
                    const waterBottle = ITEMS.find(i => i.id === 'water_bottle');
                    if (waterBottle) {
                        addItemToInventory(waterBottle, 1);
                        addLog(`游눦 캛ist칳 pramen: +15 쮂셬e켿, +1x 游눦 L치hev vody`, '游눦');
                        notifySuccess('캛erstv치 voda!', `+15 쮂셬e켿, +1x 游눦`);
                    }
                } else {
                    addLog('游눦 캛ist칳 pramen: +15 쮂셬e켿', '游눦');
                    notifySuccess('캛erstv치 voda!', '+15 ' + ('쮂셬e켿'));
                }
            } else if (event.id === 'dirty_puddle') {
                // Kaln치 lou쬰 - riziko radiace - hr치캜 si vybere
                showModal('游눥 Kaln치 lou쬰', 
                    '<p>Nach치z칤코 kalnou lou쬴. Voda vypad치 pochybn캩...</p>' +
                    '<button class="btn" onclick="drinkDirtyWater()" style="width: 100%; margin-bottom: 0.5rem; background: #ff9800;">游눥 Nap칤t se (+20 쮂셬e켿, riziko radiace)</button>' +
                    '<button class="btn" onclick="closeModal(); continueTravel();" style="width: 100%; background: #555;">九 Nechat b칳t</button>'
                );
                return; // D콢le쬴t칠 - nepokra캜ovat d치l
            } else if (event.id === 'food_scraps') {
                // Zbytky j칤dla - mal치 hodnota
                const hungerGain = 8 + Math.floor(Math.random() * 7); // 8-15 hlad
                state.status.hunger = Math.min(100, state.status.hunger + hungerGain);
                addLog(`游꼤 Zbytky j칤dla: +${hungerGain} hlad`, '游꼤');
                notifySuccess('Zbytky j칤dla', `+${hungerGain} hlad`);
                renderFull(); // Aktualizuj UI
                showModal('游꼤 Zbytky j칤dla', 
                    '<p>Na코el jsi nap콢l sn캩den칠 konzervy a zbytky j칤dla. Lep코칤 ne nic...</p>' +
                    '<p style="color: var(--toxic-green);">+' + hungerGain + ' hlad</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>'
                );
                return; // D콢le쬴t칠 - nepokra캜ovat d치l
            } else if (event.id === 'herb_patch') {
                state.resources.herbs = (state.resources.herbs || 0) + amount;
                addLog(`游 Pole bylin: +${amount} byliny`, '游');
                notifySuccess('Byliny!', '+' + amount + ' 游');
            }
            
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>'
            );
        }
        
        function handleChoiceEvent(event) {
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' +
                '<button class="btn" onclick="investigateEvent(\'' + event.id + '\')" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust);">游댌 Prozkoumat</button>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; background: #555;">九 Ignorovat</button>'
            );
        }
        
        function investigateEvent(eventId) {
            closeModal();
            const roll = Math.random();
            
            if (roll < 0.4) {
                // Dobr칳 v칳sledek
                const lootItem = ITEMS[Math.floor(Math.random() * 15)];
                if (lootItem && canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1);
                    addLog(`游댌 Pr콢zkum: Nalezeno ${lootItem.icon} ${lootItem.name}`, '游댌');
                    notifyLoot(lootItem.name, lootItem.rarity, lootItem.icon);
                }
                showModal('游꾸 맚캩st칤!', 
                    '<p>Na코el jsi n캩co u쬴te캜n칠ho!</p>' +
                    '<div style="text-align: center; font-size: 2rem; margin: 1rem 0;">' + (lootItem?.icon || '游닍') + '</div>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%;">九 Pokra캜ovat</button>'
                );
            } else if (roll < 0.7) {
                // Nic
                showModal('游땛 Nic', 
                    '<p>Nena코el jsi nic zaj칤mav칠ho.</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%;">九 Pokra캜ovat</button>'
                );
            } else {
                // 맗atn칳 v칳sledek - boj nebo past
                handleCombatEvent(1);
            }
        }
        
        function handleExploreEvent(event) {
            const roll = Math.random();
            let reward = '';
            
            if (roll < 0.5) {
                const lootItem = ITEMS[Math.floor(Math.random() * 20)];
                if (lootItem && canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1);
                    addLog(`游댌 ${event.name}: Nalezeno ${lootItem.icon} ${lootItem.name}`, '游댌');
                    reward = '<p style="color: var(--toxic-green);">Na코el jsi: ' + lootItem.icon + ' ' + lootItem.name + '</p>';
                }
            } else if (roll < 0.7) {
                const money = 10 + Math.floor(Math.random() * 30);
                addMoney(money);
                addLog(`游댌 ${event.name}: Nalezeno ${money} 游눯`, '游댌');
                reward = '<p style="color: #ffd700;">Na코el jsi: ' + money + ' 游눯</p>';
            }
            
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' + reward +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>'
            );
        }
        
        function handleRestEvent(event) {
            const energyGain = 8 + Math.floor(Math.random() * 8); // 8-15 energie (sn칤쬰no z 15-30)
            state.status.energy = Math.min(100, state.status.energy + energyGain);
            renderFull(); // Aktualizuj UI
            notifySuccess('Kr치tk칳 odpo캜inek', '+' + energyGain + ' ' + ('energie'));
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p><p style="color: var(--toxic-green);">+' + energyGain + ' energie</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>'
            );
        }
        
        function drinkDirtyWater() {
            closeModal();
            state.status.thirst = Math.min(100, state.status.thirst + 20);
            renderFull(); // Aktualizuj UI ihned
            
            // 40% 코ance na radiaci
            if (Math.random() < 0.4) {
                const radGain = 5 + Math.floor(Math.random() * 10); // 5-15 radiace
                addRadiation(radGain);
                renderFull(); // Aktualizuj UI po radiaci
                addLog(`游눥 Kaln치 voda: +20 쮂셬e켿, +${radGain} radiace!`, '驕뮖잺');
                notifyWarning('Kontaminovan치 voda!', `+20 쮂셬e켿, +${radGain} 驕뮖잺`);
                showModal('游눥 Kontaminovan치!', 
                    '<p>Voda byla kontaminovan치!</p>' +
                    '<p style="color: var(--toxic-green);">+20 쮂셬e켿</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' 驕뮖잺 radiace</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 *ka코le* ...d치l</button>'
                );
            } else {
                addLog('游눥 Kaln치 voda: +20 쮂셬e켿 (m캩l jsi 코t캩st칤)', '游눥');
                notifySuccess('M캩l jsi 코t캩st칤!', '+20 쮂셬e켿');
                showModal('游눥 V po콏치dku!', 
                    '<p>Voda chutnala divn캩, ale vypad치 쬰 jsi v po콏치dku.</p>' +
                    '<p style="color: var(--toxic-green);">+20 쮂셬e켿</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Fuj, ale ok</button>'
                );
            }
        }
        
        function handleTheftEvent() {
            const money = getMoney();
            if (money > 0) {
                const stolen = Math.min(money, 5 + Math.floor(Math.random() * 20));
                removeMoney(stolen);
                const humor = getRandomHumor('theftFail');
                notifyDanger('Okraden!', '-' + stolen + ' 游눯');
                showModal('游봉 Zlod캩j!', 
                    '<p>N캩kdo t캩 okradl!</p>' +
                    '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + humor + '"</p>' +
                    '<p style="color: #f44336; font-size: 1.2rem;">-' + stolen + ' 游눯</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 *nad치v치* ...d치l</button>'
                );
            } else {
                showModal('游봉 Zlod캩j!', 
                    '<p>N캩kdo se t캩 pokusil okr치st!</p>' +
                    '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"Plot twist: Nem치코 co ukr치st. Kdo je te캞 chud치k?"</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 Ha! 콯ebr치k 1, Zlod캩j 0</button>'
                );
            }
        }
        
        function handleSicknessEvent() {
            state.status.hunger = Math.max(0, state.status.hunger - 15);
            const damage = 5;
            state.char.hp = Math.max(1, state.char.hp - damage);
            const humor = getRandomHumor('foodWeird');
            notifyWarning('Nevolnost', '-15 ' + ('hlad') + ', -' + damage + ' HP');
            showModal('游뱍 Nevolnost', 
                '<p>N캩co ti nesedlo v 쬬ludku...</p>' +
                '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + humor + '"</p>' +
                '<p style="color: #ff9800;">-15 hlad, -' + damage + ' HP</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">九 *g칰칰칰칰* ...d치l</button>'
            );
        }
        
        function handleCacheEvent(event) {
            // Generuj n치hodn칳 loot ze skr칳코e
            const possibleLoot = [
                { type: 'money', min: 50, max: 200 },
                { type: 'resource', resource: 'metal', min: 3, max: 10 },
                { type: 'resource', resource: 'wood', min: 5, max: 15 },
                { type: 'resource', resource: 'cloth', min: 3, max: 8 },
                { type: 'resource', resource: 'chemicals', min: 1, max: 5 },
                { type: 'item', items: ['medkit', 'bandage', 'food', 'water', 'stimpack'] }
            ];
            
            // Vyber 2-4 druhy lootu
            const lootCount = 2 + Math.floor(Math.random() * 3);
            const selectedLoot = [];
            const usedTypes = [];
            
            for (let i = 0; i < lootCount; i++) {
                const available = possibleLoot.filter((_, idx) => !usedTypes.includes(idx));
                if (available.length === 0) break;
                
                const idx = possibleLoot.indexOf(available[Math.floor(Math.random() * available.length)]);
                usedTypes.push(idx);
                const loot = possibleLoot[idx];
                
                if (loot.type === 'money') {
                    const amount = loot.min + Math.floor(Math.random() * (loot.max - loot.min));
                    addMoney(amount);
                    selectedLoot.push({ icon: '游눯', text: `${amount} pen캩z` });
                } else if (loot.type === 'resource') {
                    const amount = loot.min + Math.floor(Math.random() * (loot.max - loot.min));
                    state.resources[loot.resource] = (state.resources[loot.resource] || 0) + amount;
                    const icons = { metal: '丘뙖잺', wood: '游', cloth: '游빗', chemicals: '游빍' };
                    const names = { metal: 'kovu', wood: 'd콏eva', cloth: 'l치tky', chemicals: 'chemik치li칤', scrap: '코rotu', fuel: 'paliva', electronics: 'elektroniky', herbs: 'bylin' };
                    selectedLoot.push({ icon: icons[loot.resource] || '游닍', text: `${amount} ${names[loot.resource] || loot.resource}` });
                } else if (loot.type === 'item') {
                    const itemId = loot.items[Math.floor(Math.random() * loot.items.length)];
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item && canAddItem(item, 1)) {
                        state.inv.push({...item});
                        selectedLoot.push({ icon: item.icon, text: item.name });
                    }
                }
            }
            
            const lootHtml = selectedLoot.map(l => `<div style="padding: 0.3rem 0;">${l.icon} ${l.text}</div>`).join('');
            const findHumor = getRandomHumor('finds');
            
            showModal(event.icon + ' ' + event.name,
                '<p>' + event.text + '</p>' +
                '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + findHumor + '"</p>' +
                '<div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4CAF50;">' +
                '<h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">游꾸 Nalezeno:</h4>' +
                lootHtml +
                '</div>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">九 Beru v코echno!</button>'
            );
            
            addLog('Na코el jsi skrytou skr칳코!', '游닍');
            notifySuccess('Skr칳코!', 'Nalezeny z치soby');
        }
        
        function handleTraderEvent(event) {
            // Generuj n치hodn칠 zbo쮂 od potuln칠ho obchodn칤ka
            const traderItems = [];
            const itemPool = ITEMS.filter(i => i.type === 'consumable' || i.type === 'ammo' || i.type === 'resource');
            
            // Vyber 4-6 n치hodn칳ch item콢
            const itemCount = 4 + Math.floor(Math.random() * 3);
            const usedIds = [];
            
            for (let i = 0; i < itemCount; i++) {
                const available = itemPool.filter(it => !usedIds.includes(it.id));
                if (available.length === 0) break;
                const item = available[Math.floor(Math.random() * available.length)];
                usedIds.push(item.id);
                // Cena se slevou 10-30%
                const discount = 0.7 + Math.random() * 0.2;
                const price = Math.floor((item.price || 20) * discount);
                traderItems.push({...item, traderPrice: price});
            }
            
            // Ulo zbo쮂 do stavu pro n치kup
            state.travelTraderItems = traderItems;
            
            const itemsHtml = traderItems.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span>${item.icon} ${item.name}</span>
                    <button class="btn" onclick="buyFromTravelTrader(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" ${state.money < item.traderPrice ? 'disabled' : ''}>
                        ${item.traderPrice} 游눯
                    </button>
                </div>
            `).join('');
            
            const traderQuote = getRandomHumor('trader');
            
            showModal(event.icon + ' ' + event.name,
                '<p>' + event.text + '</p>' +
                '<p style="color: #888; font-style: italic; font-size: 0.85rem; margin: 0.5rem 0;">"' + traderQuote + '"</p>' +
                '<p style="color: #ffd700; margin: 0.5rem 0;">游눯 Tvoje pen칤ze: ' + state.money + '</p>' +
                '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin: 1rem 0;">' +
                itemsHtml +
                '</div>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 Sbohem, obchodn칤ku</button>'
            );
            
            addLog('Potkal jsi potuln칠ho obchodn칤ka!', '游빕');
        }
        
        function buyFromTravelTrader(idx) {
            if (!state.travelTraderItems || !state.travelTraderItems[idx]) return;
            
            const item = state.travelTraderItems[idx];
            
            // Kontrola unique item콢
            const itemDef = ITEMS.find(i => i.id === item.id);
            if (itemDef?.unique) {
                const alreadyHas = state.inv.some(i => i.id === item.id);
                if (alreadyHas) {
                    notifyWarning('U m치코 ' + item.name, 'M콢쬰코 m칤t pouze jeden');
                    return;
                }
            }
            
            if (state.money < item.traderPrice) {
                notifyWarning('Nedostatek pen캩z!');
                return;
            }
            
            if (!canAddItem(item, 1)) {
                notifyWarning(t('notifications', 'inventoryFull'));
                return;
            }
            
            state.money -= item.traderPrice;
            // P콏idej item s fromShop flagem
            const boughtItem = { ...item, fromShop: true, boughtPrice: item.traderPrice };
            addItemToInventory(boughtItem, 1);
            notifySuccess('Koupeno!', item.name);
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            // Odeber polo쬶u z nab칤dky
            state.travelTraderItems.splice(idx, 1);
            
            // Znovu zobraz obchod
            const event = { icon: '游빕', name: 'Potuln칳 obchodn칤k', text: 'Co dal코칤ho si p콏eje코?' };
            handleTraderEvent(event);
        }

        function fightTravelEnemy(enemyId) {
            closeModal();
            state.world.resumeAfterCombat = true;
            startCombat({id: enemyId});
        }
        
        function tryToFleeTravel(enemyId) {
            const fleeChance = 0.3 + (state.char.attrs.agi - 5) * 0.05;
            if (Math.random() < fleeChance) {
                const humor = getRandomHumor('fleeSuccess');
                notifySuccess('Utekl jsi!', humor);
                continueTravel();
            } else {
                const humor = getRandomHumor('fleeFail');
                notifyDanger('칔t캩k selhal!', humor);
                fightTravelEnemy(enemyId);
            }
        }
        
        function continueTravel() {
            resolveCurrentEvent(); // Ozna캜 event jako vy콏e코en칳
            closeModal();
            renderFull();
        }
        
        // Zru코en칤 cestov치n칤 - vr치tit se zp캩t
        function cancelTravel() {
            if (!state.world.traveling) return;
            
            // Zjisti odkud jsme vy코li (p콏edchoz칤 lokace)
            const fromLocation = state.world.currentLocation;
            
            // Zru코 cestov치n칤
            state.world.traveling = false;
            state.world.travelTo = null;
            state.world.travelPath = null;
            state.world.scheduledEvents = [];
            
            // Synchronizace pro zp캩tnou kompatibilitu
            state.map.traveling = false;
            
            addLog('Vr치til ses zp캩t na ' + getLocName(fromLocation), '뾆잺');
            notifyInfo('뾆잺 Cesta zru코ena', 'Vr치til ses na ' + getLocName(fromLocation));
            
            renderFull();
        }
        
        function checkTravelComplete() {
            if (!state.world.traveling) return;
            
            const now = Date.now();
            if (now >= state.world.travelStart + state.world.travelDuration) {
                // Dorazili jsme
                state.world.traveling = false;
                state.world.currentLocation = state.world.travelTo;
                
                // P콏idej do nav코t칤ven칳ch
                const isNewLocation = !state.world.visitedLocations.includes(state.world.travelTo);
                if (isNewLocation) {
                    state.world.visitedLocations.push(state.world.travelTo);
                    notifySuccess('Nov치 lokace objevena!', WORLD_LOCATIONS.find(l => l.id === state.world.travelTo)?.name);
                    
                    // Daily quest progress - explored (pouze nov칠)
                    if (state.dailyQuests.progress) {
                        state.dailyQuests.progress.explored = (state.dailyQuests.progress.explored || 0) + 1;
                        checkDailyQuests();
                    }
                    
                    // Update Settler quest progress (patrol - prozkoumej X lokac칤)
                    if (state.settlement?.activeQuests) {
                        state.settlement.activeQuests.forEach(sq => {
                            const questDef = SETTLER_QUESTS.find(q => q.id === sq.questId);
                            if (questDef?.request?.action === 'explore') {
                                if (!sq.progress) sq.progress = {};
                                sq.progress.explored = (sq.progress.explored || 0) + 1;
                            }
                        });
                    }
                }
                
                // === UPDATE NPC QUEST PROGRESS (pro KA콯DOU cestu) ===
                if (state.npcQuests) {
                    Object.keys(state.npcQuests).forEach(npcId => {
                        const quest = state.npcQuests[npcId];
                        if (!quest || !quest.id) return;
                        
                        const questDef = NPC_QUESTS[quest.id];
                        if (!questDef || !questDef.requirement) return;
                        
                        // Zajisti 쬰 progress existuje
                        if (!quest.progress) {
                            quest.progress = { explored: 0, kills: 0, escortLocations: 0, travels: 0 };
                        }
                        
                        // EXPLORE questy - po캜칤t치 JAK칄KOLIV nav코t칤ven칠 lokace (ne jen nov칠)
                        // Proto쬰 hr치캜 m콢쬰 m칤t quest "prozkoumej 3 lokace" i kdy u lokace nav코t칤vil
                        if (questDef.requirement.explore) {
                            quest.progress.explored = (quest.progress.explored || 0) + 1;
                            console.log(`游딬勇 Explore progress pro ${quest.id}: ${quest.progress.explored}/${questDef.requirement.explore}`);
                        }
                        
                        // ESCORT questy - po캜칤t치 ka쬯ou cestu
                        if (questDef.requirement.escort) {
                            quest.progress.escortLocations = (quest.progress.escortLocations || 0) + 1;
                            console.log(`游냙 Escort progress pro ${quest.id}: ${quest.progress.escortLocations}/${questDef.requirement.travels || 3}`);
                        }
                        
                        // TRAVELS questy (nap콏. deliver_package - nav코tiv X lokac칤)
                        if (questDef.requirement.travels && !questDef.requirement.escort) {
                            quest.progress.travels = (quest.progress.travels || 0) + 1;
                            console.log(`游뛌 Travels progress pro ${quest.id}: ${quest.progress.travels}/${questDef.requirement.travels}`);
                        }
                        
                        // VISIT questy - nav코tiv konkr칠tn칤 lokaci
                        if (questDef.requirement.visit && state.world.currentLocation === questDef.requirement.visit) {
                            quest.progress.visited = true;
                            console.log(`游늸 Visit quest ${quest.id} spln캩n - dos치hl lokace ${questDef.requirement.visit}`);
                            notifySuccess('Quest progress!', `Dos치hl jsi c칤lov칠 lokace`);
                        }
                    });
                }
                
                // Speci치ln칤 quest triggery p콏i pr콢zkumu
                checkSpecialQuestTriggers(state.world.currentLocation);
                
                travelEventTimeouts.forEach(t => clearTimeout(t));
                travelEventTimeouts = [];
                
                // Daily quest progress - travelled (ka쬯치 cesta)
                if (!state.dailyQuests.progress) state.dailyQuests.progress = {};
                state.dailyQuests.progress.travelled = (state.dailyQuests.progress.travelled || 0) + 1;
                checkDailyQuests();
                
                const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
                notifyTravel(loc?.name || '???', loc?.icon || '游늸');
                addLog('Dorazil na: ' + (loc?.name || '???'), '九');
                
                // === V츼LE캛N츼 Z칍NA - zobraz UI pokud jsme na v치le캜n칠 lokaci ===
                checkAndShowWarZone();
                
                // === KONTROLA POKLADU ===
                if (state.treasureLocation && state.treasureLocation.locationId === state.world.currentLocation) {
                    // Zkontroluj jestli nevypr코el
                    if (!state.treasureLocation.expiresAt || Date.now() < state.treasureLocation.expiresAt) {
                        // Nalezen poklad! Velk칠 odm캩ny za cestu
                        const treasureRewards = [
                            { money: 500 + Math.floor(Math.random() * 500), xp: 150 + Math.floor(Math.random() * 100), tokens: 100 },
                            { money: 400 + Math.floor(Math.random() * 400), xp: 200, item: 'stimpak', itemCount: 3 },
                            { money: 800 + Math.floor(Math.random() * 700), xp: 250 },
                            { money: 300 + Math.floor(Math.random() * 300), xp: 100, tokens: 200 + Math.floor(Math.random() * 100), item: 'bandage', itemCount: 5 },
                            { money: 600 + Math.floor(Math.random() * 600), xp: 175, item: 'medkit', itemCount: 1 },
                            { money: 1000 + Math.floor(Math.random() * 500), xp: 300, tokens: 150 } // jackpot
                        ];
                        const reward = treasureRewards[Math.floor(Math.random() * treasureRewards.length)];
                        
                        // Dej odm캩ny
                        if (reward.money) state.money = (state.money || 0) + reward.money;
                        if (reward.xp) addXP(reward.xp);
                        if (reward.tokens) addCasinoTokens(reward.tokens);
                        if (reward.item) {
                            const itemDef = ITEMS.find(i => i.id === reward.item);
                            if (itemDef) {
                                for (let i = 0; i < (reward.itemCount || 1); i++) {
                                    state.inv.push({...itemDef, count: 1});
                                }
                            }
                        }
                        
                        // Sma poklad
                        const treasureName = state.treasureLocation.locationName;
                        state.treasureLocation = null;
                        state.stats = state.stats || {};
                        state.stats.treasuresFound = (state.stats.treasuresFound || 0) + 1;
                        
                        setTimeout(() => {
                            const itemInfo = reward.item ? ITEMS.find(i => i.id === reward.item) : null;
                            showModal('游눑 POKLAD NALEZEN!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem; margin-bottom: 1rem;">游눑游꿀</div>
                                    <h3 style="color: #ffd700; margin-bottom: 1rem;">Na코el jsi poklad!</h3>
                                    <p style="color: #888; margin-bottom: 1rem;">Ukryt칳 v lokaci ${treasureName}</p>
                                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; border: 2px solid #4caf50;">
                                        ${reward.money ? `<p style="color: #ffd700; font-size: 1.3rem; font-weight: bold;">+${reward.money} 游눯</p>` : ''}
                                        ${reward.xp ? `<p style="color: #8bc34a; font-size: 1.1rem;">+${reward.xp} XP</p>` : ''}
                                        ${reward.tokens ? `<p style="color: #9c27b0; font-size: 1.1rem;">+${reward.tokens} 游꿞</p>` : ''}
                                        ${itemInfo ? `<p style="color: #64b5f6;">+${reward.itemCount || 1}x ${itemInfo.icon} ${itemInfo.name}</p>` : ''}
                                    </div>
                                </div>
                                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">Super!</button>
                            `);
                        }, 1000);
                        
                        saveGame(true);
                    } else {
                        // Poklad vypr코el
                        state.treasureLocation = null;
                    }
                }
                
                // Syst칠mov치 notifikace
                sendSystemNotification('Dorazil jsi!', loc?.name || 'Nov치 lokace', '游늸');
                MobileNotifications.notifyTravelComplete(loc?.name || 'Nov치 lokace');
                
                // === KONTROLA ZRAN캨N칈 Z CESTOV츼N칈 ===
                if (typeof checkTravelInjury === 'function' && state.world.travelPath) {
                    const distance = state.world.travelPath.distance || 10;
                    const danger = state.world.travelPath.danger || 0;
                    checkTravelInjury(distance, danger);
                }
                
                // Quest notifikace - upozorn캩n칤 na questy na t칠to lokaci
                setTimeout(() => {
                    checkQuestNotifications(state.world.currentLocation);
                }, 1500);
                
                // Speci치ln칤 uv칤t치n칤 pro Bu캜ovice
                if (state.world.currentLocation === 'bucovice') {
                    setTimeout(() => {
                        showBucoviceWelcome();
                    }, 800);
                }
                
                // XP za cestu
                addXP(5 + Math.floor(Math.random() * 10));
                
                // Radiace na nebezpe캜n칳ch lokac칤ch (men코칤 d치vka p콏i p콏칤jezdu)
                if (loc?.radiation) {
                    // Radiace je per-minute, p콏i p콏칤jezdu dostane코 jen zlomek
                    let radGain = Math.ceil(loc.radiation * 0.2); // 20% z hodnoty
                    // Mutant class: -50% radiace
                    if (state.char.class === 'mutant') {
                        radGain = Math.floor(radGain * 0.5);
                    }
                    // Mutace Radia캜n칤 adaptace: -70% radiace
                    if (state.mutations?.includes('radiation_adaptation')) {
                        radGain = Math.floor(radGain * 0.3);
                    }
                    if (radGain > 0) {
                        state.status.radiation = Math.min(100, state.status.radiation + radGain);
                        notifyWarning('Radiace!', '+' + radGain + ' 驕뮖잺');
                    }
                }
                
                state.world.travelTo = null;
                state.world.travelPath = null;
                
                // Synchronizace pro zp캩tnou kompatibilitu
                state.map.traveling = false;
                state.map.inBase = (state.world.currentLocation === 'shelter');
                
                // Aktualizuj quest progress
                updateQuestProgress('location', state.world.currentLocation);
                updateQuestProgress('visit_locations', state.world.visitedLocations.length);
                
                // Kontrola timed a companion quest콢
                checkTimedQuestObjectives('location', state.world.currentLocation);
                checkCompanionQuestObjectives('location', state.world.currentLocation);
                
                // Kontrola daily quest콢
                checkDailyQuests();
                
                // Kontrola achievement콢 po cest캩
                checkAchievements();
                
                renderFull();
            }
        }
        
        // Sb칤r치n칤 zdroj콢 na resource lokac칤ch
        function gatherResources(skipLimitCheck = false) {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            // Povolit sb칤r치n칤 pro resource lokace NEBO pro lesn칤 lokace
            const isForest = loc && (loc.id === 'forest_edge' || loc.id === 'dense_forest' || loc.icon === '游' || loc.icon === '游꺕');
            if (!loc || (loc.type !== 'resource' && !isForest)) return;
            
            // Kontrola denn칤ho limitu (3x za 24 hodin) - p콏esko캜it pokud vol치no z executeGathering
            if (!skipLimitCheck) {
                const limit = checkDailyActionLimit('gather', loc.id);
                if (!limit.canDo) {
                    const hours = Math.ceil(limit.resetIn / (1000 * 60 * 60));
                    notifyWarning('Vy캜erp치no', 'Tato lokace je vy캜erpan치. Reset za ' + hours + ' hodin.');
                    return;
                }
                // Pou쬴j limit
                useActionLimit('gather', loc.id);
            }
            
            state.status.energy = Math.max(0, state.status.energy - 5);
            
            // Sb칤r치n칤 podle lokace
            let gathered = [];
            
            if (loc.id === 'berry_bushes') {
                // Bobule a byliny
                const berries = 2 + Math.floor(Math.random() * 3);
                const herbs = 1 + Math.floor(Math.random() * 2);
                state.resources.herbs = (state.resources.herbs || 0) + herbs;
                gathered.push({ name: 'Byliny', amount: herbs, icon: '游' });
                
                // P콏idej j칤dlo (bobule)
                const berryItem = { id: 'berries', name: 'Bor콢vky', icon: '游삃', type: 'consumable', effect: 'hunger', value: 15, weight: 0.2, count: berries };
                const existing = state.inv.find(i => i.id === 'berries');
                if (existing) {
                    existing.count = (existing.count || 1) + berries;
                } else {
                    state.inv.push(berryItem);
                }
                gathered.push({ name: 'Bor콢vky', amount: berries, icon: '游삃' });
            } else if (loc.id === 'water_well') {
                // Voda
                const water = 2 + Math.floor(Math.random() * 2);
                const waterItem = { id: 'water', name: 'L치hev vody', icon: '游눦', type: 'consumable', effect: 'thirst', value: 40, weight: 1, count: water };
                const existing = state.inv.find(i => i.id === 'water');
                if (existing) {
                    existing.count = (existing.count || 1) + water;
                } else {
                    state.inv.push(waterItem);
                }
                gathered.push({ name: 'L치hev vody', amount: water, icon: '游눦' });
            } else if (loc.id === 'forest_edge') {
                // D콏evo a byliny
                const wood = 3 + Math.floor(Math.random() * 3);
                const herbs = 1 + Math.floor(Math.random() * 2);
                state.resources.wood = (state.resources.wood || 0) + wood;
                state.resources.herbs = (state.resources.herbs || 0) + herbs;
                gathered.push({ name: 'D콏evo', amount: wood, icon: '游' });
                gathered.push({ name: 'Byliny', amount: herbs, icon: '游' });
            } else if (loc.id === 'dense_forest') {
                // Hust칳 les - v칤ce d콏eva, mo쬹치 k콢쬰
                const wood = 4 + Math.floor(Math.random() * 4);
                const herbs = 2 + Math.floor(Math.random() * 2);
                state.resources.wood = (state.resources.wood || 0) + wood;
                state.resources.herbs = (state.resources.herbs || 0) + herbs;
                gathered.push({ name: 'D콏evo', amount: wood, icon: '游' });
                gathered.push({ name: 'Byliny', amount: herbs, icon: '游' });
                // 마nce na k콢쬴 (spadan칠 v캩tve s mechem)
                if (Math.random() < 0.3) {
                    state.resources.leather = (state.resources.leather || 0) + 1;
                    gathered.push({ name: 'K콢쬰', amount: 1, icon: '游붮' });
                }
            } else if (loc.resource === 'stone' || loc.id === 'quarry_01') {
                // K치men a ruda
                const stone = 4 + Math.floor(Math.random() * 4);
                const metal = Math.floor(Math.random() * 3);
                state.resources.stone = (state.resources.stone || 0) + stone;
                gathered.push({ name: 'K치men', amount: stone, icon: '游뿯' });
                if (metal > 0) {
                    state.resources.metal = (state.resources.metal || 0) + metal;
                    gathered.push({ name: '콯elezo', amount: metal, icon: '丘뙖잺' });
                }
                // Mal치 코ance na m캩캞
                if (Math.random() < 0.15) {
                    state.resources.copper = (state.resources.copper || 0) + 1;
                    gathered.push({ name: 'M캩캞', amount: 1, icon: '游댰' });
                }
            } else {
                // Obecn칠 - n치hodn칠 suroviny
                const resources = ['wood', 'stone', 'cloth', 'herbs'];
                const resId = resources[Math.floor(Math.random() * resources.length)];
                const amount = 2 + Math.floor(Math.random() * 3);
                state.resources[resId] = (state.resources[resId] || 0) + amount;
                const icons = { wood: '游', stone: '游뿯', cloth: '游빗', herbs: '游' };
                const names = { wood: 'D콏evo', stone: 'K치men', cloth: 'L치tka', herbs: 'Byliny' };
                gathered.push({ name: names[resId], amount: amount, icon: icons[resId] });
            }
            
            // Zobraz v칳sledek
            const remainingLimit = checkDailyActionLimit('gather', loc.id);
            let resultHtml = '<div style="text-align: center;">';
            resultHtml += '<div style="font-size: 3rem; margin-bottom: 1rem;">游빜</div>';
            resultHtml += '<h3 style="color: var(--toxic-green);">Nasb칤r치no!</h3>';
            resultHtml += '<div style="margin: 1rem 0;">';
            gathered.forEach(g => {
                resultHtml += '<p>' + g.icon + ' ' + g.name + ': <strong>+' + g.amount + '</strong></p>';
            });
            resultHtml += '</div>';
            resultHtml += '<p style="color: #888; font-size: 0.85rem;">Zb칳v치 pokus콢: ' + remainingLimit.remaining + '/3</p>';
            resultHtml += '</div>';
            if (remainingLimit.canDo) {
                resultHtml += '<button class="btn" onclick="closeModal(); showActionModal(\'gather\');" style="width: 100%; margin-top: 0.5rem;">游빜 Sb칤rat znovu</button>';
            }
            resultHtml += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">OK</button>';
            
            showModal('游빜 Sb칤r치n칤', resultHtml);
            addXP(3 + Math.floor(Math.random() * 5));
            updateCarryWeight();
            renderFull();
        }
        
        // Pr콢zkum nebezpe캜n칠 oblasti
        function exploreDangerousArea() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            // Cooldown
            const cooldownKey = 'dangerous_' + loc.id;
            const lastExplore = state.world.locationCooldowns[cooldownKey] || 0;
            const cooldownTime = 10 * 60 * 1000; // 10 minut
            const now = Date.now();
            
            if (now - lastExplore < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastExplore)) / 1000);
                const mins = Math.floor(remaining / 60);
                notifyWarning('Nebezpe캜칤!', 'Po캜kej ' + mins + ' min');
                return;
            }
            
            state.world.locationCooldowns[cooldownKey] = now;
            
            // Radiace
            const radGain = loc.radiation || 10;
            state.status.radiation = Math.min(100, state.status.radiation + radGain);
            
            // N치hodn칳 v칳sledek
            const roll = Math.random();
            if (roll < 0.4) {
                // Boj
                const enemyId = loc.enemies?.[Math.floor(Math.random() * loc.enemies.length)] || 'mutant';
                showModal('丘멆잺 Nebezpe캜칤!', 
                    '<p>V nebezpe캜n칠 oblasti jsi narazil na nep콏칤tele!</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' 驕뮖잺 radiace</p>' +
                    '<button class="btn" onclick="closeModal(); startCombat({id: \'' + enemyId + '\'});" style="width: 100%; margin-top: 1rem; background: #8B0000;">丘덢잺 Bojovat</button>'
                );
            } else if (roll < 0.7) {
                // Vz치cn칳 loot
                const rareItems = ['radaway', 'stimpack', 'electronics', 'chemicals'];
                const itemId = rareItems[Math.floor(Math.random() * rareItems.length)];
                state.resources[itemId] = (state.resources[itemId] || 0) + 1;
                showModal('游눑 Vz치cn칳 n치lez!', 
                    '<p>V nebezpe캜n칠 oblasti jsi na코el n캩co cenn칠ho!</p>' +
                    '<p style="color: #8bc34a;">+1 ' + itemId + '</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' 驕뮖잺 radiace</p>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
                );
                addXP(20);
            } else {
                // Nic
                showModal('驕뮖잺 Pr치zdno', 
                    '<p>Nic zaj칤mav칠ho jsi nena코el, jen radiaci...</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' 驕뮖잺 radiace</p>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
                );
            }
            renderFull();
        }
        
        // Odpo캜inek v t치bo콏e
        function showRestInfo() {
            const hpGain = 20;
            const energyGain = 30;
            
            showModal('游눣 Odpo캜inek', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">久</div>
                    <p style="color: #888;">Odpo캜i켿 si v bezpe캜칤 osady.</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">Co z칤sk치코:</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.3rem; font-size: 0.9rem;">
                        <div>仇벒잺 +${hpGain} HP</div>
                        <div>丘 +${energyGain} Energie</div>
                        <div>游꼤 -10 Hlad</div>
                        <div>游눦 -10 콯칤ze켿</div>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal(); restAtCamp();" style="width: 100%; background: #3949AB;">
                    游눣 Odpo캜inout
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    九 Zru코it
                </button>
            `);
        }
        
        function restAtCamp() {
            const energyCost = 0;
            const hpGain = 20;
            const energyGain = 30;
            
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + hpGain);
            state.status.energy = Math.min(100, state.status.energy + energyGain);
            state.status.hunger = Math.max(0, state.status.hunger - 10);
            state.status.thirst = Math.max(0, state.status.thirst - 10);
            
            showModal('游눣 Odpo캜inek', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">久</div>' +
                '<h3>Odpo캜inul sis v t치bo콏e</h3>' +
                '<p style="color: #8bc34a;">+' + hpGain + ' HP, +' + energyGain + ' energie</p>' +
                '<p style="color: #ff9800;">-10 hlad, -10 쮂셬e켿</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
            );
            addLog('Odpo캜inek v t치bo콏e', '久');
            renderFull();
        }
        
        // T치bor치k
        function makeCampfire() {
            const woodCost = 3;
            const currentWood = state.resources.wood || 0;
            
            if (currentWood < woodCost) {
                notifyWarning('Nedostatek', `Pot콏ebuje코 ${woodCost} d콏eva (m치코 ${currentWood})`);
                return;
            }
            
            // Zobraz potvrzovac칤 dialog
            showModal('游댠 Rozd캩lat t치bor치k?', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游댠</div>
                    <p style="color: #888;">Rozd캩l치코 ohe켿 a m콢쬰코 va콏it j칤dlo.</p>
                </div>
                
                <div style="background: #2a1a0a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #E65100;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #ff9800;">游 Cena:</span>
                        <span style="color: #fff; font-weight: bold;">${woodCost} d콏eva</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <span style="color: #888;">M치코:</span>
                        <span style="color: ${currentWood >= woodCost ? '#8bc34a' : '#f44336'};">${currentWood} d콏eva</span>
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.9rem;">九 Bonus: +20 n치lada</p>
                    <p style="color: #ff9800; margin: 0.3rem 0 0 0; font-size: 0.9rem;">游꼽 Umo쬹칤 va콏en칤 j칤dla</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="confirmCampfire()" style="background: #E65100;">游댠 Rozd캩lat</button>
                </div>
            `);
        }
        
        function confirmCampfire() {
            if ((state.resources.wood || 0) < 3) {
                notifyWarning('Nedostatek', 'Pot콏ebuje코 3 d콏eva');
                closeModal();
                return;
            }
            
            state.resources.wood -= 3;
            state.status.mood = Math.min(100, (state.status.mood || 50) + 20);
            
            showModal('游댠 T치bor치k ho콏칤!', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">游댠</div>' +
                '<h3 style="color: #8bc34a;">Rozd캩lal jsi ohe켿</h3>' +
                '<p style="color: #8bc34a;">+20 n치lada</p>' +
                '<p style="color: #888; font-size: 0.85rem;">-3 d콏eva</p>' +
                '<p style="margin-top: 1rem; color: #ff9800;">Te캞 m콢쬰코 va콏it!</p>' +
                '</div>' +
                '<button class="btn" onclick="openCookingMenu()" style="width: 100%; margin-top: 0.5rem; background: #E65100;">游꼽 Va콏it</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 Zav콏칤t</button>'
            );
            renderFull();
        }
        
        // Mluvit s NPC na lokaci
        function talkToLocationNPC() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            // Najdi STORY_NPC na t칠to lokaci
            for (const [npcId, npc] of Object.entries(STORY_NPCS)) {
                if (npc.location === loc.id) {
                    // V콢dce p콏e쬴v코칤ch jen po dokon캜en칤 p콏칤b캩hu
                    if (npcId === 'survivor_leader' && !state.mainQuest?.storyComplete) continue;
                    
                    // Gener치l jen pokud m치me spr치vn칳 quest
                    if (npcId === 'general' && state.mainQuest?.currentQuest !== 'find_general') continue;
                    
                    // Na코li jsme NPC - zavolej talkToNPC
                    talkToNPC(npcId);
                    return;
                }
            }
            
            // Hermit/Poustevn칤k - speci치ln칤 NPC
            if (loc.id === 'hermit_hut') {
                showModal('游븿 Poustevn칤k', 
                    '<div style="text-align: center;">' +
                    '<div style="font-size: 3rem;">游븿</div>' +
                    '<p>"Ahoj, poutn칤ku. Jsem tu s치m u mnoho let..."</p>' +
                    '<p>"Mohu ti nab칤dnout moudrost, nebo l칠캜en칤."</p>' +
                    '</div>' +
                    '<button class="btn" onclick="hermitHeal()" style="width: 100%; margin-top: 0.5rem; background: #c62828;">游눍 L칠캜en칤 (50游눯)</button>' +
                    '<button class="btn" onclick="hermitWisdom()" style="width: 100%; margin-top: 0.5rem; background: #9C27B0;">游닆 Moudrost</button>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">九 Odej칤t</button>'
                );
                return;
            }
            
            // Potuln칳 obchodn칤k - speci치ln칤 exotick칠 zbo쮂
            if (loc.id === 'wandering_merchant') {
                openExoticShop();
                return;
            }
            
            // 콯치dn칳 NPC nenalezen
            showModal('游뱡 Nikdo tu nen칤', 
                '<p>Na t칠to lokaci nen칤 nikdo, s k칳m bys mohl mluvit.</p>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
            );
        }
        
        function hermitHeal() {
            if (getMoney() < 50) {
                notifyWarning('Nedostatek', 'Pot콏ebuje코 50 游눯');
                return;
            }
            removeMoney(50);
            state.char.hp = state.char.maxHp;
            state.status.radiation = 0;
            closeModal();
            notifySuccess('Vyl칠캜en!', 'Pln칠 HP, 0 radiace');
            renderFull();
        }
        
        function hermitWisdom() {
            const wisdoms = [
                "V pustin캩 p콏e쬴je ten, kdo um칤 캜ekat.",
                "Voda je cenn캩j코칤 ne zlato.",
                "Nikdy necestuj v noci bez sv캩tla.",
                "Mutanti se boj칤 ohn캩.",
                "Ka쬯칳 nep콏칤tel m치 slabinu."
            ];
            const wisdom = wisdoms[Math.floor(Math.random() * wisdoms.length)];
            addXP(10);
            showModal('游닆 Moudrost', 
                '<div style="text-align: center;">' +
                '<p style="font-style: italic; color: #9C27B0;">"' + wisdom + '"</p>' +
                '<p style="color: #8bc34a; margin-top: 1rem;">+10 XP</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
            );
        }
        
        // === POTULN칗 OBCHODN칈K - VYLEPEN칄 EXOTICK칄 ZBO콯칈 ===
        const EXOTIC_ITEMS = [
            { id: 'ancient_map', name: 'Star치 mapa', icon: '游딬勇', price: 400, desc: 'Odhal칤 3 n치hodn칠 lokace', effect: 'reveal_locations', rarity: 'rare' },
            { id: 'mysterious_serum', name: 'Z치hadn칠 s칠rum', icon: '游눌', price: 750, desc: '+5 max HP trvale', effect: 'permanent_hp', rarity: 'epic' },
            { id: 'traders_compass', name: 'Obchodnick칳 kompas', icon: '游빐', price: 500, desc: '-10% n치kupn칤 ceny trvale', effect: 'shop_discount', rarity: 'rare' },
            { id: 'lucky_coin', name: '먠벼stn치 mince', icon: '游뿣', price: 450, desc: '+15% 코ance na lep코칤 loot', effect: 'luck_bonus', rarity: 'rare' },
            { id: 'mutant_gland', name: 'Mutant칤 쬷치za', icon: '游빏', price: 800, desc: 'Imunita v콢캜i 1 mutaci', effect: 'mutation_resist', rarity: 'epic' },
            { id: 'pre_war_tech', name: 'P콏edv치le캜n치 tech', icon: '游', price: 1000, desc: '+25% XP na 48 hodin', effect: 'xp_boost', rarity: 'epic' },
            { id: 'exotic_spice', name: 'Exotick칠 ko콏en칤', icon: '游꺘勇', price: 200, desc: 'Dvojn치sobn칳 efekt j칤dla (5x)', effect: 'food_boost', rarity: 'uncommon' },
            { id: 'caravan_whistle', name: 'Karavann칤 p칤코콘alka', icon: '游꿧', price: 600, desc: 'P콏ivol치 karavanu kamkoliv (3x)', effect: 'summon_caravan', rarity: 'rare' },
            { id: 'radiation_talisman', name: 'Radia캜n칤 talisman', icon: '驕뮖잺', price: 700, desc: '-50% radiace trvale', effect: 'rad_resist', rarity: 'epic' },
            { id: 'legendary_blueprint', name: 'Legend치rn칤 pl치n', icon: '游닆', price: 1500, desc: 'Nau캜칤 legendary recept', effect: 'learn_recipe', rarity: 'legendary' },
            { id: 'enhanced_stimpack', name: 'Vylep코en칳 stimpak', icon: '游눌', price: 300, desc: 'L칠캜칤 200 HP (3x)', effect: 'super_heal', rarity: 'rare' },
            { id: 'void_crystal', name: 'Krystal pr치zdnoty', icon: '游눑', price: 1200, desc: '+10% v코echen damage trvale', effect: 'damage_boost', rarity: 'legendary' }
        ];
        
        function generateWanderingStock() {
            // Generuj z치soby - 4-5 n치hodn칳ch polo쬰k s mno쬽tv칤m 1
            const shuffled = [...EXOTIC_ITEMS].sort(() => Math.random() - 0.5);
            const count = 4 + Math.floor(Math.random() * 2);
            const stock = {};
            
            shuffled.slice(0, count).forEach(item => {
                stock[item.id] = 1; // Ka쬯칳 item jen 1x
            });
            
            return stock;
        }
        
        function openExoticShop() {
            // Kontrola otev칤rac칤 doby
            if (!isShopOpen('wandering')) {
                showModal('游깿 Obchodn칤k odpo캜칤v치', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游냙游눣</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Potuln칳 obchodn칤k odpo캜칤v치!</p>
                        <p style="color: #888; margin: 1rem 0;">낋 Otev칤rac칤 doba: 10:00 - 16:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu치ln칤 캜as: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #555; font-size: 0.8rem; margin-top: 0.5rem;">游눠 Obchodn칤k cestuje brzy r치no a ve캜er.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Inicializuj nebo resetuj z치soby ka쬯칠 3 dny
            const now = Date.now();
            const threeDays = 3 * 24 * 60 * 60 * 1000;
            
            if (!state.wanderingMerchant || (now - (state.wanderingMerchant.lastRestock || 0)) > threeDays) {
                state.wanderingMerchant = {
                    lastRestock: now,
                    stock: generateWanderingStock()
                };
            }
            
            const stock = state.wanderingMerchant.stock;
            const available = EXOTIC_ITEMS.filter(item => (stock[item.id] || 0) > 0);
            
            // 캛as do resetu
            const nextRestock = new Date((state.wanderingMerchant.lastRestock || now) + threeDays);
            const hoursUntilRestock = Math.max(0, Math.ceil((nextRestock - now) / 3600000));
            const daysUntilRestock = Math.floor(hoursUntilRestock / 24);
            const remainingHours = hoursUntilRestock % 24;
            const restockText = daysUntilRestock > 0 
                ? `${daysUntilRestock}d ${remainingHours}h` 
                : `${remainingHours}h`;
            
            const rarityColors = {
                uncommon: '#4caf50',
                rare: '#2196f3', 
                epic: '#9c27b0',
                legendary: '#ffd700'
            };
            
            let itemsHtml = available.length > 0 ? available.map(item => {
                const canAfford = getMoney() >= item.price;
                const rarityColor = rarityColors[item.rarity] || '#888';
                return `
                    <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; border: 2px solid ${rarityColor}; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-size: 1.3rem;">${item.icon} <span style="color: ${rarityColor};">${item.name}</span></div>
                            <div style="font-size: 0.8rem; color: #888;">${item.desc}</div>
                            <div style="font-size: 0.7rem; color: ${rarityColor}; text-transform: uppercase;">${item.rarity}</div>
                        </div>
                        <button class="btn" onclick="buyExoticItem('${item.id}')" style="background: ${canAfford ? rarityColor : '#333'}; color: ${canAfford ? '#fff' : '#666'}; ${!canAfford ? 'cursor: not-allowed;' : ''}">
                            游눯 ${item.price}
                        </button>
                    </div>
                `;
            }).join('') : '<p style="text-align: center; color: #666; padding: 2rem;">Vyprod치no! Vra콘 se za p치r dn칤.</p>';
            
            showModal('游냙 Potuln칳 obchodn칤k', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游냙</div>
                    <p style="color: #ffd700; font-style: italic;">"M치m vz치cn칠 v캩ci, kter칠 jinde nenajde코..."</p>
                    <p style="color: #888;">游눯 Tv칠 pen칤ze: ${getMoney()}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #888; font-size: 0.8rem;">낋 Otev콏eno: 10:00 - 16:00</span>
                    <span style="color: #ff9800; font-size: 0.8rem;">游댃 Reset: ${restockText}</span>
                </div>
                
                <div style="max-height: 280px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${itemsHtml}
                </div>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.5rem;">丘멆잺 Omezen칠 z치soby! Ka쬯칳 item jen 1x za 3 dny.</p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Odej칤t</button>
            `);
        }
        
        function buyExoticItem(itemId) {
            const item = EXOTIC_ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // Kontrola z치sob
            if (!state.wanderingMerchant?.stock || (state.wanderingMerchant.stock[itemId] || 0) <= 0) {
                notifyWarning('Vyprod치no!', 'Tento p콏edm캩t u nem치m');
                return;
            }
            
            if (getMoney() < item.price) {
                notifyWarning('M치lo pen캩z!', `Pot콏ebuje코 ${item.price} 游눯`);
                return;
            }
            
            removeMoney(item.price);
            
            // Odeber ze z치sob
            state.wanderingMerchant.stock[itemId]--;
            
            // Aplikuj efekt
            switch(item.effect) {
                case 'reveal_locations':
                    const unvisited = WORLD_LOCATIONS.filter(l => !state.world.visitedLocations?.includes(l.id) && l.type !== 'empty');
                    const toReveal = unvisited.slice(0, 3).map(l => l.id);
                    if (!state.world.revealedLocations) state.world.revealedLocations = [];
                    state.world.revealedLocations.push(...toReveal);
                    notifySuccess('Mapa pou쬴ta!', `Odhaleno ${toReveal.length} lokac칤`);
                    break;
                    
                case 'permanent_hp':
                    state.char.maxHp = (state.char.maxHp || 100) + 5;
                    state.char.hp = Math.min(state.char.hp + 5, state.char.maxHp);
                    notifySuccess('S칠rum 칰캜inkuje!', '+5 max HP trvale!');
                    break;
                    
                case 'shop_discount':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.shopDiscount = (state.exoticBonuses.shopDiscount || 0) + 0.1;
                    notifySuccess('Kompas aktivn칤!', '-10% n치kupn칤 ceny trvale!');
                    break;
                    
                case 'luck_bonus':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.luck = (state.exoticBonuses.luck || 0) + 0.15;
                    notifySuccess('맚캩st칤!', '+15% 코ance na lep코칤 loot (trvale)');
                    break;
                    
                case 'mutation_resist':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.mutationResist = (state.exoticBonuses.mutationResist || 0) + 1;
                    notifySuccess('Ochrana!', 'P콏칤코t칤 mutace bude zablokov치na');
                    break;
                    
                case 'xp_boost':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.xpBoost = Date.now() + (48 * 60 * 60 * 1000);
                    notifySuccess('Tech aktivov치na!', '+25% XP na 48 hodin');
                    break;
                    
                case 'food_boost':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.foodBoost = (state.exoticBonuses.foodBoost || 0) + 5;
                    notifySuccess('Ko콏en칤!', 'Dal코칤ch 5 j칤del m치 dvojn치sobn칳 efekt');
                    break;
                    
                case 'summon_caravan':
                    // P콏idej do invent치콏e jako pou쬴teln칳 p콏edm캩t (3 pou쬴t칤)
                    const existing = state.inv.find(i => i.id === 'caravan_whistle');
                    if (existing) {
                        existing.count = (existing.count || 1) + 3;
                    } else {
                        state.inv.push({ id: 'caravan_whistle', name: 'Karavann칤 p칤코콘alka', icon: '游꿧', type: 'consumable', count: 3, desc: 'P콏ivol치 karavanu' });
                    }
                    notifySuccess('P칤코콘alka z칤sk치na!', '3x pou쬴t칤 - p콏ivol치 karavanu kamkoliv');
                    break;
                    
                case 'rad_resist':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.radResistPermanent = (state.exoticBonuses.radResistPermanent || 0) + 0.5;
                    notifySuccess('Talisman aktivn칤!', '-50% radiace trvale!');
                    break;
                    
                case 'super_heal':
                    // P콏idej do invent치콏e (3 pou쬴t칤)
                    const existingStim = state.inv.find(i => i.id === 'enhanced_stimpack');
                    if (existingStim) {
                        existingStim.count = (existingStim.count || 1) + 3;
                    } else {
                        state.inv.push({ id: 'enhanced_stimpack', name: 'Vylep코en칳 stimpak', icon: '游눌', type: 'consumable', effect: 'health', value: 200, count: 3, weight: 0.3 });
                    }
                    notifySuccess('Stimpaky z칤sk치ny!', '3x Vylep코en칳 stimpak (200 HP)');
                    break;
                    
                case 'damage_boost':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.damageBoost = (state.exoticBonuses.damageBoost || 0) + 0.1;
                    notifySuccess('Krystal absorbov치n!', '+10% v코echen damage trvale!');
                    break;
                    
                case 'learn_recipe':
                    // P콏idej n치hodn칳 legend치rn칤 recept
                    const legendaryRecipes = ['legendary_blade', 'power_armor', 'plasma_rifle'];
                    const recipe = legendaryRecipes[Math.floor(Math.random() * legendaryRecipes.length)];
                    state.learnedRecipes = state.learnedRecipes || [];
                    if (!state.learnedRecipes.includes(recipe)) {
                        state.learnedRecipes.push(recipe);
                        notifySuccess('Nov칳 recept!', `Nau캜il ses: ${recipe}`);
                    } else {
                        // Refund pokud u m치
                        addMoney(item.price);
                        notifyInfo('U zn치코', 'Tento recept u um칤코, pen칤ze vr치ceny');
                    }
                    break;
            }
            
            closeModal();
            renderFull();
        }
        
        // Nav코t칤vit osadu p콏e쬴v코칤ch
        function visitSettlement() {
            showModal('游끶勇 Osada p콏e쬴v코칤ch', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">游끶勇</div>' +
                '<p>Mal치 komunita p콏e쬴v코칤ch t캩 v칤t치.</p>' +
                '<p style="color: #888;">M콢쬰코 zde obchodovat a odpo캜칤vat.</p>' +
                '</div>' +
                '<button class="btn" onclick="openShop()" style="width: 100%; margin-top: 0.5rem; background: var(--rust-light);">游 Obchod</button>' +
                '<button class="btn" onclick="restAtCamp()" style="width: 100%; margin-top: 0.5rem; background: #3949AB;">游눣 Odpo캜inek</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">九 Odej칤t</button>'
            );
        }
        
        // 캛erpat palivo
        function collectFuel() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            // Cooldown
            const cooldownKey = 'fuel_' + loc.id;
            const lastCollect = state.world.locationCooldowns[cooldownKey] || 0;
            const cooldownTime = 5 * 60 * 1000;
            const now = Date.now();
            
            if (now - lastCollect < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastCollect)) / 1000);
                const mins = Math.floor(remaining / 60);
                notifyWarning('캛ekej', 'Po캜kej ' + mins + ' min');
                return;
            }
            
            state.world.locationCooldowns[cooldownKey] = now;
            
            const amount = 2 + Math.floor(Math.random() * 3);
            state.resources.fuel = (state.resources.fuel || 0) + amount;
            
            showModal('久 Palivo', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">久</div>' +
                '<h3>Na캜erpal jsi palivo!</h3>' +
                '<p style="color: #8bc34a;">+' + amount + ' paliva</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%;">OK</button>'
            );
            addXP(5);
            renderFull();
        }

        function exploreLocation(skipLimitCheck = false) {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) {
                console.log('exploreLocation: No location found');
                return;
            }
            
            console.log('exploreLocation called for:', loc.name, 'skipLimitCheck:', skipLimitCheck);
            
            // Kontrola denn칤ho limitu (3x za 24 hodin) - p콏esko캜it pokud vol치no z executeExploring
            if (!skipLimitCheck) {
                const limit = checkDailyActionLimit('explore', loc.id);
                if (!limit.canDo) {
                    const hours = Math.floor(limit.resetIn / 3600000);
                    const mins = Math.floor((limit.resetIn % 3600000) / 60000);
                    notifyWarning('Lokace vy캜erpan치', `U jsi prozkoumal 3x. Dal코칤 za ${hours}h ${mins}m`);
                    return;
                }
                
                // Cooldown check - 5 minut mezi pr콢zkumy
                const cooldownKey = 'explore_' + loc.id;
                const now = Date.now();
                const lastExplore = state.world.locationCooldowns?.[cooldownKey] || 0;
                const cooldownTime = 5 * 60 * 1000; // 5 minut
                
                if (now - lastExplore < cooldownTime) {
                    const remaining = Math.ceil((cooldownTime - (now - lastExplore)) / 1000);
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    notifyWarning('Po캜kej chv칤li', `Dal코칤 pr콢zkum za ${mins}:${String(secs).padStart(2, '0')}`);
                    return;
                }
                
                // Pou쬴j limit a nastav cooldown
                useActionLimit('explore', loc.id);
                if (!state.world.locationCooldowns) state.world.locationCooldowns = {};
                state.world.locationCooldowns[cooldownKey] = now;
            }
            
            // Kontrola quest item콢 na t칠to lokaci
            if (state.world.questItems && state.world.questItems[loc.id]) {
                const questItemId = state.world.questItems[loc.id];
                const questItem = QUEST_ITEMS.find(i => i.id === questItemId);
                if (questItem) {
                    // Nalezen quest item! (quest itemy maj칤 v쬯y p콏ednost - nulov치 v치ha)
                    delete state.world.questItems[loc.id];
                    const questItemCopy = {...questItem, count: 1, weight: 0}; // Quest itemy nev치쮂
                    state.inv.push(questItemCopy);
                    updateQuestProgress('item', questItemId);
                    
                    showModal('游닆 Quest p콏edm캩t nalezen!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">${questItem.icon}</div>
                            <h3 style="color: #ffd700;">${questItem.name}</h3>
                            <p style="color: #888;">${questItem.desc || ''}</p>
                            <p style="color: #8bc34a; margin-top: 1rem;">P콏edm캩t p콏id치n do invent치콏e!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">九 V칳born캩!</button>
                    `);
                    addLog('Nalezen quest p콏edm캩t: ' + questItem.name, '游닆');
                    renderFull();
                    return;
                }
            }
            
            // === COMPANION QUEST ITEMS ===
            // Kontrola companion quest item콢 spawnovan칳ch na t칠to lokaci
            if (state.world.questItemSpawns) {
                for (const [itemId, spawnData] of Object.entries(state.world.questItemSpawns)) {
                    if (spawnData.location === loc.id) {
                        const questItem = QUEST_ITEMS.find(i => i.id === itemId);
                        if (questItem && !state.inv.some(i => i.id === itemId)) {
                            // 50% 코ance naj칤t companion quest item
                            if (Math.random() < 0.5) {
                                // Nalezen!
                                delete state.world.questItemSpawns[itemId];
                                const questItemCopy = {...questItem, count: 1, weight: 0};
                                state.inv.push(questItemCopy);
                                
                                // Update companion quest objective
                                const comp = state.companions?.find(c => c.id === spawnData.companion);
                                if (comp?.activeQuest) {
                                    comp.activeQuest.objectives.forEach(obj => {
                                        if (obj.target === itemId) {
                                            obj.completed = true;
                                        }
                                    });
                                }
                                
                                showModal('游눟 Companion Quest Item!', `
                                    <div style="text-align: center;">
                                        <div style="font-size: 4rem; margin-bottom: 1rem;">${questItem.icon}</div>
                                        <h3 style="color: #e91e63;">${questItem.name}</h3>
                                        <p style="color: #888;">${questItem.desc || ''}</p>
                                        <p style="color: #8bc34a; margin-top: 1rem;">Pro quest spole캜n칤ka!</p>
                                    </div>
                                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #e91e63;">九 V칳born캩!</button>
                                `);
                                addLog('Nalezen p콏edm캩t pro spole캜n칤ka: ' + questItem.name, '游눟');
                                renderFull();
                                return;
                            }
                        }
                    }
                }
            }
            
            // Kontrola detektivn칤ch stop na t칠to lokaci
            if (state.detectiveQuests) {
                Object.entries(state.detectiveQuests).forEach(([questId, dq]) => {
                    if (dq.solved) return;
                    const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
                    if (!quest) return;
                    
                    // Hledej stopy na t칠to lokaci
                    Object.entries(quest.clueLocations).forEach(([clueId, clueLoc]) => {
                        if (clueLoc === loc.id && !dq.cluesFound.includes(clueId)) {
                            // 40% 코ance naj칤t stopu p콏i pr콢zkumu
                            if (Math.random() < 0.4) {
                                findClue(questId, clueId);
                            }
                        }
                    });
                });
            }
            
            // Radiace pro dangerous lokace
            if (loc.type === 'dangerous' && loc.radiation) {
                const radGain = loc.radiation || 5;
                state.status.radiation = Math.min(100, state.status.radiation + radGain);
                addLog(`+${radGain} 驕뮖잺 radiace`, '驕뮖잺');
            }
            
            // === COMPANION QUEST - explore objective ===
            checkCompanionQuestObjectives('explore', loc.id);
            
            // 마nce na boj - z치vis칤 na z칩n캩 a danger level
            let combatChance = 0.15 + (loc.dangerLevel || 0) * 0.1;
            if (loc.zone === 'safe') combatChance = 0.10;
            if (loc.zone === 'medium') combatChance = Math.min(0.30, combatChance);
            if (loc.zone === 'danger') combatChance = Math.min(0.45, combatChance);
            if (loc.zone === 'deadly') combatChance = Math.min(0.55, combatChance);
            if (loc.type === 'dangerous') combatChance = Math.min(0.50, combatChance + 0.15);
            
            if (loc.enemies && loc.enemies.length > 0 && Math.random() < combatChance) {
                // Vyber n치hodn칠ho nep콏칤tele
                const enemyId = loc.enemies[Math.floor(Math.random() * loc.enemies.length)];
                const enemy = ENEMIES.find(e => e.id === enemyId) || ENEMIES[0];
                
                // Po캜et nep콏치tel - z치vis칤 na danger level
                let enemyCount = 1;
                const multiChance = 0.15 + (loc.dangerLevel || 0) * 0.1;
                if (Math.random() < multiChance) {
                    enemyCount = 2 + Math.floor(Math.random() * Math.min(3, loc.dangerLevel || 1));
                    enemyCount = Math.min(enemyCount, 4);
                }
                
                // Ob캜as sm칤코en치 skupina (pokud m치 lokace v칤ce typ콢 nep콏치tel)
                let displayHtml = '';
                if (enemyCount > 1 && loc.enemies.length > 1 && Math.random() < 0.35) {
                    // Sm칤코en치 skupina
                    let mixedEnemies = [];
                    for (let i = 0; i < enemyCount; i++) {
                        const eid = loc.enemies[Math.floor(Math.random() * loc.enemies.length)];
                        const e = ENEMIES.find(en => en.id === eid);
                        if (e) mixedEnemies.push(e);
                    }
                    displayHtml = `
                        <div style="display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
                            ${mixedEnemies.map(e => `<div style="text-align: center; background: #2a1a1a; padding: 0.5rem; border-radius: 8px;">
                                <div style="font-size: 1.8rem;">${e.icon}</div>
                                <div style="font-size: 0.7rem; color: #888;">${e.name}</div>
                            </div>`).join('')}
                        </div>
                        <p style="color: #ff6b6b; text-align: center; font-weight: bold;">${enemyCount}x nep콏치tel칠!</p>`;
                } else {
                    // Skupina stejn칳ch nep콏치tel
                    displayHtml = `
                        <div style="text-align: center; margin: 1rem 0;">
                            <div style="font-size: 3rem;">${enemy.icon}${enemyCount > 1 ? `<span style="font-size: 1.5rem; vertical-align: top; color: #ff6b6b;">칑${enemyCount}</span>` : ''}</div>
                            <h3 style="margin: 0.5rem 0;">${enemy.name}</h3>
                            ${enemyCount > 1 ? `<p style="color: #ff6b6b; margin: 0;">${`Skupina ${enemyCount} nep콏치tel!`}</p>` : ''}
                        </div>`;
                }
                
                showModal('丘덢잺 Nep콏칤tel!', 
                    '<p>P콏i pr콢zkumu jsi narazil na nep콏칤tele!</p>' +
                    displayHtml +
                    `<button class="btn" onclick="startCombat({id:'${enemy.id}'}, false, false, ${enemyCount})" style="width: 100%; background: #8B0000;">丘덢잺 ' + ('Bojovat!') + '</button>`
                );
                return;
            }
            
            // Loot - z치vis칤 na typu lokace a z칩n캩 ur캜uje maxim치ln칤 raritu
            let lootPool = [];
            
            // Scout skill bonus - zv칳코en치 코ance na vz치cn칠 p콏edm캩ty
            const scoutLevel = state.skills?.['scout'] || 0;
            const rareLootBonus = scoutLevel * 0.05; // +5% za level
            
            if (loc.zone === 'safe') {
                // Safe z칩na: jen common a uncommon (s bonusem m콢쬰 b칳t rare)
                const allowRare = rareLootBonus > 0 && Math.random() < rareLootBonus;
                lootPool = ITEMS.filter(i => 
                    (i.type === 'consumable' || i.type === 'resource' || i.type === 'tool') &&
                    (!i.rarity || i.rarity === 'common' || i.rarity === 'uncommon' || (allowRare && i.rarity === 'rare'))
                );
            } else if (loc.zone === 'medium') {
                // Medium z칩na: common, uncommon, rare (s bonusem m콢쬰 b칳t epic)
                const allowEpic = rareLootBonus > 0 && Math.random() < rareLootBonus;
                lootPool = ITEMS.filter(i => 
                    (i.type === 'consumable' || i.type === 'weapon' || i.type === 'armor' || i.type === 'resource') &&
                    (!i.rarity || i.rarity === 'common' || i.rarity === 'uncommon' || i.rarity === 'rare' || (allowEpic && i.rarity === 'epic'))
                );
            } else if (loc.zone === 'danger') {
                // Danger z칩na: v코echno krom캩 legendary (s bonusem m콢쬰 b칳t legendary)
                const allowLegendary = rareLootBonus > 0 && Math.random() < rareLootBonus * 0.5;
                lootPool = ITEMS.filter(i => 
                    (i.rarity !== 'legendary' || allowLegendary) && i.findChance && i.findChance > 0
                );
            } else if (loc.zone === 'deadly') {
                // Deadly z칩na: m콢쬰 padat v코echno v캜etn캩 legendary
                lootPool = ITEMS.filter(i => i.findChance && i.findChance > 0);
            } else {
                // Fallback - bez legendary
                lootPool = ITEMS.filter(i => 
                    (i.type === 'consumable' || i.type === 'resource') &&
                    i.rarity !== 'legendary' && i.rarity !== 'epic'
                );
            }
            
            // Fallback pokud je lootPool pr치zdn칳
            if (lootPool.length === 0) lootPool = ITEMS.filter(i => i.type === 'consumable' || i.type === 'resource').slice(0, 20);
            
            // 마nce na pr치zdn칳 n치lez (ZV칗ENO - m칠n캩 lootu)
            let emptyChance = 0.50; // Bylo 0.30, nyn칤 50% 코ance 쬰 nic nenajde코
            if (loc.zone === 'safe') emptyChance = 0.55;    // Bylo 0.35
            if (loc.zone === 'medium') emptyChance = 0.48;  // Bylo 0.28
            if (loc.zone === 'danger') emptyChance = 0.42;  // Bylo 0.22
            if (loc.zone === 'deadly') emptyChance = 0.35;  // Bylo 0.18
            
            const isEmpty = Math.random() < emptyChance;
            
            const lootItem = isEmpty ? null : lootPool[Math.floor(Math.random() * lootPool.length)];
            let foundItems = [];
            let groundItems = []; // Polo쬶y kter칠 z콢staly na zemi
            
            console.log('Explore loot item:', lootItem?.name || 'EMPTY');
            
            if (lootItem) {
                // Zkontroluj loot filtr
                const passesFilter = passesLootFilter(lootItem);
                
                if (!passesFilter) {
                    // Hr치캜 nechce tento typ - nech na zemi
                    addToGroundLoot({...lootItem});
                    groundItems.push(lootItem.icon + ' ' + lootItem.name + ' (filtr)');
                } else if (canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1);
                    notifyLoot(lootItem.name, lootItem.rarity, lootItem.icon);
                    foundItems.push(lootItem.icon + ' ' + lootItem.name);
                } else {
                    // Ulo na zem
                    addToGroundLoot({...lootItem});
                    groundItems.push(lootItem.icon + ' ' + lootItem.name);
                }
            }
            
            // Suroviny - z치vis칤 na typu lokace
            let resources = ['wood', 'metal', 'stone', 'cloth', 'scrap'];
            
            // Speci치ln칤 suroviny podle typu lokace
            if (loc.type === 'gas_station' || loc.id?.includes('gas') || loc.id?.includes('fuel')) {
                resources = ['fuel', 'scrap', 'metal', 'rope'];
            } else if (loc.type === 'explore' && (loc.id?.includes('city') || loc.id?.includes('ruin') || loc.id?.includes('mall'))) {
                resources = ['scrap', 'glass', 'cloth', 'electronics', 'rope'];
            } else if (loc.type === 'dungeon' && (loc.id?.includes('factory') || loc.id?.includes('plant'))) {
                resources = ['fuel', 'chemicals', 'scrap', 'metal', 'gunpowder'];
            } else if (loc.id?.includes('hospital') || loc.id?.includes('lab') || loc.id?.includes('research')) {
                resources = ['chemicals', 'glass', 'electronics', 'herbs'];
            } else if (loc.id?.includes('military') || loc.id?.includes('bunker') || loc.id?.includes('army')) {
                resources = ['metal', 'gunpowder', 'electronics', 'scrap', 'ammo'];
            } else if (loc.zone === 'danger' || loc.zone === 'deadly') {
                resources = ['scrap', 'metal', 'fuel', 'chemicals', 'electronics', 'gunpowder'];
            } else if (loc.type === 'forest' || loc.id?.includes('forest') || loc.id?.includes('grove')) {
                resources = ['wood', 'herbs', 'cloth', 'leather', 'rope'];
            } else if (loc.id?.includes('lake') || loc.id?.includes('river') || loc.id?.includes('water')) {
                resources = ['wood', 'stone', 'cloth', 'rope'];
            } else if (loc.id?.includes('mine') || loc.id?.includes('quarry') || loc.id?.includes('cave')) {
                resources = ['stone', 'metal', 'copper', 'scrap'];
            }
            
            // Po캜et surovin - sn칤쬰no o 30%
            const baseResCount = isEmpty ? Math.floor(Math.random() * 2) : 1 + Math.floor(Math.random() * (1 + (loc.dangerLevel || 0)));
            let resCount = Math.max(1, Math.floor(baseResCount * 0.7)); // -30%
            
            // Psychic Vision (set 2) - +20% loot z pr콢zkumu
            const setEffectsExplore = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            if (setEffectsExplore.psychicVision) {
                resCount = Math.ceil(resCount * 1.2);
            }
            
            let foundResources = [];
            
            const resIcons = { 
                wood: '游뿻', metal: '丘뙖잺', stone: '游', cloth: '游빗', scrap: '游댤',
                fuel: '久', glass: '游댩', chemicals: '游빍', electronics: '游',
                herbs: '游', leather: '游붮', gunpowder: '游눤', rope: '俱', copper: '游릯'
            };
            
            for (let i = 0; i < resCount; i++) {
                const res = resources[Math.floor(Math.random() * resources.length)];
                const baseAmount = 1 + Math.floor(Math.random() * 3);
                const amount = Math.max(1, Math.floor(baseAmount * 0.7)); // -30%
                state.resources[res] = (state.resources[res] || 0) + amount;
                const icon = RESOURCE_ICONS[res] || '游닍';
                const name = RESOURCE_NAMES[res] || res;
                foundResources.push(`+${amount} ${icon} ${name}`);
            }
            
            // Pen칤ze (men코칤 코ance p콏i pr치zdn칠m n치lezu)
            let moneyFound = 0;
            const moneyChance = isEmpty ? 0.15 : 0.4;
            if (Math.random() < moneyChance) {
                moneyFound = 5 + Math.floor(Math.random() * 20 * (1 + (loc.dangerLevel || 0)));
                addMoney(moneyFound);
            }
            
            // XP za pr콢zkum
            const xpGain = 5 + (loc.dangerLevel || 0) * 3;
            addXP(xpGain);
            
            // === ㅁNCE NA LORE KNIHU ===
            // Vy코코칤 코ance v nebezpe캜n칳ch lokac칤ch (ruiny, laborato콏e, bunkry)
            let loreChance = 0.02; // 2% z치kladn칤
            if (loc.id?.includes('ruin') || loc.id?.includes('city')) loreChance = 0.05;
            if (loc.id?.includes('lab') || loc.id?.includes('research') || loc.id?.includes('hospital')) loreChance = 0.08;
            if (loc.id?.includes('bunker') || loc.id?.includes('military')) loreChance = 0.06;
            if (loc.zone === 'danger') loreChance += 0.02;
            if (loc.zone === 'deadly') loreChance += 0.04;
            
            // Psychic Vision (set 2) - +25% 코ance na vz치cn칳 event
            if (setEffectsExplore.psychicVision) {
                loreChance *= 1.25;
            }
            
            if (Math.random() < loreChance) {
                // Najdi lore knihu kterou hr치캜 je코t캩 nem치
                const ownedLore = state.inv.filter(i => i.id?.startsWith('lore_')).map(i => i.id);
                const availableLore = ITEMS.filter(i => i.id?.startsWith('lore_') && !ownedLore.includes(i.id));
                
                if (availableLore.length > 0) {
                    // Dej p콏ednost knih치m v po콏ad칤 (lore_2 p콏ed lore_3 atd.)
                    availableLore.sort((a, b) => a.id.localeCompare(b.id));
                    const loreBook = availableLore[0];
                    
                    if (canAddItem(loreBook, 1)) {
                        addItemToInventory(loreBook, 1);
                        foundItems.push(loreBook.icon + ' ' + loreBook.name + ' (VZ츼CN칄!)');
                        notifyLoot(loreBook.name, 'epic', loreBook.icon);
                        addLog('游늿 Nalezen vz치cn칳 den칤k!', '游늿');
                    } else {
                        // Lore knihy na zem
                        addToGroundLoot({...loreBook});
                        groundItems.push(loreBook.icon + ' ' + loreBook.name + ' (VZ츼CN칄!)');
                    }
                }
            }
            
            // Daily quest progress - explored (jen nov칠 lokace se po캜칤taj칤 jinde)
            if (state.dailyQuests.progress) {
                checkDailyQuests();
            }
            
            // === RANDOM EVENTY ===
            // 마nce na event z치vis칤 na z칩n캩
            let eventChance = 0.15; // 15% z치kladn칤
            if (loc.zone === 'medium') eventChance = 0.20;
            if (loc.zone === 'danger') eventChance = 0.25;
            if (loc.zone === 'deadly') eventChance = 0.30;
            
            if (Math.random() < eventChance) {
                // Vyber vhodn칳 event podle z칩ny
                const availableEvents = RANDOM_EVENTS.filter(e => {
                    // N캩kter칠 eventy jen v ur캜it칳ch z칩n치ch
                    if (e.id === 'radiation_storm' && loc.zone === 'safe') return false;
                    if (e.id === 'animal_attack' && loc.zone === 'deadly') return false; // V deadly jsou siln캩j코칤
                    return true;
                });
                
                // Vyber n치hodn칳 event podle 코ance
                let totalChance = availableEvents.reduce((sum, e) => sum + e.chance, 0);
                let roll = Math.random() * totalChance;
                let cumulative = 0;
                
                for (const event of availableEvents) {
                    cumulative += event.chance;
                    if (roll <= cumulative) {
                        // Speci치ln칤 handling pro danger/deadly z칩ny
                        if ((loc.zone === 'danger' || loc.zone === 'deadly') && event.id === 'animal_attack') {
                            // V t캩쬶칳ch z칩n치ch naraz칤코 na siln캩j코칤 nep콏치tele
                            triggerDangerousEncounter(loc.zone);
                        } else {
                            event.trigger();
                        }
                        break;
                    }
                }
            }
            
            const limitInfo = checkDailyActionLimit('explore', loc.id);
            const usedCount = 3 - limitInfo.remaining;
            
            // Humor podle v칳sledku
            let humor = '';
            if (isEmpty && foundResources.length <= 1 && moneyFound === 0) {
                humor = getRandomHumor('lootEmpty');
            } else if (lootItem?.rarity === 'rare' || lootItem?.rarity === 'epic') {
                humor = getRandomHumor('lootGood');
            } else {
                humor = getRandomHumor('lootJunk');
            }
            
            showModal('游댌 Pr콢zkum dokon캜en', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">游댌</div>
                    <p style="margin-bottom: 0.5rem;">Prohledal jsi <strong>${loc.name}</strong></p>
                    <p style="color: #666; font-style: italic; font-size: 0.8rem; margin-bottom: 1rem;">"${humor}"</p>
                </div>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4CAF50;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游닍 Nalezeno:</h4>
                    ${foundItems.length > 0 ? `<p style="color: var(--toxic-green);">${foundItems.join(', ')}</p>` : `<p style="color: #888;">${'콯치dn칠 p콏edm캩ty...'}</p>`}
                    ${groundItems.length > 0 ? `<p style="color: #ff9800;">游닍 Na zemi: ${groundItems.join(', ')}</p>` : ''}
                    ${foundResources.length > 0 ? `<p style="color: var(--warning-yellow);">${foundResources.join(', ')}</p>` : ''}
                    ${moneyFound > 0 ? `<p style="color: #ffd700;">+${moneyFound} 游눯</p>` : ''}
                    <p style="color: #8bc34a; margin-top: 0.5rem;">+${xpGain} XP</p>
                </div>
                <p style="font-size: 0.8rem; color: #666; text-align: center;">Pr콢zkumy: ${usedCount}/3 dnes na t칠to lokaci</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">九 Jdeme d치l</button>
            `);
            
            addLog('Pr콢zkum: ' + loc.name, '游댌');
            
            // Zkontroluj speci치ln칤 quest triggery (find_npc, rescue, artifact)
            checkSpecialQuestTriggers(loc.id);
            
            renderFull();
        }
        
        function raidLocation() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            showModal(('丘덢잺 Raid: ') + loc.name, 
                '<p style="color: #ff9800;">P콏iprav se na boj!</p>' +
                '<p>Lokace je pln치 nep콏치tel. Bude코 캜elit n캩kolika vln치m!</p>' +
                '<button class="btn" onclick="startRaid()" style="width: 100%; margin-top: 1rem; background: #8B0000;">丘덢잺 Za캜칤t raid!</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 Zru코it</button>'
            );
        }
        
        function startRaid() {
            closeModal();
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // Ulo informaci o raidu pro pozd캩j코칤 zpracov치n칤
            window.currentRaidLocation = loc?.id;
            
            // Vyber nep콏칤tele z lokace, nebo podle z칩ny
            let enemy;
            if (loc?.enemies && loc.enemies.length > 0) {
                // Pou쬴j nep콏칤tele definovan칠 pro tuto lokaci
                const enemyId = loc.enemies[Math.floor(Math.random() * loc.enemies.length)];
                enemy = ENEMIES.find(e => e.id === enemyId);
            }
            
            // Fallback podle z칩ny
            if (!enemy) {
                const zoneTiers = {
                    'safe': [1],
                    'medium': [1, 2],
                    'danger': [2, 3],
                    'deadly': [4, 5]
                };
                const tiers = zoneTiers[loc?.zone] || [1, 2];
                const zoneEnemies = ENEMIES.filter(e => tiers.includes(e.tier));
                enemy = zoneEnemies[Math.floor(Math.random() * zoneEnemies.length)] || ENEMIES[0];
            }
            
            // isVillageRaid je jen pro p콏epaden칤 vesnic (ne pro 칰tok na nep콏치telsk칠 t치bory)
            startCombat({id: enemy.id}, false, false);
        }
        
        function collectWater() {
            // Cooldown 24 hodin
            const cooldownKey = 'water_' + state.world.currentLocation;
            const lastCollect = state.world.locationCooldowns?.[cooldownKey] || 0;
            const cooldownTime = 24 * 60 * 60 * 1000; // 24 hodin
            const now = Date.now();
            
            if (now - lastCollect < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastCollect)) / 1000);
                const hours = Math.floor(remaining / 3600);
                const mins = Math.floor((remaining % 3600) / 60);
                notifyWarning('Studna je vy캜erpan치', `Dal코칤 voda za ${hours}h ${mins}m`);
                return;
            }
            
            if (!state.world.locationCooldowns) state.world.locationCooldowns = {};
            state.world.locationCooldowns[cooldownKey] = now;
            
            // 2-3 vody
            const amount = 2 + Math.floor(Math.random() * 2);
            const waterItem = ITEMS.find(i => i.id === 'water') || { id: 'water', name: 'Voda', icon: '游눦', type: 'consumable', effect: 'thirst', value: 30, weight: 1 };
            
            const existing = state.inv.find(i => i.id === 'water');
            if (existing) {
                existing.count = (existing.count || 1) + amount;
            } else {
                state.inv.push({...waterItem, count: amount});
            }
            
            notifySuccess('Nabral jsi vodu!', `+${amount} 游눦`);
            addLog(`Nabral jsi ${amount}x vodu ze studny`, '游눦');
            addXP(2);
            renderFull();
        }
        
        // Osvobozen칤 zajatc콢 z otrok치콏sk칠ho t치bora
        function freeSlaves() {
            if (state.freedSlaves) {
                notifyWarning('U osvobozeno', 'Zajatci u byli osvobozeni!');
                return;
            }
            
            state.freedSlaves = true;
            
            // Odm캩ny
            const xpGain = 200;
            const moneyGain = 150;
            addXP(xpGain);
            addMoney(moneyGain);
            
            // Reputace
            changeReputation('survivors', 30, 'osvobozen칤 zajatc콢');
            changeReputation('raiders', -50, 'zni캜en칤 otrok치콏sk칠ho t치bora');
            
            // Update quest pokud existuje
            if (state.activeQuests) {
                const slaveQuest = state.activeQuests.find(q => q.id === 'rescue_slaves' || q.objectives?.some(o => o.type === 'free_slaves'));
                if (slaveQuest) {
                    slaveQuest.completed = true;
                }
            }
            
            // 마nce na nov칠ho spole캜n칤ka
            const companionChance = Math.random();
            let companionHtml = '';
            
            if (companionChance < 0.3) {
                // Osvobozen칳 zajatec chce se p콏ipojit
                const newCompanion = {
                    id: 'survivor',
                    uniqueId: 'freed_slave_' + Date.now(),
                    name: 'Osvobozen칳 zajatec',
                    icon: '游똂',
                    type: 'human',
                    hp: 80,
                    maxHp: 80,
                    damage: 12,
                    defense: 8,
                    loyalty: 70,
                    skills: [],
                    level: 1,
                    xp: 0,
                    skillPoints: 1,
                    equipped: { weapon: null, armor: null, helmet: null, gloves: null, boots: null },
                    canEquip: true,
                    inCombat: true,
                    ability: 'P콏e쬴v코칤',
                    abilityDesc: 'Osvobozen칳 zajatec, vd캩캜n칳 za z치chranu'
                };
                
                state.companions = state.companions || [];
                
                if (state.companions.length < getMaxCompanions()) {
                    // M칤sto je voln칠
                    state.companions.push(newCompanion);
                    companionHtml = `
                        <div style="background: #1a2a3a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #2196f3;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">游녻 Nov칳 spole캜n칤k!</h4>
                            <p style="color: #888; margin: 0;">"D칤ky za z치chranu! P콢jdu s tebou."</p>
                        </div>
                    `;
                } else {
                    // Plno - nab칤dni v칳m캩nu po zav콏en칤 tohoto modalu
                    window.pendingCompanionAfterModal = newCompanion;
                    companionHtml = `
                        <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #ff9800;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">游녻 Chce se p콏idat!</h4>
                            <p style="color: #888; margin: 0;">Jeden ze zajatc콢 chce j칤t s tebou, ale m치코 plno spole캜n칤k콢.</p>
                        </div>
                    `;
                }
            }
            
            showModal('久勇 Zajatci osvobozeni!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">游똂</div>
                    <h3 style="color: #8bc34a; margin: 0.5rem 0;">Osvobodil jsi zajatce!</h3>
                    <p style="color: #888;">Vd캩캜n칤 p콏e쬴v코칤 ti d캩kuj칤 za z치chranu.</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="color: #ffd700; margin: 0.3rem 0;">救 +${xpGain} XP</div>
                        <div style="color: #ffd700; margin: 0.3rem 0;">游눯 +${moneyGain} pen캩z</div>
                        <div style="color: #8bc34a; margin: 0.3rem 0;">游논 +30 reputace s P콏e쬴v코칤mi</div>
                    </div>
                    
                    ${companionHtml}
                </div>
                <button class="btn" onclick="closeFreeSlavesModal();" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 ' + ('Skv캩l칠!') + '</button>
            `);
            
            addLog('Osvobodil jsi zajatce z otrok치콏sk칠ho t치bora!', '久勇');
        }
        
        function closeFreeSlavesModal() {
            closeModal();
            renderFull();
            
            // Zkontroluj jestli 캜ek치 companion na v칳m캩nu
            if (window.pendingCompanionAfterModal) {
                const newCompanion = window.pendingCompanionAfterModal;
                window.pendingCompanionAfterModal = null;
                setTimeout(() => {
                    showCompanionSwapModal(newCompanion, 'freed_slave');
                }, 300);
            }
        }
        
        function restAtShelter() {
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + 30);
            state.status.energy = Math.min(100, state.status.energy + 40);
            notifySuccess('Odpo캜inul sis', '+30 HP, +40 ' + ('energie'));
            addLog('Odpo캜inek v 칰krytu', '游띒勇');
            renderFull();
        }
        
        // === STAR칄 HEX FUNKCE ODSTRAN캨NY ===
        // Hex canvas syst칠m byl nahrazen WORLD_LOCATIONS syst칠mem
        let canvas, ctx, offsetX = 0, offsetY = 0;
        let hexSize = 50;
        const SQRT3 = Math.sqrt(3);
        
        function initMap() { return; }
        function drawMap() { return; }
        function drawHex(q, r) { return; }
        function generateHex(q, r) { return { terrain: 0, discovered: true, explored: true }; }
        function findPath(fromQ, fromR, toQ, toR) { return []; }
        
        // clickHex - pr치zdn치 pro kompatibilitu
        function clickHex(q, r) {
            // Hex syst칠m odstran캩n - pou쬴j WORLD_LOCATIONS
            console.log('clickHex deprecated - use WORLD_LOCATIONS system');
            return;
        }
        
        // travelTo - pr치zdn치 pro kompatibilitu
        function travelTo(q, r, minutes) {
            console.log('travelTo deprecated - use travelToLocation');
            return;
        }
        // === SYST칄M N츼HODN칗CH EVENT콡 B캨HEM CESTY ===
        let scheduledEventTimeouts = [];
        
        function clearScheduledEvents() {
            scheduledEventTimeouts.forEach(t => clearTimeout(t));
            scheduledEventTimeouts = [];
        }
        
        function scheduleRandomEvents(travelMinutes) {
            // VYPNUTO - eventy jsou jen na world map캩 p콏es scheduleTravelEvents
            // Hex mapa je jen pro lok치ln칤 pohyb, eventy by byly otravn칠
            clearScheduledEvents();
            state.map.scheduledTravelEvents = [];
            
            // Dog event p콏i prvn칤 cest캩 z콢st치v치
            if (state.firstJourneyDogEvent) {
                const eventTime = Date.now() + 2000;
                state.map.scheduledTravelEvents.push({ type: 'dog', triggerAt: eventTime });
                
                const dogTimeout = setTimeout(() => {
                    if (!state.map.traveling) return;
                    state.firstJourneyDogEvent = false;
                    pauseTravelForEvent();
                    showDogEvent();
                }, 2000);
                scheduledEventTimeouts.push(dogTimeout);
                return;
            }
            
            // 콯치dn칠 dal코칤 eventy na hex map캩
            console.log('游늰 Hex map eventy vypnuty - pou쮂셨치 se world map');
        }
        
        // Obnov eventy po refreshi
        function restoreScheduledEvents() {
            if (!state.map.traveling || !state.map.scheduledTravelEvents) return;
            
            clearScheduledEvents();
            const now = Date.now();
            
            for (const event of state.map.scheduledTravelEvents) {
                if (event.triggerAt <= now) {
                    // Event m캩l prob캩hnout - spus콘 ho ihned
                    console.log('丘 Spou코t칤m opo쬯캩n칳 event:', event.type);
                    setTimeout(() => {
                        if (!state.map.traveling) return;
                        if (event.type === 'dog') {
                            state.firstJourneyDogEvent = false;
                            pauseTravelForEvent();
                            showDogEvent();
                        } else {
                            triggerRandomTravelEvent(event.forceEncounter);
                        }
                    }, 100);
                    return; // Jen jeden event najednou
                } else {
                    // Event je v budoucnosti - napl치nuj ho
                    const delay = event.triggerAt - now;
                    console.log(`游늰 Obnovuji event za ${Math.round(delay/1000)}s`);
                    
                    const timeout = setTimeout(() => {
                        if (!state.map.traveling) return;
                        if (event.type === 'dog') {
                            state.firstJourneyDogEvent = false;
                            pauseTravelForEvent();
                            showDogEvent();
                        } else {
                            triggerRandomTravelEvent(event.forceEncounter);
                        }
                    }, delay);
                    scheduledEventTimeouts.push(timeout);
                }
            }
        }
        
        function showDogEvent() {
            showModal('游냇 Opu코t캩n칳 pes!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 5rem;">游냇</div>
                </div>
                <p style="margin-bottom: 1rem;">Na kraji cesty vid칤코 vychrtl칠ho psa. Vypad치 opu코t캩n캩, ale p콏치telsky vrt칤 ocasem.</p>
                <p style="color: var(--toxic-green); margin-bottom: 1rem;">Vypad치, 쬰 by se k tob캩 r치d p콏idal!</p>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--rust);">
                    <p style="margin: 0.3rem 0; color: var(--warning-yellow);"><strong>游냇 V캩rn칳 pes</strong></p>
                    <p style="margin: 0.3rem 0; font-size: 0.85rem;">仇벒잺 HP: 50 | 丘덢잺 DMG: 8 | 游띠勇 DEF: 3</p>
                    <p style="margin: 0.3rem 0; font-size: 0.85rem; color: var(--toxic-green);">游댌 캛muchal: +25% 코ance naj칤t vz치cn캩j코칤 p콏edm캩ty</p>
                </div>
                <button class="btn" onclick="adoptDog(); resumeTravel();" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">游붮 P콏ijmout psa</button>
                <button class="btn" onclick="closeModal(); resumeTravel();" style="width: 100%; background: #555;">游뛌 J칤t d치l</button>
            `);
        }
        
        function pauseTravelForEvent() {
            if (!state.map.traveling) return;
            
            // Ulo zb칳vaj칤c칤 캜as
            const elapsed = Date.now() - state.map.travelStart;
            state.map.travelPaused = true;
            state.map.travelRemainingTime = state.map.travelDuration - elapsed;
            state.map.traveling = false;
            
            // Zru코 v코echny napl치novan칠 eventy (spust칤me nov칠 po resumeTravel)
            clearScheduledEvents();
            
            addLog('낒勇 Cesta p콏eru코ena!', '丘멆잺');
            renderFull();
        }
        
        function resumeTravel() {
            closeModal();
            
            if (!state.map.travelPaused) return;
            
            // Pokra캜uj v cest캩 se zb칳vaj칤c칤m 캜asem
            state.map.traveling = true;
            state.map.travelStart = Date.now();
            state.map.travelDuration = state.map.travelRemainingTime;
            state.map.travelPaused = false;
            
            // Napl치nuj dal코칤 eventy pro zb칳vaj칤c칤 캜as
            const remainingMinutes = state.map.travelRemainingTime / 60000;
            if (remainingMinutes > 0.5) { // Jen pokud zb칳v치 v칤c ne 30 sekund
                scheduleRandomEvents(remainingMinutes);
            }
            
            addLog('郊윒잺 Pokra캜uje코 v cest캩...', '游뛌');
            renderFull();
        }
        
        function triggerRandomTravelEvent(forceEncounter = false) {
            if (!state.map.traveling) return;
            
            pauseTravelForEvent();
            
            // 15% 코ance na dynamick칳 event
            if (!forceEncounter && Math.random() < 0.15) {
                const dynamicEvent = checkForDynamicEvent();
                if (dynamicEvent) {
                    triggerDynamicEvent(dynamicEvent);
                    return;
                }
            }
            
            const roll = Math.random();
            
            // Companion ambush reduction
            const compBonuses = getAllCompanionBonuses();
            let ambushReduction = compBonuses.ambushReduction || 0;
            
            // Hr치캜ovy skilly pro sn칤쬰n칤 p콏epaden칤
            const stealthLevel = state.skills?.['stealth'] || 0;
            if (stealthLevel > 0) {
                ambushReduction += stealthLevel * 0.15; // -15% za level
            }
            
            // Skill tree bonusy
            ambushReduction += getSkillTreeBonus('ambushReduction') || 0;
            
            const enemyChance = Math.max(0.1, 0.5 - ambushReduction); // Z치kladn칤 50%, sn칤쬰no bonusy
            
            // Vynucen칳 encounter na neprozkouman칠m 칰zem칤 NEBO 코ance na nep콏칤tele
            if (forceEncounter || roll < enemyChance) {
                // Pokud m치 companion ambushReduction, m콢쬰 se vyhnout i vynucen칠mu
                if (forceEncounter && ambushReduction > 0 && Math.random() < ambushReduction) {
                    // Vyhnul se p콏epaden칤 d칤ky spole캜n칤kovi
                    showModal('游 ' + ('T캩sn캩!'), `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem;">游</div>
                            <p style="color: #8bc34a;">Tv콢j spole캜n칤k t캩 v캜as varoval p콏ed nebezpe캜칤m!</p>
                            <p style="color: #888;">Vyhnul ses p콏epaden칤.</p>
                        </div>
                        <button class="btn" onclick="resumeTravel()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>
                    `);
                    return;
                }
                
                const enemy = ENEMIES[Math.floor(Math.random() * ENEMIES.length)];
                const isAmbush = forceEncounter; // P콏epaden칤 p콏i vynucen칠m
                showModal(isAmbush ? '游눤 P콎EPADEN칈!' : '丘멆잺 Setk치n칤!', `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">${enemy.icon}</div>
                        <h3 style="color: var(--warning-yellow);">${enemy.name}</h3>
                        <p style="color: #888;">HP: ${enemy.hp} | DMG: ${enemy.damage} | DEF: ${enemy.defense}</p>
                    </div>
                    <p style="margin-bottom: 1rem;">B캩hem cesty jsi narazil na nep콏칤tele!</p>
                    <button class="btn" onclick="startCombatDuringTravel('${enemy.id}')" style="width: 100%; margin-bottom: 0.5rem;">丘덢잺 ' + ('Bojovat!') + '</button>
                    <button class="btn" onclick="tryToFleeDuringTravel('${enemy.id}')" style="width: 100%; background: #555;">游끢 Pokusit se ut칠ct</button>
                `);
                return;
            }
            
            // 30% 코ance na loot
            if (roll < 0.8) {
                const lootRoll = Math.random();
                let foundItem = null;
                
                for (const item of ITEMS) {
                    if (lootRoll < item.findChance && item.findChance > 0) {
                        foundItem = item;
                        break;
                    }
                }
                
                if (foundItem) {
                    const rarityColor = { 'common': '#fff', 'uncommon': '#8bc34a', 'rare': '#2196f3', 'epic': '#9c27b0', 'legendary': '#ffd700' }[foundItem.rarity] || '#fff';
                    
                    if (canAddItem(foundItem, 1)) {
                        if (foundItem.type === 'consumable') {
                            const existing = state.inv.find(i => i.id === foundItem.id);
                            if (existing) existing.count = (existing.count || 1) + 1;
                            else state.inv.push({...foundItem, count: 1});
                        } else {
                            state.inv.push({...foundItem, durability: 100, maxDurability: 100});
                        }
                        
                        // Notifikace
                        notifyLoot(foundItem.name, foundItem.rarity, foundItem.icon);
                        
                        // Speci치ln칤 modal pro easter eggy
                        const isEasterEgg = foundItem.desc && foundItem.rarity === 'legendary';
                        
                        showModal(isEasterEgg ? '游꿡 EASTER EGG!' : '游꾸 N치lez!', `
                            <div style="text-align: center;">
                                ${isEasterEgg ? '<div style="font-size: 1rem; color: #ffd700; margin-bottom: 0.5rem;">九 LEGEND츼RN칈 N츼LEZ! 九</div>' : ''}
                                <div style="font-size: 4rem; ${isEasterEgg ? 'animation: pulse 1s infinite;' : ''}">${foundItem.icon}</div>
                                <h3 style="color: ${rarityColor};">${foundItem.name}</h3>
                                <p style="color: #888;">[${foundItem.rarity.toUpperCase()}]</p>
                                ${foundItem.desc ? `<p style="color: #aaa; font-style: italic; margin: 0.5rem 0;">"${foundItem.desc}"</p>` : ''}
                                <p style="margin: 1rem 0;">${isEasterEgg ? 'Na코el jsi legend치rn칤 p콏edm캩t z jin칠ho sv캩ta!' : 'Na코el jsi n캩co u쬴te캜n칠ho na cest캩!'}</p>
                                <button class="btn" onclick="resumeTravel()" style="width: 100%;">九 Pokra캜ovat</button>
                            </div>
                        `);
                        
                        if (foundItem.rarity === 'rare' || foundItem.rarity === 'epic' || foundItem.rarity === 'legendary') {
                            SoundSystem.play('rare_item');
                            // Easter egg speci치ln칤 efekt
                            if (foundItem.desc) {
                                setTimeout(() => {
                                    addLog(`游꿡 "${foundItem.desc}"`, '九');
                                }, 1000);
                            }
                        } else {
                            SoundSystem.play('pickup');
                        }
                    } else {
                        showModal('游꾸 N치lez!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">${foundItem.icon}</div>
                                <h3 style="color: ${rarityColor};">${foundItem.name}</h3>
                                <p style="color: #ff9800;">丘멆잺 Pln칳 invent치콏! Nem콢쬰코 vz칤t.</p>
                                <button class="btn" onclick="resumeTravel()" style="width: 100%;">九 Pokra캜ovat</button>
                            </div>
                        `);
                    }
                } else {
                    // Suroviny m칤sto itemu
                    const resourceTypes = ['wood', 'metal', 'stone', 'cloth'];
                    const resType = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
                    const amount = Math.floor(Math.random() * 3) + 1;
                    state.resources[resType] = (state.resources[resType] || 0) + amount;
                    
                    const resInfo = { wood: '游뿻 D콏evo', metal: '丘뙖잺 Kov', stone: '游뿯 K치men', cloth: '游빗 L치tka' };
                    
                    showModal('游꾸 N치lez!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">${resInfo[resType].split(' ')[0]}</div>
                            <h3>${resInfo[resType].split(' ')[1]} x${amount}</h3>
                            <p style="margin: 1rem 0;">Na코el jsi suroviny na cest캩!</p>
                            <button class="btn" onclick="resumeTravel()" style="width: 100%;">九 Pokra캜ovat</button>
                        </div>
                    `);
                    SoundSystem.play('pickup');
                }
                return;
            }
            
            // 20% 코ance na n치hodn칳 event
            const eventRoll = Math.random();
            if (eventRoll < 0.5) {
                // Nalezen칠 pen칤ze
                const money = Math.floor(Math.random() * 50) + 10;
                addMoney(money);
                showModal('游눯 맚캩st칤!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游눯</div>
                        <h3 style="color: var(--warning-yellow);">+${money} pen캩z</h3>
                        <p style="margin: 1rem 0;">Na코el jsi opu코t캩nou pen캩쬰nku!</p>
                        <button class="btn" onclick="resumeTravel()" style="width: 100%;">九 Pokra캜ovat</button>
                    </div>
                `);
            } else {
                // L칠캜en칤
                const heal = Math.floor(Math.random() * 20) + 10;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + heal);
                showModal('游눜 Odpo캜inek!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游</div>
                        <h3 style="color: var(--toxic-green);">+${heal} HP</h3>
                        <p style="margin: 1rem 0;">Na코el jsi klidn칠 m칤sto k odpo캜inku.</p>
                        <button class="btn" onclick="resumeTravel()" style="width: 100%;">九 Pokra캜ovat</button>
                    </div>
                `);
            }
        }
        
        function startCombatDuringTravel(enemyId) {
            closeModal();
            // Po boji se cesta obnov칤
            state.world.resumeAfterCombat = true;
            startCombat({id: enemyId});
        }
        
        function tryToFleeDuringTravel(enemyId) {
            const fleeChance = 0.3 + (state.char.attrs.agi - 5) * 0.05;
            if (Math.random() < fleeChance) {
                addLog('칔sp캩코n캩 jsi utekl!', '游끢');
                resumeTravel();
            } else {
                addLog('칔t캩k se nezda콏il!', '仇');
                startCombatDuringTravel(enemyId);
            }
        }
        
        // ============================================================
        // === 游 DYNAMICK칄 EVENTY SYSTEM ===
        // ============================================================
        
        function checkForDynamicEvent() {
            // Kontrola p콏i cestov치n칤 nebo pr콢zkumu
            if (!state.dynamicEvents) state.dynamicEvents = { triggered: [], cooldown: 0 };
            
            // Cooldown mezi eventy (min 5 minut hern칤ho 캜asu)
            if (state.dynamicEvents.cooldown > Date.now()) return null;
            
            const eligibleEvents = DYNAMIC_EVENTS.filter(e => {
                if (state.dynamicEvents.triggered.includes(e.id) && Math.random() > 0.3) return false; // 30% 코ance na opakov치n칤
                if (e.minLevel && state.char.level < e.minLevel) return false;
                return Math.random() < e.triggerChance;
            });
            
            if (eligibleEvents.length === 0) return null;
            
            const event = eligibleEvents[Math.floor(Math.random() * eligibleEvents.length)];
            state.dynamicEvents.cooldown = Date.now() + 5 * 60 * 1000; // 5 min cooldown
            
            return event;
        }
        
        function triggerDynamicEvent(event) {
            if (!event) return;
            
            state.dynamicEvents.triggered.push(event.id);
            state.dynamicEvents.currentEvent = event;
            
            let choicesHtml = event.choices.map((choice, idx) => {
                let disabled = false;
                let disabledReason = '';
                
                if (choice.requirements) {
                    if (choice.requirements.item) {
                        // Kontroluj konkr칠tn칤 item NEBO typ (food = jak칠koliv j칤dlo)
                        let hasItem = false;
                        if (choice.requirements.item === 'food') {
                            hasItem = state.inv.some(i => i.type === 'consumable' && i.effect === 'hunger');
                        } else if (choice.requirements.item === 'medkit') {
                            hasItem = state.inv.some(i => i.id === 'medkit' || i.id === 'bandage' || i.id === 'stimpack');
                        } else {
                            hasItem = state.inv.some(i => i.id === choice.requirements.item);
                        }
                        if (!hasItem) {
                            disabled = true;
                            const itemNames = { 'food': 'j칤dlo', 'medkit': 'l칠ky', 'water': 'vodu' };
                            disabledReason = `(Pot콏ebuje코: ${itemNames[choice.requirements.item] || choice.requirements.item})`;
                        }
                    }
                    if (choice.requirements.money && state.money < choice.requirements.money) {
                        disabled = true;
                        disabledReason = `(Pot콏ebuje코: ${choice.requirements.money} 游눯)`;
                    }
                    if (choice.requirements.attr) {
                        const [attr, value] = Object.entries(choice.requirements.attr)[0];
                        if (state.char.attrs[attr] < value) {
                            disabled = true;
                            const attrNames = { str: 'S칈L', agi: 'OBR', end: 'V칗D', int: 'INT', per: 'VN칈', cha: 'CHA' };
                            disabledReason = `(Pot콏ebuje코: ${attrNames[attr] || attr.toUpperCase()} ${value}+)`;
                        }
                    }
                }
                
                return `
                    <button class="btn" onclick="handleDynamicEventChoice(${idx})" 
                        style="width: 100%; margin-bottom: 0.5rem; text-align: left; padding: 0.8rem; ${disabled ? 'opacity: 0.5;' : ''}"
                        ${disabled ? 'disabled' : ''}>
                        ${choice.text} ${disabledReason ? `<span style="color: #f44336; font-size: 0.8rem;">${disabledReason}</span>` : ''}
                    </button>
                `;
            }).join('');
            
            showModal(`${event.icon} ${event.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${event.icon}</div>
                    <p style="color: #ccc; font-size: 1rem; line-height: 1.5;">${event.description}</p>
                </div>
                <div style="margin-top: 1rem;">
                    ${choicesHtml}
                </div>
            `);
        }
        
        function handleDynamicEventChoice(choiceIdx) {
            const event = state.dynamicEvents.currentEvent;
            if (!event) return;
            
            const choice = event.choices[choiceIdx];
            if (!choice) return;
            
            // Spot콏ebuj item pokud pot콏eba
            if (choice.consumeItem && choice.requirements?.item) {
                let itemIdx = -1;
                
                // Najdi spr치vn칳 item podle typu
                if (choice.requirements.item === 'food') {
                    itemIdx = state.inv.findIndex(i => i.type === 'consumable' && i.effect === 'hunger');
                } else if (choice.requirements.item === 'medkit') {
                    itemIdx = state.inv.findIndex(i => i.id === 'medkit' || i.id === 'bandage' || i.id === 'stimpack');
                } else {
                    itemIdx = state.inv.findIndex(i => i.id === choice.requirements.item);
                }
                
                if (itemIdx !== -1) {
                    const item = state.inv[itemIdx];
                    addLog(`Pou쬴to: ${item.icon} ${item.name}`, '游닍');
                    if (item.count > 1) state.inv[itemIdx].count--;
                    else state.inv.splice(itemIdx, 1);
                }
            }
            
            // Spot콏ebuj pen칤ze
            if (choice.requirements?.money) {
                state.money -= choice.requirements.money;
                addLog(`Zaplaceno: ${choice.requirements.money} 游눯`, '游눯');
            }
            
            const outcome = choice.outcome;
            
            // Quest trigger
            if (outcome.quest) {
                startTimedQuest(outcome.quest);
                showModal('游늶 Nov칳 칰kol!', `
                    <div style="text-align: center;">
                        <p>${outcome.text}</p>
                        <button class="btn" onclick="closeModal(); resumeTravel();" style="width: 100%; margin-top: 1rem;">九 P콏ijmout</button>
                    </div>
                `);
                return;
            }
            
            // Combat trigger
            if (outcome.combat) {
                closeModal();
                state.dynamicEvents.pendingOutcome = outcome;
                startDynamicEventCombat(outcome.combat);
                return;
            }
            
            // Random outcome
            if (outcome.random) {
                const roll = Math.random();
                let cumulative = 0;
                for (const possibility of outcome.random) {
                    cumulative += possibility.chance;
                    if (roll <= cumulative) {
                        applyEventOutcome(possibility);
                        return;
                    }
                }
            }
            
            // Success/Failure outcome
            if (outcome.success) {
                const roll = Math.random();
                if (roll <= outcome.success.chance) {
                    applyEventOutcome(outcome.success);
                } else if (outcome.failure) {
                    applyEventOutcome(outcome.failure);
                }
            } else {
                // Direct outcome
                applyEventOutcome(outcome);
            }
        }
        
        function applyEventOutcome(result) {
            let resultHtml = `<p style="margin-bottom: 1rem;">${result.text}</p>`;
            let rewards = [];
            let penalties = [];
            
            // Apply rewards
            if (result.reward) {
                if (result.reward.money) {
                    addMoney(result.reward.money);
                    rewards.push(`+${result.reward.money} 游눯`);
                }
                if (result.reward.xp) {
                    addXP(result.reward.xp);
                    rewards.push(`+${result.reward.xp} XP`);
                }
                if (result.reward.karma) {
                    state.karma = (state.karma || 0) + result.reward.karma;
                    rewards.push(`+${result.reward.karma} Karma`);
                }
                if (result.reward.items) {
                    result.reward.items.forEach(itemId => {
                        const item = ITEMS.find(i => i.id === itemId);
                        if (item && canAddItem(item, 1)) {
                            state.inv.push({...item, count: 1});
                            rewards.push(`+${item.icon} ${item.name}`);
                        }
                    });
                }
                if (result.reward.resources) {
                    Object.entries(result.reward.resources).forEach(([res, amt]) => {
                        state.resources[res] = (state.resources[res] || 0) + amt;
                        rewards.push(`+${amt} ${res}`);
                    });
                }
                if (result.reward.reputation) {
                    Object.entries(result.reward.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        rewards.push(`${amt > 0 ? '+' : ''}${amt} rep (${faction})`);
                    });
                }
                if (result.reward.unlockLocation) {
                    if (!state.unlockedLocations) state.unlockedLocations = [];
                    state.unlockedLocations.push(result.reward.unlockLocation);
                    rewards.push(`游딬勇 Nov치 lokace odkryta!`);
                }
            }
            
            // Apply penalties
            if (result.penalty) {
                if (result.penalty.hp) {
                    state.char.hp = Math.max(1, state.char.hp + result.penalty.hp);
                    penalties.push(`${result.penalty.hp} HP`);
                }
                if (result.penalty.money) {
                    state.money = Math.max(0, state.money + result.penalty.money);
                    penalties.push(`${result.penalty.money} 游눯`);
                }
                if (result.penalty.karma) {
                    state.karma = (state.karma || 0) + result.penalty.karma;
                    penalties.push(`${result.penalty.karma} Karma`);
                }
                if (result.penalty.reputation) {
                    Object.entries(result.penalty.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        penalties.push(`${amt} rep (${faction})`);
                    });
                }
            }
            
            if (rewards.length > 0) {
                resultHtml += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <span style="color: #4caf50;">九 Z칤sk치v치코:</span> ${rewards.join(', ')}
                </div>`;
            }
            if (penalties.length > 0) {
                resultHtml += `<div style="background: #2a1a1a; padding: 0.5rem; border-radius: 4px;">
                    <span style="color: #f44336;">九 Ztr치ty:</span> ${penalties.join(', ')}
                </div>`;
            }
            
            showModal('游늶 V칳sledek', `
                <div style="text-align: center;">
                    ${resultHtml}
                    <button class="btn" onclick="closeModal(); if(state.map.travelPaused) resumeTravel(); else renderFull();" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>
                </div>
            `);
            
            state.dynamicEvents.currentEvent = null;
        }
        
        function startDynamicEventCombat(combatData) {
            // Combat s v칤ce nep콏치teli z dynamic events
            const enemies = combatData.enemies.map(enemyId => {
                return ENEMIES.find(e => e.id === enemyId) || ENEMIES[0];
            });
            
            state.world.resumeAfterCombat = true;
            state.dynamicEvents.combatData = combatData;
            
            if (enemies.length > 1) {
                startCombatWithGroup(enemies, 'dynamic_event');
            } else {
                startCombat(enemies[0]);
            }
        }
        
        // ============================================================
        // === 낋 캛ASOV캨 LIMITOVAN칄 QUESTY ===
        // ============================================================
        
        function startTimedQuest(questId) {
            const quest = TIMED_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            if (!state.timedQuests) state.timedQuests = [];
            
            state.timedQuests.push({
                id: quest.id,
                startTime: Date.now(),
                endTime: Date.now() + quest.timeLimit,
                objectives: quest.objectives.map(o => ({...o, completed: false})),
                failed: false,
                completed: false
            });
            
            addLog(`낋 Nov칳 캜asov칳 칰kol: ${quest.name}!`, '游늶');
            notifyWarning('캛asov칳 칰kol!', `${quest.name} - ` + (`m치코 ${Math.floor(quest.timeLimit / 60000)} minut!`));
        }
        
        function updateTimedQuests() {
            if (!state.timedQuests) return;
            
            const now = Date.now();
            state.timedQuests.forEach(tq => {
                if (tq.completed || tq.failed) return;
                
                // Kontrola 캜asu
                if (now >= tq.endTime) {
                    tq.failed = true;
                    const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                    if (quest?.failureConsequence) {
                        applyTimedQuestFailure(quest);
                    }
                }
            });
        }
        
        function applyTimedQuestFailure(quest) {
            addLog(`仇 칔kol selhal: ${quest.name}`, '游');
            notifyError('칔kol selhal!', quest.failureConsequence.text);
            
            if (quest.failureConsequence.penalty) {
                const p = quest.failureConsequence.penalty;
                if (p.reputation) {
                    Object.entries(p.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                    });
                }
                if (p.karma) state.karma = (state.karma || 0) + p.karma;
                if (p.settlers) state.settlement.settlers = Math.max(0, (state.settlement?.settlers || 0) + p.settlers);
            }
        }
        
        function completeTimedQuest(questId) {
            const tqIdx = state.timedQuests?.findIndex(q => q.id === questId);
            if (tqIdx === -1) return;
            
            const tq = state.timedQuests[tqIdx];
            const quest = TIMED_QUESTS.find(q => q.id === questId);
            
            tq.completed = true;
            
            // Aplikuj odm캩ny
            if (quest.reward) {
                if (quest.reward.money) addMoney(quest.reward.money);
                if (quest.reward.xp) addXP(quest.reward.xp);
                if (quest.reward.reputation) {
                    Object.entries(quest.reward.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                    });
                }
                // NOV칄: Companion reward
                if (quest.reward.companion) {
                    const companionNames = ['Max', 'Elena', 'Viktor', 'Anna', 'Karel', 'Marie', 'Pavel', 'Zuzana'];
                    const newCompanion = {
                        id: 'survivor', // Pou쬴je survivor skill tree
                        uniqueId: 'companion_' + Date.now(),
                        name: companionNames[Math.floor(Math.random() * companionNames.length)],
                        icon: '游븸',
                        type: 'human',
                        hp: 50 + Math.floor(Math.random() * 30),
                        maxHp: 80,
                        damage: 8 + Math.floor(Math.random() * 5),
                        defense: 4 + Math.floor(Math.random() * 3),
                        level: 1,
                        xp: 0,
                        skillPoints: 1,
                        skills: [],
                        equipped: { weapon: null, armor: null, helmet: null, gloves: null, boots: null },
                        loyalty: 60 + Math.floor(Math.random() * 20),
                        ability: 'P콏e쬴v코칤',
                        abilityDesc: 'Zku코en칳 p콏e쬴v코칤 apokalypsy',
                        canEquip: true,
                        inCombat: true
                    };
                    addCompanionWithSwap(newCompanion, 'quest');
                }
            }
            
            addLog(`九 칔kol spln캩n: ${quest.name}!`, '游끥');
            notifySuccess('칔kol spln캩n!', quest.name);
            
            // Zobraz modal s odm캩nou
            showModal('游끥 Quest dokon캜en!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${quest.icon}</div>
                    <h3 style="color: #4caf50;">${quest.name}</h3>
                    <p style="color: #888;">Splnil jsi v코echny c칤le v캜as!</p>
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px; margin: 1rem 0;">
                        <p style="color: #4caf50; margin: 0;">
                            游꾸 Odm캩na: ${quest.reward.money || 0} 游눯, ${quest.reward.xp || 0} XP
                        </p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%;">九 V칳born캩!</button>
                </div>
            `);
        }
        
        // Kontrola spln캩n칤 c칤l콢 timed quest콢
        function checkTimedQuestObjectives(action, target) {
            if (!state.timedQuests) return;
            
            state.timedQuests.filter(tq => !tq.completed && !tq.failed).forEach(tq => {
                const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                if (!quest) return;
                
                let allComplete = true;
                
                tq.objectives.forEach((obj, i) => {
                    if (obj.completed) return;
                    
                    const questObj = quest.objectives[i];
                    
                    // Kontrola podle typu c칤le
                    if (questObj.type === 'location' && action === 'location' && target === questObj.target) {
                        obj.completed = true;
                        addLog(`九 C칤l spln캩n: ${questObj.text}`, '游늶');
                    }
                    if (questObj.type === 'item' && action === 'item' && state.inv.some(i => i.id === questObj.target)) {
                        obj.completed = true;
                        addLog(`九 C칤l spln캩n: ${questObj.text}`, '游늶');
                    }
                    if (questObj.type === 'combat' && action === 'combat_victory') {
                        obj.completed = true;
                        addLog(`九 C칤l spln캩n: ${questObj.text}`, '游늶');
                    }
                    // Interact se spln칤 automaticky po spln캩n칤 p콏edchoz칤ch c칤l콢 na spr치vn칠 lokaci
                    if (questObj.type === 'interact' && action === 'interact' && target === questObj.id) {
                        obj.completed = true;
                        addLog(`九 C칤l spln캩n: ${questObj.text}`, '游늶');
                    }
                    // Search - prohled치n칤 lokace (vol치 se p콏i explore/search akci)
                    if (questObj.type === 'search' && action === 'search' && target === questObj.target) {
                        obj.completed = true;
                        addLog(`九 C칤l spln캩n: ${questObj.text}`, '游댌');
                    }
                    // Skill check - kontrola dovednosti (vol치 se p콏i pou쬴t칤 skillu)
                    if (questObj.type === 'skill_check' && action === 'skill_check') {
                        // Kontrola po쬬dovan칠ho skillu
                        const requiredSkill = questObj.skill || 'int';
                        const requiredValue = questObj.value || 5;
                        const playerValue = state.char.attrs[requiredSkill] || 0;
                        
                        if (playerValue >= requiredValue) {
                            obj.completed = true;
                            addLog(`九 C칤l spln캩n: ${questObj.text}`, '游꿢');
                        } else {
                            addLog(`仇 Nespln캩no: Pot콏ebuje코 ${requiredSkill.toUpperCase()} ${requiredValue}+`, '游꿢');
                        }
                    }
                    
                    if (!obj.completed) allComplete = false;
                });
                
                // V코echny c칤le spln캩ny?
                if (allComplete) {
                    completeTimedQuest(tq.id);
                }
            });
        }
        
        // Dokon캜칤 interact objective v timed questu
        function completeInteractObjective(objectiveId) {
            checkTimedQuestObjectives('interact', objectiveId);
            
            // Speci치ln칤 efekty pro r콢zn칠 objectives
            if (objectiveId === 'free_hostage') {
                showModal('游똂 Rukojm칤 osvobozen!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游똂</div>
                        <h3 style="color: #8bc34a;">Zachr치nil jsi rukojm칤!</h3>
                        <p style="color: #888;">"D캩kuji ti! Myslel jsem, 쬰 um콏u..."</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 V칳born캩!</button>
                `);
                SoundSystem.play('victory');
            } else if (objectiveId === 'find_mother') {
                showModal('游놀 Matka nalezena!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游놀</div>
                        <h3 style="color: #8bc34a;">Na코el jsi matku d칤t캩te!</h3>
                        <p style="color: #888;">"Moje d칤t캩! Kde je?"</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 V칳born캩!</button>
                `);
                SoundSystem.play('victory');
            } else if (objectiveId === 'find_survivor') {
                showModal('游닡 P콏e쬴v코칤 nalezen!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游녻</div>
                        <h3 style="color: #8bc34a;">Na코el jsi zdroj sign치lu!</h3>
                        <p style="color: #888;">"Kone캜n캩 n캩kdo p콏i코el!"</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 V칳born캩!</button>
                `);
                SoundSystem.play('victory');
            }
            
            renderFull();
        }
        
        // Kontrola spln캩n칤 c칤l콢 companion quest콢
        function checkCompanionQuestObjectives(action, target) {
            if (!state.companions) return;
            
            state.companions.forEach(comp => {
                if (!comp.activeQuest) return;
                
                const questData = COMPANION_QUESTS[comp.id];
                if (!questData) return;
                
                const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
                if (!chapter) return;
                
                let allComplete = true;
                
                comp.activeQuest.objectives.forEach((obj, i) => {
                    if (obj.completed) return;
                    
                    const chapterObj = chapter.objectives[i];
                    
                    // Kontrola podle typu c칤le
                    if (chapterObj.type === 'location' && action === 'location' && target === chapterObj.target) {
                        obj.completed = true;
                        addLog(`游눟 ${comp.name}: C칤l spln캩n!`, '游늶');
                    }
                    if (chapterObj.type === 'explore' && action === 'explore' && target === chapterObj.target) {
                        obj.completed = true;
                        addLog(`游눟 ${comp.name}: C칤l spln캩n!`, '游늶');
                    }
                    if (chapterObj.type === 'item' && action === 'item' && state.inv.some(i => i.id === chapterObj.target)) {
                        obj.completed = true;
                        addLog(`游눟 ${comp.name}: C칤l spln캩n!`, '游늶');
                    }
                    if (chapterObj.type === 'combat' && action === 'combat_victory') {
                        obj.completed = true;
                        addLog(`游눟 ${comp.name}: C칤l spln캩n!`, '游늶');
                    }
                    
                    if (!obj.completed) allComplete = false;
                });
                
                // V코echny c칤le spln캩ny?
                if (allComplete) {
                    completeCompanionQuest(comp.id);
                }
            });
        }
        
        function renderTimedQuestTracker() {
            if (!state.timedQuests || state.timedQuests.filter(q => !q.completed && !q.failed).length === 0) return '';
            
            const activeQuests = state.timedQuests.filter(q => !q.completed && !q.failed);
            const now = Date.now();
            
            return activeQuests.map(tq => {
                const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                if (!quest) return '';
                
                const remaining = Math.max(0, tq.endTime - now);
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const urgency = remaining < 10 * 60000 ? '#f44336' : remaining < 30 * 60000 ? '#ff9800' : '#4caf50';
                
                // Najdi prvn칤 nespln캩n칳 c칤l s lokac칤
                const nextObjective = tq.objectives.find(o => !o.completed);
                let targetLocation = null;
                if (nextObjective) {
                    const questObj = quest.objectives.find(qo => qo.id === nextObjective.id);
                    if (questObj?.target) {
                        targetLocation = WORLD_LOCATIONS.find(l => l.id === questObj.target);
                    } else if (questObj?.location) {
                        targetLocation = WORLD_LOCATIONS.find(l => l.id === questObj.location);
                    }
                }
                
                return `
                    <div style="background: #1a1a2a; padding: 0.6rem; border-radius: 6px; border-left: 3px solid ${urgency}; margin-bottom: 0.5rem; cursor: pointer;" onclick="showTimedQuestDetail('${tq.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">${quest.icon} ${quest.name}</span>
                            <span style="color: ${urgency}; font-family: monospace; font-size: 1.1rem; ${remaining < 10 * 60000 ? 'animation: pulse 1s infinite;' : ''}">낋 ${minutes}:${seconds.toString().padStart(2, '0')}</span>
                        </div>
                        ${targetLocation ? `<div style="font-size: 0.75rem; color: #64b5f6; margin-top: 0.3rem;">游늸 C칤l: ${targetLocation.icon} ${targetLocation.name}</div>` : ''}
                        <div style="font-size: 0.8rem; color: #888; margin-top: 0.3rem;">${nextObjective ? ' ' + quest.objectives.find(o => o.id === nextObjective.id)?.text : quest.description}</div>
                    </div>
                `;
            }).join('');
        }
        
        function showTimedQuestDetail(questId) {
            const tq = state.timedQuests?.find(q => q.id === questId);
            const quest = TIMED_QUESTS.find(q => q.id === questId);
            if (!tq || !quest) return;
            
            const remaining = Math.max(0, tq.endTime - Date.now());
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            const urgency = remaining < 10 * 60000 ? '#f44336' : remaining < 30 * 60000 ? '#ff9800' : '#4caf50';
            
            let objectivesHtml = quest.objectives.map((obj, i) => {
                const done = tq.objectives[i]?.completed;
                let locationInfo = '';
                
                if (obj.target) {
                    const loc = WORLD_LOCATIONS.find(l => l.id === obj.target);
                    if (loc) locationInfo = `  ${loc.icon} ${loc.name} (${loc.x}, ${loc.y})`;
                } else if (obj.location) {
                    const loc = WORLD_LOCATIONS.find(l => l.id === obj.location);
                    if (loc) locationInfo = `  ${loc.icon} ${loc.name} (${loc.x}, ${loc.y})`;
                }
                
                return `
                    <div style="padding: 0.4rem; background: ${done ? '#1a2a1a' : '#2a1a1a'}; border-radius: 4px; margin-bottom: 0.3rem;">
                        <span style="color: ${done ? '#4caf50' : '#ff9800'};">${done ? '九' : '餃'}</span>
                        ${obj.text}
                        ${locationInfo ? `<div style="font-size: 0.75rem; color: #64b5f6; margin-top: 0.2rem;">${locationInfo}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            showModal(`${quest.icon} ${quest.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem; color: ${urgency}; font-family: monospace; ${remaining < 10 * 60000 ? 'animation: pulse 1s infinite;' : ''}">
                        낋 ${minutes}:${seconds.toString().padStart(2, '0')}
                    </div>
                    <p style="color: #888;">${quest.description}</p>
                </div>
                
                <h4 style="color: #ffd700; margin-bottom: 0.5rem;">游늶 C칤le:</h4>
                ${objectivesHtml}
                
                <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 6px; margin-top: 1rem; border: 1px solid #f44336;">
                    <p style="color: #f44336; font-size: 0.85rem; margin: 0;">
                        丘멆잺 P콏i selh치n칤: ${quest.failureConsequence.text}
                    </p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${'Zp캩t'}</button>
            `);
        }
        
        // ============================================================
        // === 游댌 DETEKTIVN칈 QUESTY ===
        // ============================================================
        
        function startDetectiveQuest(questId) {
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            if (!state.detectiveQuests) state.detectiveQuests = {};
            
            state.detectiveQuests[questId] = {
                id: questId,
                startTime: Date.now(),
                endTime: quest.timeLimit ? Date.now() + quest.timeLimit : null,
                cluesFound: [],
                suspectsInterrogated: [],
                accusation: null,
                solved: false
            };
            
            addLog(`游댌 Nov칳 p콏칤pad: ${quest.name}`, '游늶');
            showDetectiveQuestIntro(quest);
        }
        
        function showDetectiveQuestIntro(quest) {
            let suspectsHtml = quest.suspects.map(s => `
                <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span style="font-size: 1.5rem;">${s.icon}</span>
                    <div>
                        <div style="font-weight: bold;">${s.name}</div>
                        <div style="font-size: 0.8rem; color: #888;">Motiv: ${s.motive}</div>
                    </div>
                </div>
            `).join('');
            
            showModal(`游댌 ${quest.name}`, `
                <div style="margin-bottom: 1rem;">
                    <p style="color: #ccc; line-height: 1.5;">${quest.description}</p>
                </div>
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">Podez콏el칤:</h4>
                ${suspectsHtml}
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px; margin-top: 1rem;">
                    <p style="color: #4caf50; margin: 0;">游눠 Sb칤rej stopy na r콢zn칳ch lokac칤ch a vysl칳chej podez콏el칠. A bude코 m칤t ${quest.requiredClues} stopy, m콢쬰코 n캩koho obvinit.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">游댌 Za캜칤t vy코et콏ov치n칤</button>
            `);
        }
        
        function findClue(questId, clueId) {
            if (!state.detectiveQuests?.[questId]) return false;
            
            const dq = state.detectiveQuests[questId];
            if (dq.cluesFound.includes(clueId)) return false;
            
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!quest) return false;
            
            dq.cluesFound.push(clueId);
            
            // Najdi ke kter칠 stop캩 pat콏칤
            let suspectName = '';
            quest.suspects.forEach(s => {
                if (s.clues.includes(clueId)) suspectName = s.name;
            });
            
            const clueNames = {
                'bloody_knife': '游댥 Zakrv치cen칳 n콢',
                'torn_cloth': '游녮 Roztrhan칠 oble캜en칤',
                'angry_letter': '游닇 Zlostn칳 dopis',
                'witness_testimony': '游녜勇 Sv캩dectv칤 sv캩dka',
                'perfume_bottle': '游빖 Lahvi캜ka parf칠mu',
                'love_letter': '游눏 Milostn칳 dopis',
                'debt_note': '游늶 Dlu쬹칤 칰pis',
                'brass_knuckles': '游녥 Boxery',
                'child_toy': '游빚 D캩tsk치 hra캜ka',
                'footprints': '游녺 Stopy',
                'slaver_note': '游닆 Zpr치va otrok치콏콢',
                'cage_marks': '久勇 Stopy po kleci',
                'chemical_residue': '游빍 Chemick칠 reziduum',
                'lab_notes': '游 Laboratorn칤 z치pisky',
                'faction_symbol': '丘덢잺 Symbol frakce',
                'poison_vial': '驕멆잺 Lahvi캜ka jedu'
            };
            
            showModal('游댌 Stopa nalezena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${clueNames[clueId]?.split(' ')[0] || '游댌'}</div>
                    <h3 style="color: #ffd700;">${clueNames[clueId] || clueId}</h3>
                    ${suspectName ? `<p style="color: #888;">Ukazuje na: <strong>${suspectName}</strong></p>` : ''}
                    <p style="margin-top: 1rem;">Stopy: ${dq.cluesFound.length}/${quest.requiredClues}</p>
                    ${dq.cluesFound.length >= quest.requiredClues ? 
                        `<p style="color: #4caf50;">${'九 M치코 dost stop! M콢쬰코 obvinit podez콏el칠ho.'}</p>` : ''}
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 Pokra캜ovat</button>
                </div>
            `);
            
            return true;
        }
        
        function accuseSuspect(questId, suspectId) {
            const dq = state.detectiveQuests?.[questId];
            if (!dq) return;
            
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            if (dq.cluesFound.length < quest.requiredClues) {
                notifyWarning('Nedostatek d콢kaz콢!', `Pot콏ebuje코 alespo켿 ${quest.requiredClues} stop.`);
                return;
            }
            
            const suspect = quest.suspects.find(s => s.id === suspectId);
            if (!suspect) return;
            
            dq.accusation = suspectId;
            dq.solved = true;
            
            if (suspect.isGuilty) {
                // Spr치vn칠 obvin캩n칤!
                addLog(`游꿀 P콏칤pad vy콏e코en! ${suspect.name} byl vinen!`, '游댌');
                
                if (quest.reward) {
                    if (quest.reward.money) addMoney(quest.reward.money);
                    if (quest.reward.xp) addXP(quest.reward.xp);
                    if (quest.reward.reputation) {
                        Object.entries(quest.reward.reputation).forEach(([faction, amt]) => {
                            if (!state.factionReputation) state.factionReputation = {};
                            state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        });
                    }
                    if (quest.reward.title) {
                        if (!state.titles) state.titles = [];
                        state.titles.push(quest.reward.title);
                    }
                }
                
                showModal('游꿀 P콏칤pad vy콏e코en!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游끥</div>
                        <h3 style="color: #4caf50;">${suspect.name} byl vinen!</h3>
                        <p>Tvoje dedukce byla spr치vn치. Spravedlnosti bylo u캜in캩no zadost.</p>
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px; margin: 1rem 0;">
                            <p style="color: #4caf50;">Odm캩na: ${quest.reward.money || 0} 游눯, ${quest.reward.xp || 0} XP</p>
                            ${quest.reward.title ? `<p style="color: #ffd700;">游끤 Nov칳 titul: ${quest.reward.title}</p>` : ''}
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%;">九 V칳born캩!</button>
                    </div>
                `);
            } else {
                // 맗atn칠 obvin캩n칤
                addLog(`仇 맗atn칠 obvin캩n칤! ${suspect.name} byl nevinn칳!`, '游댌');
                
                if (quest.wrongAccusation?.penalty) {
                    const p = quest.wrongAccusation.penalty;
                    if (p.reputation) {
                        Object.entries(p.reputation).forEach(([faction, amt]) => {
                            if (!state.factionReputation) state.factionReputation = {};
                            state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        });
                    }
                    if (p.karma) state.karma = (state.karma || 0) + p.karma;
                }
                
                showModal('仇 맗atn칠 obvin캩n칤!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游땞</div>
                        <h3 style="color: #f44336;">${suspect.name} byl nevinn칳!</h3>
                        <p>${quest.wrongAccusation?.text || 'Obvinil jsi nevinn칠ho 캜lov캩ka.'}</p>
                        <p style="color: #ff9800; margin-top: 1rem;">Skute캜n칳 pachatel unikl...</p>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">游 Pokra캜ovat</button>
                    </div>
                `);
            }
        }
        
        function showDetectiveQuestStatus(questId) {
            const dq = state.detectiveQuests?.[questId];
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!dq || !quest) return;
            
            const clueNames = {
                'bloody_knife': '游댥 Zakrv치cen칳 n콢',
                'torn_cloth': '游녮 Roztrhan칠 oble캜en칤',
                'angry_letter': '游닇 Zlostn칳 dopis',
                'witness_testimony': '游녜勇 Sv캩dectv칤',
                'perfume_bottle': '游빖 Parf칠m',
                'love_letter': '游눏 Milostn칳 dopis',
                'debt_note': '游늶 Dlu쬹칤 칰pis',
                'brass_knuckles': '游녥 Boxery'
            };
            
            let cluesHtml = dq.cluesFound.length > 0 ? 
                dq.cluesFound.map(c => `<span style="background: #2a2a1a; padding: 0.2rem 0.5rem; border-radius: 3px; margin: 0.2rem;">${clueNames[c] || c}</span>`).join('') :
                '<span style="color: #666;">Zat칤m 쮂멳n칠 stopy</span>';
            
            let suspectsHtml = quest.suspects.map(s => {
                const cluesForSuspect = s.clues.filter(c => dq.cluesFound.includes(c)).length;
                const canAccuse = dq.cluesFound.length >= quest.requiredClues;
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.6rem; border-radius: 4px; margin-bottom: 0.3rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">${s.icon}</span>
                            <div>
                                <div style="font-weight: bold;">${s.name}</div>
                                <div style="font-size: 0.75rem; color: #888;">Stopy: ${cluesForSuspect}/${s.clues.length}</div>
                            </div>
                        </div>
                        ${canAccuse ? `<button class="btn" onclick="accuseSuspect('${questId}', '${s.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #c62828;">丘뒲잺 Obvinit</button>` : ''}
                    </div>
                `;
            }).join('');
            
            showModal(`游댌 ${quest.name}`, `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #ffd700;">游늶 Nalezen칠 stopy (${dq.cluesFound.length}/${quest.requiredClues}):</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin: 0.5rem 0;">
                        ${cluesHtml}
                    </div>
                </div>
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">Podez콏el칤:</h4>
                ${suspectsHtml}
                ${dq.cluesFound.length < quest.requiredClues ? 
                    `<p style="color: #888; font-size: 0.85rem; margin-top: 1rem;">${'游눠 Najdi v칤ce stop ne bude코 moci n캩koho obvinit.'}</p>` : 
                    `<p style="color: #4caf50; font-size: 0.85rem; margin-top: 1rem;">${'九 M치코 dost d콢kaz콢! Vyber podez콏el칠ho a obvi켿 ho.'}</p>`}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        // ============================================================
        // === 游논 COMPANION QUESTY ===
        // ============================================================
        
        function checkCompanionQuests() {
            if (!state.companions || state.companions.length === 0) return;
            
            state.companions.forEach(comp => {
                const questData = COMPANION_QUESTS[comp.id];
                if (!questData) return;
                
                if (!comp.completedQuests) comp.completedQuests = [];
                if (!comp.activeQuest) {
                    // Hledej nov칳 quest
                    for (const chapter of questData.chapters) {
                        if (comp.completedQuests.includes(chapter.id)) continue;
                        if (checkCompanionQuestTrigger(comp.id, chapter)) {
                            triggerCompanionQuest(comp.id, chapter);
                            break;
                        }
                    }
                }
            });
        }
        
        function triggerCompanionQuest(companionId, chapter) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            comp.activeQuest = {
                id: chapter.id,
                objectives: chapter.objectives.map(o => ({...o, completed: false})),
                startTime: Date.now()
            };
            
            const questData = COMPANION_QUESTS[companionId];
            
            // === SPAWN QUEST ITEMS ===
            // Pro ka쬯칳 objective typu 'item', spawnuj item na p콏칤slu코n칠 lokaci
            chapter.objectives.forEach(obj => {
                if (obj.type === 'item' && obj.target) {
                    // Ur캜i spawn lokaci
                    const spawnLocations = {
                        'old_collar': 'old_farm',
                        'dogtags': 'military_base',
                        'medical_records': 'hospital',
                        'lab_samples': 'research_facility',
                        'secret_documents': 'underground_bunker',
                        'family_photo': 'ruined_houses',
                        'old_toy': 'playground',
                        'ancient_relic': 'ancient_ruins'
                    };
                    
                    const spawnLocation = spawnLocations[obj.target] || chapter.trigger?.location || 'shelter';
                    
                    // Ulo quest item do world state
                    if (!state.world.questItemSpawns) state.world.questItemSpawns = {};
                    state.world.questItemSpawns[obj.target] = {
                        location: spawnLocation,
                        companion: companionId,
                        questId: chapter.id
                    };
                    
                    console.log(`游닍 Spawned quest item: ${obj.target} at ${spawnLocation}`);
                }
            });
            
            // Pokud prob칤h치 boj, odlo zobrazen칤 questu
            if (isInCombat()) {
                // Ulo pro zobrazen칤 po boji
                if (!state._pendingCompanionQuests) state._pendingCompanionQuests = [];
                state._pendingCompanionQuests.push({ companionId, chapter, questData, comp });
                notifySuccess(`游눟 ${comp.name}`, 'M치 pro tebe nov칳 칰kol!');
                addLog(`游눟 ${comp.name} m치 pro tebe 칰kol: ${chapter.title}`, '游');
                return;
            }
            
            showModal(`${questData.icon} ${questData.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${comp.icon}</div>
                    <h3 style="color: #ffd700;">${chapter.title}</h3>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ccc; font-style: italic; line-height: 1.5;">"${chapter.dialog.start}"</p>
                </div>
                <p style="color: #888; margin-bottom: 1rem;">${chapter.description}</p>
                <h4 style="color: #ff9800;">C칤le:</h4>
                <ul style="color: #ccc; margin: 0.5rem 0;">
                    ${chapter.objectives.map(o => `<li>${o.text}</li>`).join('')}
                </ul>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">游 Pom콢쬿 ti!</button>
            `);
            
            addLog(`游눟 ${comp.name} m치 pro tebe 칰kol: ${chapter.title}`, '游');
        }
        
        // P콏ed치n칤 quest itemu spole캜n칤kovi
        function deliverQuestItemToCompanion(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.activeQuest) return;
            
            // Najdi quest data
            const questData = COMPANION_QUESTS[comp.id];
            if (!questData) return;
            
            const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
            if (!chapter) return;
            
            // Najdi item objective
            const itemObjective = chapter.objectives.find(o => o.type === 'item');
            if (!itemObjective) return;
            
            // Kontrola jestli m치코 item
            const item = state.inv.find(i => i.id === itemObjective.target);
            if (!item) {
                notifyWarning('Chyb칤 p콏edm캩t', `Nem치코 ${itemObjective.text}`);
                return;
            }
            
            // Odeber item z invent치콏e
            removeItemFromInventory(item, 1);
            
            // Ozna캜 objective jako spln캩n칳
            const questObj = comp.activeQuest.objectives.find(o => {
                const chapterObj = chapter.objectives.find(co => co.text === o.text);
                return chapterObj && chapterObj.type === 'item';
            });
            if (questObj) questObj.completed = true;
            
            // Zkontroluj jestli jsou v코echny c칤le spln캩ny
            const allComplete = comp.activeQuest.objectives.every(o => o.completed);
            
            if (allComplete) {
                completeCompanionQuest(companionId);
            } else {
                notifySuccess('游닍 P콏ed치no!', `${comp.name} obdr쬰l ${item.name}`);
                addLog(`游닍 P콏edal jsi ${item.name} spole캜n칤kovi ${comp.name}`, '游눟');
                showCompanionsInfo(); // Refresh
            }
            
            saveGame();
        }
        
        // Zjist칤 jestli spole캜n칤k 캜ek치 na quest item
        function getCompanionPendingQuestItem(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.activeQuest) return null;
            
            const questData = COMPANION_QUESTS[comp.id];
            if (!questData) return null;
            
            const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
            if (!chapter) return null;
            
            // Najdi nespln캩n칳 item objective
            for (let i = 0; i < chapter.objectives.length; i++) {
                const obj = chapter.objectives[i];
                const questObj = comp.activeQuest.objectives[i];
                
                if (obj.type === 'item' && !questObj?.completed) {
                    // M치 hr치캜 tento item?
                    const hasItem = state.inv.some(item => item.id === obj.target);
                    if (hasItem) {
                        const itemDef = QUEST_ITEMS.find(qi => qi.id === obj.target) || ITEMS.find(it => it.id === obj.target);
                        return {
                            itemId: obj.target,
                            itemName: itemDef?.name || obj.target,
                            itemIcon: itemDef?.icon || '游닍'
                        };
                    }
                }
            }
            return null;
        }
        
        function completeCompanionQuest(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.activeQuest) return;
            
            const questData = COMPANION_QUESTS[companionId];
            const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
            if (!chapter) return;
            
            comp.completedQuests.push(chapter.id);
            
            // Aplikuj odm캩ny
            if (chapter.reward) {
                if (chapter.reward.companionXP) {
                    comp.xp = (comp.xp || 0) + chapter.reward.companionXP;
                }
                if (chapter.reward.bond) {
                    comp.loyalty = (comp.loyalty || 50) + chapter.reward.bond;
                }
                if (chapter.reward.skill) {
                    if (!comp.unlockedSkills) comp.unlockedSkills = [];
                    comp.unlockedSkills.push(chapter.reward.skill);
                }
                if (chapter.reward.stats) {
                    Object.entries(chapter.reward.stats).forEach(([stat, val]) => {
                        comp[stat] = (comp[stat] || 0) + val;
                    });
                }
            }
            
            showModal(`游눟 Quest dokon캜en!`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${comp.icon}</div>
                    <h3 style="color: #4caf50;">${chapter.title}</h3>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p style="color: #ccc; font-style: italic;">"${chapter.dialog.complete}"</p>
                </div>
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px;">
                    <p style="color: #4caf50; margin: 0;">
                        ${chapter.reward.bond ? `+${chapter.reward.bond} Pouto` : ''}
                        ${chapter.reward.skill ? ` | 游 Nov치 schopnost: ${chapter.reward.skill}` : ''}
                    </p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">游눟 Skv캩l칠!</button>
            `);
            
            comp.activeQuest = null;
            addLog(`游눟 ${comp.name}: Quest spln캩n!`, '游끥');
        }
        
        // Aktualizace p콏i game tick
        setInterval(() => {
            updateTimedQuests();
            checkCompanionQuests();
        }, 10000); // Ka쬯칳ch 10 sekund
        
        // Fronta pro level up zpr치vy b캩hem boje
        let pendingLevelUp = null;
        
        // Vypo캜칤t치 level z celkov칳ch XP
        // Level 1: 0 XP, Level 2: 100 XP, Level 3: 250 XP, Level 4: 475 XP, ...
        // Vzorec pro XP pot콏ebn칠 na level N: sum(100 * 1.5^(i-1)) pro i=1 to N-1
        function getLevelFromTotalXP(totalXP) {
            let level = 1;
            let xpNeeded = 0;
            while (true) {
                const xpForNextLevel = Math.floor(BASE_XP * Math.pow(1.5, level - 1));
                if (xpNeeded + xpForNextLevel > totalXP) break;
                xpNeeded += xpForNextLevel;
                level++;
                if (level > 100) break; // Max level cap
            }
            return level;
        }
        
        // Vypo캜칤t치 celkov칠 XP pot콏ebn칠 pro dosa쬰n칤 dan칠ho levelu
        function getTotalXPForLevel(level) {
            let total = 0;
            for (let i = 1; i < level; i++) {
                total += Math.floor(BASE_XP * Math.pow(1.5, i - 1));
            }
            return total;
        }
        
        // Vypo캜칤t치 XP pot콏ebn칠 pro dal코칤 level
        function getXPForNextLevel(level) {
            return Math.floor(BASE_XP * Math.pow(1.5, level - 1));
        }
        
        function addXP(amount) {
            // === XP SYST칄M ZALO콯EN칗 NA TOTALXP ===
            // totalXP = celkov칠 z칤skan칠 XP (nikdy nekles치)
            // level = vypo캜칤t치no z totalXP
            // xp = progress k dal코칤mu levelu
            // xpNeed = kolik pot콏ebuje코 pro dal코칤 level
            
            // Validace pomoc칤 safe utility
            amount = safeInteger(amount, 0, 0);
            if (amount <= 0) {
                console.warn('仇 addXP: neplatn칳 amount:', amount);
                return;
            }
            
            let finalAmount = amount;
            
            // INT bonus (+10% za bod nad 5)
            const intBonus = Math.max(0, ((state.char?.attrs?.int || 5) - 5) * 0.1);
            finalAmount = Math.floor(finalAmount * (1 + intBonus));
            
            // Companion bonus
            if (typeof getAllCompanionBonuses === 'function') {
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.xpBonus > 0) {
                    finalAmount = Math.floor(finalAmount * (1 + compBonuses.xpBonus));
                }
            }
            
            // 游 Exotic bonus - P콏edv치le캜n치 tech (+25% XP na 48h)
            if (state.exoticBonuses?.xpBoost && state.exoticBonuses.xpBoost > Date.now()) {
                finalAmount = Math.floor(finalAmount * 1.25);
            }
            
            // 游댯 Frak캜n칤 bonus - Koudyho nad캩je (+5% XP)
            const factionBonus = getFactionBonus();
            if (factionBonus.xp > 0) {
                finalAmount = Math.floor(finalAmount * (1 + factionBonus.xp));
            }
            
            // Max 1000 XP najednou (anti-cheat)
            const MAX_XP_PER_ACTION = 1000;
            finalAmount = Math.min(finalAmount, MAX_XP_PER_ACTION);
            
            // Kontrola max level
            if ((state.char.level || 1) >= GAME_CONSTANTS.MAX_LEVEL) {
                console.log('游꿡 Max level dosa쬰n, XP se nep콏id치v치');
                return;
            }
            
            // P콏idej k totalXP s kontrolou maxima
            const oldLevel = state.char.level || 1;
            const newTotalXP = (state.char.totalXP || 0) + finalAmount;
            state.char.totalXP = Math.min(newTotalXP, GAME_CONSTANTS.MAX_XP);
            
            console.log(`游꿡 +${finalAmount} XP | TotalXP: ${state.char.totalXP}`);
            
            // Vypo캜칤tej level z totalXP
            recalculateLevelFromTotalXP();
            
            const levelsGained = state.char.level - oldLevel;
            
            // Floating number
            if (typeof showFloatingNumber === 'function') {
                showFloatingNumber(finalAmount, 'xp');
            }
            
            // Level up efekty
            if (levelsGained > 0) {
                state.char.skillPoints = (state.char.skillPoints || 0) + levelsGained;
                state.char.levelUpPoints = (state.char.levelUpPoints || 0) + levelsGained;
                state.skillTreePoints = (state.skillTreePoints || 0) + levelsGained;
                state.char.hp = state.char.maxHp;
                
                if (typeof checkAchievements === 'function') checkAchievements();
                if (typeof checkUnlocks === 'function') checkUnlocks();
                
                let lvlMsg = `游꿀 LEVEL UP! Dos치hl jsi level ${state.char.level}!`;
                if (levelsGained > 1) lvlMsg += ` (+${levelsGained} level콢)`;
                lvlMsg += `<br>+${levelsGained} bod${levelsGained > 1 ? 'y' : ''} atribut콢 | +${levelsGained} bod${levelsGained > 1 ? 'y' : ''} schopnost칤`;
                lvlMsg += `<br>仇벒잺 HP dopln캩no na maximum!`;
                
                pendingLevelUp = { level: state.char.level, message: lvlMsg };
            }
            
            if (typeof renderFull === 'function') renderFull();
        }
        
        // P콏epo캜칤t치 level, xp a xpNeed z totalXP
        function recalculateLevelFromTotalXP() {
            const totalXP = state.char?.totalXP || 0;
            let level = 1;
            let xpUsed = 0;
            
            // Vzorec: xpNeed = BASE_XP * (XP_MULTIPLIER ^ (level-1))
            const BASE = GAME_CONSTANTS.BASE_XP_REQUIREMENT;
            const MULT = GAME_CONSTANTS.XP_MULTIPLIER;
            
            while (level < GAME_CONSTANTS.MAX_LEVEL) {
                const xpForThisLevel = Math.floor(BASE * Math.pow(MULT, level - 1));
                if (xpUsed + xpForThisLevel > totalXP) break;
                xpUsed += xpForThisLevel;
                level++;
            }
            
            state.char.level = level;
            state.char.xp = totalXP - xpUsed; // Zbytek XP
            state.char.xpNeed = Math.floor(BASE * Math.pow(MULT, level - 1)); // Kolik pot콏ebuji pro dal코칤 level
            
            console.log(`游늵 Level: ${level}, XP: ${state.char.xp}/${state.char.xpNeed}, TotalXP: ${totalXP}`);
        }
        
        function getPendingLevelUp() {
            const lvl = pendingLevelUp;
            pendingLevelUp = null;
            return lvl;
        }
        
        // === INFO O ATRIBUTU ===
        // === QUEST TRACKER FUNCTIONS ===
        function showQuestTrackerDetail(questType) {
            if (questType === 'story') {
                // Zobraz detail p콏칤b캩hov칠ho questu
                const quest = MAIN_QUESTS.find(q => q.id === state.mainQuest?.currentQuest);
                if (quest) {
                    let objectivesHtml = '';
                    let allComplete = true;
                    
                    if (quest.objectives) {
                        objectivesHtml = '<div style="margin-top: 1rem;"><h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游늶 C칤le:</h4>';
                        quest.objectives.forEach(obj => {
                            const savedProgress = state.mainQuest?.questProgress?.[obj.id] || 0;
                            const target = obj.target;
                            let done = false;
                            let displayProgress = '';
                            
                            if (obj.type === 'location') {
                                // Kontroluj ulo쬰n칳 progress NEBO aktu치ln칤 lokaci
                                done = savedProgress >= 1 || state.world.currentLocation === target;
                                // Automaticky ulo progress pokud jsme na c칤lov칠 lokaci
                                if (state.world.currentLocation === target && savedProgress < 1) {
                                    if (!state.mainQuest.questProgress) state.mainQuest.questProgress = {};
                                    state.mainQuest.questProgress[obj.id] = 1;
                                    done = true;
                                }
                            } else if (obj.type === 'visit_locations') {
                                const visited = state.world.visitedLocations?.length || 0;
                                done = visited >= target;
                                displayProgress = `(${Math.min(visited, target)}/${target})`;
                            } else if (obj.type === 'item') {
                                done = state.inv.some(i => i.id === target);
                            } else if (obj.type === 'explore') {
                                done = savedProgress >= target;
                                displayProgress = `(${savedProgress}/${target})`;
                            } else if (obj.type === 'kill') {
                                done = savedProgress >= 1;
                            } else {
                                done = savedProgress >= 1;
                            }
                            
                            if (!done) allComplete = false;
                            
                            const locName = obj.type === 'location' ? (WORLD_LOCATIONS.find(l => l.id === target)?.name || target) : null;
                            
                            objectivesHtml += `<div style="padding: 0.4rem; background: ${done ? '#1a2a1a' : '#1a1a1a'}; border-radius: 4px; margin-bottom: 0.3rem; border-left: 3px solid ${done ? '#4caf50' : '#666'};">
                                <span style="color: ${done ? '#8bc34a' : '#aaa'};">${done ? '九' : '餃'} ${obj.text}</span>
                                ${displayProgress ? `<span style="color: #888; font-size: 0.8rem;"> ${displayProgress}</span>` : ''}
                                ${locName ? `<div style="font-size: 0.75rem; color: #666;">游늸 ${locName}</div>` : ''}
                            </div>`;
                        });
                        objectivesHtml += '</div>';
                    }
                    
                    // Kontrola po쬬dovan칠ho itemu
                    const hasRequiredItem = !quest.requiresItem || state.inv.some(i => i.id === quest.requiresItem);
                    const canComplete = allComplete && hasRequiredItem;
                    
                    showModal('游닀 ' + quest.title, `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 0.8rem; color: #ffd700;">Kapitola ${quest.chapter}</div>
                        </div>
                        <p style="color: #aaa;">${quest.description || quest.desc || ''}</p>
                        ${objectivesHtml}
                        ${quest.reward ? `<div style="margin-top: 1rem; padding: 0.5rem; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <span style="color: #ffd700;">游꾸 Odm캩na: ${quest.reward.xp || 0} XP, ${quest.reward.money || 0} 游눯</span>
                        </div>` : ''}
                        ${canComplete ? `
                            <button class="btn" onclick="manualCompleteQuest('${quest.id}')" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #4caf50, #2e7d32); font-weight: bold;">
                                九 Dokon캜it a z칤skat odm캩nu
                            </button>
                        ` : ''}
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: ${canComplete ? '0.5rem' : '1rem'}; background: #555;">${t('ui', 'close')}</button>
                    `);
                } else {
                    showModal('游닀 P콏칤b캩h', '<p style="color: #888;">콯치dn칳 aktivn칤 p콏칤b캩hov칳 quest.</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>');
                }
            } else if (questType === 'npc') {
                // Zobraz seznam NPC quest콢
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                let hasQuests = false;
                
                Object.entries(state.npcQuests || {}).forEach(([npcId, questData]) => {
                    if (questData?.id) {
                        hasQuests = true;
                        const quest = NPC_QUESTS[questData.id];
                        const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                        if (quest && npc) {
                            const locName = WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location;
                            const canComplete = checkNPCQuestProgress(questData, quest);
                            const isAtNpc = state.world.currentLocation === npc.location;
                            
                            html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${canComplete ? '#4caf50' : '#ff9800'};">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${npc.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: ${canComplete ? '#4caf50' : '#ff9800'};">${quest.name}</div>
                                        <div style="font-size: 0.8rem; color: #888;">Od: ${npc.name}</div>
                                    </div>
                                    ${canComplete ? '<span style="color: #4caf50;">九</span>' : ''}
                                </div>
                                <p style="margin: 0; color: #aaa; font-size: 0.9rem;">${quest.desc}</p>
                                <div style="margin-top: 0.5rem; background: #0a0a0a; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                    ${renderQuestProgress(questData, quest)}
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">游늸 Odevzdat: ${locName}</div>
                                <div style="margin-top: 0.3rem; font-size: 0.8rem; color: #ffd700;">游꾸 Odm캩na: ${quest.reward?.money || 0} 游눯, ${quest.reward?.trust || 0} 仇벒잺</div>
                                ${canComplete ? `
                                    ${isAtNpc ? `
                                        <button class="btn" onclick="completeNPCQuest('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: #4caf50;">九 Odevzdat quest</button>
                                    ` : `
                                        <div style="margin-top: 0.5rem; padding: 0.4rem; background: #2a2a1a; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #ff9800;">
                                            丘멆잺 Jdi k ${npc.name} pro odevzd치n칤
                                        </div>
                                    `}
                                ` : ''}
                            </div>`;
                        }
                    }
                });
                
                if (!hasQuests) {
                    html += '<p style="color: #666; text-align: center;">콯치dn칠 aktivn칤 NPC questy.<br>Nav코tiv p콏치telsk치 NPC pro nov칠 칰koly!</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('游논 NPC Questy', html);
                
            } else if (questType === 'daily') {
                // Zobraz denn칤 questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                if (state.dailyQuests?.quests?.length > 0) {
                    state.dailyQuests.quests.forEach(q => {
                        const completed = state.dailyQuests.completed?.includes(q.id);
                        // Zjisti progress podle typu questu - pou쬴j progressKey a target z definice
                        let progress = 0;
                        let target = q.target || 1;
                        
                        // Najdi definici questu pro progressKey
                        const questDef = DAILY_QUEST_POOL.find(dq => dq.id === q.id);
                        if (questDef && questDef.progressKey) {
                            progress = state.dailyQuests.progress?.[questDef.progressKey] || 0;
                        } else {
                            // Fallback pro star칠 questy
                            if (q.id === 'kill_enemies') { progress = state.dailyQuests.progress?.kills || 0; }
                            else if (q.id === 'explore_hexes') { progress = state.dailyQuests.progress?.explored || 0; }
                            else if (q.id === 'craft_items') { progress = state.dailyQuests.progress?.crafted || 0; }
                            else if (q.id === 'collect_money') { progress = state.dailyQuests.progress?.moneyEarned || 0; }
                            else if (q.id === 'travel_distance') { progress = state.dailyQuests.progress?.travelled || 0; }
                            else if (q.id === 'collect_loot') { progress = state.dailyQuests.progress?.itemsFound || 0; }
                            else if (q.id === 'feed_companion') { progress = state.dailyQuests.progress?.companionFed || 0; }
                        }
                        
                        // Odm캩na podle typu
                        let rewardText = '';
                        if (q.id === 'kill_enemies') rewardText = '80 游눯';
                        else if (q.id === 'explore_hexes') rewardText = '50 XP';
                        else if (q.id === 'craft_items') rewardText = '10游 5丘뙖잺';
                        else if (q.id === 'collect_money') rewardText = '40 XP';
                        else if (q.id === 'travel_distance') rewardText = '60 游눯 20 XP';
                        else if (q.id === 'collect_loot') rewardText = '70 游눯';
                        else if (q.id === 'feed_companion') rewardText = '25 XP';
                        else rewardText = '游꾸';
                        
                        html += `<div style="background: ${completed ? '#1a2a1a' : '#1a1a1a'}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${completed ? '#4caf50' : '#2196f3'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; color: ${completed ? '#8bc34a' : '#fff'};">${completed ? '九' : '餃'} ${q.icon || ''} ${q.name}</span>
                                <span style="color: #ffd700; font-size: 0.8rem;">游꾸 ${rewardText}</span>
                            </div>
                            <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">${q.desc}</p>
                            <div style="margin-top: 0.5rem; background: #0a0a0a; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${Math.min(100, (progress/target)*100)}%; background: ${completed ? '#4caf50' : '#2196f3'};"></div>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.2rem;">${progress}/${target}</div>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">' + ('콯치dn칠 denn칤 questy.') + '</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('游늰 Denn칤 칰koly', html);
                
            } else if (questType === 'settler') {
                // Zobraz osadnick칠 questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                if (state.settlement?.activeQuests?.length > 0) {
                    state.settlement.activeQuests.forEach(sq => {
                        const questDef = SETTLER_QUESTS?.find(q => q.id === sq.questId);
                        html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #8bc34a;">
                            <div style="font-weight: bold; color: #8bc34a;">${questDef?.icon || '游늶'} ${questDef?.name || sq.questId}</div>
                            <div style="font-size: 0.8rem; color: #888;">Od: ${sq.settlerName || 'Osadn칤k'}</div>
                            <p style="margin: 0.3rem 0 0 0; color: #aaa; font-size: 0.85rem;">${questDef?.desc || ''}</p>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">콯치dn칠 aktivn칤 칰koly od osadn칤k콢.</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('游끶勇 칔koly osadn칤k콢', html);
            } else if (questType === 'timed') {
                // Zobraz 캜asov캩 limitovan칠 questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                const activeTimedQuests = state.timedQuests?.filter(q => !q.completed && !q.failed) || [];
                
                if (activeTimedQuests.length > 0) {
                    activeTimedQuests.forEach(tq => {
                        const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                        if (!quest) return;
                        
                        const remaining = Math.max(0, tq.endTime - Date.now());
                        const minutes = Math.floor(remaining / 60000);
                        const seconds = Math.floor((remaining % 60000) / 1000);
                        const urgency = remaining < 5 * 60000 ? '#f44336' : remaining < 15 * 60000 ? '#ff9800' : '#4caf50';
                        
                        html += `
                            <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${urgency};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 1.5rem;">${quest.icon}</span>
                                    <span style="color: ${urgency}; font-family: monospace; font-size: 1.2rem; font-weight: bold;">낋 ${minutes}:${seconds.toString().padStart(2, '0')}</span>
                                </div>
                                <h3 style="margin: 0.5rem 0; color: #fff;">${quest.name}</h3>
                                <p style="color: #888; margin: 0.3rem 0;">${quest.description}</p>
                                <div style="margin-top: 0.5rem; background: #0a0a0a; padding: 0.5rem; border-radius: 4px;">
                                    <h4 style="color: #ff9800; margin: 0 0 0.3rem 0; font-size: 0.9rem;">C칤le:</h4>
                                    ${quest.objectives.map((obj, i) => {
                                        const completed = tq.objectives[i]?.completed;
                                        return `<div style="color: ${completed ? '#4caf50' : '#aaa'};">${completed ? '九' : '餃'} ${obj.text}</div>`;
                                    }).join('')}
                                </div>
                                <div style="margin-top: 0.5rem; color: #ffd700; font-size: 0.85rem;">
                                    游꾸 Odm캩na: ${quest.reward.money || 0} 游눯, ${quest.reward.xp || 0} XP
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">콯치dn칠 캜asov캩 limitovan칠 questy.</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('낋 캛asov칠 questy', html);
            } else if (questType === 'companion') {
                // Zobraz companion questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                const companionsWithQuests = state.companions?.filter(c => c.activeQuest) || [];
                
                if (companionsWithQuests.length > 0) {
                    companionsWithQuests.forEach(comp => {
                        const questData = COMPANION_QUESTS[comp.id];
                        const chapter = questData?.chapters.find(c => c.id === comp.activeQuest.id);
                        if (!chapter) return;
                        
                        html += `
                            <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #e91e63;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 2rem;">${comp.icon}</span>
                                    <div>
                                        <div style="font-weight: bold; color: #e91e63;">${chapter.title}</div>
                                        <div style="font-size: 0.8rem; color: #888;">${comp.name}</div>
                                    </div>
                                </div>
                                <p style="color: #aaa; margin: 0.5rem 0;">${chapter.description}</p>
                                <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                    <h4 style="color: #ff9800; margin: 0 0 0.3rem 0; font-size: 0.9rem;">C칤le:</h4>
                                    ${chapter.objectives.map((obj, i) => {
                                        const completed = comp.activeQuest.objectives[i]?.completed;
                                        return `<div style="color: ${completed ? '#4caf50' : '#aaa'};">${completed ? '九' : '餃'} ${obj.text}</div>`;
                                    }).join('')}
                                </div>
                                <div style="margin-top: 0.5rem; color: #ffd700; font-size: 0.85rem;">
                                    游꾸 Odm캩na: +${chapter.reward.bond || 0} Pouto ${chapter.reward.skill ? ', 游 ' + chapter.reward.skill : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">콯치dn칠 aktivn칤 companion questy.</p>';
                    html += '<p style="color: #888; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">Cestuj se sv칳mi spole캜n칤ky a buduj s nimi pouto.</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('游눟 Companion questy', html);
            }
        }
        
        // Kontrola quest콢 na aktu치ln칤 lokaci - vol치 se p콏i p콏칤chodu na lokaci
        function checkQuestNotifications(locationId) {
            const notifications = [];
            
            // 1. NPC quest na t칠to lokaci
            if (state.npcQuests) {
                Object.entries(state.npcQuests).forEach(([npcId, questData]) => {
                    if (questData?.id) {
                        const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                        if (npc && npc.location === locationId) {
                            const quest = NPC_QUESTS[questData.id];
                            notifications.push({
                                icon: npc.icon,
                                title: 'Quest: ' + (quest?.name || 'Aktivn칤 칰kol'),
                                text: npc.name + ' tu na tebe 캜ek치!',
                                color: '#ff9800'
                            });
                        }
                    }
                });
            }
            
            // 2. NPC bez questu - m콢쬰코 z칤skat nov칳
            FRIENDLY_NPCS.filter(n => n.location === locationId && !n.rival).forEach(npc => {
                const hasQuest = state.npcQuests?.[npc.id]?.id;
                if (!hasQuest) {
                    notifications.push({
                        icon: npc.icon,
                        title: npc.name,
                        text: 'Mo쬹치 m치 pro tebe 칰kol!',
                        color: '#2196f3'
                    });
                }
            });
            
            // 3. Hlavn칤 p콏칤b캩hov칳 quest
            if (state.mainQuest?.currentQuest && !state.mainQuest.storyComplete) {
                const quest = MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
                if (quest?.objectives) {
                    const relevantObj = quest.objectives.find(o => o.location === locationId);
                    if (relevantObj) {
                        notifications.push({
                            icon: '游닀',
                            title: 'P콏칤b캩hov칳 quest!',
                            text: relevantObj.desc || quest.title,
                            color: '#ffd700'
                        });
                    }
                }
            }
            
            // Zobraz notifikace
            if (notifications.length > 0) {
                notifications.forEach((n, i) => {
                    setTimeout(() => {
                        notifySuccess(n.title, n.text);
                    }, i * 800);
                });
            }
        }
        
        function showSkillDetail(skillId) {
            const skill = SKILLS.find(s => s.id === skillId);
            if (!skill) return;
            
            const currentLevel = state.skills?.[skillId] || 0;
            const totalBonus = skill.value * currentLevel;
            
            // Popis efektu podle typu
            const effectDescriptions = {
                'hunger_efficiency': { name: 'Sn칤쬰n칤 spot콏eby hladu', unit: '%', multiplier: 100 },
                'thirst_efficiency': { name: 'Sn칤쬰n칤 spot콏eby 쮂셬n캩', unit: '%', multiplier: 100 },
                'energy_efficiency': { name: 'Sn칤쬰n칤 spot콏eby energie', unit: '%', multiplier: 100 },
                'loot_chance': { name: 'Bonus k 코anci na loot', unit: '%', multiplier: 100 },
                'travel_speed': { name: 'Zkr치cen칤 캜asu cestov치n칤', unit: '%', multiplier: 100 },
                'radiation_resistance': { name: 'Sn칤쬰n칤 zisku radiace', unit: '%', multiplier: 100 },
                'max_health': { name: 'Bonus k max HP', unit: ' HP', multiplier: 1 },
                'xp_bonus': { name: 'Bonus k z칤skan칳m XP', unit: '%', multiplier: 100 },
                'loot_quality': { name: 'Bonus ke kvalit캩 lootu', unit: '%', multiplier: 100 },
                'health_regen': { name: 'Regenerace HP za minutu', unit: ' HP/min', multiplier: 1 },
                'repair': { name: 'Sleva na opravy', unit: '%', multiplier: 100 }
            };
            
            const effect = effectDescriptions[skill.type] || { name: skill.type, unit: '', multiplier: 1 };
            const currentBonus = (totalBonus * effect.multiplier).toFixed(0);
            const perLevelBonus = (skill.value * effect.multiplier).toFixed(0);
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${skill.icon}</div>
                    <h3 style="margin: 0.5rem 0; color: var(--toxic-green);">${skill.name}</h3>
                    <div style="color: #888; font-size: 0.9rem;">${skill.desc}</div>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #888;">Aktu치ln칤 칰rove켿:</span>
                        <span style="font-size: 1.2rem; font-weight: bold; color: var(--warning-yellow);">${currentLevel} / ${skill.maxLevel}</span>
                    </div>
                    
                    <div style="height: 8px; background: #0a0a0a; border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem;">
                        <div style="height: 100%; width: ${(currentLevel / skill.maxLevel) * 100}%; background: linear-gradient(90deg, var(--toxic-dark), var(--toxic-green));"></div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 8px; border: 1px solid var(--toxic-dark); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--toxic-green);">游늵 Efekt</h4>
                    <div style="display: grid; gap: 0.3rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #aaa;">${effect.name}:</span>
                            <span style="color: var(--toxic-green); font-weight: bold;">${currentLevel > 0 ? '+' + currentBonus + effect.unit : 'Neaktivn칤'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                            <span style="color: #666;">Za ka쬯칳 level:</span>
                            <span style="color: #888;">+${perLevelBonus}${effect.unit}</span>
                        </div>
                        ${currentLevel < skill.maxLevel ? `
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 0.3rem; padding-top: 0.3rem; border-top: 1px solid #333;">
                                <span style="color: #666;">P콏i max levelu:</span>
                                <span style="color: #ffd700;">+${(skill.value * skill.maxLevel * effect.multiplier).toFixed(0)}${effect.unit}</span>
                            </div>
                        ` : `
                            <div style="text-align: center; margin-top: 0.5rem; color: #ffd700;">救 MAXIM츼LN칈 칔ROVE켾 救</div>
                        `}
                    </div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">游눠 Tip</h4>
                    <p style="margin: 0; font-size: 0.8rem; color: #aaa;">
                        Dovednosti z칤sk치v치코 automaticky p콏i hran칤 nebo je m콢쬰코 vylep코it v 游꺕 Stromu dovednost칤.
                    </p>
                </div>
            `;
            
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal(`${skill.icon} ${skill.name}`, html);
        }
        
        function showAttrInfo(attrKey) {
            const attr = ATTRS[attrKey];
            const value = state.char.attrs[attrKey] || 5;
            
            const attrEffects = {
                str: {
                    title: 'S칤la',
                    effects: [
                        { name: '칔tok', formula: '+1 za bod', current: `+${value}` },
                        { name: 'Nosnost', formula: '+2kg za bod', current: `+${value * 2}kg` },
                        { name: 'Po코kozen칤 beze zbran캩', formula: '+0.5 za bod', current: `+${(value * 0.5).toFixed(1)}` }
                    ],
                    desc: 'S칤la ur캜uje fyzickou zdatnost. Ovliv켿uje po코kozen칤 v boji a kolik toho unese코.'
                },
                end: {
                    title: 'V칳dr',
                    effects: [
                        { name: 'Max HP', formula: '+5 za bod', current: `+${value * 5}` },
                        { name: 'Obrana', formula: '+0.5 za bod', current: `+${(value * 0.5).toFixed(1)}` },
                        { name: 'Odolnost radiaci', formula: '+1% za bod', current: `+${value}%` }
                    ],
                    desc: 'V칳dr ur캜uje tv칠 zdrav칤 a odolnost. V칤ce v칳dr쬰 = v칤ce 쬴vot콢 a lep코칤 obrana.'
                },
                agi: {
                    title: 'Hbitost',
                    effects: [
                        { name: '칔hyb', formula: '+2% za bod nad 5', current: `${2 + Math.max(0, value - 5) * 2}%` },
                        { name: 'Rychlost pohybu', formula: '+2% za bod nad 5', current: `+${Math.max(0, value - 5) * 2}%` },
                        { name: '마nce na 칰t캩k', formula: '+3% za bod nad 5', current: `+${Math.max(0, value - 5) * 3}%` }
                    ],
                    desc: 'Hbitost ur캜uje rychlost a obratnost. Pom치h치 vyh칳bat se 칰tok콢m a rychleji cestovat.'
                },
                int: {
                    title: 'Inteligence',
                    effects: [
                        { name: 'XP bonus', formula: '+2% za bod', current: `+${value * 2}%` },
                        { name: 'Efektivita craftingu', formula: '+3% za bod', current: `+${value * 3}%` },
                        { name: 'Ceny v obchod캩', formula: '-1% za bod', current: `-${value}%` }
                    ],
                    desc: 'Inteligence ovliv켿uje u캜en칤 a chytrost. Z칤sk치v치코 v칤ce XP a lep코칤 ceny.'
                },
                per: {
                    title: 'Vn칤m치n칤',
                    effects: [
                        { name: 'Kritick칳 z치sah', formula: '+3% za bod', current: `${value * 3}%` },
                        { name: '마nce na loot', formula: '+2% za bod', current: `+${value * 2}%` },
                        { name: 'Detekce past칤', formula: '+5% za bod', current: `+${value * 5}%` }
                    ],
                    desc: 'Vn칤m치n칤 ur캜uje pozornost a smysly. Pom치h치 naj칤t lep코칤 loot a kriticky zas치hnout.'
                },
                lck: {
                    title: '맚캩st칤',
                    effects: [
                        { name: 'Kritick칳 z치sah', formula: '+2% za bod', current: `+${value * 2}%` },
                        { name: 'Vz치cn칳 loot', formula: '+3% za bod', current: `+${value * 3}%` },
                        { name: 'N치hodn칠 eventy', formula: '+2% za bod', current: `+${value * 2}%` }
                    ],
                    desc: '맚캩st칤 ovliv켿uje n치hodu ve tv콢j prosp캩ch. V칤ce vz치cn칠ho lootu a lep코칤 eventy.'
                }
            };
            
            const info = attrEffects[attrKey];
            
            showModal(`${attr.icon} ${info.title}`, `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${attr.icon}</div>
                    <h2 style="color: var(--warning-yellow); margin: 0.5rem 0;">${info.title}</h2>
                    <p style="color: #888; font-size: 0.85rem;">${info.desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid var(--warning-yellow);">
                        <div style="font-size: 2.5rem; font-weight: bold; color: var(--warning-yellow);">${value}</div>
                        <div style="color: #888; font-size: 0.8rem;">aktu치ln칤 hodnota</div>
                    </div>
                    
                    <div style="text-align: left; margin-top: 1rem;">
                        <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">游늵 Efekty:</div>
                        ${info.effects.map(e => `
                            <div style="background: #0a0a0a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="color: #ccc;">${e.name}</span>
                                    <span style="color: #666; font-size: 0.75rem; margin-left: 0.5rem;">(${e.formula})</span>
                                </div>
                                <span style="color: var(--toxic-green); font-weight: bold;">${e.current}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${state.char.levelUpPoints > 0 ? `
                        <button class="btn" onclick="closeModal(); levelUpAttr('${attrKey}')" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">
                            拘勇 Zv칳코it na ${value + 1} (m치코 ${state.char.levelUpPoints} bod콢)
                        </button>
                    ` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: ${state.char.levelUpPoints > 0 ? '0.5rem' : '1rem'}; ${state.char.levelUpPoints > 0 ? 'background: #555;' : ''}">${t('ui', 'close')}</button>
            `);
        }
        
        function levelUpAttr(attr) {
            if (state.char.levelUpPoints <= 0) return;
            state.char.attrs[attr]++;
            state.char.levelUpPoints--;
            
            // Update max HP if endurance increased
            if (attr === 'end') {
                state.char.maxHp = 100 + state.char.attrs.end * 5;
                if (state.char.classId === 'survivor') state.char.maxHp += 30;
            }
            
            addLog(`Zv칳코il jsi atribut na ${state.char.attrs[attr]}`, '拘勇');
            renderFull();
        }
        
        function upgradeSkill(skillId) {
            if (state.char.skillPoints <= 0) return;
            
            const skill = SKILLS.find(s => s.id === skillId);
            const currentLevel = state.skills[skillId] || 0;
            if (currentLevel >= skill.maxLevel) return;
            
            state.skills[skillId] = currentLevel + 1;
            state.char.skillPoints--;
            
            // Apply skill effects
            if (skill.type === 'max_health') {
                state.char.maxHealth += skill.value;
            }
            
            notifySuccess('游꿢 Dovednost vylep코ena!', `${skill.icon} ${skill.name}  Lv${state.skills[skillId]}`);
            saveGame(true);
            renderFull();
            showAllSkills(); // Znovu otev콏i panel
        }
        
        function showAllSkills() {
            const skillPoints = state.char.skillPoints || 0;
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem;">游꿢</div>
                    <p style="color: #888;">Investuj body do dovednost칤 pro trval칠 bonusy</p>
                    <div style="background: ${skillPoints > 0 ? 'var(--toxic-dark)' : '#333'}; padding: 0.5rem 1rem; border-radius: 8px; display: inline-block; margin-top: 0.5rem;">
                        <span style="color: ${skillPoints > 0 ? 'var(--toxic-green)' : '#888'}; font-weight: bold;">
                            救 Dostupn칠 body: ${skillPoints}
                        </span>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem; max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.3rem;">
            `;
            
            SKILLS.forEach(skill => {
                const currentLevel = state.skills?.[skill.id] || 0;
                const isMaxed = currentLevel >= skill.maxLevel;
                const canUpgrade = skillPoints > 0 && !isMaxed;
                
                // V칳po캜et bonusu
                const effectDescriptions = {
                    'hunger_efficiency': '%', 'thirst_efficiency': '%', 'energy_efficiency': '%',
                    'loot_chance': '%', 'travel_speed': '%', 'radiation_resistance': '%',
                    'max_health': ' HP', 'xp_bonus': '%', 'loot_quality': '%',
                    'health_regen': ' HP/min', 'repair': '%', 'auto_consume': ''
                };
                const unit = effectDescriptions[skill.type] || '';
                const multiplier = unit === ' HP' || unit === ' HP/min' ? 1 : 100;
                const currentBonus = (skill.value * currentLevel * multiplier).toFixed(0);
                
                html += `
                    <div style="background: linear-gradient(135deg, ${currentLevel > 0 ? '#1a2a1a' : '#1a1a1a'}, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 1px solid ${currentLevel > 0 ? 'var(--toxic-dark)' : '#333'};">
                        <div style="display: flex; align-items: center; gap: 0.6rem;">
                            <div style="font-size: 1.8rem;">${skill.icon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: ${currentLevel > 0 ? 'var(--toxic-green)' : '#fff'};">${skill.name}</span>
                                    <span style="color: ${isMaxed ? '#ffd700' : '#888'}; font-size: 0.85rem;">Lv ${currentLevel}/${skill.maxLevel}</span>
                                </div>
                                <div style="color: #888; font-size: 0.75rem; margin: 0.2rem 0;">${skill.desc}</div>
                                <div style="height: 4px; background: #0a0a0a; border-radius: 2px; overflow: hidden; margin-top: 0.3rem;">
                                    <div style="height: 100%; width: ${(currentLevel / skill.maxLevel) * 100}%; background: ${isMaxed ? '#ffd700' : 'var(--toxic-green)'};"></div>
                                </div>
                                ${currentLevel > 0 ? `<div style="color: var(--toxic-green); font-size: 0.7rem; margin-top: 0.2rem;">Aktu치ln캩: +${currentBonus}${unit}</div>` : ''}
                            </div>
                            ${canUpgrade ? `
                                <button onclick="upgradeSkill('${skill.id}')" style="background: var(--toxic-dark); border: none; color: var(--toxic-green); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    +1
                                </button>
                            ` : isMaxed ? `
                                <span style="color: #ffd700; font-size: 0.8rem;">MAX</span>
                            ` : `
                                <span style="color: #666; font-size: 0.8rem;">游</span>
                            `}
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `;
            
            showModal('游꿢 Dovednosti', html);
        }
        
        // Helper funkce pro renderov치n칤 prodejn칤ch polo쬰k
        function renderSellItems() {
            if (state.inv.length === 0) {
                return '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem치코 co prodat</p>';
            }
            
            let html = '';
            state.inv.forEach(function(item, index) {
                // P콏esko캜 nasazen칠 p콏edm캩ty
                if (isItemEquipped(item)) return;
                
                const itemData = ITEMS.find(function(i) { return i.id === item.id; }) || item;
                const price = itemData.price || item.price;
                if (!price) return;
                
                let sellPrice = Math.floor(price * 0.35);
                
                if (state.char.gender === 'female') {
                    sellPrice = Math.floor(sellPrice * 1.1);
                }
                
                const traderSellBonus = getClassPassiveValue('sellBonus');
                if (traderSellBonus) {
                    sellPrice = Math.floor(sellPrice * (1 + traderSellBonus));
                }
                
                const hasTraderSettler = state.settlement?.settlers?.some(function(s) { return s.type === 'trader_s'; });
                if (hasTraderSettler) {
                    sellPrice = Math.floor(sellPrice * 1.25);
                }
                
                // 游끵勇 Bonus z Tr쬴코t캩 (+20%)
                const bonuses = getBuildingBonuses();
                if (bonuses.tradingBonus > 0) {
                    sellPrice = Math.floor(sellPrice * (1 + bonuses.tradingBonus));
                }
                
                const countText = item.count ? ' (' + item.count + 'x)' : '';
                
                html += '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                html += '<span style="font-size: 1.3rem;">' + item.icon + '</span>';
                html += '<div><div style="font-weight: bold; font-size: 0.85rem;">' + item.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: #ffd700;">游눯 ' + sellPrice + countText + '</div></div></div>';
                html += '<button class="btn" onclick="showSellDialogByIndex(' + index + ')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>';
                html += '</div>';
            });
            
            return html || '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem치코 co prodat</p>';
        }
        
        function renderSellResources() {
            let html = '';
            const entries = Object.entries(state.resources).filter(function(e) { return e[1] > 0; });
            
            entries.forEach(function(entry) {
                const resId = entry[0];
                const amount = entry[1];
                const itemData = ITEMS.find(function(i) { return i.id === resId; });
                if (!itemData || !itemData.price) return;
                
                let sellPrice = Math.floor(itemData.price * 0.35);
                
                const hasTraderSettler = state.settlement?.settlers?.some(function(s) { return s.type === 'trader_s'; });
                if (hasTraderSettler) {
                    sellPrice = Math.floor(sellPrice * 1.25);
                }
                
                // 游끵勇 Bonus z Tr쬴코t캩 (+20%)
                const bonuses = getBuildingBonuses();
                if (bonuses.tradingBonus > 0) {
                    sellPrice = Math.floor(sellPrice * (1 + bonuses.tradingBonus));
                }
                
                html += '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                html += '<span style="font-size: 1.3rem;">' + itemData.icon + '</span>';
                html += '<div><div style="font-weight: bold; font-size: 0.85rem;">' + itemData.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: #ffd700;">游눯 ' + sellPrice + '/ks (' + amount + 'x)</div></div></div>';
                html += '<button class="btn" onclick="showSellResourceDialog(\'' + resId + '\')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>';
                html += '</div>';
            });
            
            return html || '<p style="color: #666; font-size: 0.85rem;">콯치dn칠 suroviny</p>';
        }
        
        // === SYST칄M PEN캨Z OBCHODN칈K콡 ===
        const SHOP_MONEY_LIMITS = {
            default: 2000,      // B캩쬹칳 obchod
            trader_hub: 5000,   // Obchodn칤 centrum
            caravan: 3000,      // Karavana
            pawnshop: 1000      // Zastav치rna
        };
        
        // Z칤sk치 aktu치ln칤 pen칤ze obchodu na lokaci
        function getShopMoney(locationId = null) {
            const loc = locationId || state.world?.currentLocation || 'shelter';
            if (!state.shopMoney) state.shopMoney = {};
            
            const shopData = state.shopMoney[loc];
            const now = Date.now();
            const dayMs = 24 * 60 * 60 * 1000;
            
            // Zjisti typ obchodu a limit
            const location = WORLD_LOCATIONS?.find(l => l.id === loc);
            let limit = SHOP_MONEY_LIMITS.default;
            if (location?.id === 'trader_hub' || location?.specialization === 'trade') {
                limit = SHOP_MONEY_LIMITS.trader_hub;
            }
            
            // Reset ka쬯칳 den
            if (!shopData || (now - shopData.lastReset) > dayMs) {
                state.shopMoney[loc] = { money: limit, lastReset: now, limit: limit };
                return limit;
            }
            
            return shopData.money;
        }
        
        // Sn칤쮂 pen칤ze obchodu
        function reduceShopMoney(amount, locationId = null) {
            const loc = locationId || state.world?.currentLocation || 'shelter';
            if (!state.shopMoney) state.shopMoney = {};
            
            // Zajisti 쬰 existuje z치znam
            getShopMoney(loc);
            
            state.shopMoney[loc].money = Math.max(0, state.shopMoney[loc].money - amount);
            return state.shopMoney[loc].money;
        }
        
        // Z칤sk치 캜as do resetu obchodu
        function getShopResetTime(locationId = null) {
            const loc = locationId || state.world?.currentLocation || 'shelter';
            if (!state.shopMoney?.[loc]) return 0;
            
            const dayMs = 24 * 60 * 60 * 1000;
            const resetTime = state.shopMoney[loc].lastReset + dayMs;
            return Math.max(0, resetTime - Date.now());
        }
        
        function openShop() {
            console.log('游 openShop() called');
            
            try {
                // Filtruj items kter칠 maj칤 cenu a jsou k prodeji
                // VYLOU캛EN칈: set itemy (setId) nejsou v norm치ln칤m obchod캩 - jen loot nebo online tr쬹ice
                const shopItems = ITEMS.filter(item => item.price && item.price > 0 && !item.cantBuy && !item.setId);
                console.log('游 shopItems count:', shopItems.length);
            
            // Rozd캩l na kategorie
            const consumables = shopItems.filter(i => i.type === 'consumable');
            const weapons = shopItems.filter(i => i.type === 'weapon');
            const armors = shopItems.filter(i => i.type === 'armor');
            const tools = shopItems.filter(i => i.type === 'tool');
            const resources = shopItems.filter(i => i.type === 'resource');
            const ammo = shopItems.filter(i => i.type === 'ammo');
            
            const renderShopItem = (item) => {
                const shopItemTexts = {
                    tool: 'N치stroj', resource: 'Surovina', ammoFor: 'Munice pro'
                };
                
                let desc = '';
                if (item.type === 'consumable') {
                    if (item.effect === 'health') desc = '仇벒잺 +' + item.value + ' HP';
                    else if (item.effect === 'hunger') desc = '游꼤 +' + item.value + '%';
                    else if (item.effect === 'thirst') desc = '游눦 +' + item.value + '%';
                    else if (item.effect === 'energy') desc = '丘 +' + item.value + '%';
                    else if (item.effect === 'radiation') desc = '驕뮖잺 ' + item.value;
                } else if (item.type === 'weapon') {
                    desc = '丘덢잺 ' + item.damage + ' DMG';
                    if (item.ammoType) desc += ' | 游댲 ' + getAmmoName(item.ammoType);
                    // P콏idej dal코칤 atributy zbran캩
                    if (item.critChance) desc += ' | 游눤 ' + Math.round(item.critChance * 100) + '% krit';
                    if (item.critMultiplier && item.critMultiplier > 1.5) desc += ' | x' + item.critMultiplier + ' krit DMG';
                    if (item.accuracy) desc += ' | 游꿢 ' + Math.round(item.accuracy * 100) + '%';
                    if (item.range) desc += ' | 游늺 ' + item.range + 'm';
                    if (item.armorPen) desc += ' | 游댬 ' + item.armorPen + ' pr콢raz';
                    if (item.attackSpeed && item.attackSpeed !== 1) desc += ' | 丘 ' + item.attackSpeed + 'x rychlost';
                    if (item.special) desc += ' | 九 ' + item.special;
                } else if (item.type === 'armor') {
                    desc = '游띠勇 ' + item.defense + ' DEF';
                    // P콏idej dal코칤 atributy zbroje
                    if (item.radiation) desc += ' | 驕뮖잺 -' + item.radiation + ' rad';
                    if (item.stealth) desc += ' | 游봉 +' + item.stealth + ' stealth';
                    if (item.speed) desc += ' | 游끢 ' + (item.speed > 0 ? '+' : '') + item.speed + '% rychlost';
                    if (item.hp) desc += ' | 仇벒잺 +' + item.hp + ' HP';
                    if (item.special) desc += ' | 九 ' + item.special;
                } else if (item.type === 'tool') {
                    desc = '游댢 ' + shopItemTexts.tool;
                    if (item.bonus) desc += ' | 九 ' + item.bonus;
                } else if (item.type === 'resource') {
                    desc = '游닍 ' + shopItemTexts.resource;
                } else if (item.type === 'ammo') {
                    desc = '游댲 ' + shopItemTexts.ammoFor + ' ' + getAmmoName(item.ammoType);
                }
                
                // Pou쬴j jednotnou funkci pro v칳po캜et ceny
                const originalPrice = item.price;
                const displayPrice = calculateItemPrice(originalPrice);
                
                const canAfford = getMoney() >= displayPrice;
                const hasDiscount = displayPrice < originalPrice;
                
                let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                html += '<span style="font-size: 1.5rem;">' + item.icon + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + getItemName(item.id) + '</div>';
                html += '<div style="font-size: 0.75rem; color: #8bc34a;">' + desc + '</div>';
                html += '<div style="font-size: 0.85rem; color: #ffd700;">游눯 ' + displayPrice;
                if (hasDiscount) {
                    html += ' <span style="color: #999; text-decoration: line-through; font-size: 0.75rem;">' + originalPrice + '</span>';
                }
                html += '</div></div></div>';
                html += '<button class="btn" onclick="showBuyDialog(\'' + item.id + '\')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;';
                if (!canAfford) html += ' opacity: 0.5; pointer-events: none;';
                html += '">' + ('Koupit') + '</button>';
                html += '</div>';
                return html;
            };
            
            const traderQuote = getRandomHumor('trader');
            
            const shopTexts = {
                title: 'Obchod', discount: 'Sleva od obchodn칤ka', buy: 'Koupit', sell: 'Prodat',
                consumables: 'Spot콏ebn칤', weapons: 'Zbran캩', ammo: 'Munice',
                armors: 'Zbroje', tools: 'N치stroje', resources: 'Suroviny',
                items: 'P콏edm캩ty', closeShop: 'Zav콏칤t obchod', tool: 'N치stroj', resource: 'Surovina',
                ammoFor: 'Munice pro'
            };
            
            // Zjisti jestli m치 hr치캜 slevu od karavany
            const merchantDiscount = (state.caravan?.active && Date.now() < state.caravan?.until) || 
                                     (state.settlement?.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until) ? 0.2 : 0;
            
            // Pen칤ze obchodu
            const currentShopMoney = getShopMoney();
            const shopLimit = state.shopMoney?.[state.world?.currentLocation]?.limit || SHOP_MONEY_LIMITS.default;
            const shopMoneyPercent = Math.round((currentShopMoney / shopLimit) * 100);
            const shopMoneyColor = shopMoneyPercent > 50 ? '#4caf50' : shopMoneyPercent > 20 ? '#ff9800' : '#f44336';
            
            document.getElementById('modalContent').innerHTML = `
                <h2>游낅 ${shopTexts.title}</h2>
                <p style="color: #888; font-style: italic; text-align: center; margin-bottom: 0.5rem; font-size: 0.85rem;">"${traderQuote}"</p>
                ${merchantDiscount > 0 ? '<p style="background: var(--warning-yellow); color: #000; padding: 0.5rem; border-radius: 5px; text-align: center; margin-bottom: 1rem;">游냙 ' + shopTexts.discount + ': -20%!</p>' : ''}
                <p style="text-align: center; font-size: 1.1rem; margin-bottom: 0.5rem;">
                    <strong>游눯 ${getMoney()}</strong> | <strong>游꿞 ${getCasinoTokens()}</strong>
                </p>
                
                <!-- Pen칤ze obchodn칤ka -->
                <div style="background: #1a1a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                        <span style="color: #888;">游낁 Obchodn칤k m치:</span>
                        <span style="color: ${shopMoneyColor}; font-weight: bold;">${currentShopMoney.toLocaleString()} / ${shopLimit.toLocaleString()} 游눯</span>
                    </div>
                    <div style="background: #333; height: 6px; border-radius: 3px; margin-top: 0.3rem; overflow: hidden;">
                        <div style="height: 100%; width: ${shopMoneyPercent}%; background: ${shopMoneyColor}; transition: width 0.3s;"></div>
                    </div>
                    <p style="color: #666; font-size: 0.7rem; margin: 0.2rem 0 0 0; text-align: right;">Obnovuje se denn캩</p>
                </div>
                
                <!-- Taby pro Koupit/Prodat -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button id="shopTabBuy" class="btn" onclick="switchShopTab('buy')" style="flex: 1; background: #2e7d32;">游 ${shopTexts.buy}</button>
                    <button id="shopTabSell" class="btn" onclick="switchShopTab('sell')" style="flex: 1; background: #555;">游눯 ${shopTexts.sell}</button>
                </div>
                
                <!-- Koupit sekce -->
                <div id="shopBuySection">
                    <!-- Filtry -->
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.5rem;">
                        <button class="btn shop-filter active" onclick="filterShop('all')" data-filter="all" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #4caf50;">V코e</button>
                        <button class="btn shop-filter" onclick="filterShop('consumable')" data-filter="consumable" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游꼤</button>
                        <button class="btn shop-filter" onclick="filterShop('weapon')" data-filter="weapon" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">丘덢잺</button>
                        <button class="btn shop-filter" onclick="filterShop('ammo')" data-filter="ammo" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游댲</button>
                        <button class="btn shop-filter" onclick="filterShop('armor')" data-filter="armor" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游띠勇</button>
                        <button class="btn shop-filter" onclick="filterShop('tool')" data-filter="tool" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游댢</button>
                        <button class="btn shop-filter" onclick="filterShop('resource')" data-filter="resource" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">游닍</button>
                    </div>
                    
                    <div id="shopItemsList" style="max-height: 45vh; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;">
                        <div class="shop-category" data-type="consumable">
                            ${consumables.length > 0 ? `
                                <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">游꼤 ${shopTexts.consumables} (${consumables.length})</h4>
                                ${consumables.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="weapon">
                            ${weapons.length > 0 ? `
                                <h4 style="color: #c62828; font-size: 0.85rem; margin: 0.5rem 0;">丘덢잺 ${shopTexts.weapons} (${weapons.length})</h4>
                                ${weapons.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="ammo">
                            ${ammo.length > 0 ? `
                                <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">游댲 ${shopTexts.ammo} (${ammo.length})</h4>
                                ${ammo.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="armor">
                            ${armors.length > 0 ? `
                                <h4 style="color: #2196f3; font-size: 0.85rem; margin: 0.5rem 0;">游띠勇 ${shopTexts.armors} (${armors.length})</h4>
                                ${armors.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="tool">
                            ${tools.length > 0 ? `
                                <h4 style="color: #9c27b0; font-size: 0.85rem; margin: 0.5rem 0;">游댢 ${shopTexts.tools} (${tools.length})</h4>
                                ${tools.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="resource">
                            ${resources.length > 0 ? `
                                <h4 style="color: #8bc34a; font-size: 0.85rem; margin: 0.5rem 0;">游닍 ${shopTexts.resources} (${resources.length})</h4>
                                ${resources.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Prodat sekce -->
                <div id="shopSellSection" style="max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; display: none;">
                    <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">游닍 ${shopTexts.items}</h4>
                    ${renderSellItems()}
                    
                    <h4 style="color: #8bc34a; font-size: 0.85rem; margin: 0.8rem 0 0.3rem 0;">游닍 ${shopTexts.resources}</h4>
                    ${renderSellResources()}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${shopTexts.closeShop}</button>
            `;
            console.log('游 openShop() setting modal content done');
            document.getElementById('modal').classList.add('show');
            console.log('游 openShop() modal shown');
            } catch (error) {
                console.error('游 openShop() ERROR:', error);
                showModal('仇 Chyba', 'Nepoda콏ilo se otev콏칤t obchod: ' + error.message);
            }
        }
        
        function switchShopTab(tab) {
            const buySection = document.getElementById('shopBuySection');
            const sellSection = document.getElementById('shopSellSection');
            const buyTab = document.getElementById('shopTabBuy');
            const sellTab = document.getElementById('shopTabSell');
            
            if (tab === 'buy') {
                buySection.style.display = 'block';
                sellSection.style.display = 'none';
                buyTab.style.background = '#2e7d32';
                sellTab.style.background = '#555';
            } else {
                buySection.style.display = 'none';
                sellSection.style.display = 'block';
                buyTab.style.background = '#555';
                sellTab.style.background = '#d4722e';
            }
        }
        
        function filterShop(type) {
            // Aktualizuj aktivn칤 tla캜칤tko
            document.querySelectorAll('.shop-filter').forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.style.background = '#4caf50';
                    btn.classList.add('active');
                } else {
                    btn.style.background = '#333';
                    btn.classList.remove('active');
                }
            });
            
            // Filtruj kategorie
            document.querySelectorAll('.shop-category').forEach(cat => {
                if (type === 'all' || cat.dataset.type === type) {
                    cat.style.display = 'block';
                } else {
                    cat.style.display = 'none';
                }
            });
        }
        
        function buyItem(itemId, amount = 1) {
            const itemData = ITEMS.find(i => i.id === itemId);
            if (!itemData) {
                console.error('buyItem: Item not found:', itemId);
                return;
            }
            
            // Kontrola unique item콢 (spac치k, kompas, atd.)
            if (itemData.unique) {
                const alreadyHas = state.inv.some(i => i.id === itemId);
                if (alreadyHas) {
                    notifyWarning('U m치코 ' + itemData.name, 'M콢쬰코 m칤t pouze jeden');
                    return;
                }
            }
            
            // Kontrola v치hy P콎ED n치kupem
            const itemWeight = (itemData.weight || 0) * amount;
            if (state.carryWeight + itemWeight > state.maxCarryWeight) {
                notifyWarning('P콏칤li코 t캩쬶칠!', ('Neunese코 ') + amount + 'x ' + itemData.name);
                SoundSystem.play('error');
                return;
            }
            
            // Pou쬴j jednotnou funkci pro v칳po캜et ceny
            const price = calculateItemPrice(itemData.price);
            
            // === TRADER CLASS BONUS: +10% 코ance na rare ===
            if (state.char.classId === 'trader' && Math.random() < 0.10) {
                // Bonus item!
                const bonusItems = ['medkit', 'stimpack', 'radx', 'ammo_9mm', 'ammo_shell'];
                const bonusId = bonusItems[Math.floor(Math.random() * bonusItems.length)];
                const bonusItem = ITEMS.find(i => i.id === bonusId);
                if (bonusItem) {
                    addItemToInventory(bonusItem, 1, true);
                    notifySuccess('游눯 Obchodn칤 instinkt!', 'Dostal jsi bonus: ' + bonusItem.name);
                }
            }
            
            const totalPrice = price * amount;
            const currentMoney = getMoney();
            
            if (currentMoney < totalPrice) {
                notifyWarning('Nedostatek pen캩z!', 'Pot콏ebuje코 ' + totalPrice + ' 游눯');
                return;
            }
            
            if (!removeMoney(totalPrice)) {
                console.error('buyItem: Could not remove money');
                return;
            }
            
            // P콏id치n칤 do invent치콏e
            if (itemData.type === 'resource') {
                state.resources[itemId] = (state.resources[itemId] || 0) + amount;
            } else if (itemData.type === 'ammo') {
                // Ammo se p콏id치v치 v mno쬽tv칤 kter칠 hr치캜 koupil
                addAmmo(itemData.ammoType, amount);
                notifySuccess('Zakoupeno!', itemData.name + ' x' + amount);
                updateCarryWeight();
                changeReputation('traders', 1, 'n치kup');
                openShop();
                return;
            } else {
                // Pro v코echny ostatn칤 typy - stackovateln칠 i ne
                const existing = state.inv.find(i => i.id === itemId && i.fromShop);
                if (existing && (itemData.stackable || itemData.type === 'consumable')) {
                    existing.count = (existing.count || 1) + amount;
                } else {
                    // Pro nestackovateln칠 itemy p콏idej ka쬯칳 zvl치코콘
                    for (let i = 0; i < amount; i++) {
                        const newItem = {
                            ...itemData,
                            count: 1,
                            fromShop: true, // Anti-exploit flag
                            boughtPrice: price,
                            durability: itemData.type === 'weapon' || itemData.type === 'armor' || itemData.type === 'gloves' || itemData.type === 'boots' ? 100 : undefined,
                            maxDurability: itemData.type === 'weapon' || itemData.type === 'armor' || itemData.type === 'gloves' || itemData.type === 'boots' ? 100 : undefined
                        };
                        state.inv.push(newItem);
                    }
                }
            }
            
            console.log('buyItem: Added', amount + 'x', itemData.name, 'to inventory');
            notifySuccess('Zakoupeno!', itemData.name + (amount > 1 ? ' x' + amount : ''));
            updateCarryWeight();
            saveGame(); // Ulo ihned
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + amount;
                checkDailyQuests();
            }
            
            // Mal치 zm캩na reputace s obchodn칤ky p콏i obchodov치n칤
            if (totalPrice >= 50 && Math.random() < 0.3) {
                changeReputation('traders', 1, 'obchodov치n칤');
            }
            
            renderFull(); // Aktualizuj cel칠 UI v캜etn캩 invent치콏e
            openShop(); // Refresh shop
        }
        
        // Modal pro v칳b캩r mno쬽tv칤 p콏i n치kupu
        function showBuyDialog(itemId) {
            const itemData = ITEMS.find(i => i.id === itemId);
            if (!itemData) return;
            
            // Pou쬴j jednotnou funkci pro v칳po캜et ceny
            const price = calculateItemPrice(itemData.price);
            
            const maxBuyMoney = Math.floor(getMoney() / price);
            
            // Limit podle v치hy
            const itemWeight = itemData.weight || 0;
            const freeWeight = state.maxCarryWeight - state.carryWeight;
            const maxBuyWeight = itemWeight > 0 ? Math.floor(freeWeight / itemWeight) : 999;
            
            const maxBuy = Math.min(maxBuyMoney, maxBuyWeight);
            
            if (maxBuyMoney <= 0) {
                notifyWarning('Nedostatek pen캩z!', 'Pot콏ebuje코 alespo켿 ' + price + ' 游눯');
                return;
            }
            
            if (maxBuyWeight <= 0) {
                notifyWarning(t('notifications', 'inventoryFull'), ('Neunese코 ') + itemData.name);
                return;
            }
            
            // Pokud lze koupit jen 1, rovnou kup
            if (maxBuy === 1) {
                buyItem(itemId, 1);
                return;
            }
            
            window.currentBuyItem = itemId;
            window.currentBuyPrice = price;
            window.currentBuyMax = maxBuy;
            window.currentBuyAmount = 1;
            
            updateBuyDialog();
        }
        
        function updateBuyDialog() {
            const itemData = ITEMS.find(i => i.id === window.currentBuyItem);
            const amount = window.currentBuyAmount;
            const total = window.currentBuyPrice * amount;
            const totalWeight = (itemData.weight || 0) * amount;
            const freeWeight = state.maxCarryWeight - state.carryWeight;
            
            showModal(('游 Koupit ') + itemData.icon + ' ' + itemData.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena: ' + window.currentBuyPrice + ' 游눯 | V치ha: ' + (itemData.weight || 0) + 'kg</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeBuyAmount(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeBuyAmount(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeBuyAmount(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeBuyAmount(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<p style="color: #ffd700; font-size: 1.2rem; margin: 0.5rem 0;">Celkem: ' + total + ' 游눯</p>' +
                    '<p style="color: ' + (totalWeight > freeWeight ? '#f44336' : '#888') + '; font-size: 0.85rem;">V치ha: ' + totalWeight.toFixed(1) + 'kg / Volno: ' + freeWeight.toFixed(1) + 'kg</p>' +
                    '<p style="color: #888; font-size: 0.8rem;">Max: ' + window.currentBuyMax + ' ks | M치코: ' + getMoney() + ' 游눯</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="buyItem(window.currentBuyItem, window.currentBuyAmount); closeModal();" style="background: #2e7d32;">九 Koupit</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">九 Zru코it</button>' +
                '</div>'
            );
        }
        
        function changeBuyAmount(delta) {
            window.currentBuyAmount = Math.max(1, Math.min(window.currentBuyMax, window.currentBuyAmount + delta));
            updateBuyDialog();
        }
        
        function sellItem(itemId, amount = 1) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) {
                console.error('sellItem: Item not found in inventory:', itemId);
                return;
            }
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === itemId) || item;
            
            // Quest itemy nelze prodat
            if (item.cantSell || item.type === 'quest') {
                notifyWarning('Nelze prodat', 'Tento p콏edm캩t je pot콏ebn칳 pro quest a nelze ho prodat!');
                return;
            }
            
            // Vycraft캩n칠 p콏edm캩ty nelze prodat obchodn칤k콢m
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoru캜n캩 vyroben칠 v캩ci obchodn칤ci neberou. Zkus online tr쬴코t캩!');
                return;
            }
            
            // V캩ci koupen칠 od karavany nelze prodat obchodn칤k콢m (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od karavany nelze prodat. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            // V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            if (!itemData.price) {
                notifyWarning('Nelze prodat', 'Tento p콏edm캩t nem치 hodnotu');
                return;
            }
            
            let sellPrice = Math.floor(itemData.price * 0.35); // Sn칤쬰no na 35% - crafting se mus칤 vyplatit!
            
            // Apply gender bonus (female gets 10% better selling prices)
            if (state.char.gender === 'female') {
                sellPrice = Math.floor(sellPrice * 1.1);
            }
            
            // Bonus od obchodn칤ka v osad캩
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) {
                sellPrice = Math.floor(sellPrice * 1.25);
            }
            
            const totalPrice = sellPrice * amount;
            
            // === KONTROLA PEN캨Z OBCHODU ===
            const shopMoney = getShopMoney();
            if (shopMoney < totalPrice) {
                if (shopMoney <= 0) {
                    const resetTime = getShopResetTime();
                    const hours = Math.floor(resetTime / 3600000);
                    const mins = Math.floor((resetTime % 3600000) / 60000);
                    notifyWarning('Obchodn칤k nem치 pen칤ze!', `Dnes u vy캜erpal z치sobu. Reset za ${hours}h ${mins}m`);
                    return;
                }
                // M콢쬰 prodat jen 캜치st
                const maxCanSell = Math.floor(shopMoney / sellPrice);
                if (maxCanSell < 1) {
                    notifyWarning('Obchodn칤k nem치 dost', `M치 jen ${shopMoney} 游눯, pot콏ebuje ${totalPrice} 游눯`);
                    return;
                }
                // Upozorni a prodej jen co jde
                notifyWarning('Omezen칳 v칳kup', `Obchodn칤k m치 jen na ${maxCanSell}x. Zkus prodat m칠n캩.`);
                return;
            }
            
            // Ode캜ti z pen캩z obchodu
            reduceShopMoney(totalPrice);
            
            addMoney(totalPrice);
            state.stats.itemsSold = (state.stats.itemsSold || 0) + amount;
            
            // Odebr치n칤 z invent치콏e
            if (item.count && item.count > amount) {
                item.count -= amount;
            } else if (item.count && item.count === amount) {
                state.inv.splice(itemIndex, 1);
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            console.log('sellItem: Sold', amount + 'x', item.name, 'for', playerReceives, '(tax:', totalPrice - playerReceives, ')');
            notifySuccess('Prod치no!', item.name + (amount > 1 ? ' x' + amount : '') + ' +' + playerReceives + ' 游눯');
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + amount;
                checkDailyQuests();
            }
            
            updateCarryWeight();
            openShop(); // Refresh shop
            switchShopTab('sell'); // Z콢sta켿 na prodejn칤m tabu
        }
        
        // Modal pro v칳b캩r mno쬽tv칤 p콏i prodeji
        function showSellDialog(itemId) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;
            showSellDialogByIndex(itemIndex);
        }
        
        // Prodej podle indexu v invent치콏i - 콏e코칤 probl칠m s duplicitn칤mi ID (nap콏. den칤ky)
        function showSellDialogByIndex(itemIndex) {
            if (itemIndex < 0 || itemIndex >= state.inv.length) return;
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const maxSell = item.count || 1;
            
            if (!itemData.price && !item.price) {
                notifyWarning('Nelze prodat', 'Tento p콏edm캩t nem치 hodnotu');
                return;
            }
            
            // Pokud m치코 jen 1, rovnou prodej
            if (maxSell === 1) {
                sellItemByIndex(itemIndex, 1);
                return;
            }
            
            let sellPrice = Math.floor((itemData.price || item.price) * 0.35);
            if (state.char.gender === 'female') sellPrice = Math.floor(sellPrice * 1.1);
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) sellPrice = Math.floor(sellPrice * 1.25);
            
            window.currentSellIndex = itemIndex;
            window.currentSellPrice = sellPrice;
            window.currentSellMax = maxSell;
            window.currentSellAmount = 1;
            
            updateSellDialogByIndex();
        }
        
        function updateSellDialogByIndex() {
            const item = state.inv[window.currentSellIndex];
            if (!item) return;
            
            const amount = window.currentSellAmount;
            const total = window.currentSellPrice * amount;
            
            showModal(('游눯 Prodat ') + item.icon + ' ' + item.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena za kus: ' + window.currentSellPrice + ' 游눯</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeSellAmountByIndex(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeSellAmountByIndex(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeSellAmountByIndex(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeSellAmountByIndex(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<div style="display: flex; justify-content: center; gap: 0.5rem; margin: 0.5rem 0;">' +
                        '<button class="btn" onclick="window.currentSellAmount = window.currentSellMax; updateSellDialogByIndex();" style="padding: 0.3rem 0.8rem; background: #666; font-size: 0.8rem;">V코e (' + window.currentSellMax + ')</button>' +
                    '</div>' +
                    '<p style="color: #4caf50; font-size: 1.2rem; margin: 1rem 0;">Z칤sk치코: +' + total + ' 游눯</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">M치코: ' + window.currentSellMax + ' ks</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="sellItemByIndex(window.currentSellIndex, window.currentSellAmount);" style="background: #d4722e;">九 Prodat</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">九 Zru코it</button>' +
                '</div>'
            );
        }
        
        function changeSellAmountByIndex(delta) {
            window.currentSellAmount = Math.max(1, Math.min(window.currentSellMax, window.currentSellAmount + delta));
            updateSellDialogByIndex();
        }
        
        // Prodej podle indexu - spr치vn캩 prod치 konkr칠tn칤 item i kdy maj칤 stejn치 ID
        function sellItemByIndex(itemIndex, amount = 1) {
            if (itemIndex < 0 || itemIndex >= state.inv.length) {
                console.error('sellItemByIndex: Invalid index:', itemIndex);
                return;
            }
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            
            // Quest itemy nelze prodat
            if (item.cantSell || item.type === 'quest') {
                notifyWarning('Nelze prodat', 'Tento p콏edm캩t je pot콏ebn칳 pro quest a nelze ho prodat!');
                return;
            }
            
            // Vycraft캩n칠 p콏edm캩ty nelze prodat obchodn칤k콢m
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoru캜n캩 vyroben칠 v캩ci obchodn칤ci neberou. Zkus online tr쬴코t캩!');
                return;
            }
            
            // V캩ci koupen칠 od karavany nelze prodat obchodn칤k콢m (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od karavany nelze prodat. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            // V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            const price = itemData.price || item.price;
            if (!price) {
                notifyWarning('Nelze prodat', 'Tento p콏edm캩t nem치 hodnotu');
                return;
            }
            
            let sellPrice = Math.floor(price * 0.35);
            
            // Apply gender bonus (female gets 10% better selling prices)
            if (state.char.gender === 'female') {
                sellPrice = Math.floor(sellPrice * 1.1);
            }
            
            // Bonus od obchodn칤ka v osad캩
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) {
                sellPrice = Math.floor(sellPrice * 1.25);
            }
            
            // Trader set (3) - barterImproved +75% prodejn칤 cena (m칤sto 50%)
            const setEffectsSell = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            if (setEffectsSell.barterImproved) {
                sellPrice = Math.floor(price * 0.75); // 75% m칤sto 35%
            } else if (state.char.classId === 'trader') {
                sellPrice = Math.floor(price * 0.50); // Trader class base 50%
            }
            
            const totalPrice = sellPrice * amount;
            
            // === KONTROLA PEN캨Z OBCHODU ===
            const shopMoney = getShopMoney();
            if (shopMoney < totalPrice) {
                if (shopMoney <= 0) {
                    const resetTime = getShopResetTime();
                    const hours = Math.floor(resetTime / 3600000);
                    const mins = Math.floor((resetTime % 3600000) / 60000);
                    notifyWarning('Obchodn칤k nem치 pen칤ze!', `Dnes u vy캜erpal z치sobu. Reset za ${hours}h ${mins}m`);
                    return;
                }
                const maxCanSell = Math.floor(shopMoney / sellPrice);
                notifyWarning('Omezen칳 v칳kup', `Obchodn칤k m치 jen na ${maxCanSell}x. Zkus prodat m칠n캩.`);
                return;
            }
            
            // Ode캜ti z pen캩z obchodu
            reduceShopMoney(totalPrice);
            
            addMoney(totalPrice);
            state.stats.itemsSold = (state.stats.itemsSold || 0) + amount;
            
            // Odebr치n칤 z invent치콏e
            if (item.count && item.count > amount) {
                item.count -= amount;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            console.log('sellItemByIndex: Sold', amount + 'x', item.name, 'for', totalPrice);
            notifySuccess('Prod치no!', item.name + (amount > 1 ? ' x' + amount : '') + ' +' + totalPrice + ' 游눯');
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + amount;
                checkDailyQuests();
            }
            
            updateCarryWeight();
            openShop(); // Refresh shop
            switchShopTab('sell'); // Z콢sta켿 na prodejn칤m tabu
        }

        function updateSellDialog() {
            const item = state.inv.find(i => i.id === window.currentSellItem);
            const amount = window.currentSellAmount;
            const total = window.currentSellPrice * amount;
            
            showModal(('游눯 Prodat ') + item.icon + ' ' + item.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena za kus: ' + window.currentSellPrice + ' 游눯</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeSellAmount(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeSellAmount(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeSellAmount(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeSellAmount(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<div style="display: flex; justify-content: center; gap: 0.5rem; margin: 0.5rem 0;">' +
                        '<button class="btn" onclick="window.currentSellAmount = window.currentSellMax; updateSellDialog();" style="padding: 0.3rem 0.8rem; background: #666; font-size: 0.8rem;">V코e (' + window.currentSellMax + ')</button>' +
                    '</div>' +
                    '<p style="color: #4caf50; font-size: 1.2rem; margin: 1rem 0;">Z칤sk치코: +' + total + ' 游눯</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">M치코: ' + window.currentSellMax + ' ks</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="sellItem(window.currentSellItem, window.currentSellAmount);" style="background: #d4722e;">九 Prodat</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">九 Zru코it</button>' +
                '</div>'
            );
        }
        
        function changeSellAmount(delta) {
            window.currentSellAmount = Math.max(1, Math.min(window.currentSellMax, window.currentSellAmount + delta));
            updateSellDialog();
        }
        
        function sellResource(resId, amount = 1) {
            if (!state.resources[resId] || state.resources[resId] <= 0) return;
            
            const itemData = ITEMS.find(i => i.id === resId);
            if (!itemData || !itemData.price) return;
            
            // Omez na dostupn칠 mno쬽tv칤
            amount = Math.min(amount, state.resources[resId]);
            
            let sellPrice = Math.floor(itemData.price * 0.35);
            
            // Bonus od obchodn칤ka v osad캩
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) {
                sellPrice = Math.floor(sellPrice * 1.25);
            }
            
            const totalPrice = sellPrice * amount;
            addMoney(totalPrice);
            state.resources[resId] -= amount;
            
            notifySuccess('Prod치no!', itemData.name + (amount > 1 ? ' x' + amount : '') + ' +' + totalPrice + ' 游눯');
            openShop(); // Refresh shop
        }
        
        // Dialog pro prodej surovin
        function showSellResourceDialog(resId) {
            const itemData = ITEMS.find(i => i.id === resId);
            if (!itemData || !state.resources[resId]) return;
            
            const maxSell = state.resources[resId];
            
            // Pokud m치코 jen 1, rovnou prodej
            if (maxSell === 1) {
                sellResource(resId, 1);
                return;
            }
            
            let sellPrice = Math.floor(itemData.price * 0.35);
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) sellPrice = Math.floor(sellPrice * 1.25);
            
            window.currentSellResId = resId;
            window.currentSellResPrice = sellPrice;
            window.currentSellResMax = maxSell;
            window.currentSellResAmount = 1;
            
            updateSellResourceDialog();
        }
        
        function updateSellResourceDialog() {
            const itemData = ITEMS.find(i => i.id === window.currentSellResId);
            const amount = window.currentSellResAmount;
            const total = window.currentSellResPrice * amount;
            
            showModal(('游눯 Prodat ') + itemData.icon + ' ' + itemData.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena za kus: ' + window.currentSellResPrice + ' 游눯</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeSellResAmount(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeSellResAmount(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeSellResAmount(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeSellResAmount(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<div style="display: flex; justify-content: center; gap: 0.5rem; margin: 0.5rem 0;">' +
                        '<button class="btn" onclick="window.currentSellResAmount = window.currentSellResMax; updateSellResourceDialog();" style="padding: 0.3rem 0.8rem; background: #666; font-size: 0.8rem;">V코e (' + window.currentSellResMax + ')</button>' +
                    '</div>' +
                    '<p style="color: #4caf50; font-size: 1.2rem; margin: 1rem 0;">Z칤sk치코: +' + total + ' 游눯</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">M치코: ' + window.currentSellResMax + ' ks</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="sellResource(window.currentSellResId, window.currentSellResAmount); closeModal();" style="background: #d4722e;">九 Prodat</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">九 Zru코it</button>' +
                '</div>'
            );
        }
        
        function changeSellResAmount(delta) {
            window.currentSellResAmount = Math.max(1, Math.min(window.currentSellResMax, window.currentSellResAmount + delta));
            updateSellResourceDialog();
        }
        
        function startSleeping() {
            closeModal();
            
            const now = Date.now();
            state.lastSleepTime = now;
            state.sleepEndTime = now + (60 * 60 * 1000); // 1 hour
            state.isSleeping = true;
            
            addLog('Usnul jsi ve spac치ku (1 hodina)', '游눣');
            renderFull();
        }
        
        // Sp치nek v 칰krytu (bez spot콏eby j칤dla a 쮂셬n캩)
        function startSleep() {
            // Kontrola, 쬰 jsme v 칰krytu
            if (!state.map?.inBase && state.world?.currentLocation !== 'shelter') {
                notifyWarning('Zde nelze sp치t', 'Mus칤코 b칳t v 칰krytu');
                return;
            }
            
            // Kontrola cooldownu (20 minut)
            const lastSleep = state.lastShelterSleep || 0;
            const cooldownMs = 20 * 60 * 1000; // 20 minut
            const timeSinceSleep = Date.now() - lastSleep;
            
            if (timeSinceSleep < cooldownMs) {
                const remaining = Math.ceil((cooldownMs - timeSinceSleep) / 60000);
                showModal('游땺 Je코t캩 nem치코 칰navu', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游띒勇</div>
                        <p style="color: #ff9800;">Nen칤 ti do span칤 - odpo캜칤val jsi p콏ed chv칤l칤.</p>
                        <p style="color: #888; margin-top: 0.5rem;">Dal코칤 sp치nek za: <strong style="color: #4caf50;">${remaining} minut</strong></p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            showModal('游띒勇 Sp치nek', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">游띒勇</div>
                    <p style="color: #aaa; margin-bottom: 1rem;">${'Spi v 칰krytu a obnov energii a zdrav칤.'}</p>
                    
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: left;">
                        <div style="color: #8bc34a; margin-bottom: 0.5rem;">九 ${'V칳hody:'}</div>
                        <div style="color: #aaa; font-size: 0.9rem;">
                             丘 ${'Pln치 obnova energie'}<br>
                             仇벒잺 ${'Regenerace HP (+50%)'}<br>
                             游띠勇 ${'Bez ztr치ty hladu/쮂셬n캩'}<br>
                             낋 ${'Cooldown: 20 minut'}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">仇 ${'Zru코it'}</button>
                        <button class="btn" onclick="doShelterSleep()" style="background: #3949AB;">游눣 ${'Sp치t'}</button>
                    </div>
                </div>
            `);
        }
        
        function doShelterSleep() {
            closeModal();
            
            // Nastav cooldown
            state.lastShelterSleep = Date.now();
            
            // Obnov energii na maximum
            state.status.energy = 100;
            
            // Regenerace HP (50% maxHP)
            const healAmount = Math.floor(state.char.maxHp * 0.5);
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
            
            // Daily quest progress - healing
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.healed = (state.dailyQuests.progress.healed || 0) + healAmount;
                checkDailyQuests();
            }
            
            addLog('Dob콏e ses vyspal v 칰krytu. Energie obnovena!', '游눣');
            notifySuccess('Odpo캜at칳!', `丘 100% | 仇벒잺 +${healAmount} HP`);
            
            saveGame();
            renderFull();
        }
        
        // Inventory filter (visual only - re-renders with filter)
        window.inventoryFilter = 'all';
        function filterInventory(type) {
            window.inventoryFilter = type;
            // Mus칤me znovu vykreslit cel칳 invent치콏
            if (state.activeTab === 'inv') {
                renderGame();
            }
        }
        
        // === MO콯NOSTI PRO ZBRAN캨 ===
        function showWeaponOptions(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            showWeaponOptionsByIndex(state.inv.indexOf(item));
        }
        
        function showWeaponOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.weapon === item;
            const durabilityPct = item.durability !== undefined ? Math.round((item.durability / item.maxDurability) * 100) : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            // V칳po캜et ceny opravy
            const repairCost = item.durability !== undefined ? Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100) : 0;
            const canRepair = item.durability !== undefined && item.durability < item.maxDurability && state.money >= repairCost;
            const needsRepair = item.durability !== undefined && item.durability < item.maxDurability;
            
            // Easter egg special effects descriptions
            const specialDescriptions = {
                'poison': '驕멆잺 Otravuje nep콏칤tele',
                'bleed': '游뽖 Zp콢sobuje krv치cen칤',
                'stun': '丘 Omr치캜칤 nep콏칤tele',
                'fire': '游댠 Zapaluje nep콏칤tele',
                'block': '游띠勇 +15% 코ance na blok',
                'block_bonus': '游띠勇 +10% 코ance na blok',
                'dodge_bonus': '游눧 +10% 코ance na 칰hyb',
                'powered': '丘 +5 obrana, +5 damage',
                'stealth': '游봉 -50% 코ance na p콏epaden칤, +15% dodge',
                'berserker': '游놏 +30% damage, -3 obrana',
                'phoenix': '游댠 Jednou za boj: p콏e쬴je코 smrteln칳 z치sah s 30% HP',
                'titan': '游 +5 obrana, imunita na krit',
                'scout': '游끢 +15% dodge',
                'medic': '游낀 +50% efektivita l칠캜en칤',
                'mutant': '游빏 +50% odolnost v콢캜i radiaci a jed콢m',
                'exo': '游 +50% nosnost, +10% damage',
                'nano': '游댧 +2 HP regenerace ka쬯칠 kolo',
                'intimidate': '游 +2 damage',
                'scavenger': '游 +25% bonus loot',
                'camo': '游 -30% 코ance na n치hodn칠 souboje',
                'nightvision': '游깿 +15% damage v noci',
                'agile': '游끢 +10% dodge',
                'rad_resist': '驕뮖잺 -30% radiace',
                'rad_immune': '驕뮖잺 -50% radiace',
                'night_vision': '游녜勇 No캜n칤 vid캩n칤',
                'fireproof': '游댠 Imunita na ohe켿',
                'insulated': '丘 Imunita na elekt콏inu',
                'warm': '仇勇 -30% ztr치ta energie p콏i cestov치n칤',
                'endurance': '游끢 -30% ztr치ta energie p콏i cestov치n칤',
                'flash_protect': '游눠 Ochrana p콏ed oslepen칤m',
                'sturdy': '游붯 +5% stabilita',
                // Easter egg zbran캩
                'freeman': '游댰 Lambda Core: +25% kritick칳 z치sah',
                'silver': '游깿 St콏칤brn칠 ost콏칤: +100% damage proti p콏칤코er치m',
                'silverhand': '游뱆 Rockerboy: Pr콢razn칠 n치boje ignoruj칤 zbroj',
                'devastation': '游 Devastace: Masivn칤 plo코n칠 po코kozen칤',
                'evil_bane': '九 Zhouba zla: +200% damage proti boss콢m'
            };
            
            const specialText = item.special ? (specialDescriptions[item.special] || `救 ${item.special}`) : '';
            
            // Info o munici
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const ammoType = item.ammoType || itemData.ammoType;
            let ammoInfo = '';
            if (ammoType) {
                const ammoNames = {
                    '9mm': '游댲 9mm n치boje',
                    '556': '游댰 5.56 n치boje',
                    '762': '游댱 7.62 n치boje',
                    'shell': '游댮 Brokov칠 n치boje',
                    'arrow': '俱 먞셣y',
                    'bolt': '游댤 말pky do ku코e',
                    'fuel': '久 Palivo'
                };
                const ammoCount = getAmmoCount(ammoType);
                ammoInfo = `<p style="color: #ff9800; margin: 0.3rem 0;">游댲 Munice: ${ammoNames[ammoType] || ammoType} (m치코: ${ammoCount}x)</p>`;
            } else {
                ammoInfo = `<p style="color: #4caf50; margin: 0.3rem 0;">丘덢잺 Zbra켿 na bl칤zko - nevy쬬duje munici</p>`;
            }
            
            // Set item info
            const setInfo = typeof getSetItemInfo === 'function' ? getSetItemInfo(item.id) : null;
            const canEquipSet = setInfo ? (setInfo.classId === state.char?.classId) : true;
            let setInfoHtml = '';
            if (setInfo) {
                setInfoHtml = `
                    <div style="background: linear-gradient(135deg, #2a1a3a 0%, #1a0a2a 100%); padding: 0.6rem; border-radius: 6px; margin: 0.5rem 0; border: 1px solid #9c27b0;">
                        <p style="margin: 0; color: #ce93d8; font-size: 0.85rem;">
                            ${setInfo.setIcon} <strong>${setInfo.setName}</strong> - pouze pro ${setInfo.classIcon} ${setInfo.className}
                        </p>
                        ${!canEquipSet ? `<p style="margin: 0.3rem 0 0 0; color: #f44336; font-size: 0.8rem;">丘멆잺 Nelze nasadit - jin칠 povol치n칤!</p>` : ''}
                    </div>
                `;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    ${item.desc ? `<p style="color: #888; font-style: italic; font-size: 0.85rem; margin: 0.3rem 0;">"${item.desc}"</p>` : ''}
                    ${setInfoHtml}
                    <p style="color: #c62828; margin: 0.5rem 0;">丘덢잺 Damage: +${item.damage}</p>
                    ${ammoInfo}
                    ${specialText ? `<p style="color: #9c27b0;">${specialText}</p>` : ''}
                    
                    ${item.durability !== undefined ? `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>${'游댢 V칳dr:'}</span>
                                <span style="color: ${durabilityColor};">${item.durability}/${item.maxDurability}</span>
                            </div>
                            <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${durabilityPct}%; background: ${durabilityColor};"></div>
                            </div>
                            ${needsRepair ? `
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                                    <span style="color: #888; font-size: 0.85rem;">游눯 ${'Cena opravy:'} <strong style="color: ${canRepair ? '#ffd700' : '#f44336'};">${repairCost} 游눯</strong></span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">九 Nasazeno</p>' : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${needsRepair ? `<button class="btn" onclick="repairItemForMoney(${idx})" style="background: ${canRepair ? '#2196f3' : '#555'};" ${!canRepair ? 'disabled' : ''}>游댢 ${'Opravit za'} ${repairCost} 游눯</button>` : ''}
                    ${!isEquipped ? `<button class="btn" onclick="equipWeaponByIndex(${idx})" style="background: #4caf50;">九 ${'Nasadit'}</button>` : `<button class="btn" onclick="unequipWeapon()" style="background: #ff9800;">游녦 ${'Sundat'}</button>`}
                    <button class="btn" onclick="recycleItem(${idx})" style="background: #795548;">鮫勇 Recyklovat</button>
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 ${'Zahodit'}</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function equipWeaponByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Zamkni v칳m캩nu vybaven칤 b캩hem cestov치n칤 (ALE ne b캩hem boje - to je taktika)
            if (state.map?.traveling && !window.combatState) {
                notifyWarning('Nelze zm캩nit', 'B캩hem cestov치n칤 nelze m캩nit vybaven칤!');
                return;
            }
            
            // Kontrola class requirement (set itemy)
            const fullItem = ITEMS.find(i => i.id === item.id);
            if (fullItem?.classRequired && fullItem.classRequired !== state.char?.classId) {
                const requiredClass = CLASSES[fullItem.classRequired];
                notifyWarning('Nelze nasadit!', `${item.name} je pouze pro povol치n칤 ${requiredClass?.icon || ''} ${requiredClass?.name || fullItem.classRequired}!`);
                return;
            }
            
            // P콏idej unik치tn칤 ID pro spr치vn칠 propojen칤 po load
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.weapon = item;
            
            closeModal();
            notifySuccess('Zbra켿 nasazena!', item.name);
            renderFull();
        }
        
        function equipWeapon(itemId) {
            // Pro zp캩tnou kompatibilitu - najdi prvn칤 nenasazen칳 item s t칤mto ID
            const item = state.inv.find(i => i.id === itemId && !isItemEquipped(i)) || state.inv.find(i => i.id === itemId);
            if (!item) return;
            
            // Zamkni v칳m캩nu vybaven칤 b캩hem cestov치n칤 (ALE ne b캩hem boje - to je taktika)
            if (state.map?.traveling && !window.combatState) {
                notifyWarning('Nelze zm캩nit', 'B캩hem cestov치n칤 nelze m캩nit vybaven칤!');
                return;
            }
            
            // P콏idej unik치tn칤 ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.weapon = item;
            
            closeModal();
            notifySuccess('Zbra켿 nasazena!', item.name);
            renderFull();
        }
        
        function unequipWeapon() {
            // Zamkni v칳m캩nu vybaven칤 b캩hem cestov치n칤 (ALE ne b캩hem boje)
            if (state.map?.traveling && !window.combatState) {
                notifyWarning('Nelze zm캩nit', 'B캩hem cestov치n칤 nelze m캩nit vybaven칤!');
                return;
            }
            
            state.equipped = state.equipped || {};
            state.equipped.weapon = null;
            
            closeModal();
            notifySuccess('Zbra켿 sund치na');
            renderFull();
        }
        
        function unequipItem(slotType) {
            // Zamkni v칳m캩nu vybaven칤 b캩hem cestov치n칤
            if (state.map?.traveling) {
                notifyWarning('Nelze zm캩nit', 'B캩hem cestov치n칤 nelze m캩nit vybaven칤!');
                return;
            }
            
            state.equipped = state.equipped || {};
            
            if (slotType === 'weapon') state.equipped.weapon = null;
            else if (slotType === 'armor') state.equipped.armor = null;
            else if (slotType === 'helmet') state.equipped.helmet = null;
            else if (slotType === 'gloves') state.equipped.gloves = null;
            else if (slotType === 'boots') state.equipped.boots = null;
            
            closeModal();
            notifySuccess('P콏edm캩t sund치n');
            renderFull();
        }
        
        // 游댢 OPRAVA P콎EDM캨TU ZA PEN칈ZE
        function repairItemForMoney(idx) {
            const item = state.inv[idx];
            if (!item || item.durability === undefined) return;
            
            let repairCost = Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100);
            
            // Technik companion = opravy zdarma
            const companionBonuses = getAllCompanionBonuses();
            const freeRepair = companionBonuses.freeRepair;
            
            // Kov치콏 osadn칤k = opravy zdarma
            const blacksmithSettler = state.settlement?.settlers?.find(s => s.type === 'blacksmith_s');
            const settlerFreeRepair = blacksmithSettler ? true : false;
            
            // Engineer set (2) = -50% cena oprav
            const setEffectsRepair = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            if (setEffectsRepair.repairBonus > 0) {
                repairCost = Math.ceil(repairCost * (1 - setEffectsRepair.repairBonus));
            }
            
            if (freeRepair || settlerFreeRepair) {
                repairCost = 0;
            }
            
            if (repairCost > 0 && state.money < repairCost) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot콏ebuje코 ${repairCost} 游눯`);
                return;
            }
            
            if (item.durability >= item.maxDurability) {
                notifyWarning('Nen칤 pot콏eba', 'P콏edm캩t je v perfektn칤m stavu');
                return;
            }
            
            // Ode캜ti pen칤ze (pokud nejsou zdarma) a oprav
            if (repairCost > 0) {
                state.money -= repairCost;
                state.stats.moneySpentOnRepairs = (state.stats.moneySpentOnRepairs || 0) + repairCost;
            }
            item.durability = item.maxDurability;
            
            closeModal();
            if (freeRepair) {
                notifySuccess('游댢 Opraveno zdarma!', `${item.name} - Technik to zvl치dl!`);
            } else if (settlerFreeRepair) {
                notifySuccess('游댢 Opraveno zdarma!', `${item.name} - Kov치콏 v osad캩 pomohl!`);
            } else {
                notifySuccess('游댢 Opraveno!', `${item.name} je jako nov칳! (-${repairCost} 游눯)`);
            }
            saveGame();
            renderFull();
        }
        
        // 游댢 OPRAVIT VE - hromadn치 oprava
        function repairAllItems() {
            let totalCost = 0;
            let itemsToRepair = [];
            
            state.inv.forEach((item, idx) => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    const cost = Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100);
                    totalCost += cost;
                    itemsToRepair.push({ item, idx, cost });
                }
            });
            
            if (itemsToRepair.length === 0) {
                notifySuccess('V코e v po콏치dku', '콯치dn칳 p콏edm캩t nepot콏ebuje opravu');
                return;
            }
            
            if (state.money < totalCost) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot콏ebuje코 ${totalCost} 游눯 na opravu v코eho`);
                return;
            }
            
            showModal('游댢 Opravit v코e?', `
                <div style="text-align: center; padding: 1rem;">
                    <p>Opravit <strong>${itemsToRepair.length}</strong> p콏edm캩t콢?</p>
                    <p style="font-size: 1.5rem; color: #ffd700; margin: 1rem 0;">${totalCost} 游눯</p>
                    <p style="color: #888; font-size: 0.85rem;">M치코: ${state.money} 游눯</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="confirmRepairAll(${totalCost})" style="background: #4caf50;">九 Opravit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                </div>
            `);
        }
        
        function confirmRepairAll(totalCost) {
            state.money -= totalCost;
            
            state.inv.forEach(item => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    item.durability = item.maxDurability;
                }
            });
            
            state.stats.moneySpentOnRepairs = (state.stats.moneySpentOnRepairs || 0) + totalCost;
            
            closeModal();
            notifySuccess('游댢 V코e opraveno!', `-${totalCost} 游눯`);
            saveGame();
            renderFull();
        }
        
        // === MO콯NOSTI PRO N츼STROJE ===
        function showToolOptions(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            showToolOptionsByIndex(state.inv.indexOf(item));
        }
        
        function showToolOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const durabilityPct = item.durability !== undefined ? Math.round((item.durability / item.maxDurability) * 100) : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            // Kompletn칤 seznam bonus콢 n치stroj콢
            const bonusDescriptions = {
                'mining': { icon: '久勇', desc: 'Umo쮄갓je t캩쬭u kamene a rud', status: 'Funguje automaticky' },
                'fishing': { icon: '游꿖', desc: 'Umo쮄갓je rybolov u vody', status: 'Jdi k vod캩 a pou쬴j akci Rybolov' },
                'hunting': { icon: '游낓', desc: 'Bonus k lovu zv캩콏e', status: '+20% 코ance na 칰sp캩코n칳 lov' },
                'cooking': { icon: '游꼽', desc: 'Lep코칤 efektivita va콏en칤', status: '+10% hodnota j칤dla' },
                'alchemy': { icon: '丘勇', desc: 'V칳roba lektvar콢 a elix칤r콢', status: 'Odemyk치 alchymistick칠 recepty' },
                'capacity': { icon: '游', desc: 'Zv칳코en치 nosnost', status: '+20 kg nosnost (aktivn칤)' },
                'climbing': { icon: '游븽', desc: 'P콏칤stup k horsk칳m oblastem', status: 'Umo쮄갓je cestovat p콏es hory' },
                'escape': { icon: '游끢', desc: 'Snaz코칤 칰t캩k z boje', status: '+20% 코ance na 칰t캩k' },
                'vision': { icon: '游댨', desc: 'Lep코칤 p콏ehled o okol칤', status: '+1 viditelnost na map캩' },
                'navigation': { icon: '游빐', desc: 'Rychlej코칤 cestov치n칤', status: '-7.5% 캜as cestov치n칤' },
                'stealth': { icon: '游봉', desc: 'Men코칤 코ance na p콏epaden칤', status: '-30% 코ance na nep콏치telsk칠 setk치n칤' },
                'light': { icon: '游댡', desc: 'Sv캩tlo v temnot캩', status: 'Lep코칤 viditelnost v noci' },
                'sharpen': { icon: '丘덢잺', desc: 'Ost콏en칤 zbran칤', status: 'Klikni pro +5 DMG do캜asn캩' },
                'smelt': { icon: '游댠', desc: 'Taven칤 rud na kovy', status: 'P콏em캩켿 rudu na kov' },
                'food': { icon: '游꼤', desc: 'Pasivn칤 sb캩r j칤dla', status: '+1 j칤dlo/den v osad캩' },
                'water': { icon: '游눦', desc: '캛i코t캩n칤 vody', status: '+2 캜ist치 voda/den v osad캩' },
                'power': { icon: '丘', desc: 'Energie pro osadu', status: 'Bonus k produkci osady' },
                'signal': { icon: '游니', desc: 'P콏ivol치n칤 obchodn칤k콢', status: 'Klikni pro p콏ivol치n칤 karavany' },
                'radiation': { icon: '驕뮖잺', desc: 'M캩콏en칤 radiace', status: 'Zobrazuje 칰rove켿 radiace v oblasti' },
                'sleep': { icon: '游눣', desc: 'Odpo캜inek na 1 hodinu', status: '+50 HP, +80 Energie, -30 Hlad, -40 콯칤ze켿' }
            };
            
            const bonus = bonusDescriptions[item.bonus] || bonusDescriptions[item.effect] || { icon: '游댢', desc: item.desc || 'Speci치ln칤 n치stroj', status: 'Dr v invent치콏i' };
            
            // Speci치ln칤 akce pro n캩kter칠 n치stroje
            let specialAction = '';
            if (item.bonus === 'sharpen') {
                specialAction = `<button class="btn" onclick="useSharpen(${idx})" style="background: #ff9800;">丘덢잺 Naost콏it zbra켿 (+5 DMG)</button>`;
            } else if (item.bonus === 'signal') {
                specialAction = `<button class="btn" onclick="useSignal(${idx})" style="background: #2196f3;">游니 P콏ivolat karavanu</button>`;
            } else if (item.bonus === 'smelt') {
                specialAction = `<button class="btn" onclick="useSmelt(${idx})" style="background: #ff5722;">游댠 Tavit rudu</button>`;
            } else if (item.effect === 'sleep') {
                specialAction = `<button class="btn" onclick="closeModal(); useItem('sleeping_bag');" style="background: #8bc34a;">游눣 J칤t sp치t (1 hodina)</button>`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0;">${item.name}</h3>
                    <p style="color: #8bc34a; margin: 0.5rem 0;">${bonus.icon} ${bonus.desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0; color: #ffd700;"><strong>Status:</strong> ${bonus.status}</p>
                    </div>
                    
                    ${item.durability !== undefined ? `
                        <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>${'游댢 V칳dr:'}</span>
                                <span style="color: ${durabilityColor};">${item.durability}/${item.maxDurability}</span>
                            </div>
                            <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${durabilityPct}%; background: ${durabilityColor};"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${specialAction}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        // === COMPONENT OPTIONS ===
        function showComponentOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const rarityColor = RARITY_COLORS[item.rarity] || '#888';
            const rarityName = { common: 'B캩쬹칳', uncommon: 'Neobvykl칳', rare: 'Vz치cn칳', epic: 'Epick칳', legendary: 'Legend치rn칤' }[item.rarity] || '';
            
            // Speci치ln칤 akce pro r콢zn칠 komponenty
            let specialAction = '';
            
            if (item.id === 'ai_chip') {
                // AI chip m콢쬰 vylep코it zbra켿/zbroj
                specialAction = `<button class="btn" onclick="closeModal(); useItem('ai_chip');" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">游 Vylep코it vybaven칤 (+10 DMG/DEF)</button>`;
            } else if (item.id === 'mutant_heart') {
                // Srdce mutanta - lze pou쮂셦 NEBO craftit na amulet
                const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
                specialAction = `
                    <button class="btn" onclick="closeModal(); useItem('mutant_heart');" style="background: linear-gradient(135deg, #e91e63, #c2185b); margin-bottom: 0.5rem;">游눞 Pohltit s칤lu (+50 max HP permanentn캩)</button>
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid ${hasLegendarySmith ? '#ffd700' : '#ff6600'};">
                        <p style="color: #888; margin: 0 0 0.3rem 0; font-size: 0.8rem;">Nebo pou쬴j v craftingu:</p>
                        <p style="color: #ffd700; margin: 0 0 0.5rem 0; font-weight: bold;">游눞 Amulet mutant칤ho srdce</p>
                        <p style="color: #aaa; margin: 0 0 0.5rem 0; font-size: 0.85rem;">+3 HP/min regenerace</p>
                        <div style="border-top: 1px solid #333; padding-top: 0.5rem; margin-top: 0.5rem;">
                            <p style="color: #888; margin: 0 0 0.3rem 0; font-size: 0.8rem;">游닍 Materi치ly: 游눞 Srdce 칑1  游리 Gold 칑2  游눑 Gems 칑1</p>
                        </div>
                        ${hasLegendarySmith 
                            ? `<p style="color: #4caf50; margin: 0.5rem 0 0 0; font-size: 0.85rem;">九 M치코 Legend치rn칤 kov치콏</p>`
                            : `<p style="color: #ff6600; margin: 0.5rem 0 0 0; font-size: 0.85rem;">丘멆잺 Vy쬬duje skill Legend치rn칤 kov치콏 (콎emeslo T4)</p>`
                        }
                    </div>`;
            } else if (item.id === 'deathclaw_hand') {
                // Dr치p deathclawa - materi치l na legend치rn칤 zbra켿
                const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
                specialAction = `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid ${hasLegendarySmith ? '#ffd700' : '#ff6600'};">
                    <p style="color: #ffd700; margin: 0 0 0.5rem 0; font-weight: bold;">游붔 Rukavice Deathclawa</p>
                    <p style="color: #aaa; margin: 0 0 0.5rem 0; font-size: 0.85rem;">55 DMG, +15% krit, krv치cen칤</p>
                    <div style="border-top: 1px solid #333; padding-top: 0.5rem; margin-top: 0.5rem;">
                        <p style="color: #888; margin: 0 0 0.3rem 0; font-size: 0.8rem;">游닍 Pot콏ebn칠 materi치ly:</p>
                        <p style="color: #ccc; margin: 0; font-size: 0.85rem;">游붔 Dr치p 칑1  丘뙖잺 Metal 칑10  游붮 Leather 칑5</p>
                    </div>
                    <div style="border-top: 1px solid #333; padding-top: 0.5rem; margin-top: 0.5rem;">
                        ${hasLegendarySmith 
                            ? `<p style="color: #4caf50; margin: 0;">九 M치코 skill Legend치rn칤 kov치콏 - jdi do Craftingu!</p>`
                            : `<p style="color: #ff6600; margin: 0;">丘멆잺 Vy쬬duje skill <strong>Legend치rn칤 kov치콏</strong></p>
                               <p style="color: #888; margin: 0.3rem 0 0 0; font-size: 0.8rem;">游늸 콎emeslo  Tier 4 (pot콏eba nejd콏칤v Mistr 콏emesla)</p>`
                        }
                    </div>
                </div>`;
            } else if (item.id === 'plutonium_core' || item.id === 'quantum_stabilizer' || item.id === 'fusion_cell' || item.id === 'ai_module') {
                // Quest komponenty
                specialAction = `<div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <p style="color: #8bc34a; margin: 0;">游닆 Quest p콏edm캩t - dones Korymu nebo Koudymu</p>
                </div>`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${rarityColor};">${item.name}</h3>
                    ${rarityName ? `<span style="background: ${rarityColor}22; color: ${rarityColor}; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; text-transform: uppercase;">${rarityName}</span>` : ''}
                    
                    ${item.desc ? `<p style="color: #aaa; margin: 1rem 0; font-size: 0.9rem;">${item.desc}</p>` : ''}
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>游눯 Hodnota:</span>
                            <span style="color: #ffd700;">${item.price || 0} 游눯</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.3rem;">
                            <span>丘뒲잺 V치ha:</span>
                            <span>${item.weight || 0} kg</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${specialAction}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">Zp캩t</button>
                </div>
            `);
        }
        
        // Speci치ln칤 akce n치stroj콢
        function useSharpen(idx) {
            const weapon = state.equipped?.weapon;
            if (!weapon) {
                showModal('丘덢잺 Brus', 'Nem치코 vybavenou zbra켿 k naost콏en칤!');
                return;
            }
            if (!state.weaponBuff) state.weaponBuff = { damage: 0, fights: 0 };
            state.weaponBuff.damage += 5;
            state.weaponBuff.fights += 5;
            closeModal();
            showModal('丘덢잺 Naost콏eno!', `${weapon.icon} ${weapon.name} je ost콏ej코칤!<br><span style="color: #8bc34a;">+5 DMG na 5 boj콢</span>`);
            renderFull();
        }
        
        function useSignal(idx) {
            if (state.caravan?.active) {
                showModal('游니 Vys칤la캜ka', 'Karavana u je v oblasti!');
                return;
            }
            state.caravan = state.caravan || {};
            state.caravan.active = true;
            state.caravan.until = Date.now() + 600000; // 10 minut
            closeModal();
            notifySuccess('游니 Sign치l odesl치n!', 'Karavana doraz칤 za chv칤li');
            addLog('P콏ivolal jsi karavanu vys칤la캜kou!', '游니');
            renderFull();
        }
        
        function useSmelt(idx) {
            // Kontrola jestli m치코 rudu
            const oreTypes = ['iron_ore', 'copper_ore', 'silver_ore', 'gold_ore'];
            const hasOre = oreTypes.some(ore => (state.resources[ore] || 0) > 0);
            
            if (!hasOre) {
                showModal('游댠 Kamenn치 pec', 'Nem치코 쮂멳nou rudu k taven칤!<br><span style="color: #888;">Z칤skej rudu t캩쬭ou (久勇 Krump치캜)</span>');
                return;
            }
            
            showModal('游댠 Taven칤 rudy', `
                <p style="margin-bottom: 1rem;">Vyber rudu k roztaven칤:</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${(state.resources.iron_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('iron_ore', 'metal')">游뿯 콯elezn치 ruda (${state.resources.iron_ore})  丘뙖잺 Kov</button>` : ''}
                    ${(state.resources.copper_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('copper_ore', 'copper')">游릯 M캩d캩n치 ruda (${state.resources.copper_ore})  游릯 M캩캞</button>` : ''}
                    ${(state.resources.silver_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('silver_ore', 'silver')">拘 St콏칤brn치 ruda (${state.resources.silver_ore})  拘 St콏칤bro</button>` : ''}
                    ${(state.resources.gold_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('gold_ore', 'gold')">游리 Zlat치 ruda (${state.resources.gold_ore})  游리 Zlato</button>` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function smeltOre(oreType, metalType) {
            if ((state.resources[oreType] || 0) < 1) return;
            state.resources[oreType]--;
            state.resources[metalType] = (state.resources[metalType] || 0) + 2;
            closeModal();
            const icons = { metal: '丘뙖잺', copper: '游릯', silver: '拘', gold: '游리' };
            showModal('游댠 Roztaveno!', `+2 ${icons[metalType]} ${metalType}`);
            renderFull();
        }
        
        // === MO콯NOSTI PRO BRN캨N칈 ===
        function showArmorOptions(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            showArmorOptionsByIndex(state.inv.indexOf(item));
        }
        
        function showArmorOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.armor === item;
            const durabilityPct = item.durability !== undefined ? Math.round((item.durability / item.maxDurability) * 100) : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            // V칳po캜et ceny opravy
            const repairCost = item.durability !== undefined ? Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100) : 0;
            const canRepair = item.durability !== undefined && item.durability < item.maxDurability && state.money >= repairCost;
            const needsRepair = item.durability !== undefined && item.durability < item.maxDurability;
            
            // Popis speci치ln칤ch efekt콢 brn캩n칤
            const specialDescriptions = {
                'powered': '丘 +5 obrana, +5 damage',
                'stealth': '游봉 -50% 코ance na p콏epaden칤, +15% dodge',
                'berserker': '游놏 +30% damage, -3 obrana',
                'phoenix': '游댠 Jednou za boj: p콏e쬴je코 smrt s 30% HP',
                'titan': '游 +5 obrana, imunita na kritick칠 z치sahy',
                'scout': '游끢 +15% dodge',
                'medic': '游낀 +50% efektivita l칠캜en칤',
                'mutant': '游빏 +50% odolnost v콢캜i radiaci a jed콢m',
                'exo': '游 +50% nosnost, +10% damage',
                'nano': '游댧 +2 HP regenerace ka쬯칠 kolo v boji',
                'intimidate': '游 +2 damage',
                'scavenger': '游 +25% bonus loot',
                'camo': '游 -30% 코ance na n치hodn칠 souboje',
                'nightvision': '游깿 +15% damage v noci',
                'agile': '游끢 +10% dodge',
                'block': '游띠勇 +15% 코ance na blok',
                'block_bonus': '游띠勇 +10% 코ance na blok',
                'dodge_bonus': '游눧 +10% 코ance na 칰hyb',
                'rad_resist': '驕뮖잺 -30% radiace',
                'rad_immune': '驕뮖잺 -50% radiace',
                'night_vision': '游녜勇 No캜n칤 vid캩n칤',
                'fireproof': '游댠 Imunita na ohe켿',
                'insulated': '丘 Imunita na elekt콏inu',
                'warm': '仇勇 -30% ztr치ta energie p콏i cestov치n칤',
                'endurance': '游끢 -30% ztr치ta energie p콏i cestov치n칤'
            };
            
            const specialText = item.special ? (specialDescriptions[item.special] || `救 ${item.special}`) : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    ${item.desc ? `<p style="color: #888; font-style: italic; font-size: 0.85rem; margin: 0.3rem 0;">"${item.desc}"</p>` : ''}
                    <p style="color: #3949AB; margin: 0.5rem 0;">游띠勇 Obrana: +${item.defense}</p>
                    <p style="color: #888; margin: 0.2rem 0; font-size: 0.85rem;">丘뒲잺 V치ha: ${item.weight || 0} kg</p>
                    ${specialText ? `<p style="color: #9c27b0; margin: 0.5rem 0;">${specialText}</p>` : ''}
                    
                    ${item.durability !== undefined ? `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>${'游댢 V칳dr:'}</span>
                                <span style="color: ${durabilityColor};">${item.durability}/${item.maxDurability}</span>
                            </div>
                            <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${durabilityPct}%; background: ${durabilityColor};"></div>
                            </div>
                            ${needsRepair ? `
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                                    <span style="color: #888; font-size: 0.85rem;">游눯 ${'Cena opravy:'} <strong style="color: ${canRepair ? '#ffd700' : '#f44336'};">${repairCost} 游눯</strong></span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">九 Nasazeno</p>' : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${needsRepair ? `<button class="btn" onclick="repairItemForMoney(${idx})" style="background: ${canRepair ? '#2196f3' : '#555'};" ${!canRepair ? 'disabled' : ''}>游댢 Opravit za ${repairCost} 游눯</button>` : ''}
                    ${!isEquipped ? `<button class="btn" onclick="equipArmorByIndex(${idx})" style="background: #4caf50;">九 Nasadit</button>` : `<button class="btn" onclick="unequipArmor()" style="background: #ff9800;">游녦 Sundat</button>`}
                    <button class="btn" onclick="recycleItem(${idx})" style="background: #795548;">鮫勇 Recyklovat</button>
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function showAmmoInfoByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const ammoNames = { 
                'arrow': { name: '먞셣y', weapon: 'Luk', icon: '游낓' },
                'bolt': { name: '말pky', weapon: 'Ku코e', icon: '游꿢' },
                '9mm': { name: 'N치boje 9mm', weapon: 'Pistole', icon: '游댦' },
                '556': { name: 'N치boje 5.56', weapon: '칔to캜n치 pu코ka', icon: '游댦' },
                '762': { name: 'N치boje 7.62', weapon: 'Odst콏elova캜ka', icon: '游꿢' },
                'shell': { name: 'Brokov칠 n치boje', weapon: 'Brokovnice', icon: '游댦' },
                'fuel': { name: 'Palivo', weapon: 'Plamenomet', icon: '游댠' }
            };
            const ammoInfo = ammoNames[item.ammoType] || { name: item.name, weapon: 'Nezn치m치', icon: '游꿢' };
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #ff9800; font-size: 1.3rem; margin: 0.5rem 0;">游닍 Po캜et: ${item.count || 1}</p>
                    <p style="color: #888; margin: 0.5rem 0;">${ammoInfo.icon} Pro zbra켿: ${ammoInfo.weapon}</p>
                    <p style="color: #666; font-size: 0.85rem;">丘뒲잺 V치ha: ${((item.weight || 0.1) * (item.count || 1)).toFixed(1)} kg</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${(item.count || 1) > 1 ? `<button class="btn" onclick="showSplitStackDialog(${idx})" style="background: #2196f3;">九勇 Rozd캩lit stack</button>` : ''}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function showThrowableInfoByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Z칤skej n치zev munice pokud je to ranged zbra켿
            let ammoInfo = '';
            if (item.ammoType) {
                const ammoCount = getAmmoCount(item.ammoType);
                ammoInfo = `<p style="color: #ff9800; margin: 0.5rem 0;">游댲 Munice: ${getAmmoName(item.ammoType)} (m치코: ${ammoCount})</p>`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    ${item.damage ? `<p style="color: #ff4444; margin: 0.5rem 0;">${`游눤 Po코kozen칤: ${item.damage}`}</p>` : ''}
                    ${ammoInfo}
                    ${item.aoe ? `<p style="color: #ff9800;">${'游댠 Plo코n칳 efekt'}</p>` : ''}
                    ${item.special ? `<p style="color: #9c27b0;">${`救 Speci치ln칤: ${item.special}`}</p>` : ''}
                    ${item.effect === 'escape' ? `<p style="color: #4caf50;">${'游눧 Umo쮄갓je 칰t캩k z boje'}</p>` : ''}
                    <p style="color: #888; margin: 0.5rem 0;">游닍 Po캜et: ${item.count || 1}</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${(item.count || 1) > 1 ? `<button class="btn" onclick="showSplitStackDialog(${idx})" style="background: #2196f3;">九勇 Rozd캩lit stack</button>` : ''}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function equipArmorByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Zamkni v칳m캩nu vybaven칤 b캩hem cestov치n칤
            if (state.map?.traveling) {
                notifyWarning('Nelze zm캩nit', 'B캩hem cestov치n칤 nelze m캩nit vybaven칤!');
                return;
            }
            
            // Kontrola 쬰 to je skute캜n캩 zbroj
            if (item.type !== 'armor') {
                showModal('仇 Nelze nasadit', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">${item.icon || '仇'}</div>
                        <p>${'Tento p콏edm캩t nen칤 zbroj!'}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Kontrola class requirement (set itemy)
            const fullItem = ITEMS.find(i => i.id === item.id);
            if (fullItem?.classRequired && fullItem.classRequired !== state.char?.classId) {
                const requiredClass = CLASSES[fullItem.classRequired];
                notifyWarning('Nelze nasadit!', `${item.name} je pouze pro povol치n칤 ${requiredClass?.icon || ''} ${requiredClass?.name || fullItem.classRequired}!`);
                return;
            }
            
            // Mutant nem콢쬰 nosit brn캩n칤
            if (state.char.class === 'mutant') {
                showModal('仇 Nelze nasadit', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">游붍</div>
                        <p>Jsi p콏칤li코 velk칳 a zdeformovan칳 na b캩쬹칠 brn캩n칤!</p>
                        <p style="color: #76ff03;">Tv치 mutant칤 k콢쬰 ti d치v치 +10 p콏irozen칠 obrany.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // P콏idej unik치tn칤 ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.armor = item;
            
            closeModal();
            notifySuccess('Brn캩n칤 nasazeno!', item.name);
            renderFull();
        }
        
        function equipArmor(itemId) {
            // Pro zp캩tnou kompatibilitu
            const item = state.inv.find(i => i.id === itemId && i.type === 'armor' && !isItemEquipped(i)) || state.inv.find(i => i.id === itemId && i.type === 'armor');
            if (item) {
                const idx = state.inv.indexOf(item);
                equipArmorByIndex(idx);
            }
        }
        
        function unequipArmor() {
            // Zamkni v칳m캩nu vybaven칤 b캩hem cestov치n칤
            if (state.map?.traveling) {
                notifyWarning('Nelze zm캩nit', 'B캩hem cestov치n칤 nelze m캩nit vybaven칤!');
                return;
            }
            
            state.equipped = state.equipped || {};
            state.equipped.armor = null;
            
            closeModal();
            notifySuccess('Brn캩n칤 sund치no');
            renderFull();
        }
        
        // === RUKAVICE ===
        function showGlovesOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.gloves === item;
            const durabilityPct = item.durability ? (item.durability / item.maxDurability) * 100 : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            const glovesSpecials = {
                'block_bonus': '游띠勇 +10% 코ance na blok',
                'unarmed_bonus': '游녥 +5 damage beze zbran캩',
                'grip': '游꿢 +10% p콏esnost st콏elby',
                'bleed_punch': '游뽖 칔tok p캩st칤 zp콢sob칤 krv치cen칤',
                'power_punch': '游눩 +10 damage v boji zbl칤zka',
                'medic_bonus': '游낀 +20% efektivita l칠캜en칤',
                'rad_resist': '驕뮖잺 -20% radiace'
            };
            const specialText = item.special ? (glovesSpecials[item.special] || `救 ${item.special}`) : '';
            const specialClickable = item.special ? `<p onclick="showSpecialEffectDetail('${item.special}')" style="color: #9c27b0; margin: 0.5rem 0; cursor: pointer; text-decoration: underline;">${specialText} 좶잺</p>` : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #ff9800; margin: 0.5rem 0;">游볡 Obrana: +${item.defense}</p>
                    ${specialClickable}
                    ${item.durability !== undefined ? `<p style="color: ${durabilityColor};">${`游댢 V칳dr: ${item.durability}/${item.maxDurability}`}</p>` : ''}
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">九 Nasazeno</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${!isEquipped ? `<button class="btn" onclick="equipGlovesByIndex(${idx})" style="background: #4caf50;">九 Nasadit</button>` : `<button class="btn" onclick="unequipGloves()" style="background: #ff9800;">游녦 Sundat</button>`}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function equipGlovesByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // P콏idej unik치tn칤 ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.gloves = item;
            
            closeModal();
            notifySuccess('Rukavice nasazeny!', item.name);
            renderFull();
        }
        
        function unequipGloves() {
            state.equipped = state.equipped || {};
            state.equipped.gloves = null;
            
            closeModal();
            notifySuccess('Rukavice sund치ny');
            renderFull();
        }
        
        // === BOTY ===
        function showBootsOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.boots === item;
            const durabilityPct = item.durability ? (item.durability / item.maxDurability) * 100 : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            const bootsSpecials = {
                'dodge_bonus': '游눧 +10% 코ance na 칰hyb',
                'speed_bonus': '游끢 +10% rychlost cestov치n칤',
                'stealth_move': '游봉 -20% 코ance na p콏epaden칤',
                'run_bonus': '游끢 +15% rychlost 칰t캩ku',
                'stomp': '游붰 Siln칳 kop (+8 damage)',
                'jump': '游붖 +25% dodge',
                'warm_feet': '仇勇 -15% ztr치ta energie',
                'power_kick': '游 +20% rychlost, +10 defense',
                'exo': '游 +50% nosnost, +10% damage',
                'sturdy': '游댢 +2 defense (stabilita)',
                'combat_stance': '丘덢잺 +5% kritick칳 z치sah',
                'light_feet': '游뽒 +5% rychlost cestov치n칤'
            };
            const specialText = item.special ? (bootsSpecials[item.special] || `救 ${item.special}`) : '';
            const specialClickable = item.special ? `<p onclick="showSpecialEffectDetail('${item.special}')" style="color: #9c27b0; margin: 0.5rem 0; cursor: pointer; text-decoration: underline;">${specialText} 좶잺</p>` : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #00bcd4; margin: 0.5rem 0;">游 Obrana: +${item.defense}</p>
                    ${specialClickable}
                    ${item.durability !== undefined ? `<p style="color: ${durabilityColor};">${`游댢 V칳dr: ${item.durability}/${item.maxDurability}`}</p>` : ''}
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">九 Nasazeno</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${!isEquipped ? `<button class="btn" onclick="equipBootsByIndex(${idx})" style="background: #4caf50;">九 Nasadit</button>` : `<button class="btn" onclick="unequipBoots()" style="background: #ff9800;">游녦 Sundat</button>`}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function equipBootsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // P콏idej unik치tn칤 ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.boots = item;
            
            console.log('游녹 Equipped boots:', item.name, 'special:', item.special);
            
            closeModal();
            notifySuccess('Boty nasazeny!', item.name + (item.special ? ' (' + item.special + ')' : ''));
            renderFull();
        }
        
        function unequipBoots() {
            state.equipped = state.equipped || {};
            state.equipped.boots = null;
            
            closeModal();
            notifySuccess('Boty sund치ny');
            renderFull();
        }
        
        // === HELMA ===
        function showHelmetOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.helmet === item;
            const durabilityPct = item.durability ? (item.durability / item.maxDurability) * 100 : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            const helmetSpecials = {
                'crit_immune': '游띠勇 Imunita na kritick칠 z치sahy',
                'rad_resist': '驕뮖잺 -30% radiace',
                'night_vision': '游녜勇 No캜n칤 vid캩n칤',
                'gas_filter': '驕勇 Imunita na jedy',
                'headshot_protect': '游꿢 -50% damage na hlavu'
            };
            const specialText = item.special ? (helmetSpecials[item.special] || `救 ${item.special}`) : '';
            const specialClickable = item.special ? `<p onclick="showSpecialEffectDetail('${item.special}')" style="color: #9c27b0; margin: 0.5rem 0; cursor: pointer; text-decoration: underline;">${specialText} 좶잺</p>` : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #795548; margin: 0.5rem 0;">久놾잺 Obrana: +${item.defense}</p>
                    ${specialClickable}
                    ${item.durability !== undefined ? `<p style="color: ${durabilityColor};">${`游댢 V칳dr: ${item.durability}/${item.maxDurability}`}</p>` : ''}
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">九 Nasazeno</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${!isEquipped ? `<button class="btn" onclick="equipHelmetByIndex(${idx})" style="background: #4caf50;">九 Nasadit</button>` : `<button class="btn" onclick="unequipHelmet()" style="background: #ff9800;">游녦 Sundat</button>`}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function equipHelmetByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Kontrola class requirement (set itemy)
            const fullItem = ITEMS.find(i => i.id === item.id);
            if (fullItem?.classRequired && fullItem.classRequired !== state.char?.classId) {
                const requiredClass = CLASSES[fullItem.classRequired];
                notifyWarning('Nelze nasadit!', `${item.name} je pouze pro povol치n칤 ${requiredClass?.icon || ''} ${requiredClass?.name || fullItem.classRequired}!`);
                return;
            }
            
            // P콏idej unik치tn칤 ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.helmet = item;
            
            closeModal();
            notifySuccess('Helma nasazena!', item.name);
            renderFull();
        }
        
        function unequipHelmet() {
            state.equipped = state.equipped || {};
            state.equipped.helmet = null;
            
            closeModal();
            notifySuccess('Helma sund치na');
            renderFull();
        }
        
        // === ZAHOZEN칈 P콎EDM캨TU ===
        function dropItemByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Quest itemy nelze zahodit
            if (item.cantDrop || item.type === 'quest') {
                notifyWarning('Nelze zahodit', 'Tento p콏edm캩t je pot콏ebn칳 pro quest a nelze ho zahodit!');
                return;
            }
            
            // Pokud m치 v칤ce kus콢, zobraz dialog pro v칳b캩r po캜tu
            if (item.count && item.count > 1) {
                showDropAmountDialog(idx);
                return;
            }
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon === item) state.equipped.weapon = null;
            if (state.equipped?.armor === item) state.equipped.armor = null;
            if (state.equipped?.gloves === item) state.equipped.gloves = null;
            if (state.equipped?.boots === item) state.equipped.boots = null;
            if (state.equipped?.helmet === item) state.equipped.helmet = null;
            
            // Odeber z invent치콏e
            state.inv.splice(idx, 1);
            
            // Aktualizuj nosnost
            updateCarryWeight();
            
            closeModal();
            addLog('Zahodil jsi ' + item.name, '游딈勇');
            notifyWarning('Zahozeno', item.name);
            renderFull();
        }
        
        // Dialog pro v칳b캩r po캜tu k zahozen칤
        function showDropAmountDialog(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const maxDrop = item.count || 1;
            const defaultDrop = 1;
            
            showModal(`游딈勇 ${'Zahodit'} ${item.icon} ${item.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${item.icon}</div>
                    <p style="color: #888;">${'M치코'}: <strong style="color: #ffd700;">${item.count}x</strong></p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <label style="color: #888; display: block; margin-bottom: 0.5rem;">${'Kolik zahodit?'}</label>
                    <input type="range" id="dropAmount" min="1" max="${maxDrop}" value="${defaultDrop}" 
                        style="width: 100%;"
                        oninput="document.getElementById('dropValue').textContent = this.value; document.getElementById('keepValue').textContent = (${maxDrop} - parseInt(this.value));">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span style="color: #666;">1</span>
                        <span style="color: #f44336; font-size: 1.2rem; font-weight: bold;" id="dropValue">${defaultDrop}</span>
                        <span style="color: #666;">${maxDrop}</span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-around; background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">${'Ponechat'}</div>
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;" id="keepValue">${maxDrop - defaultDrop}</div>
                    </div>
                    <div style="color: #555; font-size: 2rem;">游딈勇</div>
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">${'Zahodit'}</div>
                        <div style="color: #f44336; font-size: 1.5rem; font-weight: bold;" id="dropValueDisplay">${defaultDrop}</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="confirmDropAmount(${idx})" style="flex: 1; background: #c62828;">
                        游딈勇 ${'Zahodit'}
                    </button>
                    <button class="btn" onclick="confirmDropAll(${idx})" style="flex: 1; background: #8B0000;">
                        游 ${'Zahodit v코e'}
                    </button>
                </div>
                <button class="btn" onclick="closeModal(); showItemDetails(${idx});" style="width: 100%; margin-top: 0.5rem; background: #555;">
                     ${'Zp캩t'}
                </button>
            `);
            
            // Synchronizuj oba displeje - pou쬴j closure pro maxDrop
            const maxDropValue = maxDrop;
            setTimeout(() => {
                const slider = document.getElementById('dropAmount');
                if (slider) {
                    slider.oninput = function() {
                        document.getElementById('dropValue').textContent = this.value;
                        document.getElementById('dropValueDisplay').textContent = this.value;
                        document.getElementById('keepValue').textContent = maxDropValue - parseInt(this.value);
                    };
                }
            }, 100);
        }
        
        function confirmDropAmount(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const dropAmount = parseInt(document.getElementById('dropAmount')?.value || 1);
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon === item) state.equipped.weapon = null;
            if (state.equipped?.armor === item) state.equipped.armor = null;
            if (state.equipped?.gloves === item) state.equipped.gloves = null;
            if (state.equipped?.boots === item) state.equipped.boots = null;
            if (state.equipped?.helmet === item) state.equipped.helmet = null;
            
            // Odeber z invent치콏e
            if (item.count && item.count > dropAmount) {
                item.count -= dropAmount;
            } else {
                state.inv.splice(idx, 1);
            }
            
            // Aktualizuj nosnost
            updateCarryWeight();
            
            closeModal();
            addLog('Zahodil jsi ' + dropAmount + 'x ' + item.name, '游딈勇');
            notifyWarning('Zahozeno', dropAmount + 'x ' + item.name);
            renderFull();
        }
        
        function confirmDropAll(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const dropAmount = item.count || 1;
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon === item) state.equipped.weapon = null;
            if (state.equipped?.armor === item) state.equipped.armor = null;
            if (state.equipped?.gloves === item) state.equipped.gloves = null;
            if (state.equipped?.boots === item) state.equipped.boots = null;
            if (state.equipped?.helmet === item) state.equipped.helmet = null;
            
            // Odeber cel칳 stack
            state.inv.splice(idx, 1);
            
            // Aktualizuj nosnost
            updateCarryWeight();
            
            closeModal();
            addLog('Zahodil jsi ' + dropAmount + 'x ' + item.name, '游딈勇');
            notifyWarning('Zahozeno', dropAmount + 'x ' + item.name);
            renderFull();
        }
        
        // === ROZD캨LEN칈 STACKU ===
        function showSplitStackDialog(idx) {
            const item = state.inv[idx];
            if (!item || !item.count || item.count <= 1) {
                notifyError('Nelze rozd캩lit', 'M치코 jen 1 kus');
                return;
            }
            
            const maxSplit = item.count - 1;
            const defaultSplit = Math.floor(item.count / 2);
            const totalCount = item.count;
            
            showModal(`九勇 Rozd캩lit ${item.icon} ${item.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${item.icon}</div>
                    <p style="color: #888;">Celkem: <strong style="color: #ffd700;">${item.count}x</strong></p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <label style="color: #888; display: block; margin-bottom: 0.5rem;">Kolik odd캩lit do nov칠ho stacku?</label>
                    <input type="range" id="splitAmount" min="1" max="${maxSplit}" value="${defaultSplit}" 
                        style="width: 100%;"
                        oninput="document.getElementById('splitValue').textContent = this.value; document.getElementById('originalStack').textContent = (${totalCount} - parseInt(this.value)) + 'x'; document.getElementById('newStack').textContent = this.value + 'x';">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span style="color: #666;">1</span>
                        <span style="color: #ffd700; font-size: 1.2rem; font-weight: bold;" id="splitValue">${defaultSplit}</span>
                        <span style="color: #666;">${maxSplit}</span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-around; background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">P콢vodn칤 stack</div>
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;" id="originalStack">${item.count - defaultSplit}x</div>
                    </div>
                    <div style="color: #555; font-size: 2rem;"></div>
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Nov칳 stack</div>
                        <div style="color: #2196f3; font-size: 1.5rem; font-weight: bold;" id="newStack">${defaultSplit}x</div>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="splitStack(${idx}, parseInt(document.getElementById('splitAmount').value))" style="background: #4caf50;">
                        九勇 Rozd캩lit
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function splitStack(idx, amount) {
            const item = state.inv[idx];
            if (!item || !item.count || item.count <= 1) return;
            if (amount <= 0 || amount >= item.count) return;
            
            console.log('splitStack: idx=', idx, 'amount=', amount, 'item.count before=', item.count);
            
            const originalCount = item.count;
            
            // Vytvo콏 NOV칗 objekt ru캜n캩 (ne spread) s unik치tn칤m stackId
            const newItem = {
                id: item.id,
                name: item.name,
                icon: item.icon,
                type: item.type,
                effect: item.effect,
                value: item.value,
                weight: item.weight,
                price: item.price,
                rarity: item.rarity,
                stackable: true,
                count: amount,
                stackId: 'split_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            // Zkop칤ruj dal코칤 vlastnosti pokud existuj칤
            if (item.buff) newItem.buff = item.buff;
            if (item.duration) newItem.duration = item.duration;
            if (item.ammoType) newItem.ammoType = item.ammoType;
            if (item.damage) newItem.damage = item.damage;
            if (item.aoe) newItem.aoe = item.aoe;
            if (item.special) newItem.special = item.special;
            
            // Sni p콢vodn칤 stack
            item.count = originalCount - amount;
            
            console.log('splitStack: item.count after=', item.count, 'newItem.count=', newItem.count);
            console.log('splitStack: inv length before push=', state.inv.length);
            
            // P콏idej nov칳 stack na konec invent치콏e
            state.inv.push(newItem);
            
            console.log('splitStack: inv length after push=', state.inv.length);
            console.log('splitStack: state.inv items:', state.inv.map(i => i.name + ' x' + (i.count || 1)));
            
            closeModal();
            notifySuccess('Stack rozd캩len', `${item.name}: ${item.count}x + ${newItem.count}x`);
            saveGame(true);
            renderFull();
            
            // Debug po renderFull
            console.log('splitStack: after renderFull, inv length=', state.inv.length);
        }
        
        function dropItem(itemId) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;
            
            const item = state.inv[itemIndex];
            
            // Quest itemy nelze zahodit
            if (item.cantDrop || item.type === 'quest') {
                notifyWarning('Nelze zahodit', 'Tento p콏edm캩t je pot콏ebn칳 pro quest a nelze ho zahodit!');
                return;
            }
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon?.id === itemId) state.equipped.weapon = null;
            if (state.equipped?.armor?.id === itemId) state.equipped.armor = null;
            
            // Odeber z invent치콏e
            if (item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            closeModal();
            notifyWarning('Zahozeno', item.name);
            addLog(`Zahodil jsi ${item.name}`, '游딈勇');
            renderFull();
        }

        function confirmUseItemByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Pro spac치k pou쬴j existuj칤c칤 logiku
            if (item.effect === 'sleep') {
                useItem(item.id);
                return;
            }
            
            // Z칤skej pln치 data itemu z ITEMS
            const fullItemData = ITEMS.find(i => i.id === item.id);
            
            // Popis efektu
            let effectDesc = '';
            if (item.effect === 'health') {
                effectDesc = `仇벒잺 Vyl칠캜칤 <strong>+${item.value} HP</strong>`;
            } else if (item.effect === 'hunger') {
                effectDesc = `游꼤 Nasyt칤 <strong>+${item.value}%</strong> hladu`;
            } else if (item.effect === 'thirst') {
                effectDesc = `游눦 Osv캩쮂 <strong>+${item.value}%</strong> 쮂셬n캩`;
            } else if (item.effect === 'energy') {
                effectDesc = `丘 Dod치 <strong>+${item.value}%</strong> energie`;
            } else if (item.effect === 'radiation') {
                effectDesc = `驕뮖잺 Radiace <strong>${item.value}</strong>`;
            } else if (item.effect === 'heal_injury') {
                effectDesc = item.value > 0 ? `游뽗 Vyl칠캜칤 <strong>+${item.value} HP</strong> a zran캩n칤` : `游뽗 O코et콏칤 zran캩n칤`;
            } else if (item.effect === 'cure_disease') {
                effectDesc = item.value > 0 ? `游 L칠캜칤 nemoci a hydratuje` : `游 L칠캜칤 nemoci`;
            } else if (item.buff) {
                effectDesc = `九 Buff: <strong>+${item.value} ${item.buff}</strong> na ${Math.floor((item.duration || 300) / 60)} min`;
            }
            
            // Detailn칤 info o l칠캜en칤 nemoc칤
            let curesInfo = '';
            const cures = fullItemData?.cures || item.cures;
            if (cures && cures.length > 0 && typeof DISEASES !== 'undefined') {
                const diseaseNames = cures.map(id => {
                    const disease = DISEASES.find(d => d.id === id);
                    return disease ? `${disease.icon} ${disease.name}` : id;
                }).join(', ');
                curesInfo = `<p style="color: #4caf50; font-size: 0.85rem; margin: 0.3rem 0;">游 L칠캜칤: ${diseaseNames}</p>`;
            }
            
            // Detailn칤 info o l칠캜en칤 zran캩n칤
            let healsInjuriesInfo = '';
            const healsInjuries = fullItemData?.healsInjuries || item.healsInjuries;
            if (healsInjuries && healsInjuries.length > 0 && typeof INJURIES !== 'undefined') {
                const injuryNames = healsInjuries.map(id => {
                    const injury = INJURIES.find(inj => inj.id === id);
                    return injury ? `${injury.icon} ${injury.name}` : id;
                }).join(', ');
                healsInjuriesInfo = `<p style="color: #ff9800; font-size: 0.85rem; margin: 0.3rem 0;">游뽗 O코et콏칤: ${injuryNames}</p>`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    ${fullItemData?.desc ? `<p style="color: #888; font-style: italic; font-size: 0.85rem; margin: 0.3rem 0;">"${fullItemData.desc}"</p>` : ''}
                    <p style="color: #999; margin: 0.5rem 0;">丘뒲잺 V치ha: ${item.weight || 0} kg</p>
                    ${item.count > 1 ? `<p style="color: #ffd700;">${`游닍 Po캜et: ${item.count}x`}</p>` : ''}
                    
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0; font-size: 1.1rem;">${effectDesc}</p>
                        ${curesInfo}
                        ${healsInjuriesInfo}
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal(); useItem('${item.id}');" style="background: #4caf50;">九 Pou쮂셦</button>
                    ${item.count > 1 ? `<button class="btn" onclick="showSplitStackDialog(${idx})" style="background: #2196f3;">九勇 Rozd캩lit stack (${item.count}x)</button>` : ''}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">游딈勇 Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        function confirmUseItem(itemId) {
            const idx = state.inv.findIndex(i => i.id === itemId);
            if (idx !== -1) {
                confirmUseItemByIndex(idx);
            }
        }
        
        function useItem(itemId) {
            console.log('=== useItem called ===');
            console.log('itemId:', itemId);
            
            const item = state.inv.find(i => i.id === itemId);
            console.log('item from inventory:', item);
            
            if (!item) {
                console.log('ERROR: item not found in inventory');
                return;
            }
            
            // Knihy - p콏e캜ti
            if (item.type === 'lore') {
                readLoreBook(item.id);
                return;
            }
            
            // SPAC츼K - speci치ln칤 handling P콎ED kontrolou consumable typu
            if (item.effect === 'sleep') {
                console.log('Sleep effect detected!');
                const now = Date.now();
                const timeSinceLastSleep = now - (state.lastSleepTime || 0);
                const hoursToWait = 24 * 60 * 60 * 1000;
                
                console.log('timeSinceLastSleep:', timeSinceLastSleep);
                console.log('hoursToWait:', hoursToWait);
                
                if (timeSinceLastSleep < hoursToWait) {
                    const hoursLeft = Math.ceil((hoursToWait - timeSinceLastSleep) / (60 * 60 * 1000));
                    showModal('游땺 Nejsi unaven칳', `<div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游땺</div>
                        <p>Je코t캩 nejsi dost unaven칳 na sp치nek.</p>
                        <p style="color: #ff9800;">M콢쬰코 sp치t znovu za <strong>${hoursLeft} hodin</strong>.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>`);
                    return;
                }
                
                console.log('Showing sleep confirmation modal...');
                
                // Show confirmation dialog
                const modalHTML = '<div style="text-align: left;">' +
                    '<p style="font-size: 1.1rem; color: #ff9800; text-align: center; margin-bottom: 1rem;">丘멆잺 Opravdu chce코 j칤t sp치t na 1 hodinu?</p>' +
                    '<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                    '<h3 style="margin: 0 0 0.5rem 0; color: #d4722e;">낌勇 B캩hem sp치nku:</h3>' +
                    '<ul style="margin: 0.5rem 0; line-height: 1.8;">' +
                    '<li>游 <strong>Nem콢쬰코 d캩lat NIC</strong> celou 1 hodinu re치ln칠ho 캜asu</li>' +
                    '<li>낒勇 Hra bude zablokovan치</li>' +
                    '<li>낍 캛as norm치ln캩 b캩쮂</li>' +
                    '</ul></div>' +
                    '<div style="background: #1a4d1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                    '<h3 style="margin: 0 0 0.5rem 0; color: #8bc34a;">九 Co se stane:</h3>' +
                    '<ul style="margin: 0.5rem 0; line-height: 1.8;">' +
                    '<li>仇벒잺 HP: <strong>+50</strong></li>' +
                    '<li>丘 Energie: <strong>+80</strong></li>' +
                    '</ul></div>' +
                    '<div style="background: #4d1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                    '<h3 style="margin: 0 0 0.5rem 0; color: #ff9800;">丘멆잺 Upozorn캩n칤:</h3>' +
                    '<ul style="margin: 0.5rem 0; line-height: 1.8;">' +
                    '<li>游꼤 Hlad: <strong>-30</strong></li>' +
                    '<li>游눦 콯칤ze켿: <strong>-40</strong></li>' +
                    '</ul>' +
                    '<p style="margin: 0.5rem 0 0 0; color: #ff9800; font-size: 0.9rem;">游눠 Ujisti se 쬰 m치코 dost j칤dla a vody na pozd캩ji!</p>' +
                    '</div></div>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>' +
                    '<button class="btn" onclick="startSleeping()" style="background: #8bc34a;">游눣 Ano, j칤t sp치t</button>' +
                    '</div>';
                
                showModal('游눣 J칤t sp치t?', modalHTML);
                return;
            }
            
            // SRDCE BEHEMOTHA - permanentn칤 +50 max HP
            if (item.id === 'mutant_heart') {
                // Kontrola jestli u bylo pou쬴to
                if (state.secrets?.includes('used_mutant_heart')) {
                    showModal('游눞 Srdce Behemotha', `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem;">游눞</div>
                            <p style="color: #ff9800;">U jsi jednou srdce pou쬴l.</p>
                            <p style="color: #888;">Tv칠 t캩lo ji absorbovalo jeho s칤lu.</p>
                            <p style="color: #666; font-size: 0.85rem; margin-top: 1rem;">M콢쬰코 ho prodat za 4000 游눯</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                    return;
                }
                
                // Potvr캞 pou쬴t칤
                showModal('游눞 Srdce Behemotha', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; animation: pulse 1s infinite;">游눞</div>
                        <p style="color: #9c27b0; font-size: 1.2rem; margin: 1rem 0;">Masivn칤 srdce st치le tepe...</p>
                        <p>Absorbovat jeho s칤lu?</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4caf50;">
                            <p style="color: #8bc34a; margin: 0;">九 <strong>+50 Max HP</strong> (permanentn캩)</p>
                        </div>
                        <p style="color: #888; font-size: 0.85rem;">Srdce bude zni캜eno.</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                        <button class="btn" onclick="useMutantHeart()" style="background: linear-gradient(135deg, #9c27b0, #673ab7);">游눞 Absorbovat</button>
                    </div>
                `);
                return;
            }
            
            // AI CHIP - vylep코en칤 zbran캩 nebo zbroje
            if (item.id === 'ai_chip') {
                showAIChipUpgradeModal();
                return;
            }
            
            if (item.type !== 'consumable') {
                console.log('ERROR: item is not consumable, type:', item.type);
                return;
            }
            
            console.log('item.effect:', item.effect);
            
            // For other consumables, use item data
            console.log('Processing other consumable...');
            
            if (item.effect === 'health') {
                let healAmount = item.value;
                
                // Bonus z vybaven칤 (medic_vest, surgeon_gloves)
                const equipEffects = getArmorSpecialEffects();
                if (equipEffects.healBonus > 0) {
                    healAmount = Math.floor(healAmount * (1 + equipEffects.healBonus));
                }
                
                // Companion skills healing bonus
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.healingBonus > 0) {
                    healAmount = Math.floor(healAmount * (1 + compBonuses.healingBonus));
                }
                
                // NPC bonus - Medical Training od doktora Harrise/Koudyho (+25% healing)
                const npcBonuses = typeof getNpcBonuses === 'function' ? getNpcBonuses() : {};
                if (npcBonuses.medicalTraining) {
                    healAmount = Math.floor(healAmount * 1.25);
                }
                
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                SoundSystem.play('pickup');
                showFloatingNumber(healAmount, 'heal');
                
                // GROUP HEAL - Medic set (2) - l칠캜iva l칠캜칤 i spole캜n칤ky
                let groupHealText = '';
                const setEffectsHeal = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                if (setEffectsHeal.groupHeal && state.companions?.length > 0) {
                    const companionHeal = Math.floor(healAmount * 0.5); // 50% z heal
                    state.companions.filter(c => !c.isDead).forEach(comp => {
                        if (comp.hp === undefined) comp.hp = comp.maxHp || 80;
                        comp.hp = Math.min(comp.maxHp || 100, comp.hp + companionHeal);
                    });
                    groupHealText = `<br><span style="color: #81c784;">游논 Spole캜n칤ci: +${companionHeal} HP (set bonus)</span>`;
                }
                
                // L칄캛EN칈 NEMOC칈 - pokud m치 item cures
                let curedText = '';
                const itemData = ITEMS.find(i => i.id === item.id);
                if (itemData?.cures && itemData.cures.length > 0 && typeof hasDisease === 'function') {
                    itemData.cures.forEach(diseaseId => {
                        if (hasDisease(diseaseId)) {
                            cureDisease(diseaseId);
                            const disease = DISEASES.find(d => d.id === diseaseId);
                            if (disease) {
                                curedText += `<br><span style="color: #4caf50;">九 Vyl칠캜eno: ${disease.icon} ${disease.name}</span>`;
                            }
                        }
                    });
                }
                
                // L칄캛EN칈 ZRAN캨N칈 - pokud m치 item healsInjuries
                let healedInjuriesText = '';
                if (itemData?.healsInjuries && itemData.healsInjuries.length > 0 && typeof hasInjury === 'function') {
                    itemData.healsInjuries.forEach(injuryId => {
                        if (hasInjury(injuryId)) {
                            healInjury(injuryId);
                            const injury = INJURIES.find(inj => inj.id === injuryId);
                            if (injury) {
                                healedInjuriesText += `<br><span style="color: #ff9800;">游뽗 O코et콏eno: ${injury.icon} ${injury.name}</span>`;
                            }
                        }
                    });
                }
                
                let bonusText = '';
                if (equipEffects.healBonus > 0) bonusText += '<br><span style="color: #81c784;">游낀 Bonus z vybaven칤! (+' + Math.round(equipEffects.healBonus * 100) + '%)</span>';
                if (compBonuses.healingBonus > 0) bonusText += '<br><span style="color: #81c784;">游 Bonus od spole캜n칤ka!</span>';
                if (npcBonuses.medicalTraining) bonusText += '<br><span style="color: #81c784;">游녿꽥뚯勇 Med. tr칠nink od doktora! (+25%)</span>';
                
                showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #8bc34a;">仇벒잺 +${healAmount} HP</span>${groupHealText}${curedText}${healedInjuriesText}${bonusText}`);
                
                // Daily quest progress
                if (state.dailyQuests?.progress) {
                    state.dailyQuests.progress.healed = (state.dailyQuests.progress.healed || 0) + healAmount;
                    checkDailyQuests();
                }
            } else if (item.effect === 'radiation') {
                state.status.radiation = Math.max(0, state.status.radiation + item.value);
                SoundSystem.play('pickup');
                
                // L칄캛EN칈 NEMOCI Z OZ츼콎EN칈 - pokud m치 item cures
                let curedText = '';
                const itemData = ITEMS.find(i => i.id === item.id);
                if (itemData?.cures && itemData.cures.length > 0 && typeof hasDisease === 'function') {
                    itemData.cures.forEach(diseaseId => {
                        if (hasDisease(diseaseId)) {
                            cureDisease(diseaseId);
                            const disease = DISEASES.find(d => d.id === diseaseId);
                            if (disease) {
                                curedText += `<br><span style="color: #4caf50;">九 Vyl칠캜eno: ${disease.icon} ${disease.name}</span>`;
                            }
                        }
                    });
                }
                
                showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #8bc34a;">驕뮖잺 ${item.value} radiace</span>${curedText}`);
            } else if (item.effect === 'rad_resist') {
                // Do캜asn치 odolnost radiaci
                if (!state.buffs) state.buffs = {};
                state.buffs.radResist = { value: item.value, until: Date.now() + 7200000 }; // 2 hodiny
                SoundSystem.play('pickup');
                showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #ffd700;">驕뮖잺 Odolnost radiaci +${item.value}% na 2 hodiny!</span>`);
                renderFull(); // Aktualizuj HUD s buffy
            } else if (item.effect === 'cure_disease') {
                // SPECI츼LN칈 EFEKT - l칠캜칤 nemoci
                SoundSystem.play('pickup');
                let curedText = '';
                let curedCount = 0;
                
                const itemData = ITEMS.find(i => i.id === item.id);
                if (itemData?.cures && itemData.cures.length > 0 && typeof hasDisease === 'function') {
                    itemData.cures.forEach(diseaseId => {
                        if (hasDisease(diseaseId)) {
                            cureDisease(diseaseId);
                            curedCount++;
                            const disease = DISEASES.find(d => d.id === diseaseId);
                            if (disease) {
                                curedText += `<br><span style="color: #4caf50;">九 Vyl칠캜eno: ${disease.icon} ${disease.name}</span>`;
                            }
                        }
                    });
                }
                
                // Pokud m치 i hodnotu (nap콏. 캜ist치 voda hydratuje)
                if (item.value && item.value > 0) {
                    state.status.thirst = Math.min(100, state.status.thirst + item.value);
                    curedText += `<br><span style="color: #2196f3;">游눦 +${item.value}% 쮂셬e켿</span>`;
                }
                
                if (curedCount > 0) {
                    showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #4caf50;">游낀 L칠캜ba 칰sp캩코n치!</span>${curedText}`);
                } else {
                    showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #888;">Nejsi nemocn칳, ale c칤t칤코 se l칠pe.</span>${item.value ? `<br><span style="color: #2196f3;">游눦 +${item.value}% 쮂셬e켿</span>` : ''}`);
                }
            } else if (item.effect === 'heal_injury') {
                // SPECI츼LN칈 EFEKT - l칠캜칤 zran캩n칤
                SoundSystem.play('pickup');
                let healedText = '';
                let healedCount = 0;
                
                const itemData = ITEMS.find(i => i.id === item.id);
                if (itemData?.healsInjuries && itemData.healsInjuries.length > 0 && typeof hasInjury === 'function') {
                    itemData.healsInjuries.forEach(injuryId => {
                        if (hasInjury(injuryId)) {
                            healInjury(injuryId);
                            healedCount++;
                            const injury = INJURIES.find(inj => inj.id === injuryId);
                            if (injury) {
                                healedText += `<br><span style="color: #4caf50;">九 O코et콏eno: ${injury.icon} ${injury.name}</span>`;
                            }
                        }
                    });
                }
                
                // Pokud m치 i hodnotu HP
                if (item.value && item.value > 0) {
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + item.value);
                    healedText += `<br><span style="color: #f44336;">仇벒잺 +${item.value} HP</span>`;
                }
                
                if (healedCount > 0) {
                    showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #4caf50;">游뽗 O코et콏en칤 칰sp캩코n칠!</span>${healedText}`);
                } else {
                    showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #888;">Nem치코 쮂멳n칠 zran캩n칤 k o코et콏en칤.</span>${item.value ? `<br><span style="color: #f44336;">仇벒잺 +${item.value} HP</span>` : ''}`);
                }
            } else if (item.effect === 'all_stats') {
                // Bonus ke v코em stat콢m do캜asn캩
                if (!state.buffs) state.buffs = {};
                state.buffs.allStats = { value: item.value, until: Date.now() + 7200000 }; // 2 hodiny
                SoundSystem.play('pickup');
                showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #ffd700;">九 +${item.value} ke v코em stat콢m na 2 hodiny!</span>`);
                renderFull(); // Aktualizuj HUD s buffy
            } else if (item.effect === 'special_alcohol') {
                // Alkohol - energie, sn칤쬰n칤 쮂셬n캩, do캜asn칳 damage buff
                if (!state.buffs) state.buffs = {};
                
                let energyBonus = 30;
                let thirstPenalty = 20;
                let damageBonus = 15;
                let healBonus = 0;
                let buffDuration = 2 * 60 * 60 * 1000; // 2 hodiny
                
                if (item.id === 'vodka') {
                    energyBonus = 40;
                    thirstPenalty = 25;
                    damageBonus = 20;
                } else if (item.id === 'wine') {
                    energyBonus = 25;
                    thirstPenalty = 15;
                    damageBonus = 0;
                    healBonus = 15;
                }
                
                state.status.energy = Math.min(100, state.status.energy + energyBonus);
                state.status.thirst = Math.max(0, state.status.thirst - thirstPenalty);
                if (healBonus > 0) {
                    state.char.hp = Math.min(state.char.maxHp || 100, state.char.hp + healBonus);
                }
                
                if (damageBonus > 0) {
                    state.buffs.alcoholDamage = { value: damageBonus, until: Date.now() + buffDuration };
                }
                
                SoundSystem.play('pickup');
                let resultText = `丘 +${energyBonus} energie<br>游눦 -${thirstPenalty} 쮂셬e켿`;
                if (healBonus > 0) resultText += `<br>仇벒잺 +${healBonus} HP`;
                if (damageBonus > 0) resultText += `<br><span style="color: #ffd700;">丘덢잺 +${damageBonus}% damage na 2 hodiny!</span>`;
                
                showModal('游꽄 Na zdrav칤!', `${item.icon} ${item.name}!<br>${resultText}`);
                addLog(`游꽄 Vypil jsi ${item.name}`, '游꽄');
                renderFull(); // Aktualizuj HUD s buffy
            } else if (item.buff) {
                // Buff lektvary (luck, strength, agility atd.)
                if (!state.buffs) state.buffs = {};
                
                const buffDuration = (item.duration || 300) * 1000; // v ms
                const buffName = item.buff;
                const buffValue = item.value;
                
                state.buffs[buffName] = { 
                    value: buffValue, 
                    until: Date.now() + buffDuration 
                };
                
                SoundSystem.play('pickup');
                
                // Popis buffu
                const buffDescriptions = {
                    luck: `游 +${buffValue}% 코ance na loot`,
                    strength: `游눩 +${buffValue} s칤la`,
                    agility: `游끢 +${buffValue} obratnost`,
                    perception: `游녜勇 +${buffValue} vn칤m치n칤`,
                    endurance: `游띠勇 +${buffValue} v칳dr`
                };
                
                const durationMin = Math.floor(buffDuration / 60000);
                showModal('九 Buff aktivov치n!', `
                    ${item.icon} ${item.name}!<br>
                    <span style="color: #ffd700;">${buffDescriptions[buffName] || `+${buffValue} ${buffName}`}</span><br>
                    <span style="color: #888;">Trv치n칤: ${durationMin} minut</span>
                `);
                addLog(`九 Aktivoval jsi ${item.name} - ${buffDescriptions[buffName] || buffName}`, '九');
                renderFull(); // Aktualizuj HUD s buffy
            } else if (item.effect === 'weapon_buff') {
                // Bonus k damage zbran캩
                if (!state.weaponBuff) state.weaponBuff = { damage: 0, fights: 0 };
                state.weaponBuff.damage += item.value;
                state.weaponBuff.fights += 10;
                SoundSystem.play('pickup');
                showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #ffd700;">丘덢잺 +${item.value} damage na 10 boj콢!</span>`);
            } else if (item.effect === 'repair') {
                // Opravn치 sada - najdi po코kozenou zbra켿/zbroj
                const damagedItems = state.inv.filter(i => i.durability !== undefined && i.durability < i.maxDurability);
                const equippedWeapon = state.equipped?.weapon;
                const equippedArmor = state.equipped?.armor;
                
                if (equippedWeapon && equippedWeapon.durability < equippedWeapon.maxDurability) {
                    damagedItems.unshift(equippedWeapon);
                }
                if (equippedArmor && equippedArmor.durability < equippedArmor.maxDurability) {
                    damagedItems.unshift(equippedArmor);
                }
                
                if (damagedItems.length === 0) {
                    showModal('Opravn치 sada', 'Nem치코 쮂멳n칠 po코kozen칠 vybaven칤!');
                    return; // Nespot콏ebov치vej
                }
                
                // Zobraz v칳b캩r
                showModal('游댢 Opravn치 sada', `
                    <p style="margin-bottom: 1rem;">Vyber vybaven칤 k oprav캩 (+${item.value} durability):</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${damagedItems.map((di, idx) => `
                            <button class="btn" onclick="repairWithKit('${item.id}', ${idx})" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${di.icon} ${di.name}</span>
                                <span style="color: #ff9800;">${di.durability}/${di.maxDurability}</span>
                            </button>
                        `).join('')}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">仇 Zru코it</button>
                `);
                // Ulo쮂셠e po코kozen칠 itemy pro pozd캩j코칤 p콏칤stup
                window._damagedItems = damagedItems;
                return; // Nespot콏ebov치vej je코t캩
            } else if (item.effect !== 'sleep') {
                // Standardn칤 efekty (hunger, thirst, energy)
                let effectValue = item.value;
                
                // 游꿌勇 Vojensk칳 tr칠nink - survival bonus (+5% efektivita j칤dla/vody za ka쬯칳 tr칠nink)
                if ((item.effect === 'hunger' || item.effect === 'thirst') && state.trainingBonuses?.survival > 0) {
                    effectValue = Math.floor(effectValue * (1 + state.trainingBonuses.survival));
                }
                
                // 游꺘勇 Exotic bonus - Exotick칠 ko콏en칤 (dvojn치sobn칳 efekt j칤dla)
                if (item.effect === 'hunger' && state.exoticBonuses?.foodBoost > 0) {
                    effectValue = effectValue * 2;
                    state.exoticBonuses.foodBoost--;
                }
                
                state.status[item.effect] = Math.min(100, state.status[item.effect] + effectValue);
                SoundSystem.play('pickup');
                const effectNames = { hunger: '游꼤 Hlad', thirst: '游눦 콯칤ze켿', energy: '丘 Energie' };
                
                // APLIKACE SECONDARY EFEKT콡 (hp, energy, thirst z uva콏en칳ch j칤del)
                // Fallback: na캜ti secondary z receptu pokud item nem치 (star코칤 ulo쬰n칠 hry)
                let secondary = item.secondary;
                if (!secondary) {
                    const recipe = typeof CRAFTING !== 'undefined' ? CRAFTING.find(r => r.id === item.id) : null;
                    if (recipe?.result?.secondary) {
                        secondary = recipe.result.secondary;
                    }
                }
                
                let secondaryText = '';
                if (secondary) {
                    if (secondary.hp) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + secondary.hp);
                        secondaryText += `<br><span style="color: #f44336;">仇벒잺 HP +${secondary.hp}</span>`;
                    }
                    if (secondary.energy) {
                        state.status.energy = Math.min(100, state.status.energy + secondary.energy);
                        secondaryText += `<br><span style="color: #ffc107;">丘 Energie +${secondary.energy}%</span>`;
                    }
                    if (secondary.thirst) {
                        state.status.thirst = Math.min(100, state.status.thirst + secondary.thirst);
                        secondaryText += `<br><span style="color: #2196f3;">游눦 콯칤ze켿 +${secondary.thirst}%</span>`;
                    }
                    if (secondary.hunger) {
                        state.status.hunger = Math.min(100, state.status.hunger + secondary.hunger);
                        secondaryText += `<br><span style="color: #8bc34a;">游꼤 Hlad +${secondary.hunger}%</span>`;
                    }
                }
                
                // Vtipn치 hl치코ka pro j칤dlo
                let foodHumor = '';
                if (item.effect === 'hunger') {
                    foodHumor = '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin-top: 0.5rem;">"' + getRandomHumor('foodWeird') + '"</p>';
                    
                    // KONTROLA OTRAVY Z J칈DLA
                    if (typeof checkFoodPoisoning === 'function') {
                        checkFoodPoisoning(item.id);
                    }
                }
                // Zobraz bonus pokud je aktivn칤
                const bonusText = (item.effect === 'hunger' || item.effect === 'thirst') && state.trainingBonuses?.survival > 0 
                    ? `<br><span style="color: #ffd700; font-size: 0.8rem;">游꿌勇 Survival bonus: +${Math.floor(state.trainingBonuses.survival * 100)}%</span>` 
                    : '';
                showModal('Pou쬴to', `${item.icon} ${item.name}!<br><span style="color: #8bc34a;">${effectNames[item.effect] || item.effect} +${effectValue}%</span>${secondaryText}${bonusText}${foodHumor}`);
            }
            
            // Don't consume sleeping bag - it's reusable
            if (item.effect !== 'sleep') {
                removeItemFromInventory(item, 1);
            }
            
            // D콡LE콯IT칄: Ulo hru po pou쬴t칤 itemu!
            saveGame(true);
            renderFull();
        }
        
        // Pou쬴t칤 srdce behemota - +50 max HP permanentn캩
        function useMutantHeart() {
            const heart = state.inv.find(i => i.id === 'mutant_heart');
            if (!heart) return;
            
            // Ozna캜 jako pou쬴t칠
            if (!state.secrets) state.secrets = [];
            state.secrets.push('used_mutant_heart');
            
            // P콏idej +50 max HP
            state.char.maxHp += 50;
            state.char.hp += 50; // Vyl칠캜 o stejnou hodnotu
            
            // Odeber srdce z invent치콏e
            removeItemFromInventory(heart, 1);
            
            addLog('游눞 Absorboval jsi s칤lu srdce Behemotha! +50 Max HP', '九');
            
            closeModal();
            showModal('游눞 S칈LA ABSORBOV츼NA!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; animation: pulse 1s infinite;">游눩</div>
                    <h2 style="color: #9c27b0; margin: 0.5rem 0; text-shadow: 0 0 20px #9c27b0;">+50 Max HP!</h2>
                    <p style="color: #888;">C칤t칤코 jak tv칳m t캩lem proud칤 ob콏칤 s칤la.</p>
                    <p style="color: #8bc34a; margin-top: 1rem;">Nov칠 max HP: <strong>${state.char.maxHp}</strong></p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">C칤t칤m se MOCN칗!</button>
            `);
            
            saveGame();
            renderFull();
        }
        
        // AI CHIP - vylep코en칤 zbran캩 nebo zbroje o +10
        function showAIChipUpgradeModal() {
            const chip = state.inv.find(i => i.id === 'ai_chip');
            if (!chip) return;
            
            // Najdi zbran캩 a zbroje v invent치콏i
            const weapons = state.inv.filter(i => i.type === 'weapon' && i.damage);
            const armors = state.inv.filter(i => (i.type === 'armor' || i.type === 'helmet' || i.type === 'boots' || i.type === 'gloves') && i.defense !== undefined);
            
            // P콏idej nasazen칠 p콏edm캩ty
            if (state.equipped?.weapon && state.equipped.weapon.damage) {
                weapons.unshift({ ...state.equipped.weapon, equipped: true });
            }
            if (state.equipped?.armor && state.equipped.armor.defense !== undefined) {
                armors.unshift({ ...state.equipped.armor, equipped: true });
            }
            if (state.equipped?.helmet && state.equipped.helmet.defense !== undefined) {
                armors.unshift({ ...state.equipped.helmet, equipped: true });
            }
            if (state.equipped?.boots && state.equipped.boots.defense !== undefined) {
                armors.unshift({ ...state.equipped.boots, equipped: true });
            }
            if (state.equipped?.gloves && state.equipped.gloves.defense !== undefined) {
                armors.unshift({ ...state.equipped.gloves, equipped: true });
            }
            
            let weaponsHtml = weapons.length > 0 ? weapons.map((w, i) => `
                <div onclick="upgradeItemWithAI('weapon', ${i})" style="cursor: pointer; background: #1a2a1a; padding: 0.6rem; margin: 0.3rem 0; border-radius: 6px; border: 1px solid #4caf50; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 1.3rem;">${w.icon || '丘덢잺'}</span>
                        <span style="color: #fff;">${w.name}</span>
                        ${w.equipped ? '<span style="color: #ffd700; font-size: 0.7rem;"> (nasazeno)</span>' : ''}
                    </div>
                    <div style="color: #ff6b6b;">
                        ${w.damage}  <span style="color: #4caf50; font-weight: bold;">${w.damage + 10}</span> DMG
                    </div>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">콯치dn칠 zbran캩</p>';
            
            let armorsHtml = armors.length > 0 ? armors.map((a, i) => `
                <div onclick="upgradeItemWithAI('armor', ${i})" style="cursor: pointer; background: #1a1a2a; padding: 0.6rem; margin: 0.3rem 0; border-radius: 6px; border: 1px solid #2196f3; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 1.3rem;">${a.icon || '游띠勇'}</span>
                        <span style="color: #fff;">${a.name}</span>
                        ${a.equipped ? '<span style="color: #ffd700; font-size: 0.7rem;"> (nasazeno)</span>' : ''}
                    </div>
                    <div style="color: #64b5f6;">
                        ${a.defense}  <span style="color: #4caf50; font-weight: bold;">${a.defense + 10}</span> DEF
                    </div>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">콯치dn칠 zbroje</p>';
            
            // Ulo seznamy pro pou쬴t칤 v upgradeItemWithAI
            window._aiUpgradeWeapons = weapons;
            window._aiUpgradeArmors = armors;
            
            showModal('游 AI Procesorov칠 j치dro', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游</div>
                    <p style="color: #9c27b0;">Vyber p콏edm캩t k vylep코en칤 (+10)</p>
                </div>
                
                <h4 style="color: #ff6b6b; margin: 0.5rem 0;">丘덢잺 Zbran캩 (+10 DMG)</h4>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${weaponsHtml}
                </div>
                
                <h4 style="color: #64b5f6; margin: 0.8rem 0 0.5rem 0;">游띠勇 Zbroje (+10 DEF)</h4>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${armorsHtml}
                </div>
                
                <p style="color: #888; font-size: 0.8rem; margin-top: 1rem; text-align: center;">
                    游눠 AI chip bude spot콏ebov치n
                </p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">仇 Zru코it</button>
            `);
        }
        
        function upgradeItemWithAI(type, index) {
            const chip = state.inv.find(i => i.id === 'ai_chip');
            if (!chip) return;
            
            let item, isEquipped = false;
            
            if (type === 'weapon') {
                item = window._aiUpgradeWeapons[index];
                if (item.equipped) {
                    isEquipped = true;
                    state.equipped.weapon.damage += 10;
                    item = state.equipped.weapon;
                } else {
                    const invItem = state.inv.find(i => i.id === item.id && i.damage === item.damage);
                    if (invItem) {
                        invItem.damage += 10;
                        item = invItem;
                    }
                }
            } else {
                item = window._aiUpgradeArmors[index];
                if (item.equipped) {
                    isEquipped = true;
                    // Najdi ve kter칠m slotu je
                    if (state.equipped.armor?.id === item.id && state.equipped.armor?.defense === item.defense) {
                        state.equipped.armor.defense += 10;
                        item = state.equipped.armor;
                    } else if (state.equipped.helmet?.id === item.id && state.equipped.helmet?.defense === item.defense) {
                        state.equipped.helmet.defense += 10;
                        item = state.equipped.helmet;
                    } else if (state.equipped.boots?.id === item.id && state.equipped.boots?.defense === item.defense) {
                        state.equipped.boots.defense += 10;
                        item = state.equipped.boots;
                    } else if (state.equipped.gloves?.id === item.id && state.equipped.gloves?.defense === item.defense) {
                        state.equipped.gloves.defense += 10;
                        item = state.equipped.gloves;
                    }
                } else {
                    const invItem = state.inv.find(i => i.id === item.id && i.defense === item.defense);
                    if (invItem) {
                        invItem.defense += 10;
                        item = invItem;
                    }
                }
            }
            
            // Odeber AI chip
            removeItemFromInventory(chip, 1);
            
            const statName = type === 'weapon' ? 'DMG' : 'DEF';
            const statValue = type === 'weapon' ? item.damage : item.defense;
            
            addLog(`游 Vylep코eno: ${item.name} (+10 ${statName})`, '九');
            
            closeModal();
            showModal('游 VYLEPENO!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${item.icon || (type === 'weapon' ? '丘덢잺' : '游띠勇')}</div>
                    <h3 style="color: #9c27b0; margin: 0.5rem 0;">${item.name}</h3>
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4caf50;">
                        <p style="color: #4caf50; font-size: 1.3rem; margin: 0;">
                            ${type === 'weapon' ? '丘덢잺' : '游띠勇'} <strong>+10 ${statName}</strong>
                        </p>
                        <p style="color: #888; margin: 0.5rem 0 0 0;">Nov치 hodnota: <span style="color: #ffd700; font-weight: bold;">${statValue}</span></p>
                    </div>
                    <p style="color: #888; font-size: 0.85rem;">AI procesor byl integrov치n do p콏edm캩tu.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #9c27b0, #673ab7);">游 V칳born캩!</button>
            `);
            
            saveGame();
            renderFull();
        }
        
        // Pomocn치 funkce pro opravu s opravnou sadou
        function repairWithKit(kitId, damagedIndex) {
            const kit = state.inv.find(i => i.id === kitId);
            if (!kit || !window._damagedItems) return;
            
            const damagedItem = window._damagedItems[damagedIndex];
            if (!damagedItem) return;
            
            // Oprav
            damagedItem.durability = Math.min(damagedItem.maxDurability, damagedItem.durability + kit.value);
            
            // Spot콏ebuj kit
            kit.count--;
            if (kit.count <= 0) {
                state.inv = state.inv.filter(i => i.id !== kitId);
            }
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('游댢 Opraveno!', `${damagedItem.icon} ${damagedItem.name}<br><span style="color: #8bc34a;">Durability: ${damagedItem.durability}/${damagedItem.maxDurability}</span>`);
            
            delete window._damagedItems;
            saveGame(true);
            renderFull();
        }
        
        function repairItem(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item || item.durability === undefined) return;
            
            if (item.durability >= item.maxDurability) {
                showModal('Oprava', `${item.icon} ${item.name} je v perfektn칤m stavu!`);
                return;
            }
            
            // Calculate repair cost (based on missing durability and item rarity)
            const missingDur = item.maxDurability - item.durability;
            const rarityMultiplier = {
                'common': 1,
                'uncommon': 1.5,
                'rare': 2,
                'epic': 3,
                'legendary': 5
            }[item.rarity] || 1;
            
            let baseCost = Math.ceil(missingDur * 0.2 * rarityMultiplier); // Sn칤쬰no z 0.5 na 0.2
            
            // Repair skill reduces cost
            const repairLevel = state.skills['repair'] || 0;
            if (repairLevel > 0) {
                const skill = SKILLS.find(s => s.id === 'repair');
                const discount = skill.value * repairLevel; // 50% per level
                baseCost = Math.ceil(baseCost * (1 - discount));
            }
            
            const metalCost = Math.max(1, Math.ceil(baseCost * 0.6));
            const stoneCost = Math.max(1, Math.ceil(baseCost * 0.4));
            
            // Check if player has resources
            if (state.resources.metal < metalCost || state.resources.stone < stoneCost) {
                showModal('Oprava', 
                    `<p>${currentLang === "en" ? "Not enough resources for repair!" : "Nem치코 dost surovin na opravu!"}</p>` +
                    `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                    `<p>丘뙖잺 ${currentLang === "en" ? `Need: ${metalCost} metal (have ${state.resources.metal})` : `Pot콏ebuje코: ${metalCost} kovu (m치코 ${state.resources.metal})`}</p>` +
                    `<p>游 ${currentLang === "en" ? `Need: ${stoneCost} stone (have ${state.resources.stone})` : `Pot콏ebuje코: ${stoneCost} kamene (m치코 ${state.resources.stone})`}</p>` +
                    `</div>`
                );
                return;
            }
            
            // Perform repair
            state.resources.metal -= metalCost;
            state.resources.stone -= stoneCost;
            item.durability = item.maxDurability;
            
            SoundSystem.play('pickup');
            showModal('九 Opraveno!', 
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${item.icon}</div>` +
                `<h3>${item.name}</h3>` +
                `<p style="color: #8bc34a; margin: 1rem 0;">游댢 Opraveno na ${item.maxDurability}/${item.maxDurability}!</p>` +
                `<p style="color: #999; font-size: 0.85rem;">Spot콏ebov치no: ${metalCost} kovu, ${stoneCost} kamene</p>` +
                `</div>`
            );
            addLog(`Opravil jsi ${item.name}`, '游댢');
            renderFull();
        }
        
        function applyWeaponCoatingByIndex(idx) {
            const coating = state.inv[idx];
            if (!coating) return;
            applyWeaponCoating(coating.id);
        }
        
        function applyWeaponCoating(coatingId) {
            const coating = state.inv.find(i => i.id === coatingId);
            if (!coating || coating.type !== 'weapon_coating') return;
            
            const weapon = state.equipped?.weapon;
            if (!weapon) {
                showModal('仇 콯치dn치 zbra켿', '<p>Nem치코 nasazenou 쮂멳nou zbra켿 na kterou bys mohl aplikovat povlak!</p>');
                return;
            }
            
            // Check if weapon already has coating
            if (state.weaponCoating && state.weaponCoating.uses > 0) {
                showModal('丘멆잺 Ji pokryt치 zbra켿', 
                    `<p>Tvoje zbra켿 u m치 povlak (${state.weaponCoating.effect}, zb칳v치 ${state.weaponCoating.uses} pou쬴t칤).</p>` +
                    `<p style="color: #ff9800;">Chce코 ho nahradit?</p>` +
                    `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">` +
                    `<button class="btn" onclick="closeModal()" style="background: #555;">Ne</button>` +
                    `<button class="btn" onclick="confirmApplyCoating('${coatingId}')" style="background: var(--toxic-dark);">Ano, nahradit</button>` +
                    `</div>`
                );
                return;
            }
            
            confirmApplyCoating(coatingId);
        }
        
        function confirmApplyCoating(coatingId) {
            const coating = state.inv.find(i => i.id === coatingId);
            if (!coating) return;
            
            const weapon = state.equipped?.weapon;
            
            // Apply coating
            state.weaponCoating = {
                effect: coating.effect,
                uses: coating.uses || 5
            };
            
            // Remove coating item
            if (coating.count > 1) {
                coating.count--;
            } else {
                state.inv = state.inv.filter(i => i.id !== coatingId);
            }
            
            const effectName = coating.effect === 'poison' ? '驕멆잺 Jedov칳' : '游댠 Z치paln칳';
            
            closeModal();
            showModal('九 Povlak aplikov치n!', 
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${weapon.icon}</div>` +
                `<h3>${weapon.name}</h3>` +
                `<p style="color: #8bc34a; margin: 1rem 0;">${effectName} povlak aplikov치n!</p>` +
                `<p style="color: #888;">Vydr쮂 ${state.weaponCoating.uses} boj콢.</p>` +
                `</div>`
            );
            addLog(`Aplikoval jsi ${coating.name} na ${weapon.name}`, coating.icon);
            renderFull();
        }
        
        function buildBuilding(id) {
            // Redirect to unified building function
            buildUnifiedBuilding(id);
        }
        
        // Store item in base
        function storeInBase(itemIdx) {
            const item = state.inv[itemIdx];
            if (!item || item.type === 'money') return; // Can't store money
            
            // Kontrola jestli je hr치캜 v osad캩
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('游늸 Mus칤코 b칳t v osad캩', 'Pro ukl치d치n칤 v캩c칤 se vra콘 do osady!');
                return;
            }
            
            // Kontrola jestli m치 postavenou budovu Sklad (krom캩 j칤dla a vody)
            const hasStorage = state.base?.includes('storage') || state.settlement?.buildings?.includes('storage');
            const isFoodOrWater = item.id === 'food' || item.id === 'water' || item.id === 'canned_food' || item.id === 'clean_water';
            
            if (!hasStorage && !isFoodOrWater) {
                showModal('游끵勇 Pot콏ebuje코 Sklad!', `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游닍</div>
                        <p style="color: #ff9800; margin-bottom: 1rem;">Pro ukl치d치n칤 p콏edm캩t콢 mus칤코 postavit budovu <strong>Sklad</strong>!</p>
                        <p style="color: #888; font-size: 0.85rem;">Bez skladu m콢쬰코 ukl치dat pouze j칤dlo a vodu.</p>
                        <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">Cena: 15 d콏eva, 10 kamene</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">OK</button>
                `);
                return;
            }
            
            if (state.baseItems.length >= state.baseCapacity) {
                showModal('Pln칳 칰kryt!', 'Nem치코 m칤sto v 칰krytu! Postav Sklad pro v칤ce m칤sta.');
                return;
            }
            
            // Remove from inventory and add to base
            if (item.count && item.count > 1) {
                // Stackovan칳 item - p콏esunout 1 kus
                item.count--;
                
                // Zkus naj칤t existuj칤c칤 stack v baseItems
                const existingInBase = state.baseItems.find(i => i.id === item.id && i.type === item.type);
                if (existingInBase) {
                    existingInBase.count = (existingInBase.count || 1) + 1;
                } else {
                    state.baseItems.push({...item, count: 1});
                }
            } else {
                // Jedin칳 kus - zkus stackovat nebo p콏idej nov칳
                const existingInBase = state.baseItems.find(i => i.id === item.id && i.type === item.type);
                if (existingInBase && (item.type === 'consumable' || item.type === 'ammo' || item.type === 'throwable')) {
                    existingInBase.count = (existingInBase.count || 1) + (item.count || 1);
                    state.inv.splice(itemIdx, 1);
                } else {
                    state.baseItems.push(item);
                    state.inv.splice(itemIdx, 1);
                }
            }
            
            addLog(`Ulo쬴l jsi ${item.icon} ${item.name} do 칰krytu`, '游닍');
            updateCarryWeight();
            renderFull();
        }
        
        // Take item from base
        function takeFromBase(itemIdx) {
            // Kontrola jestli je hr치캜 v osad캩
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('游늸 Mus칤코 b칳t v osad캩', 'Pro vyb칤r치n칤 v캩c칤 se vra콘 do osady!');
                return;
            }
            
            const item = state.baseItems[itemIdx];
            if (!item) return;
            
            // Check weight
            if (!canAddItem(item, 1)) {
                SoundSystem.play('error');
                showModal('P콏칤li코 t캩쬶칠!', ('Nem치코 m칤sto v invent치콏i!'));
                return;
            }
            
            // Add to inventory
            if (item.type === 'consumable') {
                const existing = state.inv.find(i => i.id === item.id);
                if (existing) {
                    existing.count = (existing.count || 1) + (item.count || 1);
                } else {
                    state.inv.push({...item});
                }
            } else {
                state.inv.push({...item});
            }
            
            // Remove from base
            state.baseItems.splice(itemIdx, 1);
            
            addLog(`Vzal jsi ${item.icon} ${item.name} z 칰krytu`, '游닋');
            updateCarryWeight();
            renderFull();
            showStorageModal();
        }
        

// Fullscreen hex mapa odstran캩na - pou쬴j WORLD_LOCATIONS syst칠m
function openFullscreenMap() {
    // P콏esm캩ruj na nov칳 world map syst칠m
    showModal('游딬勇 Mapa', '<p>Pou쬴j z치lo쬶u Mapa pro zobrazen칤 sv캩ta.</p><button class=\"btn\" onclick=\"closeModal(); switchTab(\'map\')" style=\"width: 100%; margin-top: 1rem;\">游딬勇 Otev콏칤t mapu</button>');
}

        function toggleBase() {
            // V nov칠m syst칠mu: toggle mezi "uvnit콏 칰krytu" a "venku u 칰krytu"
            // M콢쬰코 to ud캩lat jen kdy jsi v shelter lokaci
            
            if (isPlayerTraveling()) {
                showModal('Nelze', 'Nem콢쬰코 vstoupit/opustit 칰kryt b캩hem cestov치n칤!');
                return;
            }
            
            // V nov칠m WORLD syst칠mu: hr치캜 mus칤 b칳t v 'shelter' lokaci
            if (state.world.currentLocation !== 'shelter') {
                showModal('P콏칤li코 daleko', 'Mus칤코 b칳t ve sv칠m 칰krytu abys mohl vstoupit dovnit콏!');
                return;
            }
            
            // Toggle stavu (uvnit콏/venku u shelter)
            state.map.inBase = !state.map.inBase;
            renderFull();
        }
        
        function collectStorage() {
            let collected = [];
            
            // Collect food
            if (state.baseStorage.food > 0) {
                const foodItem = ITEMS.find(i => i.id === 'food');
                const existing = state.inv.find(i => i.id === 'food');
                if (existing) {
                    existing.count = (existing.count || 1) + state.baseStorage.food;
                } else {
                    state.inv.push({...foodItem, count: state.baseStorage.food});
                }
                collected.push(`游볾 ${state.baseStorage.food}x J칤dlo`);
                state.baseStorage.food = 0;
            }
            
            // Collect water
            if (state.baseStorage.water > 0) {
                const waterItem = ITEMS.find(i => i.id === 'water');
                const existing = state.inv.find(i => i.id === 'water');
                if (existing) {
                    existing.count = (existing.count || 1) + state.baseStorage.water;
                } else {
                    state.inv.push({...waterItem, count: state.baseStorage.water});
                }
                collected.push(`游눦 ${state.baseStorage.water}x Voda`);
                state.baseStorage.water = 0;
            }
            
            if (collected.length > 0) {
                showModal('Sebr치no!', collected.join('<br>'));
            } else {
                showModal('Pr치zdn칠', 'Ve skladu nic nen칤.');
            }
            
            renderFull();
        }
        
        // === CRAFTING ===
        // Helper pro renderov치n칤 crafting recept콢
        function renderCraftingRecipes() {
            const hasWorkshop = state.base.includes('workshop');
            const isTraveling = state.map.traveling;
            const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
            
            // Filtruj recepty - legend치rn칤 jen pokud m치 skill
            const filteredRecipes = CRAFTING.filter(r => {
                // Filtr podle kategorie
                if (state.craftFilter && state.craftFilter !== 'all' && r.category !== state.craftFilter) return false;
                // Legend치rn칤 recepty jen se skillem
                if (r.legendaryRequired && !hasLegendarySmith) return false;
                return true;
            });
            
            const portableRecipes = filteredRecipes.filter(r => r.portable === true);
            const workshopRecipes = filteredRecipes.filter(r => r.portable !== true);
            
            const resourceIcons = {
                wood: '游', metal: '丘뙖잺', stone: '游', cloth: '游빗', leather: '游붮',
                herbs: '游', chemicals: '游빍', glass: '游댩', electronics: '游', fuel: '久',
                rope: '俱', raw_meat: '游볼', fish: '游', gunpowder: '游눤', copper: '游릯',
                scrap: '游댤', mutant_blood: '游뽖', acid: '游릭', crystal: '游', silver: '拘', gold: '游리', gems: '游눑',
                deathclaw_hand: '游붔'
            };
            
            const catColors = {
                weapon: '#c62828', armor: '#1976d2', medical: '#d32f2f', 
                food: '#ff9800', tool: '#388e3c', ammo: '#7b1fa2', special: '#ffd700',
                legendary: '#ff6600'
            };
            
            const renderRecipe = (recipe, canCraftAny) => {
                const engineerReduction = hasClassPassive('craftCostReduction') ? 0.5 : 1.0;
                const adjustedRequires = {};
                Object.entries(recipe.requires).forEach(([res, amt]) => {
                    adjustedRequires[res] = Math.ceil(amt * engineerReduction);
                });
                
                const needsWorkshop = recipe.portable !== true;
                // Portable = pouze invent치콏, D칤lna = invent치콏 + sklad osady
                const useSettlement = needsWorkshop;
                const canCraft = canCraftAny && (!needsWorkshop || hasWorkshop) && Object.entries(adjustedRequires).every(([res, amt]) => getTotalResource(res, useSettlement) >= amt);
                const isLocked = needsWorkshop && !hasWorkshop;
                
                // Rarity
                const rarity = recipe.result.rarity;
                const rarityColor = RARITY_COLORS[rarity] || '#9e9e9e';
                const rarityName = getRarityName(rarity) || '';
                
                // Translated name
                const recipeName = getCraftingName(recipe.id);
                
                let resultDesc = '';
                if (recipe.result.type === 'weapon') {
                    resultDesc = '丘덢잺 ' + recipe.result.damage + ' DMG';
                } else if (recipe.result.type === 'armor') {
                    resultDesc = '游띠勇 ' + recipe.result.defense + ' DEF';
                } else if (recipe.result.type === 'consumable') {
                    if (recipe.result.effect === 'health') resultDesc = '仇벒잺 +' + recipe.result.value + ' HP';
                    else if (recipe.result.effect === 'thirst') resultDesc = '游눦 +' + recipe.result.value + '%';
                    else if (recipe.result.effect === 'hunger') resultDesc = '游꼤 +' + recipe.result.value + '%';
                    else if (recipe.result.effect === 'energy') resultDesc = '丘 +' + recipe.result.value + '%';
                    else if (recipe.result.effect === 'radiation') resultDesc = '驕뮖잺 ' + recipe.result.value;
                    else if (recipe.result.effect === 'repair') resultDesc = '游댢 +' + recipe.result.value + ' v칳dr';
                    
                    // P콏idej secondary efekty
                    if (recipe.result.secondary) {
                        const sec = recipe.result.secondary;
                        if (sec.hp) resultDesc += ' 仇벒잺+' + sec.hp;
                        if (sec.thirst) resultDesc += ' 游눦+' + sec.thirst;
                        if (sec.hunger) resultDesc += ' 游꼤+' + sec.hunger;
                        if (sec.energy) resultDesc += ' 丘+' + sec.energy;
                    }
                } else if (recipe.result.type === 'tool') {
                    resultDesc = recipe.result.desc || '游댢 ' + recipe.result.bonus;
                } else if (recipe.result.type === 'throwable') {
                    resultDesc = recipe.result.damage ? '游눤 ' + recipe.result.damage + ' DMG' : '游눧 ' + recipe.result.effect;
                } else if (recipe.result.type === 'ammo') {
                    resultDesc = '游낓 ' + recipe.result.count + 'x';
                } else if (recipe.result.type === 'weapon_coating') {
                    resultDesc = (recipe.result.effect === 'poison' ? '驕멆잺' : '游댠') + ' ' + recipe.result.uses + 'x ' + ('pou쬴t칤');
                } else if (recipe.result.type === 'accessory') {
                    resultDesc = recipe.result.desc || ('游눐 Dopln캩k');
                } else if (recipe.result.type === 'defense') {
                    resultDesc = '游띠勇 +' + recipe.result.value + ' obrana';
                }
                
                const reqHtml = Object.entries(adjustedRequires).map(([res, amt]) => {
                    const icon = resourceIcons[res] || '游닍';
                    const has = getTotalResource(res, useSettlement);
                    const color = has >= amt ? '#8bc34a' : '#c62828';
                    return '<span style="color: ' + color + ';">' + icon + amt + '</span>';
                }).join(' ');
                
                return '<div class="card" onclick="showCraftDetail(\'' + recipe.id + '\')" style="cursor: pointer; ' + (!canCraft ? 'opacity: 0.6;' : '') + ' border-left: 3px solid ' + (rarity ? rarityColor : (catColors[recipe.category] || '#d4722e')) + '; min-width: 130px;">' +
                    (isLocked ? '<div style="position: absolute; top: 5px; right: 5px; font-size: 1rem;">游</div>' : '') +
                    '<div style="font-size: 2rem; text-align: center;">' + recipe.icon + '</div>' +
                    '<h3 style="text-align: center; margin: 0.2rem 0; font-size: 0.85rem; color: ' + rarityColor + ';">' + recipeName + '</h3>' +
                    (rarityName ? '<p style="text-align: center; font-size: 0.6rem; color: ' + rarityColor + '; margin: 0; text-transform: uppercase;">' + rarityName + '</p>' : '') +
                    '<p style="text-align: center; color: #8bc34a; font-size: 0.75rem; margin: 0.2rem 0;">' + resultDesc + '</p>' +
                    '<p style="text-align: center; font-size: 0.7rem; margin-top: 0.3rem; color: #999;">' + reqHtml + '</p>' +
                '</div>';
            };
            
            let html = '';
            
            // P콎ENOSN칄
            html += '<div style="margin-bottom: 1.5rem;">';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid #4CAF50;">';
            html += '<span style="font-size: 1.3rem;">游</span>';
            html += '<h3 style="margin: 0; color: #8bc34a;">' + ('NA CEST캨') + '</h3>';
            html += '<span style="font-size: 0.75rem; color: #666; margin-left: auto;">' + (isTraveling ? ('游뛌 Cestuje코...') : ('九 Lze vyr치b캩t')) + '</span>';
            html += '</div>';
            
            if (portableRecipes.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.6rem;">';
                portableRecipes.forEach(r => { html += renderRecipe(r, !isTraveling); });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center; padding: 1rem;">콯치dn칠 p콏enosn칠 recepty v t칠to kategorii</p>';
            }
            html += '</div>';
            
            // D칈LNA
            html += '<div>';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid ' + (hasWorkshop ? '#2196f3' : '#c62828') + ';">';
            html += '<span style="font-size: 1.3rem;">游댢</span>';
            html += '<h3 style="margin: 0; color: ' + (hasWorkshop ? '#64b5f6' : '#ef5350') + ';">' + ('D칈LNA') + '</h3>';
            html += '<span style="font-size: 0.75rem; color: #666; margin-left: auto;">' + (hasWorkshop ? (isTraveling ? ('游뛌 Vra콘 se do 칰krytu') : ('九 D칤lna dostupn치')) : ('游 Postav d칤lnu v 칰krytu')) + '</span>';
            html += '</div>';
            
            if (workshopRecipes.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.6rem;">';
                workshopRecipes.forEach(r => { html += renderRecipe(r, hasWorkshop && !isTraveling); });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center; padding: 1rem;">콯치dn칠 d칤lensk칠 recepty v t칠to kategorii</p>';
            }
            html += '</div>';
            
            return html;
        }
        
        function filterCraft(category) {
            state.craftFilter = category;
            renderFull();
        }
        
        // Zobrazen칤 detailu craftable itemu
        function showCraftDetail(recipeId) {
            const recipe = CRAFTING.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Engineer class = 50% reduction, Technik companion skill = dal코칤 redukce
            let engineerReduction = hasClassPassive('craftCostReduction') ? 0.5 : 1.0;
            const companionBonuses = getAllCompanionBonuses();
            if (companionBonuses.craftCostReduction > 0) {
                engineerReduction = engineerReduction * (1 - companionBonuses.craftCostReduction);
            }
            
            // Check if can craft - portable v캩ci nepot콏ebuj칤 d칤lnu
            const needsWorkshop = recipe.portable !== true;
            const useSettlement = needsWorkshop; // D칤lna = invent치콏 + sklad
            let canCraft = (!needsWorkshop || state.base.includes('workshop')) && !state.map.traveling;
            const missingRes = [];
            
            for (const [res, amt] of Object.entries(recipe.requires)) {
                const adjustedAmt = Math.ceil(amt * engineerReduction);
                if (getTotalResource(res, useSettlement) < adjustedAmt) {
                    canCraft = false;
                    missingRes.push(res);
                }
            }
            
            // Get detailed info based on type
            let typeInfo = '';
            let usageInfo = '';
            
            if (recipe.result.type === 'weapon') {
                typeInfo = `<p style="color: #c62828; font-size: 1.1rem;">丘덢잺 Zbra켿 - ${recipe.result.damage} DMG</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Vyber v invent치콏i  Vybavit</p>
                    <p>游댢 <strong>Odolnost:</strong> 100/100 (opot콏ebov치v치 se bojem)</p>
                    ${recipe.result.special ? `<p>九 <strong>Speci치ln칤:</strong> ${recipe.result.special === 'poison' ? 'Otrava' : recipe.result.special === 'bleed' ? 'Krv치cen칤' : recipe.result.special === 'stun' ? 'Omr치캜en칤' : recipe.result.special === 'fire' ? 'Ohe켿' : recipe.result.special}</p>` : ''}
                    ${recipe.result.ammoType ? `<p>游댦 <strong>Munice:</strong> ${recipe.result.ammoType}</p>` : ''}
                `;
            } else if (recipe.result.type === 'armor') {
                const specialDescriptions = {
                    'rad_resist': '驕뮖잺 Odolnost radiaci (-30%)',
                    'rad_immune': '驕뮖잺 -50% radiace',
                    'powered': '丘 +5 obrana, +5 damage',
                    'stealth': '游봉 -50% p콏epaden칤, +15% dodge',
                    'berserker': '游놏 +30% damage, -3 obrana',
                    'phoenix': '游댠 P콏e쬴je코 smrt s 30% HP (1x za boj)',
                    'titan': '游 +5 obrana, imunita na krit',
                    'scout': '游끢 +15% dodge',
                    'medic': '游낀 +50% efektivita l칠캜en칤',
                    'mutant': '游빏 +50% odolnost radiace/jedy',
                    'exo': '游 +50% nosnost, +10% damage',
                    'nano': '游댧 +2 HP regenerace/kolo',
                    'intimidate': '游 +2 damage',
                    'scavenger': '游 +25% bonus loot',
                    'camo': '游 -30% n치hodn칠 souboje',
                    'nightvision': '游깿 +15% damage v noci',
                    'agile': '游끢 +10% dodge',
                    'endurance': '仇勇 -30% ztr치ta energie',
                    'block': '游띠勇 +15% blok',
                    'block_bonus': '游띠勇 +10% blok',
                    'dodge_bonus': '游눧 +10% dodge',
                    'fireproof': '游댠 Imunita na ohe켿',
                    'insulated': '丘 Imunita na elekt콏inu'
                };
                const specialText = recipe.result.special ? (specialDescriptions[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #1976d2; font-size: 1.1rem;">游띠勇 Zbroj - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Vyber v invent치콏i  Vybavit</p>
                    <p>游댢 <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>九 <strong>Speci치ln칤:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'consumable') {
                const effectNames = { health: '仇벒잺 L칠캜en칤', hunger: '游꼤 Hlad', thirst: '游눦 콯칤ze켿', energy: '丘 Energie', radiation: '驕뮖잺 Radiace', repair: '游댢 Oprava', sleep: '游눣 Sp치nek' };
                typeInfo = `<p style="color: #ff9800; font-size: 1.1rem;">${effectNames[recipe.result.effect] || '游닍 Spot콏ebn칤'} ${recipe.result.value > 0 ? '+' : ''}${recipe.result.value}${recipe.result.effect === 'repair' ? ' durability' : '%'}</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Klikni v invent치콏i  Spot콏ebuje se</p>
                    ${recipe.result.secondary ? `<p>俱 <strong>Bonus:</strong> ${Object.entries(recipe.result.secondary).map(([key, val]) => {
                        const names = { hp: '仇벒잺 HP', thirst: '游눦 쮂셬e켿', energy: '丘 energie', radiation: '驕뮖잺 radiace' };
                        return `+${val} ${names[key] || key}`;
                    }).join(', ')}</p>` : ''}
                `;
            } else if (recipe.result.type === 'gloves') {
                const glovesSpecials = {
                    'block_bonus': '游띠勇 +10% 코ance na blok',
                    'unarmed_bonus': '游녥 +5 damage beze zbran캩',
                    'grip': '游꿢 +10% p콏esnost st콏elby',
                    'bleed_punch': '游뽖 칔tok p캩st칤 zp콢sob칤 krv치cen칤',
                    'power_punch': '游눩 +10 damage v boji zbl칤zka',
                    'medic_bonus': '游낀 +20% efektivita l칠캜en칤',
                    'rad_resist': '驕뮖잺 -20% radiace'
                };
                const specialText = recipe.result.special ? (glovesSpecials[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #ff9800; font-size: 1.1rem;">游볡 Rukavice - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Vyber v invent치콏i  Vybavit do slotu Ruce</p>
                    <p>游댢 <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>九 <strong>Speci치ln칤:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'boots') {
                const bootsSpecials = {
                    'dodge_bonus': '游눧 +10% 코ance na 칰hyb',
                    'speed_bonus': '游끢 +10% rychlost',
                    'stealth_move': '游봉 -20% 코ance na p콏epaden칤',
                    'run_bonus': '游끢 +15% rychlost 칰t캩ku',
                    'stomp': '游붰 Siln칳 kop (+8 damage)',
                    'jump': '游붖 +25% dodge',
                    'warm_feet': '仇勇 -15% ztr치ta energie',
                    'power_kick': '游 +20% rychlost, +10 defense',
                    'exo': '游 +50% nosnost, +10% damage'
                };
                const specialText = recipe.result.special ? (bootsSpecials[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #00bcd4; font-size: 1.1rem;">游 Boty - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Vyber v invent치콏i  Vybavit do slotu Boty</p>
                    <p>游댢 <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>九 <strong>Speci치ln칤:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'helmet') {
                const helmetSpecials = {
                    'crit_immune': '游띠勇 Imunita na kritick칠 z치sahy',
                    'rad_resist': '驕뮖잺 -30% radiace',
                    'night_vision': '游녜勇 No캜n칤 vid캩n칤',
                    'gas_filter': '驕勇 Imunita na jedy',
                    'headshot_protect': '游꿢 -50% damage na hlavu',
                    'flash_protect': '游눤 Ochrana p콏ed oslepen칤m'
                };
                const specialText = recipe.result.special ? (helmetSpecials[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #795548; font-size: 1.1rem;">久놾잺 Helma - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Vyber v invent치콏i  Vybavit do slotu Helma</p>
                    <p>游댢 <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>九 <strong>Speci치ln칤:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'tool') {
                typeInfo = `<p style="color: #388e3c; font-size: 1.1rem;">游댢 N치stroj</p>`;
                usageInfo = `
                    <p>游늷 <strong>Efekt:</strong> ${recipe.result.desc || 'Speci치ln칤 bonus'}</p>
                    <p>游눠 <strong>Tip:</strong> ${recipe.result.bonus === 'capacity' ? 'Automaticky zv칳코칤 nosnost kdy je v invent치콏i' : recipe.result.bonus === 'fishing' ? 'Pot콏ebuje코 pro ryba콏en칤' : recipe.result.bonus === 'light' ? 'Pou쬴j v noci pro lep코칤 viditelnost' : recipe.result.bonus === 'stealth' ? 'Pasivn칤 bonus - sn칤쮂 코anci na p콏epaden칤' : 'Dr v invent치콏i pro bonus'}</p>
                `;
            } else if (recipe.result.type === 'throwable') {
                typeInfo = `<p style="color: #7b1fa2; font-size: 1.1rem;">游눢 Vrhac칤 - ${recipe.result.damage || 0} DMG</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> V boji vyber "Hodit"  Zas치hne nep콏치tele</p>
                    ${recipe.result.aoe ? '<p>游눤 <strong>Plo코n칳 칰tok:</strong> Zas치hne v코echny nep콏치tele</p>' : ''}
                    ${recipe.result.effect === 'escape' ? '<p>游끢 <strong>Speci치ln칤:</strong> Umo쬹칤 칰t캩k z boje</p>' : ''}
                `;
            } else if (recipe.result.type === 'ammo') {
                typeInfo = `<p style="color: #7b1fa2; font-size: 1.1rem;">游댦 Munice - ${recipe.result.count}x</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Automaticky se spot콏ebuje p콏i st콏elb캩</p>
                    <p>游댦 <strong>Pro zbran캩:</strong> ${recipe.result.itemId === 'ammo_arrow' ? 'Luk, Ku코e' : recipe.result.itemId === 'ammo_9mm' ? 'Pistole' : recipe.result.itemId === 'ammo_556' ? '칔to캜n치 pu코ka' : recipe.result.itemId === 'ammo_762' ? 'Sniper, Loveck치 pu코ka' : recipe.result.itemId === 'ammo_shell' ? 'Brokovnice' : 'R콢zn칠'}</p>
                `;
            } else if (recipe.result.type === 'weapon_coating') {
                typeInfo = `<p style="color: #ffd700; font-size: 1.1rem;">九 Povlak na zbra켿 - ${recipe.result.uses}x</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Klikni v invent치콏i  Vyber zbra켿 k pota쬰n칤</p>
                    <p>丘덢잺 <strong>Efekt:</strong> ${recipe.result.effect === 'poison' ? 'Otr치v칤 nep콏칤tele (+DMG over time)' : 'Zap치l칤 nep콏칤tele (+DMG over time)'}</p>
                `;
            } else if (recipe.result.type === 'accessory') {
                typeInfo = `<p style="color: #ffd700; font-size: 1.1rem;">游눐 Dopln캩k</p>`;
                usageInfo = `
                    <p>游늷 <strong>Pou쬴t칤:</strong> Klikni v invent치콏i  Nasadit</p>
                    <p>九 <strong>Bonus:</strong> ${recipe.result.desc || '+' + recipe.result.value + ' ' + recipe.result.bonus}</p>
                `;
            } else if (recipe.result.type === 'defense') {
                typeInfo = `<p style="color: #8B4513; font-size: 1.1rem;">游낋 Obrann치 struktura</p>`;
                usageInfo = `
                    <p>游늷 <strong>Efekt:</strong> +${recipe.result.value} obrana osady</p>
                    <p>游띠勇 <strong>Tip:</strong> Chr치n칤 p콏ed n치jezdy na osadu</p>
                `;
            }
            
            // Resource icons
            const icons = {
                wood: '游', metal: '丘뙖잺', stone: '游', cloth: '游빗', leather: '游붮', rope: '俱', 
                herbs: '游', chemicals: '游빍', glass: '游댩', electronics: '游', fuel: '久', 
                gunpowder: '游눤', copper: '游릯', silver: '拘', gold: '游리', scrap: '游댤',
                raw_meat: '游볼', fish: '游', mutant_blood: '游뽖', acid: '游릭', crystal: '游', gems: '游눑'
            };
            
            showModal(`${recipe.icon} ${recipe.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${recipe.icon}</div>
                    ${typeInfo}
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #888;">游늶 Jak pou쮂셦:</h4>
                    <div style="font-size: 0.9rem; color: #aaa;">
                        ${usageInfo}
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid ${canCraft ? '#4CAF50' : '#c62828'};">
                    <h4 style="margin: 0 0 0.5rem 0; color: #888;">游빍 Pot콏ebn칠 suroviny:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${Object.entries(recipe.requires).map(([res, amt]) => {
                            const adjustedAmt = Math.ceil(amt * engineerReduction);
                            // Pro portable recepty pou쬴j jen invent치콏, pro d칤lnu invent치콏 + sklad
                            const has = getTotalResource(res, useSettlement);
                            const enough = has >= adjustedAmt;
                            return `<span style="background: ${enough ? '#1a3a1a' : '#3a1a1a'}; padding: 0.3rem 0.6rem; border-radius: 4px; color: ${enough ? '#8bc34a' : '#ff6b6b'};">
                                ${icons[res] || '游닍'} ${has}/${adjustedAmt}
                            </span>`;
                        }).join('')}
                    </div>
                    ${engineerReduction < 1 ? '<p style="color: #ffd700; font-size: 0.8rem; margin-top: 0.5rem;">游댢 Engineer: -50% surovin!</p>' : ''}
                    ${!useSettlement ? '<p style="color: #64b5f6; font-size: 0.75rem; margin-top: 0.3rem;">游 Pouze z invent치콏e (p콏enosn칳 recept)</p>' : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    ${canCraft ? `
                        <button class="btn" onclick="craftItem('${recipeId}'); closeModal();" style="background: #4CAF50;">
                            游댣 Vyrobit
                        </button>
                    ` : `
                        <button class="btn" style="background: #555; cursor: not-allowed;" disabled>
                            游 ${state.map.traveling ? 'Cestuje코...' : (needsWorkshop && !state.base.includes('workshop')) ? 'Pot콏ebuje코 d칤lnu' : 'Chyb칤 suroviny'}
                        </button>
                    `}
                    <button class="btn" onclick="closeModal()" style="background: #333;">
                         Zp캩t
                    </button>
                </div>
            `);
        }
        
        function craftItem(recipeId) {
            const recipe = CRAFTING.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Blokace b캩hem sp치nku
            if (state.isSleeping) {
                notifyWarning('游눣 Sp칤코!', 'Nem콢쬰코 vyr치b캩t b캩hem sp치nku.');
                return;
            }
            
            // Kontrola cestov치n칤
            if (state.map.traveling) {
                showModal('Nelze vyr치b캩t', '游뛌 Cestuje코! Po캜kej ne doraz칤코.');
                return;
            }
            
            // Kontrola unique item콢 (spac치k, kompas, atd.)
            const itemDef = ITEMS.find(i => i.id === recipeId);
            if (itemDef?.unique) {
                const alreadyHas = state.inv.some(i => i.id === recipeId);
                if (alreadyHas) {
                    notifyWarning('U m치코 ' + recipe.name, 'M콢쬰코 m칤t pouze jeden');
                    return;
                }
            }
            
            // Kontrola limitu past칤 (max 2)
            if (recipeId === 'trap') {
                const trapCount = state.inv?.filter(i => i.bonus === 'food' || i.id === 'trap').length || 0;
                if (trapCount >= 2) {
                    notifyWarning('Maximum past칤', 'M콢쬰코 m칤t maxim치ln캩 2 pasti');
                    return;
                }
            }
            
            // Kontrola jestli pot콏ebuje d칤lnu
            const needsWorkshop = recipe.portable !== true;
            if (needsWorkshop && !state.base.includes('workshop')) {
                showModal('Pot콏ebuje코 d칤lnu', '游댢 Tento p콏edm캩t lze vyrobit pouze v d칤ln캩. Postav si ji v 칰krytu!');
                return;
            }
            
            // Engineer bonus - 50% m칠n캩 surovin + technik companion bonus
            let engineerReduction = hasClassPassive('craftCostReduction') ? 0.5 : 1.0;
            const companionBonuses = getAllCompanionBonuses();
            if (companionBonuses.craftCostReduction > 0) {
                engineerReduction = engineerReduction * (1 - companionBonuses.craftCostReduction);
            }
            
            // Portable = pouze invent치콏, D칤lna = invent치콏 + sklad osady
            const useSettlement = needsWorkshop;
            
            // Check resources (podle typu receptu)
            for (const [res, amt] of Object.entries(recipe.requires)) {
                const adjustedAmt = Math.ceil(amt * engineerReduction);
                if (getTotalResource(res, useSettlement) < adjustedAmt) {
                    showModal(t('notifications', 'notEnoughResources'), 'Nem치코 dostatek materi치l콢!');
                    return;
                }
            }
            
            // Consume resources
            const specialComponents = ['deathclaw_hand', 'mutant_heart', 'crystal', 'gold', 'gems'];
            
            for (const [res, amt] of Object.entries(recipe.requires)) {
                const adjustedAmt = Math.ceil(amt * engineerReduction);
                let remaining = adjustedAmt;
                
                // Speci치ln칤 komponenty - odeber z invent치콏e
                if (specialComponents.includes(res)) {
                    for (let i = 0; i < remaining && state.inv; i++) {
                        const idx = state.inv.findIndex(item => item.id === res);
                        if (idx !== -1) {
                            if (state.inv[idx].count && state.inv[idx].count > 1) {
                                state.inv[idx].count--;
                            } else {
                                state.inv.splice(idx, 1);
                            }
                        }
                    }
                    remaining = 0;
                }
                
                // Nejprve ode캜ti z invent치콏e hr치캜e (resources)
                if (remaining > 0) {
                    const playerHas = state.resources[res] || 0;
                    const fromPlayer = Math.min(playerHas, remaining);
                    state.resources[res] = playerHas - fromPlayer;
                    remaining -= fromPlayer;
                }
                
                // Zbytek ode캜ti ze skladu osady (pouze pokud useSettlement)
                if (remaining > 0 && useSettlement && state.settlement?.resources) {
                    const settlementHas = state.settlement.resources[res] || 0;
                    state.settlement.resources[res] = settlementHas - remaining;
                }
            }
            
            // Add crafted item
            if (recipe.result.type === 'resource') {
                // P콏id치n칤 suroviny p콏칤mo do resources
                const resType = recipe.result.resource;
                const amount = recipe.result.amount || 1;
                state.resources[resType] = (state.resources[resType] || 0) + amount;
                showModal('Vyrobeno!', `${recipe.icon} ${recipe.name}! +${amount} ${resType}`);
                state.stats.itemsCrafted++;
                if (state.dailyQuests.progress) {
                    state.dailyQuests.progress.crafted = (state.dailyQuests.progress.crafted || 0) + 1;
                    checkDailyQuests();
                }
                checkAchievements();
                renderFull();
                return;
            } else if (recipe.result.type === 'consumable') {
                const existing = state.inv.find(i => i.id === recipeId);
                // Najdi v치hu z ITEMS nebo pou쬴j rozumn칳 default
                const itemDef = ITEMS.find(i => i.id === recipeId);
                const itemWeight = recipe.result.weight || itemDef?.weight || 0.3;
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    state.inv.push({id: recipeId, name: recipe.name, icon: recipe.icon, ...recipe.result, count: 1, weight: itemWeight});
                }
            } else if (recipe.result.type === 'throwable' || recipe.result.type === 'ammo') {
                // Pro ammo hledej podle itemId (nap콏. 'ammo_arrow'), pro ostatn칤 podle recipeId
                const searchId = recipe.result.itemId || recipeId;
                const existing = state.inv.find(i => i.id === searchId);
                if (existing) {
                    existing.count = (existing.count || 1) + (recipe.result.count || 1);
                } else {
                    // Pou쬴j itemId jako id pro spr치vn칠 stackov치n칤 s nalezen칳mi p콏edm캩ty
                    const itemDef = ITEMS.find(it => it.id === recipe.result.itemId);
                    state.inv.push({
                        id: searchId, 
                        name: itemDef?.name || recipe.name, 
                        icon: itemDef?.icon || recipe.icon, 
                        type: recipe.result.type,
                        ammoType: recipe.result.ammoType || itemDef?.ammoType,
                        count: recipe.result.count || 1, 
                        weight: itemDef?.weight || 0.1
                    });
                }
            } else if (recipe.result.type === 'weapon_coating') {
                // Povlak na zbra켿 - stackable
                const existing = state.inv.find(i => i.id === recipeId);
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    state.inv.push({id: recipeId, name: recipe.name, icon: recipe.icon, ...recipe.result, count: 1, weight: 0.2});
                }
            } else if (recipe.result.type === 'accessory') {
                // Dopln캩k - nestavkuje se
                state.inv.push({id: recipeId, name: recipe.name, icon: recipe.icon, ...recipe.result, weight: 0.5});
            } else if (recipe.result.type === 'defense') {
                // Obrann치 struktura - p콏id치v치 obranu osad캩
                state.settlement.defense = (state.settlement.defense || 0) + (recipe.result.value || 0);
                showModal('Vyrobeno!', `${recipe.icon} ${recipe.name} postaven! +${recipe.result.value} obrana osady.`);
                checkAchievements();
                renderFull();
                return; // Exit early - don't add to inventory
            } else {
                // V칳choz칤 v치hy podle typu
                const defaultWeights = {
                    'weapon': 2,
                    'armor': 4,
                    'gloves': 1,
                    'boots': 1.5,
                    'helmet': 1.5,
                    'tool': 1
                };
                const craftedItem = {
                    id: recipeId, 
                    name: recipe.name, 
                    icon: recipe.icon, 
                    ...recipe.result, 
                    weight: recipe.result.weight || defaultWeights[recipe.result.type] || 1,
                    crafted: true // Ozna캜en칤 쬰 byl vycraft캩n - nelze prodat obchodn칤k콢m
                };
                
                // 游댧 Scientists frakce - craftBonus (+5% stats)
                const factionBonuses = getFactionBonuses();
                if (factionBonuses.craftBonus > 0) {
                    if (craftedItem.damage) {
                        const bonus = Math.ceil(craftedItem.damage * factionBonuses.craftBonus);
                        craftedItem.damage += bonus;
                        craftedItem.name += ' 丘勇'; // Ozna캜en칤 vylep코en칠 v캩ci
                    }
                    if (craftedItem.defense) {
                        const bonus = Math.ceil(craftedItem.defense * factionBonuses.craftBonus);
                        craftedItem.defense += bonus;
                        if (!craftedItem.name.includes('丘勇')) craftedItem.name += ' 丘勇';
                    }
                }
                
                // Add durability to weapons, armor, gloves, boots
                if (['weapon', 'armor', 'gloves', 'boots', 'helmet'].includes(recipe.result.type)) {
                    craftedItem.durability = 100;
                    craftedItem.maxDurability = 100;
                }
                state.inv.push(craftedItem);
            }
            
            state.stats.itemsCrafted++;
            if (state.dailyQuests.progress) {
                state.dailyQuests.progress.crafted = (state.dailyQuests.progress.crafted || 0) + 1;
                checkDailyQuests();
            }
            
            // Craft success visual effect
            particleBurst(window.innerWidth / 2, window.innerHeight / 2, '#8bc34a', 12);
            
            const engineerText = engineerReduction < 1 ? ' (Engineer: -50% surovin)' : '';
            showModal('Vyrobeno!', `${recipe.icon} ${recipe.name} byl vyroben!${engineerText}`);
            checkAchievements();
            renderFull();
        }
        
        // === COMBAT ===
        function visitHospital() {
            // Pou쬴j ID aktu치ln칤 lokace jako kl칤캜
            const key = state.world.currentLocation || 'shelter';
            const now = Date.now();
            const lastVisit = state.buildingCooldowns.hospitals[key] || 0;
            const daysSinceVisit = (now - lastVisit) / (1000 * 60 * 60 * 24);
            
            if (daysSinceVisit >= 3) {
                // Can collect
                const medkit = ITEMS.find(i => i.id === 'medkit');
                if (canAddItem(medkit, 1)) {
                    state.inv.push({...medkit, count: 1});
                    state.buildingCooldowns.hospitals[key] = now;
                    SoundSystem.play('pickup');
                    const doctorQuote = getRandomHumor('doctor');
                    showModal('游낀 Nemocnice', 
                        '<p style="color: #888; font-style: italic; margin-bottom: 0.5rem;">"' + doctorQuote + '"</p>' +
                        '<p style="color: #8bc34a; font-weight: bold; margin-bottom: 1rem;">Na코el jsi l칠k치rni캜ku!</p>' +
                        '<p>V opu코t캩n칠 nemocnici jsi na코el funk캜n칤 l칠k치rni캜ku.</p>' +
                        '<p style="color: #999; font-size: 0.85rem; margin-top: 1rem;">낋 Dal코칤 l칠k치rni캜ka bude k dispozici za 3 dny</p>'
                    );
                    addLog('Nav코t칤vil jsi nemocnici', '游낀');
                } else {
                    // Ulo na zem
                    addToGroundLoot({...medkit});
                    state.buildingCooldowns.hospitals[key] = now;
                    SoundSystem.play('pickup');
                    showModal('游낀 Nemocnice', 
                        '<p style="color: #ff9800; font-weight: bold; margin-bottom: 1rem;">游닍 L칠k치rni캜ka z콢stala na zemi!</p>' +
                        '<p>Pln칳 invent치콏 - l칠k치rni캜ka 캜ek치 na zemi.</p>' +
                        '<p style="color: #999; font-size: 0.85rem; margin-top: 1rem;">Uvolni m칤sto a seber ji!</p>'
                    );
                }
            } else {
                const hoursLeft = Math.ceil((3 - daysSinceVisit) * 24);
                showModal('游낀 Nemocnice', 
                    '<p>U jsi tu byl ned치vno.</p>' +
                    `<p style="color: #ff9800;">낋 Dal코칤 l칠k치rni캜ka za ${hoursLeft} hodin</p>`
                );
            }
            renderFull();
        }
        
        function visitWorkshop() {
            // Pou쬴j ID aktu치ln칤 lokace jako kl칤캜
            const key = state.world.currentLocation || 'shelter';
            const now = Date.now();
            const lastVisit = state.buildingCooldowns.workshops[key] || 0;
            const daysSinceVisit = (now - lastVisit) / (1000 * 60 * 60 * 24);
            
            // Najdi po코kozen칠 vybaven칤
            const damagedItems = [];
            if (state.equipped?.weapon?.durability < state.equipped?.weapon?.maxDurability) {
                damagedItems.push({ item: state.equipped.weapon, type: 'equipped', slot: 'weapon' });
            }
            if (state.equipped?.armor?.durability < state.equipped?.armor?.maxDurability) {
                damagedItems.push({ item: state.equipped.armor, type: 'equipped', slot: 'armor' });
            }
            state.inv.forEach((item, idx) => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    damagedItems.push({ item, type: 'inventory', index: idx });
                }
            });
            
            let content = '';
            
            // Sb칤r치n칤 surovin
            if (daysSinceVisit >= 3) {
                const woodGain = Math.floor(Math.random() * 5) + 5;
                const metalGain = Math.floor(Math.random() * 4) + 3;
                const stoneGain = Math.floor(Math.random() * 3) + 2;
                
                state.resources.wood += woodGain;
                state.resources.metal += metalGain;
                state.resources.stone += stoneGain;
                state.buildingCooldowns.workshops[key] = now;
                SoundSystem.play('pickup');
                
                content += `
                    <div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                        <p style="color: #8bc34a; font-weight: bold; margin-bottom: 0.5rem;">游닍 Na코el jsi suroviny!</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <span>游 +${woodGain}</span>
                            <span>丘뙖잺 +${metalGain}</span>
                            <span>游 +${stoneGain}</span>
                        </div>
                    </div>
                `;
            } else {
                const hoursLeft = Math.ceil((3 - daysSinceVisit) * 24);
                content += `
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #888;">游닍 Suroviny: 낋 ${hoursLeft} hodin</p>
                    </div>
                `;
            }
            
            // Oprava vybaven칤
            content += `
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.8rem 0; color: #ff9800;">游댢 Oprava vybaven칤</h4>
                    <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.8rem;">Cena: 5 丘뙖잺 kov + 10 游눯 za item</p>
            `;
            
            if (damagedItems.length > 0) {
                content += `<div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                damagedItems.forEach((di, idx) => {
                    const canAfford = (state.resources.metal || 0) >= 5 && (state.money || 0) >= 10;
                    content += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px;">
                            <span>${di.item.icon} ${di.item.name}</span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #ff9800;">${di.item.durability}/${di.item.maxDurability}</span>
                                <button class="btn" onclick="repairAtWorkshop(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; ${canAfford ? 'background: #4CAF50;' : 'background: #555; cursor: not-allowed;'}" ${canAfford ? '' : 'disabled'}>
                                    Opravit
                                </button>
                            </div>
                        </div>
                    `;
                });
                content += `</div>`;
                window._workshopDamagedItems = damagedItems;
            } else {
                content += `<p style="color: #666; text-align: center;">九 V코e je v po콏치dku!</p>`;
            }
            
            content += `</div>`;
            content += `<button class="btn" onclick="closeModal()" style="width: 100%; background: #555;"> Zav콏칤t</button>`;
            
            showModal('游낈 Opu코t캩n치 d칤lna', content);
            addLog('Nav코t칤vil jsi opu코t캩nou d칤lnu', '游낈');
            renderFull();
        }
        
        function repairAtWorkshop(damagedIndex) {
            if (!window._workshopDamagedItems) return;
            const di = window._workshopDamagedItems[damagedIndex];
            if (!di) return;
            
            // Kontrola surovin
            if ((state.resources.metal || 0) < 5 || (state.money || 0) < 10) {
                showModal('仇 Nelze opravit', 'Nem치코 dostatek surovin!<br>Pot콏ebuje코: 5 丘뙖잺 + 10 游눯');
                return;
            }
            
            // Ode캜ti suroviny
            state.resources.metal -= 5;
            state.money -= 10;
            
            // Oprav na plno
            di.item.durability = di.item.maxDurability;
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('游댢 Opraveno!', `${di.item.icon} ${di.item.name}<br><span style="color: #8bc34a;">Pln치 trvanlivost!</span>`);
            delete window._workshopDamagedItems;
            renderFull();
        }
        
        function visitFactory() {
            // Pou쬴j ID aktu치ln칤 lokace jako kl칤캜
            const key = state.world.currentLocation || 'shelter';
            const now = Date.now();
            const lastVisit = state.buildingCooldowns.factories[key] || 0;
            const daysSinceVisit = (now - lastVisit) / (1000 * 60 * 60 * 24);
            
            if (daysSinceVisit >= 7) {
                // Can get weapon - pick random high-tier weapon
                const weaponPool = ITEMS.filter(i => i.type === 'weapon' && (i.rarity === 'uncommon' || i.rarity === 'rare'));
                const weapon = weaponPool[Math.floor(Math.random() * weaponPool.length)];
                const weaponWithDurability = {...weapon, durability: 100, maxDurability: 100};
                
                if (canAddItem(weapon, 1)) {
                    state.inv.push(weaponWithDurability);
                    state.buildingCooldowns.factories[key] = now;
                    SoundSystem.play('rare_item');
                    
                    showModal('游끵勇 Zbrojn칤 tov치rna', 
                        '<p style="color: #2196f3; font-weight: bold; margin-bottom: 1rem;">Na코el jsi zbra켿!</p>' +
                        `<div style="font-size: 3rem; text-align: center;">${weapon.icon}</div>` +
                        `<h3 style="text-align: center; color: #2196f3;">${weapon.name}</h3>` +
                        `<p style="text-align: center;">丘덢잺 Damage: ${weapon.damage}</p>` +
                        '<p style="color: #999; font-size: 0.85rem; margin-top: 1rem; text-align: center;">낋 Dal코칤 zbra켿 za 7 dn칤</p>'
                    );
                    addLog('Nav코t칤vil jsi zbrojn칤 tov치rnu', '游끵勇');
                } else {
                    // Ulo na zem
                    addToGroundLoot(weaponWithDurability);
                    state.buildingCooldowns.factories[key] = now;
                    SoundSystem.play('rare_item');
                    
                    showModal('游끵勇 Zbrojn칤 tov치rna', 
                        '<p style="color: #ff9800; font-weight: bold; margin-bottom: 1rem;">游닍 Zbra켿 z콢stala na zemi!</p>' +
                        `<div style="font-size: 3rem; text-align: center;">${weapon.icon}</div>` +
                        `<h3 style="text-align: center; color: #2196f3;">${weapon.name}</h3>` +
                        '<p style="text-align: center; color: #888;">Pln칳 invent치콏 - uvolni m칤sto a seber ji!</p>'
                    );
                }
            } else {
                const hoursLeft = Math.ceil((7 - daysSinceVisit) * 24);
                showModal('游끵勇 Zbrojn칤 tov치rna', 
                    '<p>U jsi tu byl ned치vno.</p>' +
                    `<p style="color: #ff9800;">낋 Dal코칤 zbra켿 za ${hoursLeft} hodin</p>`
                );
            }
            renderFull();
        }
        
        // Settlement functions
        // === INFO MODALY PRO OSADU ===
        function showSettlementPopulationInfo() {
            const settlers = state.settlement.settlers;
            const maxSettlers = 999; // Bez limitu
            
            // Spo캜칤tej spot콏ebu podle typu
            let totalFoodConsumption = 0;
            let totalWaterConsumption = 0;
            
            let settlersList = '';
            if (settlers.length === 0) {
                settlersList = '<p style="color: #666; text-align: center;">Zat칤m 쮂멳n칤 obyvatel칠</p>';
            } else {
                settlersList = settlers.map(s => {
                    const type = SETTLER_TYPES.find(t => t.id === s.type);
                    const skillData = SETTLER_SKILLS[type?.skill];
                    const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                    const consumption = levelData?.consumption || type?.consumption || { food: 1, water: 1 };
                    totalFoodConsumption += consumption.food || 0;
                    totalWaterConsumption += consumption.water || 0;
                    return `<div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.3rem;">
                        <span>${type?.icon || '游녻'} ${s.name} (${type?.name || s.type})</span>
                        <span style="color: #888;">-${consumption.food}游꼤 -${consumption.water}游눦</span>
                    </div>`;
                }).join('');
            }
            
            // Spo캜칤tej 칰dr쬭u budov
            let totalMaintenance = 0;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance > 0) {
                    totalMaintenance += building.maintenance;
                }
            });
            
            // Sleva od stavitel콢
            const builders = state.settlement?.settlers?.filter(s => s.type === 'builder') || [];
            let maintenanceDiscount = 0;
            builders.forEach(builder => {
                const level = builder.skillLevel || 1;
                maintenanceDiscount += 0.05 * level;
            });
            maintenanceDiscount = Math.min(0.5, maintenanceDiscount);
            const finalMaintenance = Math.floor(totalMaintenance * (1 - maintenanceDiscount));
            
            // Spo캜칤tej p콏칤jem z obchodn칤k콢
            let traderIncome = 0;
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            traders.forEach(trader => {
                const level = trader.skillLevel || 1;
                const incomeByLevel = [10, 20, 35, 55, 80];
                traderIncome += incomeByLevel[level - 1] || 10;
            });
            if (state.settlement?.buildings?.includes('market') && traderIncome > 0) {
                traderIncome = Math.floor(traderIncome * 1.25);
            }
            
            const resTexts = {
                capacity: 'Kapacita z치vis칤 na 칰rovni osady',
                totalConsumption: 'Celkov치 spot콏eba obyvatel:',
                economy: 'Ekonomika osady:',
                maintenance: '칔dr쬭a budov:',
                traderIncome: 'P콏칤jem z obchodn칤k콢:',
                netProfit: '캛ist칳 zisk:',
                day: 'den'
            };
            
            showModal('游논 Obyvatel칠 osady', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游논</div>
                    <div style="font-size: 1.5rem; color: #8bc34a;">${settlers.length} obyvatel</div>
                    <p style="color: #888;">Osada 칰rovn캩 ${state.settlement.level}</p>
                </div>
                
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${settlersList}
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #4a2d2d; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">游늵 ${resTexts.totalConsumption}</h4>
                    <div style="display: flex; justify-content: space-around;">
                        <span>游꼤 -${totalFoodConsumption}/${resTexts.day}</span>
                        <span>游눦 -${totalWaterConsumption}/${resTexts.day}</span>
                    </div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">游눯 ${resTexts.economy}</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span>游댢 ${resTexts.maintenance}</span>
                        <span style="color: #ff6b6b;">-${finalMaintenance} 游눯/${resTexts.day}${maintenanceDiscount > 0 ? ' <span style="color:#8bc34a;font-size:0.75rem;">(-' + Math.round(maintenanceDiscount * 100) + '%)</span>' : ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span>游눷 ${resTexts.traderIncome}</span>
                        <span style="color: #8bc34a;">+${traderIncome} 游눯/${resTexts.day}</span>
                    </div>
                    <div style="border-top: 1px solid #444; padding-top: 0.3rem; margin-top: 0.3rem; display: flex; justify-content: space-between;">
                        <span><b>${resTexts.netProfit}</b></span>
                        <span style="color: ${traderIncome - finalMaintenance >= 0 ? '#8bc34a' : '#ff6b6b'}; font-weight: bold;">${traderIncome - finalMaintenance >= 0 ? '+' : ''}${traderIncome - finalMaintenance} 游눯/${resTexts.day}</span>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>
            `);
        }
        
        function showSettlementDefenseInfo() {
            const defTexts = {
                noDefense: '콯치dn치 obrana! Postav zdi nebo najmi str치쬮e.',
                strength: 'S칤la obrany proti n치jezdn칤k콢m',
                tips: 'Tipy:',
                tip1: 'Najmi str치쬮e (+10-50 obrana)',
                tip2: 'Postav zdi, v캩쬰, kas치rny',
                tip3: 'Vy코코칤 obrana = men코칤 ztr치ty p콏i n치jezdu',
                barracksBonus: 'Kas치rny bonus'
            };
            
            let defenseBreakdown = [];
            let totalDefense = 0;
            
            // Od str치쬮콢
            state.settlement.settlers.forEach(settler => {
                if (settler.type === 'guard') {
                    const skillData = SETTLER_SKILLS['combat'];
                    const levelData = skillData?.levels[(settler.skillLevel || 1) - 1];
                    const def = levelData?.effect?.defense || 10;
                    defenseBreakdown.push({ name: `游띠勇 ${settler.name}`, value: def });
                    totalDefense += def;
                }
            });
            
            // Od budov
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.effect?.defense) {
                    const bName = building.name;
                    defenseBreakdown.push({ name: `游끵勇 ${bName}`, value: building.effect.defense });
                    totalDefense += building.effect.defense;
                }
            });
            
            // Bonus z kas치ren
            if (state.settlement.buildings.includes('barracks')) {
                const guards = state.settlement.settlers.filter(s => s.type === 'guard').length;
                const bonus = guards * 5;
                if (bonus > 0) {
                    defenseBreakdown.push({ name: `游낋 ${defTexts.barracksBonus}`, value: bonus });
                    totalDefense += bonus;
                }
            }
            
            const breakdownHtml = defenseBreakdown.length > 0 
                ? defenseBreakdown.map(d => `<div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span>${d.name}</span>
                    <span style="color: #8bc34a;">+${d.value}</span>
                </div>`).join('')
                : `<p style="color: #666; text-align: center;">${defTexts.noDefense}</p>`;
            
            showModal('游띠勇 Obrana osady', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游띠勇</div>
                    <div style="font-size: 1.5rem; color: ${totalDefense > 30 ? '#8bc34a' : totalDefense > 10 ? '#ff9800' : '#c62828'};">${totalDefense}</div>
                    <p style="color: #888;">${defTexts.strength}</p>
                </div>
                
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${breakdownHtml}
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d4a2d;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游눠 ${defTexts.tips}</h4>
                    <p style="color: #aaa; font-size: 0.85rem; margin: 0;">
                         ${defTexts.tip1}<br>
                         ${defTexts.tip2}<br>
                         ${defTexts.tip3}
                    </p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>
            `);
        }
        
        function showSettlementFoodInfo() {
            const balance = calculateSettlementBalance();
            const current = state.settlement.resources.food;
            const daysLeft = balance.food < 0 ? Math.floor(current / Math.abs(balance.food)) : '';
            
            const foodTexts = {
                perDay: '/den', lastsFor: 'vydr쮂', days: 'dn칤',
                production: 'Produkce', consumption: 'Spot콏eba', none: '콯치dn치'
            };
            
            // Produkce
            let production = [];
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                const effect = levelData?.effect || {};
                
                // J칤dlo p콏칤mo
                let foodProd = effect.food || 0;
                // Farmland bonus
                if (type?.id === 'farmer' && state.settlement.buildings.includes('farmland')) {
                    foodProd += 2;
                }
                // Maso se po캜칤t치 jako j칤dlo
                if (effect.meat) foodProd += effect.meat;
                
                if (foodProd > 0) {
                    production.push({ name: `${type?.icon || '游녻'} ${s.name}`, value: foodProd });
                }
            });
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.production?.food) {
                    production.push({ name: `游끵勇 ${getBuildingName(building.id)}`, value: building.production.food });
                }
            });
            
            // Spot콏eba
            let consumption = [];
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                const cons = levelData?.consumption?.food ?? type?.consumption?.food ?? 1;
                if (cons > 0) {
                    consumption.push({ name: `${type?.icon || '游녻'} ${s.name}`, value: cons });
                }
            });
            
            const prodTotal = production.reduce((sum, p) => sum + p.value, 0);
            const consTotal = consumption.reduce((sum, c) => sum + c.value, 0);
            
            showModal('游꼤 J칤dlo v osad캩', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游꼤</div>
                    <div style="font-size: 1.5rem; color: ${current > 20 ? '#8bc34a' : current > 5 ? '#ff9800' : '#c62828'};">${current}</div>
                    <p style="color: ${balance.food >= 0 ? '#8bc34a' : '#c62828'};">${balance.food >= 0 ? '+' : ''}${balance.food}${foodTexts.perDay} (${foodTexts.lastsFor} ${daysLeft} ${foodTexts.days})</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #2d4a2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #8bc34a; font-size: 0.85rem;">游늳 ${foodTexts.production}: +${prodTotal}</h4>
                        ${production.map(p => `<div style="font-size: 0.75rem; color: #aaa;">${p.name}: +${p.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + foodTexts.none + '</div>'}
                    </div>
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a2d2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ff6b6b; font-size: 0.85rem;">游늴 ${foodTexts.consumption}: -${consTotal}</h4>
                        ${consumption.map(c => `<div style="font-size: 0.75rem; color: #aaa;">${c.name}: -${c.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + foodTexts.none + '</div>'}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">九 OK</button>
            `);
        }
        
        function showSettlementWaterInfo() {
            const balance = calculateSettlementBalance();
            const current = state.settlement.resources.water;
            const daysLeft = balance.water < 0 ? Math.floor(current / Math.abs(balance.water)) : '';
            
            const waterTexts = {
                production: 'Produkce', consumption: 'Spot콏eba', none: '콯치dn치',
                lastsFor: 'vydr쮂', days: 'dn칤', day: 'den'
            };
            
            // Produkce
            let production = [];
            
            // Produkce od osadn칤k콢
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                const water = levelData?.effect?.water || 0;
                if (water > 0) production.push({ name: `${type?.icon || '游녻'} ${s.name}`, value: water });
            });
            
            // Produkce z budov
            const allBuildings = [...(state.settlement?.buildings || []), ...(state.base || [])];
            console.log('游눦 V코echny budovy pro v칳po캜et vody:', allBuildings);
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.production?.water) {
                    console.log('游눦 Budova produkuje vodu:', building.id, building.production.water);
                    production.push({ name: `游끵勇 ${getBuildingName(building.id)}`, value: building.production.water });
                }
            });
            
            // Spot콏eba
            let consumption = [];
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                // Pou쬴j spot콏ebu z levelData, jinak z type, jinak default 1
                const cons = levelData?.consumption?.water ?? type?.consumption?.water ?? 1;
                if (cons > 0) {
                    consumption.push({ name: `${type?.icon || '游녻'} ${s.name}`, value: cons });
                }
            });
            
            const prodTotal = production.reduce((sum, p) => sum + p.value, 0);
            const consTotal = consumption.reduce((sum, c) => sum + c.value, 0);
            
            showModal('游눦 Voda v osad캩', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游눦</div>
                    <div style="font-size: 1.5rem; color: ${current > 20 ? '#8bc34a' : current > 5 ? '#ff9800' : '#c62828'};">${current}</div>
                    <p style="color: ${balance.water >= 0 ? '#8bc34a' : '#c62828'};">${balance.water >= 0 ? '+' : ''}${balance.water}/${waterTexts.day} (${waterTexts.lastsFor} ${daysLeft} ${waterTexts.days})</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #1a2a2a; padding: 0.5rem; border-radius: 8px; border: 1px solid #2d4a4a;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #64b5f6; font-size: 0.85rem;">游늳 ${waterTexts.production}: +${prodTotal}</h4>
                        ${production.map(p => `<div style="font-size: 0.75rem; color: #aaa;">${p.name}: +${p.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + waterTexts.none + '</div>'}
                    </div>
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a2d2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ff6b6b; font-size: 0.85rem;">游늴 ${waterTexts.consumption}: -${consTotal}</h4>
                        ${consumption.map(c => `<div style="font-size: 0.75rem; color: #aaa;">${c.name}: -${c.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + waterTexts.none + '</div>'}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">九 OK</button>
            `);
        }
        
        function showSettlementPowerInfo() {
            const production = calculatePowerProduction();
            const consumption = calculatePowerConsumption();
            const balance = production - consumption;
            
            const powerTexts = {
                production: 'Produkce', consumption: 'Spot콏eba', balance: 'Bilance',
                sources: 'Zdroje', none: '콯치dn칠', insufficient: 'Nedostatek energie! N캩kter칠 budovy nefunguj칤. Postav gener치tor nebo sol치rn칤 panely.'
            };
            
            // Zdroje energie
            let sources = [];
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.production?.power) {
                    sources.push({ name: `${building.icon} ${getBuildingName(building.id)}`, value: building.production.power });
                }
            });
            
            // Spot콏ebi캜e
            let consumers = [];
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.requiresPower) {
                    consumers.push({ name: `${building.icon} ${getBuildingName(building.id)}`, value: building.requiresPower, working: balance >= 0 });
                }
            });
            
            showModal('丘 Elekt콏ina v osad캩', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">丘</div>
                    <div style="font-size: 1.5rem; color: ${balance >= 0 ? '#ffd700' : '#c62828'};">${balance >= 0 ? '+' : ''}${balance}</div>
                    <p style="color: #888;">${powerTexts.production} ${production} / ${powerTexts.consumption} ${consumption}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #2a2a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a4a2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ffd700; font-size: 0.85rem;">丘 ${powerTexts.sources}: +${production}</h4>
                        ${sources.map(s => `<div style="font-size: 0.75rem; color: #aaa;">${s.name}: +${s.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + powerTexts.none + '</div>'}
                    </div>
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a2d2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ff6b6b; font-size: 0.85rem;">游댋 ${powerTexts.consumption}: -${consumption}</h4>
                        ${consumers.map(c => `<div style="font-size: 0.75rem; color: ${c.working ? '#aaa' : '#c62828'};">${c.name}: -${c.value} ${c.working ? '' : '仇'}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + powerTexts.none + '</div>'}
                    </div>
                </div>
                
                ${balance < 0 ? `
                    <div style="background: #4a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #8B0000;">
                        <p style="color: #ff6b6b; margin: 0; font-size: 0.85rem;">丘멆잺 ${powerTexts.insufficient}</p>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>
            `);
        }
        
        function calculateSettlementDefense() {
            let defense = state.settlement.defense || 0;
            
            // Guards add defense based on skill level
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Pro str치쬮e pou쬴j obranu z 칰rovn캩 dovednosti
                if (type.id === 'guard') {
                    const skillData = SETTLER_SKILLS['combat'];
                    const settlerLevel = settler.skillLevel || 1;
                    const levelData = skillData?.levels[settlerLevel - 1];
                    if (levelData?.effect?.defense) {
                        defense += levelData.effect.defense;
                    }
                } else if (type.defense) {
                    // Pro ostatn칤 typy s obranou (z치loha)
                    defense += type.defense;
                }
            });
            
            // Buildings add defense
            state.settlement.buildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.effect && building.effect.defense) {
                    defense += building.effect.defense;
                }
                // Barracks bonus for guards
                if (buildingId === 'barracks') {
                    const guards = state.settlement.settlers.filter(s => s.type === 'guard').length;
                    defense += guards * 5; // sn칤쬰no z 10 na 5
                }
            });
            
            // Base buildings defense
            state.base.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.effect && building.effect.defense) {
                    defense += building.effect.defense;
                }
            });
            
            return defense;
        }
        
        // === SYST칄M N츼JEZD콡 NA OSADU ===
        function checkForRaid() {
            const now = Date.now();
            const hoursSinceLastRaid = (now - (state.settlement.lastRaid || 0)) / (1000 * 60 * 60);
            
            // Minim치ln캩 4 hodiny mezi n치jezdy
            if (hoursSinceLastRaid < 4) return false;
            
            // 마nce na n치jezd roste s 캜asem a prosperitou
            const baseChance = 0.02; // 2% z치kladn칤 코ance za tick
            const prosperityBonus = (state.settlement.prosperity || 0) * 0.001;
            const timeBonus = Math.min(0.1, hoursSinceLastRaid * 0.005);
            
            const raidChance = baseChance + prosperityBonus + timeBonus;
            
            // Zv캩d sni쬿je 코anci o 50%
            const hasScout = state.settlement.settlers.some(s => s.type === 'scout');
            const finalChance = hasScout ? raidChance * 0.5 : raidChance;
            
            return Math.random() < finalChance;
        }
        
        function startSettlementRaid() {
            state.settlement.lastRaid = Date.now();
            
            // P콏ehraj alarm zvuk
            SoundSystem.play('raid');
            
            // Syst칠mov치 notifikace
            sendSystemNotification('丘덢잺 N츼JEZD!', 'Tv치 osada je napadena! Bra켿 se!', '丘덢잺');
            
            // Ur캜i vlnu podle obt칤쬹osti (prosperity, dny p콏e쬴t칤)
            let waveIndex = Math.min(4, Math.floor(state.time.days / 7));
            waveIndex = Math.min(waveIndex, Math.floor((state.settlement.prosperity || 0) / 30));
            
            const wave = RAID_WAVES[waveIndex];
            
            // Varov치n칤 od zv캩da
            const hasScout = state.settlement.settlers.some(s => s.type === 'scout');
            
            const raidTexts = {
                scoutWarning: 'Zv캩d t캩 v캜as varoval!', enemies: 'Nep콏치tel칠:',
                settlementDefense: 'Obrana osady:', guards: 'Str치쬮i:',
                defendPersonally: 'Br치nit osobn캩!', letDefense: 'Nechat obranu',
                fatiguePenalty: '-10% 칰tok (칰nava)', returnsToSettlement: 'Vr치t칤 t캩 do osady',
                guardsDefend: 'Str치쬮i a v캩쬰 br치n칤', possibleLosses: 'Mo쬹칠 ztr치ty z치sob'
            };
            
            // Zjisti jestli je hr치캜 v osad캩
            const currentLoc = state.world?.currentLocation || '';
            const alreadyInSettlement = currentLoc === 'shelter' || currentLoc === 'settlement' || state.map?.inBase;
            
            // Text pro tla캜칤tko osobn칤 obrany
            const defendPenaltyText = alreadyInSettlement 
                ? '<span style="color: #4caf50;">九 Jsi v osad캩 - 쮂멳n치 penalizace!</span>'
                : `丘멆잺 -50% 丘 -20% 游꼤 -20% 游눦<br>${raidTexts.fatiguePenalty}<br>${raidTexts.returnsToSettlement}`;
            
            showModal('丘덢잺 N츼JEZD NA OSADU!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; animation: pulse 1s infinite;">丘덢잺</div>
                    <h3 style="color: #ff4444; margin: 0.5rem 0;">${getRaidWaveName(waveIndex + 1)}!</h3>
                </div>
                
                ${hasScout ? `<p style="color: #8bc34a; text-align: center;">游녜勇 ${raidTexts.scoutWarning}</p>` : ''}
                
                <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #8B0000;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff6666;">游놏 ${raidTexts.enemies}</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${wave.enemies.map(e => {
                            const enemy = ENEMIES.find(en => en.id === e.type);
                            return `<span style="background: #1a1a1a; padding: 0.3rem 0.6rem; border-radius: 4px;">
                                ${enemy?.icon || '游녻'} ${enemy?.name || e.type} x${e.count}
                            </span>`;
                        }).join('')}
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--toxic-dark);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>游띠勇 ${raidTexts.settlementDefense}</span>
                        <span style="color: var(--toxic-green); font-weight: bold;">${calculateSettlementDefense()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span>游논 ${raidTexts.guards}</span>
                        <span>${state.settlement.settlers.filter(s => s.type === 'guard').length}</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div>
                        <button class="btn" onclick="defendSettlement(${waveIndex})" style="background: #8B0000; width: 100%;">
                            丘덢잺 ${raidTexts.defendPersonally}
                        </button>
                        <div style="font-size: 0.65rem; color: ${alreadyInSettlement ? '#4caf50' : '#ff9800'}; text-align: center; margin-top: 0.3rem;">
                            ${defendPenaltyText}
                        </div>
                    </div>
                    <div>
                        <button class="btn" onclick="autoDefendSettlement(${waveIndex})" style="background: #555; width: 100%;">
                            游낋 ${raidTexts.letDefense}
                        </button>
                        <div style="font-size: 0.65rem; color: #888; text-align: center; margin-top: 0.3rem;">
                            ${raidTexts.guardsDefend}<br>
                            ${raidTexts.possibleLosses}
                        </div>
                    </div>
                </div>
            `, true);
        }
        
        function defendSettlement(waveIndex) {
            closeModal();
            const wave = RAID_WAVES[waveIndex];
            
            // Zjisti jestli je hr치캜 u v osad캩
            const currentLoc = state.world?.currentLocation || '';
            const alreadyInSettlement = currentLoc === 'shelter' || currentLoc === 'settlement' || state.map?.inBase;
            
            // === PENALIZACE ZA OSOBN칈 OBRANU ===
            // Pouze pokud NEN칈 v osad캩 - mus칤 se rychle vr치tit
            if (!alreadyInSettlement) {
                const energyCost = Math.floor(state.status.energy * 0.5); // 50% energie
                const hungerCost = Math.floor(state.status.hunger * 0.2); // 20% j칤dla
                const thirstCost = Math.floor(state.status.thirst * 0.2); // 20% 쮂셬n캩
                
                state.status.energy = Math.max(0, state.status.energy - energyCost);
                state.status.hunger = Math.max(0, state.status.hunger - hungerCost);
                state.status.thirst = Math.max(0, state.status.thirst - thirstCost);
                
                // P콏idej debuff za 칰navu (-10% damage)
                if (!state.combatDebuffs) state.combatDebuffs = {};
                state.combatDebuffs.fatigue = {
                    name: '칔nava z cesty',
                    effect: -0.10, // -10% damage
                    fights: 1 // Plat칤 jen pro tento boj
                };
                
                addLog('Sp캩ch치코 br치nit osadu! (-50% 丘, -20% 游꼤, -20% 游눦)', '游끢');
            } else {
                addLog('P콏ipravuje코 se k obran캩 osady!', '丘덢잺');
            }
            
            // P콏esun do osady (pro jistotu)
            state.world.currentLocation = 'shelter';
            state.map.inBase = true;
            
            // Vytvo콏 skupinu nep콏치tel
            let enemyGroup = [];
            wave.enemies.forEach(e => {
                const enemyTemplate = ENEMIES.find(en => en.id === e.type);
                if (enemyTemplate) {
                    for (let i = 0; i < e.count; i++) {
                        enemyGroup.push({
                            ...enemyTemplate,
                            hp: enemyTemplate.hp,
                            maxHp: enemyTemplate.hp,
                            alive: true,
                            stunned: false,
                            poisoned: 0,
                            bleeding: 0
                        });
                    }
                }
            });
            
            // Bonus od obrany osady - sn칤쬰n칤 HP nep콏치tel
            const defenseBonus = Math.min(0.5, calculateSettlementDefense() / 200);
            enemyGroup.forEach(e => {
                e.hp = Math.floor(e.hp * (1 - defenseBonus));
                e.maxHp = e.hp;
            });
            
            // Spus콘 boj
            window.raidWaveIndex = waveIndex;
            window.isSettlementRaid = true;
            startCombatWithGroup(enemyGroup, 'settlement_raid');
        }
        
        function autoDefendSettlement(waveIndex) {
            closeModal();
            const wave = RAID_WAVES[waveIndex];
            
            // Spo캜칤tej s칤lu nep콏치tel
            let enemyPower = 0;
            wave.enemies.forEach(e => {
                const enemy = ENEMIES.find(en => en.id === e.type);
                if (enemy) {
                    enemyPower += (enemy.hp + enemy.damage * 5) * e.count;
                }
            });
            
            // S칤la obrany
            const defensePower = calculateSettlementDefense() * 3;
            const guardPower = state.settlement.settlers.filter(s => s.type === 'guard').length * 50;
            const totalDefense = defensePower + guardPower;
            
            // V칳sledek
            const defenseRatio = totalDefense / enemyPower;
            const winChance = Math.min(0.95, Math.max(0.1, defenseRatio));
            const won = Math.random() < winChance;
            
            if (won) {
                // V칤t캩zstv칤
                state.settlement.raidsDefended = (state.settlement.raidsDefended || 0) + 1;
                const reward = wave.reward;
                
                addMoney(reward.money || 0);
                if (reward.xp > 0) addXP(reward.xp);
                
                showModal('游꿀 Obrana 칰sp캩코n치!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游띠勇</div>
                        <h3 style="color: #8bc34a;">Osada odrazila 칰tok!</h3>
                        <p>Tvoji str치쬮i a obrann칠 stavby ochr치nili osadu.</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p>游눯 +${reward.money} pen캩z</p>
                            <p>救 +${reward.xp} XP</p>
                        </div>
                        <p style="color: #888; font-size: 0.85rem;">Odra쬰no n치jezd콢: ${state.settlement.raidsDefended}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
            } else {
                // Prohra - ztr치ty
                const foodLoss = Math.floor((state.settlement.resources.food || 0) * 0.3);
                const waterLoss = Math.floor((state.settlement.resources.water || 0) * 0.2);
                const moneyLoss = Math.floor(state.money * 0.2);
                
                state.settlement.resources.food = Math.max(0, (state.settlement.resources.food || 0) - foodLoss);
                state.settlement.resources.water = Math.max(0, (state.settlement.resources.water || 0) - waterLoss);
                state.money = Math.max(0, state.money - moneyLoss);
                state.settlement.morale = Math.max(0, (state.settlement.morale || 50) - 20);
                
                // Mo쬹치 ztr치ta osadn칤ka
                if (Math.random() < 0.3 && state.settlement.settlers.length > 0) {
                    const lostSettler = state.settlement.settlers.pop();
                    showModal('游 Obrana selhala!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">游</div>
                            <h3 style="color: #ff4444;">N치jezdn칤ci vydrancovali osadu!</h3>
                            <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <p style="color: #ff6666;">游꼤 -${foodLoss} j칤dla</p>
                                <p style="color: #ff6666;">游눦 -${waterLoss} vody</p>
                                <p style="color: #ff6666;">游눯 -${moneyLoss} pen캩z</p>
                                <p style="color: #ff4444; margin-top: 0.5rem;">驕멆잺 ${lostSettler.name} zahynul!</p>
                            </div>
                            <p style="color: #ff9800;">游눠 Postav v칤ce obrann칳ch staveb!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                } else {
                    showModal('游 Obrana selhala!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">游</div>
                            <h3 style="color: #ff4444;">N치jezdn칤ci vydrancovali osadu!</h3>
                            <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <p style="color: #ff6666;">游꼤 -${foodLoss} j칤dla</p>
                                <p style="color: #ff6666;">游눦 -${waterLoss} vody</p>
                                <p style="color: #ff6666;">游눯 -${moneyLoss} pen캩z</p>
                            </div>
                            <p style="color: #ff9800;">游눠 Postav v칤ce obrann칳ch staveb!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                }
            }
            
            addLog(won ? ('Osada odrazila n치jezd!') : ('N치jezdn칤ci vydrancovali osadu!'), won ? '游띠勇' : '游');
            renderFull();
        }
        
        function handleRaidVictory() {
            const waveIndex = window.raidWaveIndex || 0;
            const wave = RAID_WAVES[waveIndex];
            
            state.settlement.raidsDefended = (state.settlement.raidsDefended || 0) + 1;
            
            const reward = wave.reward;
            addMoney(reward.money || 0);
            if (reward.xp > 0) addXP(reward.xp);
            
            addLog(`Osobn캩 jsi odrazil n치jezd! +${reward.money} 游눯, +${reward.xp} XP`, '丘덢잺');
            
            window.isSettlementRaid = false;
            window.raidWaveIndex = null;
        }
        
        // === DUNGEON SYST칄M ===
        function enterDungeon(dungeonId) {
            console.log('游낋 enterDungeon called:', dungeonId);
            console.log('游낋 Current location:', state.world?.currentLocation);
            console.log('游낋 DUNGEON_FLOORS has this dungeon:', !!DUNGEON_FLOORS[dungeonId]);
            
            // DEBUG - zobraz info
            // alert('enterDungeon: ' + dungeonId + ', currentLocation: ' + state.world?.currentLocation);
            
            // Kontrola prob칤haj칤c칤 akce (lov, t캩쬭a, pr콢zkum atd.)
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                const remaining = Math.ceil((state.currentAction.endTime - Date.now()) / 1000);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                notifyWarning('Prob칤h치 akce', `Po캜kej ${mins}:${String(secs).padStart(2, '0')} ne akce skon캜칤`);
                return;
            }
            
            // Kontrola cestov치n칤
            if (state.world?.traveling || state.map?.traveling) {
                notifyWarning('Cestuje코', 'Nejd콏칤v dokon캜i cestu!');
                return;
            }
            
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            console.log('游낋 dungeonData:', dungeonData);
            if (!dungeonData) {
                notifyWarning('Chyba', 'Tento dungeon nem치 definovan치 patra. ID: ' + dungeonId);
                return;
            }
            
            // V코e OK - vstup do dungeonu
            console.log('游낋 Entering dungeon...');
            // Zajisti 쬰 state.dungeon m치 v코echny pot콏ebn칠 properties
            if (!state.dungeon) {
                state.dungeon = { active: null, floor: 0, maxFloor: 0, cleared: {}, loot: [] };
            }
            // Zajisti 쬰 cleared existuje (pro star칠 ulo쬰n칠 hry)
            if (!state.dungeon.cleared) state.dungeon.cleared = {};
            if (!state.dungeon.loot) state.dungeon.loot = [];
            
            state.dungeon.active = dungeonId;
            state.dungeon.floor = 1;
            state.dungeon.loot = [];
            
            showDungeonUI();
        }
        
        function showDungeonUI() {
            if (!state.dungeon?.active) {
                console.error('游낋 showDungeonUI: No active dungeon');
                return;
            }
            
            const dungeonId = state.dungeon.active;
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            
            if (!dungeonData) {
                console.error('游낋 showDungeonUI: No dungeon data for', dungeonId);
                notifyWarning('Chyba', 'Dungeon data nenalezena');
                return;
            }
            
            const currentFloor = dungeonData.floors.find(f => f.floor === state.dungeon.floor);
            
            if (!currentFloor) {
                console.error('游낋 showDungeonUI: No floor data for floor', state.dungeon.floor);
                // Reset na patro 1
                state.dungeon.floor = 1;
                const firstFloor = dungeonData.floors[0];
                if (!firstFloor) {
                    notifyWarning('Chyba', 'Dungeon nem치 쮂멳n치 patra');
                    return;
                }
            }
            
            const floor = currentFloor || dungeonData.floors[0];
            // Zajisti 쬰 cleared objekt existuje
            if (!state.dungeon.cleared) state.dungeon.cleared = {};
            
            // === RESET DUNGEON콡 PO 24 HODIN츼CH ===
            const DUNGEON_RESET_TIME = 24 * 60 * 60 * 1000; // 24 hodin v ms
            const dungeonClearData = state.dungeon.cleared ? state.dungeon.cleared[dungeonId] : null;
            let clearedFloors = [];
            
            if (dungeonClearData) {
                // Nov칳 form치t: { floors: [...], clearedAt: timestamp }
                if (dungeonClearData.floors && Array.isArray(dungeonClearData.floors)) {
                    // Kontrola resetu - pouze pokud je clearedAt nastaveno
                    if (dungeonClearData.clearedAt) {
                        const timeSinceClear = Date.now() - dungeonClearData.clearedAt;
                        if (timeSinceClear >= DUNGEON_RESET_TIME) {
                            // Reset dungeonu!
                            delete state.dungeon.cleared[dungeonId];
                            addLog(`游낋 ${dungeonData.name} se resetoval - nep콏치tel칠 se vr치tili!`, '游댃');
                            clearedFloors = [];
                        } else {
                            clearedFloors = [...dungeonClearData.floors]; // Kopie array
                        }
                    } else {
                        // clearedAt je null - dungeon je코t캩 nen칤 kompletn캩 vy캜i코t캩n, ale n캩kter치 patra mohou b칳t
                        clearedFloors = [...dungeonClearData.floors]; // Kopie array
                    }
                } else if (Array.isArray(dungeonClearData)) {
                    // Star칳 form치t: [floors] - p콏eve캞 na nov칳
                    state.dungeon.cleared[dungeonId] = {
                        floors: [...dungeonClearData],
                        clearedAt: null
                    };
                    clearedFloors = [...dungeonClearData];
                }
            }
            
            const currentFloorNum = state.dungeon.floor || 1;
            const isCleared = clearedFloors.includes(currentFloorNum);
            
            console.log('游낋 showDungeonUI:', { 
                dungeonId, 
                floor: currentFloorNum, 
                totalFloors: dungeonData.floors.length,
                isCleared,
                clearedFloors: clearedFloors,
                clearData: state.dungeon.cleared ? state.dungeon.cleared[dungeonId] : null
            });
            
            // Vypo캜칤tej 캜as do resetu - pouze kdy jsou VECHNA patra vy캜i코t캩na
            let resetTimeText = '';
            const dungeonClearDataForUI = state.dungeon.cleared[dungeonId];
            const allFloorsAreCleared = clearedFloors.length >= dungeonData.floors.length;
            if (dungeonClearDataForUI && dungeonClearDataForUI.clearedAt && allFloorsAreCleared) {
                const timeUntilReset = (dungeonClearDataForUI.clearedAt + DUNGEON_RESET_TIME) - Date.now();
                if (timeUntilReset > 0) {
                    const hoursLeft = Math.floor(timeUntilReset / (60 * 60 * 1000));
                    const minsLeft = Math.floor((timeUntilReset % (60 * 60 * 1000)) / (60 * 1000));
                    resetTimeText = `<div style="font-size: 0.75rem; color: #64b5f6; margin-top: 0.3rem;">游댃 Reset za: ${hoursLeft}h ${minsLeft}m</div>`;
                }
            }
            
            showModal(`游낋 ${dungeonData.name}`, `
                <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0; color: #64b5f6;">Patro ${currentFloorNum}: ${floor.name}</h3>
                        ${isCleared ? '<span style="color: #8bc34a;">九 Vy캜i코t캩no</span>' : '<span style="color: #ff9800;">丘멆잺 Nevy캜i코t캩no</span>'}
                    </div>
                    <div style="font-size: 0.85rem; color: #888;">
                        Maxim치ln칤 patro: ${dungeonData.floors.length}
                    </div>
                    ${resetTimeText}
                </div>
                
                <!-- Progress -->
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.3rem;">
                        ${dungeonData.floors.map(f => `
                            <div style="flex: 1; height: 8px; border-radius: 4px; background: ${
                                clearedFloors.includes(f.floor) ? '#8bc34a' : 
                                f.floor === currentFloorNum ? '#ff9800' : '#333'
                            };"></div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Nep콏치tel칠 -->
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #8B0000;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff6666; font-size: 0.9rem;">游놏 Nep콏치tel칠 na pat콏e:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${floor.enemies.map(eId => {
                            const enemy = ENEMIES.find(e => e.id === eId);
                            return enemy ? `<span style="background: #1a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                                ${enemy.icon} ${enemy.name}
                            </span>` : '';
                        }).join('')}
                        ${floor.boss ? `<span style="background: #4a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; border: 1px solid #ff4444;">
                            游 BOSS: ${DUNGEON_BOSSES[floor.boss]?.name || floor.boss}
                        </span>` : ''}
                    </div>
                </div>
                
                <!-- Loot -->
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--toxic-dark);">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">游눑 Mo쬹치 ko콏ist:</h4>
                    <div style="font-size: 0.85rem; color: #aaa;">
                        ${floor.loot.join(', ')}
                    </div>
                </div>
                
                <!-- Nasb칤ran칳 loot -->
                ${state.dungeon.loot.length > 0 ? `
                    <div style="background: #2a2a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <span style="color: #ffd700; font-size: 0.85rem;">游 Nasb칤r치no: ${state.dungeon.loot.length} p콏edm캩t콢</span>
                    </div>
                ` : ''}
                
                <!-- Akce -->
                <div style="display: grid; gap: 0.5rem;">
                    ${!isCleared ? `
                        <button class="btn" onclick="exploreDungeonFloor()" style="background: #8B0000;">
                            丘덢잺 Prozkoumat patro
                        </button>
                    ` : `
                        ${currentFloorNum < dungeonData.floors.length ? `
                            <button class="btn" onclick="descendDungeon()" style="background: var(--toxic-dark);">
                                拘勇 Sestoupit hloub캩ji
                            </button>
                        ` : `
                            <div style="text-align: center; color: #8bc34a; padding: 0.5rem;">
                                九 Dungeon kompletn캩 vy캜i코t캩n!
                            </div>
                        `}
                    `}
                    ${currentFloorNum > 1 ? `
                        <button class="btn" onclick="ascendDungeon()" style="background: #555;">
                            拘勇 Vr치tit se nahoru
                        </button>
                    ` : ''}
                    <button class="btn" onclick="exitDungeon()" style="background: #333;">
                        游뛁 Opustit dungeon
                    </button>
                </div>
            `);
        }
        
        function exploreDungeonFloor() {
            closeModal();
            
            if (!state.dungeon?.active) {
                notifyWarning('Chyba', '콯치dn칳 aktivn칤 dungeon');
                return;
            }
            
            const dungeonId = state.dungeon.active;
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            
            if (!dungeonData) {
                notifyWarning('Chyba', 'Dungeon data nenalezena');
                return;
            }
            
            const currentFloorNum = state.dungeon.floor || 1;
            const currentFloor = dungeonData.floors.find(f => f.floor === currentFloorNum);
            
            if (!currentFloor) {
                notifyWarning('Chyba', `Data patra ${currentFloorNum} nenalezena`);
                return;
            }
            
            console.log('游낋 exploreDungeonFloor:', dungeonId, 'floor:', currentFloorNum, 'enemies:', currentFloor.enemies);
            
            // Vytvo콏 nep콏치tele
            let enemyGroup = [];
            currentFloor.enemies.forEach(eId => {
                const enemy = ENEMIES.find(e => e.id === eId);
                if (enemy) {
                    const count = 1 + Math.floor(Math.random() * 2); // 1-2 ka쬯칠ho typu
                    for (let i = 0; i < count; i++) {
                        enemyGroup.push({
                            ...enemy,
                            hp: enemy.hp,
                            maxHp: enemy.hp,
                            alive: true,
                            stunned: false,
                            poisoned: 0,
                            bleeding: 0
                        });
                    }
                } else {
                    console.warn('游낋 Enemy not found:', eId);
                }
            });
            
            // P콏idej bosse na posledn칤m pat콏e
            if (currentFloor.boss) {
                const boss = DUNGEON_BOSSES[currentFloor.boss];
                if (boss) {
                    enemyGroup.push({
                        ...boss,
                        id: currentFloor.boss,
                        hp: boss.hp,
                        maxHp: boss.hp,
                        alive: true,
                        stunned: false,
                        poisoned: 0,
                        bleeding: 0,
                        isBoss: true
                    });
                } else {
                    console.warn('游낋 Boss not found:', currentFloor.boss);
                }
            }
            
            if (enemyGroup.length === 0) {
                notifyWarning('Chyba', '콯치dn칤 nep콏치tel칠 na tomto pat콏e');
                return;
            }
            
            window.isDungeonCombat = true;
            startCombatWithGroup(enemyGroup, 'dungeon');
        }
        
        function handleDungeonVictory() {
            console.log('游낋 handleDungeonVictory called!', { dungeon: JSON.stringify(state.dungeon) });
            
            if (!state.dungeon?.active) {
                console.error('游낋 handleDungeonVictory: No active dungeon');
                // Zkus obnovit dungeon z lokace
                if (state.world?.currentLocation && DUNGEON_FLOORS[state.world.currentLocation]) {
                    console.log('游낋 Attempting to restore dungeon from location:', state.world.currentLocation);
                    state.dungeon = {
                        active: state.world.currentLocation,
                        floor: 1,
                        loot: [],
                        cleared: state.dungeon?.cleared || {}
                    };
                } else {
                    closeModal();
                    renderFull();
                    return;
                }
            }
            
            const dungeonId = state.dungeon.active;
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            const currentFloorNum = state.dungeon.floor || 1;
            
            console.log('游낋 Processing victory for:', dungeonId, 'floor:', currentFloorNum);
            
            if (!dungeonData) {
                console.error('游낋 handleDungeonVictory: No dungeon data for', dungeonId);
                notifyWarning('Chyba', 'Dungeon data nenalezena');
                return;
            }
            
            const currentFloor = dungeonData.floors.find(f => f.floor === currentFloorNum);
            
            if (!currentFloor) {
                console.error('游낋 handleDungeonVictory: No floor data for floor', currentFloorNum);
                return;
            }
            
            // Zajisti 쬰 loot array existuje
            if (!state.dungeon.loot) state.dungeon.loot = [];
            
            // === ROBUSTN칈 OZNA캛EN칈 PATRA JAKO VY캛IT캨N칄HO ===
            // Zajisti 쬰 cleared objekt existuje
            if (!state.dungeon.cleared || typeof state.dungeon.cleared !== 'object') {
                state.dungeon.cleared = {};
            }
            
            // Zajisti 쬰 tento dungeon m치 spr치vnou strukturu
            if (!state.dungeon.cleared[dungeonId] || typeof state.dungeon.cleared[dungeonId] !== 'object') {
                state.dungeon.cleared[dungeonId] = { floors: [], clearedAt: null };
            }
            
            // Migrace star칠ho form치tu (pokud je to array)
            if (Array.isArray(state.dungeon.cleared[dungeonId])) {
                state.dungeon.cleared[dungeonId] = { 
                    floors: state.dungeon.cleared[dungeonId], 
                    clearedAt: null
                };
            }
            
            // Zajisti 쬰 floors array existuje
            if (!Array.isArray(state.dungeon.cleared[dungeonId].floors)) {
                state.dungeon.cleared[dungeonId].floors = [];
            }
            
            // P콏idej patro do seznamu vy캜i코t캩n칳ch (pokud tam je코t캩 nen칤)
            if (!state.dungeon.cleared[dungeonId].floors.includes(currentFloorNum)) {
                state.dungeon.cleared[dungeonId].floors.push(currentFloorNum);
                console.log('游낋 Floor', currentFloorNum, 'marked as cleared! Cleared floors:', state.dungeon.cleared[dungeonId].floors);
                notifySuccess('游낋 Patro vy캜i코t캩no!', `Patro ${currentFloorNum} bylo vy캜i코t캩no`);
            } else {
                console.log('游낋 Floor', currentFloorNum, 'was already cleared');
            }
            
            // Aktualizuj 캜as vy캜i코t캩n칤 - POUZE kdy jsou vy캜i코t캩na VECHNA patra
            const allFloorsCleared = state.dungeon.cleared[dungeonId].floors.length >= dungeonData.floors.length;
            if (allFloorsCleared && !state.dungeon.cleared[dungeonId].clearedAt) {
                state.dungeon.cleared[dungeonId].clearedAt = Date.now();
                addLog(`游낋 ${dungeonData.name} kompletn캩 vy캜i코t캩n! Reset za 24 hodin.`, '游끥');
            }
            
            // Generuj loot
            const lootGained = [];
            currentFloor.loot.forEach(lootType => {
                // Legendary m치 mnohem ni쮄뫆 코anci
                let dropChance = 0.6; // 60% pro b캩쬹칳 loot
                if (lootType === 'legendary' || lootType === 'legendary_weapon' || lootType === 'legendary_armor' || lootType === 'legendary_item') {
                    dropChance = 0.03; // 3% pro legendary
                } else if (lootType === 'unique' || lootType === 'unique_artifact') {
                    dropChance = 0.02; // 2% pro unique
                } else if (lootType === 'rare_weapon' || lootType === 'rare_armor') {
                    dropChance = 0.15; // 15% pro rare
                }
                
                if (Math.random() < dropChance) {
                    lootGained.push(lootType);
                    state.dungeon.loot.push(lootType);
                }
            });
            
            // Aktualizuj max floor
            if (state.dungeon.floor > (state.dungeon.maxFloor || 0)) {
                state.dungeon.maxFloor = state.dungeon.floor;
            }
            
            addLog(`Vy캜istil jsi patro ${state.dungeon.floor} v ${dungeonData.name}!`, '游낋');
            
            window.isDungeonCombat = false;
            
            // Ulo hru po vy캜i코t캩n칤 patra
            saveGame();
            
            setTimeout(() => showDungeonUI(), 500);
        }
        
        function descendDungeon() {
            if (!state.dungeon) return;
            state.dungeon.floor++;
            showDungeonUI();
        }
        
        function ascendDungeon() {
            if (!state.dungeon) return;
            state.dungeon.floor--;
            showDungeonUI();
        }
        
        function exitDungeon() {
            if (!state.dungeon) {
                closeModal();
                return;
            }
            
            // P콏idej nasb칤ran칳 loot do invent치콏e
            if (state.dungeon.loot && state.dungeon.loot.length > 0) {
                const resourceTypes = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'copper', 'scrap', 'fuel', 'rope', 'gunpowder', 'crystal', 'radaway', 'radx', 'ammo', 'medkit', 'plutonium_core', 'fusion_cell', 'ai_chip'];
                
                state.dungeon.loot.forEach(lootType => {
                    // Je to surovina?
                    if (resourceTypes.includes(lootType)) {
                        const amount = 1 + Math.floor(Math.random() * 3);
                        state.resources[lootType] = (state.resources[lootType] || 0) + amount;
                        const name = RESOURCE_NAMES[lootType] || lootType;
                        const icon = RESOURCE_ICONS[lootType] || '游닍';
                        addLog(`+${amount} ${icon} ${name} z dungeonu`, '游닍');
                    } else if (lootType === 'legendary' || lootType === 'legendary_weapon' || lootType === 'legendary_armor' || lootType === 'legendary_item') {
                        // Legend치rn칤 p콏edm캩t
                        const legendaries = ITEMS.filter(i => i.rarity === 'legendary');
                        if (legendaries.length > 0) {
                            const item = legendaries[Math.floor(Math.random() * legendaries.length)];
                            if (canAddItem(item, 1)) {
                                addItemToInventory(item, 1);
                                notifyLoot(item.name, 'legendary', item.icon);
                            } else {
                                // Na zem pokud pln칳 invent치콏
                                addToGroundLoot({...item});
                                notifyWarning('游닍 Na zemi', `${item.name} z콢stal na zemi (pln칳 invent치콏)`);
                            }
                        }
                    } else {
                        // Ostatn칤 - p콏idej pen칤ze
                        addMoney(20 + Math.floor(Math.random() * 50));
                    }
                });
            }
            
            state.dungeon.active = null;
            state.dungeon.floor = 0;
            state.dungeon.loot = [];
            
            closeModal();
            renderFull();
        }
        
        // === ENDLESS DUNGEON - PROPAST ===
        // Nekone캜n칳 dungeon pro endgame content
        const ABYSS_MODIFIERS = [
            { id: 'no_heal', name: '游뛂 Bez l칠캜en칤', desc: 'L칠캜iva ne칰캜inkuj칤', floor: 5 },
            { id: 'double_dmg', name: '丘덢잺 Dvojit칳 damage', desc: 'V코ichni d캩laj칤 2x DMG', floor: 10 },
            { id: 'fog', name: '游꺎勇 Mlha', desc: 'Viditelnost sn칤쬰na', floor: 15 },
            { id: 'poison_air', name: '驕멆잺 Jedovat칳 vzduch', desc: '+3 jed ka쬯칠 kolo', floor: 20 },
            { id: 'elite_only', name: '游 Jen elity', desc: 'V코ichni nep콏치tel칠 jsou elite', floor: 25 },
            { id: 'no_retreat', name: '游뛍 Bez 칰stupu', desc: 'Nelze ut칠ct', floor: 30 }
        ];
        
        const ABYSS_BOSSES = [
            { floor: 10, name: 'Str치쬮e Propasti', icon: '游놏', hp: 500, damage: 40, defense: 20, xp: 500 },
            { floor: 20, name: 'St칤nov칳 Tit치n', icon: '游붌', hp: 800, damage: 55, defense: 30, xp: 800 },
            { floor: 30, name: 'Prastar칳 Lich', icon: '游', hp: 1200, damage: 70, defense: 40, xp: 1200 },
            { floor: 50, name: 'Vl치dce Propasti', icon: '游녬', hp: 2000, damage: 100, defense: 60, xp: 2000 }
        ];
        
        function showAbyssEntrance() {
            // Vy쬬duje level 15+
            if ((state.char.level || 1) < 15) {
                showModal('游돕勇 Propast', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游돕勇</div>
                        <h3 style="color: #ff4444;">Nejsi p콏ipraven</h3>
                        <p style="color: #888;">Propast vy쬬duje minim치ln캩 level 15.</p>
                        <p style="color: #ffd700;">Tv콢j level: ${state.char.level || 1}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
                `);
                return;
            }
            
            // Inicializuj abyss stats
            state.abyss = state.abyss || { maxFloor: 0, runs: 0, deaths: 0 };
            
            const highScore = state.abyss.maxFloor || 0;
            const runs = state.abyss.runs || 0;
            
            showModal('游돕勇 PROPAST - Endless Dungeon', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游돕勇</div>
                    <p style="color: #888; font-size: 0.85rem;">Nekone캜n칳 dungeon pro ty nejodv치쬹캩j코칤</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a0a2a, #0a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #9c27b0;">
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; color: #ffd700;">${highScore}</div>
                            <div style="font-size: 0.7rem; color: #888;">Rekord</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; color: #4caf50;">${runs}</div>
                            <div style="font-size: 0.7rem; color: #888;">Pokusy</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; color: #ff4444;">${state.abyss.deaths || 0}</div>
                            <div style="font-size: 0.7rem; color: #888;">Smrti</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <h4 style="color: #9c27b0; margin: 0 0 0.5rem 0;">游닆 Pravidla:</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Ka쬯칳ch 10 pater = boss + checkpoint</li>
                        <li>Ka쬯칳ch 5 pater = nov칳 modifik치tor</li>
                        <li>캛칤m hloub캩ji, t칤m siln캩j코칤 nep콏치tel칠</li>
                        <li>Smrt = konec runu (zachov치코 loot)</li>
                        <li>Unik치tn칤 Abyss loot pouze zde!</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="startAbyssRun()" style="flex: 2; background: linear-gradient(135deg, #9c27b0, #6a1b9a); padding: 0.8rem; font-weight: bold;">
                        游돕勇 Vstoupit do Propasti
                    </button>
                    <button class="btn" onclick="showAbyssLeaderboard()" style="flex: 1; background: #333;">
                        游끥
                    </button>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function startAbyssRun() {
            state.abyss = state.abyss || {};
            state.abyss.runs = (state.abyss.runs || 0) + 1;
            state.abyss.currentFloor = 1;
            state.abyss.loot = [];
            state.abyss.activeModifiers = [];
            state.abyss.inProgress = true;
            
            addLog('游돕勇 Vstoupil jsi do Propasti!', '游돕勇');
            showAbyssFloor();
        }
        
        function showAbyssFloor() {
            const floor = state.abyss.currentFloor;
            const isBossFloor = floor % 10 === 0;
            const isCheckpoint = floor % 10 === 0;
            
            // P콏idej modifik치tor ka쬯칳ch 5 pater
            if (floor > 1 && floor % 5 === 1) {
                const availableMods = ABYSS_MODIFIERS.filter(m => m.floor <= floor && !state.abyss.activeModifiers.includes(m.id));
                if (availableMods.length > 0) {
                    const newMod = availableMods[Math.floor(Math.random() * availableMods.length)];
                    state.abyss.activeModifiers.push(newMod.id);
                    notifyWarning('Nov칳 modifik치tor!', `${newMod.name}: ${newMod.desc}`);
                }
            }
            
            // Modifik치tory UI
            const modsHtml = state.abyss.activeModifiers.map(modId => {
                const mod = ABYSS_MODIFIERS.find(m => m.id === modId);
                return mod ? `<span style="background: #2a1a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; color: #ce93d8;">${mod.name}</span>` : '';
            }).join(' ');
            
            // Nep콏치tel칠 - scale s patrem
            const enemyCount = Math.min(6, 1 + Math.floor(floor / 5));
            const enemyScaling = 1 + (floor * 0.1); // +10% za patro
            
            showModal(`游돕勇 Propast - Patro ${floor}`, `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <div style="font-size: 2rem;">${isBossFloor ? '游놏' : '游돕勇'}</div>
                    <div style="color: ${isBossFloor ? '#ff4444' : '#9c27b0'}; font-weight: bold;">
                        ${isBossFloor ? '丘멆잺 BOSS FLOOR 丘멆잺' : `Patro ${floor}`}
                    </div>
                    ${isCheckpoint ? '<div style="color: #4caf50; font-size: 0.8rem;">九 Checkpoint</div>' : ''}
                </div>
                
                ${modsHtml ? `<div style="margin-bottom: 0.5rem; text-align: center;">${modsHtml}</div>` : ''}
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: #888;">Nep콏치tel칠:</span>
                        <span style="color: #ff6b6b;">${isBossFloor ? 'BOSS + ' + (enemyCount - 1) : enemyCount}x</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: #888;">S칤la:</span>
                        <span style="color: #ffd700;">칑${enemyScaling.toFixed(1)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: #888;">Loot z칤sk치n:</span>
                        <span style="color: #4caf50;">${state.abyss.loot?.length || 0} item콢</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="startAbyssCombat()" style="flex: 2; background: #c62828; padding: 0.8rem;">
                        丘덢잺 Bojovat!
                    </button>
                    <button class="btn" onclick="exitAbyss()" style="flex: 1; background: #555;">
                        游뛁 Odej칤t
                    </button>
                </div>
            `);
        }
        
        function startAbyssCombat() {
            const floor = state.abyss.currentFloor;
            const isBossFloor = floor % 10 === 0;
            const hasEliteOnly = state.abyss.activeModifiers.includes('elite_only');
            
            // 맒치lov치n칤
            const scaling = 1 + (floor * 0.1);
            
            // Seznam nep콏치tel z r콢zn칳ch tier podle patra
            const tierEnemies = {
                1: ['wolf', 'rad_roach', 'wild_dog'],
                2: ['raider', 'ghoul', 'mutant_rat'],
                3: ['mutant', 'raider_boss', 'feral_ghoul'],
                4: ['deathclaw', 'super_mutant', 'robot_security']
            };
            
            const tier = Math.min(4, Math.ceil(floor / 10));
            const enemyPool = tierEnemies[tier] || tierEnemies[1];
            
            const enemyGroup = [];
            const enemyCount = Math.min(6, 1 + Math.floor(floor / 5));
            
            // Boss na boss floorech
            if (isBossFloor) {
                const boss = ABYSS_BOSSES.find(b => b.floor === floor) || ABYSS_BOSSES[ABYSS_BOSSES.length - 1];
                enemyGroup.push({
                    ...boss,
                    id: 'abyss_boss_' + floor,
                    hp: Math.floor(boss.hp * scaling),
                    maxHp: Math.floor(boss.hp * scaling),
                    damage: Math.floor(boss.damage * scaling),
                    defense: Math.floor(boss.defense * scaling),
                    isBoss: true,
                    isElite: true
                });
            }
            
            // Norm치ln칤 nep콏치tel칠
            const normalCount = isBossFloor ? enemyCount - 1 : enemyCount;
            for (let i = 0; i < normalCount; i++) {
                const enemyId = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                const enemyData = Object.values(ENEMIES).flat().find(e => e.id === enemyId) || 
                    { id: enemyId, name: 'Nep콏칤tel', icon: '游녻', hp: 50, damage: 10, defense: 5, xp: 20, loot: ['money'] };
                
                const isElite = hasEliteOnly || Math.random() < 0.15;
                
                enemyGroup.push({
                    ...enemyData,
                    id: enemyId + '_' + i,
                    hp: Math.floor(enemyData.hp * scaling * (isElite ? 2 : 1)),
                    maxHp: Math.floor(enemyData.hp * scaling * (isElite ? 2 : 1)),
                    damage: Math.floor(enemyData.damage * scaling * (isElite ? 1.5 : 1)),
                    defense: Math.floor(enemyData.defense * scaling * (isElite ? 1.3 : 1)),
                    xp: Math.floor(enemyData.xp * (1 + floor * 0.05) * (isElite ? 2.5 : 1)),
                    name: (isElite ? '游 ' : '') + enemyData.name,
                    isElite: isElite
                });
            }
            
            window.isAbyssCombat = true;
            startCombatWithGroup(enemyGroup, 'abyss');
        }
        
        function handleAbyssVictory() {
            const floor = state.abyss.currentFloor;
            
            // Loot - lep코칤 s patrem
            const lootChance = 0.3 + (floor * 0.02);
            const possibleLoot = ['medkit', 'stimpack', 'radx', 'ammo_9mm', 'ammo_shell', 'money'];
            
            if (Math.random() < lootChance) {
                const lootId = possibleLoot[Math.floor(Math.random() * possibleLoot.length)];
                state.abyss.loot = state.abyss.loot || [];
                state.abyss.loot.push(lootId);
            }
            
            // Speci치ln칤 Abyss loot ka쬯칳ch 10 pater
            if (floor % 10 === 0) {
                state.abyss.loot.push('abyss_crystal');
                notifySuccess('游눑 Abyss Krystal!', 'Vz치cn칳 drop z bosse!');
            }
            
            // Update max floor
            if (floor > (state.abyss.maxFloor || 0)) {
                state.abyss.maxFloor = floor;
                notifySuccess('游끥 Nov칳 rekord!', `Patro ${floor}!`);
            }
            
            // Pokra캜uj na dal코칤 patro
            state.abyss.currentFloor++;
            window.isAbyssCombat = false;
            
            setTimeout(() => showAbyssFloor(), 500);
        }
        
        function handleAbyssDefeat() {
            state.abyss.deaths = (state.abyss.deaths || 0) + 1;
            state.abyss.inProgress = false;
            
            const floor = state.abyss.currentFloor;
            const loot = state.abyss.loot || [];
            
            // P콏idej loot do invent치콏e
            loot.forEach(itemId => {
                if (itemId === 'money') {
                    addMoney(50 + floor * 10);
                } else {
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) addItemToInventory(item, 1, true);
                }
            });
            
            window.isAbyssCombat = false;
            
            showModal('游 P치d do Temnoty', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">游</div>
                    <h3 style="color: #ff4444;">Propast t캩 pohltila</h3>
                    <p style="color: #888;">Dos치hl jsi patra ${floor}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #4caf50; margin: 0;">Zachr치n캩n칳 loot: ${loot.length} item콢</p>
                    </div>
                    
                    ${floor > (state.abyss.maxFloor || 0) - 1 ? '<p style="color: #ffd700;">游끥 Nov칳 osobn칤 rekord!</p>' : ''}
                </div>
                <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; background: #555;">${'Pokra캜ovat'}</button>
            `);
        }
        
        function exitAbyss() {
            const loot = state.abyss.loot || [];
            const floor = state.abyss.currentFloor;
            
            // P콏idej loot do invent치콏e
            loot.forEach(itemId => {
                if (itemId === 'money') {
                    addMoney(50 + floor * 10);
                } else {
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) addItemToInventory(item, 1, true);
                }
            });
            
            state.abyss.inProgress = false;
            window.isAbyssCombat = false;
            
            notifySuccess('Unikl jsi z Propasti!', `${loot.length} item콢 zachr치n캩no`);
            closeModal();
            renderFull();
        }
        
        function showAbyssLeaderboard() {
            // Jednoduch칳 lok치ln칤 leaderboard (v budoucnu by mohl b칳t online)
            const myScore = state.abyss?.maxFloor || 0;
            
            showModal('游끥 Propast - Leaderboard', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游끥</div>
                    <p style="color: #ffd700;">Tv콢j rekord: Patro ${myScore}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: #9c27b0; margin: 0 0 0.5rem 0;">Miln칤ky:</h4>
                    <div style="font-size: 0.85rem;">
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游볠 Patro 10</span>
                            <span style="color: ${myScore >= 10 ? '#4caf50' : '#666'};">${myScore >= 10 ? '九' : '九'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游볟 Patro 25</span>
                            <span style="color: ${myScore >= 25 ? '#4caf50' : '#666'};">${myScore >= 25 ? '九' : '九'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>游볞 Patro 50</span>
                            <span style="color: ${myScore >= 50 ? '#4caf50' : '#666'};">${myScore >= 50 ? '九' : '九'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0;">
                            <span>游녬 Patro 100</span>
                            <span style="color: ${myScore >= 100 ? '#4caf50' : '#666'};">${myScore >= 100 ? '九' : '九'}</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="showAbyssEntrance()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zp캩t'}</button>
            `);
        }

        // === NPC VZTAHY ===
        function showNPCRelations() {
            state.npcRelations = state.npcRelations || {};
            
            // Filtruj jen NPC kter칠 hr치캜 potkal (nav코t칤vil jejich lokaci nebo jsou v npcMet)
            const metNPCs = FRIENDLY_NPCS.filter(npc => {
                // Kontrola jestli hr치캜 nav코t칤vil lokaci NPC
                const npcLocation = npc.location;
                const visitedLocation = state.world?.visitedLocations?.includes(npcLocation);
                
                // Nebo je explicitn캩 v npcMet
                const isInMet = state.mainQuest?.npcMet?.includes(npc.id);
                
                // Nebo m치 vztah (kv콢li zp캩tn칠 kompatibilit캩)
                const hasTrust = (state.npcRelations[npc.id]?.trust || 0) > 0;
                const hasGifts = (state.npcRelations[npc.id]?.gifts || 0) > 0;
                const hasQuests = (state.npcRelations[npc.id]?.quests || 0) > 0;
                const hasRelation = hasTrust || hasGifts || hasQuests;
                
                // Mus칤코 nav코t칤vit lokaci NEBO m칤t v npcMet NEBO u m칤t vztah (zp캩tn치 kompatibilita)
                return visitedLocation || isInMet || hasRelation;
            });
            
            if (metNPCs.length === 0) {
                showModal('游논 Vztahy s NPC', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游녻</div>
                        <p style="color: #888;">Je코t캩 jsi nepotkal 쮂멳n칠 NPC.</p>
                        <p style="color: #666; font-size: 0.85rem;">${'Prozkoumej lokace a najdi p콏치telsk칠 p콏e쬴v코칤!'}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
                `);
                return;
            }
            
            const npcsHtml = metNPCs.map(npc => {
                const relation = state.npcRelations[npc.id] || { trust: 0, gifts: 0, quests: 0 };
                const trustLevelTexts = {
                    best: 'Nejlep코칤 p콏칤tel', good: 'Dobr칳 p콏칤tel', friend: 'P콏칤tel', known: 'Zn치m칳', stranger: 'Cizinec'
                };
                const trustLevel = relation.trust >= 100 ? trustLevelTexts.best : 
                                   relation.trust >= 75 ? trustLevelTexts.good :
                                   relation.trust >= 50 ? trustLevelTexts.friend :
                                   relation.trust >= 25 ? trustLevelTexts.known : trustLevelTexts.stranger;
                const trustColor = relation.trust >= 75 ? '#8bc34a' : 
                                   relation.trust >= 50 ? '#ffd700' :
                                   relation.trust >= 25 ? '#ff9800' : '#888';
                
                // Najdi n치zev lokace
                const location = WORLD_LOCATIONS.find(l => l.id === npc.location);
                const locationName = location ? (location.name) : npc.location;
                
                return `
                    <div style="background: linear-gradient(135deg, #2a2a2a, #1a1a1a); padding: 1rem; border-radius: 8px; border: 2px solid ${trustColor}; cursor: pointer;" onclick="showNPCDetail('${npc.id}')">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">${npc.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #fff;">${npc.name}</div>
                                <div style="font-size: 0.75rem; color: #666;">游늸 ${locationName}</div>
                                <div style="font-size: 0.8rem; color: ${trustColor};">${trustLevel}</div>
                                <div style="margin-top: 0.3rem; height: 6px; background: #1a1a1a; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${relation.trust}%; background: ${trustColor};"></div>
                                </div>
                            </div>
                            <div style="font-size: 1.2rem; color: ${trustColor};">仇벒잺 ${relation.trust}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            showModal('游논 Vztahy s NPC', `
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">
                    ${'Buduj vztahy s NPC - d치vej dary, pl켿 jejich questy a odemkni speci치ln칤 odm캩ny!'}
                </p>
                <div style="display: grid; gap: 0.8rem; max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${npcsHtml}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        // === BU캛OVICE - HLAVN칈 M캨STO ===
        function showBucoviceWelcome() {
            // Kontrola jestli m치 v코echny komponenty pro fin치le
            const hasAllComponents = ['plutonium_core', 'quantum_stabilizer', 'fusion_cell', 'ai_module'].every(
                compId => state.inv?.some(i => i.id === compId)
            );
            const hasEnding = state.storyKarma?.ending;
            
            let specialMessage = '';
            if (hasAllComponents && !hasEnding) {
                specialMessage = `
                    <div style="background: linear-gradient(135deg, #4a1a4a, #1a4a4a); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #ffd700;">
                        <div style="color: #ffd700; font-weight: bold; text-align: center;">丘멆잺 FIN츼LE P콎칈B캨HU</div>
                        <p style="color: #aaa; font-size: 0.85rem; margin: 0.5rem 0; text-align: center;">
                            M치코 v코echny 4 komponenty Projektu Genesis!<br>
                            Oba brat콏i jsou zde a 캜ekaj칤 na tv칠 rozhodnut칤.
                        </p>
                    </div>
                `;
            } else if (hasEnding) {
                const endingText = {
                    dark: '游깸 Temn칳 konec - Kory zv칤t캩zil',
                    hope: '游깬 Konec nad캩je - Koudy obnovuje sv캩t',
                    neutral: '丘뒲잺 Neutr치ln칤 - Projekt Genesis zni캜en'
                };
                specialMessage = `
                    <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #4caf50;">
                        <div style="color: #4caf50; font-weight: bold; text-align: center;">游끥 P콎칈B캨H DOKON캛EN</div>
                        <p style="color: #aaa; font-size: 0.85rem; margin: 0.3rem 0; text-align: center;">
                            ${endingText[hasEnding]}
                        </p>
                    </div>
                `;
            }
            
            showModal('游낋 V칤tej v Bu캜ovic칤ch!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">游낋</div>
                    <p style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">Hlavn칤 m캩sto pustiny</p>
                    <p style="color: #888; font-size: 0.9rem;">Jedno z m치la m칤st, kter칠 p콏e쬴lo apokalypsu vcelku.</p>
                </div>
                
                ${specialMessage}
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #fff; font-weight: bold; margin-bottom: 0.5rem;">游늸 Co tu najde코:</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">游</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Tr쬴코t캩 - Obchody</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">游꽄</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Hospoda - J칤dlo & drby</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">游낀</span>
                            <span style="color: #aaa; font-size: 0.85rem;">L칠캜itel - Zdrav칤 & radiace</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">游닆</span>
                            <span style="color: #aaa; font-size: 0.85rem;">N치st캩nka - Denn칤 칰koly</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">游눣</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Hotel - Odpo캜inek</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">游댌</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Ulice - Prohledat</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #0a1a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #8bc34a; font-size: 0.85rem; margin: 0; text-align: center;">
                        游눠 Tip: V hospod캩 m콢쬰코 poslouchat drby a dozv캩d캩t se u쬴te캜n칠 informace o sv캩t캩!
                    </p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: linear-gradient(135deg, #4a3a2a, #3a2a1a); border: 1px solid #8b7355;">
                    游뛌 Vej칤t do m캩sta
                </button>
            `);
        }
        
        function openBucoviceMarket() {
            // Speci치ln칤 obchod s lep코칤m zbo쮂셠
            showModal('游낋 Tr쬴코t캩 Bu캜ovic', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游</div>
                    <p style="color: #888;">Nejv캩t코칤 tr쬴코t캩 v cel칠 pustin캩. Najde코 tu v코e, co pot콏ebuje코.</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal(); openShop();" style="background: var(--rust-light);">
                        游 Obecn칳 obchod
                    </button>
                    <button class="btn" onclick="openBucoviceWeaponShop();" style="background: #c62828;">
                        丘덢잺 Zbroj칤콏
                    </button>
                    <button class="btn" onclick="openBucoviceArmorShop();" style="background: #1565c0;">
                        游띠勇 Kov치콏
                    </button>
                    <button class="btn" onclick="openBucoviceToolShop();" style="background: #7b1fa2;">
                        游댢 N치stroj치콏
                    </button>
                    <button class="btn" onclick="openBucoviceMedicShop();" style="background: #2e7d32;">
                        游눍 L칠k치rna
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function openBucoviceToolShop() {
            const tools = ITEMS.filter(i => i.type === 'tool' && i.price > 0);
            showModal('游댢 N치stroj치콏', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${tools.map(item => {
                        const price = calculateItemPrice(item.price);
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <span>${item.icon} ${item.name}</span>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} 游눯</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">游눯 Tv칠 pen칤ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function openBucoviceWeaponShop() {
            const weapons = ITEMS.filter(i => i.type === 'weapon' && i.price > 0 && !i.cantBuy);
            showModal('丘덢잺 Zbroj칤콏', `
                <p style="color: #888; font-size: 0.85rem; text-align: center; margin-bottom: 0.5rem;">Specializovan칳 obchod se zbran캩mi</p>
                <div style="max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${weapons.sort((a, b) => a.price - b.price).map(item => {
                        const price = calculateItemPrice(item.price);
                        let desc = `${item.damage || 0} DMG`;
                        if (item.ammoType) desc += ` | 游댲${getAmmoName(item.ammoType)}`;
                        if (item.critChance) desc += ` | 游눤${Math.round(item.critChance * 100)}%`;
                        if (item.range) desc += ` | 游늺${item.range}m`;
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <div style="flex: 1;">
                                <div>${item.icon} ${item.name}</div>
                                <div style="font-size: 0.7rem; color: #8bc34a;">丘덢잺 ${desc}</div>
                            </div>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} 游눯</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">游눯 Tv칠 pen칤ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function openBucoviceArmorShop() {
            const armors = ITEMS.filter(i => (i.type === 'armor' || i.type === 'gloves' || i.type === 'boots' || i.type === 'helmet') && i.price > 0 && !i.cantBuy);
            showModal('游띠勇 Kov치콏', `
                <p style="color: #888; font-size: 0.85rem; text-align: center; margin-bottom: 0.5rem;">Specializovan칳 obchod se zbroj칤</p>
                <div style="max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${armors.sort((a, b) => a.price - b.price).map(item => {
                        const price = calculateItemPrice(item.price);
                        let desc = `${item.defense || 0} DEF`;
                        if (item.radiation) desc += ` | 驕뮖잺-${item.radiation}`;
                        if (item.hp) desc += ` | 仇벒잺+${item.hp}`;
                        if (item.stealth) desc += ` | 游봉+${item.stealth}`;
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <div style="flex: 1;">
                                <div>${item.icon} ${item.name}</div>
                                <div style="font-size: 0.7rem; color: #8bc34a;">游띠勇 ${desc}</div>
                            </div>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} 游눯</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">游눯 Tv칠 pen칤ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function openBucoviceMedicShop() {
            const meds = ITEMS.filter(i => i.type === 'consumable' && i.price > 0 && !i.cantBuy && 
                (i.effect === 'health' || i.effect === 'radiation' || i.id.includes('med') || i.id.includes('rad') || i.id.includes('stim') || i.id.includes('antidote')));
            showModal('游눍 L칠k치rna', `
                <p style="color: #888; font-size: 0.85rem; text-align: center; margin-bottom: 0.5rem;">Specializovan칳 obchod s l칠캜ivy</p>
                <div style="max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${meds.sort((a, b) => a.price - b.price).map(item => {
                        const price = calculateItemPrice(item.price);
                        let desc = '';
                        if (item.effect === 'health') desc = `仇벒잺 +${item.value} HP`;
                        else if (item.effect === 'radiation') desc = `驕뮖잺 -${Math.abs(item.value)} rad`;
                        else desc = item.desc || '';
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <div style="flex: 1;">
                                <div>${item.icon} ${item.name}</div>
                                <div style="font-size: 0.7rem; color: #8bc34a;">${desc}</div>
                            </div>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} 游눯</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">游눯 Tv칠 pen칤ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function visitBucoviceTavern() {
            showModal('游꽄 Hospoda "U Star칠ho Bunkru"', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游꽄</div>
                    <p style="color: #888; font-style: italic;">"Co to bude, cizin캜e?"</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #aaa; font-size: 0.85rem; margin: 0;">
                        Hostinsk칳 se naklon칤 bl칤: "Sly코el jsem, 쬰 se v okol칤 pohybuj칤 dva divn칤 chl치pci. 
                        Jeden mluv칤 o o캜ist캩 sv캩ta, druh칳 o z치chran캩. Oba hledaj칤 n캩jak칠 komponenty... 
                        D치vej si na n캩 pozor."
                    </p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="buyDrink()" style="background: #8D6E63;">
                        游꽄 Pivo (5 游눯) - Dopln칤 10 energie
                    </button>
                    <button class="btn" onclick="buyMeal()" style="background: #6D4C41;">
                        游꼤 J칤dlo (15 游눯) - Dopln칤 30 j칤dla
                    </button>
                    <button class="btn" onclick="listenToRumors()" style="background: #5D4037;">
                        游녝 Poslouchat drby (zdarma)
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Odej칤t</button>
            `);
        }
        
        function buyDrink() {
            if (getMoney() < 5) {
                notifyError('M치lo pen캩z!', 'Pot콏ebuje코 5 游눯');
                return;
            }
            removeMoney(5);
            state.status.energy = Math.min((state.status.energy || 0) + 10, 100);
            notifySuccess('游꽄 Na zdrav칤!', '+10 energie');
            renderFull();
            visitBucoviceTavern();
        }
        
        function buyMeal() {
            if (getMoney() < 15) {
                notifyError('M치lo pen캩z!', 'Pot콏ebuje코 15 游눯');
                return;
            }
            removeMoney(15);
            state.status.hunger = Math.min((state.status.hunger || 0) + 30, 100);
            notifySuccess('游꼤 Dobr칠 j칤dlo!', '+30 sytost');
            renderFull();
            visitBucoviceTavern();
        }
        
        function listenToRumors() {
            const rumors = [
                "\"Vojensk치 z치kladna na severu je pln치 robot콢, ale taky tam maj nejlep코칤 zbran캩...\"",
                "\"Sly코el jsem, 쬰 v tajn칳 laborato콏i na z치pad캩 experimentovali s n캩캜칤m d캩siv칳m.\"",
                "\"Ti dva brat콏i? Kory s칤dl칤 v Trading Postu, Koudy se schov치v치 ve v칳zkumn칳m za콏칤zen칤.\"",
                "\"Projekt Genesis pr칳 m콢쬰 bu캞 zachr치nit nebo zni캜it sv캩t. Z치le쮂 kdo ho ovl치dne.\"",
                "\"Star칳 bunkr na v칳chod캩? Tam to v코echno za캜alo. Tam je odpov캩캞 na v코echny ot치zky.\"",
                "\"D치vej si pozor na mutanty v ba쬴n치ch. Ale prej tam maj vz치cn칳 loot.\"",
                "\"Karavany jezd칤 캜ast캩ji kdy m치코 r치dio. Sta캜칤 je p콏ivolat.\"",
                "\"Elektr치rna je nebezpe캜n치, ale je tam n캩co d콢le쬴t칠ho pro ten jejich projekt.\""
            ];
            
            const rumor = rumors[Math.floor(Math.random() * rumors.length)];
            
            showModal('游녝 Drby z hospody', `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #aaa; font-style: italic; margin: 0;">${rumor}</p>
                </div>
                <button class="btn" onclick="visitBucoviceTavern()" style="width: 100%; background: #555;"> Zp캩t do hospody</button>
            `);
        }
        
        // === 游 KASINO SYST칄M ===
        
        function showCasino() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            showCasinoIntro();
        }
        
        // === PRAVIDLA HER ===
        function showGameRules(game) {
            const rulesCS = {
                highlow: {
                    title: '游 Vy코코칤 / Ni쮄뫆 - Pravidla',
                    content: `<p><b>C칤l:</b> Uhodne코 sou캜et dvou kostek?</p><p><b>Jak hr치t:</b></p><ul style="margin: 0.5rem 0; padding-left: 1.2rem;"><li>Zvol s치zku</li><li>Tipni jestli sou캜et bude ni쮄뫆 (2-5), p콏esn캩 7, nebo vy코코칤 (9-12)</li><li>丘멆잺 6 a 8 = prohra (house edge)!</li></ul><p><b>V칳platy:</b> Ni쮄뫆/Vy코코칤: 2x, P콏esn캩 7: 5x</p>`
                },
                poker: {
                    title: '游 Poker Dice - Pravidla',
                    content: `<p><b>C칤l:</b> Z칤skej co nejlep코칤 kombinaci s 5 kostkami.</p><p><b>Jak hr치t:</b> M치코 3 hody. Klikni na kostku pro zamknut칤.</p><p><b>V칳platy:</b> Dva p치ry: 1x, Trojice: 1.5x, Full House: 3x, 캛tve콏ice: 6x, Postupka: 10-25x, P캩tice: 30x</p>`
                },
                slots: {
                    title: '游 Automaty - Pravidla',
                    content: `<p><b>C칤l:</b> Z칤skej 3 stejn칠 symboly.</p><p><b>Jak hr치t:</b> Zvol s치zku, klikni Zato캜it.</p><p><b>V칳platy (3 stejn칠):</b> 游=8x, 游꼚=12x, 救=18x, 游=25x, 游눑=40x, 7勇=60x</p><p style="color:#888;">마nce na trojici: ~2.8%</p>`
                },
                blackjack: {
                    title: '游 Blackjack - Pravidla',
                    content: `<p><b>C칤l:</b> Z칤skej sou캜et co nejbl칤쬰 21, nep콏ekro캜!</p><p><b>Hodnoty:</b> 2-10=nomin치l, J/Q/K=10, A=1 nebo 11</p><p><b>Hit</b>=dal코칤 karta, <b>Stand</b>=st치t</p><p><b>V칳platy:</b> V칳hra: 2x, Blackjack: 2.5x</p>`
                },
                wheel: {
                    title: '游꿔 Kolo 코t캩st칤 - Pravidla',
                    content: `<p><b>C칤l:</b> Doufej 쬰 코ipka uk치쬰 na v칳hern칤 sektor!</p><p><b>Sektory:</b> 游(prohra)-8ks, 1.5x, 2x, 3x, 4x</p><p style="color:#f44336;">丘멆잺 67% 코ance na prohru!</p>`
                },
                war: {
                    title: '丘덢잺 War - Pravidla',
                    content: `<p><b>C칤l:</b> Tv치 karta mus칤 b칳t vy코코칤 ne dealerova.</p><p><b>Hodnoty:</b> 2<3<...<K<A</p><p><b>V칳hra:</b> 2x s치zka. Rem칤za = dealer vyhr치v치.</p>`
                },
                craps: {
                    title: '游 Craps - Pravidla',
                    content: `<p><b>Pass Line:</b> 7/11=v칳hra, 2/3/12=prohra, jin칠=Point</p><p><b>Point:</b> Ho캞 Point=v칳hra, 7=prohra</p><p><b>V칳hra:</b> 2x s치zka</p>`
                },
                keno: {
                    title: '游댝 Keno - Pravidla',
                    content: `<p><b>C칤l:</b> Uhodni co nejv칤ce 캜칤sel.</p><p><b>Jak:</b> Vyber 1-10 캜칤sel, losuje se 10.</p><p><b>V칳platy:</b> 5 tref=2x, 6=5x, 7=20x, 8=100x, 10=2000x</p>`
                }
            };
            const rulesEN = {
                highlow: {
                    title: '游 Higher / Lower - Rules',
                    content: `<p><b>Goal:</b> Guess the sum of two dice!</p><p><b>How to play:</b></p><ul style="margin: 0.5rem 0; padding-left: 1.2rem;"><li>Choose bet</li><li>Guess if sum will be lower, exactly 7, or higher</li></ul><p><b>Payouts:</b> Lower/Higher: 2x, Exactly 7: 5x</p>`
                },
                poker: {
                    title: '游 Poker Dice - Rules',
                    content: `<p><b>Goal:</b> Get the best combination with 5 dice.</p><p><b>How to play:</b> You have 3 rolls. Click dice to lock.</p><p><b>Payouts:</b> Two pairs: 1x, Three of a kind: 1.5x, Full House: 3x, Four of a kind: 6x, Straight: 10-25x, Five of a kind: 30x</p>`
                },
                slots: {
                    title: '游 Slots - Rules',
                    content: `<p><b>Goal:</b> Get 3 matching symbols.</p><p><b>How to play:</b> Choose bet, click Spin.</p><p><b>Payouts (3 same):</b> 游=8x, 游꼚=12x, 救=18x, 游=25x, 游눑=40x, 7勇=60x</p><p style="color:#888;">Triple chance: ~2.8%</p>`
                },
                blackjack: {
                    title: '游 Blackjack - Rules',
                    content: `<p><b>Goal:</b> Get as close to 21 as possible, don't bust!</p><p><b>Values:</b> 2-10=face, J/Q/K=10, A=1 or 11</p><p><b>Hit</b>=draw card, <b>Stand</b>=stay</p><p><b>Payouts:</b> Win: 2x, Blackjack: 2.5x</p>`
                },
                wheel: {
                    title: '游꿔 Wheel of Fortune - Rules',
                    content: `<p><b>Goal:</b> Hope the arrow lands on a winning sector!</p><p><b>Sectors:</b> 游(lose)-8pcs, 1.5x, 2x, 3x, 4x</p><p style="color:#f44336;">丘멆잺 67% chance to lose!</p>`
                },
                war: {
                    title: '丘덢잺 War - Rules',
                    content: `<p><b>Goal:</b> Your card must be higher than dealer's.</p><p><b>Values:</b> 2<3<...<K<A</p><p><b>Win:</b> 2x bet. Tie = dealer wins.</p>`
                },
                craps: {
                    title: '游 Craps - Rules',
                    content: `<p><b>Pass Line:</b> 7/11=win, 2/3/12=lose, other=Point</p><p><b>Point:</b> Roll Point=win, 7=lose</p><p><b>Win:</b> 2x bet</p>`
                },
                keno: {
                    title: '游댝 Keno - Rules',
                    content: `<p><b>Goal:</b> Guess as many numbers as possible.</p><p><b>How:</b> Pick 1-10 numbers, 10 are drawn.</p><p><b>Payouts:</b> 5 hits=2x, 6=5x, 7=20x, 8=100x, 10=2000x</p>`
                }
            };
            
            const rules = rulesCS;
            const r = rules[game];
            if (!r) return;
            
            const backText = 'ZP캨T KE H콎E';
            showModal(r.title, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; max-height: 350px; overflow-y: auto; -webkit-overflow-scrolling: touch; font-size: 0.85rem;">
                    ${r.content}
                </div>
                <button class="btn" onclick="closeModal(); showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${backText}</button>
            `);
        }
        
        function showCasinoIntro() {
            const introTexts = {
                welcome: '"V칤tej, poutn칤캜e pustiny!"',
                desc: 'Tohle kasino je tu pro chv칤le, kdy zrovna sed칤코 na tr콢nu, 캜ek치코 na autobus, nebo prost캩 pot콏ebuje코 prokrastinovat. Nen칤 to hlavn칤 hra - je to <span style="color: #ffd700;">bonus pro chv칤le nudy</span>.',
                whatAwaits: '游 Co t캩 캜ek치:',
                higherLower: '<b>Vy코코칤/Ni쮄뫆</b> - Tipni sou캜et kostek.',
                pokerDice: '<b>Poker Dice</b> - 5 kostek, 3 hody.',
                slots: '<b>Automaty</b> - To캜 a doufej.',
                blackjack: '<b>Blackjack</b> - Klasika. 21 nebo bankrot.',
                wheel: '<b>Kolo 코t캩st칤</b> - Rozto캜칤코, kam dopadne?',
                war: '<b>War</b> - Tv치 karta vs dealer.',
                craps: '<b>Craps</b> - Klasick칠 kasinov칠 kostky.',
                keno: '<b>Keno</b> - Vyber 캜칤sla a 캜ekej na losov치n칤.',
                pawn: '<b>맔ejd</b> - Vykoup칤 tv콢j haramp치d칤.',
                warning: '丘멆잺 Varov치n칤: D콢m v쬯ycky vyhr치v치. V쬯ycky. Hraj zodpov캩dn캩.',
                enter: '游꿣 Vstoupit do kasina',
                leave: '游뛁 Rad코i ne, m치m rozum'
            };
            
            showModal('游꿣 WASTELAND CASINO', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游꿣游뛓游</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a1a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ffd70040;">
                    <p style="color: #ffd700; font-style: italic; margin: 0 0 0.5rem 0; text-align: center;">
                        ${introTexts.welcome}
                    </p>
                    <p style="color: #aaa; font-size: 0.85rem; margin: 0;">
                        ${introTexts.desc}
                    </p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0; font-size: 0.9rem;">${introTexts.whatAwaits}</h4>
                    <div style="font-size: 0.75rem; color: #aaa;">
                        <p style="margin: 0.3rem 0;">游 ${introTexts.higherLower}</p>
                        <p style="margin: 0.3rem 0;">游 ${introTexts.pokerDice}</p>
                        <p style="margin: 0.3rem 0;">游 ${introTexts.slots}</p>
                        <p style="margin: 0.3rem 0;">游 ${introTexts.blackjack}</p>
                        <p style="margin: 0.3rem 0;">游꿔 ${introTexts.wheel}</p>
                        <p style="margin: 0.3rem 0;">丘덢잺 ${introTexts.war}</p>
                        <p style="margin: 0.3rem 0;">游 ${introTexts.craps}</p>
                        <p style="margin: 0.3rem 0;">游댝 ${introTexts.keno}</p>
                        <p style="margin: 0.3rem 0;">游뱟 ${introTexts.pawn}</p>
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f4433640;">
                    <p style="color: #f44336; font-size: 0.75rem; margin: 0; text-align: center;">
                        ${introTexts.warning}
                    </p>
                </div>
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%); color: #000; font-weight: bold; padding: 0.8rem;">
                    ${introTexts.enter}
                </button>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    ${introTexts.leave}
                </button>
            `);
        }
        
        function showCasinoMain() {
            consolidateInventory();
            
            const tokens = getCasinoTokens();
            const balance = (state.casinoStats?.totalWon || 0) - (state.casinoStats?.totalLost || 0);
            
            // Kontrola bonusu podle re치ln칠ho 캜asu (24 hodin)
            const now = Date.now();
            const lastTokenTime = state.casinoLastTokenTime || 0;
            const oneDayMs = 24 * 60 * 60 * 1000;
            const gotTodayBonus = (now - lastTokenTime) < oneDayMs;
            
            // Spo캜칤tej 캜as do dal코칤ho bonusu
            let timeToBonus = '';
            if (gotTodayBonus) {
                const msLeft = oneDayMs - (now - lastTokenTime);
                const hoursLeft = Math.floor(msLeft / (60 * 60 * 1000));
                const minsLeft = Math.floor((msLeft % (60 * 60 * 1000)) / (60 * 1000));
                timeToBonus = `Reset za ${hoursLeft}h ${minsLeft}m`;
            }
            
            const casinoTexts = {
                tokens: 'kasinov칠 쬰tony',
                dailyBonus: 'Denn칤 bonus:',
                claimed: '九 Z칤sk치no',
                ready: '+1000 游꿞 p콏ipraveno!',
                claim: 'Vyzvednout!',
                exchange: 'Sm캩n치rna:',
                exchangeBtn: 'Vym캩nit',
                odds: '丘멆잺 마nce casina: 55% | Tvoje 코ance: 45%',
                higherLower: 'Vy코코칤/Ni쮄뫆',
                pokerDice: 'Poker Dice',
                slots: 'Automaty',
                blackjack: 'Blackjack',
                wheelOfFortune: 'Kolo 코t캩st칤',
                war: 'War',
                craps: 'Craps',
                keno: 'Keno',
                pawnShop: '맔ejd - Rychl칳 v칳kup (za 游눯)',
                wins: 'V칳hry',
                losses: 'Prohry',
                balance: 'Bilance',
                info: 'Info',
                close: 'Zav콏칤t'
            };
            
            showModal('游꿣 WASTELAND CASINO', `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <div style="font-size: 2rem;">游꿣游쓇릒</div>
                    <p style="color: #9c27b0; font-weight: bold; font-size: 1.3rem;">${tokens} 游꿞</p>
                    <p style="color: #888; font-size: 0.7rem;">${casinoTexts.tokens}</p>
                </div>
                
                <!-- INFO BOX -->
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 0.6rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #9c27b040;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">
                        <div style="font-size: 0.75rem;">
                            <span style="color: #ce93d8;">游늰 ${casinoTexts.dailyBonus}</span>
                            <span style="color: ${gotTodayBonus ? '#888' : '#ffd700'};">${gotTodayBonus ? `${casinoTexts.claimed} (${timeToBonus})` : casinoTexts.ready}</span>
                        </div>
                        ${!gotTodayBonus ? `<button class="btn" onclick="checkDailyCasinoTokens(); showCasinoMain();" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); padding: 0.2rem 0.5rem; font-size: 0.7rem; color: #000; font-weight: bold;">${casinoTexts.claim}</button>` : ''}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.75rem;">
                            <span style="color: #ce93d8;">游눰 ${casinoTexts.exchange}</span>
                            <span style="color: #aaa;">5000 游꿞  200 游눯</span>
                        </div>
                        <button class="btn" onclick="if(exchangeTokensForMoney()) showCasinoMain();" style="background: ${tokens >= 5000 ? 'linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%)' : '#333'}; padding: 0.3rem 0.6rem; font-size: 0.7rem;" ${tokens >= 5000 ? '' : 'disabled'}>
                            ${casinoTexts.exchangeBtn}
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                    <button class="btn" onclick="showHighLowGame()" style="background: linear-gradient(135deg, #1a5a1a 0%, #2d8a2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">游쓇릝</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.higherLower}</div>
                    </button>
                    <button class="btn" onclick="showKeno()" style="background: linear-gradient(135deg, #3a3a1a 0%, #5a5a2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">游댝</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.keno}</div>
                    </button>
                    ${isAdmin() ? `
                    <button class="btn" onclick="showPokerDice()" style="background: linear-gradient(135deg, #5a1a5a 0%, #8a2d8a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">游쓇릝쓇릝</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.pokerDice}</div>
                    </button>
                    <button class="btn" onclick="showSlotMachine()" style="background: linear-gradient(135deg, #5a5a1a 0%, #8a8a2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">游뉧릜游</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.slots}</div>
                    </button>
                    <button class="btn" onclick="showBlackjack()" style="background: linear-gradient(135deg, #1a1a5a 0%, #2d2d8a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">游鮫멆잺</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.blackjack}</div>
                    </button>
                    <button class="btn" onclick="showWheelOfFortune()" style="background: linear-gradient(135deg, #5a1a3a 0%, #8a2d5a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">游꿔</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.wheelOfFortune}</div>
                    </button>
                    <button class="btn" onclick="showWarGame()" style="background: linear-gradient(135deg, #3a1a1a 0%, #5a2d2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">丘덢잺游</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.war}</div>
                    </button>
                    <button class="btn" onclick="showCraps()" style="background: linear-gradient(135deg, #1a3a3a 0%, #2d5a5a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">游쓇릝</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.craps}</div>
                    </button>
                    ` : `
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">游</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Poker Dice</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">游</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Automaty</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">游</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Blackjack</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">游</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Kolo 코t캩st칤</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">游</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">V치lka</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">游</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Craps</div>
                    </button>
                    `}
                    <p style="grid-column: span 3; color: #666; font-size: 0.7rem; text-align: center; margin: 0.3rem 0 0 0;">游댢 Dal코칤 hry budou brzy dostupn칠!</p>
                </div>
                
                <button class="btn" onclick="showCasinoPawnShop()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #5a3a1a 0%, #8a5a2d 100%); padding: 0.5rem;">
                    <span style="font-size: 1rem;">游뱟</span> <span style="font-weight: bold; font-size: 0.85rem;">${casinoTexts.pawnShop}</span>
                </button>
                
                <div style="margin-top: 0.5rem; padding: 0.3rem; background: #1a1a1a; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-around; text-align: center; font-size: 0.65rem;">
                        <div><span style="color: #4caf50;">${state.casinoStats?.totalWon || 0}</span><br><span style="color: #888;">${casinoTexts.wins} 游꿞</span></div>
                        <div><span style="color: #f44336;">${state.casinoStats?.totalLost || 0}</span><br><span style="color: #888;">${casinoTexts.losses} 游꿞</span></div>
                        <div><span style="color: ${balance >= 0 ? '#9c27b0' : '#f44336'};">${balance >= 0 ? '+' : ''}${balance}</span><br><span style="color: #888;">${casinoTexts.balance}</span></div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button class="btn" onclick="showCasinoIntro()" style="flex: 1; background: #333; font-size: 0.7rem;">仇 ${casinoTexts.info}</button>
                    <button class="btn" onclick="closeModal()" style="flex: 2; background: #555;">九 ${casinoTexts.close}</button>
                </div>
            `);
        }
        
        // === MEJD - RYCHL칗 V칗KUP ===
        function showCasinoPawnShop() {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            
            const pawnTexts = {
                quote: '"Vykoup칤m cokoliv, 쮂멳n칳 ot치zky..."',
                tokens: '콯etony', items: 'P콏edm캩ty:', resources: 'Suroviny:',
                noItems: '콯치dn칠 v캩ci k prodeji', sellAll: 'Prodat VE', back: 'Casino', each: 'ks'
            };
            
            let itemsHtml = '';
            // Projdi v코echny itemy a zapamatuj si jejich SKUTE캛N칗 index
            const sellableItems = [];
            state.inv.forEach((item, realIndex) => {
                // Neprod치vej quest itemy a vybaven칠 v캩ci
                if (item.quest) return;
                if (state.equipped?.weapon?.id === item.id) return;
                if (state.equipped?.armor?.id === item.id) return;
                sellableItems.push({ item, realIndex });
            });
            
            if (sellableItems.length > 0) {
                itemsHtml = '<div style="max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 0.5rem;">';
                sellableItems.forEach(({ item, realIndex }) => {
                    const basePrice = item.price || item.traderPrice || 20;
                    const sellPrice = Math.floor(basePrice * 0.5);
                    const qty = item.quantity || 1;
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #222; margin: 0.3rem 0; border-radius: 6px; gap: 0.5rem;">
                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.icon || '游닍'} ${getItemName(item.id) || item.name} ${qty > 1 ? '('+qty+')' : ''}</span>
                            <button class="btn" onclick="sellToPawnShop('item', ${realIndex})" style="background: #4caf50; padding: 0.4rem 0.8rem; font-size: 0.8rem; min-width: 70px;">
                                ${sellPrice * qty} 游꿞
                            </button>
                        </div>
                    `;
                });
                itemsHtml += '</div>';
            } else {
                itemsHtml = `<p style="color: #888; text-align: center; font-size: 0.85rem;">${pawnTexts.noItems}</p>`;
            }
            
            let resourcesHtml = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem;">';
            Object.entries(state.resources || {}).forEach(([res, amount]) => {
                if (amount > 0 && resourceValues[res]) {
                    const icons = { wood: '游뿻', metal: '游댤', cloth: '游빗', electronics: '游댋', chemicals: '游빍', glass: '游댩', food: '游볾', water: '游눦', meds: '游눍', fuel: '久' };
                    const sellPrice = Math.floor(resourceValues[res] * 0.5);
                    resourcesHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; background: #222; border-radius: 6px; font-size: 0.85rem;">
                            <span>${icons[res] || '游닍'} ${amount}</span>
                            <button class="btn" onclick="sellToPawnShop('resource', '${res}')" style="background: #ff9800; padding: 0.3rem 0.5rem; font-size: 0.75rem;">
                                ${sellPrice}游꿞/${pawnTexts.each}
                            </button>
                        </div>
                    `;
                }
            });
            resourcesHtml += '</div>';
            
            showModal('游뱟 MEJD - V칗KUP', `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <div style="font-size: 2rem;">游뱟游꿞游눳</div>
                    <p style="color: #888; font-size: 0.8rem; font-style: italic;">${pawnTexts.quote}</p>
                    <p style="color: #ffd700;">${pawnTexts.tokens}: ${getCasinoTokens()} 游꿞</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #ff9800; font-size: 0.85rem;">游닍 ${pawnTexts.items}</h4>
                    ${itemsHtml}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #ff9800; font-size: 0.85rem;">游빔 ${pawnTexts.resources}</h4>
                    ${resourcesHtml}
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="sellAllToPawnShop()" style="flex: 1; background: #c62828; padding: 0.6rem; font-weight: bold;">
                        游눶 ${pawnTexts.sellAll}
                    </button>
                    <button class="btn" onclick="showCasino()" style="flex: 1; background: #555; padding: 0.6rem;">
                         ${pawnTexts.back}
                    </button>
                </div>
            `);
        }
        
        function sellToPawnShop(type, identifier) {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            const icons = { wood: '游뿻', metal: '游댤', cloth: '游빗', electronics: '游댋', chemicals: '游빍', glass: '游댩', food: '游볾', water: '游눦', meds: '游눍', fuel: '久' };
            
            let itemName = '';
            let sellPrice = 0;
            let itemIcon = '游닍';
            
            if (type === 'item') {
                const idx = parseInt(identifier);
                const item = state.inv[idx];
                if (!item) return;
                
                const basePrice = item.price || item.traderPrice || 20;
                sellPrice = Math.floor(basePrice * 0.5) * (item.quantity || 1);
                itemName = getItemName(item.id) || item.name;
                itemIcon = item.icon || '游닍';
            } else if (type === 'resource') {
                const res = identifier;
                const amount = state.resources[res] || 0;
                if (amount <= 0) return;
                
                sellPrice = Math.floor(resourceValues[res] * 0.5) * amount;
                itemName = `${amount}x ${res}`;
                itemIcon = icons[res] || '游닍';
            }
            
            // Zobraz potvrzen칤
            showModal('丘멆잺 Potvrdit prodej', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${itemIcon}</div>
                    <p style="color: #ff9800; font-size: 1.1rem; margin-bottom: 0.5rem;">${'Opravdu prodat?'}</p>
                    <p style="color: #fff; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">${itemName}</p>
                    <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                        <span style="color: #888;">${'Dostane코:'}</span>
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;">+${sellPrice} 游꿞</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="showCasinoPawnShop()" style="flex: 1; background: #555; padding: 0.7rem; font-size: 1rem;"> ${'Zru코it'}</button>
                        <button class="btn" onclick="confirmSellToPawnShop('${type}', '${identifier}')" style="flex: 1; background: #c62828; padding: 0.7rem; font-size: 1rem;">游딈勇 ${'Prodat'}</button>
                    </div>
                </div>
            `);
        }
        
        function confirmSellToPawnShop(type, identifier) {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            
            if (type === 'item') {
                const idx = parseInt(identifier);
                const item = state.inv[idx];
                if (!item) return;
                
                const basePrice = item.price || item.traderPrice || 20;
                const sellPrice = Math.floor(basePrice * 0.5);
                const qty = item.quantity || 1;
                const total = sellPrice * qty;
                
                addCasinoTokens(total);
                state.inv.splice(idx, 1);
                
                const humor = getRandomHumor('pawnShop');
                notifySuccess(`+${total} 游눯`, humor);
            } else if (type === 'resource') {
                const res = identifier;
                const amount = state.resources[res] || 0;
                if (amount <= 0) return;
                
                const sellPrice = Math.floor(resourceValues[res] * 0.5);
                const total = sellPrice * amount;
                
                addCasinoTokens(total);
                state.resources[res] = 0;
                
                const humor = getRandomHumor('pawnShop');
                notifySuccess(`+${total} 游눯`, humor);
            }
            
            saveGame(true);
            renderFull();
            showCasinoPawnShop();
        }
        
        function sellAllToPawnShop() {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            
            let total = 0;
            
            // Prodej v코echny suroviny
            Object.entries(state.resources || {}).forEach(([res, amount]) => {
                if (amount > 0 && resourceValues[res]) {
                    const sellPrice = Math.floor(resourceValues[res] * 0.5);
                    total += sellPrice * amount;
                    state.resources[res] = 0;
                }
            });
            
            // Prodej v코echny prodejn칠 p콏edm캩ty
            const toRemove = [];
            state.inv.forEach((item, idx) => {
                if (item.quest) return;
                if (state.equipped?.weapon?.id === item.id) return;
                if (state.equipped?.armor?.id === item.id) return;
                
                const basePrice = item.price || item.traderPrice || 20;
                const sellPrice = Math.floor(basePrice * 0.5);
                const qty = item.quantity || 1;
                total += sellPrice * qty;
                toRemove.push(idx);
            });
            
            // Odstra켿 prodan칠 p콏edm캩ty (odzadu)
            toRemove.reverse().forEach(idx => state.inv.splice(idx, 1));
            
            addCasinoTokens(total);
            
            if (total > 0) {
                const humor = getRandomHumor('pawnShop');
                notifySuccess(`+${total} 游눯`, humor);
            } else {
                notifyError('Nic k prodeji', 'Nem치코 co prodat');
            }
            
            saveGame(true);
            renderFull();
            showCasinoPawnShop();
        }
        
        // === VY먠먞 / NI콯먞 ===
        function showHighLowGame() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0, highLowWins: 0, pokerWins: 0 };
            
            showModal('游 Vy코코칤 / Ni쮄뫆', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;" id="diceDisplay">游 游</div>
                    <p style="color: #888;">Sou캜et dvou kostek: 2-12</p>
                    <p style="color: #9c27b0; font-weight: bold;" id="highLowMoney">콯etony: ${getCasinoTokens()} 游꿞</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p style="color: #8bc34a; margin: 0 0 0.5rem 0; text-align: center;">游꿢 Pravidla:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; text-align: center; font-size: 0.8rem;">
                        <div style="background: #2a3a2a; padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #4caf50;">拘勇 Ni쮄뫆 (2-5)</div>
                            <div style="color: #9c27b0;">2x s치zka</div>
                        </div>
                        <div style="background: #3a3a1a; padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #ff9800;">7勇 P콏esn캩 7</div>
                            <div style="color: #9c27b0;">5x s치zka</div>
                        </div>
                        <div style="background: #2a3a2a; padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #f44336;">拘勇 Vy코코칤 (9-12)</div>
                            <div style="color: #9c27b0;">2x s치zka</div>
                        </div>
                    </div>
                    <p style="color: #ff6666; font-size: 0.7rem; text-align: center; margin: 0.5rem 0 0 0;">丘멆잺 6 a 8 = prohra (house edge)</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游꿞 S치zka:</label>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                        <button class="btn" onclick="setHighLowBet(50)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet50">50</button>
                        <button class="btn" onclick="setHighLowBet(100)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet100">100</button>
                        <button class="btn" onclick="setHighLowBet(250)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet250">250</button>
                        <button class="btn" onclick="setHighLowBet(500)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet500">500</button>
                        <button class="btn" onclick="setHighLowBet(getCasinoTokens())" style="flex: 1; background: #8b0000; padding: 0.5rem;">ALL IN</button>
                    </div>
                    <p style="text-align: center; margin-top: 0.5rem; color: #9c27b0;" id="currentBetDisplay">Aktu치ln칤 s치zka: 50 游꿞</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="playHighLow('low')" style="background: linear-gradient(180deg, #1a5a1a 0%, #0a3a0a 100%); padding: 1rem;">
                        <div style="font-size: 1.5rem;">拘勇</div>
                        <div>Ni쮄뫆</div>
                        <div style="font-size: 0.7rem; color: #aaa;">2-5</div>
                    </button>
                    <button class="btn" onclick="playHighLow('seven')" style="background: linear-gradient(180deg, #5a5a1a 0%, #3a3a0a 100%); padding: 1rem;">
                        <div style="font-size: 1.5rem;">7勇</div>
                        <div>Sedma</div>
                        <div style="font-size: 0.7rem; color: #aaa;">Jackpot!</div>
                    </button>
                    <button class="btn" onclick="playHighLow('high')" style="background: linear-gradient(180deg, #5a1a1a 0%, #3a0a0a 100%); padding: 1rem;">
                        <div style="font-size: 1.5rem;">拘勇</div>
                        <div>Vy코코칤</div>
                        <div style="font-size: 0.7rem; color: #aaa;">9-12</div>
                    </button>
                </div>
                
                <div id="highLowResult" style="margin-top: 1rem; text-align: center; min-height: 60px;"></div>
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t do kasina</button>
            `);
            
            window.currentHighLowBet = 50;
        }
        
        function setHighLowBet(amount) {
            const bet = Math.min(amount, getCasinoTokens());
            window.currentHighLowBet = Math.max(1, bet);
            document.getElementById('currentBetDisplay').innerHTML = `Aktu치ln칤 s치zka: ${window.currentHighLowBet} 游꿞`;
            
            // Highlight selected
            ['bet10', 'bet25', 'bet50', 'bet100'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.background = '#333';
            });
        }
        
        function playHighLow(choice) {
            const bet = window.currentHighLowBet || 50;
            
            if (getCasinoTokens() < bet) {
                notifyError('M치lo 쬰ton콢!', `Pot콏ebuje코 ${bet} 游꿞`);
                return;
            }
            
            addCasinoTokens(-bet);
            const moneyEl = document.getElementById('highLowMoney');
            if (moneyEl) moneyEl.innerHTML = `콯etony: ${getCasinoTokens()} 游꿞`;
            
            const diceDisplay = document.getElementById('diceDisplay');
            let animCount = 0;
            const diceEmojis = ['丘', '丘', '丘', '丘', '丘', '丘'];
            const animInterval = setInterval(() => {
                const d1 = diceEmojis[Math.floor(Math.random() * 6)];
                const d2 = diceEmojis[Math.floor(Math.random() * 6)];
                diceDisplay.innerHTML = d1 + ' ' + d2;
                diceDisplay.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
                animCount++;
                if (animCount > 15) {
                    clearInterval(animInterval);
                    finishHighLowRoll(choice, bet);
                }
            }, 80);
            SoundSystem.play('click');
        }
        
        function finishHighLowRoll(choice, bet) {
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            const total = dice1 + dice2;
            
            const diceEmojis = ['', '丘', '丘', '丘', '丘', '丘', '丘'];
            const diceDisplay = document.getElementById('diceDisplay');
            diceDisplay.innerHTML = diceEmojis[dice1] + ' ' + diceEmojis[dice2];
            diceDisplay.style.transform = 'rotate(0deg)';
            
            let won = false;
            let multiplier = 0;
            
            if (choice === 'low' && total >= 2 && total <= 5) { won = true; multiplier = 2; }
            else if (choice === 'high' && total >= 9 && total <= 12) { won = true; multiplier = 2; }
            else if (choice === 'seven' && total === 7) { won = true; multiplier = 5; }
            
            const resultDiv = document.getElementById('highLowResult');
            
            // P콏i캜ti progress pro denn칤 칰kol
            addCasinoGambledProgress();
            
            if (won) {
                const winnings = bet * multiplier;
                addCasinoTokens(winnings);
                state.casinoStats.totalWon += winnings - bet;
                state.casinoStats.highLowWins++;
                const humor = multiplier >= 5 ? getRandomHumor('casinoJackpot') : getRandomHumor('casinoWin');
                resultDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1a3a1a 0%, #2a5a2a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #4caf50;">
                        <div style="font-size: 1.5rem;">游꿀</div>
                        <div style="color: #4caf50; font-weight: bold;">V칗HRA! +${winnings} 游꿞</div>
                        <div style="color: #888; font-size: 0.75rem;">Sou캜et: ${total} (${multiplier}x)</div>
                        <div style="color: #8bc34a; font-size: 0.7rem; font-style: italic; margin-top: 0.3rem;">${humor}</div>
                    </div>`;
                SoundSystem.play('victory');
            } else {
                state.casinoStats.totalLost += bet;
                const humor = getRandomHumor('casinoLose');
                resultDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #3a1a1a 0%, #5a2a2a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #f44336;">
                        <div style="font-size: 1.5rem;">游땩</div>
                        <div style="color: #f44336; font-weight: bold;">PROHRA -${bet} 游꿞</div>
                        <div style="color: #888; font-size: 0.75rem;">Sou캜et: ${total}</div>
                        <div style="color: #ff8a80; font-size: 0.7rem; font-style: italic; margin-top: 0.3rem;">${humor}</div>
                    </div>`;
                SoundSystem.play('damage');
            }
            
            const moneyEl = document.getElementById('highLowMoney');
            if (moneyEl) moneyEl.innerHTML = `콯etony: ${getCasinoTokens()} 游꿞`;
            saveGame(true);
        }
        
        // === POKER DICE ===
        function showPokerDice() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0, highLowWins: 0, pokerWins: 0 };
            if (!state.pokerDice) state.pokerDice = { dice: [0,0,0,0,0], held: [false,false,false,false,false], rolls: 0, bet: 0, phase: 'betting' };
            
            state.pokerDice = { dice: [0,0,0,0,0], held: [false,false,false,false,false], rolls: 0, bet: 0, phase: 'betting' };
            
            renderPokerDice();
        }
        
        function renderPokerDice() {
            const pd = state.pokerDice;
            
            // Pro 14st캩nnou kostku zobrazujeme 캜칤sla
            const diceHtml = pd.dice.map((d, i) => `
                <div onclick="togglePokerHold(${i})" style="
                    width: 50px; height: 50px; 
                    background: ${pd.held[i] ? 'linear-gradient(135deg, #ffd700 0%, #b8860b 100%)' : 'linear-gradient(135deg, #333 0%, #1a1a1a 100%)'};
                    border: 3px solid ${pd.held[i] ? '#ffd700' : '#555'};
                    border-radius: 50%;
                    display: flex; align-items: center; justify-content: center;
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: ${pd.held[i] ? '#000' : '#fff'};
                    cursor: ${pd.phase === 'rolling' ? 'pointer' : 'default'};
                    transition: all 0.2s;
                    ${pd.held[i] ? 'box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);' : ''}
                " id="pokerDie${i}">
                    ${d > 0 ? d : '?'}
                </div>
            `).join('');
            
            const handInfo = pd.rolls > 0 ? evaluatePokerHand(pd.dice) : { name: '-', multiplier: 0 };
            const maxRolls = 3;
            
            const payoutTable = `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin: 0.5rem 0; font-size: 0.65rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                        <span style="color: #9c27b0; font-weight: bold;">游 14st캩nn칠 kostky  3 hody</span>
                        <button class="btn" onclick="showGameRules('poker')" style="padding: 0.15rem 0.4rem; background: #333; font-size: 0.6rem;">仇</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.2rem;">
                        <div style="color: #888;">Dva p치ry: <span style="color: #ffd700;">1x</span></div>
                        <div style="color: #c62828;">Trojice: <span style="color: #ffd700;">1.5x</span></div>
                        <div style="color: #888;">Full House: <span style="color: #ffd700;">3x</span></div>
                        <div style="color: #888;">캛tve콏ice: <span style="color: #ffd700;">6x</span></div>
                        <div style="color: #888;">Mal치 postupka: <span style="color: #ffd700;">10x</span></div>
                        <div style="color: #888;">P캩tice: <span style="color: #ffd700;">30x</span></div>
                        <div style="color: #888;">Velk치 postupka: <span style="color: #ffd700;">25x</span></div>
                    </div>
                </div>
            `;
            
            let actionButtons = '';
            
            if (pd.phase === 'betting') {
                actionButtons = `
                    <div style="margin: 1rem 0;">
                        <label style="color: #888; font-size: 0.85rem;">游꿞 S치zka:</label>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="startPokerDice(10)" style="flex: 1; background: #333;">10</button>
                            <button class="btn" onclick="startPokerDice(25)" style="flex: 1; background: #333;">25</button>
                            <button class="btn" onclick="startPokerDice(50)" style="flex: 1; background: #333;">50</button>
                            <button class="btn" onclick="startPokerDice(100)" style="flex: 1; background: #333;">100</button>
                        </div>
                    </div>
                `;
            } else if (pd.phase === 'rolling') {
                actionButtons = `
                    <div style="margin: 1rem 0; text-align: center;">
                        <p style="color: #888; font-size: 0.85rem;">Klikni na kostky pro dr쬰n칤, pak ho캞 znovu</p>
                        <p style="color: #ffd700;">Zb칳vaj칤c칤 hody: ${maxRolls - pd.rolls}</p>
                        <button class="btn" onclick="rollPokerDice()" style="background: linear-gradient(135deg, #5a1a5a 0%, #8a2d8a 100%); padding: 1rem; width: 100%;">
                            游 Hodit ${pd.rolls === 0 ? '' : 'znovu'} (${maxRolls - pd.rolls} zb칳v치)
                        </button>
                    </div>
                `;
            } else if (pd.phase === 'finished') {
                const result = evaluatePokerHand(pd.dice);
                const winnings = pd.bet * result.multiplier;
                const humor = result.multiplier >= 15 ? getRandomHumor('casinoJackpot') : (result.multiplier > 0 ? getRandomHumor('casinoWin') : getRandomHumor('casinoLose'));
                
                actionButtons = `
                    <div style="margin: 1rem 0; text-align: center;">
                        <div style="background: ${result.multiplier > 0 ? 'linear-gradient(135deg, #1a3a1a 0%, #2a5a2a 100%)' : 'linear-gradient(135deg, #3a1a1a 0%, #5a2a2a 100%)'}; padding: 1rem; border-radius: 8px; border: 2px solid ${result.multiplier > 0 ? '#4caf50' : '#f44336'};">
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${result.multiplier > 0 ? '#4caf50' : '#f44336'};">${result.name}</div>
                            ${result.multiplier > 0 ? `<div style="color: #ffd700; font-size: 1.3rem;">+${winnings} 游꿞 (${result.multiplier}x)</div>` : '<div style="color: #888;">콯치dn치 v칳hra</div>'}
                            <div style="color: ${result.multiplier > 0 ? '#8bc34a' : '#ff8a80'}; font-size: 0.7rem; font-style: italic; margin-top: 0.3rem;">${humor}</div>
                        </div>
                        <button class="btn" onclick="showPokerDice()" style="background: #5a1a5a; margin-top: 1rem; width: 100%;">游댃 Hr치t znovu</button>
                    </div>
                `;
            }
            
            showModal('游 Poker Dice', `
                <div style="text-align: center;">
                    <p style="color: #9c27b0; font-weight: bold;">Tv칠 쬰tony: ${getCasinoTokens()} 游꿞</p>
                    ${pd.bet > 0 ? `<p style="color: #888;">S치zka: ${pd.bet} 游꿞</p>` : ''}
                </div>
                
                <div style="display: flex; justify-content: center; gap: 0.5rem; margin: 1rem 0;">
                    ${diceHtml}
                </div>
                
                ${pd.rolls > 0 ? `
                    <div style="text-align: center; padding: 0.5rem; background: ${handInfo.multiplier > 0 ? '#1a2a1a' : '#2a2a2a'}; border-radius: 8px; margin: 0.5rem 0;">
                        <span style="color: ${handInfo.multiplier > 0 ? '#4caf50' : '#888'}; font-weight: bold;">${handInfo.name}</span>
                        ${handInfo.multiplier > 0 ? `<span style="color: #ffd700;"> (${handInfo.multiplier}x)</span>` : ''}
                    </div>
                ` : ''}
                
                ${payoutTable}
                ${actionButtons}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t do kasina</button>
            `);
        }
        
        function startPokerDice(bet) {
            if (getCasinoTokens() < bet) {
                notifyError('M치lo 쬰ton콢!', `Pot콏ebuje코 ${bet} 游꿞`);
                return;
            }
            
            addCasinoTokens(-bet);
            state.pokerDice.bet = bet;
            state.pokerDice.phase = 'rolling';
            state.pokerDice.rolls = 0;
            state.pokerDice.dice = [0,0,0,0,0];
            state.pokerDice.held = [false,false,false,false,false];
            
            renderPokerDice();
        }
        
        function togglePokerHold(index) {
            if (state.pokerDice.phase !== 'rolling' || state.pokerDice.rolls === 0) return;
            state.pokerDice.held[index] = !state.pokerDice.held[index];
            renderPokerDice();
        }
        
        function rollPokerDice() {
            const pd = state.pokerDice;
            
            if (pd.rolls >= 3) return; // 3 hody
            
            // Animace
            let animCount = 0;
            const animInterval = setInterval(() => {
                for (let i = 0; i < 5; i++) {
                    if (!pd.held[i]) {
                        const dieEl = document.getElementById(`pokerDie${i}`);
                        if (dieEl) {
                            // 14st캩nn치 kostka (1-14)
                            dieEl.innerHTML = Math.floor(Math.random() * 14) + 1;
                            dieEl.style.transform = `rotate(${Math.random() * 30 - 15}deg)`;
                        }
                    }
                }
                animCount++;
                if (animCount > 12) {
                    clearInterval(animInterval);
                    finishPokerRoll();
                }
            }, 60);
            
            SoundSystem.play('click');
        }
        
        function finishPokerRoll() {
            const pd = state.pokerDice;
            
            // Ho캞 nepodr쬰n칳mi kostkami (14st캩nn치 kostka)
            for (let i = 0; i < 5; i++) {
                if (!pd.held[i]) {
                    pd.dice[i] = Math.floor(Math.random() * 14) + 1;
                }
            }
            
            pd.rolls++;
            
            // Pokud je to 5. hod, vyhodno콘
            if (pd.rolls >= 3) {
                pd.phase = 'finished';
                const result = evaluatePokerHand(pd.dice);
                
                // P콏i캜ti progress pro denn칤 칰kol
                addCasinoGambledProgress();
                
                if (result.multiplier > 0) {
                    const winnings = pd.bet * result.multiplier;
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - pd.bet;
                    state.casinoStats.pokerWins++;
                    SoundSystem.play('victory');
                } else {
                    state.casinoStats.totalLost += pd.bet;
                    SoundSystem.play('damage');
                }
            }
            
            saveGame(true);
            renderPokerDice();
        }
        
        function evaluatePokerHand(dice) {
            const sorted = [...dice].sort((a, b) => a - b);
            const counts = {};
            dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
            const values = Object.values(counts).sort((a, b) => b - a);
            
            // P캩tice (v코ech 5 stejn칳ch) - extr칠mn캩 vz치cn칠 s 14st캩nnou kostkou
            if (values[0] === 5) return { name: '游 P캨TICE! 游', multiplier: 30 };
            
            // Velk치 postupka (5 캜칤sel po sob캩 z 1-14) - extr칠mn캩 vz치cn칠
            const uniqueSorted = [...new Set(sorted)].sort((a,b) => a-b);
            if (uniqueSorted.length === 5) {
                const isSequential = uniqueSorted.every((val, idx) => 
                    idx === 0 || val === uniqueSorted[idx-1] + 1
                );
                if (isSequential) {
                    return { name: '游꿢 Velk치 postupka!', multiplier: 25 };
                }
            }
            
            // 캛tve콏ice
            if (values[0] === 4) return { name: '游눑 캛tve콏ice!', multiplier: 6 };
            
            // Mal치 postupka (4 캜칤sla po sob캩 z 1-14)
            if (uniqueSorted.length >= 4) {
                for (let i = 0; i <= uniqueSorted.length - 4; i++) {
                    const slice = uniqueSorted.slice(i, i + 4);
                    const isSeq = slice.every((val, idx) => 
                        idx === 0 || val === slice[idx-1] + 1
                    );
                    if (isSeq) {
                        return { name: '游늳 Mal치 postupka', multiplier: 10 };
                    }
                }
            }
            
            // Full House (trojice + p치r)
            if (values[0] === 3 && values[1] === 2) return { name: '游 Full House!', multiplier: 3 };
            
            // Trojice
            if (values[0] === 3) return { name: '游 Trojice', multiplier: 1.5 };
            
            // Dva p치ry - mal치 v칳hra
            if (values[0] === 2 && values[1] === 2) return { name: '九껊잺 Dva p치ry', multiplier: 1 };
            
            // Jeden p치r - nic
            if (values[0] === 2) return { name: '游놂 P치r', multiplier: 0 };
            
            // Nic
            return { name: 'Nic moc...', multiplier: 0 };
        }
        
        // === SLOT MACHINE ===
        function showSlotMachine() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.slotBet = 10;
            
            const slotTexts = {
                rules: 'Pravidla', tokens: '콯etony', spin: 'ZATO캛IT!', back: 'Casino'
            };
            
            showModal('游꿣 AUTOMATY', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('slots')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">仇 ${slotTexts.rules}</button>
                    <p style="color: #ffd700; margin: 0;">${slotTexts.tokens}: <span id="slotMoney">${getCasinoTokens()}</span> 游꿞</p>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 12px; margin: 0.5rem 0; border: 3px solid #ffd700;">
                    <div style="display: flex; justify-content: center; gap: 0.4rem;" id="slotReels">
                        <div style="width: 50px; height: 60px; background: #111; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid #444;">仇</div>
                        <div style="width: 50px; height: 60px; background: #111; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid #444;">仇</div>
                        <div style="width: 50px; height: 60px; background: #111; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid #444;">仇</div>
                    </div>
                </div>
                <div style="background: #111; padding: 0.3rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.6rem; text-align: center; color: #888;">
                    游=8x | 游꼚=12x | 救=18x | 游=25x | 游눑=40x | 7勇=60x
                </div>
                <div style="display: flex; gap: 0.3rem; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="setSlotBet(10)" id="slotBet10" style="flex: 1; background: #ffd700; color: #000;">10</button>
                    <button class="btn" onclick="setSlotBet(25)" id="slotBet25" style="flex: 1; background: #444;">25</button>
                    <button class="btn" onclick="setSlotBet(50)" id="slotBet50" style="flex: 1; background: #444;">50</button>
                </div>
                <button class="btn" onclick="spinSlots()" style="width: 100%; background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%); color: #000; font-weight: bold; padding: 0.8rem;">游꿣 ${slotTexts.spin}</button>
                <div id="slotResult" style="margin-top: 0.5rem; text-align: center; min-height: 30px;"></div>
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${slotTexts.back}</button>
            `);
        }
        
        function setSlotBet(amt) {
            window.slotBet = Math.min(amt, getCasinoTokens());
            ['slotBet10','slotBet25','slotBet50'].forEach(id => { const e = document.getElementById(id); if(e) { e.style.background='#444'; e.style.color='#fff'; }});
            const e = document.getElementById('slotBet'+amt); if(e) { e.style.background='#ffd700'; e.style.color='#000'; }
        }
        
        function spinSlots() {
            const bet = window.slotBet || 10;
            if (getCasinoTokens() < bet) { notifyError('M치lo 쬰ton콢!'); return; }
            addCasinoTokens(-bet);
            document.getElementById('slotMoney').textContent = getCasinoTokens();
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                addCasinoGambledProgress();
                checkDailyQuests();
            }
            
            // 6 symbol콢 m칤sto 5 = t캩쮄뫆 trefit trojici
            const symbols = ['游','游꼚','游','游눑','7勇','救'];
            const weightedRandom = () => symbols[Math.floor(Math.random() * 6)];
            
            let spins = 0;
            const iv = setInterval(() => {
                document.getElementById('slotReels').innerHTML = [0,1,2].map(() => 
                    `<div style="width:50px;height:60px;background:#111;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:2rem;border:2px solid #ffd700;">${symbols[Math.floor(Math.random()*6)]}</div>`
                ).join('');
                if (++spins > 18) { clearInterval(iv); finishSlot(bet, [weightedRandom(),weightedRandom(),weightedRandom()]); }
            }, 70);
            SoundSystem.play('click');
        }
        
        function finishSlot(bet, r) {
            document.getElementById('slotReels').innerHTML = r.map(s => 
                `<div style="width:50px;height:60px;background:#111;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:2rem;border:2px solid #4caf50;">${s}</div>`
            ).join('');
            
            let m=0, t='';
            // House edge 55% - RTP 45%
            // Trojice = v칳hra - multiplik치tory podle pravidel
            if (r[0]===r[1] && r[1]===r[2]) { 
                m = r[0]==='7勇'?60 : r[0]==='游눑'?40 : r[0]==='游'?25 : r[0]==='救'?18 : r[0]==='游꼚'?12 : 8; 
                t = m>=40?'游꿣 JACKPOT!':'Trojice!'; 
            }
            // Dvojice u nevyhr치v치 - p콏칤li코 캜ast칠 (27.78%)
            
            const rd = document.getElementById('slotResult');
            
            // P콏i캜ti progress pro denn칤 칰kol
            addCasinoGambledProgress();
            
            if (m > 0) {
                const w = Math.floor(bet*m);
                addCasinoTokens(w);
                state.casinoStats.totalWon += w - bet;
                const humor = m >= 40 ? getRandomHumor('casinoJackpot') : getRandomHumor('casinoWin');
                rd.innerHTML = `<div style="color:#4caf50;font-weight:bold;">${t}</div><div style="color:#ffd700;">+${w} 游꿞</div><div style="color:#8bc34a;font-size:0.7rem;font-style:italic;">${humor}</div>`;
                SoundSystem.play('victory');
            } else {
                state.casinoStats.totalLost += bet;
                const humor = getRandomHumor('casinoSlots');
                rd.innerHTML = `<div style="color:#888;">Nic...</div><div style="color:#ff8a80;font-size:0.7rem;font-style:italic;">${humor}</div>`;
            }
            document.getElementById('slotMoney').textContent = getCasinoTokens();
            saveGame(true);
        }
        
        // === BLACKJACK ===
        function showBlackjack() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.bjBet = 20; window.bjState = null;
            
            const bjTexts = {
                rules: 'Pravidla', tokens: '콯etony', dealer: 'DEALER', you: 'TY',
                deal: 'ROZDAT', hit: 'DAL먞', stand: 'ST츼T', back: 'Casino'
            };
            
            showModal('游 BLACKJACK', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('blackjack')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">仇 ${bjTexts.rules}</button>
                    <p style="color: #ffd700; margin: 0;">${bjTexts.tokens}: <span id="bjMoney">${getCasinoTokens()}</span> 游꿞</p>
                </div>
                <div style="background: #0a3a0a; padding: 0.8rem; border-radius: 10px; margin: 0.5rem 0; min-height: 150px;">
                    <div style="text-align: center; color: #888; font-size: 0.7rem;">${bjTexts.dealer}</div>
                    <div id="dealerCards" style="text-align: center; font-size: 1.6rem; min-height: 40px;">游 游</div>
                    <div id="dealerScore" style="text-align: center; color: #ffd700; font-size: 0.8rem;"></div>
                    <div style="border-top: 2px dashed #2a5a2a; margin: 0.4rem 0;"></div>
                    <div id="playerCards" style="text-align: center; font-size: 1.6rem; min-height: 40px;">游 游</div>
                    <div id="playerScore" style="text-align: center; color: #ffd700; font-size: 0.8rem;"></div>
                    <div style="text-align: center; color: #888; font-size: 0.7rem;">${bjTexts.you}</div>
                </div>
                <div id="bjControls">
                    <div style="display: flex; gap: 0.3rem; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="setBjBet(20)" id="bjBet20" style="flex:1;background:#ffd700;color:#000;">20</button>
                        <button class="btn" onclick="setBjBet(50)" id="bjBet50" style="flex:1;background:#444;">50</button>
                        <button class="btn" onclick="setBjBet(100)" id="bjBet100" style="flex:1;background:#444;">100</button>
                    </div>
                    <button class="btn" onclick="startBJ()" style="width:100%;background:#4caf50;font-weight:bold;">游 ${bjTexts.deal}</button>
                </div>
                <div id="bjActions" style="display:none;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="bjHit()" style="flex:1;background:#4caf50;font-weight:bold;">游닌 ${bjTexts.hit}</button>
                        <button class="btn" onclick="bjStand()" style="flex:1;background:#f44336;font-weight:bold;">九 ${bjTexts.stand}</button>
                    </div>
                </div>
                <div id="bjResult" style="margin-top: 0.5rem; text-align: center;"></div>
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${bjTexts.back}</button>
            `);
        }
        
        function setBjBet(a) {
            window.bjBet = Math.min(a, getCasinoTokens());
            ['bjBet20','bjBet50','bjBet100'].forEach(id => { const e=document.getElementById(id); if(e){e.style.background='#444';e.style.color='#fff';} });
            const e=document.getElementById('bjBet'+a); if(e){e.style.background='#ffd700';e.style.color='#000';}
        }
        
        function createDeck() {
            const suits=['鮫','鮫','鮫','鮫'], vals=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], deck=[];
            for(const s of suits) for(const v of vals) deck.push({suit:s,value:v,score:parseInt(v)||(v==='A'?11:10),display:v+s});
            for(let i=deck.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
            return deck;
        }
        
        function getScore(hand) { let s=hand.reduce((a,c)=>a+c.score,0), aces=hand.filter(c=>c.value==='A').length; while(s>21&&aces>0){s-=10;aces--;} return s; }
        
        function startBJ() {
            const bet=window.bjBet||20;
            if(getCasinoTokens()<bet){notifyError('M치lo 쬰ton콢!');return;}
            addCasinoTokens(-bet); document.getElementById('bjMoney').textContent=getCasinoTokens();
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                addCasinoGambledProgress();
                checkDailyQuests();
            }
            
            const deck=createDeck();
            window.bjState={deck,player:[deck.pop(),deck.pop()],dealer:[deck.pop(),deck.pop()],bet,done:false};
            updateBJ(false);
            document.getElementById('bjControls').style.display='none';
            document.getElementById('bjActions').style.display='block';
            document.getElementById('bjResult').innerHTML='';
            if(getScore(window.bjState.player)===21) bjStand();
            SoundSystem.play('click');
        }
        
        function updateBJ(showD) {
            const bj=window.bjState, ps=getScore(bj.player), ds=getScore(bj.dealer);
            document.getElementById('playerCards').innerHTML=bj.player.map(c=>`<span style="color:${c.suit==='鮫'||c.suit==='鮫'?'#f44':'#fff'}">${c.display}</span>`).join(' ');
            document.getElementById('playerScore').textContent=`(${ps})`;
            if(showD) {
                document.getElementById('dealerCards').innerHTML=bj.dealer.map(c=>`<span style="color:${c.suit==='鮫'||c.suit==='鮫'?'#f44':'#fff'}">${c.display}</span>`).join(' ');
                document.getElementById('dealerScore').textContent=`(${ds})`;
            } else {
                document.getElementById('dealerCards').innerHTML=`<span style="color:${bj.dealer[0].suit==='鮫'||bj.dealer[0].suit==='鮫'?'#f44':'#fff'}">${bj.dealer[0].display}</span> 游`;
                document.getElementById('dealerScore').textContent='(?)';
            }
        }
        
        function bjHit() { const bj=window.bjState; if(bj.done)return; bj.player.push(bj.deck.pop()); updateBJ(false); const s=getScore(bj.player); if(s>21)finishBJ('bust'); else if(s===21)bjStand(); }
        function bjStand() { const bj=window.bjState; if(bj.done)return; while(getScore(bj.dealer)<17)bj.dealer.push(bj.deck.pop()); updateBJ(true); const ps=getScore(bj.player),ds=getScore(bj.dealer); if(ds>21)finishBJ('dwin'); else if(ps>ds)finishBJ('win'); else if(ds>ps)finishBJ('lose'); else finishBJ('push'); }
        
        function finishBJ(r) {
            const bj=window.bjState; bj.done=true;
            document.getElementById('bjActions').style.display='none';
            let html='', w=0, humor='';
            const isBJ=bj.player.length===2&&getScore(bj.player)===21;
            
            if(r==='bust') { 
                humor = getRandomHumor('casinoBust');
                html=`<div style="color:#f44;">游눤 P콎ET츼HL!</div><div>-${bj.bet} 游꿞</div><div style="color:#ff8a80;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalLost+=bj.bet; SoundSystem.play('damage'); 
            }
            else if(r==='dwin') { 
                w=bj.bet*2; 
                humor = getRandomHumor('casinoWin');
                html=`<div style="color:#4c5;">游꿀 Dealer p콏et치hl!</div><div style="color:#ffd700;">+${w} 游꿞</div><div style="color:#8bc34a;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalWon+=bj.bet; SoundSystem.play('victory'); 
            }
            else if(r==='win') { 
                w=isBJ?Math.floor(bj.bet*2.5):bj.bet*2; 
                humor = isBJ ? getRandomHumor('casinoJackpot') : getRandomHumor('casinoWin');
                html=`<div style="color:#4c5;">${isBJ?'游 BLACKJACK!':'游꿀 V칗HRA!'}</div><div style="color:#ffd700;">+${w} 游꿞</div><div style="color:#8bc34a;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalWon+=w-bj.bet; SoundSystem.play('victory'); 
            }
            else if(r==='lose') { 
                humor = getRandomHumor('casinoLose');
                html=`<div style="color:#f44;">游땩 Prohra</div><div>-${bj.bet} 游꿞</div><div style="color:#ff8a80;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalLost+=bj.bet; SoundSystem.play('damage'); 
            }
            else { w=bj.bet; html=`<div style="color:#fa0;">游뱋 Rem칤za - s치zka vr치cena</div>`; }
            
            if(w>0) addCasinoTokens(w);
            document.getElementById('bjMoney').textContent=getCasinoTokens();
            document.getElementById('bjResult').innerHTML=html+`<button class="btn" onclick="showBlackjack()" style="margin-top:0.3rem;background:#333;">游댃 Znovu</button>`;
            updateBJ(true); saveGame(true);
        }
        
        // === KOLO T캨ST칈 ===
        function showWheelOfFortune() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            
            // House edge 55% - hr치캜 vyhr치v치 45%
            // 12 segment콢: 7 proher (58%), 5 v칳her (42%) s n칤zk칳mi multiplik치tory
            // RTP: (0*7 + 1.3 + 1.5 + 1.8 + 2 + 2.5) / 12 = 9.1/12 = 75.8% * 42% = ~45% o캜ek치van칳 zisk
            const segments = [
                { label: '游', multiplier: 0, color: '#2a0a0a' },
                { label: '1.3x', multiplier: 1.3, color: '#1a3a1a' },
                { label: '游', multiplier: 0, color: '#2a0a0a' },
                { label: '游', multiplier: 0, color: '#2a0a0a' },
                { label: '1.5x', multiplier: 1.5, color: '#1a4a1a' },
                { label: '游', multiplier: 0, color: '#2a0a0a' },
                { label: '1.8x', multiplier: 1.8, color: '#1a4a1a' },
                { label: '游', multiplier: 0, color: '#2a0a0a' },
                { label: '游', multiplier: 0, color: '#2a0a0a' },
                { label: '2x', multiplier: 2, color: '#1a5a1a' },
                { label: '游', multiplier: 0, color: '#2a0a0a' },
                { label: '游꿀 2.5x', multiplier: 2.5, color: '#3a5a1a' }
            ];
            
            window.wheelSegments = segments;
            window.wheelBet = 0;
            window.wheelSpinning = false;
            
            renderWheelOfFortune();
        }
        
        function renderWheelOfFortune() {
            const segments = window.wheelSegments;
            const bet = window.wheelBet || 0;
            const spinning = window.wheelSpinning || false;
            
            // Vytvo콏 SVG kolo - mnohem p콏ehledn캩j코칤
            const size = 220;
            const center = size / 2;
            const radius = 100;
            const segmentAngle = 360 / segments.length;
            
            let wheelSVG = `<svg width="${size}" height="${size}" style="display: block; margin: 0 auto;">`;
            
            segments.forEach((seg, i) => {
                const startAngle = (i * segmentAngle - 90) * Math.PI / 180;
                const endAngle = ((i + 1) * segmentAngle - 90) * Math.PI / 180;
                
                const x1 = center + radius * Math.cos(startAngle);
                const y1 = center + radius * Math.sin(startAngle);
                const x2 = center + radius * Math.cos(endAngle);
                const y2 = center + radius * Math.sin(endAngle);
                
                const largeArc = segmentAngle > 180 ? 1 : 0;
                
                // Barvy: 캜erven치 pro prohru, zelen치 pro v칳hru
                const color = seg.multiplier === 0 ? '#8B0000' : '#228B22';
                const textColor = '#fff';
                
                wheelSVG += `<path d="M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" 
                    fill="${color}" stroke="#ffd700" stroke-width="2"/>`;
                
                // Text uprost콏ed segmentu
                const midAngle = ((i + 0.5) * segmentAngle - 90) * Math.PI / 180;
                const textRadius = radius * 0.65;
                const tx = center + textRadius * Math.cos(midAngle);
                const ty = center + textRadius * Math.sin(midAngle);
                
                const label = seg.multiplier === 0 ? '游' : seg.multiplier + 'x';
                wheelSVG += `<text x="${tx}" y="${ty}" fill="${textColor}" font-size="${seg.multiplier === 0 ? '16' : '12'}" 
                    font-weight="bold" text-anchor="middle" dominant-baseline="middle">${label}</text>`;
            });
            
            // St콏ed kola
            wheelSVG += `<circle cx="${center}" cy="${center}" r="20" fill="#1a1a1a" stroke="#ffd700" stroke-width="3"/>`;
            wheelSVG += `<text x="${center}" y="${center}" fill="#ffd700" font-size="14" font-weight="bold" text-anchor="middle" dominant-baseline="middle">游꿣</text>`;
            wheelSVG += `</svg>`;
            
            showModal('游꿔 Kolo 코t캩st칤', `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="showGameRules('wheel')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">仇 Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="wheelMoney">${getCasinoTokens()} 游꿞</p>
                </div>
                
                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 0.5rem; font-size: 0.75rem;">
                    <span style="color: #228B22;">游릭 V칳hra</span>
                    <span style="color: #8B0000;">游댮 Prohra</span>
                </div>
                
                <div style="position: relative;">
                    <div style="position: absolute; top: -5px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; z-index: 10;">郊</div>
                    <div id="wheelContainer" style="transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);">
                        ${wheelSVG}
                    </div>
                </div>
                
                <div id="wheelResult" style="text-align: center; margin: 0.5rem 0; min-height: 40px;"></div>
                
                <div style="margin: 0.5rem 0;">
                    <label style="color: #888; font-size: 0.8rem;">S치zka:</label>
                    <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                        <button class="btn" onclick="setWheelBet(10)" style="flex:1;background:${bet===10?'#ffd700':'#333'};color:${bet===10?'#000':'#fff'};">10</button>
                        <button class="btn" onclick="setWheelBet(25)" style="flex:1;background:${bet===25?'#ffd700':'#333'};color:${bet===25?'#000':'#fff'};">25</button>
                        <button class="btn" onclick="setWheelBet(50)" style="flex:1;background:${bet===50?'#ffd700':'#333'};color:${bet===50?'#000':'#fff'};">50</button>
                        <button class="btn" onclick="setWheelBet(100)" style="flex:1;background:${bet===100?'#ffd700':'#333'};color:${bet===100?'#000':'#fff'};">100</button>
                    </div>
                </div>
                
                <button class="btn" id="spinBtn" onclick="spinWheel()" style="width: 100%; background: linear-gradient(135deg, #5a1a3a 0%, #8a2d5a 100%); padding: 0.8rem; font-weight: bold;${spinning || bet === 0 ? ' opacity: 0.5; pointer-events: none;' : ''}">
                    游꿔 Rozto캜it!
                </button>
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function setWheelBet(amount) {
            window.wheelBet = amount;
            renderWheelOfFortune();
        }
        
        function spinWheel() {
            if (window.wheelSpinning || window.wheelBet === 0) return;
            if (getCasinoTokens() < window.wheelBet) {
                notifyError('M치lo 쬰ton콢!', `Pot콏ebuje코 ${window.wheelBet} 游꿞`);
                return;
            }
            
            addCasinoTokens(-window.wheelBet);
            window.wheelSpinning = true;
            
            const segments = window.wheelSegments;
            const segmentAngle = 360 / segments.length;
            const randomSegment = Math.floor(Math.random() * segments.length);
            const extraSpins = 5 + Math.floor(Math.random() * 3);
            const finalRotation = extraSpins * 360 + (360 - randomSegment * segmentAngle - segmentAngle / 2);
            
            const wheel = document.getElementById('wheelContainer');
            wheel.style.transform = `rotate(${finalRotation}deg)`;
            
            SoundSystem.play('click');
            
            setTimeout(() => {
                const result = segments[randomSegment];
                const winnings = Math.floor(window.wheelBet * result.multiplier);
                
                let resultHtml = '';
                if (winnings > 0) {
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - window.wheelBet;
                    resultHtml = `<div style="color: #4caf50; font-size: 1.2rem;">游꿀 V칗HRA! +${winnings} 游꿞</div><div style="color: #888;">(${result.label})</div>`;
                    SoundSystem.play('victory');
                } else {
                    state.casinoStats.totalLost += window.wheelBet;
                    resultHtml = `<div style="color: #f44336; font-size: 1.2rem;">游 Prohra!</div><div style="color: #888;">-${window.wheelBet} 游꿞</div>`;
                    SoundSystem.play('damage');
                }
                
                document.getElementById('wheelResult').innerHTML = resultHtml;
                document.getElementById('wheelMoney').textContent = getCasinoTokens() + ' 游꿞';
                
                window.wheelSpinning = false;
                saveGame(true);
            }, 4500);
        }
        
        // === WAR (V츼LKA) ===
        function showWarGame() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.warBet = 0;
            window.warPhase = 'betting';
            
            renderWarGame();
        }
        
        function renderWarGame() {
            const cardSuits = ['鮫멆잺', '鮫봺잺', '鮫뷢잺', '鮫勇'];
            const cardValues = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            
            showModal('丘덢잺 War (V치lka)', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('war')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">仇 Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="warMoney">${getCasinoTokens()} 游꿞</p>
                </div>
                
                <div style="display: flex; justify-content: space-around; margin: 1rem 0;">
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Ty</div>
                        <div id="playerCard" style="width: 60px; height: 85px; background: linear-gradient(135deg, #1a3a1a 0%, #2a4a2a 100%); border: 2px solid #4caf50; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto;">?</div>
                    </div>
                    <div style="display: flex; align-items: center; font-size: 2rem;">丘덢잺</div>
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Dealer</div>
                        <div id="dealerCard" style="width: 60px; height: 85px; background: linear-gradient(135deg, #3a1a1a 0%, #4a2a2a 100%); border: 2px solid #c62828; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto;">?</div>
                    </div>
                </div>
                
                <div id="warResult" style="text-align: center; min-height: 50px;"></div>
                
                ${window.warPhase === 'betting' ? `
                    <div style="margin: 0.5rem 0;">
                        <label style="color: #888; font-size: 0.8rem;">S치zka:</label>
                        <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="window.warBet=10;renderWarGame()" style="flex:1;background:${window.warBet===10?'#ffd700':'#333'};color:${window.warBet===10?'#000':'#fff'};">10</button>
                            <button class="btn" onclick="window.warBet=25;renderWarGame()" style="flex:1;background:${window.warBet===25?'#ffd700':'#333'};color:${window.warBet===25?'#000':'#fff'};">25</button>
                            <button class="btn" onclick="window.warBet=50;renderWarGame()" style="flex:1;background:${window.warBet===50?'#ffd700':'#333'};color:${window.warBet===50?'#000':'#fff'};">50</button>
                            <button class="btn" onclick="window.warBet=100;renderWarGame()" style="flex:1;background:${window.warBet===100?'#ffd700':'#333'};color:${window.warBet===100?'#000':'#fff'};">100</button>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="playWar()" style="width: 100%; background: linear-gradient(135deg, #3a1a1a 0%, #5a2d2d 100%); padding: 0.8rem;" ${window.warBet === 0 ? 'disabled' : ''}>
                        丘덢잺 Hr치t!
                    </button>
                ` : ''}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function playWar() {
            if (window.warBet === 0) return;
            if (getCasinoTokens() < window.warBet) {
                notifyError('M치lo 쬰ton콢!', `Pot콏ebuje코 ${window.warBet} 游꿞`);
                return;
            }
            
            addCasinoTokens(-window.warBet);
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                addCasinoGambledProgress();
                checkDailyQuests();
            }
            
            const cardValues = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const suits = ['鮫멆잺', '鮫봺잺', '鮫뷢잺', '鮫勇'];
            
            const playerValue = Math.floor(Math.random() * 13);
            const dealerValue = Math.floor(Math.random() * 13);
            const playerSuit = suits[Math.floor(Math.random() * 4)];
            const dealerSuit = suits[Math.floor(Math.random() * 4)];
            
            const playerCard = cardValues[playerValue] + playerSuit;
            const dealerCard = cardValues[dealerValue] + dealerSuit;
            
            document.getElementById('playerCard').innerHTML = playerCard;
            document.getElementById('dealerCard').innerHTML = dealerCard;
            
            SoundSystem.play('click');
            
            setTimeout(() => {
                let resultHtml = '';
                if (playerValue > dealerValue) {
                    // V칳hra = 1.9x s치zka (ne 2x) = 46.15% * 1.9 = 87.7% RTP
                    const winnings = Math.floor(window.warBet * 1.9);
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - window.warBet;
                    resultHtml = `<div style="color: #4caf50; font-size: 1.2rem;">游꿀 Vyhr치v치코! +${winnings} 游꿞</div>`;
                    SoundSystem.play('victory');
                } else if (playerValue < dealerValue) {
                    state.casinoStats.totalLost += window.warBet;
                    resultHtml = `<div style="color: #f44336; font-size: 1.2rem;">游 Prohra! -${window.warBet} 游꿞</div>`;
                    SoundSystem.play('damage');
                } else {
                    // Rem칤za = dealer vyhr치v치 (jako v re치ln칠m kasinu)
                    state.casinoStats.totalLost += window.warBet;
                    resultHtml = `<div style="color: #ff9800; font-size: 1.2rem;">丘덢잺 Rem칤za - dealer vyhr치v치!</div><div style="color: #f44336;">-${window.warBet} 游꿞</div>`;
                    SoundSystem.play('damage');
                }
                
                resultHtml += `<button class="btn" onclick="showWarGame()" style="margin-top: 0.5rem; background: #333;">游댃 Znovu</button>`;
                document.getElementById('warResult').innerHTML = resultHtml;
                document.getElementById('warMoney').textContent = getCasinoTokens() + ' 游꿞';
                saveGame(true);
            }, 500);
        }
        
        // === CRAPS ===
        function showCraps() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.crapsBet = 0;
            window.crapsBetType = 'pass';
            window.crapsPoint = 0;
            window.crapsPhase = 'betting';
            
            renderCraps();
        }
        
        function renderCraps() {
            showModal('游 Craps', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('craps')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">仇 Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="crapsMoney">${getCasinoTokens()} 游꿞</p>
                </div>
                
                <div style="background: #0a3a0a; padding: 1rem; border-radius: 8px; border: 3px solid #4caf50; margin: 0.5rem 0;">
                    <div style="display: flex; justify-content: center; gap: 1rem;" id="crapsDice">
                        <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000;">?</div>
                        <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000;">?</div>
                    </div>
                    ${window.crapsPoint > 0 ? `<div style="text-align: center; margin-top: 0.5rem; color: #ffd700;">Point: ${window.crapsPoint}</div>` : ''}
                </div>
                
                <div id="crapsResult" style="text-align: center; min-height: 40px; margin: 0.5rem 0;"></div>
                
                ${window.crapsPhase === 'betting' ? `
                    <div style="margin-bottom: 0.5rem;">
                        <label style="color: #888; font-size: 0.8rem;">Typ s치zky:</label>
                        <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="window.crapsBetType='pass';renderCraps()" style="flex:1;background:${window.crapsBetType==='pass'?'#4caf50':'#333'};">Pass</button>
                            <button class="btn" onclick="window.crapsBetType='dontpass';renderCraps()" style="flex:1;background:${window.crapsBetType==='dontpass'?'#f44336':'#333'};">Don't Pass</button>
                        </div>
                        <div style="color: #666; font-size: 0.7rem; margin-top: 0.3rem;">
                            ${window.crapsBetType === 'pass' ? 'Come-out: 7,11=v칳hra, 2,3,12=prohra' : 'Come-out: 2,3=v칳hra, 7,11=prohra, 12=push'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="color: #888; font-size: 0.8rem;">S치zka:</label>
                        <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="window.crapsBet=10;renderCraps()" style="flex:1;background:${window.crapsBet===10?'#ffd700':'#333'};color:${window.crapsBet===10?'#000':'#fff'};">10</button>
                            <button class="btn" onclick="window.crapsBet=25;renderCraps()" style="flex:1;background:${window.crapsBet===25?'#ffd700':'#333'};color:${window.crapsBet===25?'#000':'#fff'};">25</button>
                            <button class="btn" onclick="window.crapsBet=50;renderCraps()" style="flex:1;background:${window.crapsBet===50?'#ffd700':'#333'};color:${window.crapsBet===50?'#000':'#fff'};">50</button>
                            <button class="btn" onclick="window.crapsBet=100;renderCraps()" style="flex:1;background:${window.crapsBet===100?'#ffd700':'#333'};color:${window.crapsBet===100?'#000':'#fff'};">100</button>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="rollCraps()" style="width: 100%; background: linear-gradient(135deg, #1a3a3a 0%, #2d5a5a 100%); padding: 0.8rem;" ${window.crapsBet === 0 ? 'disabled' : ''}>
                        游 Hodit kostky!
                    </button>
                ` : `
                    <button class="btn" onclick="rollCraps()" style="width: 100%; background: linear-gradient(135deg, #1a3a3a 0%, #2d5a5a 100%); padding: 0.8rem;">
                        游 Hodit znovu (Point: ${window.crapsPoint})
                    </button>
                `}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function rollCraps() {
            if (window.crapsPhase === 'betting') {
                if (window.crapsBet === 0) return;
                if (getCasinoTokens() < window.crapsBet) {
                    notifyError('M치lo 쬰ton콢!', `Pot콏ebuje코 ${window.crapsBet} 游꿞`);
                    return;
                }
                addCasinoTokens(-window.crapsBet);
                
                // Daily quest progress
                if (state.dailyQuests?.progress) {
                    addCasinoGambledProgress();
                    checkDailyQuests();
                }
            }
            
            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;
            const total = die1 + die2;
            
            const diceEmojis = ['', '丘', '丘', '丘', '丘', '丘', '丘'];
            document.getElementById('crapsDice').innerHTML = `
                <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">${diceEmojis[die1]}</div>
                <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">${diceEmojis[die2]}</div>
            `;
            
            SoundSystem.play('click');
            
            let resultHtml = `<div style="color: #888;">Sou캜et: ${total}</div>`;
            let gameOver = false;
            
            if (window.crapsPhase === 'betting') {
                // Come-out roll
                if (window.crapsBetType === 'pass') {
                    if (total === 7 || total === 11) {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">游꿀 Natural! +${win} 游꿞</div>`;
                        gameOver = true;
                        SoundSystem.play('victory');
                    } else if (total === 2 || total === 3 || total === 12) {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">游 Craps! -${window.crapsBet} 游꿞</div>`;
                        gameOver = true;
                        SoundSystem.play('damage');
                    } else {
                        window.crapsPoint = total;
                        window.crapsPhase = 'point';
                        resultHtml += `<div style="color: #ff9800;">Point nastaven: ${total}</div>`;
                    }
                } else {
                    if (total === 2 || total === 3) {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">游꿀 V칳hra! +${win} 游꿞</div>`;
                        gameOver = true;
                        SoundSystem.play('victory');
                    } else if (total === 12) {
                        addCasinoTokens(window.crapsBet);
                        resultHtml += `<div style="color: #ff9800;">Push - s치zka vr치cena</div>`;
                        gameOver = true;
                    } else if (total === 7 || total === 11) {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">游 Prohra! -${window.crapsBet} 游꿞</div>`;
                        gameOver = true;
                        SoundSystem.play('damage');
                    } else {
                        window.crapsPoint = total;
                        window.crapsPhase = 'point';
                        resultHtml += `<div style="color: #ff9800;">Point nastaven: ${total}</div>`;
                    }
                }
            } else {
                // Point phase
                if (total === window.crapsPoint) {
                    if (window.crapsBetType === 'pass') {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">游꿀 Point! +${win} 游꿞</div>`;
                        SoundSystem.play('victory');
                    } else {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">游 Point - prohra! -${window.crapsBet} 游꿞</div>`;
                        SoundSystem.play('damage');
                    }
                    gameOver = true;
                } else if (total === 7) {
                    if (window.crapsBetType === 'pass') {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">游 Seven out! -${window.crapsBet} 游꿞</div>`;
                        SoundSystem.play('damage');
                    } else {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">游꿀 Seven out - v칳hra! +${win} 游꿞</div>`;
                        SoundSystem.play('victory');
                    }
                    gameOver = true;
                } else {
                    resultHtml += `<div style="color: #888;">H치ze코 d치l... (Point: ${window.crapsPoint})</div>`;
                }
            }
            
            if (gameOver) {
                resultHtml += `<button class="btn" onclick="showCraps()" style="margin-top: 0.5rem; background: #333;">游댃 Nov치 hra</button>`;
                window.crapsPhase = 'betting';
                window.crapsPoint = 0;
            }
            
            document.getElementById('crapsResult').innerHTML = resultHtml;
            document.getElementById('crapsMoney').textContent = getCasinoTokens() + ' 游꿞';
            saveGame(true);
            
            if (!gameOver) {
                setTimeout(renderCraps, 100);
            }
        }
        
        // === KENO ===
        function showKeno() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.kenoSelected = [];
            window.kenoBet = 10;
            window.kenoDrawn = [];
            window.kenoPhase = 'selecting';
            
            renderKeno();
        }
        
        function renderKeno() {
            const gridHtml = Array.from({length: 40}, (_, i) => {
                const num = i + 1;
                const isSelected = window.kenoSelected.includes(num);
                const isDrawn = window.kenoDrawn.includes(num);
                const isHit = isSelected && isDrawn;
                
                let bg = '#333';
                if (isHit) bg = '#4caf50';
                else if (isSelected) bg = '#ffd700';
                else if (isDrawn) bg = '#666';
                
                return `<button onclick="toggleKenoNumber(${num})" style="width: 100%; aspect-ratio: 1; background: ${bg}; border: none; border-radius: 4px; color: ${isSelected ? '#000' : '#fff'}; font-weight: bold; font-size: 0.8rem; cursor: pointer;" ${window.kenoPhase !== 'selecting' ? 'disabled' : ''}>${num}</button>`;
            }).join('');
            
            const hits = window.kenoSelected.filter(n => window.kenoDrawn.includes(n)).length;
            
            showModal('游댝 Keno', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('keno')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">仇 Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="kenoMoney">${getCasinoTokens()} 游꿞</p>
                </div>
                <div style="text-align: center;">
                    <p style="color: #888; font-size: 0.75rem; margin: 0.3rem 0;">Vyber a 10 캜칤sel (1-40)</p>
                    <p style="color: #4caf50; margin: 0;">Vybr치no: ${window.kenoSelected.length}/10</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin: 0.5rem 0;">
                    ${gridHtml}
                </div>
                
                <div id="kenoResult" style="text-align: center; min-height: 30px;">
                    ${window.kenoPhase === 'result' ? `<div style="color: #4caf50;">Trefy: ${hits}/${window.kenoSelected.length}</div>` : ''}
                </div>
                
                ${window.kenoPhase === 'selecting' ? `
                    <div style="display: flex; gap: 0.3rem; margin: 0.5rem 0;">
                        <button class="btn" onclick="window.kenoBet=10;renderKeno()" style="flex:1;background:${window.kenoBet===10?'#ffd700':'#333'};color:${window.kenoBet===10?'#000':'#fff'};">10游꿞</button>
                        <button class="btn" onclick="window.kenoBet=25;renderKeno()" style="flex:1;background:${window.kenoBet===25?'#ffd700':'#333'};color:${window.kenoBet===25?'#000':'#fff'};">25游꿞</button>
                        <button class="btn" onclick="window.kenoBet=50;renderKeno()" style="flex:1;background:${window.kenoBet===50?'#ffd700':'#333'};color:${window.kenoBet===50?'#000':'#fff'};">50游꿞</button>
                    </div>
                    
                    <button class="btn" onclick="playKeno()" style="width: 100%; background: linear-gradient(135deg, #3a3a1a 0%, #5a5a2d 100%); padding: 0.8rem;" ${window.kenoSelected.length === 0 ? 'disabled' : ''}>
                        游꿤 Losovat!
                    </button>
                ` : `
                    <button class="btn" onclick="showKeno()" style="width: 100%; background: #333; margin-top: 0.5rem;">
                        游댃 Nov치 hra
                    </button>
                `}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function toggleKenoNumber(num) {
            if (window.kenoPhase !== 'selecting') return;
            
            const idx = window.kenoSelected.indexOf(num);
            if (idx >= 0) {
                window.kenoSelected.splice(idx, 1);
            } else if (window.kenoSelected.length < 10) {
                window.kenoSelected.push(num);
            }
            renderKeno();
        }
        
        function playKeno() {
            if (window.kenoSelected.length === 0) return;
            if (getCasinoTokens() < window.kenoBet) {
                notifyError('M치lo 쬰ton콢!', `Pot콏ebuje코 ${window.kenoBet} 游꿞`);
                return;
            }
            
            addCasinoTokens(-window.kenoBet);
            window.kenoPhase = 'drawing';
            
            // Losuj 10 캜칤sel z 40
            const numbers = Array.from({length: 40}, (_, i) => i + 1);
            window.kenoDrawn = [];
            for (let i = 0; i < 10; i++) {
                const idx = Math.floor(Math.random() * numbers.length);
                window.kenoDrawn.push(numbers.splice(idx, 1)[0]);
            }
            
            SoundSystem.play('click');
            
            // Spo캜칤tej trefy
            const hits = window.kenoSelected.filter(n => window.kenoDrawn.includes(n)).length;
            const selected = window.kenoSelected.length;
            
            // V칳platn칤 tabulka - upraven치 pro lep코칤 RTP (~80%)
            const payouts = {
                1: { 1: 3.5 },
                2: { 1: 1, 2: 12 },
                3: { 2: 2.5, 3: 25 },
                4: { 2: 1.5, 3: 6, 4: 40 },
                5: { 2: 1, 3: 4, 4: 15, 5: 80 },
                6: { 3: 2, 4: 6, 5: 25, 6: 150 },
                7: { 3: 1.5, 4: 4, 5: 12, 6: 50, 7: 300 },
                8: { 4: 2, 5: 6, 6: 25, 7: 100, 8: 800 },
                9: { 4: 1.5, 5: 4, 6: 15, 7: 50, 8: 300, 9: 1500 },
                10: { 5: 2, 6: 6, 7: 25, 8: 150, 9: 800, 10: 3000 }
            };
            
            const multiplier = payouts[selected]?.[hits] || 0;
            const winnings = window.kenoBet * multiplier;
            
            window.kenoPhase = 'result';
            
            // P콏i캜ti progress pro denn칤 칰kol
            addCasinoGambledProgress();
            
            setTimeout(() => {
                let resultHtml = `<div style="color: #888;">Trefy: ${hits}/${selected}</div>`;
                
                if (winnings > 0) {
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - window.kenoBet;
                    resultHtml += `<div style="color: #4caf50; font-size: 1.2rem;">游꿀 V칳hra! +${winnings} 游꿞 (${multiplier}x)</div>`;
                    SoundSystem.play('victory');
                } else {
                    state.casinoStats.totalLost += window.kenoBet;
                    resultHtml += `<div style="color: #f44336;">콯치dn치 v칳hra</div>`;
                    SoundSystem.play('damage');
                }
                
                document.getElementById('kenoResult').innerHTML = resultHtml;
                document.getElementById('kenoMoney').textContent = getCasinoTokens() + ' 游꿞';
                saveGame(true);
                renderKeno();
            }, 500);
        }
        
        function visitBucoviceHealer() {
            // Zkontroluj bonus od NPC
            const npcBonuses = getNPCBonuses();
            const isFreeHealing = npcBonuses.freeHealing;
            
            const healCost = isFreeHealing ? 0 : Math.max(10, Math.floor((state.char.maxHp - state.char.hp) / 2));
            const radCost = isFreeHealing ? 0 : Math.max(20, (state.status.radiation || 0) * 2);
            
            const now = Date.now();
            const healCooldown = 30 * 60 * 1000;
            const radCooldown = 60 * 60 * 1000;
            
            const healReady = !state.lastHealTime || (now - state.lastHealTime) >= healCooldown;
            const radReady = !state.lastRadCureTime || (now - state.lastRadCureTime) >= radCooldown;
            
            const healMinsLeft = healReady ? 0 : Math.ceil((healCooldown - (now - state.lastHealTime)) / 60000);
            const radMinsLeft = radReady ? 0 : Math.ceil((radCooldown - (now - state.lastRadCureTime)) / 60000);
            
            const freeHealingNote = isFreeHealing ? '<div style="background: #1a3a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; border: 1px solid #4caf50;"><span style="color: #8bc34a;">九 L칠캜en칤 ZDARMA d칤ky d콢v캩콏e u Doktora!</span></div>' : '';
            
            showModal('游낀 L칠캜itel Marek', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游녿꽥뚯勇</div>
                    <p style="color: #888;">"Uka, co t캩 bol칤..."</p>
                </div>
                
                ${freeHealingNote}
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>仇벒잺 Zdrav칤:</span>
                        <span>${state.char.hp}/${state.char.maxHp}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>驕뮖잺 Radiace:</span>
                        <span>${state.status.radiation || 0}</span>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="healAtBucovice()" style="background: ${healReady && state.char.hp < state.char.maxHp ? '#4CAF50' : '#333'}; ${!healReady || state.char.hp >= state.char.maxHp ? 'opacity: 0.6;' : ''}">
                        仇벒잺 Vyl칠캜it ${healCost > 0 ? '(' + healCost + ' 游눯)' : '(ZDARMA)'} ${!healReady ? '낍 ' + healMinsLeft + 'min' : ''}
                    </button>
                    <button class="btn" onclick="cureRadiationAtBucovice()" style="background: ${radReady && (state.status.radiation || 0) > 0 ? '#ff9800' : '#333'}; ${!radReady || (state.status.radiation || 0) <= 0 ? 'opacity: 0.6;' : ''}">
                        驕뮖잺 Odstranit radiaci ${radCost > 0 ? '(' + radCost + ' 游눯)' : '(ZDARMA)'} ${!radReady ? '낍 ' + radMinsLeft + 'min' : ''}
                    </button>
                </div>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.5rem;">낋 L칠캜ba: 30min cooldown | Dekontaminace: 60min cooldown</p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Odej칤t</button>
            `);
        }
        
        function healAtBucovice() {
            const npcBonuses = getNPCBonuses();
            const isFreeHealing = npcBonuses.freeHealing;
            const cost = isFreeHealing ? 0 : Math.max(10, Math.floor((state.char.maxHp - state.char.hp) / 2));
            
            if (state.char.hp >= state.char.maxHp) {
                notifyInfo('Jsi zdrav칳', 'Nepot콏ebuje코 l칠캜en칤');
                return;
            }
            if (!isFreeHealing && getMoney() < cost) {
                notifyError('M치lo pen캩z!', `Pot콏ebuje코 ${cost} 游눯`);
                return;
            }
            
            // Cooldown check - 1x za 30 minut re치ln칠ho 캜asu
            const now = Date.now();
            const cooldown = 30 * 60 * 1000; // 30 minut
            if (state.lastHealTime && (now - state.lastHealTime) < cooldown) {
                const minsLeft = Math.ceil((cooldown - (now - state.lastHealTime)) / 60000);
                notifyWarning('L칠캜itel odpo캜칤v치', `Zkus to za ${minsLeft} minut`);
                return;
            }
            
            if (cost > 0) removeMoney(cost);
            state.char.hp = state.char.maxHp;
            state.lastHealTime = now;
            
            notifySuccess('仇벒잺 Vyl칠캜en!', isFreeHealing ? 'Zdarma d칤ky Doktorovi!' : 'Pln칠 zdrav칤');
            renderFull();
            visitBucoviceHealer();
        }
        
        function cureRadiationAtBucovice() {
            const npcBonuses = getNPCBonuses();
            const isFreeHealing = npcBonuses.freeHealing;
            const cost = isFreeHealing ? 0 : Math.max(20, (state.status.radiation || 0) * 2);
            
            if ((state.status.radiation || 0) <= 0) {
                notifyInfo('캛ist칳', 'Nem치코 radiaci');
                return;
            }
            if (!isFreeHealing && getMoney() < cost) {
                notifyError('M치lo pen캩z!', `Pot콏ebuje코 ${cost} 游눯`);
                return;
            }
            
            // Cooldown check - 1x za 60 minut re치ln칠ho 캜asu
            const now = Date.now();
            const cooldown = 60 * 60 * 1000; // 60 minut
            if (state.lastRadCureTime && (now - state.lastRadCureTime) < cooldown) {
                const minsLeft = Math.ceil((cooldown - (now - state.lastRadCureTime)) / 60000);
                notifyWarning('Dekontaminace nen칤 p콏ipravena', `Zkus to za ${minsLeft} minut`);
                return;
            }
            
            if (cost > 0) removeMoney(cost);
            state.status.radiation = 0;
            state.lastRadCureTime = now;
            
            notifySuccess('驕뮖잺 O캜i코t캩n!', isFreeHealing ? 'Zdarma d칤ky Doktorovi!' : 'Radiace odstran캩na');
            renderFull();
            visitBucoviceHealer();
        }
        
        // === BOUNTY SYST칄M - N츼ST캨NKA BU캛OVIC ===
        const BOUNTIES = [
            // Loveck칠 bounty
            { id: 'hunt_wolves', name: 'Vl캜칤 sme캜ka', desc: 'Zabij 3 vlky', icon: '游냨', type: 'kill', target: 'wolf', amount: 3, reward: { money: 120, xp: 80 }, zone: 'medium' },
            { id: 'hunt_mutants', name: 'Mutant칤 hrozba', desc: 'Zabij 5 mutant콢', icon: '驕勇', type: 'kill', target: 'mutant', amount: 5, reward: { money: 200, xp: 150 }, zone: 'danger' },
            { id: 'hunt_raiders', name: 'N치jezdn칤ci', desc: 'Zabij 5 n치jezdn칤k콢', icon: '丘덢잺', type: 'kill', target: 'raider', amount: 5, reward: { money: 180, xp: 120 }, zone: 'medium' },
            { id: 'hunt_ghouls', name: 'Gh칰l칤 o캜ista', desc: 'Zabij 4 gh칰ly', icon: '游', type: 'kill', target: 'ghoul', amount: 4, reward: { money: 150, xp: 100 }, zone: 'danger' },
            { id: 'hunt_robots', name: 'Kovov치 hrozba', desc: 'Zni캜 3 roboty', icon: '游뱄', type: 'kill', target: 'robot', amount: 3, reward: { money: 250, xp: 180 }, zone: 'deadly' },
            
            // Boss hunt bounties (deadly)
            { id: 'hunt_deathclaw', name: 'Zabij치k Deathclaw콢', desc: 'Zabij Deathclawa', icon: '游붔', type: 'kill', target: 'deathclaw', amount: 1, reward: { money: 500, xp: 400 }, zone: 'deadly' },
            { id: 'hunt_behemoth', name: 'Lovec obr콢', desc: 'Zabij Mutant Behemotha', icon: '游놏', type: 'kill', target: 'mutant_behemoth', amount: 1, reward: { money: 600, xp: 500 }, zone: 'deadly' },
            { id: 'hunt_glowing', name: 'Z치콏칤c칤 smrt', desc: 'Zabij Z치콏칤c칤ho', icon: '驕뮖잺', type: 'kill', target: 'glowing_one', amount: 1, reward: { money: 400, xp: 300 }, zone: 'deadly' },
            
            // Sb캩ratelsk칠 bounty
            { id: 'collect_scrap', name: 'rotov치 sb칤rka', desc: 'P콏ines 25 코rotu', icon: '游댤', type: 'resource', target: 'scrap', amount: 25, reward: { money: 100, xp: 50 } },
            { id: 'collect_metal', name: 'Kovov치 dod치vka', desc: 'P콏ines 20 kovu', icon: '游댢', type: 'resource', target: 'metal', amount: 20, reward: { money: 150, xp: 60 } },
            { id: 'collect_herbs', name: 'Bylink치콏stv칤', desc: 'P콏ines 15 bylin', icon: '游', type: 'resource', target: 'herbs', amount: 15, reward: { money: 80, xp: 40 } },
            { id: 'collect_electronics', name: 'Elektronika', desc: 'P콏ines 10 elektroniky', icon: '游님', type: 'resource', target: 'electronics', amount: 10, reward: { money: 180, xp: 70 } },
            { id: 'collect_fuel', name: 'Palivov치 krize', desc: 'P콏ines 15 paliva', icon: '久', type: 'resource', target: 'fuel', amount: 15, reward: { money: 200, xp: 80 } },
            
            // Pr콢zkumn칠 bounty
            { id: 'explore_danger_zone', name: 'Nebezpe캜n칳 pr콢zkum', desc: 'Nav코tiv 3 nebezpe캜n칠 lokace', icon: '游딬勇', type: 'explore', target: 'danger', amount: 3, reward: { money: 200, xp: 150 } },
            { id: 'explore_deadly_zone', name: 'Smrteln치 v칳prava', desc: 'Nav코tiv 2 smrteln칠 lokace', icon: '游', type: 'explore', target: 'deadly', amount: 2, reward: { money: 350, xp: 250 } },
            { id: 'explore_dungeons', name: 'Dungeon Diver', desc: 'Prozkoumej 2 dungeony', icon: '游끸勇', type: 'explore', target: 'dungeon', amount: 2, reward: { money: 250, xp: 200 } }
        ];
        
        function showBucoviceBounties() {
            // Inicializace bounty state
            if (!state.bounties) {
                state.bounties = {
                    active: [],
                    completed: [],
                    lastRefresh: Date.now()
                };
            }
            
            // Refresh bounties ka쬯칳ch 24 hodin (hern칤ho 캜asu) nebo p콏i nov칠m dni
            const now = Date.now();
            if (!state.bounties.dailyBounties || state.bounties.lastDay !== state.day) {
                generateDailyBounties();
                state.bounties.lastDay = state.day;
            }
            
            const dailyBounties = state.bounties.dailyBounties || [];
            const activeBounty = state.bounties.active?.[0];
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem;">游닆</div>
                    <p style="color: #888;">Denn칤 칰koly od m캩stsk칠 rady</p>
                    <p style="color: #ffd700; font-size: 0.8rem;">Den ${state.day || 1} - Nov칠 칰koly ka쬯칳 den</p>
                </div>
            `;
            
            // Aktivn칤 bounty
            if (activeBounty) {
                const bountyDef = BOUNTIES.find(b => b.id === activeBounty.id);
                if (bountyDef) {
                    const progress = getBountyProgress(activeBounty);
                    const isComplete = progress >= bountyDef.amount;
                    
                    html += `
                        <div style="background: linear-gradient(135deg, #1a3a1a, #0a2a0a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid ${isComplete ? '#4caf50' : '#ff9800'};">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">${bountyDef.icon}</span>
                                <div>
                                    <div style="color: #ff9800; font-weight: bold;">游댃 AKTIVN칈: ${bountyDef.name}</div>
                                    <div style="color: #888; font-size: 0.85rem;">${bountyDef.desc}</div>
                                </div>
                            </div>
                            <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                    <span>Progres:</span>
                                    <span style="color: ${isComplete ? '#4caf50' : '#fff'};">${progress}/${bountyDef.amount}</span>
                                </div>
                                <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${Math.min(100, (progress / bountyDef.amount) * 100)}%; background: ${isComplete ? '#4caf50' : '#ff9800'};"></div>
                                </div>
                            </div>
                            <div style="color: #ffd700; font-size: 0.85rem;">游꾸 Odm캩na: ${bountyDef.reward.money} 游눯, ${bountyDef.reward.xp} XP</div>
                            ${isComplete ? `
                                <button class="btn" onclick="completeBounty('${activeBounty.id}')" style="width: 100%; margin-top: 0.5rem; background: #4caf50;">
                                    九 Odevzdat bounty
                                </button>
                            ` : `
                                <button class="btn" onclick="abandonBounty()" style="width: 100%; margin-top: 0.5rem; background: #c62828;">
                                    仇 Vzd치t se
                                </button>
                            `}
                        </div>
                    `;
                }
            }
            
            // Dostupn칠 bounties
            html += `<div style="margin-bottom: 0.5rem; color: #aaa; font-size: 0.9rem;">Dostupn칠 칰koly:</div>`;
            
            dailyBounties.forEach(bountyId => {
                const bounty = BOUNTIES.find(b => b.id === bountyId);
                if (!bounty) return;
                
                const isActive = activeBounty?.id === bountyId;
                const isCompleted = state.bounties.completed?.includes(bountyId);
                
                if (isCompleted) {
                    html += `
                        <div style="padding: 0.6rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem; opacity: 0.5;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.3rem;">${bounty.icon}</span>
                                <div style="flex: 1;">
                                    <div style="color: #4caf50;">九 ${bounty.name}</div>
                                    <div style="color: #666; font-size: 0.8rem;">Dokon캜eno</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (!isActive) {
                    html += `
                        <div style="padding: 0.6rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.3rem;">${bounty.icon}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff; font-weight: bold;">${bounty.name}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${bounty.desc}</div>
                                    <div style="color: #ffd700; font-size: 0.75rem;">游꾸 ${bounty.reward.money} 游눯, ${bounty.reward.xp} XP</div>
                                </div>
                                ${!activeBounty ? `
                                    <button class="btn" onclick="acceptBounty('${bounty.id}')" style="padding: 0.4rem 0.8rem; background: #ff9800;">
                                        P콏ijmout
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Statistiky
            const completedToday = state.bounties.completed?.length || 0;
            html += `
                <div style="margin-top: 1rem; padding: 0.5rem; background: #0a0a0a; border-radius: 6px; text-align: center;">
                    <span style="color: #888; font-size: 0.8rem;">Dnes dokon캜eno: ${completedToday}/3</span>
                </div>
            `;
            
            html += `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>`;
            
            showModal('游닆 N치st캩nka odm캩n', html);
        }
        
        function generateDailyBounties() {
            // Vyber 3 n치hodn칠 bounties - mix typ콢
            const killBounties = BOUNTIES.filter(b => b.type === 'kill');
            const resourceBounties = BOUNTIES.filter(b => b.type === 'resource');
            const exploreBounties = BOUNTIES.filter(b => b.type === 'explore');
            
            const daily = [];
            
            // 1 loveck치
            if (killBounties.length > 0) {
                daily.push(killBounties[Math.floor(Math.random() * killBounties.length)].id);
            }
            
            // 1 sb캩ratelsk치
            if (resourceBounties.length > 0) {
                let rb;
                do {
                    rb = resourceBounties[Math.floor(Math.random() * resourceBounties.length)];
                } while (daily.includes(rb.id));
                daily.push(rb.id);
            }
            
            // 1 pr콢zkumn치
            if (exploreBounties.length > 0) {
                let eb;
                do {
                    eb = exploreBounties[Math.floor(Math.random() * exploreBounties.length)];
                } while (daily.includes(eb.id));
                daily.push(eb.id);
            }
            
            state.bounties.dailyBounties = daily;
            state.bounties.completed = []; // Reset completed p콏i nov칠m dni
            state.bounties.active = [];
        }
        
        function acceptBounty(bountyId) {
            const bounty = BOUNTIES.find(b => b.id === bountyId);
            if (!bounty) return;
            
            if (state.bounties.active?.length > 0) {
                notifyError('M치코 aktivn칤 bounty', 'Nejd콏칤v ji dokon캜i nebo se vzdej');
                return;
            }
            
            state.bounties.active = [{
                id: bountyId,
                startKills: { ...state.stats?.killsByType } || {},
                startExplored: [...(state.world?.visitedLocations || [])],
                acceptedAt: Date.now()
            }];
            
            notifySuccess('游닆 Bounty p콏ijata!', bounty.name);
            addLog(`P콏ijata bounty: ${bounty.name}`, '游닆');
            showBucoviceBounties();
        }
        
        function getBountyProgress(activeBounty) {
            const bounty = BOUNTIES.find(b => b.id === activeBounty.id);
            if (!bounty) return 0;
            
            if (bounty.type === 'kill') {
                // Po캜칤tej kills od p콏ijet칤
                const startKills = activeBounty.startKills?.[bounty.target] || 0;
                const currentKills = state.stats?.killsByType?.[bounty.target] || 0;
                return currentKills - startKills;
            }
            
            if (bounty.type === 'resource') {
                // Aktu치ln칤 mno쬽tv칤 suroviny - kontroluj v osad캩 I v hr치캜ov캩 invent치콏i
                const settlementAmount = state.settlement?.resources?.[bounty.target] || 0;
                const playerAmount = state.resources?.[bounty.target] || 0;
                console.log(`游댌 Bounty resource check: ${bounty.target} - settlement: ${settlementAmount}, player: ${playerAmount}`);
                return settlementAmount + playerAmount;
            }
            
            if (bounty.type === 'explore') {
                // Po캜칤tej nov캩 nav코t칤ven칠 lokace dan칠ho typu od p콏ijet칤
                const startLocs = activeBounty.startExplored || [];
                const currentLocs = state.world?.visitedLocations || [];
                const newLocs = currentLocs.filter(l => !startLocs.includes(l));
                
                if (bounty.target === 'danger' || bounty.target === 'deadly') {
                    return newLocs.filter(locId => {
                        const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                        return loc?.zone === bounty.target;
                    }).length;
                }
                
                if (bounty.target === 'dungeon') {
                    return newLocs.filter(locId => {
                        const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                        return loc?.type === 'dungeon';
                    }).length;
                }
            }
            
            return 0;
        }
        
        function completeBounty(bountyId) {
            const bounty = BOUNTIES.find(b => b.id === bountyId);
            if (!bounty) return;
            
            const activeBounty = state.bounties.active?.[0];
            if (!activeBounty || activeBounty.id !== bountyId) return;
            
            const progress = getBountyProgress(activeBounty);
            if (progress < bounty.amount) {
                notifyError('Nespln캩no', `Pot콏ebuje코: ${bounty.amount}, m치코: ${progress}`);
                return;
            }
            
            // Odeber suroviny pokud je to resource bounty
            if (bounty.type === 'resource') {
                let toRemove = bounty.amount;
                
                // Nejd콏칤ve odeber z hr치캜ov칳ch zdroj콢
                const playerHas = state.resources?.[bounty.target] || 0;
                if (playerHas > 0) {
                    const removeFromPlayer = Math.min(playerHas, toRemove);
                    state.resources[bounty.target] -= removeFromPlayer;
                    toRemove -= removeFromPlayer;
                }
                
                // Pak z osady
                if (toRemove > 0 && state.settlement?.resources) {
                    state.settlement.resources[bounty.target] = (state.settlement.resources[bounty.target] || 0) - toRemove;
                }
            }
            
            // Dej odm캩ny
            addMoney(bounty.reward.money);
            addXP(bounty.reward.xp);
            
            // Ozna캜 jako dokon캜en칠
            if (!state.bounties.completed) state.bounties.completed = [];
            state.bounties.completed.push(bountyId);
            state.bounties.active = [];
            
            notifySuccess('游닆 Bounty dokon캜ena!', `+${bounty.reward.money} 游눯, +${bounty.reward.xp} XP`);
            addLog(`Bounty dokon캜ena: ${bounty.name}`, '游끥');
            
            closeModal();
            renderFull();
            
            // Znovu otev콏i n치st캩nku
            setTimeout(() => showBucoviceBounties(), 300);
        }
        
        function abandonBounty() {
            if (!state.bounties.active?.length) return;
            
            const activeBounty = state.bounties.active[0];
            const bounty = BOUNTIES.find(b => b.id === activeBounty.id);
            
            showModal('仇 Vzd치t se bounty?', `
                <p style="color: #aaa;">Opravdu se chce코 vzd치t 칰kolu "${bounty?.name}"?</p>
                <p style="color: #ff9800;">M콢쬰코 ho znovu p콏ijmout, ale progres se resetuje.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal(); showBucoviceBounties();" style="background: #555;">' + t('ui', 'cancel') + '</button>
                    <button class="btn" onclick="confirmAbandonBounty()" style="background: #c62828;">Vzd치t se</button>
                </div>
            `);
        }
        
        function confirmAbandonBounty() {
            state.bounties.active = [];
            notifyInfo('Bounty zru코ena', 'M콢쬰코 p콏ijmout jinou');
            closeModal();
            showBucoviceBounties();
        }
        
        function restAtBucovice() {
            const now = Date.now();
            const cooldown = 4 * 60 * 60 * 1000; // 4 hodiny
            const isReady = !state.lastHotelTime || (now - state.lastHotelTime) >= cooldown;
            const hoursLeft = isReady ? 0 : Math.ceil((cooldown - (now - state.lastHotelTime)) / (60 * 60 * 1000));
            
            if (getMoney() < 20) {
                notifyError('M치lo pen캩z!', 'Nocleh stoj칤 20 游눯');
                return;
            }
            
            showModal('游낃 Hotel "Nov치 Nad캩je"', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游띒勇</div>
                    <p style="color: #888;">캛ist칳 pokoj, tepl치 postel, bezpe캜칤.</p>
                </div>
                
                <p style="text-align: center; color: #aaa;">P콏esp치n칤 za 20 游눯 dopln칤:</p>
                <ul style="color: #8bc34a; margin: 0.5rem 0;">
                    <li>仇벒잺 ${currentLang === "en" ? "Full health" : "Pln칠 zdrav칤"}</li>
                    <li>丘 Pln치 energie</li>
                </ul>
                
                ${!isReady ? `
                    <div style="background: #4d1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
                        <span style="color: #ff9800;">낍 Nejsi unaven칳 - m콢쬰코 sp치t za ${hoursLeft}h</span>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="confirmRestAtBucovice()" style="width: 100%; background: ${isReady ? '#3949AB' : '#333'}; ${!isReady ? 'opacity: 0.6;' : ''}">
                    游띒勇 P콏espat (20 游눯) ${!isReady ? '낍' : ''}
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">九 Zru코it</button>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.5rem;">낋 Cooldown: 4 hodiny re치ln칠ho 캜asu</p>
            `);
        }
        
        function confirmRestAtBucovice() {
            if (getMoney() < 20) {
                notifyError('M치lo pen캩z!', 'Nocleh stoj칤 20 游눯');
                return;
            }
            
            // Cooldown check - 1x za 4 hodiny re치ln칠ho 캜asu
            const now = Date.now();
            const cooldown = 4 * 60 * 60 * 1000; // 4 hodiny
            if (state.lastHotelTime && (now - state.lastHotelTime) < cooldown) {
                const hoursLeft = Math.ceil((cooldown - (now - state.lastHotelTime)) / (60 * 60 * 1000));
                notifyWarning('Nejsi unaven칳', `M콢쬰코 p콏espat za ${hoursLeft} hodin`);
                closeModal();
                return;
            }
            
            removeMoney(20);
            state.char.hp = state.char.maxHp;
            state.status.energy = 100;
            state.lastHotelTime = now;
            
            closeModal();
            notifySuccess('游땺 Dob콏e jsi spal!', 'Pln칠 zdrav칤 a energie!');
            renderFull();
        }
        
        // === FIN츼LN칈 VOLBA ===
        function showFinalChoice(choice) {
            const karma = state.storyKarma || { kory: 0, koudy: 0 };
            
            let title, description, confirmText, color;
            
            if (choice === 'kory') {
                title = '游붳 P콏edat v코e Korymu';
                description = `
                    <p>Kory stoj칤 p콏ed tebou s 코칤len칳m 칰sm캩vem:</p>
                    <p style="color: #e91e63; font-style: italic;">"V칳born캩! V캩d캩l jsem, 쬰 pochop칤코. Slab칤 mus칤 odej칤t, aby siln칤 mohli vzkv칠tat. Dnes se rod칤 NOV칗 SV캨T!"</p>
                    <p style="color: #f44336; font-weight: bold;">丘멆잺 VAROV츼N칈: Toto aktivuje Genesis v DESTRUK캛N칈M re쬴mu!</p>
                `;
                confirmText = '游 P콏edat Korymu (Temn칳 konec)';
                color = '#e91e63';
            } else if (choice === 'koudy') {
                title = '游녿꽳릢 P콏edat v코e Koudymu';
                description = `
                    <p>Koudy m치 slzy v o캜칤ch:</p>
                    <p style="color: #2196f3; font-style: italic;">"D캩kuji ti, p콏칤teli. Dnes za캜칤n치 obnova. Bude to trvat roky, mo쬹치 desetilet칤, ale sv캩t se uzdrav칤. M치me NAD캨JI."</p>
                    <p style="color: #4caf50; font-weight: bold;">九 Toto aktivuje Genesis v L칄캛EBN칄M re쬴mu.</p>
                `;
                confirmText = '游깬 P콏edat Koudymu (Konec nad캩je)';
                color = '#2196f3';
            } else {
                title = '游눤 Zni캜it komponenty';
                description = `
                    <p>Pod칤v치코 se na oba bratry. Ani jeden si nezaslou쮂 takovou moc.</p>
                    <p style="color: #888; font-style: italic;">"NE! Co to d캩l치코?!" k콏i캜칤 oba najednou.</p>
                    <p style="color: #ff9800; font-weight: bold;">丘뒲잺 Projekt Genesis bude nav쬯y ztracen. Sv캩t z콢stane takov칳, jak칳 je.</p>
                `;
                confirmText = '游눤 Zni캜it v코e (Neutr치ln칤 konec)';
                color = '#f44336';
            }
            
            showModal(title, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    ${description}
                </div>
                
                <p style="color: #ffd700; text-align: center; font-weight: bold;">Tato volba je NEVRATN츼!</p>
                
                <button class="btn" onclick="executeFinalChoice('${choice}')" style="width: 100%; background: ${color}; margin-top: 0.5rem;">
                    ${confirmText}
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Rozmyslet si to</button>
            `);
        }
        
        function executeFinalChoice(choice) {
            closeModal();
            
            // Odeber komponenty z invent치콏e
            ['plutonium_core', 'quantum_stabilizer', 'fusion_cell', 'ai_module'].forEach(compId => {
                state.inv = state.inv.filter(i => i.id !== compId);
            });
            
            // Nastav ending
            let ending;
            if (choice === 'kory') {
                ending = STORY_ENDINGS.dark;
                state.storyKarma.ending = 'dark';
                state.storyKarma.kory += 50;
            } else if (choice === 'koudy') {
                ending = STORY_ENDINGS.hope;
                state.storyKarma.ending = 'hope';
                state.storyKarma.koudy += 50;
            } else {
                ending = STORY_ENDINGS.neutral;
                state.storyKarma.ending = 'neutral';
            }
            
            // Odm캩ny za dokon캜en칤 p콏칤b캩hu
            addXP(500);
            addMoney(500);
            
            // Dokon캜i p콏칤b캩h
            state.mainQuest.storyComplete = true;
            state.mainQuest.currentQuest = null;
            if (!state.mainQuest.completedQuests) state.mainQuest.completedQuests = [];
            if (!state.mainQuest.completedQuests.includes('final_choice')) {
                state.mainQuest.completedQuests.push('final_choice');
            }
            
            // Zobraz ending
            setTimeout(() => {
                showModal(ending.title, `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">${choice === 'kory' ? '游깸' : choice === 'koudy' ? '游깬' : '丘뒲잺'}</div>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #aaa; line-height: 1.6;">${ending.description}</p>
                    </div>
                    
                    <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #1a3a1a, #2a4a2a); border-radius: 8px;">
                        <div style="font-size: 2rem;">游끥</div>
                        <h3 style="color: #ffd700; margin: 0.5rem 0;">P콎칈B캨H DOKON캛EN!</h3>
                        <p style="color: #8bc34a; font-size: 0.9rem;">+500 XP, +500 游눯</p>
                        <p style="color: #888; font-size: 0.85rem;">M콢쬰코 pokra캜ovat ve h콏e a prozkoum치vat sv캩t.</p>
                    </div>
                    
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">
                        游꿀 Pokra캜ovat ve h콏e
                    </button>
                `);
            }, 500);
            
            addLog(`P콎칈B캨H DOKON캛EN: ${ending.title}`, '游끥');
            saveGame(true);
            renderFull();
        }
        
        // === STORY KARMA SYST칄M ===
        function showStoryKarma() {
            const karma = state.storyKarma || { kory: 0, koudy: 0, componentsGiven: { kory: 0, koudy: 0 } };
            
            // Ur캜en칤 strany
            let sideText = '丘뒲잺 Nerozhodnut';
            let sideColor = '#888';
            if (karma.componentsGiven.kory > karma.componentsGiven.koudy) {
                sideText = '游붳 Na stran캩 Koryho';
                sideColor = '#e91e63';
            } else if (karma.componentsGiven.koudy > karma.componentsGiven.kory) {
                sideText = '游녿꽳릢 Na stran캩 Koudyho';
                sideColor = '#2196f3';
            }
            
            // Karma bar
            const karmaBalance = karma.kory - karma.koudy;
            const barPosition = 50 + (karmaBalance / 2);
            
            showModal('丘뒲잺 Projekt Genesis - Karma', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">丘勇</div>
                    <h3 style="margin: 0.5rem 0;">Projekt Genesis</h3>
                    <p style="color: ${sideColor}; font-weight: bold;">${sideText}</p>
                </div>
                
                <!-- Karma Balance Bar -->
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #2196f3;">游녿꽳릢 Koudy</span>
                        <span style="color: #e91e63;">Kory 游붳</span>
                    </div>
                    <div style="height: 20px; background: linear-gradient(90deg, #2196f3, #888, #e91e63); border-radius: 10px; position: relative;">
                        <div style="position: absolute; top: -5px; left: ${barPosition}%; transform: translateX(-50%); width: 10px; height: 30px; background: #fff; border-radius: 5px; border: 2px solid #000;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                        <span>???</span>
                        <span>丘뒲잺</span>
                        <span>???</span>
                    </div>
                </div>
                
                <!-- Komponenty -->
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">游닍 Komponenty p콏ed치ny:</div>
                    <div style="display: flex; justify-content: space-around;">
                        <div style="text-align: center;">
                            <div style="color: #2196f3;">游녿꽳릢 Koudy</div>
                            <div style="font-size: 1.5rem;">${karma.componentsGiven?.koudy || 0}/4</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #e91e63;">游붳 Kory</div>
                            <div style="font-size: 1.5rem;">${karma.componentsGiven?.kory || 0}/4</div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistiky -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 0.8rem; border-radius: 8px; border: 2px solid #2196f3; text-align: center;">
                        <div style="font-size: 1.5rem;">游녿꽳릢</div>
                        <div style="color: #2196f3; font-weight: bold;">Koudy</div>
                        <div style="font-size: 1.2rem; color: #fff;">仇벒잺 ${karma.koudy}</div>
                        <div style="font-size: 0.75rem; color: #888;">???</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #2a1a2a, #1a0a1a); padding: 0.8rem; border-radius: 8px; border: 2px solid #e91e63; text-align: center;">
                        <div style="font-size: 1.5rem;">游붳</div>
                        <div style="color: #e91e63; font-weight: bold;">Kory</div>
                        <div style="font-size: 1.2rem; color: #fff;">仇벒잺 ${karma.kory}</div>
                        <div style="font-size: 0.75rem; color: #888;">???</div>
                    </div>
                </div>
                
                <!-- Info podle progressu -->
                ${(() => {
                    const completed = state.mainQuest?.completedQuests || [];
                    const knows_brothers = completed.includes('find_stranger') || completed.includes('meet_brothers');
                    const knows_genesis = completed.includes('meet_brothers') || completed.includes('first_component');
                    const knows_components = completed.includes('first_component');
                    
                    if (knows_components) {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">游눠 Sesb칤rej v코echny 4 komponenty a rozhodni o osudu sv캩ta v Bu캜ovic칤ch.</p></div>';
                    } else if (knows_genesis) {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">游눠 Zjisti v칤ce o Projektu Genesis a najdi komponenty.</p></div>';
                    } else if (knows_brothers) {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">游눠 Dva z치hadn칤 mu쬴. Nav코tiv je oba a zjisti co cht캩j칤.</p></div>';
                    } else {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">游눠 Prozkoumej sv캩t a zjisti v칤ce o t캩chto z치hadn칳ch postav치ch.</p></div>';
                    }
                })()}
                
                <button class="btn" onclick="closeModal()" style="width: 100%;">${t('ui', 'close')}</button>
            `);
        }
        
        function showStoryNPC(npcId) {
            console.log('showStoryNPC called with:', npcId);
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            console.log('Found NPC:', npc);
            if (!npc) {
                console.log('NPC not found!');
                return;
            }
            
            const karma = state.storyKarma || { kory: 0, koudy: 0 };
            const myKarma = karma[npcId] || 0;
            const rivalId = npc.rival;
            const rivalKarma = karma[rivalId] || 0;
            
            const relation = state.npcRelations?.[npcId] || { trust: 0, gifts: 0, quests: 0 };
            
            // N치lada podle karmy
            let moodText, moodColor;
            if (myKarma >= 50) {
                moodText = '仇벒잺 Spojenec';
                moodColor = '#4caf50';
            } else if (myKarma >= 20) {
                moodText = '游땕 P콏치telsk칳';
                moodColor = '#8bc34a';
            } else if (myKarma >= -20) {
                moodText = '游땛 Neutr치ln칤';
                moodColor = '#888';
            } else if (myKarma >= -50) {
                moodText = '游 Nep콏치telsk칳';
                moodColor = '#ff9800';
            } else {
                moodText = '游 Nep콏칤tel';
                moodColor = '#f44336';
            }
            
            const npcColor = npcId === 'kory' ? '#e91e63' : '#2196f3';
            const rivalName = rivalId === 'kory' ? 'Kory' : 'Koudy';
            
            // Aktivn칤 quest
            const activeQuestId = state.npcQuests?.[npcId]?.id;
            let activeQuestHtml = '';
            
            if (activeQuestId) {
                const activeQuest = NPC_QUESTS[activeQuestId];
                if (activeQuest) {
                    const canComplete = checkStoryQuestRequirements(activeQuest.requirement);
                    const progressText = getStoryQuestProgress(activeQuest.requirement);
                    
                    activeQuestHtml = `
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid ${canComplete ? '#4caf50' : npcColor};">
                            <h4 style="margin: 0 0 0.5rem 0; color: ${npcColor};">游댃 Aktivn칤 칰kol:</h4>
                            <div style="font-weight: bold;">${activeQuest.name}</div>
                            <div style="font-size: 0.85rem; color: #aaa; margin: 0.3rem 0;">${activeQuest.desc}</div>
                            <div style="font-size: 0.85rem; color: ${canComplete ? '#4caf50' : '#ff9800'}; margin: 0.5rem 0;">
                                游늵 Progres: ${progressText}
                            </div>
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">
                                游꾸 Odm캩na: ${activeQuest.reward.money || 0} 游눯
                            </div>
                            ${canComplete ? `
                                <button class="btn" onclick="turnInStoryQuest('${npcId}', '${activeQuestId}')" 
                                    style="width: 100%; background: #4caf50; margin-top: 0.5rem;">
                                    九 Odevzdat 칰kol
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            // Dostupn칠 questy (pokud nem치 aktivn칤)
            const availableQuests = npc.quests || [];
            let questsHtml = '';
            
            if (!activeQuestId) {
                // Norm치ln칤 NPC questy
                questsHtml = availableQuests.map(qId => {
                    const quest = NPC_QUESTS[qId];
                    if (!quest) return '';
                    const completed = state.npcQuests?.[npcId]?.completed?.includes(qId);
                    
                    if (completed) {
                        return `
                            <div style="padding: 0.5rem; background: #222; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                <span style="color: #4caf50;">九</span> ${quest.name}
                            </div>
                        `;
                    }
                    
                    return `
                        <button class="btn" onclick="acceptStoryQuest('${npcId}', '${qId}')" 
                            style="width: 100%; margin-bottom: 0.3rem; background: ${npcColor}; text-align: left; padding: 0.6rem;">
                            <span style="font-size: 0.9rem;">${quest.name}</span>
                            <div style="font-size: 0.75rem; color: #ccc; margin-top: 0.2rem;">${quest.desc}</div>
                            ${quest.details ? `<div style="font-size: 0.7rem; color: #64b5f6; margin-top: 0.3rem; padding: 0.3rem; background: rgba(0,0,0,0.3); border-radius: 3px;">${quest.details}</div>` : ''}
                            <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">游꾸 ${quest.reward.money || 0} 游눯</div>
                        </button>
                    `;
                }).join('');
                
                // Speci치ln칤 questy (Detektivn칤 a 캛asov칠)
                if (npc.specialQuests && npc.specialQuests.length > 0) {
                    const specialQuestsHtml = npc.specialQuests.map(sqId => {
                        // Zkontroluj jestli quest u nen칤 aktivn칤 nebo spln캩n칳
                        const isDetective = DETECTIVE_QUESTS.find(q => q.id === sqId);
                        const isTimed = TIMED_QUESTS.find(q => q.id === sqId);
                        
                        if (isDetective) {
                            const alreadyActive = state.detectiveQuests?.[sqId];
                            if (alreadyActive?.solved) {
                                return `<div style="padding: 0.5rem; background: #222; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                    <span style="color: #4caf50;">九</span> 游댌 ${isDetective.name}
                                </div>`;
                            }
                            if (alreadyActive) {
                                return `<div style="padding: 0.5rem; background: #2a1a2a; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid #9c27b0;">
                                    <span style="color: #9c27b0;">游댃</span> 游댌 ${isDetective.name} (aktivn칤)
                                </div>`;
                            }
                            return `
                                <button class="btn" onclick="acceptStoryQuest('${npcId}', '${sqId}')" 
                                    style="width: 100%; margin-bottom: 0.3rem; background: #6a1b9a; text-align: left; padding: 0.6rem;">
                                    <span style="font-size: 0.9rem;">游댌 ${isDetective.name}</span>
                                    <div style="font-size: 0.75rem; color: #ccc; margin-top: 0.2rem;">${isDetective.description}</div>
                                    <div style="font-size: 0.7rem; color: #ce93d8; margin-top: 0.2rem;">游꾸 ${isDetective.reward?.money || 0} 游눯, ${isDetective.reward?.xp || 0} XP</div>
                                </button>
                            `;
                        }
                        
                        if (isTimed) {
                            const alreadyActive = state.timedQuests?.find(t => t.id === sqId);
                            if (alreadyActive?.completed) {
                                return `<div style="padding: 0.5rem; background: #222; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                    <span style="color: #4caf50;">九</span> 낋 ${isTimed.name}
                                </div>`;
                            }
                            if (alreadyActive && !alreadyActive.failed) {
                                const remaining = Math.max(0, alreadyActive.endTime - Date.now());
                                const mins = Math.floor(remaining / 60000);
                                return `<div style="padding: 0.5rem; background: #2a2a1a; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid #ff9800;">
                                    <span style="color: #ff9800;">游댃</span> 낋 ${isTimed.name} (${mins}m zb칳v치)
                                </div>`;
                            }
                            if (alreadyActive?.failed) {
                                return `<div style="padding: 0.5rem; background: #2a1a1a; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                    <span style="color: #f44336;">九</span> 낋 ${isTimed.name} (selhal)
                                </div>`;
                            }
                            return `
                                <button class="btn" onclick="acceptStoryQuest('${npcId}', '${sqId}')" 
                                    style="width: 100%; margin-bottom: 0.3rem; background: #e65100; text-align: left; padding: 0.6rem;">
                                    <span style="font-size: 0.9rem;">낋 ${isTimed.name}</span>
                                    <div style="font-size: 0.75rem; color: #ccc; margin-top: 0.2rem;">${isTimed.description}</div>
                                    <div style="font-size: 0.7rem; color: #ffcc80; margin-top: 0.2rem;">낌勇 캛asov칳 limit: ${Math.floor(isTimed.timeLimit / 60000)} minut</div>
                                    <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">游꾸 ${isTimed.reward?.money || 0} 游눯, ${isTimed.reward?.xp || 0} XP</div>
                                </button>
                            `;
                        }
                        
                        return '';
                    }).join('');
                    
                    if (specialQuestsHtml) {
                        questsHtml += `<div style="margin-top: 0.5rem; border-top: 1px solid #333; padding-top: 0.5rem;">
                            <h5 style="color: #ff9800; margin: 0 0 0.3rem 0; font-size: 0.8rem;">救 Speci치ln칤 칰koly:</h5>
                            ${specialQuestsHtml}
                        </div>`;
                    }
                }
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${npc.icon}</div>
                    <p style="color: #888; font-style: italic;">"${npc.personality}"</p>
                    <p style="color: ${moodColor}; font-weight: bold;">${moodText}</p>
                </div>
                
                <!-- Karma Bar -->
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span style="color: ${npcColor};">Karma u ${npc.name}</span>
                        <span>${myKarma}/100</span>
                    </div>
                    <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${Math.max(0, myKarma)}%; background: ${npcColor};"></div>
                    </div>
                </div>
                
                <!-- Varov치n칤 o rivalovi -->
                ${rivalKarma > 30 ? `
                    <div style="background: #4a2a2a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #f44336;">
                        <p style="margin: 0; font-size: 0.85rem; color: #f44336;">
                            丘멆잺 "${rivalName} o tob캩 mluv칤... D치vej si pozor."
                        </p>
                    </div>
                ` : ''}
                
                <h4 style="color: ${npcColor}; margin-bottom: 0.5rem;">游닆 칔koly:</h4>
                ${activeQuestHtml}
                ${questsHtml || (activeQuestId ? '' : '<p style="color: #666;">V코echny 칰koly spln캩ny!</p>')}
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="talkToStoryNPC('${npcId}')" style="background: #555;">
                        游눫 Mluvit
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #333;">
                         Zp캩t
                    </button>
                </div>
            `);
        }
        
        function acceptStoryQuest(npcId, questId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            
            // === SPECI츼LN칈 QUESTY ===
            // 만rif Kowalski - Detektivn칤 questy
            if (npc?.specialQuests?.includes(questId) && DETECTIVE_QUESTS.find(q => q.id === questId)) {
                startDetectiveQuest(questId);
                closeModal();
                return;
            }
            
            // Posel Jin - 캛asov칠 questy
            if (npc?.specialQuests?.includes(questId) && TIMED_QUESTS.find(q => q.id === questId)) {
                startTimedQuest(questId);
                closeModal();
                return;
            }
            
            // === NORM츼LN칈 NPC QUESTY ===
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // Ulo po캜치te캜n칤 stav pro tracking progressu
            state.npcQuests = state.npcQuests || {};
            state.npcQuests[npcId] = {
                id: questId,
                accepted: Date.now(),
                startKills: state.stats?.kills || 0,
                startExplored: state.world?.visitedLocations?.length || 0,
                completed: state.npcQuests[npcId]?.completed || []
            };
            
            notifySuccess('칔kol p콏ijat!', quest.name);
            addLog(`P콏ijat 칰kol od ${npc?.name || npcId}: ${quest.name}`, '游닆');
            showStoryNPC(npcId);
        }
        
        function checkStoryQuestRequirements(req) {
            if (!req) return true;
            
            if (req.resource) {
                return (state.resources?.[req.resource] || 0) >= req.amount;
            }
            if (req.money) {
                return state.money >= req.money;
            }
            if (req.kills) {
                // Po캜칤t치 kills od p콏ijet칤 questu
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.kills
                );
                if (npcId) {
                    const startKills = state.npcQuests[npcId].startKills || 0;
                    const currentKills = state.stats?.kills || 0;
                    return (currentKills - startKills) >= req.kills;
                }
                return false;
            }
            if (req.explore) {
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.explore
                );
                if (npcId) {
                    const startExplored = state.npcQuests[npcId].startExplored || 0;
                    const currentExplored = state.world?.visitedLocations?.length || 0;
                    return (currentExplored - startExplored) >= req.explore;
                }
                return false;
            }
            
            return false;
        }
        
        function getStoryQuestProgress(req) {
            if (!req) return '???';
            
            if (req.resource) {
                const has = state.resources?.[req.resource] || 0;
                const icons = { metal: '丘뙖잺', wood: '游', gunpowder: '游눤', cloth: '游빗' };
                return `${icons[req.resource] || '游닍'} ${has}/${req.amount}`;
            }
            if (req.money) {
                return `游눯 ${state.money}/${req.money}`;
            }
            if (req.kills) {
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.kills
                );
                if (npcId) {
                    const startKills = state.npcQuests[npcId].startKills || 0;
                    const currentKills = state.stats?.kills || 0;
                    const progress = Math.max(0, currentKills - startKills);
                    return `游 ${progress}/${req.kills} zabit칳ch`;
                }
                return `游 0/${req.kills} zabit칳ch`;
            }
            if (req.explore) {
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.explore
                );
                if (npcId) {
                    const startExplored = state.npcQuests[npcId].startExplored || 0;
                    const currentExplored = state.world?.visitedLocations?.length || 0;
                    const progress = Math.max(0, currentExplored - startExplored);
                    return `游딬勇 ${progress}/${req.explore} lokac칤`;
                }
                return `游딬勇 0/${req.explore} lokac칤`;
            }
            
            return '???';
        }
        
        function turnInStoryQuest(npcId, questId) {
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // Odebr치n칤 zdroj콢
            if (quest.requirement.resource) {
                state.resources[quest.requirement.resource] -= quest.requirement.amount;
            }
            if (quest.requirement.money) {
                state.money -= quest.requirement.money;
            }
            
            // Zavolej kompletaci
            completeBucoviceQuest(npcId, questId);
            
            // Refresh UI
            closeModal();
            showStoryNPC(npcId);
        }
        
        function completeBucoviceQuest(npcId, questId) {
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // P콏idej odm캩ny
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            
            // Uprav karmu
            state.storyKarma = state.storyKarma || { kory: 0, koudy: 0, questsDone: { kory: 0, koudy: 0 } };
            
            if (quest.reward.karma_kory) {
                state.storyKarma.kory = Math.max(-100, Math.min(100, state.storyKarma.kory + quest.reward.karma_kory));
            }
            if (quest.reward.karma_koudy) {
                state.storyKarma.koudy = Math.max(-100, Math.min(100, state.storyKarma.koudy + quest.reward.karma_koudy));
            }
            
            // Po캜칤tadlo quest콢
            state.storyKarma.questsDone[npcId] = (state.storyKarma.questsDone[npcId] || 0) + 1;
            
            // Ozna캜 jako dokon캜en칳
            state.npcQuests[npcId].completed = state.npcQuests[npcId].completed || [];
            state.npcQuests[npcId].completed.push(questId);
            state.npcQuests[npcId].id = null;
            
            // Kontrola dominance
            checkBucoviceDominance();
            
            const rivalId = npcId === 'kory' ? 'koudy' : 'kory';
            const rivalName = rivalId === 'kory' ? 'Kory' : 'Koudy';
            
            notifySuccess('칔kol spln캩n!', `+${quest.reward.money || 0} 游눯`);
            
            if (quest.reward[`karma_${rivalId}`] < 0) {
                notifyWarning('Karma', `${rivalName} o tob캩 te캞 sm칳코l칤 h콢콏...`);
            }
            
            addLog(`Dokon캜en 칰kol: ${quest.name}`, '九');
        }
        
        function checkBucoviceDominance() {
            const karma = state.storyKarma;
            if (!karma) return;
            
            // Kontrola v칤t캩zstv칤
            if (karma.kory >= 100 && karma.questsDone.kory >= 3) {
                karma.dominance = 'kory';
                if (!karma.ending) {
                    karma.ending = 'kory';
                    showModal('游땓 Koryho v칤t캩zstv칤!', `
                        <div style="text-align: center;">
                            <div style="font-size: 5rem;">游땓游댠</div>
                            <h2 style="color: #e91e63;">Chaos v칤t캩z칤!</h2>
                            <p>D칤ky tv칠 pomoci Kory ovl치dl Projekt Genesise. M캩sto je nyn칤 centrem anarchie a svobody.</p>
                            <p style="color: #ff9800;">Kory t캩 jmenoval 캜estn칳m 캜lenem gangu!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">游꿀 Oslavit</button>
                    `);
                }
            } else if (karma.koudy >= 100 && karma.questsDone.koudy >= 3) {
                karma.dominance = 'koudy';
                if (!karma.ending) {
                    karma.ending = 'koudy';
                    showModal('游땒 Koudyho v칤t캩zstv칤!', `
                        <div style="text-align: center;">
                            <div style="font-size: 5rem;">游땒丘뒲잺</div>
                            <h2 style="color: #2196f3;">콎치d v칤t캩z칤!</h2>
                            <p>D칤ky tv칠 pomoci Koudy nastolil po콏치dek v Projekt Genesis칤ch. M캩sto vzkv칠t치 pod jeho veden칤m.</p>
                            <p style="color: #4caf50;">Koudy t캩 jmenoval 캜estn칳m str치쬮em!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">游꿀 Oslavit</button>
                    `);
                }
            }
        }
        
        function talkToStoryNPC(npcId) {
            const karma = state.storyKarma?.[npcId] || 0;
            const rivalId = npcId === 'kory' ? 'koudy' : 'kory';
            const rivalName = rivalId === 'kory' ? 'Kory' : 'Koudy';
            const npcName = npcId === 'kory' ? 'Kory' : 'Koudy';
            
            let dialogues;
            if (npcId === 'kory') {
                dialogues = [
                    { karma: -50, text: '"Ztra콘 se, zr치d캜e! Pom치h치코 tomu snobu Koudymu!"' },
                    { karma: 0, text: '"Hm? Co chce코? Pokud nejsi s n치mi, jsi proti n치m."' },
                    { karma: 30, text: '"Hele, nejsi 코patnej. Chaos je svoboda, ch치pe코?"' },
                    { karma: 60, text: '"Br치cho! Ty v칤코, co je spr치vn칳. Poj캞, zbo콏칤me ten jeho po콏치dek!"' },
                    { karma: 100, text: '"Jsi jeden z n치s! Spole캜n캩 ovl치dneme tohle m캩sto!"' }
                ];
            } else {
                dialogues = [
                    { karma: -50, text: '"Odejdi. Pom치h치코 tomu krimin치ln칤kovi Korymu."' },
                    { karma: 0, text: '"Dobr칳 den. Mohu ti n캩jak pomoci? 콎치d je z치klad civilizace."' },
                    { karma: 30, text: '"V칤tej p콏칤teli. Vid칤m, 쬰 si cen칤코 po콏치dku a spravedlnosti."' },
                    { karma: 60, text: '"Jsem r치d, 쬰 jsi na na코칤 stran캩. Spole캜n캩 obnov칤me m칤r."' },
                    { karma: 100, text: '"Jsi m콢j nejcenn캩j코칤 spojenec. Projekt Genesise ti budou vd캩캜n칠 nav쬯y!"' }
                ];
            }
            
            // Najdi spr치vn칳 dialog
            let dialogue = dialogues[0];
            for (const d of dialogues) {
                if (karma >= d.karma) dialogue = d;
            }
            
            showModal(`游눫 ${npcName} 콏칤k치:`, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="font-size: 1.1rem; font-style: italic; margin: 0;">${dialogue.text}</p>
                </div>
                <button class="btn" onclick="showStoryNPC('${npcId}')" style="width: 100%;">${'Zp캩t'}</button>
            `);
        }
        
        // Funkce pro z칤sk치n칤 aktivn칤ch bonus콢 od NPC
        function getNPCBonuses() {
            const bonuses = {
                freeHealing: false,       // Doktor Harris - l칠캜en칤 zdarma
                shopDiscount: 0,          // Star칳 obchodn칤k - sleva 20%
                mapReveal: false,         // Zv캩dka Maya - odhalen칤 mapy
                canGetCompanion: false,   // Zv캩dka Maya - companion
                weaponUpgrade: false,     // Kov치콏 Ivan - upgrade zbran캩
                legendarycraft: false,    // Kov치콏 Ivan - legendary craft
                prophecy: false,          // Z치hadn치 쬰na - proroctv칤
                secretLocation: false,    // Z치hadn치 쬰na - tajn치 lokace
                freeExplosives: false,    // Kory - v칳bu코niny zdarma
                medicalTraining: false,   // Koudy/Doktor - med. tr칠nink
                craftedWeaponBonus: 0     // Mechanik Pepa - bonus DMG s craft캩n칳mi zbran캩mi
            };
            
            if (!state.npcRelations) return bonuses;
            
            // Star칳 obchodn칤k - sleva
            const merchant = state.npcRelations['old_merchant'];
            if (merchant?.trust >= 50) bonuses.shopDiscount = 0.2;
            if (merchant?.trust >= 100) bonuses.shopDiscount = 0.25;
            
            // Doktor Harris - l칠캜en칤 zdarma
            const doc = state.npcRelations['doc_harris'];
            if (doc?.trust >= 50) bonuses.freeHealing = true;
            if (doc?.trust >= 100) bonuses.medicalTraining = true;
            
            // Zv캩dka Maya - mapa a companion
            const maya = state.npcRelations['scout_maya'];
            if (maya?.trust >= 50) bonuses.mapReveal = true;
            if (maya?.trust >= 100) bonuses.canGetCompanion = true;
            
            // Kov치콏 Ivan - upgrade a legendary
            const ivan = state.npcRelations['blacksmith_ivan'];
            if (ivan?.trust >= 50) bonuses.weaponUpgrade = true;
            if (ivan?.trust >= 100) bonuses.legendarycraft = true;
            
            // Z치hadn치 쬰na - proroctv칤 a tajn치 lokace
            const woman = state.npcRelations['mysterious_woman'];
            if (woman?.trust >= 50) bonuses.prophecy = true;
            if (woman?.trust >= 100) bonuses.secretLocation = true;
            
            // P칠콘a - drby a tajn치 cesta
            const peta = state.npcRelations['kid_peta'];
            if (peta?.trust >= 50) bonuses.gossip = true; // Sly코칤 drby - odhal칤 NPC lokace
            if (peta?.trust >= 100) bonuses.secretPath = true; // Tajn치 cesta - rychl칠 cestov치n칤
            
            // Babi캜ka Marta - bylinky a recept
            const marta = state.npcRelations['grandma_marta'];
            if (marta?.trust >= 50) bonuses.freeHerbs = true;
            if (marta?.trust >= 100) bonuses.secretRecipe = true;
            
            // Lovec Viktor - loveck칠 tipy
            const viktor = state.npcRelations['hunter_viktor'];
            if (viktor?.trust >= 50) bonuses.huntingTips = true;
            if (viktor?.trust >= 100) bonuses.rareHunt = true;
            
            // U캜itelka V캩ra - bonus XP
            const vera = state.npcRelations['teacher_vera'];
            if (vera?.trust >= 50) bonuses.xpBonus = 0.1; // +10% XP
            if (vera?.trust >= 100) bonuses.xpBonus = 0.2; // +20% XP
            
            // Kory - v칳bu코niny zdarma
            const kory = state.npcRelations['kory'];
            if (kory?.trust >= 50) bonuses.freeExplosives = true;
            
            // Koudy - l칠캜en칤 zdarma
            const koudy = state.npcRelations['koudy'];
            if (koudy?.trust >= 50) bonuses.freeHealing = true;
            if (koudy?.trust >= 100) bonuses.medicalTraining = true;
            
            // Mechanik Pepa - bonus DMG s craft캩n칳mi zbran캩mi
            const pepa = state.npcRelations['mechanic_pepa'];
            if (pepa?.trust >= 50) bonuses.craftedWeaponBonus = 0.15; // +15% DMG
            if (pepa?.trust >= 100) bonuses.craftedWeaponBonus = 0.25; // +25% DMG
            
            return bonuses;
        }
        
        // Pomocn치 funkce pro nalezen칤 deliver questu sm캩콏uj칤c칤ho k dan칠mu NPC
        function findDeliverQuestForNPC(targetNpcId) {
            if (!state.npcQuests) return null;
            
            for (const [questGiverId, questData] of Object.entries(state.npcQuests)) {
                if (questData.deliverTarget === targetNpcId && questData.id) {
                    const quest = NPC_QUESTS[questData.id];
                    if (quest && quest.requirement?.deliver) {
                        // Kontrola jestli je quest spln캩n (m치 dost surovin)
                        if (checkNPCQuestProgress(questData, quest)) {
                            return {
                                questGiverId,
                                quest,
                                activeQuest: questData
                            };
                        }
                    }
                }
            }
            return null;
        }
        
        function showNPCDetail(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) return;
            
            // Kontrola jestli m치 n캩kdo deliver quest pro tohoto NPC
            const deliverQuestInfo = findDeliverQuestForNPC(npcId);
            if (deliverQuestInfo) {
                // Zobraz mo쬹ost odevzdat z치silku
                const { questGiverId, quest, activeQuest } = deliverQuestInfo;
                const questGiver = FRIENDLY_NPCS.find(n => n.id === questGiverId);
                
                showModal(`游닍 Doru캜en칤 z치silek`, `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 3rem;">${npc.icon}</div>
                        <h3 style="color: #fff; margin: 0.5rem 0;">${npc.name}</h3>
                    </div>
                    <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"Aha, z치soby od ${questGiver?.name || 'obchodn칤ka'}! V칳born캩, pr치v캩 je pot콏ebuju."</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游꾸 Odm캩na:</h4>
                        <p style="font-size: 0.9rem; color: #aaa;">
                            ${quest.reward.money ? `游눯 ${quest.reward.money} pen캩z ` : ''}
                            ${quest.reward.trust ? `仇벒잺 +${quest.reward.trust} d콢v캩ry ` : ''}
                            ${quest.reward.xp ? `救 +${quest.reward.xp} XP` : ''}
                        </p>
                    </div>
                    
                    <button class="btn" onclick="completeDeliverQuest('${questGiverId}', '${npcId}')" style="width: 100%; background: #4caf50;">游닍 P콏edat z치soby</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav콏칤t</button>
                `);
                return;
            }
            
            // Kontrola jestli hr치캜 nav코t칤vil lokaci NPC
            const npcLocation = npc.location;
            const visitedLocation = state.world?.visitedLocations?.includes(npcLocation);
            const isInMet = state.mainQuest?.npcMet?.includes(npc.id);
            const hasTrust = (state.npcRelations?.[npc.id]?.trust || 0) > 0;
            
            // Je hr치캜 PR츼V캨 TE캝 na lokaci NPC?
            const isAtNPCLocation = state.world?.currentLocation === npcLocation;
            
            if (!visitedLocation && !isInMet && !hasTrust) {
                showModal('仇 Nezn치m칳 NPC', `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游</div>
                        <p style="color: #888;">Tohoto p콏e쬴v코칤ho jsi je코t캩 nepotkal.</p>
                        <p style="color: #666; font-size: 0.85rem;">Nav코tiv lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npcLocation)?.name || npcLocation}</strong> abys ho objevil!</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            state.npcRelations = state.npcRelations || {};
            const relation = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0 };
            
            const trustLevel = relation.trust >= 100 ? 'Nejlep코칤 p콏칤tel' : 
                               relation.trust >= 75 ? 'Dobr칳 p콏칤tel' :
                               relation.trust >= 50 ? 'P콏칤tel' :
                               relation.trust >= 25 ? 'Zn치m칳' : 'Cizinec';
            
            // Odm캩ny
            let rewardsHtml = '';
            if (npc.rewards) {
                rewardsHtml = `
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--toxic-dark);">
                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">游꾸 Odm캩ny za d콢v캩ru:</h4>
                        <div style="font-size: 0.85rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
                                <span>50 d콢v캩ry:</span>
                                <span style="color: ${relation.trust >= 50 ? '#8bc34a' : '#888'};">
                                    ${relation.trust >= 50 ? '九 ' : '游 '}${npc.rewards.trust50}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
                                <span>100 d콢v캩ry:</span>
                                <span style="color: ${relation.trust >= 100 ? '#8bc34a' : '#888'};">
                                    ${relation.trust >= 100 ? '九 ' : '游 '}${npc.rewards.trust100}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Tla캜칤tka - n캩kter칠 akce vy쬬duj칤 b칳t na lokaci NPC
            const locationWarning = !isAtNPCLocation ? `
                <div style="background: #3a2a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; text-align: center; border: 1px solid #ff9800;">
                    <span style="color: #ff9800;">游늸 ${npc.name} je na lokaci: ${WORLD_LOCATIONS.find(l => l.id === npcLocation)?.name || npcLocation}</span>
                </div>
            ` : '';
            
            // Tla캜칤tka podle toho jestli jsi na lokaci
            const talkButton = isAtNPCLocation 
                ? `<button class="btn" onclick="talkToFriendlyNPC('${npcId}')" style="background: #3949AB;">游눫 Mluvit</button>`
                : `<button class="btn" style="background: #333; color: #666; cursor: not-allowed;" disabled title="Mus칤코 b칳t na lokaci NPC">游눫 Mluvit (游늸)</button>`;
            
            const giftButton = isAtNPCLocation 
                ? `<button class="btn" onclick="giveGiftToNPC('${npcId}')" style="background: var(--toxic-dark);">游꾸 D치t dar</button>`
                : `<button class="btn" style="background: #333; color: #666; cursor: not-allowed;" disabled title="Mus칤코 b칳t na lokaci NPC">游꾸 D치t dar (游늸)</button>`;
            
            // Quest tla캜칤tko tak칠 vy쬬duje b칳t na lokaci
            const questButton = isAtNPCLocation 
                ? `<button class="btn" onclick="askNPCQuest('${npcId}')" style="background: #ff9800;">游닆 Zeptat se na 칰kol</button>`
                : `<button class="btn" style="background: #333; color: #666; cursor: not-allowed;" disabled title="Mus칤코 b칳t na lokaci NPC">游닆 칔koly (游늸)</button>`;
            
            // Tla캜칤tko Dokon캜it 칰kol - pokud m치 aktivn칤 quest
            let completeQuestButton = '';
            const activeQuest = state.npcQuests?.[npcId];
            if (activeQuest && activeQuest.id && isAtNPCLocation) {
                const quest = NPC_QUESTS[activeQuest.id];
                if (quest) {
                    const canComplete = checkNPCQuestProgress(activeQuest, quest);
                    if (canComplete) {
                        completeQuestButton = `<button class="btn" onclick="completeNPCQuest('${npcId}')" style="background: #4caf50; animation: pulse 1s infinite;">九 Dokon캜it 칰kol: ${quest.name}</button>`;
                    } else {
                        completeQuestButton = `<button class="btn" style="background: #333; color: #888;" disabled>游늶 칔kol: ${quest.name} (nespln캩no)</button>`;
                    }
                }
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${npc.icon}</div>
                    <p style="color: #888; font-style: italic;">"${npc.personality}"</p>
                    <p style="color: #666; font-size: 0.85rem;">游늸 ${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Vztah:</span>
                        <span style="color: #ffd700;">${trustLevel}</span>
                    </div>
                    <div style="height: 10px; background: #0a0a0a; border-radius: 5px; overflow: hidden;">
                        <div style="height: 100%; width: ${relation.trust}%; background: linear-gradient(90deg, #ff9800, #8bc34a);"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                        <span>仇벒잺 ${relation.trust}/100</span>
                        <span>游꾸 ${relation.gifts} dar콢 | 游닆 ${relation.quests} quest콢</span>
                    </div>
                </div>
                
                ${rewardsHtml}
                
                ${locationWarning}
                
                ${getNPCSpecialActions(npcId, relation.trust)}
                
                ${completeQuestButton}
                
                <div style="display: grid; gap: 0.5rem;">
                    ${talkButton}
                    ${giftButton}
                    ${questButton}
                    <button class="btn" onclick="showNPCRelations()" style="background: #555;">
                         Zp캩t
                    </button>
                </div>
            `);
        }
        
        // Speci치ln칤 akce pro NPC podle d콢v캩ry
        function getNPCSpecialActions(npcId, trust) {
            let html = '';
            
            // Star칳 obchodn칤k - v쬯y zobraz obchod
            if (npcId === 'old_merchant') {
                html += `<button class="btn" onclick="closeModal(); openShop();" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust-light);">
                    游 Otev콏칤t obchod
                </button>`;
                if (trust >= 50) {
                    html += `<div style="background: #1a3a1a; padding: 0.3rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a; font-size: 0.8rem;">九 Sleva 20% aktivn칤</div>`;
                }
            }
            
            // Zv캩dka Maya - odhalen칤 mapy
            if (npcId === 'scout_maya' && trust >= 50) {
                const alreadyRevealed = state.secrets?.includes('maya_map_reveal');
                if (!alreadyRevealed) {
                    html += `<button class="btn" onclick="revealMapFromMaya()" style="width: 100%; margin-bottom: 0.5rem; background: #2196f3;">
                        游딬勇 Odhal tajn칠 lokace na map캩
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Mapa odhalena</div>`;
                }
            }
            
            // Zv캩dka Maya - companion
            if (npcId === 'scout_maya' && trust >= 100) {
                const hasCompanion = state.companions?.some(c => c.id === 'maya_companion');
                if (!hasCompanion) {
                    html += `<button class="btn" onclick="recruitMayaCompanion()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        游끢꽥勇 Po쮂멳ej Mayu o doprovod
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Maya je tv콢j companion</div>`;
                }
            }
            
            // Kov치콏 Ivan - upgrade zbran캩 a zbroje
            if (npcId === 'blacksmith_ivan' && trust >= 50) {
                const blacksmithBonus = getSettlerUpgradeBonus();
                const totalDmg = 5 + blacksmithBonus;
                const totalDef = 5 + blacksmithBonus;
                const bonusText = blacksmithBonus > 0 ? ` <span style="color: #ffd700;">(+${blacksmithBonus} kov치콏)</span>` : '';
                
                html += `<button class="btn" onclick="upgradeWeaponAtIvan()" style="width: 100%; margin-bottom: 0.5rem; background: #ff5722;">
                    游댣 Vylep코it zbra켿 (+${totalDmg} DMG, 50丘뙖잺)${bonusText}
                </button>`;
                html += `<button class="btn" onclick="upgradeArmorAtIvan()" style="width: 100%; margin-bottom: 0.5rem; background: #2196f3;">
                    游띠勇 Vylep코it zbroj (+${totalDef} DEF, 50丘뙖잺)${bonusText}
                </button>`;
            }
            
            // Kov치콏 Ivan - legendary craft (vy쬬duje skill Legend치rn칤 kov치콏)
            if (npcId === 'blacksmith_ivan' && trust >= 100) {
                const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
                if (hasLegendarySmith) {
                    html += `<button class="btn" onclick="craftLegendaryAtIvan()" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #ffd700, #ff8f00); color: #000;">
                        救 Vykovat legend치rn칤 zbra켿 (100丘뙖잺 50游댤 20游님)
                    </button>`;
                } else {
                    html += `<div style="background: #2a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; border: 1px solid #555;">
                        <span style="color: #888;">游 Legend치rn칤 craft</span><br>
                        <span style="color: #ff9800; font-size: 0.75rem;">Vy쬬duje skill "Legend치rn칤 kov치콏" (콎emeslo tier 4)</span>
                    </div>`;
                }
            }
            
            // Z치hadn치 쬰na - proroctv칤
            if (npcId === 'mysterious_woman' && trust >= 50) {
                const hasProphecy = state.secrets?.includes('mysterious_prophecy');
                if (!hasProphecy) {
                    html += `<button class="btn" onclick="getProphecy()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        游댩 Z칤skej proroctv칤
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Proroctv칤 z칤sk치no (+10% XP)</div>`;
                }
            }
            
            // Z치hadn치 쬰na - tajn치 lokace
            if (npcId === 'mysterious_woman' && trust >= 100) {
                const hasSecret = state.secrets?.includes('secret_location_revealed');
                if (!hasSecret) {
                    html += `<button class="btn" onclick="revealSecretLocation()" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #9c27b0, #673ab7);">
                        游딓勇 Odhal tajnou lokaci
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Tajn치 lokace odhalena</div>`;
                }
            }
            
            // Kory - v칳bu코niny zdarma
            if (npcId === 'kory' && trust >= 50) {
                const lastFreeExplosives = state.lastFreeExplosives || 0;
                const canGet = Date.now() - lastFreeExplosives > 24 * 60 * 60 * 1000; // 1x denn캩
                if (canGet) {
                    html += `<button class="btn" onclick="getFreeExplosives()" style="width: 100%; margin-bottom: 0.5rem; background: #c62828;">
                        游눢 Z칤skej v칳bu코niny zdarma
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastFreeExplosives)) / 3600000);
                    html += `<div style="background: #2a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">游눢 V칳bu코niny za ${hoursLeft}h</div>`;
                }
            }
            
            // P칠콘a - drby (odhal칤 NPC)
            if (npcId === 'kid_peta' && trust >= 50) {
                html += `<button class="btn" onclick="getGossipFromPeta()" style="width: 100%; margin-bottom: 0.5rem; background: #ff9800;">
                    游녝 Poslechnout drby
                </button>`;
            }
            
            // P칠콘a - tajn치 cesta (rychl칠 cestov치n칤)
            if (npcId === 'kid_peta' && trust >= 100) {
                const pathActive = state.secretPathExpires && Date.now() < state.secretPathExpires;
                if (pathActive) {
                    const hoursLeft = Math.ceil((state.secretPathExpires - Date.now()) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Tajn치 cesta aktivn칤 (${hoursLeft}h)</div>`;
                } else {
                    html += `<button class="btn" onclick="learnSecretPath()" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        游띣勇 Aktivovat tajnou cestu (-50% 캜as, 24h)
                    </button>`;
                }
            }
            
            // Babi캜ka Marta - bylinky zdarma
            if (npcId === 'grandma_marta' && trust >= 50) {
                const lastFreeHerbs = state.lastFreeHerbs || 0;
                const canGet = Date.now() - lastFreeHerbs > 12 * 60 * 60 * 1000; // 2x denn캩
                if (canGet) {
                    html += `<button class="btn" onclick="getFreeHerbs()" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        游 Z칤skej bylinky zdarma (5x)
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((12 * 60 * 60 * 1000 - (Date.now() - lastFreeHerbs)) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">游 Bylinky za ${hoursLeft}h</div>`;
                }
            }
            
            // Babi캜ka Marta - tajn칳 recept
            if (npcId === 'grandma_marta' && trust >= 100) {
                const hasRecipe = state.secrets?.includes('marta_secret_recipe');
                if (!hasRecipe) {
                    html += `<button class="btn" onclick="learnSecretRecipe()" style="width: 100%; margin-bottom: 0.5rem; background: #8bc34a;">
                        游닆 Nau캜it se tajn칳 recept (Super Stimpak)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Tajn칳 recept nau캜en</div>`;
                }
            }
            
            // Lovec Viktor - loveck칠 tipy
            if (npcId === 'hunter_viktor' && trust >= 50) {
                html += `<button class="btn" onclick="getHuntingTips()" style="width: 100%; margin-bottom: 0.5rem; background: #795548;">
                    游낓 Loveck칠 tipy (+25% loot ze zv칤콏at)
                </button>`;
            }
            
            // Lovec Viktor - vz치cn치 ko콏ist
            if (npcId === 'hunter_viktor' && trust >= 100) {
                const lastRareHunt = state.lastRareHunt || 0;
                const canHunt = Date.now() - lastRareHunt > 24 * 60 * 60 * 1000;
                if (canHunt) {
                    html += `<button class="btn" onclick="goRareHunt()" style="width: 100%; margin-bottom: 0.5rem; background: #ff5722;">
                        游붋 Lov vz치cn칠 ko콏isti
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastRareHunt)) / 3600000);
                    html += `<div style="background: #2a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">游붋 Dal코칤 lov za ${hoursLeft}h</div>`;
                }
            }
            
            // Kapit치n Nov치k - vojensk칳 v칳cvik
            if (npcId === 'captain_novak' && trust >= 50) {
                const hasTrained = state.secrets?.includes('novak_military_training');
                if (!hasTrained) {
                    html += `<button class="btn" onclick="getMilitaryTraining()" style="width: 100%; margin-bottom: 0.5rem; background: #455a64;">
                        游꿌勇 Vojensk칳 v칳cvik (+5 DMG permanentn캩)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Vojensk칳 v칳cvik dokon캜en</div>`;
                }
            }
            
            // Kapit치n Nov치k - tajemstv칤 o 캛ern칠m
            if (npcId === 'captain_novak' && trust >= 100) {
                const hasSecret = state.secrets?.includes('novak_cerny_secret');
                if (!hasSecret) {
                    html += `<button class="btn" onclick="learnCernySecret()" style="width: 100%; margin-bottom: 0.5rem; background: #37474f;">
                        游 Sly코et pravdu o Veliteli 캛ern칠m
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Pravda odhalena</div>`;
                }
            }
            
            // Mechanik Pepa - opravy levn캩ji
            if (npcId === 'mechanic_pepa' && trust >= 50) {
                html += `<button class="btn" onclick="repairAtPepa()" style="width: 100%; margin-bottom: 0.5rem; background: #795548;">
                    游댢 Opravit vybaven칤 (50% sleva)
                </button>`;
            }
            
            // Mechanik Pepa - vozidlo zm캩n캩no na master oprav치콏
            if (npcId === 'mechanic_pepa' && trust >= 100) {
                const hasMaster = state.secrets?.includes('pepa_master_repair');
                if (!hasMaster) {
                    html += `<button class="btn" onclick="getMasterRepair()" style="width: 100%; margin-bottom: 0.5rem; background: #ff9800;">
                        游댢 Nau캜it se mistrovsk칠 opravy (zdarma opravy)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Mistrovsk칠 opravy nau캜eny</div>`;
                }
            }
            
            // Sestra Anna - po쬰hn치n칤
            if (npcId === 'sister_anna' && trust >= 50) {
                const lastBlessing = state.lastBlessing || 0;
                const canBless = Date.now() - lastBlessing > 24 * 60 * 60 * 1000;
                if (canBless) {
                    html += `<button class="btn" onclick="getBlessing()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        久 Po쬰hn치n칤 (+20% 코ance p콏e쮂셦 smrteln칳 칰tok)
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastBlessing)) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">久 Po쬰hn치n칤 za ${hoursLeft}h</div>`;
                }
            }
            
            // Sestra Anna - svat치 relikvie
            if (npcId === 'sister_anna' && trust >= 100) {
                const hasRelic = state.secrets?.includes('anna_holy_relic');
                if (!hasRelic) {
                    html += `<button class="btn" onclick="getHolyRelic()" style="width: 100%; margin-bottom: 0.5rem; background: #ffd700; color: #000;">
                        九뢢잺 Z칤skat svatou relikvii
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Relikvie z칤sk치na</div>`;
                }
            }
            
            // Pa코er치k Radek - 캜ern칳 trh
            if (npcId === 'smuggler_radek' && trust >= 50) {
                html += `<button class="btn" onclick="openBlackMarket()" style="width: 100%; margin-bottom: 0.5rem; background: #37474f;">
                    游꿠 캛ern칳 trh (vz치cn칠 p콏edm캩ty)
                </button>`;
            }
            
            // Pa코er치k Radek - velk칠 tajemstv칤
            if (npcId === 'smuggler_radek' && trust >= 100) {
                const hasSecret = state.secrets?.includes('radek_big_secret');
                if (!hasSecret) {
                    html += `<button class="btn" onclick="learnBigSecret()" style="width: 100%; margin-bottom: 0.5rem; background: #212121;">
                        游돗勇 Sly코et velk칠 tajemstv칤
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Tajemstv칤 odhaleno</div>`;
                }
            }
            
            // U캜itelka V캩ra - sirotek companion
            if (npcId === 'teacher_vera' && trust >= 100) {
                const hasOrphan = state.companions?.some(c => c.id === 'orphan_companion');
                if (!hasOrphan) {
                    html += `<button class="btn" onclick="adoptOrphan()" style="width: 100%; margin-bottom: 0.5rem; background: #e91e63;">
                        游녽 Adoptovat sirotka (companion)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Sirotek adoptov치n</div>`;
                }
            }
            
            // 먞셟en칳 Jirka - varov치n칤
            if (npcId === 'crazy_jirka' && trust >= 50) {
                const hasWarning = state.secrets?.includes('jirka_warning');
                if (!hasWarning) {
                    html += `<button class="btn" onclick="getJirkaWarning()" style="width: 100%; margin-bottom: 0.5rem; background: #ff5722;">
                        丘멆잺 Sly코et varov치n칤
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Varov치n칤 sly코eno</div>`;
                }
            }
            
            // 먞셟en칳 Jirka - pravda o Korym
            if (npcId === 'crazy_jirka' && trust >= 100) {
                const hasTruth = state.secrets?.includes('jirka_kory_truth');
                if (!hasTruth) {
                    html += `<button class="btn" onclick="learnKoryTruth()" style="width: 100%; margin-bottom: 0.5rem; background: #c62828;">
                        游 PRAVDA O KORYM
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Pravda odhalena</div>`;
                }
            }
            
            // Sta콏ec Tom치코 - historie
            if (npcId === 'elder_tomas' && trust >= 50) {
                const hasHistory = state.secrets?.includes('tomas_history');
                if (!hasHistory) {
                    html += `<button class="btn" onclick="learnHistory()" style="width: 100%; margin-bottom: 0.5rem; background: #8d6e63;">
                        游닆 Sly코et historii kraje
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Historie sly코ena</div>`;
                }
            }
            
            // Sta콏ec Tom치코 - pravda o Z치hadn칠 쬰n캩
            if (npcId === 'elder_tomas' && trust >= 100) {
                const hasTruth = state.secrets?.includes('tomas_woman_truth');
                if (!hasTruth) {
                    html += `<button class="btn" onclick="learnWomanTruth()" style="width: 100%; margin-bottom: 0.5rem; background: #673ab7;">
                        游댩 Pravda o Z치hadn칠 쬰n캩
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Pravda odhalena</div>`;
                }
            }
            
            // In쬰n칳rka Kl치ra - tech vylep코en칤
            if (npcId === 'engineer_klara' && trust >= 50) {
                html += `<button class="btn" onclick="getTechUpgrade()" style="width: 100%; margin-bottom: 0.5rem; background: #00bcd4;">
                    丘 Tech vylep코en칤 (+10 DEF vybaven칤)
                </button>`;
            }
            
            // In쬰n칳rka Kl치ra - d콢kazy proti Koudymu
            if (npcId === 'engineer_klara' && trust >= 100) {
                const hasEvidence = state.secrets?.includes('klara_koudy_evidence');
                if (!hasEvidence) {
                    html += `<button class="btn" onclick="getKoudyEvidence()" style="width: 100%; margin-bottom: 0.5rem; background: #f44336;">
                        游늶 D콢kazy proti Koudymu
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 D콢kazy z칤sk치ny</div>`;
                }
            }
            
            // Velitel 캛ern칳 - p콏칤m캩콏칤
            if (npcId === 'commander_cerny' && trust >= 50) {
                const hasTruce = state.secrets?.includes('cerny_truce');
                if (!hasTruce) {
                    html += `<button class="btn" onclick="makeTruce()" style="width: 100%; margin-bottom: 0.5rem; background: #607d8b;">
                        游뱋 Uzav콏칤t p콏칤m캩콏칤 (n치jezdn칤ci ne칰to캜칤)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 P콏칤m캩콏칤 uzav콏eno</div>`;
                }
            }
            
            // Velitel 캛ern칳 - pravda o v치lce
            if (npcId === 'commander_cerny' && trust >= 100) {
                const hasTruth = state.secrets?.includes('cerny_war_truth');
                if (!hasTruth) {
                    html += `<button class="btn" onclick="learnWarTruth()" style="width: 100%; margin-bottom: 0.5rem; background: #263238;">
                        游 Pravda o v치lce
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Pravda sly코ena</div>`;
                }
            }
            
            // Kart치콏ka Rosa - v캩코tba
            if (npcId === 'fortune_rosa' && trust >= 50) {
                const lastFortune = state.lastFortune || 0;
                const canFortune = Date.now() - lastFortune > 12 * 60 * 60 * 1000;
                if (canFortune) {
                    html += `<button class="btn" onclick="getFortune()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        游 V캩코tba (n치hodn칳 bonus)
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((12 * 60 * 60 * 1000 - (Date.now() - lastFortune)) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">游 V캩코tba za ${hoursLeft}h</div>`;
                }
            }
            
            // Kart치콏ka Rosa - le o Z치hadn칠 쬰n캩
            if (npcId === 'fortune_rosa' && trust >= 100) {
                const hasLie = state.secrets?.includes('rosa_woman_lie');
                if (!hasLie) {
                    html += `<button class="btn" onclick="hearWomanLie()" style="width: 100%; margin-bottom: 0.5rem; background: #e91e63;">
                        游꿠 "Pravda" o Z치hadn칠 쬰n캩
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #ff9800;">九 Sly코ena "pravda"</div>`;
                }
            }
            
            // 만rif Kowalski - p콏칤stup k d콢kaz콢m
            if (npcId === 'sheriff_kowalski' && trust >= 50) {
                html += `<button class="btn" onclick="accessEvidence()" style="width: 100%; margin-bottom: 0.5rem; background: #3f51b5;">
                    游늶 Prozkoumat d콢kazy (odhal칤 quest info)
                </button>`;
            }
            
            // 만rif Kowalski - z치stupce 코erifa
            if (npcId === 'sheriff_kowalski' && trust >= 100) {
                const isDeputy = state.secrets?.includes('kowalski_deputy');
                if (!isDeputy) {
                    html += `<button class="btn" onclick="becomeDeputy()" style="width: 100%; margin-bottom: 0.5rem; background: #ffd700; color: #000;">
                        游꿌勇 St치t se z치stupcem 코erifa
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Jsi z치stupce 코erifa</div>`;
                }
            }
            
            // Posel Jin - rychlej코칤 cestov치n칤
            if (npcId === 'messenger_jin' && trust >= 50) {
                const hasFastTravel = state.secrets?.includes('jin_fast_routes');
                if (!hasFastTravel) {
                    html += `<button class="btn" onclick="learnFastRoutes()" style="width: 100%; margin-bottom: 0.5rem; background: #00bcd4;">
                        游끢 Nau캜it se rychl칠 cesty (-5% 캜as)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Rychl칠 cesty nau캜eny</div>`;
                }
            }
            
            // Posel Jin - tajn칠 zkratky
            if (npcId === 'messenger_jin' && trust >= 100) {
                const hasShortcuts = state.secrets?.includes('jin_secret_shortcuts');
                if (!hasShortcuts) {
                    html += `<button class="btn" onclick="learnSecretShortcuts()" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        游딬勇 Tajn칠 zkratky (-10% 캜as cestov치n칤)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 Zkratky nau캜eny</div>`;
                }
            }
            
            // Doktor Harris - l칠캜en칤 zdarma
            if (npcId === 'doc_harris' && trust >= 50) {
                const lastFreeHeal = state.lastFreeHealHarris || 0;
                const canHeal = Date.now() - lastFreeHeal > 30 * 60 * 1000; // 30 minut cooldown
                const needsHeal = state.char.hp < state.char.maxHp;
                
                if (canHeal && needsHeal) {
                    html += `<button class="btn" onclick="freeHealFromNPC('doc_harris')" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        仇벒잺 L칠캜en칤 zdarma (pln칠 HP)
                    </button>`;
                } else if (!needsHeal) {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 M치코 pln칠 zdrav칤</div>`;
                } else {
                    const minsLeft = Math.ceil((30 * 60 * 1000 - (Date.now() - lastFreeHeal)) / 60000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">仇벒잺 L칠캜en칤 za ${minsLeft} min</div>`;
                }
            }
            
            // Koudy - l칠캜en칤 zdarma
            if (npcId === 'koudy' && trust >= 50) {
                const lastFreeHeal = state.lastFreeHealKoudy || 0;
                const canHeal = Date.now() - lastFreeHeal > 30 * 60 * 1000; // 30 minut cooldown
                const needsHeal = state.char.hp < state.char.maxHp;
                
                if (canHeal && needsHeal) {
                    html += `<button class="btn" onclick="freeHealFromNPC('koudy')" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        仇벒잺 L칠캜en칤 zdarma (pln칠 HP)
                    </button>`;
                } else if (!needsHeal) {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">九 M치코 pln칠 zdrav칤</div>`;
                } else {
                    const minsLeft = Math.ceil((30 * 60 * 1000 - (Date.now() - lastFreeHeal)) / 60000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">仇벒잺 L칠캜en칤 za ${minsLeft} min</div>`;
                }
            }
            
            return html;
        }
        
        // === NPC BONUS FUNKCE ===
        
        function freeHealFromNPC(npcId) {
            if (state.char.hp >= state.char.maxHp) {
                notifyWarning('Pln칠 zdrav칤', 'Nepot콏ebuje코 l칠캜en칤!');
                return;
            }
            
            // Nastav cooldown pro konkr칠tn칤 NPC
            if (npcId === 'doc_harris') {
                state.lastFreeHealHarris = Date.now();
            } else if (npcId === 'koudy') {
                state.lastFreeHealKoudy = Date.now();
            }
            
            const oldHp = state.char.hp;
            state.char.hp = state.char.maxHp;
            const healed = state.char.maxHp - oldHp;
            
            const npcNames = {
                'doc_harris': 'Doktor Harris',
                'koudy': 'Koudy'
            };
            
            addLog(`仇벒잺 ${npcNames[npcId] || 'NPC'} t캩 vyl칠캜il (+${healed} HP)`, '游눜');
            notifySuccess('仇벒잺 Vyl칠캜en!', `+${healed} HP zdarma`);
            
            closeModal();
            showNPCDetail(npcId);
            renderFull();
        }
        
        function revealMapFromMaya() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('maya_map_reveal')) return;
            
            state.secrets.push('maya_map_reveal');
            
            // Odhal 10 n치hodn칳ch nenav코t칤ven칳ch lokac칤
            const unvisited = WORLD_LOCATIONS.filter(l => !state.world.visitedLocations?.includes(l.id));
            const toReveal = unvisited.slice(0, 10).map(l => l.id);
            if (!state.world.revealedLocations) state.world.revealedLocations = [];
            state.world.revealedLocations.push(...toReveal);
            
            showModal('游딬勇 Mapa odhalena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游딬勇</div>
                    <p>Maya ti uk치zala ${toReveal.length} tajn칳ch lokac칤 na map캩!</p>
                    <p style="color: #8bc34a;">Nyn칤 je vid칤코 i kdy jsi je nenav코t칤vil.</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('scout_maya');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function recruitMayaCompanion() {
            if (!state.companions) state.companions = [];
            if (state.companions.some(c => c.id === 'maya_companion' && !c.isDead)) return;
            
            const activeCompanions = state.companions.filter(c => !c.isDead).length;
            const maxCompanions = getMaxCompanions();
            if (activeCompanions >= maxCompanions) {
                notifyWarning('Pln칳 t칳m!', `M치코 ${activeCompanions}/${maxCompanions} companion콢`);
                return;
            }
            
            // Odstra켿 mrtvou Mayu pokud existuje
            state.companions = state.companions.filter(c => c.id !== 'maya_companion');
            
            state.companions.push({
                id: 'maya_companion',
                name: 'Maya',
                icon: '游끢꽥勇',
                type: 'scout',
                hp: 60,
                maxHp: 60,
                damage: 15,
                defense: 5,
                special: 'Odhaluje pasti a skryt칠 p콏edm캩ty'
            });
            
            showModal('游끢꽥勇 Maya se p콏idala!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游끢꽥勇</div>
                    <p style="color: #8bc34a; font-weight: bold;">Maya je nyn칤 tv콢j companion!</p>
                    <p style="color: #888;">+15 DMG v boji, odhaluje pasti</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('scout_maya');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Helper - z칤sk치 bonus k vylep코en칤 od kov치콏e osadn칤ka
        function getSettlerUpgradeBonus() {
            if (!state.settlement?.settlers) return 0;
            
            const blacksmith = state.settlement.settlers.find(s => s.type === 'blacksmith_s');
            if (!blacksmith) return 0;
            
            const skillData = SETTLER_SKILLS?.blacksmith;
            if (!skillData) return 0;
            
            const level = blacksmith.skillLevel || 1;
            const levelData = skillData.levels[level - 1];
            
            return levelData?.effect?.upgrade || 0;
        }
        
        function upgradeWeaponAtIvan() {
            if (!state.equipped?.weapon) {
                notifyWarning('콯치dn치 zbra켿!', 'Nem치코 vybavenou zbra켿 k vylep코en칤');
                return;
            }
            if ((state.resources?.metal || 0) < 50) {
                notifyWarning('M치lo kovu!', 'Pot콏ebuje코 50 丘뙖잺 kovu');
                return;
            }
            
            state.resources.metal -= 50;
            
            // Z치kladn칤 bonus + bonus od kov치콏e osadn칤ka
            let upgradeBonus = 5;
            const blacksmithBonus = getSettlerUpgradeBonus();
            upgradeBonus += blacksmithBonus;
            
            state.equipped.weapon.damage = (state.equipped.weapon.damage || 10) + upgradeBonus;
            state.equipped.weapon.name = state.equipped.weapon.name + ' +';
            
            showModal('游댣 Zbra켿 vylep코ena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">丘덢잺</div>
                    <p style="color: #8bc34a; font-weight: bold;">${state.equipped.weapon.name}</p>
                    <p>+${upgradeBonus} po코kozen칤!${blacksmithBonus > 0 ? ` <span style="color: #ffd700;">(+${blacksmithBonus} od kov치콏e)</span>` : ''}</p>
                    <p style="color: #ff9800;">Nov칠 DMG: ${state.equipped.weapon.damage}</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('blacksmith_ivan');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function upgradeArmorAtIvan() {
            if (!state.equipped?.armor) {
                notifyWarning('콯치dn치 zbroj!', 'Nem치코 vybavenou zbroj k vylep코en칤');
                return;
            }
            if ((state.resources?.metal || 0) < 50) {
                notifyWarning('M치lo kovu!', 'Pot콏ebuje코 50 丘뙖잺 kovu');
                return;
            }
            
            state.resources.metal -= 50;
            
            // Z치kladn칤 bonus + bonus od kov치콏e osadn칤ka
            let upgradeBonus = 5;
            const blacksmithBonus = getSettlerUpgradeBonus();
            upgradeBonus += blacksmithBonus;
            
            state.equipped.armor.defense = (state.equipped.armor.defense || 5) + upgradeBonus;
            state.equipped.armor.name = state.equipped.armor.name + ' +';
            
            showModal('游띠勇 Zbroj vylep코ena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游띠勇</div>
                    <p style="color: #8bc34a; font-weight: bold;">${state.equipped.armor.name}</p>
                    <p>+${upgradeBonus} obrana!${blacksmithBonus > 0 ? ` <span style="color: #ffd700;">(+${blacksmithBonus} od kov치콏e)</span>` : ''}</p>
                    <p style="color: #2196f3;">Nov칠 DEF: ${state.equipped.armor.defense}</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('blacksmith_ivan');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function craftLegendaryAtIvan() {
            // Kontrola skillu
            const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
            if (!hasLegendarySmith) {
                notifyWarning('Chyb칤 skill!', 'Pot콏ebuje코 skill "Legend치rn칤 kov치콏" z v캩tve 콎emeslo');
                return;
            }
            
            const cost = { metal: 100, scrap: 50, electronics: 20 };
            if ((state.resources?.metal || 0) < cost.metal || 
                (state.resources?.scrap || 0) < cost.scrap ||
                (state.resources?.electronics || 0) < cost.electronics) {
                notifyWarning('M치lo surovin!', `Pot콏ebuje코: ${cost.metal}丘뙖잺 ${cost.scrap}游댤 ${cost.electronics}游님`);
                return;
            }
            
            state.resources.metal -= cost.metal;
            state.resources.scrap -= cost.scrap;
            state.resources.electronics -= cost.electronics;
            
            const legendaryWeapon = {
                id: 'legendary_blade_' + Date.now(),
                name: '救 Ivan콢v Legend치rn칤 Me캜',
                icon: '游디勇',
                type: 'weapon',
                damage: 45,
                durability: 200,
                maxDurability: 200,
                rarity: 'legendary',
                desc: 'Mistrovsk칠 d칤lo kov치콏e Ivana'
            };
            
            state.inv.push(legendaryWeapon);
            
            showModal('救 LEGEND츼RN칈 ZBRA켾!', `
                <div style="text-align: center; background: linear-gradient(135deg, #2a2a0a, #1a1a0a); padding: 1rem; border-radius: 8px; border: 2px solid #ffd700;">
                    <div style="font-size: 3rem;">游디勇</div>
                    <p style="color: #ffd700; font-weight: bold; font-size: 1.2rem;">${legendaryWeapon.name}</p>
                    <p style="color: #ff9800;">丘덢잺 ${legendaryWeapon.damage} DMG</p>
                    <p style="color: #888;">Toto je skute캜n칠 mistrovsk칠 d칤lo!</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('blacksmith_ivan');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getProphecy() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('mysterious_prophecy')) return;
            
            state.secrets.push('mysterious_prophecy');
            
            const prophecies = [
                "Vid칤m... dv캩 cesty. Bratr proti bratrovi. Tv치 volba rozhodne osud sv캩ta.",
                "Hledej tam, kde slunce zapad치 do radioaktivn칤 mlhy. Najde코, co hled치코.",
                "D콢v캩ra je vz치cn캩j코칤 ne zlato. Buduj ji, a sv캩t se ti otev콏e.",
                "Projekt Genesis... m콢쬰 b칳t sp치sou, nebo zk치zou. Z치le쮂 na srdci toho, kdo ho ovl치dne."
            ];
            const prophecy = prophecies[Math.floor(Math.random() * prophecies.length)];
            
            showModal('游댩 Proroctv칤', `
                <div style="text-align: center; background: linear-gradient(135deg, #1a0a2a, #0a0a1a); padding: 1rem; border-radius: 8px; border: 1px solid #9c27b0;">
                    <div style="font-size: 3rem;">游댩</div>
                    <p style="color: #ce93d8; font-style: italic; font-size: 1.1rem;">"${prophecy}"</p>
                    <p style="color: #8bc34a; margin-top: 1rem;">九 Bonus: +10% XP ze v코ech zdroj콢!</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('mysterious_woman');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function revealSecretLocation() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('secret_location_revealed')) return;
            
            state.secrets.push('secret_location_revealed');
            
            // P콏idej tajnou lokaci do sv캩ta
            if (!state.world.revealedLocations) state.world.revealedLocations = [];
            state.world.revealedLocations.push('ancient_vault');
            
            showModal('游딓勇 Tajn치 lokace odhalena!', `
                <div style="text-align: center; background: linear-gradient(135deg, #1a0a2a, #0a0a1a); padding: 1rem; border-radius: 8px; border: 2px solid #ffd700;">
                    <div style="font-size: 3rem;">游끹勇</div>
                    <p style="color: #ffd700; font-weight: bold;">Starov캩k칳 trezor</p>
                    <p style="color: #888;">Z치hadn치 쬰na ti prozradila lokaci prad치vn칠ho trezoru pln칠ho poklad콢!</p>
                    <p style="color: #8bc34a; margin-top: 0.5rem;">游늸 Nov치 lokace p콏id치na na mapu!</p>
                    <p style="color: #ff9800; font-size: 0.85rem;">Nach치z칤 se v nebezpe캜n칠 z칩n캩 - bu캞 p콏ipraven!</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('mysterious_woman');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getFreeExplosives() {
            const lastFree = state.lastFreeExplosives || 0;
            if (Date.now() - lastFree < 24 * 60 * 60 * 1000) return;
            
            state.lastFreeExplosives = Date.now();
            
            // P콏idej v칳bu코niny
            const gunpowder = ITEMS.find(i => i.id === 'gunpowder');
            if (gunpowder) {
                const existing = state.inv.find(i => i.id === 'gunpowder');
                if (existing) {
                    existing.count = (existing.count || 1) + 5;
                } else {
                    state.inv.push({...gunpowder, count: 5});
                }
            }
            
            showModal('游눢 V칳bu코niny!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游눢</div>
                    <p style="color: #c62828; font-weight: bold;">Kory ti dal 5x st콏eln칳 prach!</p>
                    <p style="color: #888;">"Pou쬴j je moud콏e... nebo ne. Je mi to jedno."</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('kory');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // P칠콘a - drby
        function getGossipFromPeta() {
            const gossips = [
                "Sly코el jsem, 쬰 v opu코t캩n칠m skladi코ti na severu je ukryt칳 poklad...",
                "Obchodn칤k v Bu캜ovic칤ch m치 pr칳 tajnou z치sobu vz치cn칳ch zbran칤.",
                "V laborato콏i vid캩li n캩jak칠ho podivn칠ho mu쬰. Pr칳 tam n캩co hled치.",
                "N치jezdn칤ci pl치nuj칤 칰tok na karavanu p콏칤코t칤 t칳den.",
                "V jeskyni na v칳chod캩 쬴je mutant, kter칳 pr칳 mluv칤!",
                "만rif Kowalski m치 tajemstv칤. N캩co skr칳v치 ve sv칠m stole.",
                "Sly코el jsem, 쬰 z치hadn치 쬰na nen칤 to, za co se vyd치v치...",
                "V chemi캜ce je tajn치 m칤stnost. Kl칤캜 m치 pr칳 n캩kdo z v캩dc콢."
            ];
            const gossip = gossips[Math.floor(Math.random() * gossips.length)];
            
            showModal('游녝 Drby od P칠ti', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游녽</div>
                    <p style="color: #ff9800; font-style: italic;">"${gossip}"</p>
                    <p style="color: #888; font-size: 0.8rem;">P칠콘a se rozhl칠dne a zmiz칤.</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('kid_peta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        // P칠콘a - tajn치 cesta
        function learnSecretPath() {
            state.secretPathExpires = Date.now() + 24 * 60 * 60 * 1000; // 24 hodin
            
            showModal('游띣勇 Tajn치 cesta!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游띣勇</div>
                    <p style="color: #4caf50; font-weight: bold;">P칠콘a ti uk치zal tajn칠 zkratky!</p>
                    <p style="color: #888;">Cestov치n칤 je nyn칤 o 50% rychlej코칤.</p>
                    <p style="color: #ff9800;">낋 Plat칤 24 hodin</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('kid_peta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Marta - bylinky zdarma
        function getFreeHerbs() {
            const lastFree = state.lastFreeHerbs || 0;
            if (Date.now() - lastFree < 12 * 60 * 60 * 1000) return;
            
            state.lastFreeHerbs = Date.now();
            state.resources.herbs = (state.resources.herbs || 0) + 5;
            
            showModal('游 Bylinky!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游놋</div>
                    <p style="color: #4caf50; font-weight: bold;">Babi캜ka Marta ti dala 5x bylinky!</p>
                    <p style="color: #888;">"Tyhle ti pomohou, mil치캜ku. Vracuj se!"</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('grandma_marta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Marta - tajn칳 recept
        function learnSecretRecipe() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('marta_secret_recipe')) return;
            
            state.secrets.push('marta_secret_recipe');
            
            showModal('游닆 Tajn칳 recept!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游닆</div>
                    <p style="color: #8bc34a; font-weight: bold;">Nau캜il ses recept na Super Stimpak!</p>
                    <p style="color: #888;">Nyn칤 m콢쬰코 v d칤ln캩 vyr치b캩t Super Stimpaky levn캩ji.</p>
                    <p style="color: #4caf50;">-50% surovin na Super Stimpak</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('grandma_marta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Viktor - loveck칠 tipy
        function getHuntingTips() {
            if (!state.secrets) state.secrets = [];
            if (!state.secrets.includes('viktor_hunting_tips')) {
                state.secrets.push('viktor_hunting_tips');
            }
            
            showModal('游낓 Loveck칠 tipy!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游낓</div>
                    <p style="color: #795548; font-weight: bold;">Viktor ti dal loveck칠 tipy!</p>
                    <p style="color: #888;">"St콏칤lej do srdce, ne do hlavy. M칠n캩 pr치ce s k콢쮂."</p>
                    <p style="color: #4caf50;">+25% loot ze zv칤콏at (trval칠)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('hunter_viktor');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Viktor - vz치cn치 ko콏ist
        function goRareHunt() {
            const lastHunt = state.lastRareHunt || 0;
            if (Date.now() - lastHunt < 24 * 60 * 60 * 1000) return;
            
            state.lastRareHunt = Date.now();
            
            // Dej vz치cn칠 suroviny
            state.resources.leather = (state.resources.leather || 0) + 10;
            state.resources.fur = (state.resources.fur || 0) + 5;
            state.resources.raw_meat = (state.resources.raw_meat || 0) + 8;
            markFoodAsNew('raw_meat', 8);
            addMoney(150);
            addXP(100);
            
            showModal('游붋 Vz치cn치 ko콏ist!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游붋</div>
                    <p style="color: #ff5722; font-weight: bold;">칔sp캩코n칳 lov s Viktorem!</p>
                    <p style="color: #8bc34a;">Z칤skal jsi:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; margin: 1rem 0;">
                        <div>游붮 10x K콢쬰</div>
                        <div>游붉 5x Ko쬰코ina</div>
                        <div>游볼 8x Maso</div>
                        <div>游눯 150 pen캩z</div>
                    </div>
                    <p style="color: #2196f3;">+100 XP</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('hunter_viktor');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // === NOV칄 NPC FUNKCE ===
        
        function getMilitaryTraining() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('novak_military_training')) return;
            
            state.secrets.push('novak_military_training');
            state.char.bonusDamage = (state.char.bonusDamage || 0) + 5;
            
            showModal('游꿌勇 Vojensk칳 v칳cvik!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游꿌勇</div>
                    <p>Kapit치n Nov치k t캩 nau캜il bojov칠 techniky!</p>
                    <p style="color: #8bc34a; font-weight: bold;">+5 DMG permanentn캩</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('captain_novak');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function learnCernySecret() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('novak_cerny_secret');
            
            showModal('游 Tajemstv칤 o Veliteli 캛ern칠m', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游</div>
                </div>
                <p style="color: #ff9800;">"Velitel 캛ern칳... je m콢j bratr. P콏ed v치lkou byl voj치k jako j치."</p>
                <p style="margin-top: 0.5rem;">"V치lka ho zlomila. Vid캩l p콏칤li코 mnoho. Mysl칤 si, 쬰 jedin칳 zp콢sob jak p콏e쮂셦 je st치t se pred치torem."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Ale n캩kde hluboko... je st치le 캜lov캩k. V칤m to."</p>
                <p style="margin-top: 1rem; color: #8bc34a;">Tato informace m콢쬰 zm캩nit tv콢j pohled na n치jezdn칤ky...</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('captain_novak');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function repairAtPepa() {
            const weapon = state.equipped?.weapon;
            const armor = state.equipped?.armor;
            
            if (!weapon && !armor) {
                notifyWarning('Nic k oprav캩', 'Nem치코 vybaven칠 vybaven칤');
                return;
            }
            
            // Master repair = zdarma, jinak 50% sleva
            const isMaster = state.secrets?.includes('pepa_master_repair');
            const metalCost = isMaster ? 0 : 10;
            
            if (!isMaster && (state.resources?.metal || 0) < metalCost) {
                notifyWarning('M치lo kovu', 'Pot콏ebuje코 10丘뙖잺');
                return;
            }
            
            if (!isMaster) state.resources.metal -= metalCost;
            if (weapon) { weapon.durability = weapon.maxDurability || 100; }
            if (armor) { armor.durability = armor.maxDurability || 100; }
            
            notifySuccess('Opraveno!', isMaster ? 'Pepa opravil tv칠 vybaven칤 zdarma!' : 'Pepa opravil tv칠 vybaven칤 za polovi캜n칤 cenu');
            showNPCDetail('mechanic_pepa');
        }
        
        function getMasterRepair() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('pepa_master_repair');
            
            showModal('游댢 Mistrovsk칠 opravy!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">游댢</div>
                    <p style="color: #ff9800; font-weight: bold;">Pepa t캩 nau캜il mistrovsk칠 opravy!</p>
                    <p style="color: #8bc34a;">Opravy vybaven칤 jsou nyn칤 ZDARMA</p>
                    <p style="color: #888; font-size: 0.85rem;">(St치le pot콏ebuje코 b칳t u Pepy)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('mechanic_pepa');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getBlessing() {
            state.lastBlessing = Date.now();
            state.blessingActive = Date.now() + 24 * 60 * 60 * 1000; // 24h
            
            showModal('久 Po쬰hn치n칤!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">久</div>
                    <p>Sestra Anna ti po쬰hnala.</p>
                    <p style="color: #9c27b0; font-weight: bold;">+20% 코ance p콏e쮂셦 smrteln칳 칰tok (24h)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sister_anna');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function getHolyRelic() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('anna_holy_relic');
            
            const relic = {
                id: 'holy_relic',
                name: 'Svat치 relikvie',
                icon: '九뢢잺',
                type: 'accessory',
                defense: 5,
                special: 'holy',
                desc: '+10% XP, +5 DEF, imunita na proklet칤',
                rarity: 'legendary'
            };
            state.inv.push(relic);
            
            showModal('九뢢잺 Svat치 relikvie!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">九뢢잺</div>
                    <p style="color: #ffd700; font-weight: bold;">Z칤skal jsi Svatou relikvii!</p>
                    <p style="color: #8bc34a;">+10% XP, +5 DEF, imunita na proklet칤</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sister_anna');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function openBlackMarket() {
            const rareItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic').slice(0, 5);
            
            let html = '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            rareItems.forEach(item => {
                // 캛ern칳 trh: z치kladn칤 cena + 50% p콏ir치쬶a
                const basePrice = calculateItemPrice(item.price);
                const price = Math.floor(basePrice * 1.5);
                html += `<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <div>${item.icon} ${item.name}</div>
                    <button class="btn" onclick="buyBlackMarketItem('${item.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">游눯${price}</button>
                </div>`;
            });
            html += '</div>';
            
            showModal('游꿠 캛ern칳 trh', html + `<button class="btn" onclick="showNPCDetail('smuggler_radek')" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${'Zp캩t'}</button>`);
        }
        
        function buyBlackMarketItem(itemId) {
            const item = ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // 캛ern칳 trh: z치kladn칤 cena + 50% p콏ir치쬶a
            const basePrice = calculateItemPrice(item.price);
            const price = Math.floor(basePrice * 1.5);
            
            if (getMoney() < price) {
                notifyWarning('M치lo pen캩z', 'Pot콏ebuje코 ' + price + '游눯');
                return;
            }
            
            removeMoney(price);
            state.inv.push({...item, count: 1, durability: 100, maxDurability: 100});
            notifySuccess('Koupeno!', item.name);
            openBlackMarket();
        }
        
        function learnBigSecret() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('radek_big_secret');
            
            showModal('游돗勇 Velk칠 tajemstv칤', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游돗勇</div>
                </div>
                <p style="color: #ff9800;">"Poslouchej dob콏e. 콎칤k치m ti to jen jednou."</p>
                <p style="margin-top: 0.5rem;">"Kory a Koudy... nejsou jen brat콏i. Jsou sou캜치st칤 v캩t코칤ho pl치nu."</p>
                <p style="margin-top: 0.5rem;">"P콏ed v치lkou pracovali pro vl치du. Projekt O캜ista. A te캞... jeden chce sv캩t zni캜it, druh칳 zachr치nit."</p>
                <p style="margin-top: 0.5rem; color: #c62828;">"Ale oba l쬺u. Pravda je mnohem hor코칤."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('smuggler_radek');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function adoptOrphan() {
            if (!state.companions) state.companions = [];
            
            const activeCompanions = state.companions.filter(c => !c.isDead).length;
            const maxCompanions = getMaxCompanions();
            if (activeCompanions >= maxCompanions) {
                notifyWarning('Pln칳 t칳m!', `M치코 ${activeCompanions}/${maxCompanions} companion콢`);
                return;
            }
            
            state.companions.push({
                id: 'orphan_companion',
                name: 'Tom칤k',
                icon: '游녽',
                type: 'helper',
                hp: 30,
                maxHp: 30,
                damage: 5,
                defense: 2,
                special: 'Najde skryt칠 p콏edm캩ty, +10% loot'
            });
            
            showModal('游녽 Sirotek adoptov치n!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游녽</div>
                    <p style="color: #e91e63; font-weight: bold;">Tom칤k se p콏idal k tob캩!</p>
                    <p style="color: #888;">Najde skryt칠 p콏edm캩ty, +10% loot</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('teacher_vera');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getJirkaWarning() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jirka_warning');
            
            showModal('丘멆잺 Jirkovo varov치n칤', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游뱕</div>
                </div>
                <p style="color: #ff5722;">"Poslouchej! POSLOUCHEJ! Oni m캩 maj칤 za bl치zna ale j치 V칈M!"</p>
                <p style="margin-top: 0.5rem;">"Kory... vid캩l jsem co d캩l치 v noci. V t칠 star칠 tov치rn캩. Experimenty..."</p>
                <p style="margin-top: 0.5rem; color: #888;">*t콏ese se*</p>
                <p style="margin-top: 0.5rem;">"Lid칠 tam chod칤 dovnit콏... ale ven vych치z칤 n캩co jin칠ho."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('crazy_jirka');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnKoryTruth() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jirka_kory_truth');
            
            showModal('游 PRAVDA O KORYM', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游</div>
                </div>
                <p style="color: #c62828; font-weight: bold;">"PRAVDA. Kone캜n캩 n캩kdo, kdo chce sly코et PRAVDU!"</p>
                <p style="margin-top: 0.5rem;">"Kory nechce jen zni캜it star칳 sv캩t. On ho chce P콎ED캨LAT."</p>
                <p style="margin-top: 0.5rem;">"Ti jeho 'vyvolen칤'? To jsou pokusn칤 kr치l칤ci. Transformuje je. N캩co mezi 캜lov캩kem a... n캩캜칤m jin칳m."</p>
                <p style="margin-top: 0.5rem; color: #9c27b0;">"A Koudy? Ten to v칤. A NI캛EMU nezabr치n칤. Proto쬰 pot콏ebuje data pro sv콢j 'l칠k'."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Oba jsou monstra. Jen r콢zn칠ho druhu."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('crazy_jirka');" style="width: 100%; margin-top: 1rem;">To je... 코칤len칠</button>
            `);
        }
        
        function learnHistory() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('tomas_history');
            addXP(50);
            
            showModal('游닆 Historie kraje', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游븹</div>
                </div>
                <p>"P콏ed v치lkou tu bylo kr치sn캩. Pamatuji si ka쬯칳 strom, ka쬯ou cestu."</p>
                <p style="margin-top: 0.5rem;">"Ale v치lka... v치lka zm캩nila v코echno. A n캩kte콏칤 lid칠 se zm캩nili v칤c ne jin칤."</p>
                <p style="margin-top: 0.5rem;">"Ta 쬰na, kter칠 콏칤k치te Z치hadn치? Zn치m ji. Zn치m ji velmi dob콏e."</p>
                <p style="margin-top: 0.5rem; color: #888;">*v칳znamn캩 se odml캜칤*</p>
                <p style="color: #2196f3;">+50 XP za znalosti</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('elder_tomas');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnWomanTruth() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('tomas_woman_truth');
            
            showModal('游댩 Pravda o Z치hadn칠 쬰n캩', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游댩</div>
                </div>
                <p style="color: #9c27b0;">"Jej칤 prav칠 jm칠no je Elena. Dr. Elena Voronova."</p>
                <p style="margin-top: 0.5rem;">"P콏ed v치lkou vedla Projekt Or치kulum - v칳zkum p콏edv칤d치n칤 budoucnosti pomoc칤 radiace."</p>
                <p style="margin-top: 0.5rem;">"Experiment selhal... nebo usp캩l? Z치le쮂 jak se na to d칤v치코."</p>
                <p style="margin-top: 0.5rem; color: #ff9800;">"Te캞 opravdu vid칤 budoucnost. Ale za stra코nou cenu."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Rosa? Ta jen l쬰 aby z칤skala moc. Elena mluv칤 pravdu - proto ji v코ichni nen치vid칤."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('elder_tomas');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function getTechUpgrade() {
            if ((state.resources?.electronics || 0) < 10) {
                notifyWarning('M치lo elektroniky', 'Pot콏ebuje코 10 elektroniky');
                return;
            }
            
            if (!state.equipped?.armor) {
                notifyWarning('콯치dn칠 brn캩n칤', 'Nem치코 vybaven칠 brn캩n칤 k vylep코en칤');
                return;
            }
            
            state.resources.electronics -= 10;
            
            // Z치kladn칤 bonus + bonus od kov치콏e osadn칤ka
            let upgradeBonus = 10;
            const blacksmithBonus = getSettlerUpgradeBonus();
            upgradeBonus += blacksmithBonus;
            
            state.equipped.armor.defense = (state.equipped.armor.defense || 0) + upgradeBonus;
            state.equipped.armor.name = state.equipped.armor.name + ' [TECH]';
            
            const bonusText = blacksmithBonus > 0 ? ` (+${blacksmithBonus} od kov치콏e)` : '';
            notifySuccess('Vylep코eno!', `Kl치ra vylep코ila tv칠 brn캩n칤: +${upgradeBonus} DEF${bonusText}`);
            showNPCDetail('engineer_klara');
        }
        
        function getKoudyEvidence() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('klara_koudy_evidence');
            
            const evidence = {
                id: 'koudy_evidence',
                name: 'D콢kazy proti Koudymu',
                icon: '游늶',
                type: 'quest_item',
                desc: 'Dokumenty o Koudyho experimentech'
            };
            state.inv.push(evidence);
            
            showModal('游늶 D콢kazy z칤sk치ny!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游늶</div>
                </div>
                <p style="color: #f44336;">"Tady to m치코. V코echno co pot콏ebuje코 v캩d캩t."</p>
                <p style="margin-top: 0.5rem;">"Koudy testuje sv콢j 'l칠k' na lidech. Na 쬴v칳ch lidech."</p>
                <p style="margin-top: 0.5rem;">"V캩t코ina... nep콏e쬴je. A ti co p콏e쬴j칤?"</p>
                <p style="margin-top: 0.5rem; color: #888;">*zavrt칤 hlavou*</p>
                <p style="margin-top: 0.5rem; color: #9c27b0;">"Lep코칤 by bylo kdyby nep콏e쬴li."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('engineer_klara');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function makeTruce() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('cerny_truce');
            
            showModal('游뱋 P콏칤m캩콏칤 uzav콏eno', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游뱋</div>
                </div>
                <p style="color: #607d8b;">"Tak jo. M치코 moje slovo."</p>
                <p style="margin-top: 0.5rem;">"Moji mu쬴 na tebe neza칰to캜칤. Dokud dodr쮂솬 svou 캜치st."</p>
                <p style="margin-top: 0.5rem; color: #8bc34a;">N치jezdn칤ci t캩 nyn칤 ignoruj칤!</p>
                <p style="margin-top: 0.5rem; color: #888; font-size: 0.85rem;">(마nce na p콏epaden칤 n치jezdn칤ky sn칤쬰na o 90%)</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('commander_cerny');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnWarTruth() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('cerny_war_truth');
            
            showModal('游 Pravda o v치lce', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游</div>
                </div>
                <p style="color: #263238;">"Chce코 v캩d캩t pro캜 jsem se stal t칤m, 캜칤m jsem?"</p>
                <p style="margin-top: 0.5rem;">"Proto쬰 jsem vid캩l pravdu. V치lka... nebyla n치hoda."</p>
                <p style="margin-top: 0.5rem;">"Byla pl치novan치. P콏esn캩 pl치novan치. A ti, kdo ji spustili?"</p>
                <p style="margin-top: 0.5rem; color: #c62828;">"Jsou st치le na쬴vu. A st치le tahaj칤 za nitky."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Kory a Koudy jsou jen loutky. Jako my v코ichni."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('commander_cerny');" style="width: 100%; margin-top: 1rem;">Kdo za t칤m stoj칤?</button>
            `);
        }
        
        function getFortune() {
            // Kontrola cooldownu
            const lastFortune = state.lastFortune || 0;
            if (Date.now() - lastFortune < 12 * 60 * 60 * 1000) {
                const hoursLeft = Math.ceil((12 * 60 * 60 * 1000 - (Date.now() - lastFortune)) / 3600000);
                notifyWarning('V캩코tba nen칤 p콏ipravena', `Zkus to za ${hoursLeft} hodin`);
                return;
            }
            
            state.lastFortune = Date.now();
            saveGame(); // Ulo ihned
            
            const fortunes = [
                { text: 'Vid칤m cestu plnou zlata...', effect: () => { addMoney(100); return '+100游눯'; } },
                { text: 'Tv치 s칤la vzroste...', effect: () => { state.char.bonusDamage = (state.char.bonusDamage || 0) + 3; return '+3 DMG (24h)'; } },
                { text: '맚캩st캩na ti p콏eje...', effect: () => { state.fortuneBonus = Date.now() + 24*60*60*1000; return '+25% loot (24h)'; } },
                { text: 'Uzdraven칤 p콏ich치z칤...', effect: () => { state.char.hp = state.char.maxHp; return 'Pln칠 HP'; } },
                { text: 'Energie t캩 napl켿uje...', effect: () => { state.status.energy = 100; return 'Pln치 energie'; } }
            ];
            
            const fortune = fortunes[Math.floor(Math.random() * fortunes.length)];
            const result = fortune.effect();
            
            showModal('游 V캩코tba', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游</div>
                    <p style="color: #9c27b0; font-style: italic;">"${fortune.text}"</p>
                    <p style="color: #8bc34a; font-weight: bold; margin-top: 1rem;">${result}</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('fortune_rosa');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function hearWomanLie() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('rosa_woman_lie');
            
            showModal('游꿠 "Pravda" o Z치hadn칠 쬰n캩', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游</div>
                </div>
                <p style="color: #e91e63;">"Ta 쬰na? Chce코 v캩d캩t kdo opravdu je?"</p>
                <p style="margin-top: 0.5rem;">"Je to podvodnice! Jej칤 'vize' jsou l쬴!"</p>
                <p style="margin-top: 0.5rem;">"P콏ed v치lkou kradla. Lhala. Ni캜ila 쬴voty."</p>
                <p style="margin-top: 0.5rem; color: #888;">*naklon칤 se bl칤*</p>
                <p style="margin-top: 0.5rem; color: #c62828;">"A te캞 manipuluje v코echny kolem. Nev캩콏 j칤. NIKOMU nev캩콏!"</p>
                <p style="margin-top: 1rem; color: #ff9800; font-size: 0.85rem;">Pozn치mka: Toto m콢쬰 b칳t le z rivality...</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('fortune_rosa');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function accessEvidence() {
            const clues = [
                '游댌 Stopy vedou k opu코t캩n칠 tov치rn캩 na severu',
                '游댌 Sv캩dek vid캩l podez콏elou postavu v noci',
                '游댌 Nalezena krev u star칠ho mostu',
                '游댌 Z치hadn칠 symboly na zdech kostela'
            ];
            const clue = clues[Math.floor(Math.random() * clues.length)];
            
            showModal('游늶 D콢kazy', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游늶</div>
                    <p>만rif ti uk치zal slo쬶u s d콢kazy.</p>
                    <p style="color: #3f51b5; margin-top: 1rem;">${clue}</p>
                    <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">Tato informace ti m콢쬰 pomoct s questy.</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sheriff_kowalski');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function becomeDeputy() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('kowalski_deputy');
            
            const badge = {
                id: 'deputy_badge',
                name: 'Odznak z치stupce',
                icon: '游꿌勇',
                type: 'accessory',
                defense: 3,
                special: 'authority',
                desc: 'NPC t캩 respektuj칤, +10% reputace'
            };
            state.inv.push(badge);
            
            showModal('游꿌勇 Z치stupce 코erifa!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游꿌勇</div>
                    <p style="color: #ffd700; font-weight: bold;">Jsi nyn칤 z치stupce 코erifa!</p>
                    <p>Z칤skal jsi Odznak z치stupce</p>
                    <p style="color: #8bc34a;">NPC t캩 respektuj칤, +10% reputace</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sheriff_kowalski');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function learnFastRoutes() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jin_fast_routes');
            
            showModal('游끢 Rychl칠 cesty!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游끢</div>
                    <p>Jin ti uk치zal efektivn캩j코칤 cesty!</p>
                    <p style="color: #00bcd4; font-weight: bold;">-5% 캜as cestov치n칤 permanentn캩</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('messenger_jin');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnSecretShortcuts() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jin_secret_shortcuts');
            
            showModal('游딬勇 Tajn칠 zkratky!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">游딬勇</div>
                    <p>Jin ti odhalil v코echny tajn칠 zkratky!</p>
                    <p style="color: #4caf50; font-weight: bold;">-10% 캜as cestov치n칤 permanentn캩</p>
                    <p style="color: #888; font-size: 0.85rem;">(Kombinuje se s rychl칳mi cestami)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('messenger_jin');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function talkToFriendlyNPC(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) return;
            
            // === KONTROLA LOKACE ===
            // Hr치캜 mus칤 b칳t na stejn칠 lokaci jako NPC
            const currentLocation = state.world?.currentLocation;
            if (currentLocation !== npc.location) {
                showModal('游늸 P콏칤li코 daleko', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游뛂</div>
                        <p>${npc.name} nen칤 pobl칤.</p>
                        <p style="color: #888; font-size: 0.85rem;">Mus칤코 b칳t v lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</strong> abys mohl mluvit.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            state.npcRelations = state.npcRelations || {};
            
            // Nomad set bonus - automaticky +30 d콢v캩ry u nov칳ch NPC
            const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            const npcTrustBonus = setFx.npcTrust || 0;
            
            if (!state.npcRelations[npcId]) {
                state.npcRelations[npcId] = { trust: npcTrustBonus, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
                if (npcTrustBonus > 0) {
                    addLog(`游끺勇 Nom치d set: +${npcTrustBonus} po캜치te캜n칤 d콢v캩ra u ${npc?.name || npcId}!`, '救');
                }
            }
            
            const relation = state.npcRelations[npcId];
            const dialogues = NPC_DIALOGUES[npcId];
            
            // Bonus za mluven칤 max jednou za 24 hodin (jednou denn캩)
            const now = Date.now();
            const hoursSinceLastTalk = (now - (relation.lastTalk || 0)) / (1000 * 60 * 60);
            let trustGain = 0;
            
            if (hoursSinceLastTalk >= 24) {
                trustGain = 2;
                relation.trust = Math.min(100, relation.trust + trustGain);
                relation.lastTalk = now;
            }
            
            // === TALK QUEST PROGRESS ===
            // Pokud m치 hr치캜 quest typu "talk" od tohoto NPC, spl켿 ho
            if (state.npcQuests && state.npcQuests[npcId]) {
                const quest = state.npcQuests[npcId];
                if (quest.id) {
                    const questDef = NPC_QUESTS[quest.id];
                    if (questDef?.requirement?.talk) {
                        if (!quest.progress) quest.progress = {};
                        if (!quest.progress.talked) {
                            quest.progress.talked = true;
                            console.log(`游눫 Talk quest ${quest.id} spln캩n - promluva s ${npcId}`);
                            notifySuccess('Quest spln캩n!', `Dokon캜il jsi rozhovor s ${npc.name}`);
                        }
                    }
                }
            }
            
            // Vyber pozdrav podle d콢v캩ry
            let greeting = '';
            if (dialogues?.greeting) {
                const greetings = relation.trust >= 70 ? dialogues.greeting.high :
                                  relation.trust >= 30 ? dialogues.greeting.medium :
                                  dialogues.greeting.low;
                greeting = greetings[Math.floor(Math.random() * greetings.length)];
            } else {
                greeting = `"Zdrav칤m t캩, poutn칤ku."`;
            }
            
            // Vygeneruj t칠mata k rozhovoru
            let topicsHtml = '';
            if (dialogues?.topics) {
                topicsHtml = '<h4 style="margin: 0.5rem 0; color: #888;">Na co se zept치코?</h4>';
                topicsHtml += '<div style="display: grid; gap: 0.4rem;">';
                
                const topicNames = {
                    'about_self': '游녻 O sob캩',
                    'about_radek': '游꿠 O Radkovi',
                    'about_kory': '游붳 O Korym',
                    'about_koudy': '游녿꽳릢 O Koudym',
                    'about_harris': '游녿꽥뚯勇 O doktorovi',
                    'about_marta': '游놋 O Mart캩',
                    'about_vera': '游닄 O V캩콏e',
                    'about_daughter': '游녾 O dce콏i',
                    'about_ivan': '游댣 O Ivanovi',
                    'about_cerny': '游 O 캛ern칠m',
                    'about_novak': '游꿌勇 O Nov치kovi',
                    'about_viktor': '游낓 O Viktorovi',
                    'about_jirka': '游뱕 O Jirkovi',
                    'about_rosa': '游 O Rose',
                    'about_tomas': '游븹 O Tom치코ovi',
                    'what_he_saw': '游녜勇 Co jsi vid캩l?',
                    'why_raider': '仇 Pro캜 n치jezdn칤k?',
                    'secret': '游댏 Tajemstv칤'
                };
                
                for (const [topicId, topic] of Object.entries(dialogues.topics)) {
                    const canAsk = relation.trust >= topic.trustRequired;
                    const alreadyAsked = relation.talkedTopics?.includes(`${npcId}_${topicId}`);
                    
                    if (canAsk) {
                        topicsHtml += `<button class="btn" onclick="askNPCTopic('${npcId}', '${topicId}')" 
                            style="text-align: left; padding: 0.5rem; ${alreadyAsked ? 'opacity: 0.7;' : ''}">
                            ${topicNames[topicId] || topicId} ${alreadyAsked ? '九' : ''}
                        </button>`;
                    } else {
                        topicsHtml += `<button class="btn" disabled 
                            style="text-align: left; padding: 0.5rem; opacity: 0.4;">
                            游 ${topicNames[topicId] || topicId} (${topic.trustRequired} d콢v캩ry)
                        </button>`;
                    }
                }
                topicsHtml += '</div>';
            }
            
            // Zm칤nky o jin칳ch NPC
            let mentionsHtml = '';
            if (dialogues?.mentions && Object.keys(dialogues.mentions).length > 0) {
                const mentionedNpc = Object.keys(dialogues.mentions)[Math.floor(Math.random() * Object.keys(dialogues.mentions).length)];
                const mention = dialogues.mentions[mentionedNpc];
                const mentionedNpcData = FRIENDLY_NPCS.find(n => n.id === mentionedNpc);
                if (mentionedNpcData && Math.random() > 0.5) {
                    mentionsHtml = `
                        <div style="background: #1a1a2a; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0; border-left: 3px solid #9c27b0;">
                            <span style="color: #888; font-size: 0.85rem;">游눫 O ${mentionedNpcData.name}:</span>
                            <p style="margin: 0.2rem 0 0 0; font-style: italic;">"${mention}"</p>
                        </div>
                    `;
                }
            }
            
            showModal(`游눫 ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${npc.icon}</div>
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--rust);">
                        <p style="font-style: italic; color: #ddd; margin: 0;">${greeting}</p>
                    </div>
                    ${trustGain > 0 ? `<p style="color: #8bc34a; margin-top: 0.5rem; font-size: 0.85rem;">仇벒잺 +${trustGain} d콢v캩ry</p>` : ''}
                </div>
                
                ${mentionsHtml}
                
                ${topicsHtml}
                
                <div style="display: grid; gap: 0.4rem; margin-top: 1rem;">
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="background: #555;">
                         Zp캩t na profil
                    </button>
                </div>
            `);
        }
        
        function askNPCTopic(npcId, topicId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            const dialogues = NPC_DIALOGUES[npcId];
            const topic = dialogues?.topics?.[topicId];
            
            if (!npc || !topic) return;
            
            state.npcRelations = state.npcRelations || {};
            state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
            
            const relation = state.npcRelations[npcId];
            
            // Ozna캜 t칠ma jako probran칠
            if (!relation.talkedTopics) relation.talkedTopics = [];
            if (!relation.talkedTopics.includes(`${npcId}_${topicId}`)) {
                relation.talkedTopics.push(`${npcId}_${topicId}`);
                // Bonus XP za nov칠 t칠ma
                addXP(10);
            }
            
            // Vyber n치hodnou odpov캩캞 z t칠matu
            const response = topic.lines[Math.floor(Math.random() * topic.lines.length)];
            
            // Speci치ln칤 efekty pro tajemstv칤
            let specialEffect = '';
            if (topicId === 'secret') {
                specialEffect = `
                    <div style="background: linear-gradient(135deg, #2a1a2a, #1a2a2a); padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #9c27b0;">
                        <p style="color: #ffd700; font-weight: bold; margin: 0;">游댏 Odhaleno tajemstv칤!</p>
                        <p style="color: #888; font-size: 0.85rem; margin: 0.3rem 0 0 0;">Tato informace m콢쬰 zm캩nit v코e...</p>
                    </div>
                `;
                // P콏idej do den칤ku
                if (!state.discoveredSecrets) state.discoveredSecrets = [];
                if (!state.discoveredSecrets.includes(`${npcId}_secret`)) {
                    state.discoveredSecrets.push(`${npcId}_secret`);
                    addXP(50);
                }
            }
            
            // Mo쬹ost pokra캜ovat v rozhovoru
            let continueOptions = '<div style="display: grid; gap: 0.4rem; margin-top: 1rem;">';
            
            // Najdi souvisej칤c칤 NPC ze zm칤nky
            if (dialogues?.mentions) {
                const relatedNpcs = Object.keys(dialogues.mentions).slice(0, 2);
                relatedNpcs.forEach(relNpcId => {
                    const relNpc = FRIENDLY_NPCS.find(n => n.id === relNpcId);
                    if (relNpc) {
                        continueOptions += `
                            <button class="btn" onclick="talkToFriendlyNPC('${npcId}')" style="background: #3949AB;">
                                游눫 "Pov캩z mi v칤c o ${relNpc.name}..."
                            </button>
                        `;
                    }
                });
            }
            
            continueOptions += `
                <button class="btn" onclick="talkToFriendlyNPC('${npcId}')" style="background: var(--toxic-dark);">
                    游눫 Zeptat se na n캩co jin칠ho
                </button>
                <button class="btn" onclick="showNPCDetail('${npcId}')" style="background: #555;">
                     Zp캩t na profil
                </button>
            </div>`;
            
            showModal(`游눫 ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${npc.icon}</div>
                </div>
                
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--rust);">
                    <p style="font-style: italic; color: #ddd; margin: 0; line-height: 1.6;">${response}</p>
                </div>
                
                ${specialEffect}
                
                <p style="color: #8bc34a; margin-top: 0.5rem; font-size: 0.85rem; text-align: center;">九 +10 XP</p>
                
                ${continueOptions}
            `);
            
            renderFull();
        }
        
        // === REAKCE NA KORYHO A KOUDYHO ===
        function respondToKory(response) {
            state.npcRelations = state.npcRelations || {};
            state.npcRelations['kory'] = state.npcRelations['kory'] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
            
            let text = '';
            let trustChange = 0;
            
            switch(response) {
                case 'interested':
                    text = `*Kory se usm캩je - poprv칠 up콏칤mn캩*
                    
"Kone캜n캩 n캩kdo, kdo chce SLYET ne soudit."

"M콢j otec vytvo콏il AURORU. Vakc칤nu, kter치 m캩la zachr치nit sv캩t. M칤sto toho ho zm캩nila. J치 jsem jen... urychlil nevyhnuteln칠."

"Star칳 sv캩t um칤ral. Pomalu, bolestiv캩. J치 mu dal rychlou smrt. A z popela..."

*uk치쬰 na osadu kolem*

"...povst치v치 n캩co nov칠ho. Siln캩j코칤ho. Lid칠, kte콏칤 p콏e쬴li, jsou ti NEJLEP먞 z n치s."

"Chce코 se p콏idat? M콢쬿 ti uk치zat cestu k opravdov칠 s칤le."`;
                    trustChange = 10;
                    break;
                case 'suspicious':
                    text = `*Kory p콏ik칳vne s respektem*
                    
"Dobr치 ot치zka. Pro캜 by m캩l KDOKOLI v캩콏it 캜lov캩ku, kter칠ho obvi켿uj칤 z konce sv캩ta?"

"Nem치m pro tebe odpov캩캞. Jen fakta."

"Pod칤vej se kolem sebe. Vid칤코 ty lidi? Ti siln칤 p콏e쬴li. Ti slab칤 ne. To nen칤 krutost - to je P콎칈RODA."

"M콢j bratr Koudy chce vr치tit star칳 sv캩t. Sv캩t, kter칳 n치s pomalu zab칤jel. J치 chci postavit nov칳."

"V캩콏 si 캜emu chce코. Ale a uvid칤코, co Koudy opravdu d캩l치 ve sv칠 laborato콏i... mo쬹치 zm캩n칤코 n치zor."`;
                    trustChange = 5;
                    break;
                case 'hostile':
                    text = `*Koryho o캜i ztvrdnou, ale hlas z콢stane klidn칳*
                    
"Masov칳 vrah. Ano. Sly코el jsem to mnohokr치t."

"V칤코, kolik lid칤 zem콏elo kv콢li STAR칄MU sv캩tu? V치lky. Hlad. Nemoci. Miliardy za stalet칤."

"J치 jsem to ukon캜il. Rychle. Milosrdn캩."

*naklon칤 se bl칤*

"Ale jestli chce코 n캩koho vinit... zeptej se m칠ho bratra, pro캜 neud캩lal NIC, kdy v캩d캩l co se chyst치. Zeptej se, co OPRAVDU d캩l치 v t칠 jeho laborato콏i."

"Vra콘 se, a bude코 p콏ipraven poslouchat. Zat칤m..."

*m치vne rukou na odchod*`;
                    trustChange = -5;
                    break;
            }
            
            state.npcRelations['kory'].trust = Math.max(0, Math.min(100, state.npcRelations['kory'].trust + trustChange));
            
            showModal('游붳 Kory', `
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #9c27b0; white-space: pre-line; line-height: 1.6;">
                    <p style="color: #ddd;">${text}</p>
                </div>
                <p style="color: ${trustChange >= 0 ? '#8bc34a' : '#c62828'}; text-align: center;">
                    仇벒잺 ${trustChange >= 0 ? '+' : ''}${trustChange} d콢v캩ry s Korym
                </p>
                <button class="btn" onclick="showNPCDetail('kory')" style="width: 100%; margin-top: 1rem;">${'Pokra캜ovat'}</button>
            `);
            renderFull();
        }
        
        function respondToKoudy(response) {
            state.npcRelations = state.npcRelations || {};
            state.npcRelations['koudy'] = state.npcRelations['koudy'] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
            
            let text = '';
            let trustChange = 0;
            
            switch(response) {
                case 'helpful':
                    text = `*Koudyho unaven칠 o캜i se rozz치콏칤 nad캩j칤*
                    
"Opravdu? Ty... chce코 pomoct?"

*ot콏e si ruce do pl치코t캩*

"Pracuji na zp콢sobu, jak pou쮂셦 Genesis k OBNOV캨. Vy캜istit radiaci. Stabilizovat mutace. D치t tomuhle sv캩tu druhou 코anci."

"Ale pot콏ebuji komponenty. Jsou rozpt칳len칠 po cel칠m kraji. Nebezpe캜n치 m칤sta. Nebezpe캜n칤 lid칠."

"A m콢j bratr..." *povzdech* "...Kory hled치 tot칠. Ale on chce Genesis pou쮂셦 k... o캜ist캩. Zab칤t v코echny, kdo nejsou 'dostate캜n캩 siln칤'."

"Pomoz mi ho zastavit. Pomoz mi zachr치nit, co zbylo."`;
                    trustChange = 10;
                    break;
                case 'curious':
                    text = `*Koudy p콏ik칳vne a uk치쬰 na sch칠mata na st캩n캩*
                    
"Genesis. Projekt m칠ho bratra. Geni치ln칤 a d캩siv칳 z치rove켿."

"V podstat캩 je to planet치rn칤 transform치tor. Dok치쬰 p콏epsat... v코echno. DNA, ekosyst칠my, radiaci."

"M치 dv캩 konfigurace. OBNOVA - vy캜ist칤 sv캩t, d치 n치m 코anci za캜칤t znovu. A O캛ISTA - zabije v코echno krom캩 t캩ch s 'kompatibiln칤 genetikou'."

"Kory v캩콏칤, 쬰 o캜ista je jedin치 cesta. 콯e slab칤 mus칤 zem콏칤t, aby siln칤 mohli 쮂셦."

*t콏ese se mu hlas*

"J치 v캩콏칤m... MUS칈M v캩콏it... 쬰 existuje jin치 cesta. 콯e m콢쬰me b칳t lep코칤 ne on."`;
                    trustChange = 5;
                    break;
                case 'blame':
                    text = `*Koudy sklop칤 hlavu. Ticho trv치 dlouho.*
                    
"Ano."

"Ano, zni캜il jsem sv캩t. J치 a m콢j bratr. A n치코 otec."

"AURORA byla na코e. Genesis byl n치코. A kdy jsem vid캩l, co Kory pl치nuje..."

*hlas se zlom칤*

"...neud캩lal jsem DOST. Mohl jsem ho zastavit. Mohl jsem v코echno zve콏ejnit. M칤sto toho jsem doufal, 쬰 se m칳l칤m."

"Tak쬰 ano. Vi켿 m캩. Zaslou쮂셠 si to."

*zvedne hlavu*

"Ale te캞 se sna쮂셠 to napravit. To je v코echno, co m콢쬿 d캩lat."`;
                    trustChange = 5;
                    break;
            }
            
            state.npcRelations['koudy'].trust = Math.max(0, Math.min(100, state.npcRelations['koudy'].trust + trustChange));
            
            showModal('游녿꽳릢 Koudy', `
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #4caf50; white-space: pre-line; line-height: 1.6;">
                    <p style="color: #ddd;">${text}</p>
                </div>
                <p style="color: ${trustChange >= 0 ? '#8bc34a' : '#c62828'}; text-align: center;">
                    仇벒잺 ${trustChange >= 0 ? '+' : ''}${trustChange} d콢v캩ry s Koudym
                </p>
                <button class="btn" onclick="showNPCDetail('koudy')" style="width: 100%; margin-top: 1rem;">${'Pokra캜ovat'}</button>
            `);
            renderFull();
        }
        
        function giveGiftToNPC(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) return;
            
            // === KONTROLA LOKACE ===
            const currentLocation = state.world?.currentLocation;
            if (currentLocation !== npc.location) {
                showModal('游늸 P콏칤li코 daleko', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游뛂</div>
                        <p>${npc.name} nen칤 pobl칤.</p>
                        <p style="color: #888; font-size: 0.85rem;">Mus칤코 b칳t v lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</strong> abys mohl d치t dar.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            // Uk치zat v칳b캩r dar콢 - pou쬴j suroviny z invent치콏e nebo pen칤ze
            // V캩t코칤 dary maj칤 LEP먞 pom캩r (bonus za 코t캩drost)
            const giftOptions = [
                { id: 'food', name: 'J칤dlo (2x)', icon: '游꼤', cost: { type: 'inv_resource', key: 'food', amount: 2 }, trust: 8 },
                { id: 'water', name: 'Voda (2x)', icon: '游눦', cost: { type: 'inv_resource', key: 'water', amount: 2 }, trust: 8 },
                { id: 'herbs', name: 'Byliny (3x)', icon: '游', cost: { type: 'inv_resource', key: 'herbs', amount: 3 }, trust: 12 },
                { id: 'metal', name: 'Kov (5x)', icon: '丘뙖잺', cost: { type: 'inv_resource', key: 'metal', amount: 5 }, trust: 15 },
                { id: 'money_small', name: 'Pen칤ze (25)', icon: '游눯', cost: { type: 'money', amount: 25 }, trust: 10 },
                { id: 'money_medium', name: 'Pen칤ze (50)', icon: '游눯游눯', cost: { type: 'money', amount: 50 }, trust: 22 }, // Bonus +2
                { id: 'money_big', name: 'Pen칤ze (100)', icon: '游눯游눯游눯', cost: { type: 'money', amount: 100 }, trust: 50 } // Bonus +10 (100p = 5x v칤c pen캩z, dostane코 5x v칤c trust + bonus)
            ];
            
            // === SPECI츼LN칈 DAR: Prastar칳 artefakt pro Z치hadnou 쬰nu ===
            const hasArtifact = state.inv.some(i => i.id === 'unique_artifact');
            if (npcId === 'mysterious_woman' && hasArtifact) {
                giftOptions.unshift({
                    id: 'unique_artifact',
                    name: '游낔 Prastar칳 artefakt',
                    icon: '游낔',
                    cost: { type: 'item', itemId: 'unique_artifact' },
                    trust: 100, // MAX trust!
                    special: true
                });
            }
            
            const giftsHtml = giftOptions.map(gift => {
                let canGive = false;
                let costText = '';
                
                if (gift.cost.type === 'inv_resource') {
                    canGive = (state.resources[gift.cost.key] || 0) >= gift.cost.amount;
                    costText = `${gift.cost.amount}x`;
                } else if (gift.cost.type === 'money') {
                    canGive = state.money >= gift.cost.amount;
                    costText = `${gift.cost.amount} 游눯`;
                } else if (gift.cost.type === 'item') {
                    canGive = state.inv.some(i => i.id === gift.cost.itemId);
                    costText = '游낔 LEGENDARY';
                }
                
                // Speci치ln칤 styling pro legendary dar
                const isSpecial = gift.special;
                const btnStyle = isSpecial 
                    ? 'background: linear-gradient(135deg, #9c27b0, #673ab7); border: 2px solid #ffd700;'
                    : '';
                
                return `
                    <button class="btn" onclick="confirmGift('${npcId}', '${gift.id}')" 
                        style="display: flex; justify-content: space-between; align-items: center; width: 100%; ${!canGive ? 'opacity: 0.5;' : ''} ${btnStyle}"
                        ${!canGive ? 'disabled' : ''}>
                        <span>${gift.icon} ${gift.name}</span>
                        <span style="font-size: 0.8rem; color: ${canGive ? (isSpecial ? '#ffd700' : '#8bc34a') : '#666'};">${costText}  仇벒잺+${gift.trust}</span>
                    </button>
                `;
            }).join('');
            
            showModal(`游꾸 D치t dar - ${npc.name}`, `
                <p style="color: #888; margin-bottom: 1rem;">Vyber dar pro ${npc.name}:</p>
                <div style="display: grid; gap: 0.5rem;">
                    ${giftsHtml}
                </div>
                <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function confirmGift(npcId, giftId) {
            const giftOptions = {
                'food': { cost: { type: 'inv_resource', key: 'food', amount: 2 }, trust: 8 },
                'water': { cost: { type: 'inv_resource', key: 'water', amount: 2 }, trust: 8 },
                'herbs': { cost: { type: 'inv_resource', key: 'herbs', amount: 3 }, trust: 12 },
                'metal': { cost: { type: 'inv_resource', key: 'metal', amount: 5 }, trust: 15 },
                'money_small': { cost: { type: 'money', amount: 25 }, trust: 10 },
                'money_medium': { cost: { type: 'money', amount: 50 }, trust: 22 },
                'money_big': { cost: { type: 'money', amount: 100 }, trust: 50 },
                'unique_artifact': { cost: { type: 'item', itemId: 'unique_artifact' }, trust: 100, special: true }
            };
            
            const gift = giftOptions[giftId];
            if (!gift) return;
            
            // === SPECI츼LN칈 DAR: Prastar칳 artefakt pro Z치hadnou 쬰nu ===
            if (giftId === 'unique_artifact' && npcId === 'mysterious_woman') {
                // Odeber artefakt z invent치콏e
                const artifactIdx = state.inv.findIndex(i => i.id === 'unique_artifact');
                if (artifactIdx === -1) {
                    notifyWarning('Chyba', 'Nem치코 Prastar칳 artefakt!');
                    return;
                }
                state.inv.splice(artifactIdx, 1);
                
                // Nastav trust na MAX
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0 };
                state.npcRelations[npcId].trust = 100;
                state.npcRelations[npcId].gifts++;
                
                // Speci치ln칤 odm캩na - odhal tajnou lokaci + permanent bonus
                if (!state.world.revealedLocations) state.world.revealedLocations = [];
                state.world.revealedLocations.push('ancient_vault', 'secret_lab', 'hidden_bunker');
                
                // Permanent bonus: +10 max HP
                state.char.maxHp += 10;
                state.char.hp = Math.min(state.char.hp + 10, state.char.maxHp);
                
                showModal(`游댩 Artefakt p콏ijat!`, `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; animation: pulse 1s infinite;">游댩</div>
                        <p style="color: #9c27b0; font-style: italic; margin: 1rem 0;">"Kone캜n캩... tohle jsem hledala cel칠 roky."</p>
                        <p style="color: #ffd700; font-size: 1.1rem;">Z치hadn치 쬰na ti pln캩 d콢v캩콏uje!</p>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #9c27b0;">
                            <p style="color: #8bc34a; margin: 0.3rem 0;">仇벒잺 D콢v캩ra: <strong>100/100</strong></p>
                            <p style="color: #9c27b0; margin: 0.3rem 0;">游딬勇 Odhaleny 3 tajn칠 lokace!</p>
                            <p style="color: #ff9800; margin: 0.3rem 0;">游눩 +10 Max HP (permanentn캩)</p>
                        </div>
                        
                        <p style="color: #888; font-size: 0.85rem;">"Te캞 ti pov칤m v코e... kdo jsem a pro캜 jsem tady."</p>
                    </div>
                    <button class="btn" onclick="showNPCDetail('mysterious_woman')" style="width: 100%; margin-top: 1rem; background: #9c27b0;">游댩 Poslouch치m...</button>
                `);
                
                renderFull();
                saveGame();
                return;
            }
            
            // Ode캜ti n치klady
            if (gift.cost.type === 'inv_resource') {
                state.resources[gift.cost.key] -= gift.cost.amount;
            } else if (gift.cost.type === 'money') {
                state.money -= gift.cost.amount;
            }
            
            // P콏idej d콢v캩ru
            state.npcRelations = state.npcRelations || {};
            state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0 };
            state.npcRelations[npcId].trust = Math.min(100, state.npcRelations[npcId].trust + gift.trust);
            state.npcRelations[npcId].gifts++;
            
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            
            showModal(`游꾸 Dar p콏ijat!`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${npc?.icon || '游녻'}</div>
                    <p style="color: #8bc34a; font-size: 1.2rem; margin: 1rem 0;">仇벒잺 +${gift.trust} d콢v캩ry!</p>
                    <p style="color: #888;">${npc?.name || 'NPC'} si v치쮂 tv칠ho daru.</p>
                </div>
                <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            
            renderFull();
        }
        
        function askNPCQuest(npcId) {
            console.log('游닆 askNPCQuest called for:', npcId);
            
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) {
                console.log('游닆 NPC not found!');
                notifyWarning('Chyba', 'NPC nenalezeno');
                return;
            }
            
            console.log('游닆 NPC found:', npc.name, 'location:', npc.location);
            console.log('游닆 Current location:', state.world?.currentLocation);
            
            // === KONTROLA LOKACE ===
            const currentLocation = state.world?.currentLocation;
            if (currentLocation !== npc.location) {
                console.log('游닆 Location mismatch!');
                showModal('游늸 P콏칤li코 daleko', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游뛂</div>
                        <p>${npc.name} nen칤 pobl칤.</p>
                        <p style="color: #888; font-size: 0.85rem;">Mus칤코 b칳t v lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</strong> abys mohl p콏ijmout nebo odevzdat quest.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            if (!npc.quests || npc.quests.length === 0) {
                showModal('游닆 콯치dn칠 questy', `
                    <p>${npc.name} pro tebe moment치ln캩 nem치 쮂멳n칳 칰kol.</p>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // === SPECI츼LN칈 PRVN칈 SETK츼N칈 S KORYM A KOUDYM ===
            state.storyProgress = state.storyProgress || {};
            
            // Kory - prvn칤 setk치n칤
            if (npcId === 'kory' && !state.storyProgress.metKory) {
                state.storyProgress.metKory = true;
                const knowsKoudy = state.storyProgress.metKoudy;
                
                showModal('游붳 Prvn칤 setk치n칤 s Korym', `
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #9c27b0;">
                        <p style="font-style: italic; color: #ddd; line-height: 1.6;">
                            *Vysok칳 mu s pronikav칳ma o캜ima t캩 m캩콏칤 pohledem*
                        </p>
                        <p style="color: #ccc; margin-top: 0.5rem;">
                            "Dal코칤 tul치k v pustin캩. Ale ty... ty m치코 v o캜칤ch n캩co jin칠ho. Hlad. Ne po j칤dle - po SMYSLU."
                        </p>
                        ${knowsKoudy ? `
                            <p style="color: #ff9800; margin-top: 0.5rem;">
                                *p콏imhou콏칤 o캜i* "Moment. Ten pohled... Mluvil jsi s m칳m bratrem, 쬰? S Koudym?"
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Co ti 콏ekl? 콯e jsem monstrum? 콯e chci zni캜it sv캩t?" *trpk칳 sm칤ch* 
                                "On chce OPRAVIT star칳 sv캩t. J치 chci postavit NOV칗. Kdo z n치s je v캩t코칤 bl치zen?"
                            </p>
                        ` : `
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Mo쬹치 jsi sly코el p콏칤b캩hy. O zk치ze sv캩ta. O Projektu AURORA. O bratrech, kte콏칤 stoj칤 proti sob캩."
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "콎칤kaj칤, 쬰 jsem zni캜il star칳 sv캩t. Mo쬹치 maj칤 pravdu. Ale ten sv캩t byl ZKA콯EN칗. 
                                Pln칳 slaboch콢, kte콏칤 ni캜ili planetu a naz칳vali to pokrokem."
                            </p>
                        `}
                        <p style="color: #9c27b0; margin-top: 0.5rem; font-weight: bold;">
                            "Z콢sta켿. Poslouchej. A mo쬹치 pochop칤코, pro캜 jsem ud캩lal, co jsem ud캩lal."
                        </p>
                    </div>
                    
                    <p style="color: #ffd700; text-align: center;">救 +25 XP za p콏칤b캩hov칳 moment</p>
                    
                    <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="respondToKory('interested')" style="background: #9c27b0;">
                            "Zaj칤m치코 m캩. Pov칤dej d치l."
                        </button>
                        <button class="btn" onclick="respondToKory('suspicious')" style="background: #ff9800;">
                            "Pro캜 bych ti m캩l v캩콏it?"
                        </button>
                        <button class="btn" onclick="respondToKory('hostile')" style="background: #c62828;">
                            "Jsi masov칳 vrah."
                        </button>
                    </div>
                `);
                addXP(25);
                renderFull();
                return;
            }
            
            // Koudy - prvn칤 setk치n칤
            if (npcId === 'koudy' && !state.storyProgress.metKoudy) {
                state.storyProgress.metKoudy = true;
                const knowsKory = state.storyProgress.metKory;
                
                showModal('游녿꽳릢 Prvn칤 setk치n칤 s Koudym', `
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #4caf50;">
                        <p style="font-style: italic; color: #ddd; line-height: 1.6;">
                            *Unaven캩 vypadaj칤c칤 mu v laboratorn칤m pl치코ti zvedne hlavu od p콏칤stroj콢*
                        </p>
                        <p style="color: #ccc; margin-top: 0.5rem;">
                            "N치v코t캩va? To je... neobvykl칠. V캩t코ina lid칤 se t칠hle budov캩 vyh칳b치. Boj칤 se radiace. Nebo m캩."
                        </p>
                        ${knowsKory ? `
                            <p style="color: #ff9800; margin-top: 0.5rem;">
                                *zamra캜칤 se* "Po캜kat. Pozn치v치m ten v칳raz. Mluvil jsi s m칳m bratrem. S Korym."
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Co ti nakukal? 콯e je vizion치콏? 콯e buduje lep코칤 sv캩t?" *povzdech*
                                "M콢j bratr v캩콏칤, 쬰 zni캜en칤m star칠ho vytvo콏칤 nov칠. J치 v캩콏칤m, 쬰 m콢쬰me OPRAVIT co jsme rozbili."
                            </p>
                        ` : `
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Jmenuji se Karel. Ale v코ichni mi 콏칤kaj칤 Koudy. Jsem... byl jsem v캩dec."
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Tenhle sv캩t... moje rodina ho pomohla zni캜it. AURORA. Genesis. Sly코el jsi ta jm칠na?"
                                *t콏ese se mu ruka* "Sna쮂셠 se to napravit. Ale n캩kdy... n캩kdy nev칤m, jestli je to v콢bec mo쬹칠."
                            </p>
                        `}
                        <p style="color: #4caf50; margin-top: 0.5rem; font-weight: bold;">
                            "Jestli chce코 pomoct... jestli chce코 b칳t sou캜치st칤 n캩캜eho v캩t코칤ho... m콢쬿 ti uk치zat, na 캜em pracuji."
                        </p>
                    </div>
                    
                    <p style="color: #ffd700; text-align: center;">救 +25 XP za p콏칤b캩hov칳 moment</p>
                    
                    <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="respondToKoudy('helpful')" style="background: #4caf50;">
                            "Chci pomoct. Co m콢쬿 ud캩lat?"
                        </button>
                        <button class="btn" onclick="respondToKoudy('curious')" style="background: #2196f3;">
                            "콎ekni mi v칤c o Genesis."
                        </button>
                        <button class="btn" onclick="respondToKoudy('blame')" style="background: #ff9800;">
                            "Tak쬰 p콏izn치v치코, 쬰 jsi zni캜il sv캩t?"
                        </button>
                    </div>
                `);
                addXP(25);
                renderFull();
                return;
            }
            
            // === NORM츼LN칈 QUEST SYST칄M ===
            
            // Kontrola jestli u quest m치me - P콎ED v칳b캩rem nov칠ho
            state.npcQuests = state.npcQuests || {};
            const activeQuest = state.npcQuests[npcId];
            
            // Pokud m치me aktivn칤 quest, zobraz jeho stav
            if (activeQuest && activeQuest.id) {
                const quest = NPC_QUESTS[activeQuest.id];
                if (quest) {
                    const canComplete = checkNPCQuestProgress(activeQuest, quest);
                    
                    // Pro deliver quest - kontrola jestli jsme u spr치vn칠ho NPC
                    const isDeliverQuest = quest.requirement?.deliver;
                    const deliverTarget = activeQuest.deliverTarget;
                    const isAtDeliverTarget = isDeliverQuest && npcId === deliverTarget;
                    const isAtQuestGiver = !isDeliverQuest || npcId !== deliverTarget;
                    
                    // Pokud jsme u c칤lov칠ho NPC pro doru캜en칤
                    if (isDeliverQuest && isAtDeliverTarget && canComplete) {
                        const questGiverNpcId = Object.keys(state.npcQuests).find(id => 
                            state.npcQuests[id]?.deliverTarget === npcId
                        );
                        
                        showModal(`游닍 Doru캜en칤 z치silek`, `
                            <div style="text-align: center; margin-bottom: 1rem;">
                                <div style="font-size: 3rem;">${npc.icon}</div>
                            </div>
                            <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"Aha, z치soby od obchodn칤ka! V칳born캩, pr치v캩 je pot콏ebuju."</p>
                            
                            <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游꾸 Odm캩na:</h4>
                                <p style="font-size: 0.9rem; color: #aaa;">
                                    ${quest.reward.money ? `游눯 ${quest.reward.money} pen캩z ` : ''}
                                    ${quest.reward.trust ? `仇벒잺 +${quest.reward.trust} d콢v캩ry ` : ''}
                                    ${quest.reward.xp ? `救 +${quest.reward.xp} XP` : ''}
                                </p>
                            </div>
                            
                            <button class="btn" onclick="completeDeliverQuest('${questGiverNpcId}', '${npcId}')" style="width: 100%; background: #4caf50;">游닍 P콏edat z치soby</button>
                            <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: #555;">Zp캩t</button>
                        `);
                        return;
                    }
                    
                    // Norm치ln칤 zobrazen칤 u zadavatele
                    let completeButton = '';
                    if (canComplete) {
                        if (isDeliverQuest) {
                            // U zadavatele deliver questu jen info
                            const targetNpc = FRIENDLY_NPCS.find(n => n.id === deliverTarget);
                            completeButton = `
                                <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #ff9800;">
                                    <p style="color: #ff9800; margin: 0;">游늸 Dones z치soby k: ${targetNpc?.icon || '游녻'} ${targetNpc?.name || 'NPC'}</p>
                                </div>
                            `;
                        } else {
                            completeButton = `<button class="btn" onclick="completeNPCQuest('${npcId}')" style="width: 100%; background: #4caf50;">九 Odevzdat quest</button>`;
                        }
                    }
                    
                    showModal(`游닆 ${quest.name}`, `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 3rem;">${npc.icon}</div>
                        </div>
                        <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"${quest.desc}"</p>
                        
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">游늶 Postup:</h4>
                            ${renderQuestProgress(activeQuest, quest)}
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游꾸 Odm캩na:</h4>
                            <p style="font-size: 0.9rem; color: #aaa;">
                                ${quest.reward.money ? `游눯 ${quest.reward.money} pen캩z ` : ''}
                                ${quest.reward.trust ? `仇벒잺 +${quest.reward.trust} d콢v캩ry ` : ''}
                                ${quest.reward.xp ? `救 +${quest.reward.xp} XP` : ''}
                            </p>
                        </div>
                        
                        ${completeButton}
                        <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: #555;">Zp캩t</button>
                    `);
                    return;
                }
            }
            
            // Nem치me aktivn칤 quest - vyber nov칳 n치hodn캩 (ale ne u dokon캜en칳)
            const completedQuests = state.npcQuests[npcId]?.completed || [];
            const availableQuests = npc.quests.filter(qId => !completedQuests.includes(qId));
            
            if (availableQuests.length === 0) {
                showModal('游닆 V코e spln캩no!', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">游끥</div>
                        <p>${npc?.name || 'NPC'} pro tebe u nem치 쮂멳n칠 dal코칤 칰koly.</p>
                        <p style="color: #8bc34a;">Splnil jsi v코echny questy!</p>
                    </div>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const questId = availableQuests[Math.floor(Math.random() * availableQuests.length)];
            const quest = NPC_QUESTS[questId];
            
            if (!quest) {
                showModal('游닆 콯치dn칠 questy', `<p>Zkus to pozd캩ji.</p>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>`);
                return;
            }
            
            // Nov칳 quest - nab칤dni p콏ijmout
            showModal(`游닆 ${quest.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${npc.icon}</div>
                </div>
                <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"${quest.desc}"</p>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">游늶 Po쬬davky:</h4>
                    ${renderQuestRequirements(quest)}
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游꾸 Odm캩na:</h4>
                    <p style="font-size: 0.9rem; color: #aaa;">
                        ${quest.reward.money ? `游눯 ${quest.reward.money} pen캩z ` : ''}
                        ${quest.reward.trust ? `仇벒잺 +${quest.reward.trust} d콢v캩ry ` : ''}
                        ${quest.reward.xp ? `救 +${quest.reward.xp} XP` : ''}
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="acceptNPCQuest('${npcId}', '${questId}')" style="flex: 1; background: #4caf50;">九 P콏ijmout</button>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="flex: 1; background: #555;">Odm칤tnout</button>
                </div>
            `);
        }
        
        function renderQuestRequirements(quest) {
            const req = quest.requirement;
            let html = '<ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">';
            
            if (req.resources) html += `<li>P콏ines ${req.resources} r콢zn칳ch surovin</li>`;
            if (req.herbs) html += `<li>P콏ines ${req.herbs}칑 byliny</li>`;
            if (req.metal) html += `<li>P콏ines ${req.metal}칑 kov</li>`;
            if (req.explore) html += `<li>Prozkoumej ${req.explore} lokac칤</li>`;
            if (req.kills) html += `<li>Zabij ${req.kills} nep콏치tel</li>`;
            if (req.escort) html += `<li>Doprovo캞 karavanu (nav코tiv 3 lokace)</li>`;
            if (req.riddles) html += `<li>Odpov캩z na ${req.riddles} h치danky</li>`;
            
            html += '</ul>';
            return html;
        }
        
        function renderQuestProgress(activeQuest, quest) {
            const req = quest.requirement;
            const prog = activeQuest.progress || {};
            const start = activeQuest.startState || {};
            let html = '<ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">';
            
            if (req.resources) {
                // Po캜칤tej nasb칤ran칠 suroviny od p콏ijet칤 questu (stejn캩 jako checkNPCQuestProgress)
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                const collected = Math.max(0, currentResources - startResources);
                html += `<li style="color: ${collected >= req.resources ? '#8bc34a' : '#ff9800'};">Suroviny: ${collected}/${req.resources}</li>`;
                
                // Pokud je to deliver quest a m치me dost surovin, uka c칤l
                if (req.deliver && collected >= req.resources) {
                    const targetNpcId = activeQuest.deliverTarget;
                    const targetNpc = FRIENDLY_NPCS.find(n => n.id === targetNpcId);
                    if (targetNpc) {
                        const targetLoc = findNPCLocation(targetNpcId);
                        html += `<li style="color: #2196f3;">游늸 Dones k: ${targetNpc.icon} ${targetNpc.name}</li>`;
                        if (targetLoc) {
                            const loc = LOCATIONS[targetLoc];
                            html += `<li style="color: #888; font-size: 0.85rem;">   Lokace: ${loc?.name || targetLoc}</li>`;
                        }
                    }
                } else if (req.deliver) {
                    html += `<li style="color: #666;">游늸 C칤l doru캜en칤: (nasb칤rej suroviny)</li>`;
                }
            }
            if (req.herbs) {
                const collected = Math.max(0, (state.resources?.herbs || 0) - (start.herbs || 0));
                html += `<li style="color: ${collected >= req.herbs ? '#8bc34a' : '#ff9800'};">Byliny: ${collected}/${req.herbs}</li>`;
            }
            if (req.metal) {
                const collected = Math.max(0, (state.resources?.metal || 0) - (start.metal || 0));
                html += `<li style="color: ${collected >= req.metal ? '#8bc34a' : '#ff9800'};">Kov: ${collected}/${req.metal}</li>`;
            }
            if (req.explore) {
                const current = prog.explored || 0;
                html += `<li style="color: ${current >= req.explore ? '#8bc34a' : '#ff9800'};">Prozkoum치no: ${current}/${req.explore}</li>`;
            }
            if (req.kills) {
                const current = prog.kills || 0;
                html += `<li style="color: ${current >= req.kills ? '#8bc34a' : '#ff9800'};">Zabito: ${current}/${req.kills}</li>`;
            }
            if (req.escort) {
                const current = prog.escortLocations || 0;
                html += `<li style="color: ${current >= 3 ? '#8bc34a' : '#ff9800'};">Nav코t칤ven칠 lokace: ${current}/3</li>`;
            }
            
            html += '</ul>';
            return html;
        }
        
        function checkNPCQuestProgress(activeQuest, quest) {
            const req = quest.requirement;
            const prog = activeQuest.progress || {};
            const start = activeQuest.startState || {};
            
            // Sb캩r r콢zn칳ch surovin (po캜칤t치 se od p콏ijet칤)
            if (req.resources) {
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                const collected = currentResources - startResources;
                if (collected < req.resources) return false;
            }
            
            // Byliny (po캜칤t치 se od p콏ijet칤)
            if (req.herbs) {
                const collected = (state.resources?.herbs || 0) - (start.herbs || 0);
                if (collected < req.herbs) return false;
            }
            
            // Kov (po캜칤t치 se od p콏ijet칤)
            if (req.metal) {
                const collected = (state.resources?.metal || 0) - (start.metal || 0);
                if (collected < req.metal) return false;
            }
            
            // Konkr칠tn칤 surovina (resource + amount) - pro Kory/Koudy questy - STA캛칈 M칈T
            if (req.resource && req.amount) {
                const current = state.resources?.[req.resource] || 0;
                if (current < req.amount) return false;
            }
            
            // Pen칤ze - 캛ERSTV캨 Z칈SKAN칄
            if (req.money) {
                const current = state.money || 0;
                const startMoney = start.money || 0;
                const earned = current - startMoney;
                if (earned < req.money) return false;
            }
            
            // Explore
            if (req.explore && (prog.explored || 0) < req.explore) return false;
            
            // Kills
            if (req.kills && (prog.kills || 0) < req.kills) return false;
            
            // Kill Alpha (zabij alfa pred치tora)
            if (req.killAlpha && !prog.alphaKilled) return false;
            
            // Escort (karavana - nav코tiv X lokac칤)
            if (req.escort) {
                const requiredLocations = req.travels || 3;
                if ((prog.escortLocations || 0) < requiredLocations) return false;
            }
            
            // Travels (bez escort - jen cesty, nap콏. deliver_package)
            if (req.travels && !req.escort) {
                if ((prog.travels || 0) < req.travels) return false;
            }
            
            // Find NPC (najdi p콏e쬴v코칤ho)
            if (req.find_npc && !prog.npcFound) return false;
            
            // Rescue (zachra켿 pacienta)
            if (req.rescue && !prog.rescued) return false;
            
            // Artifact (najdi artefakt)
            if (req.artifact && !prog.artifactFound) return false;
            
            // Riddles (h치danky) - 콏e코칤 se speci치ln캩 v startRiddleQuest
            if (req.riddles) return prog.riddlesSolved >= req.riddles;
            
            // Visit (nav코tiv konkr칠tn칤 lokaci)
            if (req.visit) {
                if (!prog.visited) return false;
            }
            
            // Talk (promluv s NPC) - automaticky spln캩no po p콏ijet칤 a zobrazen칤 detailu
            if (req.talk) {
                if (!prog.talked) return false;
            }
            
            return true;
        }
        
        // Z칤skej progress questu pro zobrazen칤
        function getNPCQuestProgress(activeQuest, quest) {
            const req = quest.requirement;
            const prog = activeQuest.progress || {};
            const start = activeQuest.startState || {};
            
            let result = { current: 0, required: 1, label: '', complete: false, percent: 0 };
            
            if (req.resources) {
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                result.current = Math.max(0, currentResources - startResources);
                result.required = req.resources;
                result.label = '游닍 Suroviny';
            }
            else if (req.herbs) {
                result.current = Math.max(0, (state.resources?.herbs || 0) - (start.herbs || 0));
                result.required = req.herbs;
                result.label = '游 Byliny';
            }
            else if (req.metal) {
                result.current = Math.max(0, (state.resources?.metal || 0) - (start.metal || 0));
                result.required = req.metal;
                result.label = '游댤 Kov';
            }
            else if (req.resource && req.amount) {
                const icons = { gunpowder: '游눤', metal: '游댤', wood: '游뿻', cloth: '游빗', herbs: '游' };
                const names = { gunpowder: 'St콏eln칳 prach', metal: 'Kov', wood: 'D콏evo', cloth: 'L치tka', herbs: 'Byliny' };
                result.current = Math.min(state.resources?.[req.resource] || 0, req.amount);
                result.required = req.amount;
                result.label = `${icons[req.resource] || '游닍'} ${names[req.resource] || req.resource}`;
            }
            else if (req.money) {
                const current = state.money || 0;
                const startMoney = start.money || 0;
                result.current = Math.max(0, current - startMoney);
                result.required = req.money;
                result.label = '游눯 Z칤sk치no';
            }
            else if (req.explore) {
                result.current = prog.explored || 0;
                result.required = req.explore;
                result.label = '游딬勇 Lokace';
            }
            else if (req.kills) {
                result.current = prog.kills || 0;
                result.required = req.kills;
                result.label = '游 Zabito';
            }
            else if (req.killAlpha) {
                result.current = prog.alphaKilled ? 1 : 0;
                result.required = 1;
                result.label = '游냨 Alfa pred치tor';
            }
            else if (req.escort) {
                result.current = prog.escortLocations || 0;
                result.required = req.travels || 3;
                result.label = '游냙 Lokace';
            }
            else if (req.travels && !req.escort) {
                result.current = prog.travels || 0;
                result.required = req.travels;
                result.label = '游뛌 Cesty';
            }
            else if (req.visit) {
                result.current = prog.visited ? 1 : 0;
                result.required = 1;
                result.label = `游늸 Nav코tiv ${WORLD_LOCATIONS.find(l => l.id === req.visit)?.name || req.visit}`;
            }
            else if (req.talk) {
                result.current = prog.talked ? 1 : 0;
                result.required = 1;
                result.label = '游눫 Promluv';
            }
            else if (req.find_npc) {
                result.current = prog.npcFound ? 1 : 0;
                result.required = 1;
                result.label = '游녻 P콏e쬴v코칤';
            }
            else if (req.rescue) {
                result.current = prog.rescued ? 1 : 0;
                result.required = 1;
                result.label = '游 Zachr치n캩no';
            }
            else if (req.artifact) {
                result.current = prog.artifactFound ? 1 : 0;
                result.required = 1;
                result.label = '游낔 Artefakt';
            }
            else if (req.riddles) {
                result.current = prog.riddlesSolved || 0;
                result.required = req.riddles;
                result.label = '游빌 H치danky';
            }
            
            result.complete = result.current >= result.required;
            result.percent = Math.min(100, (result.current / Math.max(1, result.required)) * 100);
            
            return result;
        }
        
        // === SPECI츼LN칈 QUEST TRIGGERY ===
        function checkSpecialQuestTriggers(locationId) {
            if (!state.npcQuests) return;
            
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            if (!loc) return;
            
            Object.entries(state.npcQuests).forEach(([npcId, questData]) => {
                if (!questData?.id || !questData.progress) return;
                const quest = NPC_QUESTS[questData.id];
                if (!quest) return;
                
                // Find NPC (najdi p콏e쬴v코칤ho) - v opu코t캩n칳ch budov치ch, ruin치ch, explore lokac칤ch
                if (quest.requirement?.find_npc && !questData.progress.npcFound) {
                    const validTypes = ['explore', 'npc', 'settlement', 'empty'];
                    const validIds = ['ruined_village', 'abandoned_house', 'old_farm', 'motel', 'safehouse', 'old_church'];
                    if ((validTypes.includes(loc.type) || validIds.includes(loc.id)) && Math.random() < 0.25) {
                        questData.progress.npcFound = true;
                        console.log(`游녻 Find NPC quest spln캩n na lokaci ${loc.id}`);
                        showModal('游녻 P콏e쬴v코칤 nalezen!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">游녻</div>
                                <p style="color: #8bc34a;">"D칤ky bohu! Hledal jsem pomoc..."</p>
                                <p style="color: #888;">Na코el jsi ztracen칠ho p콏e쬴v코칤ho! Vra콘 se k zadavateli pro odm캩nu.</p>
                            </div>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 V칳born캩!</button>
                        `);
                        SoundSystem.play('victory');
                    }
                }
                
                // Rescue (zachra켿 pacienta) - v t치borech n치jezdn칤k콢, nebezpe캜n칳ch lokac칤ch
                if (quest.requirement?.rescue && !questData.progress.rescued) {
                    const validTypes = ['hostile', 'dangerous', 'dungeon'];
                    const validIds = ['raider_camp', 'slave_camp', 'military_outpost', 'research_camp'];
                    if ((validTypes.includes(loc.type) || validIds.includes(loc.id)) && Math.random() < 0.3) {
                        questData.progress.rescued = true;
                        console.log(`游 Rescue quest spln캩n na lokaci ${loc.id}`);
                        showModal('游 Pacient zachr치n캩n!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">游낀</div>
                                <p style="color: #8bc34a;">"Jsi m콢j zachr치nce!"</p>
                                <p style="color: #888;">Osvobodil jsi zajatce! Vra콘 se k zadavateli pro odm캩nu.</p>
                            </div>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 V칳born캩!</button>
                        `);
                        SoundSystem.play('victory');
                    }
                }
                
                // Artifact (najdi artefakt) - v ruin치ch, dungeonech, star칳ch m칤stech
                if (quest.requirement?.artifact && !questData.progress.artifactFound) {
                    const validTypes = ['dungeon', 'explore', 'dangerous'];
                    const validIds = ['ruins_north', 'ruins_south', 'old_bunker', 'underground_bunker', 'ancient_vault', 'secret_lab', 'old_church', 'cemetery'];
                    if ((validTypes.includes(loc.type) || validIds.includes(loc.id)) && Math.random() < 0.2) {
                        questData.progress.artifactFound = true;
                        console.log(`游낔 Artifact quest spln캩n na lokaci ${loc.id}`);
                        showModal('游낔 Artefakt nalezen!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">游낔</div>
                                <p style="color: #9c27b0; font-style: italic;">"Prastar칳 p콏edm캩t pulzuje zvl치코tn칤 energi칤..."</p>
                                <p style="color: #888;">Na코el jsi z치hadn칳 artefakt! Vra콘 se k Z치hadn칠 쬰n캩 pro odm캩nu.</p>
                            </div>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #9c27b0;">九 Tajemn칠...</button>
                        `);
                        SoundSystem.play('victory');
                    }
                }
            });
        }
        
        function acceptNPCQuest(npcId, questId) {
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // Speci치ln칤 handling pro h치danky
            if (questId === 'solve_riddle') {
                startRiddleQuest(npcId);
                return;
            }
            
            state.npcQuests = state.npcQuests || {};
            
            // Pro "talk" questy - automaticky nastav talked na true p콏i p콏ijet칤
            // (proto쬰 u s NPC mluv칤코 kdy p콏ij칤m치코 quest)
            const isTalkQuest = quest.requirement?.talk === true;
            
            state.npcQuests[npcId] = {
                id: questId,
                startTime: Date.now(),
                progress: { explored: 0, kills: 0, escortLocations: 0, talked: isTalkQuest },
                // Ulo쬴t startovn칤 stav pro sledov치n칤 progressu
                startState: {
                    herbs: state.resources?.herbs || 0,
                    metal: state.resources?.metal || 0,
                    wood: state.resources?.wood || 0,
                    cloth: state.resources?.cloth || 0,
                    leather: state.resources?.leather || 0,
                    electronics: state.resources?.electronics || 0,
                    chemicals: state.resources?.chemicals || 0,
                    gunpowder: state.resources?.gunpowder || 0,
                    kills: state.stats?.kills || 0,
                    explored: state.world?.visitedLocations?.length || 0,
                    resources: Object.values(state.resources || {}).reduce((a, b) => a + b, 0),
                    money: state.money || 0
                }
            };
            
            // Pokud je to deliver quest, vyber n치hodn칠ho c칤lov칠ho NPC (jin칠ho ne zadavatele)
            if (quest.requirement?.deliver && quest.deliverTargets) {
                const availableTargets = quest.deliverTargets.filter(t => t !== npcId && FRIENDLY_NPCS.find(n => n.id === t));
                if (availableTargets.length > 0) {
                    state.npcQuests[npcId].deliverTarget = availableTargets[Math.floor(Math.random() * availableTargets.length)];
                }
            }
            
            notifyQuest(quest.name + ' p콏ijat!');
            addLog('P콏ijal jsi quest: ' + quest.name, '游닆');
            showNPCDetail(npcId);
        }
        
        // === SYST칄M H츼DANEK PRO Z츼HADNOU 콯ENU ===
        const RIDDLES = [
            { question: "Co m치 hlavu a patu, ale 쮂멳n칠 nohy?", 
              correct: "Mince", 
              options: ["Mince", "Had", "St콢l"] },
            { question: "캛칤m v칤c bere코, t칤m v칤c roste. Co to je?", 
              correct: "D칤ra", 
              options: ["D칤ra", "Strom", "콎eka"] },
            { question: "Co je leh캜칤 ne p칤rko, ale ani nejsiln캩j코칤 캜lov캩k ho neudr쮂 d칠le ne minutu?", 
              correct: "Dech", 
              options: ["Dech", "My코lenka", "Sv캩tlo"] },
            { question: "M치m m캩sta, ale 쮂멳n칠 domy. M치m lesy, ale 쮂멳n칠 stromy. M치m vodu, ale 쮂멳n칠 ryby. Co jsem?", 
              correct: "Mapa", 
              options: ["Mapa", "Sen", "Vzpom칤nka"] },
            { question: "Narod칤m se vysok치, zem콏u mal치. Co jsem?", 
              correct: "Sv칤캜ka", 
              options: ["Sv칤캜ka", "Hora", "Vlna"] },
            { question: "Co m치 tv치콏, ale nem콢쬰 se usm칤vat?", 
              correct: "Hodiny", 
              options: ["Hodiny", "M캩s칤c", "Socha"] },
            { question: "캛칤m v칤c schne코, t칤m v칤c mokne코. Co to je?", 
              correct: "Ru캜n칤k", 
              options: ["Ru캜n칤k", "M칳dlo", "Vana"] },
            { question: "Co m콢쬰코 chytit, ale nem콢쬰코 hodit?", 
              correct: "Nachlazen칤", 
              options: ["Nachlazen칤", "St칤n", "V칤tr"] },
            { question: "Co m치 zuby, ale nekou코e?", 
              correct: "H콏eben", 
              options: ["H콏eben", "Kl칤캜", "Z치mek"] },
            { question: "Co pad치, ale nikdy se nerozbije? Co se rozbije, ale nikdy nespadne?", 
              correct: "Noc a den", 
              options: ["Noc a den", "Voda a led", "Srdce a du코e"] },
            { question: "캛칤m v칤c z n캩j bere코, t칤m v캩t코칤 je. Co to je?",
              correct: "Studna",
              options: ["Studna", "Hora", "Mo콏e"] },
            { question: "Co b캩쮂, ale nem치 nohy?",
              correct: "캛as",
              options: ["캛as", "K치men", "Hora"] }
        ];
        
        function startRiddleQuest(npcId) {
            // Vyber 3 n치hodn칠 h치danky
            const shuffled = [...RIDDLES].sort(() => Math.random() - 0.5);
            state.riddleQuest = {
                npcId: npcId,
                riddles: shuffled.slice(0, 3),
                current: 0,
                correct: 0,
                attempts: 0
            };
            
            showRiddle();
        }
        
        function showRiddle() {
            const rq = state.riddleQuest;
            if (!rq || rq.current >= rq.riddles.length) {
                finishRiddleQuest();
                return;
            }
            
            const riddle = rq.riddles[rq.current];
            
            // Zam칤chej mo쬹osti odpov캩d칤
            const shuffledOptions = [...riddle.options].sort(() => Math.random() - 0.5);
            
            const optionsHtml = shuffledOptions.map(option => `
                <button class="btn" onclick="checkRiddleAnswer('${option}')" 
                    style="width: 100%; margin: 0.3rem 0; padding: 1rem; background: linear-gradient(135deg, #2a1a3a 0%, #1a1a2a 100%); border: 2px solid #9c27b0; font-size: 1rem;">
                    ${option}
                </button>
            `).join('');
            
            showModal('游댩 H치danka z치hadn칠 쬰ny', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游댩</div>
                    <p style="color: #888; font-size: 0.85rem;">H치danka ${rq.current + 1} z 3</p>
                    <p style="color: #8bc34a;">Spr치vn캩: ${rq.correct} | 맗atn캩: ${rq.attempts}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #9c27b0;">
                    <p style="color: #e1bee7; font-style: italic; font-size: 1.1rem; text-align: center;">
                        "${riddle.question}"
                    </p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    ${optionsHtml}
                </div>
                
                <button class="btn" onclick="cancelRiddleQuest()" style="width: 100%; margin-top: 0.5rem; background: #333; font-size: 0.85rem;">
                    游뛁 Vzd치t se
                </button>
            `);
        }
        
        function checkRiddleAnswer(selectedAnswer) {
            const rq = state.riddleQuest;
            if (!rq) return;
            
            const riddle = rq.riddles[rq.current];
            const isCorrect = selectedAnswer === riddle.correct;
            
            if (isCorrect) {
                // Spr치vn치 odpov캩캞
                rq.correct++;
                rq.current++;
                
                showModal('游댩 Spr치vn캩!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">九</div>
                        <p style="color: #8bc34a; font-size: 1.2rem;">V칳born캩!</p>
                        <p style="color: #888;">"${riddle.correct}" je spr치vn치 odpov캩캞.</p>
                    </div>
                    <button class="btn" onclick="showRiddle()" style="width: 100%; margin-top: 1rem; background: #9c27b0;">
                        ${rq.current >= 3 ? '游끥 Dokon캜it' : '俱뫮잺 Dal코칤 h치danka'}
                    </button>
                `);
                SoundSystem.play('victory');
            } else {
                // 맗atn치 odpov캩캞
                rq.attempts++;
                rq.current++; // Posunout na dal코칤 h치danku
                
                showModal('游댩 맗atn캩!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">仇</div>
                        <p style="color: #f44336; font-size: 1.2rem;">Bohu쬰l ne...</p>
                        <p style="color: #888;">Spr치vn치 odpov캩캞 byla: <strong>${riddle.correct}</strong></p>
                    </div>
                    <button class="btn" onclick="showRiddle()" style="width: 100%; margin-top: 1rem; background: #9c27b0;">
                        ${rq.current >= 3 ? '游끥 Dokon캜it' : '俱뫮잺 Dal코칤 h치danka'}
                    </button>
                `);
                SoundSystem.play('damage');
            }
        }
        
        function finishRiddleQuest() {
            const rq = state.riddleQuest;
            if (!rq) return;
            
            const npcId = rq.npcId;
            const success = rq.correct >= 2; // Pot콏eba aspo켿 2 ze 3
            
            if (success) {
                // 칔sp캩ch - dej odm캩ny
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[npcId].trust = Math.min(100, state.npcRelations[npcId].trust + 25);
                state.npcRelations[npcId].quests++;
                
                // Odhal tajemstv칤
                state.secrets = state.secrets || [];
                if (!state.secrets.includes('mysterious_prophecy')) {
                    state.secrets.push('mysterious_prophecy');
                }
                
                showModal('游댩 Quest spln캩n!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游끥</div>
                        <p style="color: #9c27b0; font-size: 1.2rem;">"Tv치 mysl je bystr치, poutn칤캜e..."</p>
                        <p style="color: #888;">Odpov캩d캩l jsi spr치vn캩 na ${rq.correct} z 3 h치danek.</p>
                        
                        <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #9c27b0;">
                            <p style="color: #e1bee7; font-style: italic;">
                                "Poslouchej dob콏e... Dva brat콏i, Kory a Koudy, hledaj칤 stejnou v캩c - Projekt Genesis. 
                                Ale jejich cesty se rozch치zej칤. Jeden chce zni캜it, druh칳 zachr치nit. 
                                Ty bude코 muset vybrat stranu... nebo naj칤t t콏et칤 cestu."
                            </p>
                        </div>
                        
                        <p style="color: #8bc34a;">仇벒잺 +25 d콢v캩ry</p>
                        <p style="color: #ffd700;">游댑 Odemknuto: Proroctv칤</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem; background: #9c27b0;">
                        Pokra캜ovat
                    </button>
                `);
                SoundSystem.play('victory');
            } else {
                showModal('游댩 Quest nespln캩n', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游땞</div>
                        <p style="color: #f44336;">"Vra콘 se, a bude tv치 mysl ost콏ej코칤..."</p>
                        <p style="color: #888;">Odpov캩d캩l jsi spr치vn캩 jen na ${rq.correct} z 3 h치danek.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem; background: #555;">
                        Odej칤t
                    </button>
                `);
            }
            
            delete state.riddleQuest;
            saveGame(true);
        }
        
        function cancelRiddleQuest() {
            delete state.riddleQuest;
            closeModal();
        }
        
        function completeNPCQuest(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            const activeQuest = state.npcQuests?.[npcId];
            
            if (!activeQuest) {
                notifyError('콯치dn칳 aktivn칤 quest', 'Nem치코 aktivn칤 quest u tohoto NPC.');
                return;
            }
            
            const quest = NPC_QUESTS[activeQuest.id];
            
            if (!quest) {
                notifyError('Quest nenalezen', 'Quest data nenalezena.');
                return;
            }
            
            if (!checkNPCQuestProgress(activeQuest, quest)) {
                // Zobraz co chyb칤
                const progress = getNPCQuestProgress(activeQuest, quest);
                notifyError('Quest nespln캩n', `${progress.label}: ${progress.current}/${progress.required}`);
                return;
            }
            
            // KONTROLA: Quest je spln캩n칳 (nasb칤ran칠 od p콏ijet칤)
            // A z치rove켿 m치 hr치캜 dost na odevzd치n칤 (aktu치ln캩)
            const start = activeQuest.startState || {};
            
            if (quest.requirement.herbs) {
                // Kontrola 1: nasb칤ral dost OD p콏ijet칤
                const collected = (state.resources?.herbs || 0) - (start.herbs || 0);
                if (collected < quest.requirement.herbs) {
                    notifyError('Quest nespln캩n', `Nasb칤rej je코t캩 ${quest.requirement.herbs - collected} bylin.`);
                    return;
                }
                // Kontrola 2: m치 dost na odevzd치n칤
                if ((state.resources.herbs || 0) < quest.requirement.herbs) {
                    notifyError('Nem치코 dost bylin!', `Pot콏ebuje코 ${quest.requirement.herbs} bylin k odevzd치n칤.`);
                    return;
                }
            }
            if (quest.requirement.metal) {
                const collected = (state.resources?.metal || 0) - (start.metal || 0);
                if (collected < quest.requirement.metal) {
                    notifyError('Quest nespln캩n', `Nasb칤rej je코t캩 ${quest.requirement.metal - collected} kovu.`);
                    return;
                }
                if ((state.resources.metal || 0) < quest.requirement.metal) {
                    notifyError('Nem치코 dost kovu!', `Pot콏ebuje코 ${quest.requirement.metal} kovu k odevzd치n칤.`);
                    return;
                }
            }
            if (quest.requirement.resource && quest.requirement.amount) {
                const res = quest.requirement.resource;
                const current = state.resources?.[res] || 0;
                if (current < quest.requirement.amount) {
                    notifyError(`Nem치코 dost ${res}!`, `Pot콏ebuje코 ${quest.requirement.amount} ${res} k odevzd치n칤.`);
                    return;
                }
            }
            if (quest.requirement.money) {
                const earned = (state.money || 0) - (start.money || 0);
                if (earned < quest.requirement.money) {
                    notifyError('Quest nespln캩n', `Z칤skej je코t캩 ${quest.requirement.money - earned} 游눯.`);
                    return;
                }
                if (getMoney() < quest.requirement.money) {
                    notifyError('Nem치코 dost pen캩z!', `Pot콏ebuje코 ${quest.requirement.money} 游눯 k odevzd치n칤.`);
                    return;
                }
            }
            
            // Odeber suroviny
            if (quest.requirement.herbs) {
                state.resources.herbs = Math.max(0, (state.resources.herbs || 0) - quest.requirement.herbs);
            }
            if (quest.requirement.metal) {
                state.resources.metal = Math.max(0, (state.resources.metal || 0) - quest.requirement.metal);
            }
            if (quest.requirement.resource && quest.requirement.amount) {
                const res = quest.requirement.resource;
                state.resources[res] = Math.max(0, (state.resources[res] || 0) - quest.requirement.amount);
            }
            if (quest.requirement.money) {
                removeMoney(quest.requirement.money);
            }
            
            // Dej odm캩ny
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            if (quest.reward.trust) {
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[npcId].trust = Math.min(100, (state.npcRelations[npcId].trust || 0) + quest.reward.trust);
                state.npcRelations[npcId].quests++;
            }
            
            // Karma pro Kory/Koudy
            if (quest.reward.karma_kory) {
                state.karma = state.karma || { kory: 0, koudy: 0 };
                state.karma.kory = (state.karma.kory || 0) + quest.reward.karma_kory;
            }
            if (quest.reward.karma_koudy) {
                state.karma = state.karma || { kory: 0, koudy: 0 };
                state.karma.koudy = (state.karma.koudy || 0) + quest.reward.karma_koudy;
            }
            
            // Ulo quest do seznamu dokon캜en칳ch
            const completedQuestId = activeQuest.id;
            if (!state.npcQuests[npcId].completed) {
                state.npcQuests[npcId].completed = [];
            }
            const completedList = state.npcQuests[npcId].completed;
            if (!completedList.includes(completedQuestId)) {
                completedList.push(completedQuestId);
            }
            
            // Sma aktivn칤 quest ale zachovej completed list
            state.npcQuests[npcId] = { completed: completedList };
            saveGame(true);
            
            notifySuccess('Quest spln캩n!', quest.name);
            addLog('Dokon캜il jsi quest: ' + quest.name, '九');
            
            showModal('游꿀 Quest spln캩n!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">游끥</div>
                    <h3 style="color: #8bc34a;">${quest.name}</h3>
                    <p>Odm캩ny z칤sk치ny!</p>
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        ${quest.reward.money ? `<div>游눯 +${quest.reward.money} pen캩z</div>` : ''}
                        ${quest.reward.xp ? `<div>救 +${quest.reward.xp} XP</div>` : ''}
                        ${quest.reward.trust ? `<div>仇벒잺 +${quest.reward.trust} d콢v캩ry s ${npc?.name || 'NPC'}</div>` : ''}
                        ${quest.reward.karma_kory ? `<div style="color: ${quest.reward.karma_kory > 0 ? '#ff5722' : '#4caf50'};">游댠 Karma Kory: ${quest.reward.karma_kory > 0 ? '+' : ''}${quest.reward.karma_kory}</div>` : ''}
                        ${quest.reward.karma_koudy ? `<div style="color: ${quest.reward.karma_koudy > 0 ? '#2196f3' : '#ff5722'};">游댧 Karma Koudy: ${quest.reward.karma_koudy > 0 ? '+' : ''}${quest.reward.karma_koudy}</div>` : ''}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%;">V칳born캩!</button>
                </div>
            `);
        }
        
        // Speci치ln칤 funkce pro odevzd치n칤 deliver questu u c칤lov칠ho NPC
        function completeDeliverQuest(questGiverNpcId, deliverTargetNpcId) {
            const activeQuest = state.npcQuests?.[questGiverNpcId];
            if (!activeQuest) {
                notifyError('Quest nenalezen', 'Aktivn칤 quest nebyl nalezen.');
                return;
            }
            
            const quest = NPC_QUESTS[activeQuest.id];
            if (!quest) {
                notifyError('Quest nenalezen', 'Quest data nenalezena.');
                return;
            }
            
            // Kontrola 쬰 m치me dost surovin
            const start = activeQuest.startState || {};
            if (quest.requirement.resources) {
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                const collected = currentResources - startResources;
                if (collected < quest.requirement.resources) {
                    notifyError('Quest nespln캩n', `Nasb칤rej je코t캩 ${quest.requirement.resources - collected} surovin.`);
                    return;
                }
            }
            
            // Odeber suroviny (celkov칳 po캜et - ode캜teme z r콢zn칳ch typ콢)
            if (quest.requirement.resources) {
                let toRemove = quest.requirement.resources;
                const resourceTypes = ['wood', 'metal', 'cloth', 'leather', 'electronics', 'chemicals', 'herbs'];
                for (const res of resourceTypes) {
                    if (toRemove <= 0) break;
                    const available = state.resources?.[res] || 0;
                    const remove = Math.min(available, toRemove);
                    if (remove > 0) {
                        state.resources[res] = available - remove;
                        toRemove -= remove;
                    }
                }
            }
            
            // Dej odm캩ny
            const questGiverNpc = FRIENDLY_NPCS.find(n => n.id === questGiverNpcId);
            const deliverNpc = FRIENDLY_NPCS.find(n => n.id === deliverTargetNpcId);
            
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            if (quest.reward.trust) {
                // Trust jde zadavateli questu
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[questGiverNpcId] = state.npcRelations[questGiverNpcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[questGiverNpcId].trust = Math.min(100, (state.npcRelations[questGiverNpcId].trust || 0) + quest.reward.trust);
                state.npcRelations[questGiverNpcId].quests++;
                
                // Trochu trustu i p콏칤jemci
                state.npcRelations[deliverTargetNpcId] = state.npcRelations[deliverTargetNpcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[deliverTargetNpcId].trust = Math.min(100, (state.npcRelations[deliverTargetNpcId].trust || 0) + 5);
            }
            
            // Ulo quest do seznamu dokon캜en칳ch
            const completedQuestId = activeQuest.id;
            if (!state.npcQuests[questGiverNpcId].completed) {
                state.npcQuests[questGiverNpcId].completed = [];
            }
            const completedList = state.npcQuests[questGiverNpcId].completed;
            if (!completedList.includes(completedQuestId)) {
                completedList.push(completedQuestId);
            }
            
            // Sma aktivn칤 quest
            state.npcQuests[questGiverNpcId] = { completed: completedList };
            saveGame(true);
            
            notifySuccess('Z치soby doru캜eny!', quest.name);
            addLog('Dokon캜il jsi quest: ' + quest.name, '九');
            
            showModal('游꿀 Doru캜eno!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">游닍九</div>
                    <h3 style="color: #8bc34a;">${quest.name}</h3>
                    <p>Z치soby 칰sp캩코n캩 doru캜eny k ${deliverNpc?.name || 'NPC'}!</p>
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        ${quest.reward.money ? `<div>游눯 +${quest.reward.money} pen캩z</div>` : ''}
                        ${quest.reward.xp ? `<div>救 +${quest.reward.xp} XP</div>` : ''}
                        ${quest.reward.trust ? `<div>仇벒잺 +${quest.reward.trust} d콢v캩ry s ${questGiverNpc?.name || 'obchodn칤kem'}</div>` : ''}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%;">V칳born캩!</button>
                </div>
            `);
        }
        
        function calculateSettlementProduction() {
            let food = 0, water = 0;
            
            // Z치kladn칤 produkce osady (mal치, ale pom치h치)
            food += 1; // Z치kladn칤 sb캩r
            water += 2; // Z치kladn칤 zdroj vody (potok, d칠코콘)
            
            // Produkce z budov - o코et콏en칤 pro undefined
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.production) {
                    // Budovy vy쬬duj칤c칤 elekt콏inu funguj칤 jen s proudem
                    if (building.requiresPower && calculatePowerBalance() < 0) return;
                    if (building.production.food) food += building.production.food;
                    if (building.production.water) water += building.production.water;
                }
            });
            
            // Produkce od osadn칤k콢 - podle 칰rovn캩 dovednosti
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Z칤skej efekty z 칰rovn캩 dovednosti
                const skillType = type.skill;
                const skillData = SETTLER_SKILLS[skillType];
                const settlerLevel = settler.skillLevel || 1;
                const levelData = skillData?.levels[settlerLevel - 1];
                const effect = levelData?.effect || {};
                
                // J칤dlo (farm치콏, nosi캜 vody s bonusem, lovec)
                if (effect.food) {
                    let bonus = effect.food;
                    // Farmland bonus pro farm치콏e
                    if (type.id === 'farmer' && state.settlement.buildings.includes('farmland')) {
                        bonus += 2;
                    }
                    food += bonus;
                }
                
                // Maso od lovce se po캜칤t치 jako j칤dlo
                if (effect.meat) {
                    food += effect.meat;
                }
                
                // Voda
                if (effect.water) {
                    water += effect.water;
                }
            });
            
            return { food, water };
        }
        
        function calculateSettlementBalance() {
            const prod = calculateSettlementProduction();
            const cons = calculateSettlementConsumption();
            return {
                food: prod.food - cons.food,
                water: prod.water - cons.water
            };
        }
        
        function calculateSettlementConsumption() {
            let food = 0, water = 0;
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Z칤skej spot콏ebu podle 칰rovn캩 dovednosti osadn칤ka
                const skillType = type.skill;
                const skillData = SETTLER_SKILLS[skillType];
                const settlerLevel = settler.skillLevel || 1;
                const levelData = skillData?.levels[settlerLevel - 1];
                
                // Pou쬴j spot콏ebu z 칰rovn캩 dovednosti, nebo z치kladn칤 z typu
                if (levelData && levelData.consumption) {
                    food += levelData.consumption.food || 0;
                    water += levelData.consumption.water || 0;
                } else {
                    food += type.consumption?.food || 1;
                    water += type.consumption?.water || 1;
                }
            });
            return {food, water};
        }
        
        function hireSettler(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            if (!type) return;
            
            // Kontrola unik치tn칤ch osadn칤k콢 (max 1)
            if (type.unique) {
                const alreadyHas = state.settlement?.settlers?.some(s => s.type === typeId);
                if (alreadyHas) {
                    showModal('仇 U m치코 ' + type.name.toLowerCase(), `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">${type.icon}</div>
                            <p>V osad캩 m콢쬰 b칳t pouze <strong>jeden ${type.name.toLowerCase()}</strong>.</p>
                            <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">游눠 Tip: M콢쬰코 ho vylep코it v seznamu osadn칤k콢.</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
                    `);
                    return;
                }
            }
            
            if (getMoney() < type.cost) {
                showModal(t('notifications', 'notEnoughMoney'), `Pot콏ebuje코 ${type.cost} pen캩z!`);
                return;
            }
            
            // Varov치n칤 pokud bude z치porn치 bilance vody/j칤dla
            const currentBalance = calculateSettlementBalance();
            const newFoodBalance = currentBalance.food - (type.consumption?.food || 1);
            const newWaterBalance = currentBalance.water - (type.consumption?.water || 1);
            
            if (newFoodBalance < -5 || newWaterBalance < -5) {
                const warnings = [];
                if (newFoodBalance < -5) warnings.push(`游꼤 J칤dlo: ${newFoodBalance}/den`);
                if (newWaterBalance < -5) warnings.push(`游눦 Voda: ${newWaterBalance}/den`);
                
                showModal('丘멆잺 Varov치n칤 - nedostatek zdroj콢!', `
                    <p>Naj칤m치n칤m dal코칤ho osadn칤ka bude코 m칤t <strong>kritick칳 nedostatek</strong>:</p>
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; color: #c62828; font-weight: bold;">
                        ${warnings.join('<br>')}
                    </div>
                    <p style="color: #888; font-size: 0.9rem;">游눠 Tip: Postav studnu (+6 vody) nebo najmi nosi캜e vody (+2 vody, spot콏eba 0)</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                        <button class="btn" onclick="closeModal(); forceHireSettler('${typeId}')" style="background: #c62828;">丘멆잺 Najmout p콏esto</button>
                    </div>
                `);
                return;
            }
            
            forceHireSettler(typeId);
        }
        
        function forceHireSettler(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            if (!type) return;
            
            // Kontrola unik치tn칤ch osadn칤k콢 (max 1)
            if (type.unique) {
                const alreadyHas = state.settlement?.settlers?.some(s => s.type === typeId);
                if (alreadyHas) return;
            }
            
            if (getMoney() < type.cost) return;
            
            removeMoney(type.cost);
            
            // Generate random name
            const names = ['Jan', 'Marie', 'Petr', 'Anna', 'Karel', 'Eva', 'Tom치코', 'Lenka', 'Pavel', 'Hana', 'Jakub', 'Tereza', 'Martin', 'Lucie', 'David', 'Kate콏ina'];
            const randomName = names[Math.floor(Math.random() * names.length)];
            
            state.settlement.settlers.push({
                type: typeId,
                name: randomName,
                hiredAt: Date.now(),
                skillLevel: 1,
                xp: 0
            });
            
            state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 5);
            
            SoundSystem.play('pickup');
            showModal('九 Najmut!', 
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${type.icon}</div>` +
                `<h3>${randomName}</h3>` +
                `<p>${type.name} byl p콏id치n do tv칠 osady!</p>` +
                `<p style="color: #8bc34a;">+5 prosperity</p>` +
                `</div>`
            );
            addLog(`Najal jsi ${type.name}: ${randomName}`, '游논');
            checkAchievements();
            renderFull();
        }
        
        function fireSettler(index) {
            const settler = state.settlement.settlers[index];
            if (!settler) return;
            
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            
            showModal('Propustit obyvatele?',
                `<p>Opravdu chce코 propustit ${settler.name} (${type.name})?</p>` +
                `<p style="color: #ff9800;">Nedostane코 쮂멳n칠 pen칤ze zp캩t.</p>` +
                `<div style="display: flex; gap: 1rem; margin-top: 1rem;">` +
                `<button class="btn" onclick="confirmFireSettler(${index}); closeModal();" style="flex: 1; background: #c62828;">九 Propustit</button>` +
                `<button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">九 Zru코it</button>` +
                `</div>`
            );
        }
        
        function confirmFireSettler(index) {
            const settler = state.settlement.settlers[index];
            state.settlement.settlers.splice(index, 1);
            state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 3);
            addLog(`Propustil jsi ${settler.name}`, '游녦');
            renderFull();
        }
        
        function buildUnifiedBuilding(buildingId) {
            console.log('游댣 buildUnifiedBuilding CALLED with:', buildingId);
            
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) {
                console.log('游댣 ERROR: Building not found:', buildingId);
                return;
            }
            console.log('游댣 Building found:', building.name);
            
            // Ensure settlers array exists
            if (!state.settlement) state.settlement = {};
            if (!state.settlement.settlers) state.settlement.settlers = [];
            if (!state.settlement.buildings) state.settlement.buildings = [];
            
            // Kontrola stavitele
            const hasBuilder = state.settlement.settlers.some(s => s.type === 'builder');
            
            console.log('游댣 hasBuilder:', hasBuilder, 'settlers:', state.settlement.settlers.map(s => ({type: s.type, name: s.name})));
            
            // Mus칤코 b칳t v osad캩/shelter NEBO m칤t stavitele
            const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
            console.log('游댣 inBase:', inBase, 'currentLocation:', state.world.currentLocation);
            
            if (!inBase && !hasBuilder) {
                console.log('游댣 BLOCKED: Not in base and no builder');
                showModal('仇 Nelze stav캩t', 'Mus칤코 b칳t v osad캩 nebo m칤t Stavitele v osad캩!');
                return;
            }
            
            // Check if already built or being built
            if (state.base.includes(buildingId) || state.settlement.buildings.includes(buildingId)) {
                console.log('游댣 BLOCKED: Already built');
                showModal('Ji postaveno', 'Tuto budovu u m치코!');
                return;
            }
            
            // Check if already in build queue
            if (state.buildQueue && state.buildQueue.some(b => b.id === buildingId)) {
                console.log('游댣 BLOCKED: Already in queue');
                showModal('Ji se stav칤', 'Tato budova se ji stav칤!');
                return;
            }
            
            // Check level requirement
            if (building.level > state.settlement.level) {
                console.log('游댣 BLOCKED: Level too low', building.level, '>', state.settlement.level);
                showModal('N칤zk칳 level', `${'Pot콏ebuje코 level'} ${building.level}!`);
                return;
            }
            
            console.log('游댣 All checks passed, checking power...');
            
            // *** KONTROLA ELEKT콎INY ***
            // Pokud budova pot콏ebuje elekt콏inu, zkontroluj jestli bude코 m칤t dost
            if (building.requiresPower) {
                const currentBalance = calculatePowerBalance();
                const futureBalance = currentBalance - building.requiresPower;
                console.log('游댣 Power check:', currentBalance, '->', futureBalance);
                
                if (futureBalance < 0) {
                    console.log('游댣 Showing power warning modal');
                    // Zobraz varov치n칤 a zeptej se jestli chce pokra캜ovat
                    showModal('丘 Nedostatek elekt콏iny!', `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">丘멆잺丘</div>
                            <p style="color: #ff9800; font-weight: bold;">Tato budova pot콏ebuje ${building.requiresPower} 丘</p>
                            <p style="color: #888;">Aktu치ln칤 bilance: ${currentBalance >= 0 ? '+' : ''}${currentBalance} 丘</p>
                            <p style="color: #c62828;">Po stavb캩: ${futureBalance} 丘</p>
                            
                            <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #c62828;">
                                <p style="color: #ff6b6b; margin: 0; font-size: 0.9rem;">丘멆잺 Budova nebude fungovat dokud nepostav칤코 gener치tor!</p>
                            </div>
                            
                            <p style="color: #888; font-size: 0.85rem;">Tip: Nejd콏칤v postav Sol치rn칤 panely 游댅 nebo Gener치tor 丘뙖잺</p>
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;"> Zru코it</button>
                                <button class="btn" onclick="closeModal(); confirmBuildWithoutPower('${buildingId}')" style="flex: 1; background: #ff9800;">丘 Postavit p콏esto</button>
                            </div>
                        </div>
                    `);
                    return;
                }
            }
            
            console.log('游댣 Calling proceedWithBuild...');
            // Pokra캜uj se stavbou
            proceedWithBuild(buildingId);
        }
        
        function confirmBuildWithoutPower(buildingId) {
            proceedWithBuild(buildingId);
        }
        
        function proceedWithBuild(buildingId) {
            console.log('游댣 proceedWithBuild CALLED with:', buildingId);
            
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) {
                console.log('游댣 proceedWithBuild ERROR: Building not found');
                return;
            }
            
            // KONTROLA: Nelze stav캩t v칤ce budov nar치z!
            if (state.buildQueue && state.buildQueue.length > 0) {
                const currentBuild = state.buildQueue[0];
                const remaining = Math.max(0, Math.ceil((currentBuild.duration - (Date.now() - currentBuild.startTime)) / 60000));
                const timeDisplay = remaining >= 60 ? Math.round(remaining / 60 * 10) / 10 + 'h' : remaining + ' min';
                showModal('游댣 Stavba prob칤h치', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">${currentBuild.icon}</div>
                        <h3>${currentBuild.name}</h3>
                        <p style="color: #ff9800;">낌勇 Zb칳v치: ${timeDisplay}</p>
                        <p style="color: #888; margin-top: 1rem;">Nelze stav캩t v칤ce budov najednou!</p>
                        <p style="color: #666; font-size: 0.85rem;">Po캜kej a se dokon캜칤 aktu치ln칤 stavba.</p>
                    </div>
                `);
                return;
            }
            
            // Kontrola stavitele
            const hasBuilder = state.settlement.settlers.some(s => s.type === 'builder');
            
            // Kontrola jestli je hr치캜 v osad캩
            const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
            
            console.log('游댣 proceedWithBuild - hasBuilder:', hasBuilder, 'inBase:', inBase);
            
            // Check resources - kombinuj sklad osady + invent치콏 hr치캜e (pouze pokud je v osad캩!)
            const settlementRes = state.settlement.resources || {};
            
            console.log('游댣 Checking resources. Building cost:', building.cost);
            console.log('游댣 Settlement resources:', settlementRes);
            console.log('游댣 Player resources:', state.resources);
            
            for (const [res, amt] of Object.entries(building.cost)) {
                const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                const settlementHas = settlementRes[res] || 0;
                // Invent치콏 hr치캜e se po캜칤t치 POUZE pokud je v osad캩
                const playerHas = inBase ? (state.resources[res] || 0) : 0;
                const totalHas = settlementHas + playerHas;
                
                console.log(`游댣 Resource ${res}: need ${cost}, settlement has ${settlementHas}, player has ${playerHas}, total ${totalHas}`);
                
                if (totalHas < cost) {
                    console.log('游댣 BLOCKED: Not enough', res);
                    if (!inBase && hasBuilder) {
                        showModal('仇 Nedostatek surovin', `<p>Stav칤코 na d치lku - suroviny se berou pouze ze <strong>skladu osady</strong>!</p><p>Pot콏ebuje코 ${cost}x ${res}, v osad캩 m치코 ${settlementHas}.</p><p style="color: #888; font-size: 0.85rem;">Tip: Vra콘 se do osady a ulo suroviny do skladu.</p>`);
                    } else {
                        showModal(t('notifications', 'notEnoughResources'), `${'Nem치코 dost materi치l콢! Pot콏ebuje코'} ${cost}x ${res}, ${'m치코'} ${totalHas}.`);
                    }
                    return;
                }
            }
            
            console.log('游댣 All resources OK, consuming...');
            
            // Consume resources - preferuj SKLAD OSADY, pak invent치콏 hr치캜e (pouze pokud je v osad캩!)
            for (const [res, amt] of Object.entries(building.cost)) {
                const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                let remaining = cost;
                
                // Nejd콏칤v odeber ze SKLADU OSADY
                const fromSettlement = Math.min(settlementRes[res] || 0, remaining);
                if (fromSettlement > 0) {
                    settlementRes[res] = (settlementRes[res] || 0) - fromSettlement;
                    remaining -= fromSettlement;
                }
                
                // Zbytek z invent치콏e hr치캜e - POUZE pokud je v osad캩!
                if (remaining > 0 && inBase && state.resources[res]) {
                    state.resources[res] = (state.resources[res] || 0) - remaining;
                }
            }
            
            // Calculate build time (in minutes)
            // Fixn칤 캜asy podle typu budovy - realistick칠 캜asy
            const buildTimes = {
                // Level 1 - z치kladn칤 (2-12 hodin)
                'bed': 120,          // L콢쬶o - 2h
                'firepit': 180,      // Ohni코t캩 - 3h
                'garden': 240,       // Zahrada - 4h
                'workshop': 360,     // D칤lna - 6h
                'storage': 300,      // Sklad - 5h
                'water': 360,        // Sb캩ra캜 vody - 6h
                'well': 720,         // Studna - 12h
                'farmland': 600,     // Pole - 10h
                
                // Level 2 (8-20 hodin)
                'infirmary': 600,    // O코et콏ovna - 10h
                'kitchen': 480,      // Kuchy켿 - 8h
                'wall': 1200,        // Hradby - 20h
                'tower': 960,        // V캩 - 16h
                'market': 800,       // Tr쬴코t캩 - 13h
                'barracks': 1200,    // Kas치rny - 20h
                
                // Level 3 (16-24 hodin)
                'forge': 1440,       // Kov치rna - 24h
                'training': 960,     // Cvi캜i코t캩 - 16h
                'armory': 1200,      // Zbrojnice - 20h
                'tavern': 960,       // Hospoda - 16h
                'chapel': 1200,      // Kaple - 20h
                
                // Level 4 (20-40 hodin)
                'generator': 1680,   // Gener치tor - 28h
                'solar': 1440,       // Sol치rn칤 panely - 24h
                'windmill_power': 1200, // V캩trn치 turb칤na - 20h
                'purifier': 1440,    // 캛isti캜ka - 24h
                'hydrofarm': 1680,   // Hydroponick치 farma - 28h
                'comms': 1920,       // Komunika캜n칤 v캩 - 32h
                'bunker': 2400,      // Bunker - 40h
                
                // Level 5 (32-48 hodin)
                'reactor': 2880,     // Reaktor - 48h (2 dny)
                'medbay': 2160,      // Zdravotn칤 st콏edisko - 36h
                'cryo': 2400,        // Kryogenn칤 sklad - 40h
                'turret': 1920,      // Automatick치 v캩 - 32h
                'university': 2640,  // Univerzita - 44h
                'monument': 2880     // Monument - 48h (2 dny)
            };
            
            let buildTime = buildTimes[buildingId] || Math.max(240, Math.min(2880, totalCost * 10));
            
            // Builder settler reduces time by 10% (max)
            if (hasBuilder) {
                buildTime = Math.ceil(buildTime * 0.9);
            }
            
            // Add to build queue
            if (!state.buildQueue) state.buildQueue = [];
            state.buildQueue.push({
                id: buildingId,
                name: building.name,
                icon: building.icon,
                category: building.category,
                startTime: Date.now(),
                duration: buildTime * 60 * 1000, // Convert to milliseconds
                effect: building.effect
            });
            
            SoundSystem.play('pickup');
            addLog(`游댣 Za캜ala stavba: ${building.name}`, '游끵勇');
            const timeDisplay = buildTime >= 60 ? Math.round(buildTime / 60 * 10) / 10 + ' hodin' : buildTime + ' min';
            showModal('游댣 Stavba zah치jena!',
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${building.icon}</div>` +
                `<h3>${building.name}</h3>` +
                `<p style="color: #ff9800;">낌勇 ${'Doba stavby'}: ${timeDisplay}</p>` +
                `<p style="color: #888; font-size: 0.85rem;">${'Budova bude automaticky dokon캜ena'}</p>` +
                `</div>`
            );
            renderFull();
        }
        
        // Process build queue - called in game loop
        function processBuildQueue() {
            if (!state.buildQueue || state.buildQueue.length === 0) return;
            
            const now = Date.now();
            const completed = [];
            
            state.buildQueue = state.buildQueue.filter(build => {
                const elapsed = now - build.startTime;
                if (elapsed >= build.duration) {
                    // Building complete!
                    completed.push(build);
                    return false;
                }
                return true;
            });
            
            // Process completed buildings
            completed.forEach(build => {
                const building = BUILDINGS.find(b => b.id === build.id);
                
                // Add to appropriate array
                if (build.category === 'settlement') {
                    state.settlement.buildings.push(build.id);
                    state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 25);
                } else {
                    state.base.push(build.id);
                    state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 5);
                }
                
                // Apply effects
                if (build.effect && build.effect.baseCapacity) {
                    state.baseCapacity += build.effect.baseCapacity;
                }
                
                state.stats.itemsCrafted++;
                checkSettlementLevelUp();
                checkAchievements();
                
                SoundSystem.play('success');
                notifyBuild(build.name, build.icon);
                addLog(`九 Stavba dokon캜ena: ${build.name}`, '游끵勇');
                
                // Show completion modal if player is in base AND NOT IN COMBAT
                if ((state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement') && !isInCombat()) {
                    const prosBonus = build.category === 'settlement' ? 25 : 5;
                    showModal('九 Stavba dokon캜ena!',
                        `<div style="text-align: center;">` +
                        `<div style="font-size: 3rem;">${build.icon}</div>` +
                        `<h3>${build.name}</h3>` +
                        `<p style="color: #8bc34a;">+${prosBonus} prosperity</p>` +
                        `</div>`
                    );
                }
            });
            
            if (completed.length > 0) {
                renderFull();
            }
        }
        
        function buildSettlementBuilding(buildingId) {
            // Redirectuji na unifikovanou funkci pro konzistenci
            buildUnifiedBuilding(buildingId);
        }
        
        function demolishBuilding(buildingId) {
            // Najdi budovu - hledej v BUILDINGS (obsahuje v코echny)
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) {
                notifyWarning('Budova nenalezena!');
                return;
            }
            
            // Zkontroluj jestli je budova postaven치 (v base nebo settlement)
            const inBase = state.base.indexOf(buildingId);
            const inSettlement = state.settlement.buildings.indexOf(buildingId);
            
            if (inBase === -1 && inSettlement === -1) {
                notifyWarning('Tato budova nen칤 postaven치!');
                return;
            }
            
            // Potvrzen칤
            const refundText = building.cost ? Object.entries(building.cost).map(([k, v]) => {
                const icons = {wood: '游뿻', metal: '游댤', stone: '游', cloth: '游빗', electronics: '游댋', glass: '游댩'};
                return `${icons[k] || '游닍'} ${Math.floor(v * 0.5)} ${k}`;
            }).join(', ') : 'nic';
            
            showModal('游끵勇 Zbourat budovu?', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${building.icon}</div>
                    <h3 style="color: #f44336; margin-bottom: 0.5rem;">${building.name}</h3>
                    <p style="color: #888;">Opravdu chce코 zbourat tuto budovu?</p>
                    <p style="color: #888; font-size: 0.85rem;">Tato akce je nevratn치!</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4caf50;">
                        <p style="color: #4caf50; margin: 0;">鮫勇 Vr치cen칠 suroviny (50%):</p>
                        <p style="color: #8bc34a; margin: 0.3rem 0 0 0;">${refundText}</p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;"> Zru코it</button>
                        <button class="btn" onclick="confirmDemolish('${buildingId}')" style="flex: 1; background: #c62828;">游끵勇 Zbourat</button>
                    </div>
                </div>
            `);
        }
        
        function confirmDemolish(buildingId) {
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) return;
            
            // Zkontroluj kde je budova
            const inBaseIndex = state.base.indexOf(buildingId);
            const inSettlementIndex = state.settlement.buildings.indexOf(buildingId);
            
            if (inBaseIndex === -1 && inSettlementIndex === -1) return;
            
            // Zapamatuj si stav elekt콏iny P콎ED zbour치n칤m
            const powerBefore = calculatePowerBalance();
            const hadPowerBefore = powerBefore >= 0;
            
            // Odeber budovu z p콏칤slu코n칠ho seznamu
            if (inBaseIndex !== -1) {
                state.base.splice(inBaseIndex, 1);
            }
            if (inSettlementIndex !== -1) {
                state.settlement.buildings.splice(inSettlementIndex, 1);
            }
            
            // Vra콘 50% surovin
            if (building.cost) {
                Object.entries(building.cost).forEach(([resource, amount]) => {
                    const refund = Math.floor(amount * 0.5);
                    if (state.settlement.resources[resource] !== undefined) {
                        state.settlement.resources[resource] += refund;
                    } else if (state.resources[resource] !== undefined) {
                        state.resources[resource] += refund;
                    }
                });
            }
            
            // Sni prosperitu
            state.settlement.prosperity = Math.max(0, (state.settlement.prosperity || 0) - 5);
            
            SoundSystem.play('sell');
            notifySuccess('Budova zbour치na!', `${building.icon} ${building.name} byl/a odstran캩na.`);
            addLog(`Zbour치na budova: ${building.name}`, '游끵勇');
            
            // Zkontroluj jestli se obnovila elekt콏ina
            const powerAfter = calculatePowerBalance();
            const hasPowerAfter = powerAfter >= 0;
            
            if (!hadPowerBefore && hasPowerAfter) {
                // Elekt콏ina se obnovila! Zjisti kter칠 budovy te캞 funguj칤
                const restoredBuildings = [];
                const allBuildings = [...state.base, ...state.settlement.buildings];
                allBuildings.forEach(bId => {
                    const b = BUILDINGS.find(x => x.id === bId);
                    if (b && b.requiresPower) {
                        restoredBuildings.push(b);
                    }
                });
                
                if (restoredBuildings.length > 0) {
                    const names = restoredBuildings.map(b => `${b.icon} ${b.name}`).join(', ');
                    setTimeout(() => {
                        notifySuccess('丘 Elekt콏ina obnovena!', `Tyto budovy nyn칤 funguj칤: ${names}`);
                        addLog(`丘 Elekt콏ina obnovena! Funguje: ${restoredBuildings.map(b => b.name).join(', ')}`, '丘');
                    }, 500);
                }
            }
            
            closeModal();
            saveGame(true);
            renderFull();
        }
        
        function checkSettlementLevelUp() {
            if (state.settlement.prosperity >= 100 && state.settlement.level < 5) {
                forceSettlementLevelUp();
            }
        }
        
        function forceSettlementLevelUp() {
            if (state.settlement.level >= 5) {
                notifyWarning('Maximum!', 'Osada je ji na maxim치ln칤m levelu.');
                return;
            }
            if (state.settlement.prosperity < 100) {
                notifyWarning('Nedostatek!', 'Pot콏ebuje코 100 prosperity.');
                return;
            }
            
            state.settlement.level++;
            state.settlement.prosperity = 0;
            
            SoundSystem.play('levelup');
            const greatText = 'Skv캩l칠!';
            showModal('游꿀 LEVEL UP OSADY!',
                `<div style="text-align: center;">` +
                `<div style="font-size: 4rem;">游끶勇</div>` +
                `<h2 style="color: #ffd700;">Level ${state.settlement.level}</h2>` +
                `<p style="color: #8bc34a; font-size: 1.2rem;">${'Tvoje osada roste!'}</p>` +
                `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                `<p>九 ${'칔rove켿 osady'}: ${state.settlement.level}</p>` +
                `<p>九 ${'Nov칠 budovy odem캜eny!'}</p>` +
                `</div>` +
                `<button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; background: #8bc34a;">九 ${greatText}</button>` +
                `</div>`
            );
            addLog(`Osada dos치hla level ${state.settlement.level}!`, '游꿀');
            renderFull();
        }
        
        // Sb캩ra캜i a lovci sb칤raj칤 ka쬯ou hodinu re치ln칠ho 캜asu
        function updateScavengerProduction() {
            if (!state.settlement || !state.settlement.settlers) return;
            
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Lovec lov칤 ka쬯ou hodinu (mal칠 mno쬽tv칤)
                if (type.production && type.production.meat) {
                    if (Math.random() < 0.3) { // 30% 코ance za hodinu
                        let meat = 1;
                        if (settler.skill > 1) meat += Math.floor(settler.skill / 5);
                        state.settlement.resources.food = (state.settlement.resources.food || 0) + meat;
                        
                        if (Math.random() < 0.05 && settler.skill < 10) {
                            settler.skill = (settler.skill || 1) + 1;
                        }
                    }
                }
                
                // SB캨RA캛 - sb칤r치 suroviny ka쬯칳ch 6 hodin
                if (type.id === 'scavenger_s') {
                    const skillLevel = settler.skillLevel || 1;
                    const SETTLER_SKILLS_DATA = {
                        1: { min: 2, max: 4 },
                        2: { min: 3, max: 5 },
                        3: { min: 4, max: 7 },
                        4: { min: 5, max: 9 },
                        5: { min: 7, max: 12 }
                    };
                    const skillData = SETTLER_SKILLS_DATA[skillLevel] || SETTLER_SKILLS_DATA[1];
                    const amount = Math.floor(Math.random() * (skillData.max - skillData.min + 1)) + skillData.min;
                    const resources = ['wood', 'metal', 'stone', 'cloth', 'leather'];
                    
                    const gathered = {};
                    for (let i = 0; i < amount; i++) {
                        const res = resources[Math.floor(Math.random() * resources.length)];
                        state.settlement.resources[res] = (state.settlement.resources[res] || 0) + 1;
                        gathered[res] = (gathered[res] || 0) + 1;
                    }
                    
                    // 마nce na vz치cnou surovinu (vy코코칤 칰rovn캩)
                    if (skillLevel >= 3 && Math.random() < 0.2) {
                        const rareRes = ['chemicals', 'electronics', 'glass'][Math.floor(Math.random() * 3)];
                        state.settlement.resources[rareRes] = (state.settlement.resources[rareRes] || 0) + 1;
                        gathered[rareRes] = (gathered[rareRes] || 0) + 1;
                    }
                    
                    const gatheredText = Object.entries(gathered).map(([k,v]) => `${v}x ${k}`).join(', ');
                    addLog(`游 ${settler.name} nasb칤ral: ${gatheredText}`, '游');
                    notifySuccess(`游 ${settler.name}`, `Nasb칤ral: ${gatheredText}`);
                }
            });
        }
        
        // === SYST칄M KAZEN칈 J칈DLA ===
        // Syrov칠 j칤dlo se kaz칤 po ur캜it칠m po캜tu dn칤
        const PERISHABLE_FOOD = {
            'raw_meat': { days: 2, name: 'Syrov칠 maso', icon: '游볼' },
            'fish': { days: 2, name: 'Ryba', icon: '游' },
            'small_fish': { days: 2, name: 'Mal치 ryba', icon: '游' },
            'medium_fish': { days: 2, name: 'Kapr', icon: '游' },
            'big_fish': { days: 2, name: 'Sumec', icon: '游냐' },
            'berries': { days: 3, name: 'Bor콢vky', icon: '游삃' },
            'herbs': { days: 5, name: 'Byliny', icon: '游' }
        };
        
        function checkFoodSpoilage() {
            if (!state.confirmed) return;
            
            // Inicializace food timestamps
            if (!state.foodTimestamps) state.foodTimestamps = {};
            
            // Kryogenn칤 sklad v osad캩 zabra켿uje kazen칤
            const hasCryoStorage = state.settlement?.buildings?.includes('cryo_storage') || state.base?.includes('cryo_storage');
            if (hasCryoStorage) return;
            
            let spoiledItems = [];
            const currentDay = state.time.days;
            
            // Kontrola resources (raw_meat, fish, herbs, berries)
            Object.keys(PERISHABLE_FOOD).forEach(itemId => {
                const perishInfo = PERISHABLE_FOOD[itemId];
                const amount = state.resources[itemId] || 0;
                
                if (amount > 0) {
                    // Nastav timestamp pokud neexistuje
                    if (!state.foodTimestamps[itemId]) {
                        state.foodTimestamps[itemId] = currentDay;
                    }
                    
                    const daysSinceObtained = currentDay - state.foodTimestamps[itemId];
                    
                    if (daysSinceObtained >= perishInfo.days) {
                        // J칤dlo se zkazilo!
                        const spoiledAmount = Math.min(amount, Math.ceil(amount * 0.5)); // Zkaz칤 se polovina
                        state.resources[itemId] = Math.max(0, amount - spoiledAmount);
                        
                        if (spoiledAmount > 0) {
                            spoiledItems.push(`${perishInfo.icon} ${spoiledAmount}x ${perishInfo.name}`);
                        }
                        
                        // Reset timestamp pro zb칳vaj칤c칤 j칤dlo
                        if (state.resources[itemId] > 0) {
                            state.foodTimestamps[itemId] = currentDay;
                        } else {
                            delete state.foodTimestamps[itemId];
                        }
                    }
                } else {
                    // Nem치me tento resource - vyma timestamp
                    delete state.foodTimestamps[itemId];
                }
            });
            
            // Kontrola invent치콏e - ryby a maso
            state.inv = state.inv.filter(item => {
                if (PERISHABLE_FOOD[item.id]) {
                    const perishInfo = PERISHABLE_FOOD[item.id];
                    
                    // Nastav timestamp pokud neexistuje
                    if (!item.obtainedDay) {
                        item.obtainedDay = currentDay;
                    }
                    
                    const daysSinceObtained = currentDay - item.obtainedDay;
                    
                    if (daysSinceObtained >= perishInfo.days) {
                        spoiledItems.push(`${perishInfo.icon} ${item.count || 1}x ${perishInfo.name}`);
                        return false; // Odstranit z invent치콏e
                    }
                }
                return true;
            });
            
            // Notifikace pokud se n캩co zkazilo
            if (spoiledItems.length > 0) {
                notifyWarning('游 J칤dlo se zkazilo!', spoiledItems.join(', '));
                addLog('Shnilo: ' + spoiledItems.join(', '), '游');
            }
        }
        
        // P콏i z칤sk치n칤 syrov칠ho j칤dla nastav/aktualizuj timestamp
        function markFoodAsNew(itemId, addedAmount = 1) {
            if (PERISHABLE_FOOD[itemId]) {
                if (!state.foodTimestamps) state.foodTimestamps = {};
                
                const currentAmount = state.resources?.[itemId] || 0;
                const currentDay = state.time.days;
                
                if (!state.foodTimestamps[itemId] || currentAmount === 0) {
                    // Prvn칤 kus nebo pr치zdn칠 - nastav na dne코ek
                    state.foodTimestamps[itemId] = currentDay;
                } else {
                    // U m치me n캩jak칠 - spo캜칤tej v치쬰n칳 pr콢m캩r 캜erstvosti
                    const oldTimestamp = state.foodTimestamps[itemId];
                    const oldAmount = Math.max(1, currentAmount - addedAmount); // Kolik jsme m캩li p콏ed p콏id치n칤m
                    
                    // V치쬰n칳 pr콢m캩r: (star칠 * star칠_mno쬽tv칤 + nov칠 * nov칠_mno쬽tv칤) / celkem
                    const weightedTimestamp = Math.round(
                        (oldTimestamp * oldAmount + currentDay * addedAmount) / (oldAmount + addedAmount)
                    );
                    
                    state.foodTimestamps[itemId] = weightedTimestamp;
                }
            }
        }
        
        function updateSettlementDaily() {
            if (!state.settlement) return;
            
            console.log('游늰 updateSettlementDaily() called! Day:', state.time.days);
            console.log('游늰 Settlers:', state.settlement.settlers?.map(s => `${s.name} (${s.type})`));
            
            // Process finances first (income and maintenance)
            processSettlementFinances();
            
            // Initialize morale if missing
            if (state.settlement.morale === undefined) state.settlement.morale = 50;
            
            // Migrace - p콏idej chyb캩j칤c칤 suroviny do skladu
            const allRes = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 
                           'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'copper', 
                           'silver', 'gold', 'crystal', 'gems', 'food', 'water', 'fuel'];
            allRes.forEach(r => {
                if (state.settlement.resources[r] === undefined) state.settlement.resources[r] = 0;
            });
            
            // Initialize production report
            const prodReport = { food: 0, water: 0, resources: {}, items: [] };
            
            // Calculate production
            let foodProd = 0, waterProd = 0;
            
            // Z치kladn칤 produkce osady (mal치, ale pom치h치)
            foodProd += 1; // Z치kladn칤 sb캩r
            waterProd += 2; // Z치kladn칤 zdroj vody (potok, d칠코콘)
            prodReport.food += 1;
            prodReport.water += 2;
            
            // Base production from buildings - v코e jde do skladu osady
            BUILDINGS.forEach(b => {
                if (state.base.includes(b.id) || state.settlement.buildings.includes(b.id)) {
                    if (b.production) {
                        if (b.production.food) {
                            foodProd += b.production.food;
                            prodReport.food += b.production.food;
                        }
                        if (b.production.water) {
                            waterProd += b.production.water;
                            prodReport.water += b.production.water;
                        }
                        // Produkce surovin z budov - do skladu osady
                        if (b.production.wood) {
                            state.settlement.resources.wood += b.production.wood;
                            prodReport.resources.wood = (prodReport.resources.wood || 0) + b.production.wood;
                        }
                        if (b.production.metal) {
                            state.settlement.resources.metal += b.production.metal;
                            prodReport.resources.metal = (prodReport.resources.metal || 0) + b.production.metal;
                        }
                        if (b.production.stone) {
                            state.settlement.resources.stone += b.production.stone;
                            prodReport.resources.stone = (prodReport.resources.stone || 0) + b.production.stone;
                        }
                        if (b.production.cloth) {
                            state.settlement.resources.cloth += b.production.cloth;
                            prodReport.resources.cloth = (prodReport.resources.cloth || 0) + b.production.cloth;
                        }
                    }
                }
            });
            
            // Past na zv캩콏 bonus - +2 j칤dlo/den za ka쬯ou past v invent치콏i (max 2 pasti)
            const traps = state.inv?.filter(i => i.bonus === 'food') || [];
            if (traps.length > 0) {
                const effectiveTraps = Math.min(traps.length, 2); // Max 2 pasti
                const trapFood = effectiveTraps * 2;
                foodProd += trapFood;
                prodReport.food += trapFood;
                prodReport.items.push({ name: '游돚勇 Pasti na zv캩콏', value: '+' + trapFood + ' j칤dla' + (traps.length > 2 ? ' (max 2)' : '') });
            }
            
            // Settler production - v코e do skladu osady, podle 칰rovn캩 dovednosti
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Z칤skej efekty z 칰rovn캩 dovednosti
                const skillType = type.skill;
                const skillData = SETTLER_SKILLS[skillType];
                const settlerLevel = settler.skillLevel || 1;
                const levelData = skillData?.levels[settlerLevel - 1];
                const effect = levelData?.effect || {};
                
                // Produkce j칤dla (farm치콏)
                if (effect.food) {
                    let food = effect.food;
                    if (state.settlement.buildings.includes('farmland')) food += 2;
                    if (state.settlement.specialization === 'farming') food = Math.floor(food * 1.5);
                    foodProd += food;
                    prodReport.food += food;
                }
                
                // Produkce vody (nosi캜 vody)
                if (effect.water) {
                    waterProd += effect.water;
                    prodReport.water += effect.water;
                }
                
                // Produkce masa (lovec) - po캜칤t치 se jako j칤dlo
                if (effect.meat) {
                    foodProd += effect.meat;
                    prodReport.food += effect.meat;
                    
                    // Lovec tak칠 produkuje k콢쬴 podle 칰rovn캩
                    if (effect.leather) {
                        state.settlement.resources.leather = (state.settlement.resources.leather || 0) + effect.leather;
                        prodReport.resources.leather = (prodReport.resources.leather || 0) + effect.leather;
                    }
                }
                
                // Sb캩ra캜 - denn칤 sb캩r surovin DO SKLADU OSADY podle 칰rovn캩
                if (type.id === 'scavenger_s') {
                    const minRes = effect.minRes || 2;
                    const maxRes = effect.maxRes || 4;
                    const amount = Math.floor(Math.random() * (maxRes - minRes + 1)) + minRes;
                    const resources = ['wood', 'metal', 'stone', 'cloth', 'leather'];
                    
                    console.log(`游 Sb캩ra캜 ${settler.name} sb칤r치 ${amount} surovin...`);
                    
                    // Inicializuj historii sb캩ru pro tohoto sb캩ra캜e
                    if (!settler.gatherHistory) settler.gatherHistory = [];
                    const todayGather = { day: state.world.day, items: [], resources: {} };
                    
                    for (let i = 0; i < amount; i++) {
                        const res = resources[Math.floor(Math.random() * resources.length)];
                        state.settlement.resources[res] = (state.settlement.resources[res] || 0) + 1;
                        prodReport.resources[res] = (prodReport.resources[res] || 0) + 1;
                        todayGather.resources[res] = (todayGather.resources[res] || 0) + 1;
                    }
                    
                    console.log('游 Sb캩ra캜 nasb칤ral:', todayGather.resources);
                    addLog(`游 ${settler.name} nasb칤ral: ${Object.entries(todayGather.resources).map(([k,v]) => `${v}x ${k}`).join(', ')}`, '游');
                    
                    for (let i = 0; i < amount; i++) {
                        const res = resources[Math.floor(Math.random() * resources.length)];
                        state.settlement.resources[res] = (state.settlement.resources[res] || 0) + 1;
                        prodReport.resources[res] = (prodReport.resources[res] || 0) + 1;
                        todayGather.resources[res] = (todayGather.resources[res] || 0) + 1;
                    }
                    
                    // 마nce na vz치cnou surovinu podle 칰rovn캩
                    const rareChance = effect.rareChance || 0.1;
                    if (Math.random() < rareChance) {
                        const rareRes = effect.electronics ? 'electronics' : ['chemicals', 'glass', 'scrap'][Math.floor(Math.random() * 3)];
                        state.settlement.resources[rareRes] = (state.settlement.resources[rareRes] || 0) + 1;
                        prodReport.resources[rareRes] = (prodReport.resources[rareRes] || 0) + 1;
                        todayGather.resources[rareRes] = (todayGather.resources[rareRes] || 0) + 1;
                        addLog(`游 ${settler.name} na코el vz치cnou surovinu: ${rareRes}!`, '九');
                    }
                    
                    // 마nce na p콏edm캩t na 칰rovni 5
                    if (effect.itemChance && Math.random() < effect.itemChance) {
                        // Vybrat n치hodn칳 vz치cn칳 p콏edm캩t
                        const rareItems = ITEMS.filter(i => (i.rarity === 'uncommon' || i.rarity === 'rare') && i.findChance > 0);
                        if (rareItems.length > 0) {
                            const foundItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                            // P콏idat do skladu osady jako baseItem
                            if (!state.baseItems) state.baseItems = [];
                            const existingItem = state.baseItems.find(i => i.id === foundItem.id);
                            if (existingItem && foundItem.type === 'consumable') {
                                existingItem.count = (existingItem.count || 1) + 1;
                                existingItem.fromSettlement = true; // Ozna캜it jako z osady
                            } else {
                                state.baseItems.push({...foundItem, count: 1, fromSettlement: true});
                            }
                            addLog(`游 ${settler.name} na코el ${foundItem.icon} ${foundItem.name}!`, '救');
                            prodReport.items.push(foundItem.name);
                            todayGather.items.push(`${foundItem.icon} ${foundItem.name}`);
                        }
                    }
                    
                    // Ulo dne코n칤 sb캩r do historie (max 7 dn칤)
                    settler.gatherHistory.unshift(todayGather);
                    if (settler.gatherHistory.length > 7) settler.gatherHistory.pop();
                }
                
                // Alchemist produces herbs + chemicals podle 칰rovn캩
                if (type.id === 'alchemist') {
                    const herbsAmount = effect.herbs || 1;
                    const chemsAmount = effect.chemicals || 1;
                    state.settlement.resources.herbs = (state.settlement.resources.herbs || 0) + herbsAmount;
                    state.settlement.resources.chemicals = (state.settlement.resources.chemicals || 0) + chemsAmount;
                    prodReport.resources.herbs = (prodReport.resources.herbs || 0) + herbsAmount;
                    prodReport.resources.chemicals = (prodReport.resources.chemicals || 0) + chemsAmount;
                }
                
                // D콏evorubec - produkuje d콏evo a dal코칤 suroviny podle 칰rovn캩
                if (type.id === 'lumberjack') {
                    const woodAmount = effect.wood || 3;
                    state.settlement.resources.wood = (state.settlement.resources.wood || 0) + woodAmount;
                    prodReport.resources.wood = (prodReport.resources.wood || 0) + woodAmount;
                    
                    // Provaz od 칰rovn캩 3
                    if (effect.rope) {
                        state.settlement.resources.rope = (state.settlement.resources.rope || 0) + effect.rope;
                        prodReport.resources.rope = (prodReport.resources.rope || 0) + effect.rope;
                    }
                    
                    // rot od 칰rovn캩 4
                    if (effect.scrap) {
                        state.settlement.resources.scrap = (state.settlement.resources.scrap || 0) + effect.scrap;
                        prodReport.resources.scrap = (prodReport.resources.scrap || 0) + effect.scrap;
                    }
                    
                    // 마nce na vz치cn칠 d콏evo na 칰rovni 5
                    if (effect.rareWood && Math.random() < 0.15) {
                        // P콏id치 bonus d콏evo nebo speci치ln칤 surovinu
                        const bonusWood = Math.floor(Math.random() * 5) + 3;
                        state.settlement.resources.wood = (state.settlement.resources.wood || 0) + bonusWood;
                        prodReport.resources.wood = (prodReport.resources.wood || 0) + bonusWood;
                        addLog(`游뿝 ${settler.name} na코el vz치cn칠 d콏evo: +${bonusWood}!`, '九');
                    }
                }
                
                // Medic healing podle 칰rovn캩 - POUZE KDY콯 JE HR츼캛 V OSAD캨
                if (effect.healing) {
                    const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
                    
                    if (inBase) {
                        let healAmount = effect.healing;
                        if (state.settlement.specialization === 'medical') healAmount = Math.floor(healAmount * 1.5);
                        
                        // L칠캜en칤 hr치캜e
                        const oldPlayerHp = state.char.hp;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                        const playerHealed = state.char.hp - oldPlayerHp;
                        
                        // L칠캜en칤 radiace hr치캜e (polovina l칠캜en칤)
                        let radHealed = 0;
                        if (state.char.radiation > 0) {
                            const radHeal = Math.floor(healAmount / 2);
                            const oldRad = state.char.radiation;
                            state.char.radiation = Math.max(0, state.char.radiation - radHeal);
                            radHealed = oldRad - state.char.radiation;
                        }
                        
                        // Heal companions too
                        let compHealed = 0;
                        state.companions?.forEach(c => {
                            if (!c.isDead) {
                                const compInfo = COMPANIONS.find(ci => ci.id === c.id);
                                const oldHp = c.hp;
                                c.hp = Math.min(c.maxHp || compInfo?.hp || 50, c.hp + healAmount);
                                compHealed += c.hp - oldHp;
                                
                                // L칠캜en칤 radiace spole캜n칤k콢
                                if (c.radiation > 0) {
                                    const radHeal = Math.floor(healAmount / 2);
                                    c.radiation = Math.max(0, c.radiation - radHeal);
                                }
                            }
                        });
                        
                        // Log a notifikace
                        if (playerHealed > 0 || radHealed > 0 || compHealed > 0) {
                            let healMsg = `游눌 ${settler.name} l칠캜il: `;
                            if (playerHealed > 0) healMsg += `ty +${playerHealed} HP`;
                            if (radHealed > 0) healMsg += `, -${radHealed} 驕뮖잺`;
                            if (compHealed > 0) healMsg += `, spole캜n칤ci +${compHealed} HP`;
                            addLog(healMsg, '游눌');
                        }
                    }
                }
                
                // Osadn칤k z칤sk치v치 XP ka쬯칳 den
                if (settlerLevel < 5) {
                    settler.xp = (settler.xp || 0) + Math.floor(Math.random() * 5) + 1; // 1-5 XP denn캩
                    const xpForNext = settlerLevel * 100;
                    if (settler.xp >= xpForNext) {
                        settler.xp = 0;
                        settler.skillLevel = settlerLevel + 1;
                        const newSkill = skillData?.levels[settler.skillLevel - 1];
                        addLog(`拘勇 ${settler.name} postoupil na 칰rove켿 ${settler.skillLevel}: ${newSkill?.name}!`, '救');
                    }
                }
            });
            
            // Calculate consumption
            const consumption = calculateSettlementConsumption();
            
            // Apply production and consumption
            state.settlement.resources.food += foodProd - consumption.food;
            state.settlement.resources.water += waterProd - consumption.water;
            
            // Morale effects
            if (state.settlement.resources.food <= 0) {
                state.settlement.morale = Math.max(0, state.settlement.morale - 10);
            }
            if (state.settlement.resources.water <= 0) {
                state.settlement.morale = Math.max(0, state.settlement.morale - 10);
            }
            if (state.settlement.resources.food > consumption.food * 3 && state.settlement.resources.water > consumption.water * 3) {
                state.settlement.morale = Math.min(100, state.settlement.morale + 5);
            }
            
            // Check for starvation/dehydration
            if (state.settlement.resources.food < 0) {
                if (state.settlement.settlers.length > 0) {
                    const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                    const settler = state.settlement.settlers[idx];
                    state.settlement.settlers.splice(idx, 1);
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 10);
                    state.settlement.morale = Math.max(0, state.settlement.morale - 15);
                    addLog(`游땩 ${settler.name} opustil osadu kv콢li hladu!`, '游땩');
                    SoundSystem.play('error');
                }
                state.settlement.resources.food = 0;
            }
            
            if (state.settlement.resources.water < 0) {
                if (state.settlement.settlers.length > 0) {
                    const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                    const settler = state.settlement.settlers[idx];
                    state.settlement.settlers.splice(idx, 1);
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 10);
                    state.settlement.morale = Math.max(0, state.settlement.morale - 15);
                    addLog(`游땩 ${settler.name} opustil osadu kv콢li 쮂셬ni!`, '游땩');
                    SoundSystem.play('error');
                }
                state.settlement.resources.water = 0;
            }
            
            // Tavern morale bonus (weekly) - prosperity bonus odstran캩n
            if (state.settlement.buildings.includes('tavern') && state.time.days % 7 === 0) {
                state.settlement.morale = Math.min(100, state.settlement.morale + 20);
                addLog('游꽄 Hospoda zv칳코ila mor치lku osady!', '游꽄');
            }
            
            // === 칔DR콯BA BUDOV ===
            let totalMaintenance = 0;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            const maintenanceReport = [];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance > 0) {
                    totalMaintenance += building.maintenance;
                    maintenanceReport.push({ name: building.name, cost: building.maintenance });
                }
            });
            
            // Stavitel sni쬿je 칰dr쬭u podle 칰rovn캩
            const builders = state.settlement?.settlers?.filter(s => s.type === 'builder') || [];
            let maintenanceDiscount = 0;
            builders.forEach(builder => {
                const level = builder.skillLevel || 1;
                // Sleva: 5%, 10%, 15%, 20%, 25%
                maintenanceDiscount += 0.05 * level;
            });
            maintenanceDiscount = Math.min(0.5, maintenanceDiscount); // Max 50% sleva
            
            const finalMaintenance = Math.floor(totalMaintenance * (1 - maintenanceDiscount));
            
            if (finalMaintenance > 0) {
                if (getMoney() >= finalMaintenance) {
                    removeMoney(finalMaintenance);
                    addLog(`游댢 칔dr쬭a budov: -${finalMaintenance} 游눯${maintenanceDiscount > 0 ? ` (sleva ${Math.round(maintenanceDiscount * 100)}%)` : ''}`, '游댢');
                } else {
                    // Nedostatek pen캩z - n치hodn치 budova se po코kod칤
                    const damageable = allBuildings.filter(id => {
                        const b = BUILDINGS.find(bd => bd.id === id);
                        return b && b.maintenance > 0;
                    });
                    if (damageable.length > 0) {
                        const damaged = damageable[Math.floor(Math.random() * damageable.length)];
                        const damagedBuilding = BUILDINGS.find(b => b.id === damaged);
                        // Odstra켿 budovu
                        if (state.base.includes(damaged)) {
                            state.base = state.base.filter(id => id !== damaged);
                        }
                        if (state.settlement?.buildings?.includes(damaged)) {
                            state.settlement.buildings = state.settlement.buildings.filter(id => id !== damaged);
                        }
                        state.settlement.morale = Math.max(0, state.settlement.morale - 10);
                        addLog(`丘멆잺 ${damagedBuilding?.name || damaged} se rozpadla kv콢li chyb캩j칤c칤 칰dr쬭캩!`, '丘멆잺');
                        SoundSystem.play('error');
                    }
                }
            }
            
            // Kontrola level upu
            checkSettlementLevelUp();
            
            // Trading specialization income je u v calculateDailyIncome()
            
            // === PASIVN칈 P콎칈JEM Z OBCHODN칈K콡 ===
            const traders = state.settlement.settlers.filter(s => s.type === 'trader_s');
            if (traders.length > 0) {
                let totalTraderIncome = 0;
                traders.forEach(trader => {
                    const level = trader.skillLevel || 1;
                    // P콏칤jem podle 칰rovn캩: 10, 20, 35, 55, 80 pen캩z/den
                    const incomeByLevel = [10, 20, 35, 55, 80];
                    const income = incomeByLevel[level - 1] || 10;
                    totalTraderIncome += income;
                });
                
                // Bonus za tr쬴코t캩
                if (state.settlement.buildings.includes('market')) {
                    totalTraderIncome = Math.floor(totalTraderIncome * 1.25); // +25%
                }
                
                addMoney(totalTraderIncome);
                addLog(`游눯 Obchodn칤ci vyd캩lali ${totalTraderIncome} pen캩z!`, '游눯');
            }
            
            // Check for random settlement events
            checkSettlementEvents();
            
            // === GENEROV츼N칈 OSADNICK칗CH QUEST콡 ===
            generateSettlerQuests();
            
            // Random raid chance (defense < 50 = 5% chance, scout reduces to 2%)
            const defense = calculateSettlementDefense();
            const hasScout = state.settlement.settlers.some(s => s.type === 'scout');
            let raidChance = defense < 50 ? 0.05 : 0.02;
            if (hasScout) raidChance *= 0.4; // Scout reduces raid chance by 60%
            if (state.settlement.specialization === 'military') raidChance *= 0.5;
            
            if (Math.random() < raidChance) {
                if (hasScout) {
                    addLog('游끢 Zv캩d varoval p콏ed bl칤쮂셖칤m se 칰tokem!', '游끢');
                }
                triggerSettlementRaid();
            }
            
            // Check level up
            checkSettlementLevelUp();
            
            // Log daily summary
            const netFood = foodProd - consumption.food;
            const netWater = waterProd - consumption.water;
            addLog(`游끶勇 Denn칤 report: ${netFood >= 0 ? '+' : ''}${netFood}游꼤 ${netWater >= 0 ? '+' : ''}${netWater}游눦 | Mor치lka: ${state.settlement.morale}%`, '游끶勇');
        }
        
        // === GENEROV츼N칈 OSADNICK칗CH QUEST콡 ===
        function generateSettlerQuests() {
            if (!state.settlement || !state.settlement.settlers || state.settlement.settlers.length === 0) return;
            if (!state.settlement.activeQuests) state.settlement.activeQuests = [];
            
            // Max 3 aktivn칤 questy sou캜asn캩
            if (state.settlement.activeQuests.length >= 3) return;
            
            // 30% 코ance na nov칳 quest ka쬯칳 den
            if (Math.random() > 0.3) return;
            
            // Vyber n치hodn칠ho osadn칤ka kter칳 nem치 aktivn칤 quest
            const settlersWithoutQuest = state.settlement.settlers.filter(s => 
                !state.settlement.activeQuests.some(q => q.settlerName === s.name)
            );
            
            if (settlersWithoutQuest.length === 0) return;
            
            const settler = settlersWithoutQuest[Math.floor(Math.random() * settlersWithoutQuest.length)];
            const settlerType = SETTLER_TYPES.find(t => t.id === settler.type);
            
            // Najdi quest pro tento typ osadn칤ka
            const availableQuests = SETTLER_QUESTS.filter(q => q.settler === settler.type);
            if (availableQuests.length === 0) return;
            
            const quest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
            
            // P콏idej quest
            state.settlement.activeQuests.push({
                questId: quest.id,
                settlerName: settler.name,
                settlerType: settler.type,
                startDay: state.time.days,
                progress: {}
            });
            
            addLog(`游늶 ${settler.name} (${settlerType?.icon || ''}) m치 pro tebe 칰kol: ${quest.name}`, '游늶');
            notifySuccess('Nov칳 칰kol!', `${settler.name}: ${quest.name}`);
        }
        
        // Funkce pro spln캩n칤 osadnick칠ho questu
        function completeSettlerQuest(questIndex) {
            if (!state.settlement?.activeQuests?.[questIndex]) return;
            
            const sq = state.settlement.activeQuests[questIndex];
            const quest = SETTLER_QUESTS.find(q => q.id === sq.questId);
            if (!quest) return;
            
            // Kontrola po쬬davk콢
            if (quest.request.wood && (state.settlement.resources.wood || 0) < quest.request.wood) {
                notifyWarning('Chyb칤 suroviny!', `Pot콏ebuje코 ${quest.request.wood} d콏eva`);
                return;
            }
            if (quest.request.metal && (state.settlement.resources.metal || 0) < quest.request.metal) {
                notifyWarning('Chyb칤 suroviny!', `Pot콏ebuje코 ${quest.request.metal} kovu`);
                return;
            }
            if (quest.request.meat && (state.settlement.resources.food || 0) < quest.request.meat) {
                notifyWarning('Chyb칤 suroviny!', `Pot콏ebuje코 ${quest.request.meat} j칤dla/masa`);
                return;
            }
            if (quest.request.money && state.money < quest.request.money) {
                notifyWarning('Chyb칤 pen칤ze!', `Pot콏ebuje코 ${quest.request.money} 游눯`);
                return;
            }
            if (quest.request.item) {
                const hasItem = state.inv.some(i => i.id === quest.request.item);
                if (!hasItem) {
                    const itemName = ITEMS.find(i => i.id === quest.request.item)?.name || quest.request.item;
                    notifyWarning('Chyb칤 p콏edm캩t!', `Pot콏ebuje코: ${itemName}`);
                    return;
                }
            }
            
            // Odeber po쬬davky
            if (quest.request.wood) state.settlement.resources.wood -= quest.request.wood;
            if (quest.request.metal) state.settlement.resources.metal -= quest.request.metal;
            if (quest.request.meat) state.settlement.resources.food -= quest.request.meat;
            if (quest.request.money) state.money -= quest.request.money;
            if (quest.request.item) {
                const idx = state.inv.findIndex(i => i.id === quest.request.item);
                if (idx !== -1) {
                    if (state.inv[idx].count > 1) state.inv[idx].count--;
                    else state.inv.splice(idx, 1);
                }
            }
            
            // Dej odm캩ny
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            if (quest.reward.prosperity) state.settlement.prosperity += quest.reward.prosperity;
            if (quest.reward.defense) state.settlement.defense = (state.settlement.defense || 0) + quest.reward.defense;
            if (quest.reward.food) state.settlement.resources.food += quest.reward.food;
            
            // Odeber quest
            state.settlement.activeQuests.splice(questIndex, 1);
            
            addLog(`九 칔kol spln캩n: ${quest.name}!`, '九');
            notifySuccess('칔kol spln캩n!', quest.name);
            
            // Aktualizuj UI
            renderFull();
        }
        
        // Funkce pro zobrazen칤 detailu settler questu
        function showSettlerQuestDetail(questIndex) {
            if (!state.settlement?.activeQuests?.[questIndex]) return;
            
            const sq = state.settlement.activeQuests[questIndex];
            const quest = SETTLER_QUESTS.find(q => q.id === sq.questId);
            const settler = state.settlement.settlers.find(s => s.name === sq.settlerName);
            const settlerType = settler ? SETTLER_TYPES.find(t => t.id === settler.type) : null;
            
            if (!quest) return;
            
            // Kontrola co m치 hr치캜
            let requirementsHtml = '';
            let canComplete = true;
            
            if (quest.request.wood) {
                const has = state.settlement.resources.wood || 0;
                const ok = has >= quest.request.wood;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">游뿻 D콏evo: ${has}/${quest.request.wood} ${ok ? '九' : '九'}</div>`;
            }
            if (quest.request.metal) {
                const has = state.settlement.resources.metal || 0;
                const ok = has >= quest.request.metal;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">游댤 Kov: ${has}/${quest.request.metal} ${ok ? '九' : '九'}</div>`;
            }
            if (quest.request.meat) {
                const has = state.settlement.resources.food || 0;
                const ok = has >= quest.request.meat;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">游볼 Maso/J칤dlo: ${has}/${quest.request.meat} ${ok ? '九' : '九'}</div>`;
            }
            if (quest.request.money) {
                const has = state.money;
                const ok = has >= quest.request.money;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">游눯 Pen칤ze: ${has}/${quest.request.money} ${ok ? '九' : '九'}</div>`;
            }
            if (quest.request.item) {
                const hasItem = state.inv.some(i => i.id === quest.request.item);
                if (!hasItem) canComplete = false;
                const itemData = ITEMS.find(i => i.id === quest.request.item);
                requirementsHtml += `<div style="color: ${hasItem ? '#4caf50' : '#f44336'};">${itemData?.icon || '游닍'} ${itemData?.name || quest.request.item}: ${hasItem ? '九' : '九'}</div>`;
            }
            if (quest.request.action) {
                // Pro akce jako 'patrol' - pot콏eba prozkoumat X lokac칤
                const progress = sq.progress?.explored || 0;
                const ok = progress >= quest.request.count;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#ff9800'};">游댌 Prozkoum치no: ${progress}/${quest.request.count} ${ok ? '九' : '...'}</div>`;
            }
            
            // Odm캩ny
            let rewardHtml = '';
            if (quest.reward.money) rewardHtml += `<span>游눯 ${quest.reward.money}</span> `;
            if (quest.reward.xp) rewardHtml += `<span>救 ${quest.reward.xp} XP</span> `;
            if (quest.reward.prosperity) rewardHtml += `<span>游늳 +${quest.reward.prosperity} prosperita</span> `;
            if (quest.reward.defense) rewardHtml += `<span>游띠勇 +${quest.reward.defense} obrana</span> `;
            if (quest.reward.food) rewardHtml += `<span>游꼤 +${quest.reward.food} j칤dla</span> `;
            
            showModal(`${quest.icon} ${quest.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${quest.icon}</div>
                    <p style="color: #888; font-style: italic;">"${quest.desc}"</p>
                    <p style="color: #aaa;">Od: ${sq.settlerName} ${settlerType?.icon || ''}</p>
                </div>
                
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">游늶 Po쬬davky:</h4>
                <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem;">
                    ${requirementsHtml || '<div style="color: #888;">콯치dn칠 speci치ln칤 po쬬davky</div>'}
                </div>
                
                <h4 style="color: #4caf50; margin-bottom: 0.5rem;">游꾸 Odm캩na:</h4>
                <div style="background: #1a2a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem;">
                    ${rewardHtml || '콯치dn치'}
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    ${canComplete ? 
                        `<button class="btn" onclick="completeSettlerQuest(${questIndex}); closeModal();" style="flex: 1; background: #4caf50;">九 Odevzdat</button>` :
                        `<button class="btn" style="flex: 1; opacity: 0.5;" disabled>九 Nespln캩no</button>`
                    }
                    <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">${'Zp캩t'}</button>
                </div>
            `);
        }
        
        // === SETTLEMENT EVENTS ===
        function checkSettlementEvents() {
            if (!state.settlement) return;
            
            // Eventy se spou코t칤 pouze pokud m치 hr치캜 alespo켿 jednoho osadn칤ka
            const hasSettlers = state.settlement.settlers && state.settlement.settlers.length > 0;
            if (!hasSettlers) return;
            
            // Kontrola cooldownu - 1 event za 6 hodin hern칤ho 캜asu
            const now = Date.now();
            const sixHoursMs = 6 * 60 * 60 * 1000; // 6 hodin v ms
            
            if (!state.settlement.lastEventTime) {
                state.settlement.lastEventTime = now - sixHoursMs; // Prvn칤 event hned
            }
            
            if (now - state.settlement.lastEventTime < sixHoursMs) {
                return; // Je코t캩 neuplynulo 6 hodin
            }
            
            // Aktualizuj 캜as posledn칤ho eventu
            state.settlement.lastEventTime = now;
            
            // Bonus 코ance na obchodn칤ka s komunika캜n칤 v캩쮂
            const hasCommTower = state.base?.includes('comms') || state.settlement?.buildings?.includes('comms');
            const merchantBonus = hasCommTower && hasPower() ? 0.1 : 0; // +10% 코ance s v캩쮂
            
            // Zam칤chej eventy aby nebyly v쬯y ve stejn칠m po콏ad칤
            const shuffledEvents = [...SETTLEMENT_EVENTS].sort(() => Math.random() - 0.5);
            
            // Vyber 1 event
            let selectedEvent = null;
            
            for (const event of shuffledEvents) {
                // Z치kladn칤 코ance
                let eventChance = event.chance * 3; // Zv칳코en치 코ance proto쬰 je jen 1 event za 6h
                
                // Obchodn칤k m치 bonus 코anci s komunika캜n칤 v캩쮂
                if (event.id === 'merchant') {
                    eventChance += merchantBonus;
                }
                
                if (Math.random() > eventChance) continue;
                
                // Check conditions
                const hasSettlers = state.settlement.settlers && state.settlement.settlers.length > 0;
                if (event.condition === 'lowMorale' && (!hasSettlers || state.settlement.morale > 30)) continue;
                if (event.condition === 'hasFarm' && !state.settlement.buildings?.includes('farmland')) continue;
                if (event.condition === 'noMedic' && hasSettlers && state.settlement.settlers.some(s => s.type === 'medic_s')) continue;
                if (event.condition === 'noGuard' && hasSettlers && state.settlement.settlers.some(s => s.type === 'guard')) continue;
                
                // N캩kter칠 eventy pot콏ebuj칤 osadn칤ky
                const needsSettlers = ['birth', 'wedding', 'dispute', 'runaway', 'accident', 'fire', 'sickness', 'injury', 'celebration'];
                if (needsSettlers.includes(event.id) && !hasSettlers) continue;
                
                selectedEvent = event;
                break;
            }
            
            // Pokud 쮂멳n칳 event nepro코el, vyber n치hodn캩 z bezpe캜n칳ch
            if (!selectedEvent) {
                const safeEvents = shuffledEvents.filter(e => 
                    !e.condition &&
                    !['birth', 'wedding', 'dispute', 'runaway', 'accident', 'fire', 'sickness', 'injury'].includes(e.id)
                );
                if (safeEvents.length > 0) {
                    selectedEvent = safeEvents[0];
                }
            }
            
            // Spus콘 event
            if (selectedEvent) {
                triggerSettlementEvent(selectedEvent);
            }
        }
        
        // Zobraz dal코칤 event z fronty
        function triggerNextSettlementEvent() {
            if (!state.pendingSettlementEvents || state.pendingSettlementEvents.length === 0) {
                return;
            }
            
            const event = state.pendingSettlementEvents.shift();
            triggerSettlementEvent(event);
        }
        
        function triggerSettlementEvent(event) {
            state.settlement.activeEvent = event;
            
            // Prom캩nn치 pro detaily eventu (kdo um콏el, co ukradli, atd.)
            let eventDetails = '';
            
            // Apply immediate effects
            if (event.prosperity) {
                state.settlement.prosperity = Math.max(0, Math.min(100, state.settlement.prosperity + event.prosperity));
            }
            if (event.morale) {
                state.settlement.morale = Math.max(0, Math.min(100, state.settlement.morale + event.morale));
            }
            
            let message = `<p style="margin-bottom: 1rem;">${event.desc}</p>`;
            let buttons = '';
            
            switch (event.effect) {
                case 'newSettler':
                    if (true) {
                        const randomType = SETTLER_TYPES[Math.floor(Math.random() * SETTLER_TYPES.length)];
                        const newSettler = { type: randomType.id, name: generateSettlerName(), hp: 100, maxHp: 100, morale: 50 };
                        state.settlement.settlers.push(newSettler);
                        message += `<p style="color: var(--toxic-green);">Nov칳 obyvatel: ${randomType.icon} ${newSettler.name} (${randomType.name})</p>`;
                        eventDetails = `Nov칳: ${newSettler.name} (${randomType.name})`;
                    } else {
                        message = '<p>Osada je pln치, nelze p콏ijmout dal코칤ho obyvatele.</p>';
                    }
                    break;
                
                case 'morale':
                    // Svatba - zv칳코칤 mor치lku
                    state.settlement.morale = Math.min(100, state.settlement.morale + (event.morale || 20));
                    message += `<p style="color: var(--toxic-green);">+${event.morale || 20} mor치lka osady!</p>`;
                    message += `<p style="color: #ff69b4;">游눗 Cel치 osada slav칤!</p>`;
                    break;
                    
                case 'party':
                    // Oslava - zv칳코칤 mor치lku v코ech
                    state.settlement.morale = Math.min(100, state.settlement.morale + (event.morale || 25));
                    state.settlement.settlers.forEach(s => {
                        s.morale = Math.min(100, (s.morale || 50) + 15);
                    });
                    message += `<p style="color: var(--toxic-green);">+${event.morale || 25} mor치lka osady!</p>`;
                    message += `<p style="color: #ffd700;">游꿁 V코ichni osadn칤ci jsou 코콘astn캩j코칤!</p>`;
                    break;
                    
                case 'conflict':
                    // Spor - sn칤쮂 mor치lku
                    state.settlement.morale = Math.max(0, state.settlement.morale + (event.morale || -15));
                    if (state.settlement.settlers.length >= 2) {
                        const settler1 = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        let settler2 = settler1;
                        while (settler2 === settler1 && state.settlement.settlers.length > 1) {
                            settler2 = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        }
                        message += `<p style="color: #ff9800;">${settler1.name} a ${settler2.name} se h치daj칤!</p>`;
                    }
                    message += `<p style="color: #c62828;">${event.morale || -15} mor치lka osady</p>`;
                    break;
                    
                case 'injury':
                    // Nehoda - zran칤 osadn칤ka
                    if (state.settlement.settlers.length > 0) {
                        const injured = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        const type = SETTLER_TYPES.find(t => t.id === injured.type);
                        injured.hp = Math.max(10, (injured.hp || 100) - 40);
                        message += `<p style="color: #c62828;">${type?.icon || '游녻'} ${injured.name} se v치쬹캩 zranil!</p>`;
                        message += `<p style="color: #ff9800;">HP: ${injured.hp}/100</p>`;
                        if (state.settlement.settlers.some(s => s.type === 'medic_s')) {
                            injured.hp = Math.min(100, injured.hp + 20);
                            message += `<p style="color: var(--toxic-green);">Medik poskytl prvn칤 pomoc! (+20 HP)</p>`;
                        } else {
                            message += `<p style="color: #888;">游눠 S medikem by se zotavil rychleji.</p>`;
                        }
                    }
                    break;
                    
                case 'loseSettler':
                    if (state.settlement.settlers.length > 0) {
                        const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                        const lost = state.settlement.settlers.splice(idx, 1)[0];
                        const type = SETTLER_TYPES.find(t => t.id === lost.type);
                        message += `<p style="color: #c62828;">${type?.icon || '游녻'} ${lost.name} utekl z osady!</p>`;
                    }
                    break;
                    
                case 'sickness':
                    const sickCount = Math.min(state.settlement.settlers.length, Math.floor(Math.random() * 3) + 1);
                    message += `<p style="color: #ff9800;">${sickCount} obyvatel onemocn캩lo.</p>`;
                    if (!state.settlement.settlers.some(s => s.type === 'medic_s')) {
                        message += '<p style="color: #c62828;">Bez medika m콢쬰 nemoc zab칤t!</p>';
                        if (Math.random() < 0.3 && state.settlement.settlers.length > 0) {
                            const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                            const dead = state.settlement.settlers.splice(idx, 1)[0];
                            message += `<p style="color: #c62828;">游 ${dead.name} zem콏el na nemoc!</p>`;
                        }
                    } else {
                        message += '<p style="color: var(--toxic-green);">Medik se o n캩 postar치.</p>';
                    }
                    break;
                    
                case 'food':
                    state.settlement.resources.food += event.food || 20;
                    message += `<p style="color: var(--toxic-green);">+${event.food || 20} 游꼤 j칤dla!</p>`;
                    break;
                    
                case 'bonus':
                    const bonusRes = ['wood', 'metal', 'stone', 'cloth'][Math.floor(Math.random() * 4)];
                    const bonusAmt = Math.floor(Math.random() * 10) + 5;
                    const resNames = { wood: 'D콏evo', metal: 'Kov', stone: 'K치men', cloth: 'L치tka' };
                    const resIcons = { wood: '游뿻', metal: '丘뙖잺', stone: '游뿯', cloth: '游빗' };
                    state.resources[bonusRes] = (state.resources[bonusRes] || 0) + bonusAmt;
                    message += `<p style="color: var(--toxic-green);">+${bonusAmt}x ${resIcons[bonusRes]} ${resNames[bonusRes]}!</p>`;
                    eventDetails = `+${bonusAmt} ${resIcons[bonusRes]} ${resNames[bonusRes]}`;
                    break;
                    
                case 'trade':
                    state.settlement.visitingMerchant = {
                        until: Date.now() + (event.duration || 10) * 60 * 1000, // duration v minut치ch
                        discount: 0.2
                    };
                    message += '<p style="color: var(--warning-yellow);">Obchodn칤k z콢stane ' + (event.duration || 10) + ' minut. Nav코tiv obchod pro slevu!</p>';
                    break;
                    
                case 'skillUp':
                case 'skill':
                    if (state.settlement.settlers.length > 0) {
                        const settler = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        settler.skillLevel = (settler.skillLevel || 1) + 1;
                        const type = SETTLER_TYPES.find(t => t.id === settler.type);
                        message += `<p style="color: var(--toxic-green);">${type?.icon || '游녻'} ${settler.name} se zlep코il! (Level ${settler.skillLevel})</p>`;
                    }
                    break;
                
                // === NOV칄 EFEKTY ===
                case 'theft':
                    const stolenFood = Math.floor(Math.random() * 10) + 5;
                    const stolenWater = Math.floor(Math.random() * 8) + 3;
                    state.settlement.resources.food = Math.max(0, state.settlement.resources.food - stolenFood);
                    state.settlement.resources.water = Math.max(0, state.settlement.resources.water - stolenWater);
                    message += `<p style="color: #c62828;">Ztr치ta: -${stolenFood} 游꼤, -${stolenWater} 游눦</p>`;
                    eventDetails = `-${stolenFood} 游꼤, -${stolenWater} 游눦`;
                    if (!state.settlement.settlers.some(s => s.type === 'guard')) {
                        message += '<p style="color: #ff9800;">游눠 Str치쬮e by tomu zabr치nil!</p>';
                    }
                    break;
                    
                case 'fire':
                    const damageRoll = Math.random();
                    if (damageRoll < 0.3 && state.settlement.buildings.length > 0) {
                        const idx = Math.floor(Math.random() * state.settlement.buildings.length);
                        const destroyed = state.settlement.buildings.splice(idx, 1)[0];
                        const building = BUILDINGS.find(b => b.id === destroyed);
                        message += `<p style="color: #c62828;">游댠 ${building?.name || destroyed} sho콏ela!</p>`;
                        eventDetails = `Sho콏ela: ${building?.name || destroyed}`;
                    } else {
                        const lostFood = Math.floor(state.settlement.resources.food * 0.2);
                        state.settlement.resources.food = Math.max(0, state.settlement.resources.food - lostFood);
                        message += `<p style="color: #ff9800;">Z치soby po코kozeny: -${lostFood} 游꼤</p>`;
                        eventDetails = `-${lostFood} 游꼤`;
                    }
                    break;
                    
                case 'golden':
                    state.settlement.resources.food += 30;
                    state.settlement.resources.water += 30;
                    addMoney(200);
                    message += `<p style="color: #ffd700;">+30 游꼤, +30 游눦, +200 游눯!</p>`;
                    eventDetails = '+30 游꼤, +30 游눦, +200 游눯';
                    break;
                    
                case 'plague':
                    const plagueDeaths = Math.min(state.settlement.settlers.length, Math.floor(Math.random() * 3) + 1);
                    const deadNames = [];
                    for (let i = 0; i < plagueDeaths; i++) {
                        if (state.settlement.settlers.length > 0) {
                            const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                            const dead = state.settlement.settlers.splice(idx, 1)[0];
                            deadNames.push(dead.name);
                            message += `<p style="color: #c62828;">游 ${dead.name} zem콏el!</p>`;
                        }
                    }
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 30);
                    eventDetails = deadNames.length > 0 ? `Zem콏eli: ${deadNames.join(', ')}` : '';
                    break;
                    
                case 'treasure':
                    const treasureMoney = Math.floor(Math.random() * 300) + 200;
                    addMoney(treasureMoney);
                    const rareRes = ['copper', 'silver', 'gold'][Math.floor(Math.random() * 3)];
                    state.resources[rareRes] = (state.resources[rareRes] || 0) + 3;
                    message += `<p style="color: #ffd700;">+${treasureMoney} 游눯, +3 ${rareRes}!</p>`;
                    eventDetails = `+${treasureMoney} 游눯, +3 ${rareRes}`;
                    // Track pro achievement
                    state.stats.treasuresFound = (state.stats.treasuresFound || 0) + 1;
                    break;
                
                // === ROZHODOVAC칈 EVENTY ===
                case 'choice_refugee':
                    const refugeeTexts = {
                        desc: 'Vy캜erpan칳 uprchl칤k pros칤 o p콏ijet칤 do osady.',
                        hint: 'Vypad치 쬰 ut칤k치 p콏ed bandity...',
                        accept: 'P콏ijmout (+1 osadn칤k, -10 游꼤)',
                        reject: 'Odm칤tnout (mo쬹치 se vr치t칤 s bandity...)'
                    };
                    message = `<p>${refugeeTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${refugeeTexts.hint}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('refugee_accept')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            九 ${refugeeTexts.accept}
                        </button>
                        <button class="btn" onclick="settlementChoice('refugee_reject')" style="width: 100%; background: #555;">
                            仇 ${refugeeTexts.reject}
                        </button>
                    `;
                    break;
                    
                case 'choice_dog':
                    const dogTexts = {
                        desc: 'Vyhubl칳 pes sed칤 u br치ny a prosebn캩 kouk치.',
                        hint: 'Vypad치 쬰 by mohl b칳t u쬴te캜n칳...',
                        adopt: 'Adoptovat (-5 游꼤/den, +bonus k obran캩)',
                        feed: 'Nakrmit a pustit (-3 游꼤)',
                        ignore: 'Ignorovat'
                    };
                    message = `<p>${dogTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${dogTexts.hint}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('dog_adopt')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            游냇 ${dogTexts.adopt}
                        </button>
                        <button class="btn" onclick="settlementChoice('dog_feed')" style="width: 100%; margin-bottom: 0.5rem; background: #5D4037;">
                            游꼤 ${dogTexts.feed}
                        </button>
                        <button class="btn" onclick="settlementChoice('dog_ignore')" style="width: 100%; background: #555;">
                            游녦 ${dogTexts.ignore}
                        </button>
                    `;
                    break;
                    
                case 'choice_mystery':
                    const mysteryOffer = Math.random() < 0.5 ? 'good' : 'bad';
                    state.settlement.mysteryOffer = mysteryOffer;
                    const mystTexts = {
                        desc: 'Z치hadn치 postava v pl치코ti nab칤z칤 obchod:',
                        offer: '"D치m ti n캩co cenn칠ho za 100 游눯..."',
                        unknown: 'Nev칤코 co dostane코.',
                        accept: 'Zaplatit 100 游눯 (risk!)', reject: 'Odm칤tnout'
                    };
                    message = `<p>${mystTexts.desc}</p>
                        <p style="color: #ffd700;">${mystTexts.offer}</p>
                        <p style="color: #888; font-size: 0.9rem;">${mystTexts.unknown}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('mystery_accept')" style="width: 100%; margin-bottom: 0.5rem; background: #9C27B0;">
                            游 ${mystTexts.accept}
                        </button>
                        <button class="btn" onclick="settlementChoice('mystery_reject')" style="width: 100%; background: #555;">
                            仇 ${mystTexts.reject}
                        </button>
                    `;
                    break;
                    
                case 'choice_wounded':
                    const woundTexts = {
                        desc: 'T캩쬮e zran캩n칳 cizinec le쮂 u cesty.',
                        hint: 'Mo쬹치 m치 n캩co cenn칠ho... nebo je to past.',
                        help: 'Pomoci (-1 medkit, mo쬹치 odm캩na)',
                        loot: 'Prohledat kapsy (zl치 karma)',
                        ignore: 'J칤t d치l'
                    };
                    message = `<p>${woundTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${woundTexts.hint}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('wounded_help')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            游눍 ${woundTexts.help}
                        </button>
                        <button class="btn" onclick="settlementChoice('wounded_loot')" style="width: 100%; margin-bottom: 0.5rem; background: #8B0000;">
                            游 ${woundTexts.loot}
                        </button>
                        <button class="btn" onclick="settlementChoice('wounded_ignore')" style="width: 100%; background: #555;">
                            游녦 ${woundTexts.ignore}
                        </button>
                    `;
                    break;
                    
                case 'choice_bandit':
                    const banditTexts = {
                        desc: 'Bandita s jizvou p콏ich치z칤 s "nab칤dkou":',
                        threat: '"Pla콘 50 游꿞 t칳dn캩 nebo... v칤코 co."',
                        pay: 'Zaplatit (m칤r na t칳den)',
                        fight: 'Odm칤tnout a bojovat!',
                        trick: 'Lst칤 ho p콏elst칤t (INT check)'
                    };
                    message = `<p>${banditTexts.desc}</p>
                        <p style="color: #c62828;">${banditTexts.threat}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('bandit_pay')" style="width: 100%; margin-bottom: 0.5rem; background: #555;">
                            游눯 ${banditTexts.pay}
                        </button>
                        <button class="btn" onclick="settlementChoice('bandit_fight')" style="width: 100%; margin-bottom: 0.5rem; background: #8B0000;">
                            丘덢잺 ${banditTexts.fight}
                        </button>
                        <button class="btn" onclick="settlementChoice('bandit_trick')" style="width: 100%; background: #9C27B0;">
                            游꿠 ${banditTexts.trick}
                        </button>
                    `;
                    break;
                    
                case 'choice_child':
                    const childTexts = {
                        desc: 'Mal칠 d칤t캩 stoj칤 samo u br치ny.',
                        quote: '"Maminka a tat칤nek jsou... pry캜."',
                        adopt: 'P콏ijmout do osady (+morale, -3 游꼤/den)',
                        send: 'Poslat k obchodn칤k콢m (bezpe캜n캩j코칤)'
                    };
                    message = `<p>${childTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${childTexts.quote}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('child_adopt')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            游 ${childTexts.adopt}
                        </button>
                        <button class="btn" onclick="settlementChoice('child_send')" style="width: 100%; background: #555;">
                            游딬勇 ${childTexts.send}
                        </button>
                    `;
                    break;
                    
                case 'choice_dispute':
                    const settler1 = state.settlement.settlers[0];
                    const settler2 = state.settlement.settlers[1] || settler1;
                    const dispTexts = {
                        desc: ' se h치daj칤 o nalezen칠 z치soby.',
                        question: 'Kdo m치 pravdu?',
                        first: ' m치 pravdu', second: ' m치 pravdu',
                        split: 'Rozd캩lit spravedliv캩'
                    };
                    message = `<p>${settler1?.name || ('Osadn칤k')} ${'a'} ${settler2?.name || ('jin칳 osadn칤k')}${dispTexts.desc}</p>
                        <p style="color: #888;">${dispTexts.question}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('dispute_first')" style="width: 100%; margin-bottom: 0.5rem; background: #2196f3;">
                            游녣 ${settler1?.name || ('Prvn칤')}${dispTexts.first}
                        </button>
                        <button class="btn" onclick="settlementChoice('dispute_second')" style="width: 100%; margin-bottom: 0.5rem; background: #FF9800;">
                            游녤 ${settler2?.name || ('Druh칳')}${dispTexts.second}
                        </button>
                        <button class="btn" onclick="settlementChoice('dispute_split')" style="width: 100%; background: #4CAF50;">
                            游뱋 ${dispTexts.split}
                        </button>
                    `;
                    break;
                    
                case 'choice_scavenger':
                    const scavTexts = {
                        desc: 'Sb캩ra캜 p콏inesl z치hadnou bednu.',
                        quote: '"Nev칤m co v n칤 je... otev콏eme?"',
                        open: 'Otev콏칤t (m콢쬰 b칳t poklad nebo past!)',
                        sell: 'Prodat obchodn칤kovi (50 游꿞 jist칳ch)',
                        careful: 'Opatrn캩 prozkoumat (INT check)'
                    };
                    message = `<p>${scavTexts.desc}</p>
                        <p style="color: #ffd700;">${scavTexts.quote}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('scavenger_open')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            游닍 ${scavTexts.open}
                        </button>
                        <button class="btn" onclick="settlementChoice('scavenger_sell')" style="width: 100%; margin-bottom: 0.5rem; background: #FF9800;">
                            游눯 ${scavTexts.sell}
                        </button>
                        <button class="btn" onclick="settlementChoice('scavenger_careful')" style="width: 100%; background: #555;">
                            游댌 ${scavTexts.careful}
                        </button>
                    `;
                    break;
                    
                default:
                    // Morale a party efekt
                    if (event.effect === 'morale' || event.effect === 'party' || event.effect === 'conflict' || event.effect === 'injury') {
                        // U zpracov치no prosperity/morale v칳코e
                    }
                    break;
            }
            
            if (!buttons) {
                // Po kliknut칤 na OK se zobraz칤 dal코칤 event (pokud existuje)
                const hasMoreEvents = state.pendingSettlementEvents && state.pendingSettlementEvents.length > 0;
                const okText = hasMoreEvents ? ('OK (dal코칤 event 캜ek치)') : 'OK';
                buttons = `<button class="btn" onclick="closeModal(); ${hasMoreEvents ? 'setTimeout(triggerNextSettlementEvent, 300);' : ''}" style="width: 100%;">${okText}</button>`;
            }
            
            // Syst칠mov치 notifikace
            sendSystemNotification(`${event.icon} ${event.name}`, event.desc, event.icon);
            
            // P콏idej do logu osady S DETAILY (v쬯y, i kdy nezobraz칤me modal)
            if (!state.settlement.eventLog) state.settlement.eventLog = [];
            state.settlement.eventLog.unshift({
                id: event.id,
                name: event.name,
                icon: event.icon,
                desc: event.desc,
                details: eventDetails, // Konkr칠tn칤 detaily (kdo um콏el, co ukradli, atd.)
                day: state.time.days,
                timestamp: Date.now()
            });
            // Max 15 z치znam콢
            if (state.settlement.eventLog.length > 15) state.settlement.eventLog.pop();
            
            addLog(`${event.icon} ${event.name}: ${event.desc}`, event.icon);
            
            // Nezobrazuj modal pokud:
            // 1. Prob칤h치 akce (lov, t캩쬭a, atd.)
            // 2. Prob칤h치 boj
            // 3. Hr치캜 nen칤 v osad캩
            const isActionInProgress = state.currentAction && state.currentAction.endTime > Date.now();
            const inCombat = isInCombat();
            const inSettlement = state.world?.currentLocation === 'shelter' || state.world?.currentLocation === 'settlement';
            
            if (isActionInProgress || inCombat) {
                // Jen toast notifikace, modal se nezobraz칤
                notifyWarning(`${event.icon} ${event.name}`, event.desc);
                // Ulo event pro pozd캩j코칤 zobrazen칤 (voliteln칠)
                if (!state.pendingSettlementEvents) state.pendingSettlementEvents = [];
                // Event u byl aplikov치n, jen nezobraz칤me modal
                return;
            }
            
            // Pokud hr치캜 nen칤 v osad캩, zobraz jen toast
            if (!inSettlement) {
                notifyWarning(`${event.icon} Osada: ${event.name}`, event.desc);
                return;
            }
            
            setTimeout(() => {
                showModal(`${event.icon} ${event.name}`, message + buttons, true);
            }, 500);
        }
        
        // === SETTLEMENT CHOICE HANDLER ===
        // Zobrazen칤 detailu ud치losti z historie podle indexu
        function showEventDetailByIndex(index) {
            const eventLog = state.settlement?.eventLog;
            if (!eventLog || !eventLog[index]) return;
            
            const e = eventLog[index];
            showEventDetail(e.id, e.name, e.icon, e.desc, e.details, e.day);
        }
        
        // Zobrazen칤 detailu ud치losti z historie
        function showEventDetail(eventId, name, icon, desc, details, day) {
            const event = SETTLEMENT_EVENTS?.find(e => e.id === eventId);
            
            showModal(`${icon} ${name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${icon}</div>
                    <div style="color: #888; font-size: 0.85rem;">Den ${day}</div>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ddd; margin: 0;">${desc || '콯치dn칳 popis'}</p>
                </div>
                
                ${details ? `
                    <div style="background: #2a1a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #ff9800;">
                        <p style="color: #ff9800; margin: 0; font-size: 0.9rem;">游늶 ${details}</p>
                    </div>
                ` : ''}
                
                ${event ? `
                    <div style="background: #0a1a0a; padding: 0.8rem; border-radius: 8px; border: 1px solid #333;">
                        <p style="color: #888; font-size: 0.8rem; margin: 0 0 0.5rem 0;">좶잺 O ud치losti:</p>
                        <p style="color: #8bc34a; font-size: 0.85rem; margin: 0;">${event.desc || ''}</p>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zav콏칤t</button>
            `);
        }
        
        function settlementChoice(choice) {
            closeModal();
            
            // Po rozhodnut칤 zobraz dal코칤 event
            setTimeout(triggerNextSettlementEvent, 500);
            
            let result = '';
            let resultType = 'info'; // 'success', 'warning', 'danger'
            
            switch(choice) {
                // REFUGEE
                case 'refugee_accept':
                    if (true) {
                        const randomType = SETTLER_TYPES[Math.floor(Math.random() * SETTLER_TYPES.length)];
                        const newSettler = { type: randomType.id, name: generateSettlerName(), hp: 100, maxHp: 100, morale: 70 };
                        state.settlement.settlers.push(newSettler);
                        state.settlement.resources.food = Math.max(0, state.settlement.resources.food - 10);
                        result = `${randomType.icon} ${newSettler.name} se p콏idal k osad캩!`;
                        resultType = 'success';
                    } else {
                        result = 'Osada je pln치!';
                        resultType = 'warning';
                    }
                    break;
                case 'refugee_reject':
                    if (Math.random() < 0.3) {
                        result = '丘멆잺 Uprchl칤k se vr치til s bandity! P콏iprav se na n치jezd!';
                        resultType = 'danger';
                        setTimeout(() => startSettlementRaid(), 2000);
                    } else {
                        result = 'Uprchl칤k ode코el.';
                    }
                    break;
                    
                // DOG
                case 'dog_adopt':
                    if (!state.settlement.dog) {
                        state.settlement.dog = { name: 'Rex', defense: 5, adopted: Date.now() };
                        state.settlement.resources.food = Math.max(0, state.settlement.resources.food - 5);
                        result = '游냇 Rex je te캞 str치쬹칤 pes osady! (+5 obrana)';
                        resultType = 'success';
                    } else {
                        result = 'U m치코 psa!';
                    }
                    break;
                case 'dog_feed':
                    state.settlement.resources.food = Math.max(0, state.settlement.resources.food - 3);
                    if (Math.random() < 0.5) {
                        result = 'Pes odb캩hl... ale mo쬹치 se vr치t칤!';
                        state.settlement.dogReturn = Date.now() + 3 * 24 * 60 * 60 * 1000;
                    } else {
                        result = 'Pes spokojen캩 odb캩hl.';
                    }
                    break;
                case 'dog_ignore':
                    state.settlement.morale = Math.max(0, state.settlement.morale - 5);
                    result = 'Osadn칤ci jsou smutn칤 쬰 jsi psa vyhnal. (-5 morale)';
                    resultType = 'warning';
                    break;
                    
                // MYSTERY TRADER
                case 'mystery_accept':
                    if (state.money >= 100) {
                        state.money -= 100;
                        if (state.settlement.mysteryOffer === 'good') {
                            const goodItems = ['legendary_weapon', 'rare_armor', 'crystal'];
                            const item = goodItems[Math.floor(Math.random() * goodItems.length)];
                            state.resources[item] = (state.resources[item] || 0) + 1;
                            result = `游꿀 Skv캩l칳 obchod! Dostal jsi ${item}!`;
                            resultType = 'success';
                        } else {
                            result = '游땸 Podvod! Dostal jsi jen kameny...';
                            resultType = 'danger';
                        }
                    } else {
                        result = ('Nem치코 dost pen캩z!');
                        resultType = 'warning';
                    }
                    break;
                case 'mystery_reject':
                    result = 'Z치hadn치 postava zmizela v noci...';
                    break;
                    
                // WOUNDED
                case 'wounded_help':
                    const hasMedkit = state.inv.find(i => i.id === 'medkit');
                    if (hasMedkit) {
                        hasMedkit.count = (hasMedkit.count || 1) - 1;
                        if (hasMedkit.count <= 0) state.inv = state.inv.filter(i => i.id !== 'medkit');
                        if (Math.random() < 0.7) {
                            const reward = Math.floor(Math.random() * 150) + 50;
                            addMoney(reward);
                            result = `Cizinec se uzdravil a dal ti ${reward} 游눯 jako pod캩kov치n칤!`;
                            resultType = 'success';
                            state.settlement.morale = Math.min(100, state.settlement.morale + 10);
                        } else {
                            result = 'Cizinec zem콏el... ale osadn칤ci oce켿uj칤 tvou snahu. (+morale)';
                            state.settlement.morale = Math.min(100, state.settlement.morale + 5);
                        }
                    } else {
                        result = 'Nem치코 medkit!';
                        resultType = 'warning';
                    }
                    break;
                case 'wounded_loot':
                    const lootMoney = Math.floor(Math.random() * 50) + 10;
                    addMoney(lootMoney);
                    state.settlement.morale = Math.max(0, state.settlement.morale - 15);
                    result = `Na코el jsi ${lootMoney} 游눯... ale osadn칤ci t캩 odsuzuj칤. (-15 morale)`;
                    resultType = 'warning';
                    break;
                case 'wounded_ignore':
                    result = 'Ode코el jsi...';
                    break;
                    
                // BANDIT
                case 'bandit_pay':
                    if (state.money >= 50) {
                        state.money -= 50;
                        state.settlement.banditProtection = Date.now() + 7 * 24 * 60 * 60 * 1000;
                        result = 'Zaplatil jsi v칳paln칠. T칳den klid od n치jezd콢.';
                    } else {
                        result = 'Nem치코 dost! Bandita se na코tval!';
                        resultType = 'danger';
                        setTimeout(() => startSettlementRaid(), 2000);
                    }
                    break;
                case 'bandit_fight':
                    result = '丘덢잺 Bandita zavolal posily! P콏iprav se na boj!';
                    resultType = 'danger';
                    setTimeout(() => startSettlementRaid(), 1000);
                    break;
                case 'bandit_trick':
                    if (state.char.attrs.int >= 7) {
                        addMoney(50);
                        result = '游꿠 P콏elstil jsi ho! Ukradl jsi MU pen칤ze! (+50 游꿞)';
                        resultType = 'success';
                    } else {
                        result = 'Nepoda콏ilo se... bandita prohl칠dl tv콢j trik!';
                        resultType = 'danger';
                        setTimeout(() => startSettlementRaid(), 2000);
                    }
                    break;
                    
                // CHILD
                case 'child_adopt':
                    state.settlement.morale = Math.min(100, state.settlement.morale + 20);
                    state.settlement.child = { name: 'Mal칳 ' + generateSettlerName().split(' ')[0], adopted: Date.now() };
                    result = '游놌 D칤t캩 m치 nov칳 domov! Osadn칤ci jsou dojat칤. (+20 morale)';
                    resultType = 'success';
                    break;
                case 'child_send':
                    result = 'Poslal jsi d칤t캩 k bezpe캜n캩j코칤m obchodn칤k콢m.';
                    state.settlement.morale = Math.min(100, state.settlement.morale + 5);
                    break;
                    
                // DISPUTE
                case 'dispute_first':
                case 'dispute_second':
                    state.settlement.morale = Math.max(0, state.settlement.morale - 5);
                    result = 'Rozhodl jsi spor. Jeden osadn칤k je nespokojen칳. (-5 morale)';
                    resultType = 'warning';
                    break;
                case 'dispute_split':
                    state.settlement.morale = Math.min(100, state.settlement.morale + 5);
                    result = 'Spravedliv칠 rozd캩len칤! Oba jsou spokojen칤. (+5 morale)';
                    resultType = 'success';
                    break;
                    
                // SCAVENGER BOX
                case 'scavenger_open':
                    if (Math.random() < 0.6) {
                        const treasures = ['metal', 'electronics', 'chemicals', 'fuel'];
                        const t = treasures[Math.floor(Math.random() * treasures.length)];
                        const amt = Math.floor(Math.random() * 15) + 5;
                        state.resources[t] = (state.resources[t] || 0) + amt;
                        result = `游닍 Poklad! +${amt} ${t}!`;
                        resultType = 'success';
                    } else {
                        const damage = 20;
                        const oldHp = state.char.hp;
                        state.char.hp = Math.max(1, state.char.hp - damage);
                        result = `游눤 Past! Exploze ti ubl칤쬴la! (-${damage} HP, ${oldHp}  ${state.char.hp})`;
                        resultType = 'danger';
                        // Vizu치ln칤 efekt
                        if (typeof screenShake === 'function') screenShake(5, 200);
                        if (typeof showFloatingNumber === 'function') showFloatingNumber(damage, 'damage');
                        SoundSystem.play('damage');
                    }
                    break;
                case 'scavenger_sell':
                    addMoney(50);
                    result = 'Prodal jsi bednu za 50 游꿞. Jistota je jistota.';
                    break;
                case 'scavenger_careful':
                    if (state.char.attrs.int >= 6) {
                        const isGood = Math.random() < 0.7;
                        if (isGood) {
                            const amt = Math.floor(Math.random() * 20) + 10;
                            state.resources.metal = (state.resources.metal || 0) + amt;
                            result = `游댌 Opatrn캩 jsi ji otev콏el. +${amt} kov!`;
                            resultType = 'success';
                        } else {
                            result = '游댌 Zjistil jsi 쬰 je to past a vyhodil jsi ji.';
                        }
                    } else {
                        result = 'Tv치 inteligence nesta캜칤 na bezpe캜n칠 prozkoum치n칤...';
                        resultType = 'warning';
                    }
                    break;
            }
            
            // Zobraz v칳sledek
            if (result) {
                const color = resultType === 'success' ? '#8bc34a' : resultType === 'danger' ? '#c62828' : resultType === 'warning' ? '#ff9800' : '#888';
                notifySuccess('V칳sledek', result);
                addLog(result, '游늶');
            }
            
            renderFull();
        }
        
        // P콏ivol치n칤 karavany za pen칤ze
        function summonCaravan() {
            // Kontrola otev칤rac칤 doby - karavana cestuje v noci
            if (!isShopOpen('caravan')) {
                showModal('游깿 Karavana cestuje', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游냙游깿</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Karavana je na cest캩!</p>
                        <p style="color: #888; margin: 1rem 0;">Obchodn칤ci cestuj칤 v noci a nelze je p콏ivolat.</p>
                        <p style="color: #666; font-size: 0.9rem;">낋 Dostupn치: 08:00 - 20:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu치ln칤 캜as: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const cost = 100;
            const hasCommTower = state.base?.includes('comms') || state.settlement?.buildings?.includes('comms');
            const hasPowerForTower = hasCommTower && hasPower();
            
            const caravanTexts = {
                inArea: 'Karavana je v oblasti!', remaining: 'Zb칳v치', minutes: 'minut',
                noCaravan: '콯치dn치 karavana v osad캩', canSummon: 'M콢쬰코 p콏ivolat karavanu nebo po캜kat na n치hodnou n치v코t캩vu.',
                howWork: 'Jak funguj칤 karavany', autoSpawn: 'Automatick칳 spawn', chanceEvery: '코ance ka쬯칳ch', minutesWord: 'minut',
                randomEvent: 'Random event', chanceWhile: '코ance p콏i cestov치n칤',
                radio: 'Vys칤la캜ka', summonFor: 'P콏ivol치n칤 na', paid: 'Zaplacen칤', hour: '1 hodinu',
                bonusChance: 'Bonusy k 코anci', contactNetwork: 'S칤콘 kontakt콢', tradeStation: 'Obchodn칤 stanice',
                traderBonuses: 'Bonusy obchodn칤ka', discount: 'Sleva na n치kup', cheaperGoods: '20-25% levn캩j코칤 zbo쮂',
                specialGoods: 'Speci치ln칤 zbo쮂', rareItems: 'vz치cn칠 p콏edm캩ty', reputation: 'Reputace', improvesTrade: 'zlep코uje vztahy s Obchodn칤 gildou',
                summonCaravan: 'P콏ivolat karavanu', commTower: 'Komunika캜n칤 v캩', built: 'postavena', missing: 'chyb칤',
                power: 'Elekt콏ina pro v캩', working: 'funguje', noPower: 'bez proudu!',
                money: 'pen캩z', youHave: 'm치코', youHaveOnly: 'm치코 jen',
                buildTip: 'Postav Komunika캜n칤 v캩 v sekci Budovy (level 4).',
                powerTip: 'V캩 pot콏ebuje 2丘. Postav Gener치tor nebo Sol치rn칤 panely.',
                traderRep: 'Reputace s Obchodn칤 gildou', visitCaravan: 'Nav코t칤vit karavanu', summonBtn: 'P콏ivolat karavanu'
            };
            
            // Zkontroluj ob캩 varianty karavany
            const caravanActive = (state.caravan?.active && Date.now() < state.caravan.until) || 
                                  (state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until);
            const caravanUntil = state.caravan?.active ? state.caravan.until : state.settlement.visitingMerchant?.until;
            const timeRemaining = caravanActive ? Math.floor((caravanUntil - Date.now()) / 60000) : 0; // minuty
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Hlavn칤 ikona
            html += '<div style="text-align: center; margin-bottom: 1rem;">';
            html += '<div style="font-size: 4rem;">游냙</div>';
            html += '</div>';
            
            // Status karavany
            if (caravanActive) {
                html += `
                    <div style="background: linear-gradient(135deg, #1a2a1a 0%, #0d150d 100%); padding: 1rem; border-radius: 10px; border: 2px solid #4caf50; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 1.5rem; color: #8bc34a; font-weight: bold;">九 ${caravanTexts.inArea}</div>
                        <p style="margin: 0.5rem 0 0 0; color: #aaa;">${caravanTexts.remaining}: <strong style="color: #ffd700;">${timeRemaining} ${caravanTexts.minutes}</strong></p>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: linear-gradient(135deg, #2a2a1a 0%, #15150d 100%); padding: 1rem; border-radius: 10px; border: 2px solid #7c6a4a; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 1.2rem; color: #ff9800;">仇 ${caravanTexts.noCaravan}</div>
                        <p style="margin: 0.5rem 0 0 0; color: #888;">${caravanTexts.canSummon}</p>
                    </div>
                `;
            }
            
            // Info o syst칠mu
            html += '<h4 style="color: var(--toxic-green); margin: 1rem 0 0.5rem 0;">游늵 ' + caravanTexts.howWork + '</h4>';
            html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem;">';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>낋 ' + caravanTexts.autoSpawn + ':</strong> <span style="color: #ffd700;">20%</span> ' + caravanTexts.chanceEvery + ' 24 hodin</p>';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>游 ' + caravanTexts.randomEvent + ':</strong> <span style="color: #ffd700;">10%</span> ' + caravanTexts.chanceWhile + '</p>';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>游니 ' + caravanTexts.radio + ':</strong> ' + caravanTexts.summonFor + ' 10 ' + caravanTexts.minutesWord + '</p>';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>游눯 ' + caravanTexts.paid + ':</strong> ' + caravanTexts.summonFor + ' ' + caravanTexts.hour + '</p>';
            html += '<p style="margin: 0; border-top: 1px solid #333; padding-top: 0.5rem; color: #888;"><strong>' + caravanTexts.bonusChance + ':</strong></p>';
            html += '<p style="margin: 0.3rem 0 0 0; font-size: 0.8rem;">游낓 Scout lvl 4: +10% | 游님 ' + caravanTexts.contactNetwork + ': +20% | 游낅 ' + caravanTexts.tradeStation + ': +15%</p>';
            html += '</div>';
            
            // Bonusy od karavany
            html += '<h4 style="color: var(--warning-yellow); margin: 1rem 0 0.5rem 0;">游꾸 ' + caravanTexts.traderBonuses + '</h4>';
            html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">';
            html += '<p style="margin: 0 0 0.3rem 0;">游눯 <strong>' + caravanTexts.discount + '</strong> - ' + caravanTexts.cheaperGoods + '</p>';
            html += '<p style="margin: 0 0 0.3rem 0;">游닍 <strong>' + caravanTexts.specialGoods + '</strong> - ' + caravanTexts.rareItems + '</p>';
            html += '<p style="margin: 0;">游낅 <strong>' + caravanTexts.reputation + '</strong> - ' + caravanTexts.improvesTrade + '</p>';
            html += '</div>';
            
            // P콏ivol치n칤 karavany
            html += '<h4 style="color: #64b5f6; margin: 1rem 0 0.5rem 0;">游니 ' + caravanTexts.summonCaravan + '</h4>';
            html += '<div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
            
            // Checklist po쬬davk콢
            html += '<div style="margin-bottom: 0.8rem;">';
            html += `<p style="margin: 0 0 0.3rem 0; color: ${hasCommTower ? '#8bc34a' : '#c62828'};">${hasCommTower ? '九' : '仇'} ${caravanTexts.commTower} ${hasCommTower ? '(' + caravanTexts.built + ')' : '(' + caravanTexts.missing + ')'}</p>`;
            if (hasCommTower) {
                html += `<p style="margin: 0 0 0.3rem 0; color: ${hasPowerForTower ? '#8bc34a' : '#c62828'};">${hasPowerForTower ? '九' : '仇'} ${caravanTexts.power} ${hasPowerForTower ? '(' + caravanTexts.working + ')' : '(' + caravanTexts.noPower + ')'}</p>`;
            }
            html += `<p style="margin: 0; color: ${getMoney() >= cost ? '#8bc34a' : '#c62828'};">${getMoney() >= cost ? '九' : '仇'} ${cost} ${caravanTexts.money} ${getMoney() >= cost ? '(' + caravanTexts.youHave + ' ' + getMoney() + ')' : '(' + caravanTexts.youHaveOnly + ' ' + getMoney() + ')'}</p>`;
            html += '</div>';
            
            if (!hasCommTower) {
                html += '<p style="color: #ff9800; font-size: 0.85rem; margin: 0;">游눠 ' + caravanTexts.buildTip + '</p>';
            } else if (!hasPowerForTower) {
                html += '<p style="color: #ff9800; font-size: 0.85rem; margin: 0;">游눠 ' + caravanTexts.powerTip + '</p>';
            }
            
            html += '</div>';
            
            // Reputace s obchodn칤ky
            const traderRep = getReputation('traders');
            const traderLevel = getReputationLevel('traders');
            html += '<h4 style="color: #ffd700; margin: 1rem 0 0.5rem 0;">游낅 ' + caravanTexts.traderRep + '</h4>';
            html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">`;
            html += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
            html += `<span style="color: ${traderLevel.color};">${traderLevel.icon} ${traderLevel.name}</span>`;
            html += `<span style="color: #888;">${traderRep > 0 ? '+' : ''}${traderRep}/100</span>`;
            html += `</div>`;
            html += `<div style="height: 6px; background: #0a0a0a; border-radius: 3px; margin-top: 0.5rem; overflow: hidden;">`;
            html += `<div style="height: 100%; width: ${((traderRep + 100) / 200) * 100}%; background: linear-gradient(90deg, #8B0000, #f44336, #ff9800, #4caf50, #ffd700);"></div>`;
            html += `</div>`;
            if (traderLevel.id === 'friendly' || traderLevel.id === 'allied') {
                html += `<p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #8bc34a;">${getFactionBonusText('traders')}</p>`;
            }
            html += '</div>';
            
            html += '</div>';
            
            // Tla캜칤tka
            let buttons = '';
            if (caravanActive) {
                buttons = '<button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">游 ' + caravanTexts.visitCaravan + '</button>';
                buttons += '<button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">' + ('Zav콏칤t') + '</button>';
            } else {
                const canSummon = hasCommTower && hasPowerForTower && getMoney() >= cost;
                buttons = `<button class="btn" onclick="doSummonCaravan()" ${!canSummon ? 'disabled' : ''} style="width: 100%; margin-bottom: 0.5rem; ${!canSummon ? 'opacity: 0.5;' : 'background: var(--rust);'}">游냙 ${caravanTexts.summonBtn} (${cost} 游눯)</button>`;
                buttons += '<button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">' + ('Zav콏칤t') + '</button>';
            }
            
            showModal('游냙 Obchodn칤 karavana', html + buttons);
        }
        
        function doSummonCaravan() {
            // Kontrola otev칤rac칤 doby
            if (!isShopOpen('caravan')) {
                notifyWarning('Karavana cestuje', 'Zkus to mezi 08:00 a 20:00');
                return;
            }
            
            const cost = 100;
            const hasCommTower = state.base?.includes('comms') || state.settlement?.buildings?.includes('comms');
            
            if (!hasCommTower || !hasPower() || getMoney() < cost) return;
            
            removeMoney(cost);
            
            // Pou쬴j glob치ln칤 karavana syst칠m
            state.caravan = state.caravan || { active: false, until: 0, lastCheck: Date.now() };
            state.caravan.active = true;
            state.caravan.until = Date.now() + 60 * 60 * 1000; // 1 hodina (del코칤 proto쬰 zaplacena)
            
            // Pro zp캩tnou kompatibilitu
            state.settlement.visitingMerchant = {
                until: state.caravan.until,
                discount: 0.25
            };
            
            changeReputation('traders', 3, 'p콏ivol치n칤 karavany');
            
            closeModal();
            showModal('游냙 Karavana dorazila!', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 4rem;">游냙</div>' +
                '<h3 style="color: #8bc34a;">Obchodn칤 karavana je zde!</h3>' +
                '<p style="color: #ffd700;">Speci치ln칤 sleva 25% na v코e!</p>' +
                '<p style="color: #888;">Z콢stane 1 hodinu.</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">游 Otev콏칤t obchod</button>'
            );
            
            addLog('游냙 P콏ivol치na obchodn칤 karavana!', '游냙');
            renderFull();
        }
        
        function generateSettlerName() {
            const names = ['Adam', 'Eva', 'Jan', 'Marie', 'Petr', 'Anna', 'Pavel', 'Lucie', 'Tom치코', 'Kate콏ina', 
                          'Martin', 'Tereza', 'Jakub', 'Mark칠ta', 'David', 'Veronika', 'Filip', 'Michaela',
                          'Ond콏ej', 'Barbora', 'Marek', 'Simona', 'Luk치코', 'Petra', 'Mat캩j', 'Nikola'];
            return names[Math.floor(Math.random() * names.length)];
        }
        
        // === N츼POV캨DA OSADY ===
        // Oprava u kov치콏e v osad캩 (zdarma)
        function repairAtBlacksmith() {
            // Kontrola jestli jsme v osad캩
            const currentLoc = state.world?.currentLocation || '';
            const inSettlement = currentLoc === 'shelter' || currentLoc === 'settlement';
            if (!inSettlement) {
                showModal('仇 Mus칤코 b칳t v osad캩', 'Kov치콏 je v osad캩. Vra콘 se do osady, abys mohl opravit vybaven칤.');
                return;
            }
            
            // Kontrola jestli m치me kov치콏e
            const hasBlacksmith = state.settlement?.settlers?.some(s => s.type === 'blacksmith');
            if (!hasBlacksmith) {
                showModal('仇 Chyb칤 kov치콏', 'Nem치코 kov치콏e v osad캩! Najmi si ho za 1200 游눯.');
                return;
            }
            
            // Najdi po코kozen칠 vybaven칤
            const damagedItems = [];
            if (state.equipped?.weapon?.durability < state.equipped?.weapon?.maxDurability) {
                damagedItems.push({ item: state.equipped.weapon, type: 'equipped', slot: 'weapon' });
            }
            if (state.equipped?.armor?.durability < state.equipped?.armor?.maxDurability) {
                damagedItems.push({ item: state.equipped.armor, type: 'equipped', slot: 'armor' });
            }
            state.inv.forEach((item, idx) => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    damagedItems.push({ item, type: 'inventory', index: idx });
                }
            });
            
            if (damagedItems.length === 0) {
                showModal('丘뉦잺 Kov치콏', '九 Ve코ker칠 vybaven칤 je v po콏치dku!<br><br><span style="color: #888;">Kov치콏 nem치 co opravovat.</span>');
                return;
            }
            
            let content = `
                <p style="color: #8bc34a; margin-bottom: 1rem;">游 Oprava zdarma d칤ky kov치콏i!</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            `;
            
            damagedItems.forEach((di, idx) => {
                content += `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px;">
                        <span>${di.item.icon} ${di.item.name}</span>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: #ff9800;">${di.item.durability}/${di.item.maxDurability}</span>
                            <button class="btn" onclick="repairFreeBlacksmith(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4CAF50;">
                                Opravit
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            content += `
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="repairAllBlacksmith()" style="flex: 1; background: #2196f3;">游댢 Opravit v코e</button>
                    <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;"> Zav콏칤t</button>
                </div>
            `;
            
            window._blacksmithDamagedItems = damagedItems;
            showModal('丘뉦잺 Kov치콏 - Oprava', content);
        }
        
        function repairFreeBlacksmith(damagedIndex) {
            if (!window._blacksmithDamagedItems) return;
            const di = window._blacksmithDamagedItems[damagedIndex];
            if (!di) return;
            
            di.item.durability = di.item.maxDurability;
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('丘뉦잺 Opraveno!', `${di.item.icon} ${di.item.name}<br><span style="color: #8bc34a;">Pln치 trvanlivost!</span>`);
            delete window._blacksmithDamagedItems;
            renderFull();
        }
        
        function repairAllBlacksmith() {
            if (!window._blacksmithDamagedItems) return;
            
            let count = 0;
            window._blacksmithDamagedItems.forEach(di => {
                di.item.durability = di.item.maxDurability;
                count++;
            });
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('丘뉦잺 V코e opraveno!', `游댢 Opraveno ${count} p콏edm캩t콢!<br><span style="color: #8bc34a;">V코e m치 plnou trvanlivost.</span>`);
            delete window._blacksmithDamagedItems;
            renderFull();
        }
        
        // L칠캜en칤 u medika v osad캩
        function healAtMedic() {
            // Kontrola jestli je hr치캜 v osad캩
            const inBase = state.world?.currentLocation === 'shelter' || state.world?.currentLocation === 'settlement' || state.map?.inBase;
            if (!inBase) {
                showModal('仇 P콏칤li코 daleko', 'Mus칤코 b칳t v osad캩, aby t캩 medik mohl o코et콏it!');
                return;
            }
            
            const hasMedic = state.settlement?.settlers?.some(s => s.type === 'medic_s');
            if (!hasMedic) {
                showModal('仇 Chyb칤 medik', 'Nem치코 medika v osad캩! Najmi si ho za 1000 游눯.');
                return;
            }
            
            if (state.char.hp >= state.char.maxHp) {
                showModal('丘됊잺 Medik', '九 Jsi zcela zdrav칳!<br><br><span style="color: #888;">Medik nem치 co l칠캜it.</span>');
                return;
            }
            
            const healAmount = Math.floor(state.char.maxHp * 0.5); // 50% max HP
            const actualHeal = Math.min(healAmount, state.char.maxHp - state.char.hp);
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
            
            SoundSystem.play('pickup');
            showFloatingNumber(actualHeal, 'heal');
            showModal('丘됊잺 Medik', `Medik t캩 o코et콏il!<br><span style="color: #8bc34a;">仇벒잺 +${actualHeal} HP</span><br><br><span style="color: #888;">HP: ${state.char.hp}/${state.char.maxHp}</span>`);
            renderFull();
        }
        
        // Obchod v osad캩
        function tradeAtSettlement() {
            // Obchodn칤k v osad캩 funguje i vzd치len캩 - prodej/n치kup jde p콏es sklad osady
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            // Kontrola otev칤rac칤 doby
            if (!isShopOpen('settlement')) {
                showModal('游깿 Zav콏eno', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游땺</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Obchodn칤k sp칤!</p>
                        <p style="color: #888; margin: 1rem 0;">낋 Otev칤rac칤 doba: 06:00 - 22:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu치ln칤 캜as: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader_s');
            if (!hasTrader) {
                showModal('仇 Chyb칤 obchodn칤k', 'Nem치코 obchodn칤ka v osad캩! Najmi si ho za 1500 游눯.');
                return;
            }
            
            // Generuj zbo쮂 pokud nem치me nebo je star칳
            if (!state.settlementShop || !state.settlementShop.items || state.settlementShop.day !== state.time.days) {
                generateSettlementShop();
            }
            
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25; // +25% ceny p콏i prodeji
            const buyDiscount = 0.9; // -10% ceny p콏i n치kupu
            
            let content = `
                <p style="color: #8bc34a; margin-bottom: 0.5rem;">游눯 Pen칤ze: ${getMoney()}</p>
                <p style="color: #ff9800; font-size: 0.85rem; margin-bottom: 0.5rem;">游낑勇 Obchodn칤k: +25% prodej, -10% n치kup!</p>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('shopHoursInfo').style.display = document.getElementById('shopHoursInfo').style.display === 'none' ? 'block' : 'none'">
                        <span style="color: #888; font-size: 0.8rem;">游뎷 Otev칤rac칤 doby obchod콢</span>
                        <span style="color: #666; font-size: 0.7rem;">郊</span>
                    </div>
                    <div id="shopHoursInfo" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                        <div style="display: grid; gap: 0.3rem; font-size: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('settlement') ? '#8bc34a' : '#666'};">
                                <span>游 Obchod v osad캩</span><span>06:00 - 22:00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('caravan') ? '#8bc34a' : '#666'};">
                                <span>游냙 Karavana</span><span>08:00 - 20:00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('military') ? '#8bc34a' : '#666'};">
                                <span>游꿌勇 Vojensk칳 tr칠nink</span><span>06:00 - 18:00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('mutants') ? '#8bc34a' : '#666'};">
                                <span>驕勇 Mutant칤 trh</span><span>20:00 - 06:00 游깿</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: #8bc34a;">
                                <span>游빍 Laborato콏 v캩dc콢</span><span>non-stop 九</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('wandering') ? '#8bc34a' : '#666'};">
                                <span>游냙 Potuln칳 obchodn칤k</span><span>10:00 - 16:00</span>
                            </div>
                        </div>
                        <p style="color: #555; font-size: 0.7rem; margin: 0.5rem 0 0 0; text-align: center;">Aktu치ln칤 캜as: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showSettlementShopBuy()" style="flex: 1; background: #2e7d32;">${'游 Koupit'}</button>
                    <button class="btn" onclick="showSettlementShopSell()" style="flex: 1; background: #ff9800;">${'游눯 Prodat'}</button>
                </div>
                
                <div id="settlementShopContent">
                    <p style="color: #888; text-align: center;">Vyber akci...</p>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;"> Zav콏칤t</button>
                    ${(() => {
                        const lastRefresh = state.lastShopRefresh || 0;
                        const canRefresh = Date.now() - lastRefresh > 24 * 60 * 60 * 1000;
                        if (canRefresh) {
                            return '<button class="btn" onclick="forceRefreshSettlementShop()" style="padding: 0.5rem; background: #2196f3;" title="Obnovit sortiment (1x za 24h)">游댃</button>';
                        } else {
                            const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastRefresh)) / 3600000);
                            return '<button class="btn" style="padding: 0.5rem; background: #333; opacity: 0.6;" disabled title="Dal코칤 refresh za ' + hoursLeft + 'h">游댃 ' + hoursLeft + 'h</button>';
                        }
                    })()}
                </div>
            `;
            
            showModal('游눯 Osadn칤 obchod', content);
        }
        
        function forceRefreshSettlementShop() {
            const lastRefresh = state.lastShopRefresh || 0;
            if (Date.now() - lastRefresh < 24 * 60 * 60 * 1000) {
                const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastRefresh)) / 3600000);
                notifyWarning('낍 Po캜kej', `Dal코칤 refresh za ${hoursLeft}h`);
                return;
            }
            
            state.lastShopRefresh = Date.now();
            state.settlementShop = null;
            generateSettlementShop();
            closeModal();
            openSettlementShop();
            notifySuccess('游댃 Obchod obnoven', 'Nov칳 sortiment!');
        }
        
        function generateSettlementShop() {
            // Generuj n치hodn칠 zbo쮂
            const possibleItems = ITEMS.filter(i => i.price && i.price > 0 && i.price < 500 && !i.cantBuy);
            const shopItems = [];
            
            // Vyber 8-12 n치hodn칳ch polo쬰k
            const count = 8 + Math.floor(Math.random() * 5);
            for (let i = 0; i < count && possibleItems.length > 0; i++) {
                const idx = Math.floor(Math.random() * possibleItems.length);
                const item = possibleItems.splice(idx, 1)[0];
                shopItems.push({
                    ...item,
                    stock: 1 + Math.floor(Math.random() * 3) // 1-3 kus콢
                });
            }
            
            state.settlementShop = {
                items: shopItems,
                day: state.time.days
            };
        }
        
        function showSettlementShopBuy() {
            let buyDiscount = 0.9; // Z치kladn칤 sleva v osad캩
            
            // Sleva od Obchodn칤 gildy
            const tradersRep = state.factions?.traders || 0;
            if (tradersRep >= 100) {
                buyDiscount *= 0.6; // Spojenec: -40%
            } else if (tradersRep >= 50) {
                buyDiscount *= 0.8; // P콏치telsk칳: -20%
            }
            
            let html = '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            if (!state.settlementShop?.items?.length) {
                html += '<p style="color: #666; text-align: center;">Obchod je pr치zdn칳. P콏ij캞 z칤tra!</p>';
            } else {
                state.settlementShop.items.forEach((item, idx) => {
                    const price = Math.floor((item.price || 10) * buyDiscount);
                    const canBuy = getMoney() >= price && item.stock > 0;
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.3rem;">
                            <div>
                                <span style="font-size: 1.2rem;">${item.icon}</span>
                                <span style="font-size: 0.85rem;">${item.name}</span>
                                <span style="color: #888; font-size: 0.7rem;">(${item.stock}x)</span>
                            </div>
                            <button class="btn" onclick="buyFromSettlement(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: ${canBuy ? '#2e7d32' : '#444'};" ${canBuy ? '' : 'disabled'}>
                                游눯${price}
                            </button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('settlementShopContent').innerHTML = html;
        }
        
        function showSettlementShopSell() {
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25;
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            let html = '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Info o re쬴mu
            if (!isInShelter) {
                html += '<p style="color: #ff9800; font-size: 0.8rem; text-align: center; margin-bottom: 0.5rem;">游닍 Prod치v치코 ze skladu osady (nejsi v osad캩)</p>';
            }
            
            // Pomocn치 funkce pro z칤sk치n칤 ceny itemu
            const getItemPrice = (item) => {
                if (item.price && item.price > 0) return item.price;
                const itemDef = ITEMS.find(i => i.id === item.id);
                return itemDef?.price || 0;
            };
            
            // Zdroj v캩c칤 - invent치콏 kdy v osad캩, sklad osady kdy mimo
            const sourceItems = isInShelter ? state.inv : (state.baseItems || []);
            const sourceType = isInShelter ? 'inv' : 'base';
            
            // Prodejn칠 v캩ci - bez fromCaravan, fromShop, fromSettlement
            const sellableItems = sourceItems.filter(i => getItemPrice(i) > 0 && !isItemEquipped(i) && !i.fromCaravan && !i.fromShop && !i.fromSettlement);
            const lockedItems = sourceItems.filter(i => getItemPrice(i) > 0 && !isItemEquipped(i) && (i.fromCaravan || i.fromShop || i.fromSettlement));
            
            if (sellableItems.length === 0 && lockedItems.length === 0) {
                html += `<p style="color: #666; text-align: center;">${isInShelter ? 'Nem치코 nic na prodej.' : 'Sklad osady je pr치zdn칳.'}</p>`;
            } else {
                sellableItems.forEach((item) => {
                    let sellPrice = Math.floor(getItemPrice(item) * 0.35 * traderBonus);
                    
                    if (item.durability !== undefined && item.maxDurability) {
                        const durabilityRatio = item.durability / item.maxDurability;
                        sellPrice = Math.floor(sellPrice * durabilityRatio);
                        if (sellPrice < 1) sellPrice = 1;
                    }
                    
                    const realIdx = sourceItems.indexOf(item);
                    
                    let specialInfo = '';
                    const itemData = ITEMS.find(i => i.id === item.id) || item;
                    if (itemData.special || item.special) {
                        const specialName = itemData.special || item.special;
                        const specialLabels = {
                            'speed_bonus': '游끢+10% rychlost',
                            'dodge_bonus': '游눧+10% 칰hyb',
                            'combat_stance': '丘덢잺+5% krit',
                            'light_feet': '游끢+5% rychlost',
                            'stealth_move': '游봉-20% p콏epaden칤',
                            'run_bonus': '游끢+15% 칰t캩k',
                            'stomp': '游붰+8 damage',
                            'jump': '游붖+25% dodge',
                            'warm_feet': '仇勇-15% energie',
                            'power_kick': '丘+20% rychlost',
                            'exo': '游눩+50% nosnost',
                            'sturdy': '游띠勇+2 DEF'
                        };
                        specialInfo = specialLabels[specialName] || specialName;
                    }
                    
                    let durabilityInfo = '';
                    if (item.durability !== undefined) {
                        const durColor = item.durability < 30 ? '#f44336' : item.durability < 60 ? '#ff9800' : '#4caf50';
                        durabilityInfo = `<span style="color: ${durColor}; font-size: 0.7rem;">[${item.durability}%]</span>`;
                    }
                    
                    let statsInfo = '';
                    if (item.defense) statsInfo += `游띠勇${item.defense} `;
                    if (item.damage) statsInfo += `丘덢잺${item.damage} `;
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.3rem;">
                            <div style="flex: 1;">
                                <div>
                                    <span style="font-size: 1.1rem;">${item.icon}</span>
                                    <span style="font-size: 0.85rem;">${item.name}</span>
                                    ${item.count > 1 ? '<span style="color: #888; font-size: 0.75rem;"> x' + item.count + '</span>' : ''}
                                    ${durabilityInfo}
                                </div>
                                <div style="font-size: 0.7rem; color: #888;">
                                    ${statsInfo}${specialInfo ? '<span style="color: #8bc34a;">' + specialInfo + '</span>' : ''}
                                </div>
                            </div>
                            <button class="btn" onclick="sellAtSettlement(${realIdx}, '${sourceType}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #ff9800;">
                                游눯${sellPrice}
                            </button>
                        </div>
                    `;
                });
                
                if (lockedItems.length > 0) {
                    html += `<div style="border-top: 1px solid #444; margin-top: 0.5rem; padding-top: 0.5rem;">
                        <p style="color: #666; font-size: 0.75rem; text-align: center; margin-bottom: 0.3rem;">游 Nelze p콏eprodat obchodn칤kovi:</p>`;
                    lockedItems.forEach((item) => {
                        const lockReason = item.fromCaravan ? '游냙 karavana' : item.fromSettlement ? '游끶勇 osada' : '游 koupeno';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.2rem; opacity: 0.6;">
                                <div>
                                    <span style="font-size: 1rem;">${item.icon}</span>
                                    <span style="font-size: 0.8rem; color: #888;">${item.name}</span>
                                    ${item.count > 1 ? '<span style="color: #666; font-size: 0.7rem;"> x' + item.count + '</span>' : ''}
                                </div>
                                <span style="font-size: 0.7rem; color: #ff9800;">${lockReason}</span>
                            </div>
                        `;
                    });
                    html += `<p style="color: #555; font-size: 0.7rem; text-align: center; margin-top: 0.3rem;">游눠 Prodej na online tr쬴코ti</p></div>`;
                }
            }
            
            html += '</div>';
            document.getElementById('settlementShopContent').innerHTML = html;
        }
        
        function buyFromSettlement(itemIdx) {
            // N치kup funguje i vzd치len캩 - nakoupen칠 v캩ci jdou do skladu osady
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            console.log('游 buyFromSettlement - itemIdx:', itemIdx);
            console.log('游 settlementShop:', state.settlementShop);
            
            const item = state.settlementShop?.items?.[itemIdx];
            console.log('游 Item:', item);
            
            if (!item || item.stock <= 0) {
                console.log('游 Item not found or out of stock!');
                return;
            }
            
            let buyDiscount = 0.9; // Z치kladn칤 sleva v osad캩
            
            // Sleva od Obchodn칤 gildy
            const tradersRep = state.factions?.traders || 0;
            if (tradersRep >= 100) {
                buyDiscount *= 0.6; // Spojenec: -40%
            } else if (tradersRep >= 50) {
                buyDiscount *= 0.8; // P콏치telsk칳: -20%
            }
            
            const price = Math.floor((item.price || 10) * buyDiscount);
            console.log('游 Price:', price, 'Money:', getMoney());
            
            if (getMoney() < price) {
                notifyWarning('Nedostatek pen캩z!', 'Pot콏ebuje코 ' + price + ' 游눯');
                return;
            }
            
            // Pokud v osad캩 - kontrola v치hy, jinak jde do skladu
            if (isInShelter) {
                if (!canAddItem(item, 1)) {
                    notifyWarning(t('notifications', 'inventoryFull'), 'Neunese코 dal코칤 v캩ci.');
                    return;
                }
            }
            
            console.log('游 Removing money and adding item...');
            removeMoney(price);
            
            // P콏idej item s flagem "koupeno" - nelze hned prodat zp캩t
            const boughtItem = {
                ...item,
                fromShop: true,
                boughtPrice: price
            };
            
            if (isInShelter) {
                // V osad캩 - do invent치콏e
                addItemToInventory(boughtItem, 1);
            } else {
                // Mimo osadu - do skladu osady
                if (!state.baseItems) state.baseItems = [];
                state.baseItems.push(boughtItem);
                notifyInfo('游닍 Do skladu', `${item.icon} ${item.name} p콏id치no do skladu osady`);
            }
            item.stock--;
            
            console.log('游 Done! New money:', getMoney());
            
            SoundSystem.play('pickup');
            showFloatingNumber(-price, 'money');
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            showSettlementShopBuy(); // Refresh
        }
        
        function sellAtSettlement(itemIndex, sourceType = 'inv') {
            // Prodej funguje i vzd치len캩 - prod치v치 ze skladu osady
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            // Pokud nen칤 v osad캩 ale source je inv, zm캩켿 na base
            if (!isInShelter && sourceType === 'inv') {
                sourceType = 'base';
            }
            
            const sourceArray = sourceType === 'base' ? (state.baseItems || []) : state.inv;
            const item = sourceArray[itemIndex];
            if (!item) return;
            
            // Vycraft캩n칠 p콏edm캩ty nelze prodat obchodn칤k콢m
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoru캜n캩 vyroben칠 v캩ci obchodn칤ci neberou. Zkus online tr쬴코t캩!');
                return;
            }
            
            // V캩ci koupen칠 od karavany nelze prodat obchodn칤k콢m (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od karavany nelze prodat. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            // V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'V캩ci koupen칠 od obchodn칤ka nelze prodat zp캩t. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            // V캩ci vyroben칠/nalezen칠 osadou nelze prodat zp캩t obchodn칤kovi (anti-exploit)
            if (item.fromSettlement) {
                notifyWarning('Nelze prodat', 'V캩ci vyroben칠 osadn칤ky nelze prodat zp캩t. Pou쬴j je nebo prodej na online tr쬴코ti!');
                return;
            }
            
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25;
            // Z칤skej cenu z itemu nebo z ITEMS definice
            const itemDef = ITEMS.find(i => i.id === item.id);
            const basePrice = item.price || itemDef?.price || 10;
            let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
            
            // Sn칤쬰n칤 ceny za po코kozen칤
            if (item.durability !== undefined && item.maxDurability) {
                const durabilityRatio = item.durability / item.maxDurability;
                sellPrice = Math.floor(sellPrice * durabilityRatio);
                if (sellPrice < 1) sellPrice = 1;
            }
            
            addMoney(sellPrice);
            
            if (item.count > 1) {
                item.count--;
            } else {
                sourceArray.splice(itemIndex, 1);
            }
            
            state.stats.itemsSold = (state.stats.itemsSold || 0) + 1;
            SoundSystem.play('pickup');
            showFloatingNumber(sellPrice, 'money');
            
            // Daily quest progress - sold
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + 1;
                checkDailyQuests();
            }
            
            showSettlementShopSell(); // Refresh
        }
        
        function showSettlementHelp() {
            const helpTexts = {
                whatIs: 'Co je osada?', whatIsDesc: 'Osada je tvoje z치kladna, kde m콢쬰코 stav캩t budovy, naj칤mat osadn칤ky a rozv칤jet komunitu p콏e쬴v코칤ch.',
                basicStats: 'Z치kladn칤 statistiky', levelDesc: 'Ur캜uje max po캜et osadn칤k콢 (3 na level)', prosperityDesc: 'Zvy코uje se stavbami a ud치lostmi, p콏i 100 level up', moraleDesc: 'Ovliv켿uje produktivitu, p콏i n칤zk칠 osadn칤ci ut칤kaj칤', defenseDesc: 'Chr치n칤 p콏ed n치jezdy bandit콢',
                economy: 'Ekonomika osady', maintenanceDesc: 'V캩t코칤 budovy stoj칤 v칤ce pen캩z/den', tradersDesc: 'Generuj칤 pasivn칤 p콏칤jem (10-80游눯/den podle levelu)', marketDesc: '+25% p콏칤jem z obchodn칤k콢', builderDesc: 'Sni쬿je 칰dr쬭u budov (5-25% podle levelu)', warningDesc: 'Bez pen캩z na 칰dr쬭u se budovy rozpadnou!',
                buildings: 'Budovy', buildingsDesc: 'Stav budovy za suroviny. Ka쬯치 m치 unik치tn칤 efekt a denn칤 칰dr쬭u:',
                bed: 'Postel', bedDesc: 'Regenerace HP a energie', well: 'Studna', wellDesc: 'Automatick치 produkce vody', garden: 'Zahrada', gardenDesc: 'Automatick치 produkce j칤dla', walls: 'Zdi', wallsDesc: 'Zvy코uj칤 obranu osady', reactor: 'Reaktor', reactorDesc: 'Energie pro budovy',
                settlers: 'Osadn칤ci', settlersDesc: 'Naj칤mej osadn칤ky za pen칤ze. Upgrady stoj칤 dal코칤 pen칤ze!',
                farmer: 'Farm치콏', farmerDesc: 'Produkuje j칤dlo', guard: 'Str치쬮e', guardDesc: 'Zvy코uje obranu', scavenger: 'Sb캩ra캜', scavengerDesc: 'Sb칤r치 n치hodn칠 suroviny', medic: 'Medik', medicDesc: 'L칠캜칤 v코echny', builder: 'Stavitel', builderDesc: 'Slevy na stavby A 칰dr쬭u!', trader: 'Obchodn칤k', traderDesc: 'Pasivn칤 p콏칤jem pen캩z!',
                upgrades: 'Upgrade osadn칤k콢', upgradesDesc: 'Ka쬯칳 osadn칤k m치 5 level콢. Vy코코칤 level = lep코칤 produkce, ale vy코코칤 spot콏eba:',
                tips: 'Tipy', tip1: 'Za캜ni s farm치콏em a nosi캜em vody pro z치soby', tip2: 'Najmi obchodn칤ka pro pasivn칤 p콏칤jem', tip3: 'Stavitel sn칤쮂 n치klady na 칰dr쬭u', tip4: 'Sleduj panel Ekonomika v info obyvatel', tip5: 'Nevypl치c칤 se stav캩t moc budov najednou!',
                understood: 'Rozum칤m!'
            };
            
            showModal('仇 Jak funguje osada', `
                <div style="text-align: left; max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch; font-size: 0.9rem;">
                    
                    <h3 style="color: var(--toxic-green); margin-top: 0;">游끶勇 ${helpTexts.whatIs}</h3>
                    <p>${helpTexts.whatIsDesc}</p>
                    
                    <h3 style="color: var(--rust-light);">游늵 ${helpTexts.basicStats}</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Level</strong> - ${helpTexts.levelDesc}</li>
                        <li><strong>Prosperity</strong> - ${helpTexts.prosperityDesc}</li>
                        <li><strong>${'Mor치lka'}</strong> - ${helpTexts.moraleDesc}</li>
                        <li><strong>${'Obrana'}</strong> - ${helpTexts.defenseDesc}</li>
                    </ul>
                    
                    <h3 style="color: var(--warning-yellow);">游눯 ${helpTexts.economy}</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>游댢 ${'칔dr쬭a budov'}</strong> - ${helpTexts.maintenanceDesc}</li>
                        <li><strong>游눷 ${'Obchodn칤ci'}</strong> - ${helpTexts.tradersDesc}</li>
                        <li><strong>游낅 ${'Tr쬴코t캩'}</strong> - ${helpTexts.marketDesc}</li>
                        <li><strong>游댣 ${'Stavitel'}</strong> - ${helpTexts.builderDesc}</li>
                        <li><strong>丘멆잺 ${'Pozor!'}</strong> - ${helpTexts.warningDesc}</li>
                    </ul>
                    
                    <h3 style="color: var(--rust-light);">游끵勇 ${helpTexts.buildings}</h3>
                    <p>${helpTexts.buildingsDesc}</p>
                    <ul style="line-height: 1.8;">
                        <li>游띒勇 <strong>${helpTexts.bed}</strong> - ${helpTexts.bedDesc} (0游눯/${'den'})</li>
                        <li>游눦 <strong>${helpTexts.well}</strong> - ${helpTexts.wellDesc} (2游눯/${'den'})</li>
                        <li>游꺔 <strong>${helpTexts.garden}</strong> - ${helpTexts.gardenDesc} (0游눯/${'den'})</li>
                        <li>游빔 <strong>${helpTexts.walls}</strong> - ${helpTexts.wallsDesc} (5游눯/${'den'})</li>
                        <li>驕뮖잺 <strong>${helpTexts.reactor}</strong> - ${helpTexts.reactorDesc} (25游눯/${'den'})</li>
                    </ul>
                    
                    <h3 style="color: var(--rust-light);">游논 ${helpTexts.settlers}</h3>
                    <p>${helpTexts.settlersDesc}</p>
                    <ul style="line-height: 1.8;">
                        <li>游 <strong>${helpTexts.farmer}</strong> (500游눯) - ${helpTexts.farmerDesc}</li>
                        <li>游띠勇 <strong>${helpTexts.guard}</strong> (800游눯) - ${helpTexts.guardDesc}</li>
                        <li>游 <strong>${helpTexts.scavenger}</strong> (700游눯) - ${helpTexts.scavengerDesc}</li>
                        <li>游눌 <strong>${helpTexts.medic}</strong> (1000游눯) - ${helpTexts.medicDesc}</li>
                        <li>游댣 <strong>${helpTexts.builder}</strong> (600游눯) - ${helpTexts.builderDesc}</li>
                        <li>游눯 <strong>${helpTexts.trader}</strong> (1500游눯) - ${helpTexts.traderDesc}</li>
                    </ul>
                    
                    <h3 style="color: var(--rust-light);">游늳 ${helpTexts.upgrades}</h3>
                    <p>${helpTexts.upgradesDesc}</p>
                    <ul style="line-height: 1.8;">
                        <li>Level 2: 350-600游눯</li>
                        <li>Level 3: 700-1200游눯</li>
                        <li>Level 4: 1400-2500游눯</li>
                        <li>Level 5: 2800-5000游눯</li>
                    </ul>
                    
                    <h3 style="color: var(--warning-yellow);">游눠 ${helpTexts.tips}</h3>
                    <ul style="line-height: 1.8;">
                        <li>${helpTexts.tip1}</li>
                        <li>${helpTexts.tip2}</li>
                        <li>${helpTexts.tip3}</li>
                        <li>${helpTexts.tip4}</li>
                        <li>${helpTexts.tip5}</li>
                    </ul>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 ${helpTexts.understood}</button>
            `);
        }
        
        // === MODALY PRO OSADU ===
        function showSettlersModal() {
            const currentMoney = getMoney();
            const canHireMore = true; // Bez limitu
            
            const settlerTexts = {
                yourResidents: 'Tvoji obyvatel칠', hireNew: 'Najmi nov칠 obyvatele',
                fullCapacity: 'Pln치 kapacita! Zvy코 level osady (prosperity 100).',
                dismiss: 'Propustit'
            };
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Aktu치ln칤 obyvatel칠
            if (state.settlement.settlers.length > 0) {
                html += '<h3 style="color: var(--toxic-green); margin-top: 0;">游논 ' + settlerTexts.yourResidents + ' (' + state.settlement.settlers.length + ')</h3>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">';
                state.settlement.settlers.forEach((settler, idx) => {
                    const type = SETTLER_TYPES.find(t => t.id === settler.type);
                    html += '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; text-align: center;">';
                    html += '<div style="font-size: 2rem;">' + (type?.icon || '游녻') + '</div>';
                    html += '<div style="font-weight: bold;">' + settler.name + '</div>';
                    html += '<div style="font-size: 0.8rem; color: #888;">' + getSettlerName(settler.type) + '</div>';
                    html += '<button class="btn" onclick="fireSettler(' + idx + '); showSettlersModal();" style="width: 100%; margin-top: 0.5rem; background: #c62828; font-size: 0.75rem;">仇 ' + settlerTexts.dismiss + '</button>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Naj칤m치n칤
            html += '<h3 style="color: var(--rust-light);">游눺 ' + settlerTexts.hireNew + '</h3>';
            if (!canHireMore) {
                html += '<p style="color: #ff9800;">丘멆잺 ' + settlerTexts.fullCapacity + '</p>';
            }
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">';
            SETTLER_TYPES.forEach(type => {
                const hasMoney = currentMoney >= type.cost;
                const countOfType = state.settlement.settlers.filter(s => s.type === type.id).length;
                const isUniqueAndOwned = type.unique && countOfType > 0;
                const btnDisabled = !canHireMore || !hasMoney || isUniqueAndOwned;
                const settlerName = getSettlerName(type.id);
                const settlerDesc = SETTLER_TRANSLATIONS[currentLang]?.[type.id]?.desc || type.desc;
                html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center; border: 1px solid ' + (isUniqueAndOwned ? '#4caf50' : '#333') + '; ' + (isUniqueAndOwned ? 'opacity: 0.7;' : '') + '">';
                html += '<div style="font-size: 2rem;">' + type.icon + '</div>';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + settlerName + (countOfType > 0 ? ' <span style="color: #8bc34a;">九</span>' : '') + (type.unique ? ' <span style="font-size: 0.65rem; color: #888;">(max 1)</span>' : '') + '</div>';
                html += '<div style="font-size: 0.75rem; color: #888;">' + settlerDesc + '</div>';
                html += '<div style="font-size: 0.7rem; color: #ff9800; margin: 0.3rem 0;">-' + type.consumption.food + '游꼤 -' + type.consumption.water + '游눦/' + ('den') + '</div>';
                if (isUniqueAndOwned) {
                    html += '<div style="color: #4caf50; font-size: 0.8rem; padding: 0.4rem;">九 M치코</div>';
                } else {
                    html += '<button class="btn" onclick="hireSettler(\'' + type.id + '\'); showSettlersModal();" ' + (btnDisabled ? 'disabled' : '') + ' style="width: 100%; font-size: 0.8rem; ' + (btnDisabled ? 'opacity: 0.5;' : '') + '">游눯 ' + type.cost + '</button>';
                }
                html += '</div>';
            });
            html += '</div></div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + ('Zav콏칤t') + '</button>';
            
            showModal('游논 Obyvatel칠 osady', html);
        }
        
        function showBuildingsModal() {
            const categoryNames = { living: '游 Bydlen칤', production: '丘뙖잺 Produkce', utility: '游댢 Utility', defense: '游띠勇 Obrana', settlement: '游끶勇 Osada' };
            const categoryColors = { living: '#8bc34a', production: '#2196f3', utility: '#ff9800', defense: '#c62828', settlement: '#9c27b0' };
            
            // Ensure settlers array exists
            if (!state.settlement) state.settlement = {};
            if (!state.settlement.settlers) state.settlement.settlers = [];
            
            const hasBuilder = state.settlement.settlers.some(s => s.type === 'builder');
            const powerBalance = calculatePowerBalance();
            
            console.log('游끵勇 showBuildingsModal - hasBuilder:', hasBuilder, 'settlers:', state.settlement.settlers.map(s => s.type));
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            html += '<p style="color: #888; margin-bottom: 0.5rem;">' + ('Postaveno') + ': ' + (state.base.length + state.settlement.buildings.length) + ' ' + ('budov') + (hasBuilder ? ' | 游댣 ' + ('Stavitel: -50% ceny a 캜asu') : '') + '</p>';
            html += '<p style="color: ' + (powerBalance >= 0 ? '#ffd700' : '#c62828') + '; margin-bottom: 1rem; font-size: 0.85rem;">丘 ' + ('Elekt콏ina') + ': ' + calculatePowerProduction() + '/' + calculatePowerConsumption() + ' (' + (powerBalance >= 0 ? '+' : '') + powerBalance + ')</p>';
            
            // Show buildings under construction
            if (state.buildQueue && state.buildQueue.length > 0) {
                html += '<div style="background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%); border: 2px solid #ff9800; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">';
                html += '<h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">游댣 ' + ('Ve v칳stavb캩') + '</h4>';
                state.buildQueue.forEach(build => {
                    const elapsed = Date.now() - build.startTime;
                    const progress = Math.min(100, (elapsed / build.duration) * 100);
                    const remaining = Math.max(0, Math.ceil((build.duration - elapsed) / 60000)); // minutes
                    html += '<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<span>' + build.icon + ' ' + build.name + '</span>';
                    html += '<span style="color: #ff9800; font-size: 0.8rem;">낌勇 ' + remaining + ' min</span>';
                    html += '</div>';
                    html += '<div style="height: 6px; background: #333; border-radius: 3px; margin-top: 0.3rem; overflow: hidden;">';
                    html += '<div style="height: 100%; width: ' + progress + '%; background: linear-gradient(90deg, #ff9800, #ffc107); transition: width 0.3s;"></div>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            ['living', 'production', 'utility', 'defense', 'settlement'].forEach(cat => {
                const buildings = BUILDINGS.filter(b => b.category === cat);
                if (buildings.length === 0) return;
                
                const builtCount = buildings.filter(b => state.base.includes(b.id) || state.settlement.buildings.includes(b.id)).length;
                
                html += '<div style="margin-bottom: 1rem;">';
                html += '<h4 style="color: ' + categoryColors[cat] + '; margin: 0 0 0.5rem 0;">' + categoryNames[cat] + ' (' + builtCount + '/' + buildings.length + ')</h4>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.5rem;">';
                
                buildings.forEach(building => {
                    const hasBuilding = state.base.includes(building.id) || state.settlement.buildings.includes(building.id);
                    const isBuilding = state.buildQueue && state.buildQueue.some(b => b.id === building.id);
                    const buildProgress = isBuilding ? state.buildQueue.find(b => b.id === building.id) : null;
                    const settlementRes = state.settlement.resources || {};
                    const canAfford = Object.entries(building.cost).every(([res, amt]) => {
                        const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                        const playerHas = state.resources[res] || 0;
                        const settlementHas = settlementRes[res] || 0;
                        return (playerHas + settlementHas) >= cost;
                    });
                    const levelOk = (building.level || 1) <= state.settlement.level;
                    const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
                    const canBuildLocation = inBase || hasBuilder; // Stavitel umo쮄갓je stav캩t odkudkoliv
                    const needsPower = building.requiresPower;
                    const hasPowerForIt = needsPower ? (powerBalance >= 0 || !hasBuilding) : true;
                    const canBuild = canAfford && levelOk && canBuildLocation && !isBuilding;
                    
                    html += '<div style="background: ' + (hasBuilding ? (hasPowerForIt ? '#1a2a1a' : '#2a1a1a') : (isBuilding ? '#2a2a1a' : '#1a1a1a')) + '; padding: 0.6rem; border-radius: 6px; text-align: center; border: 1px solid ' + (hasBuilding ? (hasPowerForIt ? '#4a7c4a' : '#7c4a4a') : (isBuilding ? '#ff9800' : '#333')) + ';">';
                    html += '<div style="font-size: 1.5rem;">' + building.icon + '</div>';
                    html += '<div style="font-size: 0.8rem; font-weight: bold;">' + getBuildingName(building.id) + '</div>';
                    html += '<div style="font-size: 0.65rem; color: #666;">' + getBuildingDesc(building.id) + '</div>';
                    
                    // Level requirement
                    if (building.level && building.level > 1) {
                        html += '<div style="font-size: 0.65rem; color: ' + (levelOk ? '#8bc34a' : '#ff9800') + '; margin-top: 0.2rem;">救 Level ' + building.level + '</div>';
                    }
                    
                    // Info o elekt콏in캩
                    if (building.production && building.production.power) {
                        html += '<div style="font-size: 0.7rem; color: #ffd700; margin-top: 0.2rem;">+' + building.production.power + ' 丘</div>';
                    }
                    if (needsPower) {
                        html += '<div style="font-size: 0.7rem; color: #c62828; margin-top: 0.2rem;">-' + needsPower + ' 丘</div>';
                    }
                    
                    if (hasBuilding) {
                        if (needsPower && !hasPowerForIt) {
                            html += '<div style="color: #c62828; font-size: 0.75rem; margin-top: 0.3rem;">丘멆잺 Bez proudu!</div>';
                        } else {
                            html += '<div style="color: #8bc34a; font-size: 0.75rem; margin-top: 0.3rem;">九 Postaveno</div>';
                        }
                        // Zobraz 칰dr쬭u postaven칠 budovy
                        if (building.maintenance > 0) {
                            html += '<div style="color: #ff9800; font-size: 0.65rem;">游댢 ' + building.maintenance + ' 游눯/den</div>';
                        }
                        // Tla캜칤tko zbour치n칤
                        html += '<button onclick="event.stopPropagation(); demolishBuilding(\'' + building.id + '\')" style="margin-top: 0.4rem; padding: 0.3rem 0.5rem; background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%); border: none; color: #fff; border-radius: 4px; cursor: pointer; font-size: 0.65rem; width: 100%;">游끵勇 Zbourat</button>';
                    } else {
                        const costText = Object.entries(building.cost).map(([res, amt]) => {
                            const icons = {wood: '游', metal: '丘뙖잺', stone: '游', cloth: '游빗'};
                            const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                            const playerHas = state.resources[res] || 0;
                            const settlementHas = settlementRes[res] || 0;
                            const totalHas = playerHas + settlementHas;
                            return '<span style="color: ' + (totalHas >= cost ? '#8bc34a' : '#c62828') + ';">' + icons[res] + cost + '</span>';
                        }).join(' ');
                        html += '<div style="font-size: 0.7rem; margin: 0.3rem 0;">' + costText + '</div>';
                        
                        // Zobraz dobu stavby - pou쬴j fixn칤 캜asy (realistick칠)
                        const buildTimes = {
                            'bed': 120, 'firepit': 180, 'garden': 240, 'workshop': 360, 'storage': 300,
                            'water': 360, 'well': 720, 'farmland': 600, 'infirmary': 600, 'kitchen': 480,
                            'wall': 1200, 'tower': 960, 'market': 800, 'barracks': 1200, 'forge': 1440,
                            'training': 960, 'armory': 1200, 'tavern': 960, 'chapel': 1200, 'generator': 1680,
                            'solar': 1440, 'windmill_power': 1200, 'purifier': 1440, 'hydrofarm': 1680,
                            'comms': 1920, 'bunker': 2400, 'reactor': 2880, 'medbay': 2160, 'cryo': 2400,
                            'turret': 1920, 'university': 2640, 'monument': 2880
                        };
                        const totalCost = Object.values(building.cost).reduce((a, b) => a + b, 0);
                        let buildTime = buildTimes[building.id] || Math.max(240, Math.min(2880, totalCost * 10));
                        if (hasBuilder) buildTime = Math.ceil(buildTime * 0.9); // Stavitel -10%
                        // Zobraz v hodin치ch
                        const timeDisplay = Math.round(buildTime / 60 * 10) / 10 + 'h';
                        html += '<div style="font-size: 0.65rem; color: #888; margin-bottom: 0.2rem;">낌勇 ' + timeDisplay + '</div>';
                        
                        // Zobraz 칰dr쬭u p콏ed stavbou
                        if (building.maintenance > 0) {
                            html += '<div style="color: #ff9800; font-size: 0.65rem; margin-bottom: 0.2rem;">游댢 ' + building.maintenance + ' 游눯/' + ('den') + '</div>';
                        }
                        
                        if (isBuilding) {
                            // Building under construction
                            const elapsed = Date.now() - buildProgress.startTime;
                            const progress = Math.min(100, (elapsed / buildProgress.duration) * 100);
                            const remaining = Math.max(0, Math.ceil((buildProgress.duration - elapsed) / 60000));
                            html += '<div style="color: #ff9800; font-size: 0.7rem; margin-top: 0.3rem;">游댣 ' + ('Stav칤 se...') + '</div>';
                            html += '<div style="height: 4px; background: #333; border-radius: 2px; margin-top: 0.2rem; overflow: hidden;">';
                            html += '<div style="height: 100%; width: ' + progress + '%; background: #ff9800;"></div>';
                            html += '</div>';
                            html += '<div style="font-size: 0.6rem; color: #888; margin-top: 0.2rem;">낌勇 ' + remaining + ' min</div>';
                        } else if (!levelOk) {
                            html += '<div style="color: #ff9800; font-size: 0.7rem;">游 ' + ('Pot콏eba level') + ' ' + building.level + '</div>';
                        } else if (!canBuildLocation) {
                            html += '<div style="color: #ff9800; font-size: 0.7rem;">游 ' + ('Jdi do osady nebo najmi Stavitele') + '</div>';
                        } else {
                            html += '<button class="btn" onclick="buildUnifiedBuilding(\'' + building.id + '\');" ' + (!canBuild ? 'disabled' : '') + ' style="width: 100%; font-size: 0.7rem; padding: 0.3rem; ' + (!canBuild ? 'opacity: 0.5;' : '') + '">游댣 ' + ('Stav캩t') + '</button>';
                        }
                    }
                    html += '</div>';
                });
                html += '</div></div>';
            });
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('游끵勇 Budovy', html);
        }
        
        function showDefenseModal() {
            const defense = calculateSettlementDefense();
            const guards = state.settlement.settlers.filter(s => s.type === 'guard').length;
            const hasWalls = state.base.includes('wall') || state.settlement.buildings.includes('wall');
            const hasBarracks = state.base.includes('barracks') || state.settlement.buildings.includes('barracks');
            const hasTowers = state.base.includes('tower') || state.settlement.buildings.includes('tower');
            const hasBunker = state.base.includes('bunker') || state.settlement.buildings.includes('bunker');
            const hasTurret = state.base.includes('turret') || state.settlement.buildings.includes('turret');
            const hasArmory = state.base.includes('armory') || state.settlement.buildings.includes('armory');
            
            const defModalTexts = {
                points: 'bod콢', desc: 'Obrana chr치n칤 p콏ed n치jezdy bandit콢',
                sources: 'Zdroje obrany:', guards: 'Str치쬮i', walls: 'Hradby',
                barracks: 'Kas치rny', tower: 'Str치쬹칤 v캩', bunker: 'Bunker',
                turret: 'Auto v캩', armory: 'Zbrojnice',
                howToIncrease: 'Jak zv칳코it obranu:',
                tip1: 'Najmi str치쬮e (+15 ka쬯칳)', tip2: 'Postav hradby (+25) - Level 2',
                tip3: 'Postav str치쬹칤 v캩 (+15) - Level 2', tip4: 'Postav bunker (+60) - Level 4',
                tip5: 'Postav auto v캩 (+50) - Level 5'
            };
            
            let html = '<div style="text-align: center; margin-bottom: 1rem;">';
            html += '<div style="font-size: 4rem;">游띠勇</div>';
            html += '<div style="font-size: 2rem; color: ' + (defense > 50 ? '#8bc34a' : defense > 20 ? '#ff9800' : '#c62828') + '; font-weight: bold;">' + defense + ' ' + defModalTexts.points + '</div>';
            html += '<p style="color: #888;">' + defModalTexts.desc + '</p>';
            html += '</div>';
            
            html += '<h4 style="color: var(--rust-light);">游늵 ' + defModalTexts.sources + '</h4>';
            html += '<div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
            html += '<p>游띠勇 ' + defModalTexts.guards + ': ' + guards + ' 칑 15 = <strong>' + (guards * 15) + '</strong></p>';
            html += '<p>游빔 ' + defModalTexts.walls + ': ' + (hasWalls ? '九 +25' : '仇 0') + '</p>';
            html += '<p>游띠勇 ' + defModalTexts.barracks + ': ' + (hasBarracks ? '九 +bonus' : '仇 0') + '</p>';
            html += '<p>游딮 ' + defModalTexts.tower + ': ' + (hasTowers ? '九 +15' : '仇 0') + '</p>';
            html += '<p>游끸勇 ' + defModalTexts.bunker + ': ' + (hasBunker ? '九 +60' : '仇 0') + '</p>';
            html += '<p>游댦 ' + defModalTexts.turret + ': ' + (hasTurret ? '九 +50' : '仇 0') + '</p>';
            html += '<p>丘덢잺 ' + defModalTexts.armory + ': ' + (hasArmory ? '九 +10% DMG' : '仇 0') + '</p>';
            html += '</div>';
            
            html += '<h4 style="color: var(--warning-yellow);">游눠 ' + defModalTexts.howToIncrease + '</h4>';
            html += '<ul style="color: #888; font-size: 0.9rem;">';
            html += '<li>' + defModalTexts.tip1 + '</li>';
            html += '<li>' + defModalTexts.tip2 + '</li>';
            html += '<li>' + defModalTexts.tip3 + '</li>';
            html += '<li>' + defModalTexts.tip4 + '</li>';
            html += '<li>' + defModalTexts.tip5 + '</li>';
            html += '</ul>';
            
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + ('Zav콏칤t') + '</button>';
            
            showModal('游띠勇 Obrana osady', html);
        }
        
        function showFinanceModal() {
            const playerMoney = state.money || 0;
            const dailyMaintenance = calculateDailyMaintenance();
            const dailyIncome = calculateDailyIncome();
            const balance = dailyIncome - dailyMaintenance;
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Hlavn칤 p콏ehled
            html += '<div style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">';
            html += '<div style="font-size: 2.5rem; color: #ffd700; font-weight: bold;">' + playerMoney + ' 游눯</div>';
            html += '<div style="color: #888; font-size: 0.9rem;">' + ('Celkov칠 pen칤ze') + '</div>';
            html += '<div style="margin-top: 0.5rem; font-size: 1.2rem; color: ' + (balance >= 0 ? '#8bc34a' : '#c62828') + ';">';
            html += (balance >= 0 ? '游늳 +' : '游늴 ') + balance + ' 游눯/' + ('den');
            html += '</div>';
            html += '</div>';
            
            // === P콎칈JMY ===
            html += '<div style="background: #1a2a1a; border: 1px solid #4a7c4a; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">';
            html += '<h3 style="color: #8bc34a; margin: 0 0 0.5rem 0; font-size: 1rem;">游늳 ' + ('P콎칈JMY') + '</h3>';
            
            // Dan캩 od osadn칤k콢
            const settlerCount = state.settlement?.settlers?.length || 0;
            const settlerTaxes = settlerCount * 2;
            if (settlerCount > 0) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>游논 Dan캩 od osadn칤k콢 (' + settlerCount + ' 칑 2)</span>';
                html += '<span style="color: #8bc34a;">+' + settlerTaxes + ' 游눯</span>';
                html += '</div>';
            }
            
            // Trading post
            if (state.base.includes('trading_post') || state.settlement.buildings.includes('trading_post')) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>游낅 Trading post</span>';
                html += '<span style="color: #8bc34a;">+50 游눯</span>';
                html += '</div>';
            }
            
            // Market/Tr쬴코t캩
            if (state.base.includes('market') || state.settlement.buildings.includes('market')) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>游낇 ' + ('Tr쬴코t캩') + '</span>';
                html += '<span style="color: #8bc34a;">+30 游눯</span>';
                html += '</div>';
            }
            
            // Trader settlers
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            if (traders.length > 0) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>游녻 Obchodn칤ci (' + traders.length + ' 칑 10)</span>';
                html += '<span style="color: #8bc34a;">+' + (traders.length * 10) + ' 游눯</span>';
                html += '</div>';
            }
            
            // Trade specialization
            if (state.settlement.specialization === 'trade') {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>游끹勇 ' + ('Obchodn칤 specializace') + '</span>';
                html += '<span style="color: #8bc34a;">+25 游눯</span>';
                html += '</div>';
            }
            
            // Celkem p콏칤jmy
            html += '<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: bold; font-size: 1.1rem;">';
            html += '<span>' + ('Celkem p콏칤jmy') + '</span>';
            html += '<span style="color: #8bc34a;">+' + dailyIncome + ' 游눯/' + ('den') + '</span>';
            html += '</div>';
            html += '</div>';
            
            // === V칗DAJE ===
            html += '<div style="background: #2a1a1a; border: 1px solid #7c4a4a; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">';
            html += '<h3 style="color: #c62828; margin: 0 0 0.5rem 0; font-size: 1rem;">游늴 ' + ('V칗DAJE') + '</h3>';
            
            // 칔dr쬭a budov
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            let totalMaintenance = 0;
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance && building.maintenance > 0) {
                    totalMaintenance += building.maintenance;
                    html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #3a2a2a;">';
                    html += '<span>' + building.icon + ' ' + building.name + '</span>';
                    html += '<span style="color: #c62828;">-' + building.maintenance + ' 游눯</span>';
                    html += '</div>';
                }
            });
            
            if (totalMaintenance === 0) {
                html += '<div style="color: #888; text-align: center; padding: 0.5rem;">' + ('콯치dn칠 n치klady na 칰dr쬭u') + '</div>';
            }
            
            // Celkem v칳daje
            html += '<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: bold; font-size: 1.1rem;">';
            html += '<span>' + ('Celkem v칳daje') + '</span>';
            html += '<span style="color: #c62828;">-' + dailyMaintenance + ' 游눯/' + ('den') + '</span>';
            html += '</div>';
            html += '</div>';
            
            // === BILANCE ===
            html += '<div style="background: ' + (balance >= 0 ? '#1a2a1a' : '#2a1a1a') + '; border: 2px solid ' + (balance >= 0 ? '#8bc34a' : '#c62828') + '; border-radius: 8px; padding: 1rem; text-align: center;">';
            html += '<div style="font-size: 0.9rem; color: #888;">' + ('Denn칤 bilance') + '</div>';
            html += '<div style="font-size: 1.5rem; font-weight: bold; color: ' + (balance >= 0 ? '#8bc34a' : '#c62828') + ';">';
            html += (balance >= 0 ? '+' : '') + balance + ' 游눯/' + ('den');
            html += '</div>';
            if (balance < 0) {
                const daysLeft = Math.floor(playerMoney / Math.abs(balance));
                html += '<div style="margin-top: 0.5rem; color: #ff6b6b;">丘멆잺 ' + ('Bankrot za ') + daysLeft + ' ' + ('dn칤') + '</div>';
            }
            html += '</div>';
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('游눯 P콏ehled financ칤', html);
        }
        
        function showStorageModal() {
            // Sklad je p콏칤stupn칳 odkudkoliv pro PROHL칈콯EN칈, ale transfer jen v osad캩
            const isInShelter = state.world?.currentLocation === 'shelter';
            
            const icons = { 
                wood: '游', metal: '丘뙖잺', stone: '游', cloth: '游빗', fuel: '久', leather: '游붮', 
                herbs: '游', chemicals: '游빍', electronics: '游', glass: '游댩', rope: '俱', 
                gunpowder: '游눤', scrap: '游댤', food: '游꼤', water: '游눦',
                copper: '游릯', silver: '拘', gold: '游리', copper_ore: '游뿯', silver_ore: '游뿯', gold_ore: '游뿯',
                crystal: '游눑', plastic: '游빖', raw_meat: '游볼', fish: '游'
            };
            const names = {
                wood: 'D콏evo', metal: 'Kov', stone: 'K치men', cloth: 'L치tka', fuel: 'Palivo',
                leather: 'K콢쬰', herbs: 'Byliny', chemicals: 'Chemik치lie', electronics: 'Elektronika',
                glass: 'Sklo', rope: 'Provaz', gunpowder: 'St콏eln칳 prach', scrap: 'rot',
                food: 'J칤dlo', water: 'Voda', copper: 'M캩캞', silver: 'St콏칤bro', gold: 'Zlato',
                copper_ore: 'M캩d캩n치 ruda', silver_ore: 'St콏칤brn치 ruda', gold_ore: 'Zlat치 ruda',
                crystal: 'Krystal', plastic: 'Plast', raw_meat: 'Syrov칠 maso', fish: 'Ryba'
            };
            
            const storageTexts = {
                title: 'Sklad osady', inStorage: 'Ve skladu osady', withYou: 'U tebe',
                takeAll: 'Vz칤t v코echny suroviny', storeAll: 'Ulo쬴t v코echny suroviny',
                resources: 'Suroviny', yourResources: 'Tvoje suroviny', storedItems: 'Ulo쬰n칠 p콏edm캩ty',
                empty: 'Pr치zdn칠', none: '콯치dn칠', noItems: '콯치dn칠 p콏edm캩ty', take: 'Vz칤t', all: 'V코e',
                amount: 'Mno쬽tv칤', closeStorage: 'Zav콏칤t sklad', consumable: 'Spot콏ebn칤'
            };
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
            
            // Migrace
            resourceKeys.forEach(r => {
                if (state.settlement.resources[r] === undefined) state.settlement.resources[r] = 0;
            });
            
            const balance = calculateSettlementBalance();
            
            // Renderov치n칤 polo쬶y suroviny
            const renderResourceRow = (res, fromSettlement) => {
                const icon = icons[res] || '游닍';
                const name = names[res] || res;
                const settlementAmt = state.settlement.resources[res] || 0;
                const playerAmt = state.resources[res] || 0;
                const amt = fromSettlement ? settlementAmt : playerAmt;
                
                if (amt <= 0) return '';
                
                let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                html += '<span style="font-size: 1.5rem;">' + icon + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + name + '</div>';
                html += '<div style="font-size: 0.85rem; color: #888;">' + storageTexts.amount + ': <span style="color: #ffd700;">' + amt + '</span></div>';
                html += '</div></div>';
                
                // Tla캜칤tka pro transfer pouze v osad캩
                if (isInShelter) {
                    if (fromSettlement) {
                        html += '<div style="display: flex; gap: 0.2rem;">';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 1)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #4caf50;">+1</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 10)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #4caf50;">+10</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 999)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #8bc34a;">' + storageTexts.all + '</button>';
                        html += '</div>';
                    } else {
                        html += '<div style="display: flex; gap: 0.2rem;">';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 1)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #2196f3;">+1</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 10)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #2196f3;">+10</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 999)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #1976d2;">' + storageTexts.all + '</button>';
                        html += '</div>';
                    }
                }
                html += '</div>';
                return html;
            };
            
            // Renderov치n칤 p콏edm캩tu ze skladu
            const renderStoredItem = (item, idx) => {
                let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                html += '<span style="font-size: 1.5rem;">' + item.icon + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + getItemName(item.id) + (item.count > 1 ? ' x' + item.count : '') + '</div>';
                let desc = '';
                if (item.type === 'weapon') desc = '丘덢잺 ' + item.damage + ' DMG';
                else if (item.type === 'armor') desc = '游띠勇 ' + item.defense + ' DEF';
                else if (item.type === 'consumable') desc = item.effect || storageTexts.consumable;
                else desc = item.type || '';
                html += '<div style="font-size: 0.75rem; color: #8bc34a;">' + desc + '</div>';
                html += '</div></div>';
                html += '<button class="btn" onclick="takeFromBase(' + idx + ')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4caf50;">' + storageTexts.take + '</button>';
                html += '</div>';
                return html;
            };
            
            // Suroviny ve skladu osady
            let settlementResources = '';
            resourceKeys.forEach(res => {
                settlementResources += renderResourceRow(res, true);
            });
            
            // Suroviny u hr치캜e
            let playerResources = '';
            resourceKeys.forEach(res => {
                playerResources += renderResourceRow(res, false);
            });
            
            // P콏edm캩ty ve skladu
            let storedItems = '';
            if (state.baseItems && state.baseItems.length > 0) {
                state.baseItems.forEach((item, idx) => {
                    storedItems += renderStoredItem(item, idx);
                });
            } else {
                storedItems = '<p style="color: #666; text-align: center; font-size: 0.85rem; padding: 1rem;">' + storageTexts.noItems + '</p>';
            }
            
            // P콏edm캩ty u hr치캜e (kter칠 lze ulo쬴t do skladu)
            let playerItems = '';
            const hasStorage = state.base?.includes('storage') || state.settlement?.buildings?.includes('storage');
            
            const storableItems = state.inv.filter(item => 
                item.type !== 'money' && 
                item.type !== 'resource' && 
                !isItemEquipped(item)
            );
            
            // Upozorn캩n칤 pokud nem치 sklad
            if (!hasStorage && storableItems.length > 0) {
                playerItems = '<div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #ff9800;">';
                playerItems += '<p style="color: #ff9800; margin: 0 0 0.5rem 0; text-align: center;">游끵勇 Pot콏ebuje코 postavit <strong>Sklad</strong>!</p>';
                playerItems += '<p style="color: #888; font-size: 0.8rem; margin: 0; text-align: center;">Pro ukl치d치n칤 p콏edm캩t콢 postav budovu Sklad (15 d콏eva, 10 kamene)</p>';
                playerItems += '</div>';
            }
            
            if (storableItems.length > 0) {
                storableItems.forEach((item, idx) => {
                    const realIdx = state.inv.indexOf(item);
                    const isFoodOrWater = item.id === 'food' || item.id === 'water' || item.id === 'canned_food' || item.id === 'clean_water';
                    const canStore = hasStorage || isFoodOrWater;
                    
                    let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                    html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                    html += '<span style="font-size: 1.3rem;">' + (item.icon || '游닍') + '</span>';
                    html += '<div style="flex: 1;">';
                    html += '<div style="font-weight: bold; font-size: 0.85rem;">' + (item.name || item.id) + (item.count > 1 ? ' x' + item.count : '') + '</div>';
                    let desc = '';
                    if (item.type === 'weapon') desc = '丘덢잺 ' + (item.damage || 0) + ' DMG';
                    else if (item.type === 'armor' || item.type === 'helmet' || item.type === 'boots' || item.type === 'gloves') desc = '游띠勇 ' + (item.defense || 0) + ' DEF';
                    else if (item.type === 'consumable') desc = '游빍 ' + (item.effect || 'Spot콏ebn칤');
                    else desc = item.type || '';
                    html += '<div style="font-size: 0.7rem; color: #888;">' + desc + '</div>';
                    html += '</div></div>';
                    
                    if (canStore) {
                        html += '<button class="btn" onclick="storeInBase(' + realIdx + '); showStorageModal();" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #2196f3;">游닍 Ulo쬴t</button>';
                    } else {
                        html += '<span style="color: #666; font-size: 0.7rem;">游 Sklad</span>';
                    }
                    html += '</div>';
                    playerItems += html;
                });
            }
            
            document.getElementById('modalContent').innerHTML = `
                <h2>游닍 ${storageTexts.title}</h2>
                
                ${!isInShelter ? `
                <div style="background: #3a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ff9800;">
                    <p style="color: #ff9800; margin: 0; text-align: center;">丘멆잺 Nejsi v osad캩 - pouze prohl칤쬰n칤, p콏esuny zak치z치ny</p>
                </div>
                ` : ''}
                
                <!-- Z치soby j칤dla a vody -->
                <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem; padding: 0.8rem; background: #1a1a1a; border-radius: 8px;">
                    <div style="text-align: center;">
                        <span style="font-size: 1.5rem;">游꼤</span>
                        <span style="font-size: 1.3rem; color: #ffd700; font-weight: bold; margin: 0 0.3rem;">${state.settlement.resources.food || 0}</span>
                        <span style="font-size: 0.8rem; color: ${balance.food >= 0 ? '#8bc34a' : '#c62828'};">(${balance.food >= 0 ? '+' : ''}${balance.food}/d)</span>
                        ${isInShelter ? `
                        <div style="display: flex; gap: 0.2rem; margin-top: 0.3rem; justify-content: center;">
                            <button class="btn" onclick="transferSettlementResource('food', -1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #c62828;">-1</button>
                            <button class="btn" onclick="transferSettlementResource('food', 1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #4caf50;">+1</button>
                        </div>
                        ` : ''}
                    </div>
                    <div style="text-align: center;">
                        <span style="font-size: 1.5rem;">游눦</span>
                        <span style="font-size: 1.3rem; color: #2196f3; font-weight: bold; margin: 0 0.3rem;">${state.settlement.resources.water || 0}</span>
                        <span style="font-size: 0.8rem; color: ${balance.water >= 0 ? '#8bc34a' : '#c62828'};">(${balance.water >= 0 ? '+' : ''}${balance.water}/d)</span>
                        ${isInShelter ? `
                        <div style="display: flex; gap: 0.2rem; margin-top: 0.3rem; justify-content: center;">
                            <button class="btn" onclick="transferSettlementResource('water', -1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #c62828;">-1</button>
                            <button class="btn" onclick="transferSettlementResource('water', 1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #4caf50;">+1</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Dva sloupce -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- Lev칳 sloupec - Sklad osady -->
                    <div>
                        <h3 style="text-align: center; color: #2196f3; margin-bottom: 0.5rem;">游닍 ${storageTexts.inStorage}</h3>
                        ${isInShelter ? `<button class="btn" onclick="transferAllToPlayer()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">游 ${storageTexts.takeAll}</button>` : ''}
                        
                        <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">游늵 ${storageTexts.resources}</h4>
                        ${settlementResources || '<p style="color: #666; text-align: center; font-size: 0.85rem;">' + storageTexts.empty + '</p>'}
                        
                        <h4 style="color: #9c27b0; font-size: 0.85rem; margin: 0.8rem 0 0.3rem 0;">游 ${storageTexts.storedItems} (${state.baseItems?.length || 0}/${state.baseCapacity})</h4>
                        ${storedItems}
                    </div>
                    
                    <!-- Prav칳 sloupec - U hr치캜e -->
                    <div>
                        <h3 style="text-align: center; color: #8bc34a; margin-bottom: 0.5rem;">游 ${storageTexts.withYou}</h3>
                        ${isInShelter ? `<button class="btn" onclick="transferAllToSettlement()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; font-size: 0.8rem; background: #2196f3;">游닍 ${storageTexts.storeAll}</button>` : ''}
                        
                        <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">游늵 ${storageTexts.yourResources}</h4>
                        ${playerResources || '<p style="color: #666; text-align: center; font-size: 0.85rem;">' + storageTexts.none + '</p>'}
                        
                        <h4 style="color: #9c27b0; font-size: 0.85rem; margin: 0.8rem 0 0.3rem 0;">游 ${'Tvoje p콏edm캩ty'}</h4>
                        ${playerItems || '<p style="color: #666; text-align: center; font-size: 0.85rem;">' + storageTexts.noItems + '</p>'}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 ${storageTexts.closeStorage}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        // === ELEKTRICK칗 SYST칄M ===
        function calculatePowerProduction() {
            let power = 0;
            const allBuildings = [...state.base, ...state.settlement.buildings];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.production && building.production.power) {
                    // Gener치tor pot콏ebuje palivo - bez paliva neprodukuje
                    if (building.consumption && building.consumption.fuel) {
                        const hasFuel = (state.settlement?.resources?.fuel || 0) >= building.consumption.fuel;
                        if (hasFuel) {
                            power += building.production.power;
                        }
                        // Bez paliva nepo캜칤tej produkci
                    } else {
                        // Sol치rn칤 panely, v캩trn치 turb칤na - nepot콏ebuj칤 palivo
                        power += building.production.power;
                    }
                }
            });
            
            return power;
        }
        
        function calculatePowerConsumption() {
            let power = 0;
            const allBuildings = [...state.base, ...state.settlement.buildings];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.requiresPower) {
                    power += building.requiresPower;
                }
            });
            
            return power;
        }
        
        function calculatePowerBalance() {
            return calculatePowerProduction() - calculatePowerConsumption();
        }
        
        // Calculate daily maintenance cost for all buildings
        function calculateDailyMaintenance() {
            let total = 0;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            const settlementLevel = state.settlement?.level || 1;
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance) {
                    // Budovy na level 1 osady nemaj칤 칰dr쬭u
                    if (settlementLevel >= 2) {
                        total += building.maintenance;
                    }
                }
            });
            
            // Settler taxes (2 per settler per day - they pay you!)
            // Skip - taxes are now income, not expense
            
            return total;
        }
        
        // Get settlement trade bonus (from traders and specialization)
        function getSettlementTradeBonus() {
            let bonus = 1.0; // Base 100%
            
            // Bonus from trader settlers
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            traders.forEach(trader => {
                const level = trader.skillLevel || 1;
                const traderSkill = SETTLER_SKILLS?.trading?.levels?.[level - 1];
                if (traderSkill?.effect?.tradeBonus) {
                    bonus += traderSkill.effect.tradeBonus;
                }
            });
            
            // Bonus from trading specialization
            if (state.settlement?.specialization === 'trading') {
                const spec = SETTLEMENT_SPECIALIZATIONS?.find(s => s.id === 'trading');
                if (spec?.bonus?.tradeBonus) {
                    bonus += spec.bonus.tradeBonus;
                }
            }
            
            // Bonus from market building
            if (state.settlement?.buildings?.includes('market')) {
                bonus += 0.1; // +10% za tr쬴코t캩
            }
            
            return bonus;
        }
        
        // Calculate daily income from settlement
        function calculateDailyIncome() {
            let total = 0;
            const settlementLevel = state.settlement?.level || 1;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            
            // Settler taxes (3 per settler per day, scales with settlement level)
            const settlerCount = state.settlement?.settlers?.length || 0;
            total += settlerCount * (2 + settlementLevel);
            
            // Income from buildings with income property
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.income) {
                    total += building.income;
                }
            });
            
            // Trading post generates income
            if (allBuildings.includes('trading_post')) {
                total += 50;
            }
            
            // Market generates income (scales with settlers)
            if (allBuildings.includes('market')) {
                total += 30 + (settlerCount * 3); // V칤ce osadn칤k콢 = v칤ce obchodu
            }
            
            // Trader settlers generate extra income (scales with level)
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            traders.forEach(t => {
                const level = t.skillLevel || 1;
                total += 10 + (level * 5); // 15-35 za obchodn칤ka podle 칰rovn캩
            });
            
            // Trading specialization bonus (+50 flat income)
            if (state.settlement.specialization === 'trading') {
                total += 50; // Flat +50 pen캩z/den podle popisu
            }
            
            // Prosperity bonus (high prosperity attracts wealth)
            const prosperity = state.settlement?.prosperity || 0;
            if (prosperity >= 80) total += 25;
            else if (prosperity >= 50) total += 10;
            
            return total;
        }
        
        // Process daily faction/territory income for PvP faction members
        async function processFactionTerritoryIncome() {
            // Kontrola jestli je hr치캜 ve frakci
            if (!state.pvpFaction || !multiplayerEnabled || !firebaseDB) return;
            
            const myFaction = state.pvpFaction;
            const factionData = PVP_FACTIONS[myFaction];
            if (!factionData) return;
            
            try {
                // Na캜ti vlastn캩n치 칰zem칤
                const terrSnapshot = await firebaseDB.ref('territories').once('value');
                const territories = terrSnapshot.val() || {};
                
                // Spo캜칤tej 칰zem칤 vlastn캩n치 moj칤 frakc칤
                let ownedCount = 0;
                for (const [locId, terrData] of Object.entries(territories)) {
                    if (terrData.owner === myFaction) {
                        ownedCount++;
                    }
                }
                
                // Z치kladn칤 denn칤 p콏칤jem za 캜lenstv칤 ve frakci (sn칤쬰no)
                let factionIncome = 5; // 5 游눯 za b칳t ve frakci
                
                // Bonus za vlastn캩n치 칰zem칤 (2 游눯 za 칰zem칤 - sn칤쬰no z 5)
                const territoryIncome = ownedCount * 2;
                
                // Bonus za contribution (1 游눯 za ka쬯칳ch 200 contribution - sn칤쬰no)
                const contribution = state.pvpFactionContribution || 0;
                const contributionBonus = Math.floor(contribution / 200);
                
                const totalIncome = factionIncome + territoryIncome + contributionBonus;
                
                if (totalIncome > 0) {
                    addMoney(totalIncome);
                    
                    let incomeDetails = [];
                    if (factionIncome > 0) incomeDetails.push(`캜lenstv칤: ${factionIncome}`);
                    if (territoryIncome > 0) incomeDetails.push(`${ownedCount} 칰zem칤: ${territoryIncome}`);
                    if (contributionBonus > 0) incomeDetails.push(`p콏칤sp캩vek: ${contributionBonus}`);
                    
                    addLog(`${factionData.icon} Frak캜n칤 p콏칤jem: +${totalIncome} 游눯 (${incomeDetails.join(', ')})`, '游눯');
                    
                    // Notifikace
                    if (totalIncome >= 20) {
                        notifySuccess(`${factionData.icon} Frak캜n칤 p콏칤jem`, `+${totalIncome} 游눯 za ${factionData.name}`);
                    }
                }
                
                console.log(`游눯 Faction income for ${myFaction}: ${totalIncome} (territories: ${ownedCount})`);
                
            } catch (e) {
                console.error('Faction income error:', e);
            }
        }
        
        // Process daily settlement finances (called in daily update)
        function processSettlementFinances() {
            const maintenance = calculateDailyMaintenance();
            const income = calculateDailyIncome();
            const balance = income - maintenance;
            
            // Add income first
            if (income > 0) {
                state.money = (state.money || 0) + income;
                addLog(`游눯 P콏칤jem osady: +${income}`, '游눯');
            }
            
            // Then deduct maintenance
            if (maintenance > 0) {
                if (state.money >= maintenance) {
                    state.money -= maintenance;
                    addLog(`游댢 칔dr쬭a zaplacena: -${maintenance}`, '游댢');
                } else {
                    // Not enough money - buildings start deteriorating
                    const unpaid = maintenance - state.money;
                    state.money = 0;
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 10);
                    addLog(`丘멆잺 Nelze zaplatit 칰dr쬭u! -${unpaid} nezaplaceno. Prosperita -10`, '丘멆잺');
                    
                    showNotification('Bankrot!', 'Nelze zaplatit 칰dr쬭u budov!', 'error');
                }
            }
        }
        
        // Detail osadn칤ka
        function showSettlerDetail(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            if (!type) return;
            
            const settlerDetailTexts = {
                mood: 'N치lada', happy: 'Spokojen칳', fine: 'V pohod캩', neutral: 'Neutr치ln칤',
                level: '칔rove켿', consumption: 'Spot콏eba', perDay: '/den',
                currentBonuses: 'Aktu치ln칤 bonusy', noBonuses: '콯치dn칠 speci치ln칤 bonusy',
                gatherHistory: 'Historie sb캩ru', day: 'Den', nothing: 'nic',
                foodDay: 'j칤dla/den', waterDay: 'vody/den', meatDay: 'masa/den', leatherDay: 'k콢쬰/den',
                defense: 'obrana', attack: '칰tok', hpDay: 'HP/den', buildings: 'stavby',
                prices: 'ceny', foodBonus: 'j칤dlo', freeRepairs: 'Opravy zdarma', raidWarning: 'Varov치n칤 p콏ed n치jezdy',
                herbsDay: 'bylin/den', chemDay: 'chemik치li칤/den'
            };
            
            // Inicializace 칰rovn캩 dovednosti
            if (!settler.skillLevel) settler.skillLevel = 1;
            if (!settler.xp) settler.xp = 0;
            
            // Z칤sk치n칤 skill info
            const skillType = type.skill;
            const skillData = SETTLER_SKILLS[skillType];
            const currentLevel = settler.skillLevel;
            const currentSkill = skillData?.levels[currentLevel - 1];
            const nextSkill = skillData?.levels[currentLevel];
            
            // XP pot콏ebn칠 pro dal코칤 칰rove켿 (roste exponenci치ln캩)
            const xpForNext = currentLevel < 5 ? currentLevel * 100 : null;
            const xpPercent = xpForNext ? Math.min(100, (settler.xp / xpForNext) * 100) : 100;
            
            // N치lada
            const moods = [`游땕 ${settlerDetailTexts.happy}`, `游뗵 ${settlerDetailTexts.fine}`, `游땛 ${settlerDetailTexts.neutral}`];
            const moodIdx = settler.mood || Math.floor(Math.random() * 3);
            
            // Skill tree HTML
            let skillTreeHtml = '';
            if (skillData) {
                const skillName = skillData.name;
                skillTreeHtml = '<div style="margin-top: 1rem;">';
                skillTreeHtml += `<h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">${skillData.icon} ${skillName}</h4>`;
                skillTreeHtml += '<div style="display: flex; flex-direction: column; gap: 0.4rem;">';
                
                skillData.levels.forEach((lvl, idx) => {
                    const isUnlocked = currentLevel >= lvl.level;
                    const isCurrent = currentLevel === lvl.level;
                    const isNext = currentLevel + 1 === lvl.level;
                    const canAfford = isNext && getMoney() >= (lvl.cost || 0);
                    
                    let bgColor = '#1a1a1a';
                    let borderColor = '#333';
                    if (isUnlocked) { bgColor = '#1a2a1a'; borderColor = '#4a7a4a'; }
                    if (isCurrent) { bgColor = '#2a3a2a'; borderColor = '#8bc34a'; }
                    if (isNext) { bgColor = '#2a2a1a'; borderColor = '#7a7a4a'; }
                    
                    const lvlName = lvl.name; // Jm칠no je u 캜esky v SETTLER_SKILLS
                    const lvlBonus = lvl.bonus;
                    
                    skillTreeHtml += `<div style="background: ${bgColor}; padding: 0.5rem; border-radius: 6px; border: 2px solid ${borderColor}; display: flex; align-items: center; gap: 0.5rem;">`;
                    skillTreeHtml += `<div style="width: 28px; height: 28px; background: ${isUnlocked ? '#4caf50' : '#333'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${isUnlocked ? '#fff' : '#666'};">${lvl.level}</div>`;
                    skillTreeHtml += '<div style="flex: 1;">';
                    skillTreeHtml += `<div style="font-weight: bold; color: ${isUnlocked ? '#8bc34a' : '#888'};">${lvlName}</div>`;
                    skillTreeHtml += `<div style="font-size: 0.75rem; color: ${isUnlocked ? '#aaa' : '#666'};">${lvlBonus}</div>`;
                    skillTreeHtml += '</div>';
                    
                    if (isUnlocked) {
                        skillTreeHtml += '<span style="color: #4caf50;">九</span>';
                    } else if (isNext) {
                        skillTreeHtml += `<button class="btn" onclick="event.stopPropagation(); upgradeSettlerSkill(${settlerIdx})" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: ${canAfford ? '#ff9800' : '#555'};" ${!canAfford ? 'disabled' : ''}>游눯 ${lvl.cost}</button>`;
                    } else {
                        skillTreeHtml += '<span style="color: #555;">游</span>';
                    }
                    
                    skillTreeHtml += '</div>';
                });
                
                skillTreeHtml += '</div></div>';
            }
            
            // Aktu치ln칤 bonusy z dovednosti
            let currentBonuses = '';
            if (currentSkill && currentSkill.effect) {
                const eff = currentSkill.effect;
                if (eff.food) currentBonuses += `游꼤 +${eff.food} ${settlerDetailTexts.foodDay}<br>`;
                if (eff.water) currentBonuses += `游눦 +${eff.water} ${settlerDetailTexts.waterDay}<br>`;
                if (eff.meat) currentBonuses += `游볼 +${eff.meat} ${settlerDetailTexts.meatDay}<br>`;
                if (eff.leather) currentBonuses += `游붮 +${eff.leather} ${settlerDetailTexts.leatherDay}<br>`;
                if (eff.defense) currentBonuses += `游띠勇 +${eff.defense} ${settlerDetailTexts.defense}<br>`;
                if (eff.attack) currentBonuses += `丘덢잺 +${eff.attack} ${settlerDetailTexts.attack}<br>`;
                if (eff.healing) currentBonuses += `仇벒잺 +${eff.healing} ${settlerDetailTexts.hpDay}<br>`;
                if (eff.discount) currentBonuses += `游끵勇 -${eff.discount * 100}% ${settlerDetailTexts.buildings}<br>`;
                if (eff.tradeBonus) currentBonuses += `游눯 +${eff.tradeBonus * 100}% ${settlerDetailTexts.prices}<br>`;
                if (eff.foodBonus) currentBonuses += `游꼽 +${(eff.foodBonus - 1) * 100}% ${settlerDetailTexts.foodBonus}<br>`;
                if (eff.freeRepair) currentBonuses += `游댢 ${settlerDetailTexts.freeRepairs}<br>`;
                if (eff.upgrade) currentBonuses += `丘덢잺 +${eff.upgrade} DMG/DEF vylep코en칤<br>`;
                if (eff.raidWarning) currentBonuses += `游녜勇 ${settlerDetailTexts.raidWarning}<br>`;
                if (eff.herbs) currentBonuses += `游 +${eff.herbs} ${settlerDetailTexts.herbsDay}<br>`;
                if (eff.chemicals) currentBonuses += `游빍 +${eff.chemicals} ${settlerDetailTexts.chemDay}<br>`;
            }
            
            const typeName = getSettlerName(type.id);
            const typeDesc = SETTLER_TRANSLATIONS[currentLang]?.[type.id]?.desc || type.desc;
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${type.icon} ${settler.name}</h2>
                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 12px; border: 2px solid #444;">
                            ${type.icon}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #888;">${settlerDetailTexts.mood}: ${moods[moodIdx]}</div>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.3rem 0; color: #8bc34a;">${typeName}</h3>
                        <p style="margin: 0 0 0.8rem 0; color: #888; font-size: 0.9rem;">${typeDesc}</p>
                        
                        <!-- XP Bar -->
                        <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.8rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span style="font-size: 0.8rem; color: #ffd700;">救 ${settlerDetailTexts.level} ${currentLevel}/5</span>
                                <span style="font-size: 0.75rem; color: #888;">${currentSkill?.name || ''}</span>
                            </div>
                            <div style="background: #0a0a0a; height: 10px; border-radius: 5px; overflow: hidden;">
                                <div style="width: ${xpPercent}%; height: 100%; background: linear-gradient(90deg, #ffd700, #ff9800); transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem; text-align: right;">
                                ${xpForNext ? `${settler.xp}/${xpForNext} XP` : 'MAX'}
                            </div>
                        </div>
                        
                        <!-- Spot콏eba -->
                        <div style="font-size: 0.85rem; color: #c62828;">
                            ${settlerDetailTexts.consumption}: ${currentSkill?.consumption?.food || type.consumption?.food || 1}游꼤 ${currentSkill?.consumption?.water || type.consumption?.water || 1}游눦 ${settlerDetailTexts.perDay}
                        </div>
                    </div>
                </div>
                
                <!-- Aktu치ln칤 bonusy -->
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #3a5a3a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">游늳 ${settlerDetailTexts.currentBonuses} (${settlerDetailTexts.level.toLowerCase()} ${currentLevel})</h4>
                    <div style="font-size: 0.85rem; color: #aaa;">${currentBonuses || settlerDetailTexts.noBonuses}</div>
                </div>
                
                <!-- Historie sb캩ru pro sb캩ra캜e -->
                ${settler.type === 'scavenger_s' && settler.gatherHistory && settler.gatherHistory.length > 0 ? `
                    <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #3a3a5a;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.9rem;">游닍 ${settlerDetailTexts.gatherHistory}</h4>
                        <div style="max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${settler.gatherHistory.map(g => {
                                const resIcons = { wood: '游뿻', metal: '丘뙖잺', stone: '游뿯', cloth: '游빗', leather: '游붮', chemicals: '游빍', glass: '游댩', scrap: '鮫勇', electronics: '游' };
                                const resList = Object.entries(g.resources || {}).map(([res, count]) => `${resIcons[res] || '游닍'}${count}`).join(' ');
                                const itemsList = g.items && g.items.length > 0 ? `<br><span style="color: #ffd700;">${g.items.join(', ')}</span>` : '';
                                return `<div style="background: #0a0a1a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                                    <span style="color: #888;">${settlerDetailTexts.day} ${g.day}:</span> ${resList || settlerDetailTexts.nothing}${itemsList}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Skill Tree -->
                ${skillTreeHtml}
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="event.stopPropagation(); renameSettler(${settlerIdx});" style="flex: 1; background: #2196f3;">九勇 ${'JM칄NO'}</button>
                    <button class="btn" onclick="event.stopPropagation(); dismissSettler(${settlerIdx});" style="flex: 1; background: #c62828;">游뛁 ${'PROPUSTIT'}</button>
                </div>
                <button class="btn" onclick="event.stopPropagation(); closeModal();" style="width: 100%; margin-top: 0.5rem; background: #555; padding-bottom: 1rem;">${'九 ZAV콎칈T'}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        // Upgrade dovednosti osadn칤ka
        function upgradeSettlerSkill(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            const skillData = SETTLER_SKILLS[type?.skill];
            if (!skillData) return;
            
            const currentLevel = settler.skillLevel || 1;
            const maxLevel = skillData.levels.length; // Dynamick칳 max level podle definice
            const nextSkill = skillData.levels[currentLevel];
            
            if (!nextSkill || currentLevel >= maxLevel) {
                showModal('仇 Maximum', 'Osadn칤k u m치 maxim치ln칤 칰rove켿 dovednosti!');
                return;
            }
            
            if (getMoney() < nextSkill.cost) {
                showModal('仇 Nedostatek pen캩z', `Pot콏ebuje코 ${nextSkill.cost} 游눯 pro upgrade na 칰rove켿 ${nextSkill.level}.`);
                return;
            }
            
            // Prov칠st upgrade
            removeMoney(nextSkill.cost);
            settler.skillLevel = nextSkill.level;
            settler.xp = 0;
            
            SoundSystem.play('levelup');
            addLog(`拘勇 ${settler.name} z칤skal 칰rove켿 ${nextSkill.level}: ${nextSkill.name}!`, '救');
            
            showSettlerDetail(settlerIdx);
            renderFull();
        }
        
        // Tr칠nov치n칤 osadn칤ka
        function trainSettler(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const cost = 50;
            if (getMoney() < cost) {
                showModal('仇 Nedostatek pen캩z', `Pot콏ebuje코 ${cost} 游눯 pro tr칠nink.`);
                return;
            }
            
            // Dynamick칳 max level
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            const skillData = SETTLER_SKILLS[type?.skill];
            const maxLevel = skillData?.levels?.length || 5;
            
            if (settler.skillLevel >= maxLevel) {
                showModal('仇 Maximum', 'Osadn칤k u m치 maxim치ln칤 칰rove켿!');
                return;
            }
            
            removeMoney(cost);
            settler.xp = (settler.xp || 0) + 25 + Math.floor(Math.random() * 25);
            
            // Check level up
            const xpForNext = settler.skillLevel * 100;
            
            if (settler.xp >= xpForNext && settler.skillLevel < maxLevel) {
                settler.xp = 0;
                settler.skillLevel++;
                const newSkill = skillData?.levels[settler.skillLevel - 1];
                SoundSystem.play('levelup');
                addLog(`拘勇 ${settler.name} postoupil na 칰rove켿 ${settler.skillLevel}: ${newSkill?.name || ''}!`, '救');
            } else if (settler.skillLevel >= maxLevel) {
                settler.xp = 0; // Reset XP na maxu
                SoundSystem.play('pickup');
                addLog(`游꿉 ${settler.name} je na maxim치ln칤 칰rovni`, '游닄');
            } else {
                SoundSystem.play('pickup');
                addLog(`游꿉 ${settler.name} tr칠noval a z칤skal zku코enosti`, '游닄');
            }
            
            showSettlerDetail(settlerIdx);
            renderFull();
        }
        
        // Propu코t캩n칤 osadn칤ka
        function dismissSettler(settlerIdx) {
            console.log('游뛁 dismissSettler called with index:', settlerIdx);
            const settler = state.settlement?.settlers?.[settlerIdx];
            if (!settler) {
                console.log('游뛁 Settler not found!');
                return;
            }
            console.log('游뛁 Settler to dismiss:', settler.name);
            
            showModal('丘멆잺 Propustit obyvatele?', `
                <p>Opravdu chce코 propustit <strong>${settler.name}</strong>?</p>
                <p style="color: #ff9800; font-size: 0.9rem;">Tato akce je nevratn치!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal();" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="confirmDismissSettler(${settlerIdx})" style="background: #c62828;">九 Propustit</button>
                </div>
            `);
        }
        
        function confirmDismissSettler(settlerIdx) {
            console.log('游뛁 confirmDismissSettler called with index:', settlerIdx);
            const settler = state.settlement?.settlers?.[settlerIdx];
            if (!settler) {
                console.log('游뛁 Settler not found for confirmation!');
                return;
            }
            
            const name = settler.name;
            state.settlement.settlers.splice(settlerIdx, 1);
            addLog(`游뛁 ${name} opustil osadu`, '游녦');
            notifySuccess('Obyvatel propu코t캩n', `${name} opustil osadu`);
            closeModal();
            saveGame(true);
            renderFull();
        }
        
        // P콏ejmenov치n칤 osadn칤ka
        function renameSettler(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const newName = prompt('Zadej nov칠 jm칠no:', settler.name);
            if (newName && newName.trim() !== '') {
                const oldName = settler.name;
                settler.name = newName.trim();
                addLog(`九勇 ${oldName} se nyn칤 jmenuje ${settler.name}`, '游닇');
                showSettlerDetail(settlerIdx);
                renderFull();
            }
        }
        
        // === 2D N츼HLED OSADY ===
        function showSettlementPreview() {
            const allBuildings = [...state.base, ...state.settlement.buildings];
            const settlers = state.settlement.settlers || [];
            
            document.getElementById('modalContent').innerHTML = `
                <h2>游딬勇 N치hled osady</h2>
                <div style="background: linear-gradient(180deg, #1a2a1a 0%, #0a150a 100%); border: 3px solid #3a5a3a; border-radius: 12px; padding: 8px; margin-bottom: 1rem; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);">
                    <canvas id="settlementCanvas" width="560" height="420" style="width: 100%; border-radius: 8px; cursor: pointer;"></canvas>
                </div>
                <div id="buildingDetail" style="background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%); padding: 1rem; border-radius: 8px; min-height: 80px; border: 1px solid #444;">
                    <div style="text-align: center; color: #666;">
                        <span style="font-size: 2rem;">游끶勇</span>
                        <p style="margin: 0.5rem 0 0 0;">Klikni na budovu pro zobrazen칤 detail콢</p>
                    </div>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `;
            document.getElementById('modal').classList.add('show');
            
            setTimeout(() => renderSettlementCanvas(), 50);
        }
        
        function renderSettlementCanvas() {
            const canvas = document.getElementById('settlementCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            
            // Pozad칤 - gradient tr치vy
            const bgGrad = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, W/2);
            bgGrad.addColorStop(0, '#2a4a2a');
            bgGrad.addColorStop(0.7, '#1a3a1a');
            bgGrad.addColorStop(1, '#0a2a0a');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, W, H);
            
            // Textura tr치vy - n치hodn칠 te캜ky
            ctx.fillStyle = 'rgba(60, 100, 60, 0.3)';
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * W;
                const y = Math.random() * H;
                ctx.beginPath();
                ctx.arc(x, y, 1 + Math.random() * 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Hlavn칤 cesty - kamenn칠
            const drawRoad = (x1, y1, x2, y2, width) => {
                ctx.strokeStyle = '#5a4a3a';
                ctx.lineWidth = width;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                
                // Okraje cesty
                ctx.strokeStyle = '#3a3a2a';
                ctx.lineWidth = width + 4;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                
                ctx.strokeStyle = '#6a5a4a';
                ctx.lineWidth = width - 2;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            };
            
            drawRoad(W/2, 0, W/2, H, 14);
            drawRoad(0, H/2, W, H/2, 14);
            drawRoad(W/4, H/4, W*3/4, H/4, 8);
            drawRoad(W/4, H*3/4, W*3/4, H*3/4, 8);
            
            // Centr치ln칤 n치m캩st칤
            ctx.beginPath();
            ctx.arc(W/2, H/2, 35, 0, Math.PI * 2);
            ctx.fillStyle = '#4a4a3a';
            ctx.fill();
            ctx.strokeStyle = '#6a6a5a';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Font치na uprost콏ed
            ctx.beginPath();
            ctx.arc(W/2, H/2, 12, 0, Math.PI * 2);
            ctx.fillStyle = '#3a5a7a';
            ctx.fill();
            ctx.strokeStyle = '#7a7a7a';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            const allBuildings = [...state.base, ...state.settlement.buildings];
            const buildingPositions = [];
            
            // Rozm칤st캩n칤 budov v kruhu kolem centra
            const zones = [
                { radius: 70, count: 6, startAngle: 0 },      // Vnit콏n칤 kruh
                { radius: 130, count: 10, startAngle: 0.3 },  // St콏edn칤 kruh
                { radius: 185, count: 12, startAngle: 0.15 }  // Vn캩j코칤 kruh
            ];
            
            let buildingIdx = 0;
            
            zones.forEach(zone => {
                for (let i = 0; i < zone.count && buildingIdx < allBuildings.length; i++) {
                    const buildingId = allBuildings[buildingIdx];
                    const building = BUILDINGS.find(b => b.id === buildingId);
                    if (!building) { buildingIdx++; continue; }
                    
                    const angle = zone.startAngle + (i / zone.count) * Math.PI * 2;
                    const x = W/2 + Math.cos(angle) * zone.radius;
                    const y = H/2 + Math.sin(angle) * zone.radius;
                    
                    drawBuilding(ctx, x, y, building, buildingPositions);
                    buildingIdx++;
                }
            });
            
            // Osadn칤ci
            const settlers = state.settlement.settlers || [];
            settlers.forEach((settler, idx) => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                const angle = (idx / Math.max(settlers.length, 1)) * Math.PI * 2 + Date.now() / 5000;
                const radius = 40 + (idx % 3) * 25;
                const x = W/2 + Math.cos(angle) * radius;
                const y = H/2 + Math.sin(angle) * radius;
                
                // St칤n
                ctx.beginPath();
                ctx.ellipse(x + 2, y + 4, 5, 3, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fill();
                
                // T캩lo
                ctx.beginPath();
                ctx.arc(x, y, 7, 0, Math.PI * 2);
                const settlerGrad = ctx.createRadialGradient(x-2, y-2, 0, x, y, 7);
                settlerGrad.addColorStop(0, '#ffe0a0');
                settlerGrad.addColorStop(1, '#c0a060');
                ctx.fillStyle = settlerGrad;
                ctx.fill();
                ctx.strokeStyle = '#806040';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Ikona profese
                if (type) {
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(type.icon, x, y - 12);
                }
            });
            
            // Dekorace - stromy kolem
            const drawTree = (x, y, size) => {
                // Kmen
                ctx.fillStyle = '#5a4030';
                ctx.fillRect(x - size/6, y, size/3, size/2);
                // Koruna
                ctx.beginPath();
                ctx.arc(x, y - size/4, size/2, 0, Math.PI * 2);
                ctx.fillStyle = '#2a6a2a';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x - size/4, y, size/3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + size/4, y, size/3, 0, Math.PI * 2);
                ctx.fill();
            };
            
            // Stromy na okraj칤ch
            [[20, 30], [50, 380], [530, 50], [500, 370], [30, 200], [540, 220]].forEach(([x, y]) => {
                drawTree(x, y, 20 + Math.random() * 10);
            });
            
            // Plot kolem osady
            ctx.strokeStyle = '#6a5a4a';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.strokeRect(10, 10, W - 20, H - 20);
            ctx.setLineDash([]);
            
            // Br치na
            ctx.fillStyle = '#8a6a4a';
            ctx.fillRect(W/2 - 20, H - 15, 40, 15);
            ctx.fillStyle = '#5a4a3a';
            ctx.fillRect(W/2 - 15, H - 12, 30, 10);
            ctx.fillStyle = '#3a3a2a';
            ctx.fillText('久뾆잺', W/2, H - 5);
            
            window._settlementBuildingPositions = buildingPositions;
            
            // Click event pro detail budovy
            canvas.onclick = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mx = (e.clientX - rect.left) * scaleX;
                const my = (e.clientY - rect.top) * scaleY;
                
                let found = null;
                for (const pos of window._settlementBuildingPositions || []) {
                    const dist = Math.sqrt((mx - pos.x) ** 2 + (my - pos.y) ** 2);
                    if (dist < pos.size) {
                        found = pos;
                        break;
                    }
                }
                
                const detail = document.getElementById('buildingDetail');
                if (detail && found) {
                    const b = found.building;
                    let prodText = '';
                    if (b.production) {
                        const prods = Object.entries(b.production).map(([k, v]) => {
                            const icons = {food: '游꼤', water: '游눦', wood: '游', metal: '丘뙖잺', stone: '游', cloth: '游빗', power: '丘'};
                            return `${icons[k] || '游닍'} +${v} ${k}`;
                        });
                        prodText = prods.join(', ');
                    }
                    
                    let defText = b.defense ? `游띠勇 +${b.defense} obrana` : '';
                    let powerText = b.requiresPower ? `丘 Spot콏eba: ${b.requiresPower}` : '';
                    
                    // Vr치cen칠 suroviny p콏i zbour치n칤 (50% n치klad콢)
                    let refundText = '';
                    if (b.cost) {
                        const refunds = Object.entries(b.cost).map(([k, v]) => {
                            const icons = {wood: '游뿻', metal: '游댤', stone: '游', cloth: '游빗', electronics: '游댋', glass: '游댩'};
                            return `${icons[k] || '游닍'} ${Math.floor(v * 0.5)}`;
                        });
                        refundText = refunds.join(' ');
                    }
                    
                    detail.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 3rem; background: linear-gradient(135deg, ${found.color} 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 10px; border: 2px solid #555;">${b.icon}</div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #fff;">${b.name}</h3>
                                <p style="margin: 0.3rem 0; color: #8bc34a;">${b.desc}</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${prodText ? `<span style="background: #1a3a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${prodText}</span>` : ''}
                                    ${defText ? `<span style="background: #3a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${defText}</span>` : ''}
                                    ${powerText ? `<span style="background: #3a3a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${powerText}</span>` : ''}
                                </div>
                                <div style="margin-top: 0.8rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                                    <button onclick="demolishBuilding('${b.id}')" style="background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%); border: none; color: #fff; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                        游끵勇 Zbourat ${refundText ? `(vr치t칤: ${refundText})` : ''}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (detail) {
                    detail.innerHTML = `
                        <div style="text-align: center; color: #666;">
                            <span style="font-size: 2rem;">游끶勇</span>
                            <p style="margin: 0.5rem 0 0 0;">Klikni na budovu pro zobrazen칤 detail콢</p>
                        </div>
                    `;
                }
            };
            
            // Hover efekt
            canvas.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mx = (e.clientX - rect.left) * scaleX;
                const my = (e.clientY - rect.top) * scaleY;
                
                let isOver = false;
                for (const pos of window._settlementBuildingPositions || []) {
                    const dist = Math.sqrt((mx - pos.x) ** 2 + (my - pos.y) ** 2);
                    if (dist < pos.size) {
                        isOver = true;
                        break;
                    }
                }
                canvas.style.cursor = isOver ? 'pointer' : 'default';
            };
        }
        
        function drawBuilding(ctx, x, y, building, positions) {
            // Barva podle kategorie
            let color = '#4a4a4a';
            let roofColor = '#3a3a3a';
            if (building.category === 'living') { color = '#4a6a4a'; roofColor = '#3a5a3a'; }
            else if (building.category === 'production') { color = '#4a5a6a'; roofColor = '#3a4a5a'; }
            else if (building.category === 'defense') { color = '#6a4a4a'; roofColor = '#5a3a3a'; }
            else if (building.category === 'utility') { color = '#6a6a4a'; roofColor = '#5a5a3a'; }
            
            // Velikost podle typu
            let size = 22;
            if (building.id === 'wall' || building.id === 'gate') size = 16;
            else if (building.id.includes('house') || building.id.includes('barracks')) size = 28;
            else if (building.id.includes('farm') || building.id.includes('warehouse')) size = 30;
            else if (building.id.includes('tower')) size = 20;
            
            // St칤n
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(x + 3, y + size/2 + 2, size/2, size/4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Z치kladna budovy
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(x - size/2, y - size/2, size, size, 3);
            ctx.fill();
            
            // Gradient efekt
            const grad = ctx.createLinearGradient(x - size/2, y - size/2, x + size/2, y + size/2);
            grad.addColorStop(0, 'rgba(255,255,255,0.2)');
            grad.addColorStop(0.5, 'rgba(255,255,255,0)');
            grad.addColorStop(1, 'rgba(0,0,0,0.2)');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.roundRect(x - size/2, y - size/2, size, size, 3);
            ctx.fill();
            
            // St콏echa
            ctx.fillStyle = roofColor;
            ctx.beginPath();
            ctx.moveTo(x - size/2 - 3, y - size/2);
            ctx.lineTo(x, y - size/2 - 10);
            ctx.lineTo(x + size/2 + 3, y - size/2);
            ctx.closePath();
            ctx.fill();
            
            // Okraj
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.roundRect(x - size/2, y - size/2, size, size, 3);
            ctx.stroke();
            
            // Ikona
            ctx.font = `${Math.max(12, size - 8)}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#000';
            ctx.shadowBlur = 3;
            ctx.fillText(building.icon, x, y + 2);
            ctx.shadowBlur = 0;
            
            positions.push({ x, y, size: size + 5, building, color });
        }
        
        
        function hasPower() {
            return calculatePowerBalance() >= 0;
        }
        
        function showPowerModal() {
            const produced = calculatePowerProduction();
            const consumed = calculatePowerConsumption();
            const balance = produced - consumed;
            const fuelPerDay = getFuelConsumption();
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Hlavn칤 p콏ehled
            html += '<div style="text-align: center; margin-bottom: 1.5rem;">';
            html += '<div style="font-size: 4rem; margin-bottom: 0.5rem;">丘</div>';
            html += '<div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem;">';
            html += '<div style="text-align: center;"><div style="font-size: 2rem; color: #8bc34a;">' + produced + '</div><div style="font-size: 0.8rem; color: #888;">Produkce</div></div>';
            html += '<div style="text-align: center;"><div style="font-size: 2rem; color: #c62828;">' + consumed + '</div><div style="font-size: 0.8rem; color: #888;">Spot콏eba</div></div>';
            html += '<div style="text-align: center;"><div style="font-size: 2rem; color: ' + (balance >= 0 ? '#ffd700' : '#ff5722') + ';">' + (balance >= 0 ? '+' : '') + balance + '</div><div style="font-size: 0.8rem; color: #888;">Bilance</div></div>';
            html += '</div>';
            
            // Status bar
            const statusColor = balance >= 0 ? '#8bc34a' : '#c62828';
            const statusText = balance >= 0 ? '九 Dostatek energie' : '丘멆잺 Nedostatek energie!';
            html += '<div style="background: ' + (balance >= 0 ? '#1a2a1a' : '#2a1a1a') + '; padding: 0.8rem; border-radius: 8px; border: 1px solid ' + statusColor + ';">';
            html += '<strong style="color: ' + statusColor + ';">' + statusText + '</strong>';
            if (balance < 0) {
                html += '<p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #aaa;">N캩kter칠 budovy nefunguj칤! Postav v칤ce zdroj콢 energie.</p>';
            }
            html += '</div>';
            html += '</div>';
            
            // Palivo
            if (fuelPerDay > 0) {
                const fuelDays = state.settlement.resources.fuel ? Math.floor(state.settlement.resources.fuel / fuelPerDay) : 0;
                html += '<div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a4a2a;">';
                html += '<h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">久 Spot콏eba paliva</h4>';
                html += '<p style="margin: 0;">Gener치tor spot콏ebuje <strong>' + fuelPerDay + ' paliva/den</strong></p>';
                html += '<p style="margin: 0.3rem 0 0 0; color: #888;">Z치soby: ' + (state.settlement.resources.fuel || 0) + ' paliva (' + fuelDays + ' dn칤)</p>';
                html += '</div>';
            }
            
            // Zdroje energie
            html += '<h4 style="color: #8bc34a; margin-bottom: 0.5rem;">游댊 Zdroje energie</h4>';
            html += '<div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">';
            
            const powerSources = BUILDINGS.filter(b => b.production && b.production.power);
            powerSources.forEach(building => {
                const hasIt = state.base.includes(building.id) || state.settlement.buildings.includes(building.id);
                // Kontrola paliva pro gener치tor
                const needsFuel = building.consumption && building.consumption.fuel;
                const hasFuel = !needsFuel || (state.settlement?.resources?.fuel || 0) >= building.consumption.fuel;
                const isWorking = hasIt && hasFuel;
                
                html += '<div style="background: ' + (hasIt ? (isWorking ? '#1a2a1a' : '#2a1a1a') : '#1a1a1a') + '; padding: 0.8rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid ' + (hasIt ? (isWorking ? '#4a7c4a' : '#7c4a4a') : '#333') + ';">';
                html += '<div><span style="font-size: 1.2rem;">' + building.icon + '</span> <strong>' + building.name + '</strong> <span style="color: ' + (isWorking ? '#8bc34a' : '#666') + ';">' + (isWorking ? '+' : '丘멆잺 ') + building.production.power + ' 丘</span>';
                if (needsFuel) {
                    html += ' <span style="color: ' + (hasFuel ? '#ff9800' : '#c62828') + '; font-size: 0.8rem;">(-' + building.consumption.fuel + ' 久' + (hasFuel ? '' : ' CHYB칈!') + ')</span>';
                }
                html += '</div>';
                if (hasIt) {
                    html += '<span style="color: ' + (isWorking ? '#8bc34a' : '#c62828') + ';">' + (isWorking ? '九 Funguje' : '仇 Bez paliva') + '</span>';
                } else {
                    html += '<span style="color: #666;">仇</span>';
                }
                html += '</div>';
            });
            html += '</div>';
            
            // Budovy vy쬬duj칤c칤 elekt콏inu
            html += '<h4 style="color: #c62828; margin-bottom: 0.5rem;">游댋 Budovy vy쬬duj칤c칤 energii</h4>';
            html += '<div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">';
            
            const powerConsumers = BUILDINGS.filter(b => b.requiresPower);
            powerConsumers.forEach(building => {
                const hasIt = state.base.includes(building.id) || state.settlement.buildings.includes(building.id);
                const working = hasIt && hasPower();
                html += '<div style="background: ' + (hasIt ? (working ? '#1a2a1a' : '#2a1a1a') : '#1a1a1a') + '; padding: 0.8rem; border-radius: 6px; border: 1px solid ' + (hasIt ? (working ? '#4a7c4a' : '#7c4a4a') : '#333') + ';">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><span style="font-size: 1.2rem;">' + building.icon + '</span> <strong>' + building.name + '</strong> <span style="color: #c62828;">-' + building.requiresPower + ' 丘</span>';
                html += '<div style="font-size: 0.75rem; color: #888;">' + building.desc + '</div>';
                html += '</div>';
                if (hasIt) {
                    html += '<span style="color: ' + (working ? '#8bc34a' : '#c62828') + ';">' + (working ? '丘 Funguje' : '仇 Bez proudu') + '</span>';
                } else {
                    html += '<span style="color: #666;">Nepostaveno</span>';
                }
                html += '</div>';
                // Tla캜칤tko pro zbour치n칤 budovy bez proudu
                if (hasIt && !working) {
                    html += '<div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">';
                    html += '<button onclick="closeModal(); demolishBuilding(\'' + building.id + '\')" style="flex: 1; padding: 0.4rem; background: #8b0000; border: none; color: #fff; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">游끵勇 Zbourat</button>';
                    html += '</div>';
                }
                html += '</div>';
            });
            html += '</div>';
            
            // Tipy
            html += '<div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; border: 1px solid #2d2d4a;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">游눠 Tipy</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            html += '<li>驕勇 Sol치rn칤 panely nevy쬬duj칤 palivo</li>';
            html += '<li>丘 Gener치tor produkuje nejv칤c, ale pot콏ebuje palivo</li>';
            html += '<li>游 V캩trn치 turb칤na je dobr칳 kompromis</li>';
            html += '<li>游댋 Budovy bez elekt콏iny nefunguj칤!</li>';
            html += '</ul>';
            html += '</div>';
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('丘 Elektrick치 s칤콘', html);
        }
        
        function getFuelConsumption() {
            let fuel = 0;
            const allBuildings = [...state.base, ...state.settlement.buildings];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.consumption && building.consumption.fuel) {
                    fuel += building.consumption.fuel;
                }
            });
            
            return fuel;
        }
        
        function showResourcesModal() {
            const icons = { 
                wood: '游', metal: '丘뙖잺', stone: '游', cloth: '游빗', fuel: '久', leather: '游붮', 
                herbs: '游', chemicals: '游빍', electronics: '游', glass: '游댩', rope: '俱', 
                gunpowder: '游눤', scrap: '游댤', copper: '游릯', silver: '拘', gold: '游리', 
                crystal: '游', gems: '游눑', food: '游꼤', water: '游눦'
            };
            const names = {
                wood: 'D콏evo', metal: 'Kov', stone: 'K치men', cloth: 'L치tka', fuel: 'Palivo',
                leather: 'K콢쬰', herbs: 'Byliny', chemicals: 'Chemik치lie', electronics: 'Elektronika',
                glass: 'Sklo', rope: 'Provaz', gunpowder: 'St콏eln칳 prach', scrap: 'rot',
                copper: 'M캩캞', silver: 'St콏칤bro', gold: 'Zlato', crystal: 'Krystal', gems: 'Drahokamy',
                food: 'J칤dlo', water: 'Voda'
            };
            
            // Migrace - ujisti se 쬰 settlement.resources m치 v코echny kl칤캜e
            Object.keys(icons).forEach(r => {
                if (state.settlement.resources[r] === undefined) state.settlement.resources[r] = 0;
            });
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // === Z츼SOBY OSADY (j칤dlo, voda) ===
            html += '<h4 style="color: #ffd700; margin-top: 0;">游낅 Z치soby osady (j칤dlo & voda)</h4>';
            html += '<p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Z치soby pro obyvatele. M콢쬰코 p콏idat nebo vz칤t.</p>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-bottom: 1rem;">';
            
            // J칤dlo
            html += '<div style="background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%); padding: 1rem; border-radius: 8px; border: 2px solid #4a4a2d;">';
            html += '<div style="text-align: center; margin-bottom: 0.5rem;">';
            html += '<span style="font-size: 2rem;">游꼤</span>';
            html += '<div style="font-size: 1.5rem; color: #ffd700; font-weight: bold;">' + (state.settlement.resources.food || 0) + '</div>';
            html += '<div style="font-size: 0.8rem; color: #888;">J칤dlo v osad캩</div>';
            html += '</div>';
            html += '<div style="display: flex; gap: 0.3rem;">';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', -5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-5</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', -1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', 1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', 5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+5</button>';
            html += '</div></div>';
            
            // Voda
            html += '<div style="background: linear-gradient(135deg, #1a2a2a 0%, #0a1a1a 100%); padding: 1rem; border-radius: 8px; border: 2px solid #2d4a4a;">';
            html += '<div style="text-align: center; margin-bottom: 0.5rem;">';
            html += '<span style="font-size: 2rem;">游눦</span>';
            html += '<div style="font-size: 1.5rem; color: #2196f3; font-weight: bold;">' + (state.settlement.resources.water || 0) + '</div>';
            html += '<div style="font-size: 0.8rem; color: #888;">Voda v osad캩</div>';
            html += '</div>';
            html += '<div style="display: flex; gap: 0.3rem;">';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', -5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-5</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', -1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', 1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', 5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+5</button>';
            html += '</div></div>';
            
            html += '</div>';
            
            // Info o spot콏eb캩
            const balance = calculateSettlementBalance();
            html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">';
            html += '<div style="font-size: 0.85rem; color: #888;">Denn칤 bilance:</div>';
            html += '<div style="display: flex; justify-content: space-around; margin-top: 0.3rem;">';
            html += '<span style="color: ' + (balance.food >= 0 ? '#8bc34a' : '#c62828') + ';">游꼤 ' + (balance.food >= 0 ? '+' : '') + balance.food + '/den</span>';
            html += '<span style="color: ' + (balance.water >= 0 ? '#8bc34a' : '#c62828') + ';">游눦 ' + (balance.water >= 0 ? '+' : '') + balance.water + '/den</span>';
            html += '</div></div>';
            
            // === SKLAD SUROVIN OSADY ===
            html += '<h4 style="color: #2196f3; margin-top: 1rem;">游닍 Sklad osady (suroviny)</h4>';
            html += '<p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Suroviny ulo쬰n칠 v osad캩. Osadn칤ci je sem p콏id치vaj칤, ty je m콢쬰코 vz칤t.</p>';
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'copper'];
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">';
            resourceKeys.forEach(res => {
                const settlementAmt = state.settlement.resources[res] || 0;
                const playerAmt = state.resources[res] || 0;
                if (settlementAmt > 0 || playerAmt > 0 || ['wood', 'metal', 'stone', 'cloth'].includes(res)) {
                    html += '<div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; border: 1px solid #333;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">';
                    html += '<span style="font-size: 1.2rem;">' + (icons[res] || '游닍') + '</span>';
                    html += '<span style="font-size: 0.7rem; color: #888;">' + (names[res] || res) + '</span>';
                    html += '</div>';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">';
                    html += '<div style="text-align: center;">';
                    html += '<div style="font-size: 0.65rem; color: #666;">Osada</div>';
                    html += '<div style="font-size: 1rem; color: #2196f3; font-weight: bold;">' + settlementAmt + '</div>';
                    html += '</div>';
                    html += '<div style="text-align: center;">';
                    html += '<div style="font-size: 0.65rem; color: #666;">Ty</div>';
                    html += '<div style="font-size: 1rem; color: #8bc34a; font-weight: bold;">' + playerAmt + '</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '<div style="display: flex; gap: 0.2rem;">';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 1)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #4caf50;" title="Vz칤t 1"> 1</button>';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 5)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #4caf50;" title="Vz칤t 5"> 5</button>';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 1)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #2196f3;" title="D치t 1">1 </button>';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 5)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #2196f3;" title="D치t 5">5 </button>';
                    html += '</div>';
                    html += '</div>';
                }
            });
            html += '</div>';
            
            // Rychl칠 akce
            html += '<div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">';
            html += '<button class="btn" onclick="transferAllToSettlement()" style="flex: 1; background: #2196f3;">游닍 Ulo쬴t v코e do osady</button>';
            html += '<button class="btn" onclick="transferAllToPlayer()" style="flex: 1; background: #4caf50;">游 Vz칤t v코e z osady</button>';
            html += '</div>';
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('游빜 Sklad osady', html);
        }
        
        // P콏esun suroviny mezi hr치캜em a osadou
        function transferResource(resource, direction, amount) {
            // Kontrola jestli je hr치캜 v osad캩
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('Nejsi v osad캩', 'P콏esuny surovin jsou mo쬹칠 pouze v osad캩!');
                return;
            }
            
            if (direction === 'toSettlement') {
                // Hr치캜  Osada
                const playerHas = state.resources[resource] || 0;
                const toTransfer = Math.min(amount, playerHas);
                if (toTransfer > 0) {
                    state.resources[resource] -= toTransfer;
                    state.settlement.resources[resource] = (state.settlement.resources[resource] || 0) + toTransfer;
                    SoundSystem.play('pickup');
                }
            } else {
                // Osada  Hr치캜
                const settlementHas = state.settlement.resources[resource] || 0;
                const toTransfer = Math.min(amount, settlementHas);
                if (toTransfer > 0) {
                    state.settlement.resources[resource] -= toTransfer;
                    state.resources[resource] = (state.resources[resource] || 0) + toTransfer;
                    SoundSystem.play('pickup');
                }
            }
            showStorageModal();
        }
        
        // P콏esun v코ech surovin do osady
        function transferAllToSettlement() {
            // Kontrola jestli je hr치캜 v osad캩
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('Nejsi v osad캩', 'P콏esuny surovin jsou mo쬹칠 pouze v osad캩!');
                return;
            }
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
            let transferred = 0;
            resourceKeys.forEach(res => {
                const amt = state.resources[res] || 0;
                if (amt > 0) {
                    state.settlement.resources[res] = (state.settlement.resources[res] || 0) + amt;
                    state.resources[res] = 0;
                    transferred += amt;
                }
            });
            if (transferred > 0) {
                SoundSystem.play('pickup');
                addLog(`Ulo쬴l jsi ${transferred} surovin do skladu osady`, '游닍');
            }
            showStorageModal();
        }
        
        // Vz칤t v코echny suroviny z osady
        function transferAllToPlayer() {
            // Kontrola jestli je hr치캜 v osad캩
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('Nejsi v osad캩', 'P콏esuny surovin jsou mo쬹칠 pouze v osad캩!');
                return;
            }
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
            let transferred = 0;
            resourceKeys.forEach(res => {
                const amt = state.settlement.resources[res] || 0;
                if (amt > 0) {
                    state.resources[res] = (state.resources[res] || 0) + amt;
                    state.settlement.resources[res] = 0;
                    transferred += amt;
                }
            });
            if (transferred > 0) {
                SoundSystem.play('pickup');
                addLog(`Vzal jsi ${transferred} surovin ze skladu osady`, '游');
            }
            showStorageModal();
        }
        
        // Z칤skej v코echny polo쬶y j칤dla/vody z invent치콏e
        function getInventoryFoodItems() {
            return state.inv.filter(i => i.type === 'consumable' && (i.effect === 'hunger' || i.id?.includes('meat') || i.id?.includes('food') || i.id?.includes('ration')));
        }
        
        function getInventoryWaterItems() {
            return state.inv.filter(i => i.type === 'consumable' && (i.effect === 'thirst' || i.id?.includes('water')));
        }
        
        function getTotalFoodCount() {
            return getInventoryFoodItems().reduce((sum, i) => sum + (i.count || 1), 0);
        }
        
        function getTotalWaterCount() {
            return getInventoryWaterItems().reduce((sum, i) => sum + (i.count || 1), 0);
        }
        
        // Transfer food/water to/from settlement
        function transferSettlementResource(type, amount) {
            if (amount > 0) {
                // P콏idat do osady - vz칤t z invent치콏e
                const items = type === 'food' ? getInventoryFoodItems() : getInventoryWaterItems();
                const totalAvailable = items.reduce((sum, i) => sum + (i.count || 1), 0);
                
                if (totalAvailable < amount) {
                    notifyWarning('Nem치코 dost!', `M치코 jen ${totalAvailable}x ${type === 'food' ? 'j칤dlo' : 'vodu'}`);
                    return;
                }
                
                // Odeber z invent치콏e (od prvn칤ch polo쬰k)
                let toRemove = amount;
                for (const item of items) {
                    if (toRemove <= 0) break;
                    const itemCount = item.count || 1;
                    const removeFromThis = Math.min(itemCount, toRemove);
                    item.count = itemCount - removeFromThis;
                    toRemove -= removeFromThis;
                }
                
                // Vy캜isti pr치zdn칠 polo쬶y
                state.inv = state.inv.filter(i => !i.count || i.count > 0);
                
                // P콏idej do osady
                state.settlement.resources[type] = (state.settlement.resources[type] || 0) + amount;
                notifySuccess(`P콏id치no do osady`, `+${amount} ${type === 'food' ? '游꼤' : '游눦'}`);
                renderFull();
            } else {
                // Vz칤t z osady - d치t do invent치콏e
                const takeAmount = Math.abs(amount);
                if ((state.settlement.resources[type] || 0) < takeAmount) {
                    notifyWarning('V osad캩 nen칤 dost!', `Jen ${state.settlement.resources[type] || 0} ${type === 'food' ? '游꼤' : '游눦'}`);
                    return;
                }
                
                // Odeber z osady
                state.settlement.resources[type] -= takeAmount;
                
                // P콏idej do invent치콏e
                const itemData = type === 'food' 
                    ? { id: 'settlement_food', name: 'Z치soby j칤dla', icon: '游꼤', type: 'consumable', effect: 'hunger', value: 25, weight: 0.5 }
                    : { id: 'settlement_water', name: 'Z치soby vody', icon: '游눦', type: 'consumable', effect: 'thirst', value: 30, weight: 0.5 };
                
                const existing = state.inv.find(i => i.id === itemData.id);
                if (existing) {
                    existing.count = (existing.count || 1) + takeAmount;
                } else {
                    state.inv.push({...itemData, count: takeAmount});
                }
                
                notifySuccess(`Vzato z osady`, `+${takeAmount} ${type === 'food' ? '游꼤' : '游눦'}`);
                renderFull();
            }
        }
        
        // === SETTLEMENT SPECIALIZATION ===
        function showSpecializationModal() {
            const specTexts = {
                intro: 'Vyber specializaci pro svou osadu. Lze zm캩nit kdykoliv.',
                guards: 'str치쬮콢', traders: 'obchodn칤k콢', farmers: 'farm치콏콢', medics: 'medik콢', builders: 'stavitel콢',
                barracks: 'Kas치rny', market: 'Tr쬴코t캩', farmland: 'Farmland', infirmary: 'O코et콏ovna', workshop: 'D칤lna', forge: 'Kov치rna',
                active: 'AKTIVN칈', activate: 'Aktivovat', notMet: 'Nespln캩no'
            };
            
            let html = '<p style="margin-bottom: 1rem;">' + specTexts.intro + '</p>';
            
            html += '<div style="display: grid; gap: 0.5rem;">';
            SETTLEMENT_SPECIALIZATIONS.forEach(spec => {
                const isActive = state.settlement.specialization === spec.id;
                const canActivate = checkSpecializationRequirements(spec);
                const specName = spec.name;
                const specDesc = spec.desc;
                
                // Build requirements text
                let reqText = [];
                if (spec.requirement) {
                    if (spec.requirement.guards) {
                        const have = state.settlement.settlers.filter(s => s.type === 'guard').length;
                        const need = spec.requirement.guards;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游눅 ${have}/${need} ${specTexts.guards}</span>`);
                    }
                    if (spec.requirement.traders) {
                        const have = state.settlement.settlers.filter(s => s.type === 'trader_s').length;
                        const need = spec.requirement.traders;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游눺 ${have}/${need} ${specTexts.traders}</span>`);
                    }
                    if (spec.requirement.farmers) {
                        const have = state.settlement.settlers.filter(s => s.type === 'farmer').length;
                        const need = spec.requirement.farmers;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游녿꽳릛 ${have}/${need} ${specTexts.farmers}</span>`);
                    }
                    if (spec.requirement.medics) {
                        const have = state.settlement.settlers.filter(s => s.type === 'medic_s').length;
                        const need = spec.requirement.medics;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">丘됊잺 ${have}/${need} ${specTexts.medics}</span>`);
                    }
                    if (spec.requirement.builders) {
                        const have = state.settlement.settlers.filter(s => s.type === 'builder').length;
                        const need = spec.requirement.builders;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游농 ${have}/${need} ${specTexts.builders}</span>`);
                    }
                    if (spec.requirement.barracks) {
                        const ok = state.settlement.buildings.includes('barracks');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游띠勇 ${specTexts.barracks} ${ok ? '九' : '九'}</span>`);
                    }
                    if (spec.requirement.market) {
                        const ok = state.settlement.buildings.includes('market');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游낅 ${specTexts.market} ${ok ? '九' : '九'}</span>`);
                    }
                    if (spec.requirement.farmland) {
                        const ok = state.settlement.buildings.includes('farmland');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游 ${specTexts.farmland} ${ok ? '九' : '九'}</span>`);
                    }
                    if (spec.requirement.infirmary) {
                        const ok = state.base.includes('infirmary');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游낀 ${specTexts.infirmary} ${ok ? '九' : '九'}</span>`);
                    }
                    if (spec.requirement.workshop) {
                        const ok = state.base.includes('workshop');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">游댢 ${specTexts.workshop} ${ok ? '九' : '九'}</span>`);
                    }
                    if (spec.requirement.forge) {
                        const ok = state.settlement.buildings.includes('forge') || state.base.includes('forge');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">丘뉦잺 ${specTexts.forge} ${ok ? '九' : '九'}</span>`);
                    }
                }
                
                html += `
                    <div style="background: ${isActive ? 'var(--toxic-dark)' : '#2a2a2a'}; padding: 1rem; border-radius: 8px; border: 2px solid ${isActive ? 'var(--toxic-green)' : canActivate ? 'var(--metal-light)' : '#555'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0; color: ${isActive ? 'var(--toxic-green)' : '#fff'};">${spec.icon} ${specName}</h4>
                                <p style="margin: 0.3rem 0; font-size: 0.85rem; color: var(--toxic-green);">${specDesc}</p>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${reqText.join(' ')}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                ${isActive ? '<span style="color: var(--toxic-green); font-weight: bold;">九 ' + specTexts.active + '</span>' : 
                                  canActivate ? `<button class="btn" onclick="setSpecialization('${spec.id}')" style="padding: 0.5rem 1rem;">${specTexts.activate}</button>` :
                                  '<span style="color: #c62828; font-size: 0.8rem;">游 ' + specTexts.notMet + '</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">' + t('ui', 'close') + '</button>';
            
            showModal('游끹勇 Specializace osady', html);
        }
        
        function checkSpecializationRequirements(spec) {
            if (!spec.requirement) return true;
            
            // Check settlers
            if (spec.requirement.guards) {
                const guardCount = state.settlement.settlers.filter(s => s.type === 'guard').length;
                if (guardCount < spec.requirement.guards) return false;
            }
            if (spec.requirement.traders) {
                const traderCount = state.settlement.settlers.filter(s => s.type === 'trader_s').length;
                if (traderCount < spec.requirement.traders) return false;
            }
            if (spec.requirement.farmers) {
                const farmerCount = state.settlement.settlers.filter(s => s.type === 'farmer').length;
                if (farmerCount < spec.requirement.farmers) return false;
            }
            if (spec.requirement.medics) {
                const medicCount = state.settlement.settlers.filter(s => s.type === 'medic_s').length;
                if (medicCount < spec.requirement.medics) return false;
            }
            if (spec.requirement.builders) {
                const builderCount = state.settlement.settlers.filter(s => s.type === 'builder').length;
                if (builderCount < spec.requirement.builders) return false;
            }
            
            // Check buildings
            if (spec.requirement.barracks && !state.settlement.buildings.includes('barracks')) return false;
            if (spec.requirement.market && !state.settlement.buildings.includes('market')) return false;
            if (spec.requirement.farmland && !state.settlement.buildings.includes('farmland')) return false;
            if (spec.requirement.infirmary && !state.base.includes('infirmary')) return false;
            if (spec.requirement.workshop && !state.base.includes('workshop')) return false;
            if (spec.requirement.forge && !state.settlement.buildings.includes('forge') && !state.base.includes('forge')) return false;
            
            return true;
        }
        
        function setSpecialization(specId) {
            state.settlement.specialization = specId;
            const spec = SETTLEMENT_SPECIALIZATIONS.find(s => s.id === specId);
            closeModal();
            addLog(`游끹勇 Osada se specializovala na: ${spec.name}`, '游끹勇');
            showModal('游끹勇 Specializace aktivov치na!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${spec.icon}</div>
                    <h3>${spec.name}</h3>
                    <p style="color: var(--toxic-green);">${spec.desc}</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function triggerSettlementRaid() {
            const defense = calculateSettlementDefense();
            const raiderPower = Math.floor(Math.random() * 30) + 20; // 20-50
            
            setTimeout(() => {
                if (defense >= raiderPower) {
                    // Successfully defended
                    const loot = Math.floor(Math.random() * 200) + 100;
                    addMoney(loot);
                    state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 5);
                    
                    showModal('游띠勇 칔tok odra쬰n!',
                        `<div style="text-align: center;">` +
                        `<p style="color: #8bc34a; font-weight: bold; margin-bottom: 1rem;">Tv치 osada odrazila 칰tok raider콢!</p>` +
                        `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                        `<p>游띠勇 Obrana: ${defense}</p>` +
                        `<p>丘덢잺 Raide콏i: ${raiderPower}</p>` +
                        `</div>` +
                        `<p style="color: #ffd700;">游눯 Loot z raider콢: ${loot} pen캩z!</p>` +
                        `<p style="color: #8bc34a;">+5 prosperity</p>` +
                        `</div>`
                    );
                    addLog('Osada odrazila 칰tok!', '游띠勇');
                } else {
                    // Raid successful - lose resources
                    const foodLoss = Math.floor(state.settlement.resources.food * 0.3);
                    const waterLoss = Math.floor(state.settlement.resources.water * 0.3);
                    state.settlement.resources.food -= foodLoss;
                    state.settlement.resources.water -= waterLoss;
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 15);
                    
                    // Possible settler injury/death
                    if (state.settlement.settlers.length > 0 && Math.random() < 0.3) {
                        const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                        const settler = state.settlement.settlers[idx];
                        state.settlement.settlers.splice(idx, 1);
                        
                        showModal('游 Raid!',
                            `<div style="text-align: center;">` +
                            `<p style="color: #c62828; font-weight: bold; margin-bottom: 1rem;">Raide콏i p콏epadli tvou osadu!</p>` +
                            `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                            `<p>游띠勇 Obrana: ${defense} (slab치!)</p>` +
                            `<p>丘덢잺 Raide콏i: ${raiderPower}</p>` +
                            `</div>` +
                            `<p style="color: #ff9800;">Ztr치ty:</p>` +
                            `<p>游꼤 -${foodLoss} j칤dla</p>` +
                            `<p>游눦 -${waterLoss} vody</p>` +
                            `<p style="color: #c62828;">游 ${settler.name} byl zabit!</p>` +
                            `<p style="color: #ff9800;">-15 prosperity</p>` +
                            `</div>`
                        );
                        addLog(`Raid! ${settler.name} zahynul!`, '游');
                    } else {
                        showModal('丘멆잺 Raid!',
                            `<div style="text-align: center;">` +
                            `<p style="color: #ff9800; font-weight: bold; margin-bottom: 1rem;">Raide콏i p콏epadli tvou osadu!</p>` +
                            `<p style="color: #ff9800;">Ztr치ty:</p>` +
                            `<p>游꼤 -${foodLoss} j칤dla</p>` +
                            `<p>游눦 -${waterLoss} vody</p>` +
                            `<p style="color: #ff9800;">-15 prosperity</p>` +
                            `<p style="margin-top: 1rem; color: #999;">Zvy코 obranu osady!</p>` +
                            `</div>`
                        );
                        addLog('Osada byla p콏epadena!', '丘멆잺');
                    }
                    SoundSystem.play('death');
                }
            }, 1000);
        }
        
        function raidVillage() {
            closeModal();
            
            // Create multiple enemies for village raid (3-5)
            const enemyCount = Math.floor(Math.random() * 3) + 3; // 3-5 enemies
            const enemyTypes = ['raider', 'bandit', 'zombie', 'mutant'];
            const selectedEnemy = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            
            // Start combat with multiple enemies
            startCombat({id: selectedEnemy}, false, true); // true = village raid
        }
        
        // Pokus o 칰t캩k
        // tryToFlee je definov치na v칳코e (콏치dek ~15403)
        
        // === START COMBAT WITH PREDEFINED GROUP ===
        // ============================================
        // === HEROES 3 STYLE COMBAT SYSTEM ===
        // ============================================
        
        // Bojov치 m콏칤쬶a: 7 sloupc콢 x 3 콏치dky
        // Sloupce 0-2: nep콏치tel칠, sloupec 3: st콏ed, sloupce 4-6: hr치캜
        const COMBAT_GRID = { cols: 9, rows: 5 };
        
        function startCombatWithGroup(enemyGroup, combatType = 'normal', skipPreCombat = false) {
            console.log('丘덢잺 startCombatWithGroup called with', enemyGroup?.length || 0, 'enemies, type:', combatType);
            
            if (!enemyGroup || enemyGroup.length === 0) {
                console.error('丘덢잺 startCombatWithGroup: No enemies!');
                notifyError('Chyba boje', '콯치dn칤 nep콏치tel칠!');
                return;
            }
            
            // === MUNICE PRO SPOLE캛N칈KY ===
            // Spole캜n칤ci nyn칤 spot콏ebov치vaj칤 munici p콏칤mo z invent치콏e hr치캜e p콏i ka쬯칠m 칰toku
            // (kontrola prob칤h치 v 칰to캜n칠m k칩du)
            
            // Pokud m치me spole캜n칤ky a nen칤 p콏esko캜en칤, uka pre-combat setup
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
            if (aliveCompanions.length > 0 && !skipPreCombat && !window._inPreCombatFlow) {
                console.log('游꿡 Showing pre-combat setup for', aliveCompanions.length, 'companions');
                showPreCombatSetup(enemyGroup, combatType);
                return;
            }
            
            // Reset flag
            window._inPreCombatFlow = false;
            
            closeModal();
            
            // Reset Phoenix efektu pro nov칳 boj
            window.phoenixUsed = false;
            
            setTimeout(() => {
                // === ENEMY SCALING SYSTEM ===
                const playerLevel = state.char.level || 1;
                
                // Soft scaling: +5% HP/DMG za ka쬯칳 level nad 10
                let levelScaling = 1.0;
                if (playerLevel > 10) {
                    levelScaling = 1 + (playerLevel - 10) * 0.05;
                }
                
                // Day scaling: nep콏치tel칠 jsou siln캩j코칤 po 30 dnech
                const dayBonus = Math.min(0.3, (state.time.days || 0) * 0.01); // max +30%
                levelScaling *= (1 + dayBonus);
                
                // Vytvo콏 jednotky na m콏칤쬮e
                const units = [];
                let unitId = 0;
                
                // Rozm칤sti nep콏치tele po lev칠 캜치sti mapy (sloupce 0-3)
                // R콢zn칠 formace podle po캜tu nep콏치tel
                const enemyCount = enemyGroup.length;
                let enemySpawnPositions = [];
                
                if (enemyCount === 1) {
                    // Jeden nep콏칤tel - uprost콏ed lev칠 strany
                    enemySpawnPositions = [{ x: 2, y: 2 }];
                } else if (enemyCount === 2) {
                    // Dva nep콏치tel칠 - vedle sebe
                    enemySpawnPositions = [
                        { x: 1, y: 1 },
                        { x: 1, y: 3 }
                    ];
                } else if (enemyCount === 3) {
                    // T콏i nep콏치tel칠 - troj칰heln칤k
                    enemySpawnPositions = [
                        { x: 2, y: 2 },  // Vep콏edu
                        { x: 0, y: 1 },  // Vzadu naho콏e
                        { x: 0, y: 3 }   // Vzadu dole
                    ];
                } else if (enemyCount === 4) {
                    // 캛ty콏i nep콏치tel칠 - 캜tverec
                    enemySpawnPositions = [
                        { x: 2, y: 1 },
                        { x: 2, y: 3 },
                        { x: 0, y: 1 },
                        { x: 0, y: 3 }
                    ];
                } else if (enemyCount <= 6) {
                    // 5-6 nep콏치tel - dva 콏ady
                    enemySpawnPositions = [
                        { x: 2, y: 1 },  // P콏edn칤 콏ada
                        { x: 2, y: 2 },
                        { x: 2, y: 3 },
                        { x: 0, y: 1 },  // Zadn칤 콏ada
                        { x: 0, y: 2 },
                        { x: 0, y: 3 }
                    ];
                } else {
                    // 7+ nep콏치tel - t콏i 콏ady p콏es celou v칳코ku
                    enemySpawnPositions = [
                        { x: 3, y: 0 },  // P콏edn칤 콏ada
                        { x: 3, y: 1 },
                        { x: 3, y: 2 },
                        { x: 3, y: 3 },
                        { x: 3, y: 4 },
                        { x: 1, y: 0 },  // St콏edn칤 콏ada
                        { x: 1, y: 1 },
                        { x: 1, y: 2 },
                        { x: 1, y: 3 },
                        { x: 1, y: 4 }
                    ];
                }
                
                enemyGroup.forEach((e, idx) => {
                    const pos = enemySpawnPositions[idx] || { x: idx % 3, y: idx % 5 };
                    
                    // === ELITE ENEMY SYSTEM ===
                    // 10% 코ance na elite (15% v dungeonech, 20% po dni 20)
                    let eliteChance = 0.10;
                    if (combatType === 'dungeon') eliteChance = 0.15;
                    if ((state.time.days || 0) > 20) eliteChance += 0.10;
                    
                    const isElite = Math.random() < eliteChance;
                    let eliteMultiplier = 1;
                    let elitePrefix = '';
                    let eliteIcon = e.icon;
                    
                    if (isElite) {
                        eliteMultiplier = 2; // 2x HP
                        elitePrefix = '游 ';
                        // Zm캩켿 barvu ikony nep콏칤tele
                        eliteIcon = '游' + e.icon;
                    }
                    
                    const scaledHp = Math.floor((e.hp || e.maxHp) * levelScaling * eliteMultiplier);
                    const scaledDmg = Math.floor(e.damage * levelScaling * (isElite ? 1.5 : 1));
                    const scaledDef = Math.floor(e.defense * levelScaling * (isElite ? 1.3 : 1));
                    
                    units.push({
                        id: unitId++,
                        ...e,
                        name: elitePrefix + e.name,
                        icon: eliteIcon,
                        isElite: isElite,
                        hp: scaledHp,
                        maxHp: scaledHp,
                        damage: scaledDmg,
                        defense: scaledDef,
                        xp: Math.floor(e.xp * (isElite ? 2.5 : 1)), // Elite d치v치 2.5x XP
                        speed: e.speed || 5 + Math.floor(Math.random() * 5),
                        x: pos.x,
                        y: pos.y,
                        team: 'enemy',
                        alive: true,
                        acted: false,
                        stunned: false,
                        poisoned: 0,
                        bleeding: 0
                    });
                });
                
                // P콏idej hr치캜e (sloupec 5, 콏치dek 1)
                units.push({
                    id: unitId++,
                    name: state.char.name || 'Hrdina',
                    icon: '游븸',
                    hp: state.char.hp,
                    maxHp: state.char.maxHp,
                    damage: calculateDamage(),
                    defense: calculateDefense(),
                    speed: 10 + Math.floor((state.char.attrs?.agi || 5) / 2),
                    x: 7,  // Prav치 strana mapy
                    y: 2,  // St콏ed
                    team: 'player',
                    isPlayer: true,
                    alive: true,
                    acted: false
                });
                
                // P콏idej 쬴v칠 spole캜n칤ky
                if (state.companions) {
                    state.companions.filter(c => !c.isDead && c.hp > 0).forEach((comp, idx) => {
                        const compData = COMPANIONS.find(cd => cd.id === comp.id);
                        // Pro dynamick칠 spole캜n칤ky (rescued survivor) pou쬴j data z comp
                        const compIcon = comp.icon || compData?.icon || '游녻';
                        const compName = comp.name || compData?.name || 'Spole캜n칤k';
                        
                        // Pou쬴j getCompanionStat pro damage a defense (zahrnuje vybaven칤)
                        const compDamage = getCompanionStat(comp, 'damage');
                        const compDefense = getCompanionStat(comp, 'defense');
                        
                        // Spawn pozice - pou쬴j override pokud existuje, jinak default
                        const compId = comp.uniqueId || comp.id;
                        let pos;
                        
                        if (window.companionPositionsOverride && window.companionPositionsOverride[compId]) {
                            pos = window.companionPositionsOverride[compId];
                            
                            // Pokud je spole캜n칤k vylou캜en칳 z boje, p콏esko캜 ho
                            if (pos.excluded || pos.id === 'excluded') {
                                console.log(`游뛂 ${compName} vynech치n z boje (excluded)`);
                                return; // P콏esko캜 tohoto spole캜n칤ka
                            }
                        } else {
                            // V칳choz칤 pozice kolem hr치캜e (prav치 strana)
                            const defaultPositions = [
                                { x: 7, y: 1 }, { x: 7, y: 3 }, // Nad a pod hr치캜em
                                { x: 8, y: 2 }, { x: 8, y: 1 }, { x: 8, y: 3 } // 칔pln캩 vpravo
                            ];
                            pos = defaultPositions[idx] || { x: 7, y: idx % 5 };
                        }
                        
                        units.push({
                            id: unitId++,
                            name: compName,
                            icon: compIcon,
                            hp: comp.hp,
                            maxHp: comp.maxHp,
                            damage: compDamage,
                            defense: compDefense,
                            speed: 8 + idx,
                            x: pos.x,
                            y: pos.y,
                            team: 'player',
                            isCompanion: true,
                            companionId: comp.uniqueId || comp.id, // Pou쬴j uniqueId pro dynamick칠
                            alive: true,
                            acted: false,
                            equipped: comp.equipped || null // Pro referenci v boji
                        });
                    });
                }
                
                // Cleanup pozic
                window.companionPositionsOverride = null;
                
                // Se콏a캞 podle rychlosti (sestupn캩)
                const turnOrder = [...units].sort((a, b) => b.speed - a.speed);
                
                // Initialize combat state - 2 AKCE SYST칄M
                window.combatState = {
                    units: units,
                    turnOrder: turnOrder,
                    currentTurnIndex: 0,
                    round: 1,
                    selectedUnit: null,
                    selectedAction: null,
                    validMoves: [],
                    validTargets: [],
                    combatType: combatType,
                    isVillageRaid: combatType === 'settlement_raid',
                    isDungeon: combatType === 'dungeon',
                    log: ['丘덢잺 Boj za캜칤n치! Ka쬯칳 m치 2 akce za kolo.'],
                    terrain: generateCombatTerrain(),
                    manualCompanions: state.settings?.manualCompanions || false // Ru캜n칤 ovl치d치n칤 spole캜n칤k콢
                };
                
                // === TECHNIK BONUSY - PAST A V캨콯I캛KA ===
                const companionBonuses = getAllCompanionBonuses();
                
                // Past - zp콢sob칤 damage na za캜치tku boje n치hodn칠mu nep콏칤teli
                if (companionBonuses.canTrap) {
                    const enemies = units.filter(u => u.team === 'enemy' && u.alive);
                    if (enemies.length > 0) {
                        const trapTarget = enemies[Math.floor(Math.random() * enemies.length)];
                        const trapDamage = 15 + Math.floor(Math.random() * 16); // 15-30 DMG
                        trapTarget.hp = Math.max(0, trapTarget.hp - trapDamage);
                        if (trapTarget.hp <= 0) trapTarget.alive = false;
                        window.combatState.log.push(`游뿫 Past zas치hla ${trapTarget.name} za ${trapDamage} DMG!`);
                        addLog(`游뿫 Past zas치hla ${trapTarget.name} za ${trapDamage} DMG`, '游뿫');
                    }
                }
                
                // V캩쬴캜ka - ulo쮂 bonus damage pro ka쬯칠 kolo
                if (companionBonuses.turretDamage > 0) {
                    window.combatState.turretDamage = companionBonuses.turretDamage;
                    window.combatState.log.push(`游댦 V캩쬴캜ka p콏ipravena (+${companionBonuses.turretDamage} DMG ka쬯칠 kolo)`);
                }
                
                // Robot - siln캩j코칤 verze v캩쬴캜ky
                if (companionBonuses.canBuildRobot) {
                    window.combatState.robotDamage = 20; // Robot d캩l치 20 DMG
                    window.combatState.log.push(`游뱄 Bojov칳 robot aktivov치n (+20 DMG ka쬯칠 kolo)`);
                }
                
                // Nastav 2 akce ka쬯칠 jednotce
                units.forEach(u => {
                    u.actionsLeft = 2;
                    u.maxActions = 2;
                    u.defending = false;
                });
                
                // Za캜ni prvn칤 tah
                startNextTurn();
                
                renderHeroesCombatUI();
                document.getElementById('modal').classList.add('show');
            }, 100);
        }
        
        function generateCombatTerrain() {
            const terrain = [];
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // Ter칠n podle lokace
            let terrainPool = [
                { type: 'forest', icon: '游', defenseBonus: 0.2, name: 'Les', weight: 3 },
                { type: 'rock', icon: '游뿯', blocked: true, name: 'Sk치la', weight: 2 },
                { type: 'bush', icon: '游', defenseBonus: 0.1, name: 'Ke콏', weight: 3 },
                { type: 'rubble', icon: '游빔', defenseBonus: 0.1, speedPenalty: 0.3, name: 'Trosky', weight: 2 },
                { type: 'barrel', icon: '游띡勇', defenseBonus: 0.15, name: 'Sudy', weight: 2 },
                { type: 'crate', icon: '游닍', defenseBonus: 0.1, name: 'Bedny', weight: 2 }
            ];
            
            // Speci치ln칤 ter칠n podle typu lokace
            if (loc?.id?.includes('swamp') || loc?.id?.includes('water') || loc?.id?.includes('lake')) {
                terrainPool = [
                    { type: 'water', icon: '游눦', speedPenalty: 0.5, name: 'Voda', weight: 4 },
                    { type: 'deepwater', icon: '游깱', blocked: true, name: 'Hlubok치 voda', weight: 2 },
                    { type: 'reed', icon: '游', defenseBonus: 0.1, name: 'R치kos칤', weight: 3 },
                    { type: 'mud', icon: '游릯', speedPenalty: 0.3, name: 'Bahno', weight: 3 }
                ];
            } else if (loc?.id?.includes('forest') || loc?.id?.includes('grove')) {
                terrainPool = [
                    { type: 'forest', icon: '游', defenseBonus: 0.2, name: 'Les', weight: 4 },
                    { type: 'tree', icon: '游꺕', blocked: true, name: 'Strom', weight: 2 },
                    { type: 'bush', icon: '游', defenseBonus: 0.1, name: 'Ke콏', weight: 3 },
                    { type: 'log', icon: '游뿻', defenseBonus: 0.1, name: 'Kl치da', weight: 2 }
                ];
            } else if (loc?.id?.includes('city') || loc?.id?.includes('ruin') || loc?.id?.includes('mall')) {
                terrainPool = [
                    { type: 'rubble', icon: '游빔', defenseBonus: 0.15, speedPenalty: 0.2, name: 'Trosky', weight: 3 },
                    { type: 'car', icon: '游뚱', blocked: true, name: 'Vrak auta', weight: 2 },
                    { type: 'wall', icon: '游끸勇', blocked: true, name: 'Ze캞', weight: 2 },
                    { type: 'barrel', icon: '游띡勇', defenseBonus: 0.15, name: 'Sudy', weight: 2 },
                    { type: 'fire', icon: '游댠', damage: 8, name: 'Ohe켿', weight: 1 }
                ];
            } else if (loc?.id?.includes('factory') || loc?.id?.includes('plant') || loc?.id?.includes('power')) {
                terrainPool = [
                    { type: 'machine', icon: '丘뙖잺', blocked: true, name: 'Stroj', weight: 3 },
                    { type: 'barrel', icon: '游띡勇', defenseBonus: 0.15, name: 'Sudy', weight: 2 },
                    { type: 'toxic', icon: '驕뮖잺', damage: 5, radiation: 3, name: 'Toxick칳 odpad', weight: 2 },
                    { type: 'crate', icon: '游닍', defenseBonus: 0.1, name: 'Bedny', weight: 2 },
                    { type: 'pipe', icon: '游댤', defenseBonus: 0.1, name: 'Potrub칤', weight: 2 }
                ];
            } else if (loc?.id?.includes('cave') || loc?.id?.includes('mine') || loc?.id?.includes('bunker')) {
                terrainPool = [
                    { type: 'rock', icon: '游뿯', blocked: true, name: 'Sk치la', weight: 3 },
                    { type: 'stalactite', icon: '游', blocked: true, name: 'Stalagmit', weight: 2 },
                    { type: 'pit', icon: '游돕勇', damage: 10, name: 'Propast', weight: 1 },
                    { type: 'crystal', icon: '游눑', defenseBonus: 0.1, name: 'Krystal', weight: 2 }
                ];
            }
            
            // P콏idej univerz치ln칤 ter칠ny
            terrainPool.push({ type: 'fire', icon: '游댠', damage: 8, name: 'Ohe켿', weight: 1 });
            
            // Celkov치 v치ha pro weighted random
            const totalWeight = terrainPool.reduce((sum, t) => sum + t.weight, 0);
            
            // Vygeneruj m콏칤쬶u
            for (let y = 0; y < COMBAT_GRID.rows; y++) {
                terrain[y] = [];
                for (let x = 0; x < COMBAT_GRID.cols; x++) {
                    // St콏edn칤 sloupce (spawn z칩ny) nechej voln칠
                    const isSpawnZone = x <= 1 || x >= COMBAT_GRID.cols - 2;
                    const isCenterPath = y === Math.floor(COMBAT_GRID.rows / 2);
                    
                    // 20-30% 코ance na ter칠n, m칠n캩 ve spawn z칩n치ch
                    let terrainChance = isSpawnZone ? 0.08 : (isCenterPath ? 0.15 : 0.25);
                    
                    if (Math.random() < terrainChance) {
                        // Weighted random selection
                        let roll = Math.random() * totalWeight;
                        let selected = terrainPool[0];
                        for (const t of terrainPool) {
                            roll -= t.weight;
                            if (roll <= 0) {
                                selected = t;
                                break;
                            }
                        }
                        terrain[y][x] = { ...selected };
                        delete terrain[y][x].weight; // Nepot콏ebujeme weight v ulo쬰n칠m ter칠nu
                    } else {
                        terrain[y][x] = { type: 'empty', icon: '췅' };
                    }
                }
            }
            
            // Zajisti pr콢chodnou cestu (alespo켿 jedna cesta z ka쬯칠 strany)
            const midY = Math.floor(COMBAT_GRID.rows / 2);
            for (let x = 0; x < COMBAT_GRID.cols; x++) {
                if (terrain[midY][x].blocked) {
                    terrain[midY][x] = { type: 'empty', icon: '췅' };
                }
            }
            
            return terrain;
        }
        
        function startNextTurn() {
            const cs = window.combatState;
            
            // Nejd콏칤v zkontroluj konec boje
            if (checkCombatEnd()) return;
            
            // Najdi dal코칤 쬴vou jednotku s akcemi
            let attempts = 0;
            while (attempts < cs.turnOrder.length * 2) {
                const unit = cs.turnOrder[cs.currentTurnIndex];
                
                if (unit && unit.alive && unit.actionsLeft > 0) {
                    cs.selectedUnit = unit;
                    cs.selectedAction = null;
                    cs.validMoves = [];
                    cs.validTargets = [];
                    
                    // Nep콏칤tel - automatick칳 AI tah
                    if (unit.team === 'enemy') {
                        setTimeout(() => performAITurn(unit), 500);
                    }
                    // Spole캜n칤k - AI nebo manu치ln칤 ovl치d치n칤
                    else if (unit.isCompanion) {
                        if (cs.manualCompanions) {
                            // Manu치ln칤 ovl치d치n칤 - hr치캜 ovl치d치 spole캜n칤ka
                            renderHeroesCombatUI();
                        } else {
                            // Automatick칠 AI
                            setTimeout(() => performCompanionAITurn(unit), 400);
                        }
                    }
                    // Hr치캜 - 캜ek치 na input
                    return;
                }
                
                cs.currentTurnIndex = (cs.currentTurnIndex + 1) % cs.turnOrder.length;
                attempts++;
                
                // Pokud v코ichni odehr치li, nov칠 kolo
                if (cs.currentTurnIndex === 0) {
                    startNewRound();
                    return;
                }
            }
        }
        
        function performCompanionAITurn(unit) {
            const cs = window.combatState;
            if (!unit.alive || unit.actionsLeft <= 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
            if (enemies.length === 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            enemies.sort((a, b) => {
                const distA = Math.max(Math.abs(a.x - unit.x), Math.abs(a.y - unit.y));
                const distB = Math.max(Math.abs(b.x - unit.x), Math.abs(b.y - unit.y));
                return distA - distB;
            });
            
            const target = enemies[0];
            let dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
            let attacks = 0;
            let moved = false;
            
            // Zjisti jestli m치 spole캜n칤k st콏elnou zbra켿
            const hasRangedWeapon = unit.equipped?.weapon?.ammoType;
            const attackRange = hasRangedWeapon ? 99 : 1;
            
            // Helper funkce pro kontrolu pr콢chodnosti pole
            const isPassable = (x, y) => {
                if (x < 0 || x >= COMBAT_GRID.cols || y < 0 || y >= COMBAT_GRID.rows) return false;
                const terrain = cs.terrain[y]?.[x];
                if (terrain && terrain.blocked) return false;
                const unitOnTile = cs.units.some(u => u.alive && u.x === x && u.y === y);
                if (unitOnTile) return false;
                return true;
            };
            
            // A* Pathfinding pro spole캜n칤ky
            const findPathToTarget = (fromX, fromY, toX, toY, maxSteps = 12) => {
                const openSet = [{ x: fromX, y: fromY, g: 0, h: 0, f: 0, parent: null }];
                const closedSet = new Set();
                const getKey = (x, y) => `${x},${y}`;
                
                while (openSet.length > 0) {
                    openSet.sort((a, b) => a.f - b.f);
                    const current = openSet.shift();
                    
                    // C칤l dosa쬰n (vedle c칤le pro melee, nebo kdekoliv pro ranged)
                    const distToTarget = Math.max(Math.abs(current.x - toX), Math.abs(current.y - toY));
                    if (distToTarget <= attackRange) {
                        const path = [];
                        let node = current;
                        while (node.parent) {
                            path.unshift({ x: node.x, y: node.y });
                            node = node.parent;
                        }
                        return path;
                    }
                    
                    closedSet.add(getKey(current.x, current.y));
                    if (current.g >= maxSteps) continue;
                    
                    for (let dx = -1; dx <= 1; dx++) {
                        for (let dy = -1; dy <= 1; dy++) {
                            if (dx === 0 && dy === 0) continue;
                            const nx = current.x + dx;
                            const ny = current.y + dy;
                            
                            if (!isPassable(nx, ny) && !(nx === toX && ny === toY)) continue;
                            if (closedSet.has(getKey(nx, ny))) continue;
                            
                            const g = current.g + 1;
                            const h = Math.max(Math.abs(toX - nx), Math.abs(toY - ny));
                            const terrain = cs.terrain[ny]?.[nx];
                            const dangerPenalty = terrain?.damage ? terrain.damage * 0.3 : 0;
                            const f = g + h + dangerPenalty;
                            
                            const existing = openSet.find(n => n.x === nx && n.y === ny);
                            if (existing && existing.g <= g) continue;
                            
                            if (existing) {
                                existing.g = g;
                                existing.f = f;
                                existing.parent = current;
                            } else {
                                openSet.push({ x: nx, y: ny, g, h, f, parent: current });
                            }
                        }
                    }
                }
                return [];
            };
            
            // Jednoduch칳 fallback pohyb
            const findBestMove = () => {
                const directions = [
                    { dx: 0, dy: -1 }, { dx: 0, dy: 1 }, { dx: -1, dy: 0 }, { dx: 1, dy: 0 },
                    { dx: -1, dy: -1 }, { dx: 1, dy: -1 }, { dx: -1, dy: 1 }, { dx: 1, dy: 1 }
                ];
                
                let candidates = [];
                const currentDist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
                
                for (const dir of directions) {
                    const newX = unit.x + dir.dx;
                    const newY = unit.y + dir.dy;
                    
                    if (isPassable(newX, newY)) {
                        const newDist = Math.max(Math.abs(target.x - newX), Math.abs(target.y - newY));
                        const terrain = cs.terrain[newY]?.[newX];
                        
                        // Sk칩re: ni쮄뫆 = lep코칤
                        // Priorita: 1) bl칤 k c칤li, 2) obrann칳 bonus, 3) vyhnut칤 se damage
                        let score = newDist * 10; // Vzd치lenost je hlavn칤 faktor
                        
                        // BONUS za obrann치 pol칤캜ka (cover, fortified)
                        if (terrain?.defense) score -= terrain.defense * 2;
                        // BONUS za dodge pol칤캜ka
                        if (terrain?.dodge) score -= terrain.dodge * 30;
                        // PENALIZACE za nebezpe캜n치 pol칤캜ka
                        if (terrain?.damage) score += terrain.damage * 3;
                        
                        candidates.push({ x: newX, y: newY, dist: newDist, score: score });
                    }
                }
                
                // Se콏a캞 podle sk칩re
                candidates.sort((a, b) => a.score - b.score);
                
                // Vra콘 nejlep코칤 pohyb (preferuje bl칤 + bezpe캜n캩ji)
                if (candidates.length > 0) {
                    return candidates[0];
                }
                
                return null;
            };
            
            // Najdi cestu pomoc칤 A*
            const path = findPathToTarget(unit.x, unit.y, target.x, target.y);
            
            // 2 akce - pohyb + 칰tok nebo 2x 칰tok
            for (let action = 0; action < 2; action++) {
                if (dist <= attackRange) {
                    performCombatAttack(unit, target);
                    attacks++;
                } else {
                    // Pou쬴j A* cestu nebo fallback
                    let move = null;
                    if (path.length > 0) {
                        const pathIndex = moved ? 1 : 0;
                        move = path[pathIndex] || path[0];
                        // Ov캩콏 쬰 je st치le pr콢chodn치
                        if (move && !isPassable(move.x, move.y)) move = null;
                    }
                    if (!move) {
                        move = findBestMove();
                    }
                    
                    if (move) {
                        unit.x = move.x;
                        unit.y = move.y;
                        moved = true;
                        
                        // Ter칠nn칤 damage
                        const terrain = cs.terrain[move.y]?.[move.x];
                        if (terrain?.damage) {
                            unit.hp -= terrain.damage;
                            if (unit.hp <= 0) {
                                unit.alive = false;
                                unit.hp = 0;
                            }
                        }
                    }
                    
                    dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
                }
            }
            
            // Fallback: obrana pokud nic neud캩lal
            if (attacks === 0 && !moved && unit.alive) {
                unit.defending = true;
                unit.defenseBonus = 3;
                cs.log.push(`游띠勇 ${unit.name} se br치n칤`);
            } else if (attacks > 0) {
                cs.log.push(`游 ${unit.name} (${attacks}x 칰tok)`);
            }
            
            // Synchronizuj HP spole캜n칤ka
            const comp = state.companions?.find(c => c.id === unit.companionId || c.uniqueId === unit.companionId);
            if (comp) comp.hp = Math.max(0, unit.hp);
            
            setTimeout(() => {
                unit.actionsLeft = 0;
                useAction(unit, 0);
            }, 300);
        }
        
        function startNewRound() {
            const cs = window.combatState;
            cs.round++;
            cs.log.push(`--- Kolo ${cs.round} ---`);
            
            // === V캨콯I캛KA ST콎칈L칈 KA콯D칄 KOLO ===
            if (cs.turretDamage && cs.turretDamage > 0) {
                const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
                if (enemies.length > 0) {
                    const turretTarget = enemies[Math.floor(Math.random() * enemies.length)];
                    turretTarget.hp = Math.max(0, turretTarget.hp - cs.turretDamage);
                    cs.log.push(`游댦 V캩쬴캜ka st콏칤l칤 na ${turretTarget.name}: -${cs.turretDamage} HP`);
                    if (turretTarget.hp <= 0) {
                        turretTarget.alive = false;
                        cs.log.push(`游 ${turretTarget.name} byl sest콏elen v캩쬴캜kou!`);
                    }
                }
            }
            
            // === ROBOT ST콎칈L칈 KA콯D칄 KOLO ===
            if (cs.robotDamage && cs.robotDamage > 0) {
                const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
                if (enemies.length > 0) {
                    const robotTarget = enemies[Math.floor(Math.random() * enemies.length)];
                    robotTarget.hp = Math.max(0, robotTarget.hp - cs.robotDamage);
                    cs.log.push(`游뱄 Robot 칰to캜칤 na ${robotTarget.name}: -${cs.robotDamage} HP`);
                    if (robotTarget.hp <= 0) {
                        robotTarget.alive = false;
                        cs.log.push(`游 ${robotTarget.name} byl zni캜en robotem!`);
                    }
                }
            }
            
            // Reset akc칤 a obrany pro v코echny
            cs.units.forEach(u => {
                u.actionsLeft = u.maxActions || 2;
                u.defending = false;
                
                // === TER칄NN칈 DAMAGE NA ZA캛츼TKU KOLA ===
                if (u.alive) {
                    const terrain = cs.terrain[u.y]?.[u.x];
                    if (terrain?.damage) {
                        u.hp -= terrain.damage;
                        cs.log.push(`${terrain.icon || '游댠'} ${u.name} stoj칤 v ${terrain.name || 'nebezpe캜n칠m ter칠nu'}: -${terrain.damage} HP`);
                        
                        if (u.hp <= 0) {
                            u.alive = false;
                            u.hp = 0;
                            cs.log.push(`游 ${u.name} zem콏el v ${terrain.name || 'ter칠nu'}!`);
                        }
                    }
                    // Radiace z ter칠nu (jen hr치캜)
                    if (terrain?.radiation && u.isPlayer) {
                        state.status.radiation = Math.min(100, state.status.radiation + terrain.radiation);
                        cs.log.push(`驕뮖잺 +${terrain.radiation} radiace z ${terrain.name || 'ter칠nu'}`);
                    }
                }
                
                // DoT efekty
                if (u.alive && u.poisoned > 0) {
                    const dmg = u.poisoned;
                    u.hp -= dmg;
                    u.poisoned = Math.max(0, u.poisoned - 2);
                    cs.log.push(`驕멆잺 ${u.name} trp칤 jedem: -${dmg} HP`);
                    if (u.hp <= 0) {
                        u.alive = false;
                        cs.log.push(`游 ${u.name} zem콏el na jed!`);
                    }
                }
                if (u.alive && u.bleeding > 0) {
                    const dmg = u.bleeding;
                    u.hp -= dmg;
                    u.bleeding = Math.max(0, u.bleeding - 1);
                    cs.log.push(`游뽖 ${u.name} krv치c칤: -${dmg} HP`);
                    if (u.hp <= 0) {
                        u.alive = false;
                        cs.log.push(`游 ${u.name} vykrv치cel!`);
                    }
                }
                if (u.stunned) u.stunned = false;
            });
            
            // Zkontroluj konec boje
            if (checkCombatEnd()) return;
            
            // P콏epo캜칤tej po콏ad칤 (쬴v칠 jednotky)
            cs.turnOrder = cs.units.filter(u => u.alive).sort((a, b) => b.speed - a.speed);
            cs.currentTurnIndex = 0;
            
            startNextTurn();
            renderHeroesCombatUI();
        }
        
        function checkCombatEnd() {
            const cs = window.combatState;
            
            // Ochrana - pokud nen칤 combatState, nic ned캩l치me
            if (!cs || !cs.units) {
                console.error('丘멆잺 checkCombatEnd: combatState is missing!');
                return false;
            }
            
            const playerUnits = cs.units.filter(u => u.team === 'player' && u.alive);
            const enemyUnits = cs.units.filter(u => u.team === 'enemy' && u.alive);
            
            console.log(`游꿡 checkCombatEnd: ${playerUnits.length} hr치캜콢, ${enemyUnits.length} nep콏치tel 쬴v칳ch`);
            
            if (enemyUnits.length === 0) {
                console.log('游끥 V코ichni nep콏치tel칠 mrtv칤 - V칈T캨ZSTV칈');
                // Synchronizuj HP zp캩t do state
                const playerUnit = cs.units.find(u => u.isPlayer);
                if (playerUnit) state.char.hp = Math.max(1, playerUnit.hp);
                
                cs.units.filter(u => u.isCompanion).forEach(cu => {
                    // Hledej podle uniqueId nebo id
                    const comp = state.companions.find(c => 
                        c.uniqueId === cu.companionId || c.id === cu.companionId
                    );
                    if (comp) comp.hp = Math.max(0, cu.hp);
                });
                
                setTimeout(() => handleCombatVictory(), 500);
                return true;
            }
            
            if (playerUnits.length === 0) {
                console.log('游 V코ichni hr치캜i mrtv칤 - PROHRA');
                setTimeout(() => handleCombatDefeat(), 500);
                return true;
            }
            
            return false;
        }
        
        function performAITurn(unit) {
            const cs = window.combatState;
            if (!unit.alive || unit.actionsLeft <= 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            // AI pou쮂셨치 ob캩 akce najednou
            const targets = cs.units.filter(u => u.team === 'player' && u.alive);
            if (targets.length === 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            // Se콏a캞 podle vzd치lenosti (Chebyshev)
            targets.sort((a, b) => {
                const distA = Math.max(Math.abs(a.x - unit.x), Math.abs(a.y - unit.y));
                const distB = Math.max(Math.abs(b.x - unit.x), Math.abs(b.y - unit.y));
                return distA - distB;
            });
            
            const target = targets[0];
            // Chebyshev distance - diagon치ly po캜칤taj칤 jako 1
            let dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
            let actionsUsed = 0;
            let movedThisTurn = false;
            
            // A* Pathfinding pro AI - najde cestu kolem p콏ek치쬰k
            const findPathToTarget = (fromX, fromY, toX, toY, maxSteps = 15) => {
                const openSet = [{ x: fromX, y: fromY, g: 0, h: 0, f: 0, parent: null }];
                const closedSet = new Set();
                const getKey = (x, y) => `${x},${y}`;
                
                while (openSet.length > 0) {
                    // Najdi uzel s nejni쮄뫆셠 f
                    openSet.sort((a, b) => a.f - b.f);
                    const current = openSet.shift();
                    
                    // C칤l dosa쬰n (nebo jsme vedle c칤le - pro melee 칰tok)
                    if (Math.max(Math.abs(current.x - toX), Math.abs(current.y - toY)) <= 1) {
                        // Rekonstruuj cestu
                        const path = [];
                        let node = current;
                        while (node.parent) {
                            path.unshift({ x: node.x, y: node.y });
                            node = node.parent;
                        }
                        return path;
                    }
                    
                    closedSet.add(getKey(current.x, current.y));
                    
                    // Omezen칤 d칠lky cesty
                    if (current.g >= maxSteps) continue;
                    
                    // Prozkoumej sousedy (8 sm캩r콢)
                    for (let dx = -1; dx <= 1; dx++) {
                        for (let dy = -1; dy <= 1; dy++) {
                            if (dx === 0 && dy === 0) continue;
                            const nx = current.x + dx;
                            const ny = current.y + dy;
                            
                            if (nx < 0 || nx >= COMBAT_GRID.cols || ny < 0 || ny >= COMBAT_GRID.rows) continue;
                            if (closedSet.has(getKey(nx, ny))) continue;
                            
                            // Kontrola blokace (jin칠 jednotky, ter칠n)
                            const blocked = cs.units.some(u => u.alive && u.x === nx && u.y === ny);
                            const terrain = cs.terrain[ny]?.[nx];
                            if (blocked || terrain?.blocked) continue;
                            
                            const g = current.g + 1;
                            const h = Math.max(Math.abs(toX - nx), Math.abs(toY - ny)); // Chebyshev heuristika
                            const dangerPenalty = terrain?.damage ? terrain.damage * 0.3 : 0;
                            const f = g + h + dangerPenalty;
                            
                            // Zkontroluj jestli u nen칤 v openSet s lep코칤m sk칩re
                            const existing = openSet.find(n => n.x === nx && n.y === ny);
                            if (existing && existing.g <= g) continue;
                            
                            if (existing) {
                                existing.g = g;
                                existing.f = f;
                                existing.parent = current;
                            } else {
                                openSet.push({ x: nx, y: ny, g, h, f, parent: current });
                            }
                        }
                    }
                }
                
                return []; // Cesta nenalezena
            };
            
            // Helper pro jednoduch칳 pohyb (p콢vodn칤 logika jako fallback)
            const findBestMove = (fromX, fromY, toX, toY) => {
                const possibleMoves = [];
                for (let dx = -1; dx <= 1; dx++) {
                    for (let dy = -1; dy <= 1; dy++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = fromX + dx;
                        const ny = fromY + dy;
                        if (nx < 0 || nx >= COMBAT_GRID.cols || ny < 0 || ny >= COMBAT_GRID.rows) continue;
                        
                        const blocked = cs.units.some(u => u.alive && u.x === nx && u.y === ny);
                        const terrain = cs.terrain[ny]?.[nx];
                        if (blocked || terrain?.blocked) continue;
                        
                        // Vzd치lenost k c칤li
                        const newDist = Math.max(Math.abs(toX - nx), Math.abs(toY - ny));
                        // Penalizace za nebezpe캜n칳 ter칠n
                        const dangerPenalty = terrain?.damage ? terrain.damage * 0.5 : 0;
                        // BONUS za obrann치 pol칤캜ka (cover, fortified)
                        const defenseBonus = terrain?.defense ? -terrain.defense * 0.3 : 0; // Z치porn칠 = lep코칤
                        // BONUS za pol칤캜ka s dodge bonusem
                        const dodgeBonus = terrain?.dodge ? -terrain.dodge * 20 : 0; // Z치porn칠 = lep코칤
                        
                        const score = newDist + dangerPenalty + defenseBonus + dodgeBonus;
                        possibleMoves.push({ x: nx, y: ny, dist: newDist, danger: dangerPenalty, defense: terrain?.defense || 0, score: score });
                    }
                }
                // Se콏a캞 podle sk칩re (ni쮄뫆 = lep코칤)
                possibleMoves.sort((a, b) => a.score - b.score);
                return possibleMoves[0] || null;
            };
            
            // Najdi cestu k c칤li pomoc칤 A*
            const path = findPathToTarget(unit.x, unit.y, target.x, target.y);
            
            // Funkce pro proveden칤 pohybu
            const doMove = (toX, toY) => {
                unit.x = toX;
                unit.y = toY;
                movedThisTurn = true;
                
                // Ter칠nn칤 damage p콏i pohybu
                const terrain = cs.terrain[toY]?.[toX];
                if (terrain?.damage) {
                    unit.hp -= terrain.damage;
                    cs.log.push(`${terrain.icon || '游댠'} ${unit.name}: -${terrain.damage} HP`);
                    if (unit.hp <= 0) {
                        unit.alive = false;
                        unit.hp = 0;
                        cs.log.push(`游 ${unit.name} zem콏el!`);
                    }
                }
            };
            
            // Akce 1: Pohyb nebo 칰tok
            if (dist <= 1) {
                performCombatAttack(unit, target);
                actionsUsed++;
            } else if (path.length > 0) {
                // Pou쬴j A* cestu
                doMove(path[0].x, path[0].y);
                actionsUsed++;
                dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
            } else {
                // Fallback na jednoduch칳 pohyb
                const bestMove = findBestMove(unit.x, unit.y, target.x, target.y);
                if (bestMove) {
                    doMove(bestMove.x, bestMove.y);
                    actionsUsed++;
                    dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
                }
            }
            
            // Akce 2: Dal코칤 칰tok nebo pohyb
            if (actionsUsed < 2 && unit.actionsLeft > 1 && unit.alive) {
                if (dist <= 1) {
                    performCombatAttack(unit, target);
                    actionsUsed++;
                } else if (path.length > 1) {
                    // Pokra캜uj po A* cest캩
                    const nextStep = movedThisTurn ? (path[1] || path[0]) : path[0];
                    if (nextStep && !cs.units.some(u => u.alive && u.x === nextStep.x && u.y === nextStep.y)) {
                        doMove(nextStep.x, nextStep.y);
                        actionsUsed++;
                    }
                } else {
                    // Fallback pohyb
                    const bestMove = findBestMove(unit.x, unit.y, target.x, target.y);
                    if (bestMove) {
                        doMove(bestMove.x, bestMove.y);
                        actionsUsed++;
                    }
                }
            }
            
            // FALLBACK: Pokud AI nic neud캩lala, alespo켿 se br치n칤
            if (actionsUsed === 0 && unit.alive) {
                unit.defending = true;
                unit.defenseBonus = 5; // +5 do캜asn치 obrana
                cs.log.push(`游띠勇 ${unit.name} se br치n칤 (+5 obrana)`);
                actionsUsed = 2; // Pou쬴je ob캩 akce na obranu
            }
            
            cs.log.push(`${unit.icon} ${unit.name} (${actionsUsed} akce)`);
            
            setTimeout(() => {
                unit.actionsLeft = 0;
                useAction(unit, 0);
            }, 300);
        }
        
        function performCombatAttack(attacker, target) {
            const cs = window.combatState;
            
            // Z칤skej skill efekty c칤le (pokud je spole캜n칤k)
            let targetSkillEffects = {};
            if (target.isCompanion && target.companionId) {
                const comp = state.companions.find(c => c.id === target.companionId);
                if (comp?.skills) {
                    const skillTree = COMPANION_SKILL_TREES[comp.id];
                    if (skillTree) {
                        comp.skills.forEach(skillId => {
                            Object.values(skillTree.trees).forEach(tree => {
                                const skill = tree.skills.find(s => s.id === skillId);
                                if (skill?.effect) {
                                    Object.entries(skill.effect).forEach(([key, val]) => {
                                        targetSkillEffects[key] = (targetSkillEffects[key] || 0) + val;
                                    });
                                }
                            });
                        });
                    }
                }
            }
            
            // Z칤skej hr치캜ovy obrann칠 skilly
            let playerDefenseEffects = {};
            if (target.isPlayer) {
                playerDefenseEffects = getPlayerCombatSkillEffects();
            }
            
            // 맚칤tov치 ze캞 - spole캜n칤k m콢쬰 blokovat 칰tok na hr치캜e
            if (target.isPlayer) {
                const companions = cs.units.filter(u => u.isCompanion && u.alive);
                for (const companion of companions) {
                    const comp = state.companions?.find(c => c.id === companion.companionId);
                    if (comp?.skills) {
                        const skillTree = COMPANION_SKILL_TREES[comp.id];
                        if (skillTree) {
                            let blockChance = 0;
                            comp.skills.forEach(skillId => {
                                Object.values(skillTree.trees).forEach(tree => {
                                    const skill = tree.skills.find(s => s.id === skillId);
                                    if (skill?.effect?.blockForPlayer) {
                                        blockChance += skill.effect.blockForPlayer;
                                    }
                                });
                            });
                            if (blockChance > 0 && Math.random() < blockChance) {
                                cs.log.push(`游띠勇 ${companion.name} zablokoval 칰tok na ${target.name}!`);
                                // Spole캜n칤k dostane polovi캜n칤 damage
                                const blockedDamage = Math.floor(attacker.damage * 0.5);
                                companion.hp -= blockedDamage;
                                cs.log.push(`${companion.icon} ${companion.name} dostal ${blockedDamage} DMG`);
                                if (companion.hp <= 0) {
                                    companion.alive = false;
                                    companion.hp = 0;
                                    cs.log.push(`游 ${companion.name} padl p콏i ochran캩!`);
                                }
                                return; // 칔tok zablokov치n
                            }
                        }
                    }
                }
            }
            
            // Hr치캜콢v skill blokov치n칤
            if (target.isPlayer && playerDefenseEffects.blockChance > 0) {
                if (Math.random() < playerDefenseEffects.blockChance) {
                    cs.log.push(`游띠勇 ${target.name} zablokoval 칰tok! (skill)`);
                    return;
                }
            }
            
            // 마nce na 칰hyb (dodge)
            const dodgeChance = targetSkillEffects.dodgeChance || 0;
            if (dodgeChance > 0 && Math.random() < dodgeChance) {
                cs.log.push(`游 ${target.name} se vyhnul 칰toku! (skill)`);
                return;
            }
            
            // 마nce p콏e쮂셦 smrteln칳 칰tok (dev캩t 쬴vot콢 nebo last_stand)
            let surviveChance = targetSkillEffects.surviveChance || 0;
            if (target.isPlayer && playerDefenseEffects.lastStand > 0) {
                surviveChance = Math.max(surviveChance, playerDefenseEffects.lastStand);
            }
            
            // Z치kladn칤 damage
            let damage = attacker.damage;
            
            // === CLASS PASSIVES - OBRANA ===
            if (target.isPlayer) {
                // Tank: Fortress - Blokuje 30% p콏칤choz칤ho damage
                if (state.char.classId === 'tank') {
                    const reduced = Math.floor(damage * 0.3);
                    damage = damage - reduced;
                    cs.log.push(`游낋 Blokov치no ${reduced} damage`);
                }
                
                // Mutant: +10 p콏irozen치 obrana a regenerace p콏i z치sahu
                if (state.char.classId === 'mutant') {
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + 2);
                    cs.log.push(`游붍 Regenerace +2 HP`);
                }
            }
            
            // Hr치캜ova obrana ze skill콢
            let defense = target.defense;
            if (target.isPlayer && playerDefenseEffects.defense > 0) {
                defense += playerDefenseEffects.defense;
            }
            
            // Mutant base defense
            if (target.isPlayer && state.char.classId === 'mutant') {
                defense += 10;
            }
            
            // Ter칠nn칤 bonus obrany
            const terrain = cs.terrain[target.y]?.[target.x];
            if (terrain?.defenseBonus) {
                defense = Math.floor(defense * (1 + terrain.defenseBonus));
            }
            
            // Kritick칳 z치sah (10% 코ance)
            const isCrit = Math.random() < 0.1;
            if (isCrit) damage = Math.floor(damage * 2);
            
            // Aplikuj obranu
            const finalDamage = Math.max(1, damage - defense);
            target.hp -= finalDamage;
            
            // Zvuky boje
            if (typeof playCombatSound === 'function') {
                if (attacker.team === 'player' || attacker.isPlayer) {
                    // Hr치캜 칰to캜칤
                    const weaponType = attacker.weaponType || 'melee';
                    playCombatSound('playerAttack', weaponType);
                }
                if (target.isPlayer) {
                    playCombatSound('playerHit');
                } else {
                    playCombatSound(isCrit ? 'crit' : 'enemyHit');
                }
            }
            
            cs.log.push(`${attacker.icon} ${attacker.name}  ${target.icon} ${target.name}: ${finalDamage} DMG${isCrit ? ' 游눤KRIT!' : ''}`);
            
            // Efekty (jed, krv치cen칤)
            if (attacker.poisonChance && Math.random() < attacker.poisonChance) {
                target.poisoned = Math.max(target.poisoned || 0, 5);
                cs.log.push(`驕멆잺 ${target.name} byl otr치ven!`);
            }
            
            if (target.hp <= 0) {
                // Survivor: Last Stand - 25% 코ance p콏e쮂셦 smrteln칳 칰der
                let lastStandChance = surviveChance;
                if (target.isPlayer && state.char.classId === 'survivor') {
                    lastStandChance = Math.max(lastStandChance, 0.25);
                }
                
                if (lastStandChance > 0 && Math.random() < lastStandChance) {
                    target.hp = 1;
                    if (target.isPlayer && state.char.classId === 'survivor') {
                        cs.log.push(`游눩 LAST STAND! P콏e쬴l jsi s 1 HP!`);
                    } else {
                        cs.log.push(`九 ${target.name} p콏e쬴l na posledn칤 chv칤li!`);
                    }
                } else {
                    target.alive = false;
                    target.hp = 0;
                    cs.log.push(`游 ${target.name} byl pora쬰n!`);
                    SoundSystem.play('combat_hit');
                    if (typeof playCombatSound === 'function') playCombatSound('enemyDeath');
                }
            }
        }
        
        // Spot콏ebuje 1 akci (pohyb/칰tok/item) nebo v코echny (obrana/konec tahu)
        function useAction(unit, count = 1) {
            const cs = window.combatState;
            unit.actionsLeft = Math.max(0, unit.actionsLeft - count);
            
            if (checkCombatEnd()) return;
            
            // Pokud jednotka nem치 akce, p콏ejdi na dal코칤
            if (unit.actionsLeft <= 0) {
                cs.currentTurnIndex = (cs.currentTurnIndex + 1) % cs.turnOrder.length;
                
                // Zkontroluj jestli v코ichni odehr치li (v코ichni maj칤 0 akc칤)
                const anyoneHasActions = cs.turnOrder.some(u => u.alive && u.actionsLeft > 0);
                if (!anyoneHasActions) {
                    startNewRound();
                    return;
                }
            }
            
            startNextTurn();
            renderHeroesCombatUI();
        }
        
        function endUnitTurn(unit) {
            // Ukon캜칤 tah jednotky (spot콏ebuje v코echny zb칳vaj칤c칤 akce)
            unit.actionsLeft = 0;
            useAction(unit, 0);
        }
        
        // === PLAYER ACTIONS ===
        
        function selectAction(action) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            cs.selectedAction = action;
            
            if (action === 'move') {
                calculateValidMoves(unit);
                renderHeroesCombatUI();
            } else if (action === 'attack') {
                calculateValidTargets(unit);
                renderHeroesCombatUI();
            } else if (action === 'defend') {
                // Obrana - spot콏ebuje VECHNY zb칳vaj칤c칤 akce, ale d치v치 velk칳 bonus
                unit.defending = true;
                const defBonus = unit.actionsLeft === 2 ? 100 : 50; // 2 akce = +100%, 1 akce = +50%
                unit.defenseBonus = defBonus;
                cs.log.push(`游띠勇 ${unit.name} se br치n칤 (+${defBonus}% obrana do dal코칤ho kola)`);
                endUnitTurn(unit);
            } else if (action === 'weapon') {
                showCombatWeaponSwitch();
                // Nerendruj UI - showCombatWeaponSwitch to 콏e코칤 samo
            } else if (action === 'wait') {
                cs.log.push(`낈勇 ${unit.name} ukon캜il tah (${unit.actionsLeft} akce nevyu쬴ty)`);
                endUnitTurn(unit);
            }
        }
        
        // === V칗M캨NA ZBRAN캨 V BOJI ===
        function showCombatWeaponSwitch() {
            const cs = window.combatState;
            const weapons = state.inv.filter(i => i.type === 'weapon');
            const currentWeapon = state.equipped?.weapon;
            
            let weaponsHtml = '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            weaponsHtml += '<div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">V칳m캩na zbran캩 spot콏ebuje 1 akci</div>';
            
            if (currentWeapon) {
                const ammoInfo = currentWeapon.ammoType ? 
                    ` | 游댦 ${getAmmoCount(currentWeapon.ammoType)} ${getAmmoName(currentWeapon.ammoType)}` : '';
                weaponsHtml += `<div style="background: #2a3a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #4a6a4a;">
                    <span style="color: #8bc34a;">Aktu치ln칤:</span> ${currentWeapon.icon || '丘덢잺'} ${currentWeapon.name} (丘덢잺${currentWeapon.damage || 10})
                    ${currentWeapon.ammoType ? `<span style="color: #ff9800;"> 游꿢</span>` : `<span style="color: #64b5f6;"> 游디勇</span>`}
                    ${ammoInfo}
                </div>`;
            } else {
                weaponsHtml += `<div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #555;">
                    <span style="color: #888;">Aktu치ln칤:</span> 游녥 Hol칠 ruce (丘덢잺5)
                </div>`;
            }
            
            if (weapons.length === 0) {
                weaponsHtml += '<p style="color: #666; text-align: center;">Nem치코 쮂멳n칠 zbran캩 v invent치콏i</p>';
            } else {
                weapons.forEach(w => {
                    const isEquipped = currentWeapon?.id === w.id;
                    const hasAmmo = !w.ammoType || getAmmoCount(w.ammoType) > 0;
                    const ammoCount = w.ammoType ? getAmmoCount(w.ammoType) : null;
                    const weaponRange = w.ammoType ? '游꿢' : '游디勇';
                    const ammoText = w.ammoType ? ` 游댦${ammoCount}` : '';
                    const bgColor = isEquipped ? '#4a6a4a' : (hasAmmo ? '#2a3a4a' : '#4a2a2a');
                    
                    weaponsHtml += `<button class="btn" onclick="switchCombatWeapon('${w.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.4rem; background: ${bgColor}; text-align: left; font-size: 0.85rem;" ${isEquipped ? 'disabled' : ''}>
                        ${w.icon || '丘덢잺'} ${w.name} - 丘덢잺${w.damage || 10} ${weaponRange}${ammoText}${!hasAmmo ? ' 丘멆잺' : ''}
                    </button>`;
                });
            }
            
            // Mo쬹ost odlo쬴t zbra켿 (p캩sti)
            weaponsHtml += `<button class="btn" onclick="switchCombatWeapon('fists')" style="display: block; width: 100%; margin-top: 0.5rem; padding: 0.4rem; background: #3a3a3a; text-align: left; font-size: 0.85rem;">
                游녥 Hol칠 ruce - 丘덢잺5 游디勇
            </button>`;
            
            weaponsHtml += '</div>';
            weaponsHtml += '<button class="btn" onclick="renderHeroesCombatUI()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t do boje</button>';
            
            // Zobraz p콏칤mo v modal contentu
            document.getElementById('modalContent').innerHTML = `
                <div style="background: linear-gradient(180deg, #0d1520 0%, #0a0f15 100%); margin: -1rem; padding: 1rem; border-radius: 8px;">
                    <h3 style="text-align: center; margin-bottom: 1rem; color: #ffd700;">游댃 V칳m캩na zbran캩</h3>
                    ${weaponsHtml}
                </div>
            `;
        }
        
        function switchCombatWeapon(weaponId) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || unit.actionsLeft <= 0) return;
            
            if (weaponId === 'fists') {
                state.equipped.weapon = null;
                cs.log.push(`游녥 ${unit.name} odlo쬴l zbra켿`);
            } else {
                const weapon = state.inv.find(i => i.id === weaponId);
                if (weapon) {
                    state.equipped.weapon = weapon;
                    cs.log.push(`游댃 ${unit.name} tasil ${weapon.name}`);
                }
            }
            
            // Aktualizuj damage jednotky
            unit.damage = calculateDamage();
            
            useAction(unit, 1);
        }
        
        function calculateValidMoves(unit) {
            const cs = window.combatState;
            cs.validMoves = [];
            
            // Pohyb pouze o 1 pole (4 sm캩ry + diagon치ly)
            const range = 1;
            for (let dx = -range; dx <= range; dx++) {
                for (let dy = -range; dy <= range; dy++) {
                    if (dx === 0 && dy === 0) continue;
                    const newX = unit.x + dx;
                    const newY = unit.y + dy;
                    
                    // Kontrola hranic
                    if (newX < 0 || newX >= COMBAT_GRID.cols || newY < 0 || newY >= COMBAT_GRID.rows) continue;
                    
                    // Kontrola koliz칤
                    const occupied = cs.units.some(u => u.alive && u.x === newX && u.y === newY);
                    const terrainBlocked = cs.terrain[newY]?.[newX]?.blocked;
                    
                    if (!occupied && !terrainBlocked) {
                        cs.validMoves.push({ x: newX, y: newY });
                    }
                }
            }
        }
        
        function calculateValidTargets(unit) {
            const cs = window.combatState;
            cs.validTargets = [];
            
            // Zjist칤me jestli je to spole캜n칤k
            const isCompanion = unit.isCompanion;
            
            // Pro hr치캜e pou쬴j vybavenou zbra켿, pro spole캜n칤ky jejich vybaven칤
            let weapon = null;
            if (!isCompanion) {
                weapon = state.equipped?.weapon;
            } else if (unit.equipped?.weapon) {
                weapon = unit.equipped.weapon;
            }
            
            const isRanged = weapon?.ammoType; // St콏eln치 zbra켿 m치 ammoType
            
            // Kontrola munice pro st콏eln칠 zbran캩 (jen hr치캜)
            if (isRanged && !isCompanion) {
                const ammoCount = getAmmoCount(weapon.ammoType);
                if (ammoCount <= 0) {
                    cs.log.push(`丘멆잺 Nem치코 ${getAmmoName(weapon.ammoType)}! Vym캩켿 zbra켿 nebo dopl켿 munici.`);
                    return;
                }
            }
            
            // Dosah zbran캩:
            // - St콏eln치 (luk, pistole, pu코ka, brokovnice, plamenomet): neomezen칳 dosah (cel치 mapa)
            // - Zbra켿 na bl칤zko (me캜, n콢, sekera): 1 pole v캜etn캩 diagon치l (8 sm캩r콢)
            // - Spole캜n칤ci se st콏elnou zbran칤: neomezen칳 dosah
            // - Spole캜n칤ci bez st콏eln칠 zbran캩: 1 pole
            // - Hol칠 ruce: 1 pole v캜etn캩 diagon치l
            const maxRange = isRanged ? 99 : 1;
            
            cs.units.filter(u => u.team === 'enemy' && u.alive).forEach(enemy => {
                // Chebyshev distance - po캜칤t치 diagon치ly jako 1 pole
                const dist = Math.max(Math.abs(enemy.x - unit.x), Math.abs(enemy.y - unit.y));
                
                if (dist <= maxRange) {
                    // Pro st콏eln칠 zbran캩 p콏idej info o vzd치lenosti
                    enemy._combatDist = dist;
                    cs.validTargets.push(enemy);
                }
            });
            
            // Pokud nem치m st콏elnou zbra켿 a nikdo nen칤 v dosahu, upozorni
            if (maxRange === 1 && cs.validTargets.length === 0) {
                const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
                if (enemies.length > 0) {
                    cs.log.push(`丘멆잺 콯치dn칳 nep콏칤tel v dosahu! P콏ibli se${!isCompanion ? ' nebo vym캩켿 zbra켿' : ''}.`);
                }
            }
        }
        
        function clickCell(x, y) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            if (cs.selectedAction === 'move') {
                // Pohyb - spot콏ebuje 1 akci
                const validMove = cs.validMoves.find(m => m.x === x && m.y === y);
                if (validMove) {
                    unit.x = x;
                    unit.y = y;
                    cs.log.push(`游뛌 ${unit.name} se p콏esunul [${unit.actionsLeft - 1} akce zb칳v치]`);
                    
                    // Ter칠nn칤 damage
                    const terrain = cs.terrain[y]?.[x];
                    if (terrain?.damage) {
                        unit.hp -= terrain.damage;
                        cs.log.push(`游댠 ${terrain.name || 'Ter칠n'} zp콢sobil ${terrain.damage} DMG!`);
                    }
                    if (terrain?.radiation && unit.isPlayer) {
                        state.status.radiation = Math.min(100, state.status.radiation + terrain.radiation);
                        cs.log.push(`驕뮖잺 +${terrain.radiation} radiace!`);
                    }
                    
                    cs.selectedAction = null;
                    cs.validMoves = [];
                    useAction(unit, 1);
                }
            } else if (cs.selectedAction === 'attack') {
                // 칔tok na jednotku v bu켿ce
                const target = cs.units.find(u => u.x === x && u.y === y && u.alive && u.team === 'enemy');
                if (target && cs.validTargets.includes(target)) {
                    playerAttackTarget(target);
                }
            }
        }
        
        function playerAttackTarget(target) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            
            // Nano armor regenerace na za캜치tku tahu hr치캜e
            if (!unit.isCompanion) {
                const armorEffects = getArmorSpecialEffects();
                if (armorEffects.regenPerTurn > 0 && state.char.hp < state.char.maxHp) {
                    const healAmt = Math.min(armorEffects.regenPerTurn, state.char.maxHp - state.char.hp);
                    state.char.hp += healAmt;
                    cs.log.push(`游댧 Nano zbroj regeneruje +${healAmt} HP`);
                }
            }
            
            // Spole캜n칤k nebo hr치캜?
            const isCompanion = unit.isCompanion;
            
            // Z칤skej skill efekty spole캜n칤ka
            let companionSkillEffects = {};
            if (isCompanion && unit.companionId) {
                const comp = state.companions.find(c => c.id === unit.companionId);
                if (comp?.skills) {
                    const skillTree = COMPANION_SKILL_TREES[comp.id];
                    if (skillTree) {
                        comp.skills.forEach(skillId => {
                            Object.values(skillTree.trees).forEach(tree => {
                                const skill = tree.skills.find(s => s.id === skillId);
                                if (skill?.effect) {
                                    Object.entries(skill.effect).forEach(([key, val]) => {
                                        companionSkillEffects[key] = (companionSkillEffects[key] || 0) + val;
                                    });
                                }
                            });
                        });
                    }
                }
            }
            
            // Z칤skej skill efekty hr치캜e
            const playerSkillEffects = !isCompanion ? getPlayerCombatSkillEffects() : {};
            
            // Spot콏eba munice pro st콏eln칠 zbran캩 (jen hr치캜)
            const weapon = !isCompanion ? state.equipped?.weapon : null;
            if (weapon?.ammoType) {
                if (!consumeAmmo(weapon.ammoType, 1)) {
                    cs.log.push(`丘멆잺 Nem치코 n치boje!`);
                    renderHeroesCombatUI();
                    return;
                }
            }
            
            // Z치kladn칤 damage
            let damage = isCompanion ? unit.damage : calculateDamage();
            
            // === CLASS PASSIVES - 칔TOK ===
            if (!isCompanion) {
                // Raider: Rage - Pod 30% HP +40% damage (nerfed from 50%)
                if (state.char.classId === 'raider' && state.char.hp / state.char.maxHp < 0.3) {
                    damage = Math.floor(damage * 1.4);
                    cs.log.push(`游땫 RAGE! +40% damage!`);
                }
                
                // Berserker: Frenzy stacks (+8% per stack, max 5)
                if (state.char.classId === 'berserker') {
                    const frenzyStacks = (state.buffs || []).filter(b => b.id === 'frenzy' && b.expires > Date.now()).length;
                    if (frenzyStacks > 0) {
                        damage = Math.floor(damage * (1 + frenzyStacks * 0.08));
                        cs.log.push(`游댠 Frenzy! (+${Math.round(frenzyStacks * 8)}% DMG)`);
                    }
                }
                
                // Alchemist: Poison na ka쬯칳 칰tok (8 DOT buffed from 5)
                if (state.char.classId === 'alchemist') {
                    target.poisoned = Math.max(target.poisoned || 0, 8);
                    cs.log.push(`驕멆잺 Jed aplikov치n! (+8 DOT)`);
                }
                
                // Demolitionist: 12% 코ance na AoE (nerfed from 15%), 40% splash
                if (state.char.classId === 'demolitionist' && Math.random() < 0.12) {
                    const nearbyEnemies = cs.units.filter(u => 
                        u.team === 'enemy' && u.alive && u.id !== target.id &&
                        Math.max(Math.abs(u.x - target.x), Math.abs(u.y - target.y)) <= 1
                    );
                    nearbyEnemies.forEach(enemy => {
                        const aoeDamage = Math.floor(damage * 0.4); // nerfed from 0.5
                        enemy.hp -= aoeDamage;
                        cs.log.push(`游눤 BOOM! ${enemy.icon}: ${aoeDamage} DMG`);
                        if (enemy.hp <= 0) {
                            enemy.alive = false;
                            enemy.hp = 0;
                        }
                    });
                }
                
                // Engineer: +15% DMG s craft캩n칳mi zbran캩mi
                if (state.char.classId === 'engineer' && state.equipped?.weapon) {
                    const craftedWeapons = ['stone_axe', 'club', 'spear', 'bow', 'crossbow_craft', 'hammer_craft', 'axe_craft', 'serrated_blade', 'barbed_club', 'pipe_pistol', 'pipe_rifle', 'pipe_shotgun'];
                    if (craftedWeapons.includes(state.equipped.weapon.id)) {
                        damage = Math.floor(damage * 1.15);
                        cs.log.push(`游댢 Craft캩n치 zbra켿! +15% DMG`);
                    }
                }
                
                // Mechanik Pepa NPC bonus: +15/25% DMG s craft캩n칳mi zbran캩mi
                const npcBonuses = getNPCBonuses();
                if (npcBonuses.craftedWeaponBonus > 0 && state.equipped?.weapon) {
                    const craftedWeapons = ['stone_axe', 'club', 'spear', 'bow', 'crossbow_craft', 'hammer_craft', 'axe_craft', 'serrated_blade', 'barbed_club', 'pipe_pistol', 'pipe_rifle', 'pipe_shotgun', 'slingshot'];
                    if (craftedWeapons.includes(state.equipped.weapon.id)) {
                        damage = Math.floor(damage * (1 + npcBonuses.craftedWeaponBonus));
                        cs.log.push(`游댢 Pep콢v bonus! +${Math.round(npcBonuses.craftedWeaponBonus * 100)}% DMG`);
                    }
                }
            }
            
            // Hr치캜콢v damage bonus ze skill콢 (power_strike atd.)
            if (!isCompanion && playerSkillEffects.damageBonus > 0) {
                damage = Math.floor(damage * (1 + playerSkillEffects.damageBonus));
            }
            
            // Berserk bonus - v칤c damage p콏i n칤zk칠m HP
            if (!isCompanion && playerSkillEffects.berserkerBonus > 0) {
                const hpPercent = state.char.hp / state.char.maxHp;
                if (hpPercent < 0.3) {
                    damage = Math.floor(damage * (1 + playerSkillEffects.berserkerBonus));
                    cs.log.push(`游땫 Berserk skill! (+${Math.round(playerSkillEffects.berserkerBonus * 100)}% DMG)`);
                }
            }
            
            // Execute bonus - v칤c damage na low HP nep콏치tele
            if (!isCompanion && playerSkillEffects.executeBonus > 0) {
                if (target.hp / target.maxHp < 0.2) {
                    damage = Math.floor(damage * (1 + playerSkillEffects.executeBonus));
                    cs.log.push(`丘썶잺 Poprava! (+${Math.round(playerSkillEffects.executeBonus * 100)}% DMG)`);
                }
            }
            
            // Kritick칳 z치sah
            // Assassin: +40% crit chance
            let baseCritChance = isCompanion ? 0.1 : calculateCritChance();
            if (!isCompanion && state.char.classId === 'assassin') {
                baseCritChance += 0.4;
            }
            
            // === SET BONUSY - CRIT ===
            const setEffects = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            if (!isCompanion) {
                // Piece bonusy crit
                baseCritChance += setEffects.critChance || 0;
                // Set (2) bonus - extra crit (raider)
                baseCritChance += setEffects.extraCritChance || 0;
                // Ambush - prvn칤 칰tok v boji m치 +100% crit (stalker)
                if (setEffects.ambush && cs.round === 1 && !window.ambushUsed) {
                    baseCritChance += 1.0; // +100%
                    window.ambushUsed = true;
                    cs.log.push(`游꿢 AMBUSH! Z치ke콏n칳 칰tok z 칰krytu!`);
                }
                // Tracking (hunter set 2) - +30% crit na zv칤콏ata
                if (setEffects.tracking) {
                    const isAnimal = target.id?.includes('wolf') || target.id?.includes('rat') || 
                                    target.id?.includes('dog') || target.id?.includes('cat') ||
                                    target.id?.includes('bear') || target.id?.includes('spider') ||
                                    target.id?.includes('frog') || target.id?.includes('fish') ||
                                    target.name?.includes('Vlk') || target.name?.includes('Krysa') ||
                                    target.name?.includes('Pes') || target.name?.includes('Pavouk');
                    if (isAnimal) {
                        baseCritChance += 0.30;
                        if (cs.round === 1) cs.log.push(`游꿢 Tracking: +30% crit na zv칤콏e!`);
                    }
                }
            }
            
            let critChance = baseCritChance + (isCompanion ? (companionSkillEffects.critChance || 0) : (playerSkillEffects.critChance || 0));
            const isCrit = Math.random() < critChance;
            if (isCrit) {
                // Assassin: Kritick칳 z치sah d캩l치 2.5x damage (nerfed from 3x)
                let critMultiplier = 2 + (companionSkillEffects.critDamage || 0);
                
                // Set piece bonus - extra crit damage
                critMultiplier += setEffects.critDamage || 0;
                
                if (!isCompanion && state.char.classId === 'assassin') {
                    // Execute Improved (3 set) - 3x m칤sto 2.5x
                    critMultiplier = setEffects.executeImproved ? 3.0 : 2.5;
                    cs.log.push(`游디勇 EXECUTE! ${setEffects.executeImproved ? '3x' : '2.5x'} kritick칳 damage!`);
                }
                damage = Math.floor(damage * critMultiplier);
                cs.log.push(`游눤 KRITICK칗 Z츼SAH!`);
                SoundSystem.play('critical');
                
                // Bleed on crit (assassin set 2) - krv치cen칤
                if (!isCompanion && setEffects.bleed) {
                    target.bleedDamage = (target.bleedDamage || 0) + 5;
                    target.bleedRounds = 3;
                    cs.log.push(`游뽖 Krv치cen칤! (5 DMG po 3 kola)`);
                }
                
                // Track pro achievement
                if (!isCompanion) {
                    state.stats.criticalHits = (state.stats.criticalHits || 0) + 1;
                }
            }
            
            // Ter칠nn칤 bonus obrany
            const terrain = cs.terrain[target.y]?.[target.x];
            let defense = target.defense;
            
            // Armor pierce - ignoruje 캜치st obrany
            if (!isCompanion && playerSkillEffects.armorPierce > 0) {
                defense = Math.floor(defense * (1 - playerSkillEffects.armorPierce));
            }
            if (terrain?.defenseBonus) {
                defense = Math.floor(defense * (1 + terrain.defenseBonus));
            }
            
            // Bonus obrany z br치n캩n칤
            if (target.defending && target.defenseBonus) {
                defense = Math.floor(defense * (1 + target.defenseBonus / 100));
            }
            
            // Execute bonus - v칤ce damage na nep콏치tele s n칤zk칳m HP
            if (companionSkillEffects.executeBonus && target.hp / target.maxHp < 0.2) {
                damage = Math.floor(damage * (1 + companionSkillEffects.executeBonus));
                cs.log.push(`游 Poprava! (+${Math.round(companionSkillEffects.executeBonus * 100)}% DMG)`);
            }
            
            // Low HP damage bonus
            if (companionSkillEffects.lowHpDamage && unit.hp / unit.maxHp < 0.3) {
                damage = Math.floor(damage * (1 + companionSkillEffects.lowHpDamage));
            }
            
            // Aplikuj damage
            const finalDamage = Math.max(1, damage - defense);
            target.hp -= finalDamage;
            
            // === SET EFEKTY PO Z츼SAHU ===
            if (!isCompanion && typeof getActiveSetEffects === 'function') {
                const setFx = getActiveSetEffects();
                
                // Lifesteal (raider weapon)
                if (setFx.lifesteal > 0) {
                    const healAmount = Math.floor(finalDamage * setFx.lifesteal);
                    if (healAmount > 0) {
                        unit.hp = Math.min(unit.maxHp, unit.hp + healAmount);
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                        cs.log.push(`游뽖 Lifesteal: +${healAmount} HP`);
                    }
                }
                
                // Mind Control (psychic) - 코ance zm치st nep콏칤tele
                const mindControlChance = setFx.mindControlImproved ? 0.30 : (state.char.classId === 'psychic' ? 0.15 : 0);
                if (mindControlChance > 0 && Math.random() < mindControlChance && target.alive) {
                    target.confused = 2; // 2 kola zmaten칤
                    cs.log.push(`游댩 MIND CONTROL! ${target.name} je zmaten칳!`);
                }
                
                // Acid Splash (alchemist set 2) - AoE jed
                if (setFx.acidSplash && Math.random() < 0.20) {
                    const nearbyEnemies = cs.units.filter(u => 
                        u.team === 'enemy' && u.alive &&
                        Math.max(Math.abs(u.x - target.x), Math.abs(u.y - target.y)) <= 1
                    );
                    nearbyEnemies.forEach(enemy => {
                        enemy.poisoned = Math.max(enemy.poisoned || 0, setFx.poisonImproved ? 15 : 8);
                    });
                    if (nearbyEnemies.length > 0) {
                        cs.log.push(`驕멆잺 Kyselinov칳 splash! ${nearbyEnemies.length} nep콏치tel otr치veno!`);
                    }
                }
                
                // Rad Aura (mutant set 2) - radia캜n칤 damage okoln칤m
                if (setFx.radAura) {
                    const nearbyEnemies = cs.units.filter(u => 
                        u.team === 'enemy' && u.alive &&
                        Math.max(Math.abs(u.x - unit.x), Math.abs(u.y - unit.y)) <= 2
                    );
                    nearbyEnemies.forEach(enemy => {
                        enemy.hp -= 5;
                        if (enemy.hp <= 0) {
                            enemy.alive = false;
                            enemy.hp = 0;
                        }
                    });
                    if (nearbyEnemies.length > 0) {
                        cs.log.push(`驕뮖잺 Radia캜n칤 aura: ${nearbyEnemies.length}x 5 DMG`);
                    }
                }
                
                // Heal on hit (medic weapon)
                if (setFx.healOnHit) {
                    const healOnHit = 5;
                    unit.hp = Math.min(unit.maxHp, unit.hp + healOnHit);
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + healOnHit);
                }
                
                // Mutant regen improved (set 3) - +8 HP p콏i z치sahu m칤sto +3
                if (setFx.radRegenImproved && state.char.classId === 'mutant') {
                    const regenAmount = 8;
                    unit.hp = Math.min(unit.maxHp, unit.hp + regenAmount);
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + regenAmount);
                    cs.log.push(`游눜 Mutant칤 regenerace: +${regenAmount} HP`);
                }
            }
            
            // Visual effect - screen shake pokud je hr치캜 zasa쬰n
            if (target.isPlayer || target.team === 'player') {
                VisualEffects.screenShake();
            }
            
            cs.log.push(`丘덢잺 ${unit.name}  ${target.icon}: ${finalDamage} DMG [${unit.actionsLeft - 1} akce]`);
            SoundSystem.play('combat_hit');
            
            // Speci치ln칤 efekty zbran캩 (jen hr치캜)
            if (!isCompanion && weapon?.special === 'poison' && Math.random() < 0.3) {
                target.poisoned = Math.max(target.poisoned || 0, 5);
                cs.log.push(`驕멆잺 Jed pronik치 do r치ny!`);
            }
            if (!isCompanion && weapon?.special === 'bleed' && Math.random() < 0.25) {
                target.bleeding = Math.max(target.bleeding || 0, 3);
                cs.log.push(`游뽖 Zp콢sobil jsi krv치cen칤!`);
            }
            if (!isCompanion && weapon?.special === 'stun' && Math.random() < 0.2) {
                target.stunned = true;
                cs.log.push(`游눪 Omr치캜il jsi nep콏칤tele!`);
            }
            
            if (target.hp <= 0) {
                target.alive = false;
                target.hp = 0;
                cs.log.push(`游 ${target.name} byl pora쬰n!`);
                
                // Berserker: Frenzy stack p콏i zabit칤
                if (!isCompanion && state.char.classId === 'berserker') {
                    state.buffs = state.buffs || [];
                    const frenzyStacks = state.buffs.filter(b => b.id === 'frenzy').length;
                    if (frenzyStacks < 10) {
                        state.buffs.push({ id: 'frenzy', value: 0.1, expires: Date.now() + 60000 });
                        cs.log.push(`游댠 FRENZY! (+${(frenzyStacks + 1) * 10}% damage)`);
                    }
                }
            }
            
            // Multi-target 칰tok (Cleave/Rozseknout)
            if (companionSkillEffects.multiTarget && companionSkillEffects.multiTarget > 1) {
                // Najdi dal코칤 nep콏치tele v dosahu (vedle prim치rn칤ho c칤le)
                const nearbyEnemies = cs.units.filter(u => 
                    u.team === 'enemy' && u.alive && u.id !== target.id &&
                    Math.max(Math.abs(u.x - unit.x), Math.abs(u.y - unit.y)) <= 1
                ).slice(0, companionSkillEffects.multiTarget - 1);
                
                nearbyEnemies.forEach(enemy => {
                    const splashDamage = Math.floor(finalDamage * 0.5); // 50% damage na sekund치rn칤 c칤le
                    enemy.hp -= splashDamage;
                    cs.log.push(`游뿝 Rozseknout  ${enemy.icon}: ${splashDamage} DMG`);
                    if (enemy.hp <= 0) {
                        enemy.alive = false;
                        enemy.hp = 0;
                        cs.log.push(`游 ${enemy.name} byl pora쬰n!`);
                    }
                });
            }
            
            // Synchronizuj HP spole캜n칤ka
            if (isCompanion) {
                const comp = state.companions?.find(c => c.id === unit.companionId);
                if (comp) comp.hp = Math.max(0, unit.hp);
            }
            
            cs.selectedAction = null;
            cs.validTargets = [];
            
            useAction(unit, 1);
        }
        
        function useItemInCombat(itemId) {
            const cs = window.combatState;
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            if (item.effect === 'health') {
                const healAmount = item.value || 30;
                const oldHp = unit.hp;
                unit.hp = Math.min(unit.maxHp, unit.hp + healAmount);
                const actualHeal = unit.hp - oldHp;
                cs.log.push(`游눜 +${actualHeal} HP [${unit.actionsLeft - 1} akce]`);
                
                // Synchronizuj HP hr치캜e
                if (unit.isPlayer) state.char.hp = unit.hp;
                
                // Odeber item bezpe캜n캩
                removeItemFromInventory(item, 1);
                
                useAction(unit, 1);
            }
        }
        
        function showCombatInventory() {
            const cs = window.combatState;
            if (!cs) {
                renderHeroesCombatUI(); // Zobraz칤 error
                return;
            }
            if (!cs.selectedUnit || cs.selectedUnit.team !== 'player') return;
            
            // Najdi bojov칠 p콏edm캩ty
            const healItems = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
            const throwables = state.inv.filter(i => 
                i.type === 'throwable' || 
                i.result?.type === 'throwable' ||
                i.id?.includes('grenade') || 
                i.id?.includes('molotov') || 
                i.id?.includes('dynamite') ||
                i.id?.includes('bomb')
            );
            const buffs = state.inv.filter(i => i.type === 'consumable' && (i.effect === 'all_stats' || i.effect === 'damage'));
            
            let html = '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // L칠캜iv칠
            if (healItems.length > 0) {
                html += '<div style="color: #4caf50; font-size: 0.9rem; margin-bottom: 0.3rem;">游눜 L칠캜en칤:</div>';
                healItems.forEach(item => {
                    html += `<button class="btn" onclick="useCombatHeal('${item.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #2e7d32; text-align: left;">
                        ${item.icon || '游눍'} ${item.name} (+${item.value || 30} HP) x${item.count || 1}
                    </button>`;
                });
            }
            
            // Gran치ty
            if (throwables.length > 0) {
                html += '<div style="color: #ff9800; font-size: 0.9rem; margin: 0.5rem 0 0.3rem;">游눢 V칳bu코niny (AOE):</div>';
                throwables.forEach(item => {
                    const dmg = item.damage || item.result?.damage || item.value || 25;
                    html += `<button class="btn" onclick="throwGrenade('${item.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #e65100; text-align: left;">
                        ${item.icon || '游눢'} ${item.name} (${dmg} DMG v코em) x${item.count || 1}
                    </button>`;
                });
            }
            
            // Buffy
            if (buffs.length > 0) {
                html += '<div style="color: #9c27b0; font-size: 0.9rem; margin: 0.5rem 0 0.3rem;">九 Pos칤len칤:</div>';
                buffs.forEach(item => {
                    html += `<button class="btn" onclick="useCombatBuff('${item.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #7b1fa2; text-align: left;">
                        ${item.icon || '九'} ${item.name} x${item.count || 1}
                    </button>`;
                });
            }
            
            if (healItems.length === 0 && throwables.length === 0 && buffs.length === 0) {
                html += '<p style="color: #888; text-align: center; padding: 1rem;">콯치dn칠 bojov칠 p콏edm캩ty v invent치콏i</p>';
            }
            
            html += '</div>';
            html += '<button class="btn" onclick="renderHeroesCombatUI();" style="width: 100%; margin-top: 0.5rem;"> Zp캩t do boje</button>';
            
            showModal('游 Bojov칠 p콏edm캩ty', html);
        }
        
        function useCombatHeal(itemId) {
            // Nezav칤rej modal! Combat UI je v modalu
            useItemInCombat(itemId);
        }
        
        function throwGrenade(itemId) {
            const cs = window.combatState;
            const item = state.inv.find(i => i.id === itemId);
            if (!item || !cs) return;
            
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            // Damage m콢쬰 b칳t p콏칤mo na itemu nebo v result
            const baseDamage = item.damage || item.result?.damage || item.value || 25;
            let totalDmg = 0;
            let kills = 0;
            
            // Damage v코em nep콏치tel콢m
            cs.units.filter(u => u.team === 'enemy' && u.alive).forEach(enemy => {
                const dmg = Math.max(1, baseDamage - Math.floor(enemy.defense * 0.3));
                enemy.hp -= dmg;
                totalDmg += dmg;
                
                if (enemy.hp <= 0) {
                    enemy.alive = false;
                    enemy.hp = 0;
                    kills++;
                }
            });
            
            cs.log.push(`游눤 ${item.name}: ${totalDmg} DMG! [${unit.actionsLeft - 1} akce]`);
            SoundSystem.play('combat_hit');
            
            // Odeber item
            if (item.count > 1) item.count--;
            else state.inv = state.inv.filter(i => i.id !== itemId);
            
            if (checkCombatEnd()) return;
            
            useAction(unit, 1);
        }
        
        function useCombatBuff(itemId) {
            const cs = window.combatState;
            const item = state.inv.find(i => i.id === itemId);
            if (!item || !cs) return;
            
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            if (item.effect === 'all_stats') {
                unit.damage = Math.floor(unit.damage * 1.25);
                unit.defense = Math.floor(unit.defense * 1.25);
                cs.log.push(`九 +25% DMG/DEF [${unit.actionsLeft - 1} akce]`);
            } else if (item.effect === 'damage') {
                unit.damage += (item.value || 10);
                cs.log.push(`丘덢잺 +${item.value || 10} DMG [${unit.actionsLeft - 1} akce]`);
            }
            
            // Odeber item
            if (item.count > 1) item.count--;
            else state.inv = state.inv.filter(i => i.id !== itemId);
            
            useAction(unit, 1);
        }
        
        function fleeCombat() {
            const cs = window.combatState;
            
            // Z치kladn칤 50% 코ance na 칰t캩k + bonus z vybaven칤
            let fleeChance = 0.5;
            
            // P콏idej escape bonus z brn캩n칤/bot
            const armorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : {};
            if (armorEffects.escapeBonus) {
                fleeChance += armorEffects.escapeBonus;
            }
            
            // Bonus za agilitu
            const agiBonus = ((state.char.attrs?.agi || 5) - 5) * 0.02; // +2% za ka쬯칳 bod nad 5
            fleeChance += agiBonus;
            
            // Max 90%
            fleeChance = Math.min(0.9, fleeChance);
            
            if (Math.random() < fleeChance) {
                cs.log.push(`游끢 칔t캩k se poda콏il! (${Math.round(fleeChance * 100)}% 코ance)`);
                setTimeout(() => {
                    closeModal();
                    renderFull();
                    notifyWarning('Uprchl jsi!', 'Boj ukon캜en bez odm캩ny');
                }, 500);
            } else {
                cs.log.push(`仇 칔t캩k se nezda콏il! (${Math.round(fleeChance * 100)}% 코ance)`);
                endUnitTurn(cs.selectedUnit);
                renderHeroesCombatUI();
            }
        }
        
        // === OVL츼D츼N칈 SPOLE캛N칈K콡 ===
        
        function toggleCompanionControl() {
            const cs = window.combatState;
            cs.manualCompanions = !cs.manualCompanions;
            
            // Ulo do nastaven칤
            if (!state.settings) state.settings = {};
            state.settings.manualCompanions = cs.manualCompanions;
            saveGame();
            
            cs.log.push(`游냇 Spole캜n칤ci: ${cs.manualCompanions ? 'Manu치ln칤 ovl치d치n칤' : 'AI ovl치d치n칤'}`);
            renderHeroesCombatUI();
            
            // Pokud se p콏epnulo na AUTO a je pr치v캩 tah spole캜n칤ka, spus콘 AI
            if (!cs.manualCompanions && cs.selectedUnit && cs.selectedUnit.isCompanion && cs.selectedUnit.alive && cs.selectedUnit.actionsLeft > 0) {
                setTimeout(() => performCompanionAITurn(cs.selectedUnit), 300);
            }
        }
        
        function letCompanionAI() {
            // Nech치 AI odehr치t tah za spole캜n칤ka
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || !unit.isCompanion) return;
            
            performCompanionAITurn(unit);
        }
        
        // === RENDER ===
        
        function renderHeroesCombatUI() {
            const cs = window.combatState;
            if (!cs) {
                // Combat state ztracen - zobraz error a nab칤dni restart
                document.getElementById('modalContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem;">丘멆잺</div>
                        <h2 style="color: #ff9800;">Chyba boje</h2>
                        <p style="color: #888;">Combat state byl ztracen. Toto by se nem캩lo st치t.</p>
                        <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;"> Zp캩t do hry</button>
                    </div>
                `;
                return;
            }
            
            const currentUnit = cs.selectedUnit;
            // Hr치캜콢v tah = hr치캜 NEBO spole캜n칤k p콏i manu치ln칤m ovl치d치n칤
            const isPlayerControlled = currentUnit && currentUnit.team === 'player' && !currentUnit.acted && 
                (currentUnit.isPlayer || (currentUnit.isCompanion && cs.manualCompanions));
            const isCompanionTurn = currentUnit && currentUnit.isCompanion && cs.manualCompanions;
            
            // Statistiky
            const playerUnits = cs.units.filter(u => u.team === 'player' && u.alive);
            const enemyUnits = cs.units.filter(u => u.team === 'enemy' && u.alive);
            const totalEnemyHp = enemyUnits.reduce((sum, e) => sum + e.hp, 0);
            const maxEnemyHp = cs.units.filter(u => u.team === 'enemy').reduce((sum, e) => sum + e.maxHp, 0);
            
            // Heal items
            const healItems = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
            
            // M치 spole캜n칤ky?
            const hasCompanions = playerUnits.some(u => u.isCompanion);
            
            document.getElementById('modalContent').innerHTML = `
                <div style="background: linear-gradient(180deg, #0d1520 0%, #0a0f15 100%); margin: -1rem; padding: 0.8rem; border-radius: 8px; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    
                    <!-- HEADER -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #2a3a4a;">
                        <div>
                            <span style="color: #ff6b6b; font-weight: bold;">${'丘덢잺 BOJ'}</span>
                            <span style="color: #666; font-size: 0.85rem;"> - Kolo ${cs.round}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${hasCompanions ? `
                                <button onclick="toggleCompanionControl()" style="background: ${cs.manualCompanions ? 'linear-gradient(135deg, #4CAF50, #2e7d32)' : 'linear-gradient(135deg, #ff9800, #f57c00)'}; border: 2px solid ${cs.manualCompanions ? '#8bc34a' : '#ffb74d'}; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; color: white; font-weight: bold; ${cs.manualCompanions ? '' : 'animation: pulse 1.5s infinite;'}" title="Klikni pro p콏epnut칤 ovl치d치n칤 spole캜n칤k콢">
                                    游냇 ${cs.manualCompanions ? '九 RU캛N칈' : '游뱄 AUTO'}
                                </button>
                            ` : ''}
                            <span style="color: #4ecdc4; font-size: 0.85rem;">游논 ${playerUnits.length}</span>
                            <span style="color: #ff6b6b; font-size: 0.85rem;">游 ${enemyUnits.length}</span>
                        </div>
                    </div>
                    </div>
                    
                    <!-- ENEMY HP BAR -->
                    <div style="margin-bottom: 0.5rem;">
                        <div style="height: 6px; background: #1a1a2a; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${(totalEnemyHp/maxEnemyHp)*100}%; background: linear-gradient(90deg, #c0392b, #e74c3c); transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- BOJOV츼 M콎칈콯KA -->
                    <div style="background: #0a0f15; border: 2px solid #2a3a4a; border-radius: 8px; padding: 0.3rem; margin-bottom: 0.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(${COMBAT_GRID.cols}, 1fr); gap: 2px;">
                            ${renderCombatGrid()}
                        </div>
                    </div>
                    
                    <!-- AKTU츼LN칈 JEDNOTKA -->
                    ${currentUnit ? `
                        <div style="background: ${currentUnit.team === 'player' ? '#1a2a1a' : '#2a1a1a'}; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid ${currentUnit.team === 'player' ? '#4a7c4a' : '#7c4a4a'};">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">${currentUnit.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: ${currentUnit.team === 'player' ? '#8bc34a' : '#ff6b6b'};">
                                        ${currentUnit.name}
                                        ${currentUnit.isCompanion ? '<span style="font-size: 0.7rem; color: #ff9800;"> (Spole캜n칤k)</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #888;">
                                        仇벒잺 ${currentUnit.hp}/${currentUnit.maxHp} | 丘덢잺 ${currentUnit.damage} | 游띠勇 ${currentUnit.defense} | 游눧 ${currentUnit.speed}
                                    </div>
                                </div>
                                ${currentUnit.team === 'player' ? `<div style="text-align: right;"><span style="color: #ffd700; font-size: 0.9rem;">餃 ${currentUnit.isCompanion ? 'Spole캜n칤k' : 'Tv콢j'} tah</span><br><span style="background: #2a4a2a; padding: 0.2rem 0.5rem; border-radius: 4px; color: #8bc34a; font-weight: bold;">丘 ${currentUnit.actionsLeft || 0}/2 akce</span></div>` : '<span style="color: #ff6b6b;">Nep콏칤tel...</span>'}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- AKCE (pokud je hr치캜콢v/spole캜n칤k콢v tah) -->
                    ${isPlayerControlled ? `
                        <!-- Info o zbrani a munici -->
                        <div style="background: #1a1a2a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.4rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; color: #888;">
                                ${!isCompanionTurn && state.equipped?.weapon ? 
                                    `${state.equipped.weapon.icon || '丘덢잺'} ${state.equipped.weapon.name} (丘덢잺${state.equipped.weapon.damage || 10}) ${state.equipped.weapon.ammoType ? '游꿢' : '游디勇'}` : 
                                    isCompanionTurn ? `游 ${currentUnit.name} 칰to캜칤` : '游녥 Hol칠 ruce (丘덢잺5) 游디勇'}
                            </span>
                            ${!isCompanionTurn && state.equipped?.weapon?.ammoType ? 
                                `<span style="font-size: 0.75rem; padding: 0.2rem 0.4rem; border-radius: 4px; ${getAmmoCount(state.equipped.weapon.ammoType) > 0 ? 'background: #2a4a2a; color: #8bc34a;' : 'background: #4a2a2a; color: #ff6b6b;'}">
                                    游댦 ${getAmmoCount(state.equipped.weapon.ammoType)} ${getAmmoName(state.equipped.weapon.ammoType)}
                                </span>` : 
                                `<span style="font-size: 0.7rem; color: #ff9800;">Dosah: ${isCompanionTurn ? 'Na bl칤zko' : '1 pole'}</span>`}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(${isCompanionTurn ? 3 : 4}, 1fr); gap: 0.3rem; margin-bottom: 0.4rem;">
                            <button class="btn" onclick="selectAction('move')" style="padding: 0.4rem; font-size: 0.8rem; background: ${cs.selectedAction === 'move' ? '#1565c0' : '#2a3a4a'};">
                                游뛌 Pohyb
                            </button>
                            <button class="btn" onclick="selectAction('attack')" style="padding: 0.4rem; font-size: 0.8rem; background: ${cs.selectedAction === 'attack' ? '#c62828' : '#2a3a4a'};">
                                丘덢잺 칔tok
                            </button>
                            <button class="btn" onclick="selectAction('defend')" style="padding: 0.4rem; font-size: 0.8rem; background: #2a3a4a;">
                                游띠勇 Obrana
                            </button>
                            ${!isCompanionTurn ? `
                            <button class="btn" onclick="selectAction('weapon')" style="padding: 0.4rem; font-size: 0.8rem; background: #6a4c93;">
                                游댃 Zbra켿
                            </button>
                            ` : ''}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(${isCompanionTurn ? 2 : 3}, 1fr); gap: 0.3rem; margin-bottom: 0.5rem;">
                            ${!isCompanionTurn ? `
                            <button class="btn" onclick="showCombatInventory()" style="padding: 0.4rem; font-size: 0.8rem; background: #1565c0;">
                                游 Item
                            </button>
                            ` : ''}
                            <button class="btn" onclick="selectAction('wait')" style="padding: 0.4rem; font-size: 0.8rem; background: #2a3a4a;">
                                낈勇 Konec
                            </button>
                            ${!isCompanionTurn ? `
                            <button class="btn" onclick="fleeCombat()" style="padding: 0.4rem; font-size: 0.8rem; background: #5d4037;">
                                游끢 칔t캩k
                            </button>
                            ` : `
                            <button class="btn" onclick="letCompanionAI()" style="padding: 0.4rem; font-size: 0.8rem; background: #ff9800;">
                                游뱄 AI tah
                            </button>
                            `}
                        </div>
                    ` : ''}
                    
                    <!-- LEGENDA TLA캛칈TKO -->
                    <button class="btn" onclick="showTerrainLegend()" style="width: 100%; padding: 0.3rem; font-size: 0.7rem; background: #333; margin-bottom: 0.3rem;">
                        游늶 Legenda ter칠nu
                    </button>
                    
                    <!-- BOJ LOG -->
                    <div id="combatLogGrid" style="background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 0.4rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch; font-size: 0.75rem;">
                        ${cs.log.slice(-8).map(l => `<div style="color: #aaa; margin-bottom: 2px;">${l}</div>`).join('')}
                    </div>
                    
                </div>
            `;
            
            // Scroll log dol콢
            const log = document.getElementById('combatLogGrid');
            if (log) log.scrollTop = log.scrollHeight;
        }
        
        function showTerrainLegend() {
            const terrainTypes = [
                { icon: '游댠', name: 'Ohe켿', effect: '8 DMG ka쬯칠 kolo', color: '#ff4444' },
                { icon: '驕뮖잺', name: 'Toxick칳 odpad', effect: '5 DMG + 3 radiace', color: '#ff9800' },
                { icon: '游돕勇', name: 'Propast', effect: '10 DMG p콏i vstupu', color: '#ff4444' },
                { icon: '游눦', name: 'Voda', effect: '-50% rychlost', color: '#2196f3' },
                { icon: '游깱', name: 'Hlubok치 voda', effect: 'Nelze proj칤t', color: '#1565c0' },
                { icon: '游릯', name: 'Bahno', effect: '-30% rychlost', color: '#795548' },
                { icon: '游', name: 'Les', effect: '+20% obrana', color: '#4caf50' },
                { icon: '游꺕', name: 'Strom', effect: 'Nelze proj칤t', color: '#2e7d32' },
                { icon: '游', name: 'Ke콏', effect: '+10% obrana', color: '#66bb6a' },
                { icon: '游뿻', name: 'Kl치da', effect: '+10% obrana', color: '#8d6e63' },
                { icon: '游', name: 'R치kos칤', effect: '+10% obrana', color: '#aed581' },
                { icon: '游빔', name: 'Trosky', effect: '+15% obrana, -20% rychlost', color: '#9e9e9e' },
                { icon: '游뚱', name: 'Vrak auta', effect: 'Nelze proj칤t', color: '#607d8b' },
                { icon: '游끸勇', name: 'Ze캞', effect: 'Nelze proj칤t', color: '#757575' },
                { icon: '游띡勇', name: 'Sudy', effect: '+15% obrana', color: '#ff9800' },
                { icon: '游닍', name: 'Bedny', effect: '+10% obrana', color: '#795548' },
                { icon: '丘뙖잺', name: 'Stroj', effect: 'Nelze proj칤t', color: '#90a4ae' },
                { icon: '游댤', name: 'Potrub칤', effect: '+10% obrana', color: '#78909c' },
                { icon: '游뿯', name: 'Sk치la', effect: 'Nelze proj칤t', color: '#9e9e9e' },
                { icon: '游', name: 'Stalagmit', effect: 'Nelze proj칤t', color: '#8d6e63' },
                { icon: '游눑', name: 'Krystal', effect: '+10% obrana', color: '#e1bee7' }
            ];
            
            let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">';
            
            terrainTypes.forEach(t => {
                html += `
                    <div style="background: #1a1a1a; padding: 0.4rem; border-radius: 6px; border-left: 3px solid ${t.color};">
                        <span style="font-size: 1.2rem;">${t.icon}</span>
                        <span style="font-weight: bold; color: ${t.color};">${t.name}</span>
                        <div style="font-size: 0.7rem; color: #888;">${t.effect}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="margin-top: 0.5rem; padding: 0.5rem; background: #1a2a1a; border-radius: 6px; font-size: 0.75rem; color: #8bc34a;">';
            html += '游눠 <strong>Tip:</strong> Obrana se aplikuje p콏i 칰toku NA tebe. Rychlost ovliv켿uje pohyb. Po코kozen칤 se aplikuje ka쬯칠 kolo.';
            html += '</div>';
            html += '</div>';
            html += '<button class="btn" onclick="renderHeroesCombatUI()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t do boje</button>';
            
            showModal('游늶 Legenda ter칠nu', html);
        }
        
        function renderCombatGrid() {
            const cs = window.combatState;
            let html = '';
            
            for (let y = 0; y < COMBAT_GRID.rows; y++) {
                for (let x = 0; x < COMBAT_GRID.cols; x++) {
                    const unit = cs.units.find(u => u.alive && u.x === x && u.y === y);
                    const terrain = cs.terrain[y]?.[x];
                    
                    // Zv칳razn캩n칤
                    const isValidMove = cs.validMoves.some(m => m.x === x && m.y === y);
                    const isValidTarget = unit && cs.validTargets.includes(unit);
                    const isSelected = cs.selectedUnit && cs.selectedUnit.x === x && cs.selectedUnit.y === y;
                    
                    let bgColor = '#151a20';
                    let border = '1px solid #2a3a4a';
                    
                    if (isSelected) {
                        bgColor = '#1a3a1a';
                        border = '2px solid #4caf50';
                    } else if (isValidMove) {
                        bgColor = '#1a2a3a';
                        border = '2px solid #2196f3';
                    } else if (isValidTarget) {
                        bgColor = '#3a1a1a';
                        border = '2px solid #f44336';
                    }
                    
                    // Ter칠n pozad칤
                    if (terrain && terrain.type !== 'empty') {
                        if (terrain.blocked) {
                            bgColor = '#0a0a0a'; // Neprostupn칠
                            border = '1px solid #333';
                        } else if (terrain.type === 'forest' || terrain.type === 'bush' || terrain.type === 'reed') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#1a2a1a';
                        } else if (terrain.type === 'water' || terrain.type === 'mud') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#1a2a3a';
                        } else if (terrain.type === 'fire' || terrain.type === 'toxic') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#3a2a1a';
                        } else if (terrain.type === 'rubble' || terrain.type === 'barrel' || terrain.type === 'crate') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#2a2a1a';
                        }
                    }
                    
                    const clickable = (isValidMove || isValidTarget) ? 'cursor: pointer;' : '';
                    const onClick = (isValidMove || isValidTarget) ? `onclick="clickCell(${x},${y})"` : '';
                    
                    // Tooltip pro ter칠n
                    const terrainTitle = terrain && terrain.type !== 'empty' ? `title="${terrain.name || terrain.type}${terrain.blocked ? ' (neprostupn칠)' : ''}${terrain.defenseBonus ? ' (+' + Math.round(terrain.defenseBonus*100) + '% obrana)' : ''}${terrain.damage ? ' (' + terrain.damage + ' DMG)' : ''}"` : '';
                    
                    html += `
                        <div ${onClick} ${terrainTitle} style="
                            aspect-ratio: 1;
                            background: ${bgColor};
                            border: ${border};
                            border-radius: 3px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-size: 1rem;
                            position: relative;
                            ${clickable}
                            min-height: 32px;
                            max-height: 45px;
                        ">
                            ${terrain && terrain.type !== 'empty' && !unit ? `<span style="opacity: ${terrain.blocked ? '0.6' : '0.35'}; font-size: 0.85rem;">${terrain.icon}</span>` : ''}
                            ${unit ? `
                                <span style="filter: ${unit.stunned ? 'grayscale(1)' : 'none'}; font-size: 1.1rem;">${unit.icon}</span>
                                <div style="
                                    position: absolute;
                                    bottom: 1px;
                                    left: 1px;
                                    right: 1px;
                                    height: 2px;
                                    background: #1a0a0a;
                                    border-radius: 1px;
                                    overflow: hidden;
                                ">
                                    <div style="
                                        height: 100%;
                                        width: ${(unit.hp/unit.maxHp)*100}%;
                                        background: ${unit.team === 'player' ? '#4caf50' : '#f44336'};
                                    "></div>
                                </div>
                                ${unit.poisoned ? '<span style="position: absolute; top: -2px; right: -2px; font-size: 0.5rem;">驕멆잺</span>' : ''}
                                ${unit.bleeding ? '<span style="position: absolute; top: -2px; left: -2px; font-size: 0.5rem;">游뽖</span>' : ''}
                                ${unit.stunned ? '<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 0.7rem;">游눪</span>' : ''}
                                ${unit.defending ? '<span style="position: absolute; bottom: 5px; right: -2px; font-size: 0.5rem;">游띠勇</span>' : ''}
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            return html;
        }
        
        function handleCombatDefeat() {
            const cs = window.combatState;
            
            // Zvuk prohry
            if (typeof playCombatSound === 'function') playCombatSound('defeat');
            
            // === V츼LE캛N츼 Z칍NA - hr치캜 m콢쬰 prohr치t boj, ale nezem콏e ===
            if (state.warZoneFight?.active) {
                const warFight = state.warZoneFight;
                state.warZoneFight = null;
                window.combatState = null;
                
                // Obnov p콢vodn칤 HP (p콏ed bojem)
                state.char.hp = warFight.savedHp || Math.max(1, Math.floor(state.char.maxHp * 0.5));
                
                // Nastav cooldown
                if (multiplayerEnabled && firebaseDB) {
                    const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                    firebaseDB.ref('warZone/cooldowns/' + myName).set(Date.now()).catch(e => {});
                }
                
                showModal('游 Prohra v boji!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">游</div>
                        <h3 style="color: #f44336;">Byl jsi pora쬰n!</h3>
                        <p style="color: #888;">Nez칤skal jsi 쮂멳n칠 body pro svou frakci.</p>
                        <p style="color: #8bc34a;">HP obnoveno na p콢vodn칤 hodnotu</p>
                        <p style="color: #666; font-size: 0.9rem;">Dal코칤 pokus za 10 minut.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #555;">
                        Zav콏칤t
                    </button>
                `);
                return;
            }
            
            // === TERRITORY GUARD COMBAT ===
            // Pokud to byl boj se str치쬮i 칰zem칤, zpracuj ho zvl치코콘
            if (cs?.combatType === 'territory_guard' && window.territoryBattle) {
                onTerritoryBattleEnd(false);
                window.combatState = null;
                // P콏i proh콏e v 칰zem칤 boji se neprohr치v치 cel치 hra
                state.char.hp = Math.max(1, Math.floor(state.char.maxHp * 0.1)); // 10% HP
                notifyWarning('游 Prohra!', 'Str치쬮i t캩 porazili. Utekl jsi s t캩쬶칳mi zran캩n칤mi.');
                renderFull();
                saveGame(true);
                return;
            }
            
            state.stats.deaths = (state.stats.deaths || 0) + 1;
            
            // Speci치ln칤 handling pro Abyss - opravdov치 smrt bez mo쬹osti respawnu
            if (cs?.combatType === 'abyss') {
                window.combatState = null;
                if (typeof handleAbyssDefeat === 'function') {
                    handleAbyssDefeat();
                } else {
                    // Fallback - norm치ln칤 smrt
                    state.isDead = true;
                    showModal('游 SMRT V PROPASTI', `
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 4rem;">游돕勇游</div>
                            <h2 style="color: #9c27b0;">Propast t캩 pohltila!</h2>
                            <p style="color: #888;">Temnota Abyss je absolutn칤...</p>
                            <button class="btn" onclick="location.reload();" style="width: 100%; margin-top: 1rem; background: #c62828;">
                                Za캜칤t znovu
                            </button>
                        </div>
                    `);
                }
                return;
            }
            
            window.combatState = null;
            
            // === TEST MODE ===
            // Hr치캜 nezem콏e, jen se vyl칠캜칤 - pro testov치n칤
            state.char.hp = state.char.maxHp;
            
            // P콏idej do hern칤ho den칤ku
            addLog(`游 Prohra v boji! (TEST MODE - HP obnoveno)`, '游');
            
            showModal('游 PROHRA', `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem;">游빍</div>
                    <h2 style="color: #ff9800;">TEST MODE</h2>
                    <p style="color: #888;">Norm치ln캩 bys um콏el, ale pro testov치n칤 pokra캜uje코.</p>
                    <p style="color: #4caf50;">HP obnoveno na maximum!</p>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">
                        九 Pokra캜ovat v testov치n칤
                    </button>
                </div>
            `);
            
            saveGame(true);
        }
        
        // === STAR칗 startCombat upraven칳 pro nov칳 syst칠m ===
        
        function startCombat(enemy, isAmbush = false, isVillageRaid = false, forceEnemyCount = null) {
            // Blokace b캩hem sp치nku
            if (state.isSleeping) {
                state.isSleeping = false; // Probu캞 se p콏i 칰toku!
                state.sleepEndTime = null;
                notifyWarning('游눣 Probudil ses!', 'N캩kdo t캩 napadl b캩hem sp치nku!');
            }
            
            // Spole캜n칤ci spot콏ebov치vaj칤 munici p콏칤mo z invent치콏e hr치캜e p콏i ka쬯칠m 칰toku
            
            // Reset Phoenix efektu pro nov칳 boj
            window.phoenixUsed = false;
            
            // Stalker passive - 50% chance to avoid ambush
            if (isAmbush) {
                const ambushPassive = getClassPassive('onAmbush');
                if (ambushPassive && ambushPassive.avoid) {
                    showModal('游녻 Vyklouzl jsi!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">游녻</div>
                            <p style="color: #8bc34a; font-size: 1.2rem;">Stealth!</p>
                            <p>${ambushPassive.message}</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${'Pokra캜ovat'}</button>
                    `);
                    return;
                }
            }
            
            closeModal();
            
            setTimeout(() => {
                // Pokud enemy m치 v코echna pot콏ebn치 data (custom enemy z lovu), pou쬴j je p콏칤mo
                let enemyData;
                if (enemy.hp && enemy.damage && enemy.name) {
                    // Custom enemy (nap콏. ze zv칤콏at p콏i lovu)
                    // P콏eve캞 loot objekt na pole pro combat syst칠m
                    let lootArray = [];
                    if (enemy.loot) {
                        if (Array.isArray(enemy.loot)) {
                            lootArray = enemy.loot;
                        } else {
                            // Objekt { meat: 6, leather: 4 } -> pole ['meat', 'leather', ...]
                            Object.entries(enemy.loot).forEach(([item, count]) => {
                                for (let i = 0; i < count; i++) {
                                    lootArray.push(item === 'meat' ? 'raw_meat' : item);
                                }
                            });
                        }
                    }
                    
                    enemyData = {
                        id: enemy.id,
                        name: enemy.name,
                        icon: enemy.icon || '仇',
                        hp: enemy.hp,
                        maxHp: enemy.hp,
                        damage: enemy.damage,
                        defense: enemy.defense || 0,
                        xp: enemy.xp || 10,
                        speed: enemy.speed || 5,
                        loot: lootArray,
                        minCount: 1,
                        maxCount: 1,
                        tier: enemy.tier || 1
                    };
                } else {
                    // Standardn칤 enemy z datab치ze
                    enemyData = ENEMIES.find(e => e.id === enemy.id);
                }
                
                if (!enemyData) {
                    console.error('Enemy not found:', enemy.id);
                    notifyError('Chyba', 'Nep콏칤tel nenalezen!');
                    return;
                }
                
                // Psychic passive - 10% chance enemy flees
                const psychicPassive = getClassPassive('onCombatStart');
                if (psychicPassive && psychicPassive.flee) {
                    showModal('游댩 Mind Control!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">游댩</div>
                            <p style="color: #aa00ff; font-size: 1.2rem;">Mind Control!</p>
                            <p>${enemyData.icon} ${enemyData.name} utekl v hr콢ze!</p>
                            <p style="color: #8bc34a;">Z칤sk치v치코 ${Math.floor(enemyData.xp * 0.5)} XP</p>
                        </div>
                        <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">${'Pokra캜ovat'}</button>
                    `);
                    addXP(Math.floor(enemyData.xp * 0.5));
                    return;
                }
                
                // Determine enemy count - pou쬴j forceEnemyCount pokud je zad치n
                let enemyCount;
                if (forceEnemyCount && forceEnemyCount > 0) {
                    enemyCount = forceEnemyCount;
                } else {
                    enemyCount = Math.floor(Math.random() * (enemyData.maxCount - enemyData.minCount + 1)) + enemyData.minCount;
                    
                    // Tier 1-2 nep콏치tel칠 se 캜ast캩ji objevuj칤 ve skupin치ch
                    if (enemyData.tier <= 2 && enemyCount === 1 && Math.random() < 0.5) {
                        enemyCount = 2;
                    }
                }
                
                if (isVillageRaid) {
                    enemyCount = Math.max(enemyCount, 3);
                    enemyCount = Math.min(enemyCount + 2, 6);
                }
                
                // Ambush bonus
                const ambushBonus = isAmbush ? 1.1 : 1.0;
                
                // Create enemy group pro nov칳 Heroes3 syst칠m
                const enemyGroup = [];
                for (let i = 0; i < enemyCount; i++) {
                    enemyGroup.push({
                        ...enemyData,
                        damage: Math.floor(enemyData.damage * ambushBonus),
                        defense: Math.floor(enemyData.defense * ambushBonus),
                        hp: enemyData.hp,
                        maxHp: enemyData.hp,
                        speed: enemyData.speed || 5 + Math.floor(Math.random() * 5)
                    });
                }
                
                // Pokud m치me spole캜n칤ky a nen칤 p콏epaden칤, uka pre-combat setup
                const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
                if (aliveCompanions.length > 0 && !isAmbush) {
                    showPreCombatSetup(enemyGroup, isVillageRaid ? 'settlement_raid' : 'normal');
                } else {
                    // Bez spole캜n칤k콢 nebo p콏i p콏epaden칤 - rovnou do boje
                    const combatType = isVillageRaid ? 'settlement_raid' : 'normal';
                    startCombatWithGroup(enemyGroup, combatType);
                }
                
            }, 100);
        }
        
        // Pre-combat setup - rozm칤st캩n칤 spole캜n칤k콢
        function showPreCombatSetup(enemyGroup, combatType) {
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
            
            // V칳choz칤 pozice spole캜n칤k콢
            const defaultPositions = [
                { id: 'back_top', x: 8, y: 1, label: 'Vzadu naho콏e' },
                { id: 'back_bot', x: 8, y: 3, label: 'Vzadu dole' },
                { id: 'back_mid', x: 8, y: 2, label: 'Vzadu st콏ed' },
                { id: 'front_top', x: 7, y: 1, label: 'Naho콏e' },
                { id: 'front_bot', x: 7, y: 3, label: 'Dole' }
            ];
            
            // Na캜ti ulo쬰n칠 pozice ze state (p콏e쬴j칤 refresh) nebo pou쬴j v칳choz칤
            if (!state.savedCompanionPositions) {
                state.savedCompanionPositions = {};
            }
            
            // Inicializuj pozice spole캜n칤k콢 - pou쬴j ulo쬰n칠 nebo v칳choz칤
            window.preCombatPositions = {};
            aliveCompanions.forEach((comp, idx) => {
                const compId = comp.uniqueId || comp.id;
                if (state.savedCompanionPositions[compId]) {
                    // Pou쬴j ulo쬰nou pozici
                    window.preCombatPositions[compId] = state.savedCompanionPositions[compId];
                } else {
                    // V칳choz칤 pozice
                    window.preCombatPositions[compId] = defaultPositions[idx] || defaultPositions[0];
                }
            });
            
            // Ulo enemy group pro pozd캩j코칤 pou쬴t칤
            window.pendingEnemyGroup = enemyGroup;
            window.pendingCombatType = combatType;
            
            renderPreCombatSetup();
        }
        
        function renderPreCombatSetup() {
            const enemyGroup = window.pendingEnemyGroup;
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
            
            const positions = [
                { id: 'front_top', x: 6, y: 1, label: '游띠勇 P콏edn칤 - Naho콏e', desc: 'Prvn칤 v boji' },
                { id: 'front_mid', x: 6, y: 2, label: '游띠勇 P콏edn칤 - St콏ed', desc: 'Hlavn칤 pozice' },
                { id: 'front_bot', x: 6, y: 3, label: '游띠勇 P콏edn칤 - Dole', desc: 'Prvn칤 v boji' },
                { id: 'back_top', x: 8, y: 1, label: '游낓 Zadn칤 - Naho콏e', desc: 'Chr치n캩n칳' },
                { id: 'back_mid', x: 8, y: 2, label: '游낓 Zadn칤 - St콏ed', desc: 'Bezpe캜n칳' },
                { id: 'back_bot', x: 8, y: 3, label: '游낓 Zadn칤 - Dole', desc: 'Chr치n캩n칳' }
            ];
            
            let html = `
                <div style="margin-bottom: 1rem;">
                    <h3 style="color: #ff9800; margin: 0 0 0.5rem 0;">丘덢잺 Nep콏치tel칠 (${enemyGroup.length}x)</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${enemyGroup.slice(0, 5).map(e => `
                            <div style="background: #2a1a1a; padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #8B0000;">
                                <span style="font-size: 1.2rem;">${e.icon}</span>
                                <span style="color: #ff6666; font-size: 0.8rem;">${e.name}</span>
                            </div>
                        `).join('')}
                        ${enemyGroup.length > 5 ? `<span style="color: #888;">+${enemyGroup.length - 5} dal코칤ch</span>` : ''}
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <h3 style="color: #8bc34a; margin: 0 0 0.5rem 0;">游논 Rozm칤st캩n칤 spole캜n칤k콢</h3>
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">Vyber pozici pro ka쬯칠ho spole캜n칤ka:</p>
            `;
            
            aliveCompanions.forEach((comp, idx) => {
                const compData = COMPANIONS.find(cd => cd.id === comp.id);
                const compId = comp.uniqueId || comp.id;
                const currentPos = window.preCombatPositions[compId] || positions[0];
                const isExcluded = currentPos.id === 'excluded';
                
                html += `
                    <div style="background: ${isExcluded ? '#2a2a1a' : '#1a2a1a'}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid ${isExcluded ? '#666' : '#2a4a2a'}; ${isExcluded ? 'opacity: 0.7;' : ''}">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">${comp.icon || compData?.icon || '游녻'}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${isExcluded ? '#888' : '#8bc34a'};">${comp.name || compData?.name} ${isExcluded ? '(캜ek치)' : ''}</div>
                                <div style="font-size: 0.75rem; color: #888;">仇벒잺 ${comp.hp}/${comp.maxHp} | 丘덢잺 ${getCompanionStat(comp, 'damage')} | 游띠勇 ${getCompanionStat(comp, 'defense')}</div>
                            </div>
                        </div>
                        <select onchange="updateCompanionPosition('${compId}', this.value)" 
                            style="width: 100%; padding: 0.5rem; background: #0a0a0a; border: 1px solid #444; border-radius: 4px; color: #fff;">
                            <option value="excluded" ${isExcluded ? 'selected' : ''}>游뛂 Nebojuje - z콢stane vzadu</option>
                            ${positions.map(p => `
                                <option value="${p.id}" ${currentPos.id === p.id ? 'selected' : ''}>
                                    ${p.label} - ${p.desc}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="confirmPreCombatSetup()" style="background: #555;">
                        游 V칳choz칤 pozice
                    </button>
                    <button class="btn" onclick="confirmPreCombatSetup()" style="background: linear-gradient(135deg, #8B0000, #5a0000);">
                        丘덢잺 Do boje!
                    </button>
                </div>
            `;
            
            showModal('丘덢잺 P콏칤prava na boj', html);
        }
        
        function updateCompanionPosition(compId, positionId) {
            const positions = {
                'excluded': { id: 'excluded', x: -1, y: -1, excluded: true },
                'front_top': { id: 'front_top', x: 6, y: 1 },
                'front_mid': { id: 'front_mid', x: 6, y: 2 },
                'front_bot': { id: 'front_bot', x: 6, y: 3 },
                'back_top': { id: 'back_top', x: 8, y: 1 },
                'back_mid': { id: 'back_mid', x: 8, y: 2 },
                'back_bot': { id: 'back_bot', x: 8, y: 3 }
            };
            const newPos = positions[positionId] || positions['back_mid'];
            window.preCombatPositions[compId] = newPos;
            
            // Ulo do state pro p콏칤코t칤 boje
            if (!state.savedCompanionPositions) state.savedCompanionPositions = {};
            state.savedCompanionPositions[compId] = newPos;
            
            // P콏ekresli modal pro vizu치ln칤 feedback
            renderPreCombatSetup();
        }
        
        function confirmPreCombatSetup() {
            console.log('游꿡 confirmPreCombatSetup called');
            
            // Ulo reference P콎ED closeModal
            const enemyGroup = window.pendingEnemyGroup;
            const combatType = window.pendingCombatType;
            
            console.log('游꿡 enemyGroup:', enemyGroup);
            console.log('游꿡 combatType:', combatType);
            
            if (!enemyGroup || enemyGroup.length === 0) {
                console.error('confirmPreCombatSetup: No enemy group!');
                closeModal();
                notifyError('Chyba', '콯치dn칤 nep콏치tel칠 k boji!');
                return;
            }
            
            // Ulo pozice do state pro p콏칤코t칤 boje
            if (!state.savedCompanionPositions) state.savedCompanionPositions = {};
            Object.assign(state.savedCompanionPositions, window.preCombatPositions);
            
            // P콏edej pozice do startCombatWithGroup
            window.companionPositionsOverride = window.preCombatPositions;
            
            // Cleanup a po ulo쬰n칤 referenc칤
            window.pendingEnemyGroup = null;
            window.pendingCombatType = null;
            window.preCombatPositions = null;
            
            console.log('游꿡 Calling startCombatWithGroup with', enemyGroup.length, 'enemies');
            
            // Nastav flag aby se pre-combat setup nezobrazoval znovu
            window._inPreCombatFlow = true;
            
            // Spus콘 boj s ulo쬰n칳mi referencemi
            startCombatWithGroup(enemyGroup, combatType, true); // true = skip pre-combat
        }
        
        function renderCombatUI() {
            const cs = window.combatState;
            if (!cs) return;
            
            const enemyGroup = cs.enemyGroup;
            
            // Fix: Ensure dead enemies are marked as not alive
            enemyGroup.forEach(e => {
                if (e.hp <= 0 && e.alive) {
                    e.alive = false;
                }
            });
            
            // Check if all enemies are dead - trigger victory
            const stillAlive = enemyGroup.filter(e => e.alive);
            if (stillAlive.length === 0) {
                handleCombatVictory();
                return;
            }
            
            const enemyData = enemyGroup[0];
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            
            // Zachovat obsah combat logu
            const existingLog = document.getElementById('combatLog');
            const combatStartText = '丘덢잺 Boj za캜칤n치!';
            const logContent = existingLog ? existingLog.innerHTML : `<div style="color: #666;">${combatStartText}</div>`;
            
            // Calculate stats - pou쬴j NASAZEN칄 vybaven칤
            let playerDefense = Math.floor(state.char.attrs.end * 1); // END bonus
            const armor = state.equipped?.armor;
            const helmet = state.equipped?.helmet;
            const gloves = state.equipped?.gloves;
            const boots = state.equipped?.boots;
            if (armor && armor.defense) playerDefense += armor.defense;
            if (helmet && helmet.defense) playerDefense += helmet.defense;
            if (gloves && gloves.defense) playerDefense += gloves.defense;
            if (boots && boots.defense) playerDefense += boots.defense;
            playerDefense += getSkillTreeBonus('defense');
            // Bonusy z mutac칤 (nap콏. Tlust치 k콢쬰 +8 DEF)
            const mutBonuses = getMutationBonuses();
            playerDefense += mutBonuses.defense;
            if (cs.playerDefending) playerDefense *= 2;
            
            const playerDamage = calculateDamage();
            const critChance = Math.round(calculateCritChance() * 100);
            const dodgeChance = Math.round(calculateDodgeChance() * 100);
            
            const countText = enemyGroup.length > 1 ? ` x${enemyGroup.length}` : '';
            
            // Get available items for combat
            const healItems = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
            const throwables = state.inv.filter(i => i.type === 'throwable');
            
            document.getElementById('modalContent').innerHTML = `
                <div style="background: linear-gradient(180deg, #1a0a0a 0%, #0a0a0a 100%); margin: -1rem; padding: 1rem; border-radius: 8px;">
                    
                    <!-- HEADER -->
                    <div style="text-align: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #333;">
                        <h2 style="margin: 0; color: #ff4444;">丘덢잺 ${t('combat', 'title')} - ${t('combat', 'round') || 'Kolo'} ${cs.turn}</h2>
                        ${cs.comboCount > 1 ? `<div style="color: #ffd700; font-size: 0.9rem;">游댠 Combo x${cs.comboCount}!</div>` : ''}
                    </div>
                    
                    <!-- COMBATANTS -->
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        
                        <!-- PLAYER -->
                        <div style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #4a7c4a;">
                            <div style="text-align: center; margin-bottom: 0.5rem;">
                                <div style="font-size: 2rem;">游븴</div>
                                <div style="font-weight: bold; color: #8bc34a;">${state.char.name || 'Ty'}</div>
                            </div>
                            
                            <!-- HP Bar -->
                            <div style="margin-bottom: 0.3rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>仇벒잺 HP</span>
                                    <span>${Math.round(state.char.hp)}/${state.char.maxHp}</span>
                                </div>
                                <div style="height: 8px; background: #1a0a0a; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${(state.char.hp/state.char.maxHp)*100}%; background: linear-gradient(90deg, #c62828, #f44336); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            <!-- Stamina Bar -->
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>丘 Stamina</span>
                                    <span>${cs.playerStamina}%</span>
                                </div>
                                <div style="height: 6px; background: #1a1a0a; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${cs.playerStamina}%; background: linear-gradient(90deg, #ff9800, #ffc107); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            <!-- STATUS EFEKTY -->
                            ${(() => {
                                let statusHtml = '';
                                if (state.char.stunned) statusHtml += '<span style="color: #ffeb3b;" title="Omr치캜en">游눪</span> ';
                                if (state.char.confused) statusHtml += `<span style="color: #9c27b0;" title="Zmaten칤 ${state.char.confused} kol">游댩${state.char.confused}</span> `;
                                if (state.char.bleeding && state.char.bleedRounds > 0) statusHtml += `<span style="color: #f44336;" title="Krv치cen칤 ${state.char.bleedRounds} kol">游뽖${state.char.bleedRounds}</span> `;
                                if (state.char.poisoned && state.char.poisonRounds > 0) statusHtml += `<span style="color: #9c27b0;" title="Otrava ${state.char.poisonRounds} kol">驕멆잺${state.char.poisonRounds}</span> `;
                                if (state.char.burning && state.char.burnRounds > 0) statusHtml += `<span style="color: #ff5722;" title="Ho콏en칤 ${state.char.burnRounds} kol">游댠${state.char.burnRounds}</span> `;
                                return statusHtml ? `<div style="font-size: 0.85rem; margin-bottom: 0.3rem;">${statusHtml}</div>` : '';
                            })()}
                            
                            <div style="font-size: 0.75rem; color: #888;">
                                <div>丘덢잺 ${playerDamage} DMG | 游띠勇 ${playerDefense} DEF</div>
                                <div>游눤 ${critChance}% krit | 游눧 ${dodgeChance}% 칰hyb</div>
                                ${(() => {
                                    const weapon = state.equipped?.weapon;
                                    if (weapon?.ammoType) {
                                        const ammoCount = getAmmoCount(weapon.ammoType);
                                        const ammoColor = ammoCount > 10 ? '#8bc34a' : ammoCount > 3 ? '#ff9800' : '#f44336';
                                        return `<div style="color: ${ammoColor};">游댲 ${getAmmoName(weapon.ammoType)}: ${ammoCount}</div>`;
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                        
                        <!-- VS -->
                        <div style="display: flex; align-items: center; font-size: 1.5rem; color: #666;">丘덢잺</div>
                        
                        <!-- ENEMIES -->
                        <div onclick="showEnemyInfo('${enemyData.id}')" style="background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #7c4a4a; cursor: pointer;" title="Klikni pro info">
                            <div style="text-align: center; margin-bottom: 0.5rem;">
                                <div style="font-size: 2rem;">${enemyData.icon}</div>
                                <div style="font-weight: bold; color: #ff6666;">${enemyData.name}${countText} <span style="font-size: 0.7rem; color: #666;">좶잺</span></div>
                            </div>
                            
                            <!-- Enemy HP Bars -->
                            ${enemyGroup.map((e, i) => `
                                <div class="enemyRow" data-index="${i}" style="margin-bottom: 0.3rem; opacity: ${e.alive ? 1 : 0.3};">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                        <span class="enemyStatus">${e.alive ? '仇벒잺' : '游'} #${i+1}</span>
                                        <span><span class="enemyHp">${Math.max(0, e.hp)}</span>/${e.maxHp}</span>
                                    </div>
                                    <div style="height: 6px; background: #0a0a0a; border-radius: 3px; overflow: hidden;">
                                        <div class="enemyHpBar" style="height: 100%; width: ${Math.max(0, (e.hp/e.maxHp)*100)}%; background: ${e.alive ? '#c62828' : '#333'}; transition: width 0.3s;"></div>
                                    </div>
                                    ${e.stunned ? '<span style="font-size: 0.6rem; color: #ffeb3b;">游눪 Omr치캜en</span>' : ''}
                                    ${e.poisoned > 0 ? '<span style="font-size: 0.6rem; color: #9c27b0;">驕멆잺 Otr치ven</span>' : ''}
                                    ${e.bleeding > 0 ? '<span style="font-size: 0.6rem; color: #f44336;">游뽖 Krv치c칤</span>' : ''}
                                </div>
                            `).join('')}
                            
                            <div style="font-size: 0.75rem; color: #888; margin-top: 0.5rem;">
                                丘덢잺 ${enemyData.damage} DMG | 游띠勇 ${enemyData.defense} DEF
                            </div>
                        </div>
                    </div>
                    
                    <!-- COMBAT LOG -->
                    <div id="combatLog" style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem; font-family: monospace; font-size: 0.8rem; border: 1px solid #333;">
                        ${logContent}
                    </div>
                    
                    <!-- ACTION BUTTONS -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="combatAction('attack')" style="background: linear-gradient(135deg, #8B0000 0%, #5a0000 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">丘덢잺</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">칔tok</span>
                            <span style="font-size: 0.65rem; color: #ffa;">-20 stamina</span>
                        </button>
                        
                        <button class="btn" onclick="combatAction('heavy')" ${cs.playerStamina < 40 ? 'disabled style="opacity: 0.5;"' : ''} style="background: linear-gradient(135deg, #6a0000 0%, #3a0000 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">游눤</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">Siln칳 칰tok</span>
                            <span style="font-size: 0.65rem; color: #ffa;">-40 stamina, 2x DMG</span>
                        </button>
                        
                        <button class="btn" onclick="combatAction('defend')" style="background: linear-gradient(135deg, #1a4a1a 0%, #0a2a0a 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">游띠勇</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">${currentLang === "en" ? "Defense" : "Obrana"}</span>
                            <span style="font-size: 0.65rem; color: #8f8;">+20 stamina, 2x DEF</span>
                        </button>
                        
                        <button class="btn" onclick="combatAction('dodge')" ${cs.playerStamina < 30 ? 'disabled style="opacity: 0.5;"' : ''} style="background: linear-gradient(135deg, #1a1a4a 0%, #0a0a2a 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">游눧</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">칔hyb</span>
                            <span style="font-size: 0.65rem; color: #88f;">-30 stamina, vyhni se</span>
                        </button>
                    </div>
                    
                    <!-- SPECIAL ACTIONS -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                        <button class="btn" onclick="showCombatItems('heal')" style="background: #2a2a2a; padding: 0.6rem; font-size: 0.8rem;" ${healItems.length === 0 ? 'disabled' : ''}>
                            游눍 L칠캜it (${healItems.reduce((sum, i) => sum + (i.count || 1), 0)})
                        </button>
                        
                        <button class="btn" onclick="showCombatItems('throw')" style="background: #2a2a2a; padding: 0.6rem; font-size: 0.8rem;" ${throwables.length === 0 ? 'disabled' : ''}>
                            游눢 Hodit (${throwables.reduce((sum, i) => sum + (i.count || 1), 0)})
                        </button>
                        
                        <button class="btn" onclick="combatAction('flee')" style="background: #444; padding: 0.6rem; font-size: 0.8rem;">
                            游끢 Ut칠ct
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Zobraz칤 info o nep콏칤teli b캩hem boje
        function showEnemyInfo(enemyId) {
            const enemy = Object.values(ENEMIES).flat().find(e => e.id === enemyId);
            if (!enemy) return;
            
            const cs = window.combatState;
            const aliveCount = cs ? cs.enemyGroup.filter(e => e.alive).length : 0;
            const totalCount = cs ? cs.enemyGroup.length : 1;
            
            let html = `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${enemy.icon}</div>
                    <h2 style="margin: 0; color: #ff6666;">${enemy.name}</h2>
                    ${enemy.boss ? '<div style="color: #ffd700; font-size: 0.9rem;">救 BOSS</div>' : ''}
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>仇벒잺 HP: <span style="color: #ff6666;">${enemy.hp}</span></div>
                            <div>丘덢잺 칔tok: <span style="color: #ff9800;">${enemy.damage}</span></div>
                            <div>游띠勇 Obrana: <span style="color: #2196f3;">${enemy.defense}</span></div>
                            <div>救 XP: <span style="color: #ffd700;">${enemy.xp}</span></div>
                        </div>
                    </div>
                    
                    ${enemy.abilities ? `
                        <div style="background: #2a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; text-align: left;">
                            <div style="color: #9c27b0; font-weight: bold; margin-bottom: 0.3rem;">丘 Schopnosti:</div>
                            <div style="color: #888; font-size: 0.85rem;">${enemy.abilities.join(', ')}</div>
                        </div>
                    ` : ''}
                    
                    ${enemy.loot ? `
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; text-align: left;">
                            <div style="color: #4caf50; font-weight: bold; margin-bottom: 0.3rem;">游꾸 Mo쬹치 ko콏ist:</div>
                            <div style="color: #888; font-size: 0.85rem;">${enemy.loot.slice(0, 5).join(', ')}${enemy.loot.length > 5 ? '...' : ''}</div>
                        </div>
                    ` : ''}
                    
                    ${cs ? `
                        <div style="margin-top: 1rem; color: #666; font-size: 0.85rem;">
                            Zb칳v치: ${aliveCount}/${totalCount}
                        </div>
                    ` : ''}
                </div>
            `;
            
            showModal(`游닀 ${enemy.name}`, html);
        }
        
        function combatAction(action) {
            const cs = window.combatState;
            if (!cs) return; // Combat u skon캜il
            
            const log = document.getElementById('combatLog');
            const enemyGroup = cs.enemyGroup;
            if (!enemyGroup) return; // 콯치dn칤 nep콏치tel칠
            
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            
            if (aliveEnemies.length === 0) return;
            
            cs.turn++;
            let playerActed = true;
            let skipEnemyTurn = false;
            
            // Reset defending
            const wasDefending = cs.playerDefending;
            cs.playerDefending = false;
            
            // === PLAYER ACTION ===
            switch(action) {
                case 'attack':
                    if (cs.playerStamina < 20) {
                        log.innerHTML += `<div style="color: #ff9800;">丘멆잺 ${'Nedostatek staminy pro 칰tok!'}</div>`;
                        playerActed = false;
                        break;
                    }
                    cs.playerStamina = Math.max(0, cs.playerStamina - 20);
                    performAttack(1.0, false);
                    break;
                    
                case 'heavy':
                    if (cs.playerStamina < 40) {
                        log.innerHTML += `<div style="color: #ff9800;">丘멆잺 ${'Nedostatek staminy pro siln칳 칰tok!'}</div>`;
                        playerActed = false;
                        break;
                    }
                    cs.playerStamina = Math.max(0, cs.playerStamina - 40);
                    performAttack(2.0, true);
                    break;
                    
                case 'defend':
                    cs.playerDefending = true;
                    cs.playerStamina = Math.min(100, cs.playerStamina + 20);
                    log.innerHTML += `<div style="color: #4caf50;">游띠勇 ${'Zauj칤m치코 obrann칳 postoj!'} (+20 stamina, 2x obrana)</div>`;
                    cs.comboCount = 0;
                    break;
                    
                case 'dodge':
                    if (cs.playerStamina < 30) {
                        log.innerHTML += `<div style="color: #ff9800;">丘멆잺 ${'Nedostatek staminy pro 칰hyb!'}</div>`;
                        playerActed = false;
                        break;
                    }
                    cs.playerStamina = Math.max(0, cs.playerStamina - 30);
                    skipEnemyTurn = true;
                    log.innerHTML += `<div style="color: #2196f3;">游눧 ${'Vyh칳b치코 se 칰tok콢m tento tah!'}</div>`;
                    cs.comboCount = 0;
                    break;
                    
                case 'flee':
                    let fleeChanceOld = 0.4 + (state.char.attrs.agi - 5) * 0.05;
                    // P콏idej escape bonus z vybaven칤
                    const fleeArmorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : {};
                    if (fleeArmorEffects.escapeBonus) {
                        fleeChanceOld += fleeArmorEffects.escapeBonus;
                    }
                    fleeChanceOld = Math.min(0.9, fleeChanceOld); // Max 90%
                    
                    if (Math.random() < fleeChanceOld) {
                        log.innerHTML += `<div style="color: #ff9800;">游끢 칔sp캩코n캩 jsi utekl! (${Math.round(fleeChanceOld * 100)}% 코ance)</div>`;
                        addLog('游끢 칔t캩k z boje 칰sp캩코n칳!', '游끢');
                        setTimeout(() => {
                            closeModal();
                            renderFull();
                        }, 1000);
                        return;
                    } else {
                        log.innerHTML += `<div style="color: #c62828;">游끢 칔t캩k se nezda콏il! (${Math.round(fleeChanceOld * 100)}% 코ance)</div>`;
                    }
                    cs.comboCount = 0;
                    break;
            }
            
            // Check victory
            const stillAlive = enemyGroup.filter(e => e.alive);
            if (stillAlive.length === 0) {
                handleCombatVictory();
                return;
            }
            
            // === COMPANION ATTACKS ===
            if (playerActed && state.companions && state.companions.length > 0) {
                const aliveCompanions = state.companions.filter(c => !c.isDead && (c.hp === undefined || c.hp > 0));
                aliveCompanions.forEach(comp => {
                    const aliveEnemiesNow = enemyGroup.filter(e => e.alive);
                    if (aliveEnemiesNow.length === 0) return;
                    
                    // Najdi c칤l (n치hodn칳 쬴v칳 nep콏칤tel)
                    const target = aliveEnemiesNow[Math.floor(Math.random() * aliveEnemiesNow.length)];
                    
                    // Vypo캜칤tej damage spole캜n칤ka - pou쬴j getCompanionStat pro spr치vn칳 v칳po캜et
                    const baseDamage = getCompanionStat(comp, 'damage');
                    const levelBonus = Math.floor(((comp.level || 1) - 1) * 2); // +2 damage za ka쬯칳 level
                    const totalDamage = Math.max(1, baseDamage + levelBonus - Math.floor(target.defense * 0.3));
                    
                    // Aplikuj damage
                    target.hp -= totalDamage;
                    
                    const compIcon = comp.icon || '游녻';
                    log.innerHTML += `<div style="color: #8bc34a;">游뱋 ${compIcon} ${escapeHtml(comp.name)} 칰to캜칤: -${totalDamage} HP</div>`;
                    
                    if (target.hp <= 0) {
                        target.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">游 ${escapeHtml(comp.name)} zabil nep콏칤tele!</div>`;
                    }
                });
                
                // Check victory po 칰toc칤ch spole캜n칤k콢
                const stillAliveAfterCompanions = enemyGroup.filter(e => e.alive);
                if (stillAliveAfterCompanions.length === 0) {
                    handleCombatVictory();
                    return;
                }
            }
            
            // === ENEMY TURN ===
            if (playerActed && !skipEnemyTurn) {
                enemyTurn();
            }
            
            // Check death
            if (state.char.hp <= 0) {
                handleCombatDefeat();
                return;
            }
            
            // Apply DOT effects on enemies
            enemyGroup.forEach((e, i) => {
                if (!e.alive) return;
                
                if (e.poisoned > 0) {
                    const poisonDmg = e.poisoned;
                    e.hp -= poisonDmg;
                    log.innerHTML += `<div style="color: #9c27b0;">驕멆잺 #${i+1} trp칤 jedem: -${poisonDmg} HP</div>`;
                    e.poisoned = Math.max(0, e.poisoned - 2);
                    if (e.hp <= 0) {
                        e.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">游 #${i+1} zem콏el na jed!</div>`;
                    }
                }
                
                if (e.bleeding > 0) {
                    const bleedDmg = e.bleeding;
                    e.hp -= bleedDmg;
                    log.innerHTML += `<div style="color: #f44336;">游뽖 #${i+1} krv치c칤: -${bleedDmg} HP</div>`;
                    e.bleeding = Math.max(0, e.bleeding - 1);
                    if (e.hp <= 0) {
                        e.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">游 #${i+1} vykrv치cel!</div>`;
                    }
                }
                
                // Krv치cen칤 ze setu (assassin set 2)
                if (e.bleedRounds && e.bleedRounds > 0 && e.bleedDamage) {
                    e.hp -= e.bleedDamage;
                    e.bleedRounds--;
                    log.innerHTML += `<div style="color: #c62828;">游뽖 #${i+1} krv치c칤 (set): -${e.bleedDamage} HP [${e.bleedRounds} kol]</div>`;
                    if (e.hp <= 0) {
                        e.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">游 #${i+1} vykrv치cel!</div>`;
                    }
                    if (e.bleedRounds <= 0) {
                        e.bleedDamage = 0;
                    }
                }
                
                if (e.stunned) {
                    e.stunned = false;
                }
                
                // Zpracov치n칤 zmaten칤 (Mind Control)
                if (e.confused && e.confused > 0) {
                    e.confused--;
                    if (e.confused <= 0) {
                        log.innerHTML += `<div style="color: #9c27b0;">游댩 #${i+1} se probral ze zmaten칤</div>`;
                    }
                }
            });
            
            // Check victory after DOT
            if (enemyGroup.filter(e => e.alive).length === 0) {
                handleCombatVictory();
                return;
            }
            
            // Regenerate stamina
            cs.playerStamina = Math.min(100, cs.playerStamina + 5);
            
            log.scrollTop = log.scrollHeight;
            
            // POUZE renderuj combat UI pokud boj st치le prob칤h치
            if (enemyGroup.some(e => e.alive)) {
                renderCombatUI();
            }
        }
        
        function performAttack(multiplier, isHeavy) {
            const cs = window.combatState;
            const log = document.getElementById('combatLog');
            const enemyGroup = cs.enemyGroup;
            
            // Check if AOE attack (from Berserker ability or throwables)
            const isAOE = state.combatBonuses?.aoeNextAttack === true;
            if (isAOE) {
                state.combatBonuses.aoeNextAttack = false; // Reset
            }
            
            // Find targets
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            if (aliveEnemies.length === 0) return;
            
            // AOE attack targets all enemies, normal attack targets first alive
            const targets = isAOE ? aliveEnemies : [aliveEnemies[0]];
            
            if (isAOE) {
                log.innerHTML += `<div style="color: #ff5722; font-weight: bold;">游댠 PLON칗 칔TOK! Zasa쬰no ${targets.length} nep콏치tel!</div>`;
                SoundSystem.play('critical');
            }
            
            // Check ammo for ranged weapons
            const weapon = state.equipped?.weapon;
            if (weapon?.ammoType) {
                const ammoNeeded = isHeavy ? 2 : 1; // Siln칳 칰tok spot콏ebuje 2 n치boje
                const currentAmmo = getAmmoCount(weapon.ammoType);
                
                if (currentAmmo < ammoNeeded) {
                    log.innerHTML += `<div style="color: #ff9800;">丘멆잺 Nem치코 dost n치boj콢 pro ${weapon.name}! (pot콏eba: ${ammoNeeded}, m치코: ${currentAmmo}) 칔to캜칤코 p캩stmi...</div>`;
                    // 칔tok p캩stmi - z치kladn칤 damage
                    if (aliveEnemies.length > 0) {
                        const fistDamage = Math.max(1, Math.floor(state.char.attrs.str * 0.5));
                        aliveEnemies[0].hp -= Math.max(1, fistDamage - aliveEnemies[0].defense);
                        log.innerHTML += `<div style="color: #888;">游녥 칔tok p캩st칤: ${fistDamage} DMG</div>`;
                    }
                    return;
                }
                
                // Spot콏ebuj munici
                consumeAmmo(weapon.ammoType, ammoNeeded);
                log.innerHTML += `<div style="color: #666; font-size: 0.8rem;">游댲 -${ammoNeeded} ${getAmmoName(weapon.ammoType)} (zb칳v치: ${currentAmmo - ammoNeeded})</div>`;
            }
            
            // Attack each target
            targets.forEach((target, idx) => {
                const targetIndex = enemyGroup.indexOf(target);
                
                // Skip stunned enemies can't defend
                const effectiveDefense = target.stunned ? 0 : target.defense;
                
                // Calculate damage (slightly reduced for AOE)
                let damage = Math.floor(calculateDamage() * multiplier * (isAOE && targets.length > 1 ? 0.7 : 1.0));
                
                // Combo bonus (only for single target)
                if (!isAOE) {
                    if (cs.lastAction === 'attack' || cs.lastAction === 'heavy') {
                        cs.comboCount++;
                        if (cs.comboCount > 1) {
                            const comboBonus = 1 + (cs.comboCount - 1) * 0.1;
                            damage = Math.floor(damage * comboBonus);
                        }
                    } else {
                        cs.comboCount = 1;
                    }
                }
                cs.lastAction = isHeavy ? 'heavy' : 'attack';
                
                // Critical hit
                const critChance = calculateCritChance();
                const isCrit = Math.random() < critChance;
                if (isCrit) {
                    damage = Math.floor(damage * 2);
                    if (idx === 0) { // Only show once
                        log.innerHTML += `<div style="color: #ffd700; font-weight: bold;">${'游눤 KRITICK칗 Z츼SAH!'}</div>`;
                        SoundSystem.play('critical');
                    }
                }
                
                // Apply defense
                damage = Math.max(1, damage - effectiveDefense);
                target.hp -= damage;
                
                // Heavy attack can stun (lower chance for AOE)
                if (isHeavy && Math.random() < (isAOE ? 0.15 : 0.3)) {
                    target.stunned = true;
                    log.innerHTML += `<div style="color: #ffeb3b;">游눪 #${targetIndex+1} omr치캜en!</div>`;
                }
                
                // Weapon special effects (only on first target for AOE)
                if (idx === 0 || !isAOE) {
                    if (weapon?.special === 'poison' && Math.random() < 0.3) {
                        target.poisoned = Math.max(target.poisoned, 5);
                        log.innerHTML += `<div style="color: #9c27b0;">驕멆잺 Jed pronik치 do r치ny!</div>`;
                    }
                    if (weapon?.special === 'bleed' && Math.random() < 0.25) {
                        target.bleeding = Math.max(target.bleeding, 3);
                        log.innerHTML += `<div style="color: #f44336;">游뽖 Zp콢sobil jsi krv치cen칤!</div>`;
                    }
                    if (weapon?.special === 'stun' && Math.random() < 0.2) {
                        target.stunned = true;
                        log.innerHTML += `<div style="color: #ffeb3b;">游눪 Elektrick칳 코ok omr치캜il nep콏칤tele!</div>`;
                    }
                }
                
                // Weapon coating effects (only first target)
                if (idx === 0 && state.weaponCoating && state.weaponCoating.uses > 0) {
                    state.weaponCoating.uses--;
                    if (state.weaponCoating.effect === 'poison') {
                        target.poisoned = Math.max(target.poisoned, 6);
                        log.innerHTML += `<div style="color: #9c27b0;">游빍 Jedov칳 povlak: Otr치veno! (zb칳v치 ${state.weaponCoating.uses} pou쬴t칤)</div>`;
                    } else if (state.weaponCoating.effect === 'fire') {
                        const fireDmg = 5;
                        target.hp -= fireDmg;
                        log.innerHTML += `<div style="color: #ff5722;">游댠 Z치paln치 pasta: +${fireDmg} DMG! (zb칳v치 ${state.weaponCoating.uses} pou쬴t칤)</div>`;
                    }
                    if (state.weaponCoating.uses <= 0) {
                        log.innerHTML += `<div style="color: #888;">游눧 Povlak na zbrani se spot콏eboval.</div>`;
                        state.weaponCoating = null;
                    }
                }
                
                log.innerHTML += `<div style="color: #8bc34a;">丘덢잺 ${isHeavy ? 'Siln칳 칰tok' : '칔tok'} na #${targetIndex+1}: ${damage} DMG${effectiveDefense > 0 ? ` (obrana -${effectiveDefense})` : ''}</div>`;
                
                // Check kill
                if (target.hp <= 0) {
                    target.alive = false;
                    log.innerHTML += `<div style="color: #ffd700;">游 Zabil jsi #${targetIndex+1}!</div>`;
                }
            });
            
            SoundSystem.play('combat_hit');
            
            // Mutant regenerace: +2 HP p콏i z치sahu
            if (state.char.class === 'mutant') {
                const healAmount = 2;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                log.innerHTML += `<div style="color: #76ff03;">游붍 Regenerace: +${healAmount} HP</div>`;
            }
            
            // Companion attacks
            if (state.companions && state.companions.length > 0) {
                state.companions.forEach(comp => {
                    if (comp.isDead) return;
                    const compInfo = COMPANIONS.find(c => c.id === comp.id);
                    if (!compInfo) return;
                    
                    // KONTROLA MUNICE - pokud m치 zbra켿 vy쬬duj칤c칤 munici, bere z invent치콏e HR츼캛E
                    if (comp.equipped?.weapon?.ammoType) {
                        const ammoType = comp.equipped.weapon.ammoType;
                        const playerAmmo = getAmmoCount(ammoType);
                        if (playerAmmo < 1) {
                            // Hr치캜 nem치 munici - spole캜n칤k nem콢쬰 칰to캜it
                            log.innerHTML += `<div style="color: #ff9800;">丘멆잺 ${comp.name || compInfo.name} nem치 munici (${getAmmoName(ammoType)})!</div>`;
                            return;
                        }
                        // Spot콏ebuj munici z invent치콏e hr치캜e
                        consumeAmmo(ammoType, 1);
                    }
                    
                    const aliveTarget = enemyGroup.find(e => e.alive);
                    if (!aliveTarget) return;
                    
                    // Pou쬴j getCompanionStat pro spr치vn칳 v칳po캜et v캜etn캩 levelu a vybaven칤
                    let compDmg = getCompanionStat(comp, 'damage') + Math.floor(Math.random() * 3);
                    compDmg = Math.max(1, compDmg - aliveTarget.defense);
                    aliveTarget.hp -= compDmg;
                    
                    const compIcon = comp.icon || compInfo.icon;
                    const compName = comp.name || compInfo.name;
                    log.innerHTML += `<div style="color: #ce93d8;">${compIcon} ${compName}: ${compDmg} DMG</div>`;
                    
                    if (aliveTarget.hp <= 0) {
                        aliveTarget.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">游 ${compName} zabil nep콏칤tele!</div>`;
                    }
                });
            }
            
            // Update enemy HP bars
            enemyGroup.forEach((e, i) => {
                const hpSpan = document.querySelectorAll('.enemyHp')[i];
                if (hpSpan) hpSpan.textContent = Math.max(0, e.hp);
                const hpBar = document.querySelectorAll('.enemyHpBar')[i];
                if (hpBar) {
                    hpBar.style.width = Math.max(0, (e.hp/e.maxHp)*100) + '%';
                    if (!e.alive) hpBar.style.background = '#333';
                }
                if (!e.alive) {
                    const enemyRow = document.querySelectorAll('.enemyRow')[i];
                    if (enemyRow) enemyRow.style.opacity = '0.3';
                }
            });
            
            // Check victory after attack
            const stillAlive = enemyGroup.filter(e => e.alive);
            if (stillAlive.length === 0) {
                // Volej okam쬴t캩 - combatAction() zkontroluje a ukon캜칤 se
                handleCombatVictory();
                return; // D콢le쬴t칠 - ukon캜i performAttack
            }
        }
        
        function enemyTurn() {
            const cs = window.combatState;
            if (!cs || !cs.enemyGroup) return; // Combat u skon캜il
            
            const log = document.getElementById('combatLog');
            const enemyGroup = cs.enemyGroup;
            
            // Zkontroluj zda jsou v콢bec 쬴v칤 nep콏치tel칠
            if (enemyGroup.filter(e => e.alive).length === 0) return;
            
            let totalDamage = 0;
            const aliveEnemies = enemyGroup.filter(e => e.alive && !e.stunned && !e.confused);
            
            // Zmaten칤 nep콏치tel칠 (Mind Control) - 칰to캜칤 na sv칠 spojence
            const confusedEnemies = enemyGroup.filter(e => e.alive && e.confused && e.confused > 0);
            confusedEnemies.forEach((enemy, i) => {
                const otherEnemies = enemyGroup.filter(e => e.alive && e.id !== enemy.id);
                if (otherEnemies.length > 0) {
                    const friendlyFireTarget = otherEnemies[Math.floor(Math.random() * otherEnemies.length)];
                    const dmg = Math.floor(enemy.damage * 0.5); // 50% damage p콏i zmaten칤
                    friendlyFireTarget.hp -= dmg;
                    log.innerHTML += `<div style="color: #9c27b0;">游댩 Zmaten칳 #${enemyGroup.indexOf(enemy)+1} 칰to캜칤 na spojence: ${dmg} DMG!</div>`;
                    if (friendlyFireTarget.hp <= 0) {
                        friendlyFireTarget.alive = false;
                        friendlyFireTarget.hp = 0;
                        log.innerHTML += `<div style="color: #ffd700;">游 Friendly fire! Nep콏칤tel zabit vlastn칤m spojencem!</div>`;
                    }
                } else {
                    log.innerHTML += `<div style="color: #9c27b0;">游댩 Zmaten칳 #${enemyGroup.indexOf(enemy)+1} je dezorientovan칳 a ne칰to캜칤</div>`;
                }
            });
            
            // Get equipped armor
            const playerArmor = state.equipped?.armor;
            
            // Z칤skej 쬴v칠 spole캜n칤ky pro mo쬹칳 칰tok nep콏치tel na n캩
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && (c.hp === undefined || c.hp > 0));
            
            aliveEnemies.forEach((enemy, i) => {
                // 30% 코ance 쬰 nep콏칤tel za칰to캜칤 na spole캜n칤ka m칤sto hr치캜e
                if (aliveCompanions.length > 0 && Math.random() < 0.3) {
                    const targetComp = aliveCompanions[Math.floor(Math.random() * aliveCompanions.length)];
                    let enemyDmg = enemy.damage + Math.floor(Math.random() * 5) - 2;
                    const compDef = targetComp.defense || 5;
                    enemyDmg = Math.max(1, enemyDmg - compDef);
                    
                    if (targetComp.hp === undefined) targetComp.hp = targetComp.maxHp || 80;
                    targetComp.hp -= enemyDmg;
                    
                    log.innerHTML += `<div style="color: #ff9800;">丘덢잺 Nep콏칤tel 칰to캜칤 na ${targetComp.icon || '游녻'} ${targetComp.name}: -${enemyDmg} HP</div>`;
                    
                    if (targetComp.hp <= 0) {
                        targetComp.isDead = true;
                        targetComp.hp = 0;
                        log.innerHTML += `<div style="color: #c62828;">游 ${targetComp.name} padl v boji!</div>`;
                        const idx = aliveCompanions.indexOf(targetComp);
                        if (idx > -1) aliveCompanions.splice(idx, 1);
                    }
                    return; // Tento nep콏칤tel u 칰to캜il
                }
                
                // Dodge chance
                const dodgeChance = calculateDodgeChance();
                if (Math.random() < dodgeChance) {
                    log.innerHTML += `<div style="color: #2196f3;">游눧 Vyhnul ses 칰toku od #${enemyGroup.indexOf(enemy)+1}!</div>`;
                    return;
                }
                
                // Calculate enemy damage
                let enemyDmg = enemy.damage + Math.floor(Math.random() * 5) - 2;
                
                // 游깿 No캜n칤 bonus pro nep콏치tele (+20% v noci)
                const dayPhase = getCurrentDayPhase();
                if (dayPhase.id === 'night') {
                    enemyDmg = Math.floor(enemyDmg * 1.2);
                } else if (dayPhase.id === 'dusk') {
                    enemyDmg = Math.floor(enemyDmg * 1.1); // +10% za soumraku
                }
                
                // 游꺊勇 Po캜as칤 efekty pro nep콏치tele - pou쬴j weather.effect.enemyDmgMod
                const weather = getCurrentWeather();
                if (weather?.effect?.enemyDmgMod) {
                    enemyDmg = Math.floor(enemyDmg * weather.effect.enemyDmgMod);
                }
                
                // Player defense - pou쬴j equipped armor
                let playerDef = Math.max(0, Math.floor((state.char.attrs.end - 5) * 1)); // END bonus
                if (playerArmor && playerArmor.defense) playerDef += playerArmor.defense;
                playerDef += getSkillTreeBonus('defense');
                if (cs.playerDefending) playerDef *= 2;
                
                // Accessory defense bonus
                if (state.equippedAccessory) {
                    const acc = state.inv.find(i => i.id === state.equippedAccessory);
                    if (acc?.bonus === 'defense') playerDef += acc.value || 0;
                }
                
                enemyDmg = Math.max(1, enemyDmg - playerDef);
                totalDamage += enemyDmg;
            });
            
            if (totalDamage > 0) {
                state.char.hp -= totalDamage;
                
                // Sleduj zdroj po코kozen칤 pro death screen
                const firstEnemy = cs.units?.find(u => u.team === 'enemy' && u.hp > 0);
                state.lastDamageSource = firstEnemy?.name || 'Nep콏칤tel';
                state.lastDamageAmount = totalDamage;
                
                log.innerHTML += `<div style="color: #f44336;">游눖 Nep콏치tel칠 칰to캜칤: -${totalDamage} HP${cs.playerDefending ? ' (obrana aktivn칤)' : ''}</div>`;
                SoundSystem.play('damage');
                
                // Degrade armor - 2 durability za kolo
                if (playerArmor && playerArmor.durability !== undefined) {
                    playerArmor.durability = Math.max(0, playerArmor.durability - 2);
                    if (playerArmor.durability === 0) {
                        log.innerHTML += `<div style="color: #c62828;">游눖 ${playerArmor.icon} ${playerArmor.name} se rozpadlo!</div>`;
                        state.equipped.armor = null;
                    } else if (playerArmor.durability <= 20) {
                        log.innerHTML += `<div style="color: #ff9800;">丘멆잺 Brn캩n칤: ${playerArmor.durability}/${playerArmor.maxDurability}</div>`;
                    }
                }
                
                // Degrade helmet - 1 durability za kolo
                const playerHelmet = state.equipped?.helmet;
                if (playerHelmet && playerHelmet.durability !== undefined) {
                    playerHelmet.durability = Math.max(0, playerHelmet.durability - 1);
                    if (playerHelmet.durability === 0) {
                        log.innerHTML += `<div style="color: #c62828;">游눖 ${playerHelmet.icon} ${playerHelmet.name} se rozpadla!</div>`;
                        state.equipped.helmet = null;
                    }
                }
                
                // Degrade boots - 1 durability za kolo
                const playerBoots = state.equipped?.boots;
                if (playerBoots && playerBoots.durability !== undefined) {
                    playerBoots.durability = Math.max(0, playerBoots.durability - 1);
                    if (playerBoots.durability === 0) {
                        log.innerHTML += `<div style="color: #c62828;">游눖 ${playerBoots.icon} ${playerBoots.name} se rozpadly!</div>`;
                        state.equipped.boots = null;
                    }
                }
            }
            
            // Stunned enemies message
            const stunnedCount = enemyGroup.filter(e => e.alive && e.stunned).length;
            if (stunnedCount > 0) {
                log.innerHTML += `<div style="color: #ffeb3b;">游눪 ${stunnedCount} nep콏칤tel omr치캜en - ne칰to캜칤</div>`;
            }
            
            // Confused enemies message
            const confusedCount = enemyGroup.filter(e => e.alive && e.confused && e.confused > 0).length;
            if (confusedCount > 0) {
                log.innerHTML += `<div style="color: #9c27b0;">游댩 ${confusedCount} nep콏칤tel zmaten칳 - 칰to캜칤 na spojence</div>`;
            }
        }
        
        function showCombatItems(type) {
            const cs = window.combatState;
            let items;
            let title;
            
            if (type === 'heal') {
                items = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
                title = '游눍 Pou쮂셦 l칠캜ivo';
            } else {
                items = state.inv.filter(i => i.type === 'throwable');
                title = '游눢 Hodit p콏edm캩t';
            }
            
            if (items.length === 0) return;
            
            let html = `<h3>${title}</h3><div style="display: grid; gap: 0.5rem; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
            items.forEach((item, idx) => {
                const count = item.count || 1;
                html += `
                    <button class="btn" onclick="useCombatItem('${item.id}', '${type}')" style="background: #2a2a2a; padding: 0.8rem; text-align: left; display: flex; align-items: center; gap: 0.8rem;">
                        <span style="font-size: 1.5rem;">${item.icon}</span>
                        <div>
                            <div style="font-weight: bold;">${item.name} x${count}</div>
                            <div style="font-size: 0.8rem; color: #888;">${type === 'heal' ? `+${item.value} HP` : `${item.damage || '?'} DMG`}</div>
                        </div>
                    </button>
                `;
            });
            html += '</div><button class="btn" onclick="renderCombatUI()" style="width: 100%; margin-top: 1rem; background: #555;">' + ('Zp캩t') + '</button>';
            
            document.getElementById('modalContent').innerHTML = html;
        }
        
        function useCombatItem(itemId, type) {
            const cs = window.combatState;
            const log = document.getElementById('combatLog');
            const item = state.inv.find(i => i.id === itemId);
            
            if (!item) return;
            
            if (type === 'heal') {
                const healAmount = item.value || 20;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                log.innerHTML += `<div style="color: #4caf50;">游눍 Pou쬴l jsi ${escapeHtml(item.name)}: +${healAmount} HP</div>`;
            } else {
                // Throwable - damage all enemies
                const damage = item.damage || 30;
                cs.enemyGroup.forEach((e, i) => {
                    if (!e.alive) return;
                    e.hp -= damage;
                    if (e.hp <= 0) {
                        e.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">游 ${item.icon} zabil #${i+1}!</div>`;
                    }
                });
                log.innerHTML += `<div style="color: #ff9800;">游눤 ${escapeHtml(item.name)}: ${damage} DMG v코em!</div>`;
                
                // Check victory
                if (cs.enemyGroup.filter(e => e.alive).length === 0) {
                    handleCombatVictory();
                    // Remove item
                    if (item.count > 1) item.count--;
                    else state.inv = state.inv.filter(i => i !== item);
                    return;
                }
            }
            
            // Remove item
            if (item.count > 1) item.count--;
            else state.inv = state.inv.filter(i => i !== item);
            
            // Enemy turn after using item
            enemyTurn();
            
            // Phoenix efekt - p콏e쬴t칤 smrti
            if (state.char.hp <= 0) {
                const armorEffects = getArmorSpecialEffects();
                if (armorEffects.phoenix && !window.phoenixUsed) {
                    state.char.hp = Math.floor(state.char.maxHp * 0.3);
                    window.phoenixUsed = true;
                    const log = document.getElementById('combat-log');
                    if (log) log.innerHTML += `<div style="color: #ff9800; font-weight: bold;">游댠 PHOENIX! Pl치코콘 F칠nixe t캩 zachr치nil! Obnoveno ${state.char.hp} HP!</div>`;
                    SoundSystem.play('victory');
                }
            }
            
            if (state.char.hp <= 0) {
                handleCombatDefeat();
                return;
            }
            
            cs.turn++;
            renderCombatUI();
        }
        
        function handleCombatVictory() {
            const cs = window.combatState;
            
            console.log('游끥 handleCombatVictory - combatType:', cs?.combatType, 'isDungeon:', cs?.isDungeon);
            
            // Zvuk v칤t캩zstv칤
            if (typeof playCombatSound === 'function') playCombatSound('victory');
            
            // === VY캛IT캨N칈 DOT EFEKT콡 PO BOJI ===
            // Krv치cen칤, otrava a ho콏en칤 se po boji zm칤rn칤/zastav칤
            if (state.char.bleeding) {
                state.char.bleeding = Math.floor(state.char.bleeding / 2); // Zm칤rn캩n칤
                state.char.bleedRounds = Math.max(0, (state.char.bleedRounds || 0) - 1);
            }
            if (state.char.poisoned) {
                // Jed z콢st치v치, ale m콢쬰코 ho vyl칠캜it
                addLog('驕멆잺 St치le jsi otr치ven칳! Pou쬴j protijed.', '丘멆잺');
            }
            if (state.char.burning) {
                state.char.burning = 0; // Ohe켿 uhasne
                state.char.burnRounds = 0;
            }
            // Stun a zmaten칤 se resetuj칤
            state.char.stunned = false;
            state.char.stunnedRounds = 0;
            state.char.confused = 0;
            
            // Reset ambush pro dal코칤 boj
            window.ambushUsed = false;
            
            // === TERRITORY GUARD COMBAT ===
            // Pokud to byl boj se str치쬮i 칰zem칤, zpracuj ho zvl치코콘
            if (cs.combatType === 'territory_guard' && window.territoryBattle) {
                onTerritoryBattleEnd(true);
                window.combatState = null;
                renderFull();
                return;
            }
            
            // Podpora pro star칳 i nov칳 syst칠m
            const enemyUnits = cs.units ? cs.units.filter(u => u.team === 'enemy') : cs.enemyGroup;
            
            // Debug
            console.log('游끥 handleCombatVictory started');
            console.log('游끥 combatState:', cs);
            console.log('游끥 enemyUnits:', enemyUnits);
            
            // O코et콏en칤 pro pr치zdn칠 enemyUnits
            if (!enemyUnits || enemyUnits.length === 0) {
                console.error('游끥 ERROR: No enemy units found!');
                closeModal();
                renderFull();
                notifySuccess('游끥 V칤t캩zstv칤!', 'Porazil jsi v코echny nep콏치tele!');
                window.combatState = null;
                return;
            }
            
            const enemyData = enemyUnits[0];
            const enemyCount = enemyUnits.length;
            
            state.stats.kills = (state.stats.kills || 0) + enemyCount;
            
            // === ACHIEVEMENT TRACKING ===
            // Boss kills
            const isBossEnemy = enemyData.isBoss || enemyData.boss || enemyData.id?.includes('boss') || enemyData.name?.includes('Boss');
            if (isBossEnemy) {
                state.stats.bossKills = (state.stats.bossKills || 0) + 1;
                
                // === ㅁNCE NA SET ITEM Z BOSSE ===
                // 8% 코ance na drop n치hodn칠ho d칤lu setu
                if (Math.random() < 0.08 && typeof CLASS_SETS !== 'undefined') {
                    // Vyber n치hodn칠 povol치n칤
                    const allClasses = Object.keys(CLASS_SETS);
                    const randomClass = allClasses[Math.floor(Math.random() * allClasses.length)];
                    const setData = CLASS_SETS[randomClass];
                    
                    // Vyber n치hodn칳 d칤l setu
                    const pieceKeys = Object.keys(setData.pieces);
                    const randomPieceKey = pieceKeys[Math.floor(Math.random() * pieceKeys.length)];
                    const piece = setData.pieces[randomPieceKey];
                    
                    // P콏idej do invent치콏e
                    const setItem = ITEMS.find(i => i.id === piece.id);
                    if (setItem) {
                        const itemCopy = { ...setItem };
                        state.inv.push(itemCopy);
                        
                        const className = CLASSES[randomClass]?.name || randomClass;
                        addLog(`游끥 Boss dropnul ${piece.icon} ${piece.name} (Set ${className})!`, '救');
                        notifySuccess('Legend치rn칤 drop!', `${piece.icon} ${piece.name} - Set pro ${className}!`);
                    }
                }
            }
            
            // Flawless win (bez zran캩n칤)
            const playerUnit = cs.units ? cs.units.find(u => u.team === 'player') : null;
            const startHp = cs.startPlayerHp || state.char.maxHp;
            const currentHp = playerUnit ? playerUnit.hp : state.char.hp;
            if (currentHp >= startHp) {
                state.stats.flawlessWins = (state.stats.flawlessWins || 0) + 1;
            }
            
            // Pacifist tracking - reset p콏i zabit칤
            state.stats.lastKillDay = state.time.days;
            
            // === KONTROLA NEMOCI PO BOJI ===
            // 마nce na infekci pokud byl hr치캜 zran캩n
            if (typeof checkCombatDisease === 'function') {
                checkCombatDisease();
            }
            
            // === KONTROLA ZRAN캨N칈 PO BOJI ===
            // 마nce na zran캩n칤 podle obdr쬰n칠ho damage a typu zbran캩 nep콏칤tele
            if (typeof checkCombatInjury === 'function') {
                const playerUnit = cs.units ? cs.units.find(u => u.team === 'player') : null;
                const startHp = cs.startPlayerHp || state.char.maxHp;
                const currentHp = playerUnit ? playerUnit.hp : state.char.hp;
                const damageReceived = Math.max(0, startHp - currentHp);
                
                if (damageReceived > 0) {
                    const enemyType = enemyData.id || enemyData.name?.toLowerCase() || '';
                    // Z칤skej zbra켿 nep콏칤tele pokud existuje
                    const enemyWeapon = enemyData.weapon || enemyData.weaponName || 
                                       (enemyData.attack?.includes('me캜') ? 'me캜' : 
                                        enemyData.attack?.includes('p치lk') ? 'p치lka' :
                                        enemyData.attack?.includes('pistol') ? 'pistole' :
                                        enemyData.attack?.includes('dr치p') ? 'dr치py' :
                                        enemyData.attack?.includes('tes치k') ? 'tes치ky' : '');
                    checkCombatInjury(damageReceived, enemyType, enemyWeapon);
                }
            }
            
            // Update timed quest objectives - combat victory
            checkTimedQuestObjectives('combat_victory', state.world.currentLocation);
            checkCompanionQuestObjectives('combat_victory', state.world.currentLocation);
            
            // Track kills by enemy type for bounties
            if (!state.stats.killsByType) state.stats.killsByType = {};
            const enemyType = enemyData.id || enemyData.name?.toLowerCase().replace(/\s+/g, '_');
            state.stats.killsByType[enemyType] = (state.stats.killsByType[enemyType] || 0) + enemyCount;
            
            // Track general categories too
            if (enemyData.id?.includes('wolf') || enemyData.name?.includes('Vlk')) {
                state.stats.killsByType['wolf'] = (state.stats.killsByType['wolf'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('mutant') || enemyData.name?.includes('utant')) {
                state.stats.killsByType['mutant'] = (state.stats.killsByType['mutant'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('raider') || enemyData.name?.includes('치jezd')) {
                state.stats.killsByType['raider'] = (state.stats.killsByType['raider'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('ghoul') || enemyData.name?.includes('h칰l')) {
                state.stats.killsByType['ghoul'] = (state.stats.killsByType['ghoul'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('robot') || enemyData.name?.includes('obot')) {
                state.stats.killsByType['robot'] = (state.stats.killsByType['robot'] || 0) + enemyCount;
            }
            
            // Update NPC quest progress (kills)
            if (state.npcQuests) {
                Object.keys(state.npcQuests).forEach(npcId => {
                    const quest = state.npcQuests[npcId];
                    if (quest && quest.id) {
                        if (!quest.progress) quest.progress = { kills: 0, explored: 0, escortLocations: 0, alphaKilled: false };
                        const questDef = NPC_QUESTS[quest.id];
                        
                        // Kills requirement
                        if (questDef?.requirement?.kills) {
                            quest.progress.kills = (quest.progress.kills || 0) + enemyCount;
                            console.log(`游 Kills progress pro ${quest.id}: ${quest.progress.kills}/${questDef.requirement.kills}`);
                        }
                        
                        // Kill Alpha requirement - detekce alfa pred치tor콢
                        if (questDef?.requirement?.killAlpha && !quest.progress.alphaKilled) {
                            const isAlpha = enemyData.id?.includes('alpha') || 
                                           enemyData.name?.toLowerCase().includes('alfa') ||
                                           enemyData.isBoss || 
                                           enemyData.tier >= 4;
                            if (isAlpha) {
                                quest.progress.alphaKilled = true;
                                console.log(`游냨 Alpha killed! Quest ${quest.id} spln캩n`);
                                notifySuccess('Alfa zabit!', `Zabil jsi ${enemyData.name}! Vra콘 se pro odm캩nu.`);
                            }
                        }
                    }
                });
            }
            
            // Debug
            console.log('游끥 handleCombatVictory - enemyData:', enemyData);
            console.log('游끥 enemyUnits:', enemyUnits);
            
            // === V츼LE캛N츼 Z칍NA - speci치ln칤 re쬴m ===
            if (state.warZoneFight?.active) {
                const warFight = state.warZoneFight;
                state.warZoneFight = null;
                window.combatState = null;
                
                // Obnov p콢vodn칤 HP (p콏ed bojem)
                state.char.hp = warFight.savedHp || state.char.hp;
                
                const factionData = PVP_FACTIONS[warFight.faction];
                
                // P콏idej body a nastav cooldown
                if (multiplayerEnabled && firebaseDB) {
                    const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                    
                    // Nastav cooldown
                    firebaseDB.ref('warZone/cooldowns/' + myName).set(Date.now()).catch(e => {});
                    
                    // P콏idej body frakci (do war zone)
                    firebaseDB.ref('warZone/factionPoints/' + warFight.faction).transaction(current => (current || 0) + warFight.pointsPerWin).catch(e => {});
                    
                    // P콏idej body i hr치캜ovi do 쬰b콏칤캜ku - spolehliv캩j코칤 metoda
                    const contribRef = firebaseDB.ref('factionMembers/' + myName + '/contribution');
                    contribRef.once('value').then(snap => {
                        const current = snap.val() || 0;
                        contribRef.set(current + warFight.pointsPerWin).catch(e => console.error('Contrib error:', e));
                        console.log('游낎 War zone contribution: ' + current + ' -> ' + (current + warFight.pointsPerWin));
                    }).catch(e => console.error('Contrib read error:', e));
                    
                    state.pvpFactionContribution = (state.pvpFactionContribution || 0) + warFight.pointsPerWin;
                }
                
                showModal('游끥 V칤t캩zstv칤!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">丘덢잺</div>
                        <h3 style="color: #4caf50;">Porazil jsi nep콏치tele!</h3>
                        <div style="background: ${factionData?.color || '#666'}22; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${factionData?.color || '#666'};">
                            <p style="color: ${factionData?.color || '#fff'}; font-size: 1.5rem; margin: 0;">
                                +${warFight.pointsPerWin} bod콢
                            </p>
                            <p style="color: #888; margin: 0.5rem 0 0 0;">pro ${factionData?.icon || '?'} ${factionData?.name || 'tvou frakci'}</p>
                        </div>
                        <p style="color: #ff9800; font-size: 0.9rem;">낍 Dal코칤 boj za 10 minut</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        V칳born캩!
                    </button>
                `);
                return;
            }
            
            let xpGain = (enemyData?.xp || 25) * enemyCount;
            
            // Tracking (Hunter set 2) - +50% XP z lovu zv칤콏at
            const setEffectsXP = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            if (setEffectsXP.tracking) {
                const isAnimal = enemyData.id?.includes('wolf') || enemyData.id?.includes('rat') || 
                                enemyData.id?.includes('dog') || enemyData.id?.includes('cat') ||
                                enemyData.id?.includes('bear') || enemyData.id?.includes('spider') ||
                                enemyData.id?.includes('frog') || enemyData.id?.includes('fish') ||
                                enemyData.name?.includes('Vlk') || enemyData.name?.includes('Krysa') ||
                                enemyData.name?.includes('Pes') || enemyData.name?.includes('Pavouk');
                if (isAnimal) {
                    const bonusXP = Math.floor(xpGain * 0.5);
                    xpGain += bonusXP;
                    addLog(`游꿢 Tracking: +${bonusXP} XP bonus z lovu!`, '救');
                }
            }
            
            console.log('游끥 xpGain:', xpGain);
            addXP(xpGain);
            
            // Companion XP - spole캜n칤ci z칤sk치vaj칤 50% XP z boje
            addCompanionXP(Math.floor(xpGain * 0.5));
            
            // Faction reputation
            if (enemyData.faction) {
                changeReputation(enemyData.faction, -5 * enemyCount, 'zabit칤 ' + enemyData.name);
                if (enemyData.faction === 'raiders') {
                    changeReputation('traders', 2 * enemyCount, 'ochrana obchodn칤k콢');
                    changeReputation('military', 1 * enemyCount, 'eliminace hrozby');
                }
                if (enemyData.faction === 'mutants') {
                    changeReputation('military', 2 * enemyCount, '캜i코t캩n칤 pustiny');
                }
            }
            
            // Daily quest progress
            if (state.dailyQuests.progress) {
                state.dailyQuests.progress.kills = (state.dailyQuests.progress.kills || 0) + enemyCount;
            }
            checkDailyQuests();
            
            // Collect loot
            let lootHtml = '';
            let totalMoney = 0;
            
            // SET BONUSY PRO LOOT
            const setEffectsLoot = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            const rareFindBonus = setEffectsLoot.rareFind || 0; // +10% 코ance na rare/epic
            const luckyFindChance = setEffectsLoot.luckyFindImproved ? 0.30 : (state.char.classId === 'scavenger' ? 0.15 : 0);
            
            // Helper pro generov치n칤 jednoho lootu
            function generateSingleLoot(lootArray) {
                // 50% 코ance 쬰 item v콢bec nepadne (sn칤쬰n칤 lootu)
                // Lucky Find: 코ance na dvojit칳 loot
                if (Math.random() < luckyFindChance) {
                    lootHtml += `<div style="color: #ffd700;">游 Lucky Find! Dvojit칳 loot!</div>`;
                    // Generuj dvakr치t
                    generateSingleLootInternal(lootArray);
                    generateSingleLootInternal(lootArray);
                    return;
                }
                generateSingleLootInternal(lootArray);
            }
            
            function generateSingleLootInternal(lootArray) {
                if (Math.random() < 0.5) {
                    return; // Nic nepadne
                }
                
                let lootId = lootArray[Math.floor(Math.random() * lootArray.length)];
                
                // RARE FIND BONUS - 코ance na upgrade rarity
                if (rareFindBonus > 0 && Math.random() < rareFindBonus) {
                    // Upgrade common -> rare, rare -> epic
                    if (lootId === 'food' || lootId === 'cloth' || lootId === 'metal') {
                        lootId = 'rare_item';
                        lootHtml += `<div style="color: #9c27b0;">九 Rare Find! Lep코칤 loot!</div>`;
                    }
                }
                
                // Legendary m치 jen 8% 코anci dropnout (i kdy je v loot poli)
                if (lootId === 'legendary' || lootId === 'legendary_weapon' || lootId === 'legendary_armor' || lootId === 'legendary_item') {
                    if (Math.random() > 0.08) {
                        // 92% 코ance 쬰 legendary NEpadne - m칤sto toho d치 rare nebo nic
                        if (Math.random() < 0.25) {
                            // 25% 코ance na rare jako n치hradu
                            const rareItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic');
                            if (rareItems.length > 0) {
                                const rareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                                if (canAddItem(rareItem, 1)) {
                                    addItemToInventory(rareItem, 1, true);
                                    lootHtml += `<div style="color: #9c27b0;">游꾸 ${rareItem.icon} ${rareItem.name}</div>`;
                                }
                            }
                        }
                        return; // Legendary nepadne
                    }
                }
                
                // Unique m치 jen 5% 코anci dropnout
                if (lootId === 'unique' || lootId === 'unique_artifact') {
                    if (Math.random() > 0.05) {
                        // 95% 코ance 쬰 unique NEpadne - m칤sto toho d치 rare nebo nic
                        if (Math.random() < 0.20) {
                            // 20% 코ance na rare jako n치hradu
                            const rareItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic');
                            if (rareItems.length > 0) {
                                const rareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                                if (canAddItem(rareItem, 1)) {
                                    addItemToInventory(rareItem, 1, true);
                                    lootHtml += `<div style="color: #9c27b0;">游꾸 ${rareItem.icon} ${rareItem.name}</div>`;
                                }
                            }
                        }
                        return; // Unique nepadne
                    }
                }
                
                if (lootId === 'money') {
                    const moneyGain = Math.floor(Math.random() * 75) + 30;
                    totalMoney += moneyGain;
                    return;
                }
                
                // Zkus naj칤t item p콏칤mo nebo z kategorie
                let lootItem = ITEMS.find(i => i.id === lootId);
                
                // Pokud nen칤 p콏칤m칳 item, zkus kategorie
                if (!lootItem) {
                    const categoryItems = {
                        'weapon': ITEMS.filter(i => i.type === 'weapon' && i.rarity !== 'legendary'),
                        'rare_weapon': ITEMS.filter(i => i.type === 'weapon' && (i.rarity === 'rare' || i.rarity === 'epic')),
                        'legendary_weapon': ITEMS.filter(i => i.type === 'weapon' && i.rarity === 'legendary'),
                        'armor': ITEMS.filter(i => i.type === 'armor' && i.rarity !== 'legendary'),
                        'rare_armor': ITEMS.filter(i => i.type === 'armor' && (i.rarity === 'rare' || i.rarity === 'epic')),
                        'legendary_armor': ITEMS.filter(i => i.type === 'armor' && i.rarity === 'legendary'),
                        'legendary': ITEMS.filter(i => i.rarity === 'legendary'),
                        'legendary_item': ITEMS.filter(i => i.rarity === 'legendary'),
                        'rare': ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic'),
                        'rare_item': ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic'),
                        'ammo': ITEMS.filter(i => i.type === 'ammo'),
                        'medkit': ITEMS.filter(i => i.id === 'medkit' || i.id === 'first_aid'),
                        'food': ITEMS.filter(i => i.type === 'food' || i.effect === 'hunger'),
                        'radaway': ITEMS.filter(i => i.id === 'radx'),
                        'radx': ITEMS.filter(i => i.id === 'radx'),
                        'tech': ITEMS.filter(i => i.type === 'tool'),
                        'unique': ITEMS.filter(i => i.rarity === 'legendary'),
                        'stimpak': ITEMS.filter(i => i.id === 'stimpak' || i.id === 'medkit')
                    };
                    
                    const categoryList = categoryItems[lootId];
                    if (categoryList && categoryList.length > 0) {
                        lootItem = categoryList[Math.floor(Math.random() * categoryList.length)];
                    }
                }
                
                if (lootItem) {
                    if (lootItem.type === 'resource') {
                        state.resources[lootItem.id] = (state.resources[lootItem.id] || 0) + 1;
                        const icon = RESOURCE_ICONS[lootItem.id] || lootItem.icon || '游닍';
                        const name = RESOURCE_NAMES[lootItem.id] || lootItem.name || lootItem.id;
                        lootHtml += `<div style="color: #ffd700;">游꾸 ${icon} ${name}</div>`;
                    } else if (lootItem.type === 'ammo') {
                        // Munice pad치 v mno쬽tv칤 3-6
                        const ammoCount = 3 + Math.floor(Math.random() * 4);
                        if (canAddItem(lootItem, ammoCount)) {
                            addItemToInventory(lootItem, ammoCount, true);
                            lootHtml += `<div style="color: #ffd700;">游꾸 ${lootItem.icon} ${lootItem.name} x${ammoCount}</div>`;
                        } else {
                            // Ulo na zem
                            addToGroundLoot({...lootItem, count: ammoCount});
                            lootHtml += `<div style="color: #ff9800;">游닍 ${lootItem.icon} ${lootItem.name} x${ammoCount} (na zemi)</div>`;
                        }
                    } else if (canAddItem(lootItem, 1)) {
                        addItemToInventory(lootItem, 1, true);
                        lootHtml += `<div style="color: #ffd700;">游꾸 ${lootItem.icon} ${lootItem.name}</div>`;
                    } else {
                        // Ulo na zem m칤sto zahozen칤
                        addToGroundLoot({...lootItem});
                        lootHtml += `<div style="color: #ff9800;">游닍 ${lootItem.icon} ${lootItem.name} (na zemi)</div>`;
                    }
                } else {
                    // Fallback - p콏idej jako resource s 캜esk칳m p콏ekladem
                    state.resources[lootId] = (state.resources[lootId] || 0) + 1;
                    const icon = RESOURCE_ICONS[lootId] || '游닍';
                    const lootTranslations = {
                        'documents': 'Dokumenty',
                        'plutonium_core': 'Plutoniov칠 j치dro',
                        'book': 'Kniha',
                        'medicine': 'L칠ky',
                        'tech': 'Technologie',
                        'unique': 'Unik치t',
                        'legendary': 'Legend치rn칤 p콏edm캩t',
                        'rare': 'Vz치cn칳 p콏edm캩t',
                        'weapon': 'Zbra켿',
                        'armor': 'Zbroj',
                        'ammo': 'Munice',
                        'food': 'J칤dlo',
                        'water': 'Voda'
                    };
                    const name = RESOURCE_NAMES[lootId] || lootTranslations[lootId] || lootId;
                    lootHtml += `<div style="color: #ffd700;">游꾸 ${icon} +1 ${name}</div>`;
                }
            }
            
            // Loot se sb칤r치 v쬯y krom캩 ar칠ny
            if (!state.inArena) {
                enemyUnits.forEach((unit) => {
                    if (unit.loot && unit.loot.length > 0) {
                        // Bossov칠 maj칤 lootCount pro v칤ce item콢
                        const lootCount = unit.lootCount || 1;
                        for (let i = 0; i < lootCount; i++) {
                            generateSingleLoot(unit.loot);
                        }
                    } else if (enemyData.loot && enemyData.loot.length > 0) {
                        generateSingleLoot(enemyData.loot);
                    }
                });
                
                // Scavenger armor bonus - 코ance na extra loot
                const armorEffects = getArmorSpecialEffects();
                if (armorEffects.lootBonus > 0 && Math.random() < armorEffects.lootBonus) {
                    if (enemyData.loot && enemyData.loot.length > 0) {
                        generateSingleLoot(enemyData.loot);
                        lootHtml += `<div style="color: #9c27b0;">游 Sb캩ra캜콢v bonus loot!</div>`;
                    }
                }
                
                // Bonus pen칤ze v쬯y
                totalMoney += Math.floor(Math.random() * 20) + 10;
            }
            
            if (totalMoney > 0) {
                addMoney(totalMoney);
                lootHtml += `<div style="color: #ffd700;">游눯 +${totalMoney} pen캩z</div>`;
            }
            
            // Check for level up
            const levelUpInfo = getPendingLevelUp();
            let levelUpHtml = '';
            if (levelUpInfo) {
                levelUpHtml = `
                    <div style="background: linear-gradient(135deg, #1a3a1a, #2a4a2a); padding: 0.5rem 0.8rem; border-radius: 6px; margin: 0.3rem 0; border: 1px solid #4caf50; display: inline-block;">
                        <span style="color: #ffd700; font-weight: bold;">游꿀 LEVEL ${levelUpInfo.level}!</span>
                        <span style="font-size: 0.75rem; color: #8bc34a; margin-left: 0.5rem;">+1 atribut, +1 skill</span>
                    </div>
                `;
            }
            
            // Handle special combat types
            let continueAction = "window.combatState = null; closeModal(); checkAchievements(); renderFull();";
            let specialRewardHtml = '';
            
            // Ozna캜 lokaci jako vy캜i코t캩nou pokud to byl raid
            if (window.currentRaidLocation) {
                state.clearedLocations = state.clearedLocations || [];
                if (!state.clearedLocations.includes(window.currentRaidLocation)) {
                    state.clearedLocations.push(window.currentRaidLocation);
                    
                    // Speci치ln칤 zpr치va pro slave_camp
                    if (window.currentRaidLocation === 'slave_camp') {
                        specialRewardHtml += `
                            <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid #4caf50;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">久勇 T치bor vy캜i코t캩n!</h4>
                                <p style="color: #888; margin: 0; font-size: 0.85rem;">Nyn칤 m콢쬰코 osvobodit zajatce!</p>
                            </div>
                        `;
                    }
                }
                window.currentRaidLocation = null;
            }
            
            if (cs.combatType === 'settlement_raid') {
                handleRaidVictory();
                // Add raid bonus to display
                const waveIndex = window.raidWaveIndex || 0;
                const wave = RAID_WAVES ? RAID_WAVES[waveIndex] : null;
                if (wave?.reward) {
                    specialRewardHtml = `
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid #4caf50;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游띠勇 Bonus za obranu osady:</h4>
                            <div style="color: #ffd700;">游눯 +${wave.reward.money || 0} pen캩z</div>
                            <div style="color: #ffd700;">救 +${wave.reward.xp || 0} XP</div>
                        </div>
                    `;
                }
            } else if (cs.combatType === 'dungeon' || cs.isDungeon) {
                continueAction = "handleDungeonVictory();";
                console.log('游낋 Setting continueAction to handleDungeonVictory, combatType:', cs.combatType, 'isDungeon:', cs.isDungeon);
            } else if (cs.combatType === 'abyss') {
                continueAction = "handleAbyssVictory();";
            }
            
            // Show victory screen
            const killHumor = '"' + enemyData.name + ' ' + getRandomHumor('kill') + '"';
            
            // P콏idej do hern칤ho den칤ku
            addLog(`丘덢잺 V칤t캩zstv칤! Porazil jsi ${enemyCount}x ${enemyData.name} (+${xpGain} XP${totalMoney > 0 ? ', +' + totalMoney + ' 游눯' : ''})`, '丘덢잺');
            
            // Check achievements se vol치 a po zav콏en칤 v칤t캩zn칠ho modalu (v continueAction)
            
            // === TECHNIK AUTO-REPAIR ===
            const companionBonuses = getAllCompanionBonuses();
            let repairHtml = '';
            if (companionBonuses.autoRepair) {
                // Oprav vybaven칤 po boji
                let repaired = [];
                if (state.equipped?.weapon?.durability !== undefined && state.equipped.weapon.durability < state.equipped.weapon.maxDurability) {
                    const repairAmount = Math.min(10, state.equipped.weapon.maxDurability - state.equipped.weapon.durability);
                    state.equipped.weapon.durability += repairAmount;
                    repaired.push(`丘덢잺 Zbra켿 +${repairAmount}`);
                }
                if (state.equipped?.armor?.durability !== undefined && state.equipped.armor.durability < state.equipped.armor.maxDurability) {
                    const repairAmount = Math.min(10, state.equipped.armor.maxDurability - state.equipped.armor.durability);
                    state.equipped.armor.durability += repairAmount;
                    repaired.push(`游띠勇 Zbroj +${repairAmount}`);
                }
                if (repaired.length > 0) {
                    repairHtml = `<div style="color: #ff9800; font-size: 0.8rem; margin-top: 0.3rem;">游댢 Technik opravil: ${repaired.join(', ')}</div>`;
                }
            }
            
            showModal('游끥 V칈T캨ZSTV칈!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.3rem;">游끥</div>
                    <h2 style="color: #8bc34a; margin: 0; font-size: 1.3rem;">V칈T캨ZSTV칈!</h2>
                    <p style="color: #666; font-style: italic; font-size: 0.75rem; margin: 0.2rem 0;">${killHumor}</p>
                    <p style="color: #ffd700; font-size: 1rem; margin: 0.3rem 0;">+${xpGain} XP</p>
                    
                    ${lootHtml ? `
                        <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 8px; margin: 0.5rem 0; text-align: left; max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            <h4 style="margin: 0 0 0.3rem 0; color: #ff9800; font-size: 0.9rem;">游 Ko콏ist:</h4>
                            ${lootHtml}
                        </div>
                    ` : ''}
                    
                    ${levelUpHtml}
                    ${specialRewardHtml}
                    ${repairHtml}
                    
                    <p style="color: #555; font-size: 0.75rem; margin-top: 0.3rem;">Zabito: ${enemyCount}</p>
                </div>
                <button class="btn" onclick="${continueAction}" style="width: 100%; margin-top: 0.5rem; background: var(--toxic-green);">九 Pokra캜ovat</button>
            `);
            
            SoundSystem.play('victory');
            // combatState se 캜ist칤 a v continueAction
        }
        
        // handleCombatDefeat je definov치na v칳코e (콏치dek ~39292)
        
        // === SKILL BONUS FUNKCE ===
        function getPlayerSkillBonus(skillId) {
            const level = state.skills?.[skillId] || 0;
            if (level === 0) return 0;
            const skill = SKILLS.find(s => s.id === skillId);
            return skill ? skill.value * level : 0;
        }
        
        function calculateMaxHp() {
            let maxHp = 100; // Z치klad
            
            // END bonus (+5 HP per point above 5)
            maxHp += (state.char.attrs.end - 5) * 5;
            
            // Tough skill (+20 HP per level)
            const toughBonus = getPlayerSkillBonus('tough');
            if (toughBonus > 0) maxHp += toughBonus;
            
            // Class bonus
            if (state.char.classId === 'tank') maxHp += 50;
            if (state.char.classId === 'mutant') maxHp += 30;
            
            // Level bonus (+2 HP per level)
            maxHp += (state.char.level - 1) * 2;
            
            return maxHp;
        }
        
        function getScavengerBonus() {
            // Scavenger skill (+15% loot chance per level)
            return getPlayerSkillBonus('scavenger');
        }
        
        function getEfficiencyBonus() {
            // Efficient skill (+25% XP per level)
            return getPlayerSkillBonus('efficient');
        }
        
        function getLuckyBonus() {
            // Lucky skill (+10% loot quality per level)
            return getPlayerSkillBonus('lucky');
        }
        
        function calculateDamage() {
            // Base damage + STR bonus (+2 per point above 5)
            let baseDmg = 5 + getAttrBonus('str');
            
            // Weapon damage
            const weapon = state.equipped?.weapon || null;
            if (weapon) {
                baseDmg += weapon.damage;
            } else if (state.char.class === 'mutant') {
                // Mutant m치 v쬯y dr치py jako z치lo쬹칤 zbra켿 (+20 DMG)
                baseDmg += 20;
            }
            
            // Raider class bonus (+30%)
            if (state.char.classId === 'raider') baseDmg = Math.floor(baseDmg * 1.3);
            
            // Berserker class bonus (+50% dmg, but we handle defense reduction elsewhere)
            if (state.char.classId === 'berserker') baseDmg = Math.floor(baseDmg * 1.5);
            
            // Mutant class bonus (+20% v radioaktivn칤ch z칩n치ch)
            if (state.char.class === 'mutant') {
                const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
                if (loc?.radiation && loc.radiation > 0) {
                    let radBonus = 1.2; // Base +20%
                    // Set (3) bonus - radRegenImproved = +50% m칤sto +20%
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    if (setFx.radRegenImproved) {
                        radBonus = 1.5; // +50%
                    }
                    baseDmg = Math.floor(baseDmg * radBonus);
                }
            }
            
            // Skill tree damage bonus
            baseDmg = Math.floor(baseDmg * (1 + getSkillTreeBonus('damageBonus')));
            
            // 游깿 No캜n칤 bonus pro hr치캜e - assassin class
            const dayPhase = getCurrentDayPhase();
            if (dayPhase.id === 'night' && state.char.classId === 'assassin') {
                baseDmg = Math.floor(baseDmg * 1.2); // +20% v noci pro assassiny
            }
            
            // 游꺊勇 Po캜as칤 efekty - pou쬴j weather.effect.playerDmgMod
            const weather = getCurrentWeather();
            if (weather?.effect?.playerDmgMod) {
                baseDmg = Math.floor(baseDmg * weather.effect.playerDmgMod);
            }
            
            // 游끵勇 Bonus z budov (Zbrojnice +10%, Kov치rna +5 DMG)
            if (state.map.inBase) {
                const bonuses = getBuildingBonuses();
                if (bonuses.damageBonus > 0) {
                    baseDmg = Math.floor(baseDmg * (1 + bonuses.damageBonus / 100));
                }
                if (bonuses.weaponBonus > 0) {
                    baseDmg += bonuses.weaponBonus;
                }
            }
            
            // 游띠勇 Armor special efekty (berserker, exo, intimidate)
            const armorEffects = getArmorSpecialEffects();
            if (armorEffects.bonusDamage > 0) {
                baseDmg += armorEffects.bonusDamage;
            }
            
            // Exoskelet +10% damage multiplik치tor
            if (armorEffects.damageMultiplier > 1.0) {
                baseDmg = Math.floor(baseDmg * armorEffects.damageMultiplier);
            }
            
            // 游깿 No캜n칤 bonus z armor (night_stalker)
            if (dayPhase.id === 'night' && armorEffects.nightBonus) {
                baseDmg = Math.floor(baseDmg * 1.15); // +15% v noci
            }
            
            // 游빏 Mutace - berserker_blood (+25% damage)
            if (state.mutations?.includes('berserker_blood')) {
                baseDmg = Math.floor(baseDmg * 1.25);
            }
            
            // 游꿌勇 Vojensk칳 tr칠nink - combat bonus (permanentn칤, stackuje se)
            if (state.trainingBonuses?.combat > 0) {
                baseDmg = Math.floor(baseDmg * (1 + state.trainingBonuses.combat));
            }
            
            // 游꿌勇 Military frakce - tactical bonus (+5% damage jako Spojenec)
            const factionBonuses = getFactionBonuses();
            if (factionBonuses.tacticalBonus > 0) {
                baseDmg = Math.floor(baseDmg * (1 + factionBonuses.tacticalBonus));
            }
            
            // 游눑 Exotic bonus - Krystal pr치zdnoty (+10% damage)
            if (state.exoticBonuses?.damageBoost > 0) {
                baseDmg = Math.floor(baseDmg * (1 + state.exoticBonuses.damageBoost));
            }
            
            // 游댮 Frak캜n칤 bonus - Koryho n치sledovn칤ci (+5% damage)
            const pvpFactionBonus = getFactionBonus();
            if (pvpFactionBonus.damage > 0) {
                baseDmg = Math.floor(baseDmg * (1 + pvpFactionBonus.damage));
            }
            
            // 游댢 Technik companion - v캩쬴캜ka bonus
            const companionBonuses = getAllCompanionBonuses();
            if (companionBonuses.turretDamage > 0) {
                baseDmg += companionBonuses.turretDamage;
            }
            
            // 游꽄 Alkohol damage buff
            if (state.buffs?.alcoholDamage && state.buffs.alcoholDamage.until > Date.now()) {
                baseDmg = Math.floor(baseDmg * (1 + state.buffs.alcoholDamage.value / 100));
            }
            
            // 游 Nemoci - sn칤쬰n칤 damage (ch콏ipka -10%)
            if (typeof getDiseaseModifiers === 'function') {
                const diseaseMods = getDiseaseModifiers();
                if (diseaseMods.damageMod < 1) {
                    baseDmg = Math.floor(baseDmg * diseaseMods.damageMod);
                }
            }
            
            // 游뽗 Zran캩n칤 - sn칤쬰n칤 damage (zlomenina -30%, mod콏ina -5%)
            if (typeof getInjuryModifiers === 'function') {
                const injuryMods = getInjuryModifiers();
                if (injuryMods.damageMod < 1) {
                    baseDmg = Math.floor(baseDmg * injuryMods.damageMod);
                }
            }
            
            // 救 SET BONUSY - damage
            if (typeof getActiveSetEffects === 'function') {
                const setEffects = getActiveSetEffects();
                // Piece damage bonus
                if (setEffects.damageBonus > 0) {
                    baseDmg = Math.floor(baseDmg * (1 + setEffects.damageBonus));
                }
                // Raider rage improved (3 set) - rage od 50% HP m칤sto 30%
                if (setEffects.rageImproved && state.char.hp / state.char.maxHp < 0.5) {
                    baseDmg = Math.floor(baseDmg * 1.4); // +40% damage
                }
                // Low HP damage bonus (berserker armor piece)
                if (setEffects.lowHpDamage && state.char.hp / state.char.maxHp < 0.5) {
                    baseDmg = Math.floor(baseDmg * (1 + setEffects.lowHpDamage));
                }
                // Lifesteal se aplikuje v combat processu
            }
            
            return Math.max(1, Math.floor(baseDmg));
        }
        
        function calculateDefense() {
            let defense = Math.floor(state.char.attrs.end * 1); // END bonus
            
            // Armor defense
            const armor = state.equipped?.armor;
            if (armor && armor.defense) defense += armor.defense;
            
            // Helmet defense
            const helmet = state.equipped?.helmet;
            if (helmet && helmet.defense) defense += helmet.defense;
            
            // Gloves defense
            const gloves = state.equipped?.gloves;
            if (gloves && gloves.defense) defense += gloves.defense;
            
            // Boots defense
            const boots = state.equipped?.boots;
            if (boots && boots.defense) defense += boots.defense;
            
            // Armor special efekty
            const armorEffects = getArmorSpecialEffects();
            defense += armorEffects.bonusDefense;
            
            // Skill tree bonus
            defense += getSkillTreeBonus('defense');
            
            // Mutant p콏irozen치 obrana +10
            if (state.char.classId === 'mutant') defense += 10;
            
            // Bonusy z mutac칤 (nap콏. Tlust치 k콢쬰 +8 DEF)
            const mutBonuses = getMutationBonuses();
            defense += mutBonuses.defense || 0;
            
            // Class bonuses
            if (state.char.classId === 'tank') defense = Math.floor(defense * 1.3);
            if (state.char.classId === 'berserker') defense = Math.floor(defense * 0.7);
            
            // 游꿌勇 Vojensk칳 tr칠nink - defense bonus (permanentn칤, stackuje se)
            if (state.trainingBonuses?.defense > 0) {
                defense = Math.floor(defense * (1 + state.trainingBonuses.defense));
            }
            
            return Math.max(0, defense);
        }
        
        function calculateCritChance() {
            let crit = 0.05; // Base 5%
            
            // PER bonus (+3% per point above 5)
            crit += (state.char.attrs.per - 5) * 0.03;
            
            // LCK bonus (+2% per point above 5)
            crit += (state.char.attrs.lck - 5) * 0.02;
            
            // Assassin class bonus (+40%)
            const assassinCrit = getClassPassiveValue('critBonus');
            if (assassinCrit) crit += assassinCrit;
            
            // Skill tree bonus
            crit += getSkillTreeBonus('critChance');
            
            // Armor/boots special effects (combat_boots +5%)
            const armorEffects = getArmorSpecialEffects();
            if (armorEffects.critBonus > 0) {
                crit += armorEffects.critBonus;
            }
            
            return Math.min(0.75, crit); // Max 75%
        }
        
        function calculateDodgeChance() {
            let dodge = 0.02; // Base 2%
            
            // AGI bonus (+2% per point above 5)
            dodge += (state.char.attrs.agi - 5) * 0.02;
            
            // Companion skills dodge bonus
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.dodgeChance > 0) {
                dodge += compBonuses.dodgeChance;
            }
            
            // Bonusy z mutac칤 (nap콏. 만st칳 smysl +15% 칰hyb)
            const mutBonuses = getMutationBonuses();
            if (mutBonuses.dodgeChance > 0) {
                dodge += mutBonuses.dodgeChance;
            }
            
            // Armor special efekty
            const armorEffects = getArmorSpecialEffects();
            if (armorEffects.bonusDodge > 0) {
                dodge += armorEffects.bonusDodge;
            }
            
            // SET BONUSY - dodge
            const setEffects = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
            if (setEffects.dodgeChance > 0) {
                dodge += setEffects.dodgeChance;
            }
            // Desert Walker (Nomad set 2) - +15% dodge
            if (setEffects.desertWalker) {
                dodge += 0.15;
            }
            
            return Math.min(0.50, dodge); // Max 50%
        }
        
        function calculateXPBonus() {
            let bonus = 1.0;
            
            // INT bonus (+10% per point above 5)
            bonus += (state.char.attrs.int - 5) * 0.10;
            
            // Accessory bonus (zlat칳 amulet)
            if (state.equippedAccessory) {
                const acc = state.inv.find(i => i.id === state.equippedAccessory);
                if (acc?.bonus === 'xp') {
                    bonus += (acc.value || 0) / 100;
                }
            }
            
            // 游끵勇 Bonus z budov (Cvi캜i코t캩 +10%)
            const bonuses = getBuildingBonuses();
            if (bonuses.xpBonus > 0) {
                bonus += bonuses.xpBonus;
            }
            
            return bonus;
        }
        
        function calculateLootBonus() {
            let bonus = 1.0;
            
            // PER bonus (+5% per point above 5)
            bonus += (state.char.attrs.per - 5) * 0.05;
            
            // Accessory bonus (st콏칤brn칳 prsten)
            if (state.equippedAccessory) {
                const acc = state.inv.find(i => i.id === state.equippedAccessory);
                if (acc?.bonus === 'luck') {
                    bonus += (acc.value || 0) / 100;
                }
            }
            
            // Companion skills loot bonus
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.lootChance > 0) {
                bonus += compBonuses.lootChance;
            }
            
            // Scavenger skill (+15% loot chance per level)
            const scavengerBonus = getScavengerBonus();
            if (scavengerBonus > 0) {
                bonus += scavengerBonus;
            }
            
            // 游뿣 Exotic bonus - 먠벼stn치 mince (+15% loot)
            if (state.exoticBonuses?.luck > 0) {
                bonus += state.exoticBonuses.luck;
            }
            
            // 游 Luck potion buff (+X% loot)
            if (state.buffs?.luck && state.buffs.luck.until > Date.now()) {
                bonus += state.buffs.luck.value / 100;
            }
            
            // 游릭 Frak캜n칤 bonus - Nez치visl칤 (+5% loot)
            const pvpFactionBonus = getFactionBonus();
            if (pvpFactionBonus.loot > 0) {
                bonus += pvpFactionBonus.loot;
            }
            
            // LCK bonus for rare loot (+3% per point above 5)
            // This is handled separately in loot rolls
            
            return bonus;
        }
        
        function calculateLootQuality() {
            let quality = 1.0;
            
            // LCK bonus (+3% per point above 5)
            quality += (state.char.attrs.lck - 5) * 0.03;
            
            // Lucky skill (+10% loot quality per level)
            const luckyBonus = getLuckyBonus();
            if (luckyBonus > 0) {
                quality += luckyBonus;
            }
            
            return quality;
        }
        
        function calculateCritBonus() {
            let bonus = 0.1; // Z치kladn칤 10% 코ance na krit
            
            // AGI bonus
            bonus += (state.char.attrs.agi - 5) * 0.02;
            
            // Accessory bonus (krystalov칳 fokus)
            if (state.equippedAccessory) {
                const acc = state.inv.find(i => i.id === state.equippedAccessory);
                if (acc?.bonus === 'crit') {
                    bonus += (acc.value || 0) / 100;
                }
            }
            
            // Companion skills crit bonus
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.critChance > 0) {
                bonus += compBonuses.critChance;
            }
            
            return Math.min(0.5, bonus); // Max 50%
        }
        
        // === PASIVN칈 SCHOPNOSTI POVOL츼N칈 ===
        const CLASS_PASSIVES = {
            // Bojov칠
            raider: {
                onAttack: (damage) => {
                    // Rage: Pod 30% HP +50% damage
                    if (state.char.hp / state.char.maxHp < 0.3) {
                        return { damage: Math.floor(damage * 1.5), message: '游땫 RAGE! +50% damage!' };
                    }
                    return { damage };
                }
            },
            berserker: {
                onKill: () => {
                    // Frenzy: Po zabit칤 +25% damage na 45 sekund (set bonus zvy코uje na +50%)
                    state.buffs = state.buffs || {};
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    const frenzyBonus = setFx.frenzyDamage ? 0.50 : 0.25; // Set bonus = 50%, jinak 25%
                    state.buffs.frenzy = { value: frenzyBonus, expires: Date.now() + 45000 }; // 45s
                    return { message: `游댠 FRENZY! (+${Math.round(frenzyBonus * 100)}% damage na 45s)` };
                },
                onAttack: (damage) => {
                    if (state.buffs?.frenzy && state.buffs.frenzy.expires > Date.now()) {
                        return { damage: Math.floor(damage * (1 + state.buffs.frenzy.value)) };
                    }
                    return { damage };
                }
            },
            
            // Obrann칠
            survivor: {
                onDamage: (damage) => {
                    // Last Stand: 20% 코ance p콏e쮂셦 smrteln칳 칰der s 1 HP (nerfed from 25%)
                    if (state.char.hp - damage <= 0 && Math.random() < 0.20) {
                        return { damage: state.char.hp - 1, message: '游눩 LAST STAND! P콏e쬴l jsi s 1 HP!' };
                    }
                    return { damage };
                }
            },
            tank: {
                onDamage: (damage) => {
                    // Fortress: Blokuje 25% p콏칤choz칤ho damage (nerfed from 30%)
                    const reduced = Math.floor(damage * 0.75);
                    return { damage: reduced, message: `游낋 Blokov치no ${damage - reduced} damage` };
                }
            },
            
            // Skautsk칠
            stalker: {
                onAmbush: () => {
                    // Stealth: 50% 코ance vyhnout se p콏epaden칤 (70% s set bonusem)
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    const stealthChance = setFx.stealthImproved ? 0.70 : 0.50;
                    if (Math.random() < stealthChance) {
                        return { avoid: true, message: `游녻 Vyklouzl jsi nepozorovan캩!${setFx.stealthImproved ? ' (Set bonus)' : ''}` };
                    }
                    return { avoid: false };
                }
            },
            assassin: {
                onAttack: (damage, isCrit) => {
                    // Execute: Kritick칳 z치sah d캩l치 3x damage (m칤sto 2x)
                    if (isCrit) {
                        return { damage: Math.floor(damage * 1.5), message: '游디勇 EXECUTE! 3x kritick칳 damage!' };
                    }
                    return { damage };
                },
                critBonus: 0.4 // +40% crit chance
            },
            
            // Podp콢rn칠
            medic: {
                onTick: () => {
                    // Regeneration: +3 HP za minutu (nebo +6 s set bonusem)
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    const regenAmount = setFx.regenImproved ? 6 : 3;
                    if (state.char.hp < state.char.maxHp) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + regenAmount);
                        return { message: `游눜 +${regenAmount} HP (regenerace${setFx.regenImproved ? ' IMPROVED' : ''})` };
                    }
                    return {};
                }
            },
            alchemist: {
                onAttack: (damage) => {
                    // Poison: 칔toky zp콢sobuj칤 otravu (5 DOT)
                    window.enemyPoison = (window.enemyPoison || 0) + 5;
                    return { damage, message: '驕멆잺 Jed aplikov치n! (+5 DOT)' };
                }
            },
            
            // Sb캩ra캜sk칠
            scavenger: {
                onLoot: (items) => {
                    // Lucky Find: 15% 코ance na dvojit칳 loot (30% s set bonusem)
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    const luckyChance = setFx.luckyFindImproved ? 0.30 : 0.15;
                    if (Math.random() < luckyChance) {
                        return { multiplier: 2, message: `游 LUCKY FIND${setFx.luckyFindImproved ? ' IMPROVED' : ''}! Dvojit칳 loot!` };
                    }
                    return { multiplier: 1 };
                }
            },
            hunter: {
                // Animal loot bonus: +100% (nebo +200% s set bonusem)
                getAnimalLootBonus: () => {
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    return setFx.animalLootImproved ? 3.0 : 2.0; // +200% nebo +100%
                },
                animalLootBonus: 2.0 // Base +100% loot ze zv칤콏at
            },
            
            // Technick칠
            engineer: {
                noDurabilityLoss: true, // Zbran캩 a zbroje se neni캜칤
                getCraftCostReduction: () => {
                    // -50% surovin (nebo -75% s masterCrafter set bonusem)
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    return setFx.masterCrafter ? 0.75 : 0.50;
                },
                craftCostReduction: 0.5 // Base -50% surovin na crafting
            },
            demolitionist: {
                onAttack: (damage) => {
                    // Boom: 12% 코ance na AoE damage (25% s set bonusem)
                    const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    const boomChance = setFx.boomImproved ? 0.25 : 0.12;
                    const splashPercent = setFx.boomImproved ? 0.60 : 0.40;
                    if (Math.random() < boomChance) {
                        // Chain Explosion (set 2) - 20% 코ance na 콏et캩zovou explozi
                        let chainMsg = '';
                        if (setFx.chainExplosion && Math.random() < 0.20) {
                            chainMsg = ' 游댠 CHAIN EXPLOSION!';
                            return { damage, aoe: true, splash: splashPercent, chain: true, message: `游눤 BOOM${setFx.boomImproved ? ' IMPROVED' : ''}! AoE damage (${Math.round(splashPercent * 100)}%)!${chainMsg}` };
                        }
                        return { damage, aoe: true, splash: splashPercent, message: `游눤 BOOM${setFx.boomImproved ? ' IMPROVED' : ''}! AoE damage (${Math.round(splashPercent * 100)}%)!` };
                    }
                    return { damage };
                }
            },
            
            // Speci치ln칤
            trader: {
                shopDiscount: 0.3, // -30% ceny v obchodech
                sellBonus: 0.5 // +50% ceny p콏i prodeji
            },
            nomad: {
                travelSpeedBonus: 0.05, // -5% 캜as cestov치n칤
                consumptionReduction: 0.5 // -50% hlad/쮂셬e켿
            },
            mutant: {
                radiationImmune: true,
                onRadiation: (amount) => {
                    // Radiace t캩 l칠캜칤 (+1 HP za 10 rad)
                    const healing = Math.floor(amount / 10);
                    if (healing > 0) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + healing);
                        return { immune: true, message: `驕뮖잺 Radiace t캩 l칠캜칤! +${healing} HP` };
                    }
                    return { immune: true };
                }
            },
            psychic: {
                onCombatStart: () => {
                    // Mind Control: 10% 코ance 쬰 nep콏칤tel ute캜e
                    if (Math.random() < 0.1) {
                        return { flee: true, message: '游댩 MIND CONTROL! Nep콏칤tel utekl!' };
                    }
                    return { flee: false };
                },
                revealHiddenLocations: true
            }
        };
        
        function triggerClassPassive(event, ...args) {
            const classId = state.char.classId;
            const passive = CLASS_PASSIVES[classId];
            if (!passive) return null;
            
            if (event === 'onAttack' && passive.onAttack) {
                return passive.onAttack(...args);
            }
            if (event === 'onDamage' && passive.onDamage) {
                return passive.onDamage(...args);
            }
            if (event === 'onKill' && passive.onKill) {
                return passive.onKill(...args);
            }
            if (event === 'onLoot' && passive.onLoot) {
                return passive.onLoot(...args);
            }
            if (event === 'onAmbush' && passive.onAmbush) {
                return passive.onAmbush(...args);
            }
            if (event === 'onCombatStart' && passive.onCombatStart) {
                return passive.onCombatStart(...args);
            }
            if (event === 'onRadiation' && passive.onRadiation) {
                return passive.onRadiation(...args);
            }
            
            return null;
        }
        
        function hasClassPassive(passiveKey) {
            const classId = state.char.classId;
            const passive = CLASS_PASSIVES[classId];
            return passive && passive[passiveKey];
        }
        
        function getClassPassiveValue(passiveKey) {
            const classId = state.char.classId;
            const passive = CLASS_PASSIVES[classId];
            return passive ? passive[passiveKey] : null;
        }

        function attack() {
            const cs = window.combatState;
            if (!cs || !cs.enemyGroup) return;
            
            const enemyGroup = cs.enemyGroup;
            const log = document.getElementById('combatLog');
            
            // === KONTROLA STUNU HR츼캛E ===
            if (state.char.stunned && state.char.stunnedRounds > 0) {
                state.char.stunnedRounds--;
                if (state.char.stunnedRounds <= 0) {
                    state.char.stunned = false;
                }
                log.innerHTML += `<div style="color: #ffeb3b;">游눪 Jsi omr치캜en칳! Nem콢쬰코 칰to캜it toto kolo!</div>`;
                // P콏ejdi na kolo nep콏치tel
                setTimeout(() => enemyTurn(), 500);
                return;
            }
            
            // === KONTROLA ZMATEN칈 HR츼캛E ===
            if (state.char.confused && state.char.confused > 0) {
                state.char.confused--;
                if (Math.random() < 0.4) { // 40% 코ance na minout
                    log.innerHTML += `<div style="color: #9c27b0;">游댩 Jsi zmaten칳! 칔tok minul!</div>`;
                    setTimeout(() => enemyTurn(), 500);
                    return;
                }
                log.innerHTML += `<div style="color: #9c27b0;">游댩 Zmaten칤: ${state.char.confused} kol zb칳v치</div>`;
            }
            
            // === DOT EFEKTY NA HR츼캛I ===
            let dotDamage = 0;
            
            // Krv치cen칤
            if (state.char.bleeding && state.char.bleedRounds > 0) {
                dotDamage += state.char.bleeding;
                state.char.bleedRounds--;
                log.innerHTML += `<div style="color: #f44336;">游뽖 Krv치c칤코: -${state.char.bleeding} HP [${state.char.bleedRounds} kol]</div>`;
                if (state.char.bleedRounds <= 0) {
                    state.char.bleeding = 0;
                    log.innerHTML += `<div style="color: #4caf50;">游뽗 Krv치cen칤 se zastavilo</div>`;
                }
            }
            
            // Otrava
            if (state.char.poisoned && state.char.poisonRounds > 0) {
                dotDamage += state.char.poisoned;
                state.char.poisonRounds--;
                log.innerHTML += `<div style="color: #9c27b0;">驕멆잺 Jed: -${state.char.poisoned} HP [${state.char.poisonRounds} kol]</div>`;
                if (state.char.poisonRounds <= 0) {
                    state.char.poisoned = 0;
                    log.innerHTML += `<div style="color: #4caf50;">游눜 Jed vyprchal</div>`;
                }
            }
            
            // Ho콏en칤
            if (state.char.burning && state.char.burnRounds > 0) {
                dotDamage += state.char.burning;
                state.char.burnRounds--;
                log.innerHTML += `<div style="color: #ff5722;">游댠 Ho콏칤코: -${state.char.burning} HP [${state.char.burnRounds} kol]</div>`;
                if (state.char.burnRounds <= 0) {
                    state.char.burning = 0;
                    log.innerHTML += `<div style="color: #4caf50;">游눦 Ohe켿 uhasl</div>`;
                }
            }
            
            if (dotDamage > 0) {
                state.char.hp -= dotDamage;
                document.getElementById('playerHp').textContent = Math.max(0, Math.round(state.char.hp));
                
                if (state.char.hp <= 0) {
                    log.innerHTML += `<div style="color: #c62828; font-weight: bold;">游 Zem콏el jsi na DOT efekty!</div>`;
                    state.stats.deaths++;
                    setTimeout(() => {
                        showModal('游 Smrt', 'Zem콏el jsi na krv치cen칤/otravu/pop치leniny!<br><br><button class="btn" onclick="location.reload()" style="width: 100%;">Restart</button>');
                    }, 1000);
                    return;
                }
            }
            
            // Find first alive enemy
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            if (aliveEnemies.length === 0) return;
            
            const targetEnemy = aliveEnemies[0];
            const enemyIndex = enemyGroup.indexOf(targetEnemy);
            
            // === KONTROLA MUNICE PRO RANGED ZBRAN캨 ===
            const weapon = state.equipped?.weapon;
            if (weapon && weapon.ammoType) {
                const ammoCount = getAmmoCount(weapon.ammoType);
                if (ammoCount <= 0) {
                    log.innerHTML += `<div style="color: #f44336;">仇 Nem치코 munici (${getAmmoName(weapon.ammoType)})! Pou쬴j jinou zbra켿 nebo ute캜!</div>`;
                    notifyWarning('콯치dn치 munice!', `Nem치코 ${getAmmoName(weapon.ammoType)} pro ${weapon.name}`);
                    return;
                }
                // Spot콏ebuj 1 n치boj/코칤p
                consumeAmmo(weapon.ammoType, 1);
                log.innerHTML += `<div style="color: #888; font-size: 0.85rem;">游댲 -1 ${getAmmoName(weapon.ammoType)} (zb칳v치: ${ammoCount - 1})</div>`;
            }
            
            // Calculate base damage
            let playerDmg = calculateDamage() + Math.floor(Math.random() * 5);
            
            // Aplikuj combat debuff (칰nava z cesty p콏i obran캩 osady)
            if (state.combatDebuffs?.fatigue) {
                const fatigueReduction = Math.floor(playerDmg * Math.abs(state.combatDebuffs.fatigue.effect));
                playerDmg = Math.max(1, playerDmg - fatigueReduction);
                log.innerHTML += `<div style="color: #ff9800;">游땝 칔nava z cesty: -${fatigueReduction} DMG (-10%)</div>`;
                state.combatDebuffs.fatigue.fights--;
                if (state.combatDebuffs.fatigue.fights <= 0) {
                    delete state.combatDebuffs.fatigue;
                }
            }
            
            // Aplikuj weapon buff (ze Zlat칠ho povlaku apod.)
            if (state.weaponBuff && state.weaponBuff.fights > 0) {
                playerDmg += state.weaponBuff.damage;
                log.innerHTML += `<div style="color: #ffd700;">九 Weapon buff: +${state.weaponBuff.damage} DMG (zb칳v치 ${state.weaponBuff.fights} boj콢)</div>`;
                state.weaponBuff.fights--;
                if (state.weaponBuff.fights <= 0) {
                    state.weaponBuff = null;
                }
            }
            
            // Aplikuj all_stats buff
            if (state.buffs?.allStats && state.buffs.allStats.until > Date.now()) {
                const statBonus = Math.floor(state.buffs.allStats.value * 0.5); // Polovina hodnoty jako damage
                playerDmg += statBonus;
                log.innerHTML += `<div style="color: #ffd700;">九 Elix칤r s칤ly: +${statBonus} DMG</div>`;
            }
            
            // Aplikuj strength buff
            if (state.buffs?.strength && state.buffs.strength.until > Date.now()) {
                playerDmg += state.buffs.strength.value;
                log.innerHTML += `<div style="color: #f44336;">游눩 S칤la buff: +${state.buffs.strength.value} DMG</div>`;
            }
            
            // Check for critical hit using new function
            const critChance = calculateCritChance();
            
            // Companion firstStrikeCrit - prvn칤 칰tok v boji je v쬯y crit
            const compBonuses = getAllCompanionBonuses();
            const isFirstStrike = !window.combatState?.playerAttacked;
            const isCrit = (compBonuses.firstStrikeCrit && isFirstStrike) || Math.random() < critChance;
            
            // Ozna캜 쬰 hr치캜 u 칰to캜il
            if (window.combatState) window.combatState.playerAttacked = true;
            
            if (isCrit) {
                // Z치kladn칤 crit = 2x, + companion bonus
                const critMultiplier = 2 + (compBonuses.critDamage || 0);
                playerDmg = Math.floor(playerDmg * critMultiplier);
                const firstStrikeText = (compBonuses.firstStrikeCrit && isFirstStrike) ? ' (游 First Strike!)' : '';
                log.innerHTML += `<div style="color: #ffd700;">游눤 KRITICK칗 Z츼SAH!${firstStrikeText} (${critMultiplier}x DMG)</div>`;
            }
            
            // Apply class passive onAttack
            const attackPassive = getClassPassive('onAttack', playerDmg, isCrit);
            if (attackPassive) {
                playerDmg = attackPassive.damage;
                if (attackPassive.message) {
                    log.innerHTML += `<div style="color: #ff9800;">${attackPassive.message}</div>`;
                }
                
                // AoE damage (Demolitionist)
                if (attackPassive.aoe) {
                    aliveEnemies.forEach((enemy, idx) => {
                        if (idx > 0) { // Skip primary target
                            const aoeDmg = Math.floor(playerDmg * 0.5);
                            enemy.hp -= aoeDmg;
                            log.innerHTML += `<div style="color: #ff9800;">游눤 AoE: #${enemyGroup.indexOf(enemy)+1} -${aoeDmg} HP</div>`;
                        }
                    });
                }
            }
            
            // Apply poison DOT (Alchemist)
            if (window.enemyPoison && window.enemyPoison > 0) {
                targetEnemy.hp -= window.enemyPoison;
                log.innerHTML += `<div style="color: #9c27b0;">驕멆잺 Jed: -${window.enemyPoison} HP</div>`;
            }
            
            // Apply defense
            playerDmg = Math.max(1, playerDmg - targetEnemy.defense);
            targetEnemy.hp -= playerDmg;
            SoundSystem.play('combat_hit');
            
            // Degrade weapon durability (unless Engineer)
            if (!hasClassPassive('noDurabilityLoss')) {
                const weapon = state.equipped?.weapon;
                if (weapon && weapon.durability !== undefined) {
                    // Technik zpevn캩n칤 - men코칤 opot콏eben칤
                    const compBonuses = getAllCompanionBonuses();
                    let durabilityLoss = 2;
                    if (compBonuses.durabilityBonus > 0) {
                        // S durabilityBonus 0.05 je 코ance 5% 쬰 se zbra켿 neopot콏eb칤
                        if (Math.random() < compBonuses.durabilityBonus) {
                            durabilityLoss = 0; // Technik zabr치nil opot콏eben칤
                        }
                    }
                    
                    if (durabilityLoss > 0) {
                        weapon.durability = Math.max(0, weapon.durability - durabilityLoss);
                        if (weapon.durability === 0) {
                            log.innerHTML += `<div style="color: #c62828;">游눖 ${weapon.icon} ${weapon.name} se rozpadla!</div>`;
                            state.equipped.weapon = null;
                        } else if (weapon.durability <= 20) {
                            log.innerHTML += `<div style="color: #ff9800;">丘멆잺 ${weapon.name}: ${weapon.durability}/${weapon.maxDurability}</div>`;
                        }
                    }
                }
            }
            
            if (targetEnemy.defense > 0) {
                log.innerHTML += `<div style="color: #8bc34a;">丘덢잺 Zas치hl jsi #${enemyIndex+1} za ${playerDmg} DMG! (obrana -${targetEnemy.defense})</div>`;
            } else {
                log.innerHTML += `<div style="color: #8bc34a;">丘덢잺 Zas치hl jsi #${enemyIndex+1} za ${playerDmg} DMG!</div>`;
            }
            
            // Vizu치ln칤 efekt z치sahu
            showFloatingNumber(playerDmg, isCrit ? 'crit' : 'damage');
            if (isCrit) screenShake(3, 100);
            
            // === 칔TOK SPOLE캛N칈K콡 ===
            if (state.companions && state.companions.length > 0) {
                state.companions.forEach(comp => {
                    if (comp.isDead) return; // Mrtv칳 spole캜n칤k ne칰to캜칤
                    
                    const compInfo = COMPANIONS.find(c => c.id === comp.id);
                    if (!compInfo) return;
                    
                    // Najdi 쬴v칠ho nep콏칤tele
                    const aliveTarget = enemyGroup.find(e => e.alive);
                    if (!aliveTarget) return;
                    
                    // KONTROLA MUNICE - pokud m치 zbra켿 vy쬬duj칤c칤 munici, bere z invent치콏e HR츼캛E
                    if (comp.equipped?.weapon?.ammoType) {
                        const ammoType = comp.equipped.weapon.ammoType;
                        const playerAmmo = getAmmoCount(ammoType);
                        if (playerAmmo < 1) {
                            // Hr치캜 nem치 munici - spole캜n칤k nem콢쬰 칰to캜it
                            log.innerHTML += `<div style="color: #ff9800;">丘멆잺 ${comp.name || compInfo.name} nem치 munici (${getAmmoName(ammoType)})!</div>`;
                            return;
                        }
                        // Spot콏ebuj munici z invent치콏e hr치캜e
                        consumeAmmo(ammoType, 1);
                    }
                    
                    // Pou쬴j getCompanionStat pro damage v캜etn캩 bonus콢 ze skill콢 a level콢
                    const baseDmg = getCompanionStat(comp, 'damage');
                    let compDmg = baseDmg + Math.floor(Math.random() * 3);
                    
                    // Bonus za level (+5% damage za level nad 1)
                    const levelBonus = ((comp.level || 1) - 1) * 0.05;
                    compDmg = Math.floor(compDmg * (1 + levelBonus));
                    
                    // Kritick칳 z치sah spole캜n칤ka (5% z치kladn칤 코ance + bonus ze skill콢)
                    const compCritChance = 0.05 + (getCompanionStat(comp, 'critChance') || 0);
                    const isCompCrit = Math.random() < compCritChance;
                    if (isCompCrit) {
                        compDmg = Math.floor(compDmg * 1.5);
                    }
                    
                    // Aplikuj obranu nep콏칤tele
                    compDmg = Math.max(1, compDmg - aliveTarget.defense);
                    aliveTarget.hp -= compDmg;
                    
                    // XP pro spole캜n칤ka za 칰tok
                    if (!comp.xp) comp.xp = 0;
                    comp.xp += 1;
                    
                    const critText = isCompCrit ? ' 游눤 KRIT!' : '';
                    log.innerHTML += `<div style="color: #9c27b0;">${compInfo.icon} ${escapeHtml(comp.name || compInfo.name)} 칰to캜칤 za ${compDmg} DMG!${critText}</div>`;
                    
                    // Aktualizuj zobrazen칤 HP nep콏칤tele
                    const targetIdx = enemyGroup.indexOf(aliveTarget);
                    const hpSpanComp = document.querySelectorAll('.enemyHp')[targetIdx];
                    if (hpSpanComp) hpSpanComp.textContent = Math.max(0, aliveTarget.hp);
                    const hpBarComp = document.querySelectorAll('.enemyHpBar')[targetIdx];
                    if (hpBarComp) hpBarComp.style.width = Math.max(0, (aliveTarget.hp/aliveTarget.maxHp)*100) + '%';
                    
                    // Zkontroluj jestli spole캜n칤k zabil nep콏칤tele
                    if (aliveTarget.hp <= 0) {
                        aliveTarget.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">游 ${compInfo.name} zabil nep콏칤tele!</div>`;
                        
                        // Aktualizuj UI pro mrtv칠ho nep콏칤tele
                        const enemyRowComp = document.querySelectorAll('.enemyRow')[targetIdx];
                        if (enemyRowComp) {
                            enemyRowComp.style.opacity = '0.3';
                            const statusSpanComp = enemyRowComp.querySelector('.enemyStatus');
                            if (statusSpanComp) statusSpanComp.innerHTML = `游 #${targetIdx+1}`;
                            const hpBarDeadComp = enemyRowComp.querySelector('.enemyHpBar');
                            if (hpBarDeadComp) hpBarDeadComp.style.background = '#333';
                        }
                    }
                });
            }
            
            // Update HP display
            const hpSpan = document.querySelectorAll('.enemyHp')[enemyIndex];
            if (hpSpan) hpSpan.textContent = Math.max(0, targetEnemy.hp);
            const hpBar = document.querySelectorAll('.enemyHpBar')[enemyIndex];
            if (hpBar) hpBar.style.width = Math.max(0, (targetEnemy.hp/targetEnemy.maxHp)*100) + '%';
            
            // Check if this enemy died
            if (targetEnemy.hp <= 0) {
                targetEnemy.alive = false;
                log.innerHTML += `<div style="color: #ffd700;">游 Zabil jsi #${enemyIndex+1}!</div>`;
                
                // Aktualizuj UI pro mrtv칠ho nep콏칤tele
                const enemyRow = document.querySelectorAll('.enemyRow')[enemyIndex];
                if (enemyRow) {
                    enemyRow.style.opacity = '0.3';
                    const statusSpan = enemyRow.querySelector('.enemyStatus');
                    if (statusSpan) statusSpan.innerHTML = `游 #${enemyIndex+1}`;
                    const hpBarDead = enemyRow.querySelector('.enemyHpBar');
                    if (hpBarDead) hpBarDead.style.background = '#333';
                }
                
                // Apply class passive onKill (Berserker Frenzy)
                const killPassive = getClassPassive('onKill');
                if (killPassive && killPassive.message) {
                    log.innerHTML += `<div style="color: #ff9800;">${killPassive.message}</div>`;
                }
                
                // Check if all enemies dead
                const stillAlive = enemyGroup.filter(e => e.alive);
                if (stillAlive.length === 0) {
                    // Victory!
                    state.stats.kills += enemyGroup.length;
                    let xpGain = targetEnemy.xp * enemyGroup.length;
                    
                    // Tracking (Hunter set 2) - +50% XP z lovu zv칤콏at
                    const setFxXP = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    if (setFxXP.tracking) {
                        const isAnimal = targetEnemy.id?.includes('wolf') || targetEnemy.id?.includes('rat') || 
                                        targetEnemy.id?.includes('dog') || targetEnemy.id?.includes('bear') ||
                                        targetEnemy.id?.includes('spider') || targetEnemy.id?.includes('frog') ||
                                        targetEnemy.name?.includes('Vlk') || targetEnemy.name?.includes('Krysa');
                        if (isAnimal) {
                            const bonusXP = Math.floor(xpGain * 0.5);
                            xpGain += bonusXP;
                            log.innerHTML += `<div style="color: #ffd700;">游꿢 Tracking: +${bonusXP} bonus XP z lovu!</div>`;
                        }
                    }
                    
                    addXP(xpGain);
                    
                    // Zm캩na reputace podle frakce nep콏칤tele
                    if (targetEnemy.faction) {
                        // Zabit칤 캜lena frakce zhor코칤 vztahy s touto frakc칤
                        changeReputation(targetEnemy.faction, -5 * enemyGroup.length, 'zabit칤 ' + targetEnemy.name);
                        
                        // Zabit칤 n치jezdn칤k콢 zlep코칤 vztahy s obchodn칤ky a vojensk칳m
                        if (targetEnemy.faction === 'raiders') {
                            changeReputation('traders', 2 * enemyGroup.length, 'ochrana obchodn칤k콢');
                            changeReputation('military', 1 * enemyGroup.length, 'eliminace hrozby');
                        }
                        // Zabit칤 mutant콢 zlep코칤 vztahy s vojensk칳m
                        if (targetEnemy.faction === 'mutants') {
                            changeReputation('military', 2 * enemyGroup.length, '캜i코t캩n칤 pustiny');
                        }
                    }
                    
                    // V ar칠n캩 쮂멳n칳 loot - jen XP
                    if (!state.inArena) {
                        // Loot from each enemy - seskup칤me
                        const lootGathered = {};
                        const resourcesGathered = {};
                        
                        enemyGroup.forEach(() => {
                            if (Math.random() < targetEnemy.chance && targetEnemy.loot.length > 0) {
                                const lootId = targetEnemy.loot[Math.floor(Math.random() * targetEnemy.loot.length)];
                                if (lootId === 'money') {
                                    const moneyGain = Math.floor(Math.random() * 75) + 30; // Zv칳코eno o 50%
                                    addMoney(moneyGain);
                                    log.innerHTML += `<div style="color: #ffd700;">游눯 Na코el jsi ${moneyGain} pen캩z!</div>`;
                                } else {
                                    const lootItem = ITEMS.find(i => i.id === lootId);
                                    if (lootItem) {
                                        // Pokud je to resource, p콏idej do resources
                                        if (lootItem.type === 'resource') {
                                            resourcesGathered[lootId] = (resourcesGathered[lootId] || 0) + 1;
                                        } else {
                                            // Jinak seskup do lootGathered
                                            lootGathered[lootId] = (lootGathered[lootId] || 0) + 1;
                                        }
                                    }
                                }
                            }
                        });
                        
                        // P콏idej resources do state.resources
                        for (const [id, amount] of Object.entries(resourcesGathered)) {
                            state.resources[id] = (state.resources[id] || 0) + amount;
                            const item = ITEMS.find(i => i.id === id);
                            log.innerHTML += `<div style="color: #ffd700;">游꾸 +${amount}x ${item?.icon || '游닍'} ${item?.name || id}</div>`;
                        }
                        
                        // P콏idej itemy do invent치콏e - seskupen칠
                        for (const [id, amount] of Object.entries(lootGathered)) {
                            const lootItem = ITEMS.find(i => i.id === id);
                            if (lootItem && canAddItem(lootItem, amount)) {
                                if (lootItem.type === 'consumable') {
                                    const existing = state.inv.find(i => i.id === id);
                                    if (existing) {
                                        existing.count = (existing.count || 1) + amount;
                                    } else {
                                        state.inv.push({...lootItem, count: amount});
                                    }
                                } else {
                                    // Pro non-consumables p콏idej jednotliv캩
                                    for (let i = 0; i < amount; i++) {
                                        state.inv.push({...lootItem});
                                    }
                                }
                                log.innerHTML += `<div style="color: #ffd700;">游꾸 +${amount}x ${lootItem.icon} ${lootItem.name}</div>`;
                            }
                        }
                    }
                    
                    // Extra loot for village raids! (ne v ar칠n캩)
                    if (window.isVillageRaid && !state.inArena) {
                        log.innerHTML += `<div style="color: #9c27b0; font-weight: bold;">游눑 VESNICE DOBYTA!</div>`;
                        
                        // Guaranteed good loot
                        const rareLoot = ITEMS.filter(i => (i.rarity === 'rare' || i.rarity === 'epic') && i.findChance > 0);
                        if (rareLoot.length > 0) {
                            const bonus = rareLoot[Math.floor(Math.random() * rareLoot.length)];
                            if (canAddItem(bonus, 1)) {
                                const existing = state.inv.find(i => i.id === bonus.id);
                                if (existing && bonus.type === 'consumable') {
                                    existing.count = (existing.count || 1) + 1;
                                } else {
                                    state.inv.push({...bonus, count: bonus.type === 'consumable' ? 1 : undefined});
                                }
                                log.innerHTML += `<div style="color: #9c27b0;">游눑 Bonus: ${bonus.icon} ${bonus.name}!</div>`;
                            }
                        }
                        
                        // Extra money
                        const bonusMoney = Math.floor(Math.random() * 200) + 100;
                        addMoney(bonusMoney);
                        log.innerHTML += `<div style="color: #ffd700;">游눯 Bonus: ${bonusMoney} pen캩z!</div>`;
                        
                        // Village raid completed
                        window.isVillageRaid = false;
                    }
                    
                    // Zkontroluj level up
                    const levelUpInfo = getPendingLevelUp();
                    let victoryText = `九 V칈T캨ZSTV칈! +${xpGain} XP`;
                    if (levelUpInfo) {
                        victoryText += `<br><span style="color: #ffd700; font-size: 1.1em;">游꿀 LEVEL ${levelUpInfo.level}!</span>`;
                        victoryText += `<br><span style="font-size: 0.85em;">+1 atribut | +1 skill | +1 strom</span>`;
                    }
                    
                    log.innerHTML += `<div style="color: #ffd700; font-weight: bold; margin-top: 0.5rem;">${victoryText}</div>`;
                    
                    // Companion bonusy po boji
                    const compBonuses = getAllCompanionBonuses();
                    
                    // MEDIC_NPC COMPANION - z치kladn칤 l칠캜en칤 +5 HP po boji (bez skillu)
                    const hasMedicCompanion = state.companions?.some(c => c.id === 'medic_npc' && !c.isDead);
                    if (hasMedicCompanion) {
                        const medicComp = state.companions.find(c => c.id === 'medic_npc' && !c.isDead);
                        const medicLevel = medicComp?.level || 1;
                        const baseHeal = 5 + (medicLevel - 1) * 2; // +5 base, +2 per level
                        
                        // L칠캜en칤 hr치캜e
                        const oldHp = state.char.hp;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + baseHeal);
                        const healed = state.char.hp - oldHp;
                        
                        // L칠캜en칤 radiace (1/3 z heal)
                        let radHealed = 0;
                        if (state.char.radiation > 0) {
                            const radHeal = Math.floor(baseHeal / 3);
                            const oldRad = state.char.radiation;
                            state.char.radiation = Math.max(0, state.char.radiation - radHeal);
                            radHealed = oldRad - state.char.radiation;
                        }
                        
                        // L칠캜en칤 ostatn칤ch companion콢
                        state.companions?.forEach(comp => {
                            if (!comp.isDead && comp.id !== 'medic_npc') {
                                comp.hp = Math.min(comp.maxHp || 80, comp.hp + Math.floor(baseHeal / 2));
                                if (comp.radiation > 0) {
                                    comp.radiation = Math.max(0, comp.radiation - Math.floor(baseHeal / 4));
                                }
                            }
                        });
                        
                        if (healed > 0 || radHealed > 0) {
                            log.innerHTML += `<div style="color: #81c784;">游녿꽥뚯勇 Poln칤 medik t캩 o코et콏il: +${healed} HP${radHealed > 0 ? `, -${radHealed} 驕뮖잺` : ''}</div>`;
                        }
                    }
                    
                    // healPlayerAfterCombat - l칠캜en칤 hr치캜e po boji (skill bonus)
                    if (compBonuses.healPlayerAfterCombat > 0) {
                        const healAmount = compBonuses.healPlayerAfterCombat;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                        log.innerHTML += `<div style="color: #81c784;">游 Spole캜n칤k t캩 o코et콏il: +${healAmount} HP</div>`;
                    }
                    
                    // regenAfterCombat - regenerace spole캜n칤k콢
                    if (compBonuses.regenAfterCombat > 0 && state.companions) {
                        state.companions.forEach(comp => {
                            if (comp.hp !== undefined && comp.hp < (comp.maxHp || 80)) {
                                comp.hp = Math.min(comp.maxHp || 80, comp.hp + compBonuses.regenAfterCombat);
                            }
                        });
                        log.innerHTML += `<div style="color: #81c784;">游 Spole캜n칤ci regeneruj칤: +${compBonuses.regenAfterCombat} HP</div>`;
                    }
                    
                    // fetchLoot - extra loot od spole캜n칤ka
                    if (compBonuses.fetchLoot && Math.random() < 0.5) {
                        const randomItem = ITEMS.filter(i => i.type === 'consumable' && i.findChance > 0.2)[Math.floor(Math.random() * 5)];
                        if (randomItem && canAddItem(randomItem, 1)) {
                            const existing = state.inv.find(i => i.id === randomItem.id);
                            if (existing) existing.count = (existing.count || 1) + 1;
                            else state.inv.push({...randomItem, count: 1});
                            log.innerHTML += `<div style="color: #81c784;">游 Spole캜n칤k na코el: ${randomItem.icon} ${randomItem.name}!</div>`;
                        }
                    }
                    
                    document.getElementById('attackBtn').style.display = 'none';
                    
                    // P콏idej tla캜칤tko OK
                    const okBtn = document.createElement('button');
                    okBtn.className = 'btn';
                    okBtn.style.cssText = 'width: 100%; margin-top: 1rem; background: var(--toxic-dark);';
                    okBtn.textContent = '九 Pokra캜ovat';
                    okBtn.onclick = function() {
                        closeModal();
                        if (state.world.resumeAfterCombat) {
                            state.world.resumeAfterCombat = false;
                            continueTravel();
                        }
                        renderFull();
                    };
                    document.getElementById('attackBtn').parentNode.appendChild(okBtn);
                    
                    addLog(`Boj vyhr치n! Zabil jsi ${enemyGroup.length}x ${targetEnemy.name}`, '丘덢잺');
                    state.stats.kills += enemyGroup.length;
                    if (state.dailyQuests.progress) {
                        state.dailyQuests.progress.kills = (state.dailyQuests.progress.kills || 0) + enemyGroup.length;
                        checkDailyQuests();
                    }
                    checkAchievements();
                    
                    // Kontrola pomoci p콏e쬴v코칤mu
                    if (state.helpingSurvivor) {
                        state.helpingSurvivor = false;
                        const reward = Math.floor(Math.random() * 100) + 50;
                        addMoney(reward);
                        setTimeout(() => {
                            showModal('游꿀 P콏e쬴v코칤 zachr치n캩n!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem;">游똂</div>
                                    <p>P콏e쬴v코칤 ti d캩kuje za z치chranu!</p>
                                    <p style="color: #ffd700; font-size: 1.2rem;">+${reward} 游눯</p>
                                </div>
                                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                            `);
                        }, 1500);
                        return;
                    }
                    
                    setTimeout(() => {
                        closeModal();
                        // Pokud byl boj b캩hem cestov치n칤, pokra캜uj v cest캩
                        if (state.world.resumeAfterCombat) {
                            state.world.resumeAfterCombat = false;
                            continueTravel();
                        }
                        renderFull();
                    }, 2000);
                    return;
                }
            }
            
            // Alive enemies attack
            const attackingEnemies = enemyGroup.filter(e => e.alive);
            attackingEnemies.forEach((enemy) => {
                const enemyNum = enemyGroup.indexOf(enemy) + 1;
                
                // 30% 코ance 쬰 nep콏칤tel za칰to캜칤 na spole캜n칤ka m칤sto na hr치캜e
                const aliveCompanions = state.companions?.filter(c => !c.isDead) || [];
                if (aliveCompanions.length > 0 && Math.random() < 0.3) {
                    const targetComp = aliveCompanions[Math.floor(Math.random() * aliveCompanions.length)];
                    const compInfo = COMPANIONS.find(c => c.id === targetComp.id);
                    
                    // Pou쬴j getCompanionStat pro defense v캜etn캩 bonus콢
                    const compDefense = getCompanionStat(targetComp, 'defense');
                    let compDmgTaken = enemy.damage + Math.floor(Math.random() * 3);
                    compDmgTaken = Math.max(1, compDmgTaken - compDefense);
                    
                    // 마nce na uhnut칤 spole캜n칤ka (5% + bonus ze skill콢)
                    const compDodge = 0.05 + (getCompanionStat(targetComp, 'dodgeChance') || 0);
                    if (Math.random() < compDodge) {
                        log.innerHTML += `<div style="color: #4caf50;">丘 ${compInfo?.icon || '游녻'} ${targetComp.name || compInfo?.name} uhnul 칰toku!</div>`;
                        return;
                    }
                    
                    targetComp.hp -= compDmgTaken;
                    log.innerHTML += `<div style="color: #ff9800;">游눤 #${enemyNum} zas치hl ${compInfo?.icon || '游녻'} ${targetComp.name || compInfo?.name} za ${compDmgTaken} DMG!</div>`;
                    
                    // Spole캜n칤k zem콏el
                    if (targetComp.hp <= 0) {
                        targetComp.hp = 0;
                        targetComp.isDead = true;
                        const deadName = targetComp.name || compInfo?.name || 'Spole캜n칤k';
                        log.innerHTML += `<div style="color: #c62828; font-weight: bold;">游 ${deadName} padl v boji!</div>`;
                        addLog(`游 ${deadName} zem콏el!`, '驕멆잺');
                    }
                    return; // Tento nep콏칤tel 칰to캜il na spole캜n칤ka
                }
                
                // Check for dodge (AGI based)
                const dodgeChance = calculateDodgeChance();
                if (Math.random() < dodgeChance) {
                    log.innerHTML += `<div style="color: #4caf50;">丘 Uhnul jsi 칰toku #${enemyNum}! (${Math.round(dodgeChance * 100)}% 코ance)</div>`;
                    return; // Skip this enemy's attack
                }
                
                let enemyDmg = enemy.damage + Math.floor(Math.random() * 5);
                
                // Defense reduction - pou쬴j NASAZEN칄 brn캩n칤
                const armor = state.equipped?.armor;
                let totalDefense = 0;
                
                if (armor && armor.defense) {
                    totalDefense += armor.defense;
                }
                
                // END bonus to defense (+1 per point above 5)
                const endDefense = Math.max(0, Math.floor((state.char.attrs.end - 5) * 1));
                totalDefense += endDefense;
                
                // Skill tree defense bonus
                totalDefense += getSkillTreeBonus('defense');
                
                // Aplikuj celkovou obranu
                enemyDmg = Math.max(1, enemyDmg - totalDefense);
                
                // Apply class passive onDamage
                const damagePassive = getClassPassive('onDamage', enemyDmg);
                if (damagePassive) {
                    enemyDmg = damagePassive.damage;
                    if (damagePassive.message) {
                        log.innerHTML += `<div style="color: #4caf50;">${damagePassive.message}</div>`;
                    }
                }
                
                // === SET BONUSY - OBRANA ===
                if (typeof getActiveSetEffects === 'function') {
                    const setFx = getActiveSetEffects();
                    
                    // Damage Reduction (survivor set 2) - -15% p콏ijat칳 damage
                    if (setFx.damageReduction > 0) {
                        const reduction = Math.floor(enemyDmg * setFx.damageReduction);
                        enemyDmg = Math.max(1, enemyDmg - reduction);
                        log.innerHTML += `<div style="color: #4caf50;">游띠勇 Set bonus: -${reduction} DMG</div>`;
                    }
                    
                    // Fortress Improved (tank set 3) - blokuje 40% m칤sto 25%
                    if (setFx.fortressImproved && state.char.classId === 'tank') {
                        const blockAmount = Math.floor(enemyDmg * 0.40);
                        enemyDmg = Math.max(1, enemyDmg - blockAmount);
                        log.innerHTML += `<div style="color: #2196f3;">游낋 Fortress: blokov치no ${blockAmount} DMG</div>`;
                    }
                    
                    // Mind Shield (psychic armor) - 30% 코ance ignorovat damage
                    if (setFx.mindShield && Math.random() < 0.30) {
                        log.innerHTML += `<div style="color: #9c27b0;">游댩 Mind Shield: 칔tok absorbov치n!</div>`;
                        return; // Skip damage
                    }
                    
                    // Unstoppable (berserker set 3) - nelze omr치캜it
                    // (implementov치no v stun efektu)
                    
                    // Thorns (tank set 2) - 15% damage zp캩t
                    if (setFx.thorns > 0) {
                        const thornsDmg = Math.floor(enemyDmg * setFx.thorns);
                        enemy.hp = (enemy.hp || 100) - thornsDmg;
                        log.innerHTML += `<div style="color: #ff9800;">游꺗 Thorns: ${thornsDmg} DMG zp캩t!</div>`;
                    }
                }
                
                state.char.hp -= enemyDmg;
                log.innerHTML += `<div style="color: #c62828;">游눤 #${enemyNum} t캩 zas치hl za ${enemyDmg} DMG!${totalDefense > 0 ? ` (游띠勇-${totalDefense})` : ''}</div>`;
                SoundSystem.play('combat_hit');
                
                // === EFEKTY OD NEP콎츼TEL NA HR츼캛E ===
                const enemyType = enemy.id || enemy.name?.toLowerCase() || '';
                const enemyWeapon = enemy.weapon || '';
                
                // Omr치캜en칤 (Stun) - t캩쬮칤 nep콏치tel칠 nebo s canStun
                const isHeavyEnemy = enemy.canStun || enemyType.includes('behemoth') || enemyType.includes('golem') || 
                                    enemyType.includes('tank') || enemyType.includes('boss') ||
                                    enemyType.includes('robot') || enemy.damage > 30;
                const setFxStun = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                if (isHeavyEnemy && Math.random() < 0.15) {
                    // Unstoppable (berserker set 3) - imunita
                    if (setFxStun.unstoppable) {
                        log.innerHTML += `<div style="color: #ff9800;">游눩 UNSTOPPABLE! Odolal jsi omr치캜en칤!</div>`;
                    } else {
                        state.char.stunned = true;
                        state.char.stunnedRounds = 1;
                        log.innerHTML += `<div style="color: #ffeb3b;">游눪 Byl jsi omr치캜en! P콏칤코t칤 kolo nem콢쬰코 칰to캜it!</div>`;
                    }
                }
                
                // Krv치cen칤 (Bleed) - ostr칠 zbran캩
                const isSharpEnemy = enemyWeapon.includes('dr치p') || enemyWeapon.includes('tes치k') ||
                                    enemyWeapon.includes('me캜') || enemyWeapon.includes('n콢') ||
                                    enemyType.includes('deathclaw') || enemyType.includes('vlk') ||
                                    enemyType.includes('wolf');
                if (isSharpEnemy && Math.random() < 0.20) {
                    state.char.bleeding = (state.char.bleeding || 0) + 3;
                    state.char.bleedRounds = Math.max(state.char.bleedRounds || 0, 3);
                    log.innerHTML += `<div style="color: #f44336;">游뽖 Krv치c칤코! (-3 HP/kolo po 3 kola)</div>`;
                    
                    // 마nce na infekci z 콏ezn칠 r치ny
                    if (Math.random() < 0.25 && typeof addDisease === 'function') {
                        if (!hasDisease('infection')) {
                            addDisease('infection');
                            log.innerHTML += `<div style="color: #ff5722;">游 R치na se infikovala! M치코 infekci!</div>`;
                        }
                    }
                }
                
                // Otrava (Poison) - jedovat칤 nep콏치tel칠 nebo s canPoison
                const isPoisonEnemy = enemy.canPoison || enemyType.includes('spider') || enemyType.includes('pavouk') ||
                                     enemyType.includes('snake') || enemyType.includes('had') ||
                                     enemyType.includes('scorpion') || enemyType.includes('코t칤r') ||
                                     enemyType.includes('toxic') || enemyType.includes('frog');
                if (isPoisonEnemy && Math.random() < 0.30) {
                    state.char.poisoned = Math.max(state.char.poisoned || 0, 5);
                    state.char.poisonRounds = Math.max(state.char.poisonRounds || 0, 4);
                    log.innerHTML += `<div style="color: #9c27b0;">驕멆잺 Byl jsi otr치ven! (-5 HP/kolo po 4 kola)</div>`;
                }
                
                // Zmaten칤 (Confusion) - psychi캜t칤 nep콏치tel칠 nebo s canConfuse
                const isPsychicEnemy = enemy.canConfuse || enemyType.includes('psychic') || enemyType.includes('psionic') ||
                                      enemyType.includes('brain') || enemyType.includes('ghost') || enemyType.includes('experiment');
                if (isPsychicEnemy && Math.random() < 0.20) {
                    if (setFxStun.unstoppable) {
                        log.innerHTML += `<div style="color: #ff9800;">游눩 UNSTOPPABLE! Odolal jsi zmaten칤!</div>`;
                    } else {
                        state.char.confused = 2;
                        log.innerHTML += `<div style="color: #9c27b0;">游댩 Jsi zmaten칳! P콏칤코t칤 칰tok m콢쬰 minout!</div>`;
                    }
                }
                
                // Pop치len칤 (Burn) - ohniv칳 nep콏치tel칠 nebo s canBurn
                const isFireEnemy = enemy.canBurn || enemyType.includes('fire') || enemyType.includes('flame') ||
                                   enemyType.includes('ohe켿') || enemyType.includes('dragon') ||
                                   enemyType.includes('glowing') || enemyWeapon.includes('laser');
                if (isFireEnemy && Math.random() < 0.25) {
                    state.char.burning = Math.max(state.char.burning || 0, 4);
                    state.char.burnRounds = Math.max(state.char.burnRounds || 0, 3);
                    log.innerHTML += `<div style="color: #ff5722;">游댠 Ho콏칤코! (-4 HP/kolo po 3 kola)</div>`;
                    
                    // 마nce na zran캩n칤 pop치lenina
                    if (Math.random() < 0.30 && typeof addInjury === 'function') {
                        addInjury('burn');
                    }
                }
                
                // Nemoc z kousnut칤/infekce od zombie nebo zv칤콏at
                const canInfect = enemy.canInfect || enemyType.includes('zombie') || enemyType.includes('ghoul');
                const isAnimalEnemy = enemyType.includes('rat') || enemyType.includes('krysa') ||
                                     enemyType.includes('dog') || enemyType.includes('pes') ||
                                     enemyType.includes('wolf') || enemyType.includes('vlk') ||
                                     enemyType.includes('bat') || enemyType.includes('netop칳r');
                if ((canInfect || isAnimalEnemy) && Math.random() < 0.15 && typeof addDisease === 'function') {
                    const possibleDiseases = canInfect ? ['infection', 'flu', 'parasites'] : ['flu', 'parasites'];
                    const randomDisease = possibleDiseases[Math.floor(Math.random() * possibleDiseases.length)];
                    if (!hasDisease(randomDisease)) {
                        addDisease(randomDisease);
                        const diseaseName = DISEASES[randomDisease]?.name || randomDisease;
                        log.innerHTML += `<div style="color: #ff5722;">游 Chytil jsi ${diseaseName}!</div>`;
                    }
                }
                
                // Screen shake when player takes damage
                screenShake(enemyDmg > 15 ? 8 : 5, 200);
            });
            
            document.getElementById('playerHp').textContent = Math.max(0, Math.round(state.char.hp));
            
            if (state.char.hp <= 0) {
                // Last Stand check (Survivor) - v캜etn캩 set bonus improved verze
                const lastStandPassive = getClassPassive('onDamage', 0);
                const setFx = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                const lastStandChance = setFx.lastStandImproved ? 0.35 : 0.25; // Set bonus: 35% m칤sto 25%
                
                if (lastStandPassive && state.char.hp <= 0 && Math.random() < lastStandChance) {
                    state.char.hp = 1;
                    log.innerHTML += `<div style="color: #ffd700;">游눩 LAST STAND${setFx.lastStandImproved ? ' (IMPROVED)' : ''}! P콏e쬴l jsi s 1 HP!</div>`;
                    document.getElementById('playerHp').textContent = 1;
                    return;
                }
                
                // Companion surviveChance (p콏e쮂셦 smrteln칳 칰tok)
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.surviveChance > 0 && Math.random() < compBonuses.surviveChance) {
                    state.char.hp = 1;
                    log.innerHTML += `<div style="color: #81c784;">游 Tv콢j spole캜n칤k t캩 zachr치nil! P콏e쬴l jsi s 1 HP!</div>`;
                    document.getElementById('playerHp').textContent = 1;
                    return;
                }
                
                // Companion resurrectChance (vzk콏칤코en칤 po smrti)
                if (compBonuses.resurrectChance > 0 && Math.random() < compBonuses.resurrectChance) {
                    state.char.hp = Math.floor(state.char.maxHp * 0.3);
                    log.innerHTML += `<div style="color: #ffd700;">九 Tv콢j spole캜n칤k t캩 vzk콏칤sil! HP obnoveno na 30%!</div>`;
                    document.getElementById('playerHp').textContent = state.char.hp;
                    return;
                }
                
                // Defeat
                log.innerHTML += `<div style="color: #c62828; font-weight: bold; margin-top: 0.5rem;">游 PROHR츼L JSI!</div>`;
                document.getElementById('attackBtn').disabled = true;
                state.stats.deaths++;
                SoundSystem.play('death');
                const deathText = 'Zem콏el jsi v boji!';
                const restartText = 'Restart hry';
                setTimeout(() => {
                    showModal('游 ' + t('death', 'youDied'), deathText + '<br><br><button class="btn" onclick="location.reload()" style="width: 100%;">' + restartText + '</button>');
                }, 1500);
            }
            
            log.scrollTop = log.scrollHeight;
        }
        
        function flee() {
            const fleeSuccessTitle = '칔t캩k';
            const fleeSuccessText = 'Poda콏ilo se ti ut칠ct!';
            const fleeFailTitle = '칔t캩k selhal!';
            
            if (Math.random() < 0.7) {
                showModal(fleeSuccessTitle, fleeSuccessText);
            } else {
                const enemy = window.currentEnemy;
                const dmg = Math.floor(enemy.data.damage * 0.5);
                state.char.hp -= dmg;
                const fleeFailText = `Nep콏칤tel t캩 zas치hl za ${dmg} DMG p콏i 칰t캩ku!`;
                showModal(fleeFailTitle, fleeFailText);
                if (state.char.hp <= 0) {
                    const deathFleeText = 'Zem콏el jsi p콏i 칰t캩ku!';
                    const restartText = 'Restart hry';
                    setTimeout(() => {
                        showModal('游 ' + t('death', 'youDied'), deathFleeText + '<br><br><button class="btn" onclick="location.reload()" style="width: 100%;">' + restartText + '</button>');
                    }, 1000);
                }
            }
            renderFull();
        }
        
        // === ACHIEVEMENTS ===
        function checkAchievements() {
            ACHIEVEMENTS.forEach(ach => {
                if (!state.achievements.includes(ach.id) && ach.check()) {
                    state.achievements.push(ach.id);
                    
                    // Zjisti jestli je otev콏en칳 n캩jak칳 modal (obchod, dialog...)
                    const modalOpen = document.getElementById('modal')?.style.display !== 'none';
                    
                    if (isInCombat() || modalOpen) {
                        // B캩hem boje nebo obchodu ulo pro pozd캩j코칤 zobrazen칤
                        if (!state._pendingAchievements) state._pendingAchievements = [];
                        state._pendingAchievements.push(ach);
                        addLog(`游끥 Achievement: ${ach.name}`, '游끥');
                    } else {
                        showModal('游끥 ACHIEVEMENT!', `<div style="text-align: center;"><div style="font-size: 4rem;">${ach.icon}</div><h3>${ach.name}</h3><p>${ach.desc}</p></div>`);
                    }
                }
            });
            
            // Zobraz odlo쬰n칠 achievementy kdy nen칤 modal
            const modalOpen = document.getElementById('modal')?.style.display !== 'none';
            if (!modalOpen && !isInCombat() && state._pendingAchievements?.length > 0) {
                const ach = state._pendingAchievements.shift();
                showModal('游끥 ACHIEVEMENT!', `<div style="text-align: center;"><div style="font-size: 4rem;">${ach.icon}</div><h3>${ach.name}</h3><p>${ach.desc}</p></div>`);
            }
        }
        
        // === SAVE/LOAD ===
        // Maxim치ln칤 bezpe캜n칠 hodnoty
        const MAX_MONEY = 999999999; // 999M
        const MAX_XP = Number.MAX_SAFE_INTEGER;
        
        function saveGame(silent = false) {
            // Ulo 캜as pro sync porovn치n칤
            state.lastSaveTime = Date.now();
            
            // Vy캜isti star칠 logy p콏ed ulo쬰n칤m (max 50 z치znam콢)
            if (state.log && state.log.length > 50) {
                state.log = state.log.slice(-50);
            }
            if (state.settlement?.eventLog && state.settlement.eventLog.length > 15) {
                state.settlement.eventLog = state.settlement.eventLog.slice(0, 15);
            }
            
            // === SANITIZACE HODNOT P콎ED ULO콯EN칈M ===
            if (state.money !== undefined) {
                state.money = Math.max(0, Math.min(MAX_MONEY, Math.floor(state.money)));
            }
            if (state.char?.hp !== undefined) {
                state.char.hp = Math.max(0, Math.min(state.char.maxHp || 9999, Math.floor(state.char.hp)));
            }
            if (state.char?.totalXP !== undefined) {
                state.char.totalXP = Math.max(0, Math.min(MAX_XP, Math.floor(state.char.totalXP)));
            }
            
            // Aktualizuj integrity check p콏ed ulo쬰n칤m
            if (typeof updateIntegrityCheck === 'function') updateIntegrityCheck();
            
            // V쬯y ulo쬴t JSON verzi (spolehliv칠)
            let jsonData;
            try {
                jsonData = JSON.stringify(state);
            } catch (e) {
                console.error('Chyba p콏i serializaci state:', e);
                if (!silent) {
                    showModal('Chyba', 'Nelze ulo쬴t - data obsahuj칤 neserializovateln칠 hodnoty.');
                }
                return;
            }
            
            try {
                localStorage.setItem('survival_hero_save', jsonData);
                localStorage.setItem('survival_hero_backup', jsonData);
            } catch(e) {
                console.error('Chyba p콏i ukl치d치n칤 do localStorage:', e);
                if (!silent) {
                    showModal('Chyba', 'Nelze ulo쬴t - 칰lo쬴코t캩 je pln칠 nebo blokovan칠.');
                }
                return;
            }
            
            // Zkus 코ifrovanou verzi (voliteln칠)
            try {
                if (typeof encryptData === 'function') {
                    const encrypted = encryptData(state);
                    if (encrypted) {
                        localStorage.setItem('survival_hero_save_v2', encrypted);
                    }
                }
            } catch(e) {
                console.warn('말frov치n칤 selhalo, pou쮂셨치m ne코ifrovanou verzi');
            }
            
            // Cloud save pro p콏ihl치코en칠 u쬴vatele (ka쬯칠 10. ulo쬰n칤 nebo p콏i ru캜n칤m ulo쬰n칤)
            if (currentUser && !currentUser.isAnonymous && typeof saveCloudSave === 'function') {
                if (!silent) {
                    // Ru캜n칤 ulo쬰n칤 - v쬯y ulo do cloudu
                    saveCloudSave();
                } else {
                    // Auto-save - ulo do cloudu jen ob캜as (ka쬯칳ch 5 minut 콏e코칤 interval)
                }
            }
            
            if (!silent) {
                showModal('Ulo쬰no!', 'Hra byla 칰sp캩코n캩 ulo쬰na.' + (currentUser && !currentUser.isAnonymous ? '<br><span style="color: #4CAF50;">驕勇 Tak칠 ulo쬰no do cloudu</span>' : ''));
            }
        }
        
        // Debouncovan치 verze pro 캜ast칠 automatick칠 ukl치d치n칤 (nap콏. v boji)
        const saveGameDebounced = debounce((silent) => saveGame(silent), 2000);
        
        // Validace struktury ulo쬰n칳ch dat
        function validateSaveData(data) {
            // Z치kladn칤 typ kontrola
            if (!data || typeof data !== 'object') return false;
            
            // Kritick칠 vlastnosti mus칤 existovat
            const criticalProps = ['char', 'status', 'time', 'inv'];
            for (const prop of criticalProps) {
                if (!data[prop]) {
                    console.warn(`validateSaveData: Chyb칤 kritick치 vlastnost '${prop}'`);
                    return false;
                }
            }
            
            // Char validace
            if (typeof data.char !== 'object') return false;
            if (typeof data.char.hp !== 'number' || isNaN(data.char.hp)) {
                console.warn('validateSaveData: Neplatn칠 HP');
                return false;
            }
            if (data.char.hp < 0 || data.char.hp > 99999) {
                console.warn('validateSaveData: HP mimo rozumn칳 rozsah');
                return false;
            }
            
            // Status validace
            if (typeof data.status !== 'object') return false;
            const statusProps = ['hunger', 'thirst', 'energy'];
            for (const prop of statusProps) {
                if (data.status[prop] !== undefined) {
                    if (typeof data.status[prop] !== 'number' || isNaN(data.status[prop])) {
                        console.warn(`validateSaveData: Neplatn칳 status.${prop}`);
                        return false;
                    }
                }
            }
            
            // Invent치콏 validace
            if (!Array.isArray(data.inv)) {
                console.warn('validateSaveData: Invent치콏 nen칤 pole');
                return false;
            }
            
            // Time validace
            if (typeof data.time !== 'object') return false;
            
            // Money validace (pokud existuje)
            if (data.money !== undefined) {
                if (typeof data.money !== 'number' || isNaN(data.money) || data.money < 0) {
                    console.warn('validateSaveData: Neplatn칠 money, resetuji na 0');
                    data.money = 0;
                }
                if (data.money > Number.MAX_SAFE_INTEGER) {
                    console.warn('validateSaveData: Money p콏ekra캜uje bezpe캜nou hodnotu');
                    data.money = Number.MAX_SAFE_INTEGER;
                }
            }
            
            return true;
        }
        
        function loadGame() {
            // Zkus na캜칤st 코ifrovanou verzi
            let saveData = localStorage.getItem('survival_hero_save_v2');
            let decrypted = null;
            
            if (saveData && typeof decryptData === 'function') {
                try {
                    decrypted = decryptData(saveData);
                } catch (e) {
                    console.warn('De코ifrov치n칤 selhalo:', e);
                    decrypted = null;
                }
            }
            
            // Fallback na starou verzi
            if (!decrypted) {
                const oldSave = localStorage.getItem('survival_hero_save');
                if (oldSave) {
                    try {
                        decrypted = JSON.parse(oldSave);
                    } catch(e) {
                        console.warn('Parsov치n칤 star칠ho save selhalo:', e);
                    }
                }
            }
            
            // Fallback na z치lohu
            if (!decrypted) {
                const backup = localStorage.getItem('survival_hero_backup');
                if (backup) {
                    try {
                        decrypted = JSON.parse(backup);
                    } catch(e) {
                        console.warn('Parsov치n칤 z치lohy selhalo:', e);
                    }
                }
            }
            
            if (decrypted) {
                // === VALIDACE P콎ED POU콯IT칈M ===
                if (!validateSaveData(decrypted)) {
                    console.error('Ulo쬰n치 hra nepro코la validac칤!');
                    showModal(
                        'Po코kozen치 hra',
                        'Ulo쬰n치 hra obsahuje neplatn치 data a nelze ji na캜칤st. Pros칤m, za캜ni novou hru nebo obnov ze z치lohy.'
                    );
                    return;
                }
                
                try {
                    state = decrypted;
                    // Reset timing references but keep totalElapsed
                    state.time.last = Date.now();
                    state.time.realStart = Date.now();
                    
                    // === MIGRACE - dopln캩n칤 chyb캩j칤c칤ch vlastnost칤 ===
                    migrateState();
                    
                    // Po na캜ten칤 v쬯y p콏epni na Online tab
                    state.activeTab = 'multiplayer';
                    
                    // Aktualizuj integrity check po na캜ten칤
                    if (typeof updateIntegrityCheck === 'function') updateIntegrityCheck();
                    
                    // === KONTROLA CHR츼N캨N칄HO NICKU ===
                    const nicknameCheck = checkProtectedNickname();
                    if (nicknameCheck instanceof Promise) {
                        // 캛ekej na ov캩콏en칤 hesla, pak zobraz "Na캜teno"
                        nicknameCheck.then(() => {
                            renderFull();
                            showModal('Na캜teno!', 'Hra byla 칰sp캩코n캩 na캜tena.');
                        });
                    } else {
                        renderFull();
                        showModal('Na캜teno!', 'Hra byla 칰sp캩코n캩 na캜tena.');
                    }
                } catch (e) {
                    console.error('Chyba p콏i na캜칤t치n칤 ulo쬰n칠 hry:', e);
                    showModal(
                        'Chyba',
                        'Ulo쬰n치 hra je po코kozen치. Pros칤m, za캜ni novou hru.'
                    );
                }
            } else {
                showModal('Chyba', 'Nebyla nalezena 쮂멳n치 ulo쬰n치 hra.');
            }
        }
        
        // Migrace star칳ch ulo쬰n칳ch her na novou verzi
        function migrateState() {
            console.log('游댃 Migrace ulo쬰n칠 hry...');
            
            // === KRITICK칄: Zajisti z치kladn칤 struktury ===
            if (!state.char) state.char = { name: 'Survivor', gender: null, level: 1, xp: 0, xpNeed: 400, totalXP: 0, hp: 100, maxHp: 100, attrs: { str: 5, int: 5, agi: 5, per: 5, end: 5, lck: 5 } };
            if (!state.status) state.status = { hunger: 100, thirst: 100, energy: 100, mood: 100, radiation: 0 };
            if (!state.time) state.time = { gameStart: Date.now(), realStart: Date.now(), last: Date.now(), days: 0, hours: 0, mins: 0, totalElapsed: 0 };
            if (!state.inv) state.inv = [];
            if (!state.equipped) state.equipped = { weapon: null, armor: null, gloves: null, boots: null };
            if (!state.resources) state.resources = { wood: 0, metal: 0, stone: 0, cloth: 0, fuel: 0, leather: 0, herbs: 0, chemicals: 0, electronics: 0, glass: 0, rope: 0, gunpowder: 0, scrap: 0, copper: 0 };
            
            // === KRITICK칄: Zajisti mainQuest strukturu ===
            if (!state.mainQuest) state.mainQuest = { currentQuest: 'intro', completedQuests: [], questProgress: {}, npcMet: [], storyComplete: false, chapter: 0 };
            if (!state.mainQuest.completedQuests) state.mainQuest.completedQuests = [];
            if (!state.mainQuest.questProgress) state.mainQuest.questProgress = {};
            if (!state.mainQuest.npcMet) state.mainQuest.npcMet = [];
            
            // === Oprava desetinn칠ho HP ===
            // === OPRAVA: HP bylo desetinn칠 ===
            if (state.char?.hp && !Number.isInteger(state.char.hp)) {
                console.warn('丘멆잺 Oprava: HP bylo desetinn칠:', state.char.hp);
                state.char.hp = Math.floor(state.char.hp);
            }
            
            // === XP MIGRACE A KONTROLA KONZISTENCE ===
            // Detekce po코kozen칠ho XP syst칠mu - totalXP mus칤 odpov칤dat level + xp
            if (state.char?.totalXP !== undefined && state.char.totalXP !== null) {
                // Spo캜칤tej kolik by m캩lo b칳t totalXP podle aktu치ln칤ho level a xp
                let expectedTotalXP = 0;
                for (let i = 1; i < (state.char.level || 1); i++) {
                    expectedTotalXP += Math.floor(350 * Math.pow(1.5, i - 1));
                }
                expectedTotalXP += (state.char.xp || 0);
                
                // Pokud totalXP neodpov칤d치 (rozd칤l > 10%), oprav ho
                const diff = Math.abs(state.char.totalXP - expectedTotalXP);
                const threshold = Math.max(100, expectedTotalXP * 0.1);
                
                if (diff > threshold) {
                    console.warn(`丘멆잺 XP NESOULAD DETEKOV츼N!`);
                    console.warn(`   TotalXP v ulo쬰n칠 h콏e: ${state.char.totalXP}`);
                    console.warn(`   O캜ek치van칠 podle level ${state.char.level} + xp ${state.char.xp}: ${expectedTotalXP}`);
                    console.warn(`   Opravuji totalXP na: ${expectedTotalXP}`);
                    state.char.totalXP = expectedTotalXP;
                }
            }
            
            // Pokud nem치 totalXP v콢bec, nastav podle aktu치ln칤ho xp
            if (state.char?.totalXP === undefined || state.char.totalXP === null) {
                state.char.totalXP = state.char.xp || 0;
                console.log(`游댢 Migrace totalXP: Nastaveno na ${state.char.totalXP}`);
            }
            
            // P콏epo캜칤tej level z totalXP (v쬯y - pro jistotu)
            if (typeof recalculateLevelFromTotalXP === 'function') {
                recalculateLevelFromTotalXP();
                console.log(`游늵 Po migraci: Level ${state.char.level}, XP: ${state.char.xp}/${state.char.xpNeed}, TotalXP: ${state.char.totalXP}`);
            }
            
            if (!state.map) state.map = { x: 0, y: 0, hexes: {}, inBase: true, traveling: false };
            if (!state.base) state.base = ['wall'];
            if (!state.skills_secondary) state.skills_secondary = { hunting: 0, mining: 0, fishing: 0 };
            if (!state.stats) state.stats = { kills: 0, explored: 0, crafted: 0, traveled: 0 };
            
            // === Migrace stashes (skr칳코e) ===
            if (!state.stashes) {
                state.stashes = {};
                console.log('游댢 Migrace: P콏id치na struktura stashes');
            }
            
            // === Migrace settlement struktury ===
            if (!state.settlement) {
                state.settlement = { level: 1, prosperity: 0, settlers: [], buildings: [], resources: { food: 10, water: 10 }, defense: 0 };
            }
            if (!state.settlement.settlers) state.settlement.settlers = [];
            if (!state.settlement.buildings) state.settlement.buildings = [];
            if (!state.settlement.resources) state.settlement.resources = { food: 10, water: 10 };
            if (!state.settlement.eventLog) state.settlement.eventLog = []; // Historie ud치lost칤
            
            // === Migrace dailyQuests struktury ===
            if (!state.dailyQuests) state.dailyQuests = { quests: [], completed: [], progress: {}, lastRefresh: 0 };
            if (!state.dailyQuests.completed) state.dailyQuests.completed = [];
            if (!state.dailyQuests.progress) state.dailyQuests.progress = {};
            
            // === Migrace NPC quest콢 - zajisti progress objekt ===
            if (state.npcQuests) {
                Object.keys(state.npcQuests).forEach(npcId => {
                    const quest = state.npcQuests[npcId];
                    if (quest && !quest.progress) {
                        console.log(`游댢 Migrace: P콏id치v치m progress pro quest ${quest.id}`);
                        quest.progress = { explored: 0, kills: 0, escortLocations: 0 };
                    }
                    // === Migrace talk quest콢 - automaticky spl켿 pokud je to talk quest ===
                    if (quest && quest.id && quest.progress) {
                        const questDef = NPC_QUESTS[quest.id];
                        if (questDef?.requirement?.talk && !quest.progress.talked) {
                            console.log(`游댢 Migrace: Opravuji talk quest ${quest.id} pro ${npcId}`);
                            quest.progress.talked = true;
                        }
                    }
                });
            }
            
            // === Migrace dungeon struktury ===
            if (state.dungeon) {
                // Zajisti 쬰 cleared existuje
                if (!state.dungeon.cleared) state.dungeon.cleared = {};
                if (!state.dungeon.loot) state.dungeon.loot = [];
            }
            
            // Oprava corrupted totalDailyQuestsCompleted (max realistick치 hodnota)
            // Hr치캜 m콢쬰 splnit max 3 denn칤 questy za den, tak쬰 limit je dny * 3
            const maxRealisticQuests = Math.max(20, (state.time?.days || 0) * 3);
            if (state.stats.totalDailyQuestsCompleted && state.stats.totalDailyQuestsCompleted > maxRealisticQuests) {
                console.log('丘멆잺 Oprava: totalDailyQuestsCompleted bylo corrupted:', state.stats.totalDailyQuestsCompleted, 'max realistic:', maxRealisticQuests);
                // Odhadni realistickou hodnotu podle dn콢 hran칤 (max 3 denn칤 questy za den)
                const daysPlayed = state.time?.days || 0;
                const realisticValue = Math.min(daysPlayed * 3, 50); // Max 50 jako fallback
                state.stats.totalDailyQuestsCompleted = realisticValue;
                console.log('丘멆잺 Oprava: totalDailyQuestsCompleted nastaveno na:', state.stats.totalDailyQuestsCompleted);
                notifyWarning('Oprava dat', 'Po캜et spln캩n칳ch quest콢 byl opraven (byla chyba v datech)');
            }
            
            // Aplikuj genetick칠 upgrady na maxHp (pokud existuj칤)
            if (state.geneticUpgrades && state.geneticUpgrades > 0) {
                const expectedMaxHp = 100 + (state.geneticUpgrades * 5);
                if (state.char.maxHp < expectedMaxHp) {
                    console.log('游빏 Aplikuji genetick칠 upgrady:', state.geneticUpgrades, '-> maxHp:', expectedMaxHp);
                    state.char.maxHp = expectedMaxHp;
                }
            }
            
            // Migrace: groundLoot syst칠m
            if (!state.world.groundLoot) state.world.groundLoot = {};
            
            // Pokud je to 캜erstv칳 import, p콏esko캜 destruktivn칤 migrace
            const isFreshImport = state._freshImport === true;
            if (isFreshImport) {
                console.log('九 캛erstv칳 import - p콏eskakuji destruktivn칤 migrace');
                delete state._freshImport;
                delete state._importTime;
            }
            
            // Migration: P콏esun resources z invent치콏e do state.resources
            // POUZE pokud nejde o fresh import (tam u jsou suroviny spr치vn캩)
            if (!isFreshImport) {
                const resourceIds = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
                const toRemove = [];
                state.inv.forEach((item, idx) => {
                    if (item.type === 'resource' || resourceIds.includes(item.id)) {
                        const count = item.count || 1;
                        state.resources[item.id] = (state.resources[item.id] || 0) + count;
                        toRemove.push(idx);
                        console.log(`游닍 Migrace: ${item.name || item.id} (${count}x) p콏esunuto do surovin`);
                    }
                });
                // Odstra켿 z invent치콏e (od konce aby indexy z콢staly spr치vn칠)
                for (let i = toRemove.length - 1; i >= 0; i--) {
                    state.inv.splice(toRemove[i], 1);
                }
            }
            
            // Migration: Fix item types - dopl켿 chyb캩j칤c칤 type z ITEMS definice
            state.inv.forEach(item => {
                const itemDef = ITEMS.find(i => i.id === item.id);
                if (itemDef) {
                    // Dopl켿 chyb캩j칤c칤 type
                    if (!item.type) item.type = itemDef.type;
                    // Dopl켿 i dal코칤 chyb캩j칤c칤 vlastnosti
                    if (item.defense === undefined && itemDef.defense !== undefined) item.defense = itemDef.defense;
                    if (item.damage === undefined && itemDef.damage !== undefined) item.damage = itemDef.damage;
                    if (item.weight === undefined && itemDef.weight !== undefined) item.weight = itemDef.weight;
                    if (!item.icon && itemDef.icon) item.icon = itemDef.icon;
                    // D콡LE콯IT칄: V쬯y oprav jm칠no na 캜esk칠 z ITEMS!
                    if (itemDef.name) item.name = itemDef.name;
                    // D콡LE콯IT칄: ammoType pro st콏eln칠 zbran캩!
                    if (item.ammoType === undefined && itemDef.ammoType !== undefined) item.ammoType = itemDef.ammoType;
                    // Bonus pro n치stroje (hunting, fishing, etc.)
                    if (item.bonus === undefined && itemDef.bonus !== undefined) item.bonus = itemDef.bonus;
                    // Efekty pro consumables
                    if (item.effect === undefined && itemDef.effect !== undefined) item.effect = itemDef.effect;
                    if (item.value === undefined && itemDef.value !== undefined) item.value = itemDef.value;
                    // D콡LE콯IT칄: special pro speci치ln칤 efekty (rad_immune, rad_resist, block, etc.)
                    if (item.special === undefined && itemDef.special !== undefined) item.special = itemDef.special;
                } else {
                    // Pokud nen칤 v ITEMS, zkus RECIPES (uva콏en칠 j칤dlo, lektvary)
                    const recipeDef = RECIPES.find(r => r.id === item.id);
                    if (recipeDef) {
                        if (!item.name && recipeDef.name) item.name = recipeDef.name;
                        if (!item.icon && recipeDef.icon) item.icon = recipeDef.icon;
                        if (!item.type) item.type = 'consumable';
                    }
                }
            });
            
            // Migration: Fix equipped items too!
            if (state.equipped) {
                Object.keys(state.equipped).forEach(slot => {
                    const item = state.equipped[slot];
                    if (item && item.id) {
                        const itemDef = ITEMS.find(i => i.id === item.id);
                        if (itemDef) {
                            if (item.ammoType === undefined && itemDef.ammoType !== undefined) item.ammoType = itemDef.ammoType;
                            if (item.damage === undefined && itemDef.damage !== undefined) item.damage = itemDef.damage;
                            if (item.defense === undefined && itemDef.defense !== undefined) item.defense = itemDef.defense;
                            // D콡LE콯IT칄: Oprav 캜esk칠 jm칠no!
                            if (itemDef.name) item.name = itemDef.name;
                            if (!item.icon && itemDef.icon) item.icon = itemDef.icon;
                            // D콡LE콯IT칄: special pro speci치ln칤 efekty (rad_immune, rad_resist, block, etc.)
                            if (item.special === undefined && itemDef.special !== undefined) item.special = itemDef.special;
                        }
                    }
                });
            }
            
            // Migration: Add durability to old weapons/armor that don't have it
            state.inv.forEach(item => {
                if ((item.type === 'weapon' || item.type === 'armor') && item.durability === undefined) {
                    item.durability = 100;
                    item.maxDurability = 100;
                }
            });
            
            // Migration: Fix settler skillLevel (p콏evod z level na skillLevel)
            if (state.settlement?.settlers) {
                state.settlement.settlers.forEach(settler => {
                    // Pokud m치 level ale ne skillLevel, p콏eve캞
                    if (settler.level && !settler.skillLevel) {
                        settler.skillLevel = settler.level;
                    }
                    // Zajisti 쬰 skillLevel existuje
                    if (!settler.skillLevel) settler.skillLevel = 1;
                    // Zajisti 쬰 xp existuje
                    if (!settler.xp) settler.xp = 0;
                });
            }
            
            // Migration: Fix dynamic companions (rescued survivors)
            if (state.companions) {
                state.companions.forEach(comp => {
                    // Najdi definici z COMPANIONS pro nastaven칤 spr치vn칳ch hodnot
                    const baseDef = COMPANIONS.find(c => c.id === comp.id);
                    
                    // Zajisti 쬰 dynami캜t칤 spole캜n칤ci maj칤 v코echny pot콏ebn칠 vlastnosti
                    // Priorita: existuj칤c칤 hodnota > hodnota z definice > fallback
                    if (!comp.type) comp.type = baseDef?.type || 'human';
                    if (!comp.equipped) comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null };
                    if (comp.equipment && !comp.equipped) {
                        comp.equipped = comp.equipment;
                        delete comp.equipment;
                    }
                    // Lid칠 a survivor v쬯y mohou m칤t vybaven칤
                    if (comp.canEquip === undefined) {
                        comp.canEquip = (comp.type === 'human' || comp.id === 'survivor' || baseDef?.type === 'human');
                    }
                    if (comp.inCombat === undefined) comp.inCombat = true;
                    if (!comp.skills) comp.skills = [];
                    if (comp.skillPoints === undefined) comp.skillPoints = 0;
                    
                    // Speci치ln칤 oprava pro freed_slave / survivor spole캜n칤ky
                    if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                        comp.type = 'human';
                        comp.canEquip = true;
                        if (!comp.id) comp.id = 'survivor';
                    }
                });
            }
            
            // Migration: Add building cooldowns if missing
            if (!state.buildingCooldowns) {
                state.buildingCooldowns = {
                    hospitals: {},
                    workshops: {},
                    factories: {}
                };
            }
            
            // Migration: Update base capacity to 40 (was 20 in old saves)
            if (state.baseCapacity < 40) {
                let bonusCapacity = 0;
                if (state.base && state.base.includes('warehouse')) bonusCapacity += 30;
                if (state.base && state.base.includes('cryo_storage')) bonusCapacity += 50;
                state.baseCapacity = 40 + bonusCapacity;
            }
            
            // Migration: Add factions if missing
            if (!state.factions) {
                state.factions = { traders: 0, scientists: 0, raiders: -20, mutants: 0, military: 0 };
            }
            
            // Migration: Add dailyQuests progress if missing
            if (!state.dailyQuests) {
                state.dailyQuests = { lastReset: Date.now(), quests: [], completed: [], progress: {} };
            }
            if (!state.dailyQuests.progress) {
                state.dailyQuests.progress = { kills: 0, explored: 0, crafted: 0, moneyEarned: 0, travelled: 0, cooked: 0, sold: 0, bought: 0 };
            }
            // Ensure cooked exists for old saves
            if (state.dailyQuests.progress.cooked === undefined) {
                state.dailyQuests.progress.cooked = 0;
            }
            
            // Migration: Add world system if missing
            if (!state.world) {
                state.world = {
                    currentLocation: 'shelter',
                    visitedLocations: ['shelter'],
                    traveling: false,
                    travelTo: null,
                    travelStart: null,
                    travelDuration: null,
                    scheduledEvents: []
                };
            }
            
            // Migration: Add scheduledEvents array if missing
            if (!state.world.scheduledEvents) {
                state.world.scheduledEvents = [];
            }
            
            // Migration: Add firstTravelDone flag
            if (state.firstTravelDone === undefined) {
                // Pokud u m치 spole캜n칤ka nebo odm칤tl psa, tak firstTravelDone = true
                state.firstTravelDone = (state.companions?.length > 0) || (state.rejectedCompanions?.length > 0);
            }
            
            // Migration: Add companions array if missing
            if (!state.companions) {
                state.companions = [];
            }
            
            // Migration: Add rejectedCompanions array if missing
            if (!state.rejectedCompanions) {
                state.rejectedCompanions = [];
            }
            
            // Migration: Add caravan system if missing
            if (!state.caravan) {
                state.caravan = { active: false, until: 0, nextCheck: Date.now() + 3600000 };
            }
            if (!state.caravan.nextCheck) {
                state.caravan.nextCheck = Date.now() + 3600000;
            }
            
            // Migration: Add settlement raid check if missing
            if (!state.settlement) {
                state.settlement = { settlers: [], buildings: [], prosperity: 0 };
            }
            if (!state.settlement.nextRaidCheck) {
                state.settlement.nextRaidCheck = Date.now() + 300000;
            }
            
            // Migration: Add NPC quests if missing
            if (!state.npcQuests) {
                state.npcQuests = {};
            }
            
            // Migration: Add NPC trust if missing
            if (!state.npcTrust) {
                state.npcTrust = {};
            }
            
            // Migration: Add NPC relations if missing
            if (!state.npcRelations) {
                state.npcRelations = {};
            }
            
            // Migration: Add Bucovice karma if missing
            if (!state.storyKarma) {
                state.storyKarma = {
                    kory: 0,
                    koudy: 0,
                    componentsGiven: { kory: 0, koudy: 0 },
                    ending: null
                };
            }
            
            // Migration: Add karma for NPC quests if missing
            if (!state.karma) {
                state.karma = { kory: 0, koudy: 0 };
            }
            
            // Migration: Convert old story quests to new story
            const oldQuestIds = ['find_diary', 'return_diary', 'find_scientist', 'get_chemicals', 'return_chemicals', 'find_general', 'save_humanity'];
            if (state.mainQuest?.currentQuest && oldQuestIds.includes(state.mainQuest.currentQuest)) {
                console.log('游댃 Migrace: Star칳 p콏칤b캩h -> Nov칳 p콏칤b캩h "Projekt Genesis"');
                
                // Zjisti jak daleko byl hr치캜 ve star칠m p콏칤b캩hu
                const oldProgress = oldQuestIds.indexOf(state.mainQuest.currentQuest);
                
                // Mapov치n칤 star칠ho progressu na nov칳
                let newQuest = 'intro';
                if (oldProgress >= 5) { // find_general nebo save_humanity
                    newQuest = 'third_component'; // Kapitola 3
                } else if (oldProgress >= 3) { // get_chemicals nebo return_chemicals
                    newQuest = 'second_component'; // Kapitola 2
                } else if (oldProgress >= 1) { // find_diary nebo return_diary
                    newQuest = 'meet_brothers'; // Kapitola 1
                }
                
                state.mainQuest.currentQuest = newQuest;
                state.mainQuest.questProgress = {};
                state.mainQuest.completedQuests = state.mainQuest.completedQuests?.filter(q => !oldQuestIds.includes(q)) || [];
                
                const newQuestData = MAIN_QUESTS.find(q => q.id === newQuest);
                if (newQuestData) {
                    state.mainQuest.chapter = newQuestData.chapter;
                }
                
                // Odstra켿 star칠 quest itemy
                state.inv = state.inv?.filter(item => !['military_diary', 'chemicals', 'antivirus'].includes(item.id)) || [];
                
                notifyInfo('游닀 P콏칤b캩h aktualizov치n!', 'Nov칳 p콏칤b캩h: Projekt Genesis - Dva brat콏i');
            }
            
            // Migration: Add stats if missing
            if (!state.stats) {
                state.stats = { kills: 0, deaths: 0, crafted: 0, travelled: 0 };
            }
            
            // Migration: Fix stuck quests - if currentQuest is in completedQuests, move to next
            if (state.mainQuest?.currentQuest && state.mainQuest?.completedQuests?.includes(state.mainQuest.currentQuest)) {
                const completedQuest = MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
                if (completedQuest && completedQuest.nextQuest) {
                    console.log(`游댢 Opravuji zasekl칳 quest: ${state.mainQuest.currentQuest} -> ${completedQuest.nextQuest}`);
                    state.mainQuest.currentQuest = completedQuest.nextQuest;
                    state.mainQuest.questProgress = {};
                    const nextQuest = MAIN_QUESTS.find(q => q.id === completedQuest.nextQuest);
                    if (nextQuest) {
                        state.mainQuest.chapter = nextQuest.chapter;
                        // Spawn quest item pokud je pot콏eba
                        if (nextQuest.spawnItem) {
                            if (!state.world.questItems) state.world.questItems = {};
                            state.world.questItems[nextQuest.spawnItem.location] = nextQuest.spawnItem.id;
                        }
                    }
                } else if (completedQuest && completedQuest.ending) {
                    state.mainQuest.currentQuest = null;
                    state.mainQuest.storyComplete = true;
                }
            }
            
            // Migration: Add world.questItems if missing
            if (!state.world.questItems) {
                state.world.questItems = {};
            }
            
            // Migration: Add equipped if missing
            if (!state.equipped) {
                state.equipped = { weapon: null, armor: null };
            }
            
            // Migration: Add starterToolChosen (existuj칤c칤 hry u maj칤 n치stroj)
            if (state.starterToolChosen === undefined) {
                state.starterToolChosen = true; // Star칠 save soubory u maj칤 n치stroje
            }
            
            // Migration: Add achievements if missing
            if (!state.achievements) {
                state.achievements = [];
            }
            
            // Migration: Add resources if missing
            if (!state.resources) {
                state.resources = {};
            }
            
            // Migration: Recalculate prosperity based on existing buildings
            if (state.base && state.settlement) {
                const baseBuildingCount = state.base.length || 0;
                const settlementBuildingCount = state.settlement.buildings?.length || 0;
                const minProsperity = (baseBuildingCount * 5) + (settlementBuildingCount * 20);
                if (state.settlement.prosperity < minProsperity) {
                    state.settlement.prosperity = Math.min(100, minProsperity);
                    console.log(`游댢 P콏epo캜칤t치na prosperita: ${state.settlement.prosperity}`);
                }
            }
            
            // Migration: Reschedule travel events if traveling but no events scheduled
            if (state.world.traveling && state.world.scheduledEvents.length === 0) {
                const now = Date.now();
                const timeElapsed = now - state.world.travelStart;
                const timeRemaining = state.world.travelDuration - timeElapsed;
                
                if (timeRemaining > 0) {
                    // Napl치nuj n치hodn칳 event
                    const eventTime = now + (timeRemaining * (0.3 + Math.random() * 0.4));
                    state.world.scheduledEvents.push({
                        type: 'random',
                        triggerAt: eventTime,
                        dangerLevel: state.world.travelPath?.danger || 0,
                        triggered: false
                    });
                    console.log('游늰 Napl치nov치n chyb캩j칤c칤 travel event');
                }
            }
            
            // Migration: Add first lore book if missing
            if (!state.inv.some(i => i.id === 'lore_1') && !state.firstLoreGiven) {
                state.inv.push({ id: 'lore_1', name: 'Den칤k v캩dce I', icon: '游늿', type: 'lore', weight: 0, price: 0, rarity: 'rare' });
                state.firstLoreGiven = true;
                console.log('游늿 P콏id치na prvn칤 kniha do invent치콏e');
                notifyInfo('游늿 Nov칳 p콏edm캩t!', 'Na코el jsi star칳 den칤k v 칰krytu...');
            }
            
            // Migration: Add readBooks array if missing
            if (!state.readBooks) {
                state.readBooks = [];
            }
            
            // Migration: Add casinoLastTokenTime if missing (for 24h real-time bonus)
            if (state.casinoLastTokenTime === undefined || state.casinoLastTokenTime === 0) {
                // Pokud m치 hr치캜 u n캩jak칠 쬰tony nad 1000, pravd캩podobn캩 u bonus dostal
                // Nastav칤me 캜as na "te캞" aby nedostal hned dal코칤
                state.casinoLastTokenTime = Date.now();
                console.log('游꿣 Migrace: Nastaven casinoLastTokenTime');
            }
            
            // Migration: Add lastFreeHerbs if missing (bylinky od Marty)
            if (state.lastFreeHerbs === undefined || state.lastFreeHerbs === 0) {
                // Nastav칤me 캜as na "te캞" aby nedostal hned bylinky
                state.lastFreeHerbs = Date.now();
                console.log('游 Migrace: Nastaven lastFreeHerbs');
            }
            
            // Migration: Add buildQueue if missing (fronta budov)
            if (!state.buildQueue) {
                state.buildQueue = [];
                console.log('游끵勇 Migrace: P콏id치no buildQueue');
            }
            
            // Migration: FIX ITEM TYPES - opravit itemy kter칠 maj칤 코patn칳 type
            const helmetIds = ['helmet_basic', 'helmet_craft', 'helmet', 'gas_mask', 'gas_mask_craft', 
                              'tactical_helmet', 'ballistic_helmet', 'rad_helmet', 'cap', 'hard_hat', 
                              'motorcycle_helmet', 'welding_mask', 'hazmat_helmet'];
            const glovesIds = ['work_gloves', 'leather_gloves', 'combat_gloves', 'tactical_gloves', 
                              'spiked_gloves', 'power_gloves', 'arm_guards'];
            const bootsIds = ['hiking_boots', 'combat_boots', 'stealth_boots', 'leg_guards', 
                             'running_shoes', 'steel_boots', 'sandals'];
            
            state.inv.forEach(item => {
                if (helmetIds.includes(item.id) && item.type !== 'helmet') {
                    item.type = 'helmet';
                }
                if (glovesIds.includes(item.id) && item.type !== 'gloves') {
                    item.type = 'gloves';
                }
                if (bootsIds.includes(item.id) && item.type !== 'boots') {
                    item.type = 'boots';
                }
                if (['helmet', 'gloves', 'boots'].includes(item.type) && item.durability === undefined) {
                    item.durability = 100;
                    item.maxDurability = 100;
                }
            });
            
            // V쬯y ov캩콏 XP syst칠m po na캜ten칤
            const loadXpNeed = 350 + (state.char.level * 50);
            if (state.char.xpNeed !== loadXpNeed) {
                console.log(`游댢 Load: Oprava xpNeed ${state.char.xpNeed}  ${loadXpNeed}`);
                state.char.xpNeed = loadXpNeed;
            }
            
            // === KONTROLA VECH QUEST PROGRESS PO NA캛TEN칈 ===
            // Zajist칤 쬰 questy se aktualizuj칤 pokud u hr치캜 je v c칤lov칠 lokaci
            setTimeout(() => {
                const currentLoc = state.world?.currentLocation;
                if (!currentLoc) return;
                
                // 1. Main quest - p콏칤b캩hov칠 questy
                if (state.mainQuest?.currentQuest && typeof updateQuestProgress === 'function') {
                    updateQuestProgress('location', currentLoc);
                }
                
                // 2. Timed questy - 캜asov캩 omezen칠
                if (state.timedQuests?.length > 0 && typeof checkTimedQuestObjectives === 'function') {
                    checkTimedQuestObjectives('location', currentLoc);
                }
                
                // 3. Companion questy
                if (state.companions?.length > 0 && typeof checkCompanionQuestObjectives === 'function') {
                    checkCompanionQuestObjectives('location', currentLoc);
                }
                
                // 4. Daily questy - zkontroluj progress
                if (typeof checkDailyQuests === 'function') {
                    checkDailyQuests();
                }
                
                console.log('游댃 Quest progress zkontrolov치n po na캜ten칤');
            }, 200);
            
            // === VALIDACE INVENT츼콎E ===
            if (typeof validateInventory === 'function') {
                const invReport = validateInventory();
                if (invReport.fixed > 0 || invReport.removed > 0) {
                    console.log(`游 Inventory validation: ${invReport.fixed} fixed, ${invReport.removed} removed`);
                }
            }
            
            // === MIGRACE: Dopln캩n칤 price/weight/rarity do star칳ch item콢 ===
            if (state.inv && state.inv.length > 0) {
                let fixedItems = 0;
                state.inv.forEach(item => {
                    if (!item.id) return;
                    const itemDef = ITEMS.find(i => i.id === item.id);
                    if (itemDef) {
                        let fixed = false;
                        if (!item.price && itemDef.price) { item.price = itemDef.price; fixed = true; }
                        if (!item.weight && itemDef.weight) { item.weight = itemDef.weight; fixed = true; }
                        if (!item.rarity && itemDef.rarity) { item.rarity = itemDef.rarity; fixed = true; }
                        if (!item.type && itemDef.type) { item.type = itemDef.type; fixed = true; }
                        if (fixed) fixedItems++;
                    }
                });
                if (fixedItems > 0) {
                    console.log(`游눯 Migrace: Dopln캩ny chyb캩j칤c칤 vlastnosti u ${fixedItems} item콢`);
                }
            }
            
            // === KRITICK츼 OPRAVA: Znovu propojit equipped itemy s invent치콏em ===
            // Po deserializaci z JSON jsou equipped itemy kopie, ne reference
            // Mus칤me je propojit zp캩t na skute캜n칠 objekty v state.inv
            if (state.equipped) {
                ['weapon', 'armor', 'helmet', 'gloves', 'boots'].forEach(slot => {
                    if (state.equipped[slot]) {
                        const equippedItem = state.equipped[slot];
                        
                        // P콏idej unik치tn칤 ID pokud chyb칤
                        if (!equippedItem._uniqueId) {
                            equippedItem._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                        
                        // Najdi odpov칤daj칤c칤 item v invent치콏i
                        // Priorita 1: p콏esn치 shoda podle _uniqueId
                        let matchingItem = state.inv.find(i => i._uniqueId === equippedItem._uniqueId);
                        
                        // Priorita 2: shoda podle ID, typu a durability
                        if (!matchingItem) {
                            matchingItem = state.inv.find(i => 
                                i.id === equippedItem.id && 
                                i.type === equippedItem.type &&
                                i.durability === equippedItem.durability &&
                                !isItemEquippedInOtherSlot(i, slot)
                            );
                        }
                        
                        // Priorita 3: shoda jen podle ID a typu (pro star칠 save)
                        if (!matchingItem) {
                            matchingItem = state.inv.find(i => 
                                i.id === equippedItem.id && 
                                i.type === equippedItem.type &&
                                !isItemEquippedInOtherSlot(i, slot)
                            );
                        }
                        
                        if (matchingItem) {
                            // Zkop칤ruj _uniqueId na matching item
                            matchingItem._uniqueId = equippedItem._uniqueId;
                            // Propoj referenci
                            state.equipped[slot] = matchingItem;
                            console.log(`游댕 Equipped ${slot} propojen: ${matchingItem.name}`);
                        } else {
                            // Item nen칤 v invent치콏i - p콏idej ho tam!
                            console.warn(`丘멆잺 Equipped ${slot} "${equippedItem.name}" nebyl v invent치콏i - p콏id치v치m`);
                            state.inv.push(equippedItem);
                            // Te캞 propoj referenci
                            state.equipped[slot] = equippedItem;
                        }
                    }
                });
            }
            
            // Pomocn치 funkce - kontroluje jestli item je equipped v jin칠m slotu
            function isItemEquippedInOtherSlot(item, currentSlot) {
                const slots = ['weapon', 'armor', 'helmet', 'gloves', 'boots'];
                for (const slot of slots) {
                    if (slot !== currentSlot && state.equipped[slot] === item) {
                        return true;
                    }
                }
                return false;
            }
            
            console.log('九 Migrace dokon캜ena');
        }
        
        function toggleSound() {
            const enabled = SoundSystem.toggle();
            const btn = document.getElementById('soundBtn');
            if (btn) {
                btn.textContent = enabled ? '游댉' : '游댆';
                btn.style.background = enabled ? '#555' : '#c62828';
            }
            if (enabled) {
                SoundSystem.play('pickup');
            }
        }
        
        // Funkce pro opravu po코kozen칠ho totalXP
        window.fixTotalXP = function() {
            const input = document.getElementById('fixTotalXP');
            if (!input) return;
            
            const newTotalXP = parseInt(input.value) || 0;
            if (newTotalXP < 0) {
                notifyWarning('Chyba', 'XP nem콢쬰 b칳t z치porn칠!');
                return;
            }
            
            state.char.totalXP = newTotalXP;
            recalculateLevelFromTotalXP();
            saveGame();
            closeModal();
            renderFull();
            notifySuccess('XP opraveno!', `Nov칳 level: ${state.char.level}, XP: ${state.char.xp}/${state.char.xpNeed}`);
        };
        
        // === V칗B캨R JAZYKA ===
        // Info o polo쬶치ch v horn칤 li코t캩 - glob치ln칤 funkce
        window.showStatInfo = function(statType) {
            // Kontrola 쬰 state existuje
            if (!state || !state.char) {
                console.log('State not ready');
                return;
            }
            
            let title = '';
            let content = '';
            
            switch(statType) {
                case 'name':
                    const classData = CLASSES[state.char.classId];
                    const attrs = state.char.attrs || state.char.stats || {};
                    
                    // V칳po캜et efektivn칤ch stat콢 (z치klad + bonusy)
                    const baseStats = {
                        strength: attrs.str || attrs.strength || 5,
                        endurance: attrs.end || attrs.endurance || 5,
                        agility: attrs.agi || attrs.agility || 5,
                        perception: attrs.per || attrs.perception || 5,
                        intelligence: attrs.int || attrs.intelligence || 5,
                        luck: attrs.lck || attrs.luck || 5
                    };
                    
                    // Bonusy z povol치n칤
                    const classBonuses = classData?.bonuses || {};
                    
                    // Bonusy z buff콢
                    const buffBonus = (state.buffs?.allStats && state.buffs.allStats.until > Date.now()) ? Math.floor(state.buffs.allStats.value / 5) : 0;
                    
                    // Celkov칠 staty
                    const totalStats = {
                        strength: baseStats.strength + (classBonuses.str || 0) + buffBonus,
                        endurance: baseStats.endurance + (classBonuses.end || 0) + buffBonus,
                        agility: baseStats.agility + (classBonuses.agi || 0) + buffBonus,
                        perception: baseStats.perception + (classBonuses.per || 0) + buffBonus,
                        intelligence: baseStats.intelligence + (classBonuses.int || 0) + buffBonus,
                        luck: baseStats.luck + (classBonuses.lck || 0) + buffBonus
                    };
                    
                    // V칳po캜et odvozen칳ch hodnot - SJEDNOCENO s hlavn칤m UI (z치lo쬶a P콎E콯IV먞)
                    // Pou쬴j Z츼KLADN칈 atributy (state.char.attrs), ne totalStats
                    let damage = 5 + state.char.attrs.str;
                    const weapon = state.equipped?.weapon;
                    if (weapon) damage += weapon.damage || 0;
                    // Raider class bonus +30%
                    if (state.char.classId === 'raider') damage = Math.floor(damage * 1.3);
                    // Armory bonus +10%
                    if (state.base?.includes('armory')) damage = Math.floor(damage * 1.1);
                    // Skill tree bonus
                    if (typeof getSkillTreeBonus === 'function') {
                        damage = Math.floor(damage * (1 + getSkillTreeBonus('damageBonus')));
                    }
                    
                    // Obrana - pou쬴j calculateDefense() pro spr치vn칳 v칳po캜et
                    let defense = typeof calculateDefense === 'function' ? calculateDefense() : 0;
                    const armor = state.equipped?.armor;
                    
                    // Crit chance - pou쬴j calculateCritChance() pro spr치vn칳 v칳po캜et
                    const critChance = typeof calculateCritChance === 'function' ? Math.round(calculateCritChance() * 100) : 5;
                    
                    // Dodge chance - pou쬴j calculateDodgeChance() pro spr치vn칳 v칳po캜et
                    let armorEffects = { bonusDefense: 0, bonusDodge: 0 };
                    if (typeof getArmorSpecialEffects === 'function') {
                        armorEffects = getArmorSpecialEffects();
                    }
                    const mutBonuses2 = getMutationBonuses();
                    const dodgeChance = typeof calculateDodgeChance === 'function' ? Math.round(calculateDodgeChance() * 100) : 2;
                    
                    // Funkce pro zobrazen칤 statu s bonusem
                    const showStat = (name, icon, base, total, desc) => {
                        const diff = total - base;
                        const diffText = diff > 0 ? `<span style="color: #8bc34a;">+${diff}</span>` : diff < 0 ? `<span style="color: #f44336;">${diff}</span>` : '';
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid #333;">
                                <span>${icon} ${name}</span>
                                <span>
                                    <strong style="color: #fff;">${total}</strong>
                                    ${diffText ? ` (${base} ${diffText})` : ''}
                                </span>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; padding: 0.2rem 0 0.4rem 1.5rem;">${desc}</div>
                        `;
                    };
                    
                    title = '驕뮖잺 P콏e쬴v코칤 - Detaily';
                    content = `
                        <div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            <!-- HLAVI캛KA -->
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-size: 3rem;">${classData?.icon || '游녻'}</div>
                                <div>
                                    <h2 style="margin: 0; color: #fff;">${state.char.name}</h2>
                                    <p style="margin: 0.2rem 0; color: #d4722e;">${state.char.gender === 'female' ? '鮫勇' : '鮫勇'} ${classData?.name || 'Nezn치m칠'}</p>
                                    <p style="margin: 0; color: #ffd700; font-size: 0.85rem;">救 칔rove켿 ${state.char.level}</p>
                                </div>
                            </div>
                            
                            <!-- BOJOV칄 STATISTIKY -->
                            <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #c62828;">
                                <h4 style="margin: 0 0 0.8rem 0; color: #ff6b6b;">${'丘덢잺 BOJOV칄 STATISTIKY'}</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #f44336; font-size: 1.5rem; font-weight: bold;">${damage}</div>
                                        <div style="color: #888; font-size: 0.75rem;">丘덢잺 칔tok</div>
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #2196f3; font-size: 1.5rem; font-weight: bold;">${defense}</div>
                                        <div style="color: #888; font-size: 0.75rem;">游띠勇 Obrana</div>
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">${critChance}%</div>
                                        <div style="color: #888; font-size: 0.75rem;">游눤 Kritick칳</div>
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #8bc34a; font-size: 1.5rem; font-weight: bold;">${dodgeChance}%</div>
                                        <div style="color: #888; font-size: 0.75rem;">游눧 칔hyb</div>
                                    </div>
                                </div>
                                ${weapon ? `<div style="margin-top: 0.5rem; padding: 0.3rem; background: #33333380; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #aaa;">${weapon.icon} ${weapon.name} (+${weapon.damage} DMG)</div>` : ''}
                                ${armor ? `<div style="margin-top: 0.3rem; padding: 0.3rem; background: #33333380; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #aaa;">${armor.icon} ${armor.name} (+${armor.defense} DEF)</div>` : ''}
                                ${state.weaponBuff?.fights > 0 ? `<div style="margin-top: 0.3rem; padding: 0.3rem; background: #ffd70030; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #ffd700;">九 Weapon buff: +${state.weaponBuff.damage} DMG (${state.weaponBuff.fights} boj콢)</div>` : ''}
                                ${state.weaponCoating ? `<div style="margin-top: 0.3rem; padding: 0.3rem; background: ${state.weaponCoating.effect === 'poison' ? '#9c27b030' : '#ff572230'}; border-radius: 4px; text-align: center; font-size: 0.8rem; color: ${state.weaponCoating.effect === 'poison' ? '#9c27b0' : '#ff5722'};">${state.weaponCoating.effect === 'poison' ? '驕멆잺 Jedov칳' : '游댠 Ohniv칳'} povlak: ${state.weaponCoating.uses}x</div>` : ''}
                            </div>
                            
                            <!-- ATRIBUTY -->
                            <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #4CAF50;">
                                <h4 style="margin: 0 0 0.8rem 0; color: #8bc34a;">${'游늵 ATRIBUTY'}</h4>
                                ${showStat('S칤la', '游눩', baseStats.strength, totalStats.strength, '+2 DMG za bod nad 5')}
                                ${showStat('V칳dr', '仇벒잺', baseStats.endurance, totalStats.endurance, '+10 HP za bod nad 5')}
                                ${showStat('Obratnost', '游끢', baseStats.agility, totalStats.agility, '+2% 칰hyb za bod nad 5')}
                                ${showStat('Vn칤mavost', '游녜勇', baseStats.perception, totalStats.perception, '+2% krit za bod nad 5')}
                                ${showStat('Inteligence', '游', baseStats.intelligence, totalStats.intelligence, '+10% XP za bod nad 5')}
                                ${showStat('맚캩st칤', '游', baseStats.luck, totalStats.luck, '+3% krit, lep코칤 loot')}
                                
                                ${state.char.availablePoints > 0 ? `
                                    <div style="margin-top: 0.8rem; padding: 0.5rem; background: #ffd70020; border-radius: 4px; text-align: center;">
                                        <span style="color: #ffd700;">九 M치코 ${state.char.availablePoints} bod콢 k rozd캩len칤!</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- POVOL츼N칈 -->
                            <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid ${classData?.color || '#666'};">
                                <h4 style="margin: 0 0 0.5rem 0; color: ${classData?.color || '#888'};">${classData?.icon || '游녻'} ${classData?.name || 'Nezn치m칠'}</h4>
                                <p style="color: #aaa; font-size: 0.9rem; margin: 0.3rem 0;">${classData?.desc || ''}</p>
                                <p style="color: #ffd700; font-size: 0.85rem; margin: 0.3rem 0;">丘 ${classData?.ability || '콯치dn치 schopnost'}</p>
                                <p style="color: #9c27b0; font-size: 0.85rem; margin: 0.3rem 0;">游댩 ${classData?.passive || '콯치dn치 pasivka'}</p>
                            </div>
                            
                            <!-- AKTIVN칈 BUFFY -->
                            ${(state.buffs?.radResist && state.buffs.radResist.until > Date.now()) || 
                              (state.buffs?.allStats && state.buffs.allStats.until > Date.now()) ||
                              (state.buffs?.luck && state.buffs.luck.until > Date.now()) ||
                              (state.buffs?.strength && state.buffs.strength.until > Date.now()) ||
                              (state.buffs?.agility && state.buffs.agility.until > Date.now()) ||
                              (state.buffs?.alcoholDamage && state.buffs.alcoholDamage.until > Date.now()) ? `
                                <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #ffd700;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">九 AKTIVN칈 BUFFY</h4>
                                    ${state.buffs?.radResist && state.buffs.radResist.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #8bc34a;">
                                            <span>驕뮖잺 Odolnost radiaci</span>
                                            <span>+${state.buffs.radResist.value}% (${Math.ceil((state.buffs.radResist.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                    ${state.buffs?.allStats && state.buffs.allStats.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #ffd700;">
                                            <span>九 V코echny staty</span>
                                            <span>+${state.buffs.allStats.value} (${Math.ceil((state.buffs.allStats.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                    ${state.buffs?.luck && state.buffs.luck.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #4caf50;">
                                            <span>游 맚캩st칤 (loot)</span>
                                            <span>+${state.buffs.luck.value}% (${Math.ceil((state.buffs.luck.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                    ${state.buffs?.strength && state.buffs.strength.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #f44336;">
                                            <span>游눩 S칤la</span>
                                            <span>+${state.buffs.strength.value} (${Math.ceil((state.buffs.strength.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                    ${state.buffs?.agility && state.buffs.agility.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #2196f3;">
                                            <span>游끢 Obratnost</span>
                                            <span>+${state.buffs.agility.value} (${Math.ceil((state.buffs.agility.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                    ${state.buffs?.alcoholDamage && state.buffs.alcoholDamage.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #ff9800;">
                                            <span>游꽄 Alkoholov치 s칤la</span>
                                            <span>+${state.buffs.alcoholDamage.value}% DMG (${Math.ceil((state.buffs.alcoholDamage.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <!-- BONUSY -->
                            <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; border-left: 3px solid #888;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #888;">游늶 DAL먞 BONUSY</h4>
                                ${state.char.gender === 'female' ? '<p style="color: #e91e63; font-size: 0.85rem; margin: 0.3rem 0;">鮫勇 -10% ceny, +10% prodej</p>' : ''}
                                ${state.mutations?.length > 0 ? `<p style="color: #ff4444; font-size: 0.85rem; margin: 0.3rem 0;">驕勇 ${state.mutations.length} mutac칤</p>` : ''}
                                ${state.companions?.length > 0 ? `<p style="color: #8bc34a; font-size: 0.85rem; margin: 0.3rem 0;">游논 ${state.companions.length} spole캜n칤k콢</p>` : ''}
                                ${state.settlement?.settlers?.some(s => s.type === 'builder') ? '<p style="color: #ffd700; font-size: 0.85rem; margin: 0.3rem 0;">游끵勇 -50% cena budov (Stavitel)</p>' : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'level':
                    // XP syst칠m zalo쬰n칳 na totalXP
                    const totalXP = state.char.totalXP || 0;
                    const xpForNext = state.char.xpNeed || Math.floor(350 * Math.pow(1.5, state.char.level - 1));
                    const xpPercent = Math.min(100, Math.floor((state.char.xp / xpForNext) * 100));
                    const lvlTexts = {
                        title: '丘덢잺 칔rove켿', current: 'Aktu치ln칤 칰rove켿', whatItMeans: 'Co to znamen치:',
                        levelExplain: '칔rove켿 reprezentuje tvou zku코enost a s칤lu. Vy코코칤 칰rove켿 = siln캩j코칤 postavy, lep코칤 schopnosti.',
                        progress: 'Postup:', toNextLevel: 'do dal코칤 칰rovn캩',
                        onLevelUp: 'P콏i level upu dostane코:', attrPoint: '+1 bod do atribut콢', skillPoint: '+1 skill point', fullHp: 'Pln칠 HP'
                    };
                    title = lvlTexts.title;
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 3rem; color: #ffd700;">${state.char.level}</div>
                            <p style="color: #888;">${lvlTexts.current}</p>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">游늶 ${lvlTexts.whatItMeans}</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">${lvlTexts.levelExplain}</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">游늵 ${lvlTexts.progress}</h4>
                            <p>XP: <span style="color: #8bc34a;">${state.char.xp}</span> / ${xpForNext}</p>
                            <div style="background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 0.5rem;">
                                <div style="background: linear-gradient(90deg, #4CAF50, #8bc34a); height: 100%; width: ${xpPercent}%;"></div>
                            </div>
                            <p style="color: #888; font-size: 0.8rem; margin-top: 0.5rem;">${xpPercent}% ${lvlTexts.toNextLevel}</p>
                            <p style="color: #666; font-size: 0.75rem; margin-top: 0.3rem;">游늳 Celkov칠 XP: ${totalXP.toLocaleString()}</p>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游꾸 ${lvlTexts.onLevelUp}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa;">
                                <li>${lvlTexts.attrPoint}</li>
                                <li>${lvlTexts.skillPoint}</li>
                                <li>${lvlTexts.fullHp}</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'hp':
                    const hpPercent = Math.floor((state.char.hp / state.char.maxHp) * 100);
                    const hpColor = hpPercent > 60 ? '#4CAF50' : hpPercent > 30 ? '#ff9800' : '#f44336';
                    const endurance = state.char.stats?.endurance || 5;
                    title = '仇벒잺 Vitalita (HP)';
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2.5rem; color: ${hpColor};">${Math.round(state.char.hp)} / ${state.char.maxHp}</div>
                            <p style="color: #888;">Aktu치ln칤 zdrav칤</p>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">游늶 Co to znamen치:</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">Vitalita (HP) je tv칠 zdrav칤. Kdy klesne na 0, zem콏e코 a ztrat칤코 캜치st invent치콏e!</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">游늳 V칳po캜et max HP:</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>Z치klad: 100 HP</li>
                                <li>+10 HP za ka쬯칳 bod V칳dr쬰 nad 5</li>
                                <li>Tv치 V칳dr: ${endurance}</li>
                            </ul>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游눍 Jak l칠캜it:</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>游뽗 Obvazy, l칠k치rni캜ky, stimpaky</li>
                                <li>游눣 Sp치nek (+50 HP)</li>
                                <li>游낀 Nemocnice (prozkoumej)</li>
                                <li>拘勇 Level up (pln칠 HP)</li>
                            </ul>
                        </div>
                        
                        ${(typeof getActiveDiseases === 'function' && getActiveDiseases().length > 0) ? `
                            <div style="background: #3a1a1a; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #f44336;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #f44336;">游 Aktivn칤 nemoci:</h4>
                                ${getActiveDiseases().map(d => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid #2a2a2a;">
                                        <div>
                                            <span style="font-size: 1.1rem;">${d.icon}</span>
                                            <strong style="color: #ff6b6b;"> ${d.name}</strong>
                                        </div>
                                        <span style="color: #888; font-size: 0.85rem;">낌勇 ${d.remainingText}</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #888; padding: 0.2rem 0 0.4rem 1.5rem;">${d.desc}</div>
                                `).join('')}
                                <button class="btn" onclick="closeModal(); showDiseasesUI();" style="width: 100%; margin-top: 0.8rem; padding: 0.5rem; background: #c62828;">游낀 L칠캜it nemoci</button>
                            </div>
                        ` : `
                            <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
                                <span style="color: #4caf50;">游눜 콯치dn칠 nemoci - jsi zdrav칳!</span>
                            </div>
                        `}
                    `;
                    break;
                    
                case 'weight':
                    const weightPercent = Math.floor((state.carryWeight / state.maxCarryWeight) * 100);
                    const weightColor = weightPercent > 90 ? '#f44336' : weightPercent > 70 ? '#ff9800' : '#4CAF50';
                    const str = state.char.stats?.strength || 5;
                    const hasBackpack = state.inv?.some(i => i.bonus === 'capacity') || false;
                    const packRatLevel = state.skills?.['pack_rat'] || 0;
                    const weightTexts = {
                        title: '游닍 N치klad (Nosnost)', currentLoad: 'Aktu치ln칤 z치t캩', whatItMeans: 'Co to znamen치:',
                        loadExplain: 'Kolik m콢쬰코 un칠st. Kdy jsi p콏et칤쬰n칳, nem콢쬰코 sb칤rat dal코칤 v캩ci!',
                        calculation: 'V칳po캜et nosnosti:', base: 'Z치klad:', perStr: 'za ka쬯칳 bod S칤ly nad 5',
                        yourStr: 'Tv치 S칤la:', backpack: 'Batoh:', noBackpack: 'nem치코',
                        tips: 'Tipy:', tipStr: 'Zvy코 S칤lu pro v칤c nosnosti', tipBackpack: 'Vyrob si 游 Batoh (+20 kg)',
                        tipStash: 'Ulo v캩ci do 칰krytu', tipSkill: 'Nau캜 se skill Pack Rat'
                    };
                    title = weightTexts.title;
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2.5rem; color: ${weightColor};">${(state.carryWeight || 0).toFixed(1)} / ${state.maxCarryWeight || 50} kg</div>
                            <p style="color: #888;">${weightTexts.currentLoad}</p>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">游늶 ${weightTexts.whatItMeans}</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">${weightTexts.loadExplain}</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">游늳 ${weightTexts.calculation}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>${weightTexts.base} 50 kg</li>
                                <li>+5 kg ${weightTexts.perStr}</li>
                                <li>${weightTexts.yourStr} ${str} (+${Math.max(0, (str - 5) * 5)} kg)</li>
                                ${hasBackpack ? '<li style="color: #8bc34a;">游 ' + weightTexts.backpack + ' +20 kg</li>' : '<li style="color: #666;">游 ' + weightTexts.backpack + ' ' + weightTexts.noBackpack + '</li>'}
                                ${packRatLevel > 0 ? `<li style="color: #8bc34a;">游닍 Pack Rat skill: +${packRatLevel * 10} kg</li>` : ''}
                            </ul>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游눠 ${weightTexts.tips}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>${weightTexts.tipStr}</li>
                                <li>${weightTexts.tipBackpack}</li>
                                <li>${weightTexts.tipStash}</li>
                                <li>${weightTexts.tipSkill}</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'time':
                    const totalSec = state.time.totalElapsed || 0;
                    const hoursPlayed = Math.floor(totalSec / 3600);
                    const minsPlayed = Math.floor((totalSec % 3600) / 60);
                    const secsToNextDay = 86400 - (totalSec % 86400);
                    const hoursToNext = Math.floor(secsToNextDay / 3600);
                    const minsToNext = Math.floor((secsToNextDay % 3600) / 60);
                    
                    title = '游뎷 캛as';
                    const timeTexts = {
                        day: 'Den', whatItMeans: 'Co to znamen치:',
                        clockExplain: 'Hodiny ukazuj칤 re치ln칳 캜as. Dny se po캜칤taj칤 z odehran칠ho 캜asu (24h hran칤 = 1 den).',
                        playedTime: 'Odehran칳 캜as:', untilNextDay: 'Do dal코칤ho dne:',
                        dailyCycles: 'Denn칤 cykly:', dayTime: 'Den (lep코칤 viditelnost)', nightTime: 'Noc (nebezpe캜n캩j코칤)',
                        dailyQuestsReset: 'Ka쬯칳 den se resetuj칤 denn칤 questy', settlementProduces: 'Osada produkuje suroviny denn캩',
                        yourStats: 'Tv칠 statistiky:', survived: 'P콏e쬴l jsi', days: 'dn칤', enemiesKilled: 'Zabito nep콏치tel:', itemsCrafted: 'Vyrobeno v캩c칤:'
                    };
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">${timeTexts.day} ${state.time.days}</div>
                            <div style="font-size: 1.5rem; color: #888;">${String(state.time.hours).padStart(2, '0')}:${String(state.time.mins).padStart(2, '0')}</div>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">游늶 ${timeTexts.whatItMeans}</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">${timeTexts.clockExplain}</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">낌勇 ${timeTexts.playedTime}</h4>
                            <p style="color: #8bc34a; font-size: 1.2rem; text-align: center;">${hoursPlayed}h ${minsPlayed}m</p>
                            <p style="color: #888; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">${timeTexts.untilNextDay} ${hoursToNext}h ${minsToNext}m</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">낋 ${timeTexts.dailyCycles}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>游깬 6:00-18:00 - ${timeTexts.dayTime}</li>
                                <li>游깿 18:00-6:00 - ${timeTexts.nightTime}</li>
                                <li>${timeTexts.dailyQuestsReset}</li>
                                <li>${timeTexts.settlementProduces}</li>
                            </ul>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游늵 ${timeTexts.yourStats}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>${timeTexts.survived} ${state.time.days} ${timeTexts.days}</li>
                                <li>${timeTexts.enemiesKilled} ${state.stats?.kills || 0}</li>
                                <li>${timeTexts.itemsCrafted} ${state.stats?.itemsCrafted || 0}</li>
                            </ul>
                        </div>
                    `;
                    break;
            }
            
            showModal(title, content + `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>`);
        }
        
        // === TUTORI츼L SYST칄M ===
        const TUTORIAL_STEPS = [
            {
                id: 'welcome',
                title: 'V칤tej v pustin캩!',
                subtitle: 'Tv칠 dobrodru쬽tv칤 za캜칤n치',
                text: 'Rok 2077. Nukle치rn칤 v치lka zm캩nila sv캩t v radioaktivn칤 pustinu. Ty jsi jeden z m치la p콏e쬴v코칤ch. Tv칳m 칰kolem je p콏e쮂셦, naj칤t ostatn칤 a mo쬹치... zachr치nit lidstvo.',
                icon: '驕뮖잺',
                tips: ['Hra se automaticky ukl치d치', 'M콢쬰코 hr치t i offline', 'Tutorial m콢쬰코 kdykoli p콏esko캜it'],
                animation: 'pulse'
            },
            {
                id: 'stats',
                title: 'Tv칠 p콏e쬴t칤 z치vis칤 na...',
                subtitle: '콯ivotn칤 statistiky',
                text: 'Sleduj tyto 4 kritick칠 ukazatele. Pokud kter칳koli klesne na 0, za캜ne코 um칤rat!',
                icon: '游늵',
                features: [
                    { icon: '仇벒잺', name: 'HP', desc: 'Zdrav칤 - l칠캜칤 se l칠k치rni캜kami a odpo캜inkem', color: '#f44336' },
                    { icon: '游꼤', name: 'Hlad', desc: 'Kles치 캜asem - jez j칤dlo!', color: '#ff9800' },
                    { icon: '游눦', name: '콯칤ze켿', desc: 'Kles치 rychleji ne hlad - pij!', color: '#2196f3' },
                    { icon: '驕뮖잺', name: 'Radiace', desc: 'Zvy코uje se v nebezpe캜n칳ch z칩n치ch', color: '#8bc34a' }
                ],
                highlight: '.stats-bar',
                animation: 'highlight'
            },
            {
                id: 'inventory',
                title: 'Tv치 v칳bava',
                subtitle: 'Z치lo쬶a V칗BAVA',
                text: 'Zde najde코 v코echny sv칠 p콏edm캩ty. Na za캜치tku m치코 z치kladn칤 vybaven칤 - pou쮂셨ej ho moud콏e!',
                icon: '游',
                features: [
                    { icon: '丘됊잺', name: 'L칠k치rni캜ka', desc: 'Obnov칤 HP', color: '#f44336' },
                    { icon: '游볾', name: 'J칤dlo', desc: 'Obnov칤 hlad', color: '#ff9800' },
                    { icon: '游눦', name: 'Voda', desc: 'Obnov칤 쮂셬e켿', color: '#2196f3' },
                    { icon: '丘덢잺', name: 'Zbran캩', desc: 'Vyber a vyzbrojit!', color: '#9c27b0' }
                ],
                highlight: '[data-tab="inv"]',
                action: 'Klikni na V칗BAVA a prozkoumej invent치콏'
            },
            {
                id: 'map',
                title: 'Prozkoumej sv캩t',
                subtitle: 'Z치lo쬶a MAPA',
                text: 'Mapa ukazuje celou pustinu. Ka쬯칳 hexagon je jin치 lokace - m캩sta, lesy, ruiny, hory...',
                icon: '游딬勇',
                features: [
                    { icon: '游', name: '칔kryt', desc: 'Tv치 z치kladna - bezpe캜칤', color: '#4CAF50' },
                    { icon: '游끷勇', name: 'M캩sta', desc: 'Obchody, NPC, questy', color: '#2196f3' },
                    { icon: '游끸勇', name: 'Ruiny', desc: 'Loot ale i nebezpe캜칤', color: '#ff9800' },
                    { icon: '驕멆잺', name: 'Nebezpe캜n칠', desc: 'Radiace, mutanti', color: '#f44336' }
                ],
                highlight: '[data-tab="map"]',
                action: 'Prozkoumej mapu a vyber c칤l cesty'
            },
            {
                id: 'combat',
                title: 'Bojov칳 syst칠m',
                subtitle: '2 akce za kolo',
                text: 'Boj je tahov칳. Ka쬯칠 kolo m치코 2 akce - kombinuj je strategicky!',
                icon: '丘덢잺',
                features: [
                    { icon: '游뛌', name: 'Pohyb', desc: '1 akce - p콏ibl칤 se/oddal', color: '#2196f3' },
                    { icon: '丘덢잺', name: '칔tok', desc: '1 akce - zra켿 nep콏칤tele', color: '#f44336' },
                    { icon: '游띠勇', name: 'Obrana', desc: 'V코echny akce - +50-100% DEF', color: '#4CAF50' },
                    { icon: '游댃', name: 'V칳m캩na', desc: '1 akce - zm캩켿 zbra켿', color: '#ff9800' }
                ],
                tips: ['St콏eln칠 zbran캩 = neomezen칳 dosah', 'Melee zbran캩 = mus칤코 b칳t bl칤zko', 'Munice se spot콏ebov치v치!']
            },
            {
                id: 'companion',
                title: 'Najdi spole캜n칤ka!',
                subtitle: 'Nejsi v tom s치m',
                text: 'P콏i prvn칤 cest캩 potk치코 opu코t캩n칠ho psa. P콎IJMI HO! Spole캜n칤ci jsou v pustin캩 neoceniteln칤.',
                icon: '游냇',
                features: [
                    { icon: '丘덢잺', name: 'Bojuj칤', desc: 'Pom치haj칤 v boji', color: '#f44336' },
                    { icon: '游댌', name: 'Hledaj칤', desc: 'Bonus k lootu', color: '#ff9800' },
                    { icon: '仇벒잺', name: 'Loajalita', desc: 'Krm je pro bonusy', color: '#e91e63' },
                    { icon: '游닆', name: 'Questy', desc: 'Maj칤 vlastn칤 p콏칤b캩hy', color: '#9c27b0' }
                ],
                tips: ['Spole캜n칤ci pot콏ebuj칤 1游꼤 + 1游눦 denn캩', 'Krmen칤m zvy코uje코 loajalitu', 'Vysok치 loajalita = speci치ln칤 questy'],
                important: true
            },
            {
                id: 'settlement',
                title: 'Vybuduj osadu',
                subtitle: 'Z치lo쬶a OSADA',
                text: 'Tv치 osada je kl칤캜em k dlouhodob칠mu p콏e쬴t칤. Stav budovy, naj칤mej osadn칤ky!',
                icon: '游끶勇',
                features: [
                    { icon: '游끵勇', name: 'Budovy', desc: 'Produkce, obrana, bonusy', color: '#795548' },
                    { icon: '游논', name: 'Osadn칤ci', desc: 'Pracuj칤 za tebe', color: '#2196f3' },
                    { icon: '游눯', name: 'Ekonomika', desc: '칔dr쬭a a p콏칤jmy', color: '#ffd700' },
                    { icon: '丘덢잺', name: 'Obrana', desc: 'Bra켿 se n치jezd콢m', color: '#f44336' }
                ],
                highlight: '[data-tab="base"]',
                tips: ['Stavitel sni쬿je n치klady na 칰dr쬭u', 'Obchodn칤k generuje pasivn칤 p콏칤jem', 'Farm치콏 a nosi캜 vody = z치kladn칤 z치soby']
            },
            {
                id: 'quests',
                title: '7 typ콢 quest콢',
                subtitle: 'V쬯y je co d캩lat',
                text: 'Hra nab칤z칤 obrovsk칠 mno쬽tv칤 칰kol콢. Sleduj Quest Tracker na map캩!',
                icon: '游닆',
                features: [
                    { icon: '游늰', name: 'Denn칤', desc: 'Obnovuj칤 se ka쬯칳 den', color: '#4CAF50' },
                    { icon: '游눫', name: 'NPC', desc: 'Od postav ve m캩stech', color: '#2196f3' },
                    { icon: '游끶勇', name: 'Osadn칤ci', desc: 'Pro tv칠 obyvatele', color: '#795548' },
                    { icon: '낌勇', name: '캛asovan칠', desc: 'Limitovan칳 캜as!', color: '#f44336' }
                ],
                tips: ['Hlavn칤 p콏칤b캩h odemyk치 nov칠 oblasti', 'Detektivn칤 questy = logick칠 h치danky', 'Spole캜n칤ci maj칤 vlastn칤 quest linie']
            },
            {
                id: 'tips',
                title: 'Zlat칠 rady p콏e쬴v코칤ho',
                subtitle: 'Zapamatuj si!',
                text: 'T캩chto 5 rad ti zachr치n칤 쬴vot:',
                icon: '游눠',
                bigTips: [
                    { num: 1, tip: 'P콎IJMI PSA p콏i prvn칤 cest캩!', icon: '游냇' },
                    { num: 2, tip: 'Jez a pij PRAVIDELN캨', icon: '游꼤' },
                    { num: 3, tip: '만t콏i RadAway na radia캜n칤 z칩ny', icon: '驕뮖잺' },
                    { num: 4, tip: 'Stav osadu CO NEJD콎칈VE', icon: '游끶勇' },
                    { num: 5, tip: 'Prozkoum치vej - loot je v코ude!', icon: '游댌' }
                ]
            },
            {
                id: 'ready',
                title: 'Jsi p콏ipraven!',
                subtitle: 'Hodn캩 코t캩st칤, p콏e쬴v코칤',
                text: 'Te캞 v칤코 v코e pot콏ebn칠. Pustina 캜ek치. Tv콢j osud je v tv칳ch rukou.',
                icon: '游꿉',
                final: true
            }
        ];
        
        function showTutorial(stepIndex = 0) {
            if (stepIndex >= TUTORIAL_STEPS.length) {
                state.tutorialComplete = true;
                saveGame();
                closeModal();
                return;
            }
            
            const step = TUTORIAL_STEPS[stepIndex];
            const progress = Math.round(((stepIndex + 1) / TUTORIAL_STEPS.length) * 100);
            
            // Zv칳razni element pokud existuje
            if (step.highlight) {
                document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
                const el = document.querySelector(step.highlight);
                if (el) {
                    el.classList.add('tutorial-highlight');
                    el.style.animation = 'tutorialPulse 1s ease-in-out infinite';
                    setTimeout(() => {
                        el.style.animation = '';
                        el.classList.remove('tutorial-highlight');
                    }, 5000);
                }
            }
            
            // Generuj features HTML
            let featuresHtml = '';
            if (step.features) {
                featuresHtml = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin: 1rem 0;">
                        ${step.features.map(f => `
                            <div style="background: linear-gradient(135deg, ${f.color}22 0%, #1a1a1a 100%); padding: 0.6rem; border-radius: 6px; border-left: 3px solid ${f.color};">
                                <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.2rem;">
                                    <span style="font-size: 1.2rem;">${f.icon}</span>
                                    <strong style="color: ${f.color};">${f.name}</strong>
                                </div>
                                <div style="font-size: 0.75rem; color: #999;">${f.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Generuj tips HTML
            let tipsHtml = '';
            if (step.tips) {
                tipsHtml = `
                    <div style="background: #1a1a0a; padding: 0.8rem; border-radius: 6px; margin-top: 1rem; border: 1px solid #4a4a2a;">
                        <div style="color: #ffd700; font-size: 0.8rem; margin-bottom: 0.5rem;">游눠 Tipy:</div>
                        ${step.tips.map(t => `<div style="color: #ccc; font-size: 0.8rem; margin-left: 1rem;"> ${t}</div>`).join('')}
                    </div>
                `;
            }
            
            // Generuj big tips HTML pro posledn칤 krok
            let bigTipsHtml = '';
            if (step.bigTips) {
                bigTipsHtml = `
                    <div style="margin: 1rem 0;">
                        ${step.bigTips.map(t => `
                            <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.6rem; background: linear-gradient(90deg, #2a2a1a 0%, #1a1a1a 100%); border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #ffd700;">
                                <div style="background: #ffd700; color: #000; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;">${t.num}</div>
                                <span style="font-size: 1.3rem;">${t.icon}</span>
                                <span style="color: #fff; font-size: 0.9rem;">${t.tip}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Action HTML
            let actionHtml = '';
            if (step.action) {
                actionHtml = `
                    <div style="background: linear-gradient(90deg, #1a3a1a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 6px; margin-top: 1rem; border: 1px solid #4CAF50; text-align: center;">
                        <span style="color: #8bc34a;">游녡 ${step.action}</span>
                    </div>
                `;
            }
            
            // Final step special content
            let finalHtml = '';
            if (step.final) {
                finalHtml = `
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <div style="font-size: 4rem; margin-bottom: 1rem; animation: bounce 1s ease infinite;">游꿉</div>
                        <div style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="color: #fff; font-size: 1.1rem; font-weight: bold;">九 Tutorial dokon캜en!</div>
                            <div style="color: #c8e6c9; font-size: 0.85rem; margin-top: 0.3rem;">Kdykoli ho m콢쬰코 spustit znovu z Termin치lu (游)</div>
                        </div>
                    </div>
                `;
            }
            
            showModal('', `
                <style>
                    @keyframes tutorialPulse {
                        0%, 100% { box-shadow: 0 0 10px 2px #ffd700; }
                        50% { box-shadow: 0 0 25px 8px #ffd700; }
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    @keyframes fadeInUp {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                </style>
                <div style="background: linear-gradient(180deg, #0a1a0a 0%, #1a1a1a 100%); border: 2px solid #4CAF50; border-radius: 12px; padding: 0; overflow: hidden; animation: fadeInUp 0.3s ease;">
                    <!-- Progress bar -->
                    <div style="height: 6px; background: #1a1a1a; position: relative;">
                        <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #4CAF50, #8bc34a); transition: width 0.5s ease; border-radius: 0 3px 3px 0;"></div>
                        <div style="position: absolute; right: 8px; top: 10px; font-size: 0.7rem; color: #666;">${stepIndex + 1}/${TUTORIAL_STEPS.length}</div>
                    </div>
                    
                    <!-- Header -->
                    <div style="padding: 1.2rem; text-align: center; background: linear-gradient(180deg, #0a2a0a 0%, transparent 100%); ${step.important ? 'border-bottom: 2px solid #ffd700;' : ''}">
                        <div style="font-size: 3rem; ${step.animation === 'pulse' ? 'animation: bounce 2s ease infinite;' : ''}">${step.icon}</div>
                        <h2 style="color: #8bc34a; margin: 0.5rem 0 0.2rem 0; font-size: 1.3rem;">${step.title}</h2>
                        <div style="color: #666; font-size: 0.85rem;">${step.subtitle}</div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 1rem 1.2rem;">
                        <p style="color: #ccc; line-height: 1.7; margin: 0; font-size: 0.9rem; text-align: center;">${step.text}</p>
                        ${featuresHtml}
                        ${bigTipsHtml}
                        ${actionHtml}
                        ${tipsHtml}
                        ${finalHtml}
                    </div>
                    
                    <!-- Navigation -->
                    <div style="padding: 1rem; background: #0a0a0a; border-top: 1px solid #333;">
                        <div style="display: grid; grid-template-columns: ${stepIndex > 0 ? '1fr 2fr' : '1fr'}; gap: 0.5rem;">
                            ${stepIndex > 0 ? `
                                <button class="btn" onclick="showTutorial(${stepIndex - 1})" style="background: #333; padding: 0.7rem;">
                                     Zp캩t
                                </button>
                            ` : ''}
                            <button class="btn" onclick="showTutorial(${stepIndex + 1})" style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); padding: 0.7rem; font-weight: bold;">
                                ${step.final ? '游꿡 Za캜칤t hr치t!' : 'Dal코칤 '}
                            </button>
                        </div>
                        ${!step.final ? `
                            <div style="text-align: center; margin-top: 0.8rem;">
                                <span onclick="state.tutorialComplete = true; saveGame(); closeModal();" style="color: #555; font-size: 0.75rem; cursor: pointer;">P콏esko캜it tutorial</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);
        }
        
        function showGameInfo() {
            const texts = {
                title: 'Post-apokalyptick치 Survival RPG',
                version: 'Verze',
                story: 'Rok 2077. Nukle치rn칤 v치lka zm캩nila sv캩t v radioaktivn칤 pustinu. M캩sta jsou v trosk치ch, mutanti se potuluj칤 krajinou a z치soby doch치zej칤. Ty jsi jeden z m치la p콏e쬴v코칤ch...',
                whatAwaits: 'Co t캩 캜ek치?',
                combat: 'Tahov칠 souboje',
                combatDesc: 'Bojuj s mutanty, bandity a monstry. Strategick칳 boj s 2 akcemi za kolo.',
                world: 'Obrovsk칳 sv캩t',
                worldDesc: '100+ lokac칤 k prozkoum치n칤 - m캩sta, ruiny, jeskyn캩, bunkry, laborato콏e...',
                settlement: 'Budov치n칤 osady',
                settlementDesc: 'Stav budovy, naj칤mej osadn칤ky, bra켿 se n치jezd콢m. Tv치 vlastn칤 komunita!',
                companions: 'Spole캜n칤ci',
                companionsDesc: 'Najdi psa, ko캜ku, robota nebo lidsk칠 spole캜n칤ky. Ka쬯칳 m치 unik치tn칤 schopnosti!',
                crafting: 'Crafting & loot',
                craftingDesc: '119 recept콢, 5 rarit p콏edm캩t콢, zbran캩, zbroje, l칠ky, j칤dlo...',
                quests: '7 quest syst칠m콢',
                casino: '9 casino her',
                classes: '9 povol치n칤',
                pvp: 'PvP boje',
                autosave: 'Auto-save',
                understand: 'Rozum칤m, chci hr치t!'
            };
            
            showModal('', `
                <div style="background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%); border: 2px solid var(--toxic-green); border-radius: 12px; padding: 0; overflow: hidden;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(180deg, #0a2a0a 0%, #1a1a1a 100%); padding: 1.5rem; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 0.5rem;">驕뮖잺</div>
                        <h2 style="color: var(--toxic-green); margin: 0; text-shadow: 0 0 10px var(--toxic-green);">${texts.title}</h2>
                        <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">${texts.version} ${GAME_VERSION}</div>
                    </div>
                    
                    <!-- P콎칈B캨H -->
                    <div style="padding: 1.2rem; border-bottom: 1px solid #333;">
                        <p style="color: #ccc; line-height: 1.8; margin: 0; font-size: 0.95rem; text-align: center;">
                            <em>${texts.story}</em>
                        </p>
                    </div>
                    
                    <!-- CO T캨 캛EK츼 -->
                    <div style="padding: 1.2rem;">
                        <h3 style="color: #ffd700; margin: 0 0 1rem 0; text-align: center;">游꿡 ${texts.whatAwaits}</h3>
                        
                        <div style="display: grid; gap: 0.8rem;">
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #f44336;">
                                <span style="font-size: 2rem;">丘덢잺</span>
                                <div>
                                    <div style="color: #f44336; font-weight: bold;">${texts.combat}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.combatDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #2196f3;">
                                <span style="font-size: 2rem;">游딬勇</span>
                                <div>
                                    <div style="color: #2196f3; font-weight: bold;">${texts.world}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.worldDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #4CAF50;">
                                <span style="font-size: 2rem;">游끶勇</span>
                                <div>
                                    <div style="color: #4CAF50; font-weight: bold;">${texts.settlement}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.settlementDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #ff9800;">
                                <span style="font-size: 2rem;">游냇</span>
                                <div>
                                    <div style="color: #ff9800; font-weight: bold;">${texts.companions}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.companionsDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #9c27b0;">
                                <span style="font-size: 2rem;">丘勇</span>
                                <div>
                                    <div style="color: #9c27b0; font-weight: bold;">${texts.crafting}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.craftingDesc}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- STATS -->
                    <div style="background: #0a0a0a; padding: 1rem; border-top: 1px solid #333;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1rem; font-size: 0.75rem; color: #666;">
                            <span>游닆 ${texts.quests}</span>
                            <span>游꿣 ${texts.casino}</span>
                            <span>游녻 ${texts.classes}</span>
                            <span>游끥 ${texts.pvp}</span>
                            <span>游 ${texts.autosave}</span>
                        </div>
                    </div>
                    
                    <!-- BUTTON -->
                    <div style="padding: 1rem;">
                        <button class="btn" onclick="closeModal()" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); padding: 0.8rem; font-size: 1rem;">
                            九 ${texts.understand}
                        </button>
                    </div>
                </div>
            `);
        }
        
        function toggleMobileNotifications() {
            if (MobileNotifications.enabled) {
                // U je povoleno - info + test
                showModal('游댒 Notifikace', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游댒</div>
                        <h3 style="color: #4CAF50;">Notifikace jsou povoleny!</h3>
                        <p style="color: #888; margin: 1rem 0;">Bude코 dost치vat upozorn캩n칤 na:</p>
                        <div style="text-align: left; background: #1a1a1a; padding: 1rem; border-radius: 8px; font-size: 0.85rem;">
                            <div>仇벒잺 Kritick칠 zdrav칤</div>
                            <div>游꼤 Kritick칳 hlad</div>
                            <div>游눦 Kritick치 쮂셬e켿</div>
                            <div>游냇 Hladov칤 spole캜n칤ci</div>
                            <div>丘덢잺 N치jezdy na osadu</div>
                            <div>游깬 Nov칳 den</div>
                        </div>
                        <button class="btn" onclick="MobileNotifications.test(); notifySuccess('Notifikace odesl치na!', 'Zkontroluj notifika캜n칤 centrum')" style="width: 100%; margin-top: 1rem; background: #2196f3;">游빍 Testovat notifikaci</button>
                        <p style="color: #666; font-size: 0.8rem; margin-top: 1rem;">Pro vypnut칤 jdi do nastaven칤 prohl칤쬰캜e/aplikace.</p>
                    </div>
                    <button class="btn" onclick="showGameInfo()" style="width: 100%; margin-top: 1rem;">${'Zp캩t'}</button>
                `);
            } else {
                // Po쮂멳ej o povolen칤
                MobileNotifications.requestPermission().then(function(granted) {
                    if (granted) {
                        showModal('游댒 Notifikace povoleny!', `
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">九</div>
                                <h3 style="color: #4CAF50;">Skv캩le!</h3>
                                <p style="color: #888;">Te캞 bude코 dost치vat upozorn캩n칤 i kdy je aplikace vypnut치.</p>
                            </div>
                            <button class="btn" onclick="showGameInfo()" style="width: 100%; margin-top: 1rem; background: #4CAF50;"> Zp캩t do termin치lu</button>
                        `);
                        
                        // Test notifikace
                        setTimeout(function() {
                            MobileNotifications.send('驕뮖잺 Notifikace aktivn칤!', {
                                body: 'Te캞 bude코 dost치vat d콢le쬴t치 upozorn캩n칤.'
                            });
                        }, 1000);
                    } else {
                        showModal('游댓 Notifikace zam칤tnuty', `
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">仇</div>
                                <h3 style="color: #f44336;">Notifikace nepovoleny</h3>
                                <p style="color: #888;">Pro povolen칤 notifikac칤 jdi do nastaven칤 prohl칤쬰캜e/aplikace a povol je ru캜n캩.</p>
                            </div>
                            <button class="btn" onclick="showGameInfo()" style="width: 100%; margin-top: 1rem;">${'Zp캩t'}</button>
                        `);
                    }
                });
            }
        }
        
        function updateGame() {
            showModal('游댃 Reload hry', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">游댃</div>
                    <h3 style="margin: 0 0 1rem 0; color: var(--toxic-green);">Na캜칤st zm캩ny</h3>
                    
                    <div style="background: #1a4d1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: left;">
                        <p style="margin: 0; color: #8bc34a;">九 Tv콢j save z콢stane zachov치n!</p>
                        <p style="margin: 0.5rem 0 0 0; color: #888; font-size: 0.85rem;">Save je ulo쬰n칳 v prohl칤쬰캜i (localStorage)</p>
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.9rem; margin-bottom: 1rem;">
                        Str치nka se znovu na캜te a aplikuj칤 se zm캩ny v k칩du.
                    </p>
                </div>
                
                <button class="btn" onclick="forceReload()" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust);">游댃 Reload te캞</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">九 Zru코it</button>
            `);
        }
        
        function forceReload() {
            // Ulo쮂셠e p콏ed reloadem
            saveGame();
            // Reload str치nky (zachov치 localStorage)
            location.reload();
        }
        
        // === EXPORT / IMPORT SAVE ===
        function showExportImport() {
            showModal('游 P콏enos postavy', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游</div>
                    <p style="color: #888;">P콏enes svou postavu mezi za콏칤zen칤mi</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="exportSave()" style="background: #1565c0; padding: 1rem;">
                        <div style="font-size: 1.5rem;">游닋</div>
                        <div style="font-weight: bold;">Exportovat save</div>
                        <div style="font-size: 0.75rem; color: #aaa;">Zkop칤ruj k칩d do schr치nky</div>
                    </button>
                    
                    <button class="btn" onclick="showImportSave()" style="background: #2e7d32; padding: 1rem;">
                        <div style="font-size: 1.5rem;">游닌</div>
                        <div style="font-weight: bold;">Importovat save</div>
                        <div style="font-size: 0.75rem; color: #aaa;">Vlo k칩d z jin칠ho za콏칤zen칤</div>
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zp캩t'}</button>
            `);
        }
        
        function exportSave() {
            try {
                saveGame(true); // Ulo쬴t aktu치ln칤 stav (ti코e)
                
                // Exportuj p콏칤mo aktu치ln칤 state objekt - to je nejspolehliv캩j코칤
                const exportData = JSON.parse(JSON.stringify(state)); // Deep copy
                
                // P콏idej metadata pro import
                exportData._exportVersion = 2;
                exportData._exportTime = Date.now();
                exportData._exportedFrom = window.location.hostname || 'local';
                
                // Zak칩duj do base64 pro bezpe캜n칳 p콏enos
                const saveData = JSON.stringify(exportData);
                const encoded = btoa(unescape(encodeURIComponent(saveData)));
                
                // P콏iprav info o postav캩
                const charName = state.char.name || 'Nezn치m칳';
                const charLevel = state.char.level || 1;
                const invCount = state.inv?.length || 0;
                const gold = state.money || 0;
                
                // Zkus zkop칤rovat do schr치nky
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(encoded).then(function() {
                        showModal('游닋 Export 칰sp캩코n칳!', 
                            '<div style="text-align: center; margin-bottom: 1rem;">' +
                                '<div style="font-size: 3rem;">九</div>' +
                                '<p style="color: #4caf50; font-weight: bold;">Save zkop칤rov치n do schr치nky!</p>' +
                            '</div>' +
                            '<div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                                '<p style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.85rem;">Postava:</p>' +
                                '<p style="color: #ffd700; margin: 0; font-size: 1.1rem;">' + charName + ' (Lv.' + charLevel + ')</p>' +
                                '<p style="color: #888; margin: 0.3rem 0 0 0; font-size: 0.8rem;">游눯 ' + gold + ' gold | 游 ' + invCount + ' item콢</p>' +
                            '</div>' +
                            '<p style="color: #888; font-size: 0.85rem; text-align: center;">' +
                                'Te캞 otev콏i hru na druh칠m za콏칤zen칤 a pou쬴j "Importovat save"' +
                            '</p>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>'
                        );
                    }).catch(function() {
                        showExportCode(encoded);
                    });
                } else {
                    showExportCode(encoded);
                }
            } catch (e) {
                notifyError('Chyba exportu', e.message);
                console.error('Export error:', e);
            }
        }
        
        function showExportCode(code) {
            showModal('游닋 Export - ru캜n칤 kop칤rov치n칤', 
                '<div style="text-align: center; margin-bottom: 1rem;">' +
                    '<p style="color: #ff9800;">' + ('Automatick칠 kop칤rov치n칤 nefunguje.') + '</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">' + ('Ozna캜 a zkop칤ruj k칩d ru캜n캩:') + '</p>' +
                '</div>' +
                '<textarea id="exportCode" readonly style="width: 100%; height: 150px; background: #0a0a0a; color: #4caf50; border: 1px solid #333; padding: 0.5rem; font-family: monospace; font-size: 0.7rem; resize: none;">' + code + '</textarea>' +
                '<button class="btn" onclick="document.getElementById(\'exportCode\').select()" style="width: 100%; margin-top: 0.5rem; background: #1565c0;">游늶 ' + ('Ozna캜it v코e') + '</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">' + ('Zp캩t') + '</button>'
            );
        }
        
        function showImportSave() {
            showModal('游닌 Import save', 
                '<div style="text-align: center; margin-bottom: 1rem;">' +
                    '<div style="font-size: 2rem;">游닌</div>' +
                    '<p style="color: #888;">' + ('Vlo k칩d exportovan칳 z jin칠ho za콏칤zen칤:') + '</p>' +
                '</div>' +
                '<textarea id="importCode" placeholder="' + ('Vlo sem exportovan칳 k칩d...') + '" style="width: 100%; height: 120px; background: #0a0a0a; color: #4caf50; border: 1px solid #333; padding: 0.5rem; font-family: monospace; font-size: 0.8rem; resize: none;"></textarea>' +
                '<div style="background: #3a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #c62828;">' +
                    '<p style="color: #f44336; margin: 0; font-size: 0.85rem;">丘멆잺 ' + ('Varov치n칤: Import p콏ep칤코e tvou aktu치ln칤 hru!') + '</p>' +
                '</div>' +
                '<button class="btn" id="importBtn" style="width: 100%; background: #2e7d32; margin-bottom: 0.5rem;">九 ' + ('Importovat') + '</button>' +
                '<button class="btn" onclick="showExportImport()" style="width: 100%; background: #555;">' + ('Zp캩t') + '</button>'
            );
            
            // P콏idej event listener po renderov치n칤
            setTimeout(function() {
                var btn = document.getElementById('importBtn');
                if (btn) {
                    btn.onclick = importSave;
                }
            }, 100);
        }
        
        function importSave() {
            console.log('importSave called');
            try {
                var codeEl = document.getElementById('importCode');
                if (!codeEl) {
                    notifyError('Chyba!', 'Nenalezen input');
                    console.error('importCode element not found');
                    return;
                }
                
                var code = codeEl.value.trim();
                
                // Odstran캩n칤 neviditeln칳ch znak콢 (BOM, zero-width spaces, atd.)
                code = code.replace(/[\u200B-\u200D\uFEFF\u00A0\u2060\u180E]/g, '');
                // Odstran캩n칤 v코ech whitespace znak콢 (mezery, nov칠 콏치dky, taby)
                code = code.replace(/\s/g, '');
                
                console.log('Code length after cleanup:', code.length);
                
                if (!code) {
                    notifyError('Pr치zdn칳 k칩d!', 'Vlo exportovan칳 k칩d');
                    return;
                }
                
                // Dek칩duj z base64
                var decoded;
                try {
                    decoded = decodeURIComponent(escape(atob(code)));
                } catch(e) {
                    // Zkus je코t캩 jednou odstranit p콏칤padn칠 probl칠my
                    try {
                        // N캩kdy se na konci p콏id치 = padding nav칤c
                        var cleanCode = code.replace(/[^A-Za-z0-9+/=]/g, '');
                        decoded = decodeURIComponent(escape(atob(cleanCode)));
                    } catch(e2) {
                        notifyError('Neplatn칳 k칩d!', 'K칩d obsahuje neplatn칠 znaky. Zkus ho zkop칤rovat znovu.');
                        console.error('Base64 decode error:', e, e2);
                        return;
                    }
                }
                
                var saveData;
                try {
                    saveData = JSON.parse(decoded);
                } catch(e) {
                    notifyError('Neplatn칳 save!', 'Data nejsou platn칳 JSON');
                    console.error('JSON parse error:', e);
                    return;
                }
                
                // Validace
                if (!saveData.char || !saveData.char.name) {
                    notifyError('Neplatn칳 save!', 'Chyb칤 data postavy');
                    return;
                }
                
                // D콡LE콯IT칄: Sma star칳 save kompletn캩
                localStorage.removeItem('survival_hero_save');
                localStorage.removeItem('survival_hero_save_v2');
                localStorage.removeItem('survival_hero_backup');
                
                // P콏idej flag 쬰 jde o 캜erstv칳 import (aby se nemigrovala data)
                saveData._freshImport = true;
                saveData._importTime = Date.now();
                
                // Ulo do localStorage (star치 verze pro kompatibilitu)
                localStorage.setItem('survival_hero_save', JSON.stringify(saveData));
                
                // Ulo i 코ifrovanou verzi pokud je k dispozici
                if (typeof encryptData === 'function') {
                    const encrypted = encryptData(saveData);
                    if (encrypted) {
                        localStorage.setItem('survival_hero_save_v2', encrypted);
                    }
                }
                
                console.log('Save imported for:', saveData.char.name);
                console.log('Imported data keys:', Object.keys(saveData));
                
                var charName = saveData.char.name || 'Nezn치m칳';
                var charLevel = saveData.char.level || 1;
                var invCount = saveData.inv?.length || 0;
                var gold = saveData.money || 0;
                var visitedLocs = saveData.world?.visitedLocations?.length || 0;
                
                showModal('九 Import 칰sp캩코n칳!', 
                    '<div style="text-align: center;">' +
                        '<div style="font-size: 3rem; margin-bottom: 1rem;">九</div>' +
                        '<p style="color: #4caf50; font-weight: bold; font-size: 1.2rem;">Postava na캜tena!</p>' +
                        '<div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">' +
                            '<p style="color: #ffd700; margin: 0; font-size: 1.3rem;">' + charName + '</p>' +
                            '<p style="color: #888; margin: 0.3rem 0 0 0;">Level ' + charLevel + '</p>' +
                            '<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 0.5rem; font-size: 0.85rem; color: #aaa;">' +
                                '<span>游눯 ' + gold + '</span>' +
                                '<span>游 ' + invCount + '</span>' +
                                '<span>游딬勇 ' + visitedLocs + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<p style="color: #ff9800; font-size: 0.85rem;">丘멆잺 Klikni na tla캜칤tko pro dokon캜en칤 importu!</p>' +
                        '<button class="btn" onclick="location.reload(true)" style="width: 100%; background: var(--rust); margin-top: 0.5rem;">游댃 Na캜칤st hru</button>' +
                    '</div>'
                );
            } catch (e) {
                notifyError('Chyba importu!', e.message);
                console.error('Import error:', e);
            }
        }
        
        function confirmNewGame() {
            showModal('游 Nov치 hra', `
                <p>Opravdu chce코 za캜칤t novou hru?</p>
                <p style="color: #c62828; font-size: 0.9rem;">丘멆잺 Aktu치ln칤 hra bude smaz치na!</p>
                ${currentUser && !currentUser.isAnonymous ? `
                    <div style="background: #1a2a3a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="deleteCloudSave" checked style="width: 18px; height: 18px;">
                            <span>驕勇 Smazat i cloud save</span>
                        </label>
                        <p style="color: #888; font-size: 0.75rem; margin: 0.5rem 0 0 0;">Jinak se po reloadu na캜te star치 hra z cloudu</p>
                    </div>
                ` : ''}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="startNewGame()" style="background: #8B0000;">游 Nov치 hra</button>
                </div>
            `);
        }
        
        async function startNewGame() {
            try {
                // Sma cloud save pokud je za코krtnuto
                const deleteCloud = document.getElementById('deleteCloudSave')?.checked;
                if (deleteCloud && currentUser && !currentUser.isAnonymous && firebaseDB) {
                    console.log('游딈勇 Ma쬿 cloud save...');
                    await firebaseDB.ref('cloudSaves/' + currentUser.uid).remove();
                }
                
                // Nastav flag 쬰 vytv치콏칤me novou postavu (oboje - localStorage i sessionStorage pro jistotu)
                localStorage.setItem('creatingNewCharacter', 'true');
                sessionStorage.setItem('creatingNewCharacter', 'true');
                window.creatingNewCharacter = true;
                
                // Sma v코echny ulo쬰n칠 hry
                localStorage.removeItem('survival_hero_save');
                localStorage.removeItem('survival_hero_save_v2');
                localStorage.removeItem('survival_hero_backup');
                localStorage.removeItem('friendsList_' + (state.char?.name || ''));
                console.log('游딈勇 Save smaz치n, reloaduji...');
            } catch(e) {
                console.error('Chyba p콏i maz치n칤 save:', e);
            }
            location.reload();
        }
        
        // O쬴ven칤 hr치캜e po smrti
        function respawnPlayer() {
            state.isDead = false;
            state.char.hp = Math.floor(state.char.maxHp * 0.5); // 50% HP
            state.status.hunger = 30;
            state.status.thirst = 30;
            state.status.energy = 30;
            state.status.radiation = Math.max(0, state.status.radiation - 20);
            
            // Teleport do 칰krytu
            state.world.currentLocation = 'shelter';
            state.world.traveling = false;
            state.map.traveling = false;
            state.map.inBase = true;
            
            // Ztr치ta 캜치sti invent치콏e (25% v캩c칤) - zapamatuj si co se ztratilo
            const lostItems = [];
            const itemsToLose = Math.floor(state.inv.length * 0.25);
            for (let i = 0; i < itemsToLose; i++) {
                const randomIndex = Math.floor(Math.random() * state.inv.length);
                const lostItem = state.inv[randomIndex];
                if (lostItem && lostItem.type !== 'quest') { // Neztr치cet quest itemy
                    lostItems.push({
                        name: lostItem.name || getItemName(lostItem.id),
                        icon: lostItem.icon || '游닍',
                        count: lostItem.count || 1
                    });
                    state.inv.splice(randomIndex, 1);
                }
            }
            
            // Ztr치ta 30% pen캩z
            const moneyBefore = getMoney();
            const moneyLost = Math.floor(moneyBefore * 0.3);
            if (moneyLost > 0) {
                removeMoney(moneyLost);
            }
            
            // Zobraz modal s informac칤 o ztr치t치ch
            let lostItemsHtml = '';
            if (lostItems.length > 0) {
                lostItemsHtml = `
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; max-height: 150px; overflow-y: auto;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b; font-size: 0.9rem;">游닍 Ztracen칠 v캩ci:</h4>
                        ${lostItems.map(item => `
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.2rem;">
                                <span>${item.icon}</span>
                                <span style="color: #888; font-size: 0.85rem;">${item.name}${item.count > 1 ? ' x' + item.count : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                lostItemsHtml = '<p style="color: #8bc34a; margin: 0.5rem 0;">九 Neztratil jsi 쮂멳n칠 v캩ci!</p>';
            }
            
            showModal('游 O쬴ven칤', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">游낀</div>
                    <p style="color: #888;">Probudil ses v 칰krytu...</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0; color: #8bc34a;">仇벒잺 HP obnoveno na 50%</p>
                        <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">游꼤 Hlad: 30% | 游눦 콯칤ze켿: 30% | 丘 Energie: 30%</p>
                    </div>
                    
                    ${moneyLost > 0 ? `<p style="color: #ff9800;">游눯 Ztr치ta pen캩z: -${moneyLost} (m캩l jsi ${moneyBefore})</p>` : ''}
                    
                    ${lostItemsHtml}
                </div>
                
                <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">
                    九 Pokra캜ovat
                </button>
            `);
            
            addLog(`Probudil ses v 칰krytu. Ztratil jsi ${lostItems.length} v캩c칤 a ${moneyLost} 游눯.`, '游');
            saveGame(true);
        }
        
        function deleteSave() {
            showModal('丘멆잺 Smazat hru?', `
                <p>Opravdu chce코 smazat ulo쬰nou hru?</p>
                <p style="color: #c62828; font-size: 0.9rem;">Tato akce je nevratn치!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="confirmDeleteSave()" style="background: #c62828;">游딈勇 Smazat</button>
                </div>
            `);
        }
        
        function confirmDeleteSave() {
            localStorage.removeItem('survival_hero_save');
            closeModal();
            showModal('九 Smaz치no!', '<p>Ulo쬰n치 hra byla smaz치na.</p><button class="btn" onclick="location.reload()" style="width: 100%; margin-top: 1rem;">游댃 Nov치 hra</button>');
        }
        
        // === GAME LOOP ===
        setInterval(() => {
            const now = Date.now();
            const delta = (now - state.time.last) / 1000; // seconds since last tick
            state.time.last = now;
            
            // Calculate total elapsed time (keeps counting even after reload)
            state.time.totalElapsed += delta;
            
            // Display REAL TIME instead of game time
            const realDate = new Date();
            state.time.hours = realDate.getHours();
            state.time.mins = realDate.getMinutes();
            state.time.days = Math.floor(state.time.totalElapsed / 86400); // Days from gameplay (24h real = 1 game day)
            
            // Update weather
            if (state.confirmed) {
                updateWeather();
            }
            
            // Update diseases (efekty nemoc칤)
            if (state.confirmed) {
                applyDiseaseEffects();
            }
            
            // Update injuries (efekty zran캩n칤)
            if (state.confirmed && typeof applyInjuryEffects === 'function') {
                applyInjuryEffects();
            }
            
            // Process building queue
            if (state.confirmed) {
                processBuildQueue();
            }
            
            // Settlement daily update
            if (!state.settlement.lastUpdateDay) state.settlement.lastUpdateDay = 0;
            if (state.time.days > state.settlement.lastUpdateDay) {
                updateSettlementDaily();
                checkFoodSpoilage(); // Kontrola kazen칤 j칤dla
                feedCompanions(); // Krmen칤 spole캜n칤k콢 (legacy - te캞 se vol치 ka쬯ou hodinu)
                processFactionTerritoryIncome(); // P콏칤jem z PvP frakc칤 a 칰zem칤
                
                // === DUNGEON RESET CHECK (ka쬯칳 den) ===
                if (state.dungeon?.cleared) {
                    const DUNGEON_RESET_TIME = 24 * 60 * 60 * 1000; // 24 hodin
                    for (const [dungeonId, clearData] of Object.entries(state.dungeon.cleared)) {
                        if (clearData?.clearedAt) {
                            const timeSinceClear = Date.now() - clearData.clearedAt;
                            if (timeSinceClear >= DUNGEON_RESET_TIME) {
                                delete state.dungeon.cleared[dungeonId];
                                const dungeonData = DUNGEON_FLOORS?.[dungeonId];
                                if (dungeonData) {
                                    addLog(`游낋 ${dungeonData.name} se resetoval - nep콏치tel칠 se vr치tili!`, '游댃');
                                }
                            }
                        }
                    }
                }
                
                // === DENN칈 BONUS LOAJALITY PRO SPOLE캛N칈KY ===
                if (state.companions && state.companions.length > 0) {
                    state.companions.forEach(comp => {
                        if (!comp.isDead) {
                            // P콏idej dny aktivn칤
                            comp.daysActive = (comp.daysActive || 0) + 1;
                            
                            // Bonus loajalita za ka쬯칳 den spolu (+1)
                            comp.loyalty = Math.min(100, (comp.loyalty || 0) + 1);
                            
                            // Penalty pokud nebyl nakrmen/napojen za posledn칤ch 24h
                            const now = Date.now();
                            const DAY_MS = 24 * 60 * 60 * 1000;
                            if (!comp.lastFedTime || (now - comp.lastFedTime) >= DAY_MS) {
                                comp.loyalty = Math.max(0, (comp.loyalty || 0) - 3);
                            }
                            if (!comp.lastWateredTime || (now - comp.lastWateredTime) >= DAY_MS) {
                                comp.loyalty = Math.max(0, (comp.loyalty || 0) - 2);
                            }
                        }
                    });
                }
                
                MobileNotifications.notifyNewDay(state.time.days); // Push notifikace
                state.settlement.lastUpdateDay = state.time.days;
                
                // === ACHIEVEMENT TRACKING - denn칤 ===
                // Pacifist - kolik dn칤 bez zabit칤
                if (state.stats.lastKillDay === undefined) state.stats.lastKillDay = -1;
                const daysSinceLastKill = state.time.days - state.stats.lastKillDay;
                if (daysSinceLastKill > (state.stats.pacifistDays || 0)) {
                    state.stats.pacifistDays = daysSinceLastKill;
                }
            }
            
            // === ACHIEVEMENT TRACKING - pr콢b캩쬹칠 ===
            // Near death experience (1-5 HP)
            if (state.confirmed && state.char.hp <= 5 && state.char.hp > 0) {
                state.stats.nearDeathExp = (state.stats.nearDeathExp || 0) + 1;
            }
            
            // === KRMEN칈 SPOLE캛N칈K콡 (ka쬯ou hodinu re치ln칠ho 캜asu) ===
            if (state.confirmed && state.companions && state.companions.length > 0) {
                if (!state._lastCompanionFeedCheck) state._lastCompanionFeedCheck = 0;
                if (now - state._lastCompanionFeedCheck > 3600000) { // Ka쬯ou hodinu
                    state._lastCompanionFeedCheck = now;
                    feedCompanions();
                }
            }
            
            // === SETTLEMENT EVENTY KA콯D칗CH 6 HODIN ===
            // Ale a 12 hodin po vytvo콏en칤 postavy
            const twelveHoursMs = 12 * 60 * 60 * 1000;
            const gameAge = state.time?.totalElapsed ? state.time.totalElapsed * 1000 : (now - (state.time?.realStart || now));
            
            if (!state.settlement.lastEventCheck) state.settlement.lastEventCheck = 0;
            if (gameAge >= twelveHoursMs && now - state.settlement.lastEventCheck > 21600000) { // Ka쬯칳ch 6 hodin, ale a po 12h hran칤
                state.settlement.lastEventCheck = now;
                checkSettlementEvents();
            }
            
            // === DENN칈 KASINO BONUS (ka쬯칳ch 24 hodin re치ln칠ho 캜asu) ===
            if (state.confirmed) {
                if (!state._lastCasinoCheck) state._lastCasinoCheck = 0;
                if (now - state._lastCasinoCheck > 60000) { // Kontroluj ka쬯ou minutu
                    state._lastCasinoCheck = now;
                    checkDailyCasinoTokens();
                }
            }
            
            // === REGENERACE Z BUDOV (ka쬯ou minutu kdy jsi v base) ===
            if (state.confirmed && state.map.inBase) {
                if (!state._lastBuildingRegen) state._lastBuildingRegen = 0;
                if (now - state._lastBuildingRegen > 60000) { // Ka쬯ou minutu
                    state._lastBuildingRegen = now;
                    const bonuses = getBuildingBonuses();
                    
                    // HP regenerace (nap콏. L콢쬶o +2, O코et콏ovna +5)
                    if (bonuses.hp > 0 && state.char.hp < state.char.maxHp) {
                        const oldHp = state.char.hp;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + bonuses.hp);
                        if (state.char.hp > oldHp) {
                            // Tich칠 l칠캜en칤 - jen log
                            console.log(`游낀 Regenerace z budov: +${state.char.hp - oldHp} HP`);
                        }
                    }
                    
                    // Energie regenerace
                    if (bonuses.energy > 0 && state.status.energy < 100) {
                        state.status.energy = Math.min(100, state.status.energy + bonuses.energy);
                    }
                    
                    // Morale bonus pro hr치캜e
                    if (bonuses.morale > 0 && state.status.mood < 100) {
                        state.status.mood = Math.min(100, state.status.mood + Math.floor(bonuses.morale / 10));
                    }
                }
            }
            
            // === PUSH NOTIFIKACE PRO KRITICK칄 STAVY ===
            if (state.confirmed && !state._lastNotifyCheck) state._lastNotifyCheck = 0;
            if (state.confirmed && now - state._lastNotifyCheck > 60000) { // Max 1x za minutu
                state._lastNotifyCheck = now;
                
                // Kritick칠 HP
                if (state.char.hp < state.char.maxHp * 0.2) {
                    MobileNotifications.notifyLowHealth();
                }
                // Kritick칳 hlad
                if (state.status.hunger < 15) {
                    MobileNotifications.notifyLowHunger();
                }
                // Kritick치 쮂셬e켿
                if (state.status.thirst < 15) {
                    MobileNotifications.notifyLowThirst();
                }
            }
            
            // Check for settlement raids (every 5 minutes of real time)
            if (state.confirmed && state.map.inBase) {
                // Napl치nuj dal코칤 raid pokud nen칤 napl치novan칳
                if (!state.settlement.nextRaidCheck) {
                    state.settlement.nextRaidCheck = now + 300000; // 5 min od te캞
                }
                
                // Kontrola jestli nastal 캜as
                if (now >= state.settlement.nextRaidCheck) {
                    state.settlement.nextRaidCheck = now + 300000; // Dal코칤 za 5 min
                    if (checkForRaid()) {
                        startSettlementRaid();
                    }
                }
            }
            
            // === FRAK캛N칈 DAN캨 Z 칔ZEM칈 (ka쬯ou hodinu) ===
            if (state.confirmed && multiplayerEnabled && firebaseDB) {
                if (!state._lastTerritoryTaxCheck) state._lastTerritoryTaxCheck = 0;
                if (now - state._lastTerritoryTaxCheck > 3600000) { // Ka쬯ou hodinu
                    state._lastTerritoryTaxCheck = now;
                    collectTerritoryTaxes();
                }
            }
            
            // === OBSAZOV츼N칈 칔ZEM칈 (ka쬯ou sekundu) ===
            if (state.confirmed && state.territoryCapture && Object.keys(state.territoryCapture).length > 0) {
                updateTerritoryCapture(delta);
            }
            
            // === KARAVANA SYST칄M (perzistentn칤) ===
            if (state.confirmed) {
                // Inicializace
                if (!state.caravan) {
                    state.caravan = { active: false, until: 0, nextCheck: now + 3600000 };
                }
                
                // Napl치nuj dal코칤 check pokud nen칤
                if (!state.caravan.nextCheck) {
                    state.caravan.nextCheck = now + 3600000; // 60 min
                }
                
                // Kontrola jestli nastal 캜as na mo쬹ou karavanu (ka쬯칳ch 24 hodin hern칤ho 캜asu)
                if (now >= state.caravan.nextCheck && !state.caravan.active) {
                    state.caravan.nextCheck = now + 86400000; // Dal코칤 check za 24 hodin re치ln칠ho 캜asu
                    
                    // Z치kladn칤 코ance 20% + bonusy
                    let caravanChance = 0.20;
                    
                    // Bonus ze scout skillu (Ranger lvl 4 = +10%)
                    const scout = state.settlement?.settlers?.find(s => s.type === 'scout');
                    if (scout && scout.skillLevel >= 4) {
                        caravanChance += 0.10;
                    }
                    
                    // Bonus ze "S칤콘 kontakt콢" skillu (+20%)
                    if (state.unlockedAbilities?.network) {
                        caravanChance += 0.20;
                    }
                    
                    // Bonus z budovy "Obchodn칤 stanice" (+15%)
                    if (state.settlement?.buildings?.includes('trading_post') || state.base?.includes('trading_post')) {
                        caravanChance += 0.15;
                    }
                    
                    if (Math.random() < caravanChance) {
                        state.caravan.active = true;
                        state.caravan.until = now + 300000; // 5 minut
                        notifyInfo('游냙 Karavana dorazila!', 'Obchodn칤ci jsou v oblasti na 5 minut');
                        sendSystemNotification('Karavana dorazila!', 'Obchodn칤ci jsou v oblasti na 5 minut', '游냙');
                        addLog('Karavana obchodn칤k콢 dorazila!', '游냙');
                    }
                }
                
                // Kontrola jestli karavana neode코la
                if (state.caravan.active && now > state.caravan.until) {
                    state.caravan.active = false;
                    addLog('Karavana odjela.', '游냙');
                }
                
                // Sync pro star칳 syst칠m
                state.caravanPresent = state.caravan.active;
            }
            
            // Check if travel is complete
            checkTravelComplete();
            
            // Check scheduled travel events (p콏e쬴j칤 refresh!)
            checkScheduledEvents();
            
            // Synchronizace state.map s state.world
            state.map.traveling = state.world.traveling;
            if (state.world.currentLocation === 'shelter' && !state.world.traveling) {
                // V shelter lokaci - inBase z치vis칤 na hr치캜ov캩 volb캩 (toggleBase)
            } else {
                state.map.inBase = false;
            }
            
            // Check if sleeping
            if (state.sleepEndTime && now < state.sleepEndTime) {
                // Player is sleeping
                const sleepProgress = (now - state.lastSleepTime) / (state.sleepEndTime - state.lastSleepTime);
                
                // During sleep: regen HP & energy, consume hunger & thirst faster
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + (50 / 3600) * delta); // +50 HP per hour
                state.status.energy = Math.min(100, state.status.energy + (80 / 3600) * delta); // +80 energy per hour
                state.status.hunger = Math.max(0, state.status.hunger - (30 / 3600) * delta); // -30 hunger per hour
                state.status.thirst = Math.max(0, state.status.thirst - (40 / 3600) * delta); // -40 thirst per hour
                
                // Skip normal consumption during sleep
            } else if (state.sleepEndTime && now >= state.sleepEndTime) {
                // Sleep ended - apply FULL effects (in case player was offline)
                state.status.energy = 100;
                const sleepHeal = 50;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + sleepHeal);
                state.status.hunger = Math.max(0, state.status.hunger - 30); // -30 hlad
                state.status.thirst = Math.max(0, state.status.thirst - 40); // -40 쮂셬e켿
                state.sleepEndTime = null;
                state.isSleeping = false;
                
                // Daily quest progress - healing
                if (state.dailyQuests?.progress) {
                    state.dailyQuests.progress.healed = (state.dailyQuests.progress.healed || 0) + sleepHeal;
                    checkDailyQuests();
                }
                
                addLog('Probudil ses ze sp치nku! C칤t칤코 se odpo캜at칳.', '游땕');
                showModal('游땕 Probudil ses!', `
                    <p>Spal jsi 1 hodinu a c칤t칤코 se odpo캜at칳!</p>
                    <p style="color: #8bc34a;">九 Energie: 100%</p>
                    <p style="color: #8bc34a;">九 HP: +50</p>
                    <p style="color: #ff9800;">丘멆잺 Hlad: -30</p>
                    <p style="color: #ff9800;">丘멆잺 콯칤ze켿: -40</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">九 OK</button>
                `);
            }
            
            if (state.confirmed && !state.sleepEndTime) {
                // Passive consumption per real second
                // Much faster: 100% in 2 hours (7200 seconds) instead of 24 hours
                let hungerRate = 100 / 86400; // 24 hours to deplete
                let thirstRate = (100 / 86400) * 1.2; // 20 hours to deplete (slightly faster than hunger)
                let energyRate = 100 / 86400; // 24 hours to deplete
                
                // Aplikace mutac칤 na spot콏ebu
                if (state.mutations && state.mutations.length > 0) {
                    state.mutations.forEach(m => {
                        if (m.effect?.hungerRate) {
                            hungerRate *= m.effect.hungerRate; // 1.5 = +50% hlad
                        }
                        if (m.effect?.energyDrain) {
                            energyRate *= m.effect.energyDrain; // 1.3 = +30% energie
                        }
                    });
                }
                
                // Apply skill bonuses
                const ironStomachLevel = state.skills['iron_stomach'] || 0;
                if (ironStomachLevel > 0) {
                    const skill = SKILLS.find(s => s.id === 'iron_stomach');
                    hungerRate *= (1 - skill.value * ironStomachLevel);
                }
                
                const waterSaverLevel = state.skills['water_saver'] || 0;
                if (waterSaverLevel > 0) {
                    const skill = SKILLS.find(s => s.id === 'water_saver');
                    thirstRate *= (1 - skill.value * waterSaverLevel);
                }
                
                const enduranceLevel = state.skills['endurance'] || 0;
                if (enduranceLevel > 0) {
                    const skill = SKILLS.find(s => s.id === 'endurance');
                    energyRate *= (1 - skill.value * enduranceLevel);
                }
                
                // Nomad passive - 50% slower consumption
                const consumptionMod = hasClassPassive('consumptionReduction') ? 0.5 : 1.0;
                
                // Apply consumption based on state
                if (state.map.traveling) {
                    // During travel: use travel-specific rates (higher consumption)
                    // Ochrana AFK hr치캜콢 - b캩hem cesty neklesne pod 5% (tak쬰 nedostane코 damage)
                    const MIN_TRAVEL_STATUS = 5;
                    state.status.hunger = Math.max(MIN_TRAVEL_STATUS, state.status.hunger - state.map.travelHungerRate * delta * consumptionMod);
                    state.status.thirst = Math.max(MIN_TRAVEL_STATUS, state.status.thirst - state.map.travelThirstRate * delta * consumptionMod);
                    state.status.energy = Math.max(MIN_TRAVEL_STATUS, state.status.energy - state.map.travelEnergyRate * delta);
                    
                    // Mutant radiation handling
                    if (hasClassPassive('radiationImmune')) {
                        const radGain = state.map.travelRadRate * delta;
                        const radPassive = getClassPassive('onRadiation', radGain);
                        // Radiation heals mutant instead
                    } else {
                        // Omezen칤 radiace b캩hem cestov치n칤 - max +20% za celou cestu
                        // Chr치n칤 hr치캜e p콏ed smrt칤 kdy jsou offline b캩hem radia캜n칤 bou콏e
                        const radGain = state.map.travelRadRate * delta;
                        if (!state.map.travelRadAccumulated) state.map.travelRadAccumulated = 0;
                        
                        const MAX_TRAVEL_RAD = 20; // Max 20% radiace za jednu cestu
                        if (state.map.travelRadAccumulated < MAX_TRAVEL_RAD) {
                            const allowedGain = Math.min(radGain, MAX_TRAVEL_RAD - state.map.travelRadAccumulated);
                            state.status.radiation = Math.min(100, state.status.radiation + allowedGain);
                            state.map.travelRadAccumulated += allowedGain;
                        }
                    }
                } else if (!state.map.inBase) {
                    // Normal passive consumption when not traveling and not in base
                    state.status.hunger = Math.max(0, state.status.hunger - hungerRate * delta * consumptionMod);
                    
                    // Desert Walker (Nomad set 2) - 쮂셬e켿 kles치 o 30% pomaleji
                    let thirstMod = 1.0;
                    const setEffectsThirst = typeof getActiveSetEffects === 'function' ? getActiveSetEffects() : {};
                    if (setEffectsThirst.desertWalker) {
                        thirstMod = 0.7; // -30%
                    }
                    state.status.thirst = Math.max(0, state.status.thirst - thirstRate * delta * consumptionMod * thirstMod);
                    state.status.energy = Math.max(0, state.status.energy - energyRate * delta);
                    
                    // Automatick칠 konzumov치n칤 pokud m치 hr치캜 perk (kontrola ka쬯칳ch 10s)
                    if (Math.floor(now / 10000) !== Math.floor((now - delta * 1000) / 10000)) {
                        autoConsumeIfDying();
                    }
                    
                    // === P콎IROZEN츼 REGENERACE HP ===
                    // 5 HP za hodinu, ale jen pokud nen칤 hladov칳/dehydratovan칳 a m치 m칠n캩 ne max HP
                    if (state.char.hp < state.char.maxHp && state.status.hunger > 20 && state.status.thirst > 20 && state.status.radiation < 50) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + (5 / 3600) * delta); // +5 HP per hour
                    }
                    
                    // Medic passive - regeneration (bonus nav칤c)
                    if (state.char.classId === 'medic' && state.char.hp < state.char.maxHp) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + 2 * delta / 60); // +2 HP per minute
                    }
                    
                    // Status warnings - flash red when critical
                    if (state.status.hunger <= 20 && Math.floor(now / 1000) % 3 === 0) {
                        document.body.style.animation = 'flash-red 0.5s';
                        setTimeout(() => document.body.style.animation = '', 500);
                    }
                    if (state.status.thirst <= 20 && Math.floor(now / 1000) % 3 === 0) {
                        document.body.style.animation = 'flash-red 0.5s';
                        setTimeout(() => document.body.style.animation = '', 500);
                    }
                } else {
                    // Regeneration in base (per real second)
                    // === P콎IROZEN츼 REGENERACE V Z츼KLADN캨 ===
                    // V z치kladn캩 se HP regeneruje rychleji - 10 HP za hodinu
                    if (state.char.hp < state.char.maxHp && state.status.radiation < 50) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + (10 / 3600) * delta); // +10 HP per hour in base
                    }
                    
                    if (state.base.includes('bed')) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + 2 * delta / 3600);
                        state.status.energy = Math.min(100, state.status.energy + 2 * delta / 3600);
                    }
                    if (state.base.includes('garden')) {
                        state.status.hunger = Math.min(100, state.status.hunger + 1 * delta / 3600);
                    }
                    if (state.base.includes('water')) {
                        state.status.thirst = Math.min(100, state.status.thirst + 1.5 * delta / 3600);
                    }
                    
                    // Survivor skill passive regen
                    const survivorLevel = state.skills['survivor'] || 0;
                    if (survivorLevel > 0) {
                        const skill = SKILLS.find(s => s.id === 'survivor');
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + skill.value * survivorLevel * delta / 60);
                    }
                }
                
                // === P콎IROZEN칄 SNI콯OV츼N칈 RADIACE ===
                // Radiace kles치 pomalu sama od sebe kdy nejsi v radioaktivn칤 z칩n캩
                // Pod 50%: -2% za hodinu, 50-80%: -1% za hodinu, nad 80%: nekles치 (pot콏ebuje코 RadAway)
                if (state.status.radiation > 0 && !state.world?.traveling) {
                    let radDecay = 0;
                    if (state.status.radiation < 50) {
                        radDecay = 2 / 3600 * delta; // -2% za hodinu
                    } else if (state.status.radiation < 80) {
                        radDecay = 1 / 3600 * delta; // -1% za hodinu
                    }
                    // Nad 80% radiace nekles치 p콏irozen캩 - pot콏ebuje코 l칠ky!
                    
                    if (radDecay > 0) {
                        state.status.radiation = Math.max(0, state.status.radiation - radDecay);
                    }
                }
                
                // Radiation sickness
                if (state.status.radiation > 50) {
                    // 50-80%: velmi m칤rn칠 damage (0.1-0.3 HP/min) - hr치캜 p콏e쬴je i offline
                    // 80-99%: m칤rn칠 damage (0.3-1 HP/min) - st치le p콏e쬴teln칠
                    // 100%: kritick칠 - rychl치 smrt (5 HP/min) - nutn칠 l칠캜it!
                    let radDamage;
                    if (state.status.radiation >= 100) {
                        radDamage = 5 * delta / 3600; // 5 HP/hodinu p콏i 100%
                        // P콏i 100% radiaci M콡콯E hr치캜 zem콏칤t!
                        state.char.hp = Math.max(0, state.char.hp - radDamage);
                    } else if (state.status.radiation >= 80) {
                        radDamage = (0.3 + (state.status.radiation - 80) * 0.035) * delta / 60; // 0.3-1 HP/min
                        state.char.hp = Math.max(1, state.char.hp - radDamage); // Min 1 HP - nelze zem콏칤t pod 100%
                    } else {
                        radDamage = (0.1 + (state.status.radiation - 50) * 0.007) * delta / 60; // 0.1-0.3 HP/min
                        state.char.hp = Math.max(1, state.char.hp - radDamage); // Min 1 HP - nelze zem콏칤t pod 100%
                    }
                    
                    // Log warning
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        if (state.status.radiation >= 100) {
                            addLog('驕멆잺 KRITICK츼 RADIACE! Um칤r치코!', '驕뮖잺');
                        } else if (state.status.radiation > 70) {
                            addLog('丘멆잺 Radia캜n칤 nemoc! Vysok치 radiace ti bere zdrav칤!', '驕뮖잺');
                        }
                    }
                }
                
                // === MUTACE Z RADIACE ===
                // 마nce na mutaci ka쬯칳ch 15 minut p콏i vysok칠 radiaci
                if (!state.lastMutationCheck) state.lastMutationCheck = 0;
                if (now - state.lastMutationCheck > 900000) { // Ka쬯칳ch 15 minut (900000ms)
                    state.lastMutationCheck = now;
                    
                    if (state.status.radiation > 50 && (state.mutations?.length || 0) < 5) {
                        checkForMutation();
                    }
                }
                
                // === PENALIZACE ZA N칈ZK칄 STATY ===
                // Kontrola noStarvation skillu (P콏e쮂셨a캜 tier 4)
                const hasNoStarvation = getSkillTreeBonus('noStarvation') > 0;
                
                // Po코kozen칤 z hladu (0% = -5 HP/min) - ale ne se skillem P콏e쮂셨a캜
                if (state.status.hunger <= 0 && !hasNoStarvation) {
                    const hungerDmg = 5 * delta / 60;
                    state.char.hp = Math.max(1, state.char.hp - hungerDmg); // Min 1 HP
                    if (Math.floor(state.time.totalElapsed) % 30 === 0) {
                        addLog('丘멆잺 Hladov칤코! Ztr치c칤코 zdrav칤!', '游꼤');
                    }
                } else if (state.status.hunger <= 0 && hasNoStarvation) {
                    // Se skillem jen warning, ne damage
                    state.char.hp = Math.max(1, state.char.hp);
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        addLog('游끥 Hladov칤코, ale p콏e쮂셨치코 d칤ky skillu!', '游꼤');
                    }
                }
                
                // Po코kozen칤 z 쮂셬n캩 (0% = -8 HP/min, rychlej코칤 ne hlad) - ale ne se skillem P콏e쮂셨a캜
                if (state.status.thirst <= 0 && !hasNoStarvation) {
                    const thirstDmg = 8 * delta / 60;
                    state.char.hp = Math.max(1, state.char.hp - thirstDmg); // Min 1 HP
                    if (Math.floor(state.time.totalElapsed) % 30 === 0) {
                        addLog('丘멆잺 Dehydratuje코! Ztr치c칤코 zdrav칤!', '游눦');
                    }
                } else if (state.status.thirst <= 0 && hasNoStarvation) {
                    // Se skillem jen warning, ne damage
                    state.char.hp = Math.max(1, state.char.hp);
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        addLog('游끥 Dehydratuje코, ale p콏e쮂셨치코 d칤ky skillu!', '游눦');
                    }
                }
                
                // Penalizace za vy캜erp치n칤 (0% energie = -50% max HP efektivn캩)
                if (state.status.energy <= 0) {
                    // Pomal칠 HP po코kozen칤 - ale ne b캩hem cestov치n칤 (ochrana AFK hr치캜콢)
                    const energyDmg = 2 * delta / 60;
                    const minHp = state.world?.traveling ? 1 : 0; // B캩hem cesty min 1 HP
                    state.char.hp = Math.max(minHp, state.char.hp - energyDmg);
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        addLog('丘멆잺 Jsi vy캜erpan칳! Pot콏ebuje코 odpo캜inek!', '游땺');
                    }
                }
                
                // === SMRT ===
                if (state.char.hp <= 0 && !state.isDead) {
                    state.isDead = true;
                    state.stats.deaths = (state.stats.deaths || 0) + 1;
                    
                    // Detailn칤 p콏칤캜ina smrti
                    let deathReason = 'Zem콏el jsi';
                    let deathDetails = '';
                    
                    if (state.status.hunger <= 0) {
                        deathReason = '游꼤 Zem콏el jsi hlady';
                        deathDetails = 'Hlad: 0%';
                    } else if (state.status.thirst <= 0) {
                        deathReason = '游눦 Zem콏el jsi 쮂셬n칤';
                        deathDetails = '콯칤ze켿: 0%';
                    } else if (state.status.radiation >= 100) {
                        deathReason = '驕뮖잺 Zem콏el jsi na radiaci';
                        deathDetails = `Radiace: ${state.status.radiation.toFixed(0)}%`;
                    } else if (state.lastDamageSource) {
                        // Pokud m치me ulo쬰nou p콏칤캜inu posledn칤ho po코kozen칤
                        deathReason = `丘덢잺 Zabil t캩: ${state.lastDamageSource}`;
                        deathDetails = `Posledn칤 damage: ${state.lastDamageAmount || '?'}`;
                    } else if (state.status.hunger < 20 || state.status.thirst < 20) {
                        deathReason = '游땻 Zem콏el jsi vy캜erp치n칤m';
                        deathDetails = `Hlad: ${state.status.hunger.toFixed(0)}%, 콯칤ze켿: ${state.status.thirst.toFixed(0)}%`;
                    }
                    
                    // Ulo p콏칤캜inu smrti do statistik
                    state.stats.lastDeathReason = deathReason;
                    state.stats.lastDeathDetails = deathDetails;
                    
                    const deathTexts = {
                        title: '游 SMRT',
                        survived: 'P콏e쬴l jsi',
                        days: 'dn칤',
                        kills: 'Zabit칤',
                        deaths: '칔mrt칤',
                        respawn: '游댃 O쬴vit (ztrat칤코 캜치st v캩c칤)',
                        newGame: '游 Nov치 hra'
                    };
                    showModal(deathTexts.title, `
                        <div style="text-align: center;">
                            <div style="font-size: 5rem; margin-bottom: 1rem;">游</div>
                            <h2 style="color: #ff4444;">${deathReason}</h2>
                            ${deathDetails ? `<p style="color: #ff9800; font-size: 0.9rem;">${deathDetails}</p>` : ''}
                            <p style="color: #888; margin: 1rem 0;">${deathTexts.survived} ${state.time.days} ${deathTexts.days}.</p>
                            <p style="color: #666; font-size: 0.85rem;">${deathTexts.kills}: ${state.stats.kills || 0} | ${deathTexts.deaths}: ${state.stats.deaths}</p>
                            
                            <div style="margin-top: 1.5rem;">
                                <button class="btn" onclick="respawnPlayer()" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust);">${deathTexts.respawn}</button>
                                <button class="btn" onclick="startNewGame()" style="width: 100%; background: #333;">${deathTexts.newGame}</button>
                            </div>
                        </div>
                    `);
                }
                
                // Update mood based on status
                const avgStatus = (state.status.hunger + state.status.thirst + state.status.energy) / 3;
                state.status.mood = avgStatus - state.status.radiation * 0.5;
                state.status.mood = Math.max(0, Math.min(100, state.status.mood));
            }
            
            render();
            
            // Scavenger production (every 6 hours of real time)
            const currentPeriod = Math.floor(state.time.totalElapsed / 21600); // 21600 = 6 hodin
            if (!state.settlement.lastScavengerPeriod) state.settlement.lastScavengerPeriod = currentPeriod;
            if (currentPeriod > state.settlement.lastScavengerPeriod && state.confirmed) {
                updateScavengerProduction();
                state.settlement.lastScavengerPeriod = currentPeriod;
            }
            
            // Production from buildings (check every minute)
            if (Math.floor(state.time.totalElapsed) % 60 === 0 && state.confirmed) {
                BUILDINGS.forEach(building => {
                    if ((state.base.includes(building.id) || state.settlement.buildings.includes(building.id)) && building.production) {
                        const prod = building.production;
                        const minutesPassed = Math.floor(state.time.totalElapsed / 60);
                        const productionInterval = 1440; // 24 hours in minutes
                        
                        if (minutesPassed % productionInterval === 0) {
                            // Produkce jde p콏칤mo do settlement.resources
                            Object.entries(prod).forEach(([resource, amount]) => {
                                if (resource === 'food' || resource === 'water') {
                                    state.settlement.resources[resource] = (state.settlement.resources[resource] || 0) + amount;
                                } else if (resource !== 'power') {
                                    state.resources[resource] = (state.resources[resource] || 0) + amount;
                                }
                            });
                        }
                    }
                });
            }
            
            // Check achievements every 10 seconds
            if (Math.floor(state.time.totalElapsed) % 10 === 0) {
                checkAchievements();
            }
        }, 1000);
        
        // Auto-save every 1 second (silent) - ochrana proti refresh exploitu
        let lastSaveTime = 0;
        setInterval(() => {
            if (state.confirmed && Date.now() - lastSaveTime > 1000) {
                saveGame(true); // true = silent mode
                lastSaveTime = Date.now();
            }
        }, 1000); // Save every 1 second
        
        // === START ===
        // Auto-load saved game on page load
        let saveData = localStorage.getItem('survival_hero_save_v2');
        let loaded = null;
        
        // Zkus de코ifrovat novou verzi
        if (saveData && typeof decryptData === 'function') {
            loaded = decryptData(saveData);
        }
        
        // Fallback na starou ne코ifrovanou verzi
        if (!loaded) {
            const oldSave = localStorage.getItem('survival_hero_save');
            if (oldSave) {
                try {
                    loaded = JSON.parse(oldSave);
                    console.log('游닌 Na캜칤t치m ze star칠 verze save...');
                } catch(e) {}
            }
        }
        
        // Fallback na z치lohu
        if (!loaded) {
            const backup = localStorage.getItem('survival_hero_backup');
            if (backup) {
                try {
                    loaded = JSON.parse(backup);
                    console.log('游닌 Na캜칤t치m ze z치lohy...');
                } catch(e) {}
            }
        }
        
        if (loaded) {
            try {
                
                // Debug: Check if save has confirmed flag
                console.log('游닌 Na캜칤t치m hru...', 'confirmed:', loaded.confirmed);
                
                // Pokud jde o 캜erstv칳 import, kompletn캩 nahra캞 state
                if (loaded._freshImport) {
                    console.log('游댃 Fresh import detected - nahrazuji kompletn캩 state');
                    // Odstra켿 import flag
                    delete loaded._freshImport;
                    delete loaded._importTime;
                    // Kompletn캩 nahra캞 state
                    Object.keys(loaded).forEach(key => {
                        state[key] = loaded[key];
                    });
                    // Ulo bez flagu
                    localStorage.setItem('survival_hero_save', JSON.stringify(state));
                } else {
                    // Norm치ln칤 na캜칤t치n칤 - nahra캞 state loaded daty kompletn캩
                    // Projdi v코echny kl칤캜e v loaded (ne jen v state!) aby se p콏idaly i nov칠
                    Object.keys(loaded).forEach(key => {
                        state[key] = loaded[key];
                    });
                    // Explicitn캩 na캜ti currentAction (m콢쬰 b칳t null v p콢vodn칤m state)
                    if (loaded.currentAction !== undefined) {
                        state.currentAction = loaded.currentAction;
                    }
                }
                
                // CRITICAL: Ensure confirmed is loaded
                if (loaded.confirmed === true) {
                    state.confirmed = true;
                    console.log('九 Hra potvrzena - postava existuje');
                } else {
                    console.log('丘멆잺 Hra nen칤 potvrzena - bude vytvo콏ena nov치 postava');
                }
                
                state.time.last = Date.now();
                state.time.realStart = Date.now();
                
                // Ensure new properties exist
                state.baseItems = state.baseItems || [];
                
                // Migration: Base capacity is now 40 + bonuses from buildings
                let bonusCapacity = 0;
                if (state.base && state.base.includes('warehouse')) bonusCapacity += 30;
                if (state.base && state.base.includes('cryo_storage')) bonusCapacity += 50;
                state.baseCapacity = 40 + bonusCapacity;
                
                state.log = state.log || [];
                state.diary = state.diary || '';
                state.lastSleepTime = state.lastSleepTime || 0;
                state.isSleeping = state.isSleeping || false;
                state.worldSeed = state.worldSeed || 123456; // Default seed for old saves
                state.dailyQuests = state.dailyQuests || { lastReset: Date.now(), quests: [], completed: [], progress: {} };
                if (!state.dailyQuests.progress) {
                    state.dailyQuests.progress = { kills: 0, explored: 0, crafted: 0, moneyEarned: 0, travelled: 0, cooked: 0, sold: 0, bought: 0 };
                }
                // Ensure cooked exists for old saves
                if (state.dailyQuests.progress.cooked === undefined) {
                    state.dailyQuests.progress.cooked = 0;
                }
                state.stats.totalMoneyEarned = state.stats.totalMoneyEarned || 0;
                
                // Migration: Add factions if missing
                if (!state.factions) {
                    state.factions = { traders: 0, scientists: 0, raiders: -20, mutants: 0, military: 0 };
                }
                
                // Migration: Add casino tokens if missing
                if (state.casinoTokens === undefined) {
                    state.casinoTokens = 1000; // Startovac칤 bonus
                    state.casinoLastTokenTime = Date.now(); // Nastav na te캞
                    console.log('游꿣 Migrace: P콏id치ny casino 쬰tony (1000)');
                }
                // Oprava: Pokud m치 쬰tony ale nem치 nastaven lastTokenTime, nastav ho
                if (state.casinoTokens > 0 && !state.casinoLastTokenTime) {
                    state.casinoLastTokenTime = Date.now();
                    console.log('游꿣 Migrace: Opraven casinoLastTokenTime');
                }
                
                // Generate daily quests
                generateDailyQuests();
                
                // Restore travel if it was in progress (star칳 hex syst칠m - pro kompatibilitu)
                if (state.map.traveling) {
                    // Star칳 hex travel - jednodu코e ho dokon캜칤me
                    state.map.traveling = false;
                    console.log('九 Star칳 hex travel ukon캜en p콏i na캜ten칤');
                }
                
                // Restore travel if using new WORLD system
                if (state.world.traveling && state.world.travelStart && state.world.travelDuration) {
                    const now = Date.now();
                    const elapsed = now - state.world.travelStart;
                    
                    if (elapsed >= state.world.travelDuration) {
                        // Travel completed during offline - complete it
                        if (state.world.travelTo) {
                            state.world.currentLocation = state.world.travelTo;
                            if (!state.world.visitedLocations.includes(state.world.travelTo)) {
                                state.world.visitedLocations.push(state.world.travelTo);
                            }
                        }
                        state.world.traveling = false;
                        state.world.travelTo = null;
                        state.map.traveling = false;
                        state.map.inBase = (state.world.currentLocation === 'shelter');
                        console.log('九 WORLD cestov치n칤 dokon캜eno b캩hem offline');
                    } else {
                        // Still traveling - keep it going
                        console.log('九 WORLD cestov치n칤 pokra캜uje...', Math.ceil((state.world.travelDuration - elapsed) / 1000), 's zb칳v치');
                    }
                }
                
                // Restore sleep if it was in progress
                if (state.isSleeping && state.sleepEndTime) {
                    const now = Date.now();
                    if (now >= state.sleepEndTime) {
                        // Sp치nek dokon캜en b캩hem offline
                        state.isSleeping = false;
                        state.sleepEndTime = null;
                        state.status.energy = 100;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + 50);
                        console.log('九 Sp치nek dokon캜en b캩hem offline');
                        addLog('Probudil ses osv캩쬰n칳!', '驕勇');
                    } else {
                        // St치le sp칤 - zobraz칤 se modal p콏i renderov치n칤
                        console.log('游눣 Sp치nek pokra캜uje...', Math.ceil((state.sleepEndTime - now) / 60000), 'min zb칳v치');
                    }
                }
                
                // Restore timed action if it was in progress (hunt, mine, fish, explore)
                if (state.currentAction && state.currentAction.endTime) {
                    const now = Date.now();
                    if (now >= state.currentAction.endTime) {
                        // Akce dokon캜ena b캩hem offline - spus콘 v칳sledek
                        const actionType = state.currentAction.type;
                        const icons = { hunt: '游낓', mine: '久勇', fish: '游꿖', explore: '游댌' };
                        const names = { hunt: 'Lov', mine: 'T캩쬭a', fish: 'Rybolov', explore: 'Pr콢zkum' };
                        console.log(`九 ${names[actionType]} dokon캜en b캩hem offline`);
                        
                        // Dokon캜it akci po na캜ten칤
                        setTimeout(() => {
                            state.currentAction = null;
                            if (actionType === 'hunt') executeHunting();
                            else if (actionType === 'mine') executeMining();
                            else if (actionType === 'fish') executeFishing();
                            else if (actionType === 'explore') executeExploring();
                        }, 500);
                    } else {
                        // St치le prob칤h치 - obnov progress ti코e (bez modalu)
                        const remaining = Math.ceil((state.currentAction.endTime - now) / 1000);
                        console.log(`낍 Akce pokra캜uje... ${Math.floor(remaining / 60)}:${String(remaining % 60).padStart(2, '0')} zb칳v치`);
                        
                        // Spus콘 progress na pozad칤 bez modalu
                        setTimeout(() => {
                            const actionType = state.currentAction.type;
                            const totalMinutes = Math.ceil(state.currentAction.duration / 60000);
                            showActionProgress(actionType, totalMinutes, true); // true = isResumed
                        }, 100);
                    }
                }
                
                // Restore travel if in progress (state.world)
                if (state.world && state.world.traveling && state.world.travelStart) {
                    const now = Date.now();
                    const travelEnd = state.world.travelStart + state.world.travelDuration;
                    
                    if (now >= travelEnd) {
                        // Cestov치n칤 dokon캜eno b캩hem offline
                        console.log('九 Cestov치n칤 dokon캜eno b캩hem offline');
                        state.world.traveling = false;
                        state.world.currentLocation = state.world.travelTo;
                        if (!state.world.visitedLocations.includes(state.world.travelTo)) {
                            state.world.visitedLocations.push(state.world.travelTo);
                        }
                        state.world.travelTo = null;
                        state.world.travelStart = 0;
                        state.world.travelDuration = 0;
                    } else {
                        // Cestov치n칤 st치le prob칤h치 - obnov timer
                        const remaining = Math.ceil((travelEnd - now) / 1000);
                        console.log(`游뛌 Cestov치n칤 pokra캜uje... ${Math.floor(remaining / 60)}:${String(remaining % 60).padStart(2, '0')} zb칳v치`);
                        
                        // Spus콘 timeout pro dokon캜en칤
                        setTimeout(() => {
                            if (state.world.traveling) {
                                state.world.traveling = false;
                                state.world.currentLocation = state.world.travelTo;
                                if (!state.world.visitedLocations.includes(state.world.travelTo)) {
                                    state.world.visitedLocations.push(state.world.travelTo);
                                }
                                state.world.travelTo = null;
                                state.world.travelStart = 0;
                                state.world.travelDuration = 0;
                                renderFull();
                                notifySuccess('游뛌 Dorazil jsi!', 'Cestov치n칤 dokon캜eno.');
                            }
                        }, travelEnd - now);
                    }
                }
                
                // Restore travel events if traveling (old state.map system)
                if (state.map && state.map.traveling && state.map.scheduledTravelEvents && state.map.scheduledTravelEvents.length > 0) {
                    console.log('游댃 Obnovuji travel eventy...');
                    setTimeout(() => {
                        restoreScheduledEvents();
                    }, 200);
                }
                
                // Calculate offline time and apply status changes
                const offlineTime = (Date.now() - state.time.last) / 1000; // seconds
                if (offlineTime > 60 && state.confirmed) { // More than 1 minute offline
                    console.log('Offline time:', Math.floor(offlineTime / 60), 'minutes');
                    
                    // Apply offline consumption (same rates as game loop)
                    const hungerRate = 100 / 86400; // 24 hours to deplete
                    const thirstRate = (100 / 86400) * 1.2; // 20 hours to deplete
                    const energyRate = 100 / 86400; // 24 hours to deplete
                    
                    state.status.hunger = Math.max(0, state.status.hunger - hungerRate * offlineTime);
                    state.status.thirst = Math.max(0, state.status.thirst - thirstRate * offlineTime);
                    state.status.energy = Math.max(0, state.status.energy - energyRate * offlineTime);
                    
                    // Automatick칠 konzumov치n칤 pokud m치 hr치캜 perk
                    autoConsumeIfDying();
                    
                    // Log if significant time passed
                    if (offlineTime > 600) { // More than 10 minutes
                        const hours = Math.floor(offlineTime / 3600);
                        const mins = Math.floor((offlineTime % 3600) / 60);
                        addLog(`Byl jsi offline ${hours}h ${mins}m - hlad, 쮂셬e켿 a energie klesly!`, '낋');
                    }
                }
                
                // Add sleeping bag ONLY ONCE for old saves (not if player sold it)
                // Use migration flag to prevent re-adding after player sells it
                if (!state.sleepingBagMigrated && state.confirmed) {
                    const hasSleepingBag = state.inv.find(i => i.id === 'sleeping_bag');
                    if (!hasSleepingBag) {
                        state.inv.push({ 
                            id: 'sleeping_bag', 
                            name: 'Spac치k', 
                            icon: '游띒勇', 
                            type: 'tool', 
                            effect: 'sleep', 
                            value: 1, 
                            weight: 2,
                            stackable: false,
                            unique: true
                        });
                        console.log('九 Spac치k p콏id치n do invent치콏e (jednor치zov치 migrace)');
                    }
                }
                // V콯DY nastav flag (i kdy hr치캜 spac치k u m치) - zabr치n칤 op캩tovn칠mu p콏id치n칤 po prodeji
                state.sleepingBagMigrated = true;
                
                // Migrace existuj칤c칤ch spac치k콢 - ponech jen jeden a oprav vlastnosti
                const sleepingBags = state.inv.filter(i => i.id === 'sleeping_bag');
                if (sleepingBags.length > 0) {
                    // Oprav prvn칤 spac치k
                    sleepingBags[0].type = 'tool';
                    sleepingBags[0].stackable = false;
                    sleepingBags[0].unique = true;
                    delete sleepingBags[0].count; // Odstra켿 count
                    
                    // Sma p콏ebyte캜n칠 spac치ky
                    if (sleepingBags.length > 1) {
                        for (let i = 1; i < sleepingBags.length; i++) {
                            const idx = state.inv.indexOf(sleepingBags[i]);
                            if (idx > -1) state.inv.splice(idx, 1);
                        }
                        console.log('九 P콏ebyte캜n칠 spac치ky odstran캩ny:', sleepingBags.length - 1, 'ks');
                    }
                }
                
                // Migrace state.world pro nov칳 mapov칳 syst칠m
                if (!state.world || !state.world.currentLocation) {
                    state.world = {
                        currentLocation: 'shelter',
                        visitedLocations: ['shelter'],
                        traveling: false,
                        travelTo: null,
                        travelPath: null,
                        travelStart: 0,
                        travelDuration: 0,
                        locationCooldowns: {}
                    };
                    console.log('九 Migrace: state.world inicializov치n pro nov칳 mapov칳 syst칠m');
                }
                
                // === RESET NEPLATN칄HO TRAVELING STAVU ===
                if (state.world.traveling) {
                    const now = Date.now();
                    const travelEnd = (state.world.travelStart || 0) + (state.world.travelDuration || 0);
                    
                    // Resetuj pokud: cestov치n칤 m캩lo d치vno skon캜it, chyb칤 c칤l, nebo chyb칤 duration
                    if ((travelEnd > 0 && now > travelEnd + 5000) || !state.world.travelTo || !state.world.travelDuration) {
                        console.log('游댢 Migrace: Reset neplatn칠ho traveling stavu');
                        state.world.traveling = false;
                        state.world.travelTo = null;
                        state.world.travelPath = null;
                        state.world.scheduledEvents = [];
                        state.map.traveling = false;
                    }
                }
                
                // Synchronizace map.traveling s world.traveling
                state.map.traveling = state.world.traveling;
                
                // Zajisti 쬰 locationCooldowns existuje
                if (!state.world.locationCooldowns) {
                    state.world.locationCooldowns = {};
                }
                
                // Spus콘 kompletn칤 migraci pro v코echny chyb캩j칤c칤 vlastnosti
                migrateState();
                
                // Obnov prob칤haj칤c칤 akci (lov, pr콢zkum, t캩쬭a...)
                resumeCurrentAction();
                
                // === KONTROLA RE츼LN칄HO 캛ASU ===
                verifyRealTime();
                
                // Po na캜ten칤 v쬯y p콏epni na Online tab
                state.activeTab = 'multiplayer';
                
                console.log('九 Hra na캜tena z auto-save', {
                    confirmed: state.confirmed,
                    charName: state.char.name,
                    level: state.char.lvl,
                    classId: state.char.classId
                });
                
                // === KONTROLA CHR츼N캨N칄HO NICKU PO AUTO-LOAD ===
                setTimeout(() => {
                    if (state.confirmed && state.char?.name) {
                        const nicknameCheck = checkProtectedNickname();
                        if (nicknameCheck instanceof Promise) {
                            // 캛ek치 na ov캩콏en칤 hesla
                            nicknameCheck.then(() => {
                                renderFull();
                            });
                        }
                    }
                }, 100);
                
            } catch(e) {
                console.error('仇 Auto-load failed:', e);
            }
        } else {
            console.log('좶잺 콯치dn치 ulo쬰n치 hra nenalezena - vytvo콏 novou postavu');
        }
        
        // Modal click handler - close when clicking outside content (desktop only)
        document.getElementById('modal').addEventListener('click', (e) => {
            // Neklikat kdy prob칤h치 boj!
            if (window.combatState) return;
            
            // Neklikat b캩hem sp치nku!
            if (state.isSleeping && state.sleepEndTime && Date.now() < state.sleepEndTime) return;
            
            // Only on desktop - prevent issues with mobile keyboard
            if (window.innerWidth >= 768 && e.target.id === 'modal') {
                closeModal();
            }
        });
        
        // Resume AudioContext on first user interaction (required by browser policies)
        document.addEventListener('click', function resumeAudio() {
            SoundSystem.resume();
            // Remove listener after first click
            document.removeEventListener('click', resumeAudio);
        }, { once: true });
        
        // Also try to resume on any touch for mobile
        document.addEventListener('touchstart', function resumeAudioTouch() {
            SoundSystem.resume();
            document.removeEventListener('touchstart', resumeAudioTouch);
        }, { once: true });
        
        // === CHR츼N캨N칄 NICKY ===
        const _0x=(s)=>{let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h=h&h;}const x=h.toString()+'x7K9m'+s.length;let h2=0;for(let i=0;i<x.length;i++){h2=((h2<<5)-h2)+x.charCodeAt(i);h2=h2&h2;}return h2.toString(16);};
        const PROTECTED_NICKNAMES = {
            // Chr치n캩n칠 nicky s heslem
            'zaoo': 'maslo',
            'Zaoo': 'maslo',
            'ZAOO': 'maslo',
            'admin': false, // false = blokov치no 칰pln캩
            'Admin': false,
            'ADMIN': false,
            'administrator': false,
            'moderator': false,
            'developer': false,
            'system': false
        };
        
        function checkProtectedNickname() {
            const playerName = state.char?.name;
            if (!playerName) return true; // Nov치 hra, OK
            
            // Kontrola v코ech variant
            const protectedPassword = PROTECTED_NICKNAMES[playerName] || PROTECTED_NICKNAMES[playerName.toLowerCase()];
            
            if (protectedPassword) {
                // Kontrola jestli u je ov캩콏en v t칠to session
                const sessionKey = 'nickname_verified_' + playerName.toLowerCase();
                if (sessionStorage.getItem(sessionKey) === 'true') {
                    return true; // U ov캩콏en
                }
                
                // Zobraz heslo modal
                return new Promise((resolve) => {
                    showProtectedNicknameModal(playerName, protectedPassword, resolve);
                });
            }
            
            return true; // Nick nen칤 chr치n캩n칳
        }
        
        function showProtectedNicknameModal(nickname, correctPassword, callback) {
            // Ulo stav - 캜ek치me na heslo (persistentn칤 p콏es refresh)
            window._pendingPasswordPrompt = {
                nickname: nickname,
                correctPassword: correctPassword,
                callback: callback
            };
            
            // Ulo i do sessionStorage pro p콏e쬴t칤 refreshe
            sessionStorage.setItem('pending_password_prompt', JSON.stringify({
                nickname: nickname,
                correctPassword: correctPassword
            }));
            
            renderProtectedNicknameModal();
        }
        
        function renderProtectedNicknameModal() {
            const pending = window._pendingPasswordPrompt;
            if (!pending) return;
            
            const { nickname, correctPassword } = pending;
            
            const modalEl = document.getElementById('modal');
            const contentEl = document.getElementById('modalContent');
            
            contentEl.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">游</div>
                    <h2 style="color: #ff9800; margin-bottom: 0.5rem;">Chr치n캩n칳 칰캜et</h2>
                    <p style="color: #888; margin-bottom: 1.5rem;">Nick <strong style="color: #8bc34a;">${escapeHtml(nickname)}</strong> je chr치n캩n칳 heslem.</p>
                    
                    <input type="password" id="nicknamePasswordInput" placeholder="Zadej heslo..." 
                        style="width: 100%; padding: 0.8rem; font-size: 1.1rem; background: #1a1a1a; border: 2px solid #ff9800; border-radius: 8px; color: #fff; text-align: center; margin-bottom: 1rem;"
                        onkeypress="if(event.key==='Enter') verifyNicknamePassword('${escapeHtml(nickname)}', '${correctPassword}')">
                    
                    <div id="nicknamePasswordError" style="color: #f44336; margin-bottom: 1rem; display: none;">仇 맗atn칠 heslo!</div>
                    
                    <button class="btn" onclick="verifyNicknamePassword('${escapeHtml(nickname)}', '${correctPassword}')" style="width: 100%; background: #4CAF50; padding: 0.8rem; margin-bottom: 0.5rem;">
                        九 Ov캩콏it
                    </button>
                    
                    <button class="btn" onclick="resetToNewNickname()" style="width: 100%; background: #c62828; padding: 0.8rem;">
                        游댃 Pou쮂셦 jin칳 nick
                    </button>
                </div>
            `;
            
            modalEl.classList.add('show');
            
            // Focus na input
            setTimeout(() => {
                document.getElementById('nicknamePasswordInput')?.focus();
            }, 100);
        }
        
        function verifyNicknamePassword(nickname, correctPassword) {
            const input = document.getElementById('nicknamePasswordInput');
            const errorEl = document.getElementById('nicknamePasswordError');
            
            // Porovnej plaintext heslo (pro jednoduchost)
            const enteredPassword = input?.value?.trim();
            if (enteredPassword && enteredPassword === correctPassword) {
                // Spr치vn칠 heslo - vy캜isti pending stav
                window._pendingPasswordPrompt = null;
                sessionStorage.removeItem('pending_password_prompt');
                
                sessionStorage.setItem('nickname_verified_' + nickname.toLowerCase(), 'true');
                closeModal();
                
                const callback = window._pendingPasswordPrompt?.callback;
                if (callback) {
                    callback(true);
                }
                
                notifySuccess('九 Ov캩콏eno', 'V칤tej zp캩t, ' + nickname + '!');
                renderFull();
            } else {
                // 맗atn칠 heslo
                if (errorEl) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = '仇 맗atn칠 heslo! Zkus to znovu.';
                }
                if (input) {
                    input.style.borderColor = '#f44336';
                    input.value = '';
                    input.focus();
                }
            }
        }
        
        function resetToNewNickname() {
            // Vy캜isti pending stav
            window._pendingPasswordPrompt = null;
            sessionStorage.removeItem('pending_password_prompt');
            
            // Zm캩켿 nick na n캩co jin칠ho
            const newNick = 'P콏e쬴v코칤_' + Math.floor(Math.random() * 10000);
            state.char.name = newNick;
            closeModal();
            
            notifyWarning('Nick zm캩n캩n', 'Tv콢j nov칳 nick je: ' + newNick);
            saveGame();
            renderFull();
        }
        
        // Kontrola neplatn칠ho mutanta (class mutant ale nem치 5 mutac칤)
        function checkInvalidMutant() {
            if (!state.confirmed) return;
            if (state.char?.classId !== 'mutant' && state.char?.class !== 'mutant') return;
            
            const mutationCount = state.mutations?.length || 0;
            if (mutationCount < 5) {
                console.log(`丘멆잺 Mutant s ${mutationCount} mutacemi - p콏id치v치m chyb캩j칤c칤`);
                // P콏idej n치hodn칠 mutace do 5
                const allMutations = ['thick_skin', 'night_vision', 'fast_metabolism', 'radiation_immunity', 'regeneration', 'extra_arm', 'enhanced_senses', 'toxic_blood'];
                if (!state.mutations) state.mutations = [];
                
                while (state.mutations.length < 5) {
                    const available = allMutations.filter(m => !state.mutations.includes(m));
                    if (available.length === 0) break;
                    const randomMutation = available[Math.floor(Math.random() * available.length)];
                    state.mutations.push(randomMutation);
                }
                saveGame();
            }
        }
        
        // Prvotn칤 renderFull - bez kontroly nicku (defaultn칤 state nem치 re치ln칳 nick)
        renderFull();
        
        // Kontrola neplatn칠ho mutanta (star칳 save bez 5 mutac칤)
        setTimeout(() => {
            checkInvalidMutant();
        }, 500);
        
        // Zkontroluj a zobraz p콏칤padn칳 neulo쬰n칳 modal
        setTimeout(() => {
            checkPendingModal();
        }, 1000);
        
        // Obnov pending password prompt ze sessionStorage (p콏e쬴je refresh)
        setTimeout(() => {
            const pendingPromptData = sessionStorage.getItem('pending_password_prompt');
            if (pendingPromptData && !window._pendingPasswordPrompt) {
                try {
                    const data = JSON.parse(pendingPromptData);
                    if (data.nickname && data.correctPassword) {
                        console.log('游 Obnovuji password prompt pro:', data.nickname);
                        window._pendingPasswordPrompt = {
                            nickname: data.nickname,
                            correctPassword: data.correctPassword,
                            callback: () => {} // Dummy callback po refreshi
                        };
                        renderProtectedNicknameModal();
                    }
                } catch (e) {
                    console.error('Chyba p콏i obnoven칤 password prompt:', e);
                    sessionStorage.removeItem('pending_password_prompt');
                }
            }
        }, 1500);
        
        // ============================================================
        // 游깷 MULTIPLAYER SYST칄M - Leaderboard, Chat, Obchod, PvP
        // ============================================================
        
        // 游댠 FIREBASE KONFIGURACE
        const firebaseConfig = {
            apiKey: "AIzaSyAnqRlz8iSsMTKa0PePTIvbPwncG1yj9RM",
            authDomain: "posledni-prezivsi.firebaseapp.com",
            databaseURL: "https://posledni-prezivsi-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "posledni-prezivsi",
            storageBucket: "posledni-prezivsi.firebasestorage.app",
            messagingSenderId: "593304244516",
            appId: "1:593304244516:web:dd99f403be270dc89a63b1"
        };
        
        // Inicializace Firebase
        function initFirebase() {
            try {
                // Kontrola jestli je Firebase SDK na캜ten칠
                if (typeof firebase === 'undefined') {
                    console.log('丘멆잺 Firebase SDK nen칤 na캜ten칠 - zkus칤m znovu za 2s');
                    updateOnlineIndicator('loading');
                    setTimeout(initFirebase, 2000);
                    return false;
                }
                
                if (firebaseConfig.apiKey === "TVUJ_API_KEY") {
                    console.log('丘멆잺 Firebase nen칤 nakonfigurov치n - multiplayer vypnut');
                    updateOnlineIndicator('offline');
                    return false;
                }
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDB = firebase.database();
                firebaseAuth = firebase.auth();
                multiplayerEnabled = true;
                console.log('九 Firebase p콏ipojen - multiplayer aktivn칤!');
                
                // Na캜ti staff 캜leny z Firebase
                loadStaffMembers();
                
                // P콏edb캩쬹캩 na캜ti territory cache
                firebaseDB.ref('territories').once('value').then(terrSnapshot => {
                    window.territoryCache = terrSnapshot.val() || {};
                    window.territoryCacheTime = Date.now();
                    console.log('游딬勇 Pre-loaded territory cache:', Object.keys(window.territoryCache).length, 'territories');
                    // P콏ekresli mapu pokud je aktivn칤
                    if (state.activeTab === 'map') {
                        renderFull();
                    }
                }).catch(e => console.log('Territory pre-load error:', e));
                
                // Poslouchej zm캩ny p콏ihl치코en칤
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        isGuest = user.isAnonymous;
                        console.log('九 P콏ihl치코en:', user.email || 'Host');
                        
                        // KONTROLA BANU
                        const playerName = state.char?.name || localStorage.getItem('playerName');
                        if (playerName) {
                            try {
                                const banSnap = await firebaseDB.ref('bannedPlayers/' + playerName).once('value');
                                const banData = banSnap.val();
                                if (banData) {
                                    // Zkontroluj jestli ban nevypr코el
                                    if (banData.until === 0 || banData.until > Date.now()) {
                                        const untilText = banData.until ? new Date(banData.until).toLocaleString('cs') : 'NAV콯DY';
                                        showBanScreen(playerName, banData.reason, untilText);
                                        return; // Zastav inicializaci
                                    } else {
                                        // Ban vypr코el, odeber ho
                                        await firebaseDB.ref('bannedPlayers/' + playerName).remove();
                                    }
                                }
                            } catch(e) {
                                console.log('Ban check error:', e);
                            }
                        }
                        
                        // Na캜ti cloud save pokud existuje
                        // ALE pouze pokud:
                        // 1. Hra je코t캩 neza캜ala (nem치 confirmed stav)
                        // 2. A u쬴vatel AKTIVN캨 nevytv치콏칤 novou postavu
                        // 3. NOV칗: A nen칤 nastaven flag v sessionStorage
                        const isCreatingNewChar = window.creatingNewCharacter === true || 
                                                  sessionStorage.getItem('creatingNewCharacter') === 'true';
                        
                        // Odeber flag ze sessionStorage po kontrole
                        if (sessionStorage.getItem('creatingNewCharacter') === 'true') {
                            sessionStorage.removeItem('creatingNewCharacter');
                            window.creatingNewCharacter = true;
                            console.log('游 Detekov치n flag nov칠 postavy ze sessionStorage');
                        }
                        
                        if (!isGuest && !state.confirmed && !isCreatingNewChar) {
                            await loadCloudSave();
                        } else if (!isGuest && isCreatingNewChar) {
                            console.log('驕勇 P콏eskakuji auto-load cloud save - vytv치콏칤 se nov치 postava');
                        } else if (!isGuest && state.confirmed) {
                            console.log('驕勇 P콏eskakuji auto-load cloud save - hra u b캩쮂');
                        }
                        
                        // Spus콘 real-time cloud sync pro registrovan칠 u쬴vatele
                        if (!isGuest && typeof setupCloudSyncListener === 'function') {
                            setTimeout(setupCloudSyncListener, 2000);
                        }
                        
                        // Spus콘 real-time listener na 칰zem칤 pro okam쬴tou synchronizaci
                        setupTerritoryRealTimeListener();
                        
                        // Zkontroluj nevyzvednut칠 odm캩ny od admina
                        if (!isGuest && state.char?.name) {
                            setTimeout(() => {
                                if (typeof checkPendingRewards === 'function') {
                                    checkPendingRewards();
                                }
                            }, 3000);
                        }
                        
                        updateOnlineIndicator('online');
                        renderFull();
                    } else {
                        currentUser = null;
                        isGuest = true;
                        console.log('좶잺 Nep콏ihl치코en - re쬴m host');
                        updateOnlineIndicator('online');
                    }
                });
                
                // Aktualizuj indik치tor
                updateOnlineIndicator('online');
                
                // Re-renderuj navigaci aby se zobrazil online status
                renderFull();
                
                // Nastav online status
                setupOnlineStatus();
                
                // Zkontroluj reset frak캜n칤 sez칩ny
                checkSeasonReset();
                
                // Na캜ti VIP barvy
                loadVIPColors();
                
                // Na캜ti chat zpr치vy
                listenToChat();
                
                // Na캜ti marketplace
                listenToMarketplace();
                
                // Na캜ti PvP v칳zvy
                listenToPvP();
                
                // Nastav listener na soukrom칠 zpr치vy (pro po캜et nep콏e캜ten칳ch)
                listenToPrivateMessages();
                
                return true;
            } catch (e) {
                console.error('仇 Firebase chyba:', e);
                multiplayerEnabled = false;
                updateOnlineIndicator('error');
                return false;
            }
        }
        
        // Funkce pro aktualizaci online indik치toru v headeru
        function updateOnlineIndicator(status) {
            const indicator = document.getElementById('onlineIndicator');
            const icon = document.getElementById('onlineStatusIcon');
            if (!indicator || !icon) return;
            
            switch(status) {
                case 'online':
                    icon.textContent = '游릭';
                    indicator.style.background = 'linear-gradient(180deg, #1a3a1a 0%, #0a2a0a 100%)';
                    indicator.style.borderColor = '#4CAF50';
                    indicator.title = 'Online - klikni pro multiplayer';
                    break;
                case 'offline':
                    icon.textContent = '游댮';
                    indicator.style.background = 'linear-gradient(180deg, #3a1a1a 0%, #2a0a0a 100%)';
                    indicator.style.borderColor = '#f44336';
                    indicator.title = 'Offline - multiplayer nedostupn칳';
                    break;
                case 'loading':
                    icon.textContent = '游리';
                    indicator.style.background = 'linear-gradient(180deg, #3a3a1a 0%, #2a2a0a 100%)';
                    indicator.style.borderColor = '#ff9800';
                    indicator.title = 'P콏ipojov치n칤...';
                    break;
                case 'error':
                    icon.textContent = '丘멆잺';
                    indicator.style.background = 'linear-gradient(180deg, #3a2a1a 0%, #2a1a0a 100%)';
                    indicator.style.borderColor = '#ff5722';
                    indicator.title = 'Chyba p콏ipojen칤 - klikni pro detaily';
                    break;
                default:
                    icon.textContent = '丘';
                    indicator.style.background = '#222';
                    indicator.style.borderColor = '#444';
                    indicator.title = 'Nezn치m칳 stav';
            }
        }
        
        // Inicializuj po na캜ten칤 str치nky
        setTimeout(initFirebase, 1500);
        
        // Nastav loading stav hned
        setTimeout(() => updateOnlineIndicator('loading'), 100);
        
        // === AUTHENTICATION SYST칄M ===
        
        // Zobraz칤 p콏ihla코ovac칤/registra캜n칤 modal
        function showAuthModal() {
            if (!multiplayerEnabled || !firebaseAuth) {
                showModal('丘멆잺 Offline', 'Multiplayer nen칤 dostupn칳.');
                return;
            }
            
            const isLoggedIn = currentUser && !currentUser.isAnonymous;
            
            if (isLoggedIn) {
                // U je p콏ihl치코en - zobraz profil 칰캜tu
                showAccountProfile();
                return;
            }
            
            showModal('游댏 P콏ihl치코en칤', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">游녻</div>
                    <p style="color: #888;">P콏ihlas se pro cloud save a ochranu nicku</p>
                </div>
                
                <div style="display: grid; gap: 0.8rem;">
                    <button class="btn" onclick="showLoginForm()" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); padding: 1rem;">
                        游댐 P콏ihl치sit se
                    </button>
                    <button class="btn" onclick="showRegisterForm()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 1rem;">
                        游닇 Registrace
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                        游녻 Pokra캜ovat jako host
                    </button>
                </div>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 1rem;">
                    Jako host m콢쬰코 hr치t, ale save z콢stane jen v tomto prohl칤쬰캜i.
                </p>
            `);
        }
        
        // P콏ep칤n치n칤 viditelnosti hesla
        function togglePasswordVisibility(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.textContent = '游뗻';
            } else {
                input.type = 'password';
                iconElement.textContent = '游녜勇';
            }
        }
        
        function showLoginForm() {
            showModal('游댐 P콏ihl치코en칤', `
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Email:</label>
                    <input type="email" id="authEmail" placeholder="tvuj@email.cz"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo:</label>
                    <div style="position: relative;">
                        <input type="password" id="authPassword" placeholder="뮉뮉뮉뮉뮉뮉뮉"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('authPassword', this)" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-70%); cursor: pointer; font-size: 1.1rem; user-select: none;">游녜勇</span>
                    </div>
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doLogin()" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); padding: 0.8rem; margin-bottom: 0.5rem;">
                        游댐 P콏ihl치sit
                    </button>
                    
                    <button class="btn" onclick="showForgotPassword()" style="width: 100%; background: #333; padding: 0.6rem; font-size: 0.85rem;">
                        游댃 Zapomenut칠 heslo
                    </button>
                </div>
                <button class="btn" onclick="showAuthModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        function showRegisterForm() {
            showModal('游닇 Registrace', `
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Hern칤 nick (bude chr치n캩n):</label>
                    <input type="text" id="authNick" placeholder="TvujNick" maxlength="20"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Email:</label>
                    <input type="email" id="authEmail" placeholder="tvuj@email.cz"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo (min. 6 znak콢):</label>
                    <div style="position: relative;">
                        <input type="password" id="authPassword" placeholder="뮉뮉뮉뮉뮉뮉뮉"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('authPassword', this)" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-70%); cursor: pointer; font-size: 1.1rem; user-select: none;">游녜勇</span>
                    </div>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo znovu:</label>
                    <div style="position: relative;">
                        <input type="password" id="authPassword2" placeholder="뮉뮉뮉뮉뮉뮉뮉"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('authPassword2', this)" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-70%); cursor: pointer; font-size: 1.1rem; user-select: none;">游녜勇</span>
                    </div>
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doRegister()" style="width: 100%; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 0.8rem;">
                        游닇 Zaregistrovat
                    </button>
                </div>
                <button class="btn" onclick="showAuthModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        // Speci치ln칤 formul치콏 pro registraci chr치n캩n칠ho nicku
        function showProtectedNickRegistration(nick, email, password, password2) {
            showModal('游 Chr치n캩n칳 nick', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">游</div>
                    <p style="color: #ff9800;">Nick <strong>${escapeHtml(nick)}</strong> je chr치n캩n칳!</p>
                    <p style="color: #888; font-size: 0.85rem;">Pokud jsi opr치vn캩n칳 vlastn칤k, zadej speci치ln칤 heslo.</p>
                </div>
                
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo pro chr치n캩n칳 nick:</label>
                    <input type="password" id="authProtectedPassword" placeholder="Zadej heslo..."
                        style="width: 100%; padding: 0.6rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 2px solid #ff9800; border-radius: 4px;">
                    
                    <!-- Skryt칠 pole pro uchov치n칤 dat -->
                    <input type="hidden" id="authNick" value="${escapeHtml(nick)}">
                    <input type="hidden" id="authEmail" value="${escapeHtml(email || '')}">
                    <input type="hidden" id="authPassword" value="${escapeHtml(password || '')}">
                    <input type="hidden" id="authPassword2" value="${escapeHtml(password2 || '')}">
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doRegister()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        游댑 Ov캩콏it a pokra캜ovat
                    </button>
                </div>
                <button class="btn" onclick="showRegisterForm()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        function showForgotPassword() {
            showModal('游댃 Reset hesla', `
                <div style="text-align: left;">
                    <p style="color: #888; margin-bottom: 1rem;">Zadej email a po코leme ti odkaz pro reset hesla.</p>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Email:</label>
                    <input type="email" id="authEmail" placeholder="tvuj@email.cz"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doResetPassword()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        游닎 Odeslat reset
                    </button>
                </div>
                <button class="btn" onclick="showLoginForm()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        async function doLogin() {
            const email = document.getElementById('authEmail')?.value?.trim();
            const password = document.getElementById('authPassword')?.value;
            const errorDiv = document.getElementById('authError');
            
            if (!email || !password) {
                if (errorDiv) { errorDiv.textContent = 'Vypl켿 email a heslo!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                if (errorDiv) { errorDiv.textContent = '낍 P콏ihla코uji...'; errorDiv.style.display = 'block'; errorDiv.style.color = '#ff9800'; }
                
                const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
                
                closeModal();
                notifySuccess('九 P콏ihl치코eno!', 'V칤tej zp캩t, ' + (userCredential.user.displayName || email));
                
            } catch (error) {
                console.error('Login error:', error);
                let msg = 'Chyba p콏ihl치코en칤';
                if (error.code === 'auth/user-not-found') msg = '칔캜et neexistuje';
                else if (error.code === 'auth/wrong-password') msg = '맗atn칠 heslo';
                else if (error.code === 'auth/invalid-email') msg = 'Neplatn칳 email';
                else if (error.code === 'auth/too-many-requests') msg = 'P콏칤li코 mnoho pokus콢, zkus pozd캩ji';
                
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
            }
        }
        
        async function doRegister() {
            const nick = document.getElementById('authNick')?.value?.trim();
            const email = document.getElementById('authEmail')?.value?.trim();
            const password = document.getElementById('authPassword')?.value;
            const password2 = document.getElementById('authPassword2')?.value;
            const protectedPassword = document.getElementById('authProtectedPassword')?.value?.trim();
            const errorDiv = document.getElementById('authError');
            
            if (!nick || nick.length < 3) {
                if (errorDiv) { errorDiv.textContent = 'Nick mus칤 m칤t alespo켿 3 znaky!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            // Kontrola chr치n캩n칳ch nick콢
            const nickLower = nick.toLowerCase();
            const protectedNickValue = PROTECTED_NICKNAMES[nick] || PROTECTED_NICKNAMES[nickLower];
            
            if (protectedNickValue !== undefined) {
                if (protectedNickValue === false) {
                    // Nick je 칰pln캩 blokovan칳
                    if (errorDiv) { errorDiv.textContent = 'Tento nick je rezervovan칳 a nelze ho pou쮂셦!'; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
                    return;
                } else if (typeof protectedNickValue === 'string') {
                    // Nick vy쬬duje heslo
                    if (!protectedPassword) {
                        // Zobraz pole pro heslo
                        showProtectedNickRegistration(nick, email, password, password2);
                        return;
                    }
                    if (protectedPassword !== protectedNickValue) {
                        if (errorDiv) { errorDiv.textContent = '맗atn칠 heslo pro chr치n캩n칳 nick!'; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
                        return;
                    }
                }
            }
            
            if (!email) {
                if (errorDiv) { errorDiv.textContent = 'Vypl켿 email!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (!password || password.length < 6) {
                if (errorDiv) { errorDiv.textContent = 'Heslo mus칤 m칤t alespo켿 6 znak콢!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (password !== password2) {
                if (errorDiv) { errorDiv.textContent = 'Hesla se neshoduj칤!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                if (errorDiv) { errorDiv.textContent = '낍 Kontroluji nick...'; errorDiv.style.display = 'block'; errorDiv.style.color = '#ff9800'; }
                
                // Zkontroluj jestli nick nen칤 zabran칳
                const nickCheck = await firebaseDB.ref('registeredNicks/' + nick.toLowerCase()).once('value');
                if (nickCheck.exists()) {
                    if (errorDiv) { errorDiv.textContent = 'Tento nick je u zabran칳!'; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
                    return;
                }
                
                if (errorDiv) { errorDiv.textContent = '낍 Vytv치콏칤m 칰캜et...'; }
                
                // Vytvo콏 칰캜et
                const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                
                // Nastav display name
                await userCredential.user.updateProfile({ displayName: nick });
                
                // Zaregistruj nick v datab치zi
                await firebaseDB.ref('registeredNicks/' + nick.toLowerCase()).set({
                    odid: userCredential.user.uid,
                    nick: nick,
                    email: email,
                    registeredAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Ulo user data
                await firebaseDB.ref('users/' + userCredential.user.uid).set({
                    nick: nick,
                    email: email,
                    registeredAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Nastav nick ve h콏e
                state.char.name = nick;
                
                closeModal();
                notifySuccess('九 Registrace 칰sp캩코n치!', 'V칤tej, ' + nick + '!');
                
                // Ulo hru do cloudu
                await saveCloudSave();
                
                renderFull();
                
            } catch (error) {
                console.error('Register error:', error);
                let msg = 'Chyba registrace';
                if (error.code === 'auth/email-already-in-use') msg = 'Email u je registrov치n';
                else if (error.code === 'auth/invalid-email') msg = 'Neplatn칳 email';
                else if (error.code === 'auth/weak-password') msg = 'Heslo je p콏칤li코 slab칠';
                
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
            }
        }
        
        async function doResetPassword() {
            const email = document.getElementById('authEmail')?.value?.trim();
            const errorDiv = document.getElementById('authError');
            
            if (!email) {
                if (errorDiv) { errorDiv.textContent = 'Vypl켿 email!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                await firebaseAuth.sendPasswordResetEmail(email);
                closeModal();
                notifySuccess('游닎 Email odesl치n!', 'Zkontroluj schr치nku pro reset hesla.');
            } catch (error) {
                console.error('Reset error:', error);
                let msg = 'Chyba p콏i odes칤l치n칤';
                if (error.code === 'auth/user-not-found') msg = '칔캜et s t칤mto emailem neexistuje';
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; }
            }
        }
        
        function showAccountProfile() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            const isAnon = currentUser.isAnonymous;
            const email = currentUser.email || 'Host';
            const nick = currentUser.displayName || state.char.name || 'Nezn치m칳';
            
            showModal('游녻 M콢j 칰캜et', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${isAnon ? '游녻' : '九'}</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #ffd700;">${escapeHtml(nick)}</div>
                    <div style="color: #888; font-size: 0.85rem;">${isAnon ? 'Re쬴m host' : escapeHtml(email)}</div>
                </div>
                
                ${isAnon ? `
                    <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; border: 1px solid #ff9800; margin-bottom: 1rem;">
                        <p style="color: #ff9800; margin: 0;">丘멆잺 Hraje코 jako host. Registruj se pro:</p>
                        <ul style="color: #ccc; margin: 0.5rem 0 0 1rem; font-size: 0.85rem;">
                            <li>Cloud save (hraj na v칤ce za콏칤zen칤ch)</li>
                            <li>Ochranu nicku</li>
                            <li>Obnoven칤 칰캜tu p콏i ztr치t캩 dat</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="showRegisterForm()" style="width: 100%; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 1rem; margin-bottom: 0.5rem;">
                        游닇 Registrovat se
                    </button>
                ` : `
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; border: 1px solid #4CAF50; margin-bottom: 1rem;">
                        <p style="color: #4CAF50; margin: 0 0 0.5rem 0;">九 칔캜et ov캩콏en</p>
                        <p style="color: #888; font-size: 0.8rem; margin: 0;">Tv콢j save je automaticky ukl치d치n do cloudu.</p>
                    </div>
                    
                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="saveCloudSave(); notifySuccess('驕勇 Ulo쬰no', 'Save ulo쬰n do cloudu');" style="background: #4CAF50; padding: 0.8rem;">
                            驕勇 Ulo쬴t do cloudu
                        </button>
                        <button class="btn" onclick="confirmLoadCloud()" style="background: #2196f3; padding: 0.8rem;">
                            游닌 Na캜칤st z cloudu
                        </button>
                        <button class="btn" onclick="showChangePasswordForm()" style="background: #ff9800; padding: 0.8rem;">
                            游댐 Zm캩nit heslo
                        </button>
                    </div>
                    
                    <button class="btn" onclick="doLogout()" style="width: 100%; background: #8B0000; padding: 0.8rem; margin-bottom: 0.5rem;">
                        游뛁 Odhl치sit se
                    </button>
                `}
                
                <div style="border-top: 1px solid #333; padding-top: 1rem; margin-top: 0.5rem;">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem; text-align: center;">Spr치va hry:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="updateGame()" style="background: #3949AB; padding: 0.6rem; font-size: 0.85rem;">
                            游댃 Aktualizovat
                        </button>
                        <button class="btn" onclick="confirmNewGame()" style="background: #8B0000; padding: 0.6rem; font-size: 0.85rem;">
                            游 Nov치 hra
                        </button>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>
            `);
        }
        
        function confirmLoadCloud() {
            showModal('游닌 Na캜칤st z cloudu?', `
                <div style="text-align: center;">
                    <p style="color: #ff9800;">丘멆잺 T칤m p콏ep칤코e코 sou캜asn칳 lok치ln칤 save!</p>
                    <p style="color: #888;">Opravdu chce코 na캜칤st save z cloudu?</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showAccountProfile()" style="background: #555;">Zru코it</button>
                    <button class="btn" onclick="loadCloudSave(true); closeModal();" style="background: #2196f3;">游닌 Na캜칤st</button>
                </div>
            `);
        }
        
        function showChangePasswordForm() {
            showModal('游댐 Zm캩nit heslo', `
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Sou캜asn칠 heslo:</label>
                    <div style="position: relative;">
                        <input type="password" id="currentPassword" placeholder="뮉뮉뮉뮉뮉뮉뮉"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('currentPassword', this)" 
                            style="position: absolute; right: 10px; top: 35%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; user-select: none;">游녜勇</span>
                    </div>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Nov칠 heslo (min. 6 znak콢):</label>
                    <div style="position: relative;">
                        <input type="password" id="newPassword" placeholder="뮉뮉뮉뮉뮉뮉뮉"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('newPassword', this)" 
                            style="position: absolute; right: 10px; top: 35%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; user-select: none;">游녜勇</span>
                    </div>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Nov칠 heslo znovu:</label>
                    <div style="position: relative;">
                        <input type="password" id="newPassword2" placeholder="뮉뮉뮉뮉뮉뮉뮉"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('newPassword2', this)" 
                            style="position: absolute; right: 10px; top: 35%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; user-select: none;">游녜勇</span>
                    </div>
                    
                    <div id="changePassError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doChangePassword()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        游댐 Zm캩nit heslo
                    </button>
                </div>
                <button class="btn" onclick="showAccountProfile()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        async function doChangePassword() {
            const currentPass = document.getElementById('currentPassword')?.value;
            const newPass = document.getElementById('newPassword')?.value;
            const newPass2 = document.getElementById('newPassword2')?.value;
            const errorDiv = document.getElementById('changePassError');
            
            if (!currentPass) {
                if (errorDiv) { errorDiv.textContent = 'Zadej sou캜asn칠 heslo!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (!newPass || newPass.length < 6) {
                if (errorDiv) { errorDiv.textContent = 'Nov칠 heslo mus칤 m칤t alespo켿 6 znak콢!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (newPass !== newPass2) {
                if (errorDiv) { errorDiv.textContent = 'Nov치 hesla se neshoduj칤!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                if (errorDiv) { errorDiv.textContent = '낍 M캩n칤m heslo...'; errorDiv.style.display = 'block'; errorDiv.style.color = '#ff9800'; }
                
                // Reautentizace u쬴vatele
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass);
                await currentUser.reauthenticateWithCredential(credential);
                
                // Zm캩na hesla
                await currentUser.updatePassword(newPass);
                
                closeModal();
                notifySuccess('九 Heslo zm캩n캩no!', 'Tvoje heslo bylo 칰sp캩코n캩 zm캩n캩no.');
                
            } catch (error) {
                console.error('Change password error:', error);
                let msg = 'Chyba p콏i zm캩n캩 hesla';
                if (error.code === 'auth/wrong-password') msg = '맗atn칠 sou캜asn칠 heslo!';
                else if (error.code === 'auth/weak-password') msg = 'Nov칠 heslo je p콏칤li코 slab칠';
                else if (error.code === 'auth/requires-recent-login') msg = 'Odhl치sit se a p콏ihl치sit se znovu';
                
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
            }
        }
        
        async function doLogout() {
            try {
                await firebaseAuth.signOut();
                currentUser = null;
                isGuest = true;
                closeModal();
                notifyInfo('游뛁 Odhl치코eno', 'Pokra캜uje코 jako host');
                renderFull();
            } catch (error) {
                console.error('Logout error:', error);
                notifyWarning('Chyba p콏i odhla코ov치n칤');
            }
        }
        
        // === CLOUD SAVE ===
        async function saveCloudSave() {
            if (!currentUser || currentUser.isAnonymous || !firebaseDB) return;
            
            try {
                const saveData = {
                    state: JSON.parse(JSON.stringify(state)),
                    savedAt: firebase.database.ServerValue.TIMESTAMP,
                    version: '59'
                };
                
                // Odstra켿 citliv치 data
                delete saveData.state.adminPassword;
                
                await firebaseDB.ref('cloudSaves/' + currentUser.uid).set(saveData);
                console.log('驕勇 Cloud save ulo쬰n');
                
            } catch (error) {
                console.error('Cloud save error:', error);
            }
        }
        
        async function loadCloudSave(showNotification = false) {
            if (!currentUser || currentUser.isAnonymous || !firebaseDB) return;
            
            // OCHRANA: Nena캜칤tej cloud save b캩hem cestov치n칤 nebo akce
            if (!showNotification) { // Pokud to nen칤 manu치ln칤 na캜ten칤
                if (state.world?.traveling || state.map?.traveling) {
                    console.log('驕勇 P콏eskakuji auto-load - prob칤h치 cestov치n칤');
                    return;
                }
                if (state.currentAction && state.currentAction.endTime > Date.now()) {
                    console.log('驕勇 P콏eskakuji auto-load - prob칤h치 akce');
                    return;
                }
            }
            
            try {
                const snapshot = await firebaseDB.ref('cloudSaves/' + currentUser.uid).once('value');
                const cloudData = snapshot.val();
                
                if (cloudData && cloudData.state) {
                    // Na캜ti cloud save
                    const loadedState = cloudData.state;
                    
                    // Zachovej n캩kter치 lok치ln칤 nastaven칤
                    loadedState.settings = state.settings;
                    
                    // Nastav state
                    Object.assign(state, loadedState);
                    
                    // Nastav nick z 칰캜tu
                    if (currentUser.displayName) {
                        state.char.name = currentUser.displayName;
                    }
                    
                    if (showNotification) {
                        const savedDate = cloudData.savedAt ? new Date(cloudData.savedAt).toLocaleString('cs-CZ') : 'Nezn치m칠';
                        notifySuccess('驕勇 Cloud save na캜ten', 'Ze dne: ' + savedDate);
                    }
                    
                    renderFull();
                    saveGame(true); // Ulo lok치ln캩
                    
                    console.log('驕勇 Cloud save na캜ten');
                } else if (showNotification) {
                    notifyInfo('驕勇 콯치dn칳 cloud save', 'V cloudu nen칤 ulo쬰n치 hra');
                }
                
            } catch (error) {
                console.error('Cloud load error:', error);
                if (showNotification) {
                    notifyWarning('Chyba p콏i na캜칤t치n칤 z cloudu');
                }
            }
        }
        
        // === FIREBASE LISTENER REGISTRY ===
        // Centr치ln칤 registr pro spr치vn칠 uvoln캩n칤 Firebase listener콢
        const _firebaseListeners = {
            listeners: [],
            
            /**
             * Registruje nov칳 Firebase listener
             * @param {string} path - Cesta v datab치zi
             * @param {string} eventType - Typ ud치losti ('value', 'child_added', etc.)
             * @param {function} callback - Callback funkce
             * @param {function} errorCallback - Error callback (optional)
             * @returns {function} Unsubscribe funkce
             */
            subscribe(path, eventType, callback, errorCallback) {
                if (!firebaseDB) {
                    console.warn('Firebase DB nen칤 inicializov치na');
                    return () => {};
                }
                
                const ref = firebaseDB.ref(path);
                
                // Wrapper s error handlingem
                const wrappedCallback = (snapshot) => {
                    try {
                        callback(snapshot);
                    } catch (error) {
                        console.error(`Firebase listener error (${path}):`, error);
                        if (errorCallback) errorCallback(error);
                    }
                };
                
                // Zaregistruj listener
                ref.on(eventType, wrappedCallback, (error) => {
                    console.error(`Firebase subscription error (${path}):`, error);
                    if (errorCallback) errorCallback(error);
                });
                
                // Ulo do registry
                const listenerInfo = { path, eventType, callback: wrappedCallback, ref };
                this.listeners.push(listenerInfo);
                
                console.log(`游니 Firebase listener registered: ${path}`);
                
                // Vra콘 unsubscribe funkci
                return () => this.unsubscribe(listenerInfo);
            },
            
            /**
             * Odregistruje konkr칠tn칤 listener
             */
            unsubscribe(listenerInfo) {
                const { ref, eventType, callback } = listenerInfo;
                try {
                    ref.off(eventType, callback);
                    this.listeners = this.listeners.filter(l => l !== listenerInfo);
                    console.log(`游니 Firebase listener removed: ${listenerInfo.path}`);
                } catch (e) {
                    console.warn('Error removing listener:', e);
                }
            },
            
            /**
             * Odstran칤 v코echny listenery
             */
            unsubscribeAll() {
                console.log(`游니 Removing all ${this.listeners.length} Firebase listeners...`);
                this.listeners.forEach(({ ref, eventType, callback }) => {
                    try {
                        ref.off(eventType, callback);
                    } catch (e) {
                        console.warn('Error removing listener:', e);
                    }
                });
                this.listeners = [];
            },
            
            /**
             * Po캜et aktivn칤ch listener콢
             */
            get count() {
                return this.listeners.length;
            }
        };
        
        // Cleanup p콏i odchodu ze str치nky
        window.addEventListener('beforeunload', () => {
            _firebaseListeners.unsubscribeAll();
        });
        
        // Auto-save do cloudu ka쬯칳ch 2 minuty + real-time sync listener
        let lastCloudSaveTime = 0;
        let cloudSyncListener = null;
        let syncPaused = false; // Pauza b캩hem lok치ln칤ch akc칤
        
        // Auto-save ka쬯칠 2 minuty
        setInterval(() => {
            if (currentUser && !currentUser.isAnonymous && !syncPaused) {
                saveCloudSave();
                lastCloudSaveTime = Date.now();
            }
        }, 2 * 60 * 1000);
        
        // Kontrola nevyzvednut칳ch odm캩n ka쬯칳ch 5 minut
        setInterval(() => {
            if (multiplayerEnabled && firebaseDB && state.char?.name && typeof checkPendingRewards === 'function') {
                checkPendingRewards();
            }
        }, 5 * 60 * 1000);
        
        // Real-time listener na 칰zem칤 - synchronizuje zm캩ny okam쬴t캩
        let territoryRealTimeListener = null;
        function setupTerritoryRealTimeListener() {
            if (!firebaseDB) return;
            
            // Odstra켿 star칳 listener
            if (territoryRealTimeListener) {
                firebaseDB.ref('territories').off('value', territoryRealTimeListener);
            }
            
            territoryRealTimeListener = firebaseDB.ref('territories').on('value', (snapshot) => {
                const newData = snapshot.val() || {};
                const oldCache = window.territoryCache || {};
                
                // Zkontroluj jestli se n캩co zm캩nilo
                const newKeys = Object.keys(newData);
                const oldKeys = Object.keys(oldCache);
                
                let changed = newKeys.length !== oldKeys.length;
                if (!changed) {
                    for (const key of newKeys) {
                        if (newData[key]?.owner !== oldCache[key]?.owner) {
                            changed = true;
                            break;
                        }
                    }
                }
                
                // Aktualizuj cache
                window.territoryCache = newData;
                window.territoryCacheTime = Date.now();
                
                // Pokud se n캩co zm캩nilo a jsme na map캩, p콏ekresli
                if (changed && state.activeTab === 'map') {
                    console.log('游딬勇 Territory real-time update detected');
                    setTimeout(() => renderFull(), 100);
                }
            });
            
            console.log('游딬勇 Territory real-time listener aktivov치n');
        }
        
        // Real-time sync listener - sleduje zm캩ny v cloudu
        function setupCloudSyncListener() {
            if (!currentUser || currentUser.isAnonymous || !firebaseDB) return;
            
            // Odstra켿 star칳 listener
            if (cloudSyncListener) {
                firebaseDB.ref('cloudSaves/' + currentUser.uid).off('value', cloudSyncListener);
            }
            
            // Nastav nov칳 listener
            cloudSyncListener = firebaseDB.ref('cloudSaves/' + currentUser.uid).on('value', (snapshot) => {
                const cloudData = snapshot.val();
                if (!cloudData || !cloudData.savedAt) return;
                
                // Ignoruj pokud jsme pr치v캩 ulo쬴li (do 5 sekund)
                if (Date.now() - lastCloudSaveTime < 5000) return;
                
                // Ignoruj pokud je sync pozastaven
                if (syncPaused) return;
                
                // Ignoruj pokud prob칤h치 cestov치n칤, akce nebo boj
                if (state.world?.traveling || state.map?.traveling) return;
                if (state.currentAction && state.currentAction.endTime > Date.now()) return;
                if (isInCombat()) return;
                
                // Ignoruj pokud je otev콏en칳 modal s akc칤 (lov, t캩쬭a, atd.)
                const activeModal = document.querySelector('#modal[style*="flex"]');
                if (activeModal) {
                    const modalTitle = activeModal.querySelector('h2, h3')?.textContent || '';
                    const modalContent = activeModal.textContent || '';
                    const actionModals = ['Lov', 'T캩쬭a', 'Ryba콏en칤', 'Pr콢zkum', 'Va콏en칤', 'Alchymie', 'Sb캩r', 'Sp치nek', 'Mining', 'T캩쬰n칤', 'Kut치n칤'];
                    if (actionModals.some(a => modalTitle.includes(a) || modalContent.includes(a))) return;
                    // Pokud je v modalu progress bar, pravd캩podobn캩 prob칤h치 akce
                    if (activeModal.querySelector('[style*="width:"][style*="%"]') || activeModal.querySelector('.progress')) return;
                }
                
                // Porovnej 캜asy - pokud je cloud nov캩j코칤 o v칤c ne 10 sekund, nab칤dni sync
                const localSaveTime = state.lastSaveTime || 0;
                const cloudSaveTime = cloudData.savedAt;
                
                if (cloudSaveTime > localSaveTime + 10000) {
                    // Cloud je nov캩j코칤 - nab칤dni synchronizaci
                    showCloudSyncPrompt(cloudData, cloudSaveTime);
                }
            });
            
            console.log('驕勇 Real-time cloud sync aktivov치n');
        }
        
        // Dialog pro synchronizaci
        function showCloudSyncPrompt(cloudData, cloudTime) {
            // OCHRANA: Nezobrazuj pokud hra je코t캩 neza캜ala
            if (!state.confirmed) {
                console.log('驕勇 P콏eskakuji cloud sync - hra je코t캩 neza캜ala');
                return;
            }
            
            // OCHRANA: Nezobrazuj pokud se vytv치콏칤 nov치 postava
            if (window.creatingNewCharacter || sessionStorage.getItem('creatingNewCharacter') === 'true') {
                console.log('驕勇 P콏eskakuji cloud sync - vytv치콏칤 se nov치 postava');
                return;
            }
            
            // OCHRANA: Nezobrazuj pokud je lok치ln칤 hra velmi nov치
            if ((state.time?.totalElapsed || 0) < 60) {
                console.log('驕勇 P콏eskakuji cloud sync - hra je p콏칤li코 nov치');
                return;
            }
            
            // OCHRANA: Nezobrazuj pokud prob칤h치 akce
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                console.log('驕勇 P콏eskakuji cloud sync - prob칤h치 akce');
                return;
            }
            
            const cloudDays = cloudData.state?.time?.days || 0;
            const cloudLevel = cloudData.state?.char?.level || 1;
            const localDays = state.time?.days || 0;
            
            // Jen jednoduch치 notifikace m칤sto otravn칠ho modalu
            notifyInfo(
                '驕勇 Nov캩j코칤 cloud save',
                `Den ${cloudDays}, Lvl ${cloudLevel}  Synchronizuj v Online sekci`
            );
            
            console.log(`驕勇 Cloud save dostupn칳: Den ${cloudDays} vs lok치ln칤 Den ${localDays}`);
        }
        
        // P콏ijmout cloud sync (vol치no z Online sekce)
        async function acceptCloudSync() {
            closeModal();
            syncPaused = true;
            await loadCloudSave(true);
            setTimeout(() => syncPaused = false, 5000);
        }
        
        // Odm칤tnout cloud sync a ulo쬴t lok치ln칤 do cloudu
        async function rejectCloudSync() {
            closeModal();
            syncPaused = true;
            await saveCloudSave();
            lastCloudSaveTime = Date.now();
            notifySuccess('游 Lok치ln칤 save', 'Ulo쬰n do cloudu');
            setTimeout(() => syncPaused = false, 5000);
        }
        
        // Spus콘 listener po p콏ihl치코en칤
        document.addEventListener('userLoggedIn', () => {
            setTimeout(setupCloudSyncListener, 2000);
        });
        
        // === HR츼캛SK칄 JM칄NO ===
        function getPlayerName() {
            // Pokud je p콏ihl치코en칳, pou쬴j nick z 칰캜tu
            if (currentUser && currentUser.displayName) {
                return currentUser.displayName;
            }
            // Jinak pou쬴j jm칠no postavy ze hry
            return state.char.name || 'Nezn치m칳';
        }
        
        // setPlayerName a showSetNameModal odstran캩ny - jm칠no se nem캩n칤
        
        // === V칗PO캛ET SK칍RE ===
        function calculateMultiplayerScore() {
            // Pou쬴j spr치vn칠 prom캩nn칠
            const daysAlive = state.time?.days || 0;
            const kills = state.stats?.kills || 0;
            const itemsCrafted = state.stats?.itemsCrafted || 0;
            const dungeonsCleared = state.stats?.dungeonsCleared || (state.dungeon?.cleared ? Object.keys(state.dungeon.cleared).length : 0);
            const settlers = state.settlement?.settlers?.length || 0;
            const booksRead = state.readBooks?.length || 0;
            const money = getMoney() || 0;
            const level = state.char?.level || 1;
            const pvpWins = state.stats?.pvpWins || 0;
            
            const score = (
                level * 1000 +
                kills * 10 +
                daysAlive * 50 +
                itemsCrafted * 5 +
                money +
                booksRead * 200 +
                dungeonsCleared * 300 +
                settlers * 100 +
                pvpWins * 250
            );
            
            console.log('游늵 Score breakdown:', { level, kills, daysAlive, itemsCrafted, money, booksRead, dungeonsCleared, settlers, pvpWins, total: score });
            
            return score;
        }
        
        // === PVP FRAK캛N칈 V츼LKY ===
        
        // Z칤skat frakci hr치캜e
        function getPlayerFaction() {
            return state.pvpFaction || null;
        }
        
        // Definice str치쬮콢
        const TERRITORY_GUARDS = [
            { id: 'rookie', name: 'Nov치캜ek', icon: '游녻', hp: 80, damage: 10, defense: 3, price: 25, desc: 'Z치kladn칤 str치쬮e' },
            { id: 'soldier', name: 'Voj치k', icon: '游눅', hp: 150, damage: 18, defense: 8, price: 75, desc: 'Zku코en칳 bojovn칤k' },
            { id: 'veteran', name: 'Veter치n', icon: '游꿌勇', hp: 250, damage: 28, defense: 12, price: 175, desc: 'Tvrd칳 protivn칤k' },
            { id: 'elite', name: 'Elita', icon: '丘덢잺', hp: 400, damage: 45, defense: 18, price: 400, desc: 'Nebezpe캜n칳 zabij치k' },
            { id: 'champion', name: '마mpion', icon: '游끥', hp: 600, damage: 65, defense: 25, price: 800, desc: 'Legend치rn칤 bojovn칤k' }
        ];
        
        const MAX_GUARDS_PER_TERRITORY = 3;
        
        // P콏ipojit se k frakci
        // === HELPER: Aktualizace aktivity 캜lena frakce ===
        
        async function updateFactionActivity() {
            const faction = getPlayerFaction();
            if (!faction || !multiplayerEnabled || !firebaseDB) return;
            
            try {
                const playerName = getPlayerName();
                const sanitizedName = playerName.replace(/[\\/\\.#$\\[\\]]/g, '_');
                
                // Zkontroluj factionSeason
                const seasonSnap = await firebaseDB.ref('factionSeason').once('value');
                const seasonData = seasonSnap.val();
                
                if (!seasonData) {
                    // factionSeason neexistuje - vytvo콏 ho (prvn칤 inicializace)
                    console.log('游낎 Creating initial factionSeason');
                    await firebaseDB.ref('factionSeason').set({
                        startTime: Date.now(),
                        seasonNumber: 1,
                        lastReset: null
                    });
                } else if (seasonData.lastReset) {
                    // Byl proveden reset - zkontroluj jestli hr치캜 vstoupil do frakce P콎ED resetem
                    const joinedAt = state.pvpFactionJoinedAt || 0;
                    if (joinedAt < seasonData.lastReset) {
                        // Hr치캜 m캩l frakci p콏ed resetem - mus칤 si vybrat znovu!
                        console.log('游댃 Faction was reset after player joined, clearing local state');
                        state.pvpFaction = null;
                        state.pvpFactionJoinedAt = null;
                        state.pvpFactionContribution = 0;
                        saveGame();
                        notifyInfo('游낎 Frakce resetov치ny', 'Vyber si novou frakci!');
                        return;
                    }
                }
                
                // Zkontroluj jestli z치znam hr치캜e existuje v Firebase
                const snap = await firebaseDB.ref('factionMembers/' + sanitizedName).once('value');
                const existingData = snap.val();
                
                if (!existingData) {
                    // Z치znam neexistuje - vytvo콏 nov칳 (ale bez star칳ch bod콢!)
                    // Pokud hr치캜 vstoupil po resetu, m콢쬰 m칤t contribution
                    // Pokud vstoupil p콏ed a z치znam chyb칤, n캩co je 코patn캩 - dej 0
                    const safeContribution = (state.pvpFactionJoinedAt && seasonData?.lastReset && state.pvpFactionJoinedAt > seasonData.lastReset) 
                        ? (state.pvpFactionContribution || 0) 
                        : 0;
                    
                    await firebaseDB.ref('factionMembers/' + sanitizedName).set({
                        name: playerName,
                        faction: faction,
                        joinedAt: state.pvpFactionJoinedAt || Date.now(),
                        contribution: safeContribution,
                        lastActive: Date.now()
                    });
                    
                    // Synchronizuj lok치ln칤 stav
                    state.pvpFactionContribution = safeContribution;
                    
                    console.log('游댃 Re-registered in factionMembers:', playerName, 'contribution:', safeContribution);
                } else {
                    // Existuje - jen aktualizuj lastActive
                    await firebaseDB.ref('factionMembers/' + sanitizedName + '/lastActive').set(Date.now());
                }
            } catch(e) {
                console.log('Update faction activity error:', e);
            }
        }
        
        async function joinFaction(factionId) {
            if (!PVP_FACTIONS[factionId]) {
                notifyError('Chyba', 'Neplatn치 frakce');
                return false;
            }
            
            // Pokud u m치 frakci, nelze zm캩nit (zm캩na jen po resetu sez칩ny)
            if (state.pvpFaction) {
                notifyWarning('Nelze zm캩nit', 'Frakci m콢쬰코 zm캩nit a po skon캜en칤 sez칩ny!');
                return false;
            }
            
            // Kontrola po캜tu 캜len콢 - max rozd칤l mezi frakcemi je 3 hr치캜i
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const membersSnap = await firebaseDB.ref('factionMembers').once('value');
                    const members = membersSnap.val() || {};
                    
                    const factionCounts = { kory: 0, koudy: 0, independent: 0 };
                    Object.values(members).forEach(m => {
                        if (m.faction && factionCounts[m.faction] !== undefined) {
                            factionCounts[m.faction]++;
                        }
                    });
                    
                    const minCount = Math.min(...Object.values(factionCounts));
                    const targetCount = factionCounts[factionId];
                    
                    if (targetCount >= minCount + 3) {
                        const smallest = Object.entries(factionCounts)
                            .filter(([id, count]) => count === minCount)
                            .map(([id]) => PVP_FACTIONS[id]);
                        
                        notifyWarning('Frakce je pln치!', `P콏칤li코 mnoho 캜len콢. Zkus ${smallest.map(f => f.icon + ' ' + f.name).join(' nebo ')}`);
                        return false;
                    }
                } catch(e) {
                    console.error('Faction balance check error:', e);
                }
            }
            
            const now = Date.now();
            state.pvpFaction = factionId;
            state.pvpFactionJoinedAt = now;
            state.pvpFactionContribution = 0;
            
            // Pozastav cloud sync aby se zm캩na nep콏epsala
            if (typeof syncPaused !== 'undefined') {
                syncPaused = true;
                setTimeout(() => { syncPaused = false; }, 10000); // 10 sekund ochrana
            }
            
            // Ulo do Firebase (factionMembers)
            if (multiplayerEnabled && firebaseDB) {
                const playerName = getPlayerName();
                try {
                    await firebaseDB.ref('factionMembers/' + playerName.replace(/[\/\.#$\[\]]/g, '_')).set({
                        name: playerName,
                        faction: factionId,
                        joinedAt: now,
                        contribution: 0,
                        lastActive: now
                    });
                    console.log('游낎 Faction joined and saved to Firebase:', factionId);
                } catch(e) {
                    console.error('Faction join error:', e);
                }
            }
            
            // Ulo lok치ln캩
            saveGame();
            
            // Okam쬴t캩 ulo do cloudu (aby se to neztratilo)
            if (typeof saveCloudSave === 'function') {
                await saveCloudSave();
                lastCloudSaveTime = Date.now(); // Nastav 캜as ulo쬰n칤 aby se ignoroval p콏칤choz칤 sync
                console.log('游낎 Cloud save completed after faction join');
            }
            
            const faction = PVP_FACTIONS[factionId];
            notifySuccess(`${faction.icon} ${faction.name}`, 'V칤tej ve frakci!');
            return true;
        }
        
        // P콏isp캩t body pro frakci na aktu치ln칤 lokaci
        async function contributeToTerritory(points) {
            const faction = getPlayerFaction();
            if (!faction) {
                notifyWarning('Bez frakce', 'Mus칤코 se nejd콏칤v p콏idat k frakci!');
                return false;
            }
            
            const locationId = state.world?.currentLocation;
            if (!locationId) return false;
            
            // P콏idej body lok치ln캩
            state.pvpFactionContribution = (state.pvpFactionContribution || 0) + points;
            console.log('游낎 Contributing ' + points + ' points, local total: ' + state.pvpFactionContribution);
            
            // Ulo do Firebase
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const territoryRef = firebaseDB.ref('territories/' + locationId + '/points/' + faction);
                    await territoryRef.transaction(current => (current || 0) + points);
                    
                    // Aktualizuj contribution hr치캜e
                    const playerName = getPlayerName();
                    const sanitizedName = playerName.replace(/[\/\.#$\[\]]/g, '_');
                    console.log('游낎 Saving to factionMembers/' + sanitizedName + '/contribution');
                    
                    // Pou쬴j set s increment m칤sto transaction pro spolehlivost
                    const contribRef = firebaseDB.ref('factionMembers/' + sanitizedName + '/contribution');
                    const snap = await contribRef.once('value');
                    const currentVal = snap.val() || 0;
                    await contribRef.set(currentVal + points);
                    console.log('游낎 Contribution updated: ' + currentVal + ' -> ' + (currentVal + points));
                    
                    // Aktualizuj vlastn칤ka
                    await checkAndUpdateTerritoryOwner(locationId);
                    
                    // Aktualizuj aktivitu
                    await updateFactionActivity();
                    
                } catch(e) {
                    console.error('Territory contribution error:', e);
                }
            }
            
            return true;
        }
        
        // Zkontroluj a aktualizuj vlastn칤ka teritoria
        async function checkAndUpdateTerritoryOwner(locationId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                const territory = snapshot.val() || {};
                const points = territory.points || {};
                
                // Najdi frakci s nejv칤c body
                let maxPoints = 0;
                let winner = null;
                
                for (const [faction, pts] of Object.entries(points)) {
                    if (pts > maxPoints) {
                        maxPoints = pts;
                        winner = faction;
                    }
                }
                
                // Aktualizuj vlastn칤ka
                if (winner) {
                    await firebaseDB.ref('territories/' + locationId + '/owner').set(winner);
                }
            } catch(e) {
                console.error('Territory owner update error:', e);
            }
        }
        
        // Hlavn칤 Faction Hub v Online sekci
        async function showFactionHub() {
            const faction = getPlayerFaction();
            
            if (!faction) {
                // Pokud nem치 frakci, zobraz v칳b캩r
                showFactionSelection();
                return;
            }
            
            // Zajisti 쬰 hr치캜 je zaregistrov치n v factionMembers
            await updateFactionActivity();
            
            // M치 frakci - zobraz info se statistikami v코ech frakc칤
            const factionData = PVP_FACTIONS[faction];
            
            // Na캜ti statistiky z Firebase
            let factionStats = { kory: { territories: 0, members: 0, topMembers: [] }, koudy: { territories: 0, members: 0, topMembers: [] }, independent: { territories: 0, members: 0, topMembers: [] } };
            let myRank = '?';
            const totalLocations = WORLD_LOCATIONS.filter(l => l.type !== 'home').length;
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    // Teritoria
                    const terrSnapshot = await firebaseDB.ref('territories').once('value');
                    const territories = terrSnapshot.val() || {};
                    Object.values(territories).forEach(t => {
                        if (t.owner && factionStats[t.owner]) factionStats[t.owner].territories++;
                    });
                    
                    // 캛lenov칠
                    const membersSnapshot = await firebaseDB.ref('factionMembers').once('value');
                    const members = membersSnapshot.val() || {};
                    const myName = getPlayerName();
                    
                    Object.values(members).forEach(m => {
                        if (m.faction && factionStats[m.faction]) {
                            factionStats[m.faction].members++;
                            factionStats[m.faction].topMembers.push({ name: m.name, contribution: m.contribution || 0 });
                        }
                    });
                    
                    // Se콏a캞 a o콏칤zni top 캜leny, najdi moji pozici
                    Object.entries(factionStats).forEach(([fid, fs]) => {
                        fs.topMembers.sort((a, b) => b.contribution - a.contribution);
                        if (fid === faction) {
                            const myIdx = fs.topMembers.findIndex(m => m.name === myName);
                            if (myIdx >= 0) myRank = myIdx + 1;
                        }
                        fs.topMembers = fs.topMembers.slice(0, 5);
                    });
                } catch(e) {
                    console.error('Faction stats error:', e);
                }
            }
            
            const canChange = !state.pvpFactionJoinedAt || (Date.now() - state.pvpFactionJoinedAt) >= (7 * 24 * 60 * 60 * 1000);
            let daysLeft = 0;
            if (!canChange) {
                daysLeft = Math.ceil((7 * 24 * 60 * 60 * 1000 - (Date.now() - state.pvpFactionJoinedAt)) / (24 * 60 * 60 * 1000));
            }
            
            // Najdi vedouc칤 frakci
            let leadingFactionId = null;
            let maxTerritories = 0;
            Object.entries(factionStats).forEach(([id, stats]) => {
                if (stats.territories > maxTerritories) {
                    maxTerritories = stats.territories;
                    leadingFactionId = id;
                }
            });
            window.leadingFaction = leadingFactionId;
            
            // Sesb칤rej v코echny top hr치캜e ze v코ech frakc칤 pro glob치ln칤 쬰b콏칤캜ek
            const allTopPlayers = [];
            Object.entries(factionStats).forEach(([fid, fs]) => {
                fs.topMembers.forEach(m => {
                    allTopPlayers.push({ ...m, faction: fid });
                });
            });
            allTopPlayers.sort((a, b) => b.contribution - a.contribution);
            const globalTop10 = allTopPlayers.slice(0, 10);
            
            // HTML pro v코echny frakce
            const allFactionsHtml = Object.entries(PVP_FACTIONS).map(([id, f]) => {
                const stats = factionStats[id];
                const percent = totalLocations > 0 ? Math.round(stats.territories / totalLocations * 100) : 0;
                const isMyFaction = id === faction;
                const isLeading = id === leadingFactionId;
                const topMembersHtml = stats.topMembers.length > 0 
                    ? stats.topMembers.map((m, i) => `<span style="color: ${f.color};">${i === 0 ? '游녬' : (i+1)+'.'} ${m.name} <span style="color: #888;">(${m.contribution})</span></span>`).join('<br>')
                    : '<span style="color: #555;">쮂멳n칤 캜lenov칠</span>';
                
                return `
                    <div style="background: ${f.color}${isMyFaction ? '30' : '15'}; padding: 0.8rem; border-radius: 8px; border: ${isMyFaction ? '2px' : '1px'} solid ${isMyFaction ? f.color : f.color + '44'}; margin-bottom: 0.5rem; ${isLeading ? 'box-shadow: 0 0 10px ' + f.color + '50;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: ${f.color}; font-weight: bold; font-size: 1.1rem;">${f.icon} ${f.name} ${isMyFaction ? '(ty)' : ''} ${isLeading ? '游녬' : ''}</span>
                            <span style="color: #fff;">${stats.territories} 칰zem칤</span>
                        </div>
                        ${isLeading ? '<p style="color: #ffd700; font-size: 0.75rem; margin: 0.2rem 0 0 0;">救 Vedouc칤 frakce - aktivn칤 bonus!</p>' : ''}
                        <div style="background: #000; height: 6px; border-radius: 3px; margin: 0.5rem 0; overflow: hidden;">
                            <div style="background: ${f.color}; height: 100%; width: ${percent}%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                            <span style="color: #888;">游논 ${stats.members} hr치캜콢</span>
                            <span style="color: #888;">${percent}% mapy</span>
                        </div>
                        <details style="margin-top: 0.5rem;">
                            <summary style="color: #666; cursor: pointer; font-size: 0.8rem;">游끥 Top hr치캜i frakce</summary>
                            <div style="padding: 0.3rem; font-size: 0.75rem; margin-top: 0.3rem;">${topMembersHtml}</div>
                        </details>
                    </div>
                `;
            }).join('');
            
            // HTML pro glob치ln칤 top 10
            const globalTopHtml = globalTop10.length > 0 
                ? globalTop10.map((m, i) => {
                    const f = PVP_FACTIONS[m.faction];
                    return `<div style="display: flex; justify-content: space-between; padding: 0.3rem; background: ${f.color}15; border-radius: 4px; margin-bottom: 0.2rem; border-left: 3px solid ${f.color};">
                        <span style="color: ${f.color};">${i === 0 ? '游볞' : i === 1 ? '游볟' : i === 2 ? '游볠' : (i+1)+'.'} ${f.icon} ${m.name}</span>
                        <span style="color: #ffd700;">${m.contribution}</span>
                    </div>`;
                }).join('')
                : '<p style="color: #555; text-align: center;">콯치dn칤 hr치캜i</p>';
            
            const isMyFactionLeading = faction === leadingFactionId;
            const bonusText = factionData.bonus.damage ? '+5% DMG' : factionData.bonus.xp ? '+5% XP' : '+5% loot';
            
            // P콏edpo캜칤tej war zone info
            const warZoneInfoHtml = await renderWarZoneInfo();
            
            showModal(`${factionData.icon} Frak캜n칤 v치lka`, `
                <!-- Moje frakce info -->
                <div style="background: ${factionData.color}20; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ${factionData.color};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: ${factionData.color}; font-weight: bold;">${factionData.icon} ${factionData.name}</span>
                        <span style="color: #888; font-size: 0.85rem;">Pozice: #${myRank}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.85rem;">
                        <span style="color: #ffd700;">P콏isp캩no: ${state.pvpFactionContribution || 0} bod콢</span>
                        <span style="color: ${isMyFactionLeading ? '#4caf50' : '#666'};">Bonus: ${bonusText} ${isMyFactionLeading ? '九' : '仇'}</span>
                    </div>
                    ${!isMyFactionLeading ? '<p style="color: #ff9800; font-size: 0.75rem; margin: 0.3rem 0 0 0;">丘멆잺 Bonus je aktivn칤 jen pro vedouc칤 frakci!</p>' : ''}
                </div>
                
                <!-- Glob치ln칤 top 10 -->
                <details style="margin-bottom: 1rem;">
                    <summary style="color: #ffd700; cursor: pointer; font-weight: bold;">游끥 Top 10 hr치캜콢 (v코echny frakce)</summary>
                    <div style="padding: 0.5rem; max-height: 200px; overflow-y: auto; margin-top: 0.5rem; background: #0a0a0a; border-radius: 6px;">
                        ${globalTopHtml}
                    </div>
                </details>
                
                <!-- P콏ehled frakc칤 - rozklik치vac칤 -->
                <details style="margin-bottom: 0.5rem;">
                    <summary style="color: #888; cursor: pointer; font-weight: bold; padding: 0.5rem; background: #1a1a1a; border-radius: 6px;">
                        游늵 P콏ehled frakc칤 <span style="color: #555; font-weight: normal;">(klikni pro detail)</span>
                    </summary>
                    <div style="max-height: 220px; overflow-y: auto; margin-top: 0.3rem;">
                        ${allFactionsHtml}
                    </div>
                </details>
                
                <!-- War Zone sekce - rozklik치vac칤 -->
                <details style="margin-bottom: 0.5rem;">
                    <summary style="color: #f44336; cursor: pointer; font-weight: bold; padding: 0.5rem; background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); border-radius: 6px; border: 1px solid #f4433650;">
                        丘덢잺 V치le캜n치 z칩na ${window.activeWarZone ? '<span style="color: #4caf50;">餃 AKTIVN칈</span>' : '<span style="color: #666;">餃 Neaktivn칤</span>'}
                    </summary>
                    <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 0 0 6px 6px; margin-top: 0.3rem;">
                        ${warZoneInfoHtml}
                    </div>
                </details>
                
                <!-- Sez칩na info -->
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #0a0a15 100%); padding: 0.6rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #ffd70050; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="color: #888; font-size: 0.8rem;">낍 Do konce sez칩ny:</span>
                        <span style="color: #ffd700; font-weight: bold; margin-left: 0.5rem;">${formatTimeRemaining(getSeasonEndTime() - Date.now())}</span>
                    </div>
                    <button class="btn" onclick="showSeasonInfo()" style="background: #ffd70030; border: 1px solid #ffd700; padding: 0.3rem 0.6rem; font-size: 0.8rem;">游늰 Info</button>
                </div>
                
                <button class="btn" onclick="showFactionHelp()" style="width: 100%; margin-top: 0.8rem; background: #2196f3;">仇 Jak to funguje</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav콏칤t</button>
            `);
        }
        
        // N치pov캩da k frak캜n칤mu syst칠mu
        // Renderov치n칤 War Zone info pro Frak캜n칤 hub
        async function renderWarZoneInfo() {
            let html = '';
            
            // Aktivn칤 war zone
            if (window.activeWarZone && window.activeWarZone.endTime > Date.now()) {
                const wz = window.activeWarZone;
                const loc = WORLD_LOCATIONS.find(l => l.id === wz.locationId);
                const enemy = ENEMIES.find(e => e.id === wz.enemyId);
                const remaining = Math.max(0, wz.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const hours = Math.floor(mins / 60);
                const timeStr = hours > 0 ? `${hours}h ${mins % 60}m` : `${mins}m`;
                
                // Na캜ti aktu치ln칤 body
                let pointsHtml = '<p style="color: #666;">Na캜칤t치m...</p>';
                if (multiplayerEnabled && firebaseDB) {
                    try {
                        const snap = await firebaseDB.ref('warZone/factionPoints').once('value');
                        const pts = snap.val() || {};
                        const sorted = Object.entries(PVP_FACTIONS)
                            .map(([fid, f]) => ({ fid, f, pts: pts[fid] || 0 }))
                            .sort((a, b) => b.pts - a.pts);
                        
                        pointsHtml = sorted.map(({ fid, f, pts }) => 
                            `<span style="color: ${f.color};">${f.icon} ${pts}</span>`
                        ).join(' | ');
                    } catch(e) {}
                }
                
                html += `
                    <div style="background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.6rem; border-radius: 6px; border: 1px solid #f44336;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #f44336; font-weight: bold;">游댠 PROB칈H츼!</span>
                            <span style="color: #ffd700;">낌勇 ${timeStr}</span>
                        </div>
                        <p style="color: #ddd; margin: 0.3rem 0;">游늸 ${loc?.icon || ''} ${loc?.name || wz.locationId}</p>
                        <p style="color: #888; margin: 0.3rem 0; font-size: 0.85rem;">游놏 ${enemy?.icon || ''} ${enemy?.name || '?'} (${wz.enemyCount}x) | 游끥 ${wz.reward}游눯</p>
                        <p style="color: #ff9800; margin: 0.5rem 0 0 0; font-size: 0.9rem;">游늵 Sk칩re: ${pointsHtml}</p>
                    </div>
                `;
            } else {
                html += `<p style="color: #666; text-align: center; margin: 0.5rem 0;">콯치dn치 aktivn칤 v치le캜n치 z칩na</p>`;
            }
            
            // Historie v칤t캩zstv칤
            html += `
                <div style="margin-top: 0.8rem; border-top: 1px solid #333; padding-top: 0.8rem;">
                    <p style="color: #ffd700; font-size: 0.9rem; margin: 0 0 0.5rem 0; font-weight: bold;">游닆 Historie v치lek:</p>
            `;
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const histSnap = await firebaseDB.ref('warZoneHistory').orderByChild('endTime').limitToLast(10).once('value');
                    const history = histSnap.val();
                    
                    if (history && Object.keys(history).length > 0) {
                        const entries = Object.entries(history).sort((a, b) => b[1].endTime - a[1].endTime);
                        html += `<div style="max-height: 180px; overflow-y: auto;">`;
                        html += entries.map(([key, h]) => {
                            const winnerF = PVP_FACTIONS[h.winner];
                            const loc = WORLD_LOCATIONS.find(l => l.id === h.locationId);
                            const date = new Date(h.endTime);
                            const dateStr = `${date.getDate()}.${date.getMonth()+1}. ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                            
                            // Zobraz body v코ech frakc칤 pokud jsou
                            let pointsStr = '';
                            if (h.points) {
                                const pts = Object.entries(h.points)
                                    .filter(([_, p]) => p > 0)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([fid, p]) => `${PVP_FACTIONS[fid]?.icon || '?'}${p}`)
                                    .join(' ');
                                if (pts) pointsStr = ` (${pts})`;
                            }
                            
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem; background: #111; border-radius: 4px; margin-bottom: 0.3rem; border-left: 3px solid ${winnerF?.color || '#666'};">
                                    <div>
                                        <span style="color: ${winnerF?.color || '#888'}; font-weight: bold;">${winnerF?.icon || '?'} ${winnerF?.name || '?'}</span>
                                        <span style="color: #666; font-size: 0.75rem;">${pointsStr}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #888; font-size: 0.8rem;">${loc?.icon || ''} ${loc?.name || '?'}</div>
                                        <div style="color: #555; font-size: 0.7rem;">${dateStr}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        html += `</div>`;
                    } else {
                        html += `<p style="color: #555; font-size: 0.85rem; text-align: center; padding: 1rem;">Zat칤m 쮂멳n치 historie v치lek</p>`;
                    }
                } catch(e) {
                    console.error('War history error:', e);
                    html += `<p style="color: #555; font-size: 0.85rem; text-align: center;">Chyba na캜칤t치n칤 historie</p>`;
                }
            } else {
                html += `<p style="color: #555; font-size: 0.85rem; text-align: center;">Offline re쬴m</p>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        function showFactionHelp() {
            showModal('仇 Jak funguje frak캜n칤 v치lka', `
                <div style="max-height: 400px; overflow-y: auto; font-size: 0.9rem;">
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游낎 Co je frak캜n칤 v치lka?</h4>
                    <p style="color: #ccc; margin-bottom: 1rem;">T콏i frakce bojuj칤 o nadvl치du nad pustinou. Vyber si stranu a pomoz j칤 ovl치dnout co nejv칤c 칰zem칤!</p>
                    
                    <h4 style="color: #f44336; margin: 0 0 0.5rem 0;">丘덢잺 V치le캜n치 z칩na (War Zone)</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>Admin vyhl치s칤 <strong>v치le캜nou z칩nu</strong> na lokaci</li>
                        <li>Lokace <strong>sv칤t칤 캜erven캩</strong> na map캩</li>
                        <li>Bojuje코 s <strong>pln칳m HP</strong> (po boji se vr치t칤 p콢vodn칤)</li>
                        <li><strong>Nezem콏e코</strong> - p콏i proh콏e jen cooldown</li>
                        <li>Cooldown <strong>10 minut</strong> mezi boji</li>
                        <li>V칳hra = <strong>body pro frakci</strong></li>
                        <li>콯치dn칠 XP ani loot</li>
                        <li>V칤t캩zn치 frakce dostane <strong>odm캩nu</strong></li>
                    </ul>
                    
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">游늰 T칳denn칤 sez칩ny</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>Ka쬯치 sez칩na trv치 <strong>1 t칳den</strong></li>
                        <li>Reset: <strong>Ned캩le 23:59</strong></li>
                        <li>V칤t캩z칤 frakce s <strong>nejv칤ce 칰zem칤mi</strong></li>
                        <li>Po resetu: v코echna 칰zem칤 neutr치ln칤, body na 0</li>
                    </ul>
                    
                    <h4 style="color: #4caf50; margin: 0 0 0.5rem 0;">游끥 Odm캩ny za sez칩nu</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li><strong>V칤t캩zn치 frakce:</strong> 100游눯 + 50 XP</li>
                        <li><strong>游볞 1. m칤sto:</strong> +200游눯 nav칤c</li>
                        <li><strong>游볟 2. m칤sto:</strong> +150游눯 nav칤c</li>
                        <li><strong>游볠 3. m칤sto:</strong> +100游눯 nav칤c</li>
                        <li><strong>칔캜ast (ostatn칤):</strong> 25游눯</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游딬勇 Jak dob칳vat 칰zem칤?</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li><strong>Neutr치ln칤</strong> - obsad칤코 okam쬴t캩</li>
                        <li><strong>Bez str치쬮콢</strong> - 캜ekej 30 minut</li>
                        <li><strong>Se str치쬮i</strong> - poraz je v boji</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游띠勇 Str치쬮i</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>Max <strong>3 str치쬮e</strong> na 칰zem칤</li>
                        <li>5 typ콢: Nov치캜ek  마mpion</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游늵 Body</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>+20 za neutr치ln칤 칰zem칤</li>
                        <li>+30 za dobyt칤 캜ek치n칤m</li>
                        <li>+50 za dobyt칤 bojem</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游눯 Dan캩 z 칰zem칤</h4>
                    <p style="color: #ccc; margin-bottom: 1rem;">5游눯/hod za ka쬯칠 칰zem칤, rozd캩leno mezi aktivn칤 캜leny.</p>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游꾸 Bonusy vedouc칤 frakce</h4>
                    <ul style="color: #ccc; margin: 0 0 0.5rem 1rem; padding: 0;">
                        <li>游댮 Kory: +5% damage</li>
                        <li>游댯 Koudy: +5% XP</li>
                        <li>游릮 Nez치visl칤: +5% loot</li>
                    </ul>
                </div>
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        // Zobrazit info o frakci
        // Zobrazit v칳b캩r frakce
        function showFactionSelection() {
            const currentFaction = getPlayerFaction();
            const canChange = !state.pvpFactionJoinedAt || (Date.now() - state.pvpFactionJoinedAt) >= (7 * 24 * 60 * 60 * 1000);
            
            let daysLeft = 0;
            if (state.pvpFactionJoinedAt && !canChange) {
                daysLeft = Math.ceil((7 * 24 * 60 * 60 * 1000 - (Date.now() - state.pvpFactionJoinedAt)) / (24 * 60 * 60 * 1000));
            }
            
            const factionsHtml = Object.values(PVP_FACTIONS).map(f => {
                const isCurrentFaction = currentFaction === f.id;
                const bonusText = f.bonus.damage ? '+5% damage' : f.bonus.xp ? '+5% XP' : '+5% loot';
                return `
                    <button class="btn" onclick="confirmJoinFaction('${f.id}')" 
                        style="background: linear-gradient(135deg, ${f.color}40 0%, ${f.color}20 100%); 
                               border: 2px solid ${isCurrentFaction ? f.color : '#333'}; 
                               padding: 1rem; margin-bottom: 0.5rem; width: 100%;
                               ${!canChange && !isCurrentFaction ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                        ${!canChange && !isCurrentFaction ? 'disabled' : ''}>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">${f.icon}</div>
                            <div style="text-align: left; flex: 1;">
                                <div style="color: ${f.color}; font-weight: bold;">${f.name}</div>
                                <div style="color: #888; font-size: 0.8rem;">${f.desc}</div>
                                <div style="color: #ffd700; font-size: 0.75rem;">游꾸 Bonus: ${bonusText}</div>
                            </div>
                            ${isCurrentFaction ? '<div style="color: #4caf50;">九</div>' : ''}
                        </div>
                    </button>
                `;
            }).join('');
            
            showModal('游낎 Vyber si frakci', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #888;">P콏ipoj se k frakci a bojuj o teritoria!</p>
                    ${currentFaction ? `<p style="color: ${PVP_FACTIONS[currentFaction].color};">Aktu치ln칤: ${PVP_FACTIONS[currentFaction].icon} ${PVP_FACTIONS[currentFaction].name}</p>` : ''}
                    ${!canChange ? `<p style="color: #ff9800; font-size: 0.85rem;">낍 Zm캩na mo쬹치 za ${daysLeft} dn칤</p>` : ''}
                </div>
                
                <div style="max-height: 350px; overflow-y: auto;">
                    ${factionsHtml}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav콏칤t</button>
            `);
        }
        
        function confirmJoinFaction(factionId) {
            const faction = PVP_FACTIONS[factionId];
            const currentFaction = getPlayerFaction();
            
            if (currentFaction === factionId) {
                notifyInfo('U jsi 캜lenem', `U jsi v ${faction.name}`);
                return;
            }
            
            showModal(`${faction.icon} P콏ipojit se?`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${faction.icon}</div>
                    <h3 style="color: ${faction.color}; margin: 0.5rem 0;">${faction.name}</h3>
                    <p style="color: #888;">${faction.desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #ffd700; margin: 0;">游꾸 Bonus: ${faction.bonus.damage ? '+5% damage' : faction.bonus.xp ? '+5% XP' : '+5% loot chance'}</p>
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.85rem;">丘멆잺 Frakci m콢쬰코 zm캩nit a za 7 dn칤!</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showFactionSelection()" style="background: #555;">Zru코it</button>
                    <button class="btn" onclick="joinFaction('${factionId}'); closeModal(); showFactionHub();" style="background: ${faction.color};">P콏ipojit se!</button>
                </div>
            `);
        }
        
        // Zobrazit statistiky v코ech frakc칤
        async function showAllFactionStats() {
            let totalTerritories = { kory: 0, koudy: 0, independent: 0 };
            let totalPoints = { kory: 0, koudy: 0, independent: 0 };
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories').once('value');
                    const territories = snapshot.val() || {};
                    Object.values(territories).forEach(t => {
                        if (t.owner) totalTerritories[t.owner]++;
                        if (t.points) {
                            Object.entries(t.points).forEach(([f, p]) => {
                                totalPoints[f] = (totalPoints[f] || 0) + p;
                            });
                        }
                    });
                } catch(e) {
                    console.error('Stats error:', e);
                }
            }
            
            const totalLocations = WORLD_LOCATIONS.filter(l => l.type !== 'home').length;
            
            const statsHtml = Object.values(PVP_FACTIONS).map(f => {
                const terr = totalTerritories[f.id] || 0;
                const pts = totalPoints[f.id] || 0;
                const percent = Math.round(terr / totalLocations * 100);
                return `
                    <div style="background: ${f.color}20; padding: 1rem; border-radius: 8px; border-left: 4px solid ${f.color}; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: ${f.color}; font-weight: bold;">${f.icon} ${f.name}</span>
                            <span style="color: #fff;">${terr} 칰zem칤 (${percent}%)</span>
                        </div>
                        <div style="background: #000; height: 8px; border-radius: 4px; margin: 0.5rem 0; overflow: hidden;">
                            <div style="background: ${f.color}; height: 100%; width: ${percent}%;"></div>
                        </div>
                        <div style="color: #888; font-size: 0.8rem;">Celkem bod콢: ${pts.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
            
            showModal('游늵 Statistiky frakc칤', `
                ${statsHtml}
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        // Interval pro refresh territory modal b캩hem capture
        let territoryRefreshInterval = null;
        
        function stopTerritoryRefresh() {
            if (territoryRefreshInterval) {
                clearInterval(territoryRefreshInterval);
                territoryRefreshInterval = null;
            }
        }
        
        // Zobrazit akce na teritoriu (tla캜칤tko na lokaci)
        async function showTerritoryActions() {
            // Zastav p콏edchoz칤 refresh interval
            stopTerritoryRefresh();
            
            const faction = getPlayerFaction();
            if (!faction) {
                showFactionSelection();
                return;
            }
            
            const locationId = state.world?.currentLocation;
            if (!locationId || locationId === 'shelter') {
                notifyWarning('Nelze', 'Tady nem콢쬰코 dob칳vat 칰zem칤');
                return;
            }
            
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            const factionData = PVP_FACTIONS[faction];
            const myName = getPlayerName();
            
            // Na캜ti info o teritoriu
            let territoryOwner = null;
            let territoryGuards = [];
            let captureProgress = 0;
            let territoryPoints = {};
            let activePlayer = null; // Hr치캜 kter칳 pr치v캩 dob칳v치/bojuje
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    console.log('游낎 showTerritoryActions - loading territory:', locationId);
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    const territory = snapshot.val();
                    console.log('游낎 showTerritoryActions - RAW data from Firebase:', JSON.stringify(territory));
                    
                    if (territory) {
                        territoryOwner = territory.owner;
                        territoryGuards = territory.guards || [];
                        territoryPoints = territory.points || {};
                        console.log('游낎 showTerritoryActions - owner:', territoryOwner, 'guards:', territoryGuards.length);
                    } else {
                        console.log('游낎 showTerritoryActions - NO DATA for this territory!');
                    }
                    
                    // Kontrola aktivn칤ho hr치캜e na 칰zem칤
                    if (territory.activeCapture) {
                        const captureTime = territory.activeCapture.startTime || 0;
                        const timePassed = Date.now() - captureTime;
                        // Aktivn칤 capture vypr코칤 po 35 minut치ch (30 min + 5 min buffer)
                        if (timePassed < 35 * 60 * 1000 && territory.activeCapture.player !== myName) {
                            activePlayer = territory.activeCapture;
                        }
                    }
                    
                    captureProgress = state.territoryCapture?.[locationId]?.progress || 0;
                } catch(e) {
                    console.error('Territory load error:', e);
                }
            }
            
            const ownerFaction = territoryOwner ? PVP_FACTIONS[territoryOwner] : null;
            const isOurTerritory = territoryOwner === faction;
            const isEnemyTerritory = territoryOwner && territoryOwner !== faction;
            const isNeutral = !territoryOwner;
            
            // Pokud n캩kdo jin칳 dob칳v치 칰zem칤
            if (activePlayer && activePlayer.player !== myName) {
                const playerFaction = PVP_FACTIONS[activePlayer.faction];
                showModal(`游낎 ${loc?.name || '칔zem칤'}`, `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">丘덢잺</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">칔zem칤 je obsazov치no!</p>
                        <p style="color: #888;">Hr치캜 <strong style="color: ${playerFaction?.color || '#fff'};">${activePlayer.player}</strong> pr치v캩 dob칳v치 toto 칰zem칤.</p>
                        <p style="color: #666; font-size: 0.85rem;">Frakce: ${playerFaction?.icon || '?'} ${playerFaction?.name || '?'}</p>
                        <p style="color: #f44336; margin-top: 1rem;">游뛂 Nem콢쬰코 zde prov치d캩t akce dokud neskon캜칤.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zav콏칤t</button>
                `);
                return;
            }
            
            let actionsHtml = '';
            
            if (isOurTerritory) {
                // Na코e 칰zem칤 - m콢쬰me najmout str치쬮e (max 3)
                const guardsCount = territoryGuards.length;
                const canHireMore = guardsCount < MAX_GUARDS_PER_TERRITORY;
                
                const guardsListHtml = territoryGuards.length > 0 ? territoryGuards.map((g, i) => {
                    const guardDef = TERRITORY_GUARDS.find(gt => gt.id === g.type);
                    return `<span style="color: #8bc34a;">${guardDef?.icon || '游녻'} ${guardDef?.name || 'Str치쬮e'} (${g.hp}HP)</span>`;
                }).join(', ') : '<span style="color: #666;">콯치dn칤</span>';
                
                actionsHtml = `
                    <p style="color: #4caf50; text-align: center;">九 Toto 칰zem칤 pat콏칤 tv칠 frakci!</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0;">
                        <p style="color: #888; margin: 0 0 0.3rem 0;">游띠勇 Str치쬮i (${guardsCount}/${MAX_GUARDS_PER_TERRITORY}):</p>
                        <p style="margin: 0; font-size: 0.85rem;">${guardsListHtml}</p>
                    </div>
                    
                    ${canHireMore ? `
                        <h4 style="color: #ffd700; margin: 0.5rem 0;">俱 Najmout str치쬮e:</h4>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${TERRITORY_GUARDS.map(g => `
                                <button class="btn" onclick="hireGuard('${locationId}', '${g.id}')" style="width: 100%; margin-bottom: 0.3rem; background: #333; display: flex; justify-content: space-between; align-items: center; ${getMoney() < g.price ? 'opacity: 0.5;' : ''}" ${getMoney() < g.price ? 'disabled' : ''}>
                                    <span>${g.icon} ${g.name} <span style="color: #666; font-size: 0.75rem;">(仇벒잺${g.hp} 丘덢잺${g.damage} 游띠勇${g.defense})</span></span>
                                    <span style="color: #ffd700;">${g.price} 游눯</span>
                                </button>
                            `).join('')}
                        </div>
                    ` : `
                        <p style="color: #ff9800; text-align: center;">丘멆잺 Maximum str치쬮콢 dosa쬰no!</p>
                    `}
                `;
            } else if (isEnemyTerritory) {
                // Nep콏치telsk칠 칰zem칤
                if (territoryGuards.length > 0) {
                    // Se str치쬮i - mus칤me je postupn캩 porazit
                    const currentGuard = territoryGuards[0];
                    const guardDef = TERRITORY_GUARDS.find(g => g.id === currentGuard.type);
                    
                    actionsHtml = `
                        <p style="color: ${ownerFaction.color}; text-align: center;">${ownerFaction.icon} 칔zem칤 pat콏칤: ${ownerFaction.name}</p>
                        
                        <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid #f44336;">
                            <h4 style="color: #f44336; margin: 0 0 0.5rem 0;">丘덢잺 Str치쬮i: ${territoryGuards.length}</h4>
                            <p style="color: #ff6b6b; margin: 0 0 0.3rem 0;">Aktu치ln칤: ${guardDef?.icon || '游녻'} ${guardDef?.name || 'Str치쬮e'}</p>
                            <p style="color: #888; margin: 0;">仇벒잺 HP: ${currentGuard.hp || guardDef?.hp || 100}</p>
                            <p style="color: #888; margin: 0;">丘덢잺 Damage: ${guardDef?.damage || 10}</p>
                            ${territoryGuards.length > 1 ? `<p style="color: #666; font-size: 0.8rem; margin: 0.3rem 0 0 0;">+ ${territoryGuards.length - 1} dal코칤ch str치쬮콢</p>` : ''}
                        </div>
                        
                        <button class="btn" onclick="attackTerritoryGuard('${locationId}')" style="width: 100%; background: #f44336;">丘덢잺 Za칰to캜it!</button>
                        <p style="color: #666; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">Pora v코echny str치쬮e pro z칤sk치n칤 칰zem칤</p>
                    `;
                } else {
                    // Bez str치쬮e - 캜ek치n칤 30 minut
                    const progressPercent = Math.min(100, captureProgress);
                    actionsHtml = `
                        <p style="color: ${ownerFaction.color}; text-align: center;">${ownerFaction.icon} 칔zem칤 pat콏칤: ${ownerFaction.name}</p>
                        <p style="color: #ff9800; text-align: center;">游뛂 콯치dn칳 str치쬮e - m콢쬰코 obsadit 캜ek치n칤m!</p>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 0.5rem 0;">
                            <p style="color: #888; margin: 0 0 0.5rem 0;">Postup obsazen칤:</p>
                            <div style="background: #000; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${factionData.color}; height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                            </div>
                            <p style="color: #ffd700; text-align: center; margin: 0.5rem 0 0 0;">${progressPercent.toFixed(0)}% (celkem 30 min)</p>
                        </div>
                        
                        ${state.territoryCapture?.[locationId] ? `
                            <button class="btn" disabled style="width: 100%; background: #555; cursor: not-allowed;">
                                낍 Prob칤h치 obsazov치n칤... (${progressPercent.toFixed(0)}%)
                            </button>
                            <p style="color: #ff9800; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">丘멆잺 Z콢sta켿 na m칤st캩!</p>
                        ` : `
                            <button class="btn" onclick="startTerritoryCapture('${locationId}')" style="width: 100%; background: ${factionData.color};">
                                ${captureProgress > 0 ? '낍 Pokra캜ovat v obsazov치n칤' : '游낎 Za캜칤t obsazovat'}
                            </button>
                        `}
                        <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.3rem;">Mus칤코 z콢stat na lokaci!</p>
                    `;
                }
            } else {
                // Neutr치ln칤 칰zem칤
                actionsHtml = `
                    <p style="color: #888; text-align: center;">丘 Neutr치ln칤 칰zem칤 - nikdo ho neovl치d치</p>
                    <button class="btn" onclick="claimNeutralTerritory('${locationId}')" style="width: 100%; background: ${factionData.color}; margin-top: 1rem;">
                        游낎 Obsadit pro ${factionData.name}!
                    </button>
                    <p style="color: #666; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">Neutr치ln칤 칰zem칤 lze obsadit okam쬴t캩</p>
                `;
            }
            
            showModal(`游낎 ${loc?.name || '칔zem칤'}`, `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <p style="color: ${factionData.color}; margin: 0;">Tv치 frakce: ${factionData.icon} ${factionData.name}</p>
                    <p style="color: #888; font-size: 0.8rem; margin: 0;">Tv콢j p콏칤sp캩vek: ${state.pvpFactionContribution || 0} bod콢</p>
                </div>
                
                ${actionsHtml}
                
                <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem;">
                    <p style="color: #666; font-size: 0.7rem; margin: 0; text-align: center;">
                        游눠 Body = p콏칤sp캩vek do 쬰b콏칤캜ku. 칔zem칤 vlastn칤 frakce s nejv칤ce body.
                    </p>
                </div>
                
                <button class="btn" onclick="stopTerritoryRefresh(); closeModal();" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav콏칤t</button>
            `);
            
            // Pokud prob칤h치 capture, spus콘 auto-refresh ka쬯ou sekundu
            if (state.territoryCapture?.[locationId]) {
                territoryRefreshInterval = setInterval(() => {
                    // Zkontroluj jestli je modal je코t캩 otev콏en칳 a capture b캩쮂
                    const modalEl = document.getElementById('modalContainer');
                    if (!modalEl || modalEl.style.display === 'none' || !state.territoryCapture?.[locationId]) {
                        stopTerritoryRefresh();
                        return;
                    }
                    // Refresh modal
                    showTerritoryActions();
                }, 1000);
            }
        }
        
        // Najmout str치쬮e
        async function hireGuard(locationId, guardType) {
            const guard = TERRITORY_GUARDS.find(g => g.id === guardType);
            if (!guard) return;
            
            const faction = getPlayerFaction();
            if (!faction) return;
            
            if (getMoney() < guard.price) {
                notifyWarning('M치lo pen캩z', `Pot콏ebuje코 ${guard.price} 游눯`);
                return;
            }
            
            // Zkontroluj vlastnictv칤, aktivitu a max str치쬮콢
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    const territory = snapshot.val() || {};
                    
                    // Kontrola vlastnictv칤 - pouze 캜lenov칠 vlastn칤c칤 frakce m콢쬺u p콏idat str치쬮e
                    if (territory.owner !== faction) {
                        notifyWarning('Nelze!', 'Str치쬮e m콢쬰코 p콏idat jen na 칰zem칤 sv칠 frakce');
                        return;
                    }
                    
                    // Kontrola jestli n캩kdo nebojuje/nedob칳v치
                    if (territory.activeCapture) {
                        const timePassed = Date.now() - (territory.activeCapture.startTime || 0);
                        if (timePassed < 35 * 60 * 1000) {
                            const action = territory.activeCapture.action === 'fighting' ? 'bojuje' : 'dob칳v치 칰zem칤';
                            notifyWarning('칔zem칤 obsazeno!', `Hr치캜 ${territory.activeCapture.player} zde pr치v캩 ${action}`);
                            return;
                        }
                    }
                    
                    const currentGuards = territory.guards || [];
                    
                    if (currentGuards.length >= MAX_GUARDS_PER_TERRITORY) {
                        notifyWarning('Maximum!', `칔zem칤 m콢쬰 m칤t max ${MAX_GUARDS_PER_TERRITORY} str치쬮e`);
                        return;
                    }
                    
                    removeMoney(guard.price);
                    
                    // P콏idej str치쬮e do pole
                    currentGuards.push({
                        type: guardType,
                        hp: guard.hp,
                        hiredBy: getPlayerName(),
                        hiredAt: Date.now()
                    });
                    
                    await firebaseDB.ref('territories/' + locationId + '/guards').set(currentGuards);
                    
                    // Aktualizuj aktivitu
                    await updateFactionActivity();
                    
                    notifySuccess('Str치쬮e najat!', `${guard.icon} ${guard.name} hl칤d치 칰zem칤 (${currentGuards.length}/${MAX_GUARDS_PER_TERRITORY})`);
                } catch(e) {
                    console.error('Hire guard error:', e);
                }
            }
            
            closeModal();
            showTerritoryActions();
        }
        
        // 칔tok na str치쬮e - pou쬴je klasick칳 bojov칳 syst칠m
        async function attackTerritoryGuard(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            const myName = getPlayerName();
            let territory = null;
            let guards = [];
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    territory = snapshot.val();
                    guards = territory?.guards || [];
                    
                    // Kontrola jestli n캩kdo jin칳 nebojuje
                    if (territory?.activeCapture) {
                        const timePassed = Date.now() - (territory.activeCapture.startTime || 0);
                        if (timePassed < 35 * 60 * 1000 && territory.activeCapture.player !== myName) {
                            notifyWarning('Obsazeno!', `Hr치캜 ${territory.activeCapture.player} zde pr치v캩 bojuje`);
                            return;
                        }
                    }
                } catch(e) {
                    console.error('Load territory error:', e);
                    return;
                }
            }
            
            if (guards.length === 0) {
                notifyInfo('콯치dn칳 str치쬮e', '칔zem칤 nem치 str치쬮e');
                showTerritoryActions();
                return;
            }
            
            // Zobraz p콏ehled str치쬮콢 p콏ed bojem
            const ownerFaction = territory?.owner ? PVP_FACTIONS[territory.owner] : null;
            const guardsListHtml = guards.map((g, i) => {
                const guardDef = TERRITORY_GUARDS.find(gt => gt.id === g.type);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${i === 0 ? '#f44336' : '#555'};">
                        <span>${guardDef?.icon || '游녻'} ${guardDef?.name || 'Str치쬮e'}</span>
                        <span style="color: #888;">仇벒잺 ${g.hp || guardDef?.hp || 100} | 丘덢잺 ${guardDef?.damage || 10}</span>
                    </div>
                `;
            }).join('');
            
            showModal('丘덢잺 Str치쬮i 칰zem칤', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: ${ownerFaction?.color || '#888'};">${ownerFaction?.icon || '?'} 칔zem칤 frakce: ${ownerFaction?.name || '?'}</p>
                    <p style="color: #f44336; font-size: 1.1rem;">游띠勇 ${guards.length} str치쬮콢 br치n칤 칰zem칤!</p>
                </div>
                
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">
                    ${guardsListHtml}
                </div>
                
                <p style="color: #888; font-size: 0.85rem; text-align: center;">Mus칤코 porazit v코echny str치쬮e abys dobyl 칰zem칤.</p>
                <p style="color: #ff9800; font-size: 0.8rem; text-align: center;">丘멆잺 Boj ned치v치 XP ani loot!</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;"> Zp캩t</button>
                    <button class="btn" onclick="startGuardCombat('${locationId}')" style="background: #f44336;">丘덢잺 Do boje!</button>
                </div>
            `);
        }
        
        // Spust칤 skute캜n칳 boj se str치쬮i
        async function startGuardCombat(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            const myName = getPlayerName();
            let territory = null;
            let guards = [];
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    territory = snapshot.val();
                    guards = territory?.guards || [];
                    
                    // Zapi코 쬰 bojujeme
                    await firebaseDB.ref('territories/' + locationId + '/activeCapture').set({
                        player: myName,
                        faction: faction,
                        startTime: Date.now(),
                        action: 'fighting'
                    });
                } catch(e) {
                    console.error('Start guard combat error:', e);
                    return;
                }
            }
            
            if (guards.length === 0) {
                notifyInfo('콯치dn칳 str치쬮e', '칔zem칤 nem치 str치쬮e');
                return;
            }
            
            // Ulo info o teritori치ln칤m boji
            window.territoryBattle = {
                locationId: locationId,
                faction: faction,
                originalGuards: [...guards]
            };
            
            // P콏eve캞 str치쬮e na nep콏치tele pro bojov칳 syst칠m
            const enemyGroup = guards.map(g => {
                const guardDef = TERRITORY_GUARDS.find(gt => gt.id === g.type);
                return {
                    id: 'territory_guard_' + g.type,
                    name: guardDef?.name || 'Str치쬮e',
                    icon: guardDef?.icon || '游녻',
                    hp: g.hp || guardDef?.hp || 100,
                    maxHp: guardDef?.hp || 100,
                    damage: guardDef?.damage || 10,
                    defense: guardDef?.defense || 5,
                    xp: 0, // 콯치dn칠 XP
                    loot: [], // 콯치dn칳 loot
                    isGuard: true,
                    guardType: g.type
                };
            });
            
            closeModal();
            
            // Spus콘 klasick칳 boj
            startCombatWithGroup(enemyGroup, 'territory_guard', true);
        }
        
        // Callback po skon캜en칤 boje se str치쬮i
        async function onTerritoryBattleEnd(victory) {
            const battle = window.territoryBattle;
            if (!battle) return;
            
            const { locationId, faction } = battle;
            
            if (victory) {
                // Vyhr치li jsme - dobyli jsme 칰zem칤!
                if (multiplayerEnabled && firebaseDB) {
                    try {
                        await firebaseDB.ref('territories/' + locationId + '/guards').remove();
                        await firebaseDB.ref('territories/' + locationId + '/owner').set(faction);
                        await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                        await contributeToTerritory(50);
                        window.territoryCache = null;
                        
                        setTimeout(() => {
                            showModal('游끥 칔zem칤 dobyto!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem;">游끥</div>
                                    <p style="color: #4caf50; font-size: 1.2rem;">V코ichni str치쬮i pora쬰ni!</p>
                                    <p style="color: ${PVP_FACTIONS[faction].color};">칔zem칤 nyn칤 pat콏칤 ${PVP_FACTIONS[faction].name}!</p>
                                    <p style="color: #ffd700;">+50 bod콢 pro frakci</p>
                                </div>
                                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                            `);
                        }, 500);
                    } catch(e) {
                        console.error('Territory capture error:', e);
                    }
                }
            } else {
                // Prohr치li jsme nebo utekli - aktualizuj HP str치쬮콢
                if (multiplayerEnabled && firebaseDB) {
                    try {
                        // Z칤skej aktu치ln칤 stav str치쬮콢 z bojov칠ho syst칠mu
                        const cs = window.combatState;
                        if (cs) {
                            const remainingGuards = cs.enemies
                                .filter(e => e.hp > 0 && e.isGuard)
                                .map(e => ({
                                    type: e.guardType,
                                    hp: e.hp,
                                    hiredBy: battle.originalGuards.find(g => g.type === e.guardType)?.hiredBy || 'unknown',
                                    hiredAt: battle.originalGuards.find(g => g.type === e.guardType)?.hiredAt || Date.now()
                                }));
                            
                            if (remainingGuards.length > 0) {
                                await firebaseDB.ref('territories/' + locationId + '/guards').set(remainingGuards);
                            } else {
                                // V코ichni mrtv칤 ale hr치캜 taky - 칰zem칤 z콢st치v치
                                await firebaseDB.ref('territories/' + locationId + '/guards').remove();
                            }
                        }
                        
                        await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                    } catch(e) {
                        console.error('Update guards error:', e);
                    }
                }
            }
            
            window.territoryBattle = null;
        }
        
        // Obsadit neutr치ln칤 칰zem칤
        async function claimNeutralTerritory(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            console.log('游낎 claimNeutralTerritory:', locationId, 'faction:', faction);
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    console.log('游낎 Setting owner in Firebase...');
                    await firebaseDB.ref('territories/' + locationId + '/owner').set(faction);
                    console.log('游낎 Owner set! Now contributing...');
                    await contributeToTerritory(20);
                    // Invaliduj cache
                    window.territoryCache = null;
                    console.log('游낎 Claim complete!');
                } catch(e) {
                    console.error('Claim territory error:', e);
                    notifyWarning('Chyba', 'Nepoda콏ilo se obsadit: ' + e.message);
                    return;
                }
            }
            
            notifySuccess('칔zem칤 obsazeno!', `+20 bod콢 pro ${PVP_FACTIONS[faction].name}`);
            closeModal();
        }
        
        // Za캜칤t obsazovat 칰zem칤 bez str치쬮e (30 min 캜ek치n칤)
        async function startTerritoryCapture(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            const myName = getPlayerName();
            
            // KONTROLA: U prob칤h치 obsazov치n칤 na t칠to lokaci?
            if (state.territoryCapture?.[locationId]) {
                notifyWarning('U obsazuje코', 'Obsazov치n칤 ji prob칤h치');
                closeModal();
                return;
            }
            
            // KONTROLA: Zkontroluj Firebase jestli tam nen칤 aktivn칤 capture od tohoto hr치캜e
            let originalOwner = null;
            if (multiplayerEnabled && firebaseDB) {
                try {
                    // Nejd콏칤v zkontroluj jestli 칰zem칤 u nevlastn칤 na코e frakce
                    const ownerSnapshot = await firebaseDB.ref('territories/' + locationId + '/owner').once('value');
                    const currentOwner = ownerSnapshot.val();
                    originalOwner = currentOwner; // Ulo pro pozd캩j코칤 kontrolu
                    
                    if (currentOwner === faction) {
                        notifyInfo('칔zem칤 ji vlastn칤me', 'Toto 칰zem칤 u pat콏칤 tv칠 frakci');
                        closeModal();
                        return;
                    }
                    
                    const snapshot = await firebaseDB.ref('territories/' + locationId + '/activeCapture').once('value');
                    const activeCapture = snapshot.val();
                    
                    if (activeCapture && activeCapture.player === myName) {
                        // U m치me rozd캩lan칳 capture - obnov ho
                        const elapsed = Date.now() - activeCapture.startTime;
                        const progress = Math.min(100, (elapsed / (30 * 60 * 1000)) * 100);
                        
                        if (progress < 100) {
                            // Obnov lok치ln칤 stav
                            if (!state.territoryCapture) state.territoryCapture = {};
                            state.territoryCapture[locationId] = {
                                startTime: activeCapture.startTime,
                                progress: progress,
                                faction: activeCapture.faction,
                                originalOwner: activeCapture.originalOwner || currentOwner
                            };
                            
                            // Spus콘 listener
                            startTerritoryListener(locationId);
                            
                            notifyInfo('Obsazov치n칤 obnoveno', `Progress: ${progress.toFixed(0)}%`);
                            closeModal();
                            return;
                        } else {
                            // Capture m캩l b칳t dokon캜en - dokon캜i ho
                            await completeTerritoryCapture(locationId);
                            closeModal();
                            return;
                        }
                    } else if (activeCapture && activeCapture.player !== myName) {
                        // N캩kdo jin칳 obsazuje - zkontroluj jestli nen칤 star칳 (> 35 min)
                        const elapsed = Date.now() - activeCapture.startTime;
                        if (elapsed > 35 * 60 * 1000) {
                            // Star칳 capture - vy캜isti ho
                            console.log('游낎 Cleaning old capture from', activeCapture.player);
                            await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                            // Pokra캜uj v norm치ln칤m startu capture
                        } else {
                            notifyWarning('칔zem칤 obsazeno', `${activeCapture.player} ji obsazuje`);
                            closeModal();
                            return;
                        }
                    }
                } catch(e) {
                    console.error('Check capture error:', e);
                }
            }
            
            // Zapi코 aktivn칤ho hr치캜e do Firebase
            if (multiplayerEnabled && firebaseDB) {
                try {
                    await firebaseDB.ref('territories/' + locationId + '/activeCapture').set({
                        player: myName,
                        faction: faction,
                        startTime: Date.now(),
                        action: 'capturing',
                        originalOwner: originalOwner
                    });
                    // Invaliduj cache aby mapa zobrazila spr치vn칳 stav
                    window.territoryCache = null;
                    console.log('游낎 Capture started, cache invalidated');
                } catch(e) {
                    console.error('Start capture error:', e);
                }
            }
            
            // Inicializuj progress lok치ln캩
            if (!state.territoryCapture) state.territoryCapture = {};
            state.territoryCapture[locationId] = {
                startTime: Date.now(),
                progress: 0,
                faction: faction,
                originalOwner: originalOwner
            };
            
            // Spus콘 real-time listener na zm캩ny vlastn칤ka
            startTerritoryListener(locationId);
            
            notifyInfo('Obsazov치n칤 za캜alo', 'Z콢sta켿 na lokaci 30 minut');
            closeModal();
            
            // Spust칤 se v gameLoop
        }
        
        // Aktualizace obsazov치n칤 (vol치 se v gameLoop)
        async function updateTerritoryCapture(deltaSeconds) {
            if (!state.territoryCapture) return;
            
            const locationId = state.world?.currentLocation;
            const CAPTURE_DURATION = 30 * 60 * 1000; // 30 minut v ms
            
            // Projdi v코echny aktivn칤 capture
            for (const [capLocId, capture] of Object.entries(state.territoryCapture)) {
                // Pokud hr치캜 nen칤 na t칠to lokaci, zru코 capture
                if (capLocId !== locationId) {
                    console.log(`游낎 Capture zru코en - opustil jsi lokaci ${capLocId}`);
                    
                    // Odstra켿 listener a Firebase z치znam
                    stopTerritoryListener(capLocId);
                    if (multiplayerEnabled && firebaseDB) {
                        firebaseDB.ref('territories/' + capLocId + '/activeCapture').remove().catch(e => {});
                    }
                    
                    delete state.territoryCapture[capLocId];
                    notifyWarning('Obsazov치n칤 zru코eno', 'Opustil jsi lokaci p콏ed dokon캜en칤m');
                    continue;
                }
                
                // Kontrola dokon캜en칤 pomoc칤 캜asu
                if (capture.startTime) {
                    const elapsed = Date.now() - capture.startTime;
                    
                    // Aktualizuj progress v procentech
                    capture.progress = Math.min(100, (elapsed / CAPTURE_DURATION) * 100);
                    
                    if (elapsed >= CAPTURE_DURATION) {
                        // Dokon캜eno!
                        console.log('游낎 Capture duration reached for', capLocId);
                        stopTerritoryListener(capLocId);
                        await completeTerritoryCapture(capLocId);
                    }
                }
            }
        }
        
        // Real-time listenery pro 칰zem칤
        let territoryListeners = {};
        
        function startTerritoryListener(locationId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (territoryListeners[locationId]) return; // U b캩쮂
            
            const myFaction = getPlayerFaction();
            const myName = getPlayerName();
            
            // Listener na zm캩nu vlastn칤ka
            const ownerRef = firebaseDB.ref('territories/' + locationId + '/owner');
            territoryListeners[locationId] = ownerRef.on('value', (snapshot) => {
                const currentOwner = snapshot.val();
                const capture = state.territoryCapture?.[locationId];
                
                if (!capture) return;
                
                // Pokud 칰zem칤 u vlastn칤 na코e frakce, zru코 capture
                if (currentOwner === myFaction) {
                    console.log('游낎 [Listener] 칔zem칤 u vlastn칤me - ru코칤me capture');
                    firebaseDB.ref('territories/' + locationId + '/activeCapture').remove().catch(e => {});
                    delete state.territoryCapture[locationId];
                    stopTerritoryListener(locationId);
                    notifyInfo('Capture zru코en', '칔zem칤 u pat콏칤 tv칠 frakci!');
                    return;
                }
                
                // Pokud se vlastn칤k zm캩nil na jinou frakci (n캩kdo jin칳 dobyl)
                if (capture.originalOwner !== undefined && currentOwner !== capture.originalOwner && currentOwner !== null) {
                    console.log('游낎 [Listener] Vlastn칤k se zm캩nil - ru코칤me capture');
                    firebaseDB.ref('territories/' + locationId + '/activeCapture').remove().catch(e => {});
                    delete state.territoryCapture[locationId];
                    stopTerritoryListener(locationId);
                    notifyWarning('Capture zru코en', 'N캩kdo jin칳 pr치v캩 dobyl toto 칰zem칤!');
                }
            });
            
            console.log('游낎 Started territory listener for', locationId);
        }
        
        function stopTerritoryListener(locationId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (!territoryListeners[locationId]) return;
            
            firebaseDB.ref('territories/' + locationId + '/owner').off('value', territoryListeners[locationId]);
            delete territoryListeners[locationId];
            console.log('游낎 Stopped territory listener for', locationId);
        }
        
        function stopAllTerritoryListeners() {
            Object.keys(territoryListeners).forEach(locId => {
                stopTerritoryListener(locId);
            });
        }
        
        // Obnova rozd캩lan칠ho capture po refreshi str치nky
        async function restoreTerritoryCapture() {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (!state.confirmed) return;
            
            const myName = getPlayerName();
            const currentLocationId = state.world?.currentLocation;
            
            try {
                // Prohledej VECHNY 칰zem칤 jestli tam nem치me aktivn칤 capture
                const snapshot = await firebaseDB.ref('territories').once('value');
                const territories = snapshot.val() || {};
                
                for (const [locationId, territory] of Object.entries(territories)) {
                    const activeCapture = territory.activeCapture;
                    
                    if (activeCapture && activeCapture.player === myName) {
                        const elapsed = Date.now() - activeCapture.startTime;
                        const progress = Math.min(100, (elapsed / (30 * 60 * 1000)) * 100);
                        
                        console.log(`游낎 Found active capture at ${locationId}: ${progress.toFixed(1)}%`);
                        
                        if (progress >= 100) {
                            // M캩l b칳t dokon캜en - dokon캜i ho!
                            console.log('游낎 Auto-completing expired capture at', locationId);
                            await completeTerritoryCapture(locationId);
                        } else if (locationId === currentLocationId) {
                            // Jsme na t칠 lokaci - obnov lok치ln칤 stav
                            if (!state.territoryCapture) state.territoryCapture = {};
                            state.territoryCapture[locationId] = {
                                startTime: activeCapture.startTime,
                                progress: progress,
                                faction: activeCapture.faction,
                                originalOwner: activeCapture.originalOwner
                            };
                            
                            // Spus콘 listener
                            startTerritoryListener(locationId);
                            
                            console.log(`游낎 Capture obnoven: ${progress.toFixed(1)}%`);
                            notifyInfo('Obsazov치n칤 obnoveno', `Progress: ${progress.toFixed(0)}% - pokra캜uj!`);
                        } else {
                            // Nejsme na t칠 lokaci - zru코 capture
                            console.log('游낎 Cancelling capture at', locationId, '- player is elsewhere');
                            await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                            notifyWarning('Obsazov치n칤 zru코eno', `Opustil jsi ${locationId} p콏ed dokon캜en칤m`);
                        }
                    }
                }
            } catch(e) {
                console.error('Restore capture error:', e);
            }
        }
        
        async function completeTerritoryCapture(locationId) {
            const faction = getPlayerFaction();
            if (!faction) {
                console.log('游낎 completeTerritoryCapture - no faction!');
                return;
            }
            
            console.log('游낎 completeTerritoryCapture started for', locationId, 'faction:', faction);
            
            // Zastav listener
            stopTerritoryListener(locationId);
            
            // Sma lok치ln칤 stav (pokud existuje)
            if (state.territoryCapture && state.territoryCapture[locationId]) {
                delete state.territoryCapture[locationId];
            }
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    // Zkontroluj jestli 칰zem칤 u nem치me
                    const ownerSnapshot = await firebaseDB.ref('territories/' + locationId + '/owner').once('value');
                    const currentOwner = ownerSnapshot.val();
                    console.log('游낎 Current owner:', currentOwner);
                    
                    if (currentOwner === faction) {
                        // U m치me 칰zem칤
                        console.log('游낎 Territory already owned by us');
                        notifyInfo('칔zem칤 ji vlastn칤me', 'Toto 칰zem칤 u pat콏칤 tv칠 frakci');
                        
                        // Vy캜isti p콏칤padn칳 activeCapture
                        await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                        return;
                    }
                    
                    // Zkontroluj activeCapture
                    const captureRef = firebaseDB.ref('territories/' + locationId + '/activeCapture');
                    const captureSnapshot = await captureRef.once('value');
                    const activeCapture = captureSnapshot.val();
                    const myName = getPlayerName();
                    console.log('游낎 Active capture:', activeCapture, 'myName:', myName);
                    
                    // Pokud n캩kdo jin칳 aktivn캩 obsazuje (캜erstv칳 capture), neru코칤me
                    if (activeCapture && activeCapture.player !== myName) {
                        const elapsed = Date.now() - activeCapture.startTime;
                        if (elapsed < 35 * 60 * 1000) {
                            // N캩kdo jin칳 m치 캜erstv칳 capture - zru코eno
                            console.log('游낎 Someone else is capturing:', activeCapture.player);
                            notifyWarning('Obsazov치n칤 zru코eno', `${activeCapture.player} pr치v캩 obsazuje toto 칰zem칤`);
                            return;
                        }
                        // Star칳 capture - vy캜ist칤me a pokra캜ujeme
                        console.log('游낎 Cleaning stale capture from', activeCapture.player);
                    }
                    
                    // Vy캜isti activeCapture (n치코 nebo star칳)
                    await captureRef.remove();
                    console.log('游낎 ActiveCapture removed');
                    
                    // Nastav vlastn칤ka
                    console.log('游낎 Setting owner to', faction);
                    await firebaseDB.ref('territories/' + locationId + '/owner').set(faction);
                    console.log('游낎 Owner set successfully!');
                    
                    await contributeToTerritory(30);
                    window.territoryCache = null; // Invaliduj cache
                    
                    console.log('游낎 Territory captured:', locationId, 'for', faction);
                    notifySuccess('游낎 칔zem칤 dobyto!', `+30 bod콢 pro ${PVP_FACTIONS[faction].name}`);
                    
                } catch(e) {
                    console.error('Complete capture error:', e);
                    notifyWarning('Chyba', 'Nepoda콏ilo se dokon캜it obsazov치n칤: ' + e.message);
                }
            } else {
                notifySuccess('游낎 칔zem칤 dobyto!', `+30 bod콢 pro ${PVP_FACTIONS[faction].name}`);
            }
        }
        
        // Zru코it obsazov치n칤 칰zem칤
        async function cancelTerritoryCapture(locationId) {
            if (!state.territoryCapture || !state.territoryCapture[locationId]) return;
            
            // Zastav refresh interval
            stopTerritoryRefresh();
            
            // Odstra켿 z Firebase
            if (multiplayerEnabled && firebaseDB) {
                try {
                    await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                } catch(e) {
                    console.error('Cancel capture error:', e);
                }
            }
            
            // Odstra켿 lok치ln칤 stav
            delete state.territoryCapture[locationId];
            
            notifyInfo('Obsazov치n칤 zru코eno', 'Progress byl ztracen');
            closeModal();
            renderFull();
        }
        
        // Zobrazit mapu 칰zem칤 (zjednodu코en치)
        async function showTerritoryMap() {
            let territories = {};
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories').once('value');
                    territories = snapshot.val() || {};
                } catch(e) {}
            }
            
            // Seskup podle frakce
            const byFaction = { kory: [], koudy: [], independent: [], neutral: [] };
            WORLD_LOCATIONS.filter(l => l.type !== 'home').forEach(loc => {
                const owner = territories[loc.id]?.owner;
                if (owner) {
                    byFaction[owner].push(loc.name);
                } else {
                    byFaction.neutral.push(loc.name);
                }
            });
            
            const html = Object.entries(PVP_FACTIONS).map(([id, f]) => `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: ${f.color}; margin: 0 0 0.3rem 0;">${f.icon} ${f.name} (${byFaction[id].length})</h4>
                    <p style="color: #888; font-size: 0.75rem; margin: 0;">${byFaction[id].slice(0, 5).join(', ')}${byFaction[id].length > 5 ? '...' : ''}</p>
                </div>
            `).join('') + `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #888; margin: 0 0 0.3rem 0;">丘 Neutr치ln칤 (${byFaction.neutral.length})</h4>
                    <p style="color: #666; font-size: 0.75rem; margin: 0;">${byFaction.neutral.slice(0, 5).join(', ')}${byFaction.neutral.length > 5 ? '...' : ''}</p>
                </div>
            `;
            
            showModal('游딬勇 Mapa 칰zem칤', `
                ${html}
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        // Cache pro vedouc칤 frakci (aktualizuje se p콏i na캜ten칤 territory cache)
        window.leadingFaction = null;
        
        // Z칤skat vedouc칤 frakci (ta s nejv칤ce 칰zem칤mi)
        function getLeadingFaction() {
            if (!window.territoryCache) return null;
            
            const counts = { kory: 0, koudy: 0, independent: 0 };
            Object.values(window.territoryCache).forEach(t => {
                if (t.owner && counts[t.owner] !== undefined) {
                    counts[t.owner]++;
                }
            });
            
            let leading = null;
            let maxCount = 0;
            Object.entries(counts).forEach(([faction, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    leading = faction;
                }
            });
            
            window.leadingFaction = leading;
            return leading;
        }
        
        // Z칤skat frak캜n칤 bonus hr치캜e (pouze pokud je jeho frakce vedouc칤!)
        function getFactionBonus() {
            const faction = getPlayerFaction();
            if (!faction || !PVP_FACTIONS[faction]) return { damage: 0, xp: 0, loot: 0 };
            
            // Bonus pouze pro vedouc칤 frakci
            const leading = window.leadingFaction || getLeadingFaction();
            if (faction !== leading) {
                return { damage: 0, xp: 0, loot: 0 }; // Nen칤 vedouc칤, 쮂멳n칳 bonus
            }
            
            return PVP_FACTIONS[faction].bonus;
        }
        
        // Z칤skat barvu frakce hr치캜e podle jm칠na (pro chat)
        async function getPlayerFactionColor(playerName) {
            if (!multiplayerEnabled || !firebaseDB) return null;
            
            try {
                const sanitizedName = playerName.replace(/[\/\.#$\[\]]/g, '_');
                const snapshot = await firebaseDB.ref('factionMembers/' + sanitizedName).once('value');
                const data = snapshot.val();
                if (data?.faction && PVP_FACTIONS[data.faction]) {
                    return PVP_FACTIONS[data.faction].color;
                }
            } catch(e) {
                console.log('Get faction color error:', e);
            }
            return null;
        }
        
        // === DAN캨 Z 칔ZEM칈 ===
        // Ka쬯ou hodinu se rozd캩l칤 p콏칤jem z 칰zem칤 mezi 캜leny frakce
        async function collectTerritoryTaxes() {
            const faction = getPlayerFaction();
            if (!faction || !multiplayerEnabled || !firebaseDB) return;
            
            try {
                // Na캜ti po캜et 칰zem칤 tv칠 frakce
                const terrSnapshot = await firebaseDB.ref('territories').once('value');
                const territories = terrSnapshot.val() || {};
                
                let factionTerritories = 0;
                Object.values(territories).forEach(t => {
                    if (t.owner === faction) factionTerritories++;
                });
                
                if (factionTerritories === 0) return; // 콯치dn치 칰zem칤, 쮂멳n칠 dan캩
                
                // Na캜ti po캜et aktivn칤ch 캜len콢 frakce (online v posledn칤ch 24h)
                const membersSnapshot = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnapshot.val() || {};
                
                let activeMembers = 0;
                const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
                Object.values(members).forEach(m => {
                    if (m.faction === faction && m.lastActive && m.lastActive > dayAgo) {
                        activeMembers++;
                    }
                });
                
                // Minim치ln캩 1 캜len (ty)
                activeMembers = Math.max(1, activeMembers);
                
                // V칳po캜et p콏칤jmu: 2 pen캩z za 칰zem칤 za hodinu, rozd캩leno mezi aktivn칤 캜leny (sn칤쬰no z 5)
                const totalIncome = factionTerritories * 2;
                const myShare = Math.floor(totalIncome / activeMembers);
                
                if (myShare > 0) {
                    addMoney(myShare); // Pou쬴j spr치vnou funkci
                    
                    // Aktualizuj lastActive pro sebe
                    const myName = getPlayerName();
                    const sanitizedName = myName.replace(/[\/\.#$\[\]]/g, '_');
                    await firebaseDB.ref('factionMembers/' + sanitizedName + '/lastActive').set(Date.now());
                    
                    // Notifikace
                    const factionData = PVP_FACTIONS[faction];
                    notifySuccess(`${factionData.icon} Dan캩 z 칰zem칤`, `+${myShare}游눯 (${factionTerritories} 칰zem칤)`);
                    addLog(`${factionData.icon} Frak캜n칤 dan캩: +${myShare} pen캩z z ${factionTerritories} 칰zem칤`, '游눯');
                    
                    console.log(`游눯 Territory taxes: ${myShare} money from ${factionTerritories} territories (${activeMembers} active members)`);
                }
            } catch(e) {
                console.error('Territory taxes error:', e);
            }
        }
        
        // === T칗DENN칈 SEZ칍NA FRAK캛N칈 V츼LKY ===
        
        // Z칤skat 캜as do konce sez칩ny (ned캩le 23:59:59)
        function getSeasonEndTime() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = ned캩le
            const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
            
            const endDate = new Date(now);
            endDate.setDate(now.getDate() + daysUntilSunday);
            endDate.setHours(23, 59, 59, 999);
            
            return endDate.getTime();
        }
        
        // Form치tovat zb칳vaj칤c칤 캜as
        function formatTimeRemaining(ms) {
            if (ms <= 0) return 'Kon캜칤!';
            
            const days = Math.floor(ms / (24 * 60 * 60 * 1000));
            const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
            const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }
        
        // Zkontrolovat a prov칠st reset sez칩ny
        async function checkSeasonReset() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0 = ned캩le
                const hour = now.getHours();
                
                // Reset pouze v ned캩li mezi 23:00 a 23:59
                if (dayOfWeek !== 0 || hour < 23) {
                    return; // Nen칤 ned캩le ve캜er, nic ned캩lej
                }
                
                // Na캜ti posledn칤 reset
                const seasonSnapshot = await firebaseDB.ref('factionSeason').once('value');
                const seasonData = seasonSnapshot.val() || {};
                
                const lastReset = seasonData.lastReset || 0;
                const lastResetDate = new Date(lastReset);
                
                // Pokud u byl reset dnes (tuto ned캩li), nic ned캩lej
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (lastReset > today.getTime()) {
                    return; // U bylo resetov치no dnes
                }
                
                console.log('游댃 Je ned캩le 23:xx - 캜as na reset sez칩ny!');
                await performSeasonReset();
                
            } catch(e) {
                // Ignoruj permission denied chyby - Firebase pravidla nemus칤 dovolovat 캜ten칤
                if (e.message && e.message.includes('permission_denied')) {
                    console.log('Season check skipped - no permission');
                } else {
                    console.error('Season check error:', e);
                }
            }
        }
        
        // Z칤skat timestamp posledn칤 ned캩le 23:59:59 (pro zobrazen칤 "do konce sez칩ny")
        function getNextSundayMidnight() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = ned캩le
            
            // Kolik dn칤 do ned캩le?
            const daysUntilSunday = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);
            
            const nextSunday = new Date(now);
            nextSunday.setDate(now.getDate() + daysUntilSunday);
            nextSunday.setHours(23, 59, 59, 999);
            
            return nextSunday.getTime();
        }
        
        // Star치 funkce pro zp캩tnou kompatibilitu
        function getLastSundayMidnight() {
            return getNextSundayMidnight(); // Te캞 vrac칤 P콎칈T칈 ned캩li
        }
        
        // Prov칠st reset sez칩ny
        async function performSeasonReset() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                // 1. Zjisti v칳sledky p콏ed resetem
                const terrSnapshot = await firebaseDB.ref('territories').once('value');
                const territories = terrSnapshot.val() || {};
                
                const membersSnapshot = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnapshot.val() || {};
                
                // Spo캜칤tej 칰zem칤 ka쬯칠 frakce
                const factionTerritories = { kory: 0, koudy: 0, independent: 0 };
                Object.values(territories).forEach(t => {
                    if (t.owner && factionTerritories[t.owner] !== undefined) {
                        factionTerritories[t.owner]++;
                    }
                });
                
                // Najdi v칤t캩ze
                let winnerFaction = null;
                let maxTerr = 0;
                Object.entries(factionTerritories).forEach(([fid, count]) => {
                    if (count > maxTerr) {
                        maxTerr = count;
                        winnerFaction = fid;
                    }
                });
                
                // Spo캜칤tej top 3 hr치캜e v칤t캩zn칠 frakce
                const winnerMembers = [];
                Object.entries(members).forEach(([key, m]) => {
                    if (m.faction === winnerFaction) {
                        winnerMembers.push({ key, name: m.name, contribution: m.contribution || 0 });
                    }
                });
                winnerMembers.sort((a, b) => b.contribution - a.contribution);
                const top3Winners = winnerMembers.slice(0, 3);
                
                // 2. Ulo historii sez칩ny
                const seasonNumber = (await firebaseDB.ref('factionSeason/seasonCount').once('value')).val() || 0;
                await firebaseDB.ref('factionSeasonHistory/' + (seasonNumber + 1)).set({
                    endedAt: Date.now(),
                    winner: winnerFaction,
                    territories: factionTerritories,
                    top3: top3Winners.map(m => ({ name: m.name, contribution: m.contribution }))
                });
                
                // 3. Reset 칰zem칤
                await firebaseDB.ref('territories').remove();
                
                // 4. Reset 캜len콢 frakc칤 - v코ichni si mus칤 vybrat znovu
                await firebaseDB.ref('factionMembers').remove();
                
                // 5. Aktualizuj sez칩nu
                await firebaseDB.ref('factionSeason').set({
                    lastReset: Date.now(),
                    seasonCount: seasonNumber + 1,
                    lastWinner: winnerFaction,
                    lastTerritories: factionTerritories
                });
                
                console.log('九 Sez칩na resetov치na! V칤t캩z:', winnerFaction);
                
                // 6. Rozdej odm캩ny tomuto hr치캜i pokud je online
                await claimSeasonRewards(winnerFaction, top3Winners);
                
            } catch(e) {
                console.error('Season reset error:', e);
            }
        }
        
        // Vyzvednout odm캩ny za sez칩nu
        async function claimSeasonRewards(winnerFaction, top3Winners) {
            const myFaction = getPlayerFaction();
            const myName = getPlayerName();
            
            if (!myFaction) return;
            
            let reward = { money: 0, xp: 0, bonus: '' };
            
            if (myFaction === winnerFaction) {
                // V칤t캩zn치 frakce
                reward.money = 100;
                reward.xp = 50;
                reward.bonus = '游끥 V칤t캩zn치 frakce!';
                
                // Bonus pro TOP 3
                const myRank = top3Winners.findIndex(m => m.name === myName);
                if (myRank === 0) {
                    reward.money += 200;
                    reward.bonus = '游볞 1. m칤sto ve frakci!';
                } else if (myRank === 1) {
                    reward.money += 150;
                    reward.bonus = '游볟 2. m칤sto ve frakci!';
                } else if (myRank === 2) {
                    reward.money += 100;
                    reward.bonus = '游볠 3. m칤sto ve frakci!';
                }
            } else {
                // 칔캜astnick치 odm캩na
                reward.money = 25;
                reward.xp = 0;
                reward.bonus = '칔캜astnick치 odm캩na';
            }
            
            // P콏idej odm캩ny
            if (reward.money > 0) {
                state.money = (state.money || 0) + reward.money;
            }
            if (reward.xp > 0) {
                addXP(reward.xp);
            }
            
            // Reset lok치ln칤ch dat - hr치캜 si mus칤 vybrat novou frakci
            state.pvpFactionContribution = 0;
            state.pvpFaction = null;
            state.pvpFactionJoinedAt = null;
            saveGame();
            
            // Zobraz notifikaci
            const winnerData = PVP_FACTIONS[winnerFaction];
            showModal('游끠 Sez칩na skon캜ila!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin: 1rem 0;">${winnerData?.icon || '游끥'}</div>
                    <h2 style="color: ${winnerData?.color || '#ffd700'}; margin: 0;">V칤t캩z: ${winnerData?.name || 'Nezn치m치 frakce'}</h2>
                    <p style="color: #888;">Ovl치dli ${factionTerritories?.[winnerFaction] || 0} 칰zem칤!</p>
                    
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${myFaction === winnerFaction ? '#4caf50' : '#666'};">
                        <p style="color: ${myFaction === winnerFaction ? '#4caf50' : '#888'}; font-size: 1.2rem; margin: 0;">${reward.bonus}</p>
                        <p style="color: #ffd700; font-size: 1.1rem; margin: 0.5rem 0;">+${reward.money} 游눯${reward.xp > 0 ? ` +${reward.xp} XP` : ''}</p>
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.9rem;">游댃 Vyber si frakci pro novou sez칩nu!</p>
                </div>
                <button class="btn" onclick="closeModal(); showFactionSelection();" style="width: 100%; margin-top: 1rem; background: #4caf50;">Vybrat frakci</button>
            `);
        }
        
        // Zobrazit info o sez칩n캩
        async function showSeasonInfo() {
            const seasonEnd = getSeasonEndTime();
            const timeLeft = seasonEnd - Date.now();
            const timeLeftStr = formatTimeRemaining(timeLeft);
            
            // Na캜ti historii
            let historyHtml = '<p style="color: #666; text-align: center;">콯치dn치 historie</p>';
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const historySnapshot = await firebaseDB.ref('factionSeasonHistory').orderByKey().limitToLast(5).once('value');
                    const history = historySnapshot.val() || {};
                    
                    const entries = Object.entries(history).reverse();
                    if (entries.length > 0) {
                        historyHtml = entries.map(([num, data]) => {
                            const winner = PVP_FACTIONS[data.winner];
                            const date = new Date(data.endedAt).toLocaleDateString('cs-CZ');
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${winner?.color || '#333'}20; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${winner?.color || '#666'};">
                                    <span style="color: #888;">Sez칩na ${num}</span>
                                    <span style="color: ${winner?.color || '#fff'};">${winner?.icon || '?'} ${winner?.name || '?'}</span>
                                    <span style="color: #666; font-size: 0.8rem;">${date}</span>
                                </div>
                            `;
                        }).join('');
                    }
                } catch(e) {
                    console.error('Season history error:', e);
                }
            }
            
            showModal('游늰 Frak캜n칤 sez칩na', `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #0a0a15 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ffd700;">
                    <div style="text-align: center;">
                        <p style="color: #888; margin: 0;">낍 Do konce sez칩ny:</p>
                        <p style="color: #ffd700; font-size: 2rem; font-weight: bold; margin: 0.5rem 0;">${timeLeftStr}</p>
                        <p style="color: #666; font-size: 0.8rem; margin: 0;">Reset: Ned캩le 23:59</p>
                    </div>
                </div>
                
                <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">游끥 Odm캩ny za v칳hru:</h4>
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                    <p style="color: #4caf50; margin: 0 0 0.3rem 0;">游끥 V칤t캩zn치 frakce: <span style="color: #ffd700;">100游눯 + 50 XP</span></p>
                    <p style="color: #ffd700; margin: 0 0 0.3rem 0;">游볞 1. m칤sto: <span style="color: #ffd700;">+200游눯 nav칤c</span></p>
                    <p style="color: #c0c0c0; margin: 0 0 0.3rem 0;">游볟 2. m칤sto: <span style="color: #ffd700;">+150游눯 nav칤c</span></p>
                    <p style="color: #cd7f32; margin: 0 0 0.3rem 0;">游볠 3. m칤sto: <span style="color: #ffd700;">+100游눯 nav칤c</span></p>
                    <p style="color: #888; margin: 0;">游닍 칔캜ast (ostatn칤): <span style="color: #ffd700;">25游눯</span></p>
                </div>
                
                <h4 style="color: #888; margin: 0 0 0.5rem 0;">游닆 Historie sez칩n:</h4>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${historyHtml}
                </div>
                
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        // === ONLINE STATUS ===
        function setupOnlineStatus() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const playerName = getPlayerName();
            // Sanitizace jm칠na pro Firebase cestu (/ . # $ [ ] nejsou povoleny)
            const sanitizedName = playerName.replace(/[\/\.#$\[\]]/g, '_');
            const playerRef = firebaseDB.ref('online/' + sanitizedName);
            
            // Nastav online - ulo skute캜n칠 jm칠no do dat
            playerRef.set({
                name: playerName,  // Skute캜n칠 jm칠no (m콢쬰 obsahovat speci치ln칤 znaky)
                level: state.char.level,
                location: state.world?.currentLocation || 'shelter',
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Aktualizuj frak캜n칤 aktivitu p콏i p콏ihl치코en칤
            updateFactionActivity();
            
            // P콏i odpojen칤 sma
            playerRef.onDisconnect().remove();
            
            // Aktualizuj ka쬯칳ch 30 sekund
            setInterval(() => {
                if (multiplayerEnabled) {
                    playerRef.update({
                        level: state.char.level,
                        location: state.world?.currentLocation || 'shelter',
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }, 30000);
        }
        
        // === LEADERBOARD ===
        async function submitScore() {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Multiplayer vypnut', 'Firebase nen칤 nakonfigurov치n');
                return;
            }
            
            initPvPStats();
            const playerName = getPlayerName();
            const score = calculateMultiplayerScore();
            
            // Pro registrovan칠 hr치캜e pou쬴j UID jako kl칤캜, pro hosty jm칠no
            const leaderboardKey = currentUser && !currentUser.isAnonymous 
                ? 'user_' + currentUser.uid 
                : playerName;
            
            try {
                await firebaseDB.ref('leaderboard/' + leaderboardKey).set({
                    name: playerName,
                    score: score,
                    level: state.char.level,
                    kills: state.stats?.kills || 0,
                    days: state.time?.days || 0,
                    // PvP Stats
                    pvpElo: state.pvp?.elo || 1000,
                    pvpWins: state.pvp?.wins || 0,
                    pvpLosses: state.pvp?.losses || 0,
                    pvpWinStreak: state.pvp?.maxWinStreak || 0,
                    // Dopl켿kov칠 info
                    classId: state.char.classId || 'survivor',
                    settlers: state.settlement?.settlers?.length || 0,
                    dungeonsCleared: state.dungeon?.cleared ? Object.keys(state.dungeon.cleared).length : 0,
                    uid: currentUser?.uid || null,
                    isRegistered: currentUser && !currentUser.isAnonymous,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Pokud je registrovan칳, sma star칳 z치znam pod jm칠nem (pokud existuje a je jin칳 kl칤캜)
                if (currentUser && !currentUser.isAnonymous && leaderboardKey !== playerName) {
                    try {
                        await firebaseDB.ref('leaderboard/' + playerName).remove();
                    } catch (e) {
                        // Ignoruj chybu - star칳 z치znam nemusel existovat
                    }
                }
                
                notifySuccess('Sk칩re odesl치no!', `${score.toLocaleString()} bod콢 | ELO: ${state.pvp?.elo || 1000}`);
            } catch (e) {
                console.error('Chyba p콏i odes칤l치n칤 sk칩re:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se odeslat sk칩re');
            }
        }
        
        async function showLeaderboard() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('游끥 콯eb콏칤캜ek', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游댋</div>
                        <h3 style="color: #ff9800;">Multiplayer nen칤 aktivn칤</h3>
                        <p style="color: #888; margin: 1rem 0;">Pro pou쬴t칤 쬰b콏칤캜ku je pot콏eba nakonfigurovat Firebase.</p>
                        <p style="color: #666; font-size: 0.85rem;">Viz instrukce v k칩du hry.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            showModal('游끥 콯eb콏칤캜ek', `
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p>Na캜칤t치m 쬰b콏칤캜ek...</p>
                </div>
            `);
            
            try {
                const snapshot = await firebaseDB.ref('leaderboard')
                    .orderByChild('score')
                    .limitToLast(100)
                    .once('value');
                
                const data = snapshot.val() || {};
                const players = Object.values(data).sort((a, b) => b.score - a.score);
                
                // Na캜ti frakce hr치캜콢
                const factionsSnapshot = await firebaseDB.ref('factionMembers').once('value');
                const factionMembers = factionsSnapshot.val() || {};
                
                // Vytvo콏 mapu jm칠no -> frakce
                const playerFactions = {};
                Object.values(factionMembers).forEach(m => {
                    if (m.name && m.faction) {
                        playerFactions[m.name] = m.faction;
                    }
                });
                
                // Najdi pozici hr치캜e
                const myName = getPlayerName();
                const myScore = calculateMultiplayerScore();
                const myRank = players.findIndex(p => p.name === myName) + 1;
                
                // Online hr치캜i
                const onlineSnapshot = await firebaseDB.ref('online').once('value');
                const onlinePlayers = Object.keys(onlineSnapshot.val() || {});
                
                let html = `
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a7a4a;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
                            <div>
                                <div style="color: #888; font-size: 0.8rem;">Tv칠 sk칩re</div>
                                <div style="color: #ffd700; font-size: 1.3rem; font-weight: bold;">${myScore.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.8rem;">Pozice</div>
                                <div style="color: #8bc34a; font-size: 1.3rem; font-weight: bold;">#${myRank || '?'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">
                        游논 Online: ${onlinePlayers.length} hr치캜콢
                    </div>
                    
                    <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; border-radius: 8px; padding: 0.5rem;">
                `;
                
                if (players.length === 0) {
                    html += `<div style="text-align: center; padding: 2rem; color: #666;">콯치dn칤 hr치캜i v 쬰b콏칤캜ku</div>`;
                } else {
                    // Ulo data hr치캜콢 do glob치ln칤 prom캩nn칠
                    window._leaderboardPlayers = {};
                    players.forEach((player, idx) => {
                        window._leaderboardPlayers[player.name] = player;
                        const rank = idx + 1;
                        const medal = rank === 1 ? '游볞' : rank === 2 ? '游볟' : rank === 3 ? '游볠' : `${rank}.`;
                        const isMe = player.name === myName;
                        const isOnline = onlinePlayers.includes(player.name);
                        
                        // Frakce hr치캜e - text v z치vorce jako v chatu
                        const playerFaction = playerFactions[player.name];
                        const factionData = playerFaction ? PVP_FACTIONS[playerFaction] : null;
                        let factionPrefix = '';
                        if (factionData) {
                            const factionShort = playerFaction === 'kory' ? 'Koryho' : playerFaction === 'koudy' ? 'Koudyho' : 'Nez치visl칳';
                            factionPrefix = `<span style="color: ${factionData.color}; font-size: 0.65rem;">[${factionShort}]</span> `;
                        }
                        
                        html += `
                            <div onclick="${isMe ? '' : `showPlayerProfileByName('${escapeHtml(player.name).replace(/'/g, "\\'")}', ${isOnline})`}" 
                                 style="display: grid; grid-template-columns: 40px 1fr auto; gap: 0.5rem; padding: 0.6rem; background: ${isMe ? '#1a3a1a' : '#1a1a1a'}; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid ${isMe ? '#4a7a4a' : '#333'}; ${isMe ? '' : 'cursor: pointer;'} transition: transform 0.1s;"
                                 ${isMe ? '' : 'onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'"'}>
                                <div style="font-size: 1.1rem; text-align: center;">${medal}</div>
                                <div>
                                    <div style="color: ${isMe ? '#8bc34a' : '#fff'}; font-weight: ${isMe ? 'bold' : 'normal'};">
                                        ${isOnline ? '游릭' : '丘'} ${factionPrefix}${escapeHtml(player.name)} ${isMe ? '(ty)' : ''}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #666;">
                                        Lvl ${player.level || '?'} | 丘덢잺${player.kills || 0} | 游닆${player.quests || 0}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ffd700; font-weight: bold;">${(player.score || 0).toLocaleString()}</div>
                                    <div style="font-size: 0.7rem; color: #666;">${isMe ? '' : '游녡 klikni'}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`;
                
                html += `
                    <div style="margin-top: 1rem;">
                        <button class="btn" onclick="submitScore()" style="background: #4CAF50; width: 100%;">游닋 Odeslat sk칩re</button>
                    </div>
                    <button class="btn" onclick="showScoreInfo()" style="width: 100%; margin-top: 0.5rem; background: #2196f3;">좶잺 Jak se po캜칤t치 sk칩re?</button>
                    <button class="btn" onclick="showHallOfFame()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #ffd700, #ff9800);">游끹勇 S칤켿 sl치vy</button>
                    <p style="text-align: center; color: #888; font-size: 0.8rem; margin-top: 0.5rem;">Jm칠no: <strong style="color: #ffd700;">${getPlayerName()}</strong></p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zav콏칤t</button>
                `;
                
                showModal('游끥 콯eb콏칤캜ek p콏e쬴v코칤ch', html);
                
            } catch (e) {
                console.error('Chyba p콏i na캜칤t치n칤 쬰b콏칤캜ku:', e);
                showModal('游끥 콯eb콏칤캜ek', `
                    <div style="text-align: center; color: #ff6b6b;">
                        <p>Chyba p콏i na캜칤t치n칤 쬰b콏칤캜ku</p>
                        <p style="font-size: 0.8rem; color: #888;">${e.message}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
            }
        }
        
        // Zobrazen칤 info o v칳po캜tu sk칩re
        function showScoreInfo() {
            // Aktu치ln칤 hodnoty hr치캜e
            const level = state.char?.level || 1;
            const kills = state.stats?.kills || 0;
            const daysAlive = state.time?.days || 0;
            const itemsCrafted = state.stats?.itemsCrafted || 0;
            const money = getMoney() || 0;
            const booksRead = state.readBooks?.length || 0;
            const dungeonsCleared = state.stats?.dungeonsCleared || (state.dungeon?.cleared ? Object.keys(state.dungeon.cleared).length : 0);
            const settlers = state.settlement?.settlers?.length || 0;
            const pvpWins = state.stats?.pvpWins || 0;
            
            // V칳po캜et bod콢 za ka쬯ou kategorii
            const scoreBreakdown = [
                { name: 'Level', value: level, multiplier: 1000, points: level * 1000, icon: '救' },
                { name: 'Zabit칤', value: kills, multiplier: 10, points: kills * 10, icon: '游' },
                { name: 'Dny p콏e쬴t칤', value: daysAlive, multiplier: 50, points: daysAlive * 50, icon: '游늰' },
                { name: 'Crafting', value: itemsCrafted, multiplier: 5, points: itemsCrafted * 5, icon: '游댣' },
                { name: 'Pen칤ze', value: money, multiplier: 1, points: money, icon: '游눯' },
                { name: 'Knihy', value: booksRead, multiplier: 200, points: booksRead * 200, icon: '游닄' },
                { name: 'Dungeony', value: dungeonsCleared, multiplier: 300, points: dungeonsCleared * 300, icon: '游낋' },
                { name: 'Osadn칤ci', value: settlers, multiplier: 100, points: settlers * 100, icon: '游논' },
                { name: 'PvP v칳hry', value: pvpWins, multiplier: 250, points: pvpWins * 250, icon: '丘덢잺' }
            ];
            
            const totalScore = scoreBreakdown.reduce((sum, item) => sum + item.points, 0);
            
            let html = `
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; border: 2px solid #ffd700;">
                    <div style="color: #888; font-size: 0.85rem;">Tvoje celkov칠 sk칩re</div>
                    <div style="color: #ffd700; font-size: 2rem; font-weight: bold;">${totalScore.toLocaleString()}</div>
                </div>
                
                <h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">游늵 Rozpis bod콢:</h4>
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            `;
            
            scoreBreakdown.forEach(item => {
                const percentage = totalScore > 0 ? Math.round((item.points / totalScore) * 100) : 0;
                html += `
                    <div style="display: grid; grid-template-columns: 30px 1fr auto; gap: 0.5rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem; align-items: center;">
                        <span style="font-size: 1.2rem;">${item.icon}</span>
                        <div>
                            <div style="color: #fff; font-size: 0.9rem;">${item.name}</div>
                            <div style="font-size: 0.7rem; color: #666;">${item.value} 칑 ${item.multiplier}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #ffd700; font-weight: bold;">+${item.points.toLocaleString()}</div>
                            <div style="font-size: 0.65rem; color: #888;">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 0.9rem;">游눠 Tipy pro zv칳코en칤 sk칩re:</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; color: #888; font-size: 0.8rem; line-height: 1.6;">
                        <li><strong style="color: #ffd700;">Level</strong> d치v치 nejv칤c bod콢 (1000/lvl)</li>
                        <li>Vy캜isti <strong style="color: #9c27b0;">dungeony</strong> (300 bod콢)</li>
                        <li>Vyhraj <strong style="color: #f44336;">PvP</strong> souboje (250 bod콢)</li>
                        <li>캛ti <strong style="color: #2196f3;">knihy</strong> (200 bod콢)</li>
                        <li>Z칤sk치vej <strong style="color: #ffd700;">pen칤ze</strong> (1 bod za 1游눯)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="showLeaderboard()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t na 쬰b콏칤캜ek</button>
            `;
            
            showModal('좶잺 V칳po캜et sk칩re', html);
        }
        
        // === PROFIL HR츼캛E ===
        
        // Helper funkce pro vol치n칤 z leaderboardu
        function showPlayerProfileByName(playerName, isOnline) {
            const playerData = window._leaderboardPlayers?.[playerName] || {};
            showPlayerProfile(playerName, playerData, isOnline);
        }
        
        async function showPlayerProfile(playerName, playerData, isOnline) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const isFriend = friendsList.includes(playerName);
            
            // Z칤skej hodnocen칤 hr치캜e
            let rating = { avg: 0, count: 0 };
            try {
                rating = await getSellerRating(playerName);
            } catch (e) {}
            
            // Z칤skej PvP stats z playerData (je tam u z leaderboardu)
            const pvpElo = playerData?.pvpElo || 1000;
            const pvpWins = playerData?.pvpWins || 0;
            const pvpLosses = playerData?.pvpLosses || 0;
            const pvpRank = getPvPRank(pvpElo);
            const totalGames = pvpWins + pvpLosses;
            const winRate = totalGames > 0 ? Math.round((pvpWins / totalGames) * 100) : 0;
            
            // Class info
            const classNames = {
                survivor: 'P콏e쬴v코칤', raider: 'N치jezdn칤k', scout: 'Zv캩d', 
                medic: 'Medik', technician: 'Technik', mutant: 'Mutant'
            };
            const className = classNames[playerData?.classId] || 'P콏e쬴v코칤';
            
            let html = `
                <!-- HEADER KARTA -->
                <div style="background: linear-gradient(135deg, ${pvpRank.color}22 0%, #0a0a0a 100%); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid ${pvpRank.color}44; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <div style="font-size: 2.5rem; filter: drop-shadow(0 0 8px ${pvpRank.color});">${pvpRank.icon}</div>
                        <div>
                            <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${escapeHtml(playerName)}</div>
                            <div style="color: ${pvpRank.color}; font-size: 0.8rem; text-transform: uppercase;">${pvpRank.name}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; font-size: 0.85rem;">
                        <span style="color: ${isOnline ? '#4CAF50' : '#666'};">${isOnline ? '游릭 Online' : '丘 Offline'}</span>
                        <span style="color: #888;"></span>
                        <span style="color: #888;">Lvl <span style="color: #ffd700; font-weight: bold;">${playerData?.level || '?'}</span></span>
                        <span style="color: #888;"></span>
                        <span style="color: #888;">${className}</span>
                    </div>
                </div>
                
                <!-- STATISTIKY - 2 콎츼DKY -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-bottom: 1rem;">
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">丘덢잺</div>
                        <div style="color: #ff6b6b; font-size: 1rem; font-weight: bold;">${playerData?.kills || 0}</div>
                        <div style="color: #555; font-size: 0.65rem;">Zabit칤</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">游닆</div>
                        <div style="color: #8bc34a; font-size: 1rem; font-weight: bold;">${playerData?.quests || 0}</div>
                        <div style="color: #555; font-size: 0.65rem;">Questy</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">游늰</div>
                        <div style="color: #2196f3; font-size: 1rem; font-weight: bold;">${playerData?.days || 0}</div>
                        <div style="color: #555; font-size: 0.65rem;">Dn칤</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">游끥</div>
                        <div style="color: #ffd700; font-size: 1rem; font-weight: bold;">${(playerData?.score || 0).toLocaleString()}</div>
                        <div style="color: #555; font-size: 0.65rem;">Sk칩re</div>
                    </div>
                </div>
                
                <!-- PVP STATS -->
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #0a0a1a 100%); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem; border: 1px solid #333;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">游꿡</span>
                            <span style="color: #888; font-size: 0.85rem;">PvP</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="text-align: center;">
                                <div style="color: ${pvpRank.color}; font-size: 1.1rem; font-weight: bold;">${pvpElo}</div>
                                <div style="color: #555; font-size: 0.6rem;">ELO</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #4CAF50; font-weight: bold;">${pvpWins}<span style="color: #666;">W</span></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #f44336; font-weight: bold;">${pvpLosses}<span style="color: #666;">L</span></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #ffd700; font-weight: bold;">${winRate}%</div>
                                <div style="color: #555; font-size: 0.6rem;">Win</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- HODNOCEN칈 OBCHODN칈KA -->
                ${rating.count > 0 ? `
                <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <span style="color: #888; font-size: 0.85rem;">游낅 Hodnocen칤</span>
                    <div>
                        <span style="color: #ffd700;">${'驕'.repeat(Math.round(rating.avg))}${'驕'.repeat(5 - Math.round(rating.avg))}</span>
                        <span style="color: #666; font-size: 0.8rem;">(${rating.count})</span>
                    </div>
                </div>
                ` : ''}
                
                <!-- AKCE -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">`
            
            // Tla캜칤tko zpr치vy - pro v코echny
            html += `
                <button class="btn" onclick="showPrivateChat('${escapeHtml(playerName)}')" style="background: #2196f3; padding: 0.8rem;">
                    游눫 Zpr치va
                </button>
            `;
            
            // Tla캜칤tko p콏치telstv칤
            if (isFriend) {
                html += `
                    <button class="btn" onclick="sendGift('${escapeHtml(playerName)}')" style="background: #ff9800; padding: 0.8rem;">
                        游꾸 D치rek
                    </button>
                `;
            } else {
                html += `
                    <button class="btn" onclick="sendFriendRequest('${escapeHtml(playerName)}'); closeModal();" style="background: #4CAF50; padding: 0.8rem;">
                        游논 P콏idat p콏칤tele
                    </button>
                `;
            }
            
            // Tla캜칤tko PvP v칳zvy - pro online hr치캜e
            if (isOnline && playerName !== myName) {
                html += `
                    <button class="btn" onclick="quickChallenge('${escapeHtml(playerName).replace(/'/g, "\\'")}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 0.8rem; grid-column: span 2;">
                        丘덢잺 Vyzvat na PvP souboj
                    </button>
                `;
            } else if (!isOnline && playerName !== myName) {
                html += `
                    <button class="btn" disabled style="background: #333; padding: 0.8rem; grid-column: span 2; opacity: 0.5;">
                        丘덢잺 Hr치캜 je offline
                    </button>
                `;
            }
            
            // Admin tla캜칤tko pro odm캩nu
            if (isAdmin()) {
                html += `
                    <button class="btn" onclick="showQuickReward('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.8rem;">
                        游꾸 Odm캩na
                    </button>
                    <button class="btn" onclick="adminQuickMute('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 0.8rem;">
                        游댆 Mute
                    </button>
                    <button class="btn" onclick="adminQuickBan('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 0.8rem; grid-column: span 2;">
                        游뛂 Banovat
                    </button>
                `;
            }
            
            html += `
                </div>
                
                <button class="btn" onclick="showLeaderboard()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t na 쬰b콏칤캜ek</button>
            `;
            
            showModal(`游녻 Profil: ${escapeHtml(playerName)}`, html);
        }
        
        // Rychl치 v칳zva na PvP z profilu
        function quickChallenge(playerName) {
            closeModal();
            showModal('丘덢잺 Vyzvat ' + escapeHtml(playerName), `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">丘덢잺</div>
                    <p style="color: #fff; font-size: 1.1rem; margin-bottom: 0.5rem;">Vyzvat <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong> na PvP souboj?</p>
                    <p style="color: #4CAF50; font-size: 0.9rem;">PvP souboj je ZDARMA!</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showLeaderboard()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="createPvPChallenge('${escapeHtml(playerName).replace(/'/g, "\\'")}', 0); closeModal();" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">丘덢잺 Vyzvat!</button>
                </div>
            `);
        }
        
        // === CHAT SYST칄M ===
        function listenToChat() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            chatListener = firebaseDB.ref('chat/messages')
                .orderByChild('timestamp')
                .limitToLast(100)
                .on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    chatMessages = Object.values(data).sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Zkontroluj nov칠 zpr치vy pro notifikaci
                    checkNewChatMessages();
                });
        }
        
        // === CHAT HODNOSTI (podle po캜tu odeslan칳ch zpr치v) ===
        const CHAT_RANKS = [
            { min: 0, name: 'Tich칳', nameEn: 'Silent', icon: '游댆', color: '#666' },
            { min: 1, name: 'Nov치캜ek', nameEn: 'Newbie', icon: '游꺔', color: '#8bc34a' },
            { min: 10, name: 'Pov칤d치lek', nameEn: 'Talker', icon: '游눫', color: '#4caf50' },
            { min: 25, name: 'Spole캜n칤k', nameEn: 'Companion', icon: '游뱋', color: '#2196f3' },
            { min: 50, name: 'Veter치n', nameEn: 'Veteran', icon: '救', color: '#ff9800' },
            { min: 100, name: 'Legenda', nameEn: 'Legend', icon: '游녬', color: '#ffd700' },
            { min: 250, name: 'Hlas pustiny', nameEn: 'Voice of Wasteland', icon: '游닉', color: '#e91e63' },
            { min: 500, name: 'Ikona', nameEn: 'Icon', icon: '游끥', color: '#9c27b0' },
            { min: 1000, name: 'Nesmrteln칳', nameEn: 'Immortal', icon: '游눑', color: '#00bcd4' }
        ];
        
        function getChatRank(messageCount) {
            let rank = CHAT_RANKS[0];
            for (const r of CHAT_RANKS) {
                if (messageCount >= r.min) rank = r;
            }
            return rank;
        }
        
        function getChatRankDisplay(messageCount) {
            const rank = getChatRank(messageCount);
            const name = rank.name;
            return `<span style="color: ${rank.color};">${rank.icon} ${name}</span>`;
        }
        
        async function sendChatMessage(text) {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (!text || !text.trim()) return;
            
            // Kontrola mute
            const playerName = getPlayerName();
            try {
                const muteSnap = await firebaseDB.ref('mutedPlayers/' + playerName).once('value');
                const muteData = muteSnap.val();
                if (muteData) {
                    // Zkontroluj jestli mute nevypr코el
                    if (muteData.until === 0 || muteData.until > Date.now()) {
                        const untilText = muteData.until ? new Date(muteData.until).toLocaleString('cs') : 'nav쬯y';
                        notifyWarning('游댆 Jsi ztlumen', `Nem콢쬰코 ps치t do chatu do: ${untilText}`);
                        return;
                    } else {
                        // Mute vypr코el, odeber ho
                        await firebaseDB.ref('mutedPlayers/' + playerName).remove();
                    }
                }
            } catch(e) {}
            
            // Rate limiting - max 1 zpr치va za 2 sekundy
            if (!RateLimiter.canProceed('chat_message', 2000)) {
                const remaining = Math.ceil(RateLimiter.getRemaining('chat_message', 2000) / 1000);
                notifyWarning('P콏칤li코 rychle', `Po캜kej ${remaining}s p콏ed dal코칤 zpr치vou`);
                return;
            }
            
            // Sanitizace textu
            const sanitizedText = escapeHtml(text.trim().substring(0, 200));
            if (!sanitizedText) return;
            
            // Inkrementuj po캜et odeslan칳ch zpr치v
            state.stats = state.stats || {};
            state.stats.chatMessagesSent = (state.stats.chatMessagesSent || 0) + 1;
            
            const rank = getChatRank(state.stats.chatMessagesSent);
            const rankName = rank.name;
            
            const message = {
                author: getPlayerName(),
                text: sanitizedText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                level: state.char?.level || 1,
                msgCount: state.stats.chatMessagesSent,
                rankName: rankName,
                rankColor: rank.color,
                faction: getPlayerFaction() || null  // P콏idej frakci do zpr치vy
            };
            
            try {
                await firebaseDB.ref('chat/messages').push(message);
                
                // Aktualizuj frak캜n칤 aktivitu
                updateFactionActivity();
                
                // Ozn치men칤 o nov칠 hodnosti
                const prevRank = getChatRank(state.stats.chatMessagesSent - 1);
                if (rank.min > prevRank.min) {
                    notifySuccess('游꿀 Nov치 chat hodnost!', `${rank.icon} ${rankName}`);
                    addLog(`${rank.icon} Dos치hl jsi chat hodnosti: ${rankName}`, '游눫');
                }
            } catch (e) {
                console.error('Chyba p콏i odes칤l치n칤 zpr치v:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se odeslat zpr치vu');
                // Vra콘 zp캩t po캜칤tadlo
                state.stats.chatMessagesSent = Math.max(0, (state.stats.chatMessagesSent || 1) - 1);
            }
        }
        
        // Menu po kliknut칤 na hr치캜e v chatu
        function showChatPlayerMenu(playerName, event) {
            if (event) event.stopPropagation();
            
            const myName = getPlayerName();
            if (playerName === myName) return;
            
            const isFriend = friendsList.includes(playerName);
            
            // Vytvo콏 popup menu
            const existingMenu = document.getElementById('chatPlayerMenu');
            if (existingMenu) existingMenu.remove();
            
            const menu = document.createElement('div');
            menu.id = 'chatPlayerMenu';
            menu.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #2a2a3a, #1a1a2a);
                border: 2px solid #9c27b0;
                border-radius: 12px;
                padding: 1rem;
                z-index: 10001;
                min-width: 200px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            `;
            
            menu.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">游녻</div>
                    <div style="color: #fff; font-weight: bold; font-size: 1.1rem;">${escapeHtml(playerName)}</div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="closeChatPlayerMenu(); replyToPlayer('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: #ff9800; padding: 0.6rem;">
                        뾆잺 Odpov캩d캩t v chatu
                    </button>
                    
                    <button class="btn" onclick="closeChatPlayerMenu(); showPrivateChat('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: #e91e63; padding: 0.6rem;">
                        游눫 Soukrom치 zpr치va
                    </button>
                    
                    <button class="btn" onclick="closeChatPlayerMenu(); showPlayerProfileByName('${escapeHtml(playerName).replace(/'/g, "\\'")}', false);" style="background: #2196f3; padding: 0.6rem;">
                        游녻 Zobrazit profil
                    </button>
                    
                    <button class="btn" onclick="closeChatPlayerMenu(); quickChallenge('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 0.6rem;">
                        丘덢잺 Vyzvat na PvP
                    </button>
                    
                    ${!isFriend ? `
                        <button class="btn" onclick="closeChatPlayerMenu(); sendFriendRequest('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: #4CAF50; padding: 0.6rem;">
                            游논 P콏idat do p콏치tel
                        </button>
                    ` : `
                        <div style="text-align: center; color: #8bc34a; font-size: 0.85rem; padding: 0.5rem;">
                            九 Ji v p콏치tel칤ch
                        </div>
                    `}
                    
                    ${hasPermission('mute') ? `
                        <button class="btn" onclick="closeChatPlayerMenu(); adminQuickMute('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 0.6rem;">
                            游댆 Mute (Staff)
                        </button>
                    ` : ''}
                    
                    ${isAdmin() ? `
                        <div style="border-top: 1px solid #f44336; margin-top: 0.5rem; padding-top: 0.5rem;">
                            <div style="color: #f44336; font-size: 0.7rem; text-align: center; margin-bottom: 0.3rem;">游녬 ADMIN</div>
                        </div>
                        <button class="btn" onclick="closeChatPlayerMenu(); showQuickReward('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.6rem;">
                            游꾸 D치t odm캩nu
                        </button>
                        <button class="btn" onclick="closeChatPlayerMenu(); showQuickVIPColor('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.6rem;">
                            游꿛 Zm캩nit barvu
                        </button>
                        <button class="btn" onclick="closeChatPlayerMenu(); quickAddToStaff('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 0.6rem;">
                            游논 P콏idat do Staff
                        </button>
                        <button class="btn" onclick="closeChatPlayerMenu(); adminQuickBan('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #b71c1c 0%, #7f0000 100%); padding: 0.6rem;">
                            游뛂 Ban
                        </button>
                    ` : ''}
                    
                    <button class="btn" onclick="closeChatPlayerMenu();" style="background: #555; padding: 0.5rem; font-size: 0.9rem;">
                        九 Zav콏칤t
                    </button>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Zav콏i menu kliknut칤m mimo
            setTimeout(() => {
                document.addEventListener('click', closeChatPlayerMenuOnClickOutside);
            }, 100);
        }
        
        function closeChatPlayerMenu() {
            const menu = document.getElementById('chatPlayerMenu');
            if (menu) menu.remove();
            document.removeEventListener('click', closeChatPlayerMenuOnClickOutside);
        }
        
        function closeChatPlayerMenuOnClickOutside(e) {
            const menu = document.getElementById('chatPlayerMenu');
            if (menu && !menu.contains(e.target)) {
                closeChatPlayerMenu();
            }
        }
        
        function replyToPlayer(playerName) {
            // Najdi chat input a vlo @nick
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = `@${playerName} ` + chatInput.value;
                chatInput.focus();
                // Nastav kurzor na konec
                chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
            }
        }
        
        // Form치tov치n칤 chat zpr치vy - barevn칠 @nicky
        function formatChatMessage(text, myName) {
            if (!text) return '';
            
            // Nejd콏칤v escapuj HTML
            let formatted = escapeHtml(text);
            
            // Najdi v코echny @nicky a obarvi je
            // Regex pro @nick (slovo za캜칤naj칤c칤 @)
            formatted = formatted.replace(/@(\w+)/g, (match, nick) => {
                // Pokud je to m콢j nick, zv칳razni zelen캩
                if (nick.toLowerCase() === myName.toLowerCase()) {
                    return `<span style="color: #4CAF50; font-weight: bold; background: rgba(76,175,80,0.2); padding: 0 3px; border-radius: 3px;">@${nick}</span>`;
                }
                // Ostatn칤 nicky mod콏e
                return `<span style="color: #2196f3; font-weight: bold;">@${nick}</span>`;
            });
            
            return formatted;
        }

        function showChatModal() {
            if (!multiplayerEnabled) {
                showModal('游눫 Chat', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游댋</div>
                        <h3 style="color: #ff9800;">Multiplayer nen칤 aktivn칤</h3>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Moje statistiky
            const myMsgCount = state.stats.chatMessagesSent || 0;
            const myRank = getChatRank(myMsgCount);
            const myRankName = myRank.name;
            const nextRank = CHAT_RANKS.find(r => r.min > myMsgCount);
            const progressToNext = nextRank ? Math.min(100, ((myMsgCount - myRank.min) / (nextRank.min - myRank.min)) * 100) : 100;
            
            let messagesHtml = '';
            const myName = getPlayerName();
            
            if (chatMessages.length === 0) {
                messagesHtml = '<div style="text-align: center; padding: 2rem; color: #666;">콯치dn칠 zpr치vy... Bu캞 prvn칤!</div>';
            } else {
                chatMessages.slice(-50).forEach(msg => {
                    const isMe = msg.author === myName;
                    const isAdmin = msg.author === 'Zaoo';
                    const staffRole = getStaffRole(msg.author);
                    const staffRoleData = staffRole ? STAFF_ROLES[staffRole] : null;
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}) : '';
                    const msgRankName = msg.rankName || 'Tich칳';
                    const msgRankColor = msg.rankColor || '#666';
                    
                    // VIP barva
                    const vipColor = getVIPColor(msg.author);
                    const isRainbow = vipColor === 'rainbow';
                    const authorColor = isMe ? '#8bc34a' : staffRoleData ? staffRoleData.color : vipColor || '#aaa';
                    const rainbowStyle = isRainbow ? 'background: linear-gradient(90deg, #ff0000, #ff9800, #ffff00, #00ff00, #00bcd4, #9c27b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;' : '';
                    
                    // Staff badge (Admin/Mod/Helper)
                    const staffBadge = staffRoleData ? `<span style="background: ${staffRoleData.color}; color: #fff; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem; margin-left: 0.3rem;">${staffRoleData.badge}</span>` : '';
                    
                    // VIP badge (pouze pokud nen칤 staff)
                    const vipBadge = (vipColor && !staffRole) ? '<span style="background: linear-gradient(135deg, #ff9800, #f57c00); color: #fff; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem; margin-left: 0.3rem;">救 VIP</span>' : '';
                    
                    // Frakce v z치vorce p콏ed nickem
                    let factionPrefix = '';
                    if (msg.faction && PVP_FACTIONS[msg.faction]) {
                        const f = PVP_FACTIONS[msg.faction];
                        const factionShort = msg.faction === 'kory' ? 'Koryho frakce' : msg.faction === 'koudy' ? 'Koudyho frakce' : 'Nez치visl치 frakce';
                        factionPrefix = `<span style="color: ${f.color}; font-size: 0.65rem;">[${factionShort}]</span> `;
                    }
                    
                    // Syst칠mov칠 zpr치vy (tombola, war zone apod.)
                    const isSystemMessage = msg.system || 
                        msg.author === '游勇 TOMBOLA' || 
                        msg.author === '游꿀 TOMBOLA' ||
                        msg.author === '丘덢잺 WAR ZONE' ||
                        msg.author === '丘덢잺 V츼LE캛N츼 Z칍NA' ||
                        msg.author?.includes('SYST칄M');
                    
                    // Klikateln칠 jm칠no pro menu, cel치 zpr치va pro rychlou odpov캩캞
                    let authorHtml;
                    if (isMe) {
                        authorHtml = `${factionPrefix}<span style="color: #8bc34a; font-weight: bold;">驕 Ty</span>${staffBadge}`;
                    } else if (isSystemMessage) {
                        // Syst칠mov치 zpr치va - klik podle typu
                        const isWarZone = msg.author?.includes('WAR') || msg.author?.includes('V츼LE캛N츼');
                        const clickAction = isWarZone ? 'showFactionTab()' : 'showTombola()';
                        const msgColor = isWarZone ? '#f44336' : '#e91e63';
                        authorHtml = `<span onclick="event.stopPropagation(); ${clickAction};" style="color: ${msgColor}; font-weight: bold; cursor: pointer; text-decoration: underline;">${escapeHtml(msg.author)}</span>`;
                    } else {
                        authorHtml = `${factionPrefix}<span onclick="event.stopPropagation(); showChatPlayerMenu('${escapeHtml(msg.author).replace(/'/g, "\\'")}', event)" style="color: ${isRainbow ? '#ff0000' : authorColor}; ${rainbowStyle} font-weight: bold; cursor: pointer; text-decoration: underline; text-decoration-style: dotted;">${escapeHtml(msg.author)}</span>${staffBadge}${vipBadge}`;
                    }
                    
                    // Kliknut칤 na zpr치vu (ne na jm칠no) = rychl치 odpov캩캞 (ne pro syst칠mov칠 zpr치vy)
                    const messageClickHandler = (isMe || isSystemMessage) ? '' : `onclick="replyToPlayer('${escapeHtml(msg.author).replace(/'/g, "\\'")}')" style="cursor: pointer;" title="Klikni pro odpov캩캞"`;
                    
                    // Barva syst칠mov칠 zpr치vy podle typu
                    const isWarZoneMsg = msg.author?.includes('WAR') || msg.author?.includes('V츼LE캛N츼');
                    const systemMsgColor = isWarZoneMsg ? '#f44336' : '#e91e63';
                    const systemBgColor = isWarZoneMsg ? '#2a1515' : '#2a1a2a';
                    const systemBorderColor = isWarZoneMsg ? '#f44336' : '#e91e63';
                    
                    messagesHtml += `
                        <div style="margin-bottom: 0.5rem; ${isMe ? 'text-align: right;' : ''}">
                            <div ${messageClickHandler} style="display: inline-block; max-width: 80%; background: ${isMe ? '#1a3a1a' : isSystemMessage ? systemBgColor : staffRole ? '#2a1a1a' : '#2a2a2a'}; padding: 0.5rem 0.8rem; border-radius: 12px; ${isMe ? 'border-bottom-right-radius: 4px;' : 'border-bottom-left-radius: 4px;'} ${isSystemMessage ? `border: 1px solid ${systemBorderColor};` : staffRole ? `border: 1px solid ${staffRoleData.color};` : ''} ${!isMe && !isSystemMessage ? 'cursor: pointer; transition: background 0.2s;' : ''}" ${!isMe && !isSystemMessage ? `onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='${staffRole ? '#2a1a1a' : '#2a2a2a'}'"` : ''}>
                                <div style="font-size: 0.7rem; margin-bottom: 0.2rem;">
                                    ${authorHtml}
                                    ${!isSystemMessage ? `<span style="color: ${msgRankColor}; font-size: 0.65rem; margin-left: 0.3rem;">[${msgRankName}]</span>
                                    <span style="color: #555; font-size: 0.65rem;"> Lvl ${escapeHtml(msg.level) || '?'}</span>` : ''}
                                    <span style="color: #444; margin-left: 0.5rem;">${time}</span>
                                </div>
                                <div style="color: ${isSystemMessage ? systemMsgColor : '#ddd'};">${formatChatMessage(msg.text, myName)}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            showModal('游눫 Chat p콏e쬴v코칤ch', `
                <!-- Moje hodnost -->
                <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 0.6rem; border-radius: 8px; margin-bottom: 0.8rem; border: 1px solid ${myRank.color}40;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: ${myRank.color}; font-size: 1.2rem;">${myRank.icon}</span>
                            <span style="color: ${myRank.color}; font-weight: bold;">${myRankName}</span>
                            <span style="color: #666; font-size: 0.75rem; margin-left: 0.5rem;">(${myMsgCount} ${'zpr치v'})</span>
                        </div>
                        ${nextRank ? `<span style="color: #555; font-size: 0.7rem;">${'Dal코칤'}: ${nextRank.icon} ${nextRank.min - myMsgCount}</span>` : '<span style="color: #ffd700; font-size: 0.7rem;">MAX!</span>'}
                    </div>
                    ${nextRank ? `<div style="background: #0a0a0a; height: 4px; border-radius: 2px; margin-top: 0.4rem; overflow: hidden;">
                        <div style="height: 100%; width: ${progressToNext}%; background: ${myRank.color};"></div>
                    </div>` : ''}
                </div>
                
                <div style="position: relative;">
                    <div id="chatMessagesContainer" style="max-height: 45vh; min-height: 200px; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; touch-action: pan-y pinch-zoom; background: #0a0a0a; border-radius: 8px; padding: 0.8rem; position: relative;">
                        ${messagesHtml}
                    </div>
                    
                    <!-- Scroll tla캜칤tka pro mobil -->
                    <div style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 0.3rem; z-index: 10;">
                        <button onclick="document.getElementById('chatMessagesContainer').scrollTop -= 150;" 
                            style="width: 44px; height: 44px; border-radius: 50%; background: rgba(76, 175, 80, 0.9); border: none; color: white; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            郊
                        </button>
                        <button onclick="document.getElementById('chatMessagesContainer').scrollTop += 150;" 
                            style="width: 44px; height: 44px; border-radius: 50%; background: rgba(76, 175, 80, 0.9); border: none; color: white; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            郊
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <input type="text" id="chatInput" placeholder="${'Napi코 zpr치vu...'}" maxlength="200"
                        style="flex: 1; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff;"
                        onkeypress="if(event.key==='Enter') sendChatFromInput()">
                    <button class="btn" onclick="sendChatFromInput()" style="background: #4CAF50; padding: 0.6rem 1rem;">游닋</button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${'Zav콏칤t'}</button>
            `);
            
            // Scrollni dol콢 a nastav touch handler
            setTimeout(() => {
                const container = document.getElementById('chatMessagesContainer');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                    
                    // Zabra켿 pull-to-refresh p콏i scrollov치n칤 v chatu
                    container.addEventListener('touchstart', function(e) {
                        this._startY = e.touches[0].pageY;
                        this._startScrollTop = this.scrollTop;
                    }, { passive: true });
                    
                    container.addEventListener('touchmove', function(e) {
                        const scrollTop = this.scrollTop;
                        const scrollHeight = this.scrollHeight;
                        const clientHeight = this.clientHeight;
                        const deltaY = e.touches[0].pageY - this._startY;
                        
                        // Pokud jsme na vrchu a t치hneme dol콢 (pull-to-refresh gesto)
                        if (scrollTop <= 0 && deltaY > 0) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                        // Pokud jsme na spodu a t치hneme nahoru
                        else if (scrollTop + clientHeight >= scrollHeight && deltaY < 0) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }, { passive: false });
                }
            }, 100);
        }
        
        function sendChatFromInput() {
            const input = document.getElementById('chatInput');
            if (input && input.value.trim()) {
                sendChatMessage(input.value.trim());
                input.value = '';
                // Obnov chat po chv칤li
                setTimeout(() => showChatModal(), 500);
            }
        }
        
        // === MARKETPLACE (Obchod mezi hr치캜i) ===
        function listenToMarketplace() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            firebaseDB.ref('marketplace/offers').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                marketplaceOffers = Object.entries(data).map(([key, val]) => ({...val, id: key}));
                
                // Kontrola expirovan칳ch nab칤dek (3 dny = 72 hodin)
                checkExpiredOffers();
            });
        }
        
        // Kontrola a sta쬰n칤 nab칤dek star코칤ch ne 3 dny
        async function checkExpiredOffers() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const now = Date.now();
            const maxAge = 3 * 24 * 60 * 60 * 1000; // 3 dny v ms
            
            for (const offer of marketplaceOffers) {
                // Kontroluj jen vlastn칤 nab칤dky
                if (offer.seller !== myName) continue;
                if (offer.status !== 'active') continue;
                
                const offerAge = now - (offer.timestamp || 0);
                
                if (offerAge > maxAge) {
                    console.log('游닍 Stahov치n칤 expirovan칠 nab칤dky:', offer.item?.name);
                    
                    try {
                        // Vra콘 item do invent치콏e
                        const itemData = offer.item;
                        if (itemData) {
                            // Rekonstruuj item pro invent치콏
                            const returnedItem = {
                                id: itemData.id,
                                name: itemData.name,
                                icon: itemData.icon,
                                type: itemData.type
                            };
                            if (itemData.damage) returnedItem.damage = itemData.damage;
                            if (itemData.defense) returnedItem.defense = itemData.defense;
                            if (itemData.rarity) returnedItem.rarity = itemData.rarity;
                            if (itemData.effect) returnedItem.effect = itemData.effect;
                            if (itemData.value) returnedItem.value = itemData.value;
                            if (itemData.weight) returnedItem.weight = itemData.weight;
                            
                            // Najdi kompletn칤 definici itemu
                            const fullItem = ITEMS.find(i => i.id === itemData.id) || returnedItem;
                            const count = offer.count || 1;
                            
                            addItemToInventory({...fullItem, ...returnedItem}, count, true);
                            
                            // Sma nab칤dku z Firebase
                            await firebaseDB.ref('marketplace/offers/' + offer.id).remove();
                            
                            notifySuccess('游닍 Nab칤dka sta쬰na', `${itemData.name} (${count}x) vr치cen do invent치콏e - uplynuly 3 dny`);
                            
                            // Ulo hru
                            saveGame(true);
                        }
                    } catch (e) {
                        console.error('Chyba p콏i stahov치n칤 nab칤dky:', e);
                    }
                }
            }
        }
        
        async function createMarketOffer(item, price) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Vyfiltruj v코echny undefined hodnoty pro Firebase
            // Firebase validace vy쬬duje damage a defense - p콏idej defaulty
            const cleanItem = {
                id: item.id || 'unknown',
                name: item.name || 'P콏edm캩t',
                icon: item.icon || '游닍',
                type: item.type || 'misc',
                damage: typeof item.damage === 'number' ? item.damage : 0,
                defense: typeof item.defense === 'number' ? item.defense : 0
            };
            
            // P콏idej dal코칤 hodnoty pokud existuj칤
            if (item.rarity && typeof item.rarity === 'string') cleanItem.rarity = item.rarity;
            if (item.effect && typeof item.effect === 'string') cleanItem.effect = item.effect;
            if (typeof item.value === 'number') cleanItem.value = item.value;
            
            const offer = {
                seller: getPlayerName(),
                item: cleanItem,
                price: price || 100,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'active'
            };
            
            try {
                await firebaseDB.ref('marketplace/offers').push(offer);
                notifySuccess('Nab칤dka vytvo콏ena!', `${item.name} za ${price} 游눯`);
            } catch (e) {
                console.error('Chyba p콏i vytv치콏en칤 nab칤dky:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se vytvo콏it nab칤dku: ' + (e.message || 'Nezn치m치 chyba'));
            }
        }
        
        // Dialog pro n치kup s v칳b캩rem po캜tu
        function promptBuyOffer(offerId, maxCount, pricePerUnit) {
            const offer = marketplaceOffers.find(o => o.id === offerId);
            if (!offer) return;
            
            if (maxCount === 1) {
                // Pokud je jen 1 kus, kup rovnou
                buyMarketOffer(offerId, 1);
                return;
            }
            
            const maxAffordable = Math.floor(state.money / pricePerUnit);
            const maxBuyable = Math.min(maxCount, maxAffordable);
            
            showModal(`游 Koupit ${escapeHtml(offer.item.name)}`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${escapeHtml(offer.item.icon)}</div>
                    <div style="color: #888; margin-bottom: 0.5rem;">Prod치v치: ${escapeHtml(offer.seller)}</div>
                    <div style="color: #ffd700; margin-bottom: 1rem;">Cena: ${pricePerUnit} 游눯/ks</div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="color: #888; font-size: 0.85rem;">Po캜et kus콢 (max ${maxCount}, m콢쬰코 si dovolit ${maxAffordable}):</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                            <button class="btn" onclick="adjustBuyCount(-10, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">-10</button>
                            <button class="btn" onclick="adjustBuyCount(-1, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">-</button>
                            <input type="number" id="buyCountInput" value="1" min="1" max="${maxBuyable}"
                                style="width: 60px; padding: 0.5rem; font-size: 1.1rem; background: #1a1a1a; border: 2px solid #4CAF50; border-radius: 8px; color: #4CAF50; text-align: center;"
                                onchange="updateBuyTotal(${pricePerUnit})">
                            <button class="btn" onclick="adjustBuyCount(1, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">+</button>
                            <button class="btn" onclick="adjustBuyCount(10, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">+10</button>
                        </div>
                        <button class="btn" onclick="document.getElementById('buyCountInput').value=${maxBuyable}; updateBuyTotal(${pricePerUnit});" style="margin-top: 0.3rem; padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">Max (${maxBuyable})</button>
                    </div>
                    
                    <div id="buyTotalDisplay" style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                        <span style="color: #888;">Celkem:</span>
                        <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${pricePerUnit} 游눯</span>
                        <div style="color: #666; font-size: 0.8rem; margin-top: 0.3rem;">Tv칠 pen칤ze: ${state.money} 游눯</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="showMarketplace()" style="background: #555;">仇 Zru코it</button>
                        <button class="btn" onclick="buyMarketOffer('${escapeHtml(offerId)}', parseInt(document.getElementById('buyCountInput').value))" style="background: #4CAF50;">九 Koupit</button>
                    </div>
                </div>
            `);
        }
        
        function adjustBuyCount(delta, max, pricePerUnit) {
            const input = document.getElementById('buyCountInput');
            if (!input) return;
            const newVal = Math.max(1, Math.min(max, parseInt(input.value || 1) + delta));
            input.value = newVal;
            updateBuyTotal(pricePerUnit);
        }
        
        function updateBuyTotal(pricePerUnit) {
            const countInput = document.getElementById('buyCountInput');
            const display = document.getElementById('buyTotalDisplay');
            if (!countInput || !display) return;
            
            const count = parseInt(countInput.value) || 1;
            // Get price from parent scope or recalculate
            const price = pricePerUnit || parseInt(document.querySelector('[data-price]')?.dataset.price) || 0;
            const total = count * price;
            
            display.innerHTML = `
                <span style="color: #888;">${count}x ${price} = </span>
                <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${total} 游눯</span>
                <div style="color: ${state.money >= total ? '#666' : '#f44336'}; font-size: 0.8rem; margin-top: 0.3rem;">Tv칠 pen칤ze: ${state.money} 游눯 ${state.money < total ? '(nedostatek!)' : ''}</div>
            `;
        }
        
        async function buyMarketOffer(offerId, buyCount = 1) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const offer = marketplaceOffers.find(o => o.id === offerId);
            if (!offer) return;
            
            if (offer.seller === getPlayerName()) {
                notifyWarning('Nelze koupit', 'Nem콢쬰코 koupit vlastn칤 nab칤dku!');
                return;
            }
            
            // Kontrola unique item콢
            const itemDef = ITEMS.find(i => i.id === offer.item?.id);
            if (itemDef?.unique) {
                const alreadyHas = state.inv.some(i => i.id === offer.item.id);
                if (alreadyHas) {
                    notifyWarning('U m치코 ' + (offer.item.name || itemDef.name), 'M콢쬰코 m칤t pouze jeden');
                    return;
                }
            }
            
            const offerCount = offer.count || 1;
            const actualBuyCount = Math.min(buyCount, offerCount);
            const totalPrice = offer.price * actualBuyCount;
            
            // 游눯 POPLATEK Z PRODEJE - 5% jde jako da켿
            const MARKET_FEE_PERCENT = 5;
            const marketFee = Math.max(1, Math.floor(totalPrice * MARKET_FEE_PERCENT / 100));
            const sellerReceives = totalPrice - marketFee;
            
            if (getMoney() < totalPrice) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot콏ebuje코 ${totalPrice} 游눯`);
                return;
            }
            
            try {
                const remainingCount = offerCount - actualBuyCount;
                
                if (remainingCount <= 0) {
                    // Koupeno v코e - ozna캜 jako prodan칠
                    await firebaseDB.ref('marketplace/offers/' + offerId).update({
                        status: 'sold',
                        buyer: getPlayerName(),
                        soldAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // Zb칳v치 n캩co - aktualizuj po캜et
                    await firebaseDB.ref('marketplace/offers/' + offerId).update({
                        count: remainingCount,
                        totalPrice: offer.price * remainingCount,
                        'item/count': remainingCount
                    });
                }
                
                // Ode캜ti pen칤ze KUPUJ칈C칈MU (spr치vn캩 p콏es funkci)
                removeMoney(totalPrice);
                
                // P콏idej item do invent치콏e - pou쬴j actualBuyCount jako druh칳 parametr
                const newItem = {
                    ...offer.item
                };
                // OPRAVA: Pou쬴j actualBuyCount jako druh칳 parametr pro spr치vn칳 po캜et
                addItemToInventory(newItem, actualBuyCount, true);
                
                // Ozn치men칤 prodejci + P콎I캛TEN칈 PEN캨Z (PO ODE캛TEN칈 POPLATKU)
                // Ulo쮂셠e pen칤ze pro prodejce do Firebase - ten si je vyzvedne p콏i kontrole notifikac칤
                const sellerPathKey = sanitizeFirebasePath(offer.seller);
                await firebaseDB.ref('marketplace/notifications/' + sellerPathKey).push({
                    type: 'sold',
                    item: offer.item.name,
                    count: actualBuyCount,
                    price: totalPrice,
                    fee: marketFee,
                    received: sellerReceives,
                    buyer: getPlayerName(),
                    moneyToAdd: sellerReceives,  // Pen칤ze k p콏i캜ten칤 prodejci (PO POPLATKU)
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Z치znam do historie obchod콢 - kupuj칤c칤
                const buyerPathKey = sanitizeFirebasePath(getPlayerName());
                await firebaseDB.ref('tradeHistory/' + buyerPathKey).push({
                    type: 'buy',
                    itemName: offer.item.name,
                    itemIcon: offer.item.icon,
                    count: actualBuyCount,
                    price: totalPrice,
                    otherPlayer: offer.seller,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Z치znam do historie obchod콢 - prodejce
                await firebaseDB.ref('tradeHistory/' + sellerPathKey).push({
                    type: 'sell',
                    itemName: offer.item.name,
                    itemIcon: offer.item.icon,
                    count: actualBuyCount,
                    price: totalPrice,
                    fee: marketFee,
                    received: sellerReceives,
                    otherPlayer: getPlayerName(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // VE콎EJN츼 HISTORIE - viditeln치 pro v코echny
                await firebaseDB.ref('publicTradeHistory').push({
                    itemName: offer.item.name,
                    itemIcon: offer.item.icon,
                    itemId: offer.item.id,
                    count: actualBuyCount,
                    price: totalPrice,
                    fee: marketFee,
                    pricePerUnit: offer.price,
                    seller: offer.seller,
                    buyer: getPlayerName(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                notifySuccess('Koupeno!', `${actualBuyCount}x ${offer.item.name} za ${totalPrice} 游눯`);
                saveGame();
                
                // Zachovej scroll pozici
                const marketContent = document.getElementById('marketplaceOffersContainer');
                const scrollPos = marketContent ? marketContent.scrollTop : 0;
                
                await showMarketplace();
                
                // Obnov scroll pozici
                setTimeout(() => {
                    const newMarketContent = document.getElementById('marketplaceOffersContainer');
                    if (newMarketContent) newMarketContent.scrollTop = scrollPos;
                }, 100);
                
            } catch (e) {
                console.error('Chyba p콏i n치kupu:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se koupit');
            }
        }
        
        async function cancelMarketOffer(offerId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                // Najdi nab칤dku abychom mohli vr치tit item
                const offer = marketplaceOffers.find(o => o.id === offerId);
                
                if (offer && offer.item) {
                    // Vra콘 p콏edm캩t do invent치콏e
                    const count = offer.count || 1;
                    const existingItem = state.inv.find(i => i.id === offer.item.id);
                    
                    if (existingItem && (existingItem.type === 'consumable' || existingItem.type === 'resource' || existingItem.type === 'ammo')) {
                        // Stackovateln칠 - p콏idej k existuj칤c칤mu
                        existingItem.count = (existingItem.count || 1) + count;
                    } else {
                        // P콏idej jako nov칳 item (nebo pro ka쬯칳 kus zvl치코콘)
                        for (let i = 0; i < count; i++) {
                            state.inv.push({...offer.item, count: 1});
                        }
                    }
                    
                    addLog(`游닍 Vr치ceno z tr쬴코t캩: ${offer.item.icon} ${offer.item.name}${count > 1 ? ' (' + count + 'x)' : ''}`, '游낅');
                }
                
                // Sma nab칤dku z Firebase
                await firebaseDB.ref('marketplace/offers/' + offerId).remove();
                notifySuccess('Nab칤dka zru코ena', 'P콏edm캩t vr치cen do invent치콏e');
                showMarketplace();
                renderFull();
            } catch (e) {
                console.error('Chyba:', e);
                notifyWarning('Chyba p콏i ru코en칤 nab칤dky');
            }
        }
        
        async function showMarketplace(filterType = 'all', searchText = '') {
            if (!multiplayerEnabled) {
                showModal('游낅 Tr쬴코t캩', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游댋</div>
                        <h3 style="color: #ff9800;">Multiplayer nen칤 aktivn칤</h3>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Ulo쬴t aktu치ln칤 filtry
            window._marketFilter = filterType;
            window._marketSearch = searchText;
            
            // Automaticky vybrat pen칤ze z prodej콢
            await autoCollectMarketEarnings();
            
            const myName = getPlayerName();
            const activeOffers = marketplaceOffers.filter(o => o.status === 'active');
            const myOffers = activeOffers.filter(o => o.seller === myName);
            let otherOffers = activeOffers.filter(o => o.seller !== myName);
            
            // Aplikuj filtr typu
            // Aplikuj filtr typu
            if (filterType === 'armor') {
                otherOffers = otherOffers.filter(o => ['armor', 'helmet', 'gloves', 'boots'].includes(o.item.type));
            } else if (filterType === 'other') {
                otherOffers = otherOffers.filter(o => !['weapon', 'armor', 'helmet', 'gloves', 'boots', 'consumable'].includes(o.item.type));
            } else if (filterType !== 'all') {
                otherOffers = otherOffers.filter(o => o.item.type === filterType);
            }
            
            // Aplikuj textov칳 filtr
            if (searchText.trim()) {
                const search = searchText.toLowerCase().trim();
                otherOffers = otherOffers.filter(o => 
                    o.item.name?.toLowerCase().includes(search) || 
                    o.seller?.toLowerCase().includes(search) ||
                    o.item.special?.toLowerCase().includes(search)
                );
            }
            
            // Po캜et nab칤dek podle typu (pro zobrazen칤 v tla캜칤tk치ch)
            const allCount = activeOffers.filter(o => o.seller !== myName).length;
            const weaponCount = activeOffers.filter(o => o.seller !== myName && o.item.type === 'weapon').length;
            const armorCount = activeOffers.filter(o => o.seller !== myName && ['armor', 'helmet', 'gloves', 'boots'].includes(o.item.type)).length;
            const consumableCount = activeOffers.filter(o => o.seller !== myName && o.item.type === 'consumable').length;
            const otherCount = activeOffers.filter(o => o.seller !== myName && !['weapon', 'armor', 'helmet', 'gloves', 'boots', 'consumable'].includes(o.item.type)).length;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Tv칠 pen칤ze</div>
                        <div style="color: #ffd700; font-size: 1.2rem; font-weight: bold;">游눯 ${state.money}</div>
                    </div>
                    <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Tv칠 nab칤dky</div>
                        <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${myOffers.length}</div>
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('marketHoursInfo').style.display = document.getElementById('marketHoursInfo').style.display === 'none' ? 'block' : 'none'">
                        <span style="color: #888; font-size: 0.75rem;">游뎷 Otev칤rac칤 doby NPC obchod콢 郊</span>
                        <span style="color: #666; font-size: 0.7rem;">${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</span>
                    </div>
                    <div id="marketHoursInfo" style="display: none; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #333; font-size: 0.7rem;">
                        <div style="display: grid; gap: 0.2rem;">
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('settlement') ? '#8bc34a' : '#666'};">游 Osada <span>06-22</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('caravan') ? '#8bc34a' : '#666'};">游냙 Karavana <span>08-20</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('military') ? '#8bc34a' : '#666'};">游꿌勇 Vojensk칳 <span>06-18</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('mutants') ? '#8bc34a' : '#666'};">驕勇 Mutanti <span>20-06游깿</span></div>
                            <div style="display: flex; justify-content: space-between; color: #8bc34a;">游빍 Laborato콏 <span>non-stop</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('wandering') ? '#8bc34a' : '#666'};">游냙 Potuln칳 <span>10-16</span></div>
                        </div>
                        <p style="color: #4caf50; font-size: 0.65rem; margin: 0.3rem 0 0 0; text-align: center;">九 Online tr쬴코t캩 je otev콏en칠 24/7!</p>
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid #f44336; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1rem;">游끹勇</span>
                    <span style="color: #ff6b6b; font-size: 0.75rem;">Poplatek z prodeje: <strong>5%</strong> (strh치v치 se prodejci)</span>
                </div>
                
                <div style="background: #1a2a2a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #2196f3; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1rem;">丘뒲잺</span>
                    <span style="color: #64b5f6; font-size: 0.75rem;">V치ha vystaven칳ch v캩c칤 se po캜칤t치 do nosnosti dokud se neprodaj칤</span>
                </div>
                
                <!-- FILTR -->
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="display: flex; gap: 0.3rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="showMarketplace('all', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'all' ? '#4CAF50' : '#333'};">V코e (${allCount})</button>
                        <button class="btn" onclick="showMarketplace('weapon', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'weapon' ? '#f44336' : '#333'};">丘덢잺 (${weaponCount})</button>
                        <button class="btn" onclick="showMarketplace('armor', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'armor' ? '#2196f3' : '#333'};">游띠勇 (${armorCount})</button>
                        <button class="btn" onclick="showMarketplace('consumable', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'consumable' ? '#8bc34a' : '#333'};">游눍 (${consumableCount})</button>
                        <button class="btn" onclick="showMarketplace('other', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'other' ? '#ff9800' : '#333'};">游닍 (${otherCount})</button>
                    </div>
                    <input type="text" id="marketSearchInput" value="${escapeHtml(searchText)}" placeholder="游댌 Hledat n치zev, prodejce..." 
                        style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #2a2a2a; border: 1px solid #444; color: #fff; font-size: 0.85rem;"
                        onkeyup="if(event.key==='Enter')showMarketplace('${filterType}', this.value)"
                        oninput="clearTimeout(window._marketSearchTimeout); window._marketSearchTimeout = setTimeout(() => showMarketplace('${filterType}', this.value), 500)">
                </div>
            `;
            
            // Moje nab칤dky - ROZBALOVAC칈 SEKCE
            if (myOffers.length > 0) {
                html += `
                <details style="margin-bottom: 0.5rem; background: #1a2a1a; border-radius: 6px; border: 1px solid #2a4a2a;">
                    <summary style="padding: 0.6rem; cursor: pointer; color: #8bc34a; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                        <span>游닍 Tv칠 nab칤dky</span>
                        <span style="background: #2a4a2a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${myOffers.length}</span>
                    </summary>
                    <div style="padding: 0.5rem; border-top: 1px solid #2a4a2a;">
                `;
                myOffers.forEach(offer => {
                    const count = offer.count || 1;
                    const totalPrice = offer.totalPrice || offer.price;
                    
                    // V칳po캜et zb칳vaj칤c칤ho 캜asu (3 dny max)
                    const maxAge = 3 * 24 * 60 * 60 * 1000;
                    const offerAge = Date.now() - (offer.timestamp || Date.now());
                    const remaining = maxAge - offerAge;
                    const hoursLeft = Math.max(0, Math.floor(remaining / (60 * 60 * 1000)));
                    const daysLeft = Math.floor(hoursLeft / 24);
                    const hoursRem = hoursLeft % 24;
                    
                    const timeColor = hoursLeft < 24 ? '#f44336' : hoursLeft < 48 ? '#ff9800' : '#8bc34a';
                    const timeText = daysLeft > 0 ? `${daysLeft}d ${hoursRem}h` : `${hoursLeft}h`;
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #0a1a0a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="font-size: 1.5rem;">${escapeHtml(offer.item.icon)}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff;">${escapeHtml(offer.item.name)} ${count > 1 ? `<span style="color: #8bc34a;">(${count}x)</span>` : ''}</div>
                                <div style="color: #ffd700; font-size: 0.85rem;">${totalPrice} 游눯 ${count > 1 ? `(${offer.price}/ks)` : ''}</div>
                                <div style="color: ${timeColor}; font-size: 0.7rem;">낌勇 Zb칳v치: ${timeText}</div>
                            </div>
                            <button class="btn" onclick="cancelMarketOffer('${escapeHtml(offer.id)}')" style="background: #c62828; padding: 0.3rem 0.6rem; font-size: 0.8rem;">仇</button>
                        </div>
                    `;
                });
                html += `</div></details>`;
            }
            
            // Nab칤dky ostatn칤ch
            html += `<h4 style="color: #2196f3; margin-bottom: 0.5rem;">游 K prodeji (${otherOffers.length}):</h4>`;
            
            if (otherOffers.length === 0) {
                html += `<div style="text-align: center; padding: 1rem; color: #666;">콯치dn칠 nab칤dky...</div>`;
            } else {
                html += `<div style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                otherOffers.forEach(offer => {
                    const totalPrice = offer.totalPrice || offer.price;
                    const count = offer.count || 1;
                    const canBuy = state.money >= totalPrice;
                    const rarityColor = offer.item.rarity === 'legendary' ? '#ffd700' : offer.item.rarity === 'epic' ? '#9c27b0' : offer.item.rarity === 'rare' ? '#2196f3' : '#888';
                    
                    // Detailn칤 info pro tooltip/proklik
                    const itemType = offer.item.type || 'misc';
                    const specialInfo = offer.item.special ? `九 ${offer.item.special}` : '';
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${rarityColor};">
                            <span onclick="showMarketItemDetail('${escapeHtml(offer.id)}')" style="font-size: 1.8rem; cursor: pointer;" title="Klikni pro detail">${escapeHtml(offer.item.icon)}</span>
                            <div onclick="showMarketItemDetail('${escapeHtml(offer.id)}')" style="flex: 1; cursor: pointer;" title="Klikni pro detail">
                                <div style="color: #fff;">${escapeHtml(offer.item.name)} ${count > 1 ? `<span style="color: #8bc34a;">(${count}x)</span>` : ''}</div>
                                <div style="font-size: 0.75rem; color: #888;">
                                    ${offer.item.damage ? '丘덢잺' + escapeHtml(offer.item.damage) : ''} ${offer.item.defense ? '游띠勇' + escapeHtml(offer.item.defense) : ''} ${specialInfo}
                                     ${escapeHtml(offer.seller)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #ffd700; font-weight: bold;">${totalPrice} 游눯</div>
                                ${count > 1 ? `<div style="color: #888; font-size: 0.7rem;">(${offer.price}/ks)</div>` : ''}
                                <button class="btn" onclick="promptBuyOffer('${escapeHtml(offer.id)}', ${count}, ${offer.price})" style="background: ${canBuy ? '#4CAF50' : '#555'}; padding: 0.2rem 0.5rem; font-size: 0.75rem;" ${!canBuy ? 'disabled' : ''}>
                                    ${canBuy ? '游 Koupit' : '仇 M치lo 游눯'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showSellToMarketplace()" style="background: #ff9800;">俱 Prodat</button>
                    <button class="btn" onclick="checkMarketNotifications()" style="background: #2196f3;">游닓 Ozn치men칤</button>
                    <button class="btn" onclick="showTradeHistory()" style="background: #607d8b;">游늵 Historie</button>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zav콏칤t</button>
            `;
            
            showModal('游낅 Tr쬴코t캩 p콏e쬴v코칤ch', html);
        }
        
        // Detail itemu na tr쬴코ti
        function showMarketItemDetail(offerId) {
            const offer = marketplaceOffers.find(o => o.id === offerId);
            if (!offer) return;
            
            const item = offer.item;
            const rarityColor = item.rarity === 'legendary' ? '#ffd700' : item.rarity === 'epic' ? '#9c27b0' : item.rarity === 'rare' ? '#2196f3' : item.rarity === 'uncommon' ? '#4caf50' : '#888';
            const rarityName = item.rarity === 'legendary' ? 'Legend치rn칤' : item.rarity === 'epic' ? 'Epick칳' : item.rarity === 'rare' ? 'Vz치cn칳' : item.rarity === 'uncommon' ? 'Neobvykl칳' : 'B캩쬹칳';
            const count = offer.count || 1;
            const totalPrice = offer.totalPrice || offer.price;
            const canBuy = state.money >= totalPrice;
            
            // Najdi kompletn칤 definici itemu pro desc
            const fullItem = ITEMS.find(i => i.id === item.id);
            const itemDesc = fullItem?.desc || item.desc || '';
            
            // Speci치ln칤 efekt s klikateln칳m odkazem
            let specialHtml = '';
            if (item.special) {
                const detail = SPECIAL_EFFECT_DETAILS[item.special];
                if (detail) {
                    specialHtml = `
                        <div onclick="showSpecialEffectDetail('${item.special}')" style="background: ${detail.color}22; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0; cursor: pointer; border: 1px solid ${detail.color};">
                            <span style="color: ${detail.color};">九 ${detail.name}</span>
                            <span style="color: #888; font-size: 0.8rem;"> (klikni pro detail)</span>
                        </div>
                    `;
                } else {
                    specialHtml = `<p style="color: #9c27b0;">九 ${item.special}</p>`;
                }
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${rarityColor};">${item.name}</h3>
                    <p style="color: ${rarityColor}; font-size: 0.8rem; margin: 0.3rem 0;">${rarityName}</p>
                    ${itemDesc ? `<p style="color: #888; font-size: 0.85rem; font-style: italic;">"${itemDesc}"</p>` : ''}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">游늵 Statistiky:</h4>
                    ${item.damage ? `<div style="padding: 0.2rem 0;">丘덢잺 칔tok: <span style="color: #f44336;">+${item.damage}</span></div>` : ''}
                    ${item.defense ? `<div style="padding: 0.2rem 0;">游띠勇 Obrana: <span style="color: #2196f3;">+${item.defense}</span></div>` : ''}
                    ${item.effect ? `<div style="padding: 0.2rem 0;">游눍 Efekt: <span style="color: #4caf50;">${item.effect}</span></div>` : ''}
                    ${item.type ? `<div style="padding: 0.2rem 0;">游닍 Typ: <span style="color: #888;">${item.type}</span></div>` : ''}
                    ${specialHtml}
                </div>
                
                <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Prod치v치:</span>
                        <span style="color: #2196f3;">${escapeHtml(offer.seller)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Po캜et:</span>
                        <span style="color: #8bc34a;">${count}x</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.1rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #444;">
                        <span>Cena:</span>
                        <span style="color: #ffd700; font-weight: bold;">${totalPrice} 游눯</span>
                    </div>
                    ${count > 1 ? `<div style="text-align: right; font-size: 0.8rem; color: #888;">(${offer.price} 游눯/ks)</div>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="showMarketplace()" style="background: #555;"> Zp캩t</button>
                    <button class="btn" onclick="promptBuyOffer('${offerId}', ${count}, ${offer.price})" style="background: ${canBuy ? '#4CAF50' : '#555'};" ${!canBuy ? 'disabled' : ''}>
                        ${canBuy ? '游 Koupit' : '仇 M치lo 游눯'}
                    </button>
                </div>
            `);
        }
        
        function showSellToMarketplace() {
            // Na online tr쬴코ti lze prodat VECHNO (v캜etn캩 fromShop, fromCaravan, crafted)
            const sellableItems = state.inv.filter(i => {
                const validTypes = ['weapon', 'armor', 'helmet', 'gloves', 'boots', 'consumable', 'tool', 'component', 'ammo', 'material'];
                if (!validTypes.includes(i.type)) return false;
                if (isItemEquipped(i)) return false;
                // Z칤skej cenu
                const itemDef = ITEMS.find(it => it.id === i.id);
                const hasPrice = (i.price && i.price > 0) || (itemDef?.price && itemDef.price > 0);
                return hasPrice;
            });
            
            if (sellableItems.length === 0) {
                showModal('Prodat na tr쬴코ti', `
                    <div style="text-align: center; padding: 1rem; color: #888;">
                        Nem치코 nic k prodeji!
                    </div>
                    <button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 1rem; background: #555;"> ${'Zp캩t'}</button>
                `);
                return;
            }
            
            let html = `<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
            
            sellableItems.forEach((item) => {
                const realIdx = state.inv.indexOf(item);
                const count = item.count || 1;
                // Z칤skej cenu z itemu nebo z ITEMS definice
                const itemDef = ITEMS.find(i => i.id === item.id);
                const basePrice = item.price || itemDef?.price || item.value || 50;
                const suggestedPrice = Math.floor(basePrice * 0.8);
                const isStackable = count > 1;
                
                // Popis podle typu
                let desc = '';
                if (item.damage) desc += `丘덢잺${item.damage} `;
                if (item.defense) desc += `游띠勇${item.defense} `;
                if (item.effect) desc += `游눍${item.effect} `;
                if (item.value && item.type === 'consumable') desc += `+${item.value} `;
                
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.5rem;">${item.icon}</span>
                        <div style="flex: 1;">
                            <div style="color: #fff;">
                                ${item.name}
                                ${isStackable ? `<span style="color: #ffd700; font-weight: bold;"> 칑${count}</span>` : ''}
                            </div>
                            <div style="font-size: 0.75rem; color: #888;">${desc || item.type}</div>
                        </div>
                        <button class="btn" onclick="promptSellPrice(${realIdx}, ${suggestedPrice}, ${count})" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">${'游눯 Prodat'}</button>
                    </div>
                `;
            });
            
            html += `</div>
                <button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 1rem; background: #555;"> ${'Zp캩t'}</button>
            `;
            
            showModal('俱 Vyber item k prodeji', html);
        }
        
        function promptSellPrice(invIndex, suggestedPrice, maxCount = 1) {
            const item = state.inv[invIndex];
            if (!item) return;
            
            const count = item.count || 1;
            
            showModal(`游눯 Prodat ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${item.icon}</div>
                    
                    ${count > 1 ? `
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #888; font-size: 0.85rem;">Po캜et kus콢 (max ${count}):</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                                <button class="btn" onclick="adjustSellCount(-10)" style="padding: 0.3rem 0.6rem; background: #555;">-10</button>
                                <button class="btn" onclick="adjustSellCount(-1)" style="padding: 0.3rem 0.6rem; background: #555;">-</button>
                                <input type="number" id="sellCountInput" value="1" min="1" max="${count}"
                                    style="width: 60px; padding: 0.5rem; font-size: 1.1rem; background: #1a1a1a; border: 2px solid #8bc34a; border-radius: 8px; color: #8bc34a; text-align: center;"
                                    onchange="updateSellTotal(${suggestedPrice})">
                                <button class="btn" onclick="adjustSellCount(1)" style="padding: 0.3rem 0.6rem; background: #555;">+</button>
                                <button class="btn" onclick="adjustSellCount(10)" style="padding: 0.3rem 0.6rem; background: #555;">+10</button>
                            </div>
                            <button class="btn" onclick="document.getElementById('sellCountInput').value=${count}; updateSellTotal(${suggestedPrice});" style="margin-top: 0.3rem; padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">V코e (${count})</button>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="color: #888; font-size: 0.85rem;">Cena za kus:</label>
                        <input type="number" id="sellPriceInput" value="${suggestedPrice}" min="1" max="99999"
                            style="width: 100%; padding: 0.8rem; font-size: 1.3rem; background: #1a1a1a; border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; text-align: center; margin-top: 0.3rem;"
                            onchange="updateSellTotal(${suggestedPrice})">
                    </div>
                    
                    <div id="sellTotalDisplay" style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                        <span style="color: #888;">Celkem:</span>
                        <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${suggestedPrice} 游눯</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="showSellToMarketplace()" style="background: #555;">仇 Zru코it</button>
                        <button class="btn" onclick="confirmSellToMarket(${invIndex})" style="background: #4CAF50;">九 Prodat</button>
                    </div>
                </div>
            `);
        }
        
        function adjustSellCount(delta) {
            const input = document.getElementById('sellCountInput');
            if (!input) return;
            const max = parseInt(input.max) || 1;
            const newVal = Math.max(1, Math.min(max, parseInt(input.value || 1) + delta));
            input.value = newVal;
            updateSellTotal();
        }
        
        function updateSellTotal() {
            const countInput = document.getElementById('sellCountInput');
            const priceInput = document.getElementById('sellPriceInput');
            const display = document.getElementById('sellTotalDisplay');
            if (!priceInput || !display) return;
            
            const count = parseInt(countInput?.value) || 1;
            const price = parseInt(priceInput.value) || 0;
            const total = count * price;
            
            display.innerHTML = `
                <span style="color: #888;">${count > 1 ? `${count}x ${price} = ` : 'Celkem:'}</span>
                <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${total} 游눯</span>
            `;
        }
        
        async function confirmSellToMarket(invIndex) {
            // Kontrola 쬰 je multiplayer aktivn칤
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Offline', 'Tr쬴코t캩 nen칤 dostupn칠 - multiplayer nen칤 p콏ipojen');
                return;
            }
            
            const priceInput = document.getElementById('sellPriceInput');
            const countInput = document.getElementById('sellCountInput');
            const price = parseInt(priceInput?.value) || 0;
            const count = parseInt(countInput?.value) || 1;
            
            if (price < 1) {
                notifyWarning('Neplatn치 cena', 'Mus칤 b칳t alespo켿 1 游눯');
                return;
            }
            
            const item = state.inv[invIndex];
            if (!item) {
                notifyWarning('Chyba', 'Item nenalezen v invent치콏i');
                return;
            }
            
            // D콡LE콯IT칄: Odeber z invent치콏e IHNED p콏ed Firebase operac칤
            // T칤m zabr치n칤me duplikaci pokud hr치캜 zav콏e okno
            const availableCount = item.count || 1;
            const sellCount = Math.min(count, availableCount);
            
            // Odeber z invent치콏e P콎ED vytvo콏en칤m nab칤dky
            const itemCopy = JSON.parse(JSON.stringify(item)); // Deep copy pro nab칤dku
            const removeSuccess = removeItemFromInventory(item, sellCount);
            
            if (!removeSuccess) {
                notifyWarning('Chyba', 'Nepoda콏ilo se odebrat item z invent치콏e');
                return;
            }
            
            // Ulo쮂셠e hru ihned po odebr치n칤
            saveGame();
            
            // Vytvo콏 kopii itemu pro nab칤dku
            const itemForOffer = {
                id: itemCopy.id || 'unknown',
                name: itemCopy.name || 'P콏edm캩t',
                icon: itemCopy.icon || '游닍',
                type: itemCopy.type || 'misc',
                damage: typeof itemCopy.damage === 'number' ? itemCopy.damage : 0,
                defense: typeof itemCopy.defense === 'number' ? itemCopy.defense : 0,
                count: sellCount
            };
            
            // P콏idej dal코칤 hodnoty pokud existuj칤
            if (itemCopy.rarity && typeof itemCopy.rarity === 'string') itemForOffer.rarity = itemCopy.rarity;
            if (itemCopy.effect && typeof itemCopy.effect === 'string') itemForOffer.effect = itemCopy.effect;
            if (typeof itemCopy.value === 'number') itemForOffer.value = itemCopy.value;
            
            const totalPrice = price * sellCount;
            
            try {
                // Vytvo콏 nab칤dku
                const offer = {
                    seller: getPlayerName(),
                    item: itemForOffer,
                    price: price,
                    totalPrice: totalPrice,
                    count: sellCount,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active'
                };
                
                await firebaseDB.ref('marketplace/offers').push(offer);
                notifySuccess('Nab칤dka vytvo콏ena!', `${sellCount}x ${itemCopy.name} za ${totalPrice} 游눯`);
                
                renderFull();
                showMarketplace();
                
            } catch (e) {
                console.error('Chyba p콏i vytv치콏en칤 nab칤dky:', e);
                // D콡LE콯IT칄: Vr치tit item zp캩t do invent치콏e pokud Firebase sel쬰
                addItemToInventory(itemCopy, sellCount, true);
                saveGame();
                notifyWarning('Chyba', ('Nepoda콏ilo se vytvo콏it nab칤dku: ') + (e.message || 'Nezn치m치 chyba'));
            }
        }
        
        async function checkMarketNotifications() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                const snapshot = await firebaseDB.ref('marketplace/notifications/' + myName).once('value');
                const notifications = snapshot.val() || {};
                const notifList = Object.entries(notifications).map(([key, val]) => ({...val, id: key}));
                
                if (notifList.length === 0) {
                    showModal('游닓 Ozn치men칤', `
                        <div style="text-align: center; padding: 2rem; color: #888;">
                            콯치dn치 nov치 ozn치men칤
                        </div>
                        <button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 1rem;">${'Zp캩t'}</button>
                    `);
                    return;
                }
                
                let html = `<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                let totalEarnings = 0;
                
                notifList.forEach(notif => {
                    if (notif.type === 'sold') {
                        totalEarnings += notif.price;
                        html += `
                            <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #8bc34a;">
                                <div style="color: #8bc34a;">游눯 Prod치no!</div>
                                <div style="color: #fff;">${notif.item}  ${notif.buyer}</div>
                                <div style="color: #ffd700; font-weight: bold;">+${notif.price} 游눯</div>
                            </div>
                        `;
                    }
                });
                
                html += `</div>`;
                
                if (totalEarnings > 0) {
                    html += `
                        <div style="background: #2a3a1a; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
                            <div style="color: #888;">Celkov칳 v칳d캩lek:</div>
                            <div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">+${totalEarnings} 游눯</div>
                        </div>
                        <button class="btn" onclick="collectMarketEarnings(${totalEarnings})" style="width: 100%; margin-top: 0.5rem; background: #4CAF50;">九 Vybrat pen칤ze</button>
                    `;
                }
                
                html += `<button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 0.5rem; background: #555;"> ${'Zp캩t'}</button>`;
                
                showModal('游닓 Ozn치men칤 z tr쬴코t캩', html);
                
            } catch (e) {
                console.error('Chyba:', e);
            }
        }
        
        // Automatick치 kontrola a vybr치n칤 pen캩z p콏i otev콏en칤 marketplace
        async function autoCollectMarketEarnings() {
            if (!multiplayerEnabled || !firebaseDB) return 0;
            
            const myName = getPlayerName();
            
            try {
                const sanitizedName = sanitizeFirebasePath(myName);
                const snapshot = await firebaseDB.ref('marketplace/notifications/' + sanitizedName).once('value');
                const notifications = snapshot.val() || {};
                const notifList = Object.values(notifications);
                
                let totalEarnings = 0;
                let totalFees = 0;
                notifList.forEach(notif => {
                    if (notif.type === 'sold') {
                        // Pou쬴j moneyToAdd (u po ode캜ten칤 poplatku) nebo fallback na price pro star칠 notifikace
                        totalEarnings += notif.moneyToAdd || notif.price || 0;
                        totalFees += notif.fee || 0;
                    }
                });
                
                if (totalEarnings > 0) {
                    addMoney(totalEarnings);
                    await firebaseDB.ref('marketplace/notifications/' + sanitizedName).remove();
                    saveGame(true);
                    if (totalFees > 0) {
                        notifySuccess('游눯 Pen칤ze z prodeje!', `+${totalEarnings} 游눯 (poplatek: ${totalFees} 游눯)`);
                    } else {
                        notifySuccess('游눯 Pen칤ze z prodeje!', `+${totalEarnings} 游눯 automaticky p콏ips치no`);
                    }
                }
                
                return totalEarnings;
            } catch (e) {
                console.error('Auto collect error:', e);
                return 0;
            }
        }
        
        async function collectMarketEarnings(amount) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const sanitizedName = sanitizeFirebasePath(myName);
            
            // P콏idej pen칤ze spr치vn캩 p콏es funkci
            addMoney(amount);
            
            // Sma ozn치men칤
            await firebaseDB.ref('marketplace/notifications/' + sanitizedName).remove();
            
            notifySuccess('Pen칤ze vybr치ny!', `+${amount} 游눯`);
            saveGame();
            showMarketplace();
        }
        
        // === 游댠 SUPER PvP SYST칄M v2.0 ===
        let lastPvPNotificationId = null;
        let activePvPBattle = null;
        let pvpAnimationFrame = null;
        
        // 游끥 PvP RANKING SYST칄M
        const PVP_RANKS = [
            { name: 'Nov치캜ek', icon: '游볠', minElo: 0, color: '#cd7f32' },
            { name: 'Bojovn칤k', icon: '丘덢잺', minElo: 1000, color: '#c0c0c0' },
            { name: 'Veter치n', icon: '游볟', minElo: 1200, color: '#87ceeb' },
            { name: 'Elita', icon: '游볞', minElo: 1400, color: '#ffd700' },
            { name: '마mpion', icon: '游끥', minElo: 1600, color: '#ff9800' },
            { name: 'Gladi치tor', icon: '丘덢잺游녬', minElo: 1800, color: '#e91e63' },
            { name: 'Legenda', icon: '游', minElo: 2000, color: '#9c27b0' },
            { name: 'Nesmrteln칳', icon: '游游녬', minElo: 2500, color: '#f44336' }
        ];
        
        // 游꿢 PvP SPECI츼LN칈 SCHOPNOSTI
        const PVP_ABILITIES = {
            // 칔to캜n칠
            powerStrike: { name: 'Drtiv칳 칰der', icon: '游눤', cooldown: 3, damage: 2.0, desc: '200% damage', type: 'attack' },
            doubleSlash: { name: 'Dvojit칳 sek', icon: '丘덢잺丘덢잺', cooldown: 2, hits: 2, damage: 0.7, desc: '2x 70% damage', type: 'attack' },
            criticalAim: { name: 'Kritick칳 c칤l', icon: '游꿢', cooldown: 4, critBonus: 100, damage: 1.0, desc: '+100% crit 코ance', type: 'attack' },
            venomStrike: { name: 'Jedovat칳 칰der', icon: '游냀', cooldown: 3, damage: 0.8, poison: 3, desc: 'Jed 3 kola', type: 'attack' },
            berserkerRage: { name: 'Zu콏ivost', icon: '游땫', cooldown: 5, damage: 2.5, selfDamage: 0.1, desc: '250% DMG, -10% HP', type: 'attack' },
            
            // Obrann칠
            ironSkin: { name: '콯elezn치 k콢쬰', icon: '游띠勇', cooldown: 4, defenseBoost: 3.0, duration: 2, desc: '3x obrana 2 kola', type: 'defense' },
            dodge: { name: '칔hyb', icon: '游눧', cooldown: 2, dodgeChance: 100, desc: '100% 칰hyb', type: 'defense' },
            counter: { name: 'Proti칰tok', icon: '뾆잺', cooldown: 3, counterDamage: 1.5, desc: 'Odraz칤 150% DMG', type: 'defense' },
            heal: { name: 'L칠캜en칤', icon: '游눜', cooldown: 4, healPercent: 25, desc: 'Vyl칠캜칤 25% HP', type: 'defense' },
            
            // Speci치ln칤
            stun: { name: 'Omr치캜en칤', icon: '游눪', cooldown: 5, stunDuration: 1, damage: 0.5, desc: 'Stun 1 kolo', type: 'special' },
            lifeSteal: { name: 'Vys치t칤 쬴vota', icon: '游빁', cooldown: 4, damage: 1.0, steal: 0.5, desc: 'Kradne 50% DMG', type: 'special' },
            execute: { name: 'Poprava', icon: '丘썶잺', cooldown: 6, executeThreshold: 0.25, damage: 3.0, desc: '3x DMG pod 25% HP', type: 'special' },
            lastStand: { name: 'Posledn칤 vzdor', icon: '游댠', cooldown: 0, passive: true, desc: '+50% DMG pod 20% HP', type: 'passive' }
        };
        
        // 游꿌勇 PvP TITULY (achievementy)
        const PVP_TITLES = [
            { id: 'first_blood', name: 'Prvn칤 krev', icon: '游뽖', req: 'Vyhr치t prvn칤 PvP', check: (s) => s.pvpWins >= 1 },
            { id: 'warrior', name: 'V치le캜n칤k', icon: '丘덢잺', req: '10 v칤t캩zstv칤', check: (s) => s.pvpWins >= 10 },
            { id: 'dominator', name: 'Domin치tor', icon: '游녬', req: '50 v칤t캩zstv칤', check: (s) => s.pvpWins >= 50 },
            { id: 'legend', name: 'Legenda', icon: '游', req: '100 v칤t캩zstv칤', check: (s) => s.pvpWins >= 100 },
            { id: 'streak5', name: 'Na vln캩', icon: '游깱', req: '5 v칤t캩zstv칤 v 콏ad캩', check: (s) => s.pvpWinStreak >= 5 },
            { id: 'streak10', name: 'Nezastaviteln칳', icon: '游댠', req: '10 v칤t캩zstv칤 v 콏ad캩', check: (s) => s.pvpWinStreak >= 10 },
            { id: 'comeback', name: 'Comeback King', icon: '游녥', req: 'Vyhr치t s <10% HP', check: (s) => s.pvpComeback >= 1 },
            { id: 'flawless', name: 'Perfektn칤', icon: '游눑', req: 'Vyhr치t bez zran캩n칤', check: (s) => s.pvpFlawless >= 1 },
            { id: 'rich', name: 'High Roller', icon: '游눯', req: 'Vyhr치t 10000+ s치zku', check: (s) => s.pvpMaxBetWon >= 10000 },
            { id: 'gladiator', name: 'Gladi치tor', icon: '游끹勇', req: 'Dos치hnout 1800 ELO', check: (s) => s.pvpElo >= 1800 },
            { id: 'tournament', name: '마mpion turnaje', icon: '游끥', req: 'Vyhr치t turnaj', check: (s) => s.pvpTournamentsWon >= 1 }
        ];
        
        // Inicializace PvP stats
        function initPvPStats() {
            if (!state.pvp) {
                state.pvp = {
                    elo: 1000,
                    wins: 0,
                    losses: 0,
                    winStreak: 0,
                    maxWinStreak: 0,
                    totalDamageDealt: 0,
                    totalDamageReceived: 0,
                    comebacks: 0,
                    flawless: 0,
                    maxBetWon: 0,
                    tournamentsWon: 0,
                    tournamentsPlayed: 0,
                    titles: [],
                    selectedAbilities: ['powerStrike', 'dodge', 'heal', 'stun'],
                    lastBattleLog: []
                };
            }
        }
        
        // Z칤skej PvP rank podle ELO
        function getPvPRank(elo) {
            for (let i = PVP_RANKS.length - 1; i >= 0; i--) {
                if (elo >= PVP_RANKS[i].minElo) return PVP_RANKS[i];
            }
            return PVP_RANKS[0];
        }
        
        // V칳po캜et ELO zm캩ny
        function calculateEloChange(myElo, enemyElo, won) {
            // Zajisti 쬰 ELO jsou 캜칤sla
            myElo = parseInt(myElo) || 1000;
            enemyElo = parseInt(enemyElo) || 1000;
            
            const K = 32; // K-faktor
            const expected = 1 / (1 + Math.pow(10, (enemyElo - myElo) / 400));
            const actual = won ? 1 : 0;
            const change = Math.round(K * (actual - expected));
            
            // Vra콘 validn칤 캜칤slo
            return isNaN(change) ? (won ? 16 : -16) : change;
        }
        
        function listenToPvP() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            initPvPStats();
            const myName = getPlayerName();
            
            firebaseDB.ref('pvp/challenges').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                pvpChallenges = Object.entries(data).map(([key, val]) => ({...val, id: key}));
                
                // Zkontroluj jestli m치m novou v칳zvu (max 5 minut starou)
                const now = Date.now();
                const PVP_CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minut
                const myChallenge = pvpChallenges.find(c => 
                    c.target === myName && 
                    c.status === 'pending' &&
                    (now - (c.createdAt || 0)) < PVP_CHALLENGE_TIMEOUT
                );
                if (myChallenge && myChallenge.id !== lastPvPNotificationId) {
                    lastPvPNotificationId = myChallenge.id;
                    showFullscreenPvPChallenge(myChallenge);
                }
                
                // Auto-expire star칠 pending v칳zvy (pro challengera)
                const myOldPendingChallenge = pvpChallenges.find(c =>
                    c.challenger === myName &&
                    c.status === 'pending' &&
                    c.createdAt &&
                    (now - c.createdAt) > PVP_CHALLENGE_TIMEOUT
                );
                if (myOldPendingChallenge) {
                    // Automaticky zru코 starou v칳zvu
                    firebaseDB.ref('pvp/challenges/' + myOldPendingChallenge.id).update({ status: 'expired' });
                    notifyWarning('낋 V칳zva vypr코ela', `${myOldPendingChallenge.target} nereagoval/a v캜as.`);
                }
                
                // Zkontroluj real-time battle
                const activeBattle = pvpChallenges.find(c => 
                    (c.challenger === myName || c.target === myName) && 
                    c.status === 'in_progress'
                );
                if (activeBattle && !activePvPBattle) {
                    startRealTimePvPBattle(activeBattle);
                }
                
                // Zkontroluj dokon캜en칠 bitvy
                const myCompletedChallenge = pvpChallenges.find(c => 
                    (c.challenger === myName || c.target === myName) && 
                    c.status === 'completed' && 
                    !c.notified
                );
                if (myCompletedChallenge) {
                    showPvPResult(myCompletedChallenge);
                }
            });
            
            // Poslouchej turnaje
            firebaseDB.ref('pvp/tournaments').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                window.pvpTournaments = Object.entries(data).map(([key, val]) => ({...val, id: key}));
            });
        }
        
        // 游꿟 FULLSCREEN PvP V칗ZVA s animacemi
        // Glob치ln칤 flag pro aktivn칤 PvP v칳zvu - zabra켿uje p콏ekryt칤 jin칳mi okny
        let pvpChallengeOverlayActive = false;
        
        function showFullscreenPvPChallenge(challenge) {
            // Ozna캜 쬰 je aktivn칤 PvP v칳zva
            pvpChallengeOverlayActive = true;
            
            const rank = getPvPRank(challenge.challengerStats?.elo || 1000);
            const html = `
                <div id="pvpFullscreenOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.98); z-index: 999999; display: flex; align-items: center; justify-content: center; animation: pvpFadeIn 0.3s;">
                    <div style="background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); border: 2px solid #f44336; border-radius: 16px; padding: 1.5rem; max-width: 340px; width: 90%; text-align: center; animation: pvpBounce 0.5s; position: relative; overflow: hidden;">
                        
                        <!-- Animated background -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 50% 50%, rgba(244,67,54,0.1) 0%, transparent 70%); animation: pvpGlow 2s infinite;"></div>
                        
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem; animation: pvpPulse 1s infinite; filter: drop-shadow(0 0 10px rgba(244,67,54,0.8));">丘덢잺</div>
                            <h2 style="color: #f44336; margin: 0 0 0.8rem 0; text-shadow: 0 0 20px rgba(244,67,54,0.8); font-size: 1.3rem; letter-spacing: 1px;">V칗ZVA K SOUBOJI!</h2>
                            
                            <div style="background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 12px; margin: 0.8rem 0; border: 2px solid ${rank.color};">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.4rem; margin-bottom: 0.3rem;">
                                    <span style="font-size: 1rem;">${rank.icon}</span>
                                    <span style="color: ${rank.color}; font-size: 0.75rem;">${rank.name}</span>
                                </div>
                                <div style="color: #fff; font-size: 1.2rem; font-weight: bold;">${escapeHtml(challenge.challenger)}</div>
                                <div style="color: #888; font-size: 0.8rem; margin-top: 0.3rem;">
                                    Level ${challenge.challengerStats?.level || '?'} | 
                                    ELO: <span style="color: ${rank.color};">${challenge.challengerStats?.elo || 1000}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; margin-top: 0.5rem; background: #0a0a0a; padding: 0.4rem; border-radius: 6px; font-size: 0.8rem;">
                                    <div><span style="font-size: 0.85rem;">仇벒잺</span><br>${challenge.challengerStats?.hp || '?'}</div>
                                    <div><span style="font-size: 0.85rem;">丘덢잺</span><br>${challenge.challengerStats?.damage || '?'}</div>
                                    <div><span style="font-size: 0.85rem;">游띠勇</span><br>${challenge.challengerStats?.defense || '?'}</div>
                                    <div><span style="font-size: 0.85rem;">游눧</span><br>${challenge.challengerStats?.agility || '?'}</div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #3a3a0a 0%, #2a2a00 100%); padding: 0.8rem; border-radius: 12px; margin: 0.8rem 0; border: 2px solid #ffd700; animation: goldPulse 2s infinite;">
                                <div style="color: #888; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;">S치zka</div>
                                <div style="color: #ffd700; font-size: 1.8rem; font-weight: bold; text-shadow: 0 0 15px rgba(255,215,0,0.5);">${challenge.bet} 游눯</div>
                            </div>
                            
                            <div style="background: rgba(255,152,0,0.1); padding: 0.5rem; border-radius: 8px; margin: 0.8rem 0; border: 1px solid #ff9800;">
                                <p style="color: #ff9800; font-size: 0.8rem; margin: 0;">
                                    丘멆잺 Prohra = -${challenge.bet} 游눯 a ELO!
                                </p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-top: 1rem;">
                                <button onclick="declinePvPFromOverlay('${challenge.id}')" style="background: linear-gradient(135deg, #555 0%, #333 100%); color: #fff; border: none; padding: 0.9rem; border-radius: 10px; font-size: 0.95rem; cursor: pointer; font-family: inherit; transition: all 0.3s;">
                                    仇 Odm칤tnout
                                </button>
                                <button onclick="acceptPvPFromOverlay('${challenge.id}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: #fff; border: none; padding: 0.9rem; border-radius: 10px; font-size: 0.95rem; cursor: pointer; font-weight: bold; font-family: inherit; animation: fightBtnPulse 1s infinite; box-shadow: 0 0 20px rgba(244,67,54,0.5);">
                                    丘덢잺 BOJOVAT!
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes pvpFadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes pvpBounce { 0% { transform: scale(0.3) rotate(-10deg); opacity: 0; } 50% { transform: scale(1.05) rotate(2deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
                    @keyframes pvpPulse { 0%, 100% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.1) rotate(-5deg); } 75% { transform: scale(1.1) rotate(5deg); } }
                    @keyframes pvpGlow { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
                    @keyframes goldPulse { 0%, 100% { box-shadow: 0 0 10px rgba(255,215,0,0.3); } 50% { box-shadow: 0 0 20px rgba(255,215,0,0.6); } }
                    @keyframes fightBtnPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            if (typeof SoundSystem !== 'undefined') SoundSystem.play('combat');
        }
        
        function closePvPOverlay() {
            const overlay = document.getElementById('pvpFullscreenOverlay');
            if (overlay) overlay.remove();
            pvpChallengeOverlayActive = false;
        }
        
        async function acceptPvPFromOverlay(challengeId) {
            closePvPOverlay();
            await acceptPvPChallenge(challengeId);
        }
        
        async function declinePvPFromOverlay(challengeId) {
            closePvPOverlay();
            await declinePvPChallenge(challengeId);
        }
        
        // 游꿟 ZOBRAZEN칈 V칗SLEDKU PvP s animacemi
        function showPvPResult(challenge) {
            // Tato funkce se vol치 pro CHALLENGERA (ten kdo poslal v칳zvu) kdy se boj dokon캜칤
            // Pro toho kdo P콎IJAL v칳zvu se vol치 showPvPResultDirect
            
            // Pokud u je overlay zobrazen, ned캩l치me nic
            if (document.getElementById('pvpResultOverlay')) return;
            
            initPvPStats();
            const myName = getPlayerName();
            const iWon = challenge.winner === myName;
            const opponent = challenge.challenger === myName ? challenge.target : challenge.challenger;
            const eloChange = challenge.eloChange || 0;
            
            // Pro challengera - aktualizuj jeho stats kdy se dozv칤 v칳sledek
            if (challenge.challenger === myName) {
                if (iWon) {
                    state.pvp.wins++;
                    state.pvp.winStreak++;
                    if (challenge.bet > 0) addMoney(challenge.bet);
                    notifySuccess('丘덢잺 V칈T캨ZSTV칈!', `${opponent} pora쬰n!${challenge.bet > 0 ? ` +${challenge.bet} 游눯` : ''}`);
                    
                    // Daily quest progress
                    if (state.dailyQuests?.progress) {
                        state.dailyQuests.progress.pvpWins = (state.dailyQuests.progress.pvpWins || 0) + 1;
                        checkDailyQuests();
                    }
                } else {
                    state.pvp.losses++;
                    state.pvp.winStreak = 0;
                    if (challenge.bet > 0) removeMoney(challenge.bet);
                    notifyWarning('丘덢잺 Prohra', `${opponent} vyhr치l!${challenge.bet > 0 ? ` -${challenge.bet} 游눯` : ''}`);
                }
                state.pvp.elo = Math.max(0, state.pvp.elo + (iWon ? eloChange : -eloChange));
                saveGame();
            }
            
            const myNewElo = state.pvp.elo;
            const newRank = getPvPRank(myNewElo);
            
            // Aktualizuj notifikaci
            if (firebaseDB) {
                firebaseDB.ref('pvp/challenges/' + challenge.id).update({ notified: true });
            }
            
            // Nov칠 tituly?
            const newTitles = checkPvPTitles();
            
            const html = `
                <div id="pvpResultOverlayAuto" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.98); z-index: 99999; display: flex; align-items: center; justify-content: center; padding: 1rem; animation: pvpFadeIn 0.3s;">
                    <div style="background: linear-gradient(135deg, ${iWon ? '#1a3a1a' : '#3a1a1a'} 0%, #0a0a0a 100%); border: 2px solid ${iWon ? '#4CAF50' : '#f44336'}; border-radius: 16px; padding: 1.2rem; max-width: 340px; width: 100%; text-align: center; animation: resultBounce 0.6s;">
                        
                        <!-- Victory/Defeat animation -->
                        <div style="font-size: 3rem; margin-bottom: 0.5rem; animation: ${iWon ? 'victoryAnim' : 'defeatAnim'} 1s;">
                            ${iWon ? '游끥' : '游'}
                        </div>
                        
                        <h2 style="color: ${iWon ? '#4CAF50' : '#f44336'}; margin: 0 0 0.3rem 0; font-size: 1.4rem; text-shadow: 0 0 20px ${iWon ? 'rgba(76,175,80,0.8)' : 'rgba(244,67,54,0.8)'}; letter-spacing: 2px;">
                            ${iWon ? 'V칈T캨ZSTV칈!' : 'PROHRA!'}
                        </h2>
                        
                        <p style="color: #888; margin: 0.3rem 0; font-size: 0.85rem;">vs <strong style="color: #fff;">${opponent}</strong></p>
                        
                        <!-- Pen칤ze -->
                        <div style="background: ${iWon ? 'linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%)' : 'linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%)'}; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${iWon ? '#4CAF50' : '#f44336'};">
                            <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.8rem; font-weight: bold; animation: moneyPop 0.5s;">
                                ${iWon ? '+' : '-'}${challenge.bet} 游눯
                            </div>
                        </div>
                        
                        <!-- ELO zm캩na -->
                        <div style="background: #1a1a2a; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${newRank.color};">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 0.8rem;">
                                <div style="text-align: center;">
                                    <div style="color: #888; font-size: 0.7rem;">ELO</div>
                                    <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.2rem; font-weight: bold;">
                                        ${iWon ? '+' : ''}${eloChange}
                                    </div>
                                </div>
                                <div style="color: #555; font-size: 1.3rem;"></div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2rem;">${newRank.icon}</div>
                                    <div style="color: ${newRank.color}; font-weight: bold; font-size: 1.1rem;">${myNewElo}</div>
                                    <div style="color: ${newRank.color}; font-size: 0.7rem;">${newRank.name}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistiky boje -->
                        ${challenge.battleStats ? `
                            <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin: 0.7rem 0;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; font-size: 0.75rem;">
                                    <div><span style="color: #888;">Kola</span><br><span style="color: #fff;">${challenge.battleStats.rounds}</span></div>
                                    <div><span style="color: #888;">DMG</span><br><span style="color: #ff9800;">${challenge.battleStats.myDamage}</span></div>
                                    <div><span style="color: #888;">P콏ijato</span><br><span style="color: #f44336;">${challenge.battleStats.damageTaken}</span></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Nov칠 tituly -->
                        ${newTitles.length > 0 ? `
                            <div style="background: linear-gradient(135deg, #3a2a0a 0%, #2a1a00 100%); padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid #ffd700; animation: newTitleGlow 1s infinite;">
                                <div style="color: #ffd700; font-weight: bold; margin-bottom: 0.3rem; font-size: 0.85rem;">游끤 NOV칗 TITUL!</div>
                                ${newTitles.map(t => `<div style="font-size: 1rem;">${t.icon} ${t.name}</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button onclick="showPvPBattleLog('${challenge.id}')" style="background: #333; color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                游닆 Log
                            </button>
                            <button onclick="document.getElementById('pvpResultOverlay').remove(); showPvPArena();" style="background: linear-gradient(135deg, #555 0%, #333 100%); color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                丘덢잺 Dal코칤
                            </button>
                        </div>
                        
                        <button onclick="document.getElementById('pvpResultOverlay').remove()" style="background: transparent; color: #666; border: none; padding: 0.4rem; margin-top: 0.3rem; cursor: pointer; font-family: inherit; width: 100%; font-size: 0.8rem;">
                            Zav콏칤t
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes resultBounce { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 60% { transform: scale(1.1) rotate(10deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
                    @keyframes victoryAnim { 0% { transform: scale(0) rotate(-180deg); } 50% { transform: scale(1.3) rotate(20deg); } 100% { transform: scale(1) rotate(0deg); } }
                    @keyframes defeatAnim { 0% { transform: translateY(-50px); opacity: 0; } 60% { transform: translateY(10px); } 100% { transform: translateY(0); opacity: 1; } }
                    @keyframes moneyPop { 0% { transform: scale(0); } 60% { transform: scale(1.3); } 100% { transform: scale(1); } }
                    @keyframes newTitleGlow { 0%, 100% { box-shadow: 0 0 10px rgba(255,215,0,0.5); } 50% { box-shadow: 0 0 30px rgba(255,215,0,0.8); } }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            if (typeof SoundSystem !== 'undefined') SoundSystem.play(iWon ? 'victory' : 'damage');
        }
        
        // Zobrazit battle log
        function showPvPBattleLog(challengeId) {
            const challenge = pvpChallenges.find(c => c.id === challengeId);
            if (!challenge || !challenge.log) return;
            
            const myName = getPlayerName();
            const opponent = challenge.challenger === myName ? challenge.target : challenge.challenger;
            
            let logHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.8rem; background: #0a0a0a; border-radius: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem;">游녻</div>
                        <div style="color: #8bc34a; font-weight: bold;">${myName}</div>
                    </div>
                    <div style="color: #888; font-size: 1.5rem;">丘덢잺</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem;">游녻</div>
                        <div style="color: #ff6b6b; font-weight: bold;">${opponent}</div>
                    </div>
                </div>
                
                <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">游닆 Pr콢b캩h boje (${challenge.battleStats?.rounds || '?'} kol)</div>
                
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; padding: 0.5rem; border-radius: 8px;">
            `;
            
            challenge.log.forEach((entry, i) => {
                const isMe = entry.actor === myName;
                const isSystem = entry.actor === 'System';
                
                logHtml += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; margin-bottom: 3px; background: ${isSystem ? '#2a1a2a' : (isMe ? 'rgba(76,175,80,0.1)' : 'rgba(244,67,54,0.1)')}; border-radius: 6px; border-left: 3px solid ${isSystem ? '#9c27b0' : (isMe ? '#4CAF50' : '#f44336')};">
                        <div style="min-width: 24px; text-align: center;">
                            ${isSystem ? '丘' : (isMe ? '游릭' : '游댮')}
                        </div>
                        <div style="flex: 1;">
                            <span style="color: ${isSystem ? '#9c27b0' : (isMe ? '#8bc34a' : '#ff6b6b')}; font-weight: bold;">${entry.actor}</span>
                            ${entry.ability ? `<span style="color: #ffd700; margin-left: 0.3rem;">${entry.ability}</span>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${entry.damage ? `<span style="color: #ff9800; font-weight: bold;">${entry.damage} DMG</span>` : ''}
                            ${entry.effect ? `<div style="color: #9c27b0; font-size: 0.75rem;">${entry.effect}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            logHtml += `</div>`;
            
            // Statistiky boje
            if (challenge.battleStats) {
                logHtml += `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 1rem; padding: 0.8rem; background: #1a1a1a; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${challenge.battleStats.myDamage || 0}</div>
                            <div style="color: #888; font-size: 0.7rem;">Tv콢j DMG</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #fff; font-size: 1.2rem; font-weight: bold;">${challenge.battleStats.rounds || 0}</div>
                            <div style="color: #888; font-size: 0.7rem;">Kol</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #f44336; font-size: 1.2rem; font-weight: bold;">${challenge.battleStats.damageTaken || 0}</div>
                            <div style="color: #888; font-size: 0.7rem;">P콏ijat칳 DMG</div>
                        </div>
                    </div>
                `;
            }
            
            logHtml += `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>`;
            
            showModal('游닆 Log boje', logHtml);
        }
        
        // Kontrola nov칳ch titul콢
        function checkPvPTitles() {
            initPvPStats();
            const newTitles = [];
            const stats = {
                pvpWins: state.pvp.wins,
                pvpWinStreak: state.pvp.winStreak,
                pvpComeback: state.pvp.comebacks,
                pvpFlawless: state.pvp.flawless,
                pvpMaxBetWon: state.pvp.maxBetWon,
                pvpElo: state.pvp.elo,
                pvpTournamentsWon: state.pvp.tournamentsWon
            };
            
            PVP_TITLES.forEach(title => {
                if (title.check(stats) && !state.pvp.titles.includes(title.id)) {
                    state.pvp.titles.push(title.id);
                    newTitles.push(title);
                }
            });
            
            return newTitles;
        }
        
        // Kontrola nov칳ch chat zpr치v
        let lastChatMessageCount = 0;
        function checkNewChatMessages() {
            const myName = getPlayerName();
            const newMessages = chatMessages.filter(m => m.author !== myName);
            
            if (newMessages.length > lastChatMessageCount && lastChatMessageCount > 0) {
                const lastMsg = newMessages[newMessages.length - 1];
                
                // Zkontroluj jestli m캩 n캩kdo ozna캜il (@mention)
                const isMentioned = lastMsg.text && lastMsg.text.toLowerCase().includes('@' + myName.toLowerCase());
                
                if (isMentioned) {
                    // Speci치ln칤 notifikace kdy m캩 n캩kdo ozna캜il
                    notifySuccess('游닉 ' + lastMsg.author + ' t캩 ozna캜il!', lastMsg.text.substring(0, 50));
                    
                    // P콏ehr치t zvuk pokud existuje
                    if (typeof SoundSystem !== 'undefined' && SoundSystem.play) {
                        SoundSystem.play('notification');
                    }
                } else {
                    // B캩쬹치 notifikace o nov칠 zpr치v캩
                    notifySuccess('游눫 ' + lastMsg.author, lastMsg.text.substring(0, 50));
                }
            }
            
            lastChatMessageCount = newMessages.length;
        }
        
        function showPvPChallengeNotification(challenge) {
            // Tato funkce je nahrazena showFullscreenPvPChallenge
        }
        
        // 游늵 PvP BOJOV칄 STATISTIKY - POU콯칈V츼 SKUTE캛N칄 HERN칈 BONUSY
        function getPlayerCombatStats() {
            initPvPStats();
            
            // Pou쬴j stejn칠 v칳po캜ty jako v PvE boji
            const damage = typeof calculateDamage === 'function' ? calculateDamage() : 10;
            const defense = typeof calculateDefense === 'function' ? calculateDefense() : 5;
            const critChance = typeof calculateCritChance === 'function' ? Math.round(calculateCritChance() * 100) : 5;
            const dodgeChance = typeof calculateDodgeChance === 'function' ? Math.round(calculateDodgeChance() * 100) : 2;
            
            // Max HP - pou쬴j aktu치ln칤 max HP v캜etn캩 v코ech bonus콢
            const maxHp = state.maxHp || state.char.maxHp || 100;
            
            // Vybaven칤 pro zobrazen칤
            const weapon = state.equipped?.weapon;
            const armor = state.equipped?.armor;
            const helmet = state.equipped?.helmet;
            const gloves = state.equipped?.gloves;
            const boots = state.equipped?.boots;
            
            // Speci치ln칤 efekty z vybaven칤
            const armorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : {};
            
            // Mutace
            const mutations = state.mutations || [];
            const hasBerserkerBlood = mutations.includes('berserker_blood');
            const hasThickSkin = mutations.includes('thick_skin');
            const hasSixthSense = mutations.includes('sixth_sense');
            
            // Class info
            const classId = state.char.classId || 'survivor';
            const className = getClassName(classId);
            
            // Block 코ance (z rukavic a skill tree)
            let blockChance = 0;
            if (gloves?.special === 'block_bonus') blockChance += 10;
            if (gloves?.special === 'block') blockChance += 15;
            // Skill tree bonus je v desetinn칠m form치tu (0.1 = 10%), n치sob칤me 100
            blockChance += (getSkillTreeBonus('blockChance') || 0) * 100;
            
            // Lifesteal (z mutac칤 nebo vybaven칤)
            let lifesteal = 0;
            if (mutations.includes('vampiric_touch')) lifesteal += 10;
            
            // Regenerace (z nano armor)
            let regenPerRound = 0;
            if (armor?.special === 'nano') regenPerRound = 2;
            
            // Phoenix efekt (1x p콏e쬴t칤 smrteln칠ho z치sahu)
            const hasPhoenix = armor?.special === 'phoenix';
            
            // Titan efekt (imunita na crit)
            const hasTitanArmor = armor?.special === 'titan';
            
            // Poison bonus z gloves
            const hasPoisonPunch = gloves?.special === 'bleed_punch';
            
            // Extra damage z gloves
            let gloveDamage = 0;
            if (gloves?.special === 'power_punch') gloveDamage = 10;
            if (gloves?.special === 'grip') gloveDamage = 2;
            if (gloves?.special === 'bleed_punch') gloveDamage = 3;
            
            // Extra damage z boots
            let bootDamage = 0;
            if (boots?.special === 'stomp') bootDamage = 8;
            
            return {
                name: getPlayerName(),
                hp: maxHp,
                maxHp: maxHp,
                damage: damage + gloveDamage + bootDamage,
                defense: defense,
                critChance: critChance,
                dodgeChance: dodgeChance,
                blockChance: blockChance,
                lifesteal: lifesteal,
                regenPerRound: regenPerRound,
                hasPhoenix: hasPhoenix,
                phoenixUsed: false,
                hasTitanArmor: hasTitanArmor,
                hasPoisonPunch: hasPoisonPunch,
                hasBerserkerBlood: hasBerserkerBlood,
                level: state.char.level,
                elo: state.pvp?.elo || 1000,
                classId: classId,
                className: className,
                weapon: weapon?.name || 'P캩sti',
                armor: armor?.name || '콯치dn치',
                // Pro zobrazen칤 v profilu
                mutations: mutations,
                equipped: {
                    weapon: weapon,
                    armor: armor,
                    helmet: helmet,
                    gloves: gloves,
                    boots: boots
                }
            };
        }
        
        // Pomocn치 funkce pro n치zev classy
        function getClassName(classId) {
            const classNames = {
                survivor: 'P콏e쬴v코칤',
                raider: 'N치jezdn칤k',
                berserker: 'Berserk',
                scout: 'Zv캩d',
                medic: 'Medik',
                engineer: 'In쬰n칳r',
                sniper: 'Odst콏elova캜',
                assassin: 'Zabij치k',
                tank: 'Tank',
                mutant: 'Mutant'
            };
            return classNames[classId] || classId;
        }
        
        // 游꿢 VYTVO콎EN칈 V칗ZVY - PvP je ZDARMA
        async function createPvPChallenge(targetName, bet = 0, mode = 'standard') {
            if (!multiplayerEnabled || !firebaseDB) {
                console.log('仇 createPvPChallenge: multiplayer not enabled or no firebaseDB');
                return;
            }
            
            initPvPStats();
            const myName = getPlayerName();
            
            console.log('丘덢잺 createPvPChallenge called:', { targetName, bet, mode, myName });
            
            // Kontrola - u m치m pending v칳zvu? (pvpChallenges m콢쬰 b칳t undefined)
            const challenges = pvpChallenges || [];
            const existingChallenge = challenges.find(c => 
                c.challenger === myName && c.status === 'pending'
            );
            if (existingChallenge) {
                notifyWarning('낍 캛ekej na odpov캩캞', `U m치코 aktivn칤 v칳zvu pro ${existingChallenge.target}. Po캜kej ne ji p콏ijme nebo odm칤tne.`);
                return;
            }
            
            const myStats = getPlayerCombatStats();
            console.log('丘덢잺 myStats:', myStats);
            
            // O코et콏en칤 dat pro Firebase - odstra켿 undefined hodnoty a funkce
            const cleanStats = {
                name: myStats.name || myName,
                level: myStats.level || 1,
                class: myStats.class || 'survivor',
                hp: myStats.hp || 100,
                maxHp: myStats.maxHp || 100,
                damage: myStats.damage || 10,
                defense: myStats.defense || 0,
                critChance: myStats.critChance || 5,
                dodgeChance: myStats.dodgeChance || 0,
                blockChance: myStats.blockChance || 0,
                elo: myStats.elo || 1000
            };
            
            const challenge = {
                challenger: myName,
                target: targetName,
                challengerStats: cleanStats,
                bet: bet || 0,
                mode: mode || 'standard',
                status: 'pending',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            console.log('丘덢잺 Sending challenge:', challenge);
            
            try {
                await firebaseDB.ref('pvp/challenges').push(challenge);
                notifySuccess('丘덢잺 V칳zva odesl치na!', `캛ek치m na odpov캩캞 od ${targetName}`);
                addLog(`Vyzval jsi ${targetName} k PvP souboji!`, '丘덢잺');
                console.log('九 Challenge sent successfully');
            } catch (err) {
                console.error('仇 createPvPChallenge error:', err);
                notifyWarning('Chyba', 'Nepoda콏ilo se odeslat v칳zvu: ' + (err.message || 'Nezn치m치 chyba'));
            }
        }
        
        // 丘덢잺 PvP BOJ - POU콯칈V츼 SKUTE캛N칄 BONUSY Z POSTAVY
        async function runPvPBattle(myStats, enemyStats, challenge) {
            return new Promise((resolve) => {
                let myHp = myStats.hp;
                let enemyHp = enemyStats.hp;
                let round = 0;
                let log = [];
                let myDamageDealt = 0;
                let damageTaken = 0;
                
                // Efekty b캩hem boje
                let myEffects = { poison: 0, bleed: 0 };
                let enemyEffects = { poison: 0, bleed: 0 };
                
                // Phoenix efekt (1x p콏e쬴t칤)
                let myPhoenixUsed = false;
                let enemyPhoenixUsed = false;
                
                const maxRounds = 30;
                
                while (myHp > 0 && enemyHp > 0 && round < maxRounds) {
                    round++;
                    
                    // === ZA캛츼TEK KOLA - DOT EFEKTY ===
                    // Jed/Krv치cen칤 na m캩
                    if (myEffects.poison > 0) {
                        const poisonDmg = Math.floor(myStats.maxHp * 0.03);
                        myHp -= poisonDmg;
                        damageTaken += poisonDmg;
                        myEffects.poison--;
                        log.push({ round, actor: '驕멆잺', text: `Jed: -${poisonDmg} HP (${myStats.name})` });
                    }
                    if (myEffects.bleed > 0) {
                        const bleedDmg = Math.floor(myStats.maxHp * 0.02);
                        myHp -= bleedDmg;
                        damageTaken += bleedDmg;
                        myEffects.bleed--;
                        log.push({ round, actor: '游뽖', text: `Krv치cen칤: -${bleedDmg} HP (${myStats.name})` });
                    }
                    
                    // Jed/Krv치cen칤 na soupe콏e
                    if (enemyEffects.poison > 0) {
                        const poisonDmg = Math.floor(enemyStats.maxHp * 0.03);
                        enemyHp -= poisonDmg;
                        myDamageDealt += poisonDmg;
                        enemyEffects.poison--;
                        log.push({ round, actor: '驕멆잺', text: `Jed: -${poisonDmg} HP (${enemyStats.name})` });
                    }
                    if (enemyEffects.bleed > 0) {
                        const bleedDmg = Math.floor(enemyStats.maxHp * 0.02);
                        enemyHp -= bleedDmg;
                        myDamageDealt += bleedDmg;
                        enemyEffects.bleed--;
                        log.push({ round, actor: '游뽖', text: `Krv치cen칤: -${bleedDmg} HP (${enemyStats.name})` });
                    }
                    
                    // Regenerace (nano armor)
                    if (myStats.regenPerRound > 0 && myHp < myStats.maxHp) {
                        const regen = Math.min(myStats.regenPerRound, myStats.maxHp - myHp);
                        myHp += regen;
                        log.push({ round, actor: '游눜', text: `Nano regenerace: +${regen} HP (${myStats.name})` });
                    }
                    if (enemyStats.regenPerRound > 0 && enemyHp < enemyStats.maxHp) {
                        const regen = Math.min(enemyStats.regenPerRound, enemyStats.maxHp - enemyHp);
                        enemyHp += regen;
                        log.push({ round, actor: '游눜', text: `Nano regenerace: +${regen} HP (${enemyStats.name})` });
                    }
                    
                    if (myHp <= 0 || enemyHp <= 0) break;
                    
                    // === M콡J TAH ===
                    const myAttackResult = executePvPAttack(myStats, enemyStats, enemyHp, myHp, enemyEffects);
                    
                    if (myAttackResult.dodged) {
                        log.push({ round, actor: enemyStats.name, text: `游눧 Vyhnul se 칰toku!` });
                    } else if (myAttackResult.blocked) {
                        log.push({ round, actor: enemyStats.name, text: `游띠勇 Zablokoval 칰tok!` });
                    } else {
                        enemyHp -= myAttackResult.damage;
                        myDamageDealt += myAttackResult.damage;
                        
                        let logText = `丘덢잺 ${myStats.name} 칰to캜칤: ${myAttackResult.damage} DMG`;
                        if (myAttackResult.crit) logText += ' 游눤CRIT!';
                        if (myAttackResult.berserker) logText += ' 游땫';
                        log.push({ round, actor: myStats.name, text: logText });
                        
                        // Lifesteal
                        if (myStats.lifesteal > 0) {
                            const stolen = Math.floor(myAttackResult.damage * myStats.lifesteal / 100);
                            myHp = Math.min(myStats.maxHp, myHp + stolen);
                            log.push({ round, actor: '游빁', text: `Vys치t칤: +${stolen} HP` });
                        }
                        
                        // Aplikuj efekty (bleed z gloves)
                        if (myAttackResult.applyBleed) {
                            enemyEffects.bleed = 3;
                            log.push({ round, actor: '游뽖', text: `${enemyStats.name} krv치c칤!` });
                        }
                    }
                    
                    // Phoenix efekt pro soupe콏e
                    if (enemyHp <= 0 && enemyStats.hasPhoenix && !enemyPhoenixUsed) {
                        enemyPhoenixUsed = true;
                        enemyHp = 1;
                        log.push({ round, actor: '游댠', text: `F칄NIX! ${enemyStats.name} p콏e쬴l smrteln칳 z치sah!` });
                    }
                    
                    if (enemyHp <= 0) break;
                    
                    // === SOUPE콎콡V TAH ===
                    const enemyAttackResult = executePvPAttack(enemyStats, myStats, myHp, enemyHp, myEffects);
                    
                    if (enemyAttackResult.dodged) {
                        log.push({ round, actor: myStats.name, text: `游눧 Vyhnul se 칰toku!` });
                    } else if (enemyAttackResult.blocked) {
                        log.push({ round, actor: myStats.name, text: `游띠勇 Zablokoval 칰tok!` });
                    } else {
                        // Titan armor - imunita na crit
                        let finalDmg = enemyAttackResult.damage;
                        if (myStats.hasTitanArmor && enemyAttackResult.crit) {
                            finalDmg = Math.floor(finalDmg / 1.5); // Zru코칤 crit bonus
                            log.push({ round, actor: '游띠勇', text: `Tit치n: Kritick칳 z치sah zablokov치n!` });
                        }
                        
                        myHp -= finalDmg;
                        damageTaken += finalDmg;
                        
                        let logText = `丘덢잺 ${enemyStats.name} 칰to캜칤: ${finalDmg} DMG`;
                        if (enemyAttackResult.crit && !myStats.hasTitanArmor) logText += ' 游눤CRIT!';
                        log.push({ round, actor: enemyStats.name, text: logText });
                        
                        // Lifesteal pro soupe콏e
                        if (enemyStats.lifesteal > 0) {
                            const stolen = Math.floor(finalDmg * enemyStats.lifesteal / 100);
                            enemyHp = Math.min(enemyStats.maxHp, enemyHp + stolen);
                        }
                        
                        // Aplikuj efekty
                        if (enemyAttackResult.applyBleed) {
                            myEffects.bleed = 3;
                            log.push({ round, actor: '游뽖', text: `${myStats.name} krv치c칤!` });
                        }
                    }
                    
                    // Phoenix efekt pro m캩
                    if (myHp <= 0 && myStats.hasPhoenix && !myPhoenixUsed) {
                        myPhoenixUsed = true;
                        myHp = 1;
                        log.push({ round, actor: '游댠', text: `F칄NIX! ${myStats.name} p콏e쬴l smrteln칳 z치sah!` });
                    }
                }
                
                const iWon = enemyHp <= 0 || (myHp > 0 && myHp > enemyHp);
                
                resolve({
                    iWon,
                    myFinalHp: Math.max(0, myHp),
                    enemyFinalHp: Math.max(0, enemyHp),
                    rounds: round,
                    log,
                    myDamageDealt,
                    damageTaken
                });
            });
        }
        
        // Proveden칤 칰toku s v코emi bonusy
        function executePvPAttack(attacker, defender, defenderHp, attackerHp, defenderEffects) {
            // Dodge 코ance
            if (Math.random() * 100 < (defender.dodgeChance || 0)) {
                return { dodged: true, damage: 0 };
            }
            
            // Block 코ance
            if (Math.random() * 100 < (defender.blockChance || 0)) {
                return { blocked: true, damage: 0 };
            }
            
            // Z치kladn칤 damage
            let damage = attacker.damage || 10;
            let isCrit = false;
            let isBerserker = false;
            let applyBleed = false;
            
            // Berserker blood mutace (+25% damage pod 50% HP)
            if (attacker.hasBerserkerBlood && attackerHp < attacker.maxHp * 0.5) {
                damage = Math.floor(damage * 1.25);
                isBerserker = true;
            }
            
            // Crit 코ance
            if (Math.random() * 100 < (attacker.critChance || 5)) {
                damage = Math.floor(damage * 1.5);
                isCrit = true;
            }
            
            // Aplikuj obranu soupe콏e
            const defReduction = Math.floor((defender.defense || 0) * 0.5);
            damage = Math.max(1, damage - defReduction);
            
            // Bleed z gloves
            if (attacker.hasPoisonPunch && Math.random() < 0.3) {
                applyBleed = true;
            }
            
            return {
                damage,
                crit: isCrit,
                berserker: isBerserker,
                applyBleed,
                dodged: false,
                blocked: false
            };
        }
        
        // 丘덢잺 P콎IJET칈 V칗ZVY
        async function acceptPvPChallenge(challengeId) {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Chyba', 'Multiplayer nen칤 aktivn칤');
                return;
            }
            
            initPvPStats();
            const challenge = pvpChallenges.find(c => c.id === challengeId);
            if (!challenge) {
                notifyWarning('Chyba', 'V칳zva nenalezena');
                return;
            }
            
            if (challenge.bet > state.money) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot콏ebuje코 ${challenge.bet} 游눯`);
                return;
            }
            
            // Zobraz loading
            showModal('丘덢잺 BOJ PROB칈H츼...', `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; animation: swordClash 0.5s infinite;">丘덢잺</div>
                    <p style="color: #ff9800; margin-top: 1rem;">Bojuje코 s ${escapeHtml(challenge.challenger)}...</p>
                    <div class="loading-spinner" style="margin: 1rem auto;"></div>
                </div>
                <style>
                    @keyframes swordClash { 0%,100%{transform:rotate(0)} 50%{transform:rotate(15deg)} }
                </style>
            `);
            
            try {
                const myStats = getPlayerCombatStats();
                const enemyStats = challenge.challengerStats;
                
                // Spus콘 boj
                const battleResult = await runPvPBattle(myStats, enemyStats, challenge);
                
                // V칳po캜et ELO
                const eloChange = calculateEloChange(myStats.elo, enemyStats.elo, battleResult.iWon);
                
                // Aktualizuj lok치ln칤 stats
                if (battleResult.iWon) {
                    state.pvp.wins++;
                    state.pvp.winStreak++;
                    state.pvp.maxWinStreak = Math.max(state.pvp.maxWinStreak, state.pvp.winStreak);
                    addMoney(challenge.bet);
                    state.pvp.maxBetWon = Math.max(state.pvp.maxBetWon, challenge.bet);
                    
                    if (battleResult.myFinalHp < myStats.maxHp * 0.1) state.pvp.comebacks++;
                    if (battleResult.myFinalHp >= myStats.maxHp) state.pvp.flawless++;
                    
                    // Denn칤 bonus - prvn칤 v칳hra dne
                    const today = new Date().toDateString();
                    if (state.pvp.lastDailyBonus !== today) {
                        state.pvp.lastDailyBonus = today;
                        addXP(50);
                        addMoney(25);
                        notifySuccess('游꾸 Denn칤 PvP bonus!', '+50 XP, +25 游눯');
                    }
                    
                    // Win streak bonus
                    if (state.pvp.winStreak >= 3) {
                        const streakBonus = Math.min(100, state.pvp.winStreak * 10);
                        addXP(streakBonus);
                        notifySuccess(`游댠 Win streak x${state.pvp.winStreak}!`, `+${streakBonus} XP`);
                    }
                    
                    notifySuccess('丘덢잺 V칈T캨ZSTV칈!', `+${challenge.bet} 游눯 | ELO +${eloChange}`);
                } else {
                    state.pvp.losses++;
                    state.pvp.winStreak = 0;
                    removeMoney(challenge.bet);
                    
                    notifyWarning('丘덢잺 Prohra', `-${challenge.bet} 游눯 | ELO ${eloChange}`);
                }
                
                state.pvp.elo = Math.max(0, state.pvp.elo + eloChange);
                state.pvp.totalDamageDealt += battleResult.myDamageDealt;
                state.pvp.totalDamageReceived += battleResult.damageTaken;
                
                // Ulo do Firebase
                await firebaseDB.ref('pvp/challenges/' + challengeId).update({
                    status: 'completed',
                    targetStats: myStats,
                    winner: battleResult.iWon ? getPlayerName() : challenge.challenger,
                    loser: battleResult.iWon ? challenge.challenger : getPlayerName(),
                    log: battleResult.log,
                    battleStats: {
                        rounds: battleResult.rounds,
                        myDamage: battleResult.myDamageDealt,
                        damageTaken: battleResult.damageTaken,
                        winnerHp: battleResult.iWon ? battleResult.myFinalHp : battleResult.enemyFinalHp
                    },
                    eloChange: Math.abs(eloChange),
                    completedAt: firebase.database.ServerValue.TIMESTAMP,
                    notified: false
                });
                
                saveGame();
                closeModal();
                
                // Zobraz v칳sledek okam쬴t캩
                const resultChallenge = {
                    ...challenge,
                    winner: battleResult.iWon ? getPlayerName() : challenge.challenger,
                    log: battleResult.log,
                    battleStats: {
                        rounds: battleResult.rounds,
                        myDamage: battleResult.myDamageDealt,
                        damageTaken: battleResult.damageTaken
                    },
                    eloChange: Math.abs(eloChange)
                };
                
                setTimeout(() => {
                    showPvPResultDirect(resultChallenge, battleResult.iWon, eloChange);
                }, 300);
                
            } catch (error) {
                console.error('PvP Error:', error);
                closeModal();
                notifyWarning('Chyba', 'N캩co se pokazilo: ' + error.message);
            }
        }
        
        // P콏칤m칠 zobrazen칤 v칳sledku (ne p콏es listener)
        function showPvPResultDirect(challenge, iWon, eloChange) {
            const myName = getPlayerName();
            const opponent = challenge.challenger === myName ? challenge.target : challenge.challenger;
            const myNewElo = state.pvp.elo;
            const newRank = getPvPRank(myNewElo);
            const newTitles = checkPvPTitles();
            
            const html = `
                <div id="pvpResultOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.98); z-index: 99999; display: flex; align-items: center; justify-content: center; padding: 1rem; animation: pvpFadeIn 0.3s;">
                    <div style="background: linear-gradient(135deg, ${iWon ? '#1a3a1a' : '#3a1a1a'} 0%, #0a0a0a 100%); border: 2px solid ${iWon ? '#4CAF50' : '#f44336'}; border-radius: 16px; padding: 1.2rem; max-width: 340px; width: 100%; text-align: center; animation: resultBounce 0.6s;">
                        
                        <div style="font-size: 3rem; margin-bottom: 0.5rem; animation: ${iWon ? 'victoryAnim' : 'defeatAnim'} 1s;">
                            ${iWon ? '游끥' : '游'}
                        </div>
                        
                        <h2 style="color: ${iWon ? '#4CAF50' : '#f44336'}; margin: 0 0 0.3rem 0; font-size: 1.4rem; text-shadow: 0 0 20px ${iWon ? 'rgba(76,175,80,0.8)' : 'rgba(244,67,54,0.8)'};">
                            ${iWon ? 'V칈T캨ZSTV칈!' : 'PROHRA!'}
                        </h2>
                        
                        <p style="color: #888; margin: 0.3rem 0; font-size: 0.85rem;">vs <strong style="color: #fff;">${opponent}</strong></p>
                        
                        <div style="background: ${iWon ? 'linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%)' : 'linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%)'}; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${iWon ? '#4CAF50' : '#f44336'};">
                            <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.8rem; font-weight: bold;">
                                ${iWon ? '+' : '-'}${challenge.bet} 游눯
                            </div>
                        </div>
                        
                        <div style="background: #1a1a2a; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${newRank.color};">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 0.8rem;">
                                <div style="text-align: center;">
                                    <div style="color: #888; font-size: 0.7rem;">ELO</div>
                                    <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.2rem; font-weight: bold;">
                                        ${iWon ? '+' : ''}${eloChange}
                                    </div>
                                </div>
                                <div style="color: #555; font-size: 1.3rem;"></div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2rem;">${newRank.icon}</div>
                                    <div style="color: ${newRank.color}; font-weight: bold; font-size: 1.1rem;">${myNewElo}</div>
                                    <div style="color: ${newRank.color}; font-size: 0.7rem;">${newRank.name}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${challenge.battleStats ? `
                            <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin: 0.7rem 0;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; font-size: 0.75rem;">
                                    <div><span style="color: #888;">Kola</span><br><span style="color: #fff;">${challenge.battleStats.rounds}</span></div>
                                    <div><span style="color: #888;">DMG</span><br><span style="color: #ff9800;">${challenge.battleStats.myDamage}</span></div>
                                    <div><span style="color: #888;">P콏ijato</span><br><span style="color: #f44336;">${challenge.battleStats.damageTaken}</span></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${newTitles.length > 0 ? `
                            <div style="background: linear-gradient(135deg, #3a2a0a 0%, #2a1a00 100%); padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid #ffd700;">
                                <div style="color: #ffd700; font-weight: bold; margin-bottom: 0.3rem; font-size: 0.85rem;">游끤 NOV칗 TITUL!</div>
                                ${newTitles.map(t => `<div style="font-size: 1rem;">${t.icon} ${t.name}</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button onclick="closePvPResultAndShowLog('${challenge.id}')" style="background: #333; color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                游닆 Log
                            </button>
                            <button onclick="closePvPResultAndShowArena()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                丘덢잺 Dal코칤
                            </button>
                        </div>
                        
                        <button onclick="document.getElementById('pvpResultOverlay')?.remove()" style="background: transparent; color: #666; border: none; padding: 0.4rem; margin-top: 0.3rem; cursor: pointer; font-family: inherit; width: 100%; font-size: 0.8rem;">
                            Zav콏칤t
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            if (typeof SoundSystem !== 'undefined') SoundSystem.play(iWon ? 'victory' : 'damage');
            renderFull();
        }
        
        function closePvPResultAndShowLog(challengeId) {
            document.getElementById('pvpResultOverlay')?.remove();
            showPvPBattleLog(challengeId);
        }
        
        function closePvPResultAndShowArena() {
            document.getElementById('pvpResultOverlay')?.remove();
            showPvPArena();
        }
        
        async function declinePvPChallenge(challengeId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            await firebaseDB.ref('pvp/challenges/' + challengeId).update({
                status: 'declined'
            });
            
            notifySuccess('V칳zva odm칤tnuta', '');
            showPvPArena();
        }
        
        function showPvPArena() {
            initPvPStats();
            
            if (!multiplayerEnabled) {
                showModal('丘덢잺 PvP AR칄NA', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游勇</div>
                        <h3 style="color: #ff9800;">Multiplayer nen칤 aktivn칤</h3>
                        <p style="color: #888; margin-top: 0.5rem;">Zapni multiplayer pro p콏칤stup do ar칠ny.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const myName = getPlayerName();
            const myStats = getPlayerCombatStats();
            const myRank = getPvPRank(state.pvp?.elo || 1000);
            const totalGames = (state.pvp?.wins || 0) + (state.pvp?.losses || 0);
            const winRate = totalGames > 0 ? Math.round((state.pvp.wins / totalGames) * 100) : 0;
            
            // Moje v칳zvy
            const pendingForMe = pvpChallenges.filter(c => c.target === myName && c.status === 'pending');
            const myPending = pvpChallenges.filter(c => c.challenger === myName && c.status === 'pending');
            
            // Denn칤 bonus - lze z칤skat 1x denn캩 za prvn칤 boj
            const today = new Date().toDateString();
            const hadDailyBonus = state.pvp?.lastDailyBonus === today;
            
            let html = `
                <!-- 游꿌勇 PLAYER CARD -->
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 1.2rem; border-radius: 15px; margin-bottom: 1rem; border: 2px solid ${myRank.color}; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 120px; height: 120px; background: radial-gradient(circle, ${myRank.color}33 0%, transparent 70%);"></div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; position: relative; z-index: 1;">
                        <div style="font-size: 2.5rem; filter: drop-shadow(0 0 10px ${myRank.color});">${myRank.icon}</div>
                        <div style="flex: 1;">
                            <div style="color: ${myRank.color}; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px;">${myRank.name}</div>
                            <div style="color: #fff; font-size: 1.2rem; font-weight: bold;">${myName}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${myRank.color}; font-size: 2rem; font-weight: bold; text-shadow: 0 0 10px ${myRank.color};">${state.pvp?.elo || 1000}</div>
                            <div style="color: #888; font-size: 0.7rem;">ELO RATING</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; background: rgba(0,0,0,0.3); padding: 0.6rem; border-radius: 8px;">
                        <div style="text-align: center;"><div style="color: #8bc34a; font-weight: bold;">${state.pvp?.wins || 0}</div><div style="color: #666; font-size: 0.65rem;">WINS</div></div>
                        <div style="text-align: center;"><div style="color: #f44336; font-weight: bold;">${state.pvp?.losses || 0}</div><div style="color: #666; font-size: 0.65rem;">LOSSES</div></div>
                        <div style="text-align: center;"><div style="color: #ffd700; font-weight: bold;">${winRate}%</div><div style="color: #666; font-size: 0.65rem;">WINRATE</div></div>
                        <div style="text-align: center;"><div style="color: #ff9800; font-weight: bold;">游댠${state.pvp?.winStreak || 0}</div><div style="color: #666; font-size: 0.65rem;">STREAK</div></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.3rem; margin-top: 0.6rem; text-align: center; font-size: 0.8rem;">
                        <div><span style="color: #ff6b6b;">仇벒잺</span>${myStats.hp}</div>
                        <div><span style="color: #ff9800;">丘덢잺</span>${myStats.damage}</div>
                        <div><span style="color: #2196f3;">游띠勇</span>${myStats.defense}</div>
                        <div><span style="color: #e91e63;">游눤</span>${myStats.critChance}%</div>
                        <div><span style="color: #8bc34a;">游눧</span>${myStats.dodgeChance}%</div>
                    </div>
                </div>
                
                <!-- 游꾸 DENN칈 BONUS -->
                ${!hadDailyBonus ? `
                <div style="background: linear-gradient(135deg, #3a3a0a 0%, #2a2a00 100%); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ffd700; animation: goldPulse 2s infinite;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="color: #ffd700; font-weight: bold;">游꾸 Denn칤 PvP bonus!</div>
                            <div style="color: #888; font-size: 0.8rem;">Zahraj si dnes a z칤skej +50 XP a +25 游눯</div>
                        </div>
                        <div style="color: #ffd700; font-size: 1.5rem;">游꿢</div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // V칳zvy pro m캩
            if (pendingForMe.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #3a2a1a 0%, #2a1a0a 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #ff9800; animation: challengePulse 2s infinite;">
                        <h4 style="color: #ff9800; margin: 0 0 0.8rem 0;">丘덢잺 V칳zvy k boji (${pendingForMe.length})</h4>
                `;
                pendingForMe.forEach(challenge => {
                    const challengerRank = getPvPRank(challenge.challengerStats?.elo || 1000);
                    html += `
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; margin-bottom: 0.5rem; border-left: 4px solid ${challengerRank.color};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.3rem;">${challengerRank.icon}</span>
                                    <div>
                                        <div style="color: #fff; font-weight: bold;">${escapeHtml(challenge.challenger)}</div>
                                        <div style="font-size: 0.75rem; color: ${challengerRank.color};">${challengerRank.name}  ELO ${challenge.challengerStats?.elo || 1000}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ffd700; font-weight: bold; font-size: 1.2rem;">${challenge.bet} 游눯</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; font-size: 0.75rem; margin-bottom: 0.5rem; background: #0a0a0a; padding: 0.4rem; border-radius: 6px;">
                                <div>仇벒잺${challenge.challengerStats?.hp || '?'}</div>
                                <div>丘덢잺${challenge.challengerStats?.damage || '?'}</div>
                                <div>游띠勇${challenge.challengerStats?.defense || '?'}</div>
                                <div>Lvl ${challenge.challengerStats?.level || '?'}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="btn" onclick="acceptPvPChallenge('${challenge.id}')" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%); padding: 0.7rem;">丘덢잺 BOJOVAT!</button>
                                <button class="btn" onclick="declinePvPChallenge('${challenge.id}')" style="background: #444;">仇 Odm칤tnout</button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>
                <style>
                    @keyframes challengePulse { 0%, 100% { box-shadow: 0 0 5px rgba(255,152,0,0.3); } 50% { box-shadow: 0 0 20px rgba(255,152,0,0.6); } }
                </style>`;
            }
            
            // Moje odeslan칠 v칳zvy
            if (myPending.length > 0) {
                html += `<div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #888; margin: 0 0 0.5rem 0;">낍 캛ekaj칤c칤 v칳zvy</h4>`;
                myPending.forEach(challenge => {
                    if (!challenge.target) return;
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem; background: #0a0a0a; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="color: #888;"> ${escapeHtml(challenge.target) || '???'}</span>
                            <span style="color: #ffd700;">${challenge.bet || 0} 游눯</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // HLAVN칈 MENU TLA캛칈TKA
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="showChallengePlayer()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem; border-radius: 12px;">
                        <div style="font-size: 1.5rem;">丘덢잺</div>
                        <div style="font-size: 0.85rem; font-weight: bold;">Vyzvat hr치캜e</div>
                    </button>
                    <button class="btn" onclick="showQuickMatchmaking()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 1rem; border-radius: 12px;">
                        <div style="font-size: 1.5rem;">游</div>
                        <div style="font-size: 0.85rem; font-weight: bold;">Rychl칳 souboj</div>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="showPvPLeaderboard()" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); color: #000; padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">游끥</div>
                        <div style="font-size: 0.75rem;">콯eb콏칤캜ek</div>
                    </button>
                    <button class="btn" onclick="showPvPTitles()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">游끤</div>
                        <div style="font-size: 0.75rem;">Tituly</div>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showPvPMyBuild()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">游녻</div>
                        <div style="font-size: 0.75rem;">Moje postava</div>
                    </button>
                    <button class="btn" onclick="showPvPHistory()" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">游닆</div>
                        <div style="font-size: 0.75rem;">Historie</div>
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #333;"> Zav콏칤t</button>
            `;
            
            showModal('丘덢잺 PvP AR칄NA', html);
        }
        
        // 游 RYCHL칗 MATCHMAKING - najde n치hodn칠ho soupe콏e podobn칠ho ELO
        async function showQuickMatchmaking() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            initPvPStats();
            const myName = getPlayerName();
            const myElo = state.pvp?.elo || 1000;
            
            showModal('游 Hled치m soupe콏e...', `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; animation: spin 1s linear infinite;">游</div>
                    <p style="color: #9c27b0; margin-top: 1rem;">Hled치m soupe콏e s podobn칳m ELO...</p>
                    <p style="color: #666; font-size: 0.85rem;">Tv칠 ELO: ${myElo}</p>
                    <div class="loading-spinner" style="margin: 1rem auto;"></div>
                </div>
                <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
            `);
            
            try {
                // Na캜ti online hr치캜e - pou쬴j kl칤캜 jako fallback pro jm칠no
                const snapshot = await firebaseDB.ref('online').once('value');
                const onlineData = snapshot.val() || {};
                const onlinePlayers = Object.entries(onlineData)
                    .map(([key, val]) => ({
                        name: val?.name || key,
                        level: val?.level || 1
                    }))
                    .filter(p => p.name && p.name !== myName && p.name !== 'undefined');
                
                if (onlinePlayers.length === 0) {
                    showModal('游 Rychl칳 souboj', `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">游땞</div>
                            <p style="color: #888;">콯치dn칤 online hr치캜i...</p>
                            <p style="color: #666; font-size: 0.85rem;">Zkus to pozd캩ji nebo vyzvi p콏칤tele!</p>
                        </div>
                        <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>
                    `);
                    return;
                }
                
                // Na캜ti ELO v코ech hr치캜콢
                const leaderboardSnap = await firebaseDB.ref('leaderboard').once('value');
                const leaderboardData = leaderboardSnap.val() || {};
                
                // P콏i콏a캞 ELO k online hr치캜콢m a se콏a캞 podle vzd치lenosti od m칠ho ELO
                const playersWithElo = onlinePlayers.map(p => {
                    const playerData = leaderboardData[p.name] || {};
                    return {
                        ...p,
                        elo: playerData.pvpElo || 1000,
                        level: playerData.level || p.level || 1
                    };
                }).sort((a, b) => Math.abs(a.elo - myElo) - Math.abs(b.elo - myElo));
                
                // Vyber n치hodn캩 z top 3 nejbli쮄뫆셖h (nebo m칠n캩 pokud jich je m칠n캩)
                const candidates = playersWithElo.slice(0, Math.min(3, playersWithElo.length));
                const opponent = candidates[Math.floor(Math.random() * candidates.length)];
                const opponentRank = getPvPRank(opponent.elo);
                
                // Doporu캜en치 s치zka podle ELO
                const suggestedBet = Math.min(500, Math.floor(myElo / 10));
                
                setTimeout(() => {
                    showModal('游 Soupe콏 nalezen!', `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2rem; animation: foundAnim 0.5s;">游꿢</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #2a1a3a 0%, #1a0a2a 100%); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid ${opponentRank.color};">
                            <div style="text-align: center; margin-bottom: 0.8rem;">
                                <div style="font-size: 2rem;">${opponentRank.icon}</div>
                                <div style="color: ${opponentRank.color}; font-size: 0.8rem;">${opponentRank.name}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${escapeHtml(opponent.name)}</div>
                                <div style="color: #888; font-size: 0.85rem;">Level ${opponent.level}  ELO: <span style="color: ${opponentRank.color};">${opponent.elo}</span></div>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.8rem; color: #888; font-size: 0.85rem;">
                                <span>ELO rozd칤l: <span style="color: ${Math.abs(opponent.elo - myElo) < 100 ? '#4CAF50' : '#ff9800'};">${opponent.elo > myElo ? '+' : ''}${opponent.elo - myElo}</span></span>
                            </div>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                            <label style="color: #888; font-size: 0.85rem;">S치zka (0 = p콏치telsk칳 z치pas):</label>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="number" id="quickMatchBet" value="${suggestedBet}" min="0" max="${getMoney()}" 
                                    style="flex: 1; padding: 0.6rem; background: #0a0a0a; border: 1px solid #444; border-radius: 8px; color: #ffd700; font-size: 1.1rem; text-align: center;">
                                <button onclick="document.getElementById('quickMatchBet').value='0'" style="background: #333; border: none; padding: 0.6rem 1rem; border-radius: 8px; color: #888; cursor: pointer;">0</button>
                                <button onclick="document.getElementById('quickMatchBet').value='${Math.floor(getMoney()/2)}'" style="background: #333; border: none; padding: 0.6rem 1rem; border-radius: 8px; color: #888; cursor: pointer;">50%</button>
                            </div>
                            <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">Tv칠 pen칤ze: ${getMoney()} 游눯</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <button class="btn" onclick="showQuickMatchmaking()" style="background: #555;">游댃 Jin칳</button>
                            <button class="btn" onclick="sendQuickChallenge('${escapeHtml(opponent.name)}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">丘덢잺 Vyzvat!</button>
                        </div>
                        
                        <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 0.5rem; background: #333;"> Zp캩t</button>
                        
                        <style>@keyframes foundAnim { 0% { transform: scale(0) rotate(-180deg); } 100% { transform: scale(1) rotate(0); } }</style>
                    `);
                }, 1500);
                
            } catch (e) {
                console.error('Matchmaking error:', e);
                showPvPArena();
            }
        }
        
        function sendQuickChallenge(targetName) {
            const bet = parseInt(document.getElementById('quickMatchBet')?.value) || 0;
            if (bet > getMoney()) {
                notifyWarning('Nedostatek pen캩z', `M치코 jen ${getMoney()} 游눯`);
                return;
            }
            createPvPChallenge(targetName, bet);
            closeModal();
        }
        
        // 游녻 ZOBRAZEN칈 BUILDU POSTAVY PRO PvP
        function showPvPMyBuild() {
            const stats = getPlayerCombatStats();
            const rank = getPvPRank(stats.elo);
            
            let html = `
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid ${rank.color};">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2rem;">${rank.icon}</div>
                        <div style="color: ${rank.color}; font-weight: bold;">${stats.className}</div>
                        <div style="color: #fff; font-size: 1.2rem;">Level ${stats.level}</div>
                    </div>
                </div>
                
                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">丘덢잺 Bojov칠 statistiky</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">仇벒잺 HP</span>
                            <span style="color: #ff6b6b; font-weight: bold;">${stats.maxHp}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">丘덢잺 칔tok</span>
                            <span style="color: #ff9800; font-weight: bold;">${stats.damage}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">游띠勇 Obrana</span>
                            <span style="color: #2196f3; font-weight: bold;">${stats.defense}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">游눤 Crit</span>
                            <span style="color: #e91e63; font-weight: bold;">${stats.critChance}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">游눧 칔hyb</span>
                            <span style="color: #8bc34a; font-weight: bold;">${stats.dodgeChance}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">游띠勇 Blok</span>
                            <span style="color: #9c27b0; font-weight: bold;">${stats.blockChance}%</span>
                        </div>
                    </div>
                </div>
                
                <h4 style="color: #4CAF50; margin: 0 0 0.5rem 0;">游 Vybaven칤</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
            `;
            
            const equipSlots = [
                { key: 'weapon', icon: '丘덢잺', name: 'Zbra켿' },
                { key: 'armor', icon: '游띠勇', name: 'Brn캩n칤' },
                { key: 'helmet', icon: '游뿠', name: 'Helma' },
                { key: 'gloves', icon: '游빇', name: 'Rukavice' },
                { key: 'boots', icon: '游녹', name: 'Boty' }
            ];
            
            equipSlots.forEach(slot => {
                const item = stats.equipped?.[slot.key];
                const special = item?.special ? SPECIAL_EFFECT_DETAILS[item.special] : null;
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: #0a0a0a; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.2rem;">${slot.icon}</span>
                        <div style="flex: 1;">
                            <div style="color: ${item ? '#fff' : '#555'};">${item?.name || '콯치dn칠'}</div>
                            ${special ? `<div style="color: ${special.color}; font-size: 0.7rem;">九 ${special.name}</div>` : ''}
                        </div>
                        ${item?.damage ? `<span style="color: #ff9800; font-size: 0.8rem;">+${item.damage} 丘덢잺</span>` : ''}
                        ${item?.defense ? `<span style="color: #2196f3; font-size: 0.8rem;">+${item.defense} 游띠勇</span>` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // Speci치ln칤 bonusy
            const bonuses = [];
            if (stats.hasPhoenix) bonuses.push({ icon: '游댠', name: 'F칠nix', desc: 'P콏e쬴je코 1x smrteln칳 z치sah' });
            if (stats.hasTitanArmor) bonuses.push({ icon: '游', name: 'Tit치n', desc: 'Imunita na kritick칠 z치sahy' });
            if (stats.lifesteal > 0) bonuses.push({ icon: '游빁', name: 'Vys치t칤 쬴vota', desc: `+${stats.lifesteal}% HP z damage` });
            if (stats.regenPerRound > 0) bonuses.push({ icon: '游눜', name: 'Nano regenerace', desc: `+${stats.regenPerRound} HP/kolo` });
            if (stats.hasBerserkerBlood) bonuses.push({ icon: '游땫', name: 'Krev berserkera', desc: '+25% DMG pod 50% HP' });
            if (stats.hasPoisonPunch) bonuses.push({ icon: '游뽖', name: 'Krvav칳 칰der', desc: 'Zp콢sobuje krv치cen칤' });
            
            if (bonuses.length > 0) {
                html += `<h4 style="color: #e91e63; margin: 0 0 0.5rem 0;">九 Speci치ln칤 bonusy v PvP</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">`;
                bonuses.forEach(b => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: #1a2a1a; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid #4CAF50;">
                            <span style="font-size: 1.2rem;">${b.icon}</span>
                            <div>
                                <div style="color: #8bc34a; font-weight: bold;">${b.name}</div>
                                <div style="color: #888; font-size: 0.75rem;">${b.desc}</div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Mutace
            if (stats.mutations && stats.mutations.length > 0) {
                html += `<h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">游빏 Aktivn칤 mutace</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">`;
                stats.mutations.forEach(m => {
                    html += `<span style="background: #1a3a1a; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; color: #8bc34a;">游빏 ${m}</span>`;
                });
                html += `</div></div>`;
            }
            
            html += `
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <p style="color: #888; font-size: 0.85rem; margin: 0; text-align: center;">
                        游눠 <strong>Tip:</strong> Vylep코i sv칠 vybaven칤, zvedni atributy a z칤skej mutace pro siln캩j코칤 PvP postavu!
                    </p>
                </div>
                
                <button class="btn" onclick="showPvPArena()" style="width: 100%; background: #333;"> Zp캩t do ar칠ny</button>
            `;
            
            showModal('游녻 Moje PvP postava', html);
        }
        
        // 游닆 HISTORIE PvP Z츼PAS콡
        async function showPvPHistory() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            showModal('游닆 Historie PvP', '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div></div>');
            
            try {
                const myName = getPlayerName();
                const snap = await firebaseDB.ref('pvp/challenges')
                    .orderByChild('completedAt')
                    .limitToLast(20)
                    .once('value');
                
                const allChallenges = [];
                snap.forEach(child => {
                    const c = child.val();
                    if (c.status === 'completed' && (c.challenger === myName || c.target === myName)) {
                        allChallenges.push({ ...c, id: child.key });
                    }
                });
                
                // Se콏a캞 od nejnov캩j코칤ch
                allChallenges.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
                
                if (allChallenges.length === 0) {
                    showModal('游닆 Historie PvP', `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">游닆</div>
                            <p style="color: #888;">Zat칤m 쮂멳n칠 z치pasy...</p>
                            <p style="color: #666; font-size: 0.85rem;">Vyzvi n캩koho k souboji!</p>
                        </div>
                        <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>
                    `);
                    return;
                }
                
                let html = `<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                allChallenges.slice(0, 15).forEach(c => {
                    const iWon = c.winner === myName;
                    const opponent = c.challenger === myName ? c.target : c.challenger;
                    const date = c.completedAt ? new Date(c.completedAt).toLocaleDateString('cs-CZ') : '?';
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: ${iWon ? '#1a2a1a' : '#2a1a1a'}; border-radius: 10px; margin-bottom: 0.5rem; border-left: 4px solid ${iWon ? '#4CAF50' : '#f44336'};">
                            <div style="font-size: 1.5rem;">${iWon ? '游끥' : '游'}</div>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-weight: bold;">${iWon ? 'V칳hra' : 'Prohra'} vs ${escapeHtml(opponent)}</div>
                                <div style="color: #888; font-size: 0.75rem;">${date}  ${c.battleStats?.rounds || '?'} kol</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-weight: bold;">${iWon ? '+' : '-'}${c.bet || 0} 游눯</div>
                                <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 0.8rem;">${iWon ? '+' : '-'}${c.eloChange || 0} ELO</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // Statistiky
                const wins = allChallenges.filter(c => c.winner === myName).length;
                const losses = allChallenges.length - wins;
                const totalEarned = allChallenges.filter(c => c.winner === myName).reduce((sum, c) => sum + (c.bet || 0), 0);
                const totalLost = allChallenges.filter(c => c.winner !== myName).reduce((sum, c) => sum + (c.bet || 0), 0);
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; margin-top: 1rem; background: #1a1a1a; padding: 0.8rem; border-radius: 10px; text-align: center; font-size: 0.8rem;">
                        <div><span style="color: #8bc34a; font-weight: bold;">${wins}</span><br><span style="color: #666;">V칳her</span></div>
                        <div><span style="color: #f44336; font-weight: bold;">${losses}</span><br><span style="color: #666;">Proher</span></div>
                        <div><span style="color: #8bc34a; font-weight: bold;">+${totalEarned}</span><br><span style="color: #666;">Z칤sk치no</span></div>
                        <div><span style="color: #f44336; font-weight: bold;">-${totalLost}</span><br><span style="color: #666;">Ztraceno</span></div>
                    </div>
                `;
                
                html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t</button>`;
                
                showModal('游닆 Historie PvP', html);
                
            } catch (e) {
                console.error('History error:', e);
                showPvPArena();
            }
        }
        
        async function showChallengePlayer() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Na캜ti online hr치캜e
            const snapshot = await firebaseDB.ref('online').once('value');
            const onlineData = snapshot.val() || {};
            const myName = getPlayerName();
            
            // P콏eve캞 na pole s kl칤캜em jako fallback pro jm칠no
            const onlinePlayers = Object.entries(onlineData)
                .map(([key, val]) => ({
                    name: val?.name || key,  // Pou쬴j name nebo kl칤캜 jako fallback
                    level: val?.level || 1,
                    location: val?.location || 'unknown'
                }))
                .filter(p => p.name && p.name !== myName && p.name !== 'undefined');
            
            if (onlinePlayers.length === 0) {
                showModal('游꿢 Vyzvat hr치캜e', `
                    <div style="text-align: center; padding: 2rem; color: #888;">
                        콯치dn칤 online hr치캜i k v칳zv캩...
                    </div>
                    <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;">Zp캩t</button>
                `);
                return;
            }
            
            let html = `
                <p style="color: #888; margin-bottom: 1rem;">Vyber hr치캜e a nastav s치zku:</p>
                <div style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem;">
            `;
            
            onlinePlayers.forEach(player => {
                const safeName = escapeHtml(player.name);
                html += `
                    <div onclick="selectPvPTarget('${safeName}')" id="pvp-${safeName}" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border: 2px solid transparent;">
                        <span style="color: #8bc34a;">游릭</span>
                        <div style="flex: 1;">
                            <div style="color: #fff;">${safeName}</div>
                            <div style="font-size: 0.75rem; color: #888;">Lvl ${player.level}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>
                <div style="margin-bottom: 1rem; text-align: center;">
                    <div style="color: #4CAF50; font-size: 1rem; padding: 0.5rem; background: #1a2a1a; border-radius: 8px;">
                        丘덢잺 PvP souboj je ZDARMA!
                    </div>
                </div>
                
                <button class="btn" onclick="confirmPvPChallenge()" id="pvpChallengeBtn" style="width: 100%; background: #555;" disabled>
                    游꿢 VYBER HR츼캛E
                </button>
                <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 0.5rem; background: #333;">Zp캩t</button>
            `;
            
            showModal('游꿢 Vyzvat k souboji', html);
        }
        
        let selectedPvPTarget = null;
        
        function selectPvPTarget(name) {
            selectedPvPTarget = name;
            
            // Vizu치ln칤 feedback
            document.querySelectorAll('[id^="pvp-"]').forEach(el => {
                el.style.borderColor = 'transparent';
                el.style.background = '#2a2a2a';
            });
            
            const selected = document.getElementById('pvp-' + name);
            if (selected) {
                selected.style.borderColor = '#ff5722';
                selected.style.background = '#3a2a1a';
            }
            
            const btn = document.getElementById('pvpChallengeBtn');
            if (btn) {
                btn.disabled = false;
                btn.style.background = '#ff5722';
                btn.textContent = `丘덢잺 Vyzvat ${name}`;
            }
        }
        
        function confirmPvPChallenge() {
            if (!selectedPvPTarget) return;
            
            // PvP je zdarma - bez s치zky
            createPvPChallenge(selectedPvPTarget, 0);
            closeModal();
        }
        
        // 游끥 PvP LEADERBOARD
        async function showPvPLeaderboard() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('游끥 PvP 콯eb콏칤캜ek', '<p style="color: #888; text-align: center;">' + ('Multiplayer nen칤 aktivn칤') + '</p><button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;">' + ('Zp캩t') + '</button>');
                return;
            }
            
            try {
                const snapshot = await firebaseDB.ref('leaderboard').orderByChild('pvpElo').limitToLast(20).once('value');
                const players = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if (data.pvpElo) players.push(data);
                });
                players.sort((a, b) => (b.pvpElo || 0) - (a.pvpElo || 0));
                
                let html = `
                    <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${players.length === 0 ? '<p style="color: #888; text-align: center;">Zat칤m 쮂멳n칤 hr치캜i</p>' : ''}
                        ${players.map((p, i) => {
                            const rank = getPvPRank(p.pvpElo || 1000);
                            const medal = i === 0 ? '游볞' : i === 1 ? '游볟' : i === 2 ? '游볠' : `#${i + 1}`;
                            const isMe = p.name === getPlayerName();
                            return `
                                <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: ${isMe ? 'linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%)' : '#1a1a1a'}; border-radius: 10px; margin-bottom: 0.5rem; border: ${isMe ? '2px solid #4CAF50' : '1px solid #333'};">
                                    <div style="font-size: 1.3rem; min-width: 35px; text-align: center;">${medal}</div>
                                    <div style="font-size: 1.5rem;">${rank.icon}</div>
                                    <div style="flex: 1;">
                                        <div style="color: #fff; font-weight: bold;">${escapeHtml(p.name)}${isMe ? ' (Ty)' : ''}</div>
                                        <div style="color: ${rank.color}; font-size: 0.8rem;">${rank.name}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${rank.color}; font-size: 1.3rem; font-weight: bold;">${p.pvpElo || 1000}</div>
                                        <div style="color: #888; font-size: 0.7rem;">ELO</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t do ar칠ny</button>`;
                showModal('游끥 PvP 콯eb콏칤캜ek', html);
            } catch (err) {
                console.error(err);
                showModal('游끥 PvP 콯eb콏칤캜ek', '<p style="color: #f44336;">' + ('Chyba na캜칤t치n칤') + '</p><button class="btn" onclick="showPvPArena()" style="width: 100%;">' + ('Zp캩t') + '</button>');
            }
        }
        
        // 九 PvP ABILITIES MENU
        function showPvPAbilities() {
            initPvPStats();
            const selectedAbilities = state.pvp?.selectedAbilities || ['powerStrike', 'dodge', 'heal', 'stun'];
            
            const categories = {
                attack: { name: '丘덢잺 칔to캜n칠', abilities: [] },
                defense: { name: '游띠勇 Obrann칠', abilities: [] },
                special: { name: '九 Speci치ln칤', abilities: [] }
            };
            
            Object.entries(PVP_ABILITIES).forEach(([id, ability]) => {
                if (ability.type && categories[ability.type]) {
                    categories[ability.type].abilities.push({ id, ...ability });
                }
            });
            
            let html = `
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">Vyber 4 schopnosti pro PvP boj:</p>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="color: #ffd700; font-size: 0.8rem; margin-bottom: 0.5rem;">VYBRAN칄 SCHOPNOSTI:</div>
                    <div id="selectedAbilitiesDisplay" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${selectedAbilities.map(id => {
                            const ab = PVP_ABILITIES[id];
                            return ab ? `<div style="background: #2a2a2a; padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.85rem;">${ab.icon} ${ab.name}</div>` : '';
                        }).join('')}
                    </div>
                </div>
            `;
            
            Object.entries(categories).forEach(([catId, cat]) => {
                if (cat.abilities.length === 0) return;
                html += `<h4 style="color: #888; margin: 1rem 0 0.5rem 0; font-size: 0.9rem;">${cat.name}</h4>`;
                html += `<div style="display: grid; gap: 0.4rem;">`;
                cat.abilities.forEach(ab => {
                    const isSelected = selectedAbilities.includes(ab.id);
                    html += `
                        <div onclick="togglePvPAbility('${ab.id}')" style="cursor: pointer; display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; background: ${isSelected ? '#1a3a1a' : '#1a1a1a'}; border-radius: 8px; border: 2px solid ${isSelected ? '#4CAF50' : 'transparent'};">
                            <div style="font-size: 1.5rem;">${ab.icon}</div>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-size: 0.9rem;">${ab.name}</div>
                                <div style="color: #888; font-size: 0.75rem;">${ab.desc}  CD: ${ab.cooldown || 0}</div>
                            </div>
                            <div style="color: ${isSelected ? '#4CAF50' : '#555'}; font-size: 1.2rem;">${isSelected ? '九' : '餃'}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            });
            
            html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;"> ${'Zp캩t'}</button>`;
            showModal('九 PvP Schopnosti', html);
        }
        
        function togglePvPAbility(abilityId) {
            initPvPStats();
            const selected = state.pvp.selectedAbilities || [];
            const index = selected.indexOf(abilityId);
            
            if (index > -1) {
                selected.splice(index, 1);
            } else if (selected.length < 4) {
                selected.push(abilityId);
            } else {
                notifyWarning('Maximum 4 schopnosti', 'Odeber n캩jakou schopnost');
                return;
            }
            
            state.pvp.selectedAbilities = selected;
            saveGame();
            showPvPAbilities();
        }
        
        // 游끤 PvP TITLES
        function showPvPTitles() {
            initPvPStats();
            const earnedTitles = state.pvp?.titles || [];
            
            let html = `
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">Z칤skej tituly za PvP 칰sp캩chy:</p>
                
                <div style="display: grid; gap: 0.5rem;">
            `;
            
            PVP_TITLES.forEach(title => {
                const isEarned = earnedTitles.includes(title.id);
                html += `
                    <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: ${isEarned ? 'linear-gradient(135deg, #3a3a0a 0%, #2a2a00 100%)' : '#1a1a1a'}; border-radius: 10px; border: 2px solid ${isEarned ? '#ffd700' : 'transparent'}; ${!isEarned ? 'opacity: 0.6;' : ''}">
                        <div style="font-size: 2rem; ${!isEarned ? 'filter: grayscale(100%);' : ''}">${title.icon}</div>
                        <div style="flex: 1;">
                            <div style="color: ${isEarned ? '#ffd700' : '#888'}; font-weight: bold;">${title.name}</div>
                            <div style="color: #666; font-size: 0.8rem;">${title.req}</div>
                        </div>
                        <div style="color: ${isEarned ? '#4CAF50' : '#555'}; font-size: 1.3rem;">${isEarned ? '九' : '游'}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
            html += `
                <div style="margin-top: 1rem; padding: 0.8rem; background: #1a1a1a; border-radius: 8px; text-align: center;">
                    <span style="color: #ffd700;">游끤 ${earnedTitles.length}</span>
                    <span style="color: #888;"> / ${PVP_TITLES.length} titul콢 z칤sk치no</span>
                </div>
            `;
            html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;"> ${'Zp캩t'}</button>`;
            
            showModal('游끤 PvP Tituly', html);
        }
        
        // Aktualizace leaderboardu s PvP ELO
        async function submitPvPScore() {
            if (!multiplayerEnabled || !firebaseDB) return;
            initPvPStats();
            
            const playerName = getPlayerName();
            try {
                await firebaseDB.ref('leaderboard/' + playerName).update({
                    pvpElo: state.pvp.elo,
                    pvpWins: state.pvp.wins,
                    pvpLosses: state.pvp.losses
                });
            } catch (err) {
                console.error('PvP score update error:', err);
            }
        }
        
        // === MULTIPLAYER TLA캛칈TKO V MENU ===
        // === MULTIPLAYER TAB RENDERER ===
        function renderMultiplayerTab() {
            const isActive = multiplayerEnabled;
            const myName = getPlayerName();
            const myScore = calculateMultiplayerScore();
            
            // Po캜et 캜ekaj칤c칤ch PvP v칳zev
            const pendingChallenges = pvpChallenges.filter(c => c.target === myName && c.status === 'pending').length;
            
            // Po캜et nov칳ch zpr치v (posledn칤 minuta)
            const recentMessages = chatMessages.filter(m => m.timestamp > Date.now() - 60000 && m.author !== myName).length;
            
            // Po캜et nep콏e캜ten칳ch soukrom칳ch zpr치v (pou쬴j glob치ln칤 prom캩nnou)
            let unreadPrivateMessages = unreadPMCount || 0;
            
            const hubTexts = {
                title: '游깷 ONLINE HUB', connected: '九 P콏ipojeno k serveru', offline: '丘멆잺 Offline - zkontroluj p콏ipojen칤',
                yourName: 'Tv칠 jm칠no:', score: 'SK칍RE', level: 'LEVEL', kills: 'ZABIT칈',
                leaderboard: '콯eb콏칤캜ek', topPlayers: 'Top hr치캜i', chat: 'Chat', messages: 'zpr치v',
                marketplace: 'Tr쬴코t캩', offers: 'nab칤dek', pvpArena: 'PvP Ar칠na', battles: 'Souboje',
                quickActions: 'Rychl칠 akce', submitScore: 'Odeslat sk칩re', refreshData: 'Obnovit data',
                recentMessages: 'Posledn칤 zpr치vy'
            };
            
            return `
                <!-- TERMINAL HEADER - kompaktn칤 -->
                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; margin-bottom: 0.5rem; border: 1px solid #333; font-family: 'Courier New', monospace;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #76ff03; font-size: 0.8rem; text-shadow: 0 0 5px #76ff03;">
                            > TERMINAL v2.7 ${isActive ? '[ONLINE]' : '[OFFLINE]'}
                        </div>
                        <div style="color: #666; font-size: 0.7rem;">${myName}</div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 0.4rem; font-size: 0.75rem;">
                        <span style="color: #ffd700;">丘${myScore.toLocaleString()}</span>
                        <span style="color: #8bc34a;">LV.${state.char.level}</span>
                        <span style="color: #ff6b6b;">驕${state.stats?.kills || 0}</span>
                    </div>
                </div>
                
                <!-- TERMINAL BUTTONS - 2x2 grid - rezav칠 termin치lov칠 tla캜칤tka -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="showLeaderboard()" style="background: linear-gradient(180deg, #1a1510 0%, #0d0a05 100%); border: 1px solid #4a3520; border-top-color: #6a4a30; border-left-color: #5a3a25; padding: 0.6rem; border-radius: 3px; display: flex; align-items: center; gap: 0.4rem; font-family: 'Courier New', monospace; box-shadow: inset 0 -2px 4px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,200,150,0.1);">
                        <span style="font-size: 1.1rem;">游끥</span>
                        <span style="font-size: 0.75rem; color: #a08060;">콯EB콎칈캛EK</span>
                    </button>
                    
                    <button class="btn" onclick="showFactionHub()" style="background: linear-gradient(180deg, #151515 0%, #080808 100%); border: 1px solid #3a3a3a; border-top-color: #4a4a4a; border-left-color: #404040; padding: 0.6rem; border-radius: 3px; display: flex; align-items: center; gap: 0.4rem; font-family: 'Courier New', monospace; box-shadow: inset 0 -2px 4px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.05);">
                        <span style="font-size: 1.1rem;">${getPlayerFaction() ? PVP_FACTIONS[getPlayerFaction()].icon : '游낎'}</span>
                        <span style="font-size: 0.75rem; color: ${getPlayerFaction() ? PVP_FACTIONS[getPlayerFaction()].color : '#666'};">FRAKCE</span>
                    </button>
                    
                    <button class="btn" onclick="showChatModal()" style="background: linear-gradient(180deg, #101510 0%, #050805 100%); border: 1px solid #2a3a2a; border-top-color: #3a4a3a; border-left-color: #304030; padding: 0.6rem; border-radius: 3px; display: flex; align-items: center; gap: 0.4rem; font-family: 'Courier New', monospace; box-shadow: inset 0 -2px 4px rgba(0,0,0,0.5), inset 0 1px 1px rgba(100,255,100,0.05); position: relative;">
                        <span style="font-size: 1.1rem;">游눫</span>
                        <span style="font-size: 0.75rem; color: #6a8a6a;">CHAT [${chatMessages.length}]</span>
                        ${recentMessages > 0 ? `<span style="position: absolute; top: 2px; right: 2px; background: #600; color: #f88; border-radius: 2px; padding: 0 3px; font-size: 0.6rem;">${recentMessages}</span>` : ''}
                    </button>
                    
                    <button class="btn" onclick="showMarketplace()" style="background: linear-gradient(180deg, #15120a 0%, #080604 100%); border: 1px solid #3a3020; border-top-color: #4a4030; border-left-color: #403525; padding: 0.6rem; border-radius: 3px; display: flex; align-items: center; gap: 0.4rem; font-family: 'Courier New', monospace; box-shadow: inset 0 -2px 4px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,200,100,0.05);">
                        <span style="font-size: 1.1rem;">游낅</span>
                        <span style="font-size: 0.75rem; color: #8a7a50;">TR콯IT캨 [${marketplaceOffers.filter(o => o.status === 'active').length}]</span>
                    </button>
                </div>
                
                <!-- LOCKED PVP -->
                <button class="btn" onclick="notifyWarning('游 Zam캜eno', 'PvP Ar칠na je do캜asn캩 nedostupn치')" style="width: 100%; background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%); border: 1px solid #222; padding: 0.4rem; border-radius: 3px; display: flex; align-items: center; justify-content: center; gap: 0.4rem; font-family: 'Courier New', monospace; opacity: 0.4; cursor: not-allowed; margin-bottom: 0.5rem;">
                    <span>游</span>
                    <span style="font-size: 0.7rem; color: #444;">PVP AR칄NA [NEDOSTUPN칄]</span>
                </button>
                
                <!-- 칔캛ET - termin치lov칳 styl -->
                <button class="btn" onclick="showAuthModal()" style="width: 100%; background: linear-gradient(180deg, ${currentUser && !currentUser.isAnonymous ? '#0a150a' : '#0a0a0a'} 0%, #050505 100%); border: 1px solid ${currentUser && !currentUser.isAnonymous ? '#2a4a2a' : '#222'}; padding: 0.5rem; border-radius: 3px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-family: 'Courier New', monospace; margin-bottom: 0.5rem;">
                    <span>${currentUser && !currentUser.isAnonymous ? '九' : '游댏'}</span>
                    <span style="font-size: 0.75rem; color: ${currentUser && !currentUser.isAnonymous ? '#6a9a6a' : '#666'};">${currentUser && !currentUser.isAnonymous ? 'M콡J 칔캛ET [CLOUD 九늏' : 'P콎IHL츼SIT SE'}</span>
                </button>
                
                <!-- QUICK ACTIONS - termin치lov칳 styl -->
                <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 3px; border: 1px solid #222; margin-bottom: 0.5rem;">
                    <div style="color: #444; font-size: 0.65rem; margin-bottom: 0.4rem; font-family: 'Courier New', monospace;">> RYCHL칄 P콎칈KAZY</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px;">
                        <button class="btn" onclick="submitScore()" style="background: #0d0d0d; border: 1px solid #2a3a2a; padding: 0.4rem; font-size: 0.7rem; font-family: 'Courier New', monospace; color: #6a8a6a; border-radius: 2px;">
                            游닋 ODESLAT
                        </button>
                        <button class="btn" onclick="refreshMultiplayerData()" style="background: #0d0d0d; border: 1px solid #2a2a3a; padding: 0.4rem; font-size: 0.7rem; font-family: 'Courier New', monospace; color: #6a6a9a; border-radius: 2px;">
                            游댃 OBNOVIT
                        </button>
                        <button class="btn" onclick="showInbox()" style="background: #0d0d0d; border: 1px solid #3a2a2a; padding: 0.4rem; font-size: 0.7rem; font-family: 'Courier New', monospace; color: #8a6a6a; border-radius: 2px; grid-column: span 2; position: relative;">
                            游닓 SOUKROM칄 ZPR츼VY
                            ${unreadPrivateMessages > 0 ? `<span style="color: #f66;">[${unreadPrivateMessages}]</span>` : ''}
                        </button>
                    </div>
                </div>
                
                <!-- CONNECTION STATUS -->
                <div style="margin-top: 1rem; padding: 0.8rem; background: ${isActive ? 'rgba(76,175,80,0.1)' : 'rgba(255,152,0,0.1)'}; border-radius: 8px; border: 1px solid ${isActive ? '#4CAF50' : '#ff9800'}; text-align: center;">
                    <span style="color: ${isActive ? '#8bc34a' : '#ff9800'};">
                        ${isActive ? '游릭 Server: posledni-prezivsi.firebaseapp.com' : '游댮 Nep콏ipojeno'}
                    </span>
                </div>
            `;
        }
        
        // Obnovit multiplayer data
        async function refreshMultiplayerData() {
            if (!multiplayerEnabled) {
                notifyWarning('Offline', 'Multiplayer nen칤 aktivn칤');
                return;
            }
            
            notifySuccess('Obnovuji...', 'Na캜칤t치m data ze serveru');
            
            // Znovu na캜ti data
            try {
                const chatSnap = await firebaseDB.ref('chat/messages').orderByChild('timestamp').limitToLast(100).once('value');
                chatMessages = Object.values(chatSnap.val() || {}).sort((a, b) => a.timestamp - b.timestamp);
                
                const marketSnap = await firebaseDB.ref('marketplace/offers').once('value');
                marketplaceOffers = Object.entries(marketSnap.val() || {}).map(([key, val]) => ({...val, id: key}));
                
                const pvpSnap = await firebaseDB.ref('pvp/challenges').once('value');
                pvpChallenges = Object.entries(pvpSnap.val() || {}).map(([key, val]) => ({...val, id: key}));
                
                renderFull();
                notifySuccess('Hotovo!', 'Data aktualizov치na');
            } catch (e) {
                console.error('Refresh error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se obnovit data');
            }
        }
        
        function showMultiplayerHub() {
            const isActive = multiplayerEnabled;
            
            showModal('游깷 Multiplayer Hub', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${isActive ? '游깷' : '游댋'}</div>
                    <div style="color: ${isActive ? '#8bc34a' : '#ff9800'};">
                        ${isActive ? '九 Online' : '丘멆잺 Offline'}
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="showLeaderboard()" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); color: #000; padding: 1rem;">
                        游끥 콯eb콏칤캜ek hr치캜콢
                    </button>
                    
                    <button class="btn" onclick="showChatModal()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 1rem;">
                        游눫 Chat p콏e쬴v코칤ch
                    </button>
                    
                    <button class="btn" onclick="showMarketplace()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem;">
                        游낅 Tr쬴코t캩 (obchod mezi hr치캜i)
                    </button>
                    
                    <button class="btn" onclick="showPvPArena()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem;">
                        丘덢잺 PvP Ar칠na
                    </button>
                    
                    <button class="btn" onclick="showBugReportModal()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 1rem;">
                        游냍 Nahl치sit chybu
                    </button>
                    
                    <button class="btn" onclick="openCommunityLinks()" style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem;">
                        游깷 Komunita
                    </button>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <span style="color: #888;">Hraje코 jako: </span>
                        <span style="color: #ffd700; font-weight: bold;">${getPlayerName()}</span>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>
            `);
        }
        
        // Automaticky odes칤lej sk칩re p콏i level upu
        const originalAddXP = addXP;
        addXP = function(amount) {
            const oldLevel = state.char.level;
            originalAddXP(amount);
            if (state.char.level > oldLevel && multiplayerEnabled) {
                setTimeout(submitScore, 1000);
            }
        };
        
        // ============================================
        // 游깷 KOMUNITA - WEB & FB
        // ============================================
        
        function openCommunityLinks() {
            showModal('游깷 Komunita', `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">游깷</div>
                    <h3 style="color: #ff5722; margin: 0;">Posledn칤 p콏e쬴v코칤</h3>
                    <p style="color: #888; margin-top: 0.5rem;">P콏ipoj se ke komunit캩 p콏e쬴v코칤ch!</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ffd700; font-style: italic; text-align: center; margin: 0;">
                        "V pustin캩 p콏e쬴j칤 jen ti, co dr쮂 spolu!" 驕뮖잺游뱋
                    </p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <a href="https://posledniprezivsi.cz/" target="_blank" rel="noopener noreferrer" 
                       class="btn" style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem; text-decoration: none; text-align: center; display: block;">
                        游깷 Ofici치ln칤 web
                    </a>
                    <a href="https://www.facebook.com/groups/1155970856393862/" target="_blank" rel="noopener noreferrer" 
                       class="btn" style="background: linear-gradient(135deg, #1877f2 0%, #0d5bbd 100%); padding: 1rem; text-decoration: none; text-align: center; display: block;">
                        游닂 Facebook skupina
                    </a>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                         Zp캩t
                    </button>
                </div>
            `);
        }
        
        // Star치 funkce pro zp캩tnou kompatibilitu
        function openFacebookGroup() {
            openCommunityLinks();
        }
        
        // ============================================
        // 游냍 BUG REPORT SYST칄M
        // ============================================
        
        function showBugReportModal() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('丘멆잺 Offline', 'Pro zobrazen칤 chyb mus칤코 b칳t online!');
                return;
            }
            
            showModal('游냍 Chyby ve h콏e', `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showBugReportForm()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 0.8rem;">
                        九勇 Nahl치sit novou
                    </button>
                    <button class="btn" onclick="showBugList()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 0.8rem;">
                        游늶 Seznam chyb
                    </button>
                </div>
                <div id="bugContent" style="min-height: 200px;">
                    <p style="color: #888; text-align: center;">Vyber mo쬹ost v칳코e...</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>
            `);
        }
        
        function showBugReportForm() {
            const container = document.getElementById('bugContent');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: left;">
                    <p style="color: #888; margin-bottom: 1rem;">Na코el jsi chybu ve h콏e? Napi코 ji sem a v칳voj치콏 ji oprav칤!</p>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Kategorie:</label>
                    <select id="bugCategory" style="width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <option value="gameplay">游꿡 Gameplay</option>
                        <option value="ui">游둰勇 Rozhran칤 (UI)</option>
                        <option value="combat">丘덢잺 Boj</option>
                        <option value="quests">游닆 Questy</option>
                        <option value="items">游 P콏edm캩ty</option>
                        <option value="skills">救 Dovednosti</option>
                        <option value="online">游깷 Online/Multiplayer</option>
                        <option value="other">仇 Jin칠</option>
                    </select>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Popis chyby:</label>
                    <textarea id="bugDescription" placeholder="Popi코 co se stalo, co jsi d캩lal a co m캩lo spr치vn캩 nastat..." 
                        style="width: 100%; height: 100px; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: vertical;"></textarea>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Kroky k reprodukci (voliteln칠):</label>
                    <textarea id="bugSteps" placeholder="1. Otev콏i invent치콏&#10;2. Klikni na p콏edm캩t&#10;3. ..."
                        style="width: 100%; height: 60px; padding: 0.5rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: vertical;"></textarea>
                    
                    <button class="btn" onclick="submitBugReport()" style="width: 100%; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">游닋 Odeslat</button>
                </div>
            `;
        }
        
        async function showBugList() {
            const container = document.getElementById('bugContent');
            if (!container) return;
            
            container.innerHTML = '<p style="color: #888; text-align: center;">낍 Na캜칤t치m...</p>';
            
            try {
                const snapshot = await firebaseDB.ref('bugReports').orderByChild('timestamp').once('value');
                const reports = snapshot.val() || {};
                
                const categoryIcons = {
                    gameplay: '游꿡', ui: '游둰勇', combat: '丘덢잺', quests: '游닆',
                    items: '游', skills: '救', online: '游깷', other: '仇'
                };
                
                const statusInfo = {
                    new: { icon: '游', color: '#f44336', text: 'Nov칳' },
                    in_progress: { icon: '游댢', color: '#ff9800', text: '콎e코칤 se' },
                    resolved: { icon: '九', color: '#4CAF50', text: 'Opraveno' },
                    wont_fix: { icon: '仇', color: '#666', text: 'Zam칤tnuto' }
                };
                
                const allReports = Object.entries(reports).map(([id, r]) => ({...r, id}));
                
                // Statistiky
                const newCount = allReports.filter(r => r.status === 'new').length;
                const inProgressCount = allReports.filter(r => r.status === 'in_progress').length;
                const resolvedCount = allReports.filter(r => r.status === 'resolved').length;
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="background: rgba(244,67,54,0.2); padding: 0.5rem; border-radius: 6px; text-align: center; border: 1px solid #f44336;">
                            <div style="font-size: 1.3rem; color: #f44336;">${newCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Nov칠</div>
                        </div>
                        <div style="background: rgba(255,152,0,0.2); padding: 0.5rem; border-radius: 6px; text-align: center; border: 1px solid #ff9800;">
                            <div style="font-size: 1.3rem; color: #ff9800;">${inProgressCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">콎e코칤 se</div>
                        </div>
                        <div style="background: rgba(76,175,80,0.2); padding: 0.5rem; border-radius: 6px; text-align: center; border: 1px solid #4CAF50;">
                            <div style="font-size: 1.3rem; color: #4CAF50;">${resolvedCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Opraveno</div>
                        </div>
                    </div>
                `;
                
                if (allReports.length === 0) {
                    html += '<p style="text-align: center; color: #888;">콯치dn칠 nahl치코en칠 chyby! 游꿀</p>';
                } else {
                    html += '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                    
                    // Se콏adit - nejd콏칤v nov칠 a in_progress, pak resolved
                    const sortedReports = allReports.sort((a, b) => {
                        const statusOrder = { new: 0, in_progress: 1, resolved: 2, wont_fix: 3 };
                        const orderA = statusOrder[a.status] ?? 4;
                        const orderB = statusOrder[b.status] ?? 4;
                        if (orderA !== orderB) return orderA - orderB;
                        return (b.timestamp || 0) - (a.timestamp || 0);
                    });
                    
                    sortedReports.forEach(report => {
                        const status = statusInfo[report.status] || statusInfo.new;
                        const catIcon = categoryIcons[report.category] || '仇';
                        const date = report.timestamp ? new Date(report.timestamp).toLocaleDateString('cs-CZ') : '';
                        const isMyReport = report.player === getPlayerName();
                        const safeId = report.id.replace(/'/g, "\\'");
                        
                        html += `
                            <div onclick="showBugReportDetail('${safeId}')" style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${status.color}; cursor: pointer;" title="Klikni pro detail">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                    <span style="font-size: 0.85rem;">${catIcon} <strong style="color: #ddd;">${report.category}</strong></span>
                                    <span style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: ${status.color}33; color: ${status.color}; border-radius: 4px;">${status.icon} ${status.text}</span>
                                </div>
                                <p style="margin: 0.3rem 0; color: #bbb; font-size: 0.85rem;">${escapeHtml(report.description).substring(0, 100)}${report.description.length > 100 ? '...' : ''}</p>
                                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-top: 0.3rem;">
                                    <span>${isMyReport ? '游녻 Tv콢j report' : '游녻 ' + report.player}</span>
                                    <span>${date}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Bug list error:', error);
                container.innerHTML = '<p style="color: #f44336; text-align: center;">Chyba p콏i na캜칤t치n칤 seznamu.</p>';
            }
        }
        
        // Zobrazen칤 detailu bug reportu
        async function showBugReportDetail(reportId) {
            try {
                const snapshot = await firebaseDB.ref('bugReports/' + reportId).once('value');
                const report = snapshot.val();
                
                if (!report) {
                    notifyWarning('Report nenalezen');
                    return;
                }
                
                const categoryIcons = {
                    gameplay: '游꿡', ui: '游둰勇', combat: '丘덢잺', quests: '游닆',
                    items: '游', skills: '救', online: '游깷', other: '仇'
                };
                
                const statusInfo = {
                    new: { icon: '游', color: '#f44336', text: 'Nov칳' },
                    in_progress: { icon: '游댢', color: '#ff9800', text: '콎e코칤 se' },
                    resolved: { icon: '九', color: '#4CAF50', text: 'Opraveno' },
                    wont_fix: { icon: '仇', color: '#666', text: 'Zam칤tnuto' }
                };
                
                const status = statusInfo[report.status] || statusInfo.new;
                const catIcon = categoryIcons[report.category] || '仇';
                const date = report.timestamp ? new Date(report.timestamp).toLocaleDateString('cs-CZ') + ' ' + new Date(report.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}) : '';
                
                showModal(`${catIcon} Detail chyby`, `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; border-left: 4px solid ${status.color};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span style="font-weight: bold; color: #ddd;">${report.category.toUpperCase()}</span>
                            <span style="padding: 0.3rem 0.6rem; background: ${status.color}33; color: ${status.color}; border-radius: 4px; font-size: 0.85rem;">${status.icon} ${status.text}</span>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.3rem;">游닇 POPIS:</div>
                            <p style="color: #ddd; margin: 0; line-height: 1.5; white-space: pre-wrap; word-break: break-word;">${escapeHtml(report.description)}</p>
                        </div>
                        
                        ${report.steps ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.3rem;">游댃 KROKY K REPRODUKCI:</div>
                                <p style="color: #bbb; margin: 0; line-height: 1.4; white-space: pre-wrap; word-break: break-word; font-size: 0.9rem;">${escapeHtml(report.steps)}</p>
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-top: 0.8rem; border-top: 1px solid #333; font-size: 0.75rem; color: #666;">
                            <div>游녻 ${escapeHtml(report.player)} (lvl ${report.playerLevel || '?'})</div>
                            <div style="text-align: right;">游늰 ${date}</div>
                            <div>游늸 ${report.location || 'Nezn치m치'}</div>
                            <div style="text-align: right;">游 ${reportId.substring(0, 8)}...</div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="showBugReportModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t na seznam</button>
                `);
                
            } catch (error) {
                console.error('Bug detail error:', error);
                notifyWarning('Chyba p콏i na캜칤t치n칤 detailu');
            }
        }
        
        async function submitBugReport() {
            const category = document.getElementById('bugCategory')?.value || 'other';
            const description = document.getElementById('bugDescription')?.value?.trim() || '';
            const steps = document.getElementById('bugSteps')?.value?.trim() || '';
            
            if (!description) {
                notifyWarning('Vypl켿 popis chyby!');
                return;
            }
            
            if (description.length < 10) {
                notifyWarning('Popis je p콏칤li코 kr치tk칳!');
                return;
            }
            
            try {
                const bugReport = {
                    category: category,
                    description: description,
                    steps: steps,
                    player: getPlayerName(),
                    playerLevel: state.char.level,
                    location: state.world?.currentLocation || 'unknown',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'new', // new, in_progress, resolved, wont_fix
                    resolved: false
                };
                
                await firebaseDB.ref('bugReports').push(bugReport);
                
                closeModal();
                notifySuccess('游냍 Chyba nahl치코ena!', 'D칤ky za pomoc s vylep코en칤m hry!');
                
            } catch (error) {
                console.error('Bug report error:', error);
                notifyWarning('Chyba p콏i odes칤l치n칤!');
            }
        }
        
        // === N츼PADY NA VYLEPEN칈 ===
        function showIdeasModal() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('丘멆잺 Offline', 'Pro zobrazen칤 n치pad콢 mus칤코 b칳t online!');
                return;
            }
            
            showModal('游눠 N치pady na vylep코en칤', `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showIdeaForm()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        九勇 P콏idat n치pad
                    </button>
                    <button class="btn" onclick="showIdeasList()" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); padding: 0.8rem;">
                        游늶 Seznam n치pad콢
                    </button>
                </div>
                <div id="ideasContent" style="min-height: 200px;">
                    <p style="color: #888; text-align: center;">Vyber mo쬹ost v칳코e...</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>
            `);
        }
        
        function showIdeaForm() {
            const container = document.getElementById('ideasContent');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: left;">
                    <p style="color: #888; margin-bottom: 1rem;">M치코 n치pad na vylep코en칤 hry? Pod캩lte se o n캩j!</p>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Kategorie:</label>
                    <select id="ideaCategory" style="width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <option value="feature">九 Nov치 funkce</option>
                        <option value="content">游닍 Nov칳 obsah (itemy, nep콏치tel칠...)</option>
                        <option value="balance">丘뒲잺 Balancov치n칤</option>
                        <option value="ui">游둰勇 Vylep코en칤 rozhran칤</option>
                        <option value="qol">游멆잺 Quality of Life</option>
                        <option value="story">游닀 P콏칤b캩h/Questy</option>
                        <option value="multiplayer">游깷 Multiplayer</option>
                        <option value="other">仇 Jin칠</option>
                    </select>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">N치zev n치padu:</label>
                    <input type="text" id="ideaTitle" placeholder="Stru캜n칳 n치zev n치padu..."
                        style="width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Popis:</label>
                    <textarea id="ideaDescription" placeholder="Popi코 sv콢j n치pad podrobn캩ji - co by to p콏ineslo hr치캜콢m, jak by to fungovalo..."
                        style="width: 100%; height: 100px; padding: 0.5rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: vertical;"></textarea>
                    
                    <button class="btn" onclick="submitIdea()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">游닋 Odeslat n치pad</button>
                </div>
            `;
        }
        
        async function showIdeasList() {
            const container = document.getElementById('ideasContent');
            if (!container) return;
            
            container.innerHTML = '<p style="color: #888; text-align: center;">낍 Na캜칤t치m...</p>';
            
            try {
                const snapshot = await firebaseDB.ref('gameIdeas').orderByChild('votes').once('value');
                const ideas = snapshot.val() || {};
                
                const categoryIcons = {
                    feature: '九', content: '游닍', balance: '丘뒲잺', ui: '游둰勇',
                    qol: '游멆잺', story: '游닀', multiplayer: '游깷', other: '仇'
                };
                
                const statusInfo = {
                    new: { icon: '游', color: '#2196f3', text: 'Nov칳', order: 0 },
                    considering: { icon: '游뱂', color: '#ff9800', text: 'Zva쬿je se', order: 1 },
                    planned: { icon: '游늶', color: '#9c27b0', text: 'Pl치nov치no', order: 2 },
                    in_progress: { icon: '游댣', color: '#ff9800', text: 'V pr치ci', order: 3 },
                    done: { icon: '九', color: '#4CAF50', text: 'Hotovo', order: 4 },
                    rejected: { icon: '仇', color: '#666', text: 'Zam칤tnuto', order: 5 }
                };
                
                // Se콏a캞 podle statusu (nevy콏칤zen칠 prvn칤), pak podle hlas콢 (sestupn캩)
                const sortedIdeas = Object.entries(ideas).sort((a, b) => {
                    const statusA = statusInfo[a[1].status] || statusInfo.new;
                    const statusB = statusInfo[b[1].status] || statusInfo.new;
                    
                    // Nejd콏칤v podle statusu (ni쮄뫆 order = prvn칤)
                    if (statusA.order !== statusB.order) {
                        return statusA.order - statusB.order;
                    }
                    
                    // Pak podle hlas콢 (vy코코칤 = prvn칤)
                    return (b[1].votes || 0) - (a[1].votes || 0);
                });
                
                if (sortedIdeas.length === 0) {
                    container.innerHTML = '<p style="color: #888; text-align: center;">Zat칤m 쮂멳n칠 n치pady. Bu캞 prvn칤!</p>';
                    return;
                }
                
                const myName = getPlayerName();
                
                let html = '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                sortedIdeas.slice(0, 20).forEach(([id, idea]) => {
                    const status = statusInfo[idea.status] || statusInfo.new;
                    const catIcon = categoryIcons[idea.category] || '仇';
                    const hasVoted = idea.votedBy && idea.votedBy[myName.replace(/[.#$[\]]/g, '_')];
                    const safeId = id.replace(/'/g, "\\'");
                    const hasReward = idea.rewarded;
                    
                    html += `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${status.color};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.3rem;">
                                <div style="flex: 1;">
                                    <span style="font-size: 1rem;">${catIcon}</span>
                                    <span style="color: #fff; font-weight: bold; font-size: 0.9rem;">${idea.title || 'Bez n치zvu'}</span>
                                    ${hasReward ? '<span style="margin-left: 0.3rem; font-size: 0.8rem;" title="Autor dostal odm캩nu">游꾸</span>' : ''}
                                </div>
                                <span style="background: ${status.color}22; color: ${status.color}; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem;">
                                    ${status.icon} ${status.text}
                                </span>
                            </div>
                            <p style="color: #aaa; font-size: 0.75rem; margin: 0.3rem 0; line-height: 1.3;">${(idea.description || '').substring(0, 100)}${(idea.description || '').length > 100 ? '...' : ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                <span style="color: #666; font-size: 0.7rem;">Od: ${idea.player || 'Anonym'}</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    ${hasReward ? `<span style="color: #8bc34a; font-size: 0.65rem;">${hasReward.money}游눯+${hasReward.xp}救</span>` : ''}
                                    <button onclick="voteIdea('${safeId}')" style="background: ${hasVoted ? '#4CAF50' : '#333'}; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                        <span style="color: ${hasVoted ? '#fff' : '#ffd700'};">游녨</span>
                                        <span style="color: #fff; font-size: 0.8rem; font-weight: bold;">${idea.votes || 0}</span>
                                    </button>
                                    <button onclick="showIdeaDetail('${safeId}')" style="background: #444; border: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; color: #fff; font-size: 0.75rem;">
                                        游닀
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Ideas list error:', error);
                container.innerHTML = '<p style="color: #ff6666; text-align: center;">Chyba p콏i na캜칤t치n칤 n치pad콢</p>';
            }
        }
        
        async function submitIdea() {
            const category = document.getElementById('ideaCategory')?.value;
            const title = document.getElementById('ideaTitle')?.value?.trim();
            const description = document.getElementById('ideaDescription')?.value?.trim();
            
            if (!title || title.length < 5) {
                notifyWarning('N치zev je p콏칤li코 kr치tk칳!');
                return;
            }
            
            if (!description || description.length < 20) {
                notifyWarning('Popis je p콏칤li코 kr치tk칳 (min. 20 znak콢)!');
                return;
            }
            
            try {
                const idea = {
                    category: category,
                    title: title,
                    description: description,
                    player: getPlayerName(),
                    playerLevel: state.char.level,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'new',
                    votes: 1,
                    votedBy: {
                        [getPlayerName().replace(/[.#$[\]]/g, '_')]: true
                    }
                };
                
                await firebaseDB.ref('gameIdeas').push(idea);
                
                closeModal();
                notifySuccess('游눠 N치pad odesl치n!', 'D칤ky za tv콢j p콏칤sp캩vek!');
                
            } catch (error) {
                console.error('Idea submit error:', error);
                notifyWarning('Chyba p콏i odes칤l치n칤!');
            }
        }
        
        async function voteIdea(ideaId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName().replace(/[.#$[\]]/g, '_');
            
            try {
                const snapshot = await firebaseDB.ref('gameIdeas/' + ideaId).once('value');
                const idea = snapshot.val();
                
                if (!idea) return;
                
                const hasVoted = idea.votedBy && idea.votedBy[myName];
                
                if (hasVoted) {
                    // Odeber hlas
                    await firebaseDB.ref('gameIdeas/' + ideaId).update({
                        votes: Math.max(0, (idea.votes || 1) - 1),
                        ['votedBy/' + myName]: null
                    });
                    notifyInfo('游녩 Hlas odebr치n', '');
                } else {
                    // P콏idej hlas
                    await firebaseDB.ref('gameIdeas/' + ideaId).update({
                        votes: (idea.votes || 0) + 1,
                        ['votedBy/' + myName]: true
                    });
                    notifySuccess('游녨 Hlasov치no!', '');
                }
                
                // Obnov seznam
                showIdeasList();
                
            } catch (error) {
                console.error('Vote error:', error);
                notifyWarning('Chyba p콏i hlasov치n칤!');
            }
        }
        
        async function showIdeaDetail(ideaId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const snapshot = await firebaseDB.ref('gameIdeas/' + ideaId).once('value');
                const idea = snapshot.val();
                
                if (!idea) {
                    notifyWarning('N치pad nenalezen');
                    return;
                }
                
                const categoryNames = {
                    feature: '九 Nov치 funkce', content: '游닍 Nov칳 obsah', balance: '丘뒲잺 Balancov치n칤',
                    ui: '游둰勇 Rozhran칤', qol: '游멆잺 Quality of Life', story: '游닀 P콏칤b캩h',
                    multiplayer: '游깷 Multiplayer', other: '仇 Jin칠'
                };
                
                const statusInfo = {
                    new: { icon: '游', color: '#2196f3', text: 'Nov칳' },
                    considering: { icon: '游뱂', color: '#ff9800', text: 'Zva쬿je se' },
                    planned: { icon: '游늶', color: '#9c27b0', text: 'Pl치nov치no' },
                    in_progress: { icon: '游댣', color: '#ff9800', text: 'V pr치ci' },
                    done: { icon: '九', color: '#4CAF50', text: 'Hotovo' },
                    rejected: { icon: '仇', color: '#666', text: 'Zam칤tnuto' }
                };
                
                const status = statusInfo[idea.status] || statusInfo.new;
                const date = idea.timestamp ? new Date(idea.timestamp).toLocaleDateString('cs-CZ') : 'Nezn치m칠';
                const myName = getPlayerName();
                const safeId = ideaId.replace(/'/g, "\\'");
                
                // Na캜ti koment치콏e
                const comments = idea.comments ? Object.entries(idea.comments).sort((a, b) => a[1].timestamp - b[1].timestamp) : [];
                
                let commentsHtml = '';
                if (comments.length > 0) {
                    commentsHtml = '<div style="margin-top: 1rem;"><h4 style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">游눫 Koment치콏e (${comments.length})</h4>';
                    commentsHtml += '<div style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                    comments.forEach(([cId, comment]) => {
                        const isAdmin = comment.author === 'Zaoo';
                        const commentDate = comment.timestamp ? new Date(comment.timestamp).toLocaleString('cs-CZ', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'}) : '';
                        commentsHtml += `
                            <div style="background: ${isAdmin ? '#1a2a1a' : '#1a1a1a'}; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; ${isAdmin ? 'border-left: 3px solid #4CAF50;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                    <span style="color: ${isAdmin ? '#ffd700' : '#aaa'}; font-size: 0.75rem; font-weight: bold;">
                                        ${comment.author || 'Anonym'}${isAdmin ? ' 游녬 ADMIN' : ''}
                                    </span>
                                    <span style="color: #555; font-size: 0.65rem;">${commentDate}</span>
                                </div>
                                <p style="color: #ccc; font-size: 0.8rem; margin: 0; line-height: 1.4;">${escapeHtml(comment.text || '')}</p>
                            </div>
                        `;
                    });
                    commentsHtml += '</div></div>';
                }
                commentsHtml = commentsHtml.replace('${comments.length}', comments.length);
                
                // Admin funkce pro zm캩nu stavu
                const adminControls = isAdmin() ? `
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #f44336;">
                        <p style="color: #f44336; font-size: 0.8rem; margin: 0 0 0.5rem 0;">游녬 Admin ovl치d치n칤:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'considering')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #ff9800;">游뱂 Zva쬿je se</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'planned')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #9c27b0;">游늶 Pl치nov치no</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'in_progress')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #ff9800;">游댣 V pr치ci</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'done')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #4CAF50;">九 Hotovo</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'rejected')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #666;">仇 Zam칤tnuto</button>
                        </div>
                        <button class="btn" onclick="rewardIdeaAuthor('${safeId}', '${escapeHtml(idea.player || '')}', '${escapeHtml(idea.title || '')}')" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.5rem;">
                            游꾸 D치t odm캩nu autorovi (${idea.player || 'Anonym'})
                        </button>
                    </div>
                ` : '';
                
                showModal('游눠 Detail n치padu', `
                    <div style="text-align: left;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="background: ${status.color}22; color: ${status.color}; padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.85rem;">
                                ${status.icon} ${status.text}
                            </span>
                            <span style="color: #ffd700; font-size: 1.2rem;">游녨 ${idea.votes || 0}</span>
                        </div>
                        
                        ${idea.rewarded ? `
                            <div style="background: linear-gradient(135deg, #1a3a1a, #0a2a0a); padding: 0.5rem 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #4caf50; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">游꾸</span>
                                <span style="color: #8bc34a; font-size: 0.85rem;">
                                    Odm캩n캩no: ${idea.rewarded.money || 0}游눯 + ${idea.rewarded.xp || 0}救
                                </span>
                            </div>
                        ` : ''}
                        
                        <h3 style="color: #ff9800; margin: 0 0 0.5rem 0;">${idea.title || 'Bez n치zvu'}</h3>
                        
                        <p style="color: #888; font-size: 0.8rem; margin-bottom: 1rem;">
                            ${categoryNames[idea.category] || 'Jin칠'}  Od: ${idea.player || 'Anonym'}  ${date}
                        </p>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: #ccc; line-height: 1.5; white-space: pre-wrap; margin: 0;">${idea.description || 'Bez popisu'}</p>
                        </div>
                        
                        ${idea.devResponse ? `
                            <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; border-left: 3px solid #4CAF50; margin-bottom: 1rem;">
                                <p style="color: #4CAF50; font-size: 0.85rem; margin: 0 0 0.5rem 0;">游눫 Odpov캩캞 v칳voj치콏e:</p>
                                <p style="color: #ccc; margin: 0;">${idea.devResponse}</p>
                            </div>
                        ` : ''}
                        
                        ${commentsHtml}
                        
                        <!-- P콏idat koment치콏 -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #333;">
                            <textarea id="ideaCommentText" placeholder="Napi코 koment치콏 nebo reakci..."
                                style="width: 100%; height: 60px; padding: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: none; margin-bottom: 0.5rem;"></textarea>
                            <button class="btn" onclick="addIdeaComment('${safeId}')" style="width: 100%; background: #2196f3;">游눫 P콏idat koment치콏</button>
                        </div>
                        
                        ${adminControls}
                    </div>
                    <button class="btn" onclick="showIdeasModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t na seznam</button>
                `);
                
            } catch (error) {
                console.error('Idea detail error:', error);
                notifyWarning('Chyba p콏i na캜칤t치n칤 detailu');
            }
        }
        
        // P콏idat koment치콏 k n치padu
        async function addIdeaComment(ideaId) {
            const text = document.getElementById('ideaCommentText')?.value?.trim();
            if (!text || text.length < 3) {
                notifyWarning('Koment치콏 je p콏칤li코 kr치tk칳!');
                return;
            }
            
            if (text.length > 500) {
                notifyWarning('Koment치콏 je p콏칤li코 dlouh칳 (max 500 znak콢)!');
                return;
            }
            
            try {
                const comment = {
                    author: getPlayerName(),
                    text: text,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await firebaseDB.ref('gameIdeas/' + ideaId + '/comments').push(comment);
                
                notifySuccess('游눫 Koment치콏 p콏id치n!', '');
                showIdeaDetail(ideaId); // Refresh
                
            } catch (error) {
                console.error('Comment error:', error);
                notifyWarning('Chyba p콏i p콏id치v치n칤 koment치콏e!');
            }
        }
        
        // Admin: zm캩na stavu n치padu
        // D치t odm캩nu autorovi n치padu
        function rewardIdeaAuthor(ideaId, playerName, ideaTitle) {
            if (!isAdmin()) return;
            
            if (!playerName || playerName === 'Anonym') {
                notifyWarning('Chyba', 'N치pad nem치 zn치m칠ho autora!');
                return;
            }
            
            // P콏eddefinovan칠 odm캩ny (ni쮄뫆 hodnoty pro vyv치쬰n칤)
            const rewardPresets = [
                { id: 'small', name: '游꾸 Mal치', money: 25, xp: 10 },
                { id: 'medium', name: '游꾸 St콏edn칤', money: 50, xp: 25 },
                { id: 'large', name: '游꾸 Velk치', money: 100, xp: 50 },
                { id: 'epic', name: '游끥 Epick치', money: 250, xp: 100 }
            ];
            
            const safeId = ideaId.replace(/'/g, "\\'");
            
            let presetsHtml = rewardPresets.map(r => `
                <button class="btn" onclick="sendIdeaReward('${safeId}', '${escapeHtml(playerName)}', ${r.money}, ${r.xp}, '${escapeHtml(ideaTitle)}')" 
                    style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.5rem; text-align: center;">
                    <div>${r.name}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">${r.money}游눯 + ${r.xp}救</div>
                </button>
            `).join('');
            
            showModal('游꾸 Odm캩na za n치pad', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #888;">D치t odm캩nu hr치캜i:</p>
                    <p style="color: #2196f3; font-size: 1.2rem; font-weight: bold;">${escapeHtml(playerName)}</p>
                    <p style="color: #666; font-size: 0.85rem;">Za n치pad: "${escapeHtml(ideaTitle)}"</p>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    ${presetsHtml}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #888; font-size: 0.85rem; margin: 0 0 0.5rem 0;">Nebo vlastn칤 캜치stka:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <input type="number" id="customRewardMoney" placeholder="Pen칤ze" value="50" min="0" style="padding: 0.5rem; background: #2a2a2a; color: #ffd700; border: 1px solid #444; border-radius: 4px;">
                        <input type="number" id="customRewardXP" placeholder="XP" value="25" min="0" style="padding: 0.5rem; background: #2a2a2a; color: #8bc34a; border: 1px solid #444; border-radius: 4px;">
                    </div>
                    <button class="btn" onclick="sendIdeaReward('${safeId}', '${escapeHtml(playerName)}', parseInt(document.getElementById('customRewardMoney').value)||0, parseInt(document.getElementById('customRewardXP').value)||0, '${escapeHtml(ideaTitle)}')" 
                        style="width: 100%; margin-top: 0.5rem; background: #ff9800;">
                        Odeslat vlastn칤 odm캩nu
                    </button>
                </div>
                
                <button class="btn" onclick="showIdeaDetail('${ideaId}')" style="width: 100%; background: #555;"> Zp캩t na n치pad</button>
            `);
        }
        
        async function sendIdeaReward(ideaId, playerName, money, xp, ideaTitle) {
            if (!isAdmin()) return;
            
            if (money <= 0 && xp <= 0) {
                notifyWarning('Chyba', 'Nastav alespo켿 pen칤ze nebo XP!');
                return;
            }
            
            try {
                const reason = `Schv치len칳 n치pad: "${ideaTitle}"`;
                const rewardId = Date.now().toString();
                
                // Ulo odm캩nu do Firebase pod players/{playerName}/pendingRewards
                await firebaseDB.ref(`players/${playerName}/pendingRewards/${rewardId}`).set({
                    money: money,
                    xp: xp,
                    reason: reason,
                    from: ADMIN_NICK,
                    timestamp: Date.now(),
                    claimed: false
                });
                
                // Ozna캜 n치pad jako odm캩n캩n칳 v gameIdeas
                await firebaseDB.ref(`gameIdeas/${ideaId}/rewarded`).set({
                    money: money,
                    xp: xp,
                    timestamp: Date.now()
                });
                
                // Po코li zpr치vu
                await firebaseDB.ref(`chat/private/${playerName}/${ADMIN_NICK}`).push({
                    from: ADMIN_NICK,
                    text: `游꾸 Tv콢j n치pad "${ideaTitle}" byl schv치len! Odm캩na: ${money > 0 ? money + '游눯' : ''} ${xp > 0 ? xp + '救XP' : ''} - Vyzvedni si ji p콏i dal코칤m p콏ihl치코en칤!`,
                    timestamp: Date.now(),
                    type: 'reward'
                });
                
                // Zaloguj
                await firebaseDB.ref('admin/rewardLog').push({
                    player: playerName,
                    money: money,
                    xp: xp,
                    reason: reason,
                    admin: ADMIN_NICK,
                    timestamp: Date.now()
                });
                
                notifySuccess('游꾸 Odm캩na odesl치na!', `${playerName}: ${money}游눯 + ${xp}救XP`);
                closeModal();
                
                // Refresh detail n치padu
                setTimeout(() => showIdeaDetail(ideaId), 500);
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function setIdeaStatus(ideaId, newStatus) {
            if (!isAdmin()) return;
            
            try {
                await firebaseDB.ref('gameIdeas/' + ideaId).update({
                    status: newStatus
                });
                
                notifySuccess('九 Stav zm캩n캩n!', newStatus);
                showIdeaDetail(ideaId); // Refresh
                
            } catch (error) {
                console.error('Status change error:', error);
                notifyWarning('Chyba p콏i zm캩n캩 stavu!');
            }
        }
        
        // Admin panel pro bug reporty
        async function showAdminBugReports() {
            if (!hasPermission('bugs')) return;
            
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('丘멆잺 Offline', 'Mus칤코 b칳t online!');
                return;
            }
            
            try {
                const snapshot = await firebaseDB.ref('bugReports').orderByChild('timestamp').once('value');
                const reports = snapshot.val() || {};
                
                const categoryIcons = {
                    gameplay: '游꿡', ui: '游둰勇', combat: '丘덢잺', quests: '游닆',
                    items: '游', skills: '救', online: '游깷', other: '仇'
                };
                
                const statusColors = {
                    new: '#f44336',
                    in_progress: '#ff9800',
                    resolved: '#4CAF50',
                    wont_fix: '#666'
                };
                
                const statusNames = {
                    new: '游 Nov칳',
                    in_progress: '游댃 콎e코칤 se',
                    resolved: '九 Vy콏e코eno',
                    wont_fix: '仇 Nebudeme opravovat'
                };
                
                let html = '<div style="max-height: 60vh; overflow-y: auto;">';
                
                // Statistiky
                const allReports = Object.values(reports);
                const newCount = allReports.filter(r => r.status === 'new').length;
                const inProgressCount = allReports.filter(r => r.status === 'in_progress').length;
                const resolvedCount = allReports.filter(r => r.status === 'resolved').length;
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="background: #3a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #f44336;">${newCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Nov칠</div>
                        </div>
                        <div style="background: #3a2a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #ff9800;">${inProgressCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">콎e코칤 se</div>
                        </div>
                        <div style="background: #1a3a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #4CAF50;">${resolvedCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Vy콏e코eno</div>
                        </div>
                    </div>
                `;
                
                // Seznam report콢 (od nejnov캩j코칤ch)
                const sortedReports = Object.entries(reports).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
                
                if (sortedReports.length === 0) {
                    html += '<p style="text-align: center; color: #888;">콯치dn칠 nahl치코en칠 chyby! 游꿀</p>';
                } else {
                    sortedReports.forEach(([id, report]) => {
                        const date = report.timestamp ? new Date(report.timestamp).toLocaleDateString('cs-CZ') : 'Nezn치m칠';
                        const icon = categoryIcons[report.category] || '仇';
                        const statusColor = statusColors[report.status] || '#666';
                        
                        html += `
                            <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.85rem;">${icon} <strong>${report.category}</strong></span>
                                    <span style="font-size: 0.7rem; color: #888;">${date}</span>
                                </div>
                                <p style="margin: 0.5rem 0; color: #ddd; font-size: 0.9rem;">${escapeHtml(report.description).substring(0, 150)}${report.description.length > 150 ? '...' : ''}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: #888;">Od: ${report.player} (L${report.playerLevel})</span>
                                    <select onchange="updateBugStatus('${id}', this.value)" style="padding: 0.2rem 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 0.75rem;">
                                        <option value="new" ${report.status === 'new' ? 'selected' : ''}>游 Nov칳</option>
                                        <option value="in_progress" ${report.status === 'in_progress' ? 'selected' : ''}>游댃 콎e코칤 se</option>
                                        <option value="resolved" ${report.status === 'resolved' ? 'selected' : ''}>九 Vy콏e코eno</option>
                                        <option value="wont_fix" ${report.status === 'wont_fix' ? 'selected' : ''}>仇 Nebudeme</option>
                                    </select>
                                </div>
                                ${report.steps ? `<details style="margin-top: 0.5rem;"><summary style="color: #888; font-size: 0.75rem; cursor: pointer;">Kroky k reprodukci</summary><p style="color: #aaa; font-size: 0.8rem; white-space: pre-line; margin: 0.5rem 0;">${escapeHtml(report.steps)}</p></details>` : ''}
                                ${report.adminReply ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #1a2a1a; border-radius: 4px; border-left: 2px solid #4caf50;"><span style="color: #4caf50; font-size: 0.7rem;">游눫 Admin odpov캩캞:</span><p style="color: #aaa; font-size: 0.8rem; margin: 0.3rem 0 0 0;">${escapeHtml(report.adminReply)}</p></div>` : ''}
                                <div style="display: flex; gap: 0.3rem; margin-top: 0.5rem;">
                                    <button onclick="showAdminReplyDialog('${id}')" style="padding: 0.2rem 0.5rem; background: #2196f3; border: none; color: #fff; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">游눫 Odpov캩d캩t</button>
                                    <button onclick="deleteBugReport('${id}')" style="padding: 0.2rem 0.5rem; background: #c62828; border: none; color: #fff; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">游딈勇 Smazat</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                
                showModal('游냍 Admin - Bug Reporty', html + `
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>
                `);
                
            } catch (error) {
                console.error('Admin bug reports error:', error);
                showModal('仇 Chyba', 'Nepoda콏ilo se na캜칤st bug reporty.');
            }
        }
        
        async function updateBugStatus(reportId, newStatus) {
            if (!firebaseDB) return;
            
            try {
                await firebaseDB.ref('bugReports/' + reportId).update({
                    status: newStatus,
                    resolved: newStatus === 'resolved'
                });
                notifySuccess('Status aktualizov치n!');
            } catch (error) {
                console.error('Update bug status error:', error);
                notifyWarning('Chyba p콏i aktualizaci!');
            }
        }
        
        async function deleteBugReport(reportId) {
            if (!firebaseDB) return;
            
            if (!confirm('Opravdu smazat tento bug report?')) return;
            
            try {
                await firebaseDB.ref('bugReports/' + reportId).remove();
                showAdminBugReports(); // Refresh
                notifySuccess('Bug report smaz치n!');
            } catch (error) {
                console.error('Delete bug report error:', error);
                notifyWarning('Chyba p콏i maz치n칤!');
            }
        }
        
        function showAdminReplyDialog(reportId) {
            showModal('游눫 Odpov캩캞 na bug report', `
                <div style="text-align: center;">
                    <textarea id="adminReplyText" placeholder="Napi코 odpov캩캞 hr치캜i..." 
                        style="width: 100%; height: 100px; padding: 0.8rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; resize: none; margin-bottom: 1rem;"></textarea>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="showAdminBugReports()" style="flex: 1; background: #555;"> Zp캩t</button>
                        <button class="btn" onclick="sendAdminReply('${reportId}')" style="flex: 1; background: #4caf50;">游닋 Odeslat</button>
                    </div>
                </div>
            `);
        }
        
        async function sendAdminReply(reportId) {
            if (!firebaseDB) return;
            
            const replyText = document.getElementById('adminReplyText')?.value?.trim();
            if (!replyText) {
                notifyWarning('Napi코 odpov캩캞!');
                return;
            }
            
            try {
                await firebaseDB.ref('bugReports/' + reportId).update({
                    adminReply: replyText,
                    adminReplyTime: firebase.database.ServerValue.TIMESTAMP
                });
                notifySuccess('Odpov캩캞 odesl치na!');
                showAdminBugReports(); // Refresh
            } catch (error) {
                console.error('Admin reply error:', error);
                notifyWarning('Chyba p콏i odes칤l치n칤!');
            }
        }
        
        // ============================================
        // 游꿡 VYLEPEN칗 MULTIPLAYER SYST칄M
        // ============================================
        
        // === P콎츼TEL칄 SYST칄M ===
        
        // Inicializace p콏치tel
        function initFriendsSystem() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            // Na캜ti p콏치tele z lok치ln칤ho ulo쬰n칤
            try {
                friendsList = JSON.parse(localStorage.getItem('friendsList_' + myName) || '[]');
            } catch (e) {
                friendsList = [];
            }
            
            // Poslouchej notifikace (쮂멳osti o p콏치telstv칤 a p콏ijet칤)
            console.log('游논 Nastavuji listener na notifikace pro:', myName);
            const processedRewards = new Set(); // Ochrana proti duplicitn칤mu zpracov치n칤
            const rewardQueue = []; // Fronta odm캩n k zpracov치n칤
            let processingRewards = false;
            
            async function processRewardQueue() {
                if (processingRewards || rewardQueue.length === 0) return;
                processingRewards = true;
                
                while (rewardQueue.length > 0) {
                    const { reward, key } = rewardQueue.shift();
                    await processAdminReward(reward, key);
                    // Po캜kej 500ms mezi modaly aby hr치캜 vid캩l ka쬯칳
                    if (rewardQueue.length > 0) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
                processingRewards = false;
            }
            
            firebaseDB.ref('notifications/' + myName).orderByChild('timestamp').limitToLast(100).on('value', (snap) => {
                const notifications = snap.val() || {};
                console.log('游논 P콏ijat칠 notifikace:', notifications);
                friendRequests = [];
                Object.entries(notifications).forEach(([k, v]) => {
                    if (v.type === 'friend_request') {
                        friendRequests.push({...v, id: k});
                        console.log('游논 콯치dost o p콏치telstv칤 od:', v.from);
                    }
                    // Kdy n캩kdo p콏ijal na코i 쮂멳ost, p콏idej ho do p콏치tel
                    if (v.type === 'friend_accepted' && !friendsList.includes(v.from)) {
                        friendsList.push(v.from);
                        saveFriendsList();
                        notifySuccess('Nov칳 p콏칤tel!', `${v.from} p콏ijal tvou 쮂멳ost o p콏치telstv칤`);
                        // Sma notifikaci
                        firebaseDB.ref('notifications/' + myName + '/' + k).remove();
                    }
                    // Zpracov치n칤 v칳hry v tombole
                    if (v.type === 'tombola_win' && !v.processed) {
                        console.log('游꿀 Tombola v칳hra!', v);
                        processTombolaWin(v);
                        // Ozna캜 jako zpracovan칠 a sma
                        firebaseDB.ref('notifications/' + myName + '/' + k).remove();
                    }
                    // Zpracov치n칤 admin odm캩ny - p콏idej do fronty
                    if (v.type === 'admin_reward' && !v.claimed && !processedRewards.has(k)) {
                        processedRewards.add(k);
                        console.log('游꾸 Admin odm캩na p콏id치na do fronty:', k);
                        rewardQueue.push({ reward: v, key: k });
                    }
                });
                // Zpracuj frontu odm캩n
                if (rewardQueue.length > 0) {
                    processRewardQueue();
                }
                if (friendRequests.length > 0) {
                    console.log('游논 Celkem 쮂멳ost칤:', friendRequests.length);
                    updateOnlineIndicator('notification');
                }
            });
            
            // Poslouchej soukrom칠 zpr치vy
            let lastPrivateMsgCount = 0;
            const privatePath = 'chat/private/' + myName;
            console.log('游닓 Nastavuji listener na:', privatePath);
            
            firebaseDB.ref(privatePath).orderByChild('timestamp').limitToLast(100).on('value', (snap) => {
                const msgs = snap.val() || {};
                const msgArray = Object.values(msgs);
                console.log('游닓 Na캜teno soukrom칳ch zpr치v:', msgArray.length, 'pro', myName);
                
                privateMessages = {};
                msgArray.forEach(msg => {
                    // P콏esko캜 zpr치vy bez from nebo to
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    privateMessages[other].push(msg);
                });
                
                console.log('游닓 Konverzace:', Object.keys(privateMessages));
                
                // Notifikace pro nov칠 soukrom칠 zpr치vy
                const incomingMsgs = msgArray.filter(m => m.from !== myName);
                if (incomingMsgs.length > lastPrivateMsgCount && lastPrivateMsgCount > 0) {
                    const lastMsg = incomingMsgs[incomingMsgs.length - 1];
                    notifySuccess('游닓 Soukrom치 zpr치va od ' + lastMsg.from, lastMsg.text?.substring(0, 40) || '');
                    
                    // P콏ehr치t zvuk pokud existuje
                    if (typeof SoundSystem !== 'undefined' && SoundSystem.play) {
                        SoundSystem.play('notification');
                    }
                }
                lastPrivateMsgCount = incomingMsgs.length;
            });
        }
        
        // Ulo쬴t p콏치tele lok치ln캩
        function saveFriendsList() {
            const myName = getPlayerName();
            try {
                localStorage.setItem('friendsList_' + myName, JSON.stringify(friendsList));
            } catch (e) {}
        }
        
        // Odeslat 쮂멳ost o p콏치telstv칤
        async function sendFriendRequest(targetName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            if (!targetName || targetName.trim() === '') {
                notifyWarning('Chyba', 'Zadej jm칠no hr치캜e!');
                return;
            }
            
            targetName = targetName.trim();
            
            if (targetName.toLowerCase() === myName.toLowerCase()) {
                notifyWarning('Chyba', 'Nem콢쬰코 si poslat 쮂멳ost s치m sob캩!');
                return;
            }
            
            if (friendsList.some(f => f.toLowerCase() === targetName.toLowerCase())) {
                notifyWarning('Ji p콏치tel칠', 'Tento hr치캜 u je tv콢j p콏칤tel!');
                return;
            }
            
            try {
                // Ov캩콏 쬰 hr치캜 existuje v leaderboardu
                const leaderboardSnap = await firebaseDB.ref('leaderboard').orderByChild('name').equalTo(targetName).once('value');
                const playerExists = leaderboardSnap.exists();
                
                if (!playerExists) {
                    // Zkus case-insensitive hled치n칤
                    const allPlayersSnap = await firebaseDB.ref('leaderboard').once('value');
                    const allPlayers = allPlayersSnap.val() || {};
                    const foundPlayer = Object.values(allPlayers).find(p => 
                        p.name && p.name.toLowerCase() === targetName.toLowerCase()
                    );
                    
                    if (foundPlayer) {
                        targetName = foundPlayer.name; // Pou쬴j spr치vn칠 jm칠no
                    } else {
                        notifyWarning('Hr치캜 nenalezen', `Hr치캜 "${targetName}" neexistuje nebo je코t캩 nehr치l.`);
                        return;
                    }
                }
                
                // Po코li notifikaci druh칠mu hr치캜i
                await firebaseDB.ref('notifications/' + targetName).push({
                    type: 'friend_request',
                    from: myName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    level: state.char.level
                });
                notifySuccess('Odesl치no!', `콯치dost o p콏치telstv칤 odesl치na hr치캜i ${targetName}`);
            } catch (e) {
                console.error('Friend request error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se odeslat 쮂멳ost: ' + e.message);
            }
        }
        
        // P콏ijmout 쮂멳ost o p콏치telstv칤
        async function acceptFriendRequest(requestId, fromName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                // P콏idej do lok치ln칤ho seznamu
                if (!friendsList.includes(fromName)) {
                    friendsList.push(fromName);
                    saveFriendsList();
                }
                
                // Sma 쮂멳ost z notifikac칤
                await firebaseDB.ref('notifications/' + myName + '/' + requestId).remove();
                
                // Notifikace druh칠mu hr치캜i, 쬰 jsme p콏ijali + p콏id치me ho taky
                await firebaseDB.ref('notifications/' + fromName).push({
                    type: 'friend_accepted',
                    from: myName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                notifySuccess('P콏칤tel p콏id치n!', `${fromName} je nyn칤 tv콢j p콏칤tel`);
                showFriendsModal();
            } catch (e) {
                console.error('Accept friend error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se p콏ijmout 쮂멳ost');
            }
        }
        
        // Odm칤tnout 쮂멳ost
        async function declineFriendRequest(requestId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                await firebaseDB.ref('notifications/' + getPlayerName() + '/' + requestId).remove();
                notifySuccess('Odm칤tnuto', '콯치dost byla odm칤tnuta');
                showFriendsModal();
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se odm칤tnout 쮂멳ost');
            }
        }
        
        // Odebrat p콏칤tele
        async function removeFriend(friendName) {
            const idx = friendsList.indexOf(friendName);
            if (idx > -1) {
                friendsList.splice(idx, 1);
                saveFriendsList();
                notifySuccess('Odebr치no', `${friendName} byl odebr치n z p콏치tel`);
                showFriendsModal();
            }
        }
        
        // Zobrazit modal p콏치tel
        function showFriendsModal() {
            if (!multiplayerEnabled) {
                showModal('游논 P콏치tel칠', '<p style="color: #888; text-align: center;">Multiplayer nen칤 aktivn칤</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            const myName = getPlayerName();
            console.log('游논 showFriendsModal - myName:', myName);
            console.log('游논 showFriendsModal - friendRequests:', friendRequests);
            console.log('游논 showFriendsModal - friendsList:', friendsList);
            
            // Refresh 쮂멳ost칤 p콏칤mo z Firebase
            if (firebaseDB) {
                firebaseDB.ref('notifications/' + myName).once('value').then(snap => {
                    const notifications = snap.val() || {};
                    console.log('游논 Aktu치ln칤 notifikace v Firebase:', notifications);
                    
                    // Aktualizuj friendRequests
                    friendRequests = [];
                    Object.entries(notifications).forEach(([k, v]) => {
                        if (v.type === 'friend_request') {
                            friendRequests.push({...v, id: k});
                        }
                    });
                    
                    // Znovu vykresli modal s aktu치ln칤mi daty
                    renderFriendsModalContent();
                });
            }
            
            renderFriendsModalContent();
        }
        
        function renderFriendsModalContent() {
            let html = `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="friendSearchInput" placeholder="Jm칠no hr치캜e..." style="flex: 1; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff;">
                        <button class="btn" onclick="sendFriendRequest(document.getElementById('friendSearchInput').value)" style="background: #4CAF50;">俱 P콏idat</button>
                    </div>
                </div>
            `;
            
            // 콯치dosti o p콏치telstv칤
            if (friendRequests.length > 0) {
                html += `<div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ff9800;">
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">游닓 콯치dosti (${friendRequests.length})</h4>`;
                friendRequests.forEach(req => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="flex: 1; color: #fff;">${escapeHtml(req.from)} <span style="color: #666; font-size: 0.8rem;">Lvl ${req.level || '?'}</span></span>
                            <button class="btn" onclick="acceptFriendRequest('${req.id}', '${escapeHtml(req.from)}')" style="background: #4CAF50; padding: 0.3rem 0.6rem; font-size: 0.8rem;">九</button>
                            <button class="btn" onclick="declineFriendRequest('${req.id}')" style="background: #c62828; padding: 0.3rem 0.6rem; font-size: 0.8rem;">九</button>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Seznam p콏치tel
            html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px;">
                <h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">游논 P콏치tel칠 (${friendsList.length})</h4>`;
            
            if (friendsList.length === 0) {
                html += `<p style="color: #666; text-align: center; padding: 1rem;">Zat칤m nem치코 쮂멳n칠 p콏치tele</p>`;
            } else {
                friendsList.forEach(friend => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #0a0a0a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="flex: 1; color: #fff;">${escapeHtml(friend)}</span>
                            <button class="btn" onclick="showPrivateChat('${escapeHtml(friend)}')" style="background: #2196f3; padding: 0.3rem 0.6rem; font-size: 0.8rem;">游눫</button>
                            <button class="btn" onclick="sendGift('${escapeHtml(friend)}')" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">游꾸</button>
                            <button class="btn" onclick="removeFriend('${escapeHtml(friend)}')" style="background: #555; padding: 0.3rem 0.6rem; font-size: 0.8rem;">九</button>
                        </div>
                    `;
                });
            }
            html += `</div>`;
            
            html += `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>`;
            
            showModal('游논 P콏치tel칠', html);
        }
        
        // === SOUKROM칄 ZPR츼VY ===
        async function showPrivateChat(friendName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            // Na캜ti zpr치vy p콏칤mo z Firebase pro jistotu
            try {
                const snap = await firebaseDB.ref('chat/private/' + myName).orderByChild('timestamp').limitToLast(100).once('value');
                const allMsgs = snap.val() || {};
                
                // Ozna캜 zpr치vy od tohoto p콏칤tele jako p콏e캜ten칠
                const updates = {};
                Object.entries(allMsgs).forEach(([key, msg]) => {
                    if (msg.from === friendName && !msg.read) {
                        updates['chat/private/' + myName + '/' + key + '/read'] = true;
                    }
                });
                
                // Ulo쬰n칤 do Firebase
                if (Object.keys(updates).length > 0) {
                    await firebaseDB.ref().update(updates);
                }
                
                const msgArray = Object.values(allMsgs);
                
                // Aktualizuj privateMessages
                privateMessages = {};
                msgArray.forEach(msg => {
                    // P콏esko캜 zpr치vy bez from nebo to
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    // Ozna캜 lok치ln캩 jako p콏e캜ten칠
                    if (msg.from === friendName) msg.read = true;
                    privateMessages[other].push(msg);
                });
            } catch (e) {
                console.error('Chyba na캜칤t치n칤 zpr치v:', e);
            }
            
            const msgs = (privateMessages[friendName] || []).sort((a, b) => a.timestamp - b.timestamp).slice(-30);
            
            // Bezpe캜n칠 escapov치n칤 pro onclick
            const safeName = escapeHtml(friendName).replace(/'/g, "\\'");
            
            let messagesHtml = '';
            if (msgs.length === 0) {
                messagesHtml = '<div style="text-align: center; padding: 2rem; color: #666;">콯치dn칠 zpr치vy... Napi코 prvn칤!</div>';
            } else {
                msgs.forEach(msg => {
                    const isMe = msg.from === myName;
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}) : '';
                    messagesHtml += `
                        <div style="margin-bottom: 0.5rem; ${isMe ? 'text-align: right;' : ''}">
                            <div style="display: inline-block; max-width: 80%; background: ${isMe ? '#1a3a1a' : '#2a2a2a'}; padding: 0.5rem 0.8rem; border-radius: 12px;">
                                <div style="color: #ddd;">${escapeHtml(msg.text)}</div>
                                <div style="font-size: 0.65rem; color: #555; margin-top: 0.2rem;">${time}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            showModal(`游눫 Chat s ${escapeHtml(friendName)}`, `
                <div id="privateChatMessages" style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">
                    ${messagesHtml}
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="privateMsgInput" placeholder="Napi코 zpr치vu..." maxlength="200"
                        style="flex: 1; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff;"
                        onkeypress="if(event.key==='Enter') sendPrivateMessage('${safeName}')">
                    <button class="btn" onclick="sendPrivateMessage('${safeName}')" style="background: #4CAF50;">游닋</button>
                </div>
                
                <button class="btn" onclick="showInbox()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t</button>
            `);
            
            setTimeout(() => {
                const container = document.getElementById('privateChatMessages');
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        async function sendPrivateMessage(toName) {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Chyba', 'Multiplayer nen칤 aktivn칤');
                return;
            }
            
            const input = document.getElementById('privateMsgInput');
            if (!input || !input.value.trim()) {
                notifyWarning('Chyba', 'Napi코 zpr치vu');
                return;
            }
            
            const myName = getPlayerName();
            if (!myName) {
                notifyWarning('Chyba', 'Nejsi p콏ihl치코en');
                return;
            }
            
            const msg = {
                from: myName,
                to: toName,
                text: input.value.trim().substring(0, 200),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            try {
                // Ulo do obou inbox콢 p콏es chat/private
                console.log('游닋 Odes칤l치m SZ:', msg);
                await firebaseDB.ref('chat/private/' + myName).push(msg);
                await firebaseDB.ref('chat/private/' + toName).push(msg);
                
                input.value = '';
                notifySuccess('九 Odesl치no', 'Zpr치va odesl치na');
                setTimeout(() => showPrivateChat(toName), 300);
            } catch (e) {
                console.error('Private message error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se odeslat: ' + e.message);
            }
        }
        
        // === LISTENER NA SOUKROM칄 ZPR츼VY (po캜et nep콏e캜ten칳ch) ===
        function listenToPrivateMessages() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            if (!myName) return;
            
            // Listener na moje soukrom칠 zpr치vy
            firebaseDB.ref('chat/private/' + myName).on('value', (snap) => {
                const allMsgs = snap.val() || {};
                const msgArray = Object.values(allMsgs);
                
                // Spo캜칤tej nep콏e캜ten칠
                unreadPMCount = 0;
                privateMessages = {};
                
                msgArray.forEach(msg => {
                    // P콏esko캜 zpr치vy bez from nebo to
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    privateMessages[other].push(msg);
                    
                    // Po캜칤tej nep콏e캜ten칠 (od ostatn칤ch, ne moje)
                    if (msg.from !== myName && !msg.read) {
                        unreadPMCount++;
                    }
                });
                
                console.log('游닓 Private messages updated, unread:', unreadPMCount);
                
                // Aktualizuj UI pokud jsme na online tabu
                if (state.activeTab === 'multiplayer') {
                    renderFull();
                }
            });
        }
        
        // === INBOX - P콎EHLED VECH KONVERZAC칈 ===
        async function showInbox() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('游닓 Soukrom칠 zpr치vy', '<p style="color: #888; text-align: center;">Mus칤코 b칳t online!</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            const myName = getPlayerName();
            
            // Na캜ti zpr치vy p콏칤mo z Firebase pro jistotu
            try {
                const snap = await firebaseDB.ref('chat/private/' + myName).orderByChild('timestamp').limitToLast(100).once('value');
                const allMsgs = snap.val() || {};
                const msgArray = Object.values(allMsgs);
                
                console.log('游닓 Inbox: na캜teno', msgArray.length, 'zpr치v pro', myName);
                
                // Aktualizuj privateMessages
                privateMessages = {};
                msgArray.forEach(msg => {
                    // P콏esko캜 zpr치vy bez from nebo to (corrupted data)
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    // P콏esko캜 undefined/null konverzace
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    privateMessages[other].push(msg);
                });
            } catch (e) {
                console.error('Chyba na캜칤t치n칤 zpr치v:', e);
            }
            
            // Z칤skej v코echny konverzace
            const conversations = Object.entries(privateMessages).map(([name, msgs]) => {
                const sortedMsgs = msgs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                const lastMsg = sortedMsgs[0];
                const unreadCount = sortedMsgs.filter(m => m.from !== myName && !m.read).length;
                return {
                    name,
                    lastMsg,
                    unreadCount,
                    timestamp: lastMsg?.timestamp || 0
                };
            }).sort((a, b) => b.timestamp - a.timestamp);
            
            let html = '';
            
            if (conversations.length === 0) {
                html = `
                    <div style="text-align: center; padding: 2rem; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游닔</div>
                        <p>Zat칤m nem치코 쮂멳n칠 zpr치vy.</p>
                        <p style="font-size: 0.85rem;">Klikni na hr치캜e v 쬰b콏칤캜ku a po코li mu zpr치vu!</p>
                    </div>
                `;
            } else {
                html = '<div style="max-height: 350px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                conversations.forEach(conv => {
                    const timeStr = conv.lastMsg?.timestamp ? new Date(conv.lastMsg.timestamp).toLocaleString('cs-CZ', {day: 'numeric', month: 'numeric', hour: '2-digit', minute: '2-digit'}) : '';
                    const isFromMe = conv.lastMsg?.from === myName;
                    const preview = conv.lastMsg?.text ? (conv.lastMsg.text.substring(0, 40) + (conv.lastMsg.text.length > 40 ? '...' : '')) : '콯치dn치 zpr치va';
                    
                    html += `
                        <div onclick="showPrivateChat('${escapeHtml(conv.name)}')" style="display: flex; align-items: center; gap: 0.8rem; background: ${conv.unreadCount > 0 ? '#1a2a3a' : '#1a1a1a'}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border-left: 3px solid ${conv.unreadCount > 0 ? '#2196f3' : '#333'};">
                            <div style="font-size: 2rem;">游녻</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #fff;">${escapeHtml(conv.name)}</span>
                                    ${conv.unreadCount > 0 ? `<span style="background: #2196f3; color: #fff; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 10px;">${conv.unreadCount}</span>` : ''}
                                </div>
                                <div style="font-size: 0.8rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${isFromMe ? '<span style="color: #666;">Ty: </span>' : ''}${escapeHtml(preview)}
                                </div>
                                <div style="font-size: 0.7rem; color: #555; margin-top: 0.2rem;">${timeStr}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            html += `
                <div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid #333;">
                    <button class="btn" onclick="showNewMessageModal()" style="width: 100%; background: #e91e63; margin-bottom: 0.5rem;">
                        九괦잺 Napsat novou zpr치vu
                    </button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;"> Zav콏칤t</button>
                </div>
            `;
            
            showModal('游닓 Soukrom칠 zpr치vy', html);
        }
        
        // Napsat novou zpr치vu - vybrat p콏칤jemce
        async function showNewMessageModal() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Na캜ti online hr치캜e
            let onlinePlayers = [];
            try {
                const snapshot = await firebaseDB.ref('online').once('value');
                const data = snapshot.val() || {};
                onlinePlayers = Object.values(data).filter(p => p.name !== getPlayerName());
            } catch (e) {}
            
            let html = `
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">P콏칤jemce (jm칠no hr치캜e):</label>
                    <input type="text" id="newMsgRecipient" placeholder="Zadej jm칠no hr치캜e..."
                        style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                </div>
            `;
            
            if (onlinePlayers.length > 0) {
                html += `<p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">Online hr치캜i:</p>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem;">`;
                onlinePlayers.slice(0, 10).forEach(p => {
                    html += `<button class="btn" onclick="document.getElementById('newMsgRecipient').value='${escapeHtml(p.name)}'" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #333;">游릭 ${escapeHtml(p.name)}</button>`;
                });
                html += `</div>`;
            }
            
            if (friendsList.length > 0) {
                html += `<p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">P콏치tel칠:</p>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem;">`;
                friendsList.slice(0, 10).forEach(name => {
                    html += `<button class="btn" onclick="document.getElementById('newMsgRecipient').value='${escapeHtml(name)}'" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #1a3a1a;">游논 ${escapeHtml(name)}</button>`;
                });
                html += `</div>`;
            }
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="showInbox()" style="background: #555;"> Zp캩t</button>
                    <button class="btn" onclick="startNewConversation()" style="background: #e91e63;">游눫 Otev콏칤t chat</button>
                </div>
            `;
            
            showModal('九괦잺 Nov치 zpr치va', html);
        }
        
        function startNewConversation() {
            const input = document.getElementById('newMsgRecipient');
            if (!input || !input.value.trim()) {
                notifyWarning('Zadej jm칠no p콏칤jemce!');
                return;
            }
            
            const recipient = input.value.trim();
            if (recipient === getPlayerName()) {
                notifyWarning('Nem콢쬰코 ps치t s치m sob캩!');
                return;
            }
            
            showPrivateChat(recipient);
        }
        
        // === D츼RKY ===
        function sendGift(friendName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Vyfiltruj itemy kter칠 lze darovat
            const giftableItems = state.inv.filter(item => 
                item && item.id && !item.questItem && (item.price || item.value) > 0
            );
            
            if (giftableItems.length === 0) {
                showModal('游꾸 Odeslat d치rek', `
                    <p style="color: #888; text-align: center;">Nem치코 쮂멳n칠 itemy k darov치n칤.</p>
                    <button class="btn" onclick="showFriendsModal()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>
                `);
                return;
            }
            
            let html = `<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
            giftableItems.slice(0, 20).forEach((item, idx) => {
                const realIdx = state.inv.indexOf(item);
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.5rem;">${item.icon}</span>
                        <div style="flex: 1;">
                            <div style="color: #fff;">${escapeHtml(item.name)} ${item.count > 1 ? `<span style="color: #ffd700;">x${item.count}</span>` : ''}</div>
                        </div>
                        <button class="btn" onclick="confirmSendGift('${escapeHtml(friendName)}', ${realIdx})" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">游꾸</button>
                    </div>
                `;
            });
            html += `</div>`;
            html += `<button class="btn" onclick="showFriendsModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>`;
            
            showModal(`游꾸 Poslat d치rek: ${escapeHtml(friendName)}`, html);
        }
        
        async function confirmSendGift(friendName, itemIdx) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const item = state.inv[itemIdx];
            if (!item) return;
            
            const myName = getPlayerName();
            
            try {
                // Odeber z invent치콏e
                const giftItem = {...item, count: 1};
                if (item.count > 1) {
                    state.inv[itemIdx].count--;
                } else {
                    state.inv.splice(itemIdx, 1);
                }
                
                // Po코li d치rek
                await firebaseDB.ref('gifts/' + friendName).push({
                    from: myName,
                    item: giftItem,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Notifikace
                await firebaseDB.ref('notifications/' + friendName).push({
                    type: 'gift',
                    from: myName,
                    itemName: item.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                notifySuccess('D치rek odesl치n!', `${item.name} byl odesl치n hr치캜i ${friendName}`);
                saveGame();
                showFriendsModal();
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se odeslat d치rek');
            }
        }
        
        // P콏ijmout d치rky
        function checkGifts() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            firebaseDB.ref('gifts/' + myName).once('value', async (snap) => {
                const gifts = snap.val();
                if (!gifts) return;
                
                for (const [key, gift] of Object.entries(gifts)) {
                    // P콏idej item
                    addItemToInventory(gift.item, 1, true);
                    notifySuccess('游꾸 D치rek!', `${gift.from} ti poslal ${gift.item.name}`);
                    
                    // Sma z datab치ze
                    await firebaseDB.ref('gifts/' + myName + '/' + key).remove();
                }
                saveGame();
            });
        }
        
        // === VYLEPEN칄 OBCHODOV츼N칈 ===
        
        // Historie transakc칤
        let tradeHistory = [];
        
        function listenToTradeHistory() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const sanitizedName = sanitizeFirebasePath(myName);
            firebaseDB.ref('tradeHistory/' + sanitizedName).orderByChild('timestamp').limitToLast(100).on('value', (snap) => {
                tradeHistory = Object.values(snap.val() || {}).sort((a, b) => b.timestamp - a.timestamp);
            });
        }
        
        // Hodnocen칤 prodejce
        async function rateSeller(sellerName, rating) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                await firebaseDB.ref('ratings/' + sellerName + '/' + myName).set({
                    rating: rating,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                notifySuccess('Hodnocen칤 ulo쬰no!', `Dal jsi ${rating}救 hr치캜i ${sellerName}`);
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se ulo쬴t hodnocen칤');
            }
        }
        
        // Z칤skat pr콢m캩rn칠 hodnocen칤 prodejce
        async function getSellerRating(sellerName) {
            if (!multiplayerEnabled || !firebaseDB) return { avg: 0, count: 0 };
            
            try {
                const snap = await firebaseDB.ref('ratings/' + sellerName).once('value');
                const ratings = Object.values(snap.val() || {});
                if (ratings.length === 0) return { avg: 0, count: 0 };
                
                const sum = ratings.reduce((a, b) => a + b.rating, 0);
                return { avg: (sum / ratings.length).toFixed(1), count: ratings.length };
            } catch (e) {
                return { avg: 0, count: 0 };
            }
        }
        
        // Zobrazit historii obchod콢
        async function showTradeHistory() {
            if (!multiplayerEnabled) {
                showModal('游닆 Historie tr쬴코t캩', '<p style="color: #888; text-align: center;">Multiplayer nen칤 aktivn칤</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            showModal('游닆 Historie tr쬴코t캩', '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p>Na캜칤t치m historii...</p></div>');
            
            try {
                // Na캜ti VE콎EJNOU historii - v코echny obchody mezi hr치캜i
                const snap = await firebaseDB.ref('publicTradeHistory').orderByChild('timestamp').limitToLast(100).once('value');
                const allTrades = Object.values(snap.val() || {}).sort((a, b) => b.timestamp - a.timestamp);
                
                let html = `
                    <p style="color: #888; text-align: center; font-size: 0.85rem; margin-bottom: 1rem;">
                        游늵 Ve콏ejn칳 p콏ehled v코ech obchod콢 na tr쬴코ti
                    </p>
                    <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                `;
                
                if (allTrades.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">Zat칤m 쮂멳n칠 obchody na tr쬴코ti</p>';
                } else {
                    const myName = getPlayerName();
                    allTrades.forEach(trade => {
                        const date = new Date(trade.timestamp).toLocaleDateString('cs-CZ');
                        const time = new Date(trade.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'});
                        const isMyTrade = trade.seller === myName || trade.buyer === myName;
                        const isSeller = trade.seller === myName;
                        const isBuyer = trade.buyer === myName;
                        
                        // Zv칳razn캩n칤 vlastn칤ch obchod콢
                        const bgColor = isMyTrade ? '#1a2a1a' : '#1a1a1a';
                        const borderColor = isSeller ? '#4CAF50' : (isBuyer ? '#2196f3' : '#555');
                        
                        html += `
                            <div style="background: ${bgColor}; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; border-left: 3px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${trade.itemIcon || '游닍'}</span>
                                    <div style="flex: 1;">
                                        <div style="color: #fff; font-weight: bold;">
                                            ${trade.count > 1 ? trade.count + 'x ' : ''}${escapeHtml(trade.itemName)}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #888; margin-top: 0.2rem;">
                                            <span style="color: ${trade.seller === myName ? '#4CAF50' : '#aaa'};">${escapeHtml(trade.seller)}</span>
                                            <span style="color: #666;">  </span>
                                            <span style="color: ${trade.buyer === myName ? '#2196f3' : '#aaa'};">${escapeHtml(trade.buyer)}</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #ffd700; font-weight: bold;">${trade.price} 游눯</div>
                                        <div style="font-size: 0.65rem; color: #666;">${trade.pricePerUnit ? trade.pricePerUnit + '/ks' : ''}</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.65rem; color: #555; text-align: right; margin-top: 0.3rem;">
                                    ${date} ${time}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                html += `
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="showMyTradeHistory()" style="flex: 1; background: #2196f3;">游늶 Moje obchody</button>
                        <button class="btn" onclick="showMarketplace()" style="flex: 1; background: #555;"> Zp캩t</button>
                    </div>
                `;
                
                showModal('游닆 Historie tr쬴코t캩', html);
                
            } catch (e) {
                console.error('Chyba p콏i na캜칤t치n칤 historie:', e);
                showModal('游닆 Historie tr쬴코t캩', '<p style="color: #f44336; text-align: center;">Chyba p콏i na캜칤t치n칤</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
            }
        }
        
        // Moje osobn칤 historie obchod콢
        async function showMyTradeHistory() {
            if (!multiplayerEnabled) return;
            
            showModal('游늶 Moje obchody', '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p>Na캜칤t치m...</p></div>');
            
            try {
                const myName = getPlayerName();
                const sanitizedName = sanitizeFirebasePath(myName);
                const snap = await firebaseDB.ref('tradeHistory/' + sanitizedName).orderByChild('timestamp').limitToLast(50).once('value');
                const myTrades = Object.values(snap.val() || {}).sort((a, b) => b.timestamp - a.timestamp);
                
                let html = '<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                if (myTrades.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">콯치dn칠 obchody</p>';
                } else {
                    myTrades.forEach(trade => {
                        const date = new Date(trade.timestamp).toLocaleDateString('cs-CZ');
                        const isBuy = trade.type === 'buy';
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${isBuy ? '#2196f3' : '#4CAF50'};">
                                <span style="font-size: 1.3rem;">${trade.itemIcon || '游닍'}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(trade.itemName)}</div>
                                    <div style="font-size: 0.75rem; color: #888;">
                                        ${isBuy ? ' Koupeno od' : ' Prod치no'} <strong>${escapeHtml(trade.otherPlayer)}</strong>  ${date}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${isBuy ? '#f44336' : '#4CAF50'}; font-weight: bold;">${isBuy ? '-' : '+'}${trade.price} 游눯</div>
                                </div>
                            </div>
                        `;
                    });
                }
                html += '</div>';
                html += `<button class="btn" onclick="showTradeHistory()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t na historii</button>`;
                
                showModal('游늶 Moje obchody', html);
                
            } catch (e) {
                console.error('Chyba:', e);
            }
        }
        
        // === ANTI-CHEAT SYST칄M ===
        
        // Validace itemu p콏ed prodejem
        function validateItemForSale(item) {
            if (!item || !item.id) return { valid: false, reason: 'Neplatn칳 item' };
            
            // Kontrola z치kladn칤ch vlastnost칤
            const itemDef = ITEMS.find(i => i.id === item.id);
            if (!itemDef) return { valid: false, reason: 'Nezn치m칳 item' };
            
            // Kontrola podez콏el칳ch hodnot
            if (item.damage && item.damage > 500) return { valid: false, reason: 'Podez콏ele vysok칳 damage' };
            if (item.defense && item.defense > 300) return { valid: false, reason: 'Podez콏ele vysok치 obrana' };
            if (item.count && item.count > 9999) return { valid: false, reason: 'Podez콏ele vysok칳 po캜et' };
            
            // Kontrola durability
            if (item.durability !== undefined && item.maxDurability !== undefined) {
                if (item.durability > item.maxDurability) return { valid: false, reason: 'Neplatn치 durabilita' };
            }
            
            return { valid: true };
        }
        
        // Validace hr치캜sk칳ch statistik
        function validatePlayerStats() {
            const issues = [];
            
            // Level check
            if (state.char.level > 100) issues.push('Podez콏el칳 level');
            if (state.char.level < 1) issues.push('Neplatn칳 level');
            
            // HP check
            if (state.hp > 9999) issues.push('Podez콏el칠 HP');
            if (state.maxHp > 9999) issues.push('Podez콏el칠 max HP');
            
            // Pen칤ze check
            if (state.money > 99999999) issues.push('Podez콏el칠 mno쬽tv칤 pen캩z');
            if (state.money < 0) issues.push('Z치porn칠 pen칤ze');
            
            // Stats check
            if (state.stats) {
                if (state.stats.kills > 99999) issues.push('Podez콏el칳 po캜et zabit칤');
                if (state.stats.daysPlayed > 9999) issues.push('Podez콏el칳 po캜et dn칤');
            }
            
            return issues;
        }
        
        // Odeslat report podez콏el칠ho hr치캜e
        async function reportPlayer(playerName, reason) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                await firebaseDB.ref('reports').push({
                    reporter: myName,
                    reported: playerName,
                    reason: reason,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                notifySuccess('Report odesl치n', `Hr치캜 ${playerName} byl nahl치코en`);
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se odeslat report');
            }
        }
        
        // Kontrola p콏ed odesl치n칤m sk칩re
        const originalSubmitScore = submitScore;
        submitScore = async function() {
            const issues = validatePlayerStats();
            if (issues.length > 0) {
                console.warn('丘멆잺 Anti-cheat varov치n칤:', issues);
                // St치le ode코li, ale s flagy
            }
            return originalSubmitScore();
        };
        
        // Kontrola p콏ed prodejem na marketplace
        const originalCreateMarketOffer = createMarketOffer;
        createMarketOffer = async function(item, price) {
            const validation = validateItemForSale(item);
            if (!validation.valid) {
                notifyWarning('Nelze prodat', validation.reason);
                return;
            }
            
            // Kontrola ceny
            if (price > 999999) {
                notifyWarning('P콏칤li코 vysok치 cena', 'Maxim치ln칤 cena je 999,999 游눯');
                return;
            }
            
            return originalCreateMarketOffer(item, price);
        };
        
        // === INICIALIZACE VYLEPEN칈 ===
        
        // P콏idej do Firebase init
        const originalInitFirebase = initFirebase;
        initFirebase = function() {
            const result = originalInitFirebase();
            
            // Po 칰sp캩코n칠m p콏ipojen칤 inicializuj nov칠 syst칠my
            setTimeout(() => {
                if (multiplayerEnabled) {
                    initFriendsSystem();
                    initTombolaListener();
                    listenToTradeHistory();
                    checkGifts();
                    restoreTerritoryCapture(); // Obnov rozd캩lan칳 capture po refreshi
                }
            }, 1000);
            
            return result;
        };
        
        // P콏idej tla캜칤tko p콏치tel do renderMultiplayerTab
        const originalRenderMultiplayerTab = renderMultiplayerTab;
        renderMultiplayerTab = function() {
            let html = originalRenderMultiplayerTab();
            
            // Definuj myName pro pou쬴t칤 v 코ablon캩
            const myName = getPlayerName();
            
            // P콏idej sekci p콏치tel p콏ed CONNECTION STATUS
            const friendsSection = `
                <!-- TERMINAL SOCIAL SECTION -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 0.5rem;">
                    <button class="btn" onclick="showFriendsModal()" style="background: linear-gradient(180deg, #100a10 0%, #080408 100%); border: 1px solid #3a2a3a; padding: 0.5rem; border-radius: 2px; display: flex; align-items: center; gap: 0.3rem; font-family: 'Courier New', monospace;">
                        <span>游논</span>
                        <span style="font-size: 0.7rem; color: #7a5a7a;">P콎츼TEL칄 [${friendsList.length}]</span>
                    </button>
                    <button class="btn" onclick="showTombola()" style="background: linear-gradient(180deg, #100a0a 0%, #080404 100%); border: 1px solid #3a2a2a; padding: 0.5rem; border-radius: 2px; display: flex; align-items: center; gap: 0.3rem; font-family: 'Courier New', monospace;">
                        <span>游勇</span>
                        <span style="font-size: 0.7rem; color: #9a5a6a;">${currentTombola ? 'TOMBOLA [!]' : 'TOMBOLA'}</span>
                    </button>
                </div>
                
                <!-- TERMINAL UTILS -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-top: 3px;">
                    <button class="btn" onclick="showBugReportModal()" style="background: #0a0a0a; border: 1px solid #2a2a1a; padding: 0.4rem; border-radius: 2px; font-family: 'Courier New', monospace;">
                        <span style="font-size: 0.65rem; color: #6a6a4a;">游냍 BUG REPORT</span>
                    </button>
                    <button class="btn" onclick="checkPendingRewards()" style="background: #0a0a0a; border: 1px solid #1a2a1a; padding: 0.4rem; border-radius: 2px; font-family: 'Courier New', monospace;">
                        <span style="font-size: 0.65rem; color: #5a7a5a;">游꾸 ODM캨NY</span>
                    </button>
                </div>
                
                <!-- TERMINAL SINGLE BUTTONS -->
                <button class="btn" onclick="showIdeasModal()" style="width: 100%; margin-top: 3px; background: #0a0a0a; border: 1px solid #2a2a1a; padding: 0.4rem; border-radius: 2px; font-family: 'Courier New', monospace;">
                    <span style="font-size: 0.65rem; color: #8a7a4a;">游눠 N츼PADY NA HRU</span>
                </button>
                
                <button class="btn" onclick="showDonateStep1()" style="width: 100%; margin-top: 3px; background: linear-gradient(180deg, #150808 0%, #0a0404 100%); border: 1px solid #3a1a1a; padding: 0.4rem; border-radius: 2px; font-family: 'Courier New', monospace;">
                    <span style="font-size: 0.65rem; color: #9a5a5a;">驕 PODPO콎IT AUTORA 仇벒잺</span>
                </button>
                
                <button class="btn" onclick="showHallOfFame()" style="width: 100%; margin-top: 3px; background: linear-gradient(180deg, #0f0a10 0%, #080508 100%); border: 1px solid #2a1a2a; padding: 0.4rem; border-radius: 2px; font-family: 'Courier New', monospace;">
                    <span style="font-size: 0.65rem; color: #8a6a9a;">游녬 S칈켾 SL츼VY 游끥</span>
                </button>
                
                <button class="btn" onclick="openCommunityLinks()" style="width: 100%; margin-top: 3px; background: #0a0a0a; border: 1px solid #2a1a0a; padding: 0.4rem; border-radius: 2px; font-family: 'Courier New', monospace;">
                    <span style="font-size: 0.65rem; color: #8a5a3a;">游깷 KOMUNITA</span>
                </button>
                
                <!-- TERMINAL CHAT LOG -->
                ${chatMessages.length > 0 ? `
                    <div style="background: #050505; padding: 0.4rem; border-radius: 2px; border: 1px solid #1a1a1a; margin-top: 0.5rem; font-family: 'Courier New', monospace;">
                        <div style="color: #333; font-size: 0.6rem; margin-bottom: 0.3rem;">> CHAT_LOG.tail(5)</div>
                        <div style="max-height: 80px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${chatMessages.slice(-5).reverse().map(msg => `
                                <div style="padding: 0.2rem; font-size: 0.65rem; border-left: 2px solid #222; padding-left: 0.3rem; margin-bottom: 2px;">
                                    <span style="color: ${msg.author === myName ? '#5a8a5a' : '#5a7a8a'};">${escapeHtml(msg.author)}></span>
                                    <span style="color: #666;">${escapeHtml(msg.text?.substring(0, 40) || '')}${(msg.text?.length || 0) > 40 ? '...' : ''}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- ADMIN BUTTON (skryt칳) -->
                <div style="margin-top: 1rem; text-align: center;">
                    <button onclick="showAdminLogin()" style="background: transparent; border: none; color: #333; font-size: 0.7rem; cursor: pointer; padding: 0.5rem;">丘뙖잺</button>
                </div>
            `;
            
            // Vlo p콏ed CONNECTION STATUS
            html = html.replace('<!-- CONNECTION STATUS -->', friendsSection + '\n                <!-- CONNECTION STATUS -->');
            
            return html;
        };
        
        // ============================================
        // 驕 DONATE - VTIPN츼 SEKVENCE MODAL콡
        // ============================================
        
        function showDonateStep1() {
            showModal('游뱂 Moment...', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">游븷</div>
                    <h3 style="color: #e91e63;">Po캜kat, po캜kat...</h3>
                    <p style="color: #888; font-size: 1.1rem; margin: 1rem 0;">
                        Ty chce코 DOBROVOLN캨 poslat pen칤ze?
                    </p>
                    <p style="color: #666; font-size: 0.9rem;">
                        V roce 2026? V t칠hle ekonomice?
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 1rem;">
                        游끢 Ut칤k치m pry캜
                    </button>
                    <button class="btn" onclick="showDonateStep2()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 1rem;">
                        游눩 Ano, jsem 코칤lenec
                    </button>
                </div>
            `);
        }
        
        function showDonateStep2() {
            showModal('游땸 V치쬹캩?!', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">游삒</div>
                    <h3 style="color: #ff9800;">Ale... jsi si 칔PLN캨 jist칳?</h3>
                    <p style="color: #888; font-size: 1.1rem; margin: 1rem 0;">
                        V칤코 쬰 ta hra je zadarmo, 쬰 jo?
                    </p>
                    <p style="color: #666; font-size: 0.9rem;">
                        Mohl bys si za to koupit... nev칤m... <br>
                        p콢lku rohl칤ku? 游볬
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 1rem;">
                        游볬 Rad코i ten rohl칤k
                    </button>
                    <button class="btn" onclick="showDonateStep3()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem;">
                        游댠 Rohl칤ky jsou p콏ecen캩n칠
                    </button>
                </div>
            `);
        }
        
        function showDonateStep3() {
            showModal('游봌 Posledn칤 코ance ut칠ct', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">游뚿</div>
                    <h3 style="color: #f44336;">VAROV츼N칈!</h3>
                    <p style="color: #888; font-size: 1.1rem; margin: 1rem 0;">
                        Za tyto pen칤ze autor pravd캩podobn캩 koup칤:
                    </p>
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                        <div style="color: #ff9800; margin: 0.3rem 0;">驕 Kafe (hodn캩 kafe)</div>
                        <div style="color: #ff9800; margin: 0.3rem 0;">游꼣 N캩jakou pizzu</div>
                        <div style="color: #ff9800; margin: 0.3rem 0;">游땺 Mo쬹치 i sp치nek (nepravd캩podobn칠)</div>
                        <div style="color: #f44336; margin: 0.3rem 0;">仇 Ur캜it캩 NE nov칠 bugy do hry</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 1rem;">
                        游땐 Ok, p콏ehodnot칤m to
                    </button>
                    <button class="btn" onclick="showDonateStep4()" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem;">
                        游붲 Jsem hrdina!
                    </button>
                </div>
            `);
        }
        
        function showDonateStep4() {
            showModal('游꿀 LEGENDA!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin: 1rem 0;">游끥仇벒잺游끥</div>
                    <h3 style="color: #4caf50; font-size: 1.5rem;">Ty jsi absolutn칤 LEGENDA!</h3>
                    <p style="color: #888; font-size: 1rem; margin: 1rem 0;">
                        War never changes... ale tvoje karma pr치v캩 stoupla na maximum! 驕뮖잺
                    </p>
                    
                    <div style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; border: 2px solid #4caf50;">
                        <p style="color: #8bc34a; margin: 0 0 0.5rem 0; font-size: 0.9rem;">游님 캛칤slo 칰캜tu:</p>
                        <p style="color: #fff; font-size: 1.4rem; font-weight: bold; margin: 0; font-family: monospace; letter-spacing: 1px;">
                            3103143163/0800
                        </p>
                        <p style="color: #666; font-size: 0.8rem; margin: 0.5rem 0 0 0;">
                            (캛esk치 spo콏itelna)
                        </p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; border: 2px solid #e91e63; margin-bottom: 1rem;">
                        <p style="color: #e91e63; margin: 0 0 0.5rem 0; font-weight: bold;">丘멆잺 D콡LE콯IT칄!</p>
                        <p style="color: #fff; margin: 0; font-size: 0.95rem;">
                            Do zpr치vy pro p콏칤jemce napi코 sv콢j <strong style="color: #ffd700;">HERN칈 NICK</strong>!
                        </p>
                        <p style="color: #888; margin: 0.5rem 0 0 0; font-size: 0.85rem;">
                            Bude코 nav쬯y zaps치n v <strong style="color: #e91e63;">S칤ni Sl치vy</strong> 
                            a dostane코 speci치ln칤 odm캩nu ve h콏e! 游꾸
                        </p>
                    </div>
                    
                    <button class="btn" onclick="showHallOfFame()" style="width: 100%; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 0.8rem; margin-bottom: 0.5rem;">
                        游녬 Zobrazit S칤켿 Sl치vy
                    </button>
                    
                    <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">
                        PS: Je코t캩 jedna v캩c... vlastn캩 ne, tentokr치t ti jdu jen pod캩kovat! 游볷
                    </p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem; font-size: 1.1rem;">
                    仇벒잺 Zav콏칤t (a b칳t 칰쬬sn칳)
                </button>
            `);
        }
        
        // === S칈켾 SL츼VY - P콎ISP캨VATEL칄 ===
        async function showHallOfFame() {
            // Seznam p콏isp캩vatel콢 - na캜칤t치 se z Firebase + hardcoded legendy
            let donors = [];
            let hofEntries = [];
            
            // Hardcoded legendy (v쬯y zobrazeni)
            const legends = [
                { name: 'MrBeeCZ', amount: 999999, subtitle: 'Nositel legend치rn칤 zbran캩 "Pen캩쬰nka Zk치zy" 游눯' },
                { name: 'Musters/CZE', amount: 999998, subtitle: 'P콏e쬴l 1000 radscorpion콢 jen aby mohl donate-ovat 游북' },
                { name: 'Denny', amount: 999997, subtitle: 'Ten co reportuje bugy rychleji ne je st칤h치m opravit 游냍' },
                { name: 'HLB', amount: 999996, subtitle: 'Ekonomika pustiny se t콏ese, kdy se p콏ihl치s칤 游눯' },
                { name: 'Samai', amount: 999995, subtitle: 'Va콏칤 gul치코 tak dob콏e, 쬰 i zomb칤ci chod칤 na ve캜e콏i 游' },
                { name: 'Delli', amount: 999994, subtitle: 'Jedin치 p콏e쬴v코칤 co si d치v치 manik칰ru i b캩hem apokalypsy 游눈' },
                { name: 'Czipi', amount: 999993, subtitle: 'M치 tolik v칤캜ek, 쬰 by i Mr. House z치vid캩l 游꿣' },
                { name: 'CzechMateMan', amount: 999992, subtitle: '마chuje s mutanty a v쬯ycky vyhraje - mat na t콏i tahy! 鮫勇' },
                { name: 'Pot치p캩캜', amount: 999991, subtitle: 'War never changes... ale on se po콏치d pot치p칤 pro loot 游' }
            ];
            
            try {
                if (multiplayerEnabled && firebaseDB) {
                    // Na캜ti donory
                    const snap = await firebaseDB.ref('donors').orderByChild('amount').once('value');
                    const data = snap.val();
                    if (data) {
                        donors = Object.values(data).sort((a, b) => (b.amount || 0) - (a.amount || 0));
                    }
                    
                    // Na캜ti admin p콏idan칠 z치znamy
                    const hofSnap = await firebaseDB.ref('hallOfFame').once('value');
                    const hofData = hofSnap.val();
                    if (hofData) {
                        hofEntries = Object.values(hofData).map(e => ({ ...e, amount: 500000 })); // St콏edn칤 priorita
                    }
                }
            } catch (e) {
                console.log('Donors load error:', e);
            }
            
            // Spoj hardcoded legendy + admin z치znamy + Firebase donory
            const allEntries = [...legends, ...hofEntries, ...donors];
            // Odstra켿 duplicity (podle jm칠na)
            const uniqueEntries = allEntries.filter((entry, index, self) => 
                index === self.findIndex(e => e.name === entry.name)
            );
            // Se콏a캞 podle amount
            donors = uniqueEntries.sort((a, b) => (b.amount || 0) - (a.amount || 0));
            
            let donorsList = '';
            if (donors.length > 0) {
                donorsList = donors.map((d, i) => {
                    const medal = i === 0 ? '游볞' : i === 1 ? '游볟' : i === 2 ? '游볠' : '仇벒잺';
                    const subtitle = d.subtitle || '';
                    return `
                        <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #e91e63; display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 1.5rem;">${medal}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-weight: bold;">${escapeHtml(d.name || 'Anonym')}</div>
                                ${subtitle ? `<div style="color: #888; font-size: 0.75rem; font-style: italic;">${escapeHtml(subtitle)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                donorsList = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游끸勇</div>
                        <p style="font-size: 1.1rem;">S칤켿 Sl치vy je zat칤m pr치zdn치...</p>
                        <p style="font-size: 0.9rem;">Bu캞 PRVN칈 kdo se sem zap칤코e!</p>
                        <div style="font-size: 2rem; margin-top: 1rem;">游</div>
                    </div>
                `;
            }
            
            showModal('游녬 S칤켿 Sl치vy', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游끹勇九뻟릞勇</div>
                    <p style="color: #e91e63; font-size: 1.1rem; margin: 0.5rem 0;">
                        Hrdinov칠, kte콏칤 podpo콏ili tuto hru!
                    </p>
                    <p style="color: #666; font-size: 0.85rem;">
                        (A zaslou쮂 si v캩캜nou sl치vu... nebo aspo켿 uzn치n칤)
                    </p>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${donorsList}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showDonateStep1()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 0.8rem;">
                        驕 Chci b칳t taky!
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                         Zav콏칤t
                    </button>
                </div>
            `);
        }
        
        // ============================================
        // 游댏 ADMIN PANEL
        // ============================================
        
        const ADMIN_NICK = 'Zaoo';
        
        // === SYST칄M ROL칈 ===
        // Admin m치 pln치 pr치va, moder치to콏i omezen치
        const STAFF_ROLES = {
            admin: {
                name: 'Admin',
                icon: '游녬',
                color: '#f44336',
                badge: '游녬 ADMIN',
                permissions: ['all'] // V코echna pr치va
            },
            moderator: {
                name: 'Moder치tor',
                icon: '游띠勇',
                color: '#2196f3',
                badge: '游띠勇 MOD',
                permissions: ['chat', 'mute', 'marketplace', 'pvp', 'bugs', 'tombola', 'warzone', 'treasure'] // Omezen치 pr치va
            },
            helper: {
                name: 'Helper',
                icon: '游눜',
                color: '#4caf50',
                badge: '游눜 HELPER',
                permissions: ['chat', 'bugs'] // Minim치ln칤 pr치va
            }
        };
        
        // Seznam staff 캜len콢 - P콎IDEJ SEM NOV칄 MODER츼TORY
        let STAFF_MEMBERS = {
            'Zaoo': 'admin',
            // P콏idej moder치tory zde:
            // 'NickModeratora': 'moderator',
            // 'NickHelpera': 'helper',
        };
        
        function getStaffRole(playerName) {
            return STAFF_MEMBERS[playerName] || null;
        }
        
        function getStaffRoleData(playerName) {
            const role = getStaffRole(playerName);
            return role ? STAFF_ROLES[role] : null;
        }
        
        function hasPermission(permission) {
            const playerName = getPlayerName();
            const role = getStaffRole(playerName);
            if (!role) return false;
            const roleData = STAFF_ROLES[role];
            if (!roleData) return false;
            return roleData.permissions.includes('all') || roleData.permissions.includes(permission);
        }
        
        function isStaff() {
            return !!getStaffRole(getPlayerName());
        }
        let isAdminLoggedIn = false;
        
        function isAdmin() {
            const playerName = getPlayerName();
            return playerName === ADMIN_NICK;
        }
        
        function showAdminLogin() {
            // Kontrola jestli je hr치캜 staff podle nicku
            if (isStaff()) {
                isAdminLoggedIn = true;
                const roleData = getStaffRoleData(getPlayerName());
                notifySuccess(`游댑 ${roleData.name} p콏ihl치코en`, 'V칤tej zp캩t, ' + getPlayerName() + '!');
                showAdminPanel();
            } else {
                notifyWarning('仇 P콏칤stup odep콏en', 'Nem치코 administr치torsk치 pr치va');
            }
        }
        
        function checkAdminPassword() {
            // Ji nepot콏ebujeme - admin je podle nicku
            showAdminLogin();
        }
        
        function showAdminPanel() {
            if (!isStaff()) {
                notifyWarning('仇 P콏칤stup odep콏en', 'Pouze pro staff');
                return;
            }
            isAdminLoggedIn = true;
            
            const playerName = getPlayerName();
            const role = getStaffRole(playerName);
            const roleData = STAFF_ROLES[role];
            
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('游댏 Staff Panel', '<p style="color: #f44336; text-align: center;">Multiplayer nen칤 aktivn칤</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            // Generuj tla캜칤tka podle permissions
            let buttonsHtml = '';
            
            // Chat - pro v코echny staff
            if (hasPermission('chat')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManageChat()" style="background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游눫</span>
                        <div>
                            <div style="font-weight: bold;">Spr치va chatu</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Mazat zpr치vy v코ech hr치캜콢</div>
                        </div>
                    </button>
                `;
            }
            
            // Marketplace - moder치tor+
            if (hasPermission('marketplace')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManageMarketplace()" style="background: linear-gradient(135deg, #ff9800 0%, #e65100 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游낅</span>
                        <div>
                            <div style="font-weight: bold;">Spr치va tr쬴코t캩</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Mazat nab칤dky hr치캜콢</div>
                        </div>
                    </button>
                `;
            }
            
            // PvP - moder치tor+
            if (hasPermission('pvp')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManagePvP()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">丘덢잺</span>
                        <div>
                            <div style="font-weight: bold;">Spr치va PvP</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Mazat v칳zvy a souboje</div>
                        </div>
                    </button>
                `;
            }
            
            // Bug Reports - pro v코echny staff
            if (hasPermission('bugs')) {
                buttonsHtml += `
                    <button class="btn" onclick="showAdminBugReports()" style="background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游냍</span>
                        <div>
                            <div style="font-weight: bold;">Bug Reporty</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Nahl치코en칠 chyby od hr치캜콢</div>
                        </div>
                    </button>
                `;
            }
            
            // Mute - moder치tor+
            if (hasPermission('mute')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManageMutes()" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游댆</span>
                        <div>
                            <div style="font-weight: bold;">Mute hr치캜콢</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Ztlumit hr치캜e v chatu</div>
                        </div>
                    </button>
                `;
            }
            
            // Tombola - moder치tor+
            if (hasPermission('tombola')) {
                buttonsHtml += `
                    <button class="btn" onclick="showAdminTombola()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游勇</span>
                        <div>
                            <div style="font-weight: bold;">Tombola</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Vytvo콏it/spravovat tombolu</div>
                        </div>
                    </button>
                `;
            }
            
            // V치le캜n치 z칩na - moder치tor+
            if (hasPermission('warzone')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminWarZone()" style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">丘덢잺</span>
                        <div>
                            <div style="font-weight: bold;">V치le캜n치 z칩na</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Vyhl치sit bitvu o 칰zem칤</div>
                        </div>
                    </button>
                `;
            }
            
            // Poklad - moder치tor+
            if (hasPermission('treasure')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminTreasure()" style="background: linear-gradient(135deg, #ffd700 0%, #ff8f00 100%); color: #000; padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游눑</span>
                        <div>
                            <div style="font-weight: bold;">Poklad</div>
                            <div style="font-size: 0.75rem; opacity: 0.6;">Um칤stit poklad na mapu</div>
                        </div>
                    </button>
                `;
            }
            
            // === POUZE PRO ADMINA ===
            if (isAdmin()) {
                buttonsHtml += `
                    <div style="border-top: 2px solid #f44336; margin: 0.5rem 0; padding-top: 0.5rem;">
                        <div style="color: #f44336; font-size: 0.75rem; text-align: center; margin-bottom: 0.5rem;">游녬 POUZE ADMIN</div>
                    </div>
                    
                    <button class="btn" onclick="adminManageLeaderboard()" style="background: linear-gradient(135deg, #ffd700 0%, #ff8f00 100%); color: #000; padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游끥</span>
                        <div>
                            <div style="font-weight: bold;">Spr치va 쬰b콏칤캜ku</div>
                            <div style="font-size: 0.75rem; opacity: 0.6;">Odebrat hr치캜e ze 쬰b콏칤캜ku</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="showAdminRewards()" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游꾸</span>
                        <div>
                            <div style="font-weight: bold;">Odm캩ny hr치캜콢m</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">D치t odm캩nu za vylep코en칤/n치pady</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="showAdminVIPColors()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游꿛</span>
                        <div>
                            <div style="font-weight: bold;">VIP Barvy</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Zm캩nit barvu nicku v chatu</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminResetPoker()" style="background: linear-gradient(135deg, #1a5a1a 0%, #2d8a2d 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游</span>
                        <div>
                            <div style="font-weight: bold;">Reset Pokeru</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Resetovat poker st콢l</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminManageHallOfFame()" style="background: linear-gradient(135deg, #ffd700 0%, #e91e63 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游끹勇</span>
                        <div>
                            <div style="font-weight: bold;">S칤켿 sl치vy</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">P콏idat/odebrat hr치캜e</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminManageBans()" style="background: linear-gradient(135deg, #b71c1c 0%, #7f0000 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游뛂</span>
                        <div>
                            <div style="font-weight: bold;">Ban hr치캜콢</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Zak치zat p콏칤stup do hry</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminClearCaptures()" style="background: linear-gradient(135deg, #795548 0%, #4e342e 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游낎</span>
                        <div>
                            <div style="font-weight: bold;">Vy캜istit Capture</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Odstranit zaseknut칠 obsazov치n칤</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="showStaffManager()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">游논</span>
                        <div>
                            <div style="font-weight: bold;">Spr치va Staff</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">P콏idat/odebrat moder치tory</div>
                        </div>
                    </button>
                `;
            }
            
            showModal(`${roleData.icon} ${roleData.name.toUpperCase()} PANEL`, `
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a1a 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid ${roleData.color};">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.5rem;">${roleData.icon}</span>
                        <span style="color: ${roleData.color}; font-weight: bold;">${roleData.name} re쬴m</span>
                    </div>
                    <p style="color: #888; font-size: 0.8rem; margin: 0;">P콏ihl치코en jako: <strong style="color: ${roleData.color};">${playerName}</strong></p>
                </div>
                
                <div style="display: grid; gap: 0.5rem; max-height: 60vh; overflow-y: auto;">
                    ${buttonsHtml}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">九 Zav콏칤t</button>
            `);
        }
        
        // Spr치va staff 캜len콢 (pouze admin)
        function showStaffManager() {
            if (!isAdmin()) {
                notifyWarning('仇 P콏칤stup odep콏en', 'Pouze pro admina');
                return;
            }
            
            let staffHtml = '<div style="max-height: 300px; overflow-y: auto;">';
            
            for (const [name, role] of Object.entries(STAFF_MEMBERS)) {
                const roleData = STAFF_ROLES[role];
                staffHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${roleData.color};">
                        <span>${roleData.icon} <strong>${name}</strong> - ${roleData.name}</span>
                        ${name !== ADMIN_NICK ? `<button class="btn" onclick="removeStaffMember('${name}')" style="background: #c62828; padding: 0.2rem 0.5rem; font-size: 0.75rem;">九</button>` : '<span style="color: #ffd700; font-size: 0.75rem;">Hlavn칤 admin</span>'}
                    </div>
                `;
            }
            staffHtml += '</div>';
            
            showModal('游논 Spr치va Staff', `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #888; margin: 0 0 0.5rem 0;">Aktu치ln칤 Staff:</h4>
                    ${staffHtml}
                </div>
                
                <div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #4caf50; margin: 0 0 0.5rem 0;">俱 P콏idat nov칠ho 캜lena:</h4>
                    <input type="text" id="newStaffNick" placeholder="Nick hr치캜e" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px;">
                    <select id="newStaffRole" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px;">
                        <option value="helper">游눜 Helper - pouze chat a bugy</option>
                        <option value="moderator">游띠勇 Moder치tor - chat, mute, tr쬴코t캩, PvP</option>
                    </select>
                    <button class="btn" onclick="addStaffMember()" style="width: 100%; background: #4caf50;">俱 P콏idat</button>
                </div>
                
                <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; font-size: 0.8rem; color: #888;">
                    <strong>Role:</strong><br>
                    游녬 <strong>Admin</strong> - v코echna pr치va<br>
                    游띠勇 <strong>Moder치tor</strong> - chat, mute, tr쬴코t캩, PvP, bugy<br>
                    游눜 <strong>Helper</strong> - chat, bugy
                </div>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t</button>
            `);
        }
        
        async function addStaffMember() {
            if (!isAdmin()) return;
            
            const nick = document.getElementById('newStaffNick')?.value?.trim();
            const role = document.getElementById('newStaffRole')?.value;
            
            if (!nick) {
                notifyWarning('Chyba', 'Zadej nick hr치캜e');
                return;
            }
            
            if (STAFF_MEMBERS[nick]) {
                notifyWarning('Chyba', 'Tento hr치캜 u je staff');
                return;
            }
            
            // P콏idej do STAFF_MEMBERS (pouze v pam캩ti - pro trval칠 p콏id치n칤 je t콏eba upravit k칩d)
            STAFF_MEMBERS[nick] = role;
            
            // Ulo do Firebase pro persistenci
            if (firebaseDB) {
                await firebaseDB.ref('adminData/staffMembers/' + nick.replace(/[\\/\\.#$\\[\\]]/g, '_')).set(role);
            }
            
            const roleData = STAFF_ROLES[role];
            notifySuccess('九 Staff p콏id치n', `${nick} je nyn칤 ${roleData.name}`);
            showStaffManager();
        }
        
        async function removeStaffMember(nick) {
            if (!isAdmin()) return;
            if (nick === ADMIN_NICK) {
                notifyWarning('Chyba', 'Nelze odebrat hlavn칤ho admina');
                return;
            }
            
            delete STAFF_MEMBERS[nick];
            
            // Odeber z Firebase
            if (firebaseDB) {
                await firebaseDB.ref('adminData/staffMembers/' + nick.replace(/[\\/\\.#$\\[\\]]/g, '_')).remove();
            }
            
            notifySuccess('九 Odebr치no', `${nick} byl odebr치n ze staff`);
            showStaffManager();
        }
        
        // Na캜ti staff 캜leny z Firebase p콏i startu
        async function loadStaffMembers() {
            if (!firebaseDB) return;
            
            try {
                const snap = await firebaseDB.ref('adminData/staffMembers').once('value');
                const data = snap.val();
                if (data) {
                    for (const [nick, role] of Object.entries(data)) {
                        if (!STAFF_MEMBERS[nick]) {
                            STAFF_MEMBERS[nick] = role;
                        }
                    }
                }
                console.log('游논 Staff na캜ten:', Object.keys(STAFF_MEMBERS));
            } catch (e) {
                console.error('Chyba p콏i na캜칤t치n칤 staff:', e);
            }
        }
        
        // === SPR츼VA CHATU ===
        async function adminManageChat() {
            if (!isStaff()) return;
            
            showModal('游눫 Spr치va chatu', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Na캜칤t치m zpr치vy...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('chat/messages').orderByChild('timestamp').limitToLast(100).once('value');
                const messages = [];
                snap.forEach(child => {
                    messages.push({ id: child.key, ...child.val() });
                });
                messages.reverse();
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                if (messages.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">콯치dn칠 zpr치vy</p>';
                } else {
                    messages.forEach(msg => {
                        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString('cs-CZ') : '?';
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <div style="flex: 1;">
                                    <div style="color: #2196f3; font-size: 0.8rem;">${escapeHtml(msg.author)} <span style="color: #555;">${time}</span></div>
                                    <div style="color: #ccc; font-size: 0.9rem;">${escapeHtml(msg.text?.substring(0, 50))}${msg.text?.length > 50 ? '...' : ''}</div>
                                </div>
                                <button onclick="adminDeleteChatMessage('${msg.id}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">游딈勇</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearAllChat()" style="background: #c62828;">游딈勇 Smazat VE</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;"> Zp캩t</button>
                    </div>
                `;
                
                showModal('游눫 Spr치va chatu', html);
            } catch (e) {
                showModal('游눫 Spr치va chatu', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>`);
            }
        }
        
        async function adminDeleteChatMessage(msgId) {
            if (!hasPermission('chat')) return;
            try {
                await firebaseDB.ref('chat/messages/' + msgId).remove();
                notifySuccess('Smaz치no', 'Zpr치va byla odstran캩na');
                adminManageChat();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllChat() {
            if (!isAdmin()) return; // Smazat VE m콢쬰 jen admin
            if (!confirm('Opravdu smazat VECHNY zpr치vy v chatu?')) return;
            
            try {
                await firebaseDB.ref('chat/messages').remove();
                notifySuccess('Chat smaz치n', 'V코echny zpr치vy byly odstran캩ny');
                adminManageChat();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === SPR츼VA TR콯IT캨 ===
        async function adminManageMarketplace() {
            if (!hasPermission('marketplace')) return;
            
            showModal('游낅 Spr치va tr쬴코t캩', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Na캜칤t치m nab칤dky...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('marketplace/offers').once('value');
                const offers = [];
                snap.forEach(child => {
                    offers.push({ id: child.key, ...child.val() });
                });
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                const activeOffers = offers.filter(o => o.status === 'active');
                if (activeOffers.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">콯치dn칠 aktivn칤 nab칤dky</p>';
                } else {
                    activeOffers.forEach(offer => {
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <span style="font-size: 1.3rem;">${offer.item?.icon || '游닍'}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(offer.item?.name || '?')} <span style="color: #ffd700;">${offer.price} 游눯</span></div>
                                    <div style="color: #888; font-size: 0.75rem;">Prod치v치: ${escapeHtml(offer.seller || '?')}</div>
                                </div>
                                <button onclick="adminDeleteOffer('${offer.id}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">游딈勇</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearAllOffers()" style="background: #c62828;">游딈勇 Smazat VE</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;"> Zp캩t</button>
                    </div>
                `;
                
                showModal('游낅 Spr치va tr쬴코t캩', html);
            } catch (e) {
                showModal('游낅 Spr치va tr쬴코t캩', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>`);
            }
        }
        
        async function adminDeleteOffer(offerId) {
            if (!hasPermission('marketplace')) return;
            try {
                await firebaseDB.ref('marketplace/offers/' + offerId).remove();
                notifySuccess('Smaz치no', 'Nab칤dka byla odstran캩na');
                adminManageMarketplace();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllOffers() {
            if (!isAdmin()) return; // Smazat VE m콢쬰 jen admin
            if (!confirm('Opravdu smazat VECHNY nab칤dky na tr쬴코ti?')) return;
            
            try {
                await firebaseDB.ref('marketplace/offers').remove();
                notifySuccess('Tr쬴코t캩 smaz치no', 'V코echny nab칤dky byly odstran캩ny');
                adminManageMarketplace();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === SPR츼VA 콯EB콎칈캛KU ===
        async function adminManageLeaderboard() {
            if (!isAdmin()) return;
            
            showModal('游끥 Spr치va 쬰b콏칤캜ku', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Na캜칤t치m 쬰b콏칤캜ek...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('leaderboard').orderByChild('score').once('value');
                const players = [];
                snap.forEach(child => {
                    players.push({ id: child.key, ...child.val() });
                });
                players.sort((a, b) => (b.score || 0) - (a.score || 0));
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                if (players.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">콯치dn칤 hr치캜i v 쬰b콏칤캜ku</p>';
                } else {
                    players.forEach((player, idx) => {
                        const medal = idx === 0 ? '游볞' : idx === 1 ? '游볟' : idx === 2 ? '游볠' : `${idx + 1}.`;
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <span style="min-width: 30px; text-align: center;">${medal}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(player.name || player.id)}</div>
                                    <div style="color: #888; font-size: 0.75rem;">Lvl ${player.level || '?'} | Score: ${(player.score || 0).toLocaleString()}</div>
                                </div>
                                <button onclick="adminDeletePlayer('${escapeHtml(player.id)}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">游딈勇</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearLeaderboard()" style="background: #c62828;">游딈勇 Smazat VE</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;"> Zp캩t</button>
                    </div>
                `;
                
                showModal('游끥 Spr치va 쬰b콏칤캜ku', html);
            } catch (e) {
                showModal('游끥 Spr치va 쬰b콏칤캜ku', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>`);
            }
        }
        
        async function adminDeletePlayer(playerId) {
            if (!isAdmin()) return;
            if (!confirm(`Opravdu odebrat hr치캜e "${playerId}" ze 쬰b콏칤캜ku?`)) return;
            
            try {
                await firebaseDB.ref('leaderboard/' + playerId).remove();
                await firebaseDB.ref('online/' + playerId).remove();
                notifySuccess('Smaz치no', 'Hr치캜 byl odebr치n ze 쬰b콏칤캜ku');
                adminManageLeaderboard();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearLeaderboard() {
            if (!isAdmin()) return;
            if (!confirm('Opravdu smazat CEL칗 쬰b콏칤캜ek? Tato akce je nevratn치!')) return;
            if (!confirm('JSTE SI OPRAVDU JISTI? V코echna sk칩re budou ztracena!')) return;
            
            try {
                await firebaseDB.ref('leaderboard').remove();
                notifySuccess('콯eb콏칤캜ek smaz치n', 'V코ichni hr치캜i byli odebr치ni');
                adminManageLeaderboard();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === SPR츼VA PVP ===
        async function adminManagePvP() {
            if (!hasPermission('pvp')) return;
            
            showModal('丘덢잺 Spr치va PvP', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Na캜칤t치m...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('pvp/challenges').once('value');
                const challenges = [];
                snap.forEach(child => {
                    challenges.push({ id: child.key, ...child.val() });
                });
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                if (challenges.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">콯치dn칠 PvP v칳zvy</p>';
                } else {
                    challenges.forEach(ch => {
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(ch.challenger || '?')} vs ${escapeHtml(ch.target || '?')}</div>
                                    <div style="color: #888; font-size: 0.75rem;">Status: ${ch.status || '?'} | S치zka: ${ch.bet || 0} 游눯</div>
                                </div>
                                <button onclick="adminDeleteChallenge('${ch.id}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">游딈勇</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearAllPvP()" style="background: #c62828;">游딈勇 Smazat VE</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;"> Zp캩t</button>
                    </div>
                `;
                
                showModal('丘덢잺 Spr치va PvP', html);
            } catch (e) {
                showModal('丘덢잺 Spr치va PvP', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>`);
            }
        }
        
        async function adminDeleteChallenge(challengeId) {
            if (!hasPermission('pvp')) return;
            try {
                await firebaseDB.ref('pvp/challenges/' + challengeId).remove();
                notifySuccess('Smaz치no', 'V칳zva byla odstran캩na');
                adminManagePvP();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllPvP() {
            if (!isAdmin()) return; // Smazat VE m콢쬰 jen admin
            if (!confirm('Opravdu smazat VECHNY PvP v칳zvy?')) return;
            
            try {
                await firebaseDB.ref('pvp/challenges').remove();
                notifySuccess('PvP smaz치no', 'V코echny v칳zvy byly odstran캩ny');
                adminManagePvP();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === ADMIN ODM캨NY ZA VYLEPEN칈 ===
        async function showAdminRewards() {
            if (!isAdmin()) return;
            
            // Na캜ti seznam hr치캜콢 z OBOU zdroj콢 - leaderboard i players
            let players = [];
            let playerNames = new Set();
            
            try {
                // 1. Z leaderboard
                const leaderboardSnap = await firebaseDB.ref('leaderboard').orderByChild('score').limitToLast(500).once('value');
                const leaderboardData = leaderboardSnap.val();
                
                if (leaderboardData) {
                    Object.entries(leaderboardData).forEach(([name, info]) => {
                        if (!name.startsWith('user_') || name.length < 20) {
                            players.push({
                                name,
                                level: info.level || 1,
                                score: info.score || 0
                            });
                            playerNames.add(name);
                        }
                    });
                }
                
                // 2. Z players - p콏idej ty co nejsou v leaderboardu
                const playersSnap = await firebaseDB.ref('players').limitToLast(500).once('value');
                const playersData = playersSnap.val();
                
                if (playersData) {
                    Object.entries(playersData).forEach(([name, info]) => {
                        if (!playerNames.has(name) && (!name.startsWith('user_') || name.length < 20)) {
                            players.push({
                                name,
                                level: info.level || 1,
                                score: info.score || 0
                            });
                            playerNames.add(name);
                        }
                    });
                }
                
                // Se콏a캞 podle score
                players.sort((a, b) => b.score - a.score);
                
                // P콏idej admina na za캜치tek seznamu pokud tam nen칤 (se spr치vn칳m levelem)
                const adminName = ADMIN_NICK || 'Zaoo';
                if (!playerNames.has(adminName)) {
                    const adminLevel = state.char?.level || 1;
                    const adminScore = state.stats?.score || 0;
                    players.unshift({ name: adminName, level: adminLevel, score: adminScore });
                }
                
                console.log('游늶 Na캜teno hr치캜콢 pro odm캩ny:', players.length);
            } catch (e) {
                console.error('Error loading players:', e);
            }
            
            // P콏eddefinovan칠 odm캩ny (ni쮄뫆 hodnoty pro vyv치쬰n칤)
            const rewardPresets = [
                { id: 'small', name: '游꾸 Mal치 odm캩na', money: 25, xp: 10, desc: 'Drobn칳 tip/oprava' },
                { id: 'medium', name: '游꾸 St콏edn칤 odm캩na', money: 50, xp: 25, desc: 'U쬴te캜n칳 n치pad' },
                { id: 'large', name: '游꾸 Velk치 odm캩na', money: 100, xp: 50, desc: 'V칳znamn칠 vylep코en칤' },
                { id: 'epic', name: '游끥 Epick치 odm캩na', money: 250, xp: 100, desc: 'Z치sadn칤 p콏칤sp캩vek' },
                { id: 'custom', name: '九勇 Vlastn칤', money: 0, xp: 0, desc: 'Nastavit ru캜n캩' }
            ];
            
            let playersHtml = players.length > 0 
                ? players.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)} (Lv.${p.level}, ${p.score} bod콢)</option>`).join('')
                : '<option value="">콯치dn칤 hr치캜i v 쬰b콏칤캜ku</option>';
            
            let presetsHtml = rewardPresets.map(r => `
                <option value="${r.id}" data-money="${r.money}" data-xp="${r.xp}">${r.name} - ${r.desc}</option>
            `).join('');
            
            // Seznam p콏edm캩t콢 pro v칳b캩r (rare+)
            const rewardItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legendary' || i.price >= 100)
                .sort((a, b) => (b.price || 0) - (a.price || 0));
            let itemsHtml = '<option value="">-- 콯치dn칳 p콏edm캩t --</option>' + 
                rewardItems.map(i => `<option value="${i.id}">${i.icon} ${i.name} ${i.rarity ? '(' + i.rarity + ')' : ''}</option>`).join('');
            
            showModal('游꾸 Odm캩ny za vylep코en칤', `
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4caf50;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.9rem;">
                        游눠 Zde m콢쬰코 d치t odm캩nu hr치캜콢m, kte콏칤 navrhli vylep코en칤 nebo nahl치sili chyby.
                    </p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游녻 Hr치캜: <span style="color: #4caf50;">(${players.length} hr치캜콢)</span></label>
                    <select id="rewardPlayerSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem; max-height: 300px;">
                        <option value="">-- Vyber hr치캜e --</option>
                        ${playersHtml}
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游꾸 Typ odm캩ny:</label>
                    <select id="rewardPresetSelect" onchange="updateRewardPreset()" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                        ${presetsHtml}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ffd700; font-size: 0.85rem;">游눯 Pen칤ze:</label>
                        <input type="number" id="rewardMoney" value="0" min="0" max="999999" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem; font-size: 1.1rem; font-weight: bold;">
                    </div>
                    <div>
                        <label style="color: #8bc34a; font-size: 0.85rem;">救 XP:</label>
                        <input type="number" id="rewardXP" value="0" min="0" max="999999" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #8bc34a; border: 1px solid #8bc34a; border-radius: 6px; margin-top: 0.3rem; font-size: 1.1rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ff9800; font-size: 0.85rem;">游댦 N치boje:</label>
                        <select id="rewardAmmo" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #ff9800; border-radius: 6px; margin-top: 0.3rem;">
                            <option value="">-- 콯치dn칠 --</option>
                            <option value="9mm">游댳 9mm pistole</option>
                            <option value="shell">游댲 Broky</option>
                            <option value="rifle">游댳 Pu코kov칠</option>
                            <option value="energy">丘 Energetick칠</option>
                            <option value="arrow">游낓 먞셣y</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ff9800; font-size: 0.85rem;">Po캜et:</label>
                        <input type="number" id="rewardAmmoCount" value="50" min="1" max="9999" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #ff9800; border: 1px solid #ff9800; border-radius: 6px; margin-top: 0.3rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div>
                        <label style="color: #9c7cff; font-size: 0.85rem;">游닍 P콏edm캩t:</label>
                        <select id="rewardItem" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #9c7cff; border-radius: 6px; margin-top: 0.3rem;">
                            ${itemsHtml}
                        </select>
                    </div>
                    <div>
                        <label style="color: #9c7cff; font-size: 0.85rem;">Po캜et:</label>
                        <input type="number" id="rewardItemCount" value="1" min="1" max="99" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #9c7cff; border: 1px solid #9c7cff; border-radius: 6px; margin-top: 0.3rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游닇 D콢vod (zobraz칤 se hr치캜i):</label>
                    <input type="text" id="rewardReason" placeholder="nap콏. N치vrh nov칠ho questu" maxlength="100" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                </div>
                
                <button class="btn" onclick="sendAdminReward()" style="width: 100%; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem; font-size: 1rem;">
                    游꾸 Odeslat odm캩nu
                </button>
                
                <button class="btn" onclick="showRewardHistory()" style="width: 100%; margin-top: 0.5rem; background: #2196f3;">
                    游늶 Historie odm캩n
                </button>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        function updateRewardPreset() {
            const select = document.getElementById('rewardPresetSelect');
            const option = select.options[select.selectedIndex];
            const money = option.dataset.money || 0;
            const xp = option.dataset.xp || 0;
            
            document.getElementById('rewardMoney').value = money;
            document.getElementById('rewardXP').value = xp;
        }
        
        async function sendAdminReward() {
            if (!isAdmin()) return;
            
            const playerName = document.getElementById('rewardPlayerSelect').value;
            const money = parseInt(document.getElementById('rewardMoney').value) || 0;
            const xp = parseInt(document.getElementById('rewardXP').value) || 0;
            const ammoType = document.getElementById('rewardAmmo')?.value || '';
            const ammoCount = parseInt(document.getElementById('rewardAmmoCount')?.value) || 0;
            const itemId = document.getElementById('rewardItem')?.value || '';
            const itemCount = parseInt(document.getElementById('rewardItemCount')?.value) || 1;
            const reason = document.getElementById('rewardReason').value.trim() || 'Odm캩na od admina';
            
            if (!playerName) {
                notifyWarning('Chyba', 'Vyber hr치캜e!');
                return;
            }
            
            if (money <= 0 && xp <= 0 && !itemId && !ammoType) {
                notifyWarning('Chyba', 'Nastav alespo켿 pen칤ze, XP, n치boje nebo p콏edm캩t!');
                return;
            }
            
            // Z칤skej info o p콏edm캩tu
            let itemData = null;
            if (itemId) {
                const item = ITEMS.find(i => i.id === itemId);
                if (item) {
                    itemData = {
                        id: item.id,
                        name: item.name,
                        icon: item.icon,
                        count: Math.min(itemCount, 99) // max 99 kus콢
                    };
                }
            }
            
            // Info o n치boj칤ch
            let ammoData = null;
            if (ammoType && ammoCount > 0) {
                const ammoNames = {
                    '9mm': '游댳 9mm',
                    'shell': '游댲 Broky',
                    'rifle': '游댳 Pu코kov칠',
                    'energy': '丘 Energetick칠',
                    'arrow': '游낓 먞셣y'
                };
                ammoData = {
                    type: ammoType,
                    count: Math.min(ammoCount, 9999),
                    name: ammoNames[ammoType] || ammoType
                };
            }
            
            try {
                // Sestav text zpr치vy
                let rewardText = [];
                if (money > 0) rewardText.push(money + '游눯');
                if (xp > 0) rewardText.push(xp + '救XP');
                if (ammoData) rewardText.push(ammoData.count + 'x ' + ammoData.name);
                if (itemData) rewardText.push(itemData.count + 'x ' + itemData.icon + ' ' + itemData.name);
                
                // Ulo odm캩nu do notifications (real-time listener)
                const rewardData = {
                    type: 'admin_reward',
                    money: money,
                    xp: xp,
                    ammo: ammoData,
                    item: itemData,
                    reason: reason,
                    from: ADMIN_NICK,
                    timestamp: Date.now(),
                    claimed: false
                };
                
                await firebaseDB.ref(`notifications/${playerName}`).push(rewardData);
                
                // Po코li tak칠 soukromou zpr치vu
                await firebaseDB.ref(`chat/private/${playerName}`).push({
                    from: ADMIN_NICK,
                    to: playerName,
                    text: `游꾸 M치코 novou odm캩nu! ${rewardText.join(', ')} - ${reason}`,
                    timestamp: Date.now(),
                    read: false
                });
                
                // Zaloguj
                await firebaseDB.ref('admin/rewardLog').push({
                    player: playerName,
                    money: money,
                    xp: xp,
                    item: itemData,
                    reason: reason,
                    admin: ADMIN_NICK,
                    timestamp: Date.now()
                });
                
                notifySuccess('Odm캩na odesl치na!', `${playerName} dostane ${rewardText.join(', ')}`);
                showAdminRewards();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Rychl치 admin odm캩na z profilu hr치캜e
        function showQuickReward(playerName) {
            if (!isAdmin()) return;
            
            // Seznam p콏edm캩t콢 pro v칳b캩r
            const rewardItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legendary' || i.price >= 100)
                .sort((a, b) => (b.price || 0) - (a.price || 0));
            let itemsHtml = '<option value="">-- 콯치dn칳 --</option>' + 
                rewardItems.map(i => `<option value="${i.id}">${i.icon} ${i.name}</option>`).join('');
            
            showModal(`游꾸 Odm캩na pro: ${escapeHtml(playerName)}`, `
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4caf50;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.85rem;">游녻 P콏칤jemce: <strong>${escapeHtml(playerName)}</strong></p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ffd700; font-size: 0.8rem;">游눯 Pen칤ze:</label>
                        <input type="number" id="qrMoney" value="0" min="0" max="999999" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="color: #8bc34a; font-size: 0.8rem;">救 XP:</label>
                        <input type="number" id="qrXP" value="0" min="0" max="999999" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #8bc34a; border: 1px solid #8bc34a; border-radius: 6px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ff9800; font-size: 0.8rem;">游댦 N치boje:</label>
                        <select id="qrAmmo" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #ff9800; border-radius: 6px;">
                            <option value="">-- 콯치dn칠 --</option>
                            <option value="9mm">游댳 9mm</option>
                            <option value="shell">游댲 Broky</option>
                            <option value="rifle">游댳 Pu코kov칠</option>
                            <option value="energy">丘 Energetick칠</option>
                            <option value="arrow">游낓 먞셣y</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ff9800; font-size: 0.8rem;">Po캜et:</label>
                        <input type="number" id="qrAmmoCount" value="50" min="1" max="9999" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #ff9800; border: 1px solid #ff9800; border-radius: 6px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #9c7cff; font-size: 0.8rem;">游닍 P콏edm캩t:</label>
                        <select id="qrItem" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #9c7cff; border-radius: 6px;">
                            ${itemsHtml}
                        </select>
                    </div>
                    <div>
                        <label style="color: #9c7cff; font-size: 0.8rem;">Po캜et:</label>
                        <input type="number" id="qrItemCount" value="1" min="1" max="99" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #9c7cff; border: 1px solid #9c7cff; border-radius: 6px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.8rem;">游닇 D콢vod:</label>
                    <input type="text" id="qrReason" placeholder="nap콏. Kompenzace za bug" maxlength="100" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px;">
                </div>
                
                <button class="btn" onclick="sendQuickReward('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="width: 100%; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.8rem;">
                    游꾸 Odeslat odm캩nu
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        async function sendQuickReward(playerName) {
            if (!isAdmin()) return;
            
            const money = parseInt(document.getElementById('qrMoney').value) || 0;
            const xp = parseInt(document.getElementById('qrXP').value) || 0;
            const ammoType = document.getElementById('qrAmmo').value;
            const ammoCount = parseInt(document.getElementById('qrAmmoCount').value) || 0;
            const itemId = document.getElementById('qrItem').value;
            const itemCount = parseInt(document.getElementById('qrItemCount').value) || 1;
            const reason = document.getElementById('qrReason').value.trim() || 'Odm캩na od admina';
            
            if (money <= 0 && xp <= 0 && !itemId && !ammoType) {
                notifyWarning('Chyba', 'Nastav alespo켿 n캩jakou odm캩nu!');
                return;
            }
            
            // P콏iprav data
            let itemData = null;
            if (itemId) {
                const item = ITEMS.find(i => i.id === itemId);
                if (item) {
                    itemData = { id: item.id, name: item.name, icon: item.icon, count: Math.min(itemCount, 99) };
                }
            }
            
            let ammoData = null;
            if (ammoType && ammoCount > 0) {
                const ammoNames = { '9mm': '游댳 9mm', 'shell': '游댲 Broky', 'rifle': '游댳 Pu코kov칠', 'energy': '丘 Energetick칠', 'arrow': '游낓 먞셣y' };
                ammoData = { type: ammoType, count: Math.min(ammoCount, 9999), name: ammoNames[ammoType] || ammoType };
            }
            
            try {
                // Sestav text
                let rewardText = [];
                if (money > 0) rewardText.push(money + '游눯');
                if (xp > 0) rewardText.push(xp + '救XP');
                if (ammoData) rewardText.push(ammoData.count + 'x ' + ammoData.name);
                if (itemData) rewardText.push(itemData.count + 'x ' + itemData.icon + ' ' + itemData.name);
                
                const rewardData = {
                    type: 'admin_reward',
                    money: money,
                    xp: xp,
                    ammo: ammoData,
                    item: itemData,
                    reason: reason,
                    from: ADMIN_NICK,
                    timestamp: Date.now(),
                    claimed: false
                };
                
                await firebaseDB.ref(`notifications/${playerName}`).push(rewardData);
                
                // Soukrom치 zpr치va
                await firebaseDB.ref(`chat/private/${playerName}`).push({
                    from: ADMIN_NICK,
                    to: playerName,
                    text: `游꾸 M치코 novou odm캩nu! ${rewardText.join(', ')} - ${reason}`,
                    timestamp: Date.now(),
                    read: false
                });
                
                // Log
                await firebaseDB.ref('admin/rewardLog').push({
                    player: playerName,
                    money: money,
                    xp: xp,
                    ammo: ammoData,
                    item: itemData,
                    reason: reason,
                    admin: ADMIN_NICK,
                    timestamp: Date.now()
                });
                
                notifySuccess('Odm캩na odesl치na!', `${playerName} dostane ${rewardText.join(', ')}`);
                closeModal();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === RYCHL칗 MUTE Z PROFILU ===
        function adminQuickMute(playerName) {
            if (!hasPermission('mute')) return;
            
            showModal(`游댆 Mute: ${escapeHtml(playerName)}`, `
                <div style="background: #1a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #607d8b;">
                    <p style="color: #90a4ae; margin: 0;">Ztlumit hr치캜e <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong> v chatu?</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">낌勇 Doba trv치n칤:</label>
                    <select id="muteDuration" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #607d8b; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="10">10 minut</option>
                        <option value="30">30 minut</option>
                        <option value="60" selected>1 hodina</option>
                        <option value="180">3 hodiny</option>
                        <option value="720">12 hodin</option>
                        <option value="1440">24 hodin</option>
                        <option value="10080">7 dn칤</option>
                        <option value="0">Permanentn캩</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游닇 D콢vod:</label>
                    <input type="text" id="muteReason" placeholder="nap콏. Spam, toxicita..." maxlength="100" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="executeQuickMute('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);">游댆 Ztlumit</button>
                </div>
            `);
        }
        
        // Rychl칠 p콏id치n칤 do staff z chatu
        function quickAddToStaff(playerName) {
            if (!isAdmin()) return;
            
            if (STAFF_MEMBERS[playerName]) {
                notifyWarning('Ji je staff', `${playerName} u je ${STAFF_ROLES[STAFF_MEMBERS[playerName]].name}`);
                return;
            }
            
            showModal(`游논 P콏idat do Staff: ${escapeHtml(playerName)}`, `
                <div style="background: #1a1a3a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #9c27b0;">
                    <p style="color: #ce93d8; margin: 0;">P콏idat <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong> do staff t칳mu?</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游꿠 Vyber roli:</label>
                    <select id="quickStaffRole" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #9c27b0; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="helper">游눜 Helper - pouze chat a bugy</option>
                        <option value="moderator">游띠勇 Moder치tor - chat, mute, tr쬴코t캩, PvP, bugy, tombola, warzone</option>
                    </select>
                </div>
                
                <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; font-size: 0.75rem; color: #888; margin-bottom: 1rem;">
                    <strong>Pr치va rol칤:</strong><br>
                    游눜 Helper: Spr치va chatu, Bug reporty<br>
                    游띠勇 Moder치tor: + Mute, Tr쬴코t캩, PvP, Tombola, Warzone
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="executeQuickAddStaff('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">游논 P콏idat</button>
                </div>
            `);
        }
        
        async function executeQuickAddStaff(playerName) {
            if (!isAdmin()) return;
            
            const role = document.getElementById('quickStaffRole')?.value || 'helper';
            
            STAFF_MEMBERS[playerName] = role;
            
            if (firebaseDB) {
                await firebaseDB.ref('adminData/staffMembers/' + playerName.replace(/[\\/\\.#$\\[\\]]/g, '_')).set(role);
            }
            
            const roleData = STAFF_ROLES[role];
            closeModal();
            notifySuccess('九 Staff p콏id치n', `${playerName} je nyn칤 ${roleData.icon} ${roleData.name}`);
        }
        
        async function executeQuickMute(playerName) {
            if (!hasPermission('mute')) return;
            
            const duration = parseInt(document.getElementById('muteDuration').value);
            const reason = document.getElementById('muteReason').value || 'Bez ud치n칤 d콢vodu';
            
            try {
                const muteData = {
                    player: playerName,
                    mutedBy: getPlayerName(), // Kdo mutnul (m콢쬰 b칳t mod)
                    reason: reason,
                    timestamp: Date.now(),
                    duration: duration, // 0 = permanent
                    expiresAt: duration > 0 ? Date.now() + (duration * 60 * 1000) : 0
                };
                
                await firebaseDB.ref(`mutes/${playerName.replace(/[\/\.#$\[\]]/g, '_')}`).set(muteData);
                
                notifySuccess('游댆 Hr치캜 ztlumen', `${playerName} - ${duration > 0 ? duration + ' min' : 'Permanentn캩'}`);
                closeModal();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === RYCHL칗 BAN Z PROFILU ===
        function adminQuickBan(playerName) {
            if (!isAdmin()) return;
            
            showModal(`游뛂 Ban: ${escapeHtml(playerName)}`, `
                <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #f44336;">
                    <p style="color: #f44336; margin: 0;">丘멆잺 POZOR: Banovat hr치캜e <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong>?</p>
                    <p style="color: #888; font-size: 0.8rem; margin: 0.5rem 0 0 0;">Hr치캜 nebude moci hr치t hru!</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">낌勇 Doba trv치n칤:</label>
                    <select id="banDuration" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #f44336; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="60">1 hodina</option>
                        <option value="720">12 hodin</option>
                        <option value="1440" selected>24 hodin</option>
                        <option value="4320">3 dny</option>
                        <option value="10080">7 dn칤</option>
                        <option value="43200">30 dn칤</option>
                        <option value="0">Permanentn캩</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游닇 D콢vod:</label>
                    <input type="text" id="banReason" placeholder="nap콏. Cheating, toxicita..." maxlength="200" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">仇 Zru코it</button>
                    <button class="btn" onclick="executeQuickBan('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #f44336 0%, #b71c1c 100%);">游뛂 Banovat</button>
                </div>
            `);
        }
        
        async function executeQuickBan(playerName) {
            if (!isAdmin()) return;
            
            const duration = parseInt(document.getElementById('banDuration').value);
            const reason = document.getElementById('banReason').value || 'Bez ud치n칤 d콢vodu';
            
            try {
                const banData = {
                    player: playerName,
                    bannedBy: ADMIN_NICK,
                    reason: reason,
                    timestamp: Date.now(),
                    duration: duration, // 0 = permanent
                    expiresAt: duration > 0 ? Date.now() + (duration * 60 * 1000) : 0
                };
                
                await firebaseDB.ref(`bans/${playerName.replace(/[\/\.#$\[\]]/g, '_')}`).set(banData);
                
                notifySuccess('游뛂 Hr치캜 zabanov치n', `${playerName} - ${duration > 0 ? (duration >= 1440 ? Math.floor(duration/1440) + ' dn칤' : duration + ' min') : 'Permanentn캩'}`);
                closeModal();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === RYCHL츼 ZM캨NA BARVY Z CHATU ===
        function showQuickVIPColor(playerName) {
            if (!isAdmin()) return;
            
            // P콏eddefinovan칠 barvy
            const presetColors = [
                { name: 'Zlat치', color: '#ffd700' },
                { name: 'St콏칤brn치', color: '#c0c0c0' },
                { name: 'Bronzov치', color: '#cd7f32' },
                { name: 'R콢쬺v치', color: '#ff69b4' },
                { name: 'Fialov치', color: '#9c27b0' },
                { name: 'Tyrkysov치', color: '#00bcd4' },
                { name: 'Oran쬺v치', color: '#ff9800' },
                { name: '캛erven치', color: '#f44336' },
                { name: 'Zelen치', color: '#4caf50' },
                { name: 'Modr치', color: '#2196f3' },
                { name: 'Rainbow', color: 'rainbow' }
            ];
            
            const currentColor = vipColors[playerName] || '';
            
            let colorsHtml = '<option value="">-- Bez VIP barvy --</option>' +
                presetColors.map(c => `<option value="${c.color}" ${currentColor === c.color ? 'selected' : ''} style="color: ${c.color === 'rainbow' ? '#ff0000' : c.color}">${c.name}</option>`).join('');
            
            showModal('游꿛 Zm캩nit barvu: ' + playerName, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">游꿛</div>
                    <div style="color: ${currentColor === 'rainbow' ? '#ff0000' : (currentColor || '#fff')}; font-weight: bold; font-size: 1.3rem; ${currentColor === 'rainbow' ? 'background: linear-gradient(90deg, #ff0000, #ff9800, #ffff00, #00ff00, #00bcd4, #9c27b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;' : ''}">${escapeHtml(playerName)}</div>
                    ${currentColor ? '<p style="color: #888; font-size: 0.85rem;">Aktu치ln칤 barva: ' + (presetColors.find(c => c.color === currentColor)?.name || currentColor) + '</p>' : '<p style="color: #666; font-size: 0.85rem;">Zat칤m bez VIP barvy</p>'}
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游꿛 Nov치 barva:</label>
                    <select id="quickVipColorSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #ff9800; border-radius: 6px; margin-top: 0.3rem;">
                        ${colorsHtml}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="applyQuickVIPColor('${escapeHtml(playerName).replace(/'/g, "\\'")}')" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        九 Ulo쬴t
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                        九 Zru코it
                    </button>
                </div>
            `);
        }
        
        async function applyQuickVIPColor(playerName) {
            if (!isAdmin()) return;
            
            const color = document.getElementById('quickVipColorSelect').value;
            
            // Firebase kl칤캜e nemohou obsahovat . # $ [ ] /
            // Pou쬴jeme encodeURIComponent pro bezpe캜n칠 ukl치d치n칤
            const safeKey = encodeURIComponent(playerName);
            
            try {
                if (color) {
                    await firebaseDB.ref('vipColors/' + safeKey).set(color);
                    vipColors[playerName] = color;
                    notifySuccess('Barva nastavena!', playerName + ' m치 novou VIP barvu');
                } else {
                    await firebaseDB.ref('vipColors/' + safeKey).remove();
                    delete vipColors[playerName];
                    notifySuccess('Barva odebr치na', playerName + ' u nem치 VIP barvu');
                }
                closeModal();
            } catch (e) {
                console.error('VIP color error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function showRewardHistory() {
            if (!isAdmin()) return;
            
            try {
                const snapshot = await firebaseDB.ref('admin/rewardLog').orderByChild('timestamp').limitToLast(20).once('value');
                const data = snapshot.val();
                
                let html = '<div style="max-height: 300px; overflow-y: auto;">';
                
                if (data) {
                    const rewards = Object.values(data).reverse();
                    rewards.forEach(r => {
                        const date = new Date(r.timestamp).toLocaleString('cs-CZ');
                        html += `
                            <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #2196f3;">${escapeHtml(r.player)}</span>
                                    <span style="color: #888; font-size: 0.75rem;">${date}</span>
                                </div>
                                <div style="color: #ffd700;">${r.money || 0}游눯 + ${r.xp || 0}救XP</div>
                                <div style="color: #666; font-size: 0.8rem;">${escapeHtml(r.reason || '')}</div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">콯치dn치 historie</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="showAdminRewards()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>';
                
                showModal('游늶 Historie odm캩n', html);
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === ADMIN VIP BARVY ===
        let vipColors = {}; // Cache VIP barev
        
        async function loadVIPColors() {
            if (!multiplayerEnabled || !firebaseDB) return;
            try {
                // Jednor치zov칠 na캜ten칤 + real-time listener
                firebaseDB.ref('vipColors').on('value', (snap) => {
                    const rawData = snap.val() || {};
                    // Dek칩duj kl칤캜e (jm칠na hr치캜콢) z Firebase form치tu
                    vipColors = {};
                    for (const [key, value] of Object.entries(rawData)) {
                        try {
                            const decodedName = decodeURIComponent(key);
                            vipColors[decodedName] = value;
                        } catch (e) {
                            // Pokud dek칩dov치n칤 sel쬰, pou쬴j p콢vodn칤 kl칤캜
                            vipColors[key] = value;
                        }
                    }
                    console.log('游꿛 VIP barvy aktualizov치ny:', Object.keys(vipColors).length);
                });
            } catch (e) {
                console.error('Error loading VIP colors:', e);
            }
        }
        
        function getVIPColor(playerName) {
            return vipColors[playerName] || null;
        }
        
        async function showAdminVIPColors() {
            if (!isAdmin()) return;
            
            // Na캜ti aktu치ln칤 VIP barvy
            await loadVIPColors();
            
            // Na캜ti hr치캜e ze 쬰b콏칤캜ku
            let players = [];
            try {
                const snap = await firebaseDB.ref('leaderboard').orderByChild('score').limitToLast(100).once('value');
                const data = snap.val();
                if (data) {
                    players = Object.entries(data).map(([name, info]) => ({
                        name,
                        level: info.level || 1,
                        score: info.score || 0
                    }))
                    // Filtruj automaticky generovan칠 nicky (user_xxx s dlouh칳m hashem)
                    .filter(p => !p.name.startsWith('user_') || p.name.length < 20)
                    .sort((a, b) => b.score - a.score);
                }
            } catch (e) {
                console.error('Error loading players:', e);
            }
            
            // P콏eddefinovan칠 barvy
            const presetColors = [
                { name: 'Zlat치', color: '#ffd700' },
                { name: 'St콏칤brn치', color: '#c0c0c0' },
                { name: 'Bronzov치', color: '#cd7f32' },
                { name: 'R콢쬺v치', color: '#ff69b4' },
                { name: 'Fialov치', color: '#9c27b0' },
                { name: 'Tyrkysov치', color: '#00bcd4' },
                { name: 'Oran쬺v치', color: '#ff9800' },
                { name: '캛erven치', color: '#f44336' },
                { name: 'Zelen치', color: '#4caf50' },
                { name: 'Modr치', color: '#2196f3' },
                { name: 'Rainbow', color: 'rainbow' }
            ];
            
            let playersHtml = players.map(p => {
                const currentColor = vipColors[p.name];
                return `<option value="${escapeHtml(p.name)}" ${currentColor ? 'style="color:' + currentColor + '"' : ''}>${escapeHtml(p.name)} (Lv.${p.level}) ${currentColor ? '游꿛' : ''}</option>`;
            }).join('');
            
            let colorsHtml = '<option value="">-- Bez VIP barvy --</option>' +
                presetColors.map(c => `<option value="${c.color}" style="color: ${c.color === 'rainbow' ? '#ff0000' : c.color}">${c.name}</option>`).join('');
            
            // Seznam aktu치ln칤ch VIP
            let currentVIPs = Object.entries(vipColors).map(([name, color]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #0a0a0a; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span style="color: ${color === 'rainbow' ? '#ff0000' : color}; font-weight: bold; ${color === 'rainbow' ? 'background: linear-gradient(90deg, #ff0000, #ff9800, #ffff00, #00ff00, #00bcd4, #9c27b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;' : ''}">${escapeHtml(name)}</span>
                    <button onclick="removeVIPColor('${escapeHtml(name)}')" style="background: #f44336; border: none; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">九</button>
                </div>
            `).join('') || '<p style="color: #666; text-align: center;">콯치dn칤 VIP hr치캜i</p>';
            
            showModal('游꿛 VIP Barvy', `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ff9800;">
                    <p style="color: #ff9800; margin: 0; font-size: 0.9rem;">
                        游꿛 Nastav speci치ln칤 barvu nicku v chatu pro VIP hr치캜e (nap콏. p콏isp캩vatele).
                    </p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游녻 Hr치캜:</label>
                    <select id="vipPlayerSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="">-- Vyber hr치캜e --</option>
                        ${playersHtml}
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">游꿛 Barva:</label>
                    <select id="vipColorSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                        ${colorsHtml}
                    </select>
                </div>
                
                <button class="btn" onclick="setVIPColor()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem; font-size: 1rem;">
                    游꿛 Nastavit barvu
                </button>
                
                <div style="margin-top: 1.5rem;">
                    <h4 style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.9rem;">游녬 Aktu치ln칤 VIP hr치캜i:</h4>
                    <div style="max-height: 150px; overflow-y: auto;">
                        ${currentVIPs}
                    </div>
                </div>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #555;"> Zp캩t</button>
            `);
        }
        
        async function setVIPColor() {
            if (!isAdmin()) return;
            
            const playerName = document.getElementById('vipPlayerSelect').value;
            const color = document.getElementById('vipColorSelect').value;
            
            if (!playerName) {
                notifyWarning('Chyba', 'Vyber hr치캜e!');
                return;
            }
            
            const safeKey = encodeURIComponent(playerName);
            
            try {
                if (color) {
                    await firebaseDB.ref('vipColors/' + safeKey).set(color);
                    vipColors[playerName] = color;
                    notifySuccess('Barva nastavena!', `${playerName} m치 te캞 VIP barvu`);
                } else {
                    await firebaseDB.ref('vipColors/' + safeKey).remove();
                    delete vipColors[playerName];
                    notifySuccess('Barva odebr치na', `${playerName} u nem치 VIP barvu`);
                }
                showAdminVIPColors();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function removeVIPColor(playerName) {
            if (!isAdmin()) return;
            
            const safeKey = encodeURIComponent(playerName);
            
            try {
                await firebaseDB.ref('vipColors/' + safeKey).remove();
                delete vipColors[playerName];
                notifySuccess('Barva odebr치na', `${playerName} u nem치 VIP barvu`);
                showAdminVIPColors();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Kontrola nevyzvednut칳ch odm캩n p콏i na캜ten칤
        async function checkPendingRewards() {
            if (!multiplayerEnabled || !firebaseDB || !state.char?.name) return;
            
            const myName = state.char.name;
            // Escapov치n칤 pro Firebase - mus칤 b칳t stejn칠 jako p콏i ukl치d치n칤 notifikac칤
            const safeName = myName.replace(/[\\/\\.#$\\[\\]]/g, '_');
            
            try {
                let totalMoney = 0;
                let totalXP = 0;
                let totalAmmo = {};
                let receivedItems = [];
                let reasons = [];
                
                // === 1. Kontrola notifications/{safeName} (admin rewards, tombola wins) ===
                const notifSnapshot = await firebaseDB.ref(`notifications/${safeName}`).once('value');
                const notifications = notifSnapshot.val() || {};
                
                for (const [key, notif] of Object.entries(notifications)) {
                    // Admin odm캩na
                    if (notif.type === 'admin_reward' && !notif.claimed) {
                        const money = Math.min(parseInt(notif.money) || 0, 999999);
                        const xp = Math.min(parseInt(notif.xp) || 0, 999999);
                        totalMoney += money;
                        totalXP += xp;
                        if (notif.reason) reasons.push(notif.reason);
                        
                        // N치boje
                        if (notif.ammo && notif.ammo.type && notif.ammo.count > 0) {
                            const ammoType = notif.ammo.type;
                            totalAmmo[ammoType] = (totalAmmo[ammoType] || 0) + Math.min(notif.ammo.count, 9999);
                        }
                        
                        // P콏edm캩t
                        if (notif.item && notif.item.id) {
                            const itemDef = ITEMS.find(i => i.id === notif.item.id);
                            if (itemDef) {
                                const count = Math.min(notif.item.count || 1, 99);
                                const itemCopy = JSON.parse(JSON.stringify(itemDef));
                                itemCopy.count = count;
                                addItemToInventory(itemCopy, count);
                                receivedItems.push(`${count}x ${itemDef.icon} ${itemDef.name}`);
                            }
                        }
                        
                        // Sma notifikaci
                        await firebaseDB.ref(`notifications/${safeName}/${key}`).remove();
                        console.log('游꾸 Admin odm캩na vyzveduta:', notif);
                    }
                    
                    // War zone v칳hra
                    if (notif.type === 'war_reward' && !notif.claimed) {
                        const reward = notif.reward || {};
                        const money = Math.min(parseInt(reward.money) || 0, 999999);
                        totalMoney += money;
                        if (notif.title) reasons.push(notif.title);
                        
                        // Sma notifikaci
                        await firebaseDB.ref(`notifications/${safeName}/${key}`).remove();
                        console.log('丘덢잺 War zone odm캩na vyzveduta:', notif);
                    }
                    
                    // Tombola v칳hra
                    if (notif.type === 'tombola_win' && !notif.processed) {
                        processTombolaWin(notif);
                        await firebaseDB.ref(`notifications/${safeName}/${key}`).remove();
                    }
                }
                
                // === 2. Kontrola players/{safeName}/pendingRewards (star칳 syst칠m) ===
                const pendingSnapshot = await firebaseDB.ref(`players/${safeName}/pendingRewards`).once('value');
                const pendingData = pendingSnapshot.val() || {};
                
                for (const [key, reward] of Object.entries(pendingData)) {
                    if (!reward.claimed) {
                        const money = Math.min(reward.money || 0, 1000);
                        const xp = Math.min(reward.xp || 0, 500);
                        totalMoney += money;
                        totalXP += xp;
                        if (reward.reason) reasons.push(reward.reason);
                        
                        // P콏edm캩t
                        if (reward.item && reward.item.id) {
                            const itemDef = ITEMS.find(i => i.id === reward.item.id);
                            if (itemDef) {
                                const count = Math.min(reward.item.count || 1, 10);
                                const itemCopy = JSON.parse(JSON.stringify(itemDef));
                                itemCopy.count = count;
                                addItemToInventory(itemCopy, count);
                                receivedItems.push(`${count}x ${itemDef.icon} ${itemDef.name}`);
                            }
                        }
                        
                        // Ozna캜 jako vyzvednut칠
                        await firebaseDB.ref(`players/${safeName}/pendingRewards/${key}/claimed`).set(true);
                    }
                }
                
                // === 3. Zobraz v칳sledky ===
                if (totalMoney > 0 || totalXP > 0 || receivedItems.length > 0 || Object.keys(totalAmmo).length > 0) {
                    // P콏idej pen칤ze
                    if (totalMoney > 0) {
                        state.money = (state.money || 0) + totalMoney;
                    }
                    
                    // P콏idej XP
                    if (totalXP > 0) {
                        addXP(totalXP);
                    }
                    
                    // P콏idej n치boje
                    let ammoText = '';
                    const ammoNames = { '9mm': '游댳 9mm', 'shell': '游댲 Broky', 'rifle': '游댳 Pu코kov칠', 'energy': '丘 Energetick칠', 'arrow': '游낓 먞셣y' };
                    for (const [type, count] of Object.entries(totalAmmo)) {
                        addAmmo(type, count);
                        ammoText += `<div style="color: #ff9800;">+${count}x ${ammoNames[type] || type}</div>`;
                    }
                    
                    console.log(`游꾸 Celkem vyzvednuto: ${totalMoney}游눯 + ${totalXP}救 + ${receivedItems.length} p콏edm캩t콢`);
                    
                    // Zobraz modal
                    showModal('游꾸 M치코 odm캩nu!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">游꾸</div>
                            <h3 style="color: #4caf50;">Gratulujeme!</h3>
                            <p style="color: #888;">Dostal jsi odm캩nu od admina:</p>
                            <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                ${totalMoney > 0 ? `<div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">+${totalMoney} 游눯</div>` : ''}
                                ${totalXP > 0 ? `<div style="color: #8bc34a; font-size: 1.5rem; font-weight: bold;">+${totalXP} 救XP</div>` : ''}
                                ${ammoText}
                                ${receivedItems.length > 0 ? `<div style="color: #9c7cff; font-size: 1.1rem; margin-top: 0.5rem;">${receivedItems.join('<br>')}</div>` : ''}
                            </div>
                            ${reasons.length > 0 ? `<p style="color: #888; font-size: 0.9rem; font-style: italic;">"${reasons.slice(0, 3).join(', ')}"</p>` : ''}
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">游꿀 Super!</button>
                    `);
                    
                    renderFull();
                    saveGame(true);
                }
                
            } catch (e) {
                console.error('Error checking pending rewards:', e);
            }
        }
        
        // ============================================
        // 游勇 TOMBOLA SYST칄M
        // ============================================
        
        let currentTombola = null;
        
        // Inicializace listeneru na tombolu
        function initTombolaListener() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            firebaseDB.ref('tombola/active').on('value', (snap) => {
                currentTombola = snap.val();
                console.log('游勇 Tombola update:', currentTombola);
            });
        }
        
        // Admin: Zobrazit spr치vu tomboly
        async function showAdminTombola() {
            if (!hasPermission('tombola')) return;
            
            showModal('游勇 Tombola', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Na캜칤t치m...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (tombola && tombola.status === 'active') {
                    // Aktivn칤 tombola - zobraz spr치vu
                    showAdminTombolaManage(tombola);
                } else {
                    // 콯치dn치 tombola - nab칤dni vytvo콏en칤
                    showAdminTombolaCreate();
                }
            } catch (e) {
                console.error('Tombola error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se na캜칤st tombolu');
            }
        }
        
        // Admin: Vytvo콏it novou tombolu
        function showAdminTombolaCreate() {
            showModal('游勇 Vytvo콏it tombolu', `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #e91e63; margin: 0;">Vytvo콏 novou tombolu s v칳hrou pro hr치캜e!</p>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">N치zev tomboly:</label>
                        <input type="text" id="tombolaName" value="Velk치 tombola" 
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Typ v칳hry:</label>
                        <select id="tombolaPrizeType" onchange="updateTombolaPrizeFields()" 
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                            <option value="money">游눯 Pen칤ze</option>
                            <option value="tokens">游꿞 콯etony</option>
                            <option value="xp">救 XP</option>
                            <option value="item">游닍 P콏edm캩t</option>
                        </select>
                    </div>
                    
                    <div id="tombolaPrizeFields">
                        <label style="color: #ffd700; font-size: 0.85rem;">캛치stka (游눯):</label>
                        <input type="number" id="tombolaPrizeAmount" value="1000" min="1" max="999999"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #ffd700; border-radius: 8px; color: #ffd700; margin-top: 0.3rem; font-weight: bold;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Cena l칤stku (游눯):</label>
                        <input type="number" id="tombolaTicketPrice" value="50" min="1"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Max l칤stk콢 na hr치캜e:</label>
                        <input type="number" id="tombolaMaxTickets" value="10" min="1" max="100"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Trv치n칤 (hodiny):</label>
                        <input type="number" id="tombolaDuration" value="24" min="1" max="168"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showAdminPanel()" style="background: #555;"> Zp캩t</button>
                    <button class="btn" onclick="createTombola()" style="background: #e91e63;">游勇 Vytvo콏it</button>
                </div>
            `);
        }
        
        function updateTombolaPrizeFields() {
            const type = document.getElementById('tombolaPrizeType').value;
            const container = document.getElementById('tombolaPrizeFields');
            
            if (type === 'item') {
                // V칳b캩r p콏edm캩tu
                const itemOptions = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legendary')
                    .map(i => `<option value="${i.id}">${i.icon} ${i.name} (${i.rarity})</option>`).join('');
                
                container.innerHTML = `
                    <label style="color: #888; font-size: 0.85rem;">P콏edm캩t:</label>
                    <select id="tombolaPrizeItem" style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                        ${itemOptions}
                    </select>
                    <div style="margin-top: 0.5rem;">
                        <label style="color: #888; font-size: 0.85rem;">Po캜et:</label>
                        <input type="number" id="tombolaPrizeAmount" value="1" min="1" max="99"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                `;
            } else {
                // Pen칤ze, 쬰tony nebo XP
                const labels = {
                    money: { label: '캛치stka (游눯):', color: '#ffd700', default: 1000 },
                    tokens: { label: 'Po캜et 쬰ton콢 (游꿞):', color: '#e91e63', default: 1000 },
                    xp: { label: 'Mno쬽tv칤 XP (救):', color: '#8bc34a', default: 500 }
                };
                const config = labels[type] || labels.money;
                
                container.innerHTML = `
                    <label style="color: ${config.color}; font-size: 0.85rem;">${config.label}</label>
                    <input type="number" id="tombolaPrizeAmount" value="${config.default}" min="1" max="999999"
                        style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid ${config.color}; border-radius: 8px; color: ${config.color}; margin-top: 0.3rem; font-weight: bold;">
                `;
            }
        }
        
        // Vytvo콏it tombolu
        async function createTombola() {
            if (!hasPermission('tombola')) return;
            
            const name = document.getElementById('tombolaName').value.trim();
            const prizeType = document.getElementById('tombolaPrizeType').value;
            const prizeAmount = parseInt(document.getElementById('tombolaPrizeAmount').value) || 1;
            const prizeItem = document.getElementById('tombolaPrizeItem')?.value || null;
            const ticketPrice = parseInt(document.getElementById('tombolaTicketPrice').value) || 50;
            const maxTickets = parseInt(document.getElementById('tombolaMaxTickets').value) || 10;
            const durationHours = parseInt(document.getElementById('tombolaDuration').value) || 24;
            
            if (!name) {
                notifyWarning('Chyba', 'Zadej n치zev tomboly');
                return;
            }
            
            // Sestav prize objekt
            let prize = { type: prizeType, amount: prizeAmount };
            if (prizeType === 'item' && prizeItem) {
                const item = ITEMS.find(i => i.id === prizeItem);
                if (item) {
                    prize.itemId = prizeItem;
                    prize.itemName = item.name;
                    prize.itemIcon = item.icon;
                }
            }
            
            const tombola = {
                name: name,
                prize: prize,
                ticketPrice: ticketPrice,
                maxTicketsPerPlayer: maxTickets,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                endsAt: Date.now() + (durationHours * 60 * 60 * 1000),
                status: 'active',
                tickets: {},
                totalTickets: 0,
                createdBy: getPlayerName()
            };
            
            try {
                await firebaseDB.ref('tombola/active').set(tombola);
                notifySuccess('游勇 Tombola vytvo콏ena!', name);
                
                // Ozn치men칤 v chatu
                await firebaseDB.ref('chat/messages').push({
                    author: '游勇 TOMBOLA',
                    text: `Nov치 tombola "${name}"! Cena l칤stku: ${ticketPrice} 游눯. V칳hra: ${getPrizeDescription(prize)}. Kon캜칤 za ${durationHours} hodin!`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                showAdminTombola();
            } catch (e) {
                console.error('Create tombola error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se vytvo콏it tombolu');
            }
        }
        
        function getPrizeDescription(prize) {
            if (prize.type === 'money') return `${prize.amount} 游눯`;
            if (prize.type === 'tokens') return `${prize.amount} 游꿞`;
            if (prize.type === 'xp') return `${prize.amount} 救 XP`;
            if (prize.type === 'item') return `${prize.amount}x ${prize.itemIcon || '游닍'} ${prize.itemName || 'P콏edm캩t'}`;
            return '???';
        }
        
        // Admin: Spr치va aktivn칤 tomboly
        async function showAdminTombolaManage(tombola) {
            const timeLeft = Math.max(0, tombola.endsAt - Date.now());
            const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
            const minsLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
            
            // Spo캜칤tej 칰캜astn칤ky a l칤stky
            const tickets = tombola.tickets || {};
            const participants = Object.keys(tickets).filter(player => {
                const t = tickets[player];
                return t && typeof t.count === 'number' && !isNaN(t.count);
            });
            const totalTickets = Object.values(tickets).reduce((sum, t) => sum + (t?.count || 0), 0);
            
            let participantsList = '';
            participants.forEach(player => {
                const t = tickets[player];
                const ticketCount = t?.count || 0;
                const chance = totalTickets > 0 ? ((ticketCount / totalTickets) * 100).toFixed(1) : 0;
                const expectedPaid = ticketCount * tombola.ticketPrice;
                const actualPaid = t?.totalPaid || 0;
                const isValid = actualPaid >= expectedPaid;
                participantsList += `
                    <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #0a0a0a; border-radius: 4px; margin-bottom: 0.2rem; border-left: 3px solid ${isValid ? '#4caf50' : '#f44336'};">
                        <span style="color: #fff;">${escapeHtml(player)}</span>
                        <span style="color: ${isValid ? '#ffd700' : '#f44336'};">${ticketCount} l칤stk콢 (${chance}%) ${!isValid ? '丘멆잺' : ''}</span>
                    </div>
                `;
            });
            
            showModal('游勇 Spr치va tomboly', `
                <div style="background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #e91e63;">
                    <h3 style="color: #e91e63; margin: 0 0 0.5rem 0;">${escapeHtml(tombola.name)}</h3>
                    <p style="color: #ffd700; margin: 0;">V칳hra: ${getPrizeDescription(tombola.prize)}</p>
                    <p style="color: #888; margin: 0.3rem 0 0 0;">Cena l칤stku: ${tombola.ticketPrice} 游눯</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;">${participants.length}</div>
                        <div style="color: #888; font-size: 0.8rem;">칔캜astn칤k콢</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #e91e63; font-size: 1.5rem; font-weight: bold;">${totalTickets}</div>
                        <div style="color: #888; font-size: 0.8rem;">L칤stk콢 celkem</div>
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                    <div style="color: ${timeLeft > 0 ? '#ff9800' : '#f44336'}; font-size: 1.2rem;">
                        ${timeLeft > 0 ? `낌勇 Zb칳v치: ${hoursLeft}h ${minsLeft}m` : '낋 캛as vypr코el!'}
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto;">
                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">游늶 칔캜astn칤ci:</div>
                    ${participantsList || '<p style="color: #555; text-align: center;">Zat칤m nikdo</p>'}
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="drawTombolaWinner()" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); color: #000; padding: 1rem; font-weight: bold;">
                        游꿀 LOSOVAT V칗HERCE
                    </button>
                    <button class="btn" onclick="cancelTombola()" style="background: #c62828; padding: 0.8rem;">
                        仇 Zru코it tombolu
                    </button>
                    <button class="btn" onclick="showAdminPanel()" style="background: #555;"> Zp캩t</button>
                </div>
            `);
        }
        
        // Admin: Losovat v칳herce
        async function drawTombolaWinner() {
            if (!hasPermission('tombola')) return;
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (!tombola || tombola.status !== 'active') {
                    notifyWarning('Chyba', '콯치dn치 aktivn칤 tombola');
                    return;
                }
                
                const tickets = tombola.tickets || {};
                const participants = Object.keys(tickets).filter(player => {
                    const t = tickets[player];
                    return player && t && typeof t.count === 'number' && !isNaN(t.count) && t.count > 0;
                });
                
                if (participants.length === 0) {
                    notifyWarning('Chyba', '콯치dn칤 칰캜astn칤ci v tombole');
                    return;
                }
                
                // Vytvo콏 pool l칤stk콢 (ka쬯칳 hr치캜 m치 tolik z치znam콢 kolik m치 l칤stk콢)
                const ticketPool = [];
                participants.forEach(player => {
                    const count = tickets[player]?.count || 0;
                    for (let i = 0; i < count; i++) {
                        ticketPool.push(player);
                    }
                });
                
                if (ticketPool.length === 0) {
                    notifyWarning('Chyba', '콯치dn칠 l칤stky v tombole');
                    return;
                }
                
                // N치hodn칳 v칳b캩r
                const winnerIndex = Math.floor(Math.random() * ticketPool.length);
                const winner = ticketPool[winnerIndex];
                const winnerTickets = tickets[winner]?.count || 0;
                const winChance = ((winnerTickets / ticketPool.length) * 100).toFixed(1);
                
                // Ulo v칳sledek
                const result = {
                    ...tombola,
                    status: 'finished',
                    winner: winner,
                    winnerTickets: winnerTickets,
                    totalTickets: ticketPool.length,
                    drawnAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // P콏esun do historie
                await firebaseDB.ref('tombola/history').push(result);
                await firebaseDB.ref('tombola/active').remove();
                
                // Po코li v칳hru hr치캜i
                await firebaseDB.ref('notifications/' + winner).push({
                    type: 'tombola_win',
                    tombolaName: tombola.name,
                    prize: tombola.prize,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Ozn치men칤 v chatu
                await firebaseDB.ref('chat/messages').push({
                    author: '游꿀 TOMBOLA',
                    text: `V칳herce tomboly "${tombola.name}" je ${winner}! M캩l ${winnerTickets} l칤stk콢 (${winChance}% 코ance). V칳hra: ${getPrizeDescription(tombola.prize)}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                // Zobraz v칳sledek
                showModal('游꿀 V칗HERCE VYLOSOV츼N!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin: 1rem 0;">游끥</div>
                        <h2 style="color: #ffd700; margin: 0;">${escapeHtml(winner)}</h2>
                        <p style="color: #888; margin: 0.5rem 0;">vyhr치l tombolu "${escapeHtml(tombola.name)}"!</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                            <p style="color: #4caf50; font-size: 1.3rem; margin: 0;">V칳hra: ${getPrizeDescription(tombola.prize)}</p>
                        </div>
                        <p style="color: #666; font-size: 0.85rem;">
                            ${winnerTickets} l칤stk콢 z ${ticketPool.length} celkem (${winChance}% 코ance)
                        </p>
                    </div>
                    <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 OK</button>
                `);
                
                notifySuccess('游꿀 V칳herce vylosov치n!', winner);
                
            } catch (e) {
                console.error('Draw winner error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se losovat: ' + e.message);
            }
        }
        
        // Admin: Zru코it tombolu
        async function cancelTombola() {
            if (!hasPermission('tombola')) return;
            
            if (!confirm('Opravdu zru코it tombolu? L칤stky nebudou vr치ceny!')) return;
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (tombola) {
                    // Ozn치men칤 v chatu
                    await firebaseDB.ref('chat/messages').push({
                        author: '游勇 TOMBOLA',
                        text: `Tombola "${tombola.name}" byla zru코ena administr치torem.`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        system: true
                    });
                }
                
                await firebaseDB.ref('tombola/active').remove();
                notifySuccess('Tombola zru코ena', 'Tombola byla zru코ena');
                showAdminPanel();
            } catch (e) {
                console.error('Cancel tombola error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se zru코it tombolu');
            }
        }
        
        // === HR츼캛SK칄 FUNKCE PRO TOMBOLU ===
        
        // Zobrazit tombolu pro hr치캜e
        async function showTombola() {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Nedostupn칠', 'Multiplayer nen칤 aktivn칤');
                return;
            }
            
            showModal('游勇 Tombola', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Na캜칤t치m...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (!tombola || tombola.status !== 'active') {
                    showModal('游勇 Tombola', `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">游勇</div>
                            <p style="color: #888;">Moment치ln캩 neprob칤h치 쮂멳n치 tombola.</p>
                            <p style="color: #666; font-size: 0.85rem;">Sleduj chat pro ozn치men칤 nov칳ch tombol!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;"> Zav콏칤t</button>
                    `);
                    return;
                }
                
                const myName = getPlayerName();
                // Sanitizace jm칠na pro Firebase cestu
                const sanitizedName = myName.replace(/[\/\.#$\[\]]/g, '_');
                const myTickets = tombola.tickets?.[sanitizedName]?.count || 0;
                const totalTickets = Object.values(tombola.tickets || {}).reduce((sum, t) => sum + (t?.count || 0), 0);
                const myChance = totalTickets > 0 ? ((myTickets / totalTickets) * 100).toFixed(1) : 0;
                const participants = Object.keys(tombola.tickets || {}).filter(k => tombola.tickets[k]?.count > 0).length;
                
                const timeLeft = Math.max(0, tombola.endsAt - Date.now());
                const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                const minsLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                
                const canBuyMore = myTickets < tombola.maxTicketsPerPlayer;
                const canAfford = getMoney() >= tombola.ticketPrice;
                
                showModal('游勇 ' + escapeHtml(tombola.name), `
                    <div style="background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #e91e63;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">游꾸</div>
                            <p style="color: #ffd700; font-size: 1.2rem; margin: 0; font-weight: bold;">V칳hra: ${getPrizeDescription(tombola.prize)}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                            <div style="color: #e91e63; font-size: 1.3rem; font-weight: bold;">${myTickets}</div>
                            <div style="color: #888; font-size: 0.75rem;">Tv칳ch l칤stk콢</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                            <div style="color: #4caf50; font-size: 1.3rem; font-weight: bold;">${myChance}%</div>
                            <div style="color: #888; font-size: 0.75rem;">Tv치 코ance</div>
                        </div>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: #888;">칔캜astn칤k콢:</span>
                            <span style="color: #fff;">${participants}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: #888;">L칤stk콢 celkem:</span>
                            <span style="color: #fff;">${totalTickets}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: #888;">Cena l칤stku:</span>
                            <span style="color: #ffd700;">${tombola.ticketPrice} 游눯</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">Max l칤stk콢/hr치캜:</span>
                            <span style="color: #fff;">${tombola.maxTicketsPerPlayer}</span>
                        </div>
                    </div>
                    
                    <div style="background: ${timeLeft > 0 ? '#1a2a1a' : '#2a1a1a'}; padding: 0.8rem; border-radius: 8px; text-align: center; margin-bottom: 1rem; border: 1px solid ${timeLeft > 0 ? '#4caf50' : '#f44336'};">
                        <div style="color: ${timeLeft > 0 ? '#ff9800' : '#f44336'}; font-size: 1.1rem;">
                            ${timeLeft > 0 ? `낌勇 Zb칳v치: ${hoursLeft}h ${minsLeft}m` : '낋 Losov치n칤 brzy!'}
                        </div>
                    </div>
                    
                    ${participants > 0 ? `
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto;">
                        <p style="color: #888; font-size: 0.75rem; margin: 0 0 0.5rem 0; text-align: center;">游논 칔캜astn칤ci a jejich 코ance:</p>
                        ${Object.entries(tombola.tickets || {})
                            .filter(([name, data]) => name && data && typeof data.count === 'number' && !isNaN(data.count))
                            .sort((a, b) => (b[1].count || 0) - (a[1].count || 0))
                            .map(([name, data]) => {
                                const ticketCount = data.count || 0;
                                const chance = totalTickets > 0 ? ((ticketCount / totalTickets) * 100).toFixed(1) : 0;
                                const isMe = name === myName;
                                return `<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333; ${isMe ? 'background: #1a2a1a; margin: 0 -0.5rem; padding: 0.3rem 0.5rem; border-radius: 4px;' : ''}">
                                    <span style="color: ${isMe ? '#8bc34a' : '#aaa'};">${isMe ? '驕 ' : ''}${escapeHtml(name)}</span>
                                    <span style="color: ${isMe ? '#4caf50' : '#ff9800'}; font-weight: bold;">${ticketCount}游勇 (${chance}%)</span>
                                </div>`;
                            }).join('')}
                    </div>
                    ` : ''}
                    
                    <div style="display: grid; gap: 0.5rem;">
                        ${canBuyMore ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="buyTombolaTicket(1)" style="flex: 1; background: ${canAfford ? '#e91e63' : '#555'}; padding: 0.8rem;" ${canAfford ? '' : 'disabled'}>
                                    游勇 Koupit 1 l칤stek
                                </button>
                                <button class="btn" onclick="buyTombolaTicket(5)" style="flex: 1; background: ${getMoney() >= tombola.ticketPrice * 5 && myTickets + 5 <= tombola.maxTicketsPerPlayer ? '#9c27b0' : '#555'}; padding: 0.8rem;" 
                                    ${getMoney() >= tombola.ticketPrice * 5 && myTickets + 5 <= tombola.maxTicketsPerPlayer ? '' : 'disabled'}>
                                    游勇 Koupit 5 l칤stk콢
                                </button>
                            </div>
                            <p style="color: #666; font-size: 0.8rem; text-align: center; margin: 0;">Tv칠 pen칤ze: ${getMoney()} 游눯 | Zb칳v치 l칤stk콢: ${tombola.maxTicketsPerPlayer - myTickets}</p>
                        ` : `
                            <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                <p style="color: #ff9800; margin: 0;">九 M치코 maximum l칤stk콢 (${tombola.maxTicketsPerPlayer})</p>
                            </div>
                        `}
                        <button class="btn" onclick="closeModal()" style="background: #555;"> Zav콏칤t</button>
                    </div>
                `);
                
            } catch (e) {
                console.error('Show tombola error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se na캜칤st tombolu');
            }
        }
        
        // Koupit l칤stek
        async function buyTombolaTicket(count = 1) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                // Nejd콏칤v na캜ti z치kladn칤 info o tombole
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (!tombola || tombola.status !== 'active') {
                    notifyWarning('Chyba', 'Tombola nen칤 aktivn칤');
                    return;
                }
                
                const myName = getPlayerName();
                
                // Sanitizace jm칠na pro Firebase cestu (/ . # $ [ ] nejsou povoleny)
                const sanitizedName = myName.replace(/[\/\.#$\[\]]/g, '_');
                if (sanitizedName !== myName) {
                    console.warn('Tombola: Jm칠no obsahuje nepovolen칠 znaky, pou쬴ta sanitizovan치 verze:', sanitizedName);
                }
                
                const totalCost = tombola.ticketPrice * count;
                const maxTickets = tombola.maxTicketsPerPlayer || 10;
                
                // P콏edb캩쬹칠 kontroly
                if (getMoney() < totalCost) {
                    notifyWarning('Nedostatek pen캩z', `Pot콏ebuje코 ${totalCost} 游눯`);
                    return;
                }
                
                if (Date.now() > tombola.endsAt) {
                    notifyWarning('Pozd캩', 'Tombola ji skon캜ila');
                    return;
                }
                
                // ATOMICK츼 TRANSAKCE - 콏e코칤 race condition
                let transactionSuccess = false;
                let finalCount = 0;
                
                try {
                    const ticketResult = await firebaseDB.ref('tombola/active/tickets/' + sanitizedName).transaction(currentData => {
                        const currentCount = currentData?.count || 0;
                        const currentPaid = currentData?.totalPaid || 0;
                        
                        // Kontrola limitu uvnit콏 transakce
                        if (currentCount + count > maxTickets) {
                            return; // Abort transakce
                        }
                        
                        return {
                            count: currentCount + count,
                            totalPaid: currentPaid + totalCost,
                            lastPurchase: firebase.database.ServerValue.TIMESTAMP
                        };
                    });
                    
                    if (!ticketResult.committed) {
                        notifyWarning('Limit', `M콢쬰코 m칤t max ${maxTickets} l칤stk콢`);
                        return;
                    }
                    
                    transactionSuccess = true;
                    finalCount = ticketResult.snapshot.val()?.count || count;
                    
                    // Aktualizuj total pomoc칤 transakce
                    await firebaseDB.ref('tombola/active/totalTickets').transaction(current => {
                        return (current || 0) + count;
                    });
                    
                } catch (firebaseError) {
                    console.error('Firebase transaction error:', firebaseError);
                    notifyWarning('Chyba serveru', 'Nepoda콏ilo se koupit l칤stek. Pen칤ze nebyly ode캜teny.');
                    return;
                }
                
                // A콯 POTOM ode캜ti pen칤ze (Firebase transakce usp캩la)
                if (transactionSuccess) {
                    removeMoney(totalCost);
                    saveGame(true);
                    
                    notifySuccess('游勇 L칤stek koupen!', `M치코 ${finalCount} l칤stk콢`);
                    addLog(`Koupen l칤stek do tomboly "${escapeHtml(tombola.name)}" za ${totalCost} 游눯`, '游勇');
                    
                    // Refresh zobrazen칤
                    showTombola();
                }
                
            } catch (e) {
                console.error('Buy ticket error:', e);
                notifyWarning('Chyba', 'Nepoda콏ilo se koupit l칤stek: ' + (e.message ? escapeHtml(e.message) : 'Nezn치m치 chyba'));
            }
        }
        
        // Zpracov치n칤 admin odm캩ny z notifikace
        async function processAdminReward(reward, notificationKey) {
            if (reward.type !== 'admin_reward' || reward.claimed) return;
            
            console.log('游꾸 Zpracov치v치m admin odm캩nu:', reward);
            
            const myName = getPlayerName();
            let receivedItems = [];
            
            // P콏idej pen칤ze
            const money = Math.min(parseInt(reward.money) || 0, 999999);
            if (money > 0) {
                state.money = (state.money || 0) + money;
                console.log('游꾸 P콏id치no pen캩z:', money);
            }
            
            // P콏idej XP
            const xp = Math.min(parseInt(reward.xp) || 0, 999999);
            if (xp > 0) {
                addXP(xp);
                console.log('游꾸 P콏id치no XP:', xp);
            }
            
            // P콏idej n치boje
            let receivedAmmo = '';
            if (reward.ammo && reward.ammo.type && reward.ammo.count > 0) {
                const ammoCount = Math.min(reward.ammo.count, 9999);
                addAmmo(reward.ammo.type, ammoCount);
                receivedAmmo = `${ammoCount}x ${reward.ammo.name || reward.ammo.type}`;
                console.log('游꾸 P콏id치no n치boj콢:', reward.ammo.type, 'x', ammoCount);
            }
            
            // P콏idej p콏edm캩t
            if (reward.item && reward.item.id) {
                const itemDef = ITEMS.find(i => i.id === reward.item.id);
                if (itemDef) {
                    const count = Math.min(reward.item.count || 1, 99);
                    const itemCopy = JSON.parse(JSON.stringify(itemDef));
                    itemCopy.count = count;
                    addItemToInventory(itemCopy, count);
                    receivedItems.push(`${count}x ${itemDef.icon} ${itemDef.name}`);
                    console.log('游꾸 P콏id치n p콏edm캩t:', itemDef.name, 'x', count);
                }
            }
            
            // Ozna캜 jako zpracovan칠 a sma
            try {
                await firebaseDB.ref('notifications/' + myName + '/' + notificationKey).remove();
            } catch (e) {
                console.error('Error removing notification:', e);
            }
            
            // Zobraz modal a po캜kej ne hr치캜 klikne
            return new Promise((resolve) => {
                showModal('游꾸 M치코 odm캩nu od admina!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游꾸</div>
                        <h3 style="color: #4caf50;">Gratulujeme!</h3>
                        <p style="color: #888;">Dostal jsi odm캩nu za p콏칤nos h콏e:</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            ${money > 0 ? `<div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">+${money} 游눯</div>` : ''}
                            ${xp > 0 ? `<div style="color: #8bc34a; font-size: 1.5rem; font-weight: bold;">+${xp} 救XP</div>` : ''}
                            ${receivedAmmo ? `<div style="color: #ff9800; font-size: 1.2rem; margin-top: 0.5rem;">+${receivedAmmo}</div>` : ''}
                            ${receivedItems.length > 0 ? `<div style="color: #9c7cff; font-size: 1.1rem; margin-top: 0.5rem;">${receivedItems.join('<br>')}</div>` : ''}
                        </div>
                        ${reward.reason ? `<p style="color: #888; font-size: 0.9rem; font-style: italic;">"${escapeHtml(reward.reason)}"</p>` : ''}
                        <p style="color: #666; font-size: 0.8rem;">D캩kujeme za tvou pomoc!</p>
                    </div>
                    <button class="btn" onclick="closeModal(); window._rewardResolved && window._rewardResolved();" style="width: 100%; margin-top: 1rem; background: #4caf50;">游꿀 Super!</button>
                `);
                
                // Callback pro zav콏en칤 modalu
                window._rewardResolved = () => {
                    window._rewardResolved = null;
                    renderFull();
                    saveGame(true);
                    resolve();
                };
                
                // Fallback - po 30s automaticky pokra캜uj
                setTimeout(() => {
                    if (window._rewardResolved) {
                        window._rewardResolved();
                    }
                }, 30000);
            });
        }
        
        // Zpracov치n칤 v칳hry z notifikace
        function processTombolaWin(notification) {
            if (notification.type !== 'tombola_win') return;
            
            console.log('游꿀 Zpracov치v치m tombola v칳hru:', notification);
            
            const prize = notification.prize;
            if (!prize) {
                console.error('游꿀 Chyb칤 prize v notifikaci!', notification);
                return;
            }
            
            console.log('游꿀 Prize objekt:', prize);
            
            const amount = parseInt(prize.amount) || 1;
            
            // P콏idej v칳hru podle typu
            if (prize.type === 'money') {
                if (amount > 0) {
                    state.money = (state.money || 0) + amount;
                    console.log('游꿀 P콏id치no pen캩z:', amount, 'Nov칳 stav:', state.money);
                    notifySuccess('游꿀 V칗HRA V TOMBOLE!', `+${amount} 游눯`);
                }
            } else if (prize.type === 'tokens') {
                if (amount > 0) {
                    addCasinoTokens(amount);
                    console.log('游꿀 P콏id치no token콢:', amount);
                    notifySuccess('游꿀 V칗HRA V TOMBOLE!', `+${amount} 游꿞`);
                }
            } else if (prize.type === 'xp') {
                if (amount > 0) {
                    addXP(amount);
                    console.log('游꿀 P콏id치no XP:', amount);
                    notifySuccess('游꿀 V칗HRA V TOMBOLE!', `+${amount} 救 XP`);
                }
            } else if (prize.type === 'item') {
                const itemId = prize.itemId;
                if (itemId) {
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) {
                        // P콏idej p콏edm캩t/y do invent치콏e
                        const itemCopy = JSON.parse(JSON.stringify(item));
                        itemCopy.count = amount;
                        addItemToInventory(itemCopy, amount);
                        console.log('游꿀 P콏id치n p콏edm캩t:', item.name, 'x', amount);
                        notifySuccess('游꿀 V칗HRA V TOMBOLE!', `${amount}x ${item.icon} ${item.name}`);
                    } else {
                        console.error('游꿀 P콏edm캩t nenalezen v ITEMS:', itemId);
                        // Fallback - vytvo콏 z치kladn칤 p콏edm캩t z prize dat
                        if (prize.itemName) {
                            const fallbackItem = {
                                id: itemId,
                                name: prize.itemName,
                                icon: prize.itemIcon || '游닍',
                                type: 'misc',
                                count: amount
                            };
                            state.inv.push(fallbackItem);
                            console.log('游꿀 P콏id치n fallback p콏edm캩t:', fallbackItem);
                            notifySuccess('游꿀 V칗HRA V TOMBOLE!', `${amount}x ${fallbackItem.icon} ${fallbackItem.name}`);
                        }
                    }
                } else {
                    console.error('游꿀 Chyb칤 itemId v prize:', prize);
                }
            } else {
                console.warn('游꿀 Nezn치m칳 typ v칳hry:', prize.type);
            }
            
            addLog(`V칳hra v tombole: ${getPrizeDescription(prize)}`, '游끥');
            saveGame(true);
            
            // Zobraz modal
            showModal('游꿀 VYHR츼L JSI TOMBOLU!', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">游끥</div>
                    <h2 style="color: #ffd700; margin: 0;">Gratulujeme!</h2>
                    <p style="color: #888; margin: 0.5rem 0;">Vyhr치l jsi tombolu "${escapeHtml(notification.tombolaName || 'Tombola')}"!</p>
                    <div style="background: #1a2a1a; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                        <p style="color: #4caf50; font-size: 1.5rem; margin: 0; font-weight: bold;">${getPrizeDescription(prize)}</p>
                    </div>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">游꿀 Super!</button>
            `);
            
            // Refresh UI
            renderFull();
        }
        
        // === ADMIN - S칈N칈 SL츼VY ===
        async function adminManageHallOfFame() {
            if (!isAdmin()) return;
            
            // Na캜ti sou캜asn칠 z치znamy z Firebase
            let entries = [];
            try {
                const snap = await firebaseDB.ref('hallOfFame').once('value');
                const data = snap.val();
                if (data) {
                    entries = Object.entries(data).map(([key, val]) => ({ key, ...val }));
                }
            } catch(e) {}
            
            let entriesHtml = entries.length > 0 ? entries.map(e => `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; color: #ffd700;">${escapeHtml(e.name)}</div>
                        <div style="font-size: 0.75rem; color: #888;">${escapeHtml(e.subtitle || '')}</div>
                    </div>
                    <button class="btn" onclick="adminRemoveFromHallOfFame('${e.key}')" style="background: #c62828; padding: 0.3rem 0.5rem; font-size: 0.75rem;">游딈勇</button>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">콯치dn칠 z치znamy v datab치zi</p>';
            
            showModal('游끹勇 Spr치va S칤n캩 sl치vy', `
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #4caf50;">俱 P콏idat nov칳 z치znam</h4>
                    <input type="text" id="hofName" placeholder="Jm칠no hr치캜e" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <input type="text" id="hofSubtitle" placeholder="Hl치코ka / popisek" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <button class="btn" onclick="adminAddToHallOfFame()" style="width: 100%; background: #4caf50;">俱 P콏idat do S칤n캩 sl치vy</button>
                </div>
                
                <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">游늶 Aktu치ln칤 z치znamy (Firebase)</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${entriesHtml}
                </div>
                
                <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem;">游눠 Hardcoded legendy (v k칩du) se zobrazuj칤 v쬯y.</p>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t</button>
            `);
        }
        
        async function adminAddToHallOfFame() {
            if (!isAdmin()) return;
            
            const name = document.getElementById('hofName')?.value?.trim();
            const subtitle = document.getElementById('hofSubtitle')?.value?.trim();
            
            if (!name) {
                notifyWarning('Chyb칤 jm칠no', 'Zadej jm칠no hr치캜e');
                return;
            }
            
            try {
                await firebaseDB.ref('hallOfFame').push({
                    name: name,
                    subtitle: subtitle || '',
                    addedAt: Date.now(),
                    addedBy: getPlayerName()
                });
                
                notifySuccess('P콏id치no!', `${name} je nyn칤 v S칤ni sl치vy`);
                adminManageHallOfFame(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se p콏idat');
            }
        }
        
        async function adminRemoveFromHallOfFame(key) {
            if (!isAdmin()) return;
            if (!confirm('Opravdu odebrat ze S칤n캩 sl치vy?')) return;
            
            try {
                await firebaseDB.ref('hallOfFame/' + key).remove();
                notifySuccess('Odebr치no', 'Z치znam smaz치n');
                adminManageHallOfFame(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se odebrat');
            }
        }
        
        // === ADMIN - MUTE HR츼캛콡 ===
        async function adminManageMutes() {
            if (!hasPermission('mute')) return;
            
            // Na캜ti seznam muted hr치캜콢
            let mutes = [];
            try {
                const snap = await firebaseDB.ref('mutedPlayers').once('value');
                const data = snap.val();
                if (data) {
                    mutes = Object.entries(data).map(([key, val]) => ({ key, ...val }));
                }
            } catch(e) {}
            
            let mutesHtml = mutes.length > 0 ? mutes.map(m => `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; color: #607d8b;">游댆 ${escapeHtml(m.name)}</div>
                        <div style="font-size: 0.75rem; color: #888;">D콢vod: ${escapeHtml(m.reason || 'Neuvedeno')}</div>
                        <div style="font-size: 0.7rem; color: #666;">Do: ${m.until ? new Date(m.until).toLocaleString('cs') : 'Nav쬯y'}</div>
                    </div>
                    <button class="btn" onclick="adminUnmutePlayer('${m.key}')" style="background: #4caf50; padding: 0.3rem 0.5rem; font-size: 0.75rem;">游댉 Unmute</button>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">콯치dn칤 ztlumen칤 hr치캜i</p>';
            
            showModal('游댆 Spr치va Mute', `
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #607d8b;">游댆 Ztlumit hr치캜e</h4>
                    <input type="text" id="muteName" placeholder="Nick hr치캜e" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <input type="text" id="muteReason" placeholder="D콢vod (voliteln칠)" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <select id="muteDuration" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                        <option value="3600000">1 hodina</option>
                        <option value="86400000">1 den</option>
                        <option value="604800000">1 t칳den</option>
                        <option value="2592000000">1 m캩s칤c</option>
                        <option value="0">Nav쬯y</option>
                    </select>
                    <button class="btn" onclick="adminMutePlayer()" style="width: 100%; background: #607d8b;">游댆 Ztlumit</button>
                </div>
                
                <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">游늶 Ztlumen칤 hr치캜i</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${mutesHtml}
                </div>
                
                <p style="color: #888; font-size: 0.75rem; margin-top: 0.5rem;">游눠 Ztlumen칤 hr치캜i nemohou ps치t do glob치ln칤ho chatu.</p>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t</button>
            `);
        }
        
        async function adminMutePlayer() {
            if (!hasPermission('mute')) return;
            
            const name = document.getElementById('muteName')?.value?.trim();
            const reason = document.getElementById('muteReason')?.value?.trim();
            const duration = parseInt(document.getElementById('muteDuration')?.value || '0');
            
            if (!name) {
                notifyWarning('Chyb칤 nick', 'Zadej nick hr치캜e');
                return;
            }
            
            const until = duration > 0 ? Date.now() + duration : 0; // 0 = nav쬯y
            
            try {
                await firebaseDB.ref('mutedPlayers/' + name).set({
                    name: name,
                    reason: reason || '',
                    until: until,
                    mutedAt: Date.now(),
                    mutedBy: getPlayerName()
                });
                
                notifySuccess('Ztlumen!', `${name} byl ztlumen v chatu`);
                adminManageMutes(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se ztlumit');
            }
        }
        
        async function adminUnmutePlayer(key) {
            if (!hasPermission('mute')) return;
            
            try {
                await firebaseDB.ref('mutedPlayers/' + key).remove();
                notifySuccess('Odtlumeno', 'Hr치캜 m콢쬰 op캩t ps치t');
                adminManageMutes(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se odtlumit');
            }
        }
        
        // === ADMIN - BAN HR츼캛콡 ===
        async function adminManageBans() {
            if (!isAdmin()) return;
            
            // Na캜ti seznam banned hr치캜콢 z obou zdroj콢
            let bans = [];
            try {
                // Star칳 form치t - bannedPlayers
                const snap1 = await firebaseDB.ref('bannedPlayers').once('value');
                const data1 = snap1.val();
                if (data1) {
                    Object.entries(data1).forEach(([key, val]) => {
                        bans.push({ key, source: 'bannedPlayers', name: val.name || key, ...val });
                    });
                }
                
                // Nov칳 form치t - bans
                const snap2 = await firebaseDB.ref('bans').once('value');
                const data2 = snap2.val();
                if (data2) {
                    Object.entries(data2).forEach(([key, val]) => {
                        // P콏esko캜 pokud u existuje
                        if (!bans.find(b => b.name === val.player)) {
                            bans.push({ 
                                key, 
                                source: 'bans', 
                                name: val.player || key, 
                                reason: val.reason,
                                until: val.expiresAt,
                                bannedAt: val.timestamp,
                                bannedBy: val.bannedBy,
                                duration: val.duration
                            });
                        }
                    });
                }
            } catch(e) {
                console.error('Load bans error:', e);
            }
            
            // Se콏a캞 podle 캜asu (nejnov캩j코칤 prvn칤)
            bans.sort((a, b) => (b.bannedAt || 0) - (a.bannedAt || 0));
            
            let bansHtml = bans.length > 0 ? bans.map(b => {
                const isPermanent = !b.until || b.until === 0;
                const isExpired = !isPermanent && b.until < Date.now();
                const expiresText = isPermanent ? 'Permanentn캩' : (isExpired ? 'Vypr코el' : new Date(b.until).toLocaleString('cs'));
                const statusColor = isExpired ? '#888' : (isPermanent ? '#f44336' : '#ff9800');
                
                return `
                    <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${statusColor};">游뛂 ${escapeHtml(b.name)}</div>
                                <div style="font-size: 0.75rem; color: #888;">D콢vod: ${escapeHtml(b.reason || 'Neuvedeno')}</div>
                                <div style="font-size: 0.7rem; color: #666;">
                                    ${isExpired ? '낋 Vypr코el' : (isPermanent ? '久 Permanentn칤' : '낌勇 Do: ' + expiresText)}
                                </div>
                                ${b.bannedBy ? `<div style="font-size: 0.65rem; color: #555;">Zabanoval: ${escapeHtml(b.bannedBy)}</div>` : ''}
                            </div>
                            <button class="btn" onclick="adminUnbanPlayer('${b.key}', '${b.source}')" style="background: #4caf50; padding: 0.3rem 0.6rem; font-size: 0.75rem;">九 Unban</button>
                        </div>
                    </div>
                `;
            }).join('') : '<p style="color: #666; text-align: center; padding: 1rem;">콯치dn칤 zabanovan칤 hr치캜i 游꿀</p>';
            
            showModal('游뛂 Spr치va Ban콢', `
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f44336;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #f44336;">游뛂 Zabanovat hr치캜e</h4>
                    <input type="text" id="banName" placeholder="Nick hr치캜e" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <input type="text" id="banReason2" placeholder="D콢vod banu" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <select id="banDuration2" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                        <option value="60">1 hodina</option>
                        <option value="720">12 hodin</option>
                        <option value="1440">24 hodin</option>
                        <option value="4320">3 dny</option>
                        <option value="10080">7 dn칤</option>
                        <option value="43200">30 dn칤</option>
                        <option value="0">Permanentn캩</option>
                    </select>
                    <button class="btn" onclick="adminBanPlayer()" style="width: 100%; background: #b71c1c;">游뛂 ZABANOVAT</button>
                </div>
                
                <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">游늶 Zabanovan칤 hr치캜i (${bans.length})</h4>
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${bansHtml}
                </div>
                
                <p style="color: #888; font-size: 0.75rem; margin-top: 0.5rem;">丘멆잺 Zabanovan칤 hr치캜i nemohou hr치t hru.</p>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t</button>
            `);
        }
        
        async function adminBanPlayer() {
            if (!isAdmin()) return;
            
            const name = document.getElementById('banName')?.value?.trim();
            const reason = document.getElementById('banReason2')?.value?.trim();
            const duration = parseInt(document.getElementById('banDuration2')?.value || '0');
            
            if (!name) {
                notifyWarning('Chyb칤 nick', 'Zadej nick hr치캜e');
                return;
            }
            
            if (!confirm(`丘멆잺 Opravdu chce코 zabanovat hr치캜e "${name}"?`)) return;
            
            const expiresAt = duration > 0 ? Date.now() + (duration * 60 * 1000) : 0; // 0 = permaban
            
            try {
                // Pou쬴j nov칳 form치t bans
                await firebaseDB.ref('bans/' + name.replace(/[\/\.#$\[\]]/g, '_')).set({
                    player: name,
                    reason: reason || 'Poru코en칤 pravidel',
                    expiresAt: expiresAt,
                    duration: duration,
                    timestamp: Date.now(),
                    bannedBy: getPlayerName()
                });
                
                notifySuccess('游뛂 Zabanov치n!', `${name} byl zabanov치n`);
                adminManageBans(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se zabanovat: ' + e.message);
            }
        }
        
        async function adminUnbanPlayer(key, source = 'bannedPlayers') {
            if (!isAdmin()) return;
            
            try {
                await firebaseDB.ref(source + '/' + key).remove();
                notifySuccess('九 Odbanov치n', 'Hr치캜 m콢쬰 op캩t hr치t');
                adminManageBans(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda콏ilo se odbanovat: ' + e.message);
            }
        }
        
        // === BAN SCREEN ===
        function showBanScreen(playerName, reason, until) {
            document.body.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, #1a0a0a 0%, #2a0a0a 100%); display: flex; justify-content: center; align-items: center; padding: 2rem;">
                    <div style="background: #1a1a1a; padding: 2rem; border-radius: 16px; max-width: 500px; text-align: center; border: 3px solid #f44336; box-shadow: 0 0 50px rgba(244, 67, 54, 0.5);">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">游뛂</div>
                        <h1 style="color: #f44336; margin: 0 0 1rem 0;">P콎칈STUP ODEP콎EN</h1>
                        <p style="color: #888; font-size: 1.1rem; margin-bottom: 1.5rem;">
                            칔캜et <strong style="color: #fff;">${escapeHtml(playerName)}</strong> byl zabanov치n.
                        </p>
                        
                        <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #f44336;">
                            <p style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.9rem;">D콢vod:</p>
                            <p style="color: #fff; margin: 0; font-size: 1rem;">${escapeHtml(reason || 'Poru코en칤 pravidel')}</p>
                        </div>
                        
                        <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <p style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Ban vypr코칤:</p>
                            <p style="color: #ff9800; margin: 0; font-size: 1.2rem; font-weight: bold;">${until}</p>
                        </div>
                        
                        <p style="color: #666; font-size: 0.85rem;">
                            Pokud si mysl칤코, 쬰 jde o omyl, kontaktuj admina na Discordu.
                        </p>
                        
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.8rem 2rem; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            游댃 Zkusit znovu
                        </button>
                    </div>
                </div>
            `;
        }
        
        // === VY캛ISTIT ZASEKNUT칄 CAPTURE ===
        async function adminClearCaptures() {
            if (!isAdmin()) return;
            
            showModal('游낎 Spr치va Capture', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Na캜칤t치m teritoria...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('territories').once('value');
                const territories = snap.val() || {};
                
                // Najdi v코echny aktivn칤 capture
                const activeCaptures = [];
                for (const [locId, territory] of Object.entries(territories)) {
                    if (territory.activeCapture) {
                        const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                        activeCaptures.push({
                            locationId: locId,
                            locationName: loc?.name || locId,
                            ...territory.activeCapture
                        });
                    }
                }
                
                if (activeCaptures.length === 0) {
                    showModal('游낎 Spr치va Capture', `
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">九</div>
                            <p style="color: #8bc34a;">콯치dn칠 aktivn칤 capture</p>
                            <p style="color: #888; font-size: 0.85rem;">V코echna teritoria jsou v po콏치dku.</p>
                        </div>
                        <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t</button>
                    `);
                    return;
                }
                
                let html = `
                    <p style="color: #ff9800; margin-bottom: 1rem;">Nalezeno ${activeCaptures.length} aktivn칤ch capture:</p>
                    <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                `;
                
                for (const capture of activeCaptures) {
                    const elapsed = Date.now() - capture.startTime;
                    const elapsedMins = Math.floor(elapsed / 60000);
                    const factionData = PVP_FACTIONS[capture.faction];
                    
                    html += `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold; color: #ddd;">${capture.locationName}</div>
                                    <div style="font-size: 0.8rem; color: #888;">
                                        Hr치캜: <span style="color: #ffd700;">${capture.player}</span> |
                                        Frakce: <span style="color: ${factionData?.color || '#888'};">${factionData?.name || capture.faction}</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: #666;">B캩쮂: ${elapsedMins} minut</div>
                                </div>
                                <button class="btn" onclick="adminDeleteCapture('${capture.locationId}')" style="background: #c62828; padding: 0.5rem 1rem;">
                                    游딈勇 Smazat
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                    <button class="btn" onclick="adminClearAllCaptures()" style="width: 100%; margin-top: 1rem; background: #f44336;">游딈勇 Smazat VECHNY capture</button>
                    <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 0.5rem; background: #333;"> Zp캩t</button>
                `;
                
                showModal('游낎 Spr치va Capture', html);
            } catch(e) {
                console.error('Load captures error:', e);
                showModal('游낎 Chyba', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;"> Zp캩t</button>`);
            }
        }
        
        async function adminDeleteCapture(locationId) {
            if (!isAdmin()) return;
            
            try {
                await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                notifySuccess('Smaz치no', `Capture na ${locationId} byl odstran캩n`);
                adminClearCaptures(); // Refresh
            } catch(e) {
                console.error('Delete capture error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllCaptures() {
            if (!isAdmin()) return;
            
            if (!confirm('Opravdu smazat VECHNY aktivn칤 capture?')) return;
            
            try {
                const snap = await firebaseDB.ref('territories').once('value');
                const territories = snap.val() || {};
                
                let count = 0;
                for (const [locId, territory] of Object.entries(territories)) {
                    if (territory.activeCapture) {
                        await firebaseDB.ref('territories/' + locId + '/activeCapture').remove();
                        count++;
                    }
                }
                
                notifySuccess('Hotovo', `Smaz치no ${count} capture`);
                adminClearCaptures(); // Refresh
            } catch(e) {
                console.error('Clear all captures error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === ZTRACEN칗 POKLAD ===
        async function adminTreasure() {
            if (!hasPermission('treasure')) {
                notifyWarning('仇 P콏칤stup odep콏en', 'Nem치코 opr치vn캩n칤');
                return;
            }
            
            // Na캜ti aktivn칤 poklad pokud existuje
            let activeTreasure = null;
            try {
                const snap = await firebaseDB.ref('treasure').once('value');
                activeTreasure = snap.val();
            } catch (e) {
                console.log('Treasure load error:', e);
            }
            
            // Seznam lokac칤
            const locations = WORLD_LOCATIONS.filter(l => l.id !== 'shelter');
            
            // Seznam polo쬰k pro v칳b캩r
            const treasureItems = [
                { id: 'water', name: '游눦 Voda', icon: '游눦' },
                { id: 'canned_food', name: '游볾 Konzerva', icon: '游볾' },
                { id: 'medkit', name: '游눍 L칠k치rni캜ka', icon: '游눍' },
                { id: 'bandage', name: '游뽗 Obvaz', icon: '游뽗' },
                { id: 'stimpack', name: '游눌 Stimpack', icon: '游눌' },
                { id: 'money', name: '游눯 Pen칤ze', icon: '游눯' },
                { id: 'ammo_9mm', name: '游댳 9mm n치boje', icon: '游댳' },
                { id: 'ammo_shell', name: '游댲 Broky', icon: '游댲' },
                { id: 'scrap', name: '游댤 rot', icon: '游댤' },
                { id: 'cloth', name: '游빗 L치tka', icon: '游빗' },
                { id: 'herbs', name: '游 Byliny', icon: '游' },
                { id: 'leather', name: '游붍 K콢쬰', icon: '游붍' },
                { id: 'electronics', name: '游님 Elektronika', icon: '游님' },
                { id: 'chemicals', name: '游빍 Chemik치lie', icon: '游빍' }
            ];
            
            if (activeTreasure && activeTreasure.endTime > Date.now()) {
                // Zobraz aktivn칤 poklad
                const loc = WORLD_LOCATIONS.find(l => l.id === activeTreasure.locationId);
                const remaining = Math.max(0, activeTreasure.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const claimedCount = activeTreasure.claimedBy ? Object.keys(activeTreasure.claimedBy).length : 0;
                
                let itemsHtml = '';
                if (activeTreasure.items) {
                    activeTreasure.items.forEach(item => {
                        itemsHtml += `<div style="display: inline-block; background: #2a2a2a; padding: 0.3rem 0.6rem; border-radius: 4px; margin: 0.2rem;">${item.icon} ${item.count}x</div>`;
                    });
                }
                if (activeTreasure.money) {
                    itemsHtml += `<div style="display: inline-block; background: #2a2a2a; padding: 0.3rem 0.6rem; border-radius: 4px; margin: 0.2rem;">游눯 ${activeTreasure.money}</div>`;
                }
                
                showModal('游눑 Aktivn칤 poklad', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">游눑</div>
                        <p style="color: #ffd700; font-size: 1.2rem;">Poklad je aktivn칤!</p>
                        <p style="margin: 0.3rem 0;"><strong>Lokace:</strong> ${loc?.icon || '游늸'} ${loc?.name || activeTreasure.locationId}</p>
                        <p style="margin: 0.3rem 0;"><strong>Zb칳v치:</strong> <span style="color: #ff9800;">${mins} minut</span></p>
                        <p style="margin: 0.3rem 0;"><strong>Vyzvedlo:</strong> <span style="color: #4caf50;">${claimedCount} hr치캜콢</span></p>
                        <div style="margin: 0.5rem 0;">${itemsHtml}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminCancelTreasure()" style="flex: 1; background: #c62828;">仇 Zru코it poklad</button>
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #333;"> Zav콏칤t</button>
                    </div>
                `);
            } else {
                // Formul치콏 pro vytvo콏en칤 nov칠ho pokladu
                showModal('游눑 Vytvo콏it poklad', `
                    <div style="font-size: 0.9rem;">
                        <p style="color: #ffd700; margin-bottom: 1rem;">Um칤sti poklad na mapu - ka쬯칳 kdo tam dojde si m콢쬰 vz칤t!</p>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">游늸 Lokace:</label>
                            <select id="treasureLocation" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem;">
                                ${locations.map(l => `<option value="${l.id}">${l.icon} ${l.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">낌勇 Doba trv치n칤:</label>
                            <select id="treasureDuration" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                                <option value="15">15 minut</option>
                                <option value="30" selected>30 minut</option>
                                <option value="60">1 hodina</option>
                                <option value="120">2 hodiny</option>
                                <option value="360">6 hodin</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">游눯 Pen칤ze (0 = 쮂멳n칠):</label>
                            <input type="number" id="treasureMoney" value="0" min="0" max="10000" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem;">
                        </div>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">游닍 Polo쬶y (vyber a nastav po캜et):</label>
                            <div id="treasureItemsList" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; border-radius: 6px; padding: 0.5rem; margin-top: 0.3rem;">
                                ${treasureItems.map(item => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem; border-bottom: 1px solid #333;">
                                        <span style="width: 80px;">${item.icon} ${item.name.split(' ')[1]}</span>
                                        <input type="number" id="treasure_${item.id}" value="0" min="0" max="99" style="width: 60px; padding: 0.3rem; background: #0d0d0d; color: #fff; border: 1px solid #444; border-radius: 4px; text-align: center;">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn" onclick="createTreasure()" style="flex: 2; background: linear-gradient(135deg, #ffd700 0%, #ff8f00 100%); color: #000; font-weight: bold;">游눑 Vytvo콏it poklad</button>
                            <button class="btn" onclick="closeModal()" style="flex: 1; background: #333;">Zru코it</button>
                        </div>
                    </div>
                `);
            }
        }
        
        async function createTreasure() {
            if (!isAdmin()) return;
            
            const locationId = document.getElementById('treasureLocation').value;
            const duration = parseInt(document.getElementById('treasureDuration').value);
            const money = parseInt(document.getElementById('treasureMoney').value) || 0;
            
            // Sb칤r치n칤 polo쬰k
            const items = [];
            const itemDefs = [
                { id: 'water', icon: '游눦' },
                { id: 'canned_food', icon: '游볾' },
                { id: 'medkit', icon: '游눍' },
                { id: 'bandage', icon: '游뽗' },
                { id: 'stimpack', icon: '游눌' },
                { id: 'ammo_9mm', icon: '游댳', isAmmo: true, ammoType: '9mm' },
                { id: 'ammo_shell', icon: '游댲', isAmmo: true, ammoType: 'shell' },
                { id: 'scrap', icon: '游댤' },
                { id: 'cloth', icon: '游빗' },
                { id: 'herbs', icon: '游' },
                { id: 'leather', icon: '游붍' },
                { id: 'electronics', icon: '游님' },
                { id: 'chemicals', icon: '游빍' }
            ];
            
            itemDefs.forEach(def => {
                const input = document.getElementById('treasure_' + def.id);
                if (input) {
                    const count = parseInt(input.value) || 0;
                    if (count > 0) {
                        items.push({
                            id: def.id,
                            icon: def.icon,
                            count: count,
                            isAmmo: def.isAmmo || false,
                            ammoType: def.ammoType || null
                        });
                    }
                }
            });
            
            // Speci치ln칤 handling pro pen칤ze
            const moneyInput = document.getElementById('treasure_money');
            if (moneyInput) {
                const moneyCount = parseInt(moneyInput.value) || 0;
                if (moneyCount > 0) {
                    // Money se p콏id치 p콏칤mo, ne jako item
                }
            }
            
            if (items.length === 0 && money === 0) {
                notifyWarning('Pr치zdn칳 poklad', 'P콏idej alespo켿 jednu polo쬶u nebo pen칤ze!');
                return;
            }
            
            try {
                const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
                
                // Ulo poklad do Firebase
                await firebaseDB.ref('treasure').set({
                    locationId: locationId,
                    items: items,
                    money: money,
                    startTime: Date.now(),
                    endTime: Date.now() + (duration * 60 * 1000),
                    createdBy: ADMIN_NICK,
                    claimedBy: {}
                });
                
                // Zpr치va do chatu
                let treasureDesc = [];
                items.forEach(item => treasureDesc.push(`${item.count}x ${item.icon}`));
                if (money > 0) treasureDesc.push(`${money} 游눯`);
                
                await firebaseDB.ref('chat/messages').push({
                    player: '游눑 POKLAD',
                    text: `游딬勇 Byl nalezen ZTRACEN칗 POKLAD na lokaci ${loc?.icon || '游늸'} ${loc?.name || locationId}! Obsahuje: ${treasureDesc.join(', ')}. Posp캩코te si - zmiz칤 za ${duration} minut! 游끢꽥뗵勇`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                closeModal();
                notifySuccess('游눑 Poklad vytvo콏en!', `Na ${loc?.name || locationId} - ${duration} minut`);
                
            } catch (e) {
                console.error('Create treasure error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminCancelTreasure() {
            if (!hasPermission('treasure')) return;
            
            if (!confirm('Opravdu zru코it poklad?')) return;
            
            try {
                await firebaseDB.ref('treasure').remove();
                window.activeTreasure = null;
                
                await firebaseDB.ref('chat/messages').push({
                    player: '游눑 POKLAD',
                    text: '仇 Ztracen칳 poklad byl odstran캩n.',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                closeModal();
                notifyInfo('Poklad zru코en', 'Odstran캩no');
                
            } catch (e) {
                console.error('Cancel treasure error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Vyzvednut칤 pokladu hr치캜em
        async function claimTreasure() {
            if (!multiplayerEnabled || !firebaseDB || !state.char?.name) {
                notifyWarning('Chyba', 'Mus칤코 b칳t p콏ihl치코en!');
                return;
            }
            
            try {
                const snap = await firebaseDB.ref('treasure').once('value');
                const treasure = snap.val();
                
                if (!treasure || treasure.endTime < Date.now()) {
                    notifyWarning('Pozd캩!', 'Poklad u zmizel...');
                    window.activeTreasure = null;
                    renderWorldMap();
                    return;
                }
                
                // Kontrola jestli jsem na spr치vn칠 lokaci
                if (state.world?.currentLocation !== treasure.locationId) {
                    notifyWarning('맗atn치 lokace', 'Mus칤코 b칳t na m칤st캩 pokladu!');
                    return;
                }
                
                // Kontrola jestli u jsem nevyzvedl
                const myName = state.char.name;
                if (treasure.claimedBy && treasure.claimedBy[myName.replace(/[.\[\]#$/]/g, '_')]) {
                    notifyWarning('U m치코', 'Tento poklad jsi u vyzvedl!');
                    return;
                }
                
                // Vyzvedni poklad
                const safeName = myName.replace(/[.\[\]#$/]/g, '_');
                await firebaseDB.ref('treasure/claimedBy/' + safeName).set({
                    time: Date.now(),
                    name: myName
                });
                
                // P콏idej polo쬶y do invent치콏e
                let receivedText = [];
                
                if (treasure.items) {
                    treasure.items.forEach(item => {
                        if (item.isAmmo && item.ammoType) {
                            // N치boje
                            addAmmo(item.ammoType, item.count);
                            receivedText.push(`${item.count}x ${item.icon}`);
                        } else {
                            // Norm치ln칤 item
                            const itemDef = ITEMS.find(i => i.id === item.id);
                            if (itemDef) {
                                const newItem = JSON.parse(JSON.stringify(itemDef));
                                newItem.count = item.count;
                                addItemToInventory(newItem, item.count);
                                receivedText.push(`${item.count}x ${item.icon}`);
                            }
                        }
                    });
                }
                
                if (treasure.money > 0) {
                    addMoney(treasure.money);
                    receivedText.push(`${treasure.money} 游눯`);
                }
                
                SoundSystem.play('pickup');
                
                showModal('游눑 Poklad vyzvednut!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">游꿀</div>
                        <h3 style="color: #ffd700;">Na코el jsi poklad!</h3>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="color: #8bc34a; font-size: 1.2rem;">${receivedText.join(', ')}</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">游꿀 Super!</button>
                `);
                
                addLog(`游눑 Vyzvedl jsi poklad: ${receivedText.join(', ')}`, '游눑');
                
            } catch (e) {
                console.error('Claim treasure error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === V츼LE캛N츼 Z칍NA ===
        async function adminWarZone() {
            if (!hasPermission('warzone')) return;
            
            // Na캜ti aktu치ln칤 v치le캜nou z칩nu pokud existuje
            let activeWarZone = null;
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snap = await firebaseDB.ref('warZone').once('value');
                    activeWarZone = snap.val();
                } catch(e) {}
            }
            
            // Seznam lokac칤 pro v칳b캩r
            const locations = WORLD_LOCATIONS.filter(l => l.type !== 'home' && l.id !== 'shelter');
            const locOptions = locations.map(l => 
                `<option value="${l.id}" ${activeWarZone?.locationId === l.id ? 'selected' : ''}>${l.icon} ${l.name}</option>`
            ).join('');
            
            // Seznam nep콏치tel pro v칳b캩r
            const enemyOptions = ENEMIES.map(e => 
                `<option value="${e.id}">${e.icon} ${e.name} (HP: ${e.hp}, DMG: ${e.damage})</option>`
            ).join('');
            
            // 캛asov칠 mo쬹osti
            const timeOptions = `
                <option value="30">30 minut</option>
                <option value="60" selected>1 hodina</option>
                <option value="120">2 hodiny</option>
                <option value="180">3 hodiny</option>
                <option value="360">6 hodin</option>
                <option value="720">12 hodin</option>
                <option value="1440">24 hodin</option>
            `;
            
            // Odm캩ny
            const rewardOptions = `
                <option value="100">100 游눯</option>
                <option value="250" selected>250 游눯</option>
                <option value="500">500 游눯</option>
                <option value="1000">1000 游눯</option>
            `;
            
            let activeHtml = '';
            if (activeWarZone && activeWarZone.endTime > Date.now()) {
                const loc = WORLD_LOCATIONS.find(l => l.id === activeWarZone.locationId);
                const enemy = ENEMIES.find(e => e.id === activeWarZone.enemyId);
                const remaining = Math.max(0, activeWarZone.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const hours = Math.floor(mins / 60);
                const timeStr = hours > 0 ? `${hours}h ${mins % 60}m` : `${mins}m`;
                
                // Na캜ti aktu치ln칤 body
                let pointsHtml = '';
                try {
                    const terrSnap = await firebaseDB.ref('warZone/factionPoints').once('value');
                    const warPoints = terrSnap.val() || {};
                    
                    // Se콏a캞 podle bod콢
                    const sorted = Object.entries(PVP_FACTIONS)
                        .map(([fid, f]) => ({ fid, f, pts: warPoints[fid] || 0 }))
                        .sort((a, b) => b.pts - a.pts);
                    
                    pointsHtml = sorted.map(({ fid, f, pts }) => {
                        const isLeader = pts > 0 && pts === sorted[0].pts;
                        return `<div style="display: flex; justify-content: space-between; padding: 0.5rem; background: ${f.color}22; border-radius: 4px; margin: 0.3rem 0; ${isLeader ? 'border: 2px solid ' + f.color : ''}">
                            <span>${f.icon} ${f.name} ${isLeader ? '游녬' : ''}</span>
                            <span style="font-weight: bold; color: ${f.color}; font-size: 1.1rem;">${pts} bod콢</span>
                        </div>`;
                    }).join('');
                } catch(e) {}
                
                activeHtml = `
                    <div style="background: linear-gradient(135deg, #2a1a1a 0%, #1a1a2a 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ff5722;">
                        <h3 style="color: #ff5722; margin: 0 0 0.5rem 0;">丘덢잺 AKTIVN칈 V츼LE캛N츼 Z칍NA</h3>
                        <p style="margin: 0.3rem 0;"><strong>Lokace:</strong> ${loc?.icon || '游늸'} ${loc?.name || activeWarZone.locationId}</p>
                        <p style="margin: 0.3rem 0;"><strong>Nep콏칤tel:</strong> ${enemy?.icon || '游놏'} ${enemy?.name || '?'} (${activeWarZone.enemyCount}x)</p>
                        <p style="margin: 0.3rem 0;"><strong>Zb칳v치:</strong> <span style="color: #ffd700;">${timeStr}</span></p>
                        <p style="margin: 0.3rem 0;"><strong>Odm캩na:</strong> <span style="color: #ffd700;">${activeWarZone.reward} 游눯</span></p>
                        
                        <div style="margin-top: 0.8rem;">
                            <p style="color: #ff9800; font-weight: bold; margin: 0.3rem 0;">游늵 Aktu치ln칤 sk칩re:</p>
                            ${pointsHtml}
                        </div>
                        
                        <button class="btn" onclick="adminEndWarZone()" style="width: 100%; margin-top: 1rem; background: #f44336;">
                            游띔 Ukon캜it a vyhodnotit
                        </button>
                        <button class="btn" onclick="adminCancelWarZone()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                            仇 Zru코it bez odm캩n
                        </button>
                    </div>
                `;
            }
            
            showModal('丘덢잺 V치le캜n치 z칩na', `
                ${activeHtml}
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4caf50;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.85rem;">
                        游눠 <strong>Jak to funguje:</strong><br>
                         Vyber lokaci, nep콏칤tele a nastaven칤<br>
                         Hr치캜i p콏ijdou na lokaci a bojuj칤 s tv칳m nep콏칤telem<br>
                         Po boji 캜ekaj칤 10 minut na dal코칤 boj<br>
                         Hr치캜 nem콢쬰 zem콏칤t a nedost치v치 XP<br>
                         Ka쬯칳 zabit칳 nep콏칤tel = body pro frakci<br>
                         V칤t캩zn치 frakce dostane odm캩nu!
                    </p>
                </div>
                
                <div style="margin-bottom: 0.8rem;">
                    <label style="color: #888; font-size: 0.85rem;">游늸 Lokace bitvy:</label>
                    <select id="warZoneLocation" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #ff5722; border-radius: 6px; margin-top: 0.3rem;">
                        ${locOptions}
                    </select>
                </div>
                
                <div style="margin-bottom: 0.8rem;">
                    <label style="color: #888; font-size: 0.85rem;">游놏 Nep콏칤tel:</label>
                    <select id="warZoneEnemy" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #f44336; border-radius: 6px; margin-top: 0.3rem;">
                        ${enemyOptions}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.8rem;">
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">游논 Po캜et nep콏치tel:</label>
                        <select id="warZoneEnemyCount" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">救 Body za boj:</label>
                        <select id="warZonePoints" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                            <option value="1">1 bod</option>
                            <option value="2">2 body</option>
                            <option value="3" selected>3 body</option>
                            <option value="5">5 bod콢</option>
                            <option value="10">10 bod콢</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">낌勇 Doba trv치n칤:</label>
                        <select id="warZoneDuration" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                            ${timeOptions}
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">游끥 Odm캩na:</label>
                        <select id="warZoneReward" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem;">
                            ${rewardOptions}
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="adminStartWarZone()" style="width: 100%; background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem; font-size: 1.1rem;">
                    丘덢잺 VYHL츼SIT V츼LE캛NOU Z칍NU
                </button>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 0.5rem; background: #333;"> Zp캩t</button>
            `);
        }
        
        // Renderov치n칤 mapy pro v칳b캩r v치le캜n칠 z칩ny (admin)
        function renderWarZoneMap() {
            const cellSize = 38;
            const locations = WORLD_LOCATIONS.filter(l => l.type !== 'home' && l.id !== 'shelter');
            
            let minX = 0, maxX = 0, minY = 0, maxY = 0;
            locations.forEach(loc => {
                if (loc.x < minX) minX = loc.x;
                if (loc.x > maxX) maxX = loc.x;
                if (loc.y < minY) minY = loc.y;
                if (loc.y > maxY) maxY = loc.y;
            });
            
            const gridWidth = (maxX - minX + 1) * cellSize;
            const gridHeight = (maxY - minY + 1) * cellSize;
            
            let html = `<div style="position: relative; width: ${gridWidth}px; height: ${gridHeight}px; margin: 0 auto;">`;
            
            locations.forEach(loc => {
                const left = (loc.x - minX) * cellSize;
                const top = (loc.y - minY) * cellSize;
                
                html += `<div onclick="selectWarZoneLocation('${loc.id}')" 
                    style="position: absolute; left: ${left}px; top: ${top}px; width: ${cellSize - 4}px; height: ${cellSize - 4}px; 
                    background: #1a1a1a; border: 2px solid #444; border-radius: 4px; 
                    display: flex; align-items: center; justify-content: center; font-size: 0.9rem; 
                    cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='#ff5722'; this.style.boxShadow='0 0 10px #ff5722';"
                    onmouseout="this.style.borderColor='#444'; this.style.boxShadow='none';"
                    title="${loc.name}">
                    ${loc.icon}
                </div>`;
            });
            
            html += '</div>';
            return html;
        }
        
        // V칳b캩r lokace pro v치le캜nou z칩nu (admin)
        function selectWarZoneLocation(locationId) {
            window.selectedWarZoneLocation = locationId;
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            
            const enemyOptions = ENEMIES.map(e => 
                `<option value="${e.id}">${e.icon} ${e.name} (HP:${e.hp} DMG:${e.damage} T${e.tier || 1})</option>`
            ).join('');
            
            showModal(`丘덢잺 ${loc?.icon || ''} ${loc?.name || locationId}`, `
                <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.8rem; border: 2px solid #ff5722; text-align: center;">
                    <span style="color: #ff5722; font-size: 1.1rem;">游늸 ${loc?.icon || ''} ${loc?.name || locationId}</span>
                </div>
                
                <div style="margin-bottom: 0.6rem;">
                    <label style="color: #888; font-size: 0.8rem;">游놏 Nep콏칤tel:</label>
                    <select id="warZoneEnemy" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #f44336; border-radius: 6px; margin-top: 0.2rem; font-size: 0.85rem;">
                        ${enemyOptions}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-bottom: 0.6rem;">
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">游논 Po캜et:</label>
                        <select id="warZoneEnemyCount" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">救 Body:</label>
                        <select id="warZonePoints" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="5">5</option><option value="10">10</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-bottom: 0.8rem;">
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">낌勇 캛as:</label>
                        <select id="warZoneDuration" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="30">30m</option><option value="60" selected>1h</option><option value="120">2h</option><option value="180">3h</option><option value="360">6h</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">游끥 Odm캩na:</label>
                        <select id="warZoneReward" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="100">100游눯</option><option value="250" selected>250游눯</option><option value="500">500游눯</option><option value="1000">1000游눯</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="adminStartWarZone()" style="width: 100%; background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 0.8rem; font-size: 1rem;">
                    丘덢잺 VYHL츼SIT V츼LKU!
                </button>
                <button class="btn" onclick="adminWarZone()" style="width: 100%; margin-top: 0.4rem; background: #333; padding: 0.6rem;"> Zp캩t</button>
            `);
        }
        
        // Spustit v치le캜nou z칩nu
        async function adminStartWarZone() {
            if (!hasPermission('warzone')) return;
            
            // Pou쬴j vybranou lokaci z mapy nebo z dropdownu
            const locationId = window.selectedWarZoneLocation || document.getElementById('warZoneLocation')?.value;
            const enemyId = document.getElementById('warZoneEnemy')?.value;
            const enemyCount = parseInt(document.getElementById('warZoneEnemyCount')?.value) || 3;
            const pointsPerWin = parseInt(document.getElementById('warZonePoints')?.value) || 3;
            const duration = parseInt(document.getElementById('warZoneDuration')?.value) || 60;
            const reward = parseInt(document.getElementById('warZoneReward')?.value) || 250;
            
            if (!locationId || !enemyId) {
                notifyWarning('Chyba', 'Vyber lokaci a nep콏칤tele!');
                return;
            }
            
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            const enemy = ENEMIES.find(e => e.id === enemyId);
            
            try {
                // Nastav v치le캜nou z칩nu v Firebase
                await firebaseDB.ref('warZone').set({
                    locationId: locationId,
                    locationName: loc?.name || locationId,
                    enemyId: enemyId,
                    enemyCount: enemyCount,
                    pointsPerWin: pointsPerWin,
                    startTime: Date.now(),
                    endTime: Date.now() + (duration * 60 * 1000),
                    reward: reward,
                    startedBy: getPlayerName(),
                    factionPoints: {
                        kory: 0,
                        koudy: 0,
                        independent: 0
                    }
                });
                
                // Aktualizuj lok치ln칤 cache
                window.activeWarZone = {
                    locationId: locationId,
                    endTime: Date.now() + (duration * 60 * 1000)
                };
                
                // Vy캜isti vybranou lokaci
                window.selectedWarZoneLocation = null;
                
                // Po코li notifikaci v코em - form치t jako tombola
                await firebaseDB.ref('chat/messages').push({
                    author: '丘덢잺 V츼LE캛N츼 Z칍NA',
                    text: `游댠 BITVA VYHL츼ENA! Lokace: ${loc?.icon || '游늸'} ${loc?.name || locationId} | Nep콏칤tel: ${enemy?.icon || '游놏'} ${enemy?.name} (${enemyCount}x) | 캛as: ${duration} min\n游눯 Odm캩na pro v칤t캩znou frakci: ${reward} 游눯 na hr치캜e! B캩쬾e bojovat!`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                notifySuccess('丘덢잺 V치le캜n치 z칩na vyhl치코ena!', `${loc?.name || locationId} - ${duration} minut`);
                closeModal();
                renderFull(); // P콏ekresli mapu s 캜erven칳m sv칤cen칤m
                
            } catch(e) {
                console.error('Start war zone error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Ukon캜it v치le캜nou z칩nu a vyhodnotit
        // Zru코it v치le캜nou z칩nu bez vyhodnocen칤 a odm캩n
        async function adminCancelWarZone() {
            if (!hasPermission('warzone')) return;
            
            if (!confirm('Opravdu zru코it v치le캜nou z칩nu BEZ odm캩n? Nikdo nedostane odm캩ny.')) return;
            
            try {
                // Sma v치le캜nou z칩nu
                await firebaseDB.ref('warZone').remove();
                
                // Vy캜isti cache
                window.activeWarZone = null;
                
                // Ozn치men칤 do chatu
                await firebaseDB.ref('chat/messages').push({
                    author: '丘덢잺 WAR ZONE',
                    text: '仇 V치le캜n치 z칩na byla ZRUENA! 콯치dn칠 odm캩ny nebyly rozd치ny.',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                notifyInfo('仇 V치le캜n치 z칩na zru코ena', 'Bez odm캩n');
                closeModal();
                renderFull();
                
            } catch(e) {
                console.error('Cancel war zone error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Automatick칠 vyhodnocen칤 expirovan칠 war zone (vol치 se kdy n캩kdo na캜te mapu a war zone u skon캜ila)
        async function autoEvaluateExpiredWarZone(warZone) {
            if (!warZone || !firebaseDB) return;
            
            try {
                // Pou쬴j transakci aby se to provedlo jen jednou
                const lockRef = firebaseDB.ref('warZone/evaluating');
                const lockResult = await lockRef.transaction(current => {
                    if (current === true) return; // U n캩kdo vyhodnocuje
                    return true;
                });
                
                if (!lockResult.committed) {
                    console.log('丘덢잺 War zone already being evaluated by another client');
                    return;
                }
                
                console.log('丘덢잺 Auto-evaluating expired war zone...');
                
                // Na캜ti aktu치ln칤 stav (mohl se zm캩nit)
                const snap = await firebaseDB.ref('warZone').once('value');
                const currentWarZone = snap.val();
                
                if (!currentWarZone || currentWarZone.endTime > Date.now()) {
                    // U nen칤 nebo je코t캩 neskon캜ila
                    await lockRef.remove();
                    return;
                }
                
                // Na캜ti body z warZone/factionPoints
                const pointsSnap = await firebaseDB.ref('warZone/factionPoints').once('value');
                const warPoints = pointsSnap.val() || {};
                
                // Najdi v칤t캩ze
                let winner = null;
                let maxPoints = 0;
                for (const [fid, pts] of Object.entries(warPoints)) {
                    if (pts > maxPoints) {
                        maxPoints = pts;
                        winner = fid;
                    }
                }
                
                if (!winner || maxPoints === 0) {
                    // Nikdo nebojoval
                    await firebaseDB.ref('warZone').remove();
                    
                    await firebaseDB.ref('chat/messages').push({
                        author: '丘덢잺 WAR ZONE',
                        text: `낋 V치le캜n치 z칩na automaticky skon캜ila bez v칤t캩ze! Nikdo nez칤skal body.`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        system: true
                    });
                    
                    console.log('丘덢잺 War zone ended without winner');
                    return;
                }
                
                const winnerFaction = PVP_FACTIONS[winner];
                
                // Rozdej odm캩ny 캜len콢m v칤t캩zn칠 frakce
                const membersSnap = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnap.val() || {};
                
                let winnersCount = 0;
                for (const [key, member] of Object.entries(members)) {
                    if (member.faction === winner) {
                        const safeName = member.name.replace(/[\\/.#$\[\]]/g, '_');
                        await firebaseDB.ref('notifications/' + safeName).push({
                            type: 'war_reward',
                            title: '丘덢잺 V칤t캩zstv칤 ve v치le캜n칠 z칩n캩!',
                            message: `Tv치 frakce ${winnerFaction.icon} ${winnerFaction.name} vyhr치la bitvu s ${maxPoints} body! Odm캩na: ${currentWarZone.reward} 游눯`,
                            reward: { money: currentWarZone.reward },
                            timestamp: Date.now(),
                            read: false
                        });
                        winnersCount++;
                    }
                }
                
                // Nastav 칰zem칤 jako vlastn캩n칠 v칤t캩znou frakc칤
                await firebaseDB.ref('territories/' + currentWarZone.locationId + '/owner').set(winner);
                
                // Ulo do historie
                await firebaseDB.ref('warZoneHistory').push({
                    locationId: currentWarZone.locationId,
                    winner: winner,
                    points: warPoints,
                    reward: currentWarZone.reward,
                    winnersCount: winnersCount,
                    endTime: Date.now(),
                    autoEvaluated: true
                });
                
                // Sma v치le캜nou z칩nu
                await firebaseDB.ref('warZone').remove();
                
                // Ozn치men칤 do chatu
                const allPoints = Object.entries(warPoints)
                    .filter(([_, pts]) => pts > 0)
                    .sort((a, b) => b[1] - a[1])
                    .map(([fid, pts]) => `${PVP_FACTIONS[fid]?.icon || '?'} ${pts}`)
                    .join(' | ');
                
                await firebaseDB.ref('chat/messages').push({
                    author: '丘덢잺 WAR ZONE',
                    text: `游끥 V츼LKA SKON캛ILA! V칤t캩z: ${winnerFaction.icon} ${winnerFaction.name} (${maxPoints} bod콢)! | V칳sledky: ${allPoints} | Odm캩na: ${currentWarZone.reward}游눯`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                console.log('丘덢잺 War zone auto-evaluated, winner:', winner);
                
            } catch (e) {
                console.error('Auto-evaluate war zone error:', e);
            }
        }
        
        async function adminEndWarZone() {
            if (!hasPermission('warzone')) return;
            
            if (!confirm('Opravdu ukon캜it v치le캜nou z칩nu a rozdat odm캩ny?')) return;
            
            try {
                const snap = await firebaseDB.ref('warZone').once('value');
                const warZone = snap.val();
                
                if (!warZone) {
                    notifyWarning('Chyba', '콯치dn치 aktivn칤 v치le캜n치 z칩na');
                    return;
                }
                
                // Na캜ti body z warZone/factionPoints
                const pointsSnap = await firebaseDB.ref('warZone/factionPoints').once('value');
                const warPoints = pointsSnap.val() || {};
                
                // Najdi v칤t캩ze
                let winner = null;
                let maxPoints = 0;
                for (const [fid, pts] of Object.entries(warPoints)) {
                    if (pts > maxPoints) {
                        maxPoints = pts;
                        winner = fid;
                    }
                }
                
                if (!winner || maxPoints === 0) {
                    // Nikdo nebojoval
                    await firebaseDB.ref('warZone').remove();
                    
                    await firebaseDB.ref('chat/messages').push({
                        author: '丘덢잺 V츼LE캛N츼 Z칍NA',
                        text: `仇 Bitva skon캜ila bez v칤t캩ze! Nikdo nez칤skal body. 콯치dn칠 odm캩ny nebyly rozd치ny.`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        system: true
                    });
                    
                    notifyInfo('V치le캜n치 z칩na skon캜ila', 'Bez v칤t캩ze');
                    closeModal();
                    return;
                }
                
                const winnerFaction = PVP_FACTIONS[winner];
                
                // Rozdej odm캩ny 캜len콢m v칤t캩zn칠 frakce
                const membersSnap = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnap.val() || {};
                
                let winnersCount = 0;
                for (const [key, member] of Object.entries(members)) {
                    if (member.faction === winner) {
                        // Po코li notifikaci s odm캩nou
                        const safeName = member.name.replace(/[\\/\\.#$\\[\\]]/g, '_');
                        await firebaseDB.ref('notifications/' + safeName).push({
                            type: 'war_reward',
                            title: '丘덢잺 V칤t캩zstv칤 ve v치le캜n칠 z칩n캩!',
                            message: `Tv치 frakce ${winnerFaction.icon} ${winnerFaction.name} vyhr치la bitvu s ${maxPoints} body! Odm캩na: ${warZone.reward} 游눯`,
                            reward: { money: warZone.reward },
                            timestamp: Date.now(),
                            read: false
                        });
                        winnersCount++;
                    }
                }
                
                // Nastav 칰zem칤 jako vlastn캩n칠 v칤t캩znou frakc칤
                await firebaseDB.ref('territories/' + warZone.locationId + '/owner').set(winner);
                
                // Ulo do historie v칤t캩zstv칤
                await firebaseDB.ref('warZoneHistory').push({
                    locationId: warZone.locationId,
                    winner: winner,
                    points: warPoints,
                    reward: warZone.reward,
                    winnersCount: winnersCount,
                    endTime: Date.now()
                });
                
                // Sma v치le캜nou z칩nu
                await firebaseDB.ref('warZone').remove();
                
                // Vy캜isti cache
                window.activeWarZone = null;
                
                // Ozn치men칤 do chatu
                const allPoints = Object.entries(warPoints)
                    .filter(([_, pts]) => pts > 0)
                    .sort((a, b) => b[1] - a[1])
                    .map(([fid, pts]) => `${PVP_FACTIONS[fid]?.icon || '?'} ${pts}`)
                    .join(' | ');
                
                // Vytvo콏 seznam v칳herc콢 (max 10 jmen)
                const winnerNames = [];
                for (const [key, member] of Object.entries(members)) {
                    if (member.faction === winner && winnerNames.length < 10) {
                        winnerNames.push(member.name);
                    }
                }
                const winnersListText = winnerNames.length > 0 
                    ? `V칳herci: ${winnerNames.join(', ')}${winnersCount > 10 ? ` a dal코칤ch ${winnersCount - 10}...` : ''}`
                    : '';
                
                // Ozn치men칤 do chatu - form치t jako tombola
                await firebaseDB.ref('chat/messages').push({
                    author: '丘덢잺 V츼LE캛N츼 Z칍NA',
                    text: `游끥 BITVA SKON캛ILA! V칤t캩z: ${winnerFaction.icon} ${winnerFaction.name} (${maxPoints} bod콢)! Sk칩re: ${allPoints}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                // Druh치 zpr치va s v칳herci a odm캩nami
                await firebaseDB.ref('chat/messages').push({
                    author: '丘덢잺 V츼LE캛N츼 Z칍NA',
                    text: `游눯 ${winnersCount} hr치캜콢 dost치v치 odm캩nu ${warZone.reward} 游눯! ${winnersListText}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                // Zobraz detailn칤 p콏ehled adminovi
                const loc = WORLD_LOCATIONS.find(l => l.id === warZone.locationId);
                showModal('游끥 V치le캜n치 z칩na vyhodnocena!', `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">${winnerFaction.icon}</div>
                        <h3 style="color: ${winnerFaction.color}; margin: 0;">${winnerFaction.name} VYHR츼V츼!</h3>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #888; margin: 0 0 0.5rem 0;">游늸 Lokace: <strong style="color: #ddd;">${loc?.icon || ''} ${loc?.name || warZone.locationId}</strong></p>
                        <p style="color: #888; margin: 0 0 0.5rem 0;">游끥 V칤t캩zn칠 body: <strong style="color: #ffd700;">${maxPoints}</strong></p>
                        <p style="color: #888; margin: 0;">游눯 Odm캩na: <strong style="color: #4caf50;">${warZone.reward} 游눯</strong></p>
                    </div>
                    
                    <div style="background: #0a1a0a; padding: 1rem; border-radius: 8px; border: 1px solid #4caf50; margin-bottom: 1rem;">
                        <p style="color: #4caf50; margin: 0 0 0.5rem 0; font-weight: bold;">九 Odm캩ny odesl치ny!</p>
                        <p style="color: #8bc34a; margin: 0;">${winnersCount} hr치캜콢 z frakce ${winnerFaction.icon} ${winnerFaction.name} obdr쮂 ${warZone.reward} 游눯</p>
                        <p style="color: #666; margin: 0.5rem 0 0 0; font-size: 0.85rem;">Hr치캜i si odm캩nu vyzvednou automaticky p콏i dal코칤m na캜ten칤 hry.</p>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px;">
                        <p style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.85rem;">游늵 Kone캜n칠 sk칩re:</p>
                        <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                            ${Object.entries(warPoints)
                                .sort((a, b) => b[1] - a[1])
                                .map(([fid, pts]) => {
                                    const f = PVP_FACTIONS[fid];
                                    const isWinner = fid === winner;
                                    return `<span style="color: ${f?.color || '#888'}; ${isWinner ? 'font-weight: bold; font-size: 1.2rem;' : ''}">${f?.icon || '?'} ${pts}</span>`;
                                }).join(' | ')}
                        </div>
                    </div>
                    
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">九 OK</button>
                `);
                
            } catch(e) {
                console.error('End war zone error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Zkontrolovat jestli je hr치캜 ve v치le캜n칠 z칩n캩 a m콢쬰 bojovat
        async function checkWarZoneFight() {
            if (!multiplayerEnabled || !firebaseDB) return null;
            
            try {
                const snap = await firebaseDB.ref('warZone').once('value');
                const warZone = snap.val();
                
                if (!warZone || warZone.endTime < Date.now()) return null;
                if (state.world?.currentLocation !== warZone.locationId) return null;
                
                const playerFaction = getPlayerFaction();
                if (!playerFaction) return null;
                
                // Zkontroluj cooldown
                const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                const cooldownSnap = await firebaseDB.ref('warZone/cooldowns/' + myName).once('value');
                const lastFight = cooldownSnap.val() || 0;
                const cooldownMs = 10 * 60 * 1000; // 10 minut
                
                if (Date.now() - lastFight < cooldownMs) {
                    const remaining = Math.ceil((cooldownMs - (Date.now() - lastFight)) / 60000);
                    return { canFight: false, cooldown: remaining, warZone: warZone };
                }
                
                return { canFight: true, warZone: warZone, faction: playerFaction };
                
            } catch(e) {
                console.error('Check war zone error:', e);
                return null;
            }
        }
        
        // Zobrazit UI pro v치le캜nou z칩nu na lokaci
        async function showWarZoneUI() {
            const check = await checkWarZoneFight();
            
            if (!check) return;
            
            const warZone = check.warZone;
            const enemy = ENEMIES.find(e => e.id === warZone.enemyId);
            const loc = WORLD_LOCATIONS.find(l => l.id === warZone.locationId);
            const remaining = Math.max(0, warZone.endTime - Date.now());
            const mins = Math.floor(remaining / 60000);
            
            // Aktu치ln칤 sk칩re
            const points = warZone.factionPoints || {};
            const sorted = Object.entries(PVP_FACTIONS)
                .map(([fid, f]) => ({ fid, f, pts: points[fid] || 0 }))
                .sort((a, b) => b.pts - a.pts);
            
            const scoreHtml = sorted.map(({ fid, f, pts }) => 
                `<span style="color: ${f.color}; margin: 0 0.3rem;">${f.icon} ${pts}</span>`
            ).join('|');
            
            if (!check.canFight) {
                showModal('丘덢잺 V치le캜n치 z칩na', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">낍</div>
                        <h3 style="color: #ff9800;">Mus칤코 po캜kat!</h3>
                        <p style="color: #888;">Dal코칤 boj za <strong style="color: #ffd700; font-size: 1.5rem;">${check.cooldown} min</strong></p>
                        
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="color: #888; margin: 0 0 0.3rem 0; font-size: 0.85rem;">Aktu치ln칤 sk칩re:</p>
                            <div style="font-size: 1.1rem;">${scoreHtml}</div>
                        </div>
                        
                        <p style="color: #666; font-size: 0.85rem;">Zb칳v치 ${mins} minut do konce ud치losti</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zav콏칤t</button>
                `);
                return;
            }
            
            const factionData = PVP_FACTIONS[check.faction];
            
            showModal('丘덢잺 V치le캜n치 z칩na', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${enemy?.icon || '游놏'}</div>
                    <h3 style="color: #f44336;">${enemy?.name || 'Nep콏칤tel'} (${warZone.enemyCount}x)</h3>
                    <p style="color: #888;">HP: ${enemy?.hp || '?'} | DMG: ${enemy?.damage || '?'}</p>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #888; margin: 0 0 0.3rem 0; font-size: 0.85rem;">Aktu치ln칤 sk칩re:</p>
                        <div style="font-size: 1.1rem;">${scoreHtml}</div>
                    </div>
                    
                    <p style="color: ${factionData.color};">Bojuje코 za: ${factionData.icon} ${factionData.name}</p>
                    <p style="color: #8bc34a; font-size: 0.9rem;">游띠勇 Nem콢쬰코 zem콏칤t | 救 +${warZone.pointsPerWin} bod콢 za v칳hru</p>
                    <p style="color: #666; font-size: 0.85rem;">Zb칳v치 ${mins} minut | Odm캩na: ${warZone.reward} 游눯</p>
                </div>
                
                <button class="btn" onclick="startWarZoneFight()" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem; font-size: 1.2rem;">
                    丘덢잺 BOJOVAT!
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Pozd캩ji</button>
            `);
        }
        
        // Spustit boj ve v치le캜n칠 z칩n캩
        async function startWarZoneFight() {
            const check = await checkWarZoneFight();
            
            if (!check || !check.canFight) {
                notifyWarning('Nelze bojovat', 'Mus칤코 po캜kat na cooldown');
                closeModal();
                return;
            }
            
            const warZone = check.warZone;
            const enemyTemplate = ENEMIES.find(e => e.id === warZone.enemyId);
            
            if (!enemyTemplate) {
                notifyWarning('Chyba', 'Nep콏칤tel nenalezen');
                closeModal();
                return;
            }
            
            // Vytvo콏 pole nep콏치tel pro bojov칳 syst칠m
            const enemyGroup = [];
            for (let i = 0; i < warZone.enemyCount; i++) {
                enemyGroup.push({
                    ...enemyTemplate,
                    hp: enemyTemplate.hp,
                    maxHp: enemyTemplate.hp
                });
            }
            
            // Ulo aktu치ln칤 HP p콏ed bojem
            const savedHp = state.char.hp;
            
            // Dej pln칠 HP pro war zone boj
            state.char.hp = state.char.maxHp;
            
            // Ozna캜 jako war zone boj (speci치ln칤 re쬴m - 쮂멳n치 smrt, 쮂멳n칠 XP)
            state.warZoneFight = {
                active: true,
                faction: check.faction,
                pointsPerWin: warZone.pointsPerWin,
                locationId: warZone.locationId,
                savedHp: savedHp  // Ulo쬰n칠 HP pro obnoven칤 po boji
            };
            
            closeModal();
            
            // Spus콘 norm치ln칤 boj se v코emi bonusy hr치캜e
            // skipPreCombat = false - uka p콏칤pravu spole캜n칤k콢 pokud n캩jak칠 m치
            startCombatWithGroup(enemyGroup, 'war_zone', false);
        }
        
        // Po dokon캜en칤 boje ve v치le캜n칠 z칩n캩
        async function finishWarZoneFight(won) {
            if (!state.warZoneFight?.active) return;
            
            const warFight = state.warZoneFight;
            state.warZoneFight = null;
            
            if (!won) {
                notifyInfo('Boj prohr치n', 'Zkus to znovu za 10 minut');
                return;
            }
            
            try {
                const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                
                // Nastav cooldown
                await firebaseDB.ref('warZone/cooldowns/' + myName).set(Date.now());
                
                // P콏idej body frakci (do war zone)
                await firebaseDB.ref('warZone/factionPoints/' + warFight.faction).transaction(current => (current || 0) + warFight.pointsPerWin);
                
                // P콏idej body i hr치캜ovi do 쬰b콏칤캜ku - spolehliv캩j코칤 metoda
                const contribRef = firebaseDB.ref('factionMembers/' + myName + '/contribution');
                const snap = await contribRef.once('value');
                const currentContrib = snap.val() || 0;
                await contribRef.set(currentContrib + warFight.pointsPerWin);
                console.log('游낎 War zone contribution updated: ' + currentContrib + ' -> ' + (currentContrib + warFight.pointsPerWin));
                
                state.pvpFactionContribution = (state.pvpFactionContribution || 0) + warFight.pointsPerWin;
                
                const factionData = PVP_FACTIONS[warFight.faction];
                notifySuccess(`+${warFight.pointsPerWin} bod콢!`, `Pro ${factionData.icon} ${factionData.name}`);
                
                // Refresh pokud jsme st치le na lokaci
                if (state.world?.currentLocation === warFight.locationId) {
                    setTimeout(() => showWarZoneUI(), 1000);
                }
                
            } catch(e) {
                console.error('Finish war zone fight error:', e);
            }
        }
        
        // Zkontrolovat a zobrazit war zone UI p콏i p콏칤chodu na lokaci
        async function checkAndShowWarZone() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const snap = await firebaseDB.ref('warZone').once('value');
                const warZone = snap.val();
                
                if (!warZone || warZone.endTime < Date.now()) return;
                if (state.world?.currentLocation !== warZone.locationId) return;
                
                const playerFaction = getPlayerFaction();
                if (!playerFaction) return;
                
                // Zobraz war zone UI s mal칳m zpo쬯캩n칤m
                setTimeout(() => showWarZoneUI(), 500);
                
            } catch(e) {
                console.error('Check war zone error:', e);
            }
        }
        
                // === DANGER ZONE ===
        function adminDangerZone() {
            if (!isAdmin()) return;
            
            showModal('驕뮖잺 DANGER ZONE', `
                <div style="background: #3a1a1a; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #f44336;">
                    <p style="color: #f44336; font-weight: bold; margin: 0 0 0.5rem 0;">丘멆잺 VAROV츼N칈</p>
                    <p style="color: #888; font-size: 0.85rem; margin: 0;">Tyto akce jsou NEVRATN칄 a sma쬺u data v코ech hr치캜콢!</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="adminResetDatabase()" style="background: linear-gradient(135deg, #b71c1c 0%, #4a0000 100%); padding: 1rem;">
                        驕뮖잺 RESET CEL칄 DATAB츼ZE
                    </button>
                    <button class="btn" onclick="adminResetFactions()" style="background: linear-gradient(135deg, #d84315 0%, #6a1b00 100%); padding: 1rem;">
                        游낎 RESET FRAKC칈
                    </button>
                    <button class="btn" onclick="adminClearOnlinePlayers()" style="background: #c62828; padding: 0.8rem;">
                        游논 Vy캜istit online hr치캜e
                    </button>
                    <button class="btn" onclick="adminClearNotifications()" style="background: #c62828; padding: 0.8rem;">
                        游댒 Smazat v코echny notifikace
                    </button>
                </div>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;"> Zp캩t</button>
            `);
        }
        
        // Reset frakc칤 - sma쬰 v코echna 칰zem칤, 캜leny a historii
        async function adminResetFactions() {
            if (!isAdmin()) return;
            if (!confirm('丘멆잺 OPRAVDU CHCE RESETOVAT VECHNY FRAKCE?')) return;
            if (!confirm('Toto sma쬰:\n V코echna 칰zem칤\n V코echny 캜leny frakc칤\n Historii sez칩n\n V치le캜nou z칩nu\n\nHr치캜i si budou muset znovu vybrat frakci!')) return;
            
            try {
                const resetTime = Date.now();
                
                // Sma 칰zem칤
                await firebaseDB.ref('territories').remove();
                
                // Sma 캜leny frakc칤
                await firebaseDB.ref('factionMembers').remove();
                
                // Sma historii sez칩n
                await firebaseDB.ref('factionSeasonHistory').remove();
                
                // Nastav novou sez칩nu s 캜asem resetu (d콢le쬴t칠 pro detekci u ostatn칤ch hr치캜콢!)
                await firebaseDB.ref('factionSeason').set({
                    startTime: resetTime,
                    seasonNumber: 1,
                    lastReset: resetTime
                });
                
                // Sma v치le캜nou z칩nu
                await firebaseDB.ref('warZone').remove();
                
                // Vy캜isti cache
                window.territoryCache = null;
                window.activeWarZone = null;
                
                // Reset lok치ln칤ho stavu frakce - hr치캜 si mus칤 vybrat znovu
                state.pvpFaction = null;
                state.pvpFactionJoinedAt = null;
                state.pvpFactionContribution = 0;
                saveGame();
                
                // Ozn치men칤 do chatu
                await firebaseDB.ref('chat/messages').push({
                    author: '丘덢잺 SYST칄M',
                    text: '游낎 FRAKCE BYLY RESETOV츼NY! V코echna 칰zem칤 a 캜lenstv칤 byla smaz치na. Vyberte si novou frakci!',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                notifySuccess('游낎 FRAKCE RESETOV츼NY', 'V코echna data frakc칤 byla smaz치na');
                closeModal();
                renderFull();
                
            } catch (e) {
                console.error('Reset factions error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminResetDatabase() {
            if (!isAdmin()) return;
            if (!confirm('丘멆잺 OPRAVDU CHCE SMAZAT CELOU DATAB츼ZI?')) return;
            if (!confirm('TATO AKCE JE NEVRATN츼! V코echna data budou ztracena!')) return;
            if (prompt('Napi코 "SMAZAT" pro potvrzen칤:') !== 'SMAZAT') {
                notifyWarning('Zru코eno', 'Reset nebyl proveden');
                return;
            }
            
            try {
                await firebaseDB.ref('leaderboard').remove();
                await firebaseDB.ref('chat').remove();
                await firebaseDB.ref('marketplace').remove();
                await firebaseDB.ref('pvp').remove();
                await firebaseDB.ref('online').remove();
                await firebaseDB.ref('notifications').remove();
                await firebaseDB.ref('ratings').remove();
                await firebaseDB.ref('tradeHistory').remove();
                await firebaseDB.ref('gifts').remove();
                
                notifySuccess('驕뮖잺 DATAB츼ZE RESETOV츼NA', 'V코echna data byla smaz치na');
                showAdminPanel();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearOnlinePlayers() {
            if (!isAdmin()) return;
            if (!confirm('Smazat v코echny online hr치캜e?')) return;
            
            try {
                await firebaseDB.ref('online').remove();
                notifySuccess('Hotovo', 'Online seznam vy캜i코t캩n');
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearNotifications() {
            if (!isAdmin()) return;
            if (!confirm('Smazat v코echny notifikace v코ech hr치캜콢?')) return;
            
            try {
                await firebaseDB.ref('notifications').remove();
                notifySuccess('Hotovo', 'Notifikace smaz치ny');
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === GLOB츼LN칈 EXPORTY PRO ONCLICK ===
        window.adminTreasure = adminTreasure;
        window.createTreasure = createTreasure;
        window.adminCancelTreasure = adminCancelTreasure;
        window.claimTreasure = claimTreasure;
        window.showLootFilterSettings = showLootFilterSettings;
        window.updateLootFilter = updateLootFilter;
        window.resetLootFilter = resetLootFilter;
        window.recycleItem = recycleItem;
        window.confirmRecycle = confirmRecycle;
        // Dungeon funkce
        window.exploreDungeonFloor = exploreDungeonFloor;
        window.descendDungeon = descendDungeon;
        window.ascendDungeon = ascendDungeon;
        window.exitDungeon = exitDungeon;
        window.showDungeonUI = showDungeonUI;
        window.enterDungeon = enterDungeon;
        window.handleDungeonVictory = handleDungeonVictory;
        window.handleAbyssVictory = handleAbyssVictory;
    </script>
</body>
</html>
