<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="author" content="Zaoo">
    <meta name="description" content="Posledn√≠ p≈ôe≈æiv≈°√≠ - Post-apokalyptick√° survival RPG hra. Prozkoumej radioaktivn√≠ pustinu, bojuj s mutanty a p≈ôe≈æij!">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUG9zbGVkbsOtIHDFmWXFvml2xaHDrSIsInNob3J0X25hbWUiOiJQxZllxb5pdsWhw60iLCJkZXNjcmlwdGlvbiI6IlBvc3QtYXBva2FseXB0aWNrw6Egc3Vydml2YWwgUlBHIGhyYSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMWExYTFhIiwidGhlbWVfY29sb3IiOiIjMWExYTFhIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0N0ZXh0IHk9Jy45ZW0nIGZvbnQtc2l6ZT0nOTAnJTNFJUUyJTk4JUEyJUVGJUI4JThGJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <title>‚ò¢Ô∏è Posledn√≠ p≈ôe≈æiv≈°√≠ v58 | by Zaoo</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --rust: #8B4513;
            --rust-light: #CD853F;
            --toxic-green: #39FF14;
            --toxic-dark: #228B22;
            --blood-red: #8B0000;
            --warning-yellow: #FFD700;
            --metal-dark: #1a1a1a;
            --metal-mid: #2d2d2d;
            --metal-light: #3d3d3d;
            --terminal-green: #00ff00;
            --radiation-glow: #7FFF00;
            --danger-orange: #FF4500;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1512 50%, #0d0d0d 100%);
            background-attachment: fixed;
            color: #c9c9c9;
            overflow-x: hidden;
            max-width: 100vw;
            min-height: 100vh;
        }
        
        /* Radiaƒçn√≠ z√°≈ôe na okraj√≠ch */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at top left, rgba(76, 175, 80, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(255, 152, 0, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at bottom left, rgba(139, 195, 74, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at top right, rgba(255, 87, 34, 0.1) 0%, transparent 45%);
            pointer-events: none;
            z-index: 1;
            animation: radiationGlow 6s ease-in-out infinite;
        }
        
        @keyframes radiationGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Jemn√° zelen√° mlha */
        body::after {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 20% 50%, rgba(0, 255, 65, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 75% 25%, rgba(0, 200, 50, 0.03) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 85%, rgba(0, 230, 60, 0.035) 0%, transparent 48%);
            pointer-events: none;
            z-index: 2;
            animation: fogDrift 15s ease-in-out infinite;
        }
        
        /* Noƒçn√≠ re≈æim overlay */
        .night-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 20, 50, 0.15);
            pointer-events: none;
            z-index: 3;
            transition: opacity 2s ease;
        }
        
        /* Blik√°n√≠ p≈ôi n√≠zk√© HP */
        @keyframes lowHpPulse {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.3; }
        }
        
        .low-hp-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(255, 0, 0, 0.4) 100%);
            pointer-events: none;
            z-index: 9990;
            animation: lowHpPulse 1.5s ease-in-out infinite;
        }
        
        /* Screen shake */
        @keyframes damageShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5px, -3px); }
            20% { transform: translate(5px, 3px); }
            30% { transform: translate(-4px, 2px); }
            40% { transform: translate(4px, -2px); }
            50% { transform: translate(-3px, 3px); }
            60% { transform: translate(3px, -1px); }
            70% { transform: translate(-2px, 1px); }
            80% { transform: translate(2px, -1px); }
            90% { transform: translate(-1px, 1px); }
        }
        
        .damage-shake {
            animation: damageShake 0.4s ease-out;
        }
        
        /* Radiaƒçn√≠ zkreslen√≠ */
        @keyframes radiationWave {
            0%, 100% { filter: none; }
            25% { filter: hue-rotate(10deg); }
            50% { filter: hue-rotate(-10deg) saturate(1.2); }
            75% { filter: hue-rotate(5deg); }
        }
        
        .radiation-zone {
            animation: radiationWave 3s ease-in-out infinite;
        }
        
        /* Blesky p≈ôi bou≈ôce */
        @keyframes stormFlash {
            0%, 90%, 100% { opacity: 0; }
            92%, 96% { opacity: 0.7; }
            94% { opacity: 0; }
        }
        
        .storm-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            pointer-events: none;
            z-index: 9995;
            opacity: 0;
        }
        
        /* Level up z√°≈ôe */
        @keyframes levelUpGlow {
            0% { opacity: 0; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        .levelup-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.6) 0%, transparent 70%);
            pointer-events: none;
            z-index: 9994;
            animation: levelUpGlow 0.8s ease-out forwards;
        }
        
        /* Mini glitch */
        @keyframes miniGlitch {
            0%, 100% { transform: translate(0); filter: none; }
            20% { transform: translate(-4px, 2px); filter: hue-rotate(90deg) brightness(1.3); }
            40% { transform: translate(4px, -2px); filter: hue-rotate(-90deg) saturate(2); }
            60% { transform: translate(-3px, -2px); filter: brightness(0.7) contrast(1.5); }
            80% { transform: translate(3px, 1px); filter: hue-rotate(180deg) brightness(1.2); }
        }
        
        .mini-glitch {
            animation: miniGlitch 0.15s ease-out;
        }
        
        /* Efekt smrti */
        @keyframes deathEffect {
            0% { filter: none; opacity: 1; }
            30% { filter: grayscale(0.5) brightness(0.8); }
            60% { filter: grayscale(0.8) brightness(0.5) blur(1px); }
            100% { filter: grayscale(1) brightness(0) blur(3px); opacity: 0; }
        }
        
        .death-screen {
            animation: deathEffect 1.5s ease-out forwards;
        }
        
        /* Modal scan efekt */
        @keyframes modalScan {
            0% { height: 0; opacity: 1; }
            100% { height: 100%; opacity: 0; }
        }
        
        .modal-scan {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 65, 0.1) 0px,
                rgba(0, 255, 65, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            animation: modalScan 0.2s ease-out forwards;
        }
        
        @keyframes fogDrift {
            0%, 100% { transform: translate(0, 0); }
            33% { transform: translate(-5%, 3%); }
            66% { transform: translate(3%, -3%); }
        }
        
        /* Fallout terminal efekt p≈ôi p≈ôepnut√≠ */
        @keyframes terminalSwitch {
            0% { filter: brightness(1); opacity: 1; }
            10% { filter: brightness(0.2); opacity: 0.8; }
            25% { filter: brightness(1.4) contrast(1.2); opacity: 1; }
            40% { filter: brightness(0.9); }
            60% { filter: brightness(1.1); }
            100% { filter: brightness(1); opacity: 1; }
        }
        
        .terminal-switch {
            animation: terminalSwitch 0.3s ease-out;
        }
        
        /* Scanline ≈°um efekt od spodu i shora - zelen√Ω */
        @keyframes scanUp {
            0% { bottom: 0; height: 0; }
            50% { height: 100%; bottom: 0; }
            51% { height: 100%; bottom: 0; opacity: 1; }
            100% { height: 100%; bottom: 0; opacity: 0; }
        }
        
        @keyframes scanDown {
            0% { top: 0; height: 0; }
            50% { height: 100%; top: 0; }
            51% { height: 100%; top: 0; opacity: 1; }
            100% { height: 100%; top: 0; opacity: 0; }
        }
        
        .scan-overlay {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 65, 0.12) 0px,
                rgba(0, 255, 65, 0.12) 1px,
                rgba(0, 50, 20, 0.25) 1px,
                rgba(0, 50, 20, 0.25) 3px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanUp 0.25s ease-out forwards;
        }
        
        .scan-overlay-top {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            height: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 65, 0.12) 0px,
                rgba(0, 255, 65, 0.12) 1px,
                rgba(0, 50, 20, 0.25) 1px,
                rgba(0, 50, 20, 0.25) 3px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanDown 0.25s ease-out forwards;
        }
        
        .container { 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
        }
        
        /* === HEADER - Terminal Style === */
        header { 
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            padding: 0.5rem;
            border-bottom: 3px solid var(--rust);
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.3), inset 0 -2px 10px rgba(0,0,0,0.5);
            flex-shrink: 0;
            position: relative;
        }
        
        .stats { 
            display: flex; 
            gap: 0.8rem; 
            flex-wrap: wrap; 
            font-size: 0.75rem; 
            align-items: center;
            padding-top: 0.8rem;
        }
        
        .stat { 
            background: rgba(0,0,0,0.4);
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            border: 1px solid var(--metal-light);
            position: relative;
            transition: all 0.2s;
        }
        
        .stat.clickable {
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .stat.clickable:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--toxic-green);
            transform: scale(1.02);
        }
        
        .stat strong { 
            color: var(--toxic-green);
            text-shadow: 0 0 5px var(--toxic-green);
        }
        
        #statusBars { 
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            border: 1px solid var(--metal-light);
        }
        
        /* === MAIN CONTENT === */
        main { 
            flex: 1; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
            padding: 0.5rem;
            padding-bottom: var(--main-bottom-padding, 100px);
        }
        
        /* === NAVIGATION - Spodn√≠ li≈°ta === */
        nav { 
            position: fixed !important;
            bottom: 0 !important;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            background: linear-gradient(0deg, #000 0%, #1a1a1a 100%);
            padding: 0.4rem 0.2rem;
            padding-bottom: var(--nav-bottom-padding, 35px);
            border-top: 2px solid var(--rust);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.9);
            z-index: 100;
            gap: 0.15rem;
        }
        
        .nav-btn { 
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid var(--metal-light);
            color: #888;
            padding: 0.4rem 0.1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.45rem;
            font-family: 'Share Tech Mono', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.05rem;
            text-transform: uppercase;
            letter-spacing: 0px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.3s ease;
        }
        
        .nav-btn:hover::before {
            left: 100%;
        }
        
        .nav-btn .icon { font-size: 0.9rem; filter: grayscale(0.5); }
        
        .nav-btn.active { 
            background: linear-gradient(180deg, var(--rust) 0%, #5a3510 100%);
            border-color: var(--rust-light);
            color: #fff;
            box-shadow: 0 0 10px rgba(139, 69, 19, 0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .nav-btn.active .icon { filter: none; }
        
        /* === TABS - Weathered Panel === */
        .tab { 
            display: none; 
            background: linear-gradient(135deg, #1a1a1a 0%, #151515 50%, #1a1a1a 100%);
            padding: 1rem; 
            border-radius: 8px;
            border: 2px solid var(--metal-light);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 4px 20px rgba(0,0,0,0.3);
            min-height: calc(100vh - 220px);
            position: relative;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--rust), transparent);
        }
        
        .tab.active { display: block; }
        
        /* === BUTTONS === */
        .btn { 
            background: linear-gradient(180deg, var(--rust-light) 0%, var(--rust) 50%, #5a3510 100%);
            color: #fff;
            border: 2px solid var(--rust-light);
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover { 
            background: linear-gradient(180deg, #e09050 0%, var(--rust-light) 50%, var(--rust) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(139, 69, 19, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* === GRID & CARDS === */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 0.8rem; 
            margin: 1rem 0; 
        }
        
        .card { 
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid var(--metal-light);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--metal-light), transparent);
        }
        
        .card:hover { 
            border-color: var(--rust);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4), 0 0 20px rgba(139, 69, 19, 0.2);
        }
        
        .card.selected { 
            border-color: var(--toxic-green);
            background: linear-gradient(135deg, #1a2a1a 0%, #152515 100%);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
        }
        
        /* === INPUTS === */
        input, textarea { 
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 2px solid var(--metal-light);
            border-radius: 4px;
            color: var(--toxic-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0.5rem 0;
            transition: border-color 0.2s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--toxic-green);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.2);
        }
        
        /* === ATTRIBUTES === */
        .attr-row { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            border-left: 3px solid var(--rust);
        }
        
        .attr-btn { 
            background: linear-gradient(180deg, var(--metal-light) 0%, var(--metal-dark) 100%);
            border: 2px solid var(--rust);
            color: var(--toxic-green);
            width: 35px;
            height: 35px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .attr-btn:hover {
            background: linear-gradient(180deg, var(--rust) 0%, #5a3510 100%);
            color: #fff;
        }
        
        .attr-btn:disabled { 
            background: #1a1a1a;
            border-color: #333;
            color: #444;
            cursor: not-allowed;
        }
        
        /* === MODAL === */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.9); 
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal.show { display: flex; align-items: center; justify-content: center; }
        
        /* Scroll to top button */
        #scrollToTop {
            position: fixed;
            bottom: 100px;
            right: 15px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--rust) 0%, #8B4513 100%);
            border: 2px solid var(--metal-light);
            border-radius: 50%;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 99;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s, opacity 0.2s;
        }
        #scrollToTop:hover { transform: scale(1.1); }
        #scrollToTop.visible { display: flex; }
        
        .modal-content { 
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            padding: 1.5rem;
            border-radius: 8px;
            border: 3px solid var(--rust);
            box-shadow: 0 0 50px rgba(139, 69, 19, 0.3), inset 0 2px 20px rgba(0,0,0,0.5);
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        
        .modal-content::before {
            content: '';
            display: none;
        }
        
        /* === HEADINGS === */
        h2 { 
            color: var(--rust-light);
            font-family: 'Russo One', sans-serif;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            border-bottom: 2px solid var(--rust);
            padding-bottom: 0.5rem;
        }
        
        h3 { 
            color: var(--warning-yellow);
            font-family: 'Share Tech Mono', monospace;
            margin: 1rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* === STATUS BARS === */
        .status-bar { 
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 1px solid var(--metal-light);
            background: linear-gradient(180deg, rgba(30,30,30,0.9) 0%, rgba(15,15,15,0.9) 100%);
            min-width: 100px;
            transition: all 0.2s;
        }
        
        .status-bar:hover {
            transform: scale(1.05);
            border-color: #666;
        }
        
        .status-bar .icon {
            font-size: 1.1rem;
        }
        
        .status-bar .value {
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 32px;
        }
        
        .status-bar .bar-container { 
            flex: 1;
            height: 8px;
            background: #0a0a0a;
            border-radius: 4px;
            position: relative;
            border: 1px solid #333;
            overflow: hidden;
            min-width: 50px;
        }
        
        .status-bar .bar-container::after { 
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .hunger-bar::after { background: linear-gradient(90deg, #cc4400, #ff6600, #ff9900); width: var(--val); box-shadow: 0 0 8px #ff6600; }
        .thirst-bar::after { background: linear-gradient(90deg, #004488, #0066cc, #00aaff); width: var(--val); box-shadow: 0 0 8px #00aaff; }
        .energy-bar::after { background: linear-gradient(90deg, #448800, #66cc00, #99ff00); width: var(--val); box-shadow: 0 0 8px #99ff00; }
        .mood-bar::after { background: linear-gradient(90deg, #660088, #9900cc, #cc66ff); width: var(--val); box-shadow: 0 0 8px #cc66ff; }
        .radiation-bar::after { background: linear-gradient(90deg, #660000, #990000, #ff0000); width: var(--val); box-shadow: 0 0 8px #ff0000; }
        
        /* === CANVAS === */
        canvas { 
            display: block; 
            cursor: crosshair;
            border: 2px solid var(--rust);
            border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        canvas:active { cursor: grabbing; }
        
        /* === RESPONSIVE LAYOUTS === */
        .equipment-layout { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .char-info-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .shop-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; max-height: 500px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .combat-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin: 1rem 0; }
        
        /* Glob√°ln√≠ pravidlo pro plynul√© scrollov√°n√≠ na mobilu */
        [style*="overflow-y: auto"], [style*="overflow-y:auto"], 
        [style*="overflow: auto"], [style*="overflow:auto"] {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile-first responsive grids */
        .responsive-2col { display: grid; grid-template-columns: 1fr; gap: 0.8rem; }
        .responsive-3col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; }
        .responsive-4col { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; }
        .responsive-6col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; }
        
        /* Scrollable container helper - pro plynul√© scrollov√°n√≠ na mobilu */
        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* Hide on mobile */
        .hide-mobile { display: none; }
        
        /* Smaller text on mobile */
        .mobile-compact { font-size: 0.7rem !important; }
        .mobile-compact h2 { font-size: 1rem !important; }
        .mobile-compact h3 { font-size: 0.85rem !important; }
        
        @media (min-width: 769px) {
            header { padding: 0.8rem 1rem; }
            header::before { font-size: 0.7rem; }
            .stats { font-size: 0.85rem; gap: 1rem; padding-top: 1rem; }
            .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
            main { padding: 0; margin-bottom: 1rem; overflow-y: visible; padding-bottom: 0; }
            nav { 
                position: static !important;
                bottom: auto !important;
                display: flex;
                gap: 0.5rem;
                padding: 0.5rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                border-top: none;
                border: 2px solid var(--rust);
            }
            .nav-btn { 
                padding: 1rem 1.5rem;
                flex: 1;
                font-size: 0.85rem;
                flex-direction: row;
                gap: 0.5rem;
            }
            .nav-btn .icon { font-size: 1.1rem; }
            .tab { padding: 1.5rem; min-height: auto; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .equipment-layout { grid-template-columns: 300px 1fr; }
            .char-info-grid { grid-template-columns: 1fr 1fr 1fr; }
            .shop-grid { grid-template-columns: 1fr 1fr; }
            .combat-grid { grid-template-columns: 1fr 1fr; }
            .modal-content { padding: 2rem; }
            
            /* Desktop responsive grids */
            .responsive-2col { grid-template-columns: 1fr 1fr; }
            .responsive-6col { grid-template-columns: repeat(6, 1fr); gap: 0.4rem; }
            .hide-mobile { display: block; }
            .mobile-compact { font-size: inherit !important; }
            .mobile-compact h2 { font-size: inherit !important; }
            .mobile-compact h3 { font-size: inherit !important; }
        }
        
        /* === ANIMATIONS === */
        @keyframes flash-red {
            0%, 100% { background: transparent; }
            50% { background: rgba(139, 0, 0, 0.3); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px var(--toxic-green); }
            50% { box-shadow: 0 0 20px var(--toxic-green); }
        }
        
        @keyframes war-zone-pulse {
            0%, 100% { box-shadow: 0 0 60px #ff0000, 0 0 120px #ff0000dd, 0 0 180px #ff0000aa, 0 0 240px #ff000066, inset 0 0 60px #ff000088; transform: scale(1); filter: brightness(1.5); background: radial-gradient(circle, #ff000055 0%, #ff000022 50%, transparent 70%); }
            50% { box-shadow: 0 0 80px #ff3333, 0 0 160px #ff0000, 0 0 240px #ff0000cc, 0 0 320px #ff000088, inset 0 0 80px #ff0000cc; transform: scale(1.05); filter: brightness(2); background: radial-gradient(circle, #ff000088 0%, #ff000044 50%, transparent 70%); }
        }
        
        @keyframes treasure-pulse {
            0%, 100% { box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700aa, 0 0 90px #ffd70066; transform: scale(1); filter: brightness(1.2); }
            50% { box-shadow: 0 0 45px #ffd700, 0 0 90px #ffd700cc, 0 0 120px #ffd70088; transform: scale(1.06); filter: brightness(1.4); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.85; }
        }
        
        @keyframes scan-line {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        
        /* === PvP ANIMACE === */
        @keyframes pvpArenaGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(244, 67, 54, 0.3); }
            50% { box-shadow: 0 0 40px rgba(244, 67, 54, 0.6); }
        }
        
        @keyframes swordClash {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        
        @keyframes eloUp {
            0% { transform: translateY(0); color: #8bc34a; }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        
        @keyframes eloDown {
            0% { transform: translateY(0); color: #f44336; }
            50% { transform: translateY(10px); }
            100% { transform: translateY(0); }
        }
        
        @keyframes rankGlow {
            0%, 100% { filter: drop-shadow(0 0 5px currentColor); }
            50% { filter: drop-shadow(0 0 15px currentColor); }
        }
        
        @keyframes streakFire {
            0%, 100% { text-shadow: 0 0 5px #ff9800, 0 0 10px #f44336; }
            50% { text-shadow: 0 0 15px #ff9800, 0 0 25px #f44336, 0 0 35px #ffeb3b; }
        }
        
        @keyframes battleReady {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes criticalHit {
            0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
            25% { transform: scale(1.3) rotate(-5deg); filter: brightness(1.5); }
            50% { transform: scale(1.5) rotate(5deg); filter: brightness(2); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
        }
        
        @keyframes damageNumber {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(0.8); }
        }
        
        /* === NOV√â ANIMACE === */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes hitFlash {
            0% { filter: brightness(1); }
            50% { filter: brightness(2) saturate(2); }
            100% { filter: brightness(1); }
        }
        
        @keyframes goldShine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        @keyframes particleFloat {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        .shake { animation: shake 0.5s ease-in-out; }
        .bounce { animation: bounce 0.6s ease-in-out; }
        .fade-in-up { animation: fadeInUp 0.4s ease-out; }
        .fade-in-scale { animation: fadeInScale 0.3s ease-out; }
        .sparkle { animation: sparkle 1s ease-in-out infinite; }
        .hit-flash { animation: hitFlash 0.2s ease-out; }
        .damage-shake { animation: damageShake 0.3s ease-in-out; }
        
        /* === ADVANCED VISUAL EFFECTS v2.4 === */
        
        /* Rare item glow effect */
        .item-rare { 
            animation: rareGlow 2s ease-in-out infinite;
            border: 1px solid #2196f3 !important;
        }
        .item-epic { 
            animation: epicGlow 2s ease-in-out infinite;
            border: 1px solid #9c27b0 !important;
        }
        .item-legendary { 
            animation: legendaryGlow 1.5s ease-in-out infinite;
            border: 2px solid #ffd700 !important;
        }
        
        @keyframes rareGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(33, 150, 243, 0.3); }
            50% { box-shadow: 0 0 15px rgba(33, 150, 243, 0.6); }
        }
        
        @keyframes epicGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(156, 39, 176, 0.4); }
            50% { box-shadow: 0 0 20px rgba(156, 39, 176, 0.8); }
        }
        
        @keyframes legendaryGlow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 165, 0, 0.3);
                filter: brightness(1);
            }
            50% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 165, 0, 0.5);
                filter: brightness(1.1);
            }
        }
        
        /* Elite enemy effect */
        .elite-enemy {
            animation: eliteAura 1.5s ease-in-out infinite;
            position: relative;
        }
        
        .elite-enemy::after {
            content: 'üíÄ';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
            animation: elitePulse 1s ease-in-out infinite;
        }
        
        @keyframes eliteAura {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(139, 0, 0, 0.5);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 15px rgba(139, 0, 0, 0.8), 0 0 25px rgba(255, 0, 0, 0.3);
                transform: scale(1.02);
            }
        }
        
        @keyframes elitePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        /* Screen damage flash */
        @keyframes screenFlashRed {
            0% { background-color: rgba(139, 0, 0, 0); }
            50% { background-color: rgba(139, 0, 0, 0.3); }
            100% { background-color: rgba(139, 0, 0, 0); }
        }
        
        @keyframes screenFlashGreen {
            0% { background-color: rgba(0, 139, 0, 0); }
            50% { background-color: rgba(0, 139, 0, 0.2); }
            100% { background-color: rgba(0, 139, 0, 0); }
        }
        
        .screen-flash-red { animation: screenFlashRed 0.3s ease-out; }
        .screen-flash-green { animation: screenFlashGreen 0.3s ease-out; }
        
        /* Button hover effects */
        .btn {
            transition: all 0.2s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .btn:active::after {
            width: 200px;
            height: 200px;
        }
        
        /* Smooth transitions for UI elements */
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* Chat container - zajisti scroll na mobilech */
        #chatMessagesContainer {
            -webkit-overflow-scrolling: touch !important;
            overflow-y: auto !important;
            touch-action: pan-y !important;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        /* Progress bar animations */
        .progress-bar-animated {
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-animated::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            100% { left: 100%; }
        }
        
        /* Dust fall animation */
        @keyframes dustFall {
            0% { 
                transform: translateY(0) translateX(0); 
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: translateY(100vh) translateX(var(--drift)); 
                opacity: 0;
            }
        }
        
        /* Damage flash animation */
        @keyframes damageFlashAnim {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* Elite enemy glow */
        .elite-glow {
            animation: eliteGlowPulse 2s ease-in-out infinite;
        }
        
        @keyframes eliteGlowPulse {
            0%, 100% { 
                filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.5));
            }
            50% { 
                filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
            }
        }
        
        /* Rare item shimmer */
        .rare-shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .rare-shimmer::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                transparent 0%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 100%
            );
            transform: rotate(30deg);
            animation: rareShimmer 3s ease-in-out infinite;
        }
        
        @keyframes rareShimmer {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }
        
        /* Combat damage number pop */
        .damage-pop {
            animation: damagePop 0.3s ease-out;
        }
        
        @keyframes damagePop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Abyss portal effect */
        .abyss-portal {
            animation: abyssPortal 4s linear infinite;
            border-radius: 50%;
        }
        
        @keyframes abyssPortal {
            0% { 
                box-shadow: 0 0 10px #9c27b0, inset 0 0 20px rgba(156, 39, 176, 0.5);
                transform: rotate(0deg);
            }
            50% { 
                box-shadow: 0 0 30px #9c27b0, inset 0 0 40px rgba(156, 39, 176, 0.8);
            }
            100% { 
                box-shadow: 0 0 10px #9c27b0, inset 0 0 20px rgba(156, 39, 176, 0.5);
                transform: rotate(360deg);
            }
        }
        
        /* Radiation warning pulse */
        .radiation-warning {
            animation: radiationPulse 1s ease-in-out infinite;
        }
        
        @keyframes radiationPulse {
            0%, 100% { 
                text-shadow: 0 0 5px #7FFF00;
                opacity: 1;
            }
            50% { 
                text-shadow: 0 0 20px #7FFF00, 0 0 30px #ADFF2F;
                opacity: 0.8;
            }
        }
        
        /* Combat unit hover */
        .combat-unit {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .combat-unit:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            z-index: 10;
        }
        
        /* Terrain tile effects */
        .terrain-fire {
            animation: fireFlicker 0.5s ease-in-out infinite;
        }
        
        .terrain-toxic {
            animation: toxicBubble 2s ease-in-out infinite;
        }
        
        .terrain-water {
            animation: waterRipple 3s ease-in-out infinite;
        }
        
        @keyframes fireFlicker {
            0%, 100% { opacity: 0.8; filter: brightness(1); }
            50% { opacity: 1; filter: brightness(1.3); }
        }
        
        @keyframes toxicBubble {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes waterRipple {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.8; }
        }
        
        /* XP gain floating number */
        .xp-float {
            position: fixed;
            pointer-events: none;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: xpFloatUp 1.5s ease-out forwards;
            z-index: 10000;
        }
        
        @keyframes xpFloatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-80px) scale(1.5); 
            }
        }
        
        /* Level up celebration */
        .level-up-celebration {
            animation: levelUpBurst 0.8s ease-out;
        }
        
        @keyframes levelUpBurst {
            0% { 
                transform: scale(0.5);
                opacity: 0;
                filter: brightness(2);
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% { 
                transform: scale(1);
                opacity: 1;
                filter: brightness(1);
            }
        }
        
        /* Floating damage/heal numbers */
        .floating-number {
            position: fixed;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 10000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: floatUp 1.5s ease-out forwards;
        }
        
        .floating-number.damage { color: #ff4444; }
        .floating-number.heal { color: #4CAF50; }
        .floating-number.xp { color: #ffd700; }
        .floating-number.crit { color: #ff6600; font-size: 2rem; }
        .floating-number.money { color: #ffeb3b; }
        
        /* Particle container */
        .particle-container {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }
        
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: particleFloat 1s ease-out forwards;
        }
        
        /* Level up glow effect */
        .levelup-glow {
            animation: goldShine 2s linear infinite;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.3), transparent);
            background-size: 200% 100%;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--metal-dark);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--rust);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--rust-light);
        }
        
        /* === SPECIAL ELEMENTS === */
        .danger-zone {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.2) 0%, rgba(0,0,0,0.3) 100%);
            border: 2px solid var(--blood-red);
            border-radius: 6px;
            padding: 1rem;
        }
        
        .safe-zone {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2) 0%, rgba(0,0,0,0.3) 100%);
            border: 2px solid var(--toxic-dark);
            border-radius: 6px;
            padding: 1rem;
        }
        
        .warning-zone {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(0,0,0,0.3) 100%);
            border: 2px solid var(--warning-yellow);
            border-radius: 6px;
            padding: 1rem;
        }
        
        /* Glowing text for important values */
        .glow-green { color: var(--toxic-green); text-shadow: 0 0 10px var(--toxic-green); }
        .glow-red { color: #ff4444; text-shadow: 0 0 10px #ff4444; }
        .glow-yellow { color: var(--warning-yellow); text-shadow: 0 0 10px var(--warning-yellow); }
        .glow-orange { color: var(--danger-orange); text-shadow: 0 0 10px var(--danger-orange); }
        
        /* === NOTIFIKACE === */
        #notificationContainer {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
            pointer-events: none;
        }
        
        .notification {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid var(--rust);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            animation: notifySlideIn 0.3s ease-out, notifyFadeOut 0.5s ease-in 3.5s forwards;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
        }
        
        .notification.success { border-color: var(--toxic-green); }
        .notification.warning { border-color: var(--warning-yellow); }
        .notification.danger { border-color: #c62828; }
        .notification.info { border-color: #2196f3; }
        .notification.epic { border-color: #9c27b0; background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); }
        .notification.legendary { border-color: #ffd700; background: linear-gradient(135deg, #2a2a1a 0%, #3a3a2a 100%); animation: notifySlideIn 0.3s ease-out, legendaryGlow 1s ease-in-out infinite, notifyFadeOut 0.5s ease-in 4.5s forwards; }
        
        .notification-icon {
            font-size: 1.8rem;
            min-width: 40px;
            text-align: center;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 0.95rem;
            color: #fff;
            margin-bottom: 2px;
        }
        
        .notification-text {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        @keyframes notifySlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes notifyFadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(50%); }
        }
        
        /* === ADVANCED VISUAL EFFECTS === */
        
        /* Parallax wasteland background */
        .parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(139, 69, 19, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(57, 255, 20, 0.05) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(30, 30, 30, 1) 0%, rgba(10, 10, 10, 1) 100%);
        }
        
        /* Screen shake effect */
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-3px) translateY(2px); }
            20% { transform: translateX(3px) translateY(-2px); }
            30% { transform: translateX(-2px) translateY(1px); }
            40% { transform: translateX(2px) translateY(-1px); }
            50% { transform: translateX(-1px); }
            60% { transform: translateX(1px); }
        }
        
        .screen-shake {
            animation: screenShake 0.4s ease-out;
        }
        
        /* Combat damage flash */
        @keyframes damageFlash {
            0% { background-color: rgba(255, 0, 0, 0.4); }
            100% { background-color: transparent; }
        }
        
        .damage-flash {
            animation: damageFlash 0.3s ease-out;
        }
        
        /* Heal effect */
        @keyframes healPulse {
            0% { box-shadow: inset 0 0 20px rgba(76, 175, 80, 0.5); }
            100% { box-shadow: inset 0 0 0px rgba(76, 175, 80, 0); }
        }
        
        .heal-pulse {
            animation: healPulse 0.5s ease-out;
        }
        
        /* Radiation warning - uses @keyframes radiationPulse defined above */
        .radiation-warning {
            animation: radiationPulse 1s ease-in-out infinite;
            color: #ff9800 !important;
        }
        
        .radiation-critical {
            animation: radiationPulse 0.5s ease-in-out infinite;
            color: #ff4444 !important;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        /* Map location hover effect */
        .map-location {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        
        .map-location:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        /* Progress bar smooth animation */
        .progress-bar-fill {
            transition: width 0.5s ease-out;
        }
        
        /* Tab switch animation */
        @keyframes tabFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content {
            animation: tabFadeIn 0.3s ease-out;
        }
        
        /* Modal entrance - uses @keyframes modalSlideIn defined above */
        .modal.show .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* Combat grid cell hover */
        .combat-cell {
            transition: all 0.15s ease-out;
        }
        
        .combat-cell:hover {
            filter: brightness(1.3);
            z-index: 5;
        }
        
        /* Abyss special effects */
        @keyframes abyssGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(156, 39, 176, 0.3), inset 0 0 30px rgba(0, 0, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(156, 39, 176, 0.6), inset 0 0 50px rgba(0, 0, 0, 0.7); }
        }
        
        .abyss-portal {
            animation: abyssGlow 3s ease-in-out infinite;
            border-radius: 50%;
        }
        
        /* Loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--toxic-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Text typing effect class */
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        
        .typing-text {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 2s steps(40, end);
        }
        
        /* Inventory item hover */
        .inv-item {
            transition: all 0.2s ease-out;
        }
        
        .inv-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* Color blind friendly mode - add class to body */
        body.colorblind-mode .radiation-warning,
        body.colorblind-mode .radiation-critical {
            text-decoration: underline wavy;
        }
        
        body.colorblind-mode .item-rare { border: 2px dashed #2196f3; }
        body.colorblind-mode .item-epic { border: 2px dotted #9c27b0; }
        body.colorblind-mode .item-legendary { border: 3px double #ffd700; }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <div class="container">
        <header>
            <div id="headerStats" style="background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%); border: 1px solid #333; border-radius: 8px; padding: 0.4rem; margin-bottom: 0.3rem;">
                <!-- ≈ò√°dek 1: Jm√©no + HP + Level -->
                <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 0.25rem; margin-bottom: 0.3rem; align-items: center;">
                    <div class="stat clickable" data-stat="name" onclick="showStatInfo('name')" style="display: flex; align-items: center; gap: 0.2rem; background: linear-gradient(180deg, #2a2a1a 0%, #1a1a0a 100%); padding: 0.25rem 0.4rem; border-radius: 5px; border: 1px solid #4a4a2a; cursor: pointer; overflow: hidden;">
                        <span style="font-size: 0.85rem;">‚ò¢Ô∏è</span>
                        <span id="name" style="font-size: 0.7rem; font-weight: bold; color: #ffd700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
                    </div>
                    <div class="stat clickable" data-stat="hp" onclick="showStatInfo('hp')" style="display: flex; align-items: center; gap: 0.15rem; background: linear-gradient(180deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.25rem 0.4rem; border-radius: 5px; border: 1px solid #4a2a2a; cursor: pointer;">
                        <span style="font-size: 0.8rem;">‚ù§Ô∏è</span>
                        <span id="hp" style="font-size: 0.7rem; font-weight: bold; color: #ff6b6b;"></span>
                    </div>
                    <div class="stat clickable" data-stat="level" onclick="showStatInfo('level')" style="display: flex; align-items: center; gap: 0.15rem; background: linear-gradient(180deg, #1a2a1a 0%, #0a1a0a 100%); padding: 0.25rem 0.4rem; border-radius: 5px; border: 1px solid #2a4a2a; cursor: pointer;">
                        <span style="font-size: 0.8rem;">‚öîÔ∏è</span>
                        <span style="font-size: 0.7rem; font-weight: bold; color: #8bc34a;">Lv.<span id="level"></span></span>
                    </div>
                    <div style="display: flex; gap: 0.15rem;">
                        <div id="onlineIndicator" onclick="switchTab('multiplayer')" style="padding: 0.2rem 0.35rem; font-size: 0.75rem; background: #222; border: 1px solid #444; border-radius: 4px; min-width: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Online status">
                            <span id="onlineStatusIcon">‚ö´</span>
                        </div>
                        <button class="btn" onclick="toggleSound()" id="soundBtn" style="padding: 0.2rem 0.35rem; font-size: 0.75rem; background: #222; border: 1px solid #444; min-width: 28px;">üîä</button>
                        <button class="btn" onclick="showGameInfo()" style="padding: 0.2rem 0.35rem; font-size: 0.75rem; background: #222; border: 1px solid #444; min-width: 28px;">üìü</button>
                    </div>
                </div>
                <!-- ≈ò√°dek 2: V√°ha + ƒåas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem;">
                    <div class="stat clickable" data-stat="weight" onclick="showStatInfo('weight')" style="display: flex; align-items: center; justify-content: center; gap: 0.15rem; background: #151515; padding: 0.2rem; border-radius: 4px; border: 1px solid #2a2a2a; cursor: pointer;">
                        <span style="font-size: 0.7rem;">üì¶</span>
                        <span id="weight" style="font-size: 0.65rem; color: #aaa;"></span><span style="font-size: 0.6rem; color: #666;">kg</span>
                    </div>
                    <div class="stat clickable" data-stat="time" onclick="showStatInfo('time')" style="display: flex; align-items: center; justify-content: center; gap: 0.15rem; background: #151515; padding: 0.2rem; border-radius: 4px; border: 1px solid #2a2a2a; cursor: pointer;">
                        <span style="font-size: 0.7rem;">üïê</span>
                        <span id="time" style="font-size: 0.65rem; color: #aaa;"></span>
                    </div>
                </div>
            </div>
            <div id="statusBars"></div>
        </header>
        
        <main id="main"></main>
    </div>
    
    <nav id="nav"></nav>
    
    <!-- Scroll to top button -->
    <button id="scrollToTop" onclick="scrollToTop()">‚¨ÜÔ∏è</button>
    
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>
    
    <script>
        // === GLOBAL CLEANUP REGISTRY ===
        // Pro spr√°vn√© uvolnƒõn√≠ zdroj≈Ø p≈ôi ukonƒçen√≠
        const _cleanupRegistry = {
            intervals: [],
            timeouts: [],
            listeners: [],
            
            addInterval(id) { this.intervals.push(id); return id; },
            addTimeout(id) { this.timeouts.push(id); return id; },
            addListener(target, event, handler) { 
                this.listeners.push({ target, event, handler }); 
                return handler;
            },
            
            cleanup() {
                this.intervals.forEach(clearInterval);
                this.timeouts.forEach(clearTimeout);
                this.listeners.forEach(({ target, event, handler }) => {
                    target.removeEventListener(event, handler);
                });
                this.intervals = [];
                this.timeouts = [];
                this.listeners = [];
                console.log('üßπ Cleanup completed');
            }
        };
        
        // Safe interval/timeout wrappers
        function safeSetInterval(fn, delay) {
            return _cleanupRegistry.addInterval(setInterval(fn, delay));
        }
        
        function safeSetTimeout(fn, delay) {
            return _cleanupRegistry.addTimeout(setTimeout(fn, delay));
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => _cleanupRegistry.cleanup());
        
        // === SECURITY UTILITIES ===
        // Escape HTML to prevent XSS attacks in user-generated content
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Sanitizace jm√©na pro Firebase cesty (/ . # $ [ ] nejsou povoleny v kl√≠ƒç√≠ch)
        function sanitizeFirebasePath(name) {
            if (!name) return 'unknown';
            return String(name).replace(/[\/\.#$\[\]]/g, '_');
        }
        
        // === GAME CONSTANTS ===
        // Centralizovan√© konstanty m√≠sto magic numbers
        const GAME_CONSTANTS = {
            // Limity hodnot
            MAX_MONEY: 999999999,
            MAX_XP: Number.MAX_SAFE_INTEGER,
            MAX_HP: 9999,
            MAX_LEVEL: 100,
            MAX_INVENTORY_WEIGHT: 999,
            MAX_STACK_SIZE: 999,
            
            // ƒåasov√© konstanty (ms)
            AUTOSAVE_INTERVAL: 60000,           // 1 minuta
            DEBOUNCE_SAVE: 2000,                // 2 sekundy
            HOTEL_COOLDOWN: 4 * 60 * 60 * 1000, // 4 hodiny
            FORTUNE_COOLDOWN: 12 * 60 * 60 * 1000, // 12 hodin
            RADIO_COOLDOWN: 30 * 60 * 1000,     // 30 minut
            SLEEP_DURATION: 8 * 60 * 60 * 1000, // 8 hodin
            
            // Hern√≠ mechaniky
            BASE_XP_REQUIREMENT: 350,
            XP_MULTIPLIER: 1.5,
            CRIT_MULTIPLIER: 1.5,
            INFLATION_RATE_PER_DAY: 0.01,       // 1%
            MAX_INFLATION: 0.5,                  // 50%
            
            // Status decay (per game hour)
            HUNGER_DECAY: 1,
            THIRST_DECAY: 1.5,
            ENERGY_DECAY: 0.5,
            
            // Limity UI
            MAX_LOG_ENTRIES: 50,
            MAX_SETTLEMENT_EVENTS: 15,
            MAX_CHAT_MESSAGES: 100,
            
            // Storage keys
            STORAGE_KEYS: {
                SAVE: 'survival_hero_save',
                SAVE_V2: 'survival_hero_save_v2',
                BACKUP: 'survival_hero_backup',
                FRIENDS: 'friendsList_'
            }
        };
        
        // Freeze to prevent accidental modification
        Object.freeze(GAME_CONSTANTS);
        Object.freeze(GAME_CONSTANTS.STORAGE_KEYS);
        
        // === SAFE NUMBER UTILITIES ===
        function safeNumber(value, defaultValue = 0, min = -Infinity, max = Infinity) {
            const num = Number(value);
            if (isNaN(num) || !isFinite(num)) return defaultValue;
            return Math.max(min, Math.min(max, num));
        }
        
        function safeInteger(value, defaultValue = 0, min = -Infinity, max = Infinity) {
            return Math.floor(safeNumber(value, defaultValue, min, max));
        }
        
        // Debounce utility for performance optimization
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Throttle utility - execute at most once per wait period
        function throttle(func, wait) {
            let lastTime = 0;
            return function executedFunction(...args) {
                const now = Date.now();
                if (now - lastTime >= wait) {
                    lastTime = now;
                    func(...args);
                }
            };
        }
        
        // === GAME LOGGER ===
        // Centralizovan√© logov√°n√≠ s √∫rovnƒõmi a form√°tov√°n√≠m
        const GameLogger = {
            levels: {
                DEBUG: 0,
                INFO: 1,
                WARN: 2,
                ERROR: 3
            },
            
            currentLevel: 1, // INFO by default
            history: [],
            maxHistory: 100,
            
            // Ikony pro r≈Øzn√© kategorie
            icons: {
                combat: '‚öîÔ∏è',
                inventory: 'üéí',
                money: 'üí∞',
                xp: '‚≠ê',
                quest: 'üìú',
                multiplayer: 'üåê',
                save: 'üíæ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                debug: 'üîß'
            },
            
            /**
             * Nastav√≠ √∫rove≈à logov√°n√≠
             */
            setLevel(level) {
                if (typeof level === 'string') {
                    this.currentLevel = this.levels[level.toUpperCase()] ?? 1;
                } else {
                    this.currentLevel = level;
                }
            },
            
            /**
             * Form√°tovan√Ω log s kategori√≠
             */
            log(category, message, data = null, level = 1) {
                if (level < this.currentLevel) return;
                
                const timestamp = new Date().toLocaleTimeString('cs-CZ');
                const icon = this.icons[category] || 'üìù';
                const levelName = Object.keys(this.levels).find(k => this.levels[k] === level) || 'INFO';
                
                const logEntry = {
                    timestamp,
                    category,
                    message,
                    data,
                    level: levelName
                };
                
                // P≈ôidej do historie
                this.history.push(logEntry);
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                }
                
                // Console output
                const formattedMsg = `[${timestamp}] ${icon} [${category.toUpperCase()}] ${message}`;
                
                switch(level) {
                    case 0: console.debug(formattedMsg, data || ''); break;
                    case 1: console.log(formattedMsg, data || ''); break;
                    case 2: console.warn(formattedMsg, data || ''); break;
                    case 3: console.error(formattedMsg, data || ''); break;
                }
            },
            
            // Shortcut metody
            debug(category, message, data) { this.log(category, message, data, 0); },
            info(category, message, data) { this.log(category, message, data, 1); },
            warn(category, message, data) { this.log(category, message, data, 2); },
            error(category, message, data) { this.log(category, message, data, 3); },
            
            // Combat specific
            combat(message, data) { this.log('combat', message, data, 1); },
            
            // Money specific
            money(message, data) { this.log('money', message, data, 1); },
            
            /**
             * Export logu pro debugging
             */
            export() {
                return JSON.stringify(this.history, null, 2);
            },
            
            /**
             * Vyƒçist√≠ historii
             */
            clear() {
                this.history = [];
            }
        };
        
        // === EVENT BUS ===
        // Centr√°ln√≠ syst√©m pro komunikaci mezi ƒç√°stmi aplikace
        const EventBus = {
            events: {},
            
            /**
             * Registruje posluchaƒçe ud√°losti
             * @param {string} event - N√°zev ud√°losti
             * @param {function} callback - Callback funkce
             * @returns {function} Unsubscribe funkce
             */
            on(event, callback) {
                if (!this.events[event]) {
                    this.events[event] = [];
                }
                this.events[event].push(callback);
                
                // Vra≈• unsubscribe funkci
                return () => {
                    this.events[event] = this.events[event].filter(cb => cb !== callback);
                };
            },
            
            /**
             * Jednor√°zov√Ω posluchaƒç
             */
            once(event, callback) {
                const unsubscribe = this.on(event, (...args) => {
                    unsubscribe();
                    callback(...args);
                });
                return unsubscribe;
            },
            
            /**
             * Emituje ud√°lost
             * @param {string} event - N√°zev ud√°losti
             * @param {*} data - Data ud√°losti
             */
            emit(event, data) {
                if (!this.events[event]) return;
                
                this.events[event].forEach(callback => {
                    try {
                        callback(data);
                    } catch (error) {
                        console.error(`EventBus error in "${event}":`, error);
                    }
                });
            },
            
            /**
             * Odstran√≠ v≈°echny posluchaƒçe ud√°losti
             */
            off(event) {
                delete this.events[event];
            },
            
            /**
             * Debug: vyp√≠≈°e v≈°echny registrovan√© ud√°losti
             */
            debug() {
                console.log('EventBus registered events:');
                Object.entries(this.events).forEach(([event, listeners]) => {
                    console.log(`  ${event}: ${listeners.length} listeners`);
                });
            }
        };
        
        // P≈ôeddefinovan√© ud√°losti
        const GameEvents = {
            PLAYER_DAMAGED: 'player:damaged',
            PLAYER_HEALED: 'player:healed',
            PLAYER_DEATH: 'player:death',
            PLAYER_LEVEL_UP: 'player:levelUp',
            ITEM_ADDED: 'inventory:itemAdded',
            ITEM_REMOVED: 'inventory:itemRemoved',
            MONEY_CHANGED: 'player:moneyChanged',
            COMBAT_START: 'combat:start',
            COMBAT_END: 'combat:end',
            QUEST_COMPLETE: 'quest:complete',
            ACHIEVEMENT_UNLOCKED: 'achievement:unlocked',
            SAVE_GAME: 'game:save',
            LOAD_GAME: 'game:load'
        };
        
        Object.freeze(GameEvents);
        
        // === RATE LIMITER ===
        // Prevence p≈ô√≠li≈° ƒçast√Ωch API/Firebase vol√°n√≠
        const RateLimiter = {
            limits: {},
            
            /**
             * Kontroluje zda lze prov√©st akci
             * @param {string} key - Unik√°tn√≠ kl√≠ƒç akce
             * @param {number} cooldownMs - Minim√°ln√≠ interval mezi akcemi v ms
             * @returns {boolean} true pokud lze prov√©st, false pokud je v cooldownu
             */
            canProceed(key, cooldownMs) {
                const now = Date.now();
                const lastTime = this.limits[key] || 0;
                
                if (now - lastTime < cooldownMs) {
                    return false;
                }
                
                this.limits[key] = now;
                return true;
            },
            
            /**
             * ƒåas zb√Ωvaj√≠c√≠ do konce cooldownu
             * @param {string} key - Unik√°tn√≠ kl√≠ƒç akce
             * @param {number} cooldownMs - Cooldown v ms
             * @returns {number} Zb√Ωvaj√≠c√≠ ƒças v ms (0 pokud lze prov√©st)
             */
            getRemaining(key, cooldownMs) {
                const now = Date.now();
                const lastTime = this.limits[key] || 0;
                const remaining = cooldownMs - (now - lastTime);
                return Math.max(0, remaining);
            },
            
            /**
             * Resetuje cooldown pro dan√Ω kl√≠ƒç
             */
            reset(key) {
                delete this.limits[key];
            },
            
            /**
             * Wrapper pro funkci s rate limitingem
             * @param {string} key - Unik√°tn√≠ kl√≠ƒç
             * @param {number} cooldownMs - Cooldown v ms
             * @param {function} fn - Funkce k proveden√≠
             * @param {function} onBlocked - Callback p≈ôi blokov√°n√≠ (optional)
             */
            wrap(key, cooldownMs, fn, onBlocked) {
                return (...args) => {
                    if (!this.canProceed(key, cooldownMs)) {
                        const remaining = this.getRemaining(key, cooldownMs);
                        console.log(`‚è≥ Rate limited: ${key} (${Math.ceil(remaining/1000)}s remaining)`);
                        if (onBlocked) onBlocked(remaining);
                        return;
                    }
                    return fn(...args);
                };
            }
        };
        
        // === V√çCEJAZYƒåN√ù SYST√âM ===
        const currentLang = 'cs';
        
        const TRANSLATIONS = {
            // === ƒåE≈†TINA ===
            cs: {
                // UI - Hlavn√≠ navigace
                ui: {
                    play: 'Hr√°t',
                    inventory: 'V√Ωbava',
                    map: 'Mapa',
                    settlement: 'Osada',
                    craft: 'Craft',
                    quests: 'Questy',
                    settings: 'Nastaven√≠',
                    close: 'Zav≈ô√≠t',
                    back: 'Zpƒõt',
                    next: 'Dal≈°√≠',
                    confirm: 'Potvrdit',
                    cancel: 'Zru≈°it',
                    save: 'Ulo≈æit',
                    load: 'Naƒç√≠st',
                    yes: 'Ano',
                    no: 'Ne',
                    ok: 'OK',
                    buy: 'Koupit',
                    sell: 'Prodat',
                    use: 'Pou≈æ√≠t',
                    equip: 'Vyzbrojit',
                    unequip: 'Odlo≈æit',
                    drop: 'Zahodit',
                    repair: 'Opravit',
                    upgrade: 'Vylep≈°it',
                    travel: 'Cestovat',
                    rest: 'Odpoƒç√≠vat',
                    search: 'Hledat',
                    attack: '√ötok',
                    defend: 'Obrana',
                    flee: '√ötƒõk',
                    skip: 'P≈ôeskoƒçit',
                    // Nov√© kl√≠ƒçe pro invent√°≈ô
                    items: 'P≈ôedmƒõty',
                    capacity: 'Kapacita',
                    sleep: 'Sp√°nek',
                    poison: 'Jed',
                    fire: 'Ohe≈à',
                    bow: 'Luk',
                    crossbowAmmo: '≈†ipky',
                    pistolAmmo: '9mm n√°boje',
                    rifleAmmo: '5.56 n√°boje',
                    sniperAmmo: '7.62 n√°boje',
                    shotgunAmmo: 'Broky',
                    flameAmmo: 'Palivo',
                    ammo: 'Munice',
                    readStatus: 'P≈ôeƒçteno',
                    unread: 'Nep≈ôeƒçteno',
                    read: 'ƒå√≠st',
                    survivor: 'P≈ôe≈æiv≈°√≠',
                    look: 'Vzhled',
                    skills: 'Dovednosti'
                },
                // Statistiky
                stats: {
                    health: 'Zdrav√≠',
                    hunger: 'Hlad',
                    thirst: '≈Ω√≠ze≈à',
                    radiation: 'Radiace',
                    energy: 'Energie',
                    level: 'Level',
                    exp: 'Zku≈°enosti',
                    money: 'Pen√≠ze',
                    damage: 'Po≈°kozen√≠',
                    defense: 'Obrana',
                    day: 'Den',
                    time: 'ƒåas'
                },
                // Atributy
                attrs: {
                    str: 'S√≠la',
                    end: 'V√Ωdr≈æ',
                    agi: 'Obratnost',
                    int: 'Inteligence',
                    per: 'Vn√≠m√°n√≠',
                    cha: 'Charisma',
                    lck: '≈†tƒõst√≠'
                },
                // Vytv√°≈ôen√≠ postavy
                charCreate: {
                    title: 'Vytvo≈ôen√≠ Postavy',
                    name: 'Jm√©no',
                    gender: 'Pohlav√≠',
                    class: 'Povol√°n√≠',
                    attributes: 'Atributy',
                    pointsLeft: 'Zb√Ωvaj√≠c√≠ body',
                    startGame: 'Zaƒç√≠t hru',
                    whatIsThis: 'Co je to za hru?',
                    male: 'Mu≈æ',
                    female: '≈Ωena'
                },
                // Invent√°≈ô
                inv: {
                    title: 'Invent√°≈ô',
                    equipment: 'Vybaven√≠',
                    resources: 'Suroviny',
                    consumables: 'Spot≈ôebn√≠',
                    weapons: 'Zbranƒõ',
                    armor: 'Zbroj',
                    weight: 'V√°ha',
                    empty: 'Pr√°zdn√Ω invent√°≈ô',
                    equipped: 'Vybaveno'
                },
                // Mapa
                mapUI: {
                    title: 'Mapa svƒõta',
                    yourPosition: 'Tv√° pozice',
                    destination: 'C√≠l',
                    distance: 'Vzd√°lenost',
                    travelTime: 'ƒåas cesty',
                    goHere: 'J√≠t sem',
                    exploring: 'Prozkoum√°v√°n√≠...',
                    discovered: 'Objeveno',
                    unknown: 'Nezn√°m√©'
                },
                // Osada
                settlementUI: {
                    title: 'Osada',
                    buildings: 'Budovy',
                    settlers: 'Osadn√≠ci',
                    resources: 'Z√°soby',
                    defense: 'Obrana',
                    morale: 'Mor√°lka',
                    prosperity: 'Prosperita',
                    build: 'Stavƒõt',
                    hire: 'Najmout',
                    storage: 'Sklad',
                    food: 'J√≠dlo',
                    water: 'Voda',
                    power: 'Energie',
                    maintenance: '√ödr≈æba',
                    income: 'P≈ô√≠jem',
                    population: 'Obyvatel√©'
                },
                // Crafting
                craftUI: {
                    title: 'V√Ωroba',
                    recipes: 'Recepty',
                    materials: 'Materi√°ly',
                    craft: 'Vyrobit',
                    required: 'Pot≈ôeba',
                    result: 'V√Ωsledek'
                },
                // Boj
                combat: {
                    title: 'Boj',
                    yourTurn: 'Tv√© kolo',
                    enemyTurn: 'Kolo nep≈ô√≠tele',
                    victory: 'V√≠tƒõzstv√≠!',
                    defeat: 'Prohra!',
                    flee: '√ötƒõk!',
                    actions: 'Akce',
                    actionsLeft: 'Zb√Ωv√° akc√≠',
                    move: 'Pohyb',
                    attack: '√ötok',
                    defend: 'Obrana',
                    item: 'P≈ôedmƒõt',
                    swap: 'Vymƒõnit zbra≈à',
                    range: 'Dosah',
                    melee: 'Na bl√≠zko',
                    ranged: 'Na d√°lku',
                    ammo: 'Munice',
                    critical: 'Kritick√Ω z√°sah!',
                    miss: 'Minul!',
                    blocked: 'Zablokov√°no!',
                    round: 'Kolo'
                },
                // Spoleƒçn√≠ci
                companions: {
                    title: 'Spoleƒçn√≠ci',
                    loyalty: 'Loajalita',
                    feed: 'Nakrmit',
                    water: 'Napojit',
                    dismiss: 'Propustit',
                    stats: 'Statistiky',
                    abilities: 'Schopnosti',
                    hungry: 'Hladov√Ω',
                    thirsty: '≈Ω√≠zniv√Ω',
                    happy: 'Spokojen√Ω',
                    // Jm√©na spoleƒçn√≠k≈Ø
                    dog: 'Vƒõrn√Ω pes',
                    cat: 'Mazan√° koƒçka',
                    crow: 'Bystr√Ω havran',
                    scout: 'Zvƒõd',
                    medic_npc: 'Poln√≠ medik',
                    warrior: 'V√°leƒçn√≠k',
                    trader_npc: 'Obchodn√≠k',
                    engineer_npc: 'Technik',
                    // Schopnosti
                    sniffing: 'ƒåmuch√°n√≠',
                    mousing: 'My≈°ilov',
                    scouting: 'Pr≈Øzkum',
                    quickScout: 'Rychl√Ω pr≈Øzkum',
                    healing: 'L√©ƒçen√≠',
                    fighter: 'Bojovn√≠k',
                    bargaining: 'Smlouv√°n√≠',
                    repairs: 'Opravy'
                },
                // Questy
                questsUI: {
                    title: '√ökoly',
                    active: 'Aktivn√≠',
                    completed: 'Dokonƒçen√©',
                    daily: 'Denn√≠',
                    main: 'Hlavn√≠',
                    side: 'Vedlej≈°√≠',
                    reward: 'Odmƒõna',
                    progress: 'Postup',
                    accept: 'P≈ôijmout',
                    abandon: 'Vzd√°t se'
                },
                // Obecn√©
                general: {
                    loading: 'Naƒç√≠t√°n√≠...',
                    saving: 'Ukl√°d√°n√≠...',
                    error: 'Chyba',
                    success: '√öspƒõch',
                    warning: 'Varov√°n√≠',
                    info: 'Info',
                    notEnough: 'Nedostatek',
                    full: 'Pln√Ω',
                    empty: 'Pr√°zdn√Ω',
                    locked: 'Zamƒçeno',
                    unlocked: 'Odemƒçeno',
                    new: 'Nov√©',
                    rare: 'Vz√°cn√©',
                    common: 'Bƒõ≈æn√©',
                    epic: 'Epick√©',
                    legendary: 'Legend√°rn√≠'
                },
                // Tutorial
                tutorial: {
                    welcome: 'V√≠tej v pustinƒõ!',
                    skip: 'P≈ôeskoƒçit tutorial',
                    finish: 'Dokonƒçit',
                    tip: 'Tip'
                },
                // ƒåas
                time: {
                    morning: 'R√°no',
                    day: 'Den',
                    evening: 'Veƒçer',
                    night: 'Noc',
                    dawn: '√ösvit',
                    dusk: 'Soumrak'
                },
                // Povol√°n√≠
                classes: {
                    raider: { name: 'N√°jezdn√≠k', desc: 'Brut√°ln√≠ bojovn√≠k z pustiny', ability: '+25% damage v boji' },
                    berserker: { name: 'Berserkr', desc: '≈†√≠len√Ω v√°leƒçn√≠k bez strachu', ability: '+40% damage, -25% obrana' },
                    survivor: { name: 'P≈ôe≈æiv≈°√≠', desc: 'Otrl√Ω veter√°n apokalypsy', ability: '+50 max HP' },
                    tank: { name: 'Tank', desc: 'Nepr≈Øst≈ôeln√° zeƒè masa', ability: '+80 max HP, -15% rychlost' },
                    stalker: { name: 'Stopa≈ô', desc: 'Tich√Ω lovec st√≠n≈Ø', ability: '-30% spot≈ôeba zdroj≈Ø' },
                    assassin: { name: 'Assassin', desc: 'Mistr rychl√Ωch zabit√≠', ability: '+40% crit ≈°ance' },
                    medic: { name: 'Poln√≠ Medik', desc: 'Expert na p≈ôe≈æit√≠ a l√©ƒçbu', ability: 'L√©ƒçiva +50% efektivnƒõj≈°√≠' },
                    alchemist: { name: 'Alchymista', desc: 'Mistr lektvar≈Ø a jed≈Ø', ability: 'Lektvary +100% efekt' },
                    scavenger: { name: 'Sbƒõraƒç', desc: 'Specialista na hled√°n√≠ zdroj≈Ø', ability: '+50% ≈°ance naj√≠t p≈ôedmƒõty' },
                    hunter: { name: 'Lovec', desc: 'Mistr lovu a p≈ô√≠rody', ability: '+100% loot ze zv√≠≈ôat' },
                    engineer: { name: 'Mechanik', desc: 'Technik a vyn√°lezce', ability: 'Crafting -50% surovin' },
                    demolitionist: { name: 'Demoliƒç√°≈ô', desc: 'Expert na v√Ωbu≈°niny', ability: 'V√Ωbuchy +100% damage' },
                    trader: { name: 'Obchodn√≠k', desc: 'Charismatick√Ω dealer', ability: '-30% ceny v obchodech' },
                    nomad: { name: 'Nom√°d', desc: 'Pou≈°tn√≠ tul√°k', ability: '-5% ƒças cestov√°n√≠' },
                    mutant: { name: 'Mutant', desc: 'Ob≈ô√≠ zmutovan√Ω p≈ôe≈æiv≈°√≠', ability: 'Imunn√≠ na radiaci' },
                    psychic: { name: 'Psychik', desc: 'Ment√°ln√≠ schopnosti', ability: 'Vid√≠≈° skryt√© lokace na mapƒõ' }
                },
                // Nep≈ô√°tel√©
                enemies: {
                    dog: 'Divok√Ω pes', rat: 'Ob≈ô√≠ krysa', snake: 'Jedovat√Ω had', wolf: 'Vlk',
                    raider: 'N√°jezdn√≠k', bandit: 'Bandita', thief: 'Zlodƒõj', marauder: 'Maraud√©r',
                    ghoul: 'Gh√∫l', zombie: 'Zombie', crawler: 'Plazivec',
                    mutant: 'Mutant', abomination: 'Zr≈Øda', beast: 'Bestie',
                    robot: 'Robot', drone: 'Dron', turret: 'Vƒõ≈æiƒçka',
                    boss: 'Boss', warlord: 'V√°leƒçn√≠k', alpha: 'Alfa'
                },
                // Lokace
                locations: {
                    shelter: '√ökryt', settlement: 'Osada', city: 'Mƒõsto', village: 'Vesnice',
                    ruins: 'Ruiny', bunker: 'Bunkr', factory: 'Tov√°rna', hospital: 'Nemocnice',
                    forest: 'Les', desert: 'Pou≈°≈•', mountains: 'Hory', swamp: 'Ba≈æina',
                    lake: 'Jezero', river: '≈òeka', bridge: 'Most', road: 'Silnice',
                    cave: 'Jeskynƒõ', mine: 'D≈Øl', military: 'Vojensk√° z√°kladna', lab: 'Laborato≈ô',
                    trader: 'Obchodn√≠k', casino: 'Kasino', arena: 'Ar√©na', church: 'Kostel'
                },
                // Budovy
                buildings: {
                    bed: 'L≈Ø≈æko', firepit: 'Ohni≈°tƒõ', garden: 'Zahrada', water: 'Sbƒõraƒç vody',
                    workshop: 'D√≠lna', storage: 'Sklad', well: 'Studna', farmland: 'Pole',
                    infirmary: 'O≈°et≈ôovna', kitchen: 'Kuchy≈à', wall: 'Hradby', tower: 'Str√°≈æn√≠ vƒõ≈æ',
                    market: 'Tr≈æi≈°tƒõ', barracks: 'Kas√°rny', forge: 'Kov√°rna', training: 'Cviƒçi≈°tƒõ',
                    armory: 'Zbrojnice', tavern: 'Hospoda', chapel: 'Kaple', generator: 'Gener√°tor',
                    solar: 'Sol√°rn√≠ panely', purifier: 'ƒåistiƒçka vody', hydrofarm: 'Hydroponick√° farma',
                    reactor: 'Reaktor', medbay: 'Zdravotn√≠ st≈ôedisko', turret: 'Automatick√° vƒõ≈æ',
                    university: 'Univerzita', monument: 'Monument'
                },
                // Osadn√≠ci
                settlers: {
                    farmer: 'Farm√°≈ô', guard: 'Str√°≈æce', scavenger: 'Sbƒõraƒç', medic: 'Medik',
                    builder: 'Stavitel', blacksmith: 'Kov√°≈ô', cook: 'Kucha≈ô', scout: 'Zvƒõd',
                    trader: 'Obchodn√≠k', alchemist: 'Alchymista', hunter: 'Lovec', waterCarrier: 'Nosiƒç vody'
                },
                // Suroviny
                resources: {
                    wood: 'D≈ôevo', metal: 'Kov', stone: 'K√°men', cloth: 'L√°tka',
                    herbs: 'Byliny', chemicals: 'Chemik√°lie', electronics: 'Elektronika',
                    glass: 'Sklo', scrap: '≈†rot', fuel: 'Palivo', leather: 'K≈Ø≈æe',
                    rope: 'Lano', gunpowder: 'St≈ôeln√Ω prach', copper: 'Mƒõƒè', silver: 'St≈ô√≠bro',
                    gold: 'Zlato', gems: 'Drahokamy', crystal: 'Krystal', acid: 'Kyselina'
                },
                // Obecn√© hern√≠ texty
                game: {
                    newGame: 'Nov√° hra',
                    loadGame: 'Naƒç√≠st hru',
                    saveGame: 'Ulo≈æit hru',
                    continue: 'Pokraƒçovat',
                    options: 'Mo≈ænosti',
                    quit: 'Ukonƒçit',
                    paused: 'Pozastaveno',
                    gameOver: 'Konec hry',
                    youDied: 'Zem≈ôel jsi',
                    youWon: 'Vyhr√°l jsi',
                    restart: 'Znovu',
                    mainMenu: 'Hlavn√≠ menu'
                },
                // Notifikace
                notifications: {
                    saved: 'Hra ulo≈æena',
                    loaded: 'Hra naƒçtena',
                    levelUp: 'Level Up!',
                    newQuest: 'Nov√Ω √∫kol',
                    questComplete: '√ökol splnƒõn',
                    itemFound: 'P≈ôedmƒõt nalezen',
                    notEnoughMoney: 'Nedostatek penƒõz',
                    notEnoughResources: 'Nedostatek surovin',
                    inventoryFull: 'Pln√Ω invent√°≈ô',
                    equipped: 'Vybaveno',
                    unequipped: 'Odlo≈æeno',
                    repaired: 'Opraveno',
                    crafted: 'Vyrobeno',
                    sold: 'Prod√°no',
                    bought: 'Koupeno'
                },
                // Detailn√≠ UI texty
                uiDetail: {
                    newGame: 'Nov√° hra',
                    continueGame: 'Pokraƒçovat',
                    loadGame: 'Naƒç√≠st hru',
                    settings: 'Nastaven√≠',
                    emptySlot: 'Pr√°zdn√Ω slot',
                    durability: 'Odolnost',
                    damage: 'Po≈°kozen√≠',
                    defense: 'Obrana',
                    weight: 'V√°ha',
                    value: 'Hodnota',
                    quantity: 'Mno≈æstv√≠',
                    unexplored: 'Neprozkoum√°no',
                    explored: 'Prozkoum√°no',
                    currentLocation: 'Aktu√°ln√≠ pozice',
                    travelTo: 'Cestovat do',
                    distance: 'Vzd√°lenost',
                    travelTime: 'ƒåas cesty',
                    danger: 'Nebezpeƒç√≠',
                    buildCost: 'Cena stavby',
                    upgradeLevel: '√örove≈à vylep≈°en√≠',
                    production: 'Produkce',
                    consumption: 'Spot≈ôeba',
                    storageCapacity: 'Kapacita skladu',
                    defenseValue: 'Hodnota obrany',
                    moraleBonus: 'Bonus mor√°lky',
                    ingredients: 'Ingredience',
                    craftTime: 'ƒåas v√Ωroby',
                    successChance: '≈†ance na √∫spƒõch',
                    yourHP: 'Tv√© HP',
                    enemyHP: 'HP nep≈ô√≠tele',
                    round: 'Kolo',
                    actionsRemaining: 'Zb√Ωvaj√≠c√≠ akce',
                    weaponRange: 'Dosah zbranƒõ',
                    ammoLeft: 'Zb√Ωv√° munice',
                    dawn: '√ösvit',
                    day: 'Den',
                    dusk: 'Soumrak',
                    night: 'Noc',
                    morning: 'R√°no',
                    evening: 'Veƒçer',
                    weather: 'Poƒças√≠',
                    clear: 'Jasno',
                    rain: 'D√©≈°≈•',
                    storm: 'Bou≈ôka',
                    fog: 'Mlha',
                    perDay: 'dennƒõ',
                    perHour: 'za hodinu',
                    seconds: 'sekund',
                    minutes: 'minut',
                    hours: 'hodin',
                    days: 'dn√≠',
                    km: 'km',
                    kg: 'kg'
                },
                dialogs: {
                    confirmDelete: 'Opravdu chce≈° smazat?',
                    confirmSell: 'Prodat tento p≈ôedmƒõt?',
                    confirmBuy: 'Koupit tento p≈ôedmƒõt?',
                    confirmTravel: 'Cestovat na toto m√≠sto?',
                    confirmRest: 'Odpoƒç√≠vat zde?',
                    confirmDismiss: 'Propustit tohoto spoleƒçn√≠ka?',
                    confirmAbandon: 'Vzd√°t se tohoto √∫kolu?',
                    gameOverText: 'Zem≈ôel jsi. Pustina si vy≈æ√°dala dal≈°√≠ obƒõ≈•.',
                    restartPrompt: 'Zaƒç√≠t novou hru?',
                    noAmmo: '≈Ω√°dn√° munice!',
                    tooHeavy: 'P≈ô√≠li≈° tƒõ≈æk√© na nesen√≠!',
                    cantAfford: 'Na tohle nem√°≈° pen√≠ze!',
                    inventoryFull: 'Invent√°≈ô je pln√Ω!',
                    questAccepted: '√ökol p≈ôijat!',
                    questCompleted: '√ökol splnƒõn!',
                    levelUp: 'Level up! Tv√° nov√° √∫rove≈à je',
                    newAbility: 'Odemƒçena nov√° schopnost!',
                    companionJoined: 'se p≈ôidal k tv√© skupinƒõ!',
                    companionLeft: 'opustil tvou skupinu.',
                    itemFound: 'Na≈°el jsi:',
                    enemyDefeated: 'Nep≈ô√≠tel pora≈æen!',
                    youFled: 'Utekl jsi z boje!',
                    enemyFled: 'Nep≈ô√≠tel utekl!',
                    resting: 'Odpoƒç√≠v√°≈°...',
                    traveling: 'Cestuje≈°...',
                    exploring: 'Prozkoum√°v√°≈°...',
                    crafting: 'Vyr√°b√≠≈°...',
                    building: 'Stav√≠≈°...',
                    repairing: 'Opravuje≈°...'
                },
                // Denn√≠ questy
                dailyQuests: {
                    kill_enemies: { name: 'Lovec', desc: 'Zabij 3 nep≈ô√°tele' },
                    kill_many: { name: 'Vyhlazovaƒç', desc: 'Zabij 8 nep≈ô√°tel' },
                    explore_hexes: { name: 'Pr≈Øzkumn√≠k', desc: 'Objevuj 2 nov√© lokace' },
                    collect_money: { name: 'Sbƒõratel', desc: 'Z√≠skej 150 penƒõz' },
                    collect_loot: { name: 'Hledaƒç', desc: 'Najdi 5 p≈ôedmƒõt≈Ø' },
                    craft_items: { name: '≈òemesln√≠k', desc: 'Vyrob 2 vƒõci' },
                    cook_food: { name: 'Kucha≈ô', desc: 'Upeƒç/uva≈ô 3 j√≠dla' },
                    trade_items: { name: 'Obchodn√≠k', desc: 'Prodej 3 vƒõci' },
                    buy_items: { name: 'N√°kupƒç√≠', desc: 'Kup 2 vƒõci' },
                    feed_companion: { name: 'Krmitel', desc: 'Nakrm spoleƒçn√≠ka' },
                    heal_self: { name: 'P≈ôe≈æiv≈°√≠', desc: 'Vyl√©ƒç se 50 HP' }
                },
                events: {
                    ambush: 'P≈ôepaden√≠!',
                    found: 'Nalezeno!',
                    discovery: 'Objev!',
                    encounter: 'Setk√°n√≠!',
                    danger: 'Nebezpeƒç√≠!',
                    success: '√öspƒõch!',
                    failure: 'Selh√°n√≠!',
                    reward: 'Odmƒõna',
                    choice: 'Vyber si:',
                    accept: 'P≈ôijmout',
                    decline: 'Odm√≠tnout',
                    fight: 'Bojovat',
                    run: 'Ut√©ct',
                    negotiate: 'Vyjedn√°vat',
                    search: 'Prohledat',
                    rest: 'Odpoƒç√≠vat',
                    continue: 'Pokraƒçovat'
                },
            },
            
        };
        
        // Lokalizace n√°zv≈Ø lokac√≠
        // Funkce pro z√≠sk√°n√≠ lokalizovan√©ho n√°zvu t≈ô√≠dy (pouze ƒçe≈°tina)
        function getClassName(classId) {
            return CLASSES[classId]?.name || classId;
        }
        
        function getClassDesc(classId) {
            return CLASSES[classId]?.desc || '';
        }
        
        function getClassAbility(classId) {
            return CLASSES[classId]?.ability || '';
        }
        
        function getClassPassive(classId) {
            return CLASSES[classId]?.passive || '';
        }
        
        // P≈ôeklady poƒças√≠
        // Funkce pro poƒças√≠ (pouze ƒçe≈°tina)
        function getWeatherName(weatherId) {
            const w = WEATHER_TYPES?.find(w => w.id === weatherId);
            return w?.name || weatherId;
        }
        
        function getWeatherDesc(weatherId) {
            const w = WEATHER_TYPES?.find(w => w.id === weatherId);
            return w?.desc || '';
        }
        
        // Funkce pro spoleƒçn√≠ky (pouze ƒçe≈°tina)
        function getCompanionName(companionId) {
            const c = COMPANIONS?.find(c => c.id === companionId);
            return c?.name || companionId;
        }
        
        // P≈ôeklady p≈ôedmƒõt≈Ø
        // P≈ôeklady p≈ôedmƒõt≈Ø - pouze ƒçe≈°tina, bereme p≈ô√≠mo z ITEMS
        function getItemName(itemIdOrItem) {
            // Pokud je to objekt s id, pou≈æij id
            const itemId = typeof itemIdOrItem === 'object' ? itemIdOrItem?.id : itemIdOrItem;
            const item = ITEMS?.find(i => i.id === itemId);
            
            // Vra≈• ƒçesk√© jm√©no z ITEMS pokud existuje
            if (item?.name) return item.name;
            
            // Fallback - pokud byl p≈ôed√°n objekt, vra≈• jeho name
            if (typeof itemIdOrItem === 'object' && itemIdOrItem?.name) {
                return itemIdOrItem.name;
            }
            
            // Posledn√≠ fallback - vra≈• ID
            return itemId || 'Nezn√°m√Ω p≈ôedmƒõt';
        }
        
        // Kontrola jestli je item vybaven
        function isItemEquipped(item) {
            if (!item || !state.equipped) return false;
            
            // Najdi index itemu v invent√°≈ôi
            const itemIndex = state.inv.indexOf(item);
            
            // Pomocn√° funkce - kontrola jestli equipped item je stejn√Ω objekt (reference)
            // NEBO je to stejn√Ω index v invent√°≈ôi (pro p≈ô√≠pad po load)
            const isEquippedItem = (equippedItem) => {
                if (!equippedItem) return false;
                if (equippedItem === item) return true; // P≈ô√≠m√° reference
                // Po load: equipped item by mƒõl b√Ωt propojen√Ω s inv, tak≈æe kontroluj index
                const equippedIndex = state.inv.indexOf(equippedItem);
                return equippedIndex !== -1 && equippedIndex === itemIndex;
            };
            
            // Kontrola v≈°ech slot≈Ø
            if (isEquippedItem(state.equipped.weapon)) return true;
            if (isEquippedItem(state.equipped.armor)) return true;
            if (isEquippedItem(state.equipped.helmet)) return true;
            if (isEquippedItem(state.equipped.gloves)) return true;
            if (isEquippedItem(state.equipped.boots)) return true;
            
            // Kontrola accessory (accessory se ukl√°d√° jako ID, ne jako reference)
            if (item.type === 'accessory' && state.equippedAccessory === item.id) return true;
            
            return false;
        }
        
        // NPC jm√©na - p≈ô√≠mo z definice
        function getNpcName(npcId) {
            // Pro bƒõ≈æn√© NPC se jm√©na berou p≈ô√≠mo z k√≥du kde jsou definov√°na
            return npcId;
        }
        
        // Quest popisy - p≈ô√≠mo z MAIN_QUESTS
        function getQuestDesc(questId) {
            const quest = MAIN_QUESTS?.find(q => q.id === questId);
            return quest?.description || '';
        }
        
        // Enemy jm√©na - p≈ô√≠mo z ENEMIES
        function getEnemyName(enemyId) {
            const enemy = ENEMIES?.find(e => e.id === enemyId);
            return enemy?.name || enemyId;
        }
        
        // Skill jm√©na - p≈ô√≠mo z definice
        function getSkillName(skillId) {
            for (const branch of Object.values(SKILL_TREE || {})) {
                const skill = branch.skills?.find(s => s.id === skillId);
                if (skill) return skill.name;
            }
            return skillId;
        }
        
        function getSkillBranchName(branchId) {
            return SKILL_TREE?.[branchId]?.name || branchId;
        }
        
        // Mutation jm√©na - p≈ô√≠mo z MUTATIONS
        function getMutationName(mutationId) {
            const mutation = MUTATIONS?.find(m => m.id === mutationId);
            return mutation?.name || mutationId;
        }
        
        function getMutationDesc(mutationId) {
            const mutation = MUTATIONS?.find(m => m.id === mutationId);
            return mutation?.desc || '';
        }
        
        // Z√≠sk√°n√≠ bonus≈Ø z aktivn√≠ch mutac√≠
        function getMutationBonuses() {
            const bonuses = {
                defense: 0,
                dodgeChance: 0,
                maxHp: 0,
                damageBonus: 0,
                damageTaken: 0,
                healRate: 0,
                radResist: 0,
                str: 0,
                agi: 0,
                int: 0,
                perception: 0,
                travelSpeed: 0,
                speed: 0,
                hungerRate: 0,
                energyDrain: 0
            };
            
            if (!state.mutations || state.mutations.length === 0) return bonuses;
            
            state.mutations.forEach(mutId => {
                const mutation = MUTATIONS?.find(m => m.id === mutId);
                if (mutation?.effect) {
                    Object.entries(mutation.effect).forEach(([key, value]) => {
                        if (typeof value === 'number' && bonuses.hasOwnProperty(key)) {
                            bonuses[key] += value;
                        }
                    });
                }
            });
            
            return bonuses;
        }
        
        // Faction jm√©na - p≈ô√≠mo z FACTIONS
        function getFactionName(factionId) {
            const faction = FACTIONS?.find(f => f.id === factionId);
            return faction?.name || factionId;
        }
        
        function getFactionDesc(factionId) {
            const f = FACTIONS?.find(f => f.id === factionId);
            return f?.desc || '';
        }
        
        // Event jm√©na - p≈ô√≠mo z SETTLEMENT_EVENTS
        function getEventName(eventId) {
            const evt = SETTLEMENT_EVENTS?.find(e => e.id === eventId);
            return evt?.name || eventId;
        }
        
        function getEventDesc(eventId) {
            const evt = SETTLEMENT_EVENTS?.find(e => e.id === eventId);
            return evt?.desc || '';
        }
        
        // Dungeon jm√©na - p≈ô√≠mo z definice
        function getDungeonName(dungeonId) {
            return dungeonId;
        }
        
        // Achievement jm√©na - p≈ô√≠mo z ACHIEVEMENTS
        function getAchievementName(achId) {
            const ach = ACHIEVEMENTS?.find(a => a.id === achId);
            return ach?.name || achId;
        }
        
        function getAchievementDesc(achId) {
            const ach = ACHIEVEMENTS?.find(a => a.id === achId);
            return ach?.desc || '';
        }
        
        // Resource jm√©na - p≈ô√≠mo z RESOURCES
        function getResourceName(resourceId) {
            const res = RESOURCES?.find(r => r.id === resourceId);
            return res?.name || resourceId;
        }
        
        // Building jm√©na - p≈ô√≠mo z BUILDINGS
        function getBuildingName(buildingId) {
            const building = BUILDINGS?.find(b => b.id === buildingId);
            return building?.name || buildingId;
        }
        
        function getBuildingDesc(buildingId) {
            const building = BUILDINGS?.find(b => b.id === buildingId);
            return building?.desc || '';
        }
        
        // Funkce pro t() - p≈ôeklad text≈Ø
        function t(category, key) {
            return TRANSLATIONS?.cs?.[category]?.[key] || key;
        }
        
        // Zkratka pro UI p≈ôeklady
        function ui(key) {
            return t('ui', key);
        }
        
        function hasTranslation(category, key) {
            return TRANSLATIONS?.cs?.[category]?.[key] !== undefined;
        }
        
        // Funkce pro z√≠sk√°n√≠ aktu√°ln√≠ho jazyka
        function getLanguage() {
            return 'cs';
        }

        // === SAFE AREA DETECTION PRO MOBILY ===
        (function() {
            // Detekce v√Ω≈°ky syst√©mov√© navigace
            function updateSafeArea() {
                var root = document.documentElement;
                
                // Zkus z√≠skat safe-area-inset-bottom
                var safeBottom = parseInt(getComputedStyle(root).getPropertyValue('--sab') || '0');
                
                // Pokud CSS env() nefunguje, pou≈æij fallback
                if (!safeBottom) {
                    // Detekce podle pomƒõru obrazovky (mobily s gesture nav maj√≠ obvykle vysok√Ω pomƒõr)
                    var ratio = window.innerHeight / window.innerWidth;
                    if (ratio > 2) {
                        // Pravdƒõpodobnƒõ mobil s gesture navigation
                        safeBottom = 34;
                    } else if (ratio > 1.7) {
                        safeBottom = 20;
                    } else {
                        safeBottom = 10;
                    }
                }
                
                // Nastav CSS promƒõnn√©
                root.style.setProperty('--nav-bottom-padding', (safeBottom + 10) + 'px');
                root.style.setProperty('--main-bottom-padding', (safeBottom + 80) + 'px');
            }
            
            // Spus≈• p≈ôi naƒçten√≠ a p≈ôi zmƒõnƒõ orientace
            updateSafeArea();
            window.addEventListener('resize', updateSafeArea);
            window.addEventListener('orientationchange', updateSafeArea);
        })();
        
        // === MOBILE PUSH NOTIFICATIONS ===
        const MobileNotifications = {
            permission: 'default',
            enabled: false,
            swRegistration: null,
            
            init: function() {
                var self = this;
                
                if (!('Notification' in window)) {
                    console.log('Notifications not supported');
                    return false;
                }
                
                this.permission = Notification.permission;
                
                if (this.permission === 'granted') {
                    this.enabled = true;
                }
                
                // Registrace Service Worker pro PWA notifikace
                if ('serviceWorker' in navigator) {
                    // Vytvo≈ô inline service worker
                    const swCode = `
                        self.addEventListener('push', function(event) {
                            const data = event.data ? event.data.json() : {};
                            const title = data.title || 'Survival Hero';
                            const options = {
                                body: data.body || '',
                                icon: '/icon-192.png',
                                badge: '/icon-192.png',
                                tag: data.tag || 'survival-game',
                                renotify: true,
                                vibrate: [200, 100, 200]
                            };
                            event.waitUntil(self.registration.showNotification(title, options));
                        });
                        
                        self.addEventListener('notificationclick', function(event) {
                            event.notification.close();
                            event.waitUntil(clients.openWindow('/'));
                        });
                    `;
                    
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    navigator.serviceWorker.register(swUrl, { scope: '/' })
                        .then(function(reg) {
                            self.swRegistration = reg;
                            console.log('Service Worker registered for notifications');
                        })
                        .catch(function(err) {
                            console.log('SW registration failed:', err);
                        });
                }
                
                return this.enabled;
            },
            
            requestPermission: function() {
                var self = this;
                if (!('Notification' in window)) {
                    return Promise.resolve(false);
                }
                
                return Notification.requestPermission().then(function(result) {
                    self.permission = result;
                    self.enabled = result === 'granted';
                    console.log('Notification permission:', result);
                    
                    // Test notifikace
                    if (self.enabled) {
                        setTimeout(function() {
                            self.send('‚úÖ Notifikace aktivov√°ny!', {
                                body: 'Bude≈° dost√°vat upozornƒõn√≠ i kdy≈æ nen√≠ hra aktivn√≠.',
                                tag: 'test-notification'
                            });
                        }, 1000);
                    }
                    
                    return self.enabled;
                }).catch(function(e) {
                    console.log('Notification permission error:', e);
                    return false;
                });
            },
            
            send: function(title, options) {
                options = options || {};
                
                // Pos√≠lej i kdy≈æ je viditeln√° - pro testov√°n√≠
                // V produkci: if (!this.enabled || document.visibilityState === 'visible') return;
                if (!this.enabled) {
                    console.log('Notifications not enabled');
                    return;
                }
                
                console.log('Sending notification:', title);
                
                try {
                    // Zkus Service Worker notifikaci (funguje l√©pe na mobilu)
                    if (this.swRegistration) {
                        this.swRegistration.showNotification(title, {
                            body: options.body || '',
                            icon: '‚ò¢Ô∏è',
                            tag: options.tag || 'survival-game',
                            renotify: options.renotify || true,
                            silent: options.silent || false,
                            vibrate: [200, 100, 200]
                        });
                        return;
                    }
                    
                    // Fallback na klasick√© notifikace
                    var notification = new Notification(title, {
                        icon: '‚ò¢Ô∏è',
                        badge: '‚ò¢Ô∏è',
                        tag: options.tag || 'survival-game',
                        renotify: options.renotify || false,
                        silent: options.silent || false,
                        body: options.body || ''
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    setTimeout(function() { notification.close(); }, 5000);
                    
                    return notification;
                } catch (e) {
                    console.log('Notification error:', e);
                }
            },
            
            // Testovac√≠ funkce
            test: function() {
                this.send('üß™ Test notifikace', {
                    body: 'Pokud toto vid√≠≈°, notifikace funguj√≠!',
                    tag: 'test'
                });
            },
            
            notifyCompanionHungry: function(names) {
                this.send('üêï Hladov√≠ spoleƒçn√≠ci!', {
                    body: names + ' pot≈ôebuj√≠ j√≠dlo a vodu!',
                    tag: 'companion-hungry',
                    renotify: true
                });
            },
            
            notifyLowHealth: function() {
                this.send('‚ù§Ô∏è Kritick√© zdrav√≠!', {
                    body: 'Tv√© HP je velmi n√≠zk√©! Vyl√©ƒç se!',
                    tag: 'low-health',
                    renotify: true
                });
            },
            
            notifyLowHunger: function() {
                this.send('üçñ Um√≠r√°≈° hlady!', {
                    body: 'Rychle nƒõco snƒõz nebo zem≈ôe≈°!',
                    tag: 'low-hunger',
                    renotify: true
                });
            },
            
            notifyLowThirst: function() {
                this.send('üíß Um√≠r√°≈° ≈æ√≠zn√≠!', {
                    body: 'Rychle se napij nebo zem≈ôe≈°!',
                    tag: 'low-thirst',
                    renotify: true
                });
            },
            
            notifyRaid: function() {
                this.send('‚öîÔ∏è N√ÅJEZD NA OSADU!', {
                    body: 'Tv√° osada je pod √∫tokem! Vra≈• se a bra≈à ji!',
                    tag: 'raid',
                    renotify: true
                });
            },
            
            notifyTravelComplete: function(locationName) {
                this.send('üó∫Ô∏è Cesta dokonƒçena!', {
                    body: 'Dorazil jsi do: ' + locationName,
                    tag: 'travel-complete'
                });
            },
            
            notifyCaravan: function() {
                this.send('üê™ Karavana dorazila!', {
                    body: 'Obchodn√≠ karavana je ve tv√© osadƒõ!',
                    tag: 'caravan'
                });
            },
            
            notifyNewDay: function(day) {
                this.send('üåÖ Nov√Ω den!', {
                    body: 'Den ' + day + ' - Spoleƒçn√≠ci spot≈ôebovali j√≠dlo a vodu.',
                    tag: 'new-day'
                });
            },
            
            notifyTravelEvent: function(eventName, eventIcon) {
                this.send((eventIcon || '‚ùó') + ' Ud√°lost na cestƒõ!', {
                    body: eventName,
                    tag: 'travel-event',
                    renotify: true
                });
            },
            
            notifyLootFound: function(itemName, itemIcon) {
                this.send((itemIcon || 'üéÅ') + ' N√°lez!', {
                    body: 'Na≈°el jsi: ' + itemName,
                    tag: 'loot-found'
                });
            },
            
            notifyCombat: function(enemyName) {
                this.send('‚öîÔ∏è Souboj!', {
                    body: 'Narazil jsi na: ' + enemyName,
                    tag: 'combat',
                    renotify: true
                });
            }
        };
        
        // Inicializace notifikac√≠
        MobileNotifications.init();
        
        // === ANTI-CHEAT SYSTEM ===
        
        // Detekce DevTools
        let devToolsOpen = false;
        const devToolsCheck = () => {
            const threshold = 160;
            const widthThreshold = window.outerWidth - window.innerWidth > threshold;
            const heightThreshold = window.outerHeight - window.innerHeight > threshold;
            
            if (widthThreshold || heightThreshold) {
                if (!devToolsOpen) {
                    devToolsOpen = true;
                    console.log('%c‚ö†Ô∏è VAROV√ÅN√ç', 'color: red; font-size: 30px; font-weight: bold;');
                    console.log('%cTato konzole je urƒçena pro v√Ωvoj√°≈ôe.', 'font-size: 16px;');
                    console.log('%cPokud v√°s nƒõkdo po≈æ√°dal, abyste sem nƒõco vlo≈æili, je to podvod.', 'color: orange; font-size: 14px;');
                    console.log('%cManipulace s hrou m≈Ø≈æe po≈°kodit v√°≈° ulo≈æen√Ω postup!', 'color: red; font-size: 14px;');
                }
            } else {
                devToolsOpen = false;
            }
        };
        
        // Checksum pro kritick√© hodnoty
        function calculateChecksum(data) {
            let hash = 0;
            const str = JSON.stringify(data);
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }
        
        // Ulo≈æen√≠ checksumu p≈ôi zmƒõnƒõ stavu
        let lastValidChecksum = 0;
        let lastValidValues = {};
        
        function updateIntegrityCheck() {
            const criticalValues = {
                money: state.money,
                hp: state.char?.hp,
                maxHp: state.char?.maxHp,
                level: state.char?.level,
                xp: state.char?.xp
            };
            lastValidChecksum = calculateChecksum(criticalValues);
            lastValidValues = {...criticalValues};
        }
        
        // Kontrola integrity
        function verifyIntegrity() {
            if (!state.confirmed) return true; // P≈ôed potvrzen√≠m postavy nekontroluj
            
            const criticalValues = {
                money: state.money,
                hp: state.char?.hp,
                maxHp: state.char?.maxHp,
                level: state.char?.level,
                xp: state.char?.xp
            };
            
            // Detekce nerealistick√Ωch hodnot
            if (state.money > 1000000) {
                console.warn('üö® Detekov√°na anom√°lie: p≈ô√≠li≈° mnoho penƒõz:', state.money);
                // Resetuj na rozumnou hodnotu (ne na 0!)
                const safeValue = lastValidValues.money && lastValidValues.money < 1000000 
                    ? lastValidValues.money 
                    : 10000; // Fallback na 10k
                console.warn('üîß Pen√≠ze opraveny na:', safeValue);
                state.money = safeValue;
                return false;
            }
            
            if (state.char?.hp > state.char?.maxHp * 2) {
                console.warn('üö® Detekov√°na anom√°lie: p≈ô√≠li≈° mnoho HP');
                state.char.hp = state.char.maxHp;
                return false;
            }
            
            if (state.char?.level > 100) {
                console.warn('üö® Detekov√°na anom√°lie: p≈ô√≠li≈° vysok√Ω level');
                state.char.level = lastValidValues.level || 1;
                return false;
            }
            
            return true;
        }
        
        // ≈†ifrov√°n√≠ pro localStorage (s podporou Unicode)
        const encKey = 'P0st4p0_S3cr3t_K3y_2024!';
        
        function encryptData(data) {
            try {
                const str = JSON.stringify(data);
                // Pou≈æij base64 bez XOR pro kompatibilitu
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                console.error('Encrypt error:', e);
                return null;
            }
        }
        
        function decryptData(encrypted) {
            try {
                const str = decodeURIComponent(escape(atob(encrypted)));
                return JSON.parse(str);
            } catch (e) {
                console.error('Decrypt error:', e);
                return null;
            }
        }
        
        // === KONTROLA RE√ÅLN√âHO ƒåASU ===
        async function verifyRealTime() {
            const localTime = Date.now();
            const lastSaveTime = state.lastSaveTime || 0;
            const gameStartTime = state.time?.realStart || localTime;
            
            // 1. Kontrola zda lok√°ln√≠ ƒças nen√≠ v minulosti oproti ulo≈æen√≠
            if (lastSaveTime > 0 && localTime < lastSaveTime - 60000) {
                // Lok√°ln√≠ ƒças je v√≠c ne≈æ 1 minutu v minulosti = podez≈ôel√©
                console.warn('‚ö†Ô∏è Podez≈ôel√Ω ƒças: lok√°ln√≠ ƒças je star≈°√≠ ne≈æ posledn√≠ save');
                showTimeWarning('past', lastSaveTime - localTime);
                return;
            }
            
            // 2. Kontrola zda ƒças neskoƒçil p≈ô√≠li≈° dop≈ôedu (v√≠c ne≈æ 7 dn√≠)
            const timeSinceLastSave = localTime - lastSaveTime;
            if (lastSaveTime > 0 && timeSinceLastSave > 7 * 24 * 60 * 60 * 1000) {
                console.warn('‚ö†Ô∏è Dlouh√° prodleva od posledn√≠ho ulo≈æen√≠:', Math.floor(timeSinceLastSave / (24*60*60*1000)), 'dn√≠');
                // Toto je OK - hr√°ƒç jen dlouho nehr√°l
            }
            
            // 3. Zkus ovƒõ≈ôit ƒças online (pokud je dostupn√© Firebase)
            if (typeof firebaseDB !== 'undefined' && firebaseDB) {
                try {
                    const serverTimeRef = await firebaseDB.ref('.info/serverTimeOffset').once('value');
                    const offset = serverTimeRef.val() || 0;
                    const serverTime = localTime + offset;
                    
                    // Pokud je rozd√≠l vƒõt≈°√≠ ne≈æ 5 minut, varuj
                    if (Math.abs(offset) > 5 * 60 * 1000) {
                        console.warn('‚ö†Ô∏è Rozd√≠l mezi lok√°ln√≠m a serverov√Ωm ƒçasem:', Math.round(offset / 60000), 'minut');
                        
                        // Ulo≈æ spr√°vn√Ω offset pro pozdƒõj≈°√≠ pou≈æit√≠
                        state.serverTimeOffset = offset;
                    }
                    
                    console.log('‚úì ƒåas ovƒõ≈ôen: lok√°ln√≠=' + new Date(localTime).toLocaleTimeString() + 
                                ', server=' + new Date(serverTime).toLocaleTimeString() + 
                                ', offset=' + Math.round(offset/1000) + 's');
                } catch (e) {
                    console.log('‚ÑπÔ∏è Nelze ovƒõ≈ôit serverov√Ω ƒças (offline?)');
                }
            }
        }
        
        function showTimeWarning(type, diff) {
            const diffMins = Math.abs(Math.round(diff / 60000));
            const diffHours = Math.round(diffMins / 60);
            
            let message = '';
            if (type === 'past') {
                message = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚è∞</div>
                        <h3 style="color: #f44336;">Probl√©m s ƒçasem!</h3>
                        <p style="color: #888;">ƒåas tv√©ho za≈ô√≠zen√≠ je <strong>${diffHours > 0 ? diffHours + ' hodin' : diffMins + ' minut'}</strong> v minulosti oproti posledn√≠mu ulo≈æen√≠.</p>
                        <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #f44336;">
                            <p style="color: #ff9800; margin: 0; font-size: 0.9rem;">‚ö†Ô∏è Mo≈æn√© p≈ô√≠ƒçiny:</p>
                            <ul style="color: #888; text-align: left; margin: 0.5rem 0 0 1rem; font-size: 0.85rem;">
                                <li>≈†patnƒõ nastaven√Ω ƒças za≈ô√≠zen√≠</li>
                                <li>Zmƒõna ƒçasov√©ho p√°sma</li>
                                <li>Nƒõkdo jin√Ω hr√°l na tv√©m √∫ƒçtu</li>
                            </ul>
                        </div>
                        <p style="color: #888; font-size: 0.85rem;">Pros√≠m zkontroluj nastaven√≠ ƒçasu na sv√©m za≈ô√≠zen√≠.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; background: #4CAF50;">OK, rozum√≠m</button>
                `;
            }
            
            if (message) {
                showModal('‚è∞ Varov√°n√≠', message);
            }
        }
        
        // Inicializace anti-cheat syst√©mu (vol√° se a≈æ po naƒçten√≠ hry)
        function initAntiCheat() {
            // Spus≈• detekci DevTools - pou≈æ√≠v√°me safe interval pro spr√°vn√Ω cleanup
            safeSetInterval(devToolsCheck, 1000);
            
            // Pravideln√° kontrola integrity
            safeSetInterval(() => {
                if (state.confirmed) {
                    verifyIntegrity();
                }
            }, 5000);
        }
        
        // === VISUAL EFFECTS SYSTEM ===
        
        // Terminal ≈°um zvuk p≈ôi p≈ôepnut√≠
        let audioCtx = null;
        function getAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        }
        
        function playTerminalSound() {
            try {
                const ctx = getAudioContext();
                const bufferSize = ctx.sampleRate * 0.08;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * 0.2;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 2000;
                filter.Q.value = 1;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + 0.08);
            } catch (e) {}
        }
        
        // === COMBAT SOUNDS ===
        
        // Zvuk √∫deru/z√°sahu
        function playSoundHit(isCrit = false) {
            try {
                const ctx = getAudioContext();
                const duration = isCrit ? 0.15 : 0.1;
                
                // Noise burst pro "dopad"
                const bufferSize = ctx.sampleRate * duration;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const env = Math.exp(-i / (bufferSize * 0.2));
                    data[i] = (Math.random() * 2 - 1) * env;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = isCrit ? 800 : 500;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(isCrit ? 0.25 : 0.15, ctx.currentTime);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + duration);
            } catch (e) {}
        }
        
        // Zvuk st≈ôelby
        function playSoundGunshot() {
            try {
                const ctx = getAudioContext();
                
                // Ostr√Ω noise burst
                const bufferSize = ctx.sampleRate * 0.12;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const env = Math.exp(-i / (bufferSize * 0.05));
                    data[i] = (Math.random() * 2 - 1) * env;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 1000;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + 0.12);
            } catch (e) {}
        }
        
        // Zvuk meƒçe/seƒçn√© zbranƒõ
        function playSoundSlash() {
            try {
                const ctx = getAudioContext();
                
                const osc = ctx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 2000;
                filter.Q.value = 2;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.12, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } catch (e) {}
        }
        
        // Zvuk smrti nep≈ô√≠tele
        function playSoundEnemyDeath() {
            try {
                const ctx = getAudioContext();
                
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.3);
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) {}
        }
        
        // Zvuk z√°sahu hr√°ƒçe (bolest)
        function playSoundPlayerHit() {
            try {
                const ctx = getAudioContext();
                
                // N√≠zk√Ω "ugh" zvuk
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.15);
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.12, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
            } catch (e) {}
        }
        
        // Zvuk mine/tƒõ≈æk√° r√°na
        function playSoundMiss() {
            try {
                const ctx = getAudioContext();
                
                const bufferSize = ctx.sampleRate * 0.08;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const env = Math.exp(-i / (bufferSize * 0.3));
                    data[i] = (Math.random() * 2 - 1) * env * 0.3;
                }
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 2000;
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.08, ctx.currentTime);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                noise.start();
                noise.stop(ctx.currentTime + 0.08);
            } catch (e) {}
        }
        
        // Zvuk v√≠tƒõzstv√≠ v boji
        function playSoundVictory() {
            try {
                const ctx = getAudioContext();
                
                // V√≠tƒõzn√° fanf√°ra - t≈ôi t√≥ny
                [0, 0.15, 0.3].forEach((delay, i) => {
                    const osc = ctx.createOscillator();
                    osc.type = 'square';
                    osc.frequency.value = [262, 330, 392][i]; // C, E, G
                    
                    const gain = ctx.createGain();
                    gain.gain.setValueAtTime(0, ctx.currentTime + delay);
                    gain.gain.linearRampToValueAtTime(0.08, ctx.currentTime + delay + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + delay + 0.2);
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    osc.start(ctx.currentTime + delay);
                    osc.stop(ctx.currentTime + delay + 0.2);
                });
            } catch (e) {}
        }
        
        // Zvuk prohry/smrti
        function playSoundDefeat() {
            try {
                const ctx = getAudioContext();
                
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(30, ctx.currentTime + 0.8);
                
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.8);
            } catch (e) {}
        }
        
        // Hlavn√≠ funkce pro combat zvuky
        function playCombatSound(type, weaponType = 'melee') {
            switch(type) {
                case 'playerAttack':
                    if (weaponType === 'ranged' || weaponType === 'gun') {
                        playSoundGunshot();
                    } else {
                        playSoundSlash();
                    }
                    break;
                case 'playerHit':
                    playSoundPlayerHit();
                    break;
                case 'enemyHit':
                    playSoundHit(false);
                    break;
                case 'crit':
                    playSoundHit(true);
                    break;
                case 'miss':
                    playSoundMiss();
                    break;
                case 'enemyDeath':
                    playSoundEnemyDeath();
                    break;
                case 'victory':
                    playSoundVictory();
                    break;
                case 'defeat':
                    playSoundDefeat();
                    break;
            }
        }
        
        // Univerz√°ln√≠ scan efekt
        function triggerScanEffect() {
            const scan = document.createElement('div');
            scan.className = 'scan-overlay';
            document.body.appendChild(scan);
            // playTerminalSound(); // Odstranƒõno - ru≈°iv√Ω zvuk
            setTimeout(() => scan.remove(), 300);
        }
        
        // 1. Blik√°n√≠ p≈ôi n√≠zk√© HP
        let lowHpOverlay = null;
        function updateLowHpEffect() {
            const hpPercent = (state.hp / state.maxHp) * 100;
            if (hpPercent <= 25 && !lowHpOverlay) {
                lowHpOverlay = document.createElement('div');
                lowHpOverlay.className = 'low-hp-overlay';
                document.body.appendChild(lowHpOverlay);
            } else if (hpPercent > 25 && lowHpOverlay) {
                lowHpOverlay.remove();
                lowHpOverlay = null;
            }
        }
        
        // 2. Screen shake p≈ôi z√°sahu
        function triggerDamageShake() {
            const container = document.querySelector('.container');
            if (container) {
                container.classList.add('damage-shake');
                setTimeout(() => container.classList.remove('damage-shake'), 400);
            }
        }
        
        // 3. Radiaƒçn√≠ zkreslen√≠
        let radiationActive = false;
        function updateRadiationEffect() {
            const container = document.querySelector('.container');
            if (!container) return;
            
            // Pou≈æij WORLD_LOCATIONS nebo p≈ôeskoƒç pokud neexistuje
            if (typeof WORLD_LOCATIONS === 'undefined') return;
            
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world?.currentLocation);
            const isRadZone = loc && (loc.radiation > 0 || loc.danger >= 4);
            
            if (isRadZone && !radiationActive) {
                container.classList.add('radiation-zone');
                radiationActive = true;
            } else if (!isRadZone && radiationActive) {
                container.classList.remove('radiation-zone');
                radiationActive = false;
            }
        }
        
        // 4. Blesky p≈ôi bou≈ôce
        let stormFlashElement = null;
        let stormInterval = null;
        function updateStormEffect() {
            // Efekt bou≈ôe vypnut - ru≈°iv√Ω
            return;
        }
        
        // 5. Zelen√© probuzen√≠ p≈ôi naƒçten√≠
        function triggerBootEffect() {
            const scanBottom = document.createElement('div');
            scanBottom.className = 'scan-overlay';
            scanBottom.style.animationDuration = '0.6s';
            document.body.appendChild(scanBottom);
            
            const scanTop = document.createElement('div');
            scanTop.className = 'scan-overlay-top';
            scanTop.style.animationDuration = '0.6s';
            document.body.appendChild(scanTop);
            
            // playTerminalSound(); // Odstranƒõno - ru≈°iv√Ω zvuk
            
            setTimeout(() => {
                scanBottom.remove();
                scanTop.remove();
            }, 700);
        }
        
        // 6. Efekt p≈ôi smrti
        function triggerDeathEffect() {
            const container = document.querySelector('.container');
            if (container) {
                container.classList.add('death-screen');
            }
        }
        
        // 7. Level up z√°≈ôe
        function triggerLevelUpEffect() {
            const flash = document.createElement('div');
            flash.className = 'levelup-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 800);
        }
        
        // 8. N√°hodn√© mini glitche - VYPNUTO
        function startRandomGlitches() {
            // Disabled
        }
        
        // 9. Modal scan efekt
        function addModalScanEffect(modalContent) {
            // Efekt vypnut - ru≈°iv√Ω
            return;
        }
        
        // 10. Noƒçn√≠ re≈æim
        let nightOverlay = null;
        function updateNightEffect() {
            const hour = state.time ? state.time.hour : 12;
            const isNight = hour >= 21 || hour < 6;
            
            if (isNight && !nightOverlay) {
                nightOverlay = document.createElement('div');
                nightOverlay.className = 'night-overlay';
                document.body.appendChild(nightOverlay);
            } else if (!isNight && nightOverlay) {
                nightOverlay.style.opacity = '0';
                setTimeout(() => {
                    if (nightOverlay) {
                        nightOverlay.remove();
                        nightOverlay = null;
                    }
                }, 2000);
            }
        }
        
        // Inicializace v≈°ech efekt≈Ø
        function initAllEffects() {
            // triggerBootEffect(); // Odstranƒõno - ru≈°iv√Ω zelen√Ω efekt
            startRandomGlitches();
            
            // Pravideln√° kontrola efekt≈Ø
            setInterval(() => {
                updateLowHpEffect();
                updateRadiationEffect();
                updateStormEffect();
                updateNightEffect();
            }, 1000);
        }
        const VisualEffects = {
            init() {
                // Vytvo≈ô parallax pozad√≠
                const parallax = document.createElement('div');
                parallax.className = 'parallax-bg';
                document.body.prepend(parallax);
            },
            
            // Legacy funkce - nic nedƒõl√°
            startDustParticles() {},
            createDustParticle() {},
            
            screenShake(intensity = 'medium') {
                const container = document.querySelector('.container');
                if (!container) return;
                
                container.classList.add('screen-shake');
                setTimeout(() => container.classList.remove('screen-shake'), 400);
            },
            
            damageFlash(element) {
                if (!element) return;
                element.classList.add('damage-flash');
                setTimeout(() => element.classList.remove('damage-flash'), 300);
            },
            
            healPulse(element) {
                if (!element) return;
                element.classList.add('heal-pulse');
                setTimeout(() => element.classList.remove('heal-pulse'), 500);
            },
            
            createExplosion(x, y) {
                const explosion = document.createElement('div');
                explosion.innerHTML = 'üí•';
                explosion.style.cssText = `
                    position: fixed;
                    left: ${x}px;
                    top: ${y}px;
                    font-size: 3rem;
                    pointer-events: none;
                    z-index: 10000;
                    animation: explode 0.5s ease-out forwards;
                `;
                document.body.appendChild(explosion);
                setTimeout(() => explosion.remove(), 500);
            },
            
            toggleDust(enabled) {
                this.dustEnabled = enabled;
                if (!enabled) {
                    this.dustParticles.forEach(p => p.remove());
                    this.dustParticles = [];
                } else {
                    this.startDustParticles();
                }
            },
            
            toggleColorBlindMode(enabled) {
                document.body.classList.toggle('colorblind-mode', enabled);
            }
        };
        
        // Inicializuj visual effects po naƒçten√≠
        document.addEventListener('DOMContentLoaded', () => {
            // Check jestli u≈æivatel vytv√°≈ô√≠ novou postavu
            if (localStorage.getItem('creatingNewCharacter') === 'true') {
                window.creatingNewCharacter = true;
                localStorage.removeItem('creatingNewCharacter');
                console.log('üÜï Re≈æim vytv√°≈ôen√≠ nov√© postavy aktivn√≠');
            }
            
            setTimeout(() => VisualEffects.init(), 1000);
            setTimeout(() => initAllEffects(), 1500);
            setTimeout(() => initAntiCheat(), 2000);
            
            // Scroll to top button visibility
            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.addEventListener('scroll', () => {
                    const scrollBtn = document.getElementById('scrollToTop');
                    if (scrollBtn) {
                        if (mainEl.scrollTop > 300) {
                            scrollBtn.classList.add('visible');
                        } else {
                            scrollBtn.classList.remove('visible');
                        }
                    }
                });
            }
        });
        
        function scrollToTop() {
            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // === SOUND SYSTEM ===
        const SoundSystem = {
            context: null,
            enabled: true,
            initialized: false,
            
            init() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                } catch (e) {
                    console.log('Web Audio API not supported');
                    this.enabled = false;
                }
            },
            
            // Resume context on user interaction (required by browsers)
            async resume() {
                if (this.context && this.context.state === 'suspended') {
                    try {
                        await this.context.resume();
                        console.log('AudioContext resumed');
                    } catch (e) {
                        console.log('Failed to resume AudioContext');
                    }
                }
            },
            
            play(type) {
                if (!this.enabled || !this.context) return;
                
                // Try to resume if suspended
                if (this.context.state === 'suspended') {
                    this.context.resume();
                }
                
                const ctx = this.context;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                const now = ctx.currentTime;
                
                switch(type) {
                    case 'levelup':
                        // Ascending happy beeps
                        oscillator.frequency.setValueAtTime(523, now); // C
                        oscillator.frequency.setValueAtTime(659, now + 0.1); // E
                        oscillator.frequency.setValueAtTime(784, now + 0.2); // G
                        gainNode.gain.setValueAtTime(0.3, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                        oscillator.start(now);
                        oscillator.stop(now + 0.4);
                        break;
                        
                    case 'rare_item':
                        // Shimmering high tone
                        oscillator.frequency.setValueAtTime(1046, now); // High C
                        oscillator.frequency.exponentialRampToValueAtTime(1568, now + 0.3); // High G
                        gainNode.gain.setValueAtTime(0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                        oscillator.start(now);
                        oscillator.stop(now + 0.3);
                        break;
                        
                    case 'death':
                        // Descending sad tone
                        oscillator.frequency.setValueAtTime(440, now); // A
                        oscillator.frequency.exponentialRampToValueAtTime(220, now + 0.5); // Low A
                        gainNode.gain.setValueAtTime(0.3, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                        oscillator.start(now);
                        oscillator.stop(now + 0.5);
                        break;
                        
                    case 'quest_complete':
                        // Victory fanfare
                        oscillator.frequency.setValueAtTime(523, now); // C
                        oscillator.frequency.setValueAtTime(659, now + 0.1); // E
                        oscillator.frequency.setValueAtTime(523, now + 0.2); // C
                        oscillator.frequency.setValueAtTime(784, now + 0.3); // G
                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                        oscillator.start(now);
                        oscillator.stop(now + 0.5);
                        break;
                        
                    case 'combat_hit':
                        // Quick hit sound
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(200, now);
                        gainNode.gain.setValueAtTime(0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        oscillator.start(now);
                        oscillator.stop(now + 0.1);
                        break;
                        
                    case 'critical':
                        // Critical hit - powerful impact
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(400, now);
                        oscillator.frequency.setValueAtTime(200, now + 0.05);
                        oscillator.frequency.setValueAtTime(600, now + 0.1);
                        gainNode.gain.setValueAtTime(0.3, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        oscillator.start(now);
                        oscillator.stop(now + 0.2);
                        break;
                        
                    case 'damage':
                        // Taking damage - lower thud
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(150, now);
                        oscillator.frequency.exponentialRampToValueAtTime(80, now + 0.15);
                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                        oscillator.start(now);
                        oscillator.stop(now + 0.15);
                        break;
                        
                    case 'pickup':
                        // Quick pickup beep
                        oscillator.frequency.setValueAtTime(800, now);
                        gainNode.gain.setValueAtTime(0.15, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                        oscillator.start(now);
                        oscillator.stop(now + 0.15);
                        break;
                        
                    case 'error':
                        // Error buzz
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(150, now);
                        gainNode.gain.setValueAtTime(0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        oscillator.start(now);
                        oscillator.stop(now + 0.2);
                        break;
                        
                    case 'click':
                        // UI click
                        oscillator.frequency.setValueAtTime(600, now);
                        gainNode.gain.setValueAtTime(0.1, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                        oscillator.start(now);
                        oscillator.stop(now + 0.05);
                        break;
                        
                    case 'raid':
                        // Raid alarm
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(400, now);
                        oscillator.frequency.setValueAtTime(600, now + 0.15);
                        oscillator.frequency.setValueAtTime(400, now + 0.3);
                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                        oscillator.start(now);
                        oscillator.stop(now + 0.4);
                        break;
                }
            },
            
            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        };
        
        // Initialize sound system
        SoundSystem.init();
        
        // === GAME DATA ===
        // Funkce pro lokalizovan√° pohlav√≠
        function getGenders() {
            const names = {
                cs: { male: 'Mu≈æ', female: '≈Ωena' },
                en: { male: 'Male', female: 'Female' }
            };
            const lang = currentLang || 'cs';
            return {
                male: {
                    name: names[lang]?.male || names.cs.male,
                    icon: 'üë®',
                    desc: lang === 'en' ? 'Physically stronger and tougher' : 
                          lang === 'sk' ? 'Fyzicky silnej≈°√≠ a odolnej≈°√≠' : 'Fyzicky silnƒõj≈°√≠ a odolnƒõj≈°√≠',
                    bonuses: { str: 1, end: 1 },
                    special: lang === 'en' ? '+5% max HP' : '+5% max HP'
                },
                female: {
                    name: names[lang]?.female || names.cs.female,
                    icon: 'üë©',
                    desc: lang === 'en' ? 'More charismatic and perceptive' :
                          lang === 'sk' ? 'Charizmatickej≈°ia a vn√≠mavej≈°ia' : 'Charismatiƒçtƒõj≈°√≠ a vn√≠mavƒõj≈°√≠',
                    bonuses: { lck: 1, per: 1 },
                    special: lang === 'en' ? '+10% better shop prices' : '+10% lep≈°√≠ ceny v obchodƒõ'
                }
            };
        }
        
        const GENDERS = {
            male: {
                name: 'Mu≈æ',
                name_en: 'Male',
                icon: 'üë®',
                desc: 'Fyzicky silnƒõj≈°√≠ a odolnƒõj≈°√≠',
                bonuses: {
                    str: 1,
                    end: 1
                },
                special: '+5% max HP'
            },
            female: {
                name: '≈Ωena',
                name_en: 'Female',
                icon: 'üë©',
                desc: 'Charismatiƒçtƒõj≈°√≠ a vn√≠mavƒõj≈°√≠',
                bonuses: {
                    lck: 1,
                    per: 1
                },
                special: '+10% lep≈°√≠ ceny v obchodƒõ'
            }
        };
        
        const CLASSES = {
            // === BOJOV√â T≈ò√çDY ===
            raider: { 
                name: 'N√°jezdn√≠k', 
                icon: '‚öîÔ∏è', 
                desc: 'Brut√°ln√≠ bojovn√≠k z pustiny', 
                ability: '+25% damage v boji',
                passive: 'Rage: Pod 30% HP +40% damage',
                weapon: { name: 'Palc√°t', icon: 'üî®', dmg: 12 },
                bonuses: { str: 2, end: 1 },
                color: '#c62828'
            },
            berserker: { 
                name: 'Berserkr', 
                icon: 'ü™ì', 
                desc: '≈†√≠len√Ω v√°leƒçn√≠k bez strachu', 
                ability: '+40% damage, -25% obrana',
                passive: 'Frenzy: Ka≈æd√Ω kill +8% damage (max 5 stack≈Ø, 45s)',
                weapon: { name: 'Bojov√° sekera', icon: 'ü™ì', dmg: 15 },
                bonuses: { str: 3 },
                color: '#b71c1c'
            },
            
            // === OBRANN√â T≈ò√çDY ===
            survivor: { 
                name: 'P≈ôe≈æiv≈°√≠', 
                icon: 'üõ°Ô∏è', 
                desc: 'Otrl√Ω veter√°n apokalypsy', 
                ability: '+50 max HP',
                passive: 'Last Stand: 20% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫der s 1 HP',
                weapon: { name: 'Sekera', icon: 'ü™ì', dmg: 9 },
                bonuses: { end: 2, str: 1 },
                color: '#388e3c'
            },
            tank: { 
                name: 'Tank', 
                icon: 'üèãÔ∏è', 
                desc: 'Nepr≈Øst≈ôeln√° zeƒè masa', 
                ability: '+80 max HP, -15% rychlost',
                passive: 'Fortress: Blokuje 25% p≈ô√≠choz√≠ho damage',
                weapon: { name: '≈†t√≠t', icon: 'üõ°Ô∏è', dmg: 6 },
                bonuses: { end: 3 },
                color: '#1565c0'
            },
            
            // === SKAUTSK√â T≈ò√çDY ===
            stalker: { 
                name: 'Stopa≈ô', 
                icon: 'üéØ', 
                desc: 'Tich√Ω lovec st√≠n≈Ø', 
                ability: '-30% spot≈ôeba zdroj≈Ø',
                passive: 'Stealth: 50% ≈°ance vyhnout se p≈ôepaden√≠',
                weapon: { name: 'Luk', icon: 'üèπ', dmg: 10 },
                bonuses: { agi: 2, per: 1 },
                color: '#5d4037'
            },
            assassin: { 
                name: 'Assassin', 
                icon: 'üó°Ô∏è', 
                desc: 'Mistr rychl√Ωch zabit√≠', 
                ability: '+30% crit chance',
                passive: 'Execute: Kritick√Ω z√°sah dƒõl√° 2.5x damage',
                weapon: { name: 'D√Ωky', icon: 'üó°Ô∏è', dmg: 8 },
                bonuses: { agi: 3 },
                color: '#263238'
            },
            
            // === PODP≈ÆRN√â T≈ò√çDY ===
            medic: { 
                name: 'Poln√≠ Medik', 
                icon: '‚öïÔ∏è', 
                desc: 'Expert na p≈ôe≈æit√≠ a l√©ƒçbu', 
                ability: 'L√©ƒçiva +50% efektivnƒõj≈°√≠',
                passive: 'Regeneration: +3 HP za minutu, +10% heal v boji',
                weapon: { name: 'Skalpel', icon: 'üó°Ô∏è', dmg: 6 },
                bonuses: { int: 2, end: 1 },
                color: '#d32f2f'
            },
            alchemist: { 
                name: 'Alchymista', 
                icon: '‚öóÔ∏è', 
                desc: 'Mistr lektvar≈Ø a jed≈Ø', 
                ability: 'Lektvary +100% efekt, trvaj√≠ 2x d√©le',
                passive: 'Poison: √ötoky zp≈Øsobuj√≠ otravu (8 DOT)',
                weapon: { name: 'Jedov√Ω n≈Ø≈æ', icon: 'üî™', dmg: 7 },
                bonuses: { int: 3 },
                color: '#7b1fa2'
            },
            
            // === SBƒöRAƒåSK√â T≈ò√çDY ===
            scavenger: { 
                name: 'Sbƒõraƒç', 
                icon: 'üîç', 
                desc: 'Specialista na hled√°n√≠ zdroj≈Ø', 
                ability: '+50% ≈°ance naj√≠t p≈ôedmƒõty',
                passive: 'Lucky Find: 15% ≈°ance na dvojit√Ω loot',
                weapon: { name: 'Rezav√Ω N≈Ø≈æ', icon: 'üî™', dmg: 5 },
                bonuses: { per: 2, agi: 1 },
                color: '#ff9800'
            },
            hunter: { 
                name: 'Lovec', 
                icon: 'üèπ', 
                desc: 'Mistr lovu a p≈ô√≠rody', 
                ability: '+100% loot ze zv√≠≈ôat',
                passive: 'Tracker: Vid√≠≈° zv√≠≈ôata na mapƒõ, +20% crit na zv√≠≈ôata',
                weapon: { name: 'Loveck√Ω luk', icon: 'üèπ', dmg: 11 },
                bonuses: { per: 3 },
                color: '#33691e'
            },
            
            // === TECHNICK√â T≈ò√çDY ===
            engineer: { 
                name: 'Mechanik', 
                icon: 'üîß', 
                desc: 'Technik a vyn√°lezce', 
                ability: 'Crafting -50% surovin',
                passive: 'Repair: Zbranƒõ a zbroje se neniƒç√≠, +15% DMG s craftƒõn√Ωmi zbranƒõmi',
                weapon: { name: 'Kl√≠ƒç', icon: 'üîß', dmg: 7 },
                bonuses: { int: 2, str: 1 },
                color: '#455a64'
            },
            demolitionist: { 
                name: 'Demoliƒç√°≈ô', 
                icon: 'üí£', 
                desc: 'Expert na v√Ωbu≈°niny', 
                ability: 'V√Ωbuchy +100% damage',
                passive: 'Boom: 12% ≈°ance na AoE damage p≈ôi √∫toku (40% splash)',
                weapon: { name: 'Z√°paln√° bomba', icon: 'üî•', dmg: 14 },
                bonuses: { str: 2, int: 1 },
                color: '#e65100'
            },
            
            // === SPECI√ÅLN√ç T≈ò√çDY ===
            trader: { 
                name: 'Obchodn√≠k', 
                icon: 'üí∞', 
                desc: 'Charismatick√Ω dealer', 
                ability: '-30% ceny v obchodech, +10% ≈°ance na rare v obchodech',
                passive: 'Barter: Prodej za +50% ceny, NPC d√°vaj√≠ lep≈°√≠ questy',
                weapon: { name: 'Revolver', icon: 'üî´', dmg: 8 },
                bonuses: { lck: 3 },
                color: '#ffd600'
            },
            nomad: { 
                name: 'Nom√°d', 
                icon: 'üèúÔ∏è', 
                desc: 'Pou≈°tn√≠ tul√°k', 
                ability: '-5% ƒças cestov√°n√≠',
                passive: 'Endurance: ≈Ω√≠ze≈à a hlad kles√° 50% pomaleji',
                weapon: { name: '≈†avle', icon: '‚öîÔ∏è', dmg: 10 },
                bonuses: { end: 1, agi: 2 },
                color: '#8d6e63'
            },
            mutant: { 
                name: 'Mutant', 
                icon: '‚ò¢Ô∏è', 
                desc: 'Ob≈ô√≠ zmutovan√Ω p≈ôe≈æiv≈°√≠', 
                ability: 'Imunn√≠ na radiaci, +15% damage v rad z√≥n√°ch, +10 p≈ôirozen√° obrana',
                passive: 'Regenerace: +3 HP p≈ôi z√°sahu, dr√°py +20 DMG jako z√°lo≈æn√≠ zbra≈à',
                restrictions: 'Nem≈Ø≈æe nosit brnƒõn√≠ ani helmy (p≈ô√≠li≈° velk√Ω)',
                weapon: { name: 'Mutant√≠ dr√°py', icon: 'ü¶é', dmg: 20 },
                bonuses: { end: 3, str: 3 },
                baseDefense: 10,
                color: '#76ff03'
            },
            psychic: { 
                name: 'Psychik', 
                icon: 'üîÆ', 
                desc: 'Ment√°ln√≠ schopnosti', 
                ability: 'Vid√≠≈° skryt√© lokace na mapƒõ',
                passive: 'Mind Control: 15% ≈°ance ≈æe nep≈ô√≠tel uteƒçe nebo se omr√°ƒç√≠',
                weapon: { name: 'Psychick√° ƒçepel', icon: 'üó°Ô∏è', dmg: 9 },
                bonuses: { int: 2, lck: 1 },
                color: '#aa00ff'
            }
        };
        
        // Funkce pro z√≠sk√°n√≠ lokalizovan√Ωch atribut≈Ø
        function getAttrs() {
            const names = {
                cs: { str: 'S√≠la', end: 'V√Ωdr≈æ', agi: 'Obratnost', per: 'Vn√≠m√°n√≠', int: 'Inteligence', lck: '≈†tƒõst√≠' },
                en: { str: 'Strength', end: 'Endurance', agi: 'Agility', per: 'Perception', int: 'Intelligence', lck: 'Luck' }
            };
            const lang = currentLang || 'cs';
            const n = names[lang] || names.cs;
            return {
                // Fyzick√© atributy
                str: { 
                    name: n.str, 
                    icon: 'üí™', 
                    desc: lang === 'en' ? '+2 damage per point' : '+2 damage za bod',
                    effect: 'damage',
                    perPoint: 2
                },
                end: { 
                    name: n.end, 
                    icon: '‚ù§Ô∏è', 
                    desc: lang === 'en' ? '+10 max HP per point' : '+10 max HP za bod',
                    effect: 'maxHp',
                    perPoint: 10
                },
                agi: { 
                    name: n.agi, 
                    icon: '‚ö°', 
                    desc: lang === 'en' ? '+5% speed, +2% dodge' : '+5% rychlost, +2% √∫hyb',
                    effect: 'speed',
                    perPoint: 0.05
                },
                
                // Ment√°ln√≠ atributy
                per: { 
                    name: n.per, 
                    icon: 'üëÅÔ∏è', 
                    desc: lang === 'en' ? '+5% loot, +3% crit' : '+5% loot, +3% crit',
                    effect: 'loot',
                    perPoint: 0.05
                },
                int: { 
                    name: n.int, 
                    icon: 'üß†', 
                    desc: lang === 'en' ? '+10% XP, better crafting' : '+10% XP, lep≈°√≠ crafting',
                    effect: 'xp',
                    perPoint: 0.10
                },
                lck: { 
                    name: n.lck, 
                    icon: 'üçÄ', 
                    desc: lang === 'en' ? '+3% rare loot, +2% crit' : '+3% vz√°cn√Ω loot, +2% crit',
                    effect: 'luck',
                    perPoint: 0.03
                }
            };
        }
        
        // Pro zpƒõtnou kompatibilitu
        const ATTRS = {
            // Fyzick√© atributy
            str: { 
                name: 'S√≠la', 
                icon: 'üí™', 
                desc: '+2 damage za bod',
                effect: 'damage',
                perPoint: 2
            },
            end: { 
                name: 'V√Ωdr≈æ', 
                icon: '‚ù§Ô∏è', 
                desc: '+10 max HP za bod',
                effect: 'maxHp',
                perPoint: 10
            },
            agi: { 
                name: 'Obratnost', 
                icon: '‚ö°', 
                desc: '+5% rychlost, +2% √∫hyb',
                effect: 'speed',
                perPoint: 0.05
            },
            
            // Ment√°ln√≠ atributy
            per: { 
                name: 'Vn√≠m√°n√≠', 
                icon: 'üëÅÔ∏è', 
                desc: '+5% loot, +3% crit',
                effect: 'loot',
                perPoint: 0.05
            },
            int: { 
                name: 'Inteligence', 
                icon: 'üß†', 
                desc: '+10% XP, lep≈°√≠ crafting',
                effect: 'xp',
                perPoint: 0.10
            },
            lck: { 
                name: '≈†tƒõst√≠', 
                icon: 'üçÄ', 
                desc: '+3% vz√°cn√Ω loot, +2% crit',
                effect: 'luck',
                perPoint: 0.03
            }
        };
        
        // Funkce pro v√Ωpoƒçet bonus≈Ø z atribut≈Ø
        function getAttrBonus(attr) {
            const base = state.char.attrs[attr] || 5;
            const attrData = ATTRS[attr];
            if (!attrData) return 0;
            return (base - 5) * attrData.perPoint; // Bonus nad base 5
        }
        
        // === HUMORN√â TEXTY (Fallout style) ===
        const HUMOR = {
            // Pasti
            trap: [
                "≈†l√°pl jsi do pasti! Nƒõkdo ji nastavil na idioty. Funguje skvƒõle.",
                "Past! Kdo sakra d√°v√° medvƒõd√≠ past do supermarketu?!",
                "Dr√°tƒõn√° past ti elegantnƒõ roz≈ô√≠zla kalhoty. A nohu. Hlavnƒõ nohu.",
                "Gratuluji, na≈°el jsi past. Bohu≈æel nohou.",
                "Past sklapla. Tv√° hrdost utrpƒõla v√≠c ne≈æ tvoje noha.",
                "Na≈°el jsi skrytou past! Plot twist: Ona na≈°la tebe.",
                "Nƒõkdo tu nechal d√°rek. Bol√≠ to.",
                "Past 1, Ty 0. Zkus to p≈ô√≠≈°tƒõ oƒçima.",
                "P≈ôedv√°leƒçn√° past st√°le funguje. Kvalita!",
                "Tv√° noha pr√°vƒõ objevila lok√°ln√≠ atrakci.",
                "Krok, cvak, au. V tomto po≈ôad√≠.",
                "Na≈°el jsi past. Tv√° noha nesouhlas√≠ s metodou.",
                "Nƒõkdo mƒõl moc ƒçasu a dr√°tu. Ty m√°≈° m√©nƒõ krve.",
                "Past aktivov√°na! Achievement unlocked: Idiot.",
                "Detekce past√≠: F. Bolest: A+."
            ],
            
            // Kr√°de≈æe - kdy≈æ Tƒö okradli
            theftFail: [
                "Sakra! Mƒõl jsi l√©pe hl√≠dat kapsy.",
                "Zlodƒõj byl rychlej≈°√≠. A ≈°ikovnƒõj≈°√≠.",
                "Okraden! Aspo≈à m√°≈° d≈Øvod k paranoi.",
                "Tvoje pen√≠ze maj√≠ nov√©ho majitele.",
                "Kapsy pr√°zdnƒõj≈°√≠ ne≈æ tv≈Øj v√Ωraz.",
                "Nƒõkdo ti pr√°vƒõ ulehƒçil invent√°≈ô.",
                "Profesion√°l! (On, ne ty.)",
                "Mƒõl jsi d√°vat pozor. Teƒè je pozdƒõ.",
                "Zlodƒõj 1, Tv√° ostra≈æitost 0.",
                "Tv√© pen√≠ze utekly. S pomoc√≠.",
                "Pickpocket skill: 100. Tv√° pozornost: 0.",
                "Na≈°el ses. Bez penƒõz.",
                "Karma? Ne, jen ≈°ikovn√© prsty cizince."
            ],
            
            // Smrt nep≈ô√°tel
            kill: [
                "je mrtv√Ω. Nemƒõl si vyb√≠rat tuhle kari√©ru.",
                "ode≈°el na vƒõƒçnost. Bez doporuƒçen√≠.",
                "u≈æ netr√°p√≠. R.I.P. = Rest In Pieces.",
                "padl. Gravitace opƒõt v√≠tƒõz√≠.",
                "je po nƒõm. Dal≈°√≠ z√°kazn√≠k pro zdej≈°√≠ krysy.",
                "skonƒçil. P≈ô√≠roda dƒõkuje za recyklaci.",
                "zem≈ôel jak ≈æil - blbƒõ.",
                "u≈æ nebude obtƒõ≈æovat. Nikdy.",
                "ode≈°el. Poslal jsi ho do d≈Øchodu. Permanentn√≠ho.",
                "je toast. Doslova pokud m√°≈° plamenomet.",
                "se rozpadl na souƒç√°stky. Neopraviteln√©.",
                "obdr≈æel fat√°ln√≠ chybu. Nelze restartovat.",
                "se odpojil. Permanentnƒõ.",
                "dostal rychlokurz anatomie. Zevnit≈ô.",
                "p≈ôestal existovat. Jak poetick√©.",
                "na≈°el klid. A 6 stop pod zem√≠.",
                "zmƒõnil stav na 'mrtv√Ω'. Update complete.",
                "ode≈°el do offline re≈æimu. Nav≈ædy."
            ],
            
            // J√≠dlo - divn√©
            foodWeird: [
                "Snƒõdl jsi 200 let starou konzervu. Nem√°≈° co ztratit.",
                "Maso nezn√°m√©ho p≈Øvodu. Chu≈•? Taky nezn√°m√°.",
                "Recept babiƒçky. Pokud babiƒçka byla kanibal.",
                "Jedl√©? Technicky ano. Chutn√©? Neptej se.",
                "Tv≈Øj ≈æaludek tƒõ pr√°vƒõ odsoudil k smrti.",
                "Expirov√°no p≈ôed v√°lkou. Asi. Mo≈æn√°. Kdo v√≠.",
                "Chutnalo to jako l√≠tost a zka≈æen√© sny.",
                "Gordon Ramsay by plakal. Ty taky, ale z jin√Ωch d≈Øvod≈Ø.",
                "Nutriƒçn√≠ hodnota: Existuje. Asi.",
                "Snƒõdl jsi to. Proƒç? S√°m nev√≠≈°.",
                "Mystery meat! Chu≈• p≈ôekvapen√≠. A bakteri√≠.",
                "Konzervovan√° nostalgie. A salmonela.",
                "Jedl jsi hor≈°√≠. Asi. Doufej.",
                "Tv√© chu≈•ov√© poh√°rky podaly rezignaci.",
                "To bylo j√≠dlo? Tv≈Øj ≈æaludek m√° pochybnosti."
            ],
            
            // Hlad
            hunger: [
                "Tv≈Øj ≈æaludek hraje symfonii um√≠raj√≠c√≠ch velryb.",
                "Tak hladov√Ω, ≈æe i ten mutant vypad√° chutnƒõ.",
                "Posledn√≠ j√≠dlo: P≈ôed 2 dny. P≈ô√≠≈°t√≠: Kdy najde≈°.",
                "Hlad level: Se≈æral bych vlastn√≠ botu.",
                "Tv√° tr√°vic√≠ soustava podala v√Ωpovƒõƒè.",
                "≈Ωaludek: 'Hele, pamatuje≈° si j√≠dlo? J√° taky ne.'",
                "Hladovƒõn√≠ jako ≈æivotn√≠ styl. Nevolunt√©rnƒõ.",
                "J√≠dlo je p≈ôece≈àovan√©. ≈ò√≠k√° tvoje pr√°zdn√© b≈ôicho.",
                "Kruƒç√≠ ti v b≈ôi≈°e jako motor od tanku.",
                "Tv√© vnit≈ônosti hraj√≠ heavy metal."
            ],
            
            // Radiace
            radiation: [
                "Svƒõt√©lkuje≈°! Na p√°rty bys byl hvƒõzda.",
                "Dal≈°√≠ d√°vka radiace. Mo≈æn√° z√≠sk√°≈° superschopnosti. Asi ne.",
                "Tvoje vlasy: 'Tak j√° jdu, ƒçau.'",
                "Geiger ≈ô√≠k√°, ≈æe jsi top. Doktor by ≈ôekl nƒõco jin√©ho.",
                "Radiace tƒõ objala jako star√° zn√°m√°. Jedovat√° zn√°m√°.",
                "Sv√≠t√≠≈° ve tmƒõ! Romantick√© a smrteln√©.",
                "Oz√°≈ôen! Evoluce za 5 minut. Darwin by plakal.",
                "Gratulujeme k d√°vce vitam√≠nu R(adiace)!",
                "Tv√© bu≈àky pr√°vƒõ ≈ôekly 'what the f***'.",
                "Dal≈°√≠ krok k tomu st√°t se lucernou.",
                "Z√°≈ô√≠≈°! Doslova. A ne v dobr√©m smyslu.",
                "Tv√° DNA pr√°vƒõ provedla jazz improvizaci.",
                "Bonus radiace! Tv√© org√°ny nejsou nad≈°en√©.",
                "Geiger counter goes brrrrr.",
                "Oz√°≈ôen a neinformov√°n. Klasika."
            ],
            
            // Loot - nic
            lootEmpty: [
                "Pr√°zdn√©. Jako tv≈Øj bankovn√≠ √∫ƒçet p≈ôed v√°lkou.",
                "Nic. Nƒõkdo tu byl rychlej≈°√≠. Nebo tu nikdy nic nebylo.",
                "Na≈°el jsi prach, zklam√°n√≠ a existenci√°ln√≠ krizi.",
                "Obsah: Vzduch a zklam√°n√≠.",
                "Pr√°zdnƒõj≈°√≠ ne≈æ sliby politik≈Ø.",
                "Nic. Absolutn√≠, kosmick√© nic.",
                "Loot: 404 Not Found.",
                "Nƒõkdo tu uklidil. V apokalypse. V√°≈ænƒõ.",
                "Pr√°zdno. Vakuum. Void. Nic.",
                "Nalezeno: Prach. Hodnƒõ prachu.",
                "Expected loot: Something. Actual loot: Nothing.",
                "Pr√°zdn√© jako tv√© nadƒõje.",
                "Zero. Zilch. Nada. Nic."
            ],
            
            // Loot - bordel
            lootJunk: [
                "Nalezeno: Hromada sraƒçek a jedna funkƒçn√≠ tu≈æka.",
                "Jackpot! ...pokud sb√≠r√°≈° rezav√© plechovky.",
                "Poklad! Pro nƒõkoho, kdo sb√≠r√° odpadky.",
                "Wow, tolik... nevyu≈æiteln√Ωch vƒõc√≠.",
                "Sbƒõratel odpadu by byl v ext√°zi.",
                "Technicky je to loot. Technicky.",
                "Haraburd√≠ deluxe edition.",
                "Nƒõkdo tohle schoval. Proƒç?",
                "Retro odpad. Vintage smet√≠.",
                "Sb√≠r√°≈° bordel? Tak se raduj!"
            ],
            
            // Loot - dobr√Ω
            lootGood: [
                "Svat√Ω gr√°l pustiny: Nƒõco u≈æiteƒçn√©ho!",
                "Na≈°el jsi nƒõco dobr√©ho! Zapi≈° do kroniky.",
                "Loot goblini by byli hrd√≠.",
                "Koneƒçnƒõ nƒõco, co nen√≠ tot√°ln√≠ odpad!",
                "Jackpot! Skuteƒçn√Ω, tentokr√°t!",
                "RNG bohov√© se usm√°li!",
                "V√°noce p≈ôi≈°ly brzy!",
                "Ko≈ôist! A u≈æiteƒçn√°!",
                "Nƒõkdo tu nechal poklad. D√≠ky!",
                "≈†tƒõst√≠ existuje. D≈Økaz v ruce."
            ],
            
            // Vstup do lokac√≠
            locations: {
                obchod: "Otev≈ôeno 24/7. U≈æ 200 let bez person√°lu.",
                nemocnice: "Vstup na vlastn√≠ nebezpeƒç√≠. Doktor mo≈æn√° p≈ôe≈æil. Jako ghoul.",
                tovarna: "Kde se sny mƒõnily na produkty. Teƒè se mƒõn√≠ v tetanus.",
                kostel: "B≈Øh mo≈æn√° odpou≈°t√≠. Mutanti v kryptƒõ ne.",
                skola: "Vzdƒõl√°n√≠ je d≈Øle≈æit√©. Kulky taky.",
                byt: "Domov nƒõkoho. Teƒè domov prachu a vzpom√≠nek.",
                sklep: "Temn√Ω, vlhk√Ω, pln√Ω p≈ôekvapen√≠. Vƒõt≈°inou nemil√Ωch."
            },
            
            // Obchodn√≠k dialogy
            trader: [
                "V√≠tej! Kup nƒõco nebo vypadni. Nejl√≠p oboj√≠.",
                "Ceny jsou koneƒçn√©. Jako vƒõt≈°ina m√Ωch z√°kazn√≠k≈Ø.",
                "Slevu? Ha! Dobrej vtip. M√°≈° nƒõco na prodej?",
                "Cash only. Karty neberem od roku... no, od v≈ædycky.",
                "Nakupuj, nebo se koukej. Ale neo≈°ah√°vej zbo≈æ√≠.",
                "Kvalitn√≠ zbo≈æ√≠! Vƒõt≈°inou. Nƒõkdy. Obƒças.",
                "V√≠t√°m! Pen√≠ze nahoru, ot√°zky dol≈Ø.",
                "Z√°kazn√≠k je kr√°l. S pr√°zdnou kapsou je ≈æebr√°k.",
                "M√°m co pot≈ôebuje≈°. Za cenu co nechce≈°.",
                "Nakup nebo uhni. ƒåas jsou pen√≠ze.",
                "V≈°echno na prodej. I moje babiƒçka. Vtip. Mo≈æn√°."
            ],
            
            // Doktor dialogy
            doctor: [
                "Nem√°m anestezii, ale m√°m kus d≈ôeva na kous√°n√≠.",
                "Co tƒõ bol√≠? V≈°echno? Typick√©.",
                "Progn√≥za: Bude≈° ≈æ√≠t. Mo≈æn√°. Zaplat√≠≈° p≈ôedem.",
                "Tohle bude bolet. Tebe v√≠c ne≈æ mƒõ.",
                "Jsem doktor, ne kouzeln√≠k. Ale zkus√≠m to.",
                "Vidƒõl jsem hor≈°√≠. Ale ne o moc.",
                "Operace? Jasnƒõ. Kde je n≈Ø≈æ od chleba?",
                "Diagn√≥za: ≈Ωije≈°. L√©ƒçba: Pla≈•.",
                "Neboj, tohle jsem dƒõlal u≈æ dvakr√°t. Jednou √∫spƒõ≈°nƒõ.",
                "V√Ωbornƒõ, dal≈°√≠ pacient! M√°≈° poji≈°tƒõn√≠? Vtip."
            ],
            
            // Noƒçn√≠ ud√°losti
            night: [
                "Sly≈°√≠≈° kroky. Mo≈æn√° mutant. Mo≈æn√° v√≠tr. Mo≈æn√° paranoie.",
                "Nƒõco se h√Ωbe ve tmƒõ. Tvoje p≈ôedstavivost? Doufejme.",
                "Hvƒõzdy jsou kr√°sn√©. Radiace je rozsv√≠tila.",
                "Noc je temn√° a pln√°... no, v≈°eho mo≈æn√©ho.",
                "Ka≈æd√Ω zvuk = potenci√°ln√≠ smrt. Dobrou noc!",
                "Tma. Ticho. A ten pocit, ≈æe nejsi s√°m.",
                "Noƒçn√≠ smƒõna. Nep≈ô√°tel√© maj√≠ v√Ωhodu.",
                "Ve tmƒõ jsou v≈°echny koƒçky ≈°ed√©. A nebezpeƒçn√©.",
                "Mƒõs√≠c sv√≠t√≠. Mutanti taky.",
                "Noc je mlad√°. Ty mo≈æn√° nebude≈° star√Ω.",
                "Ticho p≈ôed bou≈ô√≠. Nebo p≈ôed √∫tokem.",
                "Vid√≠≈° st√≠ny. Nƒõkter√© vid√≠ tebe."
            ],
            
            // Zvl√°≈°tn√≠ n√°lezy
            finds: [
                "Na≈°el jsi kostru obj√≠maj√≠c√≠ pr√°zdnou l√°hev whisky. Mood.",
                "Kostra sed√≠ na z√°chodƒõ. Zem≈ôel jak ≈æil.",
                "Nalezena cedule: 'Den 1: V≈°echno bude ok.' Nebyla.",
                "Den√≠k: 'Den 47 - sousedi u≈æ nevon√≠, ale jsou v√Ω≈æivn√≠.'",
                "N√°pis na zdi: 'Byl jsem tu. Teƒè nejsem. RIP.'",
                "Fotka rodiny. V≈°ichni se usm√≠vaj√≠. D√°vno.",
                "Seznam √∫kol≈Ø: 1) P≈ôe≈æ√≠t. (nedokonƒçeno)",
                "Posledn√≠ SMS: 'Miluji tƒõ. P≈ôijdu dom...' (nedoruƒçeno)",
                "Den√≠k: 'Den 1: Jsem optimista!' Den 200: (pr√°zdn√© str√°nky)",
                "Nalezena pozn√°mka: 'Pokud tohle ƒçte≈°, ut√≠kej.'",
                "Foto psa. Na rubu: 'Jedin√Ω p≈ô√≠tel.' Smutn√©.",
                "Kresba d√≠tƒõte: Domeƒçek, slun√≠ƒçko, houba... atomov√°.",
                "N√°pis: 'Zde bydlel ≈°tƒõst√≠. Odstƒõhovalo se.'",
                "Kostra s den√≠kem: 'Jsem fajn, jen odpoƒç√≠v√°m...'"
            ],
            
            // Mutace
            mutation: [
                "Gratuluji k mutaci! Matka p≈ô√≠roda ti pos√≠l√° 'd√°rek'.",
                "Nov√° mutace! Tv√© tƒõlo si ≈ô√≠k√°: 'Dr≈æte mi pivo.'",
                "Zmutoval jsi! Aspo≈à bude≈° zaj√≠mav√Ω na poh≈ôbu.",
                "Evoluce za 5 minut. Darwin by plakal. Nebo aplaudoval.",
                "Nov√° funkce odemƒçena! Vedlej≈°√≠ efekty se mohou li≈°it.",
                "Mutace! Tv√© DNA pr√°vƒõ ≈ôeklo 'yolo'.",
                "P≈ôekvapen√≠ od radiace! Mo≈æn√° dobr√Ω. Mo≈æn√° ne.",
                "Level up! ...zp≈Øsobem, kter√Ω jsi nepl√°noval.",
                "Gratulujeme! Jsi teƒè o krok bl√≠≈æ k X-Men.",
                "Mutace aktivov√°na! Vedlej≈°√≠ √∫ƒçinky: P≈ôekvapen√≠!",
                "Tv√© geny: 'Hold my beer.'",
                "Nov√° schopnost! Cena: Tv√° normalita.",
                "Evoluce speedrun! WR pace!"
            ],
            
            // Boj - zaƒç√°tek
            combatStart: [
                "ƒåas na bolest! (Jejich, doufejme.)",
                "Iniciativa! A≈• ≈æije ten, kdo p≈ôe≈æije!",
                "Boj! Diplomacie selhala. Jak obvykle.",
                "Nƒõkdo chce zem≈ô√≠t. A≈• to nejsi ty.",
                "Violence is the answer. What was the question?",
                "Round 1, FIGHT!",
                "ƒåas ≈ôe≈°it vƒõci po zl√©m.",
                "Konverzace skonƒçila. Kulky mluv√≠.",
                "Smrt nebo sl√°va! Preferuji sl√°vu.",
                "P≈ôiprav se! Tohle bude bolestiv√©.",
                "√ötok! Nebo √∫tƒõk. Tv√° volba.",
                "Boj na ≈æivot a na smrt. Hlavnƒõ jejich."
            ],
            
            // Boj - √∫tƒõk
            fleeSuccess: [
                "Utekl jsi! Zbabƒõlost = p≈ôe≈æit√≠. Matematika.",
                "Strategick√Ω √∫stup! (ƒåti: Panika≈ôil jsi a bƒõ≈æel.)",
                "P≈ôe≈æil jsi! Hrdost ne, ale whatever.",
                "Run! Funguje od pravƒõku.",
                "Nohy > Hrdost. V≈ædycky.",
                "Taktick√Ω odvrat! Zn√≠ l√≠p ne≈æ √∫tƒõk.",
                "≈Ωije≈°! Uteƒç a bojuj jindy.",
                "Speed boost: Activated by fear.",
                "Ut√≠kej, Forrest, ut√≠kej!",
                "Odvaha je p≈ôece≈àovan√°. Nohy ne."
            ],
            fleeFail: [
                "√ötƒõk selhal! Mus√≠≈° bojovat.",
                "Nedostal ses daleko. Teƒè to bude bolet.",
                "Bƒõ≈æel jsi, ale ne dost rychle. Boj!",
                "Nep≈ô√≠tel tƒõ dostihl! Nen√≠ √∫niku.",
                "√ötƒõk zam√≠tnut! ƒåas vyt√°hnout zbra≈à.",
                "Zakopnut√≠! Teƒè mus√≠≈° bojovat.",
                "≈†patn√Ω smƒõr! A teƒè boj.",
                "Slep√° uliƒçka! Otoƒçka a bojuj!",
                "Nohy selhaly. Ruce mus√≠ zabrat."
            ],
            
            // Vyƒçerp√°n√≠
            exhaustion: [
                "Jsi unaven√Ω jak pes po maratonu. V pou≈°ti. Bez vody.",
                "Tv√© nohy ≈ô√≠kaj√≠ 'ne'. Tv√© tƒõlo ≈ô√≠k√° 'N√â√â√â'.",
                "Vyƒçerpan√Ω! Pot≈ôebuje≈° odpoƒçinek. A terapii.",
                "Energie: 404 Not Found.",
                "Running on empty. Doslova.",
                "Tv√© tƒõlo pr√°vƒõ podalo dvout√Ωdenn√≠ v√Ωpovƒõƒè.",
                "Baterie vybita. Nab√≠jen√≠ nutn√©.",
                "Error: Energy.exe stopped working.",
                "Vyƒçerpan√Ω jak baterka v zombie apokalypse.",
                "Sp√°nek je pro slab√©. Ty jsi slab√Ω.",
                "√önava level: Zombie bez k√°vy.",
                "Tv√© svaly st√°vkuj√≠. A vyhr√°vaj√≠."
            ],
            
            // Obecn√© hl√°≈°ky p≈ôi akc√≠ch
            general: [
                "Dal≈°√≠ den v r√°ji. Radioaktivn√≠m r√°ji.",
                "Aspo≈à nen√≠ pondƒõl√≠. Mysl√≠m.",
                "Mohl bys b√Ωt mrtv√Ω. Progress!",
                "P≈ôe≈æil jsi! Zat√≠m. D≈Øraz na 'zat√≠m'.",
                "Ka≈æd√Ω den nad zem√≠ je dobr√Ω den.",
                "Apokalypsa: 1, Ty: 0.5. Ale po≈ô√°d hraje≈°!",
                "≈Ωije≈°! To je v√≠c ne≈æ vƒõt≈°ina.",
                "Dal≈°√≠ den, dal≈°√≠ pokus nezem≈ô√≠t.",
                "Survival mode: Aktivn√≠. St√°le.",
                "Pozitivn√≠ my≈°len√≠: Aspo≈à nepr≈°√≠. Kyselinou.",
                "Keep calm and... no, kdo si dƒõl√°m srandu.",
                "Dnes neum≈ôe≈°! Mo≈æn√°. Snad. Doufej."
            ],
            
            // Casino - prohry (50+ hl√°≈°ek)
            casinoLose: [
                "D≈Øm v≈ædycky vyhr√°v√°. Jako v≈ædycky.",
                "Tv√© pen√≠ze ≈°ly na lep≈°√≠ m√≠sto. No, vlastnƒõ ne.",
                "Kostky ti ≈ôekly 'ne'. Dost d≈Øraznƒõ.",
                "≈†tƒõstƒõna je mrcha. Dnes obzvl√°≈°≈•.",
                "Bohov√© n√°hody nejsou potƒõ≈°eni.",
                "Kapit√°n Sm≈Øla ude≈ôil znovu!",
                "Nƒõkde se smƒõje krupi√©r. A nen√≠ to s tebou.",
                "Matematick√° pravdƒõpodobnost: Proti tobƒõ.",
                "Prohr√°l jsi. ≈†mejd vzadu u≈æ t≈ôepe rukama.",
                "Bankrot se bl√≠≈æ√≠. C√≠t√≠≈° to?",
                "Tv√° strategie: Existovala v≈Øbec?",
                "Kasino dƒõkuje za p≈ô√≠spƒõvek.",
                "Hoƒè minci a pokraƒçuj... moment.",
                "Finanƒçn√≠ poradce by plakal.",
                "To bolelo. Hlavnƒõ penƒõ≈æenku.",
                "N√°hoda je krut√° pan√≠.",
                "Dal≈°√≠ prohra do sb√≠rky!",
                "Pen√≠ze jsou p≈ôece≈àovan√©. Prej.",
                "Sm≈Øla? Ne, to je talent.",
                "Tv√° penƒõ≈æenka pos√≠l√° S.O.S.",
                "Aspo≈à m√°≈° zdrav√≠. Zat√≠m.",
                "Prohra ƒç√≠slo... kolik vlastnƒõ?",
                "≈†tƒõst√≠ se na tebe vyka≈°lalo.",
                "Mo≈æn√° p≈ô√≠≈°tƒõ. Mo≈æn√°. Asi ne.",
                "Dej si pauzu. Nebo ne, je to tvoje volba.",
                "Krupi√©r poslal d√≠ky.",
                "Dal≈°√≠ lekce pokory.",
                "Hra tƒõ nem√° r√°da. Je to vz√°jemn√©?",
                "≈†mejd si u≈æ brous√≠ ruce.",
                "Investice do z√°bavy. Bolestiv√© z√°bavy.",
                "Tv√© ≈°tƒõst√≠ je na dovolen√©.",
                "N√°hoda rozhodla. ≈†patnƒõ.",
                "Zase nic. P≈ôekvapen√≠?",
                "Pen√≠ze utekly. Rychle.",
                "Kasino: 1, Ty: 0. Zase.",
                "Dal≈°√≠ den, dal≈°√≠ prohra.",
                "Tv√° s√©rie... neskonƒçila dob≈ôe.",
                "Nƒõkdo musel prohr√°t. Ty jsi se p≈ôihl√°sil.",
                "Prohr√°v√°≈° s gr√°ci√≠. Skoro.",
                "≈†ance byly proti tobƒõ. Potvrzeno.",
                "Mo≈æn√° zkus nƒõco jin√©ho. T≈ôeba pr√°ci.",
                "N√°hoda nen√≠ tv≈Øj kamar√°d.",
                "Prohr√°l jsi. Svƒõt se toƒç√≠ d√°l.",
                "Dal≈°√≠ kapitola v knize proher.",
                "Kasino prosperuje. D√≠ky tobƒõ.",
                "Tv√° strategie pot≈ôebuje strategii.",
                "Sm≈Øla loves you.",
                "Prachy jsou fuƒç. Jako v≈ædycky.",
                "Zkus to znovu. V√Ωsledek bude stejn√Ω.",
                "Hazard: 1, Rozum: 0."
            ],
            
            // Casino - v√Ωhry (40+ hl√°≈°ek)
            casinoWin: [
                "VYHR√ÅL JSI! Nezapome≈à na danƒõ. Vtip, apokalypsa.",
                "Pen√≠ze! Teƒè je rychle promƒõ≈à v dal≈°√≠ prohru!",
                "≈†tƒõst√≠ p≈ôeje odv√°≈æn√Ωm! Nebo blb√Ωm. Jedno z toho.",
                "V√Ωhra! ≈†mejd vzadu vypad√° zklamanƒõ.",
                "V√≠tƒõz v√≠tƒõz, rad≈°v√°b√≠ veƒçe≈ôe!",
                "Na moment jsi bohat≈°√≠. U≈æij si to.",
                "Kostky tƒõ maj√≠ r√°dy! Prozat√≠m.",
                "Z√°zrak! Zapi≈° datum do kalend√°≈ôe.",
                "Kasino je v ≈°oku. Ty taky.",
                "Jde to nahoru! Ale nadlouho?",
                "Dobr√° hra! Teƒè to vsaƒè znovu!",
                "Chytr√Ω tah! Nebo n√°hoda. Asi n√°hoda.",
                "Dnes m√°≈° ≈°tƒõst√≠. U≈æij si to, z√≠tra nebude.",
                "Koneƒçnƒõ v√Ωhra! Bylo to tƒõ≈æk√©, co?",
                "Penƒõ≈æenka se usm√≠v√°!",
                "N√°hoda byla na tv√© stranƒõ!",
                "≈†mejd pl√°ƒçe v koutƒõ.",
                "Kdo by to byl ≈ôekl? Ty ne.",
                "V√Ωhra! Neƒçekan√°, ale v√≠tan√°.",
                "Bohov√© gamblingu tƒõ po≈æehnali!",
                "≈†tƒõstƒõna mrkla. Rychle, ne≈æ si to rozmysl√≠!",
                "Prachy jsou tvoje! Na chv√≠li.",
                "Kasino pr√°vƒõ ztratilo. Vz√°cn√©.",
                "Tv√° s√©rie zaƒç√≠n√°! Nebo konƒç√≠. Uvid√≠me.",
                "Dob≈ôe zahr√°no! Nebo dob≈ôe hozeno. Jedno z toho.",
                "Pen√≠ze p≈ôibyly! Jako by to bylo tƒõ≈æk√©.",
                "V√Ωhra je v√Ωhra. I mal√°.",
                "≈†mejd si kou≈°e nehty.",
                "≈†tƒõst√≠ koneƒçnƒõ dorazilo!",
                "Krupi√©r nen√≠ nad≈°en√Ω. Ty jo.",
                "N√°hoda se usm√°la. Vz√°cn√Ω jev.",
                "Bohatstv√≠! No, relativnƒõ.",
                "Vyhr√°l jsi! Zapamatuj si ten pocit.",
                "Penƒõ≈æenka tloustne!",
                "Z√°zraky se dƒõj√≠. Tady. Teƒè.",
                "Dal≈°√≠ v√Ωhra do sb√≠rky!",
                "≈†tƒõstƒõna je s tebou. Dnes.",
                "Kasino truchl√≠. Ty slav√≠≈°.",
                "Dobrej! Ale nezvykej si.",
                "Prachy v kapse. Lep≈°√≠ ne≈æ v kasinu."
            ],
            
            // Casino - jackpot (30+ hl√°≈°ek)
            casinoJackpot: [
                "üé∞ JACKPOT!!! ≈†mejd omdlel!",
                "KRUCIN√ÅL! To se fakt stalo?!",
                "MEGA V√ùHRA! Udƒõlej si fotku, nikdo ti neuvƒõ≈ô√≠!",
                "Z√°zrak v pustinƒõ! B≈Øh gamblingu existuje!",
                "Chyba v syst√©mu ve tv≈Øj prospƒõch!",
                "Bo≈æe n√°hody, d√≠ky za po≈æehn√°n√≠!",
                "Kasino pr√°vƒõ zaplatilo tv≈Øj d≈Øchod. Na t√Ωden.",
                "LEGEND√ÅRN√ç V√ùHRA! Nƒõkde pl√°ƒçe pravdƒõpodobnost.",
                "Tohle se st√°v√° jednou za ≈æivot!",
                "≈†mejd vol√° sanitku. Pro sebe.",
                "NEUVƒö≈òITELN√â! Statistika l≈æe!",
                "Jackpot! Teƒè rychle ut√≠kej!",
                "Kasino vyhla≈°uje bankrot. Vtip. Nebo ne?",
                "BOMBA! Pen√≠ze v≈°ude!",
                "Krupi√©r dostal infarkt. Skoro.",
                "Tohle je sen, ne? NE! Je to realita!",
                "MEGA JACKPOT! ≈†mejd breƒç√≠.",
                "Z√°zrak! P√≠≈°ou o tobƒõ legendy!",
                "Vyhr√°l jsi v√≠c ne≈æ cel√° vesnice za rok!",
                "≈†tƒõstƒõna tƒõ pol√≠bila. Francouzsky.",
                "ASTRONOMICK√Å V√ùHRA!",
                "Kasino tƒõ nen√°vid√≠. Tento jeden trik...",
                "Jackpot! Povƒõz n√°m tv√© tajemstv√≠!",
                "Neuvƒõ≈ôiteln√©! Nepravdƒõpodobn√©! Ale pravdiv√©!",
                "≈†mejd nab√≠z√≠ partnerstv√≠. Odm√≠tni.",
                "BRUT√ÅLN√ç V√ùHRA! Respekt!",
                "Bohov√© gamblingu jsou s tebou!",
                "Tohle se dƒõje jednou za tis√≠c her!",
                "V√ùHRA STOLET√ç! No, dne≈°ka.",
                "Kasino kontroluje kostky. Jsou v pohodƒõ."
            ],
            
            // Casino - blackjack bust (25+ hl√°≈°ek)
            casinoBust: [
                "P≈òETAH! Chamtivost zab√≠j√≠. A penƒõ≈æenky.",
                "21 bylo tak bl√≠zko... a tak daleko.",
                "P≈ôet√°hl jsi. Jako v≈ædycky u baru.",
                "Karty ≈ôekly 'Ne.' Dost jasnƒõ.",
                "Mƒõl jsi st√°t. ≈ò√≠kal jsem to? Ne? Mƒõl jsem.",
                "Matematika je tƒõ≈æk√°. Pro tebe obzvl√°≈°≈•.",
                "22 nen√≠ 21. P≈ôekvapiv√©, co?",
                "Dal≈°√≠ karta byla ≈°patn√Ω n√°pad.",
                "Chamtivost tƒõ zniƒçila. Znovu.",
                "Chtƒõl jsi moc. Dostal jsi nic.",
                "P≈ôeta≈æen√≠ je umƒõn√≠. Zvl√°d√°≈° ho.",
                "21? Ne, 22. Velk√Ω rozd√≠l.",
                "Dealer se usm√≠v√°. Ty ne.",
                "P≈ô√≠li≈° mnoho karet, p≈ô√≠li≈° m√°lo ≈°tƒõst√≠.",
                "St√°t bylo spr√°vn√© rozhodnut√≠. Neudƒõlal jsi ho.",
                "P≈ôekroƒçil jsi limit. Jako v≈ædycky.",
                "Karty tƒõ zradily. Nebo ty je?",
                "P≈ôetah! Klasika.",
                "Jedna karta nav√≠c = jedna v√Ωhra m√≠≈à.",
                "21 je maximum. Ty jsi ho p≈ôeskoƒçil.",
                "Dealer dƒõkuje za snadnou v√Ωhru.",
                "P≈ôet√°hl jsi. P≈ôekvapen√≠? Ne.",
                "Chamtivost: 1, Ty: 0.",
                "Mƒõl jsi p≈ôestat d≈ô√≠v. Mnohem d≈ô√≠v.",
                "Dal≈°√≠ p≈ôetah do sb√≠rky."
            ],
            
            // Casino - automaty (35+ hl√°≈°ek)
            casinoSlots: [
                "üçíüçãüçÄ Skoro! ...poƒçkej, ne.",
                "Symboly: N√°hodn√©. V√Ωhra: ≈Ω√°dn√°.",
                "Automat si z tebe dƒõl√° srandu.",
                "Toƒç, toƒç, toƒç... prohra.",
                "Jednou to vyjde! Statisticky. Jednou.",
                "Zatoƒçil jsi. Prohr√°l jsi. Klasika.",
                "Symboly ti uk√°zaly prost≈ôedn√≠ƒçek.",
                "Jackpot je m√Ωtus! ...nebo ne?",
                "Zase nic. Automat se checht√°.",
                "Symboly nespolupracuj√≠. Jako v≈ædy.",
                "Automat spolykal dal≈°√≠ mince.",
                "T≈ôe≈°nƒõ, citr√≥ny, nic. Obvykl√©.",
                "Symboly se rozhodly jinak.",
                "Dal≈°√≠ zatoƒçen√≠, dal≈°√≠ zklam√°n√≠.",
                "Automat ≈ô√≠k√° ne. D≈Øraznƒõ.",
                "Skoro jackpot! Skoro.",
                "Symboly tancuj√≠. Ale ne pro tebe.",
                "Zase vedle. Automat je krut√Ω.",
                "Mechanick√° ≈°elma spolkla dal≈°√≠ obƒõ≈•.",
                "Toƒç√≠≈° a toƒç√≠≈°. V√Ωsledek stejn√Ω.",
                "Sedmiƒçky? Ne dnes.",
                "Automat m√° hlad. Na tv√© pen√≠ze.",
                "Symboly: Chaos. V√Ωsledek: Prohra.",
                "Dal≈°√≠ pokus, dal≈°√≠ fail.",
                "Jackpot z≈Øst√°v√° m√Ωtem.",
                "Automat: 'D√≠ky za prachy!'",
                "Symboly se neshodly. Jako obvykle.",
                "Toƒçen√≠ ƒç√≠slo... mnoho. V√Ωhra: 0.",
                "Automat vyhr√°v√°. Ty ne.",
                "Skoro! Ale skoro nestaƒç√≠.",
                "Symboly jsou proti tobƒõ.",
                "Dal≈°√≠ mince do nenasytn√© bestie.",
                "Automat se smƒõje. Sly≈°√≠≈° to?",
                "V√Ωhra? P≈ô√≠≈°tƒõ. Mo≈æn√°. Asi ne.",
                "Symboly: Random. ≈†tƒõst√≠: Nula."
            ],
            
            // ≈†mejd (25+ hl√°≈°ek)
            pawnShop: [
                "≈†mejd: 'Dobr√Ω k≈°eft!' (Pro nƒõj.)",
                "Prod√°no! Tv√° ztr√°ta, jeho zisk.",
                "≈†mejd se cul√≠. Nikdy dobr√Ω znak.",
                "'V√Ωhodn√° cena!' Vypravƒõƒç: Nebyla.",
                "Prachy vl√°dnou v≈°emu kolem mƒõ.",
                "Nƒõkdo tu dƒõl√° dobr√Ω byznys. Nejsi to ty.",
                "50%? Sp√≠≈° 50% z 50%. Ale kdo poƒç√≠t√°.",
                "≈†mejd: 'Potƒõ≈°en√≠ jednat s v√°mi!'",
                "Pen√≠ze jsou pen√≠ze. I kdy≈æ m√°lo.",
                "Rychl√Ω prachy, rychl√° ztr√°ta.",
                "≈†mejd si mne ruce. Mastn√© ruce.",
                "Prodej uskuteƒçnƒõn. V√Ωhodnƒõ. Pro nƒõj.",
                "≈†mejd: 'P≈ôijƒè zas!' (Douf√°.)",
                "Tv≈Øj odpad, jeho poklad.",
                "V√Ωkupn√≠ cena: Smƒõ≈°n√°. Ale co nadƒõl√°≈°.",
                "≈†mejd z√°≈ô√≠. Tv√° penƒõ≈æenka ne.",
                "Dal≈°√≠ obchod, dal≈°√≠ ztr√°ta hodnoty.",
                "≈†mejd: 'F√©r cena!' Lol.",
                "Prod√°no pod cenou. P≈ôekvapen√≠?",
                "≈†mejd poƒç√≠t√° prachy. Tvoje prachy.",
                "Rychl√° transakce. Pomal√© uvƒõdomƒõn√≠.",
                "≈†mejd: 'Kvalitn√≠ zbo≈æ√≠!' Hned ho prod√° dr√°≈æ.",
                "Pen√≠ze v kapse. M√©nƒõ ne≈æ by mƒõlo b√Ωt.",
                "≈†mejd m√° radost. Ty m√©nƒõ.",
                "Dal≈°√≠ vƒõc pryƒç. Dal≈°√≠ p√°r minc√≠."
            ]
        };
        
        // Funkce pro z√≠sk√°n√≠ n√°hodn√©ho humoru z kategorie
        function getRandomHumor(category) {
            if (!HUMOR[category]) {
                console.warn('getRandomHumor: Unknown category:', category);
                return '';
            }
            
            const texts = HUMOR[category];
            if (Array.isArray(texts)) {
                return texts[Math.floor(Math.random() * texts.length)];
            } else if (typeof texts === 'object') {
                // Pro vno≈ôen√© objekty jako 'locations'
                const keys = Object.keys(texts);
                const randomKey = keys[Math.floor(Math.random() * keys.length)];
                return texts[randomKey];
            }
            return '';
        }
        
        // Barvy rarit
        const RARITY_COLORS = {
            'common': '#9e9e9e',      // ≈†ed√°
            'uncommon': '#8bc34a',    // Zelen√°
            'rare': '#2196f3',        // Modr√°
            'epic': '#9c27b0',        // Fialov√°
            'legendary': '#ffd700'    // Zlat√°
        };
        
        const RARITY_NAMES_CS = {
            'common': 'Bƒõ≈æn√Ω',
            'uncommon': 'Neobvykl√Ω',
            'rare': 'Vz√°cn√Ω',
            'epic': 'Epick√Ω',
            'legendary': 'Legend√°rn√≠'
        };
        
        function getRarityName(rarity) {
            return RARITY_NAMES_CS[rarity] || rarity;
        }
        
        // Zpƒõtn√° kompatibilita
        const RARITY_NAMES = RARITY_NAMES_CS;
        
        // ƒåesk√© n√°zvy surovin
        const RESOURCE_NAMES = {
            wood: 'D≈ôevo', metal: 'Kov', stone: 'K√°men', cloth: 'L√°tka',
            leather: 'K≈Ø≈æe', herbs: 'Byliny', rope: 'Provaz', glass: 'Sklo',
            scrap: '≈†rot', fuel: 'Benz√≠n', copper: 'Mƒõƒè', electronics: 'Elektronika',
            chemicals: 'Chemik√°lie', gunpowder: 'St≈ôeln√Ω prach', crystal: 'Krystal',
            raw_meat: 'Syrov√© maso', fish: 'Ryba', radaway: 'Radaway', radx: 'Rad-X',
            ammo: 'Munice', medkit: 'L√©k√°rniƒçka', plutonium_core: 'Plutoniov√© j√°dro',
            fusion_cell: 'F√∫zn√≠ ƒçl√°nek', ai_chip: 'AI ƒçip',
            fur: 'Ko≈æe≈°ina', mutant_blood: 'Mutant√≠ krev', silver: 'St≈ô√≠bro', gold: 'Zlato',
            acid: 'Kyselina', gems: 'Drahokamy'
        };
        
        const RESOURCE_ICONS = {
            wood: 'ü™µ', metal: '‚öôÔ∏è', stone: 'ü™®', cloth: 'üßµ',
            leather: 'ü¶¥', herbs: 'üåø', rope: '‚û∞', glass: 'üîÆ',
            scrap: '‚ôªÔ∏è', fuel: '‚õΩ', copper: 'üü§', electronics: 'üíæ',
            chemicals: 'üß™', gunpowder: 'üí•', crystal: 'üíé',
            raw_meat: 'ü•©', fish: 'üêü', radaway: '‚ò¢Ô∏è', radx: 'üíä',
            ammo: 'üî´', medkit: '‚öïÔ∏è', plutonium_core: '‚ò¢Ô∏è',
            fusion_cell: 'üîã', ai_chip: 'ü§ñ',
            fur: 'ü¶ä', mutant_blood: 'ü©∏', silver: '‚¨ú', gold: 'üü°',
            acid: 'üü¢', gems: 'üíé'
        };
        
        const ITEMS = [
            // Food & Consumables (Common - 60-80% chance)
            { id: 'water', name: 'L√°hev vody', icon: 'üíß', type: 'consumable', effect: 'thirst', value: 40, weight: 1, price: 15, rarity: 'common', findChance: 0.8 },
            { id: 'food', name: 'Konzervovan√© j√≠dlo', icon: 'ü•´', type: 'consumable', effect: 'hunger', value: 35, weight: 1, price: 20, rarity: 'common', findChance: 0.75 },
            { id: 'beans', name: 'Fazole v konzervƒõ', icon: 'ü´ò', type: 'consumable', effect: 'hunger', value: 45, weight: 1, price: 25, rarity: 'common', findChance: 0.7 },
            { id: 'juice', name: 'Ovocn√Ω d≈æus', icon: 'üßÉ', type: 'consumable', effect: 'thirst', value: 50, weight: 0.5, price: 20, rarity: 'common', findChance: 0.65 },
            { id: 'coffee', name: 'K√°va', icon: '‚òï', type: 'consumable', effect: 'energy', value: 40, weight: 0.3, price: 20, rarity: 'common', findChance: 0.6 },
            
            // Uncommon consumables (30-50%)
            { id: 'bandage', name: 'Band√°≈æ', icon: 'ü©π', type: 'consumable', effect: 'health', value: 20, weight: 0.2, price: 15, rarity: 'common', findChance: 0.7 },
            { id: 'medkit', name: 'L√©k√°rniƒçka', icon: '‚öïÔ∏è', type: 'consumable', effect: 'health', value: 50, weight: 1, price: 40, rarity: 'uncommon', findChance: 0.5 },
            { id: 'energy', name: 'Energetick√Ω n√°poj', icon: 'üîã', type: 'consumable', effect: 'energy', value: 50, weight: 0.5, price: 25, rarity: 'uncommon', findChance: 0.45 },
            { id: 'meat', name: 'Su≈°en√© maso', icon: 'ü•ì', type: 'consumable', effect: 'hunger', value: 55, weight: 0.5, price: 35, rarity: 'uncommon', findChance: 0.4 },
            { id: 'vitamins', name: 'Vitam√≠ny', icon: 'üíä', type: 'consumable', effect: 'energy', value: 30, weight: 0.2, price: 30, rarity: 'uncommon', findChance: 0.35 },
            { id: 'antibiotics', name: 'Antibiotika', icon: 'üíä', type: 'consumable', effect: 'health', value: 25, weight: 0.2, price: 40, rarity: 'uncommon', findChance: 0.4 },
            { id: 'water_purified', name: 'ƒåist√° voda', icon: 'üíé', type: 'consumable', effect: 'thirst', value: 60, weight: 1, price: 25, rarity: 'uncommon', findChance: 0.35 },
            
            // Rare consumables (10-25%)
            { id: 'radx', name: 'Rad-X', icon: 'üíä', type: 'consumable', effect: 'radiation', value: -30, weight: 0.5, price: 55, rarity: 'uncommon', findChance: 0.3 },
            { id: 'radaway', name: 'RadAway', icon: '‚ò¢Ô∏è', type: 'consumable', effect: 'radiation', value: -40, weight: 0.5, price: 85, rarity: 'rare', findChance: 0.25 },
            { id: 'stimpack', name: 'Stimpak', icon: 'üíâ', type: 'consumable', effect: 'health', value: 80, weight: 0.3, price: 75, rarity: 'rare', findChance: 0.2 },
            { id: 'mre', name: 'Vojensk√° d√°vka', icon: 'üì¶', type: 'consumable', effect: 'hunger', value: 70, weight: 1.5, price: 50, rarity: 'rare', findChance: 0.15 },
            { id: 'radaway_super', name: 'RadAway Plus', icon: '‚ò¢Ô∏è', type: 'consumable', effect: 'radiation', value: -50, weight: 0.5, price: 120, rarity: 'epic', findChance: 0.1 },
            
            // Weapons - Common (40-60%)
            { id: 'wooden_bow', name: 'D≈ôevƒõn√Ω luk', icon: 'üèπ', type: 'weapon', damage: 6, weight: 1, price: 40, rarity: 'common', findChance: 0.25, ammoType: 'arrow' },
            { id: 'knife', name: 'Bojov√Ω n≈Ø≈æ', icon: 'üî™', type: 'weapon', damage: 8, weight: 0.5, price: 60, rarity: 'common', findChance: 0.25 },
            { id: 'bat', name: 'Baseballov√° p√°lka', icon: '‚öæ', type: 'weapon', damage: 12, weight: 2, price: 80, rarity: 'common', findChance: 0.25 },
            
            // Weapons - Uncommon (20-35%)
            { id: 'pistol', name: 'Pistole 9mm', icon: 'üî´', type: 'weapon', damage: 15, weight: 2, price: 150, rarity: 'uncommon', findChance: 0.25, ammoType: '9mm' },
            { id: 'machete', name: 'Maƒçeta', icon: 'üó°Ô∏è', type: 'weapon', damage: 18, weight: 1.5, price: 120, rarity: 'uncommon', findChance: 0.25 },
            { id: 'hammer', name: 'V√°leƒçn√© kladivo', icon: 'üî®', type: 'weapon', damage: 20, weight: 3, price: 150, rarity: 'uncommon', findChance: 0.25 },
            { id: 'crossbow', name: 'Ku≈°e', icon: 'üèπ', type: 'weapon', damage: 22, weight: 3, price: 200, rarity: 'uncommon', findChance: 0.05, ammoType: 'bolt' },
            
            // Weapons - Rare (8-15%)
            { id: 'rifle', name: '√ötoƒçn√° pu≈°ka', icon: 'üî´', type: 'weapon', damage: 25, weight: 4, price: 300, rarity: 'rare', findChance: 0.15, ammoType: '556' },
            { id: 'sword', name: 'Meƒç', icon: '‚öîÔ∏è', type: 'weapon', damage: 24, weight: 2.5, price: 250, rarity: 'rare', findChance: 0.03 },
            { id: 'shotgun', name: 'Brokovnice', icon: 'üî´', type: 'weapon', damage: 30, weight: 4.5, price: 350, rarity: 'rare', findChance: 0.05, ammoType: 'shell' },
            { id: 'chainsaw', name: '≈òetƒõzov√° pila', icon: 'ü™ö', type: 'weapon', damage: 35, weight: 6, price: 400, rarity: 'rare', findChance: 0.005, ammoType: 'fuel' },
            
            // Weapons - Epic (3-5%)
            { id: 'sniper', name: 'Sniper pu≈°ka', icon: 'üî´', type: 'weapon', damage: 40, weight: 5, price: 500, rarity: 'epic', findChance: 0.05, ammoType: '762' },
            
            // === N√ÅBOJE ===
            { id: 'ammo_arrow', name: '≈†√≠py', icon: '‚ûµ', type: 'ammo', ammoType: 'arrow', weight: 0.1, price: 2, rarity: 'common', findChance: 0.5, stackable: true },
            { id: 'ammo_bolt', name: '≈†ipky do ku≈°e', icon: 'üî©', type: 'ammo', ammoType: 'bolt', weight: 0.1, price: 3, rarity: 'common', findChance: 0.4, stackable: true },
            { id: 'ammo_9mm', name: 'N√°boje 9mm', icon: 'üî∏', type: 'ammo', ammoType: '9mm', weight: 0.05, price: 3, rarity: 'common', findChance: 0.4, stackable: true },
            { id: 'ammo_556', name: 'N√°boje 5.56', icon: 'üî∂', type: 'ammo', ammoType: '556', weight: 0.05, price: 5, rarity: 'uncommon', findChance: 0.25, stackable: true },
            { id: 'ammo_762', name: 'N√°boje 7.62', icon: 'üî∑', type: 'ammo', ammoType: '762', weight: 0.08, price: 8, rarity: 'uncommon', findChance: 0.15, stackable: true },
            { id: 'ammo_shell', name: 'Brokov√© n√°boje', icon: 'üî¥', type: 'ammo', ammoType: 'shell', weight: 0.1, price: 6, rarity: 'uncommon', findChance: 0.2, stackable: true },
            { id: 'ammo_fuel', name: 'Kanystr paliva', icon: '‚õΩ', type: 'ammo', ammoType: 'fuel', weight: 2, price: 20, rarity: 'uncommon', findChance: 0.2, stackable: true },
            
            // Armor - Common (starter)
            { id: 'worn_jacket', name: 'Opot≈ôebovan√° bunda', icon: 'üß•', type: 'armor', defense: 6, weight: 2, price: 30, rarity: 'common', findChance: 0 },
            
            // Armor - Uncommon (25-40%)
            { id: 'helmet_basic', name: 'Helma', icon: 'ü™ñ', type: 'helmet', defense: 10, weight: 2, price: 120, rarity: 'uncommon', findChance: 0.5 },
            
            // Armor - Rare (10-15%)
            { id: 'vest', name: 'Nepr≈Øst≈ôeln√° vesta', icon: 'ü¶∫', type: 'armor', defense: 20, weight: 3, price: 200, rarity: 'rare', findChance: 0.3 },
            
            // Armor - Epic (5%)
            { id: 'armor_heavy', name: 'Tƒõ≈æk√° zbroj', icon: 'üõ°Ô∏è', type: 'armor', defense: 30, weight: 8, price: 350, rarity: 'epic', findChance: 0.1 },
            
            // Tools - Common (50-70%)
            { id: 'flashlight', name: 'Baterka', icon: 'üî¶', type: 'tool', bonus: 'vision', weight: 0.5, price: 40, rarity: 'common', findChance: 0.7 },
            { id: 'rope', name: 'Lano', icon: '‚û∞', type: 'tool', bonus: 'escape', weight: 2, price: 30, rarity: 'common', findChance: 0.65 },
            { id: 'sleeping_bag', name: 'Spac√°k', icon: 'üõèÔ∏è', type: 'tool', effect: 'sleep', value: 1, weight: 2, price: 60, rarity: 'common', findChance: 0, stackable: false, unique: true }, // Only one allowed
            
            // Tools - Uncommon (30-45%)
            { id: 'compass', name: 'Kompas', icon: 'üß≠', type: 'tool', bonus: 'navigation', weight: 0.3, price: 50, rarity: 'uncommon', findChance: 0.45, unique: true, maxStack: 1 },
            { id: 'binoculars', name: 'Dalekohled', icon: 'üî≠', type: 'tool', bonus: 'vision', weight: 1, price: 70, rarity: 'uncommon', findChance: 0.35, unique: true, maxStack: 1 },
            { id: 'backpack', name: 'Batoh', icon: 'üéí', type: 'tool', bonus: 'capacity', weight: 1, price: 80, rarity: 'uncommon', findChance: 0.3, unique: true, maxStack: 1 },
            
            // === Z√ÅKLADN√ç SUROVINY (80-95%) ===
            { id: 'wood', name: 'D≈ôevo', icon: 'üå≤', type: 'resource', weight: 1, price: 5, rarity: 'common', findChance: 0.95 },
            { id: 'stone', name: 'K√°men', icon: 'üóø', type: 'resource', weight: 2, price: 5, rarity: 'common', findChance: 0.9 },
            { id: 'cloth', name: 'L√°tka', icon: 'üßµ', type: 'resource', weight: 0.5, price: 8, rarity: 'common', findChance: 0.85 },
            { id: 'metal', name: 'Kov', icon: '‚öôÔ∏è', type: 'resource', weight: 2, price: 10, rarity: 'common', findChance: 0.8 },
            
            // === ORGANICK√â SUROVINY (40-70%) ===
            { id: 'herbs', name: 'Bylinky', icon: 'üåø', type: 'resource', weight: 0.2, price: 15, rarity: 'common', findChance: 0.6, terrain: [0, 1] }, // les, louka
            { id: 'berries', name: 'Bor≈Øvky', icon: 'ü´ê', type: 'consumable', effect: 'hunger', value: 15, weight: 0.2, price: 8, rarity: 'common', findChance: 0.5 },
            { id: 'leather', name: 'K≈Ø≈æe', icon: 'ü¶¥', type: 'resource', weight: 1, price: 20, rarity: 'common', findChance: 0.4 },
            { id: 'raw_meat', name: 'Syrov√© maso', icon: 'ü•©', type: 'resource', weight: 1, price: 12, rarity: 'common', findChance: 0.5 },
            { id: 'fish', name: 'Ryba', icon: 'üêü', type: 'resource', weight: 0.5, price: 10, rarity: 'common', findChance: 0 }, // jen ryba≈ôen√≠
            { id: 'rope', name: 'Provaz', icon: '‚û∞', type: 'resource', weight: 0.3, price: 12, rarity: 'common', findChance: 0.5 },
            
            // === PR≈ÆMYSLOV√â SUROVINY (20-40%) ===
            { id: 'fuel', name: 'Benz√≠n', icon: '‚õΩ', type: 'resource', weight: 1, price: 25, rarity: 'uncommon', findChance: 0.3, terrain: [2, 5] }, // ruiny, tov√°rna
            { id: 'chemicals', name: 'Chemik√°lie', icon: 'üß™', type: 'resource', weight: 0.5, price: 35, rarity: 'uncommon', findChance: 0.25, terrain: [2, 5] },
            { id: 'glass', name: 'Sklo', icon: 'üîÆ', type: 'resource', weight: 0.5, price: 15, rarity: 'common', findChance: 0.4, terrain: [2] },
            { id: 'electronics', name: 'Elektronika', icon: 'üíæ', type: 'resource', weight: 0.3, price: 50, rarity: 'rare', findChance: 0.15, terrain: [2, 5] },
            { id: 'gunpowder', name: 'St≈ôeln√Ω prach', icon: 'üí•', type: 'resource', weight: 0.2, price: 40, rarity: 'uncommon', findChance: 0.2, terrain: [2, 3] },
            
            // === VZ√ÅCN√â RUDY (5-15%, jen tƒõ≈æba) ===
            { id: 'copper', name: 'Mƒõƒè', icon: 'üü§', type: 'resource', weight: 1.5, price: 20, rarity: 'uncommon', findChance: 0, terrain: [3] }, // hory
            { id: 'silver', name: 'St≈ô√≠bro', icon: '‚¨ú', type: 'resource', weight: 1, price: 50, rarity: 'rare', findChance: 0, terrain: [3] },
            { id: 'gold', name: 'Zlato', icon: 'üü°', type: 'resource', weight: 0.5, price: 150, rarity: 'epic', findChance: 0, terrain: [3] },
            { id: 'gems', name: 'Drahokamy', icon: 'üíé', type: 'resource', weight: 0.1, price: 100, rarity: 'rare', findChance: 0.05, terrain: [3] },
            
            // === SPECI√ÅLN√ç SUROVINY ===
            { id: 'mutant_blood', name: 'Mutant√≠ krev', icon: 'ü©∏', type: 'material', weight: 0.2, price: 80, rarity: 'rare', findChance: 0, desc: 'Krev mutanta. Pou≈æiteln√° pro alchymii.' }, // z mutant≈Ø
            { id: 'fur', name: 'Ko≈æe≈°ina', icon: 'ü¶ä', type: 'material', weight: 0.5, price: 50, rarity: 'uncommon', findChance: 0, desc: 'Kvalitn√≠ ko≈æe≈°ina. Prodej nebo craft.' }, // z vlk≈Ø a medvƒõd≈Ø
            { id: 'acid', name: 'Kyselina', icon: 'üü¢', type: 'resource', weight: 0.5, price: 60, rarity: 'rare', findChance: 0.1, terrain: [5] },
            { id: 'crystal', name: 'Krystal', icon: 'üí†', type: 'resource', weight: 0.3, price: 120, rarity: 'epic', findChance: 0.03, terrain: [3] },
            { id: 'scrap', name: '≈†rot', icon: 'üî©', type: 'resource', weight: 1.5, price: 8, rarity: 'common', findChance: 0.7, terrain: [2, 5] },
            
            // === KNIHY - P≈ò√çBƒöH ===
            { id: 'lore_1', name: 'Den√≠k vƒõdce I', icon: 'üìï', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_2', name: 'Den√≠k vƒõdce II', icon: 'üìó', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_3', name: 'Den√≠k vƒõdce III', icon: 'üìò', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_4', name: 'Den√≠k vƒõdce IV', icon: 'üìô', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            { id: 'lore_5', name: 'Den√≠k vƒõdce V', icon: 'üìì', type: 'lore', weight: 0, price: 0, rarity: 'common', findChance: 0.15, cantBuy: true, cantSell: true, use: 'readLoreBook' },
            
            // === N√ÅSTROJE ===
            { id: 'fishing_rod', name: 'Ryb√°≈ôsk√Ω prut', icon: 'üé£', type: 'tool', bonus: 'fishing', bonusValue: 1, weight: 1, price: 50, rarity: 'common', findChance: 0.2, stackable: true },
            { id: 'fishing_rod_uncommon', name: 'Kvalitn√≠ ryb√°≈ôsk√Ω prut', icon: 'üé£', type: 'tool', bonus: 'fishing', bonusValue: 2, weight: 1, price: 120, rarity: 'uncommon', findChance: 0.08 },
            { id: 'pickaxe', name: 'Krump√°ƒç', icon: '‚õèÔ∏è', type: 'tool', bonus: 'mining', weight: 3, price: 100, rarity: 'uncommon', findChance: 0.12 },
            { id: 'hunting_bow', name: 'Loveck√Ω luk', icon: 'üèπ', type: 'weapon', damage: 15, bonus: 'hunting', weight: 2, price: 120, rarity: 'uncommon', findChance: 0.10, ammoType: 'arrow' },
            { id: 'radio', name: 'R√°dio', icon: 'üìª', type: 'tool', bonus: 'radio', weight: 1, price: 200, rarity: 'rare', findChance: 0.05 },
            { id: 'cooking_pot', name: 'Hrnec', icon: 'üç≥', type: 'tool', bonus: 'cooking', weight: 2, price: 60, rarity: 'common', findChance: 0.2 },
            { id: 'alchemy_set', name: 'Alchymistick√° sada', icon: '‚öóÔ∏è', type: 'tool', bonus: 'alchemy', weight: 2, price: 150, rarity: 'rare', findChance: 0.08 },
            
            // === CRAFTOVAC√ç ZBRANƒö (vz√°cnƒõj≈°√≠ - lze vyrobit) ===
            // Common - z√°kladn√≠
            { id: 'stone_axe', name: 'Kamenn√° sekera', icon: 'ü™ì', type: 'weapon', damage: 10, weight: 2, price: 30, rarity: 'common', findChance: 0.15 },
            { id: 'club', name: 'Kyj', icon: 'üèè', type: 'weapon', damage: 12, weight: 2, price: 25, rarity: 'common', findChance: 0.2 },
            { id: 'spear', name: 'Kop√≠', icon: 'üî±', type: 'weapon', damage: 15, weight: 2, price: 50, rarity: 'common', findChance: 0.03 },
            { id: 'bow', name: 'Luk', icon: 'üèπ', type: 'weapon', damage: 18, weight: 1.5, price: 80, rarity: 'common', findChance: 0.05, ammoType: 'arrow' },
            { id: 'slingshot', name: 'Prak', icon: 'üéØ', type: 'weapon', damage: 10, weight: 0.5, price: 20, rarity: 'common', findChance: 0.25 },
            
            // Uncommon - pokroƒçil√©
            { id: 'crossbow_craft', name: 'Ku≈°e', icon: 'üèπ', type: 'weapon', damage: 22, weight: 3, price: 180, rarity: 'uncommon', findChance: 0.015, ammoType: 'bolt' },
            { id: 'hammer_craft', name: 'V√°leƒçn√© kladivo', icon: 'üî®', type: 'weapon', damage: 20, weight: 3.5, price: 150, rarity: 'uncommon', findChance: 0.04 },
            { id: 'axe_craft', name: 'Bojov√° sekera', icon: 'ü™ì', type: 'weapon', damage: 24, weight: 3, price: 200, rarity: 'uncommon', findChance: 0.03 },
            { id: 'serrated_blade', name: 'Zubat√° ƒçepel', icon: 'üî™', type: 'weapon', damage: 18, weight: 1, price: 130, rarity: 'uncommon', findChance: 0.07, special: 'bleed' },
            { id: 'barbed_club', name: 'Ostnat√Ω kyj', icon: 'üèè', type: 'weapon', damage: 16, weight: 2.5, price: 100, rarity: 'uncommon', findChance: 0.005, special: 'bleed' },
            { id: 'pipe_pistol', name: 'Improvizovan√° pistole', icon: 'üî´', type: 'weapon', damage: 22, weight: 1.5, price: 160, rarity: 'uncommon', findChance: 0.05, ammoType: '9mm' },
            { id: 'pipe_rifle', name: 'Trubkov√° pu≈°ka', icon: 'üî´', type: 'weapon', damage: 30, weight: 3, price: 220, rarity: 'uncommon', findChance: 0.005, ammoType: '9mm' },
            { id: 'pipe_shotgun', name: 'Trubkov√° brokovnice', icon: 'üî´', type: 'weapon', damage: 35, weight: 4, price: 280, rarity: 'uncommon', findChance: 0.005, ammoType: 'shell' },
            
            // Rare - vz√°cn√©
            { id: 'sword_craft', name: 'Meƒç', icon: '‚öîÔ∏è', type: 'weapon', damage: 26, weight: 2.5, price: 300, rarity: 'rare', findChance: 0.03 },
            { id: 'poisoned_blade', name: 'Otr√°ven√° ƒçepel', icon: 'üó°Ô∏è', type: 'weapon', damage: 20, weight: 1.5, price: 250, rarity: 'rare', findChance: 0.015, special: 'poison' },
            { id: 'hunting_rifle', name: 'Loveck√° pu≈°ka', icon: 'üéØ', type: 'weapon', damage: 45, weight: 4, price: 450, rarity: 'rare', findChance: 0.005, ammoType: '762' },
            
            // Epic - epick√©
            { id: 'electric_baton', name: 'Elektrick√° palice', icon: '‚ö°', type: 'weapon', damage: 28, weight: 2, price: 400, rarity: 'epic', findChance: 0.015, special: 'stun' },
            { id: 'assault_rifle_craft', name: '√ötoƒçn√° pu≈°ka', icon: 'üî´', type: 'weapon', damage: 38, weight: 4, price: 550, rarity: 'epic', findChance: 0.005, ammoType: '556' },
            { id: 'double_barrel', name: 'Dvojhlav≈àov√° brokovnice', icon: 'üî´', type: 'weapon', damage: 50, weight: 5, price: 600, rarity: 'epic', findChance: 0.005, ammoType: 'shell' },
            
            // Legendary - legend√°rn√≠
            { id: 'flamethrower', name: 'Plamenomet', icon: 'üî•', type: 'weapon', damage: 40, weight: 8, price: 800, rarity: 'legendary', findChance: 0.005, ammoType: 'fuel', special: 'fire' },
            
            // === CRAFTOVAC√ç ZBROJE ===
            // Common
            { id: 'leather_armor', name: 'Ko≈æen√° zbroj', icon: 'ü¶∫', type: 'armor', defense: 16, weight: 3, price: 100, rarity: 'common', findChance: 0.24 },
            { id: 'helmet_craft', name: 'Kovan√° helma', icon: 'ü™ñ', type: 'helmet', defense: 10, weight: 1.5, price: 80, rarity: 'common', findChance: 0.3 },
            { id: 'wooden_shield', name: 'D≈ôevƒõn√Ω ≈°t√≠t', icon: 'ü™µ', type: 'armor', defense: 16, weight: 4, price: 90, rarity: 'common', findChance: 0.2, special: 'block' },
            
            // Uncommon
            { id: 'light_armor', name: 'Lehk√° zbroj', icon: 'üõ°Ô∏è', type: 'armor', defense: 20, weight: 4, price: 180, rarity: 'uncommon', findChance: 0.12 },
            { id: 'gas_mask_craft', name: 'Improviz. maska', icon: 'üò∑', type: 'helmet', defense: 6, weight: 1, price: 120, rarity: 'uncommon', findChance: 0.16, special: 'rad_resist', desc: '-30% radiace' },
            { id: 'arm_guards', name: 'Chr√°niƒçe rukou', icon: 'ü•ä', type: 'gloves', defense: 6, weight: 1.5, price: 140, rarity: 'uncommon', findChance: 0.14, special: 'block_bonus' },
            { id: 'leg_guards', name: 'Chr√°niƒçe nohou', icon: 'ü•æ', type: 'boots', defense: 6, weight: 2, price: 140, rarity: 'uncommon', findChance: 0.14, special: 'dodge_bonus' },
            { id: 'work_gloves', name: 'Pracovn√≠ rukavice', icon: 'üß§', type: 'gloves', defense: 2, weight: 0.5, price: 40, rarity: 'common', findChance: 0.3 },
            { id: 'combat_gloves', name: 'Bojov√© rukavice', icon: 'ü•ä', type: 'gloves', defense: 8, weight: 1, price: 200, rarity: 'rare', findChance: 0.1, special: 'unarmed_bonus', desc: '+5 damage beze zbranƒõ' },
            { id: 'tactical_gloves', name: 'Taktick√© rukavice', icon: 'üß§', type: 'gloves', defense: 10, weight: 1, price: 350, rarity: 'epic', findChance: 0.05, special: 'grip', desc: '+10% p≈ôesnost st≈ôelby' },
            { id: 'hiking_boots', name: 'Turistick√© boty', icon: 'ü•æ', type: 'boots', defense: 3, weight: 1.5, price: 60, rarity: 'common', findChance: 0.25, special: 'speed_bonus', desc: '+2% rychlost' },
            { id: 'combat_boots', name: 'Bojov√© boty', icon: 'ü•æ', type: 'boots', defense: 8, weight: 2.5, price: 220, rarity: 'rare', findChance: 0.1, special: 'combat_stance', desc: '+5% kritick√Ω z√°sah' },
            { id: 'stealth_boots', name: 'Tich√© boty', icon: 'üëü', type: 'boots', defense: 4, weight: 1, price: 300, rarity: 'epic', findChance: 0.06, special: 'stealth_move', desc: '-20% ≈°ance na p≈ôepaden√≠' },
            // Nov√© gloves
            { id: 'leather_gloves', name: 'Ko≈æen√© rukavice', icon: 'üß§', type: 'gloves', defense: 4, weight: 0.5, price: 80, rarity: 'common', findChance: 0.25 },
            { id: 'spiked_gloves', name: 'Ostnat√© rukavice', icon: 'ü•ä', type: 'gloves', defense: 6, weight: 1, price: 180, rarity: 'uncommon', findChance: 0.12, special: 'bleed_punch', desc: '√ötok pƒõst√≠ zp≈Øsob√≠ krv√°cen√≠' },
            { id: 'power_gloves', name: 'Silov√© rukavice', icon: 'üí™', type: 'gloves', defense: 12, weight: 2, price: 500, rarity: 'epic', findChance: 0.04, special: 'power_punch', desc: '+10 damage v boji zbl√≠zka' },
            { id: 'surgeon_gloves', name: 'Chirurgick√© rukavice', icon: 'üß§', type: 'gloves', defense: 1, weight: 0.1, price: 100, rarity: 'uncommon', findChance: 0.15, special: 'medic_bonus', desc: '+20% efektivita l√©ƒçen√≠' },
            { id: 'rad_gloves', name: 'Protirad. rukavice', icon: '‚ò¢Ô∏è', type: 'gloves', defense: 5, weight: 1, price: 250, rarity: 'rare', findChance: 0.08, special: 'rad_resist', desc: '-20% radiace' },
            // Nov√© boots
            { id: 'sandals', name: 'Sand√°ly', icon: 'ü©¥', type: 'boots', defense: 1, weight: 0.3, price: 20, rarity: 'common', findChance: 0.35, special: 'light_feet', desc: '+1% rychlost' },
            { id: 'running_shoes', name: 'Bƒõ≈æeck√© boty', icon: 'üëü', type: 'boots', defense: 2, weight: 0.5, price: 90, rarity: 'common', findChance: 0.2, special: 'run_bonus', desc: '+15% ≈°ance na √∫tƒõk' },
            { id: 'steel_boots', name: 'Ocelov√© boty', icon: 'ü¶∂', type: 'boots', defense: 12, weight: 4, price: 350, rarity: 'rare', findChance: 0.08, special: 'stomp', desc: 'Siln√Ω kop (+8 damage)' },
            { id: 'jump_boots', name: 'Skokov√© boty', icon: 'ü¶ò', type: 'boots', defense: 6, weight: 1.5, price: 400, rarity: 'epic', findChance: 0.05, special: 'jump', desc: '+25% dodge' },
            { id: 'winter_boots', name: 'Zimn√≠ boty', icon: '‚ùÑÔ∏è', type: 'boots', defense: 5, weight: 2, price: 150, rarity: 'uncommon', findChance: 0.15, special: 'warm_feet', desc: '-15% ztr√°ta energie' },
            { id: 'power_boots', name: 'Exo boty', icon: 'ü¶ø', type: 'boots', defense: 14, weight: 3, price: 600, rarity: 'epic', findChance: 0.03, special: 'power_kick', desc: '+4% rychlost, +10 defense' },
            
            // === HELMY ===
            { id: 'cap', name: 'ƒåepice', icon: 'üß¢', type: 'helmet', defense: 1, weight: 0.2, price: 15, rarity: 'common', findChance: 0.4 },
            { id: 'hard_hat', name: 'Stavebn√≠ helma', icon: '‚õëÔ∏è', type: 'helmet', defense: 4, weight: 1, price: 80, rarity: 'common', findChance: 0.25 },
            { id: 'motorcycle_helmet', name: 'Motork√°≈ôsk√° helma', icon: 'ü™ñ', type: 'helmet', defense: 8, weight: 1.5, price: 180, rarity: 'uncommon', findChance: 0.15, special: 'headshot_protect', desc: '-50% damage na hlavu' },
            { id: 'gas_mask', name: 'Plynov√° maska', icon: 'üò∑', type: 'helmet', defense: 3, weight: 1, price: 200, rarity: 'uncommon', findChance: 0.12, special: 'gas_filter', desc: 'Imunita na jedy' },
            { id: 'tactical_helmet', name: 'Taktick√° helma', icon: 'ü™ñ', type: 'helmet', defense: 16, weight: 2, price: 300, rarity: 'rare', findChance: 0.06, special: 'night_vision', desc: 'Noƒçn√≠ vidƒõn√≠' },
            { id: 'ballistic_helmet', name: 'Balistick√° helma', icon: '‚õëÔ∏è', type: 'helmet', defense: 24, weight: 2.5, price: 380, rarity: 'epic', findChance: 0.04, special: 'crit_immune', desc: 'Imunita na kritick√© z√°sahy' },
            { id: 'rad_helmet', name: 'Protirad. helma', icon: '‚ò¢Ô∏è', type: 'helmet', defense: 10, weight: 2, price: 280, rarity: 'rare', findChance: 0.08, special: 'rad_resist', desc: '-30% radiace' },
            
            // Rare Armor
            { id: 'heavy_armor', name: 'Tƒõ≈æk√° zbroj', icon: 'üõ°Ô∏è', type: 'armor', defense: 30, weight: 10, price: 350, rarity: 'rare', findChance: 0.06 },
            { id: 'riot_shield', name: '≈†t√≠t', icon: 'üõ°Ô∏è', type: 'armor', defense: 24, weight: 5, price: 280, rarity: 'rare', findChance: 0.08, special: 'block' },
            { id: 'reinforced_vest', name: 'Zpevnƒõn√° vesta', icon: 'ü¶∫', type: 'armor', defense: 36, weight: 6, price: 420, rarity: 'rare', findChance: 0.05 },
            
            // Epic Armor
            { id: 'hazmat_suit', name: 'Protichemick√Ω oblek', icon: 'ü•º', type: 'armor', defense: 10, weight: 4, price: 400, rarity: 'epic', findChance: 0.04, special: 'rad_immune' },
            { id: 'combat_armor', name: 'Bojov√° zbroj', icon: 'üõ°Ô∏è', type: 'armor', defense: 44, weight: 12, price: 550, rarity: 'epic', findChance: 0.03 },
            { id: 'tower_shield', name: 'Vƒõ≈æov√Ω ≈°t√≠t', icon: 'üõ°Ô∏è', type: 'armor', defense: 40, weight: 10, price: 500, rarity: 'epic', findChance: 0.03, special: 'block' },
            
            // Legendary Armor
            { id: 'power_armor', name: 'Panc√©≈ôov√° zbroj', icon: 'ü§ñ', type: 'armor', defense: 60, weight: 20, price: 1200, rarity: 'legendary', findChance: 0.01, special: 'powered' },
            { id: 'stealth_suit', name: 'Stealth oblek', icon: 'ü•∑', type: 'armor', defense: 24, weight: 3, price: 900, rarity: 'legendary', findChance: 0.02, special: 'stealth', desc: 'Neviditelnost v boji. -50% ≈°ance na p≈ôepaden√≠.' },
            { id: 'berserker_armor', name: 'Zbroj berserkra', icon: 'üëπ', type: 'armor', defense: 50, weight: 15, price: 1100, rarity: 'legendary', findChance: 0.01, special: 'berserker', desc: '+30% damage ale -10% defense.' },
            { id: 'phoenix_cloak', name: 'Pl√°≈°≈• F√©nixe', icon: 'üî•', type: 'armor', defense: 36, weight: 2, price: 1500, rarity: 'legendary', findChance: 0.01, special: 'phoenix', desc: 'Jednou za boj: pokud bys zem≈ôel, obnov√≠≈° 30% HP.' },
            { id: 'titan_plate', name: 'Titanov√° pl√°t', icon: 'ü¶æ', type: 'armor', defense: 70, weight: 25, price: 1800, rarity: 'legendary', findChance: 0.01, special: 'titan', desc: 'Nejvy≈°≈°√≠ obrana. Imunita na kritick√© z√°sahy.' },
            
            // Epic Armor - v√≠ce variant
            { id: 'scout_armor', name: 'Zvƒõdova zbroj', icon: 'üèÉ', type: 'armor', defense: 20, weight: 3, price: 320, rarity: 'epic', findChance: 0.04, special: 'scout', desc: '+4% rychlost pohybu, +15% dodge.' },
            { id: 'medic_vest', name: 'Zdravotn√≠ vesta', icon: 'üè•', type: 'armor', defense: 16, weight: 4, price: 380, rarity: 'epic', findChance: 0.04, special: 'medic', desc: 'L√©ƒçen√≠ je o 50% efektivnƒõj≈°√≠.' },
            { id: 'mutant_hide', name: 'Mutant√≠ k≈Ø≈æe', icon: 'üß¨', type: 'armor', defense: 32, weight: 6, price: 450, rarity: 'epic', findChance: 0.03, special: 'mutant', desc: '+50% odolnost v≈Øƒçi radiaci a jed≈Øm.' },
            { id: 'exoskeleton', name: 'Exoskelet', icon: 'ü¶ø', type: 'boots', defense: 40, weight: 8, price: 600, rarity: 'epic', findChance: 0.02, special: 'exo', desc: '+50% nosnost, +10% damage' },
            { id: 'nano_armor', name: 'Nano zbroj', icon: 'üî¨', type: 'armor', defense: 36, weight: 4, price: 700, rarity: 'epic', findChance: 0.02, special: 'nano', desc: 'Regeneruje 2 HP ka≈æd√© kolo v boji.' },
            
            // Rare Armor - v√≠ce variant
            { id: 'raider_gear', name: 'N√°jezdnick√° zbroj', icon: 'üíÄ', type: 'armor', defense: 24, weight: 5, price: 220, rarity: 'rare', findChance: 0.08, special: 'intimidate', desc: '+10% damage, nep≈ô√°tel√© maj√≠ -5% mor√°lky.' },
            { id: 'scavenger_coat', name: 'Sbƒõraƒç≈Øv kab√°t', icon: 'üß•', type: 'armor', defense: 14, weight: 2, price: 180, rarity: 'rare', findChance: 0.1, special: 'scavenger', desc: '+25% ≈°ance na bonus loot.' },
            { id: 'camo_suit', name: 'Maskovac√≠ oblek', icon: 'üåø', type: 'armor', defense: 12, weight: 2, price: 200, rarity: 'rare', findChance: 0.09, special: 'camo', desc: '-30% ≈°ance na n√°hodn√© souboje.' },
            { id: 'flame_retardant', name: 'Ohnivzdorn√Ω oblek', icon: 'üî•', type: 'armor', defense: 18, weight: 5, price: 250, rarity: 'rare', findChance: 0.07, special: 'fireproof', desc: 'Imunita na pop√°leniny a ohniv√© √∫toky.' },
            { id: 'shock_resistant', name: 'Izolaƒçn√≠ oblek', icon: '‚ö°', type: 'armor', defense: 18, weight: 5, price: 250, rarity: 'rare', findChance: 0.07, special: 'insulated', desc: 'Imunita na elektrick√© √∫toky.' },
            { id: 'winter_gear', name: 'Zimn√≠ v√Ωstroj', icon: '‚ùÑÔ∏è', type: 'armor', defense: 20, weight: 6, price: 230, rarity: 'rare', findChance: 0.08, special: 'endurance', desc: '-30% ztr√°ta energie p≈ôi cestov√°n√≠.' },
            { id: 'night_stalker', name: 'Noƒçn√≠ lovec', icon: 'üåô', type: 'armor', defense: 22, weight: 4, price: 280, rarity: 'rare', findChance: 0.06, special: 'nightvision', desc: 'Bonus +15% damage v noci.' },
            
            // Uncommon Armor - v√≠ce variant
            { id: 'padded_jacket', name: 'Vycpan√° bunda', icon: 'üß•', type: 'armor', defense: 10, weight: 2, price: 80, rarity: 'uncommon', findChance: 0.24 },
            { id: 'sports_gear', name: 'Sportovn√≠ v√Ωstroj', icon: 'üéΩ', type: 'armor', defense: 8, weight: 1.5, price: 70, rarity: 'uncommon', findChance: 0.3, special: 'agile', desc: '+10% dodge.' },
            { id: 'work_boots', name: 'Pracovn√≠ boty', icon: 'üë¢', type: 'boots', defense: 6, weight: 1.5, price: 60, rarity: 'uncommon', findChance: 0.36, special: 'sturdy', desc: '+5% stability.' },
            { id: 'knee_pads', name: 'Chr√°niƒçe kolen', icon: 'ü¶µ', type: 'armor', defense: 8, weight: 1, price: 65, rarity: 'uncommon', findChance: 0.32 },
            { id: 'welding_mask', name: 'Sv√°≈ôeƒçsk√° maska', icon: 'üé≠', type: 'helmet', defense: 8, weight: 1, price: 75, rarity: 'uncommon', findChance: 0.28, special: 'flash_protect', desc: 'Ochrana p≈ôed oslepen√≠m' },
            { id: 'biker_jacket', name: 'Motork√°≈ôsk√° bunda', icon: 'üß•', type: 'armor', defense: 14, weight: 3, price: 110, rarity: 'uncommon', findChance: 0.2 },
            { id: 'chainmail', name: 'Krou≈ækov√° zbroj', icon: '‚õìÔ∏è', type: 'armor', defense: 18, weight: 7, price: 150, rarity: 'uncommon', findChance: 0.16, desc: 'St≈ôedovƒõk√° klasika. St√°le funkƒçn√≠.' },
            
            // Common Armor
            { id: 'torn_jacket', name: 'Roztrhan√° bunda', icon: 'ü•ã', type: 'armor', defense: 4, weight: 1, price: 25, rarity: 'common', findChance: 0.5 },
            { id: 'makeshift_vest', name: 'Provizorn√≠ vesta', icon: 'üëï', type: 'armor', defense: 6, weight: 1.5, price: 40, rarity: 'common', findChance: 0.4 },
            { id: 'cardboard_armor', name: 'Kartonov√° zbroj', icon: 'üì¶', type: 'armor', defense: 2, weight: 0.5, price: 10, rarity: 'common', findChance: 0.5, desc: 'Lep≈°√≠ ne≈æ nic... asi.' },
            
            // === üéÆ EASTER EGG ZBRANƒö - 5 legend√°rn√≠ch p≈ôedmƒõt≈Ø z kultovn√≠ch her ===
            
            // Half-Life - Gordon Freeman's iconic weapon
            { id: 'crowbar', name: 'ƒåerven√© p√°ƒçidlo', icon: 'üîß', type: 'weapon', damage: 42, weight: 2, price: 1337, rarity: 'legendary', findChance: 0.005, special: 'freeman', desc: 'Ikonick√° zbra≈à dr. Freemana z Black Mesa. P≈ôe≈æila Rezonaƒçn√≠ kask√°du i invazi Combine. Nikdy nezklame.' },
            
            // The Witcher - Ciri's sword
            { id: 'zirael', name: 'Zirael', icon: '‚öîÔ∏è', type: 'weapon', damage: 65, weight: 2, price: 3000, rarity: 'legendary', findChance: 0.005, special: 'silver', desc: 'Meƒç vla≈°tovky. Gn√≥msk√° ocel s runami star≈°√≠ krve. "Nƒõco konƒç√≠, nƒõco zaƒç√≠n√°." - Z≈Østal po Ciri, kter√° zmizela mezi svƒõty.' },
            
            // Cyberpunk 2077 - Johnny Silverhand's gun
            { id: 'malorian', name: 'Malorian Arms 3516', icon: 'üî´', type: 'weapon', damage: 68, weight: 2, price: 2077, rarity: 'legendary', findChance: 0.005, ammoType: '9mm', special: 'silverhand', desc: 'Pistole Johnnyho Silverhanda. Vyrobena na zak√°zku, zniƒçila Arasaku v roce 2023. "Wake the fuck up, Samurai. We have a city to burn."' },
            
            // Doom - The BFG
            { id: 'bfg', name: 'B.F.G. 9000', icon: 'üî´', type: 'weapon', damage: 100, weight: 15, price: 6666, rarity: 'legendary', findChance: 0.005, special: 'devastation', ammoType: 'fuel', desc: 'Bio Force Gun z UAC laborato≈ô√≠ na Marsu. Devastuj√≠c√≠ plasmov√Ω v√Ωboj. RIP AND TEAR, dokud to nebude hotov√©.' },
            { id: 'deathclaw_gauntlet', name: 'Rukavice Deathclawa', icon: 'ü¶ñ', type: 'weapon', damage: 55, weight: 4, price: 5000, rarity: 'legendary', findChance: 0, special: 'bleed', critBonus: 15, cantBuy: true, desc: 'Brut√°ln√≠ zbra≈à vyroben√° z dr√°pu Deathclawa. +15% krit, zp≈Øsobuje krv√°cen√≠.' },
            
            // Zelda - The Master Sword
            { id: 'master_sword', name: 'Meƒç mistr≈Ø', icon: 'üó°Ô∏è', type: 'weapon', damage: 55, weight: 2, price: 3000, rarity: 'legendary', findChance: 0.005, special: 'evil_bane', desc: 'Posv√°tn√Ω meƒç vykovan√Ω bohy Hyrule. ƒåepel zah√°nƒõj√≠c√≠ zlo sp√≠ v Zapomenut√©m lese a ƒçek√° na sv√©ho hrdinu. Hyaaah!' },
            
            // === BOSS TROPHY ITEMS ===
            { id: 'queen_crown', name: 'Koruna mutant√≠ kr√°lovny', icon: 'üëë', type: 'trophy', weight: 1, price: 5000, rarity: 'legendary', desc: 'Groteskn√≠ koruna z mutant√≠ho chitinu. D≈Økaz v√≠tƒõzstv√≠ nad kr√°lovnou hn√≠zda.' },
            { id: 'deathclaw_hand', name: 'Dr√°p Deathclawa', icon: 'ü¶ñ', type: 'resource', weight: 3, price: 3000, rarity: 'legendary', desc: 'Obrovsk√Ω dr√°p nejnebezpeƒçnƒõj≈°√≠ho pred√°tora. Lze pou≈æ√≠t k v√Ωrobƒõ legend√°rn√≠ zbranƒõ!' },
            { id: 'mutant_heart', name: 'Srdce Behemotha', icon: 'üíú', type: 'trophy', weight: 5, price: 4000, rarity: 'legendary', desc: 'Masivn√≠ pulzuj√≠c√≠ srdce. Pou≈æij pro +50 max HP (jednor√°zovƒõ) nebo prodej.', usable: true },
            { id: 'ai_chip', name: 'AI Procesorov√© j√°dro', icon: 'üß†', type: 'component', weight: 0.5, price: 2500, rarity: 'epic', desc: 'Pokroƒçil√Ω kvantov√Ω procesor p≈ôedv√°leƒçn√© AI. Pou≈æij v invent√°≈ôi pro vylep≈°en√≠ zbranƒõ (+10 DMG) nebo zbroje (+10 DEF).' },
            { id: 'ai_module', name: 'AI Pamƒõ≈•ov√Ω modul', icon: 'üíæ', type: 'component', weight: 1, price: 1800, rarity: 'rare', desc: 'Pamƒõ≈•ov√Ω modul obsahuj√≠c√≠ fragmenty AI vƒõdom√≠. Prodejn√Ω p≈ôedmƒõt.' },
            { id: 'unique_artifact', name: 'Prastar√Ω artefakt', icon: 'üè∫', type: 'artifact', weight: 2, price: 10000, rarity: 'legendary', desc: 'Z√°hadn√Ω p≈ôedmƒõt z doby p≈ôed v√°lkou. Jeho √∫ƒçel z≈Øst√°v√° nezn√°m√Ω, ale vyza≈ôuje podivnou energii.' },
            { id: 'documents', name: 'Tajn√© dokumenty', icon: 'üìú', type: 'quest', weight: 0.5, price: 500, rarity: 'rare', desc: '≈†ifrovan√© vojensk√© dokumenty. Spr√°vn√≠ lid√© za nƒõ zaplat√≠ hodnƒõ.' }
        ];
        
        // === SN√ç≈ΩEN√ç ≈†ANCE NA NALEZEN√ç VZ√ÅCN√ùCH ZBRAN√ç/BRNƒöN√ç ===
        // Aplikuje se na: weapon, armor, helmet, gloves, boots
        ITEMS.forEach(item => {
            const isEquipment = ['weapon', 'armor', 'helmet', 'gloves', 'boots'].includes(item.type);
            if (isEquipment && item.findChance && item.findChance > 0) {
                if (item.rarity === 'uncommon') {
                    item.findChance = 0.05; // Uncommon fixnƒõ na 0.05
                } else if (['rare', 'epic', 'legendary'].includes(item.rarity)) {
                    item.findChance = Math.max(0.001, item.findChance * 0.2); // Sn√≠≈æen√≠ o 80%
                }
            }
        });
        
        const BUILDINGS = [
            // === Z√ÅKLADN√ç (Level 1) - Osobn√≠ z√°zem√≠ ===
            { id: 'bed', name: 'L≈Ø≈æko', icon: 'üõèÔ∏è', desc: '+2 HP/min, +2 energie/min', cost: { wood: 10, cloth: 5 }, effect: { hp: 2, energy: 2 }, category: 'living', level: 1, maintenance: 0 },
            { id: 'firepit', name: 'Ohni≈°tƒõ', icon: 'üî•', desc: '+10 morale, va≈ôen√≠', cost: { stone: 10, wood: 5 }, effect: { morale: 10, cooking: true }, category: 'living', level: 1, maintenance: 0 },
            { id: 'garden', name: 'Zahrada', icon: 'üå±', desc: '+1 j√≠dlo/den', cost: { wood: 5, stone: 5 }, production: { food: 1 }, category: 'production', level: 1, maintenance: 0 },
            { id: 'water', name: 'Sbƒõraƒç vody', icon: 'üíß', desc: '+3 voda/den', cost: { metal: 8, stone: 10 }, production: { water: 3 }, category: 'production', level: 1, maintenance: 0 },
            { id: 'workshop', name: 'D√≠lna', icon: 'üîß', desc: 'Umo≈æ≈àuje crafting', cost: { wood: 5, metal: 3 }, effect: { crafting: true }, category: 'utility', level: 1, maintenance: 0 },
            { id: 'storage', name: 'Sklad', icon: 'üì¶', desc: '+30 kapacity', cost: { wood: 15, stone: 10 }, effect: { baseCapacity: 30 }, category: 'utility', level: 1, maintenance: 0 },
            
            // Osada Level 1
            { id: 'well', name: 'Studna', icon: 'üö∞', desc: '+6 vody/den pro osadu', cost: { stone: 40, metal: 15 }, production: { water: 6 }, category: 'settlement', level: 1, maintenance: 1 },
            { id: 'farmland', name: 'Pole', icon: 'üåæ', desc: 'Farm√°≈ôi +50% produkce', cost: { wood: 30, stone: 20 }, effect: { farmBonus: 0.5 }, category: 'settlement', level: 1, maintenance: 1 },
            
            // === Level 2 - Rozvoj ===
            { id: 'infirmary', name: 'O≈°et≈ôovna', icon: 'üè•', desc: '+5 HP/min', cost: { wood: 15, metal: 10, cloth: 8 }, effect: { hp: 5 }, category: 'living', level: 2, maintenance: 1 },
            { id: 'kitchen', name: 'Kuchy≈à', icon: 'üç≥', desc: '+2 j√≠dlo/den', cost: { wood: 12, metal: 8 }, production: { food: 2 }, category: 'production', level: 2, maintenance: 1 },
            { id: 'wall', name: 'Hradby', icon: 'üß±', desc: '+25 obrany', cost: { stone: 30, metal: 10 }, effect: { defense: 25 }, category: 'defense', level: 2, maintenance: 2 },
            { id: 'tower', name: 'Str√°≈æn√≠ vƒõ≈æ', icon: 'üóº', desc: '+15 obrany, varov√°n√≠', cost: { wood: 25, stone: 20 }, effect: { defense: 15, raidWarning: true }, category: 'defense', level: 2, maintenance: 1 },
            
            // Osada Level 2
            { id: 'market', name: 'Tr≈æi≈°tƒõ', icon: 'üè™', desc: '+20% prodejn√≠ ceny', cost: { wood: 40, stone: 30, cloth: 20 }, effect: { tradingBonus: 0.2 }, category: 'settlement', level: 2, maintenance: 3 },
            { id: 'barracks', name: 'Kas√°rny', icon: 'üõ°Ô∏è', desc: 'Str√°≈æci +50% efektivity', cost: { wood: 50, metal: 40, stone: 30 }, effect: { guardBonus: 0.5 }, category: 'settlement', level: 2, maintenance: 3 },
            
            // === Level 3 - Specializace ===
            { id: 'forge', name: 'Kov√°rna', icon: '‚öíÔ∏è', desc: '+5 DMG ze zbran√≠', cost: { metal: 30, stone: 20 }, effect: { weaponBonus: 5 }, category: 'utility', level: 3, maintenance: 3 },
            { id: 'training', name: 'Cviƒçi≈°tƒõ', icon: 'üéØ', desc: '+10% XP', cost: { wood: 40, stone: 25 }, effect: { xpBonus: 0.1 }, category: 'utility', level: 3, maintenance: 2 },
            { id: 'armory', name: 'Zbrojnice', icon: '‚öîÔ∏è', desc: '+10% damage', cost: { metal: 25, stone: 15 }, effect: { damageBonus: 10 }, category: 'defense', level: 3, maintenance: 2 },
            
            // Osada Level 3
            { id: 'tavern', name: 'Hospoda', icon: 'üç∫', desc: '+25 morale osady, +20üí∞/den', cost: { wood: 35, cloth: 15 }, effect: { settlementMorale: 25 }, income: 20, category: 'settlement', level: 3, maintenance: 2 },
            { id: 'chapel', name: 'Kaple', icon: '‚õ™', desc: '+20 morale, l√©ƒç√≠ nemoci', cost: { wood: 40, stone: 30 }, effect: { settlementMorale: 20, cureDisease: true }, category: 'settlement', level: 3, maintenance: 3 },
            
            // === Level 4 - Elekt≈ôina ===
            { id: 'generator', name: 'Gener√°tor', icon: '‚ö°', desc: '15 ‚ö°/den (pot≈ôebuje palivo)', cost: { metal: 40, stone: 20 }, production: { power: 15 }, consumption: { fuel: 2 }, category: 'utility', level: 4, maintenance: 5 },
            { id: 'solar', name: 'Sol√°rn√≠ panely', icon: '‚òÄÔ∏è', desc: '8 ‚ö°/den zdarma', cost: { metal: 60, stone: 30 }, production: { power: 8 }, category: 'utility', level: 4, maintenance: 2 },
            { id: 'windmill_power', name: 'Vƒõtrn√° turb√≠na', icon: 'üåÄ', desc: '6 ‚ö°/den zdarma', cost: { metal: 45, wood: 25 }, production: { power: 6 }, category: 'utility', level: 4, maintenance: 2 },
            { id: 'purifier', name: 'ƒåistiƒçka vody', icon: 'üíéüíß', desc: '+10 vody/den', cost: { metal: 35, stone: 25 }, production: { water: 10 }, requiresPower: 2, category: 'production', level: 4, maintenance: 3 },
            { id: 'hydrofarm', name: 'Hydroponick√° farma', icon: 'üåøüí°', desc: '+8 j√≠dlo/den', cost: { metal: 50, stone: 30 }, production: { food: 8 }, requiresPower: 3, category: 'production', level: 4, maintenance: 4 },
            
            // Osada Level 4
            { id: 'comms', name: 'Komunikaƒçn√≠ vƒõ≈æ', icon: 'üì°', desc: 'Obchodn√≠ci +50% ƒçastƒõji, +15üí∞/den', cost: { metal: 40, stone: 30 }, effect: { merchantBonus: 0.5 }, income: 15, requiresPower: 2, category: 'settlement', level: 4, maintenance: 3 },
            { id: 'bunker', name: 'Bunker', icon: 'üèöÔ∏è', desc: '+60 obrany', cost: { stone: 80, metal: 50 }, effect: { defense: 60 }, category: 'settlement', level: 4, maintenance: 6 },
            
            // === Level 5 - Endgame ===
            { id: 'reactor', name: 'Reaktor', icon: '‚ò¢Ô∏è‚ö°', desc: '25 ‚ö°/den', cost: { metal: 80, stone: 50 }, production: { power: 25 }, category: 'utility', level: 5, maintenance: 8 },
            { id: 'medbay', name: 'Zdravotn√≠ st≈ôedisko', icon: 'üè•‚ö°', desc: '+15 HP/min v≈°em', cost: { metal: 45, cloth: 30 }, effect: { hp: 15, healAll: true }, requiresPower: 3, category: 'living', level: 5, maintenance: 7 },
            { id: 'cryo', name: 'Kryogenn√≠ sklad', icon: '‚ùÑÔ∏èüì¶', desc: 'J√≠dlo se nekaz√≠', cost: { metal: 55, stone: 35 }, effect: { foodPreserve: true, baseCapacity: 50 }, requiresPower: 2, category: 'utility', level: 5, maintenance: 5 },
            { id: 'turret', name: 'Automatick√° vƒõ≈æ', icon: 'üî´', desc: '+50 obrany, st≈ô√≠l√≠', cost: { metal: 60, stone: 25 }, effect: { defense: 50, autoAttack: true }, requiresPower: 3, category: 'defense', level: 5, maintenance: 7 },
            
            // Osada Level 5
            { id: 'university', name: 'Univerzita', icon: 'üéì', desc: '+20% XP v≈°em, +25üí∞/den', cost: { wood: 80, stone: 60, cloth: 40 }, effect: { xpBonus: 0.2 }, income: 25, category: 'settlement', level: 5, maintenance: 5 },
            { id: 'monument', name: 'Monument', icon: 'üóΩ', desc: '+50 morale, symbol nadƒõje', cost: { stone: 100, metal: 50 }, effect: { morale: 50, settlementMorale: 30 }, category: 'settlement', level: 5, maintenance: 5 }
        ];
        
        const SETTLER_TYPES = [
            { id: 'farmer', name: 'Farm√°≈ô', icon: 'üåæ', cost: 250, consumption: { food: 1, water: 1 }, desc: 'Produkuje j√≠dlo (od +3/den)', skill: 'farming' },
            { id: 'guard', name: 'Str√°≈æce', icon: 'üõ°Ô∏è', cost: 400, consumption: { food: 2, water: 1 }, desc: 'P≈ôid√°v√° obranu (od +10)', skill: 'combat' },
            { id: 'scavenger_s', name: 'Sbƒõraƒç', icon: 'üéí', cost: 350, consumption: { food: 1, water: 1 }, desc: 'Sb√≠r√° suroviny (2-4/den)', skill: 'scavenging' },
            { id: 'medic_s', name: 'Medik', icon: 'üíâ', cost: 500, consumption: { food: 1, water: 1 }, desc: 'L√©ƒç√≠ v≈°echny (od +3 HP/den)', skill: 'medicine', unique: true },
            { id: 'builder', name: 'Stavitel', icon: 'üî®', cost: 300, consumption: { food: 1, water: 2 }, desc: 'Sleva na stavby (od -15%)', skill: 'building', unique: true },
            { id: 'blacksmith', name: 'Kov√°≈ô', icon: '‚öíÔ∏è', cost: 600, consumption: { food: 2, water: 1 }, desc: 'Opravuje vybaven√≠ zdarma', skill: 'smithing', unique: true },
            { id: 'cook', name: 'Kucha≈ô', icon: 'üçñ', cost: 300, consumption: { food: 1, water: 1 }, desc: 'J√≠dlo d√°v√° v√≠ce (od +25%)', skill: 'cooking', unique: true },
            { id: 'scout', name: 'Zvƒõd', icon: 'üëÅÔ∏è', cost: 450, consumption: { food: 1, water: 1 }, desc: 'Varuje p≈ôed n√°jezdy', skill: 'scouting', unique: true },
            { id: 'trader_s', name: 'Obchodn√≠k', icon: 'üí∞', cost: 750, consumption: { food: 1, water: 1 }, desc: 'Lep≈°√≠ ceny (od +15%)', skill: 'trading' },
            { id: 'alchemist', name: 'Alchymista', icon: '‚öóÔ∏è', cost: 650, consumption: { food: 1, water: 1 }, desc: 'Sb√≠r√° byliny a chemik√°lie', skill: 'alchemy', unique: true },
            { id: 'hunter', name: 'Lovec', icon: 'üèπ', cost: 400, consumption: { food: 1, water: 1 }, desc: 'Produkuje maso (od +2/den)', skill: 'hunting' },
            { id: 'water_carrier', name: 'Nosiƒç vody', icon: 'ü™£', cost: 200, consumption: { food: 1, water: 0 }, desc: 'Produkuje vodu (od +2/den)', skill: 'labor' },
            { id: 'lumberjack', name: 'D≈ôevorubec', icon: 'ü™ì', cost: 300, consumption: { food: 2, water: 1 }, desc: 'Produkuje d≈ôevo (od +3/den)', skill: 'woodcutting' }
        ];
        
        // Fallback pro p≈ôeklady osadn√≠k≈Ø (pou≈æ√≠v√° se .desc p≈ô√≠mo z SETTLER_TYPES)
        const SETTLER_TRANSLATIONS = { cs: {} };
        
        // === DOVEDNOSTI OSADN√çK≈Æ ===
        // Vyv√°≈æen√≠: ni≈æ≈°√≠ produkce, vy≈°≈°√≠ spot≈ôeba na vy≈°≈°√≠ch √∫rovn√≠ch, dra≈æ≈°√≠ upgrady
        // consumption = { food: X, water: Y } - kolik osadn√≠k spot≈ôebuje na t√©to √∫rovni
        const SETTLER_SKILLS = {
            farming: {
                name: 'Zemƒõdƒõlstv√≠', icon: 'üåæ',
                levels: [
                    { level: 1, name: 'Zaƒç√°teƒçn√≠k', bonus: '+3 j√≠dla', effect: { food: 3 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Zahradn√≠k', bonus: '+4 j√≠dla', effect: { food: 4 }, cost: 400, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Farm√°≈ô', bonus: '+6 j√≠dla', effect: { food: 6 }, cost: 800, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '+8 j√≠dla', effect: { food: 8, seedChance: 0.05 }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr zemƒõdƒõlec', bonus: '+12 j√≠dla', effect: { food: 12, rareChance: 0.1 }, cost: 3000, consumption: { food: 3, water: 2 } }
                ]
            },
            combat: {
                name: 'Boj', icon: '‚öîÔ∏è',
                levels: [
                    { level: 1, name: 'Nov√°ƒçek', bonus: '+10 obrany', effect: { defense: 10 }, consumption: { food: 2, water: 1 } },
                    { level: 2, name: 'Str√°≈æce', bonus: '+15 obrany', effect: { defense: 15 }, cost: 500, consumption: { food: 2, water: 1 } },
                    { level: 3, name: 'Voj√°k', bonus: '+22 obrany', effect: { defense: 22, attack: 3 }, cost: 1000, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Veter√°n', bonus: '+30 obrany', effect: { defense: 30, attack: 6 }, cost: 2000, consumption: { food: 3, water: 2 } },
                    { level: 5, name: '≈†ampion', bonus: '+40 obrany', effect: { defense: 40, attack: 10, command: true }, cost: 4000, consumption: { food: 3, water: 3 } }
                ]
            },
            scavenging: {
                name: 'Sbƒõr', icon: 'üîç',
                levels: [
                    { level: 1, name: 'Hledaƒç', bonus: '2-4 surovin', effect: { minRes: 2, maxRes: 4 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Sbƒõraƒç', bonus: '3-5 surovin', effect: { minRes: 3, maxRes: 5 }, cost: 400, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Pr≈Øzkumn√≠k', bonus: '4-7 surovin', effect: { minRes: 4, maxRes: 7, rareChance: 0.1 }, cost: 800, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '5-9 surovin', effect: { minRes: 5, maxRes: 9, electronics: true }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr sbƒõraƒç', bonus: '7-12 surovin', effect: { minRes: 7, maxRes: 12, itemChance: 0.05 }, cost: 3000, consumption: { food: 3, water: 2 } },
                    { level: 6, name: 'Legend√°rn√≠ sbƒõraƒç', bonus: '10-15 surovin', effect: { minRes: 10, maxRes: 15, itemChance: 0.1, electronics: true }, cost: 6000, consumption: { food: 3, water: 2 } }
                ]
            },
            medicine: {
                name: 'Medic√≠na', icon: 'üíä',
                levels: [
                    { level: 1, name: 'O≈°et≈ôovatel', bonus: '+3 HP/den', effect: { healing: 3 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Sanit√°≈ô', bonus: '+5 HP/den', effect: { healing: 5 }, cost: 500, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Doktor', bonus: '+8 HP/den', effect: { healing: 8, cureDisease: true }, cost: 1000, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Chirurg', bonus: '+12 HP/den', effect: { healing: 12, craftMeds: true }, cost: 2000, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Hlavn√≠ l√©ka≈ô', bonus: '+18 HP/den', effect: { healing: 18, revive: true }, cost: 4000, consumption: { food: 3, water: 2 } }
                ]
            },
            building: {
                name: 'Stavitelstv√≠', icon: 'üèóÔ∏è',
                levels: [
                    { level: 1, name: 'Dƒõln√≠k', bonus: '-15% cena staveb', effect: { discount: 0.15 }, consumption: { food: 1, water: 2 } },
                    { level: 2, name: 'Zedn√≠k', bonus: '-25% cena staveb', effect: { discount: 0.25 }, cost: 400, consumption: { food: 1, water: 2 } },
                    { level: 3, name: 'Stavitel', bonus: '-35% cena', effect: { discount: 0.35, wallBonus: 5 }, cost: 800, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Architekt', bonus: '-45% cena', effect: { discount: 0.45, wallBonus: 10 }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Hlavn√≠ in≈æen√Ωr', bonus: '-55% cena', effect: { discount: 0.55, wallBonus: 15 }, cost: 3000, consumption: { food: 3, water: 2 } }
                ]
            },
            smithing: {
                name: 'Kov√°≈ôstv√≠', icon: 'üî®',
                levels: [
                    { level: 1, name: 'Uƒçe≈à', bonus: 'Opravy zdarma', effect: { freeRepair: true }, consumption: { food: 2, water: 1 } },
                    { level: 2, name: 'Kov√°≈ô', bonus: '+1 vylep≈°en√≠', effect: { freeRepair: true, upgrade: 1 }, cost: 600, consumption: { food: 2, water: 1 } },
                    { level: 3, name: 'Zbroj√≠≈ô', bonus: '+2 vylep≈°en√≠', effect: { freeRepair: true, upgrade: 2 }, cost: 1200, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Mistr kov√°≈ô', bonus: '+3 vylep≈°en√≠', effect: { freeRepair: true, upgrade: 3, craftWeapons: true }, cost: 2500, consumption: { food: 3, water: 2 } },
                    { level: 5, name: 'Legend√°rn√≠ kov√°≈ô', bonus: '+5 vylep≈°en√≠', effect: { freeRepair: true, upgrade: 5, legendary: true }, cost: 5000, consumption: { food: 3, water: 3 } }
                ]
            },
            cooking: {
                name: 'Va≈ôen√≠', icon: 'üç≥',
                levels: [
                    { level: 1, name: 'Pomocn√≠k', bonus: '+25% efekt j√≠dla', effect: { foodBonus: 1.25 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Kucha≈ô', bonus: '+40% efekt j√≠dla', effect: { foodBonus: 1.40 }, cost: 350, consumption: { food: 1, water: 1 } },
                    { level: 3, name: '≈†√©fkucha≈ô', bonus: '+60% efekt', effect: { foodBonus: 1.60 }, cost: 700, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '+80% efekt', effect: { foodBonus: 1.80, specialFood: true }, cost: 1400, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr kucha≈ô', bonus: '+100% efekt', effect: { foodBonus: 2.0, buffFood: true }, cost: 2800, consumption: { food: 3, water: 2 } }
                ]
            },
            scouting: {
                name: 'Pr≈Øzkum', icon: 'üî≠',
                levels: [
                    { level: 1, name: 'Pozorovatel', bonus: 'Varov√°n√≠ p≈ôed n√°jezdy', effect: { raidWarning: true }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Zvƒõd', bonus: '+info o nep≈ô√°tel√≠ch', effect: { raidWarning: true, enemyInfo: true }, cost: 450, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Stopa≈ô', bonus: '+mapov√© bonusy', effect: { raidWarning: true, mapBonus: true }, cost: 900, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Ranger', bonus: '+10% karavany', effect: { raidWarning: true, caravanBonus: 0.1 }, cost: 1800, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Mistr zvƒõd', bonus: 'Sabot√°≈æ n√°jezd≈Ø', effect: { raidWarning: true, sabotage: true }, cost: 3500, consumption: { food: 3, water: 2 } }
                ]
            },
            trading: {
                name: 'Obchodov√°n√≠', icon: 'üíπ',
                levels: [
                    { level: 1, name: 'Prodavaƒç', bonus: '+15% ceny', effect: { tradeBonus: 0.15 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Obchodn√≠k', bonus: '+25% ceny', effect: { tradeBonus: 0.25 }, cost: 600, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Makl√©≈ô', bonus: '+35% ceny', effect: { tradeBonus: 0.35, rareGoods: true }, cost: 1200, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Velkobchodn√≠k', bonus: '+50% ceny', effect: { tradeBonus: 0.50, moreCaravans: true }, cost: 2500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Magn√°t', bonus: '+70% ceny', effect: { tradeBonus: 0.70, exclusive: true }, cost: 5000, consumption: { food: 3, water: 2 } }
                ]
            },
            alchemy: {
                name: 'Alchymie', icon: '‚öóÔ∏è',
                levels: [
                    { level: 1, name: 'Uƒçedn√≠k', bonus: '+1 byliny, +1 chem', effect: { herbs: 1, chemicals: 1 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Alchymista', bonus: '+2 byliny, +1 chem', effect: { herbs: 2, chemicals: 1, potions: true }, cost: 500, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'L√©k√°rn√≠k', bonus: '+3 byliny, +2 chem', effect: { herbs: 3, chemicals: 2, stimpacks: true }, cost: 1000, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Mistr alchymista', bonus: '+4 byliny, +3 chem', effect: { herbs: 4, chemicals: 3, radaway: true }, cost: 2000, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Arcialchymista', bonus: '+5 byliny, +4 chem', effect: { herbs: 5, chemicals: 4, mutantSerum: true }, cost: 4000, consumption: { food: 3, water: 2 } }
                ]
            },
            hunting: {
                name: 'Lov', icon: 'üéØ',
                levels: [
                    { level: 1, name: 'Stopa≈ô', bonus: '+2 masa', effect: { meat: 2 }, consumption: { food: 1, water: 1 } },
                    { level: 2, name: 'Lovec', bonus: '+3 masa, +1 k≈Ø≈æe', effect: { meat: 3, leather: 1 }, cost: 400, consumption: { food: 1, water: 1 } },
                    { level: 3, name: 'Myslivec', bonus: '+5 masa, +2 k≈Ø≈æe', effect: { meat: 5, leather: 2 }, cost: 800, consumption: { food: 2, water: 1 } },
                    { level: 4, name: 'Expert', bonus: '+7 masa, +3 k≈Ø≈æe', effect: { meat: 7, leather: 3, trophies: true }, cost: 1500, consumption: { food: 2, water: 2 } },
                    { level: 5, name: 'Legend√°rn√≠ lovec', bonus: '+10 masa, +4 k≈Ø≈æe', effect: { meat: 10, leather: 4, rareHunt: true }, cost: 3000, consumption: { food: 3, water: 2 } }
                ]
            },
            labor: {
                name: 'Pr√°ce', icon: 'üí™',
                levels: [
                    { level: 1, name: 'Nosiƒç', bonus: '+2 vody', effect: { water: 2 }, consumption: { food: 1, water: 0 } },
                    { level: 2, name: 'Dƒõln√≠k', bonus: '+3 vody', effect: { water: 3 }, cost: 250, consumption: { food: 1, water: 0 } },
                    { level: 3, name: 'Pomocn√≠k', bonus: '+5 vody', effect: { water: 5, food: 1 }, cost: 500, consumption: { food: 2, water: 0 } },
                    { level: 4, name: 'Veter√°n', bonus: '+7 vody, +1 j√≠dlo', effect: { water: 7, food: 1 }, cost: 1000, consumption: { food: 2, water: 1 } },
                    { level: 5, name: 'Ne√∫navn√Ω', bonus: '+10 vody, +2 j√≠dlo', effect: { water: 10, food: 2 }, cost: 2000, consumption: { food: 3, water: 1 } },
                    { level: 6, name: 'Mistr nosiƒç', bonus: '+14 vody, +3 j√≠dlo', effect: { water: 14, food: 3 }, cost: 4000, consumption: { food: 3, water: 1 } }
                ]
            },
            woodcutting: {
                name: 'D≈ôevorubectv√≠', icon: 'ü™ì',
                levels: [
                    { level: 1, name: 'Uƒçe≈à', bonus: '+3 d≈ôeva', effect: { wood: 3 }, consumption: { food: 2, water: 1 } },
                    { level: 2, name: 'D≈ôevorubec', bonus: '+5 d≈ôeva', effect: { wood: 5 }, cost: 350, consumption: { food: 2, water: 1 } },
                    { level: 3, name: 'Lesn√≠k', bonus: '+7 d≈ôeva, +1 provaz', effect: { wood: 7, rope: 1 }, cost: 700, consumption: { food: 2, water: 2 } },
                    { level: 4, name: 'Mistr d≈ôevorubec', bonus: '+10 d≈ôeva, +2 provaz', effect: { wood: 10, rope: 2, scrap: 1 }, cost: 1400, consumption: { food: 3, water: 2 } },
                    { level: 5, name: 'Legend√°rn√≠ d≈ôevorubec', bonus: '+15 d≈ôeva, +3 provaz', effect: { wood: 15, rope: 3, scrap: 2, rareWood: true }, cost: 2800, consumption: { food: 3, water: 2 } }
                ]
            }
        };
        
        // === KNIHY - P≈ò√çBƒöH ZK√ÅZY ===
        const LORE_BOOKS = [
            { id: 'lore_1', name: 'Den√≠k Dr. Nov√°ka I', icon: 'üìï', title: 'Projekt AURORA',
              text: `VƒöDECK√ù DEN√çK - Z√ÅZNAM 001
Datum: 15. b≈ôezna 2031
Autor: Dr. Karel Nov√°k, vedouc√≠ projektu AURORA
M√≠sto: V√Ωzkumn√© st≈ôedisko AURORA, Brno

Dnes je historick√Ω den. Po dvaceti letech v√Ωzkumu byl Projekt AURORA ofici√°lnƒõ schv√°len vl√°dou ƒåesk√© republiky a Evropskou uni√≠.

Sed√≠m ve sv√© kancel√°≈ôi a d√≠v√°m se na fotografii na stole. Moje ≈æena Eva. Moji synov√©. Moje dcera Eli≈°ka - teprve ≈°estn√°ct, ale u≈æ chyt≈ôej≈°√≠ ne≈æ vƒõt≈°ina m√Ωch koleg≈Ø.

Mus√≠m zaƒç√≠t od zaƒç√°tku, pro p≈ô√≠pad, ≈æe nƒõkdy nƒõkdo najde tyto z√°pisky.

AURORA mƒõla b√Ωt vakc√≠na. Univerz√°ln√≠ ochrana proti v≈°em zn√°m√Ωm nemocem. Genetick√° modifikace imunitn√≠ho syst√©mu pomoc√≠ upraven√Ωch retrovir≈Ø. Teoreticky dokonal√©. Prakticky... pracujeme ve tmƒõ.

M≈Øj t√Ωm ƒç√≠t√° 47 vƒõdc≈Ø. Vynikaj√≠c√≠ lid√©. Ale dva z nich jsou moji synov√© a to komplikuje vƒõci v√≠c, ne≈æ jsem ƒçekal.

Star≈°√≠ Korvin - "Kory" - je brilantn√≠ genetik. M√° dar vidƒõt vzorce tam, kde ostatn√≠ vid√≠ chaos. Ale vƒçera mi ≈ôekl nƒõco, co mƒõ dƒõs√≠ dodnes:

"Otƒçe, vidƒõl jsi nƒõkdy, jak lesn√≠ po≈æ√°r obnov√≠ ekosyst√©m? Zniƒçen√≠ nen√≠ konec. Je to zaƒç√°tek. Lidstvo je p≈ôerostl√Ω les. Pot≈ôebuje ohe≈à."

Je mu 28. V jeho oƒç√≠ch nevid√≠m mlad√≠ka. Vid√≠m nƒõkoho, kdo se rozhodl p≈ô√≠li≈° brzy.

Mlad≈°√≠ Karel - "Koudy" - je jin√Ω. Ve sv√Ωch 25 letech je opatrn√Ω, metodick√Ω, neust√°le pochybuj√≠c√≠. "Jeden ≈°patn√Ω v√Ωpoƒçet zabije miliony," opakuje jako mantru. Nƒõkdy mƒõ jeho pesimismus unavuje, ale dnes... dnes jsem vdƒõƒçn√Ω za jeho opatrnost.

A pak je tu Marta.

Marta Svobodov√°. Sedmdes√°tilet√° bylink√°≈ôka z vesnice u Slavkova. Nev√≠m proƒç ji sem vl√°da poslala - pr√Ω "lidov√Ω pohled na medic√≠nu." Smƒõ≈°n√©. Ale ta ≈æena... vid√≠ vƒõci. Vƒçera mi ≈ôekla:

"Pane doktore, vid√≠m smrt v oƒç√≠ch va≈°eho star≈°√≠ho. A smutek v oƒç√≠ch mlad≈°√≠ho. D√°vejte pozor."

Zasm√°l jsem se. Teƒè si nejsem jist√Ω, jestli to bylo moudr√©.

Prvn√≠ testy na zv√≠≈ôatech zaƒç√≠naj√≠ p≈ô√≠≈°t√≠ t√Ωden. Modl√≠m se, aby Marta nemƒõla pravdu.

- Dr. Karel Nov√°k

P.S. - Eva mi dnes volala. Ptala se, kdy p≈ôijedu dom≈Ø. ≈òekl jsem "brzy." Oba v√≠me, ≈æe jsem lhal.` },
            
            { id: 'lore_2', name: 'Den√≠k Dr. Nov√°ka II', icon: 'üìó', title: 'St√≠ny v laborato≈ôi',
              text: `VƒöDECK√ù DEN√çK - Z√ÅZNAM 047
Datum: 3. ƒçervna 2031
Autor: Dr. Karel Nov√°k

Dva mƒõs√≠ce od schv√°len√≠. Svƒõt slav√≠. J√° nesp√≠m.

Testy na zv√≠≈ôatech uk√°zaly... anom√°lie. Nƒõkte≈ô√≠ jedinci pro≈°li zmƒõnami, kter√© jsme nep≈ôedpokl√°dali. Mutace. Nƒõkte≈ô√≠ jedinci se stali agresivn√≠mi. Jin√≠ vyvinuli schopnosti, kter√© by nemƒõly existovat. Jeden ≈°impanz p≈ôe≈æil smrtelnou d√°vku radiace.

Vl√°da ≈ô√≠k√°: "Pokraƒçujte."

Kory mi dnes uk√°zal sv√© soukrom√© pozn√°mky. Projekt, kter√Ω naz√Ωv√° "Genesis."

"AURORA je zaƒç√°tek," vysvƒõtloval nad≈°enƒõ. "Genesis je dal≈°√≠ krok. Dok√°≈æeme p≈ôetvo≈ôit celou biosf√©ru. Vyƒçistit radiaci, obnovit ekosyst√©my, dokonce ≈ô√≠zenƒõ evoluovat druhy."

Jeho v√Ωpoƒçty jsou geni√°ln√≠. Ale v konfiguraƒçn√≠ch parametrech jsem na≈°el nƒõco znepokojiv√©ho.

"Kory," zeptal jsem se, "proƒç jsou v konfiguraci LET√ÅLN√ç parametry?"

Usm√°l se. Ten √∫smƒõv mƒõ pron√°sleduje ve snech.

"Ka≈æd√Ω n√°stroj m√° dvƒõ strany, otƒçe. Skalpel l√©ƒç√≠ i zab√≠j√≠. Z√°le≈æ√≠ na chirurgovi."

---

Mezit√≠m se kolem laborato≈ôe pohybuj√≠ nov√≠ lid√©.

Kapit√°n Martin Nov√°k (≈æ√°dn√Ω p≈ô√≠buzn√Ω, jen shoda jmen) vede vojenskou ochranu. Profesion√°l. Jeho mlad≈°√≠ bratr Pavel slou≈æ√≠ tak√©, ale na jin√©m oddƒõlen√≠. Nikdy je nevid√≠m spolu.

Anna Hor√°kov√° - mlad√° jepti≈°ka, kter√° p≈ôi≈°la jako "duchovn√≠ podpora person√°lu." Tich√°, pozorn√°. V≈°√≠m√° si vƒõc√≠, kter√© ostatn√≠ p≈ôehl√≠≈æej√≠. Vƒçera se mƒõ zeptala: "Doktore, proƒç v√°≈° syn Korvin pracuje i v noci, kdy≈æ v≈°ichni ostatn√≠ sp√≠?"

Nemƒõl jsem odpovƒõƒè.

---

Dnes p≈ôi≈°la zpr√°va z Braz√≠lie. Pacienti v testovac√≠ skupinƒõ vykazuj√≠ "neobvykl√© derm√°ln√≠ zmƒõny." Vojensk√° cenzura. Ofici√°ln√≠ verze: "lok√°ln√≠ alergick√° reakce."

Koudy str√°vil celou noc kontrolou Koryho dat. R√°no p≈ôi≈°el s oƒçima ƒçerven√Ωma od √∫navy.

"Tati," ≈ôekl ti≈°e, "bratr nƒõco skr√Ωv√°. M√°m strach."

J√° taky, synu. J√° taky.

- Dr. Karel Nov√°k

P.S. - Marta dnes odm√≠tla vstoupit do Koryho laborato≈ôe. "Tam c√≠t√≠m smrt," ≈ôekla. U≈æ se nesmƒõju jej√≠m p≈ôedtuch√°m.` },
            
            { id: 'lore_3', name: 'Den√≠k Dr. Nov√°ka III', icon: 'üìò', title: 'P√°d svƒõta',
              text: `VƒöDECK√ù DEN√çK - Z√ÅZNAM 089
Datum: 28. srpna 2031
Autor: Dr. Karel Nov√°k

P√≠≈°u ve spƒõchu. Ruce se mi t≈ôesou. Venku jsou v√Ωbuchy.

AURORA selhala. Nebo uspƒõla, z√°le≈æ√≠ na √∫hlu pohledu.

Virus mutoval. P≈ôeskoƒçil. P≈ôen√°≈°√≠ se vzduchem. Miliardy lid√≠ po cel√©m svƒõtƒõ dostaly vakc√≠nu - a teƒè se mƒõn√≠. Nƒõkte≈ô√≠ um√≠raj√≠. Nƒõkte≈ô√≠ se st√°vaj√≠... nƒõƒç√≠m jin√Ωm. Mutanty. Ale ne v≈°ichni ztr√°cej√≠ rozum.

Praha padla p≈ôed t≈ôemi dny. Brno ho≈ô√≠. Arm√°da dostala rozkaz "vyƒçistit" - vidƒõl jsem, jak st≈ô√≠leli do dav≈Ø. Do dƒõt√≠.

Dukovany jsou bez obsluhy. V√Ωbuchy nebyly v√°leƒçn√© - byly jadern√©.

A uprost≈ôed toho v≈°eho - moji synov√©.

Kory zmizel. Na≈°el jsem v jeho laborato≈ôi pozn√°mky:

"GENESIS - F√ÅZE 2
AURORA splnila sv≈Øj √∫ƒçel. Selekce zaƒçala. Slab√≠ budou eliminov√°ni. Siln√≠ p≈ôe≈æij√≠ a budou transformov√°ni. Tohle je evoluce v p≈ô√≠m√©m p≈ôenosu.

Otec nepochop√≠. Koudy nepochop√≠. Ale jednou... jednou uvid√≠, ≈æe jsem mƒõl pravdu."

Bo≈æe m≈Øj. M≈Øj syn. ON TO VƒöDƒöL. On to PL√ÅNOVAL.

---

Koudy se pokusil zniƒçit Genesis. Konfrontace s Korym. V√Ωbuch v laborato≈ôi - budova B je pryƒç. Oba p≈ôe≈æili, ale...

Vidƒõl jsem Koudyho naposledy, jak prch√° s ƒç√°st√≠ dokument≈Ø. Mƒõl pop√°leniny na rukou. Plakal.

"Promi≈à, tati," ≈ôekl. "Nedok√°zal jsem ho zastavit."

Kory zmizel jin√Ωm smƒõrem. Jeho posledn√≠ slova ke mnƒõ:

"Nejsi m≈Øj otec. Otcov√© chr√°n√≠ sv√© dƒõti. Ty jsi vytvo≈ôil svƒõt pln√Ω slaboch≈Ø a teƒè se div√≠≈°, ≈æe nƒõkdo mus√≠ uklidit?"

---

Eva je mrtv√°. Eli≈°ka zmizela. Posledn√≠ zpr√°va od n√≠ byla z okol√≠ Slavkova - pom√°hala uprchl√≠k≈Øm. Pros√≠m... pros√≠m, a≈• je na≈æivu.

Marta mƒõ na≈°la ve sklepƒõ, kde jsem se schoval. Ta star√° ≈æena pro≈°la peklem, aby se ke mnƒõ dostala.

"Mus√≠te p≈ôe≈æ√≠t," ≈ôekla. "Mus√≠te zaznamenat pravdu. Svƒõt bude pot≈ôebovat vƒõdƒõt, co se stalo."

Dala mi bylinn√Ω odvar proti radiaci. Funguje - trochu.

Kapit√°n Nov√°k organizuje evakuaci civilist≈Ø. Jeho bratr Pavel √∫dajnƒõ odm√≠tl rozkaz st≈ô√≠let do lid√≠ a dezertoval. Nikdo nev√≠, kde je.

Anna se modl√≠ za mrtv√©. Je jich p≈ô√≠li≈° mnoho.

- Dr. Karel Nov√°k` },
            
            { id: 'lore_4', name: 'Den√≠k Dr. Nov√°ka IV', icon: 'üìô', title: 'Z popela',
              text: `VƒöDECK√ù DEN√çK - Z√ÅZNAM 127
Datum: 15. ≈ô√≠jna 2031
Autor: Dr. Karel Nov√°k
M√≠sto: Sklep pod Buƒçovicemi

Dva mƒõs√≠ce od kolapsu. Svƒõt, jak jsme ho znali, je pryƒç.

Podle m√Ωch odhad≈Ø p≈ôe≈æilo 2-3% populace. Vƒõt≈°ina zem≈ôela na virus, radiaci, nebo na sebe navz√°jem. Mƒõsta jsou radioaktivn√≠ pustina pln√° mutant≈Ø - nƒõkte≈ô√≠ divoc√≠ jako zv√≠≈ôata, jin√≠ si zachovali rozum.

Ale ≈æivot nach√°z√≠ cestu. A lid√© tak√©.

---

P≈òE≈ΩIV≈†√ç, KTER√â JSEM POTKAL:

MARTA SVOBODOV√Å - star√° bylink√°≈ôka mƒõ st√°le doprov√°z√≠. Je mi jako matka. Uƒç√≠ mlad√©ho l√©ka≈ôe jm√©nem Thomas Harris v≈°echno, co v√≠ o bylin√°ch a l√©ƒçen√≠. Ten mlad√≠k m√° talent.

KAPIT√ÅN MARTIN NOV√ÅK - dr≈æ√≠ checkpoint severnƒõ od Buƒçovic. Disciplinovan√Ω, tvrd√Ω, ale spravedliv√Ω. St√°le hled√° svou dceru Emmu - zmizela den p≈ôed bombami. Je to zlomen√Ω mu≈æ v uniformƒõ.

PAVEL NOV√ÅK - Martin≈Øv bratr. B√Ωval√Ω voj√°k. Teƒè vede bandu... ne n√°jezdn√≠k≈Ø, ne p≈ôesnƒõ. Ochr√°nc≈Ø? Odm√≠tl st≈ô√≠let do civilist≈Ø a stal se vyhnancem. Ironicky, jeho "n√°jezdn√≠ci" chr√°n√≠ vesnice p≈ôed skuteƒçn√Ωmi bandity. Martin to nev√≠. Nebo nechce vƒõdƒõt.

ANNA HOR√ÅKOV√Å - sestra Anna teƒè ≈æije ve star√©m kostele. L√©ƒç√≠ du≈°e tam, kde Thomas l√©ƒç√≠ tƒõla. Modl√≠ se za ≈æenu, kterou m√≠stn√≠ naz√Ωvaj√≠ "z√°hadn√°" - pr√Ω ji nƒõkdo vidƒõl u severn√≠ch ruin.

---

FRAKCE:

Vznikaj√≠ organizace. Lid√© se shlukuj√≠.

ORL√ç N√ÅROD - b√Ωval√≠ voj√°ci a policist√©. Vƒõ≈ô√≠ v po≈ô√°dek. Jejich v≈Ødce je plukovn√≠k Havl√≠k.

RUD√ù √öSVIT - vƒõdci. Pracujeme na pochopen√≠ mutac√≠. Na l√©ku. Na nadƒõji.

VOLN√ç OBCHODN√çCI - p≈ôe≈æit√≠ skrze obchod. Star√Ω mu≈æ jm√©nem pouze "Obchodn√≠k" vede nejvƒõt≈°√≠ karavanu. M√° mlad√©ho inform√°tora - sirotka jm√©nem P√©≈•a, kter√Ω sly≈°√≠ v≈°echno.

LOVCI ST√çN≈Æ - ≈æold√°ci. Viktor, samot√°≈ôsk√Ω lovec, s nimi obƒças spolupracuje. M√° povƒõst, ≈æe ho nelze sledovat.

---

A moji synov√©?

Kory se etabloval v Trading Postu. Charismatick√Ω v≈Ødce s viz√≠ "nov√©ho lidstva." M√° n√°sledovn√≠ky. Mluv√≠ o "oƒçi≈°tƒõn√≠" a "nov√© evoluci." Lid√© mu vƒõ≈ô√≠. To mƒõ dƒõs√≠ nejv√≠c.

Koudy se skr√Ωv√° v tajn√© laborato≈ôi. Pracuje na zp≈Øsobu, jak Genesis rekonfigurovat pro OBNOVU m√≠sto zniƒçen√≠. Mlad√° in≈æen√Ωrka jm√©nem Kl√°ra mu pom√°h√° - nebo pom√°hala. Sly≈°el jsem, ≈æe ode≈°la. Pr√Ω zjistila nƒõco, co ji vydƒõsilo.

Oba hledaj√≠ ƒçty≈ôi komponenty k dokonƒçen√≠ Genesis. Oba vƒõ≈ô√≠, ≈æe zachra≈àuj√≠ svƒõt.

Jeden z nich m√° pravdu.

- Dr. Karel Nov√°k

P.S. - Viktor mi dnes p≈ôinesl zpr√°vu. Pr√Ω vidƒõl mu≈æe v ba≈æin√°ch, kter√Ω "mluv√≠ s√°m se sebou o pravdƒõ." ≈ò√≠kaj√≠ mu ≈†√≠len√Ω Jirka. Pr√Ω byl v laborato≈ôi NOC P≈òED BOMBAMI. Jestli je to pravda... mo≈æn√° v√≠ nƒõco, co nev√≠m ani j√°.` },
            
            { id: 'lore_5', name: 'Den√≠k Dr. Nov√°ka V', icon: 'üìì', title: 'Pravda a nadƒõje',
              text: `VƒöDECK√ù DEN√çK - Z√ÅZNAM 158 (POSLEDN√ç)
Datum: 1. ledna 2032
Autor: Dr. Karel Nov√°k

Nov√Ω rok. Nov√Ω svƒõt. M≈Øj posledn√≠ z√°pis.

Radiace si vyb√≠r√° da≈à. M√°m mo≈æn√° t√Ωden. Marta mi d√°v√° bylinky, ale obƒõ v√≠me, ≈æe u≈æ jen oddalujeme nevyhnuteln√©.

Ne≈æ odejdu, mus√≠m zanechat pravdu. Pro tebe. Pro toho, kdo toto ƒçte.

---

PRAVDA O PROJEKTU GENESIS:

Genesis je za≈ô√≠zen√≠ schopn√© planet√°rn√≠ transformace. M√° DVƒö konfigurace:

OBNOVA - Vyƒçist√≠ radiaci, regeneruje p≈Ødu, stabilizuje mutace. Svƒõt bude jin√Ω, ale ≈æiv√Ω.

OƒåISTA - ≈òetƒõzov√° reakce, kter√° zabije v≈°e kromƒõ tƒõch s "kompatibiln√≠ genetikou." V praxi: ti, kte≈ô√≠ pro≈°li kontrolovanou mutac√≠ AURORA, p≈ôe≈æij√≠. Zbytek zem≈ôe.

ƒåty≈ôi komponenty jsou nutn√©: Plutoniov√© j√°dro, Kvantov√Ω stabiliz√°tor, F√∫zn√≠ ƒçl√°nek, ≈ò√≠dic√≠ modul AI. Rozpt√Ωlil jsem je po kraji.

---

PRAVDA O M√ùCH SYNECH:

Kory... m≈Øj star≈°√≠. Vƒõ≈ô√≠, ≈æe lidstvo v souƒçasn√© formƒõ je "evoluƒçnƒõ zastaral√©." Chce Genesis pou≈æ√≠t k OƒåISTƒö. Ne ze zlomyslnosti - on opravdu vƒõ≈ô√≠, ≈æe t√≠m zachra≈àuje budoucnost. "Slab√≠ mus√≠ odej√≠t, aby siln√≠ mohli ≈æ√≠t," ≈ô√≠k√°.

Je to monstrum? Nebo vizion√°≈ô, kter√©mu nerozum√≠me?

Koudy... m≈Øj mlad≈°√≠. Chce Genesis nakonfigurovat pro OBNOVU. I za cenu, ≈æe mutanti z≈Østanou mutanty nav≈ædy. "L√©pe zmƒõnƒõn√≠ ne≈æ mrtv√≠," argumentuje.

Je to hrdina? Nebo zbabƒõlec, kter√Ω se boj√≠ tƒõ≈æk√Ωch rozhodnut√≠?

NEV√çM. Po v≈°ech tƒõch letech, po v≈°ech tƒõch studi√≠ch a experimentech... NEV√çM, kdo m√° pravdu.

---

CO V√çM JISTƒö:

1. Jirka v ba≈æin√°ch NƒöCO VIDƒöL. V≈°ichni ≈ô√≠kaj√≠, ≈æe je bl√°zen. Ale j√° zn√°m tu laborato≈ô. Byl tam nƒõkdo TU NOC. Jirka mo≈æn√° v√≠ v√≠c ne≈æ kdokoli jin√Ω.

2. Z√°hadn√° ≈æena u severn√≠ch ruin... pozn√°v√°m jej√≠ ch≈Øzi. Jej√≠ gesta. Ale to je nemo≈æn√©. Eva je mrtv√°. Vidƒõl jsem tƒõlo. Nebo... vidƒõl jsem tƒõlo, kter√© VYPADALO jako Eva.

3. Kl√°ra opustila Koudyho laborato≈ô. Proƒç? Co zjistila? Kde jsou jej√≠ pozn√°mky?

4. Kapit√°n Nov√°k hled√° dceru. Pavel "ƒåern√Ω" Nov√°k vede n√°jezdn√≠ky. Dva brat≈ôi na opaƒçn√Ωch stran√°ch. Zn√≠ to povƒõdomƒõ?

5. Star√Ω Tom√°≈° - poustevn√≠k z chaty v lese - zn√° historii tohoto m√≠sta. Je tu d√©le ne≈æ kdokoli jin√Ω. ON V√ç VƒöCi, kter√© ostatn√≠ zapomnƒõli.

---

TOBƒö, KDO TOTO ƒåTE≈†:

Ne≈ô√≠k√°m ti, komu vƒõ≈ôit. To mus√≠≈° zjistit s√°m. Mluv s lidmi. POSLOUCHEJ jejich p≈ô√≠bƒõhy. Pravda nen√≠ v jednom den√≠ku nebo jednom ƒçlovƒõku - je rozpt√Ωlen√° mezi v≈°emi.

Jirka. Tom√°≈°. Kl√°ra. Anna. Marta. Viktor. P√©≈•a - ano, i ten mal√Ω sirotek V√ç vƒõci.

Moje dcera Eli≈°ka... jestli je na≈æivu, bude nƒõkde pom√°hat lidem. Takov√° byla v≈ædycky. Najdi ji. ≈òekni j√≠, ≈æe tati myslel na ni do posledn√≠ chv√≠le.

A Maya - ta mlad√° zvƒõdka, kter√° pr√Ω bƒõh√° po kraji. Nev√≠m proƒç, ale kdy≈æ jsem ji vidƒõl... p≈ôipomnƒõla mi nƒõkoho. Oƒçi. Mƒõla Emminy oƒçi. Nov√°kovny oƒçi.

Svƒõt je zniƒçen√Ω, ale ne mrtv√Ω.

TY jsi d≈Økaz, ≈æe nadƒõje p≈ôe≈æ√≠v√°.

S l√°skou k budoucnosti, kterou u≈æ neuvid√≠m,

Dr. Karel Nov√°k
Vedouc√≠ projektu AURORA
Otec Korvina, Karla ml. a Eli≈°ky
Man≈æel Evy (nav≈ædy)

P.S. - Genesis vy≈æaduje LIDSK√â rozhodnut√≠. Stroj se s√°m nezapne. Osud svƒõta bude v rukou toho, kdo shrom√°≈æd√≠ v≈°echny komponenty.

Zvol moud≈ôe.

Nebo nezvoluj v≈Øbec.

Nƒõkdy je nejlep≈°√≠ volba - nepodlehnout iluzi, ≈æe mus√≠me volit.`}
        ];
        
        // Funkce pro ƒçten√≠ knihy
        function readLoreBook(bookId) {
            try {
                console.log('üìï readLoreBook called with bookId:', bookId);
                console.log('üìï LORE_BOOKS exists:', typeof LORE_BOOKS !== 'undefined');
                console.log('üìï LORE_BOOKS length:', LORE_BOOKS?.length);
                
                const book = LORE_BOOKS.find(b => b.id === bookId);
                console.log('üìï Found book:', book ? book.title : 'NOT FOUND');
                
                if (!book) {
                    showModal('‚ùå Chyba', 'Kniha nebyla nalezena: ' + bookId);
                    return;
                }
                
                // Kontrola cooldownu - ka≈æd√Ω den√≠k m√° sv≈Øj vlastn√≠ cooldown
                const now = Date.now();
                if (!state.loreCooldowns) state.loreCooldowns = {};
                const lastRead = state.loreCooldowns[bookId] || 0;
                const cooldown = 5 * 60 * 1000; // 5 minut
                const remaining = cooldown - (now - lastRead);
                
                if (remaining > 0) {
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    showModal('üìï Den√≠k zamƒçen', `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                            <p style="color: #ff9800;">Tento d√≠l den√≠ku jsi pr√°vƒõ ƒçetl.</p>
                            <p style="color: #ffd700; font-size: 1.5rem; margin: 1rem 0;">${mins}:${String(secs).padStart(2, '0')}</p>
                            <p style="color: #888; font-size: 0.85rem;">Poƒçkej, ne≈æ si ho bude≈° moct p≈ôeƒç√≠st znovu.</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                    return;
                }
                
                // Nastav cooldown pro tento konkr√©tn√≠ den√≠k
                state.loreCooldowns[bookId] = now;
                
                // Oznaƒç jako p≈ôeƒçten√© a dej XP pouze poprv√©
                if (!state.readBooks) state.readBooks = [];
                const alreadyRead = state.readBooks.includes(bookId);
                
                if (!alreadyRead) {
                    state.readBooks.push(bookId);
                    addXP(50); // Bonus XP za prvn√≠ p≈ôeƒçten√≠
                    notifySuccess('Nov√Ω p≈ô√≠bƒõh!', '+50 XP za p≈ôeƒçten√≠');
                }
                
                // Ulo≈æ hned po p≈ôeƒçten√≠
                saveGame(true);
                
                showModal(book.icon + ' ' + book.title, 
                    '<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; text-align: left; line-height: 1.6; white-space: pre-wrap; font-size: 0.9rem; color: #ccc; background: #0a0a0a; padding: 1rem; border-radius: 8px; border: 1px solid #333;">' +
                    book.text +
                    '</div>' +
                    '<p style="text-align: center; margin-top: 1rem; color: #888; font-size: 0.8rem;">üìö D√≠l ' + (LORE_BOOKS.findIndex(b => b.id === bookId) + 1) + ' z ' + LORE_BOOKS.length + '</p>' +
                    (alreadyRead ? '<p style="text-align: center; color: #666; font-size: 0.75rem;">üìñ Ji≈æ p≈ôeƒçteno</p>' : '') +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">' + t('ui', 'close') + '</button>'
                );
            } catch (error) {
                console.error('‚ùå Chyba v readLoreBook:', error);
                showModal('‚ùå Chyba', 'Nepoda≈ôilo se p≈ôeƒç√≠st knihu: ' + error.message);
            }
        }
        
        // Funkce pro zobrazen√≠ sb√≠rky knih
        function showLoreCollection() {
            if (!state.readBooks) state.readBooks = [];
            if (!state.loreCooldowns) state.loreCooldowns = {};
            const collected = state.inv.filter(i => i.id?.startsWith('lore_')).map(i => i.id);
            const now = Date.now();
            const cooldown = 5 * 60 * 1000; // 5 minut
            
            let html = '<p style="color: #888; margin-bottom: 1rem;">Sb√≠rej den√≠ky Dr. Nov√°ka a odhal pravdu o zk√°ze svƒõta a o bratrech Korym a Koudym.</p>';
            html += '<div style="display: grid; gap: 0.5rem;">';
            
            LORE_BOOKS.forEach((book, idx) => {
                const hasBook = collected.includes(book.id);
                const wasRead = state.readBooks.includes(book.id);
                const lastRead = state.loreCooldowns[book.id] || 0;
                const remaining = cooldown - (now - lastRead);
                const isOnCooldown = remaining > 0;
                
                html += '<div style="background: ' + (hasBook ? '#1a2a1a' : '#1a1a1a') + '; padding: 0.8rem; border-radius: 8px; border: 1px solid ' + (hasBook ? '#2a4a2a' : '#333') + '; display: flex; align-items: center; gap: 0.8rem;">';
                html += '<span style="font-size: 2rem;">' + (hasBook ? book.icon : '‚ùì') + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; color: ' + (hasBook ? '#8bc34a' : '#666') + ';">' + (hasBook ? book.name : '???') + '</div>';
                html += '<div style="font-size: 0.8rem; color: #888;">' + (hasBook ? book.title : 'Nenalezeno') + '</div>';
                if (hasBook && isOnCooldown) {
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    html += '<div style="font-size: 0.75rem; color: #ff9800;">üîí ' + mins + ':' + String(secs).padStart(2, '0') + '</div>';
                }
                html += '</div>';
                if (hasBook) {
                    if (isOnCooldown) {
                        html += '<button class="btn" disabled style="padding: 0.4rem 0.8rem; font-size: 0.8rem; opacity: 0.5; cursor: not-allowed;">üîí</button>';
                    } else {
                        html += '<button class="btn" onclick="readLoreBook(\'' + book.id + '\')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">' + (wasRead ? 'üìñ' : 'üìï Nov√©!') + '</button>';
                    }
                }
                html += '</div>';
            });
            
            html += '</div>';
            html += '<p style="text-align: center; margin-top: 1rem; color: #ffd700;">üìö Sebr√°no: ' + collected.length + '/' + LORE_BOOKS.length + '</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">' + t('ui', 'close') + '</button>';
            
            showModal('üìö P≈ô√≠bƒõh zk√°zy', html);
        }
        
        // === UD√ÅLOSTI V OSADƒö ===
        const SETTLEMENT_EVENTS = [
            // === POZITIVN√ç EVENTY === (zv√Ω≈°en√© ≈°ance)
            { id: 'birth', name: 'Narozen√≠', icon: 'üçº', chance: 0.10, effect: 'newSettler', desc: 'Narodil se nov√Ω obyvatel!' },
            { id: 'wedding', name: 'Svatba', icon: 'üíç', chance: 0.06, effect: 'morale', desc: 'Dva osadn√≠ci se vzali!', morale: 20 },
            { id: 'discovery', name: 'Objev', icon: 'üî¶', chance: 0.15, effect: 'bonus', desc: 'Osadn√≠k nƒõco objevil!', resources: true },
            { id: 'celebration', name: 'Oslava', icon: 'üéâ', chance: 0.18, effect: 'party', desc: 'Osadn√≠ci slav√≠!', morale: 25 },
            { id: 'harvest', name: 'Sklize≈à', icon: 'üåæ', chance: 0.20, effect: 'food', desc: 'Bohat√° sklize≈à!', food: 20, condition: 'hasFarm' },
            { id: 'inspiration', name: 'Inspirace', icon: '‚ö°', chance: 0.10, effect: 'skill', desc: 'Osadn√≠k se zlep≈°il!', skillUp: true },
            { id: 'merchant', name: 'Obchodn√≠k', icon: 'üõí', chance: 0.35, effect: 'trade', desc: 'P≈ôijela karavana obchodn√≠k≈Ø!', duration: 10 },
            
            // === NEGATIVN√ç EVENTY === (m√≠rnƒõ sn√≠≈æen√©) - prosperity penalties z≈Øst√°vaj√≠
            { id: 'disease', name: 'Nemoc', icon: 'ü¶†', chance: 0.08, effect: 'sickness', desc: 'Nemoc se ≈°√≠≈ô√≠ osadou!', prosperity: -10 },
            { id: 'dispute', name: 'Spor', icon: 'üí¢', chance: 0.12, effect: 'conflict', desc: 'Osadn√≠ci se h√°daj√≠!', morale: -15 },
            { id: 'runaway', name: '√ötƒõk', icon: 'üèÉ', chance: 0.05, effect: 'loseSettler', desc: 'Osadn√≠k utekl!', prosperity: -5, condition: 'lowMorale' },
            { id: 'accident', name: 'Nehoda', icon: 'ü©∏', chance: 0.06, effect: 'injury', desc: 'Osadn√≠k se zranil.', condition: 'noMedic' },
            { id: 'theft', name: 'Kr√°de≈æ', icon: 'ü¶ù', chance: 0.06, effect: 'theft', desc: 'Nƒõkdo okradl z√°soby!', condition: 'noGuard' },
            { id: 'fire', name: 'Po≈æ√°r', icon: 'üî•', chance: 0.03, effect: 'fire', desc: 'V osadƒõ ho≈ô√≠!', prosperity: -15 },
            
            // === ROZHODOVAC√ç EVENTY === (zv√Ω≈°en√© ≈°ance)
            { id: 'refugee', name: 'Uprchl√≠k', icon: 'ü•æ', chance: 0.15, effect: 'choice_refugee', desc: 'Uprchl√≠k hled√° √∫toƒçi≈°tƒõ.', choice: true },
            { id: 'stray_dog', name: 'Toulav√Ω pes', icon: 'üêï', chance: 0.12, effect: 'choice_dog', desc: 'Toulav√Ω pes se zatoulal k osadƒõ.', choice: true },
            { id: 'mysterious_trader', name: 'Z√°hadn√Ω obchodn√≠k', icon: 'üé≠', chance: 0.08, effect: 'choice_mystery', desc: 'Z√°hadn√° postava nab√≠z√≠ obchod...', choice: true },
            { id: 'wounded_stranger', name: 'Zranƒõn√Ω cizinec', icon: 'ü©π', chance: 0.12, effect: 'choice_wounded', desc: 'Zranƒõn√Ω cizinec pros√≠ o pomoc.', choice: true },
            { id: 'bandit_offer', name: 'Nab√≠dka bandity', icon: 'üíÄ', chance: 0.06, effect: 'choice_bandit', desc: 'Bandita nab√≠z√≠ "ochranu" za √∫platu.', choice: true },
            { id: 'lost_child', name: 'Ztracen√© d√≠tƒõ', icon: 'üë∂', chance: 0.08, effect: 'choice_child', desc: 'Ztracen√© d√≠tƒõ hled√° domov.', choice: true },
            { id: 'trader_dispute', name: 'Obchodn√≠ spor', icon: '‚öñÔ∏è', chance: 0.12, effect: 'choice_dispute', desc: 'Dva osadn√≠ci se h√°daj√≠ o zbo≈æ√≠.', choice: true },
            { id: 'scavenger_find', name: 'N√°lez sbƒõraƒçe', icon: 'üì¶', chance: 0.15, effect: 'choice_scavenger', desc: 'Sbƒõraƒç na≈°el nƒõco zaj√≠mav√©ho...', choice: true },
            
            // === VZ√ÅCN√â EVENTY === - zlat√Ω vƒõk z≈Øst√°v√° jako jedin√Ω pozitivn√≠ zdroj prosperity z event≈Ø
            { id: 'golden_age', name: 'Zlat√Ω vƒõk', icon: '‚ú®', chance: 0.04, effect: 'golden', desc: 'Osada vzkv√©t√°!', prosperity: 15, morale: 30 },
            { id: 'plague', name: 'Mor', icon: '‚ò†Ô∏è', chance: 0.02, effect: 'plague', desc: 'Smrteln√° nemoc zas√°hla osadu!', prosperity: -20, condition: 'noMedic' },
            { id: 'treasure', name: 'Poklad', icon: 'üíé', chance: 0.05, effect: 'treasure', desc: 'Nƒõkdo na≈°el ukryt√Ω poklad!' }
        ];
        
        // P≈ôeklady settlement event≈Ø
        function getSettlementEventName(eventId) {
            const event = SETTLEMENT_EVENTS.find(e => e.id === eventId);
            return event?.name || eventId;
        }
        
        function getSettlementEventDesc(eventId) {
            const event = SETTLEMENT_EVENTS.find(e => e.id === eventId);
            return event?.desc || '';
        }
        
        // === N√ÅJEZDY NA OSADU ===
        const RAID_WAVES = [
            { wave: 1, name: 'Zvƒõdov√©', enemies: [{ type: 'raider', count: 2 }], reward: { money: 50, xp: 30 } },
            { wave: 2, name: 'Mal√Ω n√°jezd', enemies: [{ type: 'raider', count: 3 }, { type: 'bandit', count: 1 }], reward: { money: 100, xp: 60 } },
            { wave: 3, name: '√ötoƒçn√° vlna', enemies: [{ type: 'raider', count: 4 }, { type: 'bandit', count: 2 }], reward: { money: 200, xp: 100 } },
            { wave: 4, name: 'Velk√Ω n√°jezd', enemies: [{ type: 'bandit', count: 4 }, { type: 'raider_boss', count: 1 }], reward: { money: 350, xp: 150 } },
            { wave: 5, name: 'Invaze', enemies: [{ type: 'bandit', count: 5 }, { type: 'raider_boss', count: 2 }], reward: { money: 500, xp: 250, item: 'rare' } }
        ];
        
        // === DUNGEONY S PATRY ===
        const DUNGEON_FLOORS = {
            'old_cellar': {
                name: 'Star√Ω sklep',
                floors: [
                    { floor: 1, name: 'Vstupn√≠ chodba', enemies: ['rat', 'giant_rat'], loot: ['food', 'scrap'], boss: null },
                    { floor: 2, name: 'Skladi≈°tƒõ', enemies: ['giant_rat', 'feral'], loot: ['metal', 'cloth', 'medkit'], boss: null },
                    { floor: 3, name: 'Tajn√° m√≠stnost', enemies: ['feral', 'zombie'], loot: ['weapon', 'ammo', 'money'], boss: 'cellar_king' }
                ]
            },
            'nuclear_plant': {
                name: 'Jadern√° elektr√°rna',
                floors: [
                    { floor: 1, name: 'Vnƒõj≈°√≠ perimetr', enemies: ['ghoul', 'soldier_zombie'], loot: ['ammo', 'medkit'], boss: null },
                    { floor: 2, name: 'Kontroln√≠ m√≠stnost', enemies: ['glowing_ghoul', 'robot'], loot: ['electronics', 'radaway'], boss: null },
                    { floor: 3, name: 'Reaktorov√° hala', enemies: ['glowing_ghoul', 'mutant_brute'], loot: ['fuel', 'crystal', 'radx'], boss: null },
                    { floor: 4, name: 'Chladic√≠ vƒõ≈æe', enemies: ['glowing_one', 'irradiated_beast'], loot: ['chemicals', 'legendary'], boss: null },
                    { floor: 5, name: 'J√°dro reaktoru', enemies: ['glowing_one'], loot: ['plutonium_core', 'legendary'], boss: 'nuclear_abomination' }
                ]
            },
            'abandoned_mine': {
                name: 'Opu≈°tƒõn√Ω d≈Øl',
                floors: [
                    { floor: 1, name: 'Vstup', enemies: ['rat', 'zombie'], loot: ['metal', 'stone'], boss: null },
                    { floor: 2, name: 'Star√© ≈°toly', enemies: ['zombie', 'mutant_rat'], loot: ['metal', 'copper'], boss: null },
                    { floor: 3, name: 'Zatopen√© tunely', enemies: ['mutant_rat', 'raider'], loot: ['copper', 'silver'], boss: null },
                    { floor: 4, name: 'Hlubiny', enemies: ['raider', 'bandit'], loot: ['silver', 'gold'], boss: 'mine_foreman' }
                ]
            },
            'military_base': {
                name: 'Vojensk√° z√°kladna',
                floors: [
                    { floor: 1, name: 'Br√°na', enemies: ['soldier', 'raider'], loot: ['ammo', 'metal'], boss: null },
                    { floor: 2, name: 'Kas√°rny', enemies: ['soldier', 'bandit'], loot: ['weapon', 'armor'], boss: null },
                    { floor: 3, name: 'Zbrojnice', enemies: ['soldier', 'raider_boss'], loot: ['weapon', 'ammo'], boss: null },
                    { floor: 4, name: 'Velitelstv√≠', enemies: ['soldier', 'soldier'], loot: ['rare_weapon', 'documents'], boss: 'commander' }
                ]
            },
            'military_outpost': {
                name: 'Vojensk√° hl√≠dka',
                floors: [
                    { floor: 1, name: 'Str√°≈ænice', enemies: ['soldier_zombie', 'raider'], loot: ['ammo', 'medkit'], boss: null },
                    { floor: 2, name: 'Muniƒçn√≠ sklad', enemies: ['soldier_zombie', 'robot'], loot: ['ammo', 'weapon'], boss: null },
                    { floor: 3, name: 'Velitelsk√Ω bunkr', enemies: ['robot', 'turret'], loot: ['rare_weapon', 'armor'], boss: 'sergeant' }
                ]
            },
            'underground_bunker': {
                name: 'Tajn√Ω bunkr',
                floors: [
                    { floor: 1, name: 'Vstupn√≠ hala', enemies: ['robot', 'turret'], loot: ['electronics', 'metal'], boss: null },
                    { floor: 2, name: 'Laborato≈ôe', enemies: ['mutant', 'robot'], loot: ['chemicals', 'electronics'], boss: null },
                    { floor: 3, name: 'Reaktor', enemies: ['mutant', 'giant_mutant'], loot: ['fuel', 'crystal'], boss: null },
                    { floor: 4, name: 'Tajn√° sekce', enemies: ['robot', 'robot'], loot: ['legendary'], boss: 'ai_core' },
                    { floor: 5, name: 'Srdce bunkru', enemies: ['elite_robot'], loot: ['legendary', 'unique'], boss: 'general_morrison' }
                ]
            },
            'old_bunker': {
                name: 'Star√Ω bunkr',
                floors: [
                    { floor: 1, name: 'Zrezivƒõl√Ω vchod', enemies: ['ghoul', 'rat'], loot: ['scrap', 'metal'], boss: null },
                    { floor: 2, name: 'Skladi≈°tƒõ', enemies: ['ghoul', 'zombie'], loot: ['food', 'medkit'], boss: null },
                    { floor: 3, name: 'Obytn√° sekce', enemies: ['zombie', 'feral'], loot: ['cloth', 'electronics'], boss: null },
                    { floor: 4, name: 'Tajn√° laborato≈ô', enemies: ['experiment', 'robot'], loot: ['chemicals', 'rare_item'], boss: 'mad_scientist' }
                ]
            },
            'factory': {
                name: 'Toxick√° tov√°rna',
                floors: [
                    { floor: 1, name: 'V√Ωrobn√≠ hala', enemies: ['zombie', 'mutant'], loot: ['scrap', 'chemicals'], boss: null },
                    { floor: 2, name: 'Sklady', enemies: ['mutant', 'raider'], loot: ['fuel', 'chemicals'], boss: null },
                    { floor: 3, name: 'Chemick√Ω sklad', enemies: ['mutant', 'zombie_hulk'], loot: ['acid', 'chemicals'], boss: 'toxic_beast' }
                ]
            },
            'power_plant': {
                name: 'Elektr√°rna',
                floors: [
                    { floor: 1, name: 'Transform√°tory', enemies: ['electric_mutant', 'robot'], loot: ['electronics', 'copper'], boss: null },
                    { floor: 2, name: 'Gener√°tory', enemies: ['electric_mutant', 'turret'], loot: ['fuel', 'electronics'], boss: null },
                    { floor: 3, name: '≈ò√≠d√≠c√≠ centrum', enemies: ['robot', 'elite_robot'], loot: ['rare_electronics', 'crystal'], boss: 'power_core' }
                ]
            },
            'chemical_plant': {
                name: 'Chemick√° tov√°rna',
                floors: [
                    { floor: 1, name: 'Vstupn√≠ hala', enemies: ['toxic_zombie', 'mutant'], loot: ['chemicals', 'scrap'], boss: null },
                    { floor: 2, name: 'V√Ωrobn√≠ linka', enemies: ['toxic_zombie', 'acid_beast'], loot: ['acid', 'chemicals'], boss: null },
                    { floor: 3, name: 'Sklad chemik√°li√≠', enemies: ['acid_beast', 'toxic_beast'], loot: ['rare_chemicals', 'antidote'], boss: 'chemical_horror' }
                ]
            },
            'police_station': {
                name: 'Policejn√≠ stanice',
                floors: [
                    { floor: 1, name: 'Recepce', enemies: ['zombie_cop', 'zombie'], loot: ['ammo', 'medkit'], boss: null },
                    { floor: 2, name: 'Cely', enemies: ['zombie_cop', 'feral'], loot: ['weapon', 'armor'], boss: null },
                    { floor: 3, name: 'Zbrojnice', enemies: ['zombie_cop', 'raider'], loot: ['rare_weapon', 'ammo'], boss: 'zombie_chief' }
                ]
            },
            'secret_lab': {
                name: 'Tajn√° laborato≈ô',
                floors: [
                    { floor: 1, name: 'Dezinfekƒçn√≠ komora', enemies: ['experiment', 'robot'], loot: ['chemicals', 'electronics'], boss: null },
                    { floor: 2, name: 'V√Ωzkumn√© oddƒõlen√≠', enemies: ['experiment', 'mutant'], loot: ['rare_chemicals', 'documents'], boss: null },
                    { floor: 3, name: 'Testovac√≠ komory', enemies: ['mutant_brute', 'experiment'], loot: ['mutant_blood', 'crystal'], boss: null },
                    { floor: 4, name: 'J√°dro laborato≈ôe', enemies: ['elite_robot', 'ai_guardian'], loot: ['legendary', 'ai_module'], boss: 'project_x' }
                ]
            },
            'ancient_vault': {
                name: 'Starovƒõk√Ω trezor',
                floors: [
                    { floor: 1, name: 'Zapeƒçetƒõn√Ω vchod', enemies: ['robot', 'turret'], loot: ['electronics', 'crystal'], boss: null },
                    { floor: 2, name: 'Str√°≈æn√≠ chodba', enemies: ['sentinel', 'robot'], loot: ['rare_electronics', 'gold'], boss: null },
                    { floor: 3, name: 'Archiv vƒõk≈Ø', enemies: ['sentinel', 'ai_guardian'], loot: ['documents', 'legendary'], boss: null },
                    { floor: 4, name: 'Chr√°m poklad≈Ø', enemies: ['ancient_guardian', 'elite_robot'], loot: ['legendary_weapon', 'legendary_armor'], boss: null },
                    { floor: 5, name: 'Srdce trezoru', enemies: ['ancient_guardian'], loot: ['unique_artifact', 'legendary'], boss: 'vault_keeper' }
                ]
            }
        };
        
        // Dungeon bossov√©
        const DUNGEON_BOSSES = {
            'cellar_king': { name: 'Kr√°l sklepa', icon: 'üêÄ', hp: 120, damage: 15, defense: 8, xp: 100, loot: ['food', 'medkit', 'money', 'scrap', 'cloth', 'leather'], lootCount: 3 },
            'nuclear_abomination': { name: 'Jadern√° zr≈Øda', icon: '‚ò¢Ô∏è', hp: 600, damage: 50, defense: 20, xp: 600, loot: ['legendary_weapon', 'legendary_armor', 'radx', 'crystal', 'electronics', 'gems'], lootCount: 4, radiation: 30 },
            'vault_keeper': { name: 'Str√°≈æce trezoru', icon: 'üóø', hp: 500, damage: 45, defense: 35, xp: 700, loot: ['legendary_weapon', 'legendary_armor', 'rare_weapon', 'electronics', 'crystal', 'gems', 'gold'], lootCount: 5 },
            'mine_foreman': { name: 'D≈Øln√≠ p≈ôed√°k', icon: '‚õèÔ∏è', hp: 180, damage: 22, defense: 12, xp: 180, loot: ['metal', 'copper', 'rare_weapon', 'money', 'gold'], lootCount: 3 },
            'commander': { name: 'Velitel', icon: 'üéñÔ∏è', hp: 220, damage: 28, defense: 18, xp: 250, loot: ['rare_weapon', 'rare_armor', 'ammo', 'medkit', 'money'], lootCount: 4 },
            'sergeant': { name: 'Ser≈æant', icon: 'üíÇ', hp: 160, damage: 24, defense: 15, xp: 180, loot: ['ammo', 'weapon', 'medkit', 'armor', 'money'], lootCount: 3 },
            'ai_core': { name: 'AI J√°dro', icon: 'ü§ñ', hp: 300, damage: 35, defense: 25, xp: 400, loot: ['electronics', 'legendary_weapon', 'rare_armor', 'crystal', 'gems'], lootCount: 4 },
            'toxic_beast': { name: 'Toxick√° bestie', icon: '‚ò£Ô∏è', hp: 250, damage: 30, defense: 15, xp: 300, loot: ['mutant_blood', 'chemicals', 'rare_armor', 'herbs'], lootCount: 3 },
            'general_morrison': { name: 'Gener√°l Morrison', icon: '‚≠ê', hp: 400, damage: 40, defense: 30, xp: 500, loot: ['legendary_weapon', 'legendary_armor', 'electronics', 'ammo', 'rare_weapon', 'gems'], lootCount: 5 },
            'mad_scientist': { name: '≈†√≠len√Ω vƒõdec', icon: 'üß™', hp: 150, damage: 20, defense: 8, xp: 200, loot: ['chemicals', 'rare', 'electronics', 'stimpak'], lootCount: 3 },
            'power_core': { name: 'Energetick√© j√°dro', icon: '‚ö°', hp: 200, damage: 35, defense: 20, xp: 250, loot: ['electronics', 'crystal', 'copper', 'rare_weapon'], lootCount: 3 },
            'chemical_horror': { name: 'Chemick√° hr≈Øza', icon: 'üß´', hp: 280, damage: 32, defense: 12, xp: 280, loot: ['chemicals', 'mutant_blood', 'rare_armor', 'herbs'], lootCount: 3 },
            'zombie_chief': { name: 'Zombie n√°ƒçeln√≠k', icon: 'üëÆ', hp: 180, damage: 25, defense: 14, xp: 200, loot: ['weapon', 'armor', 'ammo', 'medkit', 'money'], lootCount: 3 },
            'project_x': { name: 'Projekt X', icon: 'üß¨', hp: 350, damage: 38, defense: 18, xp: 400, loot: ['legendary', 'electronics', 'rare_weapon', 'crystal', 'chemicals', 'gems'], lootCount: 4 }
        };
        
        // === NPC PRO VZTAHY ===
        const FRIENDLY_NPCS = [
            // === P≈ÆVODN√ç NPC ===
            { id: 'old_merchant', name: 'Star√Ω obchodn√≠k', icon: 'üë¥', location: 'trader_camp', 
              personality: 'Moudr√Ω a zku≈°en√Ω obchodn√≠k. Pamatuje ƒçasy p≈ôed v√°lkou.',
              background: 'P≈ôed v√°lkou vlastnil obchodn√≠ ≈ôetƒõzec. Teƒè obchoduje jen proto, aby lid√© p≈ôe≈æili.',
              gifts: ['food', 'water', 'medicine'],
              quests: ['find_goods', 'protect_caravan'], 
              rewards: { trust50: 'Sleva 20%', trust100: 'Sleva 25%' },
              relationships: { 'smuggler_radek': 'partner', 'kid_peta': 'inform√°tor' }
            },
            { id: 'scout_maya', name: 'Zvƒõdka Maya', icon: 'üèÉ‚Äç‚ôÄÔ∏è', location: 'watchtower', 
              personality: 'Rychl√° a odv√°≈æn√° pr≈Øzkumnice. V≈ædy v pohybu.',
              background: 'Sirotkem od pƒõti let. Nauƒçila se p≈ôe≈æ√≠t sama v pustinƒõ.',
              gifts: ['weapon', 'ammo', 'map'],
              quests: ['explore_area', 'find_survivor'], 
              rewards: { trust50: 'Odhalen√≠ mapy', trust100: 'Companion' },
              relationships: { 'hunter_viktor': 'obdiv', 'captain_novak': 'mo≈æn√Ω otec?' }
            },
            { id: 'doc_harris', name: 'Doktor Harris', icon: 'üë®‚Äç‚öïÔ∏è', location: 'hospital',
              personality: 'Laskav√Ω l√©ƒçitel. Nikdy neodm√≠tne pomoc.',
              background: 'Uƒçil se u Babiƒçky Marty. Jedin√Ω skuteƒçn√Ω doktor v kraji.',
              gifts: ['medicine', 'herbs', 'chemicals'],
              quests: ['gather_herbs', 'rescue_patient'], 
              rewards: { trust50: 'L√©ƒçen√≠ zdarma', trust100: 'Med. tr√©nink' },
              relationships: { 'grandma_marta': 'uƒçitelka', 'sister_anna': 'spolupr√°ce' }
            },
            { id: 'blacksmith_ivan', name: 'Kov√°≈ô Ivan', icon: 'üî®', location: 'workshop',
              personality: 'Hrub√Ω, ale zruƒçn√Ω ≈ôemesln√≠k. M√°lomluvn√Ω.',
              background: 'B√Ωval√Ω voj√°k. S kapit√°nem Nov√°kem slou≈æili ve stejn√© jednotce.',
              gifts: ['metal', 'scrap', 'tools'],
              quests: ['bring_metal', 'test_weapon'], 
              rewards: { trust50: 'Upgrade zbranƒõ', trust100: 'Legendary craft' },
              relationships: { 'captain_novak': 'kamar√°d', 'mechanic_pepa': 'dodavatel' }
            },
            { id: 'mysterious_woman', name: 'Z√°hadn√° ≈æena', icon: 'üîÆ', location: 'ruins_north',
              personality: 'Nikdo nev√≠ odkud p≈ôi≈°la. Mluv√≠ v h√°dank√°ch.',
              background: 'Pr√Ω byla vƒõdkyn√≠ p≈ôed v√°lkou. Nƒõkte≈ô√≠ ≈ô√≠kaj√≠, ≈æe vidƒõla budoucnost.',
              gifts: ['crystal', 'rare_item', 'book'],
              quests: ['find_artifact', 'solve_riddle'], 
              rewards: { trust50: 'Proroctv√≠', trust100: 'Tajn√° lokace' },
              relationships: { 'fortune_rosa': 'rivalka', 'elder_tomas': 'v√≠ pravdu', 'sister_anna': 'modl√≠ se za ni' }
            },
            
            // === KORY & KOUDY - HLAVN√ç P≈ò√çBƒöH ===
            { id: 'kory', name: 'Kory', icon: 'ü¶π', location: 'trading_post', 
              personality: 'Charismatick√Ω vizion√°≈ô. Mluv√≠ o "oƒçi≈°tƒõn√≠" svƒõta.',
              background: 'Bratr Koudyho. Vƒõ≈ô√≠, ≈æe star√Ω svƒõt mus√≠ b√Ωt zniƒçen, aby mohl vzniknout nov√Ω.',
              rival: 'koudy', faction: 'kory_followers',
              gifts: ['weapon', 'ammo', 'explosive'],
              quests: ['sabotage_koudy', 'steal_supplies', 'spread_chaos'], 
              rewards: { trust50: 'V√Ωbu≈°niny zdarma', trust100: 'Vyvolen√Ω' },
              relationships: { 'koudy': 'bratr/rival', 'crazy_jirka': 'v√≠ p≈ô√≠li≈°', 'grandma_marta': 'nen√°vist' }
            },
            { id: 'koudy', name: 'Koudy', icon: 'üë®‚Äçüî¨', location: 'research_facility', 
              personality: 'Unaven√Ω vƒõdec. Vƒõ≈ô√≠ v z√°chranu pomoc√≠ vƒõdy.',
              background: 'Bratr Koryho. Pracuje na l√©ku proti radiaci. Za jakou cenu?',
              rival: 'kory', faction: 'koudy_hope',
              gifts: ['medicine', 'food', 'tech'],
              quests: ['disrupt_kory', 'gather_intel', 'restore_order'], 
              rewards: { trust50: 'L√©ƒçen√≠ zdarma', trust100: 'Spolutv≈Ørce' },
              relationships: { 'kory': 'bratr/rival', 'engineer_klara': 'kolegynƒõ', 'captain_novak': 'respekt' }
            },
            
            // === NOV√ùCH 13 NPC ===
            { id: 'grandma_marta', name: 'Babiƒçka Marta', icon: 'üëµ', location: 'old_farm',
              personality: 'Star√° bylink√°≈ôka. Pamatuje si v≈°echno a v≈°echny.',
              background: 'Uƒçila Harrise v≈°emu co v√≠ o bylin√°ch. Ztratila celou rodinu ve v√°lce.',
              gifts: ['herbs', 'food', 'cloth'],
              quests: ['gather_herbs', 'find_family_photo'],
              rewards: { trust50: 'Bylinky zdarma', trust100: 'Tajn√Ω recept' },
              relationships: { 'doc_harris': '≈æ√°k', 'teacher_vera': 'p≈ô√≠telkynƒõ', 'kory': 'nen√°vist' }
            },
            { id: 'captain_novak', name: 'Kapit√°n Nov√°k', icon: 'üéñÔ∏è', location: 'checkpoint',
              personality: 'Disciplinovan√Ω voj√°k. Hled√° svou ztracenou dceru.',
              background: 'Velel jednotce p≈ôed v√°lkou. Jeho dcera zmizela den p≈ôed bombami.',
              gifts: ['ammo', 'weapon', 'armor'],
              quests: ['find_daughter', 'clear_outpost'],
              rewards: { trust50: 'Vojensk√Ω v√Ωcvik', trust100: 'Tajemstv√≠ o ƒåern√©m' },
              relationships: { 'blacksmith_ivan': 'kamar√°d', 'commander_cerny': 'bratr!', 'koudy': 'respekt', 'scout_maya': 'dcera?' }
            },
            { id: 'hunter_viktor', name: 'Lovec Viktor', icon: 'üèπ', location: 'dense_forest',
              personality: 'Samot√°≈ô. Mluv√≠ m√°lo, sleduje hodnƒõ.',
              background: '≈Ωije v lese u≈æ 10 let. Lid√© ho unavuj√≠. Zv√≠≈ôata jsou up≈ô√≠mnƒõj≈°√≠.',
              gifts: ['meat', 'leather', 'herbs'],
              quests: ['hunt_alpha', 'track_beast'],
              rewards: { trust50: 'Loveck√© tipy', trust100: 'Vz√°cn√° ko≈ôist' },
              relationships: { 'scout_maya': 'ignoruje ji', 'crazy_jirka': 'jedin√Ω p≈ô√≠tel' }
            },
            { id: 'mechanic_pepa', name: 'Mechanik Pepa', icon: 'üîß', location: 'junkyard',
              personality: 'G√©nius na stroje. Mluv√≠ v√≠c s motory ne≈æ s lidmi.',
              background: 'Opravil prvn√≠ auto po v√°lce. Sn√≠ o tom, ≈æe jednou znovu pojede vlak.',
              gifts: ['scrap', 'electronics', 'fuel'],
              quests: ['find_parts', 'repair_generator'],
              rewards: { trust50: 'Opravy levnƒõji', trust100: 'Opravy zdarma' },
              relationships: { 'blacksmith_ivan': 'dodavatel', 'engineer_klara': 'obdiv' }
            },
            { id: 'sister_anna', name: 'Sestra Anna', icon: '‚õ™', location: 'old_church',
              personality: 'Tich√° a laskav√°. Vƒõ≈ô√≠, ≈æe dobro p≈ôe≈æije.',
              background: 'Jedin√° p≈ôe≈æiv≈°√≠ z kl√°≈°tera. L√©ƒç√≠ du≈°e tam, kde Harris l√©ƒç√≠ tƒõla.',
              gifts: ['medicine', 'food', 'book'],
              quests: ['help_refugees', 'find_relic'],
              rewards: { trust50: 'Po≈æehn√°n√≠', trust100: 'Svat√° relikvie' },
              relationships: { 'doc_harris': 'spolupr√°ce', 'mysterious_woman': 'modl√≠ se za ni', 'teacher_vera': 'p≈ô√≠telkynƒõ' }
            },
            { id: 'smuggler_radek', name: 'Pa≈°er√°k Radek', icon: 'üé≠', location: 'highway',
              personality: '≈†ed√° eminence. V√≠ v≈°echno o v≈°ech.',
              background: 'P≈ôed v√°lkou pracoval pro vl√°du. Nebo proti n√≠. Nikdo nev√≠ jistƒõ.',
              gifts: ['rare_item', 'ammo', 'medicine'],
              quests: ['deliver_package', 'gather_intel'],
              rewards: { trust50: 'ƒåern√Ω trh', trust100: 'Velk√© tajemstv√≠' },
              relationships: { 'old_merchant': 'partner', 'kid_peta': 'inform√°tor', 'commander_cerny': 'obchod' }
            },
            { id: 'teacher_vera', name: 'Uƒçitelka Vƒõra', icon: 'üìö', location: 'ruined_village',
              personality: 'Ochr√°nkynƒõ dƒõt√≠. Vede jedinou ≈°kolu v pustinƒõ.',
              background: 'Zachr√°nila 12 sirotk≈Ø. Uƒç√≠ je ƒç√≠st, poƒç√≠tat a hlavnƒõ p≈ôe≈æ√≠t.',
              gifts: ['book', 'food', 'cloth'],
              quests: ['find_books', 'protect_children'],
              rewards: { trust50: 'Vzdƒõl√°n√≠ (+XP)', trust100: 'Sirotek companion' },
              relationships: { 'grandma_marta': 'p≈ô√≠telkynƒõ', 'sister_anna': 'p≈ô√≠telkynƒõ', 'kid_peta': '≈æ√°k' }
            },
            { id: 'crazy_jirka', name: '≈†√≠len√Ω Jirka', icon: 'ü§™', location: 'swamp',
              personality: 'Bl√°zen? Nebo jedin√Ω, kdo vid√≠ pravdu?',
              background: 'Tvrd√≠, ≈æe vidƒõl co Kory opravdu pl√°nuje. Nikdo mu nevƒõ≈ô√≠.',
              gifts: ['herbs', 'crystal', 'strange_item'],
              quests: ['listen_to_truth', 'find_proof'],
              rewards: { trust50: 'Varov√°n√≠', trust100: 'PRAVDA O KORYM' },
              relationships: { 'hunter_viktor': 'jedin√Ω p≈ô√≠tel', 'kory': 'v√≠ pravdu' }
            },
            { id: 'elder_tomas', name: 'Sta≈ôec Tom√°≈°', icon: 'üßì', location: 'hermit_hut',
              personality: 'Poustevn√≠k. Zn√° historii tohoto m√≠sta.',
              background: '≈Ωil tu cel√Ω ≈æivot. V√≠ vƒõci, kter√© ostatn√≠ zapomnƒõli nebo nikdy nevƒõdƒõli.',
              gifts: ['book', 'crystal', 'rare_item'],
              quests: ['hear_history', 'find_old_place'],
              rewards: { trust50: 'Historie kraje', trust100: 'Pravda o Z√°hadn√© ≈æenƒõ' },
              relationships: { 'mysterious_woman': 'v√≠ kdo je', 'fortune_rosa': 'ne≈ôekne pravdu' }
            },
            { id: 'engineer_klara', name: 'In≈æen√Ωrka Kl√°ra', icon: 'üë©‚Äçüî¨', location: 'power_plant',
              personality: 'Vƒõdkynƒõ. Kritick√°, ale f√©rov√°.',
              background: 'Pracovala s Koudym. Ode≈°la, kdy≈æ zjistila... nƒõco.',
              gifts: ['electronics', 'chemicals', 'tech'],
              quests: ['repair_reactor', 'investigate_koudy'],
              rewards: { trust50: 'Tech vylep≈°en√≠', trust100: 'D≈Økazy proti Koudymu' },
              relationships: { 'koudy': 'b√Ωval√° kolegynƒõ', 'mechanic_pepa': 'obdivovatel' }
            },
            { id: 'commander_cerny', name: 'Velitel ƒåern√Ω', icon: 'üíÄ', location: 'raider_camp',
              personality: 'V≈Ødce n√°jezdn√≠k≈Ø. Ale je opravdu zl√Ω?',
              background: 'Bratr kapit√°na Nov√°ka. Proƒç se stal t√≠m, ƒç√≠m je?',
              gifts: ['weapon', 'ammo', 'rare_item'],
              quests: ['prove_yourself', 'hear_his_story'],
              rewards: { trust50: 'P≈ô√≠mƒõ≈ô√≠', trust100: 'Pravda o v√°lce' },
              relationships: { 'captain_novak': 'bratr!', 'smuggler_radek': 'obchod' }
            },
            { id: 'kid_peta', name: 'P√©≈•a', icon: 'üë¶', location: 'safehouse',
              personality: 'Sirotek. V≈°ude proleze, v≈°echno sly≈°√≠.',
              background: 'Rodiƒçe zem≈ôeli. P≈ôe≈æ√≠v√° t√≠m, ≈æe prod√°v√° informace.',
              gifts: ['food', 'water', 'toy'],
              quests: ['find_toy', 'deliver_message'],
              rewards: { trust50: 'Drby', trust100: 'Tajn√° cesta' },
              relationships: { 'old_merchant': 'inform√°tor', 'smuggler_radek': 'inform√°tor', 'teacher_vera': '≈æ√°k' }
            },
            { id: 'fortune_rosa', name: 'Kart√°≈ôka Rosa', icon: 'üÉè', location: 'bucovice',
              personality: 'Vƒõ≈°tkynƒõ v hospodƒõ. Rivalka Z√°hadn√© ≈æeny.',
              background: 'Tvrd√≠, ≈æe jej√≠ vƒõ≈°tby jsou pravdiv√©. Z√°hadnou ≈æenu nen√°vid√≠.',
              gifts: ['crystal', 'rare_item', 'money'],
              quests: ['get_reading', 'discredit_rival'],
              rewards: { trust50: 'Vƒõ≈°tba', trust100: 'Le≈æ o Z√°hadn√© ≈æenƒõ' },
              relationships: { 'mysterious_woman': 'rivalka', 'elder_tomas': 'chce pravdu' }
            },
            
            // === NOV√ç NPC PRO SPECI√ÅLN√ç QUESTY ===
            { id: 'sheriff_kowalski', name: '≈†erif Kowalski', icon: 'üéñÔ∏è', location: 'crossroads',
              personality: 'Star√Ω str√°≈æce z√°kona. Jedin√Ω, kdo se sna≈æ√≠ udr≈æet po≈ô√°dek.',
              background: 'B√Ωval√Ω policista. St√°le nos√≠ odznak a vƒõ≈ô√≠ ve spravedlnost.',
              gifts: ['ammo', 'weapon', 'food'],
              quests: ['detective_quest'],  // Speci√°ln√≠ - d√°v√° detektivn√≠ questy
              rewards: { trust50: 'P≈ô√≠stup k d≈Økaz≈Øm', trust100: 'Z√°stupce ≈°erifa' },
              relationships: { 'captain_novak': 'respekt', 'commander_cerny': 'nep≈ô√≠tel' },
              specialQuests: ['murdered_trader', 'missing_child', 'poisoned_well']  // Detektivn√≠ questy
            },
            { id: 'messenger_jin', name: 'Posel Jin', icon: 'üì®', location: 'broken_bridge',
              personality: 'Rychl√Ω a spolehliv√Ω. P≈ôin√°≈°√≠ zpr√°vy z cel√©ho kraje.',
              background: 'Bƒõh√° mezi osadami a p≈ôin√°≈°√≠ zpr√°vy. Zn√° ka≈ædou cestu.',
              gifts: ['food', 'water', 'money'],
              quests: ['urgent_quest'],  // Speci√°ln√≠ - d√°v√° ƒçasov√© questy
              rewards: { trust50: 'Rychlej≈°√≠ cestov√°n√≠', trust100: 'Tajn√© zkratky' },
              relationships: { 'old_merchant': 'z√°kazn√≠k', 'kid_peta': 'konkurent' },
              specialQuests: ['rescue_hostage', 'deliver_medicine', 'defuse_bomb', 'escape_horde']  // ƒåasov√© questy
            }
        ];
        
        // === PROPRACOVAN√â DIALOGY ===
        const NPC_DIALOGUES = {
            // Ka≈æd√© NPC m√° dialogy podle √∫rovnƒõ d≈Øvƒõry a kontextu
            'old_merchant': {
                greeting: {
                    low: [
                        "Hmm, dal≈°√≠ z√°kazn√≠k? Co pot≈ôebuje≈°?",
                        "Obchod je obchod. Co nab√≠z√≠≈°?"
                    ],
                    medium: [
                        "√Å, to jsi ty! Jak se da≈ô√≠ v pustinƒõ?",
                        "V√≠tej zpƒõt, p≈ô√≠teli. M√°m pro tebe nƒõco zaj√≠mav√©ho."
                    ],
                    high: [
                        "Star√Ω p≈ô√≠teli! Pojƒè d√°l, pov√≠me si u ohnƒõ.",
                        "Tƒõ≈°√≠ mƒõ, ≈æe tƒõ vid√≠m. M√°lo je lid√≠, kter√Ωm m≈Ø≈æu vƒõ≈ôit."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "*povzdech* P≈ôed v√°lkou jsem vlastnil dvacet obchod≈Ø. Teƒè m√°m jen tento st√°nek a vzpom√≠nky.",
                            "Obchoduji u≈æ pades√°t let. Vidƒõl jsem, jak lid√© dok√°≈æou b√Ωt krut√≠. Ale i laskav√≠.",
                            "Pen√≠ze? Nezaj√≠maj√≠ mƒõ. Chci jen, aby lid√© mƒõli co j√≠st a ƒç√≠m se br√°nit."
                        ],
                        trustRequired: 0
                    },
                    'about_radek': {
                        lines: [
                            "Radek? *rozhl√©dne se* Ten chlap v√≠ vƒõci. Nebezpeƒçn√© vƒõci.",
                            "Spolupracujeme. On se≈æene, j√° prod√°m. Neptej se na v√≠c.",
                            "Jestli chce≈° nƒõco speci√°ln√≠ho... Radek to m≈Ø≈æe sehnat. Za cenu."
                        ],
                        trustRequired: 30
                    },
                    'about_kory': {
                        lines: [
                            "Kory... *zavrt√≠ hlavou* Ten mlad√≠k m√° v oƒç√≠ch ohe≈à. Ale ne ten dobr√Ω.",
                            "Vidƒõl jsem takov√© jako on p≈ôed v√°lkou. V≈ædycky to skonƒçilo ≈°patnƒõ.",
                            "Poslouchej, v√≠m ≈æe je charismatick√Ω. Ale pozor na ty, kdo slibuj√≠ r√°j."
                        ],
                        trustRequired: 50
                    },
                    'secret': {
                        lines: [
                            "*≈°ept√°* V√≠≈° proƒç vlastnƒõ v√°lka zaƒçala? Nebyla to n√°hoda.",
                            "Nƒõkdo ji chtƒõl. A mysl√≠m, ≈æe Kory v√≠ kdo. Nebo je jeho souƒç√°st√≠.",
                            "Najdi Jirku v ba≈æin√°ch. Je bl√°zen, ale... on tam BYL. On to VIDƒöL."
                        ],
                        trustRequired: 80
                    }
                },
            },
            
            'grandma_marta': {
                greeting: {
                    low: [
                        "*p≈ôimhou≈ô√≠ oƒçi* Dal≈°√≠ tul√°k. Co chce≈°, mlad√≠ku?",
                        "Nem√°m ƒças na pov√≠d√°n√≠. Co pot≈ôebuje≈°?"
                    ],
                    medium: [
                        "Ty jsi ten, co pom√°h√° lidem. Pojƒè d√°l.",
                        "Uva≈ô√≠m ti ƒçaj. Posaƒè se a pov√≠me si."
                    ],
                    high: [
                        "D√≠tƒõ moje! *obejme tƒõ* Tak r√°d tƒõ vid√≠m!",
                        "Pojƒè, pojƒè. M√°m pro tebe nƒõco dobr√©ho z bylinek."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "≈Ωiju tu sedmdes√°t let. Pamatuju ƒçasy, kdy tu kvetly jablonƒõ.",
                            "Mƒõla jsem t≈ôi dƒõti. V≈°echny mi je vzala v√°lka. *slza*",
                            "Teƒè uƒç√≠m mlad√©, co v√≠m. Harris byl m≈Øj nejlep≈°√≠ ≈æ√°k."
                        ],
                        trustRequired: 0
                    },
                    'about_harris': {
                        lines: [
                            "Mal√Ω Thomas... teda doktor Harris. P≈ôi≈°el ke mnƒõ jako chlapec.",
                            "Nauƒçila jsem ho v≈°echno o bylin√°ch. O l√©ƒçen√≠. O lidech.",
                            "Je to dobr√Ω ƒçlovƒõk. Mo≈æn√° jedin√Ω opravdu dobr√Ω v tomhle proklet√©m svƒõtƒõ."
                        ],
                        trustRequired: 20
                    },
                    'about_vera': {
                        lines: [
                            "Vƒõra je jako dcera, kterou jsem ztratila. Chr√°n√≠ ty dƒõti jako lvice.",
                            "Chod√≠m j√≠ pom√°hat uƒçit. Star√© recepty, star√© p≈ô√≠bƒõhy...",
                            "V tƒõch dƒõtech je nadƒõje. Jedin√° nadƒõje."
                        ],
                        trustRequired: 30
                    },
                    'about_kory': {
                        lines: [
                            "*zho≈ôkne* Ten had! Ne≈ô√≠kej to jm√©no v m√©m domƒõ!",
                            "Znala jsem ho jako d√≠tƒõ. U≈æ tehdy mƒõl v oƒç√≠ch tmu.",
                            "On a jeho bratr... rozbili svƒõt. A teƒè ho chtƒõj√≠ znovu."
                        ],
                        trustRequired: 40
                    },
                    'secret': {
                        lines: [
                            "*≈°ept√°* Kory nen√≠ ten, za koho se vyd√°v√°.",
                            "P≈ôed v√°lkou... pracoval pro VL√ÅDU. Na tom projektu.",
                            "Projekt Genesis. On ho nezastavil. On ho SPUSTIL."
                        ],
                        trustRequired: 90
                    }
                },
                mentions: {
                    'doc_harris': "M≈Øj ≈æ√°k. Hrd√° jsem na nƒõj.",
                    'teacher_vera': "Jako m√° vlastn√≠ dcera.",
                    'kory': "ƒé√°bel v lidsk√© k≈Ø≈æi."
                }
            },
            
            'captain_novak': {
                greeting: {
                    low: [
                        "*salutuje* Civilista. Identifikuj se.",
                        "Toto je vojensk√° z√≥na. Co tu pohled√°v√°≈°?"
                    ],
                    medium: [
                        "√Å, ty. Sly≈°el jsem o tobƒõ dobr√© vƒõci. Pohodƒõ.",
                        "Vstup povolen. M√°≈° pƒõt minut."
                    ],
                    high: [
                        "P≈ô√≠teli! *pod√° ruku* Pojƒè d√°l, m√°me co probrat.",
                        "R√°d tƒõ vid√≠m. Pot≈ôeboval bych tvou pomoc s nƒõƒç√≠m... osobn√≠m."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "Kapit√°n Nov√°k. T≈ôet√≠ mechanizovan√°. Nebo to, co z n√≠ zbylo.",
                            "Velel jsem stovce mu≈æ≈Ø. Teƒè jich m√°m osm.",
                            "Dr≈æ√≠me linii. Chr√°n√≠me civilisty. To je n√°≈° √∫ƒçel."
                        ],
                        trustRequired: 0
                    },
                    'about_daughter': {
                        lines: [
                            "*hlas se zlom√≠* M√° dcera... Emma. Zmizela den p≈ôed bombami.",
                            "Hled√°m ji deset let. DESET LET.",
                            "Nƒõkdy si ≈ô√≠k√°m... mo≈æn√° je mrtv√°. Ale nem≈Ø≈æu p≈ôestat hledat."
                        ],
                        trustRequired: 40
                    },
                    'about_ivan': {
                        lines: [
                            "Ivan? Slou≈æili jsme spolu. Zachr√°nil mi ≈æivot. Dvakr√°t.",
                            "Dobr√Ω voj√°k. Lep≈°√≠ p≈ô√≠tel. Jeden z m√°la, kter√Ωm vƒõ≈ô√≠m.",
                            "Teƒè kove m√≠sto toho, aby bojoval. Mo≈æn√° je moud≈ôej≈°√≠ ne≈æ j√°."
                        ],
                        trustRequired: 20
                    },
                    'about_cerny': {
                        lines: [
                            "*dlouh√© ticho* ƒåern√Ω... je m≈Øj bratr.",
                            "Martin ƒåern√Ω. M≈Øj mlad≈°√≠ bratr. Teƒè vede n√°jezdn√≠ky.",
                            "Nev√≠m co se stalo. Co ho zlomilo. Ale jednou... mus√≠me si promluvit."
                        ],
                        trustRequired: 70
                    },
                    'secret': {
                        lines: [
                            "M√° dcera... na≈°el jsem stopu. Maya...",
                            "*ticho* Ona nev√≠ kdo je. Ale ty rysy. Ten vƒõk. To mus√≠ b√Ωt ona.",
                            "Nem≈Ø≈æu j√≠ to ≈ô√≠ct. Je≈°tƒõ ne. Pot≈ôebuji d≈Økaz."
                        ],
                        trustRequired: 95
                    }
                },
                mentions: {
                    'blacksmith_ivan': "Bratr ve zbrani. Vƒõ≈ô√≠m mu ≈æivotem.",
                    'commander_cerny': "M≈Øj bratr. *bolestn√Ω pohled*",
                    'scout_maya': "Ta d√≠vka... p≈ôipom√≠n√° mi nƒõkoho."
                }
            },
            
            'crazy_jirka': {
                greeting: {
                    low: [
                        "*bl√°bolivƒõ* ONI p≈ôich√°zej√≠! ONI V√ç!",
                        "TY! Jsi jeden z NICH? Ne? DOKAA≈Ω TO!"
                    ],
                    medium: [
                        "*klidnƒõji* √Å. Ty. Ty aspo≈à poslouch√°≈°.",
                        "P≈ôi≈°el jsi sly≈°et pravdu? Nebo jen dal≈°√≠ l≈æi?"
                    ],
                    high: [
                        "*jasnƒõ* P≈ô√≠teli. Ty mi vƒõ≈ô√≠≈°, ≈æe?",
                        "Pojƒè bl√≠≈æ. M√°m ti co ≈ô√≠ct. Ale ONI nesm√≠ sly≈°et."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "≈ò√≠kaj√≠ mi ≈°√≠lenec. ALE J√Å JSEM TAM BYL!",
                            "Vidƒõl jsem to. V laborato≈ôi. V NOC P≈òED BOMBAMI.",
                            "Nikdo mi nevƒõ≈ô√≠. *pl√°ƒçe* Nikdo..."
                        ],
                        trustRequired: 0
                    },
                    'about_viktor': {
                        lines: [
                            "Viktor? On je jedin√Ω, kdo mƒõ nepova≈æuje za bl√°zna.",
                            "Nos√≠ mi j√≠dlo. Nemluv√≠, ale... ch√°pe.",
                            "On taky v√≠, ≈æe svƒõt je zka≈æen√Ω. Proto ≈æije se zv√≠≈ôaty."
                        ],
                        trustRequired: 20
                    },
                    'what_he_saw': {
                        lines: [
                            "*t≈ôese se* Ta laborato≈ô... pod mƒõstem... VIDƒöL JSEM JE!",
                            "Kory. A dal≈°√≠. Kolem TLAƒå√çTKA. Sm√°li se!",
                            "Oni to CHTƒöLI! Bomby! V≈°echno! BYL TO PL√ÅN!"
                        ],
                        trustRequired: 50
                    },
                    'secret': {
                        lines: [
                            "*√∫plnƒõ jasnƒõ* Poslouchej pozornƒõ. M√°m d≈Økaz.",
                            "Schoval jsem dokumenty. V ba≈æin√°ch. Pod mrtv√Ωm stromem.",
                            "Projekt Genesis. Kory ho nevynalezl. On ho SPUSTIL. Z√°mƒõrnƒõ."
                        ],
                        trustRequired: 80
                    }
                },
                mentions: {
                    'hunter_viktor': "M≈Øj jedin√Ω p≈ô√≠tel. On ch√°pe.",
                    'kory': "ƒé√ÅBEL! V√çM CO JSI UDƒöLAL!"
                }
            },
            
            'mysterious_woman': {
                greeting: {
                    low: [
                        "*ti≈°e* Proƒç jsi p≈ôi≈°el? Co hled√°≈°?",
                        "Vid√≠m... temnotu. A svƒõtlo. Oboj√≠ v tobƒõ."
                    ],
                    medium: [
                        "Tv√° cesta je zaj√≠mav√°. Pojƒè bl√≠≈æ.",
                        "ƒåas je ≈ôeka. Ty jsi k√°men. Zmƒõn√≠≈° jej√≠ tok?"
                    ],
                    high: [
                        "*√∫smƒõv* Koneƒçnƒõ jsi p≈ôipraven sly≈°et.",
                        "V√≠m proƒç jsi p≈ôi≈°el. A m√°m pro tebe odpovƒõdi."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "Kdo jsem? *z√°hadn√Ω √∫smƒõv* Kdo jsme v≈°ichni?",
                            "Byla jsem nƒõk√Ωm jin√Ωm. P≈ôed v√°lkou. P≈ôed v≈°√≠m.",
                            "Teƒè jsem jen ta, kter√° V√ç. A ƒçek√°."
                        ],
                        trustRequired: 0
                    },
                    'about_rosa': {
                        lines: [
                            "Rosa? *lehk√Ω sm√≠ch* Vƒõ≈°tkynƒõ, kter√° nevid√≠.",
                            "Ona ƒçte karty. J√° ƒçtu osud.",
                            "Nen√°vid√≠ mƒõ, proto≈æe v√≠, ≈æe m√°m pravdu."
                        ],
                        trustRequired: 30
                    },
                    'about_tomas': {
                        lines: [
                            "Sta≈ôec Tom√°≈°... jeden z m√°la, kdo si pamatuje.",
                            "On v√≠ kdo jsem. Ale ne≈ôekne. Dobr√Ω mu≈æ.",
                            "A≈æ bude≈° p≈ôipraven, jdi za n√≠m. On ti pov√≠ zbytek."
                        ],
                        trustRequired: 60
                    },
                    'secret': {
                        lines: [
                            "*sund√° kapuci* Pozn√°v√°≈° mƒõ?",
                            "Jmenovala jsem se... Dr. Eva Nov√°kov√°. Vedla jsem Projekt Genesis.",
                            "Chtƒõla jsem zachr√°nit svƒõt. M√≠sto toho jsem ho zniƒçila. *slzy*"
                        ],
                        trustRequired: 100
                    }
                },
                mentions: {
                    'fortune_rosa': "Slep√° vƒõ≈°tkynƒõ. Nev√≠ nic.",
                    'elder_tomas': "Star√Ω p≈ô√≠tel. Str√°≈æce m√©ho tajemstv√≠."
                }
            },
            
            'commander_cerny': {
                greeting: {
                    low: [
                        "*ruka na zbrani* St≈Øj! Proƒç bych tƒõ nemƒõl zab√≠t?",
                        "Dal≈°√≠ hrdina? Posledn√≠ t≈ôi jsou zakop√°ni tamhle."
                    ],
                    medium: [
                        "*p≈ôimhou≈ô√≠ oƒçi* Ty m√°≈° koule. Respektuju to.",
                        "P≈ôi≈°el jsi obchodovat? Nebo zem≈ô√≠t?"
                    ],
                    high: [
                        "*m√°vne str√°≈æe pryƒç* Nech n√°s. Tohle je... p≈ô√≠tel.",
                        "Pojƒè ke mnƒõ. M√°me si co ≈ô√≠ct. O minulosti."
                    ]
                },
                topics: {
                    'about_self': {
                        lines: [
                            "Jsem ƒåern√Ω. V≈Ødce tƒõchto mu≈æ≈Ø. To je v≈°e co pot≈ôebuje≈° vƒõdƒõt.",
                            "N√°jezdn√≠ci? Mo≈æn√°. P≈ôe≈æ√≠vaj√≠c√≠? Urƒçitƒõ.",
                            "Dƒõl√°m co mus√≠m. Jako v≈ædycky."
                        ],
                        trustRequired: 0
                    },
                    'about_novak': {
                        lines: [
                            "*dlouh√© ticho* M≈Øj bratr. Kapit√°n spravedliv√Ω.",
                            "Nevidƒõl jsem ho deset let. Nechci.",
                            "On nech√°pe. NIKDY nepochopil proƒç jsem ode≈°el."
                        ],
                        trustRequired: 50
                    },
                    'why_raider': {
                        lines: [
                            "Chce≈° vƒõdƒõt proƒç? *ho≈ôk√Ω sm√≠ch*",
                            "Vidƒõl jsem co ARM√ÅDA udƒõlala. NA≈†E arm√°da. Civilist≈Øm.",
                            "Rozkazy shora. 'Vyƒçistit oblast.' Vƒõdƒõl jsem co to znamen√°."
                        ],
                        trustRequired: 70
                    },
                    'secret': {
                        lines: [
                            "Neode≈°el jsem, proto≈æe jsem zbabƒõlec. Ode≈°el jsem, proto≈æe jsem ODM√çTL.",
                            "Rozkaz byl... zab√≠t vesnici. ≈Ωeny. Dƒõti. 'Potenci√°ln√≠ naka≈æen√≠.'",
                            "Tak jsem vzal ty, kte≈ô√≠ taky odm√≠tli. A stal jsem se 'zloƒçincem'."
                        ],
                        trustRequired: 90
                    }
                },
                mentions: {
                    'captain_novak': "M≈Øj bratr. *bolest* K√©≈æ by pochopil.",
                    'smuggler_radek': "Obchodn√≠ partner. Spolehliv√Ω."
                }
            },
            
            // Ostatn√≠ NPC maj√≠ jednodu≈°≈°√≠ dialogy
            'scout_maya': {
                greeting: {
                    low: ["Kdo jsi? Vypad√°≈°... *prohl√≠≈æ√≠ tƒõ* ...pou≈æitelnƒõ."],
                    medium: ["Hej! M√°≈° pro mƒõ nƒõjakou pr√°ci? Nud√≠m se."],
                    high: ["*zam√°v√°* K√°mo! Pojƒè, m√°m co uk√°zat!"]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem Maya. Pr≈Øzkumnice. Nejrychlej≈°√≠ v pustinƒõ.", "Rodiƒçe? *pokrƒç√≠ rameny* Nepamatuju je."],
                        trustRequired: 0
                    },
                    'about_viktor': {
                        lines: ["Viktor? *zƒçerven√°* Je... dobr√Ω lovec. Nic v√≠c.", "Chtƒõla bych aby mƒõ uƒçil. Ale ignoruje mƒõ."],
                        trustRequired: 20
                    }
                },
                mentions: { 'hunter_viktor': "*zƒçerven√°* On je... prostƒõ dobr√Ω." }
            },
            
            'doc_harris': {
                greeting: {
                    low: ["Jsi zranƒõn√Ω? Uka≈æ. Pom≈Ø≈æu."],
                    medium: ["√Å, p≈ô√≠teli! Pojƒè d√°l, d√°m ti ƒçaj."],
                    high: ["*≈°irok√Ω √∫smƒõv* Tak r√°d tƒõ vid√≠m zdrav√©ho!"]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem doktor. Jedin√Ω tady kolem. Marta mƒõ uƒçila, kdy≈æ jsem byl mlad√Ω.", "L√©ƒç√≠m v≈°echny. N√°jezdn√≠ky, voj√°ky... bolest je stejn√°."],
                        trustRequired: 0
                    },
                    'about_marta': {
                        lines: ["Marta? *nƒõ≈ænƒõ* Ta ≈æena mi dala v≈°echno. Nadƒõji, znalosti, smysl.", "Bez n√≠ bych byl jen dal≈°√≠ loupe≈æn√≠k."],
                        trustRequired: 20
                    }
                },
                mentions: { 'grandma_marta': "M√° uƒçitelka. Dlu≈æ√≠m j√≠ ≈æivot." }
            },
            
            'blacksmith_ivan': {
                greeting: {
                    low: ["*bouchne kladivem* Co chce≈°?"],
                    medium: ["*p≈ôik√Ωvne* Zbra≈à nebo zbroj?"],
                    high: ["*odlo≈æ√≠ kladivo* Poƒçkej. D√°m si s tebou pauzu."]
                },
                topics: {
                    'about_self': {
                        lines: ["Kov√°≈ô. B√Ωval√Ω voj√°k. To je v≈°e.", "*ukazuje jizvu* Tohle mi zachr√°nil Nov√°k. Dlu≈æ√≠m mu."],
                        trustRequired: 0
                    },
                    'about_novak': {
                        lines: ["Slou≈æili jsme spolu. Dobr√Ω velitel. Lep≈°√≠ ƒçlovƒõk.", "Hled√° dceru. Deset let. *zavrt√≠ hlavou* Smutn√©."],
                        trustRequired: 30
                    }
                },
                mentions: { 'captain_novak': "Kamar√°d. Bratr ve zbrani." }
            },
            
            'hunter_viktor': {
                greeting: {
                    low: ["*ticho, jen p≈ôik√Ωvne*"],
                    medium: ["*p≈ôik√Ωvne* Nƒõco chce≈°?"],
                    high: ["*poprv√© √∫smƒõv* Posaƒè se. M√°m maso."]
                },
                topics: {
                    'about_self': {
                        lines: ["*dlouh√© ticho* Les. To je v≈°e co pot≈ôebuju.", "Lid√© l≈æou. Zv√≠≈ôata ne."],
                        trustRequired: 0
                    },
                    'about_jirka': {
                        lines: ["Jirka nen√≠ bl√°zen. *v√°≈ænƒõ* On nƒõco vidƒõl.", "Nos√≠m mu j√≠dlo. Ostatn√≠ ho ignoruj√≠."],
                        trustRequired: 40
                    }
                },
                mentions: { 'crazy_jirka': "Nen√≠ bl√°zen. Jen vidƒõl p≈ô√≠li≈°." }
            },
            
            'kory': {
                greeting: {
                    low: ["*charismaticky* V√≠tej, poutn√≠ku! Hled√°≈° pravdu?"],
                    medium: ["*polo≈æ√≠ ruku na rameno* Vƒõdƒõl jsem, ≈æe se vr√°t√≠≈°."],
                    high: ["Brat≈ôe! *obejme tƒõ* Jsi p≈ôipraven zmƒõnit svƒõt?"]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem Kory. Vizion√°≈ô. Ten, kdo vid√≠ cestu.", "Star√Ω svƒõt byl zka≈æen√Ω. Zniƒçili jsme ho. Teƒè budujeme nov√Ω."],
                        trustRequired: 0
                    },
                    'about_koudy': {
                        lines: ["M≈Øj bratr... *zavrt√≠ hlavou* Ztratil se ve vƒõdƒõ.", "On chce OPRAVIT star√Ω svƒõt. J√° chci NOV√ù.", "Jednou pochop√≠. Nebo... nepochop√≠."],
                        trustRequired: 30
                    }
                },
                mentions: { 'koudy': "M≈Øj bratr. Zaslepen√Ω vƒõdou." }
            },
            
            'koudy': {
                greeting: {
                    low: ["*unavenƒõ* Dal≈°√≠ p≈ôeru≈°en√≠. Co pot≈ôebuje≈°?"],
                    medium: ["*odlo≈æ√≠ n√°stroje* Dob≈ôe. M√°m p√°r minut."],
                    high: ["*up≈ô√≠mn√Ω √∫smƒõv* P≈ô√≠teli. Pojƒè, uk√°≈æu ti pokroky."]
                },
                topics: {
                    'about_self': {
                        lines: ["Jsem vƒõdec. Pracuji na l√©ku proti radiaci.", "M≈Øj bratr... zniƒçil svƒõt. J√° ho oprav√≠m."],
                        trustRequired: 0
                    },
                    'about_kory': {
                        lines: ["Kory... *dlouh√© ticho* Je nemocn√Ω. V hlavƒõ.", "On CHTƒöL tu v√°lku. J√° jsem... pomohl. *ho≈ôce*", "Teƒè se to sna≈æ√≠m napravit."],
                        trustRequired: 50
                    }
                },
                mentions: { 'kory': "M≈Øj bratr. Moje selh√°n√≠." }
            }
        };
        
        // Vztahy mezi NPC - kdo o kom mluv√≠
        const NPC_RELATIONSHIP_HINTS = {
            'scout_maya': { 'captain_novak': 'M√° podobn√© oƒçi jako on... zvl√°≈°tn√≠.' },
            'captain_novak': { 'scout_maya': 'Ta d√≠vka... m√° Emminy oƒçi.' },
            'mysterious_woman': { 'kory': 'On v√≠ kdo jsem. A boj√≠ se t√© pravdy.' },
            'crazy_jirka': { 'kory': 'VIDƒöL JSEM CO UDƒöLAL! M√ÅM D≈ÆKAZ!' },
            'grandma_marta': { 'doc_harris': 'M≈Øj nejlep≈°√≠ ≈æ√°k. Jsem na nƒõj hrd√°.' },
            'elder_tomas': { 'mysterious_woman': 'V√≠m kdo je. Ale to tajemstv√≠ mus√≠ odhalit sama.' }
        };
        
        // NPC questy
        const NPC_QUESTS = {
            'find_goods': { 
                name: 'Dones z√°soby', 
                desc: 'M≈Øj zn√°m√Ω pot≈ôebuje z√°soby. Donese≈° mu je?', 
                details: 'üì¶ Nasb√≠rej 10 surovin a dones je c√≠lov√©mu NPC. C√≠l se ti zobraz√≠ po nasb√≠r√°n√≠.',
                requirement: { resources: 10, deliver: true }, 
                reward: { money: 200, trust: 15 },
                deliverTargets: ['elder_tomas', 'mysterious_woman', 'blacksmith_ivan', 'doc_harris', 'grandma_marta', 'teacher_vera']
            },
            'protect_caravan': { 
                name: 'Ochra≈à karavanu', 
                desc: 'Doprovoƒè mou karavanu.', 
                details: 'üê™ Cestuj na 3 r≈Øzn√© lokace a p≈ôe≈æij p≈ô√≠padn√© souboje. Pak se vra≈• pro odmƒõnu.',
                requirement: { escort: true, travels: 3 }, 
                reward: { money: 300, trust: 20, item: 'rare' } 
            },
            'explore_area': { 
                name: 'Prozkoumej oblast', 
                desc: 'Pot≈ôebuji ƒçerstv√© informace o okol√≠.', 
                details: 'üó∫Ô∏è Nav≈°tiv 5 NOV√ùCH lokac√≠ po p≈ôijet√≠ √∫kolu. Star√© mapy jsou k niƒçemu.',
                requirement: { explore: 5 }, 
                reward: { xp: 150, trust: 15 } 
            },
            'find_survivor': { 
                name: 'Najdi p≈ôe≈æiv≈°√≠ho', 
                desc: 'Hled√°m sv√©ho bratra.', 
                details: 'üë§ Prozkoumej okoln√≠ lokace. Bratr byl naposledy vidƒõn u opu≈°tƒõn√Ωch budov.',
                requirement: { find_npc: true }, 
                reward: { trust: 30, companion: true } 
            },
            'gather_herbs': { 
                name: 'Sbƒõr ƒçerstv√Ωch bylin', 
                desc: 'Pot≈ôebuji ƒåERSTV√â byliny, ne su≈°en√©!', 
                details: 'üåø Nasb√≠rej 15 bylin PO p≈ôijet√≠ √∫kolu. Na l√©ky pot≈ôebuji ƒçerstv√© - star√© ztratily √∫ƒçinnost.',
                requirement: { herbs: 15 }, 
                reward: { money: 100, trust: 10, item: 'medkit' } 
            },
            'rescue_patient': { 
                name: 'Zachra≈à pacienta', 
                desc: 'Pacient je uvƒõznƒõn n√°jezdn√≠ky.', 
                details: '‚öîÔ∏è Najdi t√°bor n√°jezdn√≠k≈Ø, poraz je a osvoboƒè zajatce.',
                requirement: { rescue: true }, 
                reward: { trust: 25, medical_training: true } 
            },
            'bring_metal': { 
                name: 'ƒåerstv√Ω kovov√Ω ≈°rot', 
                desc: 'Pot≈ôebuji nerezav√Ω kov, ƒçerstvƒõ sebran√Ω!', 
                details: 'üî© Nasb√≠rej 20 kovu PO p≈ôijet√≠ √∫kolu. Star√Ω ≈°rot z invent√°≈ôe je u≈æ zkorodovan√Ω.',
                requirement: { metal: 20 }, 
                reward: { money: 150, trust: 10 } 
            },
            'test_weapon': { 
                name: 'Otestuj zbra≈à', 
                desc: 'Zabij 10 nep≈ô√°tel mou novou zbran√≠.', 
                details: '‚öîÔ∏è Zabij 10 nep≈ô√°tel PO p≈ôijet√≠ √∫kolu. Pot≈ôebuji vƒõdƒõt jak zbra≈à funguje v akci.',
                requirement: { kills: 10 }, 
                reward: { trust: 20, weapon: 'upgraded' } 
            },
            'find_artifact': { 
                name: 'Najdi artefakt', 
                desc: 'Hled√°m starobyl√Ω p≈ôedmƒõt...', 
                details: 'üèõÔ∏è Prozkoumej star√© ruiny a hrobky. Artefakt je ukryt√Ω hluboko v podzem√≠.',
                requirement: { artifact: true }, 
                reward: { trust: 30, prophecy: true } 
            },
            'solve_riddle': { 
                name: 'Vy≈ôe≈° h√°danku', 
                desc: 'Odpovƒõz spr√°vnƒõ na 3 ot√°zky.', 
                details: 'üß© Promluv si se mnou a odpovƒõz na m√© h√°danky. M√°≈° 3 pokusy.',
                requirement: { riddles: 3 }, 
                reward: { trust: 25, secret: true } 
            },
            
            // === KORY QUESTY (Chaos) ===
            'sabotage_koudy': { name: 'Sabot√°≈æ!', desc: 'P≈ôines 10 v√Ωbu≈°nin (gunpowder).', 
                requirement: { resource: 'gunpowder', amount: 10 }, 
                reward: { money: 300, trust: 25, karma_kory: 10, karma_koudy: -15 },
                rival: 'koudy' },
            'steal_supplies': { name: 'Kr√°de≈æ z√°sob', desc: 'P≈ôines 150 penƒõz.', 
                requirement: { money: 150 }, 
                reward: { money: 250, trust: 20, karma_kory: 8, karma_koudy: -10 },
                rival: 'koudy' },
            'spread_chaos': { name: '≈†√≠≈ôen√≠ chaosu', desc: 'Zabij 5 nep≈ô√°tel kdekoliv.', 
                requirement: { kills: 5 }, 
                reward: { money: 400, trust: 30, karma_kory: 15, karma_koudy: -20 },
                rival: 'koudy' },
                
            // === KOUDY QUESTY (≈ò√°d) ===
            'disrupt_kory': { name: 'Naru≈°it operace', desc: 'P≈ôines 15 kovu na barik√°dy.', 
                requirement: { resource: 'metal', amount: 15 }, 
                reward: { money: 300, trust: 25, karma_koudy: 10, karma_kory: -15 },
                rival: 'kory' },
            'gather_intel': { name: 'Sbƒõr informac√≠', desc: 'Prozkoumej 3 lokace (nav≈°tiv nov√© m√≠sta).', 
                requirement: { explore: 3 }, 
                reward: { money: 200, trust: 20, karma_koudy: 8, karma_kory: -10 },
                rival: 'kory' },
            'restore_order': { name: 'Obnovit po≈ô√°dek', desc: 'Zabij 5 nep≈ô√°tel kdekoliv.', 
                requirement: { kills: 5 }, 
                reward: { money: 400, trust: 30, karma_koudy: 15, karma_kory: -20 },
                rival: 'kory' },
            
            // === CHYBƒöJ√çC√ç NPC QUESTY ===
            'clear_outpost': {
                name: 'Vyƒçisti z√°kladnu',
                desc: 'Vyƒçisti nep≈ô√°telskou z√°kladnu od n√°jezdn√≠k≈Ø.',
                details: '‚öîÔ∏è Zabij 8 nep≈ô√°tel v nep≈ô√°telsk√Ωch lokac√≠ch.',
                requirement: { kills: 8 },
                reward: { money: 350, trust: 25, xp: 100 }
            },
            'deliver_message': {
                name: 'Doruƒç zpr√°vu',
                desc: 'Doruƒç d≈Øle≈æitou zpr√°vu do obchodn√≠ho postu.',
                details: 'üìú Cestuj do obchodn√≠ho postu (trading_post) a vra≈• se.',
                requirement: { visit: 'trading_post' },
                reward: { money: 150, trust: 15 }
            },
            'deliver_package': {
                name: 'Doruƒç bal√≠k',
                desc: 'Doruƒç tajn√Ω bal√≠k na domluven√© m√≠sto.',
                details: 'üì¶ Nav≈°tiv 2 r≈Øzn√© lokace s bal√≠kem.',
                requirement: { travels: 2 },
                reward: { money: 200, trust: 20 }
            },
            'detective_quest': {
                name: 'Vy≈°et≈ôov√°n√≠',
                desc: 'Prozkoumej stopy a najdi vin√≠ka.',
                details: 'üîç Prozkoumej 4 lokace a najdi d≈Økazy.',
                requirement: { explore: 4 },
                reward: { money: 300, trust: 25, xp: 150 }
            },
            'discredit_rival': {
                name: 'Diskredituj rivala',
                desc: 'Najdi kompromituj√≠c√≠ materi√°ly na m√©ho konkurenta.',
                details: 'üìÅ Prozkoumej 3 lokace a najdi tajn√© dokumenty.',
                requirement: { explore: 3 },
                reward: { money: 250, trust: 20 }
            },
            'find_books': {
                name: 'Sbƒõr knih',
                desc: 'Najdi star√© knihy pro mou sb√≠rku.',
                details: 'üìö Prozkoumej star√© budovy a najdi 3 knihy.',
                requirement: { explore: 3 },
                reward: { money: 200, trust: 15, xp: 100 }
            },
            'find_daughter': {
                name: 'Najdi mou dceru',
                desc: 'Moje dcera zmizela, pros√≠m najdi ji.',
                details: 'üëß Prozkoumej 5 lokac√≠ a najdi stopy.',
                requirement: { explore: 5 },
                reward: { money: 400, trust: 35 }
            },
            'find_family_photo': {
                name: 'Najdi rodinnou fotku',
                desc: 'Moje jedin√° pam√°tka na rodinu se ztratila.',
                details: 'üñºÔ∏è Prozkoumej star√© domy a najdi fotku.',
                requirement: { explore: 2 },
                reward: { trust: 25, item: 'family_photo' }
            },
            'find_old_place': {
                name: 'Najdi star√© m√≠sto',
                desc: 'Hled√°m m√≠sto z m√Ωch vzpom√≠nek.',
                details: 'üèöÔ∏è Nav≈°tiv 4 r≈Øzn√© lokace.',
                requirement: { explore: 4 },
                reward: { money: 200, trust: 20, secret: true }
            },
            'find_parts': {
                name: 'Najdi d√≠ly',
                desc: 'Pot≈ôebuji n√°hradn√≠ d√≠ly na opravu.',
                details: 'üîß Nasb√≠rej 15 kovu a 5 elektroniky.',
                requirement: { metal: 15 },
                reward: { money: 250, trust: 20 }
            },
            'find_proof': {
                name: 'Najdi d≈Økazy',
                desc: 'Pot≈ôebuji d≈Økazy o zloƒçinu.',
                details: 'üîç Prozkoumej podez≈ôel√© lokace.',
                requirement: { explore: 3 },
                reward: { money: 300, trust: 25 }
            },
            'find_relic': {
                name: 'Najdi relikvii',
                desc: 'Hled√°m prastar√Ω artefakt.',
                details: 'üè∫ Prozkoumej ruiny a hrobky.',
                requirement: { explore: 4 },
                reward: { money: 500, trust: 30, item: 'ancient_relic' }
            },
            'find_toy': {
                name: 'Najdi hraƒçku',
                desc: 'Ztratila se obl√≠ben√° hraƒçka m√©ho d√≠tƒõte.',
                details: 'üß∏ Prozkoumej okol√≠ a najdi ply≈°√°ka.',
                requirement: { explore: 2 },
                reward: { trust: 20, item: 'old_toy' }
            },
            'get_reading': {
                name: 'Z√≠skej ƒçten√≠',
                desc: 'Pot≈ôebuji, abys mi p≈ôeƒçetl budoucnost.',
                details: 'üîÆ Nav≈°tiv vƒõ≈°tce (Severn√≠ ruiny nebo Buƒçovice) a vra≈• se s proroctv√≠m.',
                requirement: { visit: 'ruins_north' },
                reward: { trust: 15, prophecy: true }
            },
            'hear_his_story': {
                name: 'Vyslechni p≈ô√≠bƒõh',
                desc: 'Star√Ω mu≈æ chce vypr√°vƒõt sv≈Øj p≈ô√≠bƒõh.',
                details: 'üë¥ Pohovo≈ô si a vyslechni si jeho ≈æivotn√≠ p≈ô√≠bƒõh.',
                requirement: { talk: true },
                reward: { trust: 10, xp: 50, lore: true }
            },
            'hear_history': {
                name: 'Vyslechni historii',
                desc: 'Chci ti vypr√°vƒõt o star√Ωch ƒçasech.',
                details: 'üìú Vyslechni historii tohoto m√≠sta.',
                requirement: { talk: true },
                reward: { trust: 15, xp: 75, lore: true }
            },
            'help_refugees': {
                name: 'Pomoz uprchl√≠k≈Øm',
                desc: 'Skupina uprchl√≠k≈Ø pot≈ôebuje pomoc.',
                details: 'üèÉ P≈ôines 10 j√≠dla a 10 vody pro uprchl√≠ky.',
                requirement: { resources: 20 },
                reward: { trust: 30, karma: 10 }
            },
            'hunt_alpha': {
                name: 'Ulov alfa pred√°tora',
                desc: 'Obrovsk√° bestie terorizuje oblast.',
                details: 'üê∫ Najdi a zabij alfa mutanta (vlka, medvƒõda nebo jin√©ho alfa pred√°tora). Hledej v nebezpeƒçn√Ωch z√≥n√°ch.',
                requirement: { killAlpha: true },
                reward: { money: 500, trust: 35, item: 'rare' }
            },
            'investigate_koudy': {
                name: 'Vy≈°et≈ôi Koudyho',
                desc: 'Zjisti co Koudy ve skuteƒçnosti pl√°nuje.',
                details: 'üîç Prozkoumej Koudyho teritorium.',
                requirement: { explore: 3 },
                reward: { money: 300, trust: 20, karma_kory: 10 }
            },
            'listen_to_truth': {
                name: 'Vyslechni pravdu',
                desc: 'Chci ti ≈ô√≠ct nƒõco d≈Øle≈æit√©ho.',
                details: 'üëÇ Vyslechni tajemstv√≠.',
                requirement: { talk: true },
                reward: { trust: 20, secret: true }
            },
            'protect_children': {
                name: 'Ochra≈à dƒõti',
                desc: 'Dƒõti jsou v nebezpeƒç√≠, ochra≈à je!',
                details: 'üë∂ Doprovoƒè dƒõti do bezpeƒç√≠ (3 cesty).',
                requirement: { escort: true, travels: 3 },
                reward: { trust: 35, karma: 15 }
            },
            'prove_yourself': {
                name: 'Doka≈æ svou hodnotu',
                desc: 'Uka≈æ ≈æe jsi hoden m√© d≈Øvƒõry.',
                details: '‚öîÔ∏è Zabij 5 nep≈ô√°tel a p≈ôe≈æij.',
                requirement: { kills: 5 },
                reward: { trust: 25, respect: true }
            },
            'repair_generator': {
                name: 'Oprav gener√°tor',
                desc: 'N√°≈° gener√°tor je rozbit√Ω.',
                details: 'üîß P≈ôines 10 kovu a 5 elektroniky.',
                requirement: { metal: 10 },
                reward: { money: 200, trust: 20 }
            },
            'repair_reactor': {
                name: 'Oprav reaktor',
                desc: 'Jadern√Ω reaktor pot≈ôebuje opravu.',
                details: '‚ò¢Ô∏è P≈ôines 20 kovu a 10 elektroniky.',
                requirement: { metal: 20 },
                reward: { money: 500, trust: 30, xp: 200 }
            },
            'track_beast': {
                name: 'Sleduj bestii',
                desc: 'Sleduj stopy obrovsk√© bestie.',
                details: 'üêæ Prozkoumej 4 lokace a najdi stopy.',
                requirement: { explore: 4 },
                reward: { money: 300, trust: 25 }
            },
            'urgent_quest': {
                name: 'Nal√©hav√Ω √∫kol',
                desc: 'Pot≈ôebuji tvou pomoc HNED!',
                details: '‚ö° Spl≈à √∫kol rychle - ƒçasov√Ω limit!',
                requirement: { kills: 3 },
                reward: { money: 400, trust: 30, item: 'rare' }
            }
        };
        
        // === SPECIALIZACE OSADY ===
        const SETTLEMENT_SPECIALIZATIONS = [
            { id: 'military', name: 'Vojensk√° pevnost', nameEn: 'Military Fortress', icon: '‚öîÔ∏è', bonus: { defense: 50, guardBonus: 25 }, requirement: { guards: 3, barracks: true }, desc: '+50 obrana, str√°≈æci +25%', descEn: '+50 defense, guards +25%' },
            { id: 'trading', name: 'Obchodn√≠ centrum', nameEn: 'Trading Hub', icon: 'üí∞', bonus: { tradeBonus: 0.25, income: 50 }, requirement: { traders: 2, market: true }, desc: '+25% ceny, +50 penƒõz/den', descEn: '+25% prices, +50 money/day' },
            { id: 'farming', name: 'Zemƒõdƒõlsk√° osada', nameEn: 'Farming Settlement', icon: 'üåæ', bonus: { foodBonus: 100, waterBonus: 50 }, requirement: { farmers: 3, farmland: true }, desc: 'Dvojn√°sobn√° produkce j√≠dla', descEn: 'Double food production' },
            { id: 'medical', name: 'L√©ƒçitelsk√© st≈ôedisko', nameEn: 'Medical Center', icon: 'üè•', bonus: { healing: 20, diseaseResist: 0.8 }, requirement: { medics: 2, infirmary: true }, desc: '+20 HP/den, -80% nemoci', descEn: '+20 HP/day, -80% disease' },
            { id: 'industrial', name: 'Pr≈Ømyslov√° z√≥na', nameEn: 'Industrial Zone', icon: 'üè≠', bonus: { productionBonus: 2 }, requirement: { builders: 2, workshop: true, forge: true }, desc: 'Dvojn√°sobn√° produkce surovin', descEn: 'Double resource production' }
        ];
        
        // === MISE OD OSADN√çK≈Æ ===
        const SETTLER_QUESTS = [
            { id: 'gather_wood', name: 'Sb√≠r√°n√≠ d≈ôeva', icon: 'ü™µ', settler: 'builder', request: { wood: 20 }, reward: { money: 100, prosperity: 5 }, desc: 'Pot≈ôebuji d≈ôevo na opravu.' },
            { id: 'find_medicine', name: 'Najdi l√©ky', icon: 'üíä', settler: 'medic_s', request: { item: 'medkit' }, reward: { money: 150, xp: 50 }, desc: 'Pot≈ôebuji l√©k√°rniƒçku pro pacienta.' },
            { id: 'hunt_meat', name: 'Ulov maso', icon: 'ü•©', settler: 'cook', request: { meat: 5 }, reward: { food: 30, prosperity: 3 }, desc: 'Pot≈ôebuji maso na va≈ôen√≠.' },
            { id: 'patrol', name: 'Hl√≠dka', icon: 'üëÅÔ∏è', settler: 'guard', request: { action: 'explore', count: 3 }, reward: { money: 200, defense: 10 }, desc: 'Prohl√©dni okol√≠ osady.' },
            { id: 'trade_mission', name: 'Obchodn√≠ mise', icon: 'üíº', settler: 'trader_s', request: { money: 500 }, reward: { item: 'rare', prosperity: 10 }, desc: 'Investuj do obchodu.' },
            { id: 'repair_tools', name: 'Oprava n√°stroj≈Ø', icon: 'üîß', settler: 'blacksmith', request: { metal: 10 }, reward: { item: 'weapon', prosperity: 5 }, desc: 'Pot≈ôebuji kov na opravu.' }
        ];
        
        
        const SKILLS = [
            { id: 'iron_stomach', name: '≈Ωelezn√Ω ≈æaludek', icon: 'üçñ', desc: '-20% spot≈ôeba hladu', maxLevel: 3, type: 'hunger_efficiency', value: 0.2 },
            { id: 'water_saver', name: '√ösporn√Ω pij√°k', icon: 'üíß', desc: '-20% spot≈ôeba ≈æ√≠znƒõ', maxLevel: 3, type: 'thirst_efficiency', value: 0.2 },
            { id: 'endurance', name: 'V√Ωdr≈æ', icon: '‚ö°', desc: '-20% spot≈ôeba energie', maxLevel: 3, type: 'energy_efficiency', value: 0.2 },
            { id: 'scavenger', name: 'Sbƒõraƒç', icon: 'üîç', desc: '+15% ≈°ance naj√≠t loot', maxLevel: 5, type: 'loot_chance', value: 0.15 },
            { id: 'fast_travel', name: 'Rychl√Ω pochod', icon: 'üèÉ', desc: '-1% ƒças cestov√°n√≠ / level', maxLevel: 5, type: 'travel_speed', value: 0.01 },
            { id: 'rad_resistance', name: 'Odolnost radiaci', icon: '‚ò¢Ô∏è', desc: '-30% zisku radiace', maxLevel: 3, type: 'radiation_resistance', value: 0.3 },
            { id: 'tough', name: 'Otrlost', icon: 'üí™', desc: '+20 max HP', maxLevel: 5, type: 'max_health', value: 20 },
            { id: 'efficient', name: 'Efektivita', icon: '‚öôÔ∏è', desc: '+25% XP ze v≈°ech zdroj≈Ø', maxLevel: 3, type: 'xp_bonus', value: 0.25 },
            { id: 'lucky', name: '≈†tƒõst√≠', icon: 'üçÄ', desc: '+10% kvalita lootu', maxLevel: 3, type: 'loot_quality', value: 0.1 },
            { id: 'survivor', name: 'P≈ôe≈æiv≈°√≠', icon: 'üõ°Ô∏è', desc: '+1 HP/min regenerace', maxLevel: 5, type: 'health_regen', value: 1 },
            { id: 'repair', name: 'Oprav√°≈ô', icon: 'üîß', desc: 'Oprava zbran√≠ a zbroje (-50% cost)', maxLevel: 3, type: 'repair', value: 0.5 },
            { id: 'auto_consume', name: 'Pud sebez√°chovy', icon: 'üß†', desc: 'Auto-j√≠/pije kdy≈æ um√≠r√°≈°', maxLevel: 1, type: 'auto_consume', value: 1 }
        ];
        
        const ENEMIES = [
            // === TIER 1 - Slab√≠ (divok√° zvƒõ≈ô) === (2x HP, +defense)
            { id: 'rat', name: 'Krysa', icon: 'üêÄ', hp: 80, damage: 5, defense: 3, xp: 10, loot: ['food'], chance: 0.4, minCount: 2, maxCount: 5, tier: 1 },
            { id: 'giant_rat', name: 'Ob≈ô√≠ krysa', icon: 'üêÄ', hp: 100, damage: 8, defense: 5, xp: 15, loot: ['food', 'cloth'], chance: 0.35, minCount: 1, maxCount: 3, tier: 1 },
            { id: 'mutant_rat', name: 'Mutantn√≠ krysa', icon: 'üêÄ', hp: 120, damage: 8, defense: 5, xp: 18, loot: ['food', 'cloth'], chance: 0.3, minCount: 2, maxCount: 4, tier: 1 },
            { id: 'wild_dog', name: 'Divok√Ω pes', icon: 'üêï', hp: 170, damage: 12, defense: 8, xp: 30, loot: ['food', 'cloth'], chance: 0.4, minCount: 1, maxCount: 3, tier: 1 },
            { id: 'feral_cat', name: 'Zdivoƒçel√° koƒçka', icon: 'üêà', hp: 140, damage: 10, defense: 7, xp: 25, loot: ['cloth'], chance: 0.35, minCount: 1, maxCount: 3, tier: 1 },
            { id: 'feral', name: 'Zdivoƒçel√Ω ƒçlovƒõk', icon: 'üßü', hp: 150, damage: 11, defense: 7, xp: 28, loot: ['cloth', 'food'], chance: 0.3, minCount: 1, maxCount: 3, tier: 1 },
            
            // === TIER 2 - St≈ôedn√≠ === (2x HP, +defense)
            { id: 'zombie', name: 'Zombie', icon: 'üßü', hp: 220, damage: 12, defense: 10, xp: 35, loot: ['cloth', 'medkit'], chance: 0.3, minCount: 2, maxCount: 4, tier: 2 },
            { id: 'raider_weak', name: 'Slab√Ω n√°jezdn√≠k', icon: 'üíÄ', hp: 180, damage: 14, defense: 12, xp: 35, loot: ['food', 'metal'], chance: 0.3, minCount: 1, maxCount: 3, tier: 2, faction: 'raiders' },
            { id: 'raider', name: 'N√°jezdn√≠k', icon: 'üíÄ', hp: 190, damage: 14, defense: 14, xp: 40, loot: ['pistol', 'food', 'metal'], chance: 0.2, minCount: 1, maxCount: 3, tier: 2, faction: 'raiders' },
            { id: 'wolf', name: 'Mutantn√≠ vlk', icon: 'üê∫', hp: 200, damage: 17, defense: 12, xp: 45, loot: ['food', 'fur', 'leather'], chance: 0.25, minCount: 1, maxCount: 2, tier: 2 },
            { id: 'soldier', name: 'Voj√°k', icon: 'üéñÔ∏è', hp: 240, damage: 18, defense: 20, xp: 50, loot: ['ammo', 'metal', 'medkit'], chance: 0.15, minCount: 1, maxCount: 2, tier: 2, faction: 'military' },
            { id: 'soldier_zombie', name: 'Zombie voj√°k', icon: 'üéñÔ∏è', hp: 260, damage: 16, defense: 18, xp: 48, loot: ['ammo', 'metal'], chance: 0.15, minCount: 1, maxCount: 3, tier: 2 },
            { id: 'turret', name: 'St≈ôeleck√° vƒõ≈æ', icon: 'üî´', hp: 180, damage: 25, defense: 30, xp: 55, loot: ['metal', 'electronics', 'ammo'], chance: 0.1, minCount: 1, maxCount: 1, tier: 2 },
            { id: 'cave_spider', name: 'Jeskynn√≠ pavouk', icon: 'üï∑Ô∏è', hp: 170, damage: 15, defense: 8, xp: 35, loot: ['cloth', 'poison'], chance: 0.2, minCount: 2, maxCount: 4, tier: 2 },
            { id: 'ghost', name: 'P≈ô√≠zrak', icon: 'üëª', hp: 150, damage: 15, defense: 0, xp: 40, loot: ['crystal'], chance: 0.1, minCount: 1, maxCount: 2, tier: 2 },
            { id: 'mutant_dog', name: 'Mutantn√≠ pes', icon: 'üêï', hp: 170, damage: 14, defense: 10, xp: 38, loot: ['food', 'mutant_blood'], chance: 0.2, minCount: 1, maxCount: 3, tier: 2 },
            { id: 'mutant_frog', name: 'Mutantn√≠ ≈æ√°ba', icon: 'üê∏', hp: 140, damage: 10, defense: 8, xp: 32, loot: ['food', 'poison'], chance: 0.25, minCount: 2, maxCount: 4, tier: 2 },
            { id: 'zombie_cop', name: 'Zombie policista', icon: 'üëÆ', hp: 230, damage: 14, defense: 16, xp: 42, loot: ['ammo', 'pistol'], chance: 0.15, minCount: 1, maxCount: 2, tier: 2 },
            { id: 'mutant_fish', name: 'Mutantn√≠ ryba', icon: 'üêü', hp: 150, damage: 12, defense: 10, xp: 35, loot: ['food', 'mutant_blood'], chance: 0.2, minCount: 2, maxCount: 4, tier: 2 },
            
            // === TIER 3 - Siln√≠ ===
            { id: 'mutant', name: 'Mutant', icon: 'üëπ', hp: 145, damage: 18, defense: 12, xp: 60, loot: ['metal', 'radx'], chance: 0.2, minCount: 1, maxCount: 1, tier: 3, faction: 'mutants' },
            { id: 'bandit', name: 'Bandita', icon: 'üî´', hp: 130, damage: 22, defense: 14, xp: 55, loot: ['rifle', 'food', 'money'], chance: 0.3, minCount: 1, maxCount: 1, tier: 3, faction: 'raiders' },
            { id: 'ghoul', name: 'Gh√∫l', icon: 'üëª', hp: 160, damage: 19, defense: 10, xp: 65, loot: ['radx', 'stimpack'], chance: 0.15, minCount: 1, maxCount: 2, tier: 3, faction: 'mutants' },
            { id: 'raider_boss', name: 'V≈Ødce n√°jezdn√≠k≈Ø', icon: '‚ò†Ô∏è', hp: 180, damage: 24, defense: 16, xp: 80, loot: ['shotgun', 'vest', 'money'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3, faction: 'raiders' },
            { id: 'robot', name: 'Bojov√Ω robot', icon: 'ü§ñ', hp: 220, damage: 28, defense: 25, xp: 90, loot: ['electronics', 'metal', 'ammo'], chance: 0.08, minCount: 1, maxCount: 1, tier: 3 },
            { id: 'slaver', name: 'Otrok√°≈ô', icon: '‚õìÔ∏è', hp: 135, damage: 20, defense: 12, xp: 70, loot: ['weapon', 'money', 'metal'], chance: 0.15, minCount: 1, maxCount: 2, tier: 3, faction: 'raiders' },
            { id: 'experiment', name: 'Experiment', icon: 'üß¨', hp: 150, damage: 22, defense: 8, xp: 75, loot: ['chemicals', 'mutant_blood'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3 },
            { id: 'swamp_creature', name: 'Ba≈æinn√° p≈ô√≠≈°era', icon: 'üêä', hp: 165, damage: 20, defense: 14, xp: 72, loot: ['food', 'leather'], chance: 0.12, minCount: 1, maxCount: 1, tier: 3 },
            { id: 'ice_mutant', name: 'Ledov√Ω mutant', icon: 'ü•∂', hp: 160, damage: 21, defense: 16, xp: 78, loot: ['crystal', 'radx'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3 },
            { id: 'toxic_zombie', name: 'Toxick√Ω zombie', icon: '‚ò£Ô∏è', hp: 145, damage: 18, defense: 8, xp: 68, loot: ['chemicals', 'radx'], chance: 0.12, minCount: 1, maxCount: 2, tier: 3 },
            { id: 'electric_mutant', name: 'Elektrick√Ω mutant', icon: '‚ö°', hp: 150, damage: 24, defense: 10, xp: 80, loot: ['electronics', 'copper'], chance: 0.1, minCount: 1, maxCount: 1, tier: 3 },
            
            // === TIER 4 - Bossov√© === (+50% HP, +defense)
            { id: 'slaver_boss', name: 'V≈Ødce otrok√°≈ô≈Ø', icon: '‚õìÔ∏è', hp: 240, damage: 28, defense: 18, xp: 120, loot: ['rare_weapon', 'money', 'armor'], chance: 0.05, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            { id: 'giant_mutant', name: 'Ob≈ô√≠ Mutant', icon: 'üëæ', hp: 360, damage: 36, defense: 20, xp: 200, loot: ['sniper', 'armor_heavy', 'radaway'], chance: 0.03, minCount: 1, maxCount: 1, tier: 4, isBoss: true, faction: 'mutants' },
            { id: 'alpha_wolf', name: 'Alfa Vlk', icon: 'üê∫', hp: 270, damage: 30, defense: 16, xp: 150, loot: ['meat', 'fur', 'leather', 'stimpack'], chance: 0.04, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            { id: 'zombie_hulk', name: 'Zombie Hulk', icon: 'ü¶†', hp: 450, damage: 42, defense: 15, xp: 250, loot: ['stimpack', 'radx', 'armor_heavy'], chance: 0.02, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            { id: 'elite_robot', name: 'Elitn√≠ robot', icon: 'ü§ñ', hp: 500, damage: 45, defense: 40, xp: 350, loot: ['electronics', 'legendary_weapon', 'ai_chip'], chance: 0.01, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            { id: 'toxic_beast', name: 'Toxick√° bestie', icon: '‚ò£Ô∏è', hp: 330, damage: 32, defense: 16, xp: 180, loot: ['chemicals', 'mutant_blood', 'rare_armor'], chance: 0.03, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            { id: 'acid_beast', name: 'Kyselinov√° bestie', icon: 'üß™', hp: 300, damage: 35, defense: 12, xp: 170, loot: ['chemicals', 'acid'], chance: 0.03, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            { id: 'swamp_beast', name: 'Ba≈æinn√° bestie', icon: 'üêä', hp: 375, damage: 38, defense: 18, xp: 190, loot: ['food', 'leather', 'rare_item'], chance: 0.02, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            { id: 'glowing_ghoul', name: 'Z√°≈ô√≠c√≠ gh√∫l', icon: 'üëª', hp: 270, damage: 30, defense: 12, xp: 160, loot: ['radaway', 'radx'], chance: 0.02, minCount: 1, maxCount: 1, tier: 4, radiation: 15 },
            { id: 'mutant_brute', name: 'Mutant Brutus', icon: 'üëπ', hp: 480, damage: 45, defense: 22, xp: 300, loot: ['rare_weapon', 'mutant_blood'], chance: 0.01, minCount: 1, maxCount: 1, tier: 4, isBoss: true },
            
            // === TIER 5 - Legend√°rn√≠ === (+50% HP, +defense)
            { id: 'glowing_one', name: 'Z√°≈ô√≠c√≠', icon: '‚ò¢Ô∏è', hp: 420, damage: 40, defense: 15, xp: 280, loot: ['radaway', 'legendary_item', 'crystal'], chance: 0.01, minCount: 1, maxCount: 1, tier: 5, isBoss: true, radiation: 20 },
            { id: 'irradiated_beast', name: 'Oz√°≈ôen√° bestie', icon: '‚ò¢Ô∏è', hp: 390, damage: 38, defense: 16, xp: 220, loot: ['radaway', 'mutant_blood', 'crystal'], chance: 0.02, minCount: 1, maxCount: 1, tier: 5, isBoss: true, radiation: 18 },
            { id: 'mutant_behemoth', name: 'Mutant Behemoth', icon: 'üëπ', hp: 750, damage: 55, defense: 32, xp: 500, loot: ['legendary_weapon', 'legendary_armor', 'mutant_heart'], chance: 0.005, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            { id: 'deathclaw', name: 'Deathclaw', icon: 'ü¶ñ', hp: 680, damage: 60, defense: 28, xp: 450, loot: ['deathclaw_hand', 'legendary_item'], chance: 0.005, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            { id: 'mutant_giant', name: 'Mutant√≠ obr', icon: 'üëæ', hp: 600, damage: 50, defense: 28, xp: 400, loot: ['legendary_weapon', 'mutant_blood'], chance: 0.008, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            { id: 'mutant_queen', name: 'Mutant√≠ kr√°lovna', icon: 'üëë', hp: 820, damage: 48, defense: 35, xp: 600, loot: ['legendary_weapon', 'legendary_armor', 'queen_crown'], chance: 0.003, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            { id: 'ai_guardian', name: 'AI Str√°≈æce', icon: 'üõ°Ô∏è', hp: 570, damage: 42, defense: 45, xp: 380, loot: ['electronics', 'ai_chip', 'legendary_item'], chance: 0.008, minCount: 1, maxCount: 1, tier: 5, isBoss: true },
            
            // === TAJN√ù TREZOR - Speci√°ln√≠ nep≈ô√°tel√© === (+50% HP)
            { id: 'sentinel', name: 'Str√°≈æn√Ω sentinel', icon: 'üóø', hp: 300, damage: 35, defense: 32, xp: 200, loot: ['electronics', 'crystal', 'gold', 'gems'], chance: 0.05, minCount: 1, maxCount: 1, tier: 4 },
            { id: 'ancient_guardian', name: 'Prastar√Ω str√°≈æce', icon: '‚öîÔ∏è', hp: 525, damage: 48, defense: 38, xp: 400, loot: ['legendary_item', 'crystal', 'gold', 'gems'], chance: 0.02, minCount: 1, maxCount: 1, tier: 5, isBoss: true }
        ];
        
        const CRAFTING = [
            // === ZBRANƒö - Z√°kladn√≠ (portable = lze vyrobit na cestƒõ) ===
            { id: 'spear', name: 'Kop√≠', icon: 'üî±', result: { type: 'weapon', damage: 15, rarity: 'common' }, requires: { wood: 3, metal: 2 }, category: 'weapon', portable: true },
            { id: 'bow', name: 'Luk', icon: 'üèπ', result: { type: 'weapon', damage: 18, ammoType: 'arrow', rarity: 'common' }, requires: { wood: 5, cloth: 3 }, category: 'weapon', portable: true },
            { id: 'machete', name: 'Maƒçeta', icon: 'üó°Ô∏è', result: { type: 'weapon', damage: 18, rarity: 'common' }, requires: { metal: 4, cloth: 1 }, category: 'weapon', portable: true },
            { id: 'club', name: 'Kyj', icon: 'üèè', result: { type: 'weapon', damage: 12, rarity: 'common' }, requires: { wood: 4 }, category: 'weapon', portable: true },
            
            // === ZBRANƒö - Pokroƒçil√© (vy≈æaduj√≠ d√≠lnu) ===
            { id: 'crossbow', name: 'Ku≈°e', icon: 'üèπ', result: { type: 'weapon', damage: 22, ammoType: 'bolt', rarity: 'uncommon' }, requires: { wood: 6, metal: 4, rope: 2 }, category: 'weapon', portable: false },
            { id: 'hammer', name: 'V√°leƒçn√© kladivo', icon: 'üî®', result: { type: 'weapon', damage: 20, rarity: 'uncommon' }, requires: { metal: 5, wood: 3, leather: 1 }, category: 'weapon', portable: false },
            { id: 'axe', name: 'Bojov√° sekera', icon: 'ü™ì', result: { type: 'weapon', damage: 24, rarity: 'uncommon' }, requires: { metal: 6, wood: 4 }, category: 'weapon', portable: false },
            { id: 'sword', name: 'Meƒç', icon: '‚öîÔ∏è', result: { type: 'weapon', damage: 26, rarity: 'uncommon' }, requires: { metal: 8, leather: 2 }, category: 'weapon', portable: false },
            { id: 'serrated_blade', name: 'Zubat√° ƒçepel', icon: 'üî™', result: { type: 'weapon', damage: 18, special: 'bleed', rarity: 'uncommon' }, requires: { metal: 5, scrap: 3 }, category: 'weapon', portable: false },
            { id: 'barbed_club', name: 'Ostnat√Ω kyj', icon: 'üèè', result: { type: 'weapon', damage: 16, special: 'bleed', rarity: 'uncommon' }, requires: { wood: 4, metal: 3, scrap: 2 }, category: 'weapon', portable: true },
            
            // === ZBRANƒö - St≈ôeln√© (v≈°echny vy≈æaduj√≠ d√≠lnu) ===
            { id: 'slingshot', name: 'Prak', icon: 'üéØ', result: { type: 'weapon', damage: 10, rarity: 'common' }, requires: { wood: 2, leather: 1 }, category: 'weapon', portable: true },
            { id: 'throwing_knives', name: 'Vrhac√≠ no≈æe', icon: 'üó°Ô∏è', result: { type: 'weapon', damage: 16, rarity: 'common' }, requires: { metal: 4 }, category: 'weapon', portable: false },
            { id: 'pipe_rifle', name: 'Trubkov√° pu≈°ka', icon: 'üî´', result: { type: 'weapon', damage: 30, ammoType: '9mm', rarity: 'uncommon' }, requires: { metal: 8, scrap: 5, gunpowder: 3 }, category: 'weapon', portable: false },
            { id: 'pipe_shotgun', name: 'Trubkov√° brokovnice', icon: 'üî´', result: { type: 'weapon', damage: 35, ammoType: 'shell', rarity: 'uncommon' }, requires: { metal: 10, scrap: 6, gunpowder: 4 }, category: 'weapon', portable: false },
            { id: 'pipe_pistol', name: 'Improvizovan√° pistole', icon: 'üî´', result: { type: 'weapon', damage: 22, ammoType: '9mm', rarity: 'uncommon' }, requires: { metal: 6, scrap: 4, gunpowder: 2 }, category: 'weapon', portable: false },
            
            // === VYLEP≈†EN√ç ZBRAN√ç ===
            { id: 'weapon_poison', name: 'Jed na zbra≈à', icon: 'üß™', result: { type: 'weapon_coating', effect: 'poison', uses: 5, desc: 'Otr√°v√≠≈° zbra≈à na 5 boj≈Ø' }, requires: { herbs: 4, chemicals: 3 }, category: 'special', portable: false },
            { id: 'weapon_fire', name: 'Z√°paln√° pasta', icon: 'üî•', result: { type: 'weapon_coating', effect: 'fire', uses: 5, desc: 'Zbra≈à ho≈ô√≠ 5 boj≈Ø' }, requires: { fuel: 2, chemicals: 2, cloth: 1 }, category: 'special', portable: true },
            
            // === ZBROJE ===
            { id: 'leather_armor', name: 'Ko≈æen√° zbroj', icon: 'ü¶∫', result: { type: 'armor', defense: 16, rarity: 'common' }, requires: { leather: 6, rope: 2 }, category: 'armor', portable: true },
            { id: 'light_armor', name: 'Lehk√° zbroj', icon: 'üõ°Ô∏è', result: { type: 'armor', defense: 20, rarity: 'uncommon' }, requires: { metal: 5, leather: 3, cloth: 2 }, category: 'armor', portable: false },
            { id: 'gas_mask', name: 'Plynov√° maska', icon: 'üò∑', result: { type: 'helmet', defense: 6, special: 'gas_filter', rarity: 'uncommon' }, requires: { glass: 2, cloth: 3, chemicals: 1 }, category: 'armor', portable: false },
            { id: 'helmet', name: 'Helma', icon: 'ü™ñ', result: { type: 'helmet', defense: 10, rarity: 'common' }, requires: { metal: 4, leather: 1 }, category: 'armor', portable: false },
            
            // === POKROƒåIL√â ZBROJE (max uncommon) ===
            { id: 'arm_guards', name: 'Chr√°niƒçe rukou', icon: 'ü•ä', result: { type: 'gloves', defense: 6, special: 'block_bonus', rarity: 'uncommon' }, requires: { leather: 4, metal: 3 }, category: 'armor', portable: false },
            { id: 'leg_guards', name: 'Chr√°niƒçe nohou', icon: 'ü•æ', result: { type: 'boots', defense: 6, special: 'dodge_bonus', rarity: 'uncommon' }, requires: { leather: 4, metal: 3 }, category: 'armor', portable: false },
            { id: 'leather_gloves', name: 'Ko≈æen√© rukavice', icon: 'üß§', result: { type: 'gloves', defense: 4, rarity: 'common' }, requires: { leather: 3, cloth: 1 }, category: 'armor', portable: true },
            { id: 'spiked_gloves', name: 'Ostnat√© rukavice', icon: 'ü•ä', result: { type: 'gloves', defense: 6, special: 'bleed_punch', rarity: 'uncommon' }, requires: { leather: 3, metal: 4, scrap: 2 }, category: 'armor', portable: false },
            { id: 'hiking_boots', name: 'Turistick√© boty', icon: 'ü•æ', result: { type: 'boots', defense: 3, special: 'speed_bonus', rarity: 'common' }, requires: { leather: 4, cloth: 2 }, category: 'armor', portable: true },
            { id: 'winter_boots', name: 'Zimn√≠ boty', icon: '‚ùÑÔ∏è', result: { type: 'boots', defense: 5, special: 'warm_feet', rarity: 'uncommon' }, requires: { leather: 4, cloth: 4, fur: 2 }, category: 'armor', portable: false },
            
            // === ≈†T√çTY ===
            { id: 'wooden_shield', name: 'D≈ôevƒõn√Ω ≈°t√≠t', icon: 'ü™µ', result: { type: 'armor', defense: 16, special: 'block', rarity: 'common' }, requires: { wood: 8, leather: 2 }, category: 'armor', portable: true },
            { id: 'metal_shield', name: 'Kovov√Ω ≈°t√≠t', icon: 'üõ°Ô∏è', result: { type: 'armor', defense: 22, special: 'block', rarity: 'uncommon' }, requires: { metal: 8, wood: 3, leather: 2 }, category: 'armor', portable: false },
            
            // === Bƒö≈ΩN√â ZBROJE ===
            { id: 'chainmail', name: 'Krou≈ækov√° zbroj', icon: '‚õìÔ∏è', result: { type: 'armor', defense: 18, rarity: 'uncommon' }, requires: { metal: 12, leather: 2 }, category: 'armor', portable: false },
            { id: 'biker_jacket', name: 'Motork√°≈ôsk√° bunda', icon: 'üß•', result: { type: 'armor', defense: 14, rarity: 'uncommon' }, requires: { leather: 6, metal: 2, cloth: 2 }, category: 'armor', portable: false },
            { id: 'padded_jacket', name: 'Vycpan√° bunda', icon: 'üß•', result: { type: 'armor', defense: 10, rarity: 'uncommon' }, requires: { cloth: 6, leather: 2 }, category: 'armor', portable: true },
            
            // === L√âƒåIVA (vƒõt≈°ina portable) ===
            { id: 'bandage', name: 'Obvaz', icon: 'ü©π', result: { type: 'consumable', effect: 'health', value: 20 }, requires: { cloth: 2 }, category: 'medical', portable: true },
            { id: 'herbal_medicine', name: 'Bylinn√Ω l√©k', icon: 'üåø', result: { type: 'consumable', effect: 'health', value: 30 }, requires: { herbs: 3 }, category: 'medical', portable: true },
            { id: 'medkit_craft', name: 'L√©k√°rniƒçka', icon: '‚öïÔ∏è', result: { type: 'consumable', effect: 'health', value: 40 }, requires: { cloth: 3, herbs: 2, chemicals: 1 }, category: 'medical', portable: false },
            { id: 'stimpack_craft', name: 'Stimpak', icon: 'üíâ', result: { type: 'consumable', effect: 'health', value: 60 }, requires: { chemicals: 3, glass: 1, herbs: 2 }, category: 'medical', portable: false },
            { id: 'antidote', name: 'Antidotum', icon: 'üíä', result: { type: 'consumable', effect: 'radiation', value: -30 }, requires: { herbs: 4, chemicals: 2 }, category: 'medical', portable: true },
            { id: 'super_stim', name: 'Super Stimpak', icon: 'üíâ', result: { type: 'consumable', effect: 'health', value: 100 }, requires: { chemicals: 6, herbs: 3, glass: 2 }, category: 'medical', portable: false },
            { id: 'rad_x', name: 'Rad-X', icon: '‚ò¢Ô∏è', result: { type: 'consumable', effect: 'rad_resist', value: 50 }, requires: { chemicals: 4, herbs: 2 }, category: 'medical', portable: false },
            
            // === J√çDLO & PIT√ç (vƒõt≈°ina portable - va≈ôen√≠ u t√°bor√°ku) ===
            { id: 'water_filter', name: 'ƒåist√° voda', icon: 'üíé', result: { type: 'consumable', effect: 'thirst', value: 60 }, requires: { glass: 1, cloth: 1, stone: 2 }, category: 'food', portable: false },
            { id: 'cooked_meat', name: 'Peƒçen√© maso', icon: 'üçñ', result: { type: 'consumable', effect: 'hunger', value: 50 }, requires: { raw_meat: 1, wood: 1 }, category: 'food', portable: true },
            { id: 'grilled_fish', name: 'Grilovan√° ryba', icon: 'üêü', result: { type: 'consumable', effect: 'hunger', value: 45, secondary: { thirst: 10 } }, requires: { fish: 1, wood: 1 }, category: 'food', portable: true },
            { id: 'steak', name: 'Steak', icon: 'ü•©', result: { type: 'consumable', effect: 'hunger', value: 60, secondary: { hp: 20 } }, requires: { raw_meat: 2, wood: 1 }, category: 'food', portable: true },
            { id: 'stew', name: 'Gul√°≈°', icon: 'üç≤', result: { type: 'consumable', effect: 'hunger', value: 100, secondary: { hp: 65, energy: 10 } }, requires: { raw_meat: 4, herbs: 2, wood: 2 }, category: 'food', portable: true },
            { id: 'energy_drink', name: 'Energetick√Ω n√°poj', icon: 'üîã', result: { type: 'consumable', effect: 'energy', value: 50 }, requires: { chemicals: 2, glass: 1 }, category: 'food', portable: false },
            { id: 'coffee_brew', name: 'Siln√° k√°va', icon: '‚òï', result: { type: 'consumable', effect: 'energy', value: 40 }, requires: { herbs: 2, wood: 1 }, category: 'food', portable: true },
            { id: 'mutant_steak', name: 'Mutant√≠ steak', icon: 'üçñ', result: { type: 'consumable', effect: 'hunger', value: 90, secondary: { hp: 25, energy: 20 } }, requires: { leather: 2, herbs: 3 }, category: 'food', portable: true, rarity: 'uncommon' },
            
            // === N√ÅSTROJE ===
            { id: 'trap', name: 'Past na zvƒõ≈ô', icon: 'üï∏Ô∏è', result: { type: 'tool', bonus: 'food', desc: '+2 j√≠dla/den pro osadu (max 2 pasti, dr≈æ v invent√°≈ôi)' }, requires: { wood: 4, metal: 3, rope: 2 }, category: 'tool', portable: true },
            { id: 'backpack', name: 'Batoh', icon: 'üéí', result: { type: 'tool', bonus: 'capacity', desc: '+10 kapacita invent√°≈ôe' }, requires: { leather: 5, cloth: 4, rope: 2 }, category: 'tool', portable: true },
            { id: 'binoculars', name: 'Dalekohled', icon: 'üî≠', result: { type: 'tool', bonus: 'vision', desc: 'Vƒõt≈°√≠ viditelnost mapy' }, requires: { glass: 4, metal: 2, leather: 1 }, category: 'tool', portable: false },
            { id: 'compass', name: 'Kompas', icon: 'üß≠', result: { type: 'tool', bonus: 'navigation', desc: 'Rychlej≈°√≠ cestov√°n√≠' }, requires: { metal: 3, glass: 1 }, category: 'tool', portable: false },
            { id: 'fishing_rod', name: 'Ryb√°≈ôsk√Ω prut', icon: 'üé£', result: { type: 'tool', bonus: 'fishing', bonusValue: 1, weight: 1, desc: 'Pro ryba≈ôen√≠' }, requires: { wood: 4, rope: 3 }, category: 'tool', portable: true },
            { id: 'pickaxe', name: 'Krump√°ƒç', icon: '‚õèÔ∏è', result: { type: 'tool', bonus: 'mining', desc: 'Pro tƒõ≈æbu' }, requires: { metal: 5, wood: 3 }, category: 'tool', portable: false },
            { id: 'cooking_pot', name: 'Hrnec', icon: 'üç≥', result: { type: 'tool', bonus: 'cooking', desc: 'Pro va≈ôen√≠ j√≠dla' }, requires: { metal: 4, wood: 1 }, category: 'tool', portable: true },
            { id: 'alchemy_set', name: 'Alchymistick√° sada', icon: '‚öóÔ∏è', result: { type: 'tool', bonus: 'alchemy', desc: 'Pro v√Ωrobu lektvar≈Ø' }, requires: { glass: 3, metal: 2, herbs: 1 }, category: 'tool', portable: false },
            { id: 'geiger_counter', name: 'Geiger≈Øv poƒç√≠taƒç', icon: '‚ò¢Ô∏è', result: { type: 'tool', bonus: 'radiation', desc: 'Zobrazuje radiaci' }, requires: { electronics: 4, copper: 3, glass: 2 }, category: 'tool', portable: false },
            
            // === MUNICE & BOMBY ===
            // === ST≈òELIVO (portable = jednoduch√©, false = slo≈æit√©) ===
            { id: 'craft_gunpowder', name: 'St≈ôeln√Ω prach (5x)', icon: 'üí•', result: { type: 'resource', resource: 'gunpowder', amount: 5 }, requires: { chemicals: 3, wood: 2 }, category: 'ammo', portable: false },
            { id: 'craft_arrows', name: '≈†√≠py (15x)', icon: '‚ûµ', result: { type: 'ammo', itemId: 'ammo_arrow', count: 15 }, requires: { wood: 2 }, category: 'ammo', portable: true },
            { id: 'craft_bolts', name: '≈†ipky do ku≈°e (10x)', icon: 'üî©', result: { type: 'ammo', itemId: 'ammo_bolt', count: 10 }, requires: { wood: 1, metal: 1 }, category: 'ammo', portable: true },
            { id: 'craft_9mm', name: 'N√°boje 9mm (15x)', icon: 'üî∏', result: { type: 'ammo', itemId: 'ammo_9mm', count: 15 }, requires: { metal: 2 }, category: 'ammo', portable: false },
            { id: 'craft_556', name: 'N√°boje 5.56 (10x)', icon: 'üî∂', result: { type: 'ammo', itemId: 'ammo_556', count: 10 }, requires: { metal: 2, copper: 1 }, category: 'ammo', portable: false },
            { id: 'craft_762', name: 'N√°boje 7.62 (8x)', icon: 'üî∑', result: { type: 'ammo', itemId: 'ammo_762', count: 8 }, requires: { metal: 3, copper: 1 }, category: 'ammo', portable: false },
            { id: 'craft_shells', name: 'Brokov√© n√°boje (8x)', icon: 'üî¥', result: { type: 'ammo', itemId: 'ammo_shell', count: 8 }, requires: { metal: 2, scrap: 1 }, category: 'ammo', portable: false },
            { id: 'poison_arrows', name: 'Otr√°ven√© ≈°√≠py (5x)', icon: '‚ò†Ô∏è', result: { type: 'ammo', itemId: 'ammo_arrow', count: 5, special: 'poison' }, requires: { wood: 1, herbs: 2 }, category: 'ammo', portable: true },
            { id: 'molotov', name: 'Molotov', icon: 'üî•', result: { type: 'throwable', damage: 30, aoe: true }, requires: { glass: 1, cloth: 1, fuel: 1 }, category: 'ammo', portable: true },
            { id: 'smoke_bomb', name: 'D√Ωmovnice', icon: 'üí®', result: { type: 'throwable', effect: 'escape' }, requires: { chemicals: 2, cloth: 1 }, category: 'ammo', portable: true },
            { id: 'grenade', name: 'Gran√°t', icon: 'üí£', result: { type: 'throwable', damage: 50, aoe: true }, requires: { metal: 3, chemicals: 2 }, category: 'ammo', portable: false },
            { id: 'acid_bomb', name: 'Kyselinov√° bomba', icon: 'üü¢', result: { type: 'throwable', damage: 40, special: 'acid' }, requires: { acid: 2, glass: 1 }, category: 'ammo', portable: false },
            { id: 'emp_grenade', name: 'EMP gran√°t', icon: '‚ö°', result: { type: 'throwable', damage: 20, special: 'emp' }, requires: { electronics: 3, copper: 2 }, category: 'ammo', portable: false },
            
            // === SPECI√ÅLN√ç (vƒõt≈°ina vy≈æaduje d√≠lnu) ===
            { id: 'torch', name: 'Pochode≈à', icon: 'üî•', result: { type: 'tool', bonus: 'light', desc: 'Svƒõtlo v noci' }, requires: { wood: 2, cloth: 1, fuel: 1 }, category: 'special', portable: true },
            { id: 'repair_kit', name: 'Opravn√° sada', icon: 'üîß', result: { type: 'consumable', effect: 'repair', value: 50 }, requires: { metal: 3, scrap: 4, cloth: 1 }, category: 'special', portable: false },
            { id: 'sleeping_bag', name: 'Spac√°k', icon: 'üõèÔ∏è', result: { type: 'tool', effect: 'sleep', value: 1, stackable: false }, requires: { cloth: 8, leather: 2 }, category: 'special', portable: true },
            { id: 'camouflage', name: 'Maskovac√≠ pl√°≈°≈•', icon: 'ü•∑', result: { type: 'tool', bonus: 'stealth', desc: '-30% ≈°ance na p≈ôepaden√≠' }, requires: { cloth: 8, leather: 4, herbs: 3 }, category: 'special', portable: false },
            { id: 'water_purifier', name: 'ƒåistiƒçka vody', icon: 'üíß', result: { type: 'tool', bonus: 'water', desc: 'Pasivnƒõ ƒçist√≠ vodu' }, requires: { glass: 4, chemicals: 3, metal: 4 }, category: 'special', portable: false },
            { id: 'solar_panel', name: 'Sol√°rn√≠ panel', icon: '‚òÄÔ∏è', result: { type: 'tool', bonus: 'power', desc: 'Energie pro z√°kladnu' }, requires: { electronics: 6, glass: 4, copper: 4 }, category: 'special', portable: false },
            { id: 'radio_transmitter', name: 'Vys√≠laƒçka', icon: 'üì°', result: { type: 'tool', bonus: 'signal', desc: 'P≈ôivol√° obchodn√≠ky' }, requires: { electronics: 5, copper: 4, metal: 3 }, category: 'special', portable: false },
            
            // === LUXUSN√ç P≈òEDMƒöTY (v≈°echny vy≈æaduj√≠ d√≠lnu) ===
            { id: 'silver_ring', name: 'St≈ô√≠brn√Ω prsten', icon: 'üíç', result: { type: 'accessory', bonus: 'luck', value: 10, desc: '+10% ≈°ance na loot' }, requires: { silver: 3, glass: 1 }, category: 'special', portable: false },
            { id: 'golden_amulet', name: 'Zlat√Ω amulet', icon: 'üìø', result: { type: 'accessory', bonus: 'xp', value: 15, desc: '+15% XP ze v≈°eho' }, requires: { gold: 2, electronics: 2, leather: 1 }, category: 'special', portable: false },
            { id: 'crystal_focus', name: 'Krystalov√Ω zamƒõ≈ôovaƒç', icon: 'üîÆ', result: { type: 'accessory', bonus: 'crit', value: 15, desc: '+15% kritick√Ω z√°sah' }, requires: { crystal: 2, electronics: 2 }, category: 'special', portable: false },
            { id: 'gem_pendant', name: 'Drahokamov√Ω p≈ô√≠vƒõsek', icon: 'üíé', result: { type: 'accessory', bonus: 'defense', value: 15, desc: '+15 obrana' }, requires: { gems: 2, gold: 1, leather: 1 }, category: 'special', portable: false },
            { id: 'gem_ring', name: 'Drahokamov√Ω prsten', icon: 'üíç', result: { type: 'accessory', bonus: 'luck', value: 10, desc: '+10% ≈°ance na vz√°cn√Ω loot' }, requires: { gems: 1, silver: 1 }, category: 'special', portable: false },
            
            // === LEGEND√ÅRN√ç P≈òEDMƒöTY (z trofej√≠) - vy≈æaduje skill Legend√°rn√≠ kov√°≈ô ===
            { id: 'deathclaw_gauntlet', name: 'Rukavice Deathclawa', icon: 'ü¶ñ', result: { type: 'weapon', damage: 55, rarity: 'legendary', special: 'bleed', critBonus: 15, desc: '+15% krit, zp≈Øsobuje krv√°cen√≠' }, requires: { deathclaw_hand: 1, metal: 10, leather: 5 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'legendary_blade', name: 'Legend√°rn√≠ ƒçepel', icon: 'üó°Ô∏è', result: { type: 'weapon', damage: 48, rarity: 'legendary', critChance: 0.15, desc: 'Mistrovsk√Ω meƒç s +15% krit' }, requires: { metal: 80, scrap: 30, gems: 1 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'legendary_rifle', name: 'Legend√°rn√≠ pu≈°ka', icon: 'üî´', result: { type: 'weapon', damage: 52, rarity: 'legendary', ammoType: '556', accuracy: 0.95, desc: '95% p≈ôesnost, devastuj√≠c√≠ damage' }, requires: { metal: 60, electronics: 15, scrap: 40 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'legendary_armor', name: 'Legend√°rn√≠ zbroj', icon: 'üõ°Ô∏è', result: { type: 'armor', defense: 45, rarity: 'legendary', hp: 30, desc: '+30 max HP, vysok√° obrana' }, requires: { metal: 100, leather: 20, chemicals: 10 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'mutant_heart_amulet', name: 'Amulet mutant√≠ho srdce', icon: 'üíú', result: { type: 'accessory', rarity: 'legendary', bonus: 'hp_regen', value: 3, desc: '+3 HP/min regenerace' }, requires: { mutant_heart: 1, gold: 2, gems: 1 }, category: 'legendary', portable: false, legendaryRequired: true },
            { id: 'crystal_blade', name: 'Krystalov√° ƒçepel', icon: 'üí†', result: { type: 'weapon', damage: 42, rarity: 'epic', special: 'energy', desc: 'Energetick√Ω damage ignoruje 25% zbroje' }, requires: { crystal: 5, metal: 20, electronics: 5 }, category: 'legendary', portable: false, legendaryRequired: true },
            
            // === KAMENN√â P≈òEDMƒöTY ===
            { id: 'stone_wall', name: 'Kamenn√° zeƒè', icon: 'üß±', result: { type: 'defense', bonus: 'base_defense', value: 20, desc: '+20 obrana osady' }, requires: { stone: 15, wood: 5 }, category: 'special', portable: false },
            { id: 'stone_axe', name: 'Kamenn√° sekera', icon: 'ü™ì', result: { type: 'weapon', damage: 10, rarity: 'common' }, requires: { stone: 4, wood: 2 }, category: 'weapon', portable: true },
            { id: 'grindstone', name: 'Brus', icon: '‚öôÔ∏è', result: { type: 'tool', bonus: 'sharpen', desc: '+5 damage zbran√≠ doƒçasnƒõ' }, requires: { stone: 6, metal: 2 }, category: 'tool', portable: false },
            { id: 'stone_furnace', name: 'Kamenn√° pec', icon: 'üî•', result: { type: 'tool', bonus: 'smelt', desc: 'Taven√≠ rud na kovy' }, requires: { stone: 12, metal: 4, wood: 6 }, category: 'special', portable: false },
            
            // === Z√ÅKLADN√ç SUROVINY (lze vyr√°bƒõt z jin√Ωch) ===
            { id: 'craft_rope', name: 'Lano (3x)', icon: '‚û∞', result: { type: 'resource', resource: 'rope', amount: 3 }, requires: { cloth: 4 }, category: 'special', portable: true },
            { id: 'craft_glass', name: 'Sklo (2x)', icon: 'üîÆ', result: { type: 'resource', resource: 'glass', amount: 2 }, requires: { stone: 5 }, category: 'special', portable: false },
            { id: 'craft_leather', name: 'Vydƒõlan√° k≈Ø≈æe (2x)', icon: 'ü¶¥', result: { type: 'resource', resource: 'leather', amount: 2 }, requires: { cloth: 2, chemicals: 1 }, category: 'special', portable: false },
            { id: 'craft_scrap', name: '≈†rot (3x)', icon: '‚ôªÔ∏è', result: { type: 'resource', resource: 'scrap', amount: 3 }, requires: { metal: 2 }, category: 'special', portable: true },
            { id: 'craft_fuel', name: 'Palivo (2x)', icon: '‚õΩ', result: { type: 'resource', resource: 'fuel', amount: 2 }, requires: { wood: 3, chemicals: 1 }, category: 'special', portable: false },
            
            // === ELIX√çRY S KRYSTALY (vy≈æaduj√≠ d√≠lnu) ===
            { id: 'crystal_elixir', name: 'Siln√Ω elix√≠r', icon: '‚ú®', result: { type: 'consumable', effect: 'all_stats', value: 20, desc: '+20 ke v≈°em stat≈Øm' }, requires: { herbs: 5, chemicals: 4, glass: 1 }, category: 'medical', portable: false },
            { id: 'silver_bullet', name: 'St≈ô√≠brn√© n√°boje (5x)', icon: 'üî´', result: { type: 'ammo', ammoType: 'bullet', count: 5, damage: 50 }, requires: { silver: 2, gunpowder: 3 }, category: 'ammo', portable: false },
            { id: 'gold_coating', name: 'Zes√≠len√Ω povlak', icon: '‚ú®', result: { type: 'consumable', effect: 'weapon_buff', value: 10, desc: '+10 damage na 10 boj≈Ø' }, requires: { metal: 2, chemicals: 2 }, category: 'special', portable: false }
        ];
        
        const ACHIEVEMENTS = [
            // Boj
            { id: 'first_blood', name: 'Prvn√≠ krev', icon: '‚öîÔ∏è', desc: 'Zabij prvn√≠ho nep≈ô√≠tele', check: () => state.stats.kills >= 1 },
            { id: 'warrior', name: 'Bojovn√≠k', icon: 'üó°Ô∏è', desc: 'Zabij 25 nep≈ô√°tel', check: () => state.stats.kills >= 25 },
            { id: 'slayer', name: 'Zabij√°k', icon: 'üíÄ', desc: 'Zabij 100 nep≈ô√°tel', check: () => state.stats.kills >= 100 },
            { id: 'boss_hunter', name: 'Lovec boss≈Ø', icon: 'üëæ', desc: 'Poraz sv√©ho prvn√≠ho bosse', check: () => state.stats.bossKills >= 1 },
            { id: 'boss_slayer', name: 'Niƒçitel boss≈Ø', icon: 'üêâ', desc: 'Poraz 5 boss≈Ø', check: () => state.stats.bossKills >= 5 },
            { id: 'untouchable', name: 'Nedotknuteln√Ω', icon: 'üõ°Ô∏è', desc: 'Vyhraj boj bez zranƒõn√≠', check: () => state.stats.flawlessWins >= 1 },
            { id: 'combo_master', name: 'Kritick√Ω √∫toƒçn√≠k', icon: 'üî•', desc: 'Dej 10 kritick√Ωch √∫der≈Ø', check: () => (state.stats.criticalHits || 0) >= 10 },
            
            // Pr≈Øzkum - opraveno na visitedLocations
            { id: 'explorer', name: 'Pr≈Øzkumn√≠k', icon: 'üó∫Ô∏è', desc: 'Nav≈°tiv 5 r≈Øzn√Ωch lokac√≠', check: () => (state.world?.visitedLocations?.length || 0) >= 5 },
            { id: 'adventurer', name: 'Dobrodruh', icon: 'üß≠', desc: 'Nav≈°tiv 15 r≈Øzn√Ωch lokac√≠', check: () => (state.world?.visitedLocations?.length || 0) >= 15 },
            { id: 'world_traveler', name: 'Svƒõtobƒõ≈æn√≠k', icon: 'üåç', desc: 'Nav≈°tiv 30 r≈Øzn√Ωch lokac√≠', check: () => (state.world?.visitedLocations?.length || 0) >= 30 },
            { id: 'treasure_hunter', name: 'Sbƒõratel vz√°cnost√≠', icon: 'üíé', desc: 'Najdi 5 vz√°cn√Ωch p≈ôedmƒõt≈Ø', check: () => (state.stats.rareFound || 0) >= 5 },
            
            // P≈ôe≈æit√≠
            { id: 'survivor_3', name: 'P≈ôe≈æiv≈°√≠', icon: 'üåÖ', desc: 'P≈ôe≈æij 3 dny', check: () => state.time.days >= 3 },
            { id: 'survivor_7', name: 'T√Ωdenn√≠ p≈ôe≈æit√≠', icon: 'üìÖ', desc: 'P≈ôe≈æij 7 dn√≠', check: () => state.time.days >= 7 },
            { id: 'survivor_30', name: 'Mƒõs√≠ƒçn√≠ veter√°n', icon: 'üèÜ', desc: 'P≈ôe≈æij 30 dn√≠', check: () => state.time.days >= 30 },
            { id: 'survivor_100', name: 'Legenda pustiny', icon: 'üëë', desc: 'P≈ôe≈æij 100 dn√≠', check: () => state.time.days >= 100 },
            { id: 'near_death', name: 'Na pokraji smrti', icon: 'üíÄ', desc: 'P≈ôe≈æij s m√©nƒõ ne≈æ 5 HP', check: () => state.stats.nearDeathExp >= 1 },
            { id: 'rad_survivor', name: 'Radiaƒçn√≠ veter√°n', icon: '‚ò¢Ô∏è', desc: 'P≈ôe≈æij s 80+ radiac√≠', check: () => state.stats.maxRadiation >= 80 },
            { id: 'weather_survivor', name: 'Bou≈ôkov√Ω p≈ôe≈æiv≈°√≠', icon: '‚õàÔ∏è', desc: 'P≈ôe≈æij radiaƒçn√≠ bou≈ôi', check: () => state.stats.radstormsSurvived >= 1 },
            
            // Ekonomika
            { id: 'saver', name: 'Spo≈ôivec', icon: 'ü™ô', desc: 'Nasb√≠rej 500 penƒõz', check: () => state.money >= 500 },
            { id: 'rich', name: 'Boh√°ƒç', icon: 'üí∞', desc: 'Nasb√≠rej 2000 penƒõz', check: () => state.money >= 2000 },
            { id: 'millionaire', name: 'Milion√°≈ô', icon: 'üíé', desc: 'Vydƒõlej celkem 10000 penƒõz', check: () => (state.stats.totalMoneyEarned || 0) >= 10000 },
            { id: 'trader_novice', name: 'Zaƒç√≠naj√≠c√≠ obchodn√≠k', icon: 'üõí', desc: 'Prodej 10 p≈ôedmƒõt≈Ø', check: () => (state.stats.itemsSold || 0) >= 10 },
            { id: 'trader_pro', name: 'Obchodn√≠k profesion√°l', icon: 'üè™', desc: 'Prodej 50 p≈ôedmƒõt≈Ø', check: () => (state.stats.itemsSold || 0) >= 50 },
            
            // Crafting
            { id: 'crafter', name: '≈òemesln√≠k', icon: 'üî®', desc: 'Vyrob 10 p≈ôedmƒõt≈Ø', check: () => (state.stats.itemsCrafted || 0) >= 10 },
            { id: 'master_crafter', name: 'Mistr ≈ôemesla', icon: '‚öíÔ∏è', desc: 'Vyrob 50 p≈ôedmƒõt≈Ø', check: () => (state.stats.itemsCrafted || 0) >= 50 },
            
            // Vybaven√≠
            { id: 'collector', name: 'Sbƒõratel', icon: 'üì¶', desc: 'Mƒõj 30+ item≈Ø v invent√°≈ôi', check: () => state.inv.length >= 30 },
            { id: 'legendary_finder', name: 'Legend√°rn√≠ n√°lez', icon: '‚≠ê', desc: 'Najdi legend√°rn√≠ p≈ôedmƒõt', check: () => (state.stats.legendaryFound || 0) >= 1 },
            { id: 'fully_equipped', name: 'Plnƒõ vybaven', icon: 'üéñÔ∏è', desc: 'Mƒõj zbra≈à, brnƒõn√≠ a helmu', check: () => state.equipped?.weapon && state.equipped?.armor && state.equipped?.helmet },
            
            // Osada
            { id: 'builder', name: 'Stavitel', icon: 'üèóÔ∏è', desc: 'Postav 5 budov', check: () => (state.base?.length || 0) >= 5 },
            { id: 'architect', name: 'Architekt', icon: 'üèõÔ∏è', desc: 'Postav 15 budov', check: () => (state.base?.length || 0) >= 15 },
            { id: 'settler', name: 'Zakladatel', icon: 'üèòÔ∏è', desc: 'P≈ôijmi prvn√≠ho osadn√≠ka', check: () => (state.settlement?.settlers?.length || 0) >= 1 },
            { id: 'community_leader', name: 'V≈Ødce komunity', icon: 'üë•', desc: 'Mƒõj 5 osadn√≠k≈Ø', check: () => (state.settlement?.settlers?.length || 0) >= 5 },
            
            // Level
            { id: 'level_5', name: 'Zku≈°en√Ω', icon: 'üìà', desc: 'Dos√°hni level 5', check: () => state.char.level >= 5 },
            { id: 'level_10', name: 'Veter√°n', icon: 'üéØ', desc: 'Dos√°hni level 10', check: () => state.char.level >= 10 },
            { id: 'level_20', name: 'Hrdina', icon: 'üèÖ', desc: 'Dos√°hni level 20', check: () => state.char.level >= 20 },
            { id: 'max_level', name: 'Mistr', icon: 'üëë', desc: 'Dos√°hni level 30', check: () => state.char.level >= 30 },
            
            // Speci√°ln√≠
            { id: 'pacifist', name: 'Pacifista', icon: '‚òÆÔ∏è', desc: 'P≈ôe≈æij 3 dny bez zabit√≠', check: () => (state.stats.pacifistDays || 0) >= 3 },
            { id: 'companion_friend', name: 'P≈ô√≠tel zv√≠≈ôat', icon: 'üêï', desc: 'Z√≠skej prvn√≠ho spoleƒçn√≠ka', check: () => (state.companions?.length || 0) >= 1 },
            { id: 'companion_master', name: 'P√°n spoleƒçn√≠k≈Ø', icon: 'ü§ù', desc: 'Mƒõj 3 spoleƒçn√≠ky', check: () => (state.companions?.length || 0) >= 3 },
            { id: 'quest_complete', name: 'Dobrodinec', icon: 'üìú', desc: 'Dokonƒçi hlavn√≠ quest', check: () => (state.mainQuest?.completedQuests?.length || 0) >= 1 },
            { id: 'story_master', name: 'Mistr p≈ô√≠bƒõhu', icon: 'üìñ', desc: 'Dokonƒçi 10 quest≈Ø', check: () => (state.mainQuest?.completedQuests?.length || 0) >= 10 }
        ];
        
        // üìñ BESTI√Å≈ò - Popisy nep≈ô√°tel
        const BESTIARY_DESCRIPTIONS = {
            // Tier 1 - Divok√° zvƒõ≈ô
            rat: 'Obyƒçejn√° krysa, kter√° se po apokalypse rozmno≈æila do ob≈ô√≠ch smeƒçek. Slab√°, ale nebezpeƒçn√° ve velk√©m poƒçtu.',
            giant_rat: 'Mutac√≠ zvƒõt≈°en√° krysa. Jej√≠ zuby dok√°≈æ√≠ prokousnout i ko≈æen√© boty.',
            mutant_rat: 'Radiac√≠ pozmƒõnƒõn√° krysa se sv√≠t√≠c√≠ma oƒçima. Jej√≠ kousnut√≠ m≈Ø≈æe zp≈Øsobit infekci.',
            wild_dog: 'Kdysi vƒõrn√Ω spoleƒçn√≠k ƒçlovƒõka, nyn√≠ zdivoƒçel√Ω pred√°tor lov√≠c√≠ v smeƒçk√°ch.',
            feral_cat: 'Zdivoƒçel√° koƒçka s ostr√Ωmi dr√°py. Rychl√° a nep≈ôedv√≠dateln√°.',
            feral: 'ƒålovƒõk, kter√Ω ztratil rozum v pustinƒõ. √ötoƒç√≠ na v≈°e ≈æiv√©.',
            
            // Tier 2 - St≈ôedn√≠
            zombie: 'O≈æivl√° mrtvola poh√°nƒõn√° nezn√°mou silou. Pomal√°, ale vytrval√°.',
            raider_weak: 'Zaƒç√≠naj√≠c√≠ n√°jezdn√≠k s improvizovanou v√Ωzbroj√≠. Nebezpeƒçn√Ω ve skupinƒõ.',
            raider: 'Zku≈°en√Ω n√°jezdn√≠k, kter√Ω p≈ôe≈æil d√≠ky kr√°de≈æi a n√°sil√≠.',
            wolf: 'Mutantn√≠ vlk s ocelovƒõ ≈°edou srst√≠. Alfa pred√°tor pustiny.',
            soldier: 'Voj√°k p≈ôe≈æiv≈°√≠ z vojensk√© z√°kladny. Dob≈ôe vycviƒçen√Ω a ozbrojen√Ω.',
            soldier_zombie: 'O≈æivl√Ω voj√°k st√°le v uniformƒõ. Nebezpeƒçnƒõj≈°√≠ ne≈æ bƒõ≈æn√Ω zombie.',
            turret: 'Automatick√° st≈ôeleck√° vƒõ≈æ. St≈ô√≠l√≠ na v≈°e co se h√Ωbe.',
            cave_spider: 'Ob≈ô√≠ pavouk ≈æij√≠c√≠ v temn√Ωch jeskyn√≠ch. Jeho jed paralyzuje obƒõti.',
            ghost: 'P≈ô√≠zraƒçn√° bytost bez fyzick√© formy. ≈ò√≠k√° se, ≈æe jsou to du≈°e obƒõt√≠ apokalypsy.',
            mutant_dog: 'Pes pozmƒõnƒõn√Ω radiac√≠. Jeho ƒçenich c√≠t√≠ ko≈ôist na kilometry.',
            mutant_frog: 'Ob≈ô√≠ ≈æ√°ba s jedovatou k≈Ø≈æ√≠. Jej√≠ jazyk dok√°≈æe zas√°hnout na nƒõkolik metr≈Ø.',
            zombie_cop: 'Zombie v policejn√≠ uniformƒõ. St√°le nos√≠ slu≈æebn√≠ zbra≈à.',
            mutant_fish: 'Ryba s nohama, kter√° vy≈°la z vody. Apokalypsa zmƒõnila i oce√°ny.',
            
            // Tier 3 - Siln√≠
            mutant: 'ƒålovƒõk zcela p≈ôemƒõnƒõn√Ω radiac√≠. Siln√Ω, odoln√Ω a nep≈ô√°telsk√Ω.',
            bandit: 'Profesion√°ln√≠ zloƒçinec p≈ôe≈æiv≈°√≠ d√≠ky bezcitnosti. Dob≈ôe ozbrojen√Ω.',
            ghoul: 'Kdysi ƒçlovƒõk, nyn√≠ rozpadaj√≠c√≠ se stvo≈ôen√≠ ≈æiv√≠c√≠ se masem.',
            raider_boss: 'V≈Ødce bandy n√°jezdn√≠k≈Ø. Bezohledn√Ω a nebezpeƒçn√Ω.',
            robot: 'Vojensk√Ω robot st√°le pln√≠c√≠ sv√© naprogramovan√© rozkazy.',
            slaver: 'Obchodn√≠k s lidmi. Jeden z nejodpornƒõj≈°√≠ch tvor≈Ø pustiny.',
            experiment: 'Utekl√Ω laboratorn√≠ experiment. Nikdo nev√≠, co p≈ôesnƒõ je.',
            swamp_creature: 'Prastar√Ω tvor z ba≈æin. Mo≈æn√° p≈ôe≈æil z doby dinosaur≈Ø.',
            ice_mutant: 'Mutant adaptovan√Ω na extr√©mn√≠ chlad. Jeho dotek mraz√≠.',
            toxic_zombie: 'Zombie nas√°kl√Ω toxick√Ωmi l√°tkami. Jeho p≈ô√≠tomnost otravuje vzduch.',
            electric_mutant: 'Mutant generuj√≠c√≠ elekt≈ôinu. Nebezpeƒçn√© se ho dotknout.',
            
            // Tier 4 - Bossov√©
            slaver_boss: 'V≈Ødce otrok√°≈ôsk√©ho syndik√°tu. M√° arm√°du vƒõrn√Ωch slu≈æebn√≠k≈Ø.',
            giant_mutant: 'Ob≈ô√≠ mutant vysok√Ω p≈ôes 3 metry. Legenda pustiny.',
            alpha_wolf: 'V≈Ødce vlƒç√≠ smeƒçky. Nejvƒõt≈°√≠ a nejsilnƒõj≈°√≠ z vlk≈Ø.',
            zombie_hulk: 'Masivn√≠ zombie mutant. Jeho s√≠la dok√°≈æe prorazit zdi.',
            elite_robot: 'Pokroƒçil√Ω vojensk√Ω robot s AI. T√©mƒõ≈ô nezniƒçiteln√Ω.',
            toxic_beast: 'Bestie z toxick√© z√≥ny. Jej√≠ krev je ƒçist√Ω jed.',
            acid_beast: 'Tvor plivaj√≠c√≠ kyselinu. Rozpou≈°t√≠ v≈°e ve sv√© cestƒõ.',
            swamp_beast: 'Prastar√Ω str√°≈æce ba≈æin. M√≠stn√≠ ho uct√≠vaj√≠ jako boha.',
            glowing_ghoul: 'Ghoul nas√°kl√Ω radiac√≠. Z√°≈ô√≠ ve tmƒõ zelen√Ωm svƒõtlem.',
            mutant_brute: 'Nejsilnƒõj≈°√≠ z mutant≈Ø. ≈ò√≠k√° se, ≈æe byl kdysi olympijsk√Ω atlet.',
            
            // Tier 5 - Legend√°rn√≠
            glowing_one: 'Legend√°rn√≠ z√°≈ô√≠c√≠ bytost. Samotn√° radiace z√≠skala vƒõdom√≠.',
            irradiated_beast: 'Bestie z centra v√Ωbuchu. Jej√≠ tƒõlo je ƒçist√° radiace.',
            mutant_behemoth: 'Kolos√°ln√≠ mutant. Nƒõkte≈ô√≠ vƒõ≈ô√≠, ≈æe je nesmrteln√Ω.',
            deathclaw: 'Legend√°rn√≠ dravec. Nejv√≠ce ob√°van√Ω tvor cel√© pustiny.',
            mutant_giant: 'Obr mezi mutanty. Jeho kroky ot≈ô√°saj√≠ zem√≠.',
            mutant_queen: 'Kr√°lovna mutant≈Ø. Pr√Ω ovl√°d√° v≈°echny ostatn√≠ mutanty.',
            ai_guardian: 'Str√°≈æce starovƒõk√© technologie. Chr√°n√≠ tajemstv√≠ p≈ôed apokalypsy.',
            
            // Speci√°ln√≠
            sentinel: 'Kamenn√Ω str√°≈æce tajn√©ho trezoru. Stoj√≠ zde stalet√≠.',
            ancient_guardian: 'Prastar√Ω str√°≈æce poklad≈Ø. Posledn√≠ obr√°nce ztracen√© civilizace.'
        };
        
        // Funkce pro zobrazen√≠ besti√°≈ôe
        function showBestiary() {
            const killsByType = state.stats.killsByType || {};
            const discoveredEnemies = Object.keys(killsByType).filter(k => killsByType[k] > 0);
            const totalEnemyTypes = ENEMIES.length;
            
            // Seskup nep≈ô√°tele podle tieru
            const enemiesByTier = {};
            ENEMIES.forEach(enemy => {
                if (!enemiesByTier[enemy.tier]) enemiesByTier[enemy.tier] = [];
                enemiesByTier[enemy.tier].push(enemy);
            });
            
            const tierNames = {
                1: 'üêÄ Tier 1 - Divok√° zvƒõ≈ô',
                2: 'üíÄ Tier 2 - St≈ôedn√≠ hrozby', 
                3: 'üëπ Tier 3 - Siln√≠ nep≈ô√°tel√©',
                4: 'üëæ Tier 4 - Bossov√©',
                5: 'üëë Tier 5 - Legend√°rn√≠'
            };
            
            const tierColors = {
                1: '#8bc34a',
                2: '#ff9800',
                3: '#f44336',
                4: '#9c27b0',
                5: '#ffd700'
            };
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; color: #888;">Objeveno nep≈ô√°tel</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f44336;">${discoveredEnemies.length} / ${totalEnemyTypes}</div>
                    <div style="background: #333; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #f44336, #ff9800); height: 100%; width: ${(discoveredEnemies.length / totalEnemyTypes * 100).toFixed(1)}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            `;
            
            for (let tier = 1; tier <= 5; tier++) {
                const enemies = enemiesByTier[tier] || [];
                const discovered = enemies.filter(e => killsByType[e.id] > 0).length;
                
                html += `
                    <details ${tier <= 2 ? 'open' : ''} style="margin-bottom: 0.5rem;">
                        <summary style="background: linear-gradient(135deg, ${tierColors[tier]}22, #1a1a1a); padding: 0.6rem; border-radius: 6px; cursor: pointer; border-left: 3px solid ${tierColors[tier]};">
                            <span style="color: ${tierColors[tier]}; font-weight: bold;">${tierNames[tier]}</span>
                            <span style="color: #888; font-size: 0.8rem; margin-left: 0.5rem;">(${discovered}/${enemies.length})</span>
                        </summary>
                        <div style="padding: 0.5rem; display: grid; gap: 0.4rem;">
                `;
                
                enemies.forEach(enemy => {
                    const kills = killsByType[enemy.id] || 0;
                    const discovered = kills > 0;
                    const desc = BESTIARY_DESCRIPTIONS[enemy.id] || 'Nezn√°m√Ω nep≈ô√≠tel.';
                    
                    if (discovered) {
                        html += `
                            <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 0.6rem; border-radius: 6px; border: 1px solid ${tierColors[tier]}44;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                                    <span style="font-size: 1.5rem;">${enemy.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="color: #fff; font-weight: bold; font-size: 0.9rem;">${enemy.name}</div>
                                        <div style="color: ${tierColors[tier]}; font-size: 0.7rem;">Zabito: ${kills}x</div>
                                    </div>
                                    ${enemy.isBoss ? '<span style="background: #9c27b0; color: #fff; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem;">BOSS</span>' : ''}
                                </div>
                                <div style="color: #888; font-size: 0.75rem; font-style: italic; margin-bottom: 0.4rem;">${desc}</div>
                                <div style="display: flex; gap: 0.5rem; font-size: 0.7rem; color: #666;">
                                    <span>‚ù§Ô∏è ${enemy.hp}</span>
                                    <span>‚öîÔ∏è ${enemy.damage}</span>
                                    <span>üõ°Ô∏è ${enemy.defense}</span>
                                    <span>‚≠ê ${enemy.xp} XP</span>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 6px; border: 1px solid #222; opacity: 0.5;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">‚ùì</span>
                                    <div>
                                        <div style="color: #444; font-weight: bold; font-size: 0.9rem;">???</div>
                                        <div style="color: #333; font-size: 0.7rem;">Zat√≠m neobjeveno</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `</div></details>`;
            }
            
            html += `</div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">Zav≈ô√≠t</button>
            `;
            
            showModal('üìñ Besti√°≈ô', html);
        }
        
        const RANDOM_EVENTS = [
            {
                id: 'abandoned_camp',
                name: 'Opu≈°tƒõn√Ω kemp',
                icon: 'üèïÔ∏è',
                chance: 0.15,
                trigger: () => {
                    const loot = ITEMS.filter(i => i.findChance > 0 && (i.rarity === 'common' || i.rarity === 'uncommon'));
                    const found = loot[Math.floor(Math.random() * loot.length)];
                    if (found && canAddItem(found, 1)) {
                        const existing = state.inv.find(i => i.id === found.id);
                        if (existing && found.type === 'consumable') {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            state.inv.push({...found, count: found.type === 'consumable' ? 1 : undefined});
                        }
                        showModal('üèïÔ∏è Opu≈°tƒõn√Ω kemp!', 
                            '<p>Na≈°el jsi opu≈°tƒõn√Ω kemp cestovatel≈Ø...</p>' +
                            '<p style="color: #8bc34a;">‚úì Na≈°el jsi: ' + found.icon + ' ' + found.name + '</p>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>'
                        );
                    }
                }
            },
            {
                id: 'radiation_storm',
                name: 'Radiaƒçn√≠ bou≈ôe',
                icon: '‚ò¢Ô∏è',
                chance: 0.10,
                trigger: () => {
                    addRadiation(20);
                    // Track pro achievement
                    state.stats.radstormsSurvived = (state.stats.radstormsSurvived || 0) + 1;
                    showModal('‚ò¢Ô∏è Radiaƒçn√≠ bou≈ôe!', 
                        ('<p style="color: #c62828;">Dostal ses do radiaƒçn√≠ bou≈ôe!</p>') +
                        '<p>+20 radiace</p>' +
                        ('<p style="color: #ff9800;">‚ö†Ô∏è Pot≈ôebuje≈° RadAway!</p>') +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>'
                    );
                    addLog('Radiaƒçn√≠ bou≈ôe! +20 radiace', '‚ò¢Ô∏è');
                }
            },
            {
                id: 'friendly_trader',
                name: 'P≈ô√°telsk√Ω obchodn√≠k',
                icon: 'ü§ù',
                chance: 0.08,
                trigger: () => {
                    showModal('ü§ù P≈ô√°telsk√Ω obchodn√≠k!', 
                        '<p>Potkal jsi p≈ô√°telsk√©ho obchodn√≠ka na cestƒõ!</p>' +
                        ('<p style="color: #8bc34a;">Nab√≠z√≠ speci√°ln√≠ ceny...</p>') +
                        '<button class="btn" onclick="closeModal(); openShop();" style="width: 100%; margin-top: 1rem;">üè™ ' + ('Otev≈ô√≠t obchod') + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó ' + ('Ne, dƒõkuji') + '</button>'
                    );
                }
            },
            {
                id: 'mystery_box',
                name: 'Z√°hadn√Ω bal√≠ƒçek',
                icon: 'üì¶',
                chance: 0.12,
                trigger: () => {
                    const roll = Math.random();
                    if (roll < 0.6) {
                        // Good item
                        const rare = ITEMS.filter(i => i.rarity === 'rare' && i.findChance > 0);
                        if (rare.length > 0) {
                            const item = rare[Math.floor(Math.random() * rare.length)];
                            if (canAddItem(item, 1)) {
                                state.inv.push({...item, count: item.type === 'consumable' ? 1 : undefined});
                                showModal('üì¶ Z√°hadn√Ω bal√≠ƒçek!', 
                                    '<p>Na≈°el jsi z√°hadn√Ω bal√≠ƒçek!</p>' +
                                    '<p style="color: #2196f3;">‚úì ' + item.icon + ' ' + item.name + '</p>' +
                                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>'
                                );
                            }
                        }
                    } else {
                        // Trap!
                        state.char.hp = Math.max(1, state.char.hp - 20);
                        showModal('üì¶ Past!', 
                            ('<p style="color: #c62828;">Byl to trap!</p>') +
                            '<p>-20 HP</p>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>'
                        );
                        addLog('Chytil ses do pasti! -20 HP', 'üí•');
                    }
                }
            },
            {
                id: 'find_money',
                name: 'Pen√≠ze',
                icon: 'üí∞',
                chance: 0.12,
                trigger: () => {
                    const amount = Math.floor(Math.random() * 40) + 15; // 15-55 (sn√≠≈æeno z 50-150)
                    addMoney(amount);
                    showModal('üí∞ N√°hodn√Ω n√°lez!', 
                        '<p>Na≈°el jsi trochu penƒõz na zemi!</p>' +
                        '<p style="color: #ffd700;">+' + amount + ' penƒõz</p>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>'
                    );
                }
            },
            {
                id: 'survivor_help',
                name: 'P≈ôe≈æiv≈°√≠ v nouzi',
                icon: 'üÜò',
                chance: 0.08,
                trigger: () => {
                    showModal('üÜò P≈ôe≈æiv≈°√≠ v nouzi!', 
                        '<p>Sly≈°√≠≈° vol√°n√≠ o pomoc z nedaleka...</p>' +
                        '<p>P≈ôe≈æiv≈°√≠ je v ohro≈æen√≠ mutanty!</p>' +
                        '<button class="btn" onclick="helpSurvivor()" style="width: 100%; margin-top: 1rem; background: #4caf50;">ü§ù Pomoct (boj)</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">üèÉ ' + ('Ignorovat') + '</button>'
                    );
                }
            },
            {
                id: 'treasure_map',
                name: 'Mapa k pokladu',
                icon: 'üó∫Ô∏è',
                chance: 0.05,
                trigger: () => {
                    // Pou≈æij nov√Ω WORLD_LOCATIONS syst√©m
                    const treasureLocations = WORLD_LOCATIONS.filter(l => 
                        l.type !== 'home' && l.type !== 'empty' && l.zone !== 'safe' &&
                        !state.world.visitedLocations?.includes(l.id)
                    );
                    if (treasureLocations.length === 0) return;
                    
                    const treasureLoc = treasureLocations[Math.floor(Math.random() * treasureLocations.length)];
                    state.treasureLocation = { 
                        locationId: treasureLoc.id,
                        locationName: treasureLoc.name,
                        expiresAt: Date.now() + 30 * 60 * 1000 // 30 minut
                    };
                    showModal('üó∫Ô∏è Nalezena mapa!', 
                        '<p>Na≈°el jsi starou mapu s oznaƒçen√Ωm m√≠stem!</p>' +
                        '<p style="color: #ffd700;">üìç Poklad je v lokaci: <strong>' + treasureLoc.name + '</strong></p>' +
                        '<p style="color: #999; font-size: 0.85rem;">M√°≈° 30 minut na nalezen√≠ pokladu!</p>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì Zapamatov√°no!</button>'
                    );
                    addLog('Na≈°el jsi mapu k pokladu! Lokace: ' + treasureLoc.name, 'üó∫Ô∏è');
                }
            },
            {
                id: 'caravan',
                name: 'Obchodn√≠ karavana',
                icon: 'üê™',
                chance: 0.10,
                trigger: () => {
                    // Aktivuj glob√°ln√≠ karavanu
                    state.caravan = state.caravan || { active: false, until: 0, lastCheck: Date.now() };
                    state.caravan.active = true;
                    state.caravan.until = Date.now() + 300000; // 5 minut
                    
                    showModal('üê™ Obchodn√≠ karavana!', 
                        '<p>Potkal jsi obchodn√≠ karavanu!</p>' +
                        '<p style="color: #8bc34a;">Nab√≠zej√≠ vz√°cn√© zbo≈æ√≠ za dobr√© ceny...</p>' +
                        '<p style="color: #888;">Karavana z≈Østane 5 minut.</p>' +
                        '<button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 1rem;">üõí ' + ('Prohl√©dnout zbo≈æ√≠') + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">üëã ' + ('Rozlouƒçit se') + '</button>'
                    );
                    addLog('Potkal jsi obchodn√≠ karavanu!', 'üê™');
                }
            },
            {
                id: 'animal_attack',
                name: '√ötok divok√Ωch zv√≠≈ôat',
                icon: 'üê∫',
                chance: 0.12,
                trigger: () => {
                    const animals = ENEMIES.filter(e => e.tier === 1);
                    const animal = animals[Math.floor(Math.random() * animals.length)];
                    showModal('üê∫ √ötok zv√≠≈ôat!', 
                        ('<p style="color: #ff9800;">Divok√° zv√≠≈ôata tƒõ napadla!</p>') +
                        '<p>' + animal.icon + ' ' + animal.name + ' √∫toƒç√≠!</p>' +
                        '<button class="btn" onclick="startCombat({id: \'' + animal.id + '\'});" style="width: 100%; margin-top: 1rem;">‚öîÔ∏è ' + ('Bojovat!') + '</button>'
                    );
                }
            },
            {
                id: 'hidden_stash',
                name: 'Skryt√° skr√Ω≈°',
                icon: 'üï≥Ô∏è',
                chance: 0.08,
                trigger: () => {
                    const resources = ['wood', 'metal', 'stone', 'cloth'];
                    const found = {};
                    resources.forEach(r => {
                        const amount = 1 + Math.floor(Math.random() * 2); // 1-2 (sn√≠≈æeno z 1-5)
                        found[r] = amount;
                        state.resources[r] = (state.resources[r] || 0) + amount;
                    });
                    showModal('üï≥Ô∏è Skryt√° skr√Ω≈°!', 
                        '<p>Objevil jsi malou skr√Ω≈° se z√°sobami!</p>' +
                        '<p style="color: #8bc34a;">' +
                        'üå≤ +' + found.wood + ' d≈ôeva<br>' +
                        '‚öôÔ∏è +' + found.metal + ' kovu<br>' +
                        'üóø +' + found.stone + ' kamene<br>' +
                        'üßµ +' + found.cloth + ' l√°tky</p>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì ' + ('Dob≈ôe!') + '</button>'
                    );
                }
            },
            {
                id: 'wounded_companion',
                name: 'Zranƒõn√Ω spoleƒçn√≠k',
                icon: 'ü§ï',
                chance: 0.04,
                trigger: () => {
                    if (state.companions && state.companions.length >= getMaxCompanions()) return; // Max companions based on level
                    const availableCompanions = COMPANIONS.filter(c => !state.companions?.find(sc => sc.id === c.id));
                    if (availableCompanions.length === 0) return;
                    const companion = availableCompanions[Math.floor(Math.random() * availableCompanions.length)];
                    showModal('ü§ï Zranƒõn√Ω spoleƒçn√≠k!', 
                        '<p>Na≈°el jsi zranƒõn√©ho ' + companion.name + '!</p>' +
                        '<p>' + companion.icon + ' ' + companion.abilityDesc + '</p>' +
                        '<p style="color: #8bc34a;">Pokud ho vyl√©ƒç√≠≈°, p≈ôipoj√≠ se k tobƒõ!</p>' +
                        '<button class="btn" onclick="rescueCompanion(\'' + companion.id + '\')" style="width: 100%; margin-top: 1rem; background: #4caf50;">üíä ' + ('Vyl√©ƒçit (1x L√©k√°rniƒçka)') + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">üòî ' + ('Nechat b√Ωt') + '</button>'
                    );
                }
            }
        ];
        
        const DAILY_QUEST_POOL = [
            // === BOJOV√â ===
            { id: 'kill_enemies', name: 'Lovec', desc: 'Zabij 3 nep≈ô√°tele', icon: '‚öîÔ∏è', 
              target: 3, progressKey: 'kills',
              check: () => (state.dailyQuests.progress?.kills || 0) >= 3, 
              reward: () => { addMoney(80); addXP(30); } },
            { id: 'kill_many', name: 'Vyhlazovaƒç', desc: 'Zabij 8 nep≈ô√°tel', icon: 'üíÄ', 
              target: 8, progressKey: 'kills',
              check: () => (state.dailyQuests.progress?.kills || 0) >= 8, 
              reward: () => { addMoney(150); addXP(60); } },
            
            // === PR≈ÆZKUM ===
            { id: 'explore_hexes', name: 'Pr≈Øzkumn√≠k', desc: 'Objevuj 2 nov√© lokace', icon: 'üó∫Ô∏è', 
              target: 2, progressKey: 'explored',
              check: () => (state.dailyQuests.progress?.explored || 0) >= 2, 
              reward: () => { addXP(50); } },
            
            // === SBƒöR ===
            { id: 'collect_money', name: 'Sbƒõratel', desc: 'Z√≠skej 150 penƒõz', icon: 'üí∞', 
              target: 150, progressKey: 'moneyEarned',
              check: () => (state.dailyQuests.progress?.moneyEarned || 0) >= 150, 
              reward: () => { addXP(40); } },
            { id: 'collect_loot', name: 'Hledaƒç', desc: 'Najdi 5 p≈ôedmƒõt≈Ø', icon: 'üéí', 
              target: 5, progressKey: 'itemsFound',
              check: () => (state.dailyQuests.progress?.itemsFound || 0) >= 5, 
              reward: () => { addMoney(70); } },
            
            // === V√ùROBA ===
            { id: 'craft_items', name: '≈òemesln√≠k', desc: 'Vyrob 2 vƒõci', icon: 'üî®', 
              target: 2, progressKey: 'crafted',
              check: () => (state.dailyQuests.progress?.crafted || 0) >= 2, 
              reward: () => { state.settlement.resources.wood = (state.settlement?.resources?.wood || 0) + 10; state.settlement.resources.metal = (state.settlement?.resources?.metal || 0) + 5; } },
            { id: 'cook_food', name: 'Kucha≈ô', desc: 'Upeƒç/uva≈ô 3 j√≠dla', icon: 'üçñ', 
              target: 3, progressKey: 'cooked',
              check: () => (state.dailyQuests.progress?.cooked || 0) >= 3, 
              reward: () => { addXP(25); } },
            
            // === OBCHOD ===
            { id: 'trade_items', name: 'Obchodn√≠k', desc: 'Prodej 3 vƒõci', icon: 'üíº', 
              target: 3, progressKey: 'sold',
              check: () => (state.dailyQuests.progress?.sold || 0) >= 3, 
              reward: () => { addMoney(100); } },
            { id: 'buy_items', name: 'N√°kupƒç√≠', desc: 'Kup 2 vƒõci', icon: 'üõí', 
              target: 2, progressKey: 'bought',
              check: () => (state.dailyQuests.progress?.bought || 0) >= 2, 
              reward: () => { addXP(30); } },
            
            // === OSADA ===
            { id: 'feed_companion', name: 'Krmitel', desc: 'Nakrm spoleƒçn√≠ka', icon: 'ü¶¥', 
              target: 1, progressKey: 'fedCompanion',
              check: () => (state.dailyQuests.progress?.fedCompanion || 0) >= 1, 
              reward: () => { addXP(20); addMoney(30); } },
            { id: 'heal_self', name: 'P≈ôe≈æiv≈°√≠', desc: 'Vyl√©ƒç se 50 HP', icon: 'üíö', 
              target: 50, progressKey: 'healed',
              check: () => (state.dailyQuests.progress?.healed || 0) >= 50, 
              reward: () => { addMoney(50); } },
            
            // === SPECI√ÅLN√ç ===
            // PvP quest odstranƒõn - PvP je zamƒçeno
            { id: 'gamble', name: 'Hr√°ƒç', desc: 'Zahraj si v kasinu', icon: 'üé∞', 
              target: 1, progressKey: 'gambled',
              check: () => (state.dailyQuests.progress?.gambled || 0) >= 1, 
              reward: () => { addXP(15); } }
        ];
        
        // P≈ôeklady daily quest≈Ø
        function getDailyQuestName(questId) {
            const quest = DAILY_QUEST_POOL.find(q => q.id === questId);
            return quest?.name || questId;
        }
        
        function getDailyQuestDesc(questId) {
            const quest = DAILY_QUEST_POOL.find(q => q.id === questId);
            return quest?.desc || '';
        }
        
        // === FRAKCE SYST√âM ===
        const FACTIONS = [
            { 
                id: 'traders', 
                name: 'Obchodn√≠ gilda', 
                icon: 'üè™', 
                color: '#ffd700',
                desc: 'Obchodn√≠ci a karavan√°≈ôi. Ovl√°daj√≠ obchod v pustinƒõ.',
                bonuses: {
                    friendly: { priceDiscount: 0.05, specialItems: true, desc: '-5% ceny, speci√°ln√≠ zbo≈æ√≠' },
                    allied: { priceDiscount: 0.10, freeHealing: true, desc: '-10% ceny, l√©ƒçen√≠ zdarma' }
                },
                penalties: {
                    hostile: { priceIncrease: 0.5, noTrade: false, desc: '+50% ceny' },
                    enemy: { noTrade: true, attackOnSight: true, desc: 'Neobchoduj√≠, √∫toƒç√≠' }
                },
                locations: ['trading_post', 'bazaar']
            },
            { 
                id: 'scientists', 
                name: 'Vƒõdci Enkl√°vy', 
                icon: 'üî¨', 
                color: '#00bcd4',
                desc: 'Hledaj√≠ odpovƒõdi v trosk√°ch star√© civilizace.',
                bonuses: {
                    friendly: { craftBonus: 0.05, techAccess: true, desc: '+5% efektivita craftingu, tech' },
                    allied: { mutations: true, labAccess: true, desc: 'L√©ƒçen√≠ mutac√≠, p≈ô√≠stup do lab' }
                },
                penalties: {
                    hostile: { noHelp: true, desc: 'Nepom√°haj√≠' },
                    enemy: { sabotage: true, desc: 'Sabotuj√≠ tv√© vybaven√≠' }
                },
                locations: ['lab', 'bunker']
            },
            { 
                id: 'raiders', 
                name: 'N√°jezdn√≠ci', 
                icon: 'üíÄ', 
                color: '#f44336',
                desc: 'Brut√°ln√≠ gangy ≈æij√≠c√≠ z loupe≈æ√≠ a n√°sil√≠.',
                bonuses: {
                    friendly: { safePassage: true, blackMarket: true, desc: 'Bezpeƒçn√Ω pr≈Øchod, ƒçern√Ω trh' },
                    allied: { mercenaries: true, intimidation: true, desc: '≈Ωold√°ci, zastra≈°ov√°n√≠' }
                },
                penalties: {
                    hostile: { ambushChance: 0.3, desc: '30% ≈°ance na p≈ôepaden√≠' },
                    enemy: { ambushChance: 0.6, raidSettlement: true, desc: '60% p≈ôepaden√≠, raidy na osadu' }
                },
                locations: ['raider_camp', 'wasteland']
            },
            { 
                id: 'mutants', 
                name: 'Mutant√≠ kmen', 
                icon: '‚ò£Ô∏è', 
                color: '#8bc34a',
                desc: 'P≈ôe≈æiv≈°√≠ transformovan√≠ radiac√≠. Mist≈ôi pustiny.',
                bonuses: {
                    friendly: { radResist: 0.1, mutantTrade: true, desc: '-10% radiace, obchod s mutanty' },
                    allied: { radResist: 0.25, mutantAllies: true, desc: '-25% radiace, spojenci v boji' }
                },
                penalties: {
                    hostile: { mutantAggro: true, desc: 'Mutanti √∫toƒç√≠ na potk√°n√≠' },
                    enemy: { mutantHunters: true, desc: 'Pos√≠laj√≠ lovce' }
                },
                locations: ['mutant_village', 'toxic_zone']
            },
            { 
                id: 'military', 
                name: 'Vojensk√Ω remnant', 
                icon: 'üéñÔ∏è', 
                color: '#607d8b',
                desc: 'Zbytky star√© arm√°dy. Discipl√≠na a po≈ô√°dek.',
                bonuses: {
                    friendly: { weaponAccess: true, training: true, desc: 'P≈ô√≠stup ke zbran√≠m, tr√©nink' },
                    allied: { eliteWeapons: true, tacticalBonus: 0.05, desc: 'Elitn√≠ zbranƒõ, +5% damage' }
                },
                penalties: {
                    hostile: { noWeapons: true, desc: 'Neobchoduj√≠ zbranƒõ' },
                    enemy: { hunted: true, desc: 'Aktivnƒõ tƒõ lov√≠' }
                },
                locations: ['military_base', 'checkpoint']
            }
        ];
        
        // Reputaƒçn√≠ √∫rovnƒõ
        const REPUTATION_LEVELS = [
            { id: 'enemy', name: 'Nep≈ô√≠tel', min: -100, max: -61, color: '#8B0000', icon: 'üíÄ' },
            { id: 'hostile', name: 'Nep≈ô√°telsk√Ω', min: -60, max: -21, color: '#f44336', icon: 'üò†' },
            { id: 'neutral', name: 'Neutr√°ln√≠', min: -20, max: 19, color: '#9e9e9e', icon: 'üòê' },
            { id: 'friendly', name: 'P≈ô√°telsk√Ω', min: 20, max: 49, color: '#4caf50', icon: 'üòä' },
            { id: 'trusted', name: 'D≈Øvƒõryhodn√Ω', min: 50, max: 99, color: '#8bc34a', icon: 'ü§ù' },
            { id: 'allied', name: 'Spojenec', min: 100, max: 100, color: '#ffd700', icon: '‚≠ê' }
        ];
        
        // === POƒåAS√ç SYST√âM ===
        const WEATHER_TYPES = [
            { id: 'sunny', name: 'Sluneƒçno', icon: '‚òÄÔ∏è', effect: { speedMod: 1.0, radMod: 1.0, moodMod: 1.1, playerDmgMod: 1.05, enemyDmgMod: 1.0 }, chance: 0.4, desc: 'Ide√°ln√≠ poƒças√≠. +5% damage' },
            { id: 'cloudy', name: 'Zata≈æeno', icon: '‚òÅÔ∏è', effect: { speedMod: 1.0, radMod: 0.8, moodMod: 1.0, playerDmgMod: 1.0, enemyDmgMod: 1.0 }, chance: 0.25, desc: 'Norm√°ln√≠ podm√≠nky' },
            { id: 'rain', name: 'D√©≈°≈•', icon: 'üåßÔ∏è', effect: { speedMod: 0.8, radMod: 0.5, moodMod: 0.9, playerDmgMod: 0.95, enemyDmgMod: 1.0 }, chance: 0.15, desc: '-20% rychlost, -5% damage' },
            { id: 'storm', name: 'Bou≈ôka', icon: '‚õàÔ∏è', effect: { speedMod: 0.6, radMod: 0.3, moodMod: 0.7, playerDmgMod: 0.9, enemyDmgMod: 1.0 }, chance: 0.08, desc: '-40% rychlost, -10% damage' },
            { id: 'fog', name: 'Mlha', icon: 'üå´Ô∏è', effect: { speedMod: 0.7, radMod: 1.0, moodMod: 0.85, playerDmgMod: 1.0, enemyDmgMod: 1.1 }, chance: 0.07, desc: 'Nep≈ô√°tel√© +10% damage' },
            { id: 'radstorm', name: 'Radiaƒçn√≠ bou≈ôe', icon: '‚ò¢Ô∏è', effect: { speedMod: 0.5, radMod: 3.0, moodMod: 0.5, playerDmgMod: 1.0, enemyDmgMod: 1.15 }, chance: 0.05, desc: '3x radiace! Nep≈ô√°tel√© +15% damage' }
        ];
        
        // === VOZIDLA ===
        // === KOMPANIONI ===
        const COMPANIONS = [
            // === QUESTOV√ç SPOLEƒåN√çCI ===
            { id: 'survivor', name: 'P≈ôe≈æiv≈°√≠', icon: 'üôè', hp: 80, damage: 12, defense: 8, 
              ability: 'P≈ôe≈æiv≈°√≠', abilityDesc: 'Osvobozen√Ω zajatec, vdƒõƒçn√Ω za z√°chranu', cost: 0, type: 'human' },
            
            // === ZV√ç≈òATA (z event≈Ø - zdarma) ===
            { id: 'dog', name: 'Vƒõrn√Ω pes', icon: 'üêï', hp: 40, damage: 8, defense: 3, 
              ability: 'ƒåmuch√°n√≠', abilityDesc: '+15% ≈°ance na vyhnut√≠ se boji', cost: 0, type: 'animal' },
            { id: 'cat', name: 'Mazan√° koƒçka', icon: 'üêà', hp: 25, damage: 5, defense: 2,
              ability: 'My≈°ilov', abilityDesc: '+10% ≈°ance na loot', cost: 0, type: 'animal' },
            { id: 'crow', name: 'Bystr√Ω havran', icon: 'ü¶Ö', hp: 20, damage: 4, defense: 1,
              ability: 'Pr≈Øzkum', abilityDesc: '+20% ≈°ance naj√≠t skryt√© vƒõci', cost: 0, type: 'animal' },
            
            // === LID√â (kupovateln√≠) ===
            { id: 'scout', name: 'Zvƒõd', icon: 'üèÉ', hp: 60, damage: 10, defense: 5, 
              ability: 'Rychl√Ω pr≈Øzkum', abilityDesc: '+3% rychlost cestov√°n√≠', cost: 800, type: 'human' },
            { id: 'medic_npc', name: 'Poln√≠ medik', icon: 'üë®‚Äç‚öïÔ∏è', hp: 45, damage: 5, defense: 3, 
              ability: 'L√©ƒçen√≠', abilityDesc: '+5 HP po ka≈æd√©m boji', cost: 1000, type: 'human' },
            { id: 'warrior', name: 'V√°leƒçn√≠k', icon: '‚öîÔ∏è', hp: 80, damage: 15, defense: 8, 
              ability: 'Bojovn√≠k', abilityDesc: '+20% damage v boji', cost: 1200, type: 'human' },
            { id: 'trader_npc', name: 'Obchodn√≠k', icon: 'üíº', hp: 35, damage: 5, defense: 2, 
              ability: 'Smlouv√°n√≠', abilityDesc: '+15% lep≈°√≠ ceny', cost: 600, type: 'human' },
            { id: 'engineer_npc', name: 'Technik', icon: 'üîß', hp: 50, damage: 7, defense: 4, 
              ability: 'Opravy', abilityDesc: 'Opravuje vybaven√≠ zdarma', cost: 900, type: 'human' }
        ];
        
        // === COMPANION SKILL TREES ===
        const COMPANION_SKILL_TREES = {
            // === PES ===
            dog: {
                name: 'Vƒõrn√Ω pes',
                icon: 'üêï',
                trees: {
                    combat: {
                        name: 'Bojovn√≠k',
                        icon: '‚öîÔ∏è',
                        color: '#c62828',
                        skills: [
                            { id: 'bite', name: 'Siln√Ω kousanec', icon: 'ü¶∑', desc: '+1 damage', effect: { damage: 1 }, tier: 1 },
                            { id: 'pack_hunter', name: 'Smeƒçkov√Ω lovec', icon: 'üê∫', desc: '+3% crit ≈°ance', effect: { critChance: 0.03 }, tier: 2, requires: 'bite' },
                            { id: 'savage', name: 'Divokost', icon: 'üí¢', desc: '+2 damage, -1 defense', effect: { damage: 2, defense: -1 }, tier: 3, requires: 'pack_hunter' }
                        ]
                    },
                    survival: {
                        name: 'P≈ôe≈æit√≠',
                        icon: 'üíö',
                        color: '#4caf50',
                        skills: [
                            { id: 'thick_fur', name: 'Hust√° srst', icon: 'ü¶ä', desc: '+5 HP', effect: { hp: 5 }, tier: 1 },
                            { id: 'scavenger_nose', name: 'ƒåmuch√°n√≠', icon: 'üëÉ', desc: '+5% ≈°ance na loot', effect: { lootChance: 0.05 }, tier: 2, requires: 'thick_fur' },
                            { id: 'loyal', name: 'Vƒõrnost', icon: '‚ù§Ô∏è', desc: '+1 HP regenerace po boji', effect: { regenAfterCombat: 1 }, tier: 3, requires: 'scavenger_nose' }
                        ]
                    },
                    utility: {
                        name: 'U≈æiteƒçnost',
                        icon: 'üîß',
                        color: '#ff9800',
                        skills: [
                            { id: 'guard', name: 'Hl√≠daƒç', icon: 'üëÅÔ∏è', desc: '-5% ≈°ance na p≈ôepaden√≠', effect: { ambushReduction: 0.05 }, tier: 1 },
                            { id: 'tracker', name: 'Stopa≈ô', icon: 'üêæ', desc: '+1% rychlost cestov√°n√≠', effect: { travelSpeed: 0.01 }, tier: 2, requires: 'guard' },
                            { id: 'fetch', name: 'Aport', icon: 'ü¶¥', desc: 'Mal√° ≈°ance naj√≠t loot po boji', effect: { fetchLoot: true }, tier: 3, requires: 'tracker' }
                        ]
                    }
                }
            },
            // === KOƒåKA ===
            cat: {
                name: 'Mazan√° koƒçka',
                icon: 'üêà',
                trees: {
                    stealth: {
                        name: 'Nen√°padnost',
                        icon: 'üë§',
                        color: '#9c27b0',
                        skills: [
                            { id: 'silent_paws', name: 'Tich√© tlapky', icon: 'üêæ', desc: '-3% ≈°ance na p≈ôepaden√≠', effect: { ambushReduction: 0.03 }, tier: 1 },
                            { id: 'shadow', name: 'St√≠n', icon: 'üåë', desc: '+5% √∫hyb v boji', effect: { dodgeChance: 0.05 }, tier: 2, requires: 'silent_paws' },
                            { id: 'assassin', name: 'Zabij√°k', icon: 'üó°Ô∏è', desc: '+10% crit damage', effect: { critDamage: 0.1 }, tier: 3, requires: 'shadow' }
                        ]
                    },
                    hunter: {
                        name: 'Lovec',
                        icon: 'üéØ',
                        color: '#ff5722',
                        skills: [
                            { id: 'mouser', name: 'My≈°ilov', icon: 'üê≠', desc: '+3% ≈°ance na loot', effect: { lootChance: 0.03 }, tier: 1 },
                            { id: 'predator', name: 'Pred√°tor', icon: 'üêÜ', desc: '+2 damage', effect: { damage: 2 }, tier: 2, requires: 'mouser' },
                            { id: 'nine_lives', name: 'Devƒõt ≈æivot≈Ø', icon: '‚ú®', desc: '5% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫tok', effect: { surviveChance: 0.05 }, tier: 3, requires: 'predator' }
                        ]
                    },
                    charm: {
                        name: '≈†arm',
                        icon: 'üíï',
                        color: '#e91e63',
                        skills: [
                            { id: 'cute', name: 'Roztomilost', icon: 'üòª', desc: '+3% lep≈°√≠ ceny', effect: { priceBonus: 0.03 }, tier: 1 },
                            { id: 'luck_cat', name: 'Koƒçiƒç√≠ ≈°tƒõst√≠', icon: 'üçÄ', desc: '+3% ≈°ance na vz√°cn√Ω loot', effect: { rareChance: 0.03 }, tier: 2, requires: 'cute' },
                            { id: 'blessing', name: 'Po≈æehn√°n√≠', icon: '‚≠ê', desc: '+2% XP bonus', effect: { xpBonus: 0.02 }, tier: 3, requires: 'luck_cat' }
                        ]
                    }
                }
            },
            // === HAVRAN ===
            crow: {
                name: 'Bystr√Ω havran',
                icon: 'ü¶Ö',
                trees: {
                    scout: {
                        name: 'Pr≈Øzkum',
                        icon: 'üî≠',
                        color: '#2196f3',
                        skills: [
                            { id: 'eagle_eye', name: 'Orl√≠ zrak', icon: 'üëÅÔ∏è', desc: '-3% ≈°ance na p≈ôepaden√≠', effect: { ambushReduction: 0.03 }, tier: 1 },
                            { id: 'warning', name: 'Varov√°n√≠', icon: '‚ö†Ô∏è', desc: 'Upozorn√≠ na nep≈ô√°tele p≈ôedem', effect: { enemyWarning: true }, tier: 2, requires: 'eagle_eye' },
                            { id: 'treasure_hunter', name: 'Lovec poklad≈Ø', icon: 'üíé', desc: '+5% ≈°ance naj√≠t skryt√© vƒõci', effect: { hiddenChance: 0.05 }, tier: 3, requires: 'warning' }
                        ]
                    },
                    trickster: {
                        name: '≈†ibal',
                        icon: 'üé≠',
                        color: '#673ab7',
                        skills: [
                            { id: 'distract', name: 'Rozpt√Ωlen√≠', icon: 'üí´', desc: 'Nep≈ô√≠tel m√° -3% p≈ôesnost', effect: { enemyAccuracy: -0.03 }, tier: 1 },
                            { id: 'steal', name: 'Kr√°de≈æ', icon: 'ü•∑', desc: '3% ≈°ance ukr√°st item v boji', effect: { stealChance: 0.03 }, tier: 2, requires: 'distract' },
                            { id: 'mimic', name: 'Napodoben√≠', icon: 'üó£Ô∏è', desc: 'M≈Ø≈æe zastra≈°it slab≈°√≠ nep≈ô√°tele', effect: { intimidate: true }, tier: 3, requires: 'steal' }
                        ]
                    },
                    wisdom: {
                        name: 'Moudrost',
                        icon: 'üìö',
                        color: '#009688',
                        skills: [
                            { id: 'memory', name: 'Pamƒõ≈•', icon: 'üß†', desc: '+3% XP z boj≈Ø', effect: { xpBonus: 0.03 }, tier: 1 },
                            { id: 'ancient', name: 'Starod√°vn√Ω', icon: 'üìú', desc: 'Odhal√≠ quest lokace', effect: { questReveal: true }, tier: 2, requires: 'memory' },
                            { id: 'oracle', name: 'Vƒõ≈°tec', icon: 'üîÆ', desc: 'P≈ôedpov√≠ poƒças√≠ a eventy', effect: { prediction: true }, tier: 3, requires: 'ancient' }
                        ]
                    }
                }
            },
            // === ZVƒöD ===
            scout: {
                name: 'Zvƒõd',
                icon: 'üèÉ',
                trees: {
                    speed: {
                        name: 'Rychlost',
                        icon: 'üí®',
                        color: '#00bcd4',
                        skills: [
                            { id: 'swift', name: 'Hbitost', icon: 'üèÉ', desc: '+1% rychlost cestov√°n√≠', effect: { travelSpeed: 0.01 }, tier: 1 },
                            { id: 'parkour', name: 'Parkour', icon: 'üßó', desc: 'Ignoruje ter√©nn√≠ postihy', effect: { ignoreTerrrain: true }, tier: 2, requires: 'swift' },
                            { id: 'flash', name: 'Blesk', icon: '‚ö°', desc: 'Prvn√≠ √∫tok v boji m√° +50% crit', effect: { firstStrikeCrit: true }, tier: 3, requires: 'parkour' }
                        ]
                    },
                    combat: {
                        name: 'Boj',
                        icon: '‚öîÔ∏è',
                        color: '#f44336',
                        skills: [
                            { id: 'dual_wield', name: 'Dvoj√≠ zbra≈à', icon: 'üó°Ô∏è', desc: '+2 damage', effect: { damage: 2 }, tier: 1 },
                            { id: 'precision', name: 'P≈ôesnost', icon: 'üéØ', desc: '+3% crit ≈°ance', effect: { critChance: 0.03 }, tier: 2, requires: 'dual_wield' },
                            { id: 'deadly', name: 'Smrt√≠c√≠', icon: 'üíÄ', desc: '+15% crit damage', effect: { critDamage: 0.15 }, tier: 3, requires: 'precision' }
                        ]
                    },
                    survival: {
                        name: 'P≈ôe≈æit√≠',
                        icon: 'üèïÔ∏è',
                        color: '#8bc34a',
                        skills: [
                            { id: 'endurance', name: 'V√Ωdr≈æ', icon: 'üí™', desc: '+8 HP', effect: { hp: 8 }, tier: 1 },
                            { id: 'resourceful', name: 'Vynal√©zavost', icon: 'üéí', desc: '+5% ≈°ance na dvojit√Ω loot', effect: { doubleLoot: 0.05 }, tier: 2, requires: 'endurance' },
                            { id: 'survivor', name: 'P≈ôe≈æiv≈°√≠', icon: 'üèÜ', desc: 'Regeneruje 3 HP po boji', effect: { regenAfterCombat: 3 }, tier: 3, requires: 'resourceful' }
                        ]
                    }
                }
            },
            // === MEDIK ===
            medic_npc: {
                name: 'Poln√≠ medik',
                icon: 'üë®‚Äç‚öïÔ∏è',
                trees: {
                    healing: {
                        name: 'L√©ƒçen√≠',
                        icon: 'üíö',
                        color: '#4caf50',
                        skills: [
                            { id: 'first_aid', name: 'Prvn√≠ pomoc', icon: 'ü©π', desc: '+3 HP hr√°ƒçi po boji', effect: { healPlayerAfterCombat: 3 }, tier: 1 },
                            { id: 'medic_expert', name: 'Expert', icon: 'üíâ', desc: '+15% efekt l√©ƒçiv√Ωch item≈Ø', effect: { healingBonus: 0.15 }, tier: 2, requires: 'first_aid' },
                            { id: 'resurrection', name: 'Vzk≈ô√≠≈°en√≠', icon: '‚ú®', desc: '5% ≈°ance p≈ôe≈æ√≠t smrt', effect: { resurrectChance: 0.05 }, tier: 3, requires: 'medic_expert' }
                        ]
                    },
                    support: {
                        name: 'Podpora',
                        icon: 'üõ°Ô∏è',
                        color: '#2196f3',
                        skills: [
                            { id: 'inspire', name: 'Inspirace', icon: 'üì¢', desc: '+1 damage v≈°em', effect: { partyDamage: 1 }, tier: 1 },
                            { id: 'protect', name: 'Ochrana', icon: 'üõ°Ô∏è', desc: '+1 defense hr√°ƒçi', effect: { playerDefense: 1 }, tier: 2, requires: 'inspire' },
                            { id: 'aura', name: 'L√©ƒçiv√° aura', icon: 'üí´', desc: '+1 HP/min regenerace', effect: { regenPerMin: 1 }, tier: 3, requires: 'protect' }
                        ]
                    },
                    alchemy: {
                        name: 'Alchymie',
                        icon: '‚öóÔ∏è',
                        color: '#9c27b0',
                        skills: [
                            { id: 'herbs', name: 'Bylink√°≈ô', icon: 'üåø', desc: '+1 herbs p≈ôi sbƒõru', effect: { herbBonus: 1 }, tier: 1 },
                            { id: 'antidote', name: 'Protijed', icon: 'üß™', desc: '-5% radiace po boji', effect: { radReduction: 0.05 }, tier: 2, requires: 'herbs' },
                            { id: 'elixir', name: 'Elix√≠ry', icon: 'üç∑', desc: 'M≈Ø≈æe vytvo≈ôit vz√°cn√© lektvary', effect: { rareRecipes: true }, tier: 3, requires: 'antidote' }
                        ]
                    }
                }
            },
            // === V√ÅLEƒåN√çK ===
            warrior: {
                name: 'V√°leƒçn√≠k',
                icon: '‚öîÔ∏è',
                trees: {
                    offense: {
                        name: '√ötok',
                        icon: '‚öîÔ∏è',
                        color: '#c62828',
                        skills: [
                            { id: 'power', name: 'S√≠la', icon: 'üí™', desc: '+3 damage', effect: { damage: 3 }, tier: 1 },
                            { id: 'cleave', name: 'Rozseknout', icon: 'ü™ì', desc: '√ötoƒç√≠ na 2 nep≈ô√°tele', effect: { multiTarget: 2 }, tier: 2, requires: 'power' },
                            { id: 'execute', name: 'Poprava', icon: 'üíÄ', desc: '+25% damage na nep≈ô√°tele pod 20% HP', effect: { executeBonus: 0.25 }, tier: 3, requires: 'cleave' }
                        ]
                    },
                    defense: {
                        name: 'Obrana',
                        icon: 'üõ°Ô∏è',
                        color: '#1976d2',
                        skills: [
                            { id: 'armor', name: 'Zbroj', icon: 'üõ°Ô∏è', desc: '+2 defense', effect: { defense: 2 }, tier: 1 },
                            { id: 'tank', name: 'Tank', icon: 'üè∞', desc: '+10 HP', effect: { hp: 10 }, tier: 2, requires: 'armor' },
                            { id: 'shield_wall', name: '≈†t√≠tov√° zeƒè', icon: 'üß±', desc: '10% ≈°ance blokovat √∫tok na hr√°ƒçe', effect: { blockForPlayer: 0.1 }, tier: 3, requires: 'tank' }
                        ]
                    },
                    rage: {
                        name: 'Zu≈ôivost',
                        icon: 'üí¢',
                        color: '#ff5722',
                        skills: [
                            { id: 'fury', name: 'Zu≈ôivost', icon: 'üò§', desc: '+5% damage p≈ôi n√≠zk√©m HP', effect: { lowHpDamage: 0.05 }, tier: 1 },
                            { id: 'berserk', name: 'Berserk', icon: 'üî•', desc: '+8% damage, -3% defense', effect: { damage: 0.08, defense: -0.03 }, tier: 2, requires: 'fury' },
                            { id: 'unstoppable', name: 'Nezastaviteln√Ω', icon: '‚ö°', desc: 'Nem≈Ø≈æe b√Ωt omr√°ƒçen', effect: { stunImmune: true }, tier: 3, requires: 'berserk' }
                        ]
                    }
                }
            },
            // === OBCHODN√çK ===
            trader_npc: {
                name: 'Obchodn√≠k',
                icon: 'üíº',
                trees: {
                    bargain: {
                        name: 'Smlouv√°n√≠',
                        icon: 'üí∞',
                        color: '#ffd700',
                        skills: [
                            { id: 'haggle', name: 'Smlouv√°n√≠', icon: 'üó£Ô∏è', desc: '-3% n√°kupn√≠ ceny', effect: { buyDiscount: 0.03 }, tier: 1 },
                            { id: 'sell_high', name: 'Prodat draze', icon: 'üìà', desc: '+5% prodejn√≠ ceny', effect: { sellBonus: 0.05 }, tier: 2, requires: 'haggle' },
                            { id: 'master_trader', name: 'Mistr obchodu', icon: 'üëë', desc: 'Speci√°ln√≠ zbo≈æ√≠ v obchodech', effect: { specialItems: true }, tier: 3, requires: 'sell_high' }
                        ]
                    },
                    connections: {
                        name: 'Kontakty',
                        icon: 'ü§ù',
                        color: '#9c27b0',
                        skills: [
                            { id: 'network', name: 'S√≠≈• kontakt≈Ø', icon: 'üì±', desc: '+5% ≈°ance na karavanu', effect: { caravanChance: 0.05 }, tier: 1 },
                            { id: 'reputation', name: 'Reputace', icon: '‚≠ê', desc: '+1 reputace se v≈°emi frakcemi', effect: { repBonus: 1 }, tier: 2, requires: 'network' },
                            { id: 'diplomat', name: 'Diplomat', icon: 'üïäÔ∏è', desc: 'M≈Ø≈æe usm√≠≈ôit nep≈ô√°telsk√© frakce', effect: { peacemaker: true }, tier: 3, requires: 'reputation' }
                        ]
                    },
                    appraisal: {
                        name: 'Odhad',
                        icon: 'üîç',
                        color: '#00bcd4',
                        skills: [
                            { id: 'identify', name: 'Identifikace', icon: 'üè∑Ô∏è', desc: 'Uk√°≈æe pravou hodnotu item≈Ø', effect: { showValue: true }, tier: 1 },
                            { id: 'treasure_sense', name: 'Smysl pro poklady', icon: 'üíé', desc: '+5% ≈°ance na vz√°cn√Ω loot', effect: { rareChance: 0.05 }, tier: 2, requires: 'identify' },
                            { id: 'golden_touch', name: 'Zlat√Ω dotyk', icon: '‚ú®', desc: '+8% penƒõz z lootu', effect: { moneyBonus: 0.08 }, tier: 3, requires: 'treasure_sense' }
                        ]
                    }
                }
            },
            // === TECHNIK ===
            engineer_npc: {
                name: 'Technik',
                icon: 'üîß',
                trees: {
                    repair: {
                        name: 'Opravy',
                        icon: 'üîß',
                        color: '#ff9800',
                        skills: [
                            { id: 'quick_fix', name: 'Rychl√° oprava', icon: 'üî©', desc: 'Oprav√≠ vybaven√≠ po boji', effect: { autoRepair: true }, tier: 1 },
                            { id: 'reinforce', name: 'Zpevnƒõn√≠', icon: 'üõ†Ô∏è', desc: '+5% trvanlivost vybaven√≠', effect: { durabilityBonus: 0.05 }, tier: 2, requires: 'quick_fix' },
                            { id: 'masterwork', name: 'Mistrovsk√° pr√°ce', icon: '‚≠ê', desc: 'M≈Ø≈æe vylep≈°it vybaven√≠', effect: { canUpgrade: true }, tier: 3, requires: 'reinforce' }
                        ]
                    },
                    crafting: {
                        name: 'V√Ωroba',
                        icon: 'üè≠',
                        color: '#795548',
                        skills: [
                            { id: 'efficient', name: 'Efektivita', icon: 'üì¶', desc: '-5% surovin na crafting', effect: { craftCostReduction: 0.05 }, tier: 1 },
                            { id: 'quality', name: 'Kvalita', icon: 'üíé', desc: '+5% stats vyroben√Ωm vƒõcem', effect: { craftBonus: 0.05 }, tier: 2, requires: 'efficient' },
                            { id: 'innovate', name: 'Inovace', icon: 'üí°', desc: 'Odemkne speci√°ln√≠ recepty', effect: { specialRecipes: true }, tier: 3, requires: 'quality' }
                        ]
                    },
                    gadgets: {
                        name: 'Gadgety',
                        icon: '‚öôÔ∏è',
                        color: '#607d8b',
                        skills: [
                            { id: 'trap', name: 'Bojov√© pasti', icon: 'ü™§', desc: 'Na zaƒç√°tku boje past automaticky zas√°hne nep≈ô√≠tele za 15-30 DMG', effect: { canTrap: true }, tier: 1 },
                            { id: 'turret', name: 'Vƒõ≈æiƒçka', icon: 'üî´', desc: 'Automaticky +5 DMG ka≈æd√© kolo boje', effect: { turretDamage: 5 }, tier: 2, requires: 'trap' },
                            { id: 'robot', name: 'Bojov√Ω robot', icon: 'ü§ñ', desc: 'Robot bojuje na tv√© stranƒõ (+20 DMG ka≈æd√© kolo, automaticky)', effect: { canBuildRobot: true }, tier: 3, requires: 'turret' }
                        ]
                    }
                }
            },
            // === GENERICK√ù SURVIVOR (pro dynamick√© companiony jako freed_slave) ===
            survivor: {
                name: 'P≈ôe≈æiv≈°√≠',
                icon: 'üôè',
                trees: {
                    combat: {
                        name: 'Boj',
                        icon: '‚öîÔ∏è',
                        color: '#c62828',
                        skills: [
                            { id: 'desperate_strike', name: 'Zoufal√Ω √∫der', icon: 'üí¢', desc: '+4 damage', effect: { damage: 4 }, tier: 1 },
                            { id: 'will_to_live', name: 'V≈Øle k ≈æivotu', icon: 'üí™', desc: '+20 HP', effect: { hp: 20 }, tier: 2, requires: 'desperate_strike' },
                            { id: 'revenge', name: 'Pomsta', icon: 'üî•', desc: '+25% damage kdy≈æ pod 50% HP', effect: { lowHpDamage: 0.25 }, tier: 3, requires: 'will_to_live' }
                        ]
                    },
                    survival: {
                        name: 'P≈ôe≈æit√≠',
                        icon: 'üèïÔ∏è',
                        color: '#4caf50',
                        skills: [
                            { id: 'scavenger', name: 'Sbƒõraƒç', icon: 'üéí', desc: '+15% ≈°ance na loot', effect: { lootChance: 0.15 }, tier: 1 },
                            { id: 'resourceful', name: 'Vynal√©zavost', icon: 'üîß', desc: '-20% spot≈ôeba j√≠dla/vody', effect: { consumptionReduction: 0.2 }, tier: 2, requires: 'scavenger' },
                            { id: 'hardened', name: 'Zocelen√Ω', icon: 'üõ°Ô∏è', desc: '+5 defense', effect: { defense: 5 }, tier: 3, requires: 'resourceful' }
                        ]
                    },
                    support: {
                        name: 'Podpora',
                        icon: 'ü§ù',
                        color: '#2196f3',
                        skills: [
                            { id: 'gratitude', name: 'Vdƒõƒçnost', icon: '‚ù§Ô∏è', desc: '+10 loajalita', effect: { loyalty: 10 }, tier: 1 },
                            { id: 'teamwork', name: 'T√Ωmov√° pr√°ce', icon: 'üë•', desc: '+2 damage v≈°em spoleƒçn√≠k≈Øm', effect: { partyDamage: 2 }, tier: 2, requires: 'gratitude' },
                            { id: 'guardian', name: 'Str√°≈æce', icon: 'üõ°Ô∏è', desc: '20% ≈°ance zablokovat √∫tok na hr√°ƒçe', effect: { blockForPlayer: 0.2 }, tier: 3, requires: 'teamwork' }
                        ]
                    }
                }
            }
        };
        
        // XP pot≈ôebn√© pro level spoleƒçn√≠ka
        const COMPANION_XP_TABLE = [0, 50, 120, 220, 350, 520, 730, 980, 1280, 1630]; // Level 1-10
        
        // Max poƒçet spoleƒçn√≠k≈Ø podle levelu hr√°ƒçe
        function getMaxCompanions() {
            const level = state.char?.level || 1;
            if (level >= 10) return 5;
            if (level >= 7) return 4;
            if (level >= 5) return 3;
            if (level >= 3) return 2;
            return 1;
        }
        
        // P≈ôid√° spoleƒçn√≠ka s mo≈ænost√≠ v√Ωmƒõny pokud je plno
        function addCompanionWithSwap(newCompanion, source = 'event') {
            state.companions = state.companions || [];
            
            if (state.companions.length < getMaxCompanions()) {
                // M√≠sto je voln√© - rovnou p≈ôidej
                state.companions.push(newCompanion);
                notifySuccess('Nov√Ω spoleƒçn√≠k!', `${newCompanion.name} se p≈ôidal k tobƒõ!`);
                addLog(`${newCompanion.icon || 'üë§'} ${newCompanion.name} se p≈ôipojil!`, newCompanion.icon || 'üë§');
                saveGame();
                renderFull();
                return true;
            }
            
            // Plno - nab√≠dni v√Ωmƒõnu
            showCompanionSwapModal(newCompanion, source);
            return false;
        }
        
        function showCompanionSwapModal(newCompanion, source) {
            const newIcon = newCompanion.icon || 'üë§';
            const newName = newCompanion.name || 'Nov√Ω spoleƒçn√≠k';
            
            let companionsHtml = state.companions.map(comp => {
                const compIcon = comp.icon || COMPANIONS.find(c => c.id === comp.id)?.icon || 'üë§';
                const compName = comp.name || COMPANIONS.find(c => c.id === comp.id)?.name || 'Spoleƒçn√≠k';
                const level = comp.level || 1;
                const compUniqueId = comp.uniqueId || comp.id;
                
                return `
                    <div onclick="swapCompanion('${compUniqueId}')" 
                         style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border: 2px solid #444; transition: all 0.2s;"
                         onmouseover="this.style.borderColor='#c62828'; this.style.background='#3a2a2a';"
                         onmouseout="this.style.borderColor='#444'; this.style.background='#2a2a2a';">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <div style="font-size: 2rem;">${compIcon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${compName}</div>
                                <div style="font-size: 0.8rem; color: #888;">
                                    Level ${level} | ‚ù§Ô∏è ${comp.hp}/${comp.maxHp} | ‚öîÔ∏è ${getCompanionStat(comp, 'damage')} | üõ°Ô∏è ${getCompanionStat(comp, 'defense')}
                                </div>
                            </div>
                            <div style="color: #c62828; font-size: 0.8rem;">üëã Propustit</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ulo≈æ nov√©ho spoleƒçn√≠ka pro swap
            window.pendingNewCompanion = newCompanion;
            
            showModal('üë• V√Ωmƒõna spoleƒçn√≠ka', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${newIcon}</div>
                    <h3 style="margin: 0.5rem 0; color: #4caf50;">${newName}</h3>
                    <p style="color: #888;">chce se k tobƒõ p≈ôipojit!</p>
                    <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0; font-size: 0.85rem;">
                        ‚ù§Ô∏è ${newCompanion.hp || newCompanion.maxHp} HP | ‚öîÔ∏è ${newCompanion.damage} DMG | üõ°Ô∏è ${newCompanion.defense} DEF
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c62828;">
                    <p style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 0.9rem;">‚ö†Ô∏è M√°≈° u≈æ maximum spoleƒçn√≠k≈Ø (${getMaxCompanions()})!</p>
                    <p style="color: #888; margin: 0; font-size: 0.85rem;">Vyber koho propust√≠≈°, aby se ${newName} mohl p≈ôidat:</p>
                </div>
                
                <div style="max-height: 40vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${companionsHtml}
                </div>
                
                <button class="btn" onclick="cancelCompanionSwap()" style="width: 100%; margin-top: 1rem; background: #555;">
                    ‚ùå Odm√≠tnout ${newName}
                </button>
            `);
        }
        
        function swapCompanion(oldCompanionId) {
            const newCompanion = window.pendingNewCompanion;
            if (!newCompanion) {
                closeModal();
                return;
            }
            
            // Pokud je to placen√Ω swap (z hire), odeƒçti pen√≠ze
            if (window.pendingHireCompanion && window.pendingHireCompanion.companion === newCompanion) {
                removeMoney(window.pendingHireCompanion.cost);
                window.pendingHireCompanion = null;
            }
            
            // Najdi a odeber star√©ho spoleƒçn√≠ka - hledej podle id nebo uniqueId
            const oldIndex = state.companions.findIndex(c => c.id === oldCompanionId || c.uniqueId === oldCompanionId);
            if (oldIndex === -1) {
                closeModal();
                return;
            }
            
            const oldCompanion = state.companions[oldIndex];
            const oldIcon = oldCompanion.icon || COMPANIONS.find(c => c.id === oldCompanion.id)?.icon || 'üë§';
            const oldName = oldCompanion.name || COMPANIONS.find(c => c.id === oldCompanion.id)?.name || 'Spoleƒçn√≠k';
            
            // Vra≈• vybaven√≠ star√©ho spoleƒçn√≠ka do invent√°≈ôe
            if (oldCompanion.equipped) {
                Object.values(oldCompanion.equipped).forEach(item => {
                    if (item) {
                        const existing = state.inv.find(i => i.id === item.id);
                        if (existing) {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            state.inv.push({...item, count: 1});
                        }
                    }
                });
            }
            
            // Odeber star√©ho
            state.companions.splice(oldIndex, 1);
            addLog(`${oldIcon} ${oldName} ode≈°el`, 'üëã');
            
            // P≈ôidej nov√©ho s unik√°tn√≠m ID
            newCompanion.uniqueId = newCompanion.uniqueId || `${newCompanion.id}_${Date.now()}`;
            state.companions.push(newCompanion);
            const newIcon = newCompanion.icon || 'üë§';
            const newName = newCompanion.name || 'Spoleƒçn√≠k';
            
            notifySuccess('V√Ωmƒõna!', `${oldName} ode≈°el, ${newName} se p≈ôidal!`);
            addLog(`${newIcon} ${newName} se p≈ôipojil!`, newIcon);
            
            window.pendingNewCompanion = null;
            closeModal();
            saveGame();
            renderFull();
        }
        
        function cancelCompanionSwap() {
            // Pokud je to placen√Ω swap, neodeƒç√≠tej pen√≠ze
            window.pendingHireCompanion = null;
            const newCompanion = window.pendingNewCompanion;
            if (newCompanion) {
                const newName = newCompanion.name || 'Spoleƒçn√≠k';
                notifyWarning('Odm√≠tnuto', `${newName} ode≈°el.`);
                addLog(`Odm√≠tnut: ${newName}`, 'üëã');
            }
            window.pendingNewCompanion = null;
            closeModal();
        }
        
        // === SPECI√ÅLN√ç SCHOPNOSTI POVOL√ÅN√ç ===
        const CLASS_ABILITIES = {
            scavenger: { name: 'Bystr√Ω zrak', icon: 'üëÅÔ∏è', cooldown: 300, desc: 'Odhal√≠ v≈°echen loot na aktu√°ln√≠m hexu', action: 'revealLoot' },
            raider: { name: 'Zu≈ôivost', icon: 'üí¢', cooldown: 180, desc: '+50% damage na 1 boj', action: 'rage' },
            berserker: { name: 'Krvav√° l√°ze≈à', icon: 'ü©∏', cooldown: 240, desc: 'P≈ô√≠≈°t√≠ √∫tok zas√°hne v≈°echny nep≈ô√°tele', action: 'bloodbath' },
            medic: { name: 'Rychl√© l√©ƒçen√≠', icon: 'üíâ', cooldown: 240, desc: 'Okam≈æitƒõ +40 HP', action: 'quickHeal' },
            engineer: { name: 'Nouzov√° oprava', icon: 'üîß', cooldown: 300, desc: 'Oprav√≠ vybaven√≠ o 30%', action: 'emergencyRepair' },
            stalker: { name: 'Neviditelnost', icon: 'üë§', cooldown: 360, desc: 'Vyhne≈° se dal≈°√≠mu nep≈ô√≠teli', action: 'stealth' },
            survivor: { name: 'Druh√Ω dech', icon: 'üí®', cooldown: 600, desc: 'Obnov√≠ 50% HP kdy≈æ pod 20%', action: 'secondWind' },
            trader: { name: 'Zlat√Ω jazyk', icon: 'üó£Ô∏è', cooldown: 180, desc: '-30% ceny na 5 minut', action: 'haggle' },
            assassin: { name: 'Smrt√≠c√≠ √∫der', icon: 'üó°Ô∏è', cooldown: 300, desc: 'Garantovan√Ω kritick√Ω z√°sah', action: 'deathStrike' },
            tank: { name: '≈Ωelezn√° k≈Ø≈æe', icon: 'üõ°Ô∏è', cooldown: 240, desc: 'Blokuje 100% damage na 1 kolo', action: 'ironSkin' },
            alchemist: { name: 'Jedovat√Ω oblak', icon: '‚ò†Ô∏è', cooldown: 300, desc: 'Otr√°v√≠≈° v≈°echny nep≈ô√°tele na 3 kola', action: 'poisonCloud' },
            hunter: { name: 'Stopov√°n√≠', icon: 'üêæ', cooldown: 180, desc: 'Najde nejbli≈æ≈°√≠ zv√≠≈ôe na mapƒõ', action: 'track' },
            demolitionist: { name: 'Mega bomba', icon: 'üí£', cooldown: 360, desc: '100 damage v≈°em nep≈ô√°tel≈Øm', action: 'megaBomb' },
            nomad: { name: 'Pou≈°tn√≠ v√≠tr', icon: 'üèúÔ∏è', cooldown: 120, desc: 'Okam≈æitƒõ dokonƒç√≠ cestov√°n√≠', action: 'desertWind' },
            mutant: { name: 'Radiaƒçn√≠ v√Ωbuch', icon: '‚ò¢Ô∏è', cooldown: 300, desc: '50 damage + radiace nep≈ô√°tel≈Øm', action: 'radBurst' },
            psychic: { name: 'Ment√°ln√≠ √∫tok', icon: 'üîÆ', cooldown: 240, desc: 'Nep≈ô√≠tel p≈ôeskoƒç√≠ tah', action: 'mindBlast' }
        };
        
        // === ALCHYMIE/VA≈òEN√ç ===
        const RECIPES = [
            // Va≈ôen√≠
            { id: 'cooked_meat', name: 'Peƒçen√© maso', icon: 'üçñ', type: 'cooking', requires: { raw_meat: 1 }, result: { effect: 'hunger', value: 50 }, desc: 'V√Ω≈æivnƒõj≈°√≠ ne≈æ syrov√©' },
            { id: 'grilled_fish', name: 'Grilovan√° ryba', icon: 'üêü', type: 'cooking', requires: { fish: 1 }, result: { effect: 'hunger', value: 45, bonus: 'thirst', bonusValue: 10 }, desc: 'Lehk√© j√≠dlo' },
            { id: 'steak', name: 'Steak', icon: 'ü•©', type: 'cooking', requires: { raw_meat: 2 }, result: { effect: 'hunger', value: 60, bonus: 'hp', bonusValue: 20 }, desc: 'Po≈ô√°dn√© j√≠dlo' },
            { id: 'stew', name: 'Gul√°≈°', icon: 'üç≤', type: 'cooking', requires: { raw_meat: 4, herbs: 2 }, result: { effect: 'hunger', value: 100, bonus: 'hp', bonusValue: 65 }, desc: 'Nejlep≈°√≠ j√≠dlo!' },
            { id: 'fish_soup', name: 'Ryb√≠ pol√©vka', icon: 'üçú', type: 'cooking', requires: { fish: 2 }, result: { effect: 'hunger', value: 60, bonus: 'thirst', bonusValue: 40 }, desc: 'Zah≈ôeje a nasyt√≠' },
            { id: 'jerky', name: 'Su≈°en√© maso', icon: 'ü•ì', type: 'cooking', requires: { raw_meat: 2 }, result: { effect: 'hunger', value: 55, stackable: true }, desc: 'Vydr≈æ√≠ dlouho' },
            
            // Lektvary
            { id: 'health_potion', name: 'L√©ƒçiv√Ω lektvar', icon: '‚ù§Ô∏è', type: 'alchemy', requires: { herbs: 2 }, result: { effect: 'health', value: 50 }, desc: 'Rychl√© l√©ƒçen√≠' },
            { id: 'energy_potion', name: 'Energetick√Ω lektvar', icon: '‚ö°', type: 'alchemy', requires: { herbs: 1 }, result: { effect: 'energy', value: 70 }, desc: 'Obnov√≠ energii' },
            { id: 'antidote', name: 'Protijed', icon: 'üß™', type: 'alchemy', requires: { herbs: 3 }, result: { effect: 'radiation', value: -40 }, desc: 'Siln√Ω anti-rad' },
            { id: 'strength_elixir', name: 'Elix√≠r s√≠ly', icon: 'üí™', type: 'alchemy', requires: { herbs: 2, raw_meat: 1 }, result: { effect: 'buff', buff: 'strength', value: 3, duration: 300 }, desc: '+3 s√≠la na 5 min' },
            { id: 'speed_elixir', name: 'Elix√≠r rychlosti', icon: 'üèÉ', type: 'alchemy', requires: { herbs: 2 }, result: { effect: 'buff', buff: 'agility', value: 3, duration: 300 }, desc: '+3 obratnost na 5 min' },
            { id: 'luck_potion', name: 'Lektvar ≈°tƒõst√≠', icon: 'üçÄ', type: 'alchemy', requires: { herbs: 3 }, result: { effect: 'buff', buff: 'luck', value: 20, duration: 600 }, desc: '+20% loot na 10 min' }
        ];
        
        // === RYBY ===
        const FISH_TYPES = [
            { id: 'small_fish', name: 'Mal√° ryba', icon: 'üêü', rarity: 'common', chance: 0.5, value: 10, hunger: 15 },
            { id: 'medium_fish', name: 'Kapr', icon: 'üê†', rarity: 'uncommon', chance: 0.3, value: 25, hunger: 30 },
            { id: 'big_fish', name: 'Sumec', icon: 'üê°', rarity: 'rare', chance: 0.15, value: 50, hunger: 50 },
            { id: 'golden_fish', name: 'Zlat√° rybka', icon: '‚ú®', rarity: 'epic', chance: 0.04, value: 200, hunger: 20, special: 'wish' },
            { id: 'mutant_fish', name: 'Mutantn√≠ ryba', icon: '‚ò¢Ô∏è', rarity: 'rare', chance: 0.08, value: 30, hunger: 40, radiation: 5 },
            { id: 'boot', name: 'Star√° bota', icon: 'üë¢', rarity: 'common', chance: 0.2, value: 0, junk: true },
            { id: 'treasure_chest', name: 'Truhliƒçka', icon: 'üì¶', rarity: 'epic', chance: 0.02, value: 0, special: 'treasure' }
        ];
        
        // === RUDY A DRAHOKAMY ===
        const ORES = [
            { id: 'iron_ore', name: '≈Ωelezn√° ruda', icon: '‚öôÔ∏è', rarity: 'common', chance: 0.40, value: 15, smeltTo: 'metal' },
            { id: 'stone_chunk', name: 'K√°men', icon: 'ü™®', rarity: 'common', chance: 0.30, value: 10, smeltTo: 'stone' },
            { id: 'coal', name: 'Uhl√≠', icon: '‚¨õ', rarity: 'uncommon', chance: 0.12, value: 20, smeltTo: 'fuel' },
            { id: 'scrap_metal', name: 'Star√Ω ≈°rot', icon: '‚ôªÔ∏è', rarity: 'uncommon', chance: 0.08, value: 15, smeltTo: 'scrap' },
            { id: 'sulfur', name: 'S√≠ra', icon: 'üíõ', rarity: 'rare', chance: 0.05, value: 40, smeltTo: 'chemicals' },
            { id: 'quartz', name: 'K≈ôemen', icon: 'üíé', rarity: 'rare', chance: 0.03, value: 50, smeltTo: 'glass' },
            { id: 'uranium_ore', name: 'Uranov√° ruda', icon: '‚ò¢Ô∏è', rarity: 'epic', chance: 0.02, value: 200, smeltTo: 'chemicals', radiation: 15 }
        ];
        
        // === ZVƒö≈ò PRO LOV ===
        const HUNTABLE_ANIMALS = [
            { id: 'rabbit', name: 'Kr√°l√≠k', icon: 'üê∞', hp: 10, speed: 8, loot: { meat: 1, cloth: 1 }, xp: 5 },
            { id: 'deer', name: 'Jelen', icon: 'ü¶å', hp: 30, speed: 7, loot: { meat: 3, leather: 2 }, xp: 15 },
            { id: 'boar', name: 'Divoƒç√°k', icon: 'üêó', hp: 50, speed: 5, loot: { meat: 4, leather: 2 }, xp: 25, aggressive: true },
            { id: 'bear', name: 'Medvƒõd', icon: 'üêª', hp: 100, speed: 4, loot: { meat: 6, leather: 4, fur: 3 }, xp: 50, aggressive: true },
            { id: 'wolf_pack', name: 'Smeƒçka vlk≈Ø', icon: 'üê∫', hp: 80, speed: 6, loot: { meat: 3, leather: 2, fur: 2 }, xp: 40, aggressive: true, count: 3 },
            { id: 'mutant_beast', name: 'Mutantn√≠ bestie', icon: 'üëæ', hp: 150, speed: 5, loot: { meat: 5, leather: 3, radx: 1 }, xp: 80, aggressive: true, radiation: 10 }
        ];
        
        // === MUTACE ===
        const MUTATIONS = [
            // Sm√≠≈°en√© mutace (v√Ωhoda + nev√Ωhoda)
            { id: 'thick_skin', name: 'Tlust√° k≈Ø≈æe', icon: 'ü¶é', type: 'mixed', 
              effect: { defense: 8, agi: -1 }, 
              desc: '+8 obrany, -1 obratnost', chance: 0.15,
              positive: 'Tv√° k≈Ø≈æe je tvrd≈°√≠ jako krun√Ω≈ô',
              negative: 'Jsi pomalej≈°√≠' },
              
            { id: 'eagle_eyes', name: 'Orl√≠ zrak', icon: 'ü¶Ö', type: 'mixed', 
              effect: { perception: 3, nightPenalty: true }, 
              desc: '+3 vn√≠mavost, -30% vidƒõn√≠ v noci', chance: 0.12,
              positive: 'Vid√≠≈° d√°l a ost≈ôeji',
              negative: 'V noci jsi t√©mƒõ≈ô slep√Ω' },
              
            { id: 'fast_metabolism', name: 'Rychl√Ω metabolismus', icon: '‚ö°', type: 'mixed', 
              effect: { travelSpeed: 0.1, hungerRate: 1.5, energyDrain: 1.3 }, 
              desc: '-10% ƒças cestov√°n√≠, +50% hlad, +30% √∫bytek energie', chance: 0.10,
              positive: 'Cestuje≈° mnohem rychleji',
              negative: 'Pot≈ôebuje≈° v√≠ce j√≠dla a energie' },
              
            { id: 'night_vision', name: 'Noƒçn√≠ vidƒõn√≠', icon: 'üëÅÔ∏è', type: 'mixed', 
              effect: { nightBonus: 0.3, dayPenalty: 0.15 }, 
              desc: '+30% stats v noci, -15% ve dne', chance: 0.08,
              positive: 'V noci vid√≠≈° jako ve dne',
              negative: 'Denn√≠ svƒõtlo tƒõ osl≈àuje' },
              
            { id: 'rad_immunity', name: 'Radiaƒçn√≠ adaptace', icon: '‚ò¢Ô∏è', type: 'mixed', 
              effect: { radResist: 0.7, appearance: 'ghoul' }, 
              desc: '-70% radiace, vypad√°≈° jako ghoul', chance: 0.05,
              positive: 'Radiace ti t√©mƒõ≈ô neubli≈æuje',
              negative: 'Lid√© se tƒõ boj√≠ (-20% ceny u obchodn√≠k≈Ø)' },
              
            { id: 'berserker_blood', name: 'Berserk≈ô√≠ krev', icon: 'üî¥', type: 'mixed', 
              effect: { damageBonus: 0.25, damageTaken: 0.15 }, 
              desc: '+25% damage, +15% p≈ôijat√© damage', chance: 0.10,
              positive: 'Zasahuje≈° silnƒõji',
              negative: 'Sn√°ze se zran√≠≈°' },
              
            { id: 'iron_bones', name: '≈Ωelezn√© kosti', icon: 'ü¶¥', type: 'mixed', 
              effect: { maxHp: 30, speed: -0.2 }, 
              desc: '+30 max HP, -20% rychlost cestov√°n√≠', chance: 0.12,
              positive: 'Jsi odolnƒõj≈°√≠',
              negative: 'Tv√© tƒõ≈æk√© kosti tƒõ zpomaluj√≠' },
              
            { id: 'sixth_sense', name: '≈†est√Ω smysl', icon: 'üîÆ', type: 'mixed', 
              effect: { dodgeChance: 0.15, paranoia: true }, 
              desc: '+15% √∫hyb, ƒçastƒõj≈°√≠ n√°hodn√© boje', chance: 0.08,
              positive: 'C√≠t√≠≈° nebezpeƒç√≠ d≈ô√≠v',
              negative: 'Jsi paranoidn√≠ a p≈ôitahuje≈° probl√©my' },
              
            { id: 'regenerator', name: 'Regener√°tor', icon: 'üíö', type: 'mixed', 
              effect: { healRate: 5, energyDrain: 1.3 }, 
              desc: '+5 HP/min, +30% √∫bytek energie', chance: 0.07,
              positive: 'Regeneruje≈° se neuvƒõ≈ôitelnƒõ rychle',
              negative: 'Regenerace tƒõ vyƒçerp√°v√°' },
              
            { id: 'mutant_strength', name: 'Mutant√≠ s√≠la', icon: 'üí™', type: 'mixed', 
              effect: { str: 3, int: -2 }, 
              desc: '+3 s√≠la, -2 inteligence', chance: 0.10,
              positive: 'Jsi silnƒõj≈°√≠ ne≈æ d≈ô√≠v',
              negative: 'My≈°len√≠ je tƒõ≈æ≈°√≠' }
        ];
        
        // === DEN/NOC ===
        const DAY_PHASES = [
            { id: 'dawn', name: '√ösvit', icon: 'üåÖ', hours: [5, 6, 7], moodBonus: 5, enemyMod: 0.8 },
            { id: 'day', name: 'Den', icon: '‚òÄÔ∏è', hours: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17], moodBonus: 10, enemyMod: 1.0 },
            { id: 'dusk', name: 'Soumrak', icon: 'üåÜ', hours: [18, 19, 20], moodBonus: 0, enemyMod: 1.2 },
            { id: 'night', name: 'Noc', icon: 'üåô', hours: [21, 22, 23, 0, 1, 2, 3, 4], moodBonus: -10, enemyMod: 1.5, visibility: 0.5 }
        ];
        
        // === HORDA M√ìD ===
        const HORDE_WAVES = [
            { wave: 1, enemies: ['mutant_rat', 'mutant_rat', 'wild_dog'], reward: 100 },
            { wave: 2, enemies: ['zombie', 'zombie', 'wild_dog', 'wild_dog'], reward: 150 },
            { wave: 3, enemies: ['raider', 'raider', 'zombie', 'zombie'], reward: 200 },
            { wave: 4, enemies: ['mutant', 'bandit', 'raider', 'zombie'], reward: 300 },
            { wave: 5, enemies: ['giant_mutant', 'raider_boss'], reward: 500, boss: true }
        ];
        
        // === ENCHANTMENTY ===
        const ENCHANTMENTS = [
            { id: 'fire', name: 'Ohe≈à', icon: 'üî•', type: 'weapon', effect: { bonusDamage: 5, element: 'fire' }, desc: '+5 ohniv√©ho po≈°kozen√≠' },
            { id: 'ice', name: 'Led', icon: '‚ùÑÔ∏è', type: 'weapon', effect: { bonusDamage: 3, slow: 20 }, desc: '+3 damage, -20% rychlost nep≈ô√≠tele' },
            { id: 'poison', name: 'Jed', icon: 'üß™', type: 'weapon', effect: { dot: 3, duration: 3 }, desc: '3 damage/kolo po 3 kola' },
            { id: 'lifesteal', name: 'Vys√°v√°n√≠ ≈æivota', icon: 'üßõ', type: 'weapon', effect: { lifesteal: 0.1 }, desc: '10% damage se vr√°t√≠ jako HP' },
            { id: 'critical', name: 'Kritick√Ω √∫der', icon: 'üí•', type: 'weapon', effect: { critChance: 0.15, critDamage: 2 }, desc: '+15% ≈°ance na 2x damage' },
            { id: 'fortify', name: 'Zpevnƒõn√≠', icon: 'üõ°Ô∏è', type: 'armor', effect: { bonusDefense: 5 }, desc: '+5 obrany' },
            { id: 'regeneration', name: 'Regenerace', icon: 'üíö', type: 'armor', effect: { regenHp: 1 }, desc: '+1 HP/min' },
            { id: 'rad_shield', name: 'Radiaƒçn√≠ ≈°t√≠t', icon: '‚ò¢Ô∏è', type: 'armor', effect: { radResist: 0.3 }, desc: '-30% radiace' }
        ];
        
        // === R√ÅDIO ZPR√ÅVY ===
        const RADIO_MESSAGES = [
            { id: 'sos', type: 'quest', message: 'SOS! P≈ôe≈æiv≈°√≠ pot≈ôebuje pomoc na pozici...', questType: 'rescue' },
            { id: 'trader', type: 'event', message: 'Karavana m√≠≈ô√≠ do oblasti...', eventType: 'caravan' },
            { id: 'warning', type: 'danger', message: 'VAROV√ÅN√ç: Horda mutant≈Ø se bl√≠≈æ√≠!', eventType: 'horde' },
            { id: 'treasure', type: 'quest', message: 'Sly≈°el jsem o skryt√©m skladu na...', questType: 'treasure' },
            { id: 'weather', type: 'info', message: 'P≈ôedpovƒõƒè: Oƒçek√°v√° se radiaƒçn√≠ bou≈ôe...', eventType: 'weather' }
        ];
        
        // === HLAVN√ç P≈ò√çBƒöH ===
        // STORY_NPCS jsou definov√°ni n√≠≈æe s nov√Ωm p≈ô√≠bƒõhem
        
        // P≈ôeklady hlavn√≠ch quest≈Ø
        function getMainQuestTitle(questId) {
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            return quest?.title || questId;
        }
        
        function getMainQuestDesc(questId) {
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            return quest?.description || '';
        }
        
        const MAIN_QUESTS = [
            // === KAPITOLA 0: PROBUZEN√ç ===
            {
                id: 'intro',
                chapter: 0,
                title: 'Probuzen√≠',
                description: 'Probuƒè se a zjisti co se stalo',
                objectives: [
                    { id: 'wake_up', text: 'Prozkoumej okol√≠ (nav≈°tiv 3 lokace)', type: 'visit_locations', target: 3, progress: 0 }
                ],
                reward: { xp: 50, money: 0 },
                nextQuest: 'find_stranger',
                dialog: {
                    start: "Hlava tƒõ bol√≠... Co se stalo? Kde to jsi? Svƒõt kolem je v trosk√°ch. Mus√≠≈° prozkoumat okol√≠.",
                    complete: "Zaƒç√≠n√°≈° si vzpom√≠nat. Byla tu exploze... Projekt Genesis... a pak tma. Mus√≠≈° naj√≠t nƒõkoho, kdo v√≠ v√≠c."
                }
            },
            {
                id: 'find_stranger',
                chapter: 0,
                title: 'Z√°hadn√Ω cizinec',
                description: 'Najdi z√°hadn√©ho cizince v opu≈°tƒõn√©m domƒõ',
                objectives: [
                    { id: 'go_to_stranger', text: 'Jdi do Opu≈°tƒõn√©ho domu', type: 'location', target: 'abandoned_house', progress: 0 }
                ],
                reward: { xp: 100, money: 50 },
                nextQuest: 'choose_brother',
                npc: 'mysterious_stranger',
                dialog: {
                    start: "V opu≈°tƒõn√©m domƒõ potk√°≈° star√©ho mu≈æe...",
                    complete: "\"Dva brat≈ôi,\" ≈°ept√° sta≈ôec. \"Kory a Koudy. Oba hledaj√≠ tot√©≈æ - Projekt Genesis. Jeden chce svƒõt zachr√°nit, druh√Ω zniƒçit. Ale kter√Ω je kter√Ω?\" D√° ti sou≈ôadnice k obƒõma. Vyber si, za k√Ωm p≈Øjde≈° prvn√≠."
                }
            },
            {
                id: 'choose_brother',
                chapter: 1,
                title: 'Vyber si stranu',
                description: 'Rozhodni se, za kter√Ωm bratrem p≈Øjde≈°',
                objectives: [
                    { id: 'choose_path', text: 'Jdi za Korym (Trading Post) NEBO Koudym (Research Facility)', type: 'choice', targets: ['trading_post', 'research_facility'], progress: 0 }
                ],
                reward: { xp: 50 },
                isChoice: true,
                choiceEffects: {
                    trading_post: { nextQuest: 'meet_kory', dialog: "Rozhodl ses nav≈°t√≠vit Koryho v Trading Postu." },
                    research_facility: { nextQuest: 'meet_koudy', dialog: "Rozhodl ses nav≈°t√≠vit Koudyho v Research Facility." }
                },
                dialog: {
                    start: "M√°≈° sou≈ôadnice k obƒõma bratr≈Øm. Koho nav≈°t√≠v√≠≈° prvn√≠?",
                    complete: "Vybral sis svou cestu..."
                }
            },
            
            // === KAPITOLA 1: PRVN√ç KONTAKT ===
            {
                id: 'meet_kory',
                chapter: 1,
                title: 'Setk√°n√≠ s Korym',
                description: 'Najdi Koryho v Trading Postu',
                objectives: [
                    { id: 'go_to_kory', text: 'Jdi do Trading Post', type: 'location', target: 'trading_post', progress: 0 }
                ],
                reward: { xp: 100, money: 100, karma: { kory: 5 } },
                nextQuest: 'first_component',
                npc: 'kory',
                dialog: {
                    start: "Hled√°≈° Koryho - charismatick√©ho mu≈æe, kter√Ω pr√Ω v√≠ o Projektu Genesis.",
                    complete: "Kory je elegantn√≠ mu≈æ s pronikav√Ωma oƒçima. \"Ach, nov√Ω p≈ôe≈æiv≈°√≠! Sly≈°el jsem o tobƒõ. V√≠≈°, tento svƒõt je zka≈æen√Ω. Projekt Genesis ho m≈Ø≈æe OƒåISTIT a vytvo≈ôit nƒõco lep≈°√≠ho. Prvn√≠ komponent - Plutoniov√© j√°dro - je ve Vojensk√© z√°kladnƒõ. P≈ôines mi ho a j√° tƒõ vezmu s sebou do nov√©ho svƒõta.\""
                }
            },
            {
                id: 'meet_koudy',
                chapter: 1,
                title: 'Setk√°n√≠ s Koudym',
                description: 'Najdi Koudyho v Research Facility',
                objectives: [
                    { id: 'go_to_koudy', text: 'Jdi do Research Facility', type: 'location', target: 'research_facility', progress: 0 }
                ],
                reward: { xp: 100, money: 100, karma: { koudy: 5 } },
                nextQuest: 'first_component',
                npc: 'koudy',
                dialog: {
                    start: "Koudyho najde≈° v opu≈°tƒõn√© laborato≈ôi, obklopen√©ho p≈ô√≠stroji.",
                    complete: "Koudy je unaven√Ω mu≈æ s laskav√Ωma oƒçima. \"M≈Øj bratr Kory... je nebezpeƒçn√Ω. Vƒõ≈ô√≠, ≈æe svƒõt je t≈ôeba zniƒçit a zaƒç√≠t znovu. Ale Projekt Genesis m≈Ø≈æe b√Ωt pou≈æit k OBNOVƒö - k vyƒçi≈°tƒõn√≠ radiace, o≈æiven√≠ p≈Ødy. Prvn√≠ komponent - Plutoniov√© j√°dro - je ve Vojensk√© z√°kladnƒõ. Pros√≠m, p≈ôines MI ho d≈ô√≠v ne≈æ Kory!\""
                }
            },
            {
                id: 'first_component',
                chapter: 1,
                title: 'Plutoniov√© j√°dro',
                description: 'Najdi prvn√≠ komponent - Plutoniov√© j√°dro',
                objectives: [
                    { id: 'go_to_military', text: 'Jdi do Vojensk√© z√°kladny', type: 'location', target: 'military_base', progress: 0 },
                    { id: 'get_plutonium', text: 'Z√≠skej Plutoniov√© j√°dro', type: 'item', target: 'plutonium_core', progress: 0 }
                ],
                reward: { xp: 200, money: 150 },
                nextQuest: 'first_choice',
                spawnItem: { id: 'plutonium_core', location: 'military_base' },
                dialog: {
                    start: "Oba brat≈ôi chtƒõj√≠ Plutoniov√© j√°dro z vojensk√© z√°kladny. Je ƒças ho naj√≠t.",
                    complete: "M√°≈° j√°dro! Radioaktivn√≠ z√°≈ôe z nƒõj vych√°z√≠... Komu ho d√°≈°?"
                }
            },
            {
                id: 'first_choice',
                chapter: 1,
                title: 'Prvn√≠ volba',
                description: 'Rozhodni komu d√°≈° Plutoniov√© j√°dro',
                objectives: [
                    { id: 'deliver_plutonium', text: 'Dones j√°dro Korymu NEBO Koudymu', type: 'choice', targets: ['trading_post', 'research_facility'], progress: 0 }
                ],
                reward: { xp: 150, money: 100 },
                nextQuest: 'second_component',
                requiresItem: 'plutonium_core',
                isChoice: true,
                choiceEffects: {
                    kory: { karma: { kory: 15, koudy: -10 }, dialog: "Kory se usm√≠v√°. \"V√Ωbornƒõ! Vƒõdƒõl jsem, ≈æe jsi chytr√Ω. Tohle je jen zaƒç√°tek nov√©ho svƒõta.\"" },
                    koudy: { karma: { koudy: 15, kory: -10 }, dialog: "Koudy si √∫levnƒõ oddechne. \"Dƒõkuji. Ka≈æd√Ω komponent v m√Ωch rukou je krok k z√°chranƒõ, ne zniƒçen√≠.\"" }
                }
            },
            
            // === KAPITOLA 2: POCHYBNOSTI ===
            {
                id: 'second_component',
                chapter: 2,
                title: 'Kvantov√Ω stabiliz√°tor',
                description: 'Najdi druh√Ω komponent - Kvantov√Ω stabiliz√°tor',
                objectives: [
                    { id: 'investigate_lab', text: 'Prozkoumej Secret Lab', type: 'location', target: 'secret_lab', progress: 0 },
                    { id: 'get_stabilizer', text: 'Z√≠skej Kvantov√Ω stabiliz√°tor', type: 'item', target: 'quantum_stabilizer', progress: 0 }
                ],
                reward: { xp: 250, money: 200 },
                nextQuest: 'find_document',
                spawnItem: { id: 'quantum_stabilizer', location: 'secret_lab' },
                dialog: {
                    start: "Dal≈°√≠ komponent je v tajn√© laborato≈ôi. Cesta bude nebezpeƒçn√°.",
                    complete: "Stabiliz√°tor je tv≈Øj. V laborato≈ôi jsi ale na≈°el i nƒõco jin√©ho - roztrhan√© dokumenty..."
                }
            },
            {
                id: 'find_document',
                chapter: 2,
                title: 'Roztrhan√© dokumenty',
                description: 'Najdi zbyl√© ƒç√°sti dokumentu o Projektu Genesis',
                objectives: [
                    { id: 'search_hospital', text: 'Prohledej Nemocnici', type: 'location', target: 'hospital', progress: 0 },
                    { id: 'get_document', text: 'Najdi chybƒõj√≠c√≠ str√°nky', type: 'item', target: 'genesis_document', progress: 0 }
                ],
                reward: { xp: 200, money: 150 },
                nextQuest: 'second_choice',
                spawnItem: { id: 'genesis_document', location: 'hospital' },
                dialog: {
                    start: "V trosk√°ch laborato≈ôe jsi na≈°el zm√≠nku o dokumentech v nemocnici...",
                    complete: "Dokument odhaluje pravdu: Projekt Genesis m≈Ø≈æe BUƒé vyƒçistit radiaci a obnovit p≈ô√≠rodu, NEBO vyvolat ≈ôetƒõzovou reakci kter√° zniƒç√≠ v≈°e ≈æiv√©. Z√°le≈æ√≠ na konfiguraci. Kdo z bratr≈Ø ≈ô√≠k√° pravdu?"
                }
            },
            {
                id: 'second_choice',
                chapter: 2,
                title: 'Druh√° volba',
                description: 'Dones stabiliz√°tor jednomu z bratr≈Ø',
                objectives: [
                    { id: 'deliver_stabilizer', text: 'Dones stabiliz√°tor Korymu NEBO Koudymu', type: 'choice', targets: ['trading_post', 'research_facility'], progress: 0 }
                ],
                reward: { xp: 200, money: 150 },
                nextQuest: 'third_component',
                requiresItem: 'quantum_stabilizer',
                isChoice: true,
                choiceEffects: {
                    kory: { karma: { kory: 15, koudy: -10 }, dialog: "\"Dal≈°√≠ krok k oƒçistƒõ,\" ≈ô√≠k√° Kory s podivn√Ωm leskem v oƒç√≠ch. \"Brzy bude v≈°e dokonal√©.\"" },
                    koudy: { karma: { koudy: 15, kory: -10 }, dialog: "Koudy studuje stabiliz√°tor. \"M≈Øj bratr... byl to v≈ædy on kdo vƒõ≈ôil, ≈æe slab√≠ mus√≠ zem≈ô√≠t. J√° vƒõ≈ô√≠m v druhou ≈°anci.\"" }
                }
            },
            
            // === KAPITOLA 3: ODHALEN√ç ===
            {
                id: 'third_component',
                chapter: 3,
                title: 'F√∫zn√≠ ƒçl√°nek',
                description: 'Najdi t≈ôet√≠ komponent - F√∫zn√≠ ƒçl√°nek',
                objectives: [
                    { id: 'go_to_power', text: 'Jdi do Power Plant', type: 'location', target: 'power_plant', progress: 0 },
                    { id: 'get_fusion', text: 'Z√≠skej F√∫zn√≠ ƒçl√°nek', type: 'item', target: 'fusion_cell', progress: 0 }
                ],
                reward: { xp: 300, money: 250 },
                nextQuest: 'truth_revealed',
                spawnItem: { id: 'fusion_cell', location: 'power_plant' },
                dialog: {
                    start: "Elektr√°rna je pln√° radiace a nebezpeƒç√≠. Ale F√∫zn√≠ ƒçl√°nek je tam.",
                    complete: "M√°≈° ƒçl√°nek! Ale v elektr√°rnƒõ jsi na≈°el star√Ω termin√°l s video z√°znamy..."
                }
            },
            {
                id: 'truth_revealed',
                chapter: 3,
                title: 'Pravda odhalena',
                description: 'P≈ôehraj video z√°znamy z termin√°lu',
                objectives: [
                    { id: 'watch_video', text: 'Prozkoumej Underground Bunker', type: 'location', target: 'underground_bunker', progress: 0 }
                ],
                reward: { xp: 300, money: 200 },
                nextQuest: 'third_choice',
                dialog: {
                    start: "Video z√°znamy odk√°zaly na hlavn√≠ archiv v podzemn√≠m bunkru...",
                    complete: "PRAVDA: Kory byl vedouc√≠m vojensk√©ho projektu. Vƒõ≈ôil, ≈æe lidstvo je \"nemoc\" a Genesis je \"l√©k\". Koudy byl jeho asistent, kter√Ω se pokusil projekt sabotovat - proto do≈°lo k explozi. Koudy se sna≈æ√≠ opravit chyby sv√©ho bratra. Kory chce dokonƒçit to, co zaƒçal - vymazat \"slab√©\" a vytvo≈ôit novou rasu vyvolen√Ωch."
                }
            },
            {
                id: 'third_choice',
                chapter: 3,
                title: 'T≈ôet√≠ volba',
                description: 'Dones F√∫zn√≠ ƒçl√°nek - tentokr√°t s pln√Ωm vƒõdom√≠m pravdy',
                objectives: [
                    { id: 'deliver_fusion', text: 'Dones ƒçl√°nek Korymu NEBO Koudymu', type: 'choice', targets: ['trading_post', 'research_facility'], progress: 0 }
                ],
                reward: { xp: 250, money: 200 },
                nextQuest: 'fourth_component',
                requiresItem: 'fusion_cell',
                isChoice: true,
                choiceEffects: {
                    kory: { karma: { kory: 20, koudy: -15 }, dialog: "Kory se smƒõje. \"Tak≈æe jsi vidƒõl pravdu a P≈òESTO jsi p≈ôi≈°el ke mnƒõ? Buƒè jsi hloup√Ω, nebo... rozum√≠≈°. Slab√≠ mus√≠ odej√≠t.\"" },
                    koudy: { karma: { koudy: 20, kory: -15 }, dialog: "Koudy m√° slzy v oƒç√≠ch. \"Dƒõkuji. Teƒè v√≠≈° pravdu o m√©m bratrovi. Mus√≠me ho zastavit.\"" }
                }
            },
            
            // === KAPITOLA 4: ROZHODNUT√ç ===
            {
                id: 'fourth_component',
                chapter: 4,
                title: '≈ò√≠dic√≠ modul AI',
                description: 'Najdi posledn√≠ komponent - ≈ò√≠dic√≠ modul AI',
                objectives: [
                    { id: 'go_to_bunker', text: 'Prozkoumej Star√Ω bunkr', type: 'location', target: 'old_bunker', progress: 0 },
                    { id: 'get_ai', text: 'Z√≠skej ≈ò√≠dic√≠ modul AI', type: 'item', target: 'ai_module', progress: 0 }
                ],
                reward: { xp: 400, money: 300 },
                nextQuest: 'final_choice',
                spawnItem: { id: 'ai_module', location: 'old_bunker' },
                dialog: {
                    start: "Posledn√≠ komponent je v Star√©m bunkru. Toto rozhodne osud svƒõta.",
                    complete: "M√°≈° v≈°echny ƒçty≈ôi komponenty. Je ƒças pro fin√°ln√≠ rozhodnut√≠. Komu svƒõ≈ô√≠≈° osud lidstva?"
                }
            },
            {
                id: 'final_choice',
                chapter: 4,
                title: 'Osud svƒõta',
                description: 'Jdi do Buƒçovic a rozhodni o osudu svƒõta',
                objectives: [
                    { id: 'go_to_bucovice', text: 'Jdi do Buƒçovic', type: 'location', target: 'bucovice', progress: 0 },
                    { id: 'final_decision', text: 'Rozhodni: Kory, Koudy, nebo zniƒçit?', type: 'final_choice', targets: ['kory', 'koudy', 'destroy'], progress: 0 }
                ],
                reward: { xp: 500, money: 500 },
                nextQuest: null,
                isFinalChoice: true,
                dialog: {
                    start: "M√°≈° v≈°echny 4 komponenty Projektu Genesis. Oba brat≈ôi se dozvƒõdƒõli a ƒçekaj√≠ v Buƒçovic√≠ch. Je ƒças rozhodnout o osudu svƒõta.",
                    complete: "Tv√° volba zmƒõnila svƒõt nav≈ædy..."
                },
                choiceEffects: {
                    kory: { ending: 'dark', dialog: "Kory se smƒõje jako ≈°√≠lenec. \"KONEƒåNƒö! Nov√Ω svƒõt se rod√≠!\" Aktivuje Genesis..." },
                    koudy: { ending: 'hope', dialog: "Koudy se usm√≠v√°. \"Dƒõkuji, p≈ô√≠teli. Dnes zaƒç√≠n√° obnova.\" Aktivuje Genesis v re≈æimu l√©ƒçen√≠..." },
                    destroy: { ending: 'neutral', dialog: "Rozb√≠j√≠≈° modul na kusy. Oba brat≈ôi k≈ôiƒç√≠. Projekt Genesis je nav≈ædy ztracen..." }
                }
            }
        ];
        
        // Quest itemy - 4 komponenty + dokumenty
        const QUEST_ITEMS = [
            { id: 'plutonium_core', name: 'Plutoniov√© j√°dro', icon: '‚ò¢Ô∏è', type: 'quest', weight: 2, desc: 'Radioaktivn√≠ j√°dro pulzuj√≠c√≠ zelen√Ωm svƒõtlem. Prvn√≠ komponent Projektu Genesis. Dones Korymu (Obchodn√≠ stanice) nebo Koudymu (V√Ωzkumn√© st≈ôedisko).' },
            { id: 'quantum_stabilizer', name: 'Kvantov√Ω stabiliz√°tor', icon: 'üî¨', type: 'quest', weight: 1.5, desc: 'Slo≈æit√© za≈ô√≠zen√≠ pro stabilizaci kvantov√Ωch fluktuac√≠. Druh√Ω komponent. Dones Korymu (Obchodn√≠ stanice) nebo Koudymu (V√Ωzkumn√© st≈ôedisko).' },
            { id: 'fusion_cell', name: 'F√∫zn√≠ ƒçl√°nek', icon: '‚ö°', type: 'quest', weight: 3, desc: 'Miniaturn√≠ f√∫zn√≠ reaktor. T≈ôet√≠ komponent Projektu Genesis. Dones Korymu (Obchodn√≠ stanice) nebo Koudymu (V√Ωzkumn√© st≈ôedisko).' },
            { id: 'ai_module', name: '≈ò√≠dic√≠ modul AI', icon: 'üíæ', type: 'quest', weight: 1, desc: 'Pokroƒçil√° umƒõl√° inteligence v p≈ôenosn√©m modulu. ƒåtvrt√Ω a posledn√≠ komponent. Dones Korymu (Obchodn√≠ stanice) nebo Koudymu (V√Ωzkumn√© st≈ôedisko).' },
            { id: 'genesis_document', name: 'Dokumenty Genesis', icon: 'üìú', type: 'quest', weight: 0.5, desc: 'Roztrhan√© dokumenty odhaluj√≠c√≠ pravdu o Projektu Genesis. P≈ôeƒçti si je v invent√°≈ôi.' },
            // Companion quest items
            { id: 'old_collar', name: 'Star√Ω obojek', icon: 'üìø', type: 'quest', weight: 0.1, desc: 'Star√Ω, opot≈ôebovan√Ω ps√≠ obojek s vybledl√Ωm jm√©nem.' },
            { id: 'dogtags', name: 'Identifikaƒçn√≠ zn√°mky', icon: 'ü™™', type: 'quest', weight: 0.1, desc: 'Vojensk√© identifikaƒçn√≠ zn√°mky padl√Ωch voj√°k≈Ø.' },
            { id: 'medical_records', name: 'L√©ka≈ôsk√© z√°znamy', icon: 'üìã', type: 'quest', weight: 0.2, desc: 'Star√© nemocniƒçn√≠ z√°znamy z doby p≈ôed v√°lkou.' },
            { id: 'lab_samples', name: 'Laboratorn√≠ vzorky', icon: 'üß™', type: 'quest', weight: 0.5, desc: 'Vzorky z v√Ωzkumn√© laborato≈ôe v ochrann√Ωch n√°dob√°ch.' },
            { id: 'secret_documents', name: 'Tajn√© dokumenty', icon: 'üìÅ', type: 'quest', weight: 0.3, desc: 'Utajovan√© vojensk√© dokumenty oznaƒçen√© jako "TOP SECRET". Quest item pro spoleƒçn√≠ka V√°leƒçn√≠ka - mluv s n√≠m pro dokonƒçen√≠ questu.' },
            { id: 'family_photo', name: 'Rodinn√° fotka', icon: 'üñºÔ∏è', type: 'quest', weight: 0.1, desc: 'Vybledl√° fotografie ≈°≈•astn√© rodiny z dob p≈ôed v√°lkou.' },
            { id: 'old_toy', name: 'Star√Ω ply≈°√°k', icon: 'üß∏', type: 'quest', weight: 0.2, desc: 'Otrhan√Ω ply≈°ov√Ω medv√≠dek, stopy po slz√°ch.' },
            { id: 'ancient_relic', name: 'Prastar√Ω artefakt', icon: 'üè∫', type: 'quest', weight: 1, desc: 'Z√°hadn√Ω p≈ôedmƒõt nezn√°m√©ho p≈Øvodu.' }
        ];
        
        // P≈ô√≠bƒõhov√≠ NPC - Kory a Koudy
        const STORY_NPCS = {
            kory: {
                id: 'kory',
                name: 'Kory',
                icon: 'ü¶π',
                location: 'trading_post',
                description: 'Charismatick√Ω mu≈æ s pronikav√Ωma oƒçima. Mluv√≠ o "oƒçistƒõ" a "nov√©m svƒõtƒõ".',
                dialogs: {
                    first_meet: [
                        "Ach, nov√Ω p≈ôe≈æiv≈°√≠! Sly≈°el jsem o tobƒõ.",
                        "V√≠≈°, tento svƒõt je zka≈æen√Ω. Slab√≠ t√°hnou siln√© dol≈Ø.",
                        "Projekt Genesis m≈Ø≈æe v≈°e zmƒõnit. Oƒçistit svƒõt od slabosti.",
                        "Pomoz mi naj√≠t komponenty a j√° tƒõ vezmu s sebou do nov√©ho, lep≈°√≠ho svƒõta.",
                        "Neposlouchej m√©ho bratra Koudyho. Je naivn√≠ a slab√Ω."
                    ],
                    quest_active: [
                        "U≈æ jsi na≈°el nƒõjak√© komponenty?",
                        "ƒåas se kr√°t√≠. Mus√≠me jednat rychle."
                    ],
                    quest_complete: [
                        "V√Ωbornƒõ. Jsi cenn√Ω spojenec.",
                        "Nov√Ω svƒõt se bl√≠≈æ√≠. A ty v nƒõm bude≈° m√≠t m√≠sto."
                    ]
                }
            }
        };
        
        // Ending definice
        const STORY_ENDINGS = {
            dark: {
                title: 'üåë Temn√Ω konec: Nov√Ω svƒõtov√Ω ≈ô√°d',
                description: 'Kory aktivoval Genesis v destrukƒçn√≠m re≈æimu. Vlna energie se ≈°√≠≈ô√≠ svƒõtem a niƒç√≠ v≈°e "slab√©". Jen hrstka "vyvolen√Ωch" p≈ôe≈æila v Koryho bunkru. Ty jsi mezi nimi - ale za jakou cenu?',
                effects: { reputation: -50, ending_type: 'dark' }
            },
            hope: {
                title: 'üåÖ Konec nadƒõje: Obnova',
                description: 'Koudy aktivoval Genesis v l√©ƒçebn√©m re≈æimu. Radiace se pomalu rozptyluje, mrtv√° zemƒõ zaƒç√≠n√° znovu zelenat. Je to pomal√Ω proces, ale poprv√© za dlouhou dobu je tu nadƒõje.',
                effects: { reputation: 50, ending_type: 'hope' }
            },
            neutral: {
                title: '‚öñÔ∏è Neutr√°ln√≠ konec: Status quo',
                description: 'Zniƒçil jsi posledn√≠ komponent. Projekt Genesis je nav≈ædy ztracen. Svƒõt z≈Øst√°v√° takov√Ω jak√Ω je - rozbit√Ω, ale ≈æiv√Ω. Nen√≠ tu nadƒõje na rychlou obnovu, ale ani hrozba zk√°zy.',
                effects: { reputation: 0, ending_type: 'neutral' }
            }
        };
        
        // === CUSTOMIZACE POSTAVY ===
        const HAIRSTYLES = [
            { id: 'bald', name: 'Hol√° hlava', icon: 'üë®‚Äçü¶≤' },
            { id: 'short', name: 'Kr√°tk√©', icon: 'üë®' },
            { id: 'medium', name: 'St≈ôedn√≠', icon: 'üßë' },
            { id: 'long', name: 'Dlouh√©', icon: 'üßî' },
            { id: 'mohawk', name: 'Mohawk', icon: 'üë©‚Äçüé§' },
            { id: 'ponytail', name: 'Cul√≠k', icon: 'üë©' }
        ];
        
        const HAIR_COLORS = [
            { id: 'black', name: 'ƒåern√°', color: '#1a1a1a' },
            { id: 'brown', name: 'Hnƒõd√°', color: '#8B4513' },
            { id: 'blonde', name: 'Blond', color: '#FFD700' },
            { id: 'red', name: 'Zrzav√°', color: '#B22222' },
            { id: 'gray', name: '≈†ediv√°', color: '#808080' },
            { id: 'white', name: 'B√≠l√°', color: '#F5F5F5' },
            { id: 'blue', name: 'Modr√°', color: '#4169E1' },
            { id: 'green', name: 'Zelen√°', color: '#228B22' },
            { id: 'pink', name: 'R≈Ø≈æov√°', color: '#FF69B4' }
        ];
        
        const SKIN_TONES = [
            { id: 'light', name: 'Svƒõtl√°', color: '#FFDFC4' },
            { id: 'medium_light', name: 'Svƒõtle hnƒõd√°', color: '#F0C8A0' },
            { id: 'medium', name: 'St≈ôedn√≠', color: '#D4A574' },
            { id: 'medium_dark', name: 'Tmavƒõ hnƒõd√°', color: '#A67B5B' },
            { id: 'dark', name: 'Tmav√°', color: '#8D5524' }
        ];
        
        const OUTFITS = [
            { id: 'survivor', name: 'P≈ôe≈æiv≈°√≠', icon: 'üß•', desc: 'Z√°kladn√≠ obleƒçen√≠' },
            { id: 'military', name: 'Vojensk√©', icon: 'üéñÔ∏è', desc: 'Mask√°ƒçov√° uniforma', unlock: 'kill_50' },
            { id: 'scientist', name: 'Vƒõdeck√©', icon: 'ü•º', desc: 'Laboratorn√≠ pl√°≈°≈•', unlock: 'story_ch2' },
            { id: 'raider', name: 'N√°jezdnick√©', icon: 'üíÄ', desc: 'Ko≈æen√© brnƒõn√≠', unlock: 'kill_100' },
            { id: 'hero', name: 'Hrdinsk√©', icon: 'ü¶∏', desc: 'Pl√°≈°≈• hrdiny', unlock: 'story_complete' },
            { id: 'wasteland', name: 'Pou≈°tn√≠', icon: 'üèúÔ∏è', desc: 'Pou≈°tn√≠ obleƒçen√≠', unlock: 'explore_100' }
        ];
        
        const TITLES = [
            { id: 'survivor', name: 'P≈ôe≈æiv≈°√≠', unlock: 'default' },
            { id: 'explorer', name: 'Pr≈Øzkumn√≠k', unlock: 'explore_50' },
            { id: 'warrior', name: 'V√°leƒçn√≠k', unlock: 'kill_100' },
            { id: 'champion', name: '≈†ampion', unlock: 'kill_200' },
            { id: 'legend', name: 'Legenda', unlock: 'explore_150' },
            { id: 'scientist', name: 'Vƒõdec', unlock: 'alchemy_10' },
            { id: 'hunter', name: 'Lovec', unlock: 'hunting_10' },
            { id: 'merchant', name: 'Obchodn√≠k', unlock: 'money_10000' },
            { id: 'savior', name: 'Zachr√°nce lidstva', unlock: 'story_complete' },
            { id: 'mutant', name: 'Mutant', unlock: 'mutations_3' }
        ];
        
        const BADGES = [
            { id: 'first_blood', name: 'Prvn√≠ krev', icon: 'ü©∏', desc: 'Zabil prvn√≠ho nep≈ô√≠tele' },
            { id: 'boss_slayer', name: 'Zabij√°k boss≈Ø', icon: 'üíÄ', desc: 'Zabil bosse' },
            { id: 'survivor_7', name: 'T√Ωden p≈ôe≈æit√≠', icon: 'üìÖ', desc: 'P≈ôe≈æil 7 dn√≠' },
            { id: 'rich', name: 'Boh√°ƒç', icon: 'üí∞', desc: 'Mƒõl 1000+ penƒõz' },
            { id: 'explorer', name: 'Objevitel', icon: 'üó∫Ô∏è', desc: 'Prozkoumal 50 hex≈Ø' },
            { id: 'chef', name: '≈†√©fkucha≈ô', icon: 'üë®‚Äçüç≥', desc: 'Uva≈ôil 10 j√≠del' },
            { id: 'alchemist', name: 'Alchymista', icon: '‚öóÔ∏è', desc: 'Nam√≠chal 10 lektvar≈Ø' },
            { id: 'fisherman', name: 'Ryb√°≈ô', icon: 'üé£', desc: 'Chytil 20 ryb' },
            { id: 'miner', name: 'Horn√≠k', icon: '‚õèÔ∏è', desc: 'Vytƒõ≈æil 20 rud' },
            { id: 'story_complete', name: 'Hrdina', icon: 'üèÜ', desc: 'Dokonƒçil p≈ô√≠bƒõh' }
        ];
        
        // === SKILL TREE ===
        const SKILL_TREE = {
            combat: {
                name: 'Boj',
                icon: '‚öîÔ∏è',
                color: '#c62828',
                skills: [
                    { id: 'power_strike', name: 'Siln√Ω √∫der', icon: 'üí™', desc: '+10% damage', maxLevel: 5, effect: { damageBonus: 0.1 }, requires: null, tier: 1 },
                    { id: 'critical_hit', name: 'Kritick√Ω z√°sah', icon: 'üí•', desc: '+5% ≈°ance na krit', maxLevel: 5, effect: { critChance: 0.05 }, requires: 'power_strike', tier: 2 },
                    { id: 'armor_pierce', name: 'Pr≈Øraz zbroje', icon: 'üó°Ô∏è', desc: 'Ignoruje 10% obrany', maxLevel: 3, effect: { armorPierce: 0.1 }, requires: 'power_strike', tier: 2 },
                    { id: 'berserker', name: 'Berserk', icon: 'üò§', desc: '+20% dmg kdy≈æ HP < 30%', maxLevel: 3, effect: { berserkerBonus: 0.2 }, requires: 'critical_hit', tier: 3 },
                    { id: 'execute', name: 'Poprava', icon: '‚ö∞Ô∏è', desc: '+50% dmg na nep≈ô√°tele pod 20% HP', maxLevel: 1, effect: { executeBonus: 0.5 }, requires: 'berserker', tier: 4 }
                ]
            },
            defense: {
                name: 'Obrana',
                icon: 'üõ°Ô∏è',
                color: '#1976d2',
                skills: [
                    { id: 'tough_skin', name: 'Tvrd√° k≈Ø≈æe', icon: 'ü¶é', desc: '+5 obrany', maxLevel: 5, effect: { defense: 5 }, requires: null, tier: 1 },
                    { id: 'block', name: 'Blokov√°n√≠', icon: 'üõ°Ô∏è', desc: '10% ≈°ance blokovat √∫tok', maxLevel: 5, effect: { blockChance: 0.1 }, requires: 'tough_skin', tier: 2 },
                    { id: 'regeneration', name: 'Regenerace', icon: 'üíö', desc: '+1 HP/min', maxLevel: 5, effect: { hpRegen: 1 }, requires: 'tough_skin', tier: 2 },
                    { id: 'last_stand', name: 'Posledn√≠ v√Ωdr≈æ', icon: 'üí™', desc: '20% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫der s 1 HP', maxLevel: 3, effect: { lastStand: 0.2 }, requires: 'block', tier: 3 },
                    { id: 'fortress', name: 'Pevnost', icon: 'üè∞', desc: '+20% max HP', maxLevel: 1, effect: { maxHpBonus: 0.2 }, requires: 'last_stand', tier: 4 }
                ]
            },
            survival: {
                name: 'P≈ôe≈æit√≠',
                icon: 'üèïÔ∏è',
                color: '#388e3c',
                skills: [
                    { id: 'scavenger', name: 'Sbƒõraƒç', icon: 'üîç', desc: '+15% ≈°ance na loot', maxLevel: 5, effect: { lootChance: 0.15 }, requires: null, tier: 1 },
                    { id: 'efficient', name: 'Efektivita', icon: 'üìä', desc: '-10% spot≈ôeba j√≠dla/vody', maxLevel: 5, effect: { consumeReduction: 0.1 }, requires: 'scavenger', tier: 2 },
                    { id: 'pack_rat', name: 'K≈ôeƒçek', icon: 'üéí', desc: '+10 nosnost', maxLevel: 5, effect: { carryWeight: 10 }, requires: 'scavenger', tier: 2 },
                    { id: 'auto_consume', name: 'Pud sebez√°chovy', icon: 'üß†', desc: 'Auto-j√≠/pije kdy≈æ um√≠r√°≈°', maxLevel: 1, effect: { autoConsume: true }, requires: 'efficient', tier: 3 },
                    { id: 'lucky', name: '≈†tƒõstƒõna', icon: 'üçÄ', desc: '+5% ≈°ance na vz√°cn√Ω loot', maxLevel: 3, effect: { rareChance: 0.05 }, requires: 'efficient', tier: 3 }
                ]
            },
            exploration: {
                name: 'Pr≈Øzkum',
                icon: 'üó∫Ô∏è',
                color: '#f57c00',
                skills: [
                    { id: 'pathfinder', name: 'Pr≈Øzkumn√≠k', icon: 'üë£', desc: '-1% ƒças cestov√°n√≠ / level', maxLevel: 5, effect: { travelSpeed: 0.01 }, requires: null, tier: 1 },
                    { id: 'scout', name: 'Zvƒõd', icon: 'üëÅÔ∏è', desc: '+5% ≈°ance naj√≠t vz√°cn√© p≈ôedmƒõty', maxLevel: 3, effect: { rareLootBonus: 0.05 }, requires: 'pathfinder', tier: 2 },
                    { id: 'stealth', name: 'Nen√°padnost', icon: 'üë§', desc: '-15% ≈°ance na p≈ôepaden√≠', maxLevel: 5, effect: { ambushReduction: 0.15 }, requires: 'pathfinder', tier: 2 },
                    { id: 'tracker', name: 'Stopa≈ô', icon: 'üêæ', desc: '+20% √∫spƒõ≈°nost lovu', maxLevel: 3, effect: { huntingBonus: 0.2 }, requires: 'scout', tier: 3 },
                    { id: 'nomad', name: 'Nom√°d', icon: 'üèúÔ∏è', desc: '≈Ω√°dn√© postihy za ter√©n', maxLevel: 1, effect: { noTerrainPenalty: true }, requires: 'tracker', tier: 4 }
                ]
            },
            crafting: {
                name: '≈òemeslo',
                icon: 'üîß',
                color: '#7b1fa2',
                skills: [
                    { id: 'tinkerer', name: 'Kutil', icon: 'üîß', desc: '-10% cena craftingu', maxLevel: 5, effect: { craftCostReduction: 0.1 }, requires: null, tier: 1 },
                    { id: 'chef', name: 'Kucha≈ô', icon: 'üë®‚Äçüç≥', desc: '+20% efekt j√≠dla', maxLevel: 5, effect: { foodBonus: 0.2 }, requires: 'tinkerer', tier: 2 },
                    { id: 'alchemist', name: 'Alchymista', icon: '‚öóÔ∏è', desc: '+20% efekt lektvar≈Ø', maxLevel: 5, effect: { potionBonus: 0.2 }, requires: 'tinkerer', tier: 2 },
                    { id: 'master_craft', name: 'Mistr ≈ôemesla', icon: '‚≠ê', desc: '20% ≈°ance na double v√Ωstup', maxLevel: 3, effect: { doubleCraft: 0.2 }, requires: 'chef', tier: 3 },
                    { id: 'legendary_smith', name: 'Legend√°rn√≠ kov√°≈ô', icon: 'üî®', desc: 'M≈Ø≈æe vytv√°≈ôet legend√°rn√≠ p≈ôedmƒõty', maxLevel: 1, effect: { legendaryUnlock: true }, requires: 'master_craft', tier: 4 }
                ]
            }
        };
        
        function generateDailyQuests() {
            // Reset check - once per real day
            const now = Date.now();
            const lastReset = state.dailyQuests.lastReset || 0;
            const daysPassed = Math.floor((now - lastReset) / (24 * 60 * 60 * 1000));
            
            // Kontrola: pokud je moneyEarned p≈ô√≠li≈° vysok√©, progress nebyl resetov√°n
            const progressCorrupted = state.dailyQuests.progress?.moneyEarned > 10000 ||
                                      state.dailyQuests.progress?.kills > 500 ||
                                      state.dailyQuests.progress?.explored > 100;
            
            if (daysPassed >= 1 || state.dailyQuests.quests.length === 0 || progressCorrupted) {
                if (progressCorrupted) {
                    console.warn('‚ö†Ô∏è Daily quest progress byl corrupted, resetuji...');
                }
                // Generate 3 random quests
                const shuffled = [...DAILY_QUEST_POOL].sort(() => Math.random() - 0.5);
                state.dailyQuests.quests = shuffled.slice(0, 3);
                state.dailyQuests.completed = [];
                state.dailyQuests.lastReset = now;
                state.dailyQuests.progress = {
                    kills: 0,
                    explored: 0,
                    crafted: 0,
                    moneyEarned: 0,
                    travelled: 0,
                    itemsFound: 0,
                    cooked: 0,
                    sold: 0,
                    bought: 0,
                    fedCompanion: 0,
                    healed: 0,
                    pvpWins: 0,
                    gambled: 0
                };
                addLog('Nov√© denn√≠ √∫koly dostupn√©!', 'üìã');
            } else {
                // Odfiltruj neexistuj√≠c√≠ questy (nap≈ô. travel_distance ze star√Ωch sav≈Ø)
                const validQuestIds = DAILY_QUEST_POOL.map(q => q.id);
                const invalidQuests = state.dailyQuests.quests.filter(q => !validQuestIds.includes(q.id));
                if (invalidQuests.length > 0) {
                    console.log('üßπ Odstra≈àuji neplatn√© questy:', invalidQuests.map(q => q.id));
                    state.dailyQuests.quests = state.dailyQuests.quests.filter(q => validQuestIds.includes(q.id));
                    // Pokud zbylo m√©nƒõ ne≈æ 3 questy, dopl≈à
                    while (state.dailyQuests.quests.length < 3) {
                        const availableQuests = DAILY_QUEST_POOL.filter(q => 
                            !state.dailyQuests.quests.some(sq => sq.id === q.id)
                        );
                        if (availableQuests.length === 0) break;
                        const randomQuest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
                        state.dailyQuests.quests.push(randomQuest);
                    }
                }
            }
        }
        
        function checkDailyQuests() {
            if (!state.dailyQuests.quests || state.dailyQuests.quests.length === 0) return;
            
            state.dailyQuests.quests.forEach(quest => {
                // Najdi origin√°ln√≠ quest z poolu (funkce se nezachovaj√≠ p≈ôi save/load)
                const originalQuest = DAILY_QUEST_POOL.find(q => q.id === quest.id);
                if (!originalQuest || !originalQuest.check) return;
                
                // Zajisti ≈æe completed existuje
                if (!state.dailyQuests.completed) state.dailyQuests.completed = [];
                
                if (!state.dailyQuests.completed.includes(quest.id) && originalQuest.check()) {
                    state.dailyQuests.completed.push(quest.id);
                    
                    // Poƒç√≠tadlo celkov√Ωch splnƒõn√Ωch denn√≠ch quest≈Ø (pro sk√≥re)
                    state.stats = state.stats || {};
                    state.stats.totalDailyQuestsCompleted = (state.stats.totalDailyQuestsCompleted || 0) + 1;
                    
                    // Spoƒç√≠tej odmƒõnu P≈òED vol√°n√≠m (pro zobrazen√≠)
                    const moneyBefore = getMoney();
                    const levelBefore = state.char.level;
                    const xpBefore = state.char.xp;
                    
                    // Zavolej reward funkci
                    console.log('üìú Denn√≠ quest dokonƒçen:', quest.name, '- vol√°m reward()');
                    originalQuest.reward();
                    
                    const moneyGained = getMoney() - moneyBefore;
                    // XP m≈Ø≈æe b√Ωt resetovan√© p≈ôi level upu, tak spoƒç√≠tej jinak
                    let xpGained = 0;
                    if (state.char.level > levelBefore) {
                        xpGained = state.char.xp + (state.char.xpNeed || 350); // P≈ôibli≈ænƒõ
                    } else {
                        xpGained = Math.max(0, state.char.xp - xpBefore);
                    }
                    
                    console.log('üìú Odmƒõny:', moneyGained, 'üí∞,', xpGained, 'XP');
                    
                    SoundSystem.play('quest_complete');
                    
                    // Sestaven√≠ textu odmƒõny
                    let rewardText = '';
                    if (moneyGained > 0) rewardText += `+${moneyGained} üí∞ `;
                    if (xpGained > 0) rewardText += `+${xpGained} XP `;
                    if (!rewardText) rewardText = 'Suroviny p≈ôid√°ny!';
                    
                    // Bƒõhem boje pou≈æij jen notifikaci, jinak modal
                    if (isInCombat()) {
                        notifySuccess('‚úÖ ' + quest.name, 'Denn√≠ √∫kol splnƒõn! ' + rewardText);
                    } else {
                        showModal('‚úÖ √ökol splnƒõn!', 
                            '<div style="text-align: center;">' +
                            '<div style="font-size: 3rem;">' + quest.icon + '</div>' +
                            '<h3>' + quest.name + '</h3>' +
                            '<p>' + quest.desc + '</p>' +
                            '<p style="color: #8bc34a; margin-top: 1rem; font-size: 1.2rem;">‚úì ' + rewardText + '</p>' +
                            '</div>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>'
                        );
                    }
                    addLog('Denn√≠ √∫kol splnƒõn: ' + quest.name + ' (' + rewardText.trim() + ')', '‚úÖ');
                    saveGame(true);
                }
            });
        }
        
        // === GAME VERSION ===
        // ============================================================
        // === üé≤ DYNAMICK√â N√ÅHODN√â EVENTY ===
        // ============================================================
        const DYNAMIC_EVENTS = [
            // === RESCUE EVENTS - Z√°chrann√© mise ===
            {
                id: 'burning_village',
                name: 'Ho≈ô√≠c√≠ vesnice',
                icon: 'üî•',
                type: 'rescue',
                triggerChance: 0.08,
                minLevel: 3,
                description: 'Vid√≠≈° kou≈ô stoupaj√≠c√≠ z nedalek√© vesnice!',
                choices: [
                    { 
                        id: 'help', 
                        text: 'üèÉ Bƒõ≈æ pomoci!', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.7, reward: { money: 150, xp: 100, reputation: { traders: 10 } }, text: 'Zachr√°nil jsi 3 vesniƒçany! Jsou ti nesm√≠rnƒõ vdƒõƒçn√≠.' },
                            failure: { chance: 0.3, penalty: { hp: -30 }, text: 'Dostal jsi pop√°leniny, ale zachr√°nil jsi jednoho ƒçlovƒõka.' }
                        }
                    },
                    { 
                        id: 'loot', 
                        text: 'üí∞ Vyu≈æij chaosu a lootuj', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.9, reward: { money: 250, items: ['medkit', 'food'] }, penalty: { reputation: { traders: -15 } }, text: 'Na≈°el jsi cennosti, ale nƒõkdo tƒõ vidƒõl...' }
                        }
                    },
                    { 
                        id: 'ignore', 
                        text: 'üö∂ Jdi d√°l', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, text: 'Pokraƒçuje≈° v cestƒõ. V√Ωk≈ôiky za tebou utichaj√≠...' }
                        }
                    }
                ]
            },
            {
                id: 'dying_stranger',
                name: 'Um√≠raj√≠c√≠ cizinec',
                icon: 'üíÄ',
                type: 'rescue',
                triggerChance: 0.1,
                minLevel: 1,
                description: 'Na zemi le≈æ√≠ zranƒõn√Ω ƒçlovƒõk. St√©n√° bolest√≠ a dr≈æ√≠ nƒõco v ruce...',
                choices: [
                    { 
                        id: 'help_heal', 
                        text: 'üíä O≈°et≈ôi ho (pot≈ôebuje≈° medkit)', 
                        requirements: { item: 'medkit' },
                        consumeItem: true,
                        outcome: {
                            success: { chance: 0.8, reward: { xp: 80, money: 100, unlockEvent: 'stranger_reward' }, text: '"Dƒõkuji... Vezmi si tohle." D√° ti mapu k pokladu.' },
                            failure: { chance: 0.2, text: 'P≈ôes tvou snahu um√≠r√°. V ruce dr≈æ√≠ kl√≠ƒç...' , reward: { items: ['mystery_key'] } }
                        }
                    },
                    { 
                        id: 'search', 
                        text: 'üîç Prohledej ho', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, reward: { money: 50, items: ['mystery_note'] }, text: 'Najde≈° z√°hadn√Ω dopis a p√°r minc√≠.' }
                        }
                    },
                    { 
                        id: 'mercy', 
                        text: 'üó°Ô∏è Ukonƒçi jeho utrpen√≠', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, reward: { items: ['dogtag'] }, penalty: { karma: -5 }, text: 'Rychl√° smrt. Najde≈° u nƒõj identifikaƒçn√≠ zn√°mku.' }
                        }
                    }
                ]
            },
            {
                id: 'caravan_attack',
                name: 'Karavana pod √∫tokem',
                icon: '‚öîÔ∏è',
                type: 'combat',
                triggerChance: 0.07,
                minLevel: 5,
                description: 'Sly≈°√≠≈° st≈ôelbu! Karavana obchodn√≠k≈Ø je napadena bandity!',
                choices: [
                    { 
                        id: 'help_fight', 
                        text: '‚öîÔ∏è Pomoz karavannƒõ!', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['raider', 'raider', 'bandit'], allies: 2 },
                            victory: { reward: { money: 300, xp: 150, reputation: { traders: 20 }, items: ['rare_weapon'] }, text: 'Obchodn√≠ci ti d√°vaj√≠ odmƒõnu!' },
                            defeat: { penalty: { hp: -50 }, text: 'Byl jsi tƒõ≈æce zranƒõn, ale obchodn√≠ci p≈ôe≈æili.' }
                        }
                    },
                    { 
                        id: 'help_bandits', 
                        text: 'üíÄ Pomoz bandit≈Øm (p≈ôidej se k √∫toku)', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['trader', 'guard'], allies: 3 },
                            victory: { reward: { money: 500 }, penalty: { reputation: { traders: -30, raiders: 15 } }, text: 'Banditi se s tebou podƒõl√≠ o ko≈ôist.' }
                        }
                    },
                    { 
                        id: 'wait', 
                        text: 'üëÅÔ∏è Poƒçkej a oloupej v√≠tƒõze', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.5, reward: { money: 200 }, text: 'Vyƒçkals a sebral co zbylo.' },
                            failure: { chance: 0.5, penalty: { hp: -20 }, text: 'Nƒõkdo tƒõ zpozoroval a napadl!' }
                        }
                    }
                ]
            },
            {
                id: 'child_lost',
                name: 'Ztracen√© d√≠tƒõ',
                icon: 'üë∂',
                type: 'rescue',
                triggerChance: 0.06,
                minLevel: 2,
                description: 'Mal√© d√≠tƒõ sed√≠ samo u cesty a pl√°ƒçe. Hled√° svou matku.',
                choices: [
                    { 
                        id: 'help_find', 
                        text: 'üîç Pomoz naj√≠t matku', 
                        requirements: null,
                        outcome: {
                            quest: 'find_mother',
                            text: 'D√≠tƒõ ti ukazuje smƒõr. Mus√≠≈° naj√≠t jeho matku do 20 minut!'
                        }
                    },
                    { 
                        id: 'give_food', 
                        text: 'üçñ Dej mu j√≠dlo', 
                        requirements: { item: 'food' },
                        consumeItem: true,
                        outcome: {
                            success: { chance: 1.0, reward: { xp: 30, karma: 5 }, text: 'D√≠tƒõ se uklidn√≠. Mo≈æn√° ho nƒõkdo najde.' }
                        }
                    },
                    { 
                        id: 'ignore_child', 
                        text: 'üö∂ Jdi d√°l', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, penalty: { karma: -3 }, text: 'Nech√°v√°≈° d√≠tƒõ za sebou. Pl√°ƒç utich√° v d√°lce.' }
                        }
                    }
                ]
            },
            
            // === MYSTERY EVENTS - Z√°hadn√© ud√°losti ===
            {
                id: 'strange_signal',
                name: 'Z√°hadn√Ω sign√°l',
                icon: 'üì°',
                type: 'mystery',
                triggerChance: 0.05,
                minLevel: 4,
                description: 'Tv√© r√°dio zachytilo ≈°ifrovanou zpr√°vu. Nƒõkdo vol√° o pomoc!',
                choices: [
                    { 
                        id: 'follow', 
                        text: 'üìç Vysleduj sign√°l', 
                        requirements: null,
                        outcome: {
                            quest: 'trace_signal',
                            text: 'Sign√°l poch√°z√≠ z opu≈°tƒõn√© tov√°rny severnƒõ odsud...'
                        }
                    },
                    { 
                        id: 'decode', 
                        text: 'üíª Pokus se de≈°ifrovat (INT 7+)', 
                        requirements: { attr: { int: 7 } },
                        outcome: {
                            success: { chance: 0.7, reward: { xp: 50 }, text: 'Zpr√°va zn√≠: "Trezor... 4-7-2-9... pomoc..."', unlockLocation: 'hidden_vault' },
                            failure: { chance: 0.3, text: 'Nedok√°≈æe≈° zpr√°vu rozlu≈°tit.' }
                        }
                    },
                    { 
                        id: 'ignore_signal', 
                        text: 'üìª Vypni r√°dio', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, text: 'Mo≈æn√° past, mo≈æn√° z√°chrana. Nikdy se nedozv√≠≈°.' }
                        }
                    }
                ]
            },
            {
                id: 'mysterious_trader',
                name: 'Z√°hadn√Ω obchodn√≠k',
                icon: 'üé≠',
                type: 'trade',
                triggerChance: 0.04,
                minLevel: 3,
                description: 'Podivn√Ω mu≈æ v pl√°≈°ti ti nab√≠z√≠ obchod. "M√°m nƒõco, co hled√°≈°..."',
                choices: [
                    { 
                        id: 'trade_money', 
                        text: 'üí∞ Zapla≈• 200 penƒõz', 
                        requirements: { money: 200 },
                        outcome: {
                            random: [
                                { chance: 0.3, reward: { items: ['legendary_weapon'] }, text: 'Dost√°v√°≈° LEGEND√ÅRN√ç zbra≈à!' },
                                { chance: 0.4, reward: { items: ['rare_armor'] }, text: 'Dost√°v√°≈° vz√°cnou zbroj.' },
                                { chance: 0.3, reward: { items: ['junk'] }, penalty: { money: -200 }, text: 'Je to jen haramp√°d√≠! Byl jsi okraden.' }
                            ]
                        }
                    },
                    { 
                        id: 'trade_item', 
                        text: 'üéÅ Nab√≠dni vz√°cn√Ω p≈ôedmƒõt', 
                        requirements: { hasRareItem: true },
                        outcome: {
                            success: { chance: 0.8, reward: { money: 500, xp: 100 }, text: '"Zaj√≠mav√©... Zde je tv√° odmƒõna."' }
                        }
                    },
                    { 
                        id: 'attack_trader', 
                        text: '‚öîÔ∏è Okraƒè ho', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['mysterious_trader'] },
                            victory: { reward: { money: 400, items: ['mystery_box'] }, penalty: { karma: -10 }, text: 'Porazil jsi ho. Co skr√Ωval?' },
                            defeat: { text: 'Miz√≠ v d√Ωmu... "Uvid√≠me se zase."' }
                        }
                    },
                    { 
                        id: 'decline', 
                        text: 'üö∂ Odm√≠tni', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, text: '"≈†koda... P≈ô√≠≈°tƒõ mo≈æn√°." Miz√≠ ve st√≠nech.' }
                        }
                    }
                ]
            },
            
            // === OPPORTUNITY EVENTS - P≈ô√≠le≈æitosti ===
            {
                id: 'abandoned_cache',
                name: 'Opu≈°tƒõn√° skr√Ω≈°',
                icon: 'üì¶',
                type: 'loot',
                triggerChance: 0.1,
                minLevel: 1,
                description: 'V≈°√≠m√°≈° si nen√°padn√©ho vchodu do podzemn√≠ skr√Ω≈°e.',
                choices: [
                    { 
                        id: 'enter_careful', 
                        text: 'üî¶ Vstup opatrnƒõ', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.6, reward: { money: 100, items: ['food', 'medkit'], resources: { metal: 5, electronics: 3 } }, text: 'Na≈°el jsi starou z√°sob√°rnu!' },
                            failure: { chance: 0.4, penalty: { hp: -15 }, text: 'Past! Aktivoval jsi alarm a zranil se.' }
                        }
                    },
                    { 
                        id: 'enter_force', 
                        text: 'üí™ Vraz dovnit≈ô (STR 6+)', 
                        requirements: { attr: { str: 6 } },
                        outcome: {
                            success: { chance: 0.8, reward: { money: 150, items: ['weapon', 'ammo'] }, text: 'Rozbil jsi dve≈ôe a vzal co bylo.' },
                            failure: { chance: 0.2, penalty: { hp: -25 }, text: 'Strop se z≈ô√≠til!' }
                        }
                    },
                    { 
                        id: 'mark_location', 
                        text: 'üó∫Ô∏è Oznaƒç na mapƒõ a jdi d√°l', 
                        requirements: null,
                        outcome: {
                            success: { chance: 1.0, reward: { unlockLocation: 'marked_cache' }, text: 'Vr√°t√≠≈° se sem pozdƒõji s lep≈°√≠ v√Ωbavou.' }
                        }
                    }
                ]
            },
            {
                id: 'faction_conflict',
                name: 'Frakƒçn√≠ konflikt',
                icon: '‚öîÔ∏è',
                type: 'faction',
                triggerChance: 0.05,
                minLevel: 5,
                description: 'Voj√°ci a n√°jezdn√≠ci se st≈ôetli! Obƒõ strany chtƒõj√≠ tvou pomoc.',
                choices: [
                    { 
                        id: 'help_military', 
                        text: 'üéñÔ∏è Pomoz vojensk√Ωm', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['raider', 'raider', 'bandit'], allies: 2 },
                            victory: { reward: { money: 200, reputation: { military: 25, raiders: -20 } }, text: 'Voj√°ci ti dƒõkuj√≠.' }
                        }
                    },
                    { 
                        id: 'help_raiders', 
                        text: 'üíÄ Pomoz n√°jezdn√≠k≈Øm', 
                        requirements: null,
                        outcome: {
                            combat: { enemies: ['soldier', 'soldier'], allies: 3 },
                            victory: { reward: { money: 300, reputation: { raiders: 25, military: -20 } }, text: 'N√°jezdn√≠ci se s tebou podƒõl√≠.' }
                        }
                    },
                    { 
                        id: 'wait_loot', 
                        text: 'üëÅÔ∏è Poƒçkej a seber ko≈ôist', 
                        requirements: null,
                        outcome: {
                            success: { chance: 0.7, reward: { money: 150, items: ['ammo', 'medkit'] }, text: 'Sebral jsi co zbylo po boji.' },
                            failure: { chance: 0.3, text: 'P≈ôe≈æiv≈°√≠ tƒõ zahl√©dl. Utekl jsi.' }
                        }
                    }
                ]
            }
        ];
        
        // ============================================================
        // === ‚è∞ ƒåASOVƒö LIMITOVAN√â QUESTY ===
        // ============================================================
        const TIMED_QUESTS = [
            {
                id: 'find_mother',
                name: 'Najdi matku',
                icon: 'üë∂',
                description: 'Ztracen√© d√≠tƒõ ti uk√°zalo smƒõr. Najdi jeho matku ne≈æ bude pozdƒõ!',
                timeLimit: 45 * 60 * 1000, // 45 minut - realistick√Ω ƒças na cestu + hled√°n√≠
                objectives: [
                    { id: 'search_village', text: 'Prohledej okoln√≠ vesnici', type: 'location', target: 'ruined_village' },
                    { id: 'find_mother', text: 'Najdi matku d√≠tƒõte', type: 'interact' }
                ],
                reward: { xp: 100, karma: 15, money: 150 },
                failureConsequence: {
                    text: 'Nepoda≈ôilo se ti naj√≠t matku vƒças. D√≠tƒõ z≈Østalo samo...',
                    penalty: { karma: -10 }
                }
            },
            {
                id: 'trace_signal',
                name: 'Vysleduj sign√°l',
                icon: 'üì°',
                description: 'Zachytil jsi nouzov√Ω sign√°l! Nƒõkdo pot≈ôebuje pomoc!',
                timeLimit: 60 * 60 * 1000, // 60 minut - tov√°rna je daleko
                objectives: [
                    { id: 'go_to_factory', text: 'Jdi k opu≈°tƒõn√© tov√°rnƒõ', type: 'location', target: 'factory' },
                    { id: 'find_survivor', text: 'Najdi zdroj sign√°lu', type: 'interact' }
                ],
                reward: { xp: 150, money: 200, items: ['rare_item'] },
                failureConsequence: {
                    text: 'Sign√°l utichl... P≈ôi≈°el jsi pozdƒõ.',
                    penalty: { karma: -5 }
                }
            },
            {
                id: 'rescue_hostage',
                name: 'Z√°chrana rukojm√≠',
                icon: '‚è∞',
                description: 'Banditi dr≈æ√≠ rukojm√≠! Mus√≠≈° ho zachr√°nit ne≈æ ho zabij√≠!',
                timeLimit: 90 * 60 * 1000, // 90 minut - raider_camp je daleko + combat
                location: 'raider_camp',
                objectives: [
                    { id: 'go_to_camp', text: 'Jdi do t√°bora n√°jezdn√≠k≈Ø', type: 'location', target: 'raider_camp' },
                    { id: 'defeat_raiders', text: 'Poraz n√°jezdn√≠ky', type: 'combat', enemies: ['raider', 'raider', 'raider_boss'] },
                    { id: 'free_hostage', text: 'Osvoboƒè rukojm√≠', type: 'interact' }
                ],
                reward: { money: 400, xp: 200, reputation: { traders: 20 }, companion: 'rescued_survivor' },
                failureConsequence: { 
                    text: 'Rukojm√≠ byl zabit... Jeho rodina tƒõ nikdy neodpust√≠.',
                    penalty: { reputation: { traders: -15 }, karma: -10 }
                }
            },
            {
                id: 'deliver_medicine',
                name: 'Z√°silka l√©k≈Ø',
                icon: 'üíä',
                description: 'Nemocn√Ω osadn√≠k um√≠r√°! Dones mu l√©ky z nemocnice!',
                timeLimit: 75 * 60 * 1000, // 75 minut - hospital je daleko (7,2) + zpƒõt
                requiresItem: 'antibiotics',
                objectives: [
                    { id: 'get_medicine', text: 'Z√≠skej antibiotika z nemocnice', type: 'item', target: 'antibiotics' },
                    { id: 'return_to_settlement', text: 'Dones l√©ky do osady', type: 'location', target: 'shelter' }
                ],
                reward: { xp: 150, reputation: { settlers: 15 }, unlockNPC: 'grateful_healer' },
                failureConsequence: {
                    text: 'Osadn√≠k zem≈ôel. Mohl jsi ho zachr√°nit...',
                    penalty: { settlers: -1, morale: -20 }
                }
            },
            {
                id: 'defuse_bomb',
                name: 'Tikaj√≠c√≠ bomba',
                icon: 'üí£',
                description: 'Nƒõkdo um√≠stil bombu v obchodn√≠m centru! Mus√≠≈° ji zne≈°kodnit!',
                timeLimit: 45 * 60 * 1000, // 45 minut - trading_post (4,2) + hled√°n√≠
                location: 'trading_post',
                objectives: [
                    { id: 'find_bomb', text: 'Najdi bombu', type: 'search', location: 'trading_post' },
                    { id: 'defuse', text: 'Zne≈°kodni bombu (INT 6+ nebo n√°stroje)', type: 'skill_check', attr: 'int', difficulty: 6 }
                ],
                reward: { money: 500, xp: 300, reputation: { traders: 30 } },
                failureConsequence: {
                    text: 'BOOM! Trading Post je zniƒçen. Obchodn√≠ci evakuovali ale ztratili v≈°e.',
                    penalty: { reputation: { traders: -25 }, destroyLocation: 'trading_post_destroyed' }
                }
            },
            {
                id: 'escape_horde',
                name: 'Zombie horda',
                icon: 'üßü',
                description: 'Obrovsk√° horda zombie m√≠≈ô√≠ k tv√© osadƒõ! M√°≈° m√°lo ƒçasu na p≈ô√≠pravu!',
                timeLimit: 90 * 60 * 1000, // 90 minut - pot≈ôebuje≈° sehnat materi√°l
                objectives: [
                    { id: 'build_defenses', text: 'Postav barik√°dy (50 d≈ôeva, 30 kovu)', type: 'build', resources: { wood: 50, metal: 30 } },
                    { id: 'gather_weapons', text: 'P≈ôiprav zbranƒõ pro osadn√≠ky', type: 'collect', items: ['weapon', 'weapon', 'ammo'] },
                    { id: 'defend', text: 'P≈ôe≈æij √∫tok hordy', type: 'siege_combat' }
                ],
                reward: { xp: 500, money: 300, achievement: 'horde_survivor' },
                failureConsequence: {
                    text: 'Horda zniƒçila osadu. Mus√≠≈° zaƒç√≠t znovu...',
                    penalty: { destroyBuildings: 2, settlers: -2 }
                }
            }
        ];
        
        // ============================================================
        // === üîç DETEKTIVN√ç QUESTY ===
        // ============================================================
        const DETECTIVE_QUESTS = [
            {
                id: 'murdered_trader',
                name: 'Vra≈æda obchodn√≠ka',
                icon: 'üîç',
                description: 'Star√Ω obchodn√≠k byl nalezen mrtv√Ω. Kdo ho zabil?',
                suspects: [
                    { id: 'jealous_rival', name: '≈Ω√°rliv√Ω konkurent', icon: 'üò†', clues: ['bloody_knife', 'torn_cloth'], motive: 'Obchodn√≠ rivalita', isGuilty: false },
                    { id: 'angry_customer', name: 'Na≈°tvan√Ω z√°kazn√≠k', icon: 'üò§', clues: ['angry_letter', 'witness_testimony'], motive: 'Podveden√Ω obchod', isGuilty: true },
                    { id: 'mysterious_woman', name: 'Z√°hadn√° ≈æena', icon: 'üîÆ', clues: ['perfume_bottle', 'love_letter'], motive: 'Odm√≠tnut√° l√°ska', isGuilty: false },
                    { id: 'debt_collector', name: 'Vymahaƒç dluh≈Ø', icon: 'üí∞', clues: ['debt_note', 'brass_knuckles'], motive: 'Nesplacen√Ω dluh', isGuilty: false }
                ],
                clueLocations: {
                    'bloody_knife': 'trading_post',
                    'torn_cloth': 'old_farm',
                    'angry_letter': 'abandoned_house',
                    'witness_testimony': 'trader_camp',
                    'perfume_bottle': 'hospital',
                    'love_letter': 'shelter',
                    'debt_note': 'bucovice',
                    'brass_knuckles': 'police_station'
                },
                interrogationQuestions: [
                    { question: 'Kde jsi byl v noci vra≈ædy?', truthful: ['angry_customer'], lie: ['jealous_rival', 'debt_collector'] },
                    { question: 'Znal jsi obƒõ≈• osobnƒõ?', truthful: ['jealous_rival', 'mysterious_woman'], lie: ['angry_customer'] },
                    { question: 'M√°≈° alibi?', truthful: ['mysterious_woman', 'jealous_rival'], lie: ['angry_customer', 'debt_collector'] }
                ],
                requiredClues: 3,
                reward: { money: 500, xp: 300, reputation: { traders: 25 }, title: 'Detektiv' },
                wrongAccusation: { penalty: { reputation: { traders: -20 }, karma: -5 }, text: 'Obvinil jsi nevinn√©ho!' }
            },
            {
                id: 'missing_child',
                name: 'Zmizen√≠ d√≠tƒõte',
                icon: 'üë∂',
                description: 'D√≠tƒõ zmizelo z osady. Rodiƒçe jsou zoufal√≠. Najdi ho!',
                suspects: [
                    { id: 'creepy_hermit', name: 'Podivn√Ω poustevn√≠k', icon: 'üßô', clues: ['child_toy', 'footprints'], motive: 'Samota', isGuilty: false },
                    { id: 'slaver_gang', name: 'Gang otrok√°≈ô≈Ø', icon: '‚õìÔ∏è', clues: ['slaver_note', 'cage_marks'], motive: 'Prodej', isGuilty: true },
                    { id: 'wild_animals', name: 'Divok√° zv√≠≈ôata', icon: 'üê∫', clues: ['torn_clothes', 'blood_trail'], motive: 'Lov', isGuilty: false }
                ],
                clueLocations: {
                    'child_toy': 'forest_edge',
                    'footprints': 'old_farm',
                    'slaver_note': 'raider_camp',
                    'cage_marks': 'abandoned_mine',
                    'torn_clothes': 'dense_forest',
                    'blood_trail': 'hunters_cabin'
                },
                timeLimit: 60 * 60 * 1000, // 1 hodina - d√≠tƒõ je v nebezpeƒç√≠!
                requiredClues: 2,
                reward: { xp: 400, reputation: { settlers: 30 }, companion: 'grateful_parent', karma: 20 },
                wrongAccusation: { penalty: { time: -15 * 60 * 1000 }, text: 'Ztratil jsi ƒças! D√≠tƒõ je st√°le v nebezpeƒç√≠!' },
                failureConsequence: { text: 'D√≠tƒõ nebylo nalezeno vƒças...', penalty: { karma: -15, reputation: { settlers: -20 } } }
            },
            {
                id: 'poisoned_well',
                name: 'Otr√°ven√° studna',
                icon: 'üíÄ',
                description: 'Nƒõkdo otr√°vil hlavn√≠ zdroj vody! Lid√© um√≠raj√≠. Najdi vin√≠ka!',
                suspects: [
                    { id: 'mad_scientist', name: '≈†√≠len√Ω vƒõdec', icon: 'üß™', clues: ['chemical_residue', 'lab_notes'], motive: 'Experiment', isGuilty: false },
                    { id: 'enemy_faction', name: 'Nep≈ô√°telsk√° frakce', icon: 'üíÄ', clues: ['faction_symbol', 'poison_vial'], motive: 'Oslaben√≠', isGuilty: true },
                    { id: 'revenge_seeker', name: 'Mstitel', icon: 'üòà', clues: ['revenge_letter', 'family_photo'], motive: 'Pomsta za smrt rodiny', isGuilty: false }
                ],
                clueLocations: {
                    'chemical_residue': 'water_well',
                    'lab_notes': 'research_facility',
                    'faction_symbol': 'military_outpost',
                    'poison_vial': 'chemical_plant',
                    'revenge_letter': 'old_bunker',
                    'family_photo': 'abandoned_house'
                },
                requiredClues: 3,
                reward: { money: 400, xp: 350, reputation: { settlers: 25 }, unlockCure: 'antidote_recipe' },
                wrongAccusation: { penalty: { reputation: { settlers: -15 } }, text: 'Skuteƒçn√Ω vin√≠k unikl!' }
            }
        ];
        
        // ============================================================
        // === üë• COMPANION QUESTY ===
        // ============================================================
        const COMPANION_QUESTS = {
            'dog': {
                name: 'Vƒõrn√Ω p≈ô√≠tel',
                icon: 'üêï',
                chapters: [
                    {
                        id: 'dog_past',
                        title: 'Stopy minulosti',
                        description: 'Tv≈Øj pes se chov√° divnƒõ pobl√≠≈æ star√© farmy. M√° tam nƒõjakou vazbu?',
                        trigger: { location: 'old_farm', loyalty: 30 },
                        objectives: [
                            { text: 'Prozkoumej starou farmu s psem', type: 'explore', target: 'old_farm' },
                            { text: 'Najdi star√Ω obojek', type: 'item', target: 'old_collar' }
                        ],
                        dialog: {
                            start: 'Tv≈Øj pes zaƒçne k≈àuƒçet a hrabat v trosk√°ch. Zd√° se, ≈æe tu kdysi ≈æil...',
                            complete: 'Na≈°el jsi star√Ω obojek. Pes se na tebe vdƒõƒçnƒõ pod√≠v√°. Koneƒçnƒõ v√≠, k√Ωm byl.'
                        },
                        reward: { companionXP: 100, skill: 'tracking', bond: 20 }
                    },
                    {
                        id: 'dog_revenge',
                        title: 'Pomsta za p√°na',
                        description: 'Pes vyƒçenichal stopu tƒõch, kdo zabili jeho p≈Øvodn√≠ rodinu.',
                        trigger: { previousQuest: 'dog_past', loyalty: 60 },
                        objectives: [
                            { text: 'Sleduj psovu stopu k t√°boru', type: 'location', target: 'raider_camp' },
                            { text: 'Pomoz psovi porazit n√°jezdn√≠ky', type: 'combat', enemies: ['raider', 'raider_boss'] }
                        ],
                        dialog: {
                            start: 'Pes vrƒç√≠. Poznal pach tƒõch, kte≈ô√≠ mu vzali v≈°e...',
                            complete: 'Spravedlnosti bylo uƒçinƒõno zadost. Pes ti l√≠z√° ruku - jste teƒè rodina.'
                        },
                        reward: { companionXP: 200, skill: 'fury', bond: 30 }
                    }
                ]
            },
            'warrior': {
                name: 'Cesta v√°leƒçn√≠ka',
                icon: '‚öîÔ∏è',
                chapters: [
                    {
                        id: 'warrior_honor',
                        title: 'Ztracen√° ƒçest',
                        description: 'V√°leƒçn√≠k ti vypr√°v√≠ o bitvƒõ, kde ztratil svou jednotku.',
                        trigger: { location: 'military_base', loyalty: 35 },
                        objectives: [
                            { text: 'Prozkoumej vojenskou z√°kladnu', type: 'explore', target: 'military_base' },
                            { text: 'Najdi identifikaƒçn√≠ zn√°mky padl√Ωch', type: 'item', target: 'dogtags' }
                        ],
                        dialog: {
                            start: '"Tady to bylo... V≈°ichni padli. Jen j√° jsem p≈ôe≈æil. Mo≈æn√°... mo≈æn√° bychom je mohli poh≈ôb√≠t."',
                            complete: '"Dƒõkuji. Koneƒçnƒõ mohou odpoƒç√≠vat v pokoji. A j√°... j√° mohu j√≠t d√°l."'
                        },
                        reward: { companionXP: 150, skill: 'veteran', bond: 25 }
                    },
                    {
                        id: 'warrior_redemption',
                        title: 'Vykoupen√≠ v boji',
                        description: 'V√°leƒçn√≠k chce dokonƒçit posledn√≠ misi sv√© jednotky.',
                        trigger: { previousQuest: 'warrior_honor', loyalty: 70 },
                        objectives: [
                            { text: 'Jdi do tajn√©ho bunkru', type: 'location', target: 'underground_bunker' },
                            { text: 'Poraz velitele mutant≈Ø', type: 'combat', target: 'mutant_boss' },
                            { text: 'Z√≠skej tajn√© dokumenty', type: 'item', target: 'secret_documents' }
                        ],
                        dialog: {
                            start: '"Na≈°e mise byla z√≠skat tyto dokumenty. Teƒè ji dokonƒç√≠me - spoleƒçnƒõ."',
                            complete: '"Mise splnƒõna. Po tolika letech... Jsi nejlep≈°√≠ velitel, jak√©ho jsem kdy mƒõl."'
                        },
                        reward: { companionXP: 300, stats: { damage: 5, defense: 3 }, bond: 40 }
                    }
                ]
            },
            'medic_npc': {
                name: 'L√©ƒçitelovo tajemstv√≠',
                icon: 'üë®‚Äç‚öïÔ∏è',
                chapters: [
                    {
                        id: 'medic_past',
                        title: 'Nemocnice hr≈Øzy',
                        description: 'Medik nechce mluvit o tom, co se stalo v nemocnici bƒõhem apokalypsy.',
                        trigger: { location: 'hospital', loyalty: 30 },
                        objectives: [
                            { text: 'Prozkoumej nemocnici', type: 'explore', target: 'hospital' },
                            { text: 'Najdi medic√≠nsk√© z√°znamy', type: 'item', target: 'medical_records' }
                        ],
                        dialog: {
                            start: '"Ne... Nechci sem. Ale... mo≈æn√° je ƒças se s t√≠m vyrovnat."',
                            complete: '"Nemohl jsem je zachr√°nit. Ale teƒè... teƒè zachr√°n√≠m tolik lid√≠, kolik bude mo≈æn√©."'
                        },
                        reward: { companionXP: 100, skill: 'trauma_surgeon', bond: 20 }
                    },
                    {
                        id: 'medic_cure',
                        title: 'Hled√°n√≠ l√©ku',
                        description: 'Medik vƒõ≈ô√≠, ≈æe existuje l√©k na mutaci. Pomoz mu ho naj√≠t.',
                        trigger: { previousQuest: 'medic_past', loyalty: 65 },
                        objectives: [
                            { text: 'Jdi do v√Ωzkumn√©ho za≈ô√≠zen√≠', type: 'location', target: 'research_facility' },
                            { text: 'Z√≠skej vzorky z laborato≈ôe', type: 'item', target: 'lab_samples' },
                            { text: 'Vra≈• se do osady', type: 'location', target: 'shelter' }
                        ],
                        dialog: {
                            start: '"Vidƒõl jsem v z√°znamech zm√≠nku o experiment√°ln√≠m l√©ku. Mus√≠me ho naj√≠t!"',
                            complete: '"M√°me ho! S t√≠mhle m≈Ø≈æeme l√©ƒçit prvn√≠ st√°dia mutace. Zachr√°nili jsme budoucnost."'
                        },
                        reward: { companionXP: 250, skill: 'miracle_worker', bond: 35, unlockRecipe: 'mutation_cure' }
                    }
                ]
            }
        };
        
        // Helper pro kontrolu podm√≠nek companion quest≈Ø
        function checkCompanionQuestTrigger(companionId, questChapter) {
            const comp = state.companions?.find(c => c.id === companionId);
            if (!comp) return false;
            
            const trigger = questChapter.trigger;
            
            if (trigger.location && state.world.currentLocation !== trigger.location) return false;
            if (trigger.loyalty && (comp.loyalty || 0) < trigger.loyalty) return false;
            if (trigger.daysWithCompanion && (comp.daysActive || 0) < trigger.daysWithCompanion) return false;
            if (trigger.previousQuest && !comp.completedQuests?.includes(trigger.previousQuest)) return false;
            if (trigger.choice && comp.questChoices?.[trigger.previousQuest] !== trigger.choice) return false;
            
            return true;
        }
        
        const GAME_VERSION = '2.5.1';
        const VERSION_DATE = '2025-01-11';
        
        // === NOV√ù MAPOV√ù SYST√âM - LOKACE ===
        // === VELK√Å MAPA SVƒöTA - 50+ LOKAC√ç ===
        // Pozice: x,y kde shelter je 0,0. Ka≈æd√Ω bod m≈ô√≠≈æky = 0.5 km
        // Rychlost ch≈Øze: 1 km = 6 minut (10 km/h je bƒõh, 5 km/h ch≈Øze)
        const GRID_SIZE_KM = 2; // Ka≈æd√Ω bod m≈ô√≠≈æky = 2 km
        const WALK_SPEED_MIN_PER_KM = 12; // 12 minut na 1 km ch≈Øze (5 km/h)
        
        const WORLD_LOCATIONS = [
            // === CENTRUM - √öKRYT (0,0) ===
            { id: 'shelter', name: 'Tv≈Øj √∫kryt', icon: 'üè†', type: 'home', zone: 'safe', x: 0, y: 0,
              desc: 'Tvoje z√°kladna. Bezpeƒçn√© m√≠sto pro odpoƒçinek a spr√°vu osady.' },
            
            // === BEZPEƒåN√Å Z√ìNA (bl√≠zko √∫krytu) - do 1 km ===
            { id: 'water_well', name: 'Star√° studna', icon: 'üíß', type: 'resource', zone: 'safe', x: 1, y: 0,
              desc: 'Zdroj relativnƒõ ƒçist√© vody.', resource: 'water' },
            { id: 'forest_edge', name: 'Okraj lesa', icon: 'üå≤', type: 'explore', zone: 'safe', x: 0, y: -1,
              desc: 'Klidn√Ω les. Dobr√Ω pro lov a sbƒõr d≈ôeva.', enemies: ['rat', 'wild_dog'], dangerLevel: 1 },
            { id: 'old_farm', name: 'Star√° farma', icon: 'üèöÔ∏è', type: 'explore', zone: 'safe', x: -1, y: 0,
              desc: 'Opu≈°tƒõn√° farma. J√≠dlo a l√°tky.', enemies: ['rat', 'wild_dog', 'feral'], dangerLevel: 1 },
            { id: 'trader_camp', name: 'T√°bor obchodn√≠k≈Ø', icon: '‚õ∫', type: 'shop', zone: 'safe', x: 2, y: 1,
              desc: 'Mal√Ω obchodn√≠ t√°bor. Z√°kladn√≠ zbo≈æ√≠.' },
            { id: 'small_pond', name: 'Mal√Ω rybn√≠k', icon: 'üêü', type: 'resource', zone: 'safe', x: -1, y: -1,
              desc: 'Klidn√© m√≠sto na ryba≈ôen√≠.', actions: ['fish'], spots: 2 },
            { id: 'berry_bushes', name: 'K≈ôov√≠ s bobulemi', icon: 'ü´ê', type: 'resource', zone: 'safe', x: 0, y: 1,
              desc: 'Jedl√© bobule a byliny.' },
            { id: 'old_shed', name: 'Star√° k≈Ølna', icon: 'üõñ', type: 'explore', zone: 'safe', x: 1, y: -1,
              desc: 'Rozpadl√° k≈Ølna. N√°stroje a d≈ôevo.', dangerLevel: 1 },
            { id: 'campsite', name: 'T√°bo≈ôi≈°tƒõ', icon: 'üèïÔ∏è', type: 'rest', zone: 'safe', x: -2, y: -1,
              desc: 'Bezpeƒçn√© m√≠sto pro odpoƒçinek.' },
            
            // === NOV√ù ZAƒå√ÅTEƒåNICK√ù DUNGEON ===
            { id: 'old_cellar', name: 'Star√Ω sklep', icon: 'üö™', type: 'dungeon', zone: 'safe', x: -1, y: 2,
              desc: 'Podzemn√≠ sklep pod z≈ô√≠cenou budovou. Tv≈Øj prvn√≠ dungeon!', enemies: ['rat', 'giant_rat'], dangerLevel: 1 },
              
            // === ST≈òEDN√ç Z√ìNA - SEVER (1-3 km) ===
            { id: 'dense_forest', name: 'Hust√Ω les', icon: 'üå≥', type: 'explore', zone: 'medium', x: 0, y: -3,
              desc: 'Temn√Ω les pln√Ω zvƒõ≈ôe.', enemies: ['wild_dog', 'wolf'], dangerLevel: 2 },
            { id: 'hunters_cabin', name: 'Loveck√° chata', icon: 'üèïÔ∏è', type: 'rest', zone: 'medium', x: 2, y: -3,
              desc: 'Opu≈°tƒõn√° chata lovce. Odpoƒçinek a loot.', enemies: ['wild_dog'], dangerLevel: 2 },
            { id: 'old_sawmill', name: 'Star√° pila', icon: 'ü™ö', type: 'explore', zone: 'medium', x: -2, y: -3,
              desc: 'Zdroj d≈ôeva a n√°stroj≈Ø.', enemies: ['raider_weak'], dangerLevel: 2 },
            { id: 'mountain_pass', name: 'Horsk√Ω pr≈Øsmyk', icon: '‚õ∞Ô∏è', type: 'explore', zone: 'medium', x: 0, y: -5,
              desc: 'Nebezpeƒçn√° cesta p≈ôes hory.', enemies: ['wolf', 'bandit'], dangerLevel: 3 },
            { id: 'abandoned_mine', name: 'Opu≈°tƒõn√Ω d≈Øl', icon: '‚õèÔ∏è', type: 'dungeon', zone: 'medium', x: -3, y: -4,
              desc: 'Temn√Ω d≈Øl. Kovy a nebezpeƒç√≠.', enemies: ['mutant_rat', 'cave_spider'], dangerLevel: 3, radiation: 5 },
            
            // === ST≈òEDN√ç Z√ìNA - JIH (1-3 km) ===
            { id: 'ruined_village', name: 'Zniƒçen√° vesnice', icon: 'üèòÔ∏è', type: 'explore', zone: 'medium', x: 0, y: 3,
              desc: 'Opu≈°tƒõn√° vesnice. Loot v domech.', enemies: ['raider_weak', 'wild_dog'], dangerLevel: 2 },
            { id: 'old_church', name: 'Star√Ω kostel', icon: '‚õ™', type: 'explore', zone: 'medium', x: 2, y: 3,
              desc: 'Posv√°tn√© m√≠sto, teƒè opu≈°tƒõn√©.', enemies: ['ghost'], dangerLevel: 2 },
            { id: 'cemetery', name: 'H≈ôbitov', icon: 'ü™¶', type: 'explore', zone: 'medium', x: -2, y: 3,
              desc: 'Dƒõsiv√© m√≠sto. Vz√°cn√Ω loot.', enemies: ['ghoul'], dangerLevel: 3 },
            { id: 'swamp', name: 'Ba≈æina', icon: 'üêä', type: 'dangerous', zone: 'medium', x: 0, y: 5,
              desc: 'Nebezpeƒçn√° ba≈æina. Radiace a mutanti.', enemies: ['mutant_frog', 'swamp_creature'], dangerLevel: 3, radiation: 8 },
            
            // === ST≈òEDN√ç Z√ìNA - Z√ÅPAD (1-3 km) ===
            { id: 'highway', name: 'Star√° d√°lnice', icon: 'üõ£Ô∏è', type: 'explore', zone: 'medium', x: -3, y: 0,
              desc: 'Opu≈°tƒõn√° d√°lnice. Vraky aut.', enemies: ['raider'], dangerLevel: 2 },
            { id: 'gas_station', name: 'Benz√≠nka', icon: '‚õΩ', type: 'resource', zone: 'medium', x: -3, y: 2,
              desc: 'Zdroj paliva.', enemies: ['raider'], dangerLevel: 2, resource: 'fuel' },
            { id: 'motel', name: 'Opu≈°tƒõn√Ω motel', icon: 'üè®', type: 'explore', zone: 'medium', x: -3, y: -2,
              desc: 'Rozpadl√Ω motel. Mo≈æn√° p≈ôe≈æiv≈°√≠?', enemies: ['raider_weak', 'feral'], dangerLevel: 2 },
            { id: 'junkyard', name: 'Vrakovi≈°tƒõ', icon: 'üöó', type: 'explore', zone: 'medium', x: -5, y: 0,
              desc: 'Hromady ≈°rotu. Kov a d√≠ly.', enemies: ['wild_dog', 'raider'], dangerLevel: 2 },
            
            // === ST≈òEDN√ç Z√ìNA - V√ùCHOD (1-3 km) ===
            { id: 'radio_tower', name: 'Vys√≠laƒç', icon: 'üì°', type: 'radio', zone: 'medium', x: 3, y: 0,
              desc: 'Star√° r√°diov√° vƒõ≈æ. Lze tu zachytit sign√°ly.', enemies: ['raider'], dangerLevel: 2 },
            { id: 'workshop', name: 'D√≠lna mechanika', icon: 'üîß', type: 'service', zone: 'medium', x: 3, y: -2,
              desc: 'Opravy zbran√≠ a zbroje.' },
            { id: 'warehouse', name: 'Sklad', icon: 'üì¶', type: 'explore', zone: 'medium', x: 5, y: 0,
              desc: 'Velk√Ω sklad. Hodnƒõ lootu.', enemies: ['raider', 'mutant_dog'], dangerLevel: 2 },
            
            // === NEBEZPEƒåN√Å Z√ìNA - SEVER (3-5 km) ===
            { id: 'frozen_lake', name: 'Zamrzl√© jezero', icon: 'üßä', type: 'dangerous', zone: 'danger', x: 0, y: -7,
              desc: 'Nebezpeƒçn√Ω led. Mutantn√≠ ryby.', enemies: ['ice_mutant'], dangerLevel: 4, radiation: 5 },
            { id: 'military_outpost', name: 'Vojensk√° hl√≠dka', icon: 'üéñÔ∏è', type: 'dungeon', zone: 'danger', x: 3, y: -6,
              desc: 'Opu≈°tƒõn√° vojensk√° pozice.', enemies: ['soldier_zombie', 'robot'], dangerLevel: 4 },
            { id: 'research_camp', name: 'V√Ωzkumn√Ω t√°bor', icon: 'üî¨', type: 'explore', zone: 'danger', x: -3, y: -6,
              desc: 'Vƒõdeck√° expedice zmizela...', enemies: ['mutant', 'experiment'], dangerLevel: 4, radiation: 10 },
            
            // === NEBEZPEƒåN√Å Z√ìNA - JIH (3-5 km) ===
            { id: 'toxic_lake', name: 'Toxick√© jezero', icon: '‚ò¢Ô∏è', type: 'dangerous', zone: 'danger', x: 0, y: 7,
              desc: 'Silnƒõ radioaktivn√≠ voda.', enemies: ['mutant_fish', 'swamp_beast'], dangerLevel: 4, radiation: 15 },
            { id: 'raider_camp', name: 'T√°bor n√°jezdn√≠k≈Ø', icon: '‚öîÔ∏è', type: 'hostile', zone: 'danger', x: 3, y: 6,
              desc: 'Hlavn√≠ z√°kladna n√°jezdn√≠k≈Ø.', enemies: ['raider', 'raider_boss'], dangerLevel: 4, isRaid: true },
            { id: 'slave_camp', name: 'Otrok√°≈ôsk√Ω t√°bor', icon: '‚õìÔ∏è', type: 'hostile', zone: 'danger', x: -3, y: 6,
              desc: 'Osvoboƒè zajatce!', enemies: ['slaver', 'slaver_boss'], dangerLevel: 4, isRaid: true },
            
            // === NEBEZPEƒåN√Å Z√ìNA - Z√ÅPAD (3-5 km) ===
            { id: 'factory', name: 'Toxick√° tov√°rna', icon: 'üè≠', type: 'dungeon', zone: 'danger', x: -7, y: 0,
              desc: 'Chemick√° tov√°rna. Jedy a mutanti.', enemies: ['mutant', 'toxic_beast'], dangerLevel: 4, radiation: 12 },
            { id: 'power_plant', name: 'Elektr√°rna', icon: '‚ö°', type: 'dungeon', zone: 'danger', x: -7, y: 2,
              desc: 'Nebezpeƒçn√°, ale cenn√°.', enemies: ['robot', 'electric_mutant'], dangerLevel: 4, radiation: 8 },
            { id: 'chemical_plant', name: 'Chemiƒçka', icon: 'üß™', type: 'dungeon', zone: 'danger', x: -7, y: -2,
              desc: 'Chemik√°lie a nebezpeƒç√≠.', enemies: ['toxic_zombie', 'acid_beast'], dangerLevel: 4, radiation: 10 },
            
            // === NEBEZPEƒåN√Å Z√ìNA - V√ùCHOD (3-5 km) ===
            { id: 'ruined_city', name: 'Zniƒçen√© mƒõsto', icon: 'üèöÔ∏è', type: 'explore', zone: 'danger', x: 7, y: 0,
              desc: 'Velk√© mƒõsto v ruin√°ch.', enemies: ['raider', 'mutant', 'feral'], dangerLevel: 4 },
            { id: 'hospital', name: 'Nemocnice', icon: 'üè•', type: 'medical', zone: 'danger', x: 7, y: 2,
              desc: 'L√©ky a nebezpeƒç√≠.', enemies: ['feral', 'mutant'], dangerLevel: 4 },
            { id: 'police_station', name: 'Policejn√≠ stanice', icon: 'üöî', type: 'dungeon', zone: 'danger', x: 7, y: -2,
              desc: 'Zbranƒõ a munice.', enemies: ['zombie_cop', 'feral'], dangerLevel: 4 },
            { id: 'shopping_mall', name: 'N√°kupn√≠ centrum', icon: 'üõí', type: 'explore', zone: 'danger', x: 9, y: 0,
              desc: 'Obrovsk√©, pln√© lootu i nebezpeƒç√≠.', enemies: ['raider', 'feral', 'mutant'], dangerLevel: 4 },
            
            // === SMRTELN√Å Z√ìNA (5+ km) ===
            { id: 'military_base', name: 'Vojensk√° z√°kladna', icon: 'üéñÔ∏è', type: 'dungeon', zone: 'deadly', x: 0, y: -10,
              desc: 'Tƒõ≈æce st≈ôe≈æen√°. Nejlep≈°√≠ v√Ωbava.', enemies: ['soldier', 'robot', 'turret'], dangerLevel: 5, isBoss: true },
            { id: 'nuclear_plant', name: 'Jadern√° elektr√°rna', icon: '‚ò¢Ô∏è', type: 'dungeon', zone: 'deadly', x: -10, y: 0,
              desc: 'Extr√©mn√≠ radiace. Legend√°rn√≠ loot.', enemies: ['glowing_one', 'mutant_behemoth'], dangerLevel: 5, radiation: 25 },
            { id: 'underground_bunker', name: 'Tajn√Ω bunkr', icon: 'üö™', type: 'dungeon', zone: 'deadly', x: 10, y: -3,
              desc: 'P≈ôedv√°leƒçn√Ω bunkr. Kdo v√≠ co je uvnit≈ô?', enemies: ['robot', 'turret', 'ai_guardian'], dangerLevel: 5, isSecret: true },
            { id: 'crater', name: 'Kr√°ter', icon: 'üí•', type: 'dangerous', zone: 'deadly', x: 0, y: 10,
              desc: 'M√≠sto dopadu bomby. Extr√©mnƒõ nebezpeƒçn√©.', enemies: ['glowing_ghoul', 'irradiated_beast'], dangerLevel: 5, radiation: 30 },
            { id: 'wasteland_depths', name: 'Hlubiny pustiny', icon: 'üíÄ', type: 'explore', zone: 'deadly', x: -6, y: -8,
              desc: 'Nejnebezpeƒçnƒõj≈°√≠ oblast svƒõta.', enemies: ['deathclaw', 'mutant_giant'], dangerLevel: 5, radiation: 20 },
            { id: 'mutant_nest', name: 'Hn√≠zdo mutant≈Ø', icon: 'üï≥Ô∏è', type: 'hostile', zone: 'deadly', x: 6, y: 8,
              desc: 'Hlavn√≠ hn√≠zdo mutant≈Ø.', enemies: ['mutant', 'mutant_brute', 'mutant_queen'], dangerLevel: 5, isBoss: true },
            
            // === SPECI√ÅLN√ç LOKACE ===
            { id: 'abandoned_house', name: 'Opu≈°tƒõn√Ω d≈Øm', icon: 'üèöÔ∏è', type: 'npc', zone: 'safe', x: 2, y: -1,
              desc: 'Tajemn√Ω opu≈°tƒõn√Ω d≈Øm. Nƒõkdo tu mo≈æn√° ≈æije...', enemies: ['rat'], dangerLevel: 1 },
            { id: 'research_facility', name: 'V√Ωzkumn√© za≈ô√≠zen√≠', icon: 'üî¨', type: 'npc', zone: 'danger', x: 5, y: -5,
              desc: 'Vƒõdeck√° laborato≈ô. Koudy tu pracuje na z√°chranƒõ svƒõta.', enemies: ['mutant', 'experiment'], dangerLevel: 4, radiation: 8 },
            { id: 'trading_post', name: 'Obchodn√≠ stanice', icon: 'üè™', type: 'shop', zone: 'medium', x: 4, y: 2,
              desc: 'Hlavn√≠ obchodn√≠ centrum oblasti. Kory m√° tu svou z√°kladnu.' },
            { id: 'secret_lab', name: 'Tajn√° laborato≈ô', icon: 'üß´', type: 'dungeon', zone: 'danger', x: -5, y: -6,
              desc: 'Skryt√° laborato≈ô pln√° tajemstv√≠ o Projektu Genesis.', enemies: ['mutant', 'robot', 'experiment'], dangerLevel: 4, radiation: 12 },
            { id: 'old_bunker', name: 'Star√Ω bunkr', icon: 'üö™', type: 'dungeon', zone: 'deadly', x: 8, y: -8,
              desc: 'P≈ôedv√°leƒçn√Ω bunkr. M√≠sto kde v≈°e zaƒçalo...', enemies: ['robot', 'turret', 'ai_guardian'], dangerLevel: 5, isSecret: true },
            { id: 'wandering_merchant', name: 'Potuln√Ω obchodn√≠k', icon: 'üê™', type: 'shop', zone: 'medium', x: -4, y: 4,
              desc: 'Vz√°cn√Ω obchodn√≠k s exotick√Ωm zbo≈æ√≠m.' },
            { id: 'hermit_hut', name: 'Poustevn√≠kova chata', icon: 'üßô', type: 'npc', zone: 'medium', x: 4, y: -4,
              desc: 'Star√Ω mudrc. Mo≈æn√° m√° quest?' },
            { id: 'safehouse', name: '√ökryt p≈ôe≈æiv≈°√≠ch', icon: 'üè†', type: 'settlement', zone: 'medium', x: -5, y: 4,
              desc: 'Mal√° osada p≈ôe≈æiv≈°√≠ch. Bezpeƒçn√© m√≠sto.' },
            
            // === DAL≈†√ç M√çSTA PRO HUSTOTU MAPY ===
            { id: 'crossroads', name: 'K≈ôi≈æovatka', icon: 'üîÄ', type: 'npc', zone: 'safe', x: 2, y: 2,
              desc: 'K≈ôi≈æovatka cest. ≈†erif Kowalski tu hl√≠d√° po≈ô√°dek.' },
            { id: 'empty_field', name: 'Pr√°zdn√© pole', icon: 'üåæ', type: 'empty', zone: 'safe', x: -2, y: 1,
              desc: 'Opu≈°tƒõn√© pole. Klid.' },
            { id: 'broken_bridge', name: 'Rozbit√Ω most', icon: 'üåâ', type: 'npc', zone: 'medium', x: 4, y: 4,
              desc: 'Most p≈ôes ≈ôeku. Posel Jin tu p≈ôed√°v√° zpr√°vy.' },
            { id: 'dried_riverbed', name: 'Vyschl√© koryto', icon: 'üèúÔ∏è', type: 'explore', zone: 'medium', x: -4, y: -3,
              desc: 'Star√° ≈ôeka. Obƒças se tu nƒõco najde.', dangerLevel: 1 },
            { id: 'watchtower', name: 'Str√°≈æn√≠ vƒõ≈æ', icon: 'üóº', type: 'explore', zone: 'medium', x: 5, y: -4,
              desc: 'Star√° vƒõ≈æ. Dobr√Ω rozhled.', enemies: ['raider'], dangerLevel: 2 },
            { id: 'roadside_camp', name: 'T√°bor u cesty', icon: '‚õ∫', type: 'rest', zone: 'medium', x: -5, y: -3,
              desc: 'Opu≈°tƒõn√Ω t√°bor. Mo≈æn√° odpoƒçinek?' },
            { id: 'old_bridge', name: 'Star√Ω most', icon: 'üåâ', type: 'empty', zone: 'medium', x: 0, y: -2,
              desc: 'Kamenn√Ω most p≈ôes potok.' },
            { id: 'ruins_north', name: 'Severn√≠ ruiny', icon: 'üèõÔ∏è', type: 'explore', zone: 'danger', x: 2, y: -5,
              desc: 'Star√© ruiny. Nebezpeƒçn√©.', enemies: ['ghoul', 'raider'], dangerLevel: 3 },
            { id: 'ruins_south', name: 'Ji≈æn√≠ ruiny', icon: 'üèõÔ∏è', type: 'explore', zone: 'danger', x: -2, y: 5,
              desc: 'Rozpadl√© budovy.', enemies: ['mutant', 'feral'], dangerLevel: 3 },
            
            // === PR√ÅZDN√â LOKACE - HUSTOTA MAPY ===
            // Bezpeƒçn√° z√≥na
            { id: 'empty_01', name: 'Pra≈°n√° cesta', icon: 'üõ§Ô∏è', type: 'empty', zone: 'safe', x: 1, y: 1, desc: 'Jen prach a kamen√≠.' },
            { id: 'empty_02', name: 'Such√© k≈ôov√≠', icon: 'üåø', type: 'empty', zone: 'safe', x: -1, y: 1, desc: 'Uschl√© ke≈ôe.' },
            { id: 'empty_03', name: 'Rozbit√° cesta', icon: 'üõ§Ô∏è', type: 'empty', zone: 'safe', x: 0, y: 2, desc: 'Popraskan√Ω asfalt.' },
            { id: 'empty_04', name: 'Hol√° pl√°≈à', icon: 'üèúÔ∏è', type: 'empty', zone: 'safe', x: 2, y: 0, desc: 'Pr√°zdn√° pustina.' },
            { id: 'empty_05', name: 'Spadl√Ω strom', icon: 'ü™µ', type: 'empty', zone: 'safe', x: -2, y: -2, desc: 'Star√Ω padl√Ω strom.' },
            { id: 'empty_06', name: 'P√≠seƒçn√° duna', icon: 'üèñÔ∏è', type: 'empty', zone: 'safe', x: 1, y: 2, desc: 'Mal√° p√≠seƒçn√° duna.' },
            
            // === BUƒåOVICE - HLAVN√ç MƒöSTO ===
            { id: 'bucovice', name: 'Buƒçovice', icon: 'üè∞', type: 'city', zone: 'safe', x: -2, y: 2,
              desc: 'Starobyl√© mƒõsto, jedno z m√°la kter√© p≈ôe≈æilo apokalypsu vcelku. Centrum obchodu a civilizace v pustinƒõ.',
              special: 'main_city' },
            
            // St≈ôedn√≠ z√≥na - sever
            { id: 'quarry_01', name: 'Skalnat√° str√°≈à', icon: 'ü™®', type: 'mine', zone: 'medium', x: 1, y: -2, desc: 'Strm√© sk√°ly bohat√© na k√°men a rudu. Ide√°ln√≠ m√≠sto pro tƒõ≈æbu.', danger: 0.1 },
            { id: 'empty_09', name: 'Mrtv√Ω les', icon: 'üå≤', type: 'empty', zone: 'medium', x: -1, y: -2, desc: 'Uschl√© stromy.' },
            { id: 'empty_10', name: 'Zarostl√° cesta', icon: 'üåø', type: 'empty', zone: 'medium', x: 1, y: -3, desc: 'Cesta zarostl√° plevelem.' },
            { id: 'empty_11', name: 'Opu≈°tƒõn√Ω t√°bor', icon: 'üèöÔ∏è', type: 'empty', zone: 'medium', x: -1, y: -3, desc: 'Pr√°zdn√© stanovi≈°tƒõ.' },
            { id: 'empty_12', name: 'Rozbit√© auto', icon: 'üöó', type: 'empty', zone: 'medium', x: 1, y: -4, desc: 'Rezav√Ω vrak auta.' },
            { id: 'empty_13', name: 'Kamenn√© trosky', icon: 'üß±', type: 'empty', zone: 'medium', x: -1, y: -4, desc: 'Zbytky nƒõjak√© stavby.' },
            { id: 'empty_14', name: 'Pr√°zdn√° j√°ma', icon: 'üï≥Ô∏è', type: 'empty', zone: 'medium', x: 0, y: -4, desc: 'Hlubok√° d√≠ra v zemi.' },
            
            // St≈ôedn√≠ z√≥na - jih
            { id: 'empty_15', name: 'Sp√°leni≈°tƒõ', icon: 'üî•', type: 'empty', zone: 'medium', x: 1, y: 3, desc: 'Sp√°len√° zemƒõ.' },
            { id: 'empty_16', name: 'Rezav√Ω plot', icon: 'üöß', type: 'empty', zone: 'medium', x: -1, y: 3, desc: 'Star√Ω kovov√Ω plot.' },
            { id: 'empty_17', name: 'Rozpadl√° zeƒè', icon: 'üß±', type: 'empty', zone: 'medium', x: 1, y: 4, desc: 'Zbytky cihlov√© zdi.' },
            { id: 'empty_18', name: 'Bahnit√° lou≈æe', icon: 'üíß', type: 'empty', zone: 'medium', x: -1, y: 4, desc: '≈†pinav√° voda.' },
            { id: 'empty_19', name: 'Opu≈°tƒõn√° ≈°achta', icon: '‚¨õ', type: 'empty', zone: 'medium', x: 0, y: 4, desc: 'Zasypan√© dno.' },
            
            // St≈ôedn√≠ z√≥na - z√°pad
            { id: 'empty_20', name: 'Pr√°zdn√Ω parking', icon: 'üÖøÔ∏è', type: 'empty', zone: 'medium', x: -2, y: 0, desc: 'Opu≈°tƒõn√© parkovi≈°tƒõ.' },
            { id: 'empty_21', name: 'Rozbit√Ω billboard', icon: 'üìã', type: 'empty', zone: 'medium', x: -4, y: 0, desc: 'Vybledl√° reklama.' },
            { id: 'empty_22', name: 'Opu≈°tƒõn√° zast√°vka', icon: 'üöè', type: 'empty', zone: 'medium', x: -4, y: 1, desc: 'Autobusov√° zast√°vka.' },
            { id: 'empty_23', name: 'Rozbit√Ω st√°nek', icon: 'üè™', type: 'empty', zone: 'medium', x: -4, y: -1, desc: 'Pr√°zdn√Ω kiosk.' },
            { id: 'empty_24', name: '≈Ωelezn√Ω ≈°rot', icon: '‚öôÔ∏è', type: 'empty', zone: 'medium', x: -6, y: 0, desc: 'Hromada kovu.' },
            
            // St≈ôedn√≠ z√≥na - v√Ωchod
            { id: 'empty_25', name: 'Such√° studna', icon: 'ü™£', type: 'empty', zone: 'medium', x: 4, y: 0, desc: 'Pr√°zdn√° studna.' },
            { id: 'empty_26', name: 'Star√© pneumatiky', icon: '‚≠ï', type: 'empty', zone: 'medium', x: 4, y: 1, desc: 'Hromada gum.' },
            { id: 'empty_27', name: 'Rozbit√° br√°na', icon: 'üö™', type: 'empty', zone: 'medium', x: 4, y: -1, desc: 'Zniƒçen√° vrata.' },
            { id: 'empty_28', name: 'Opu≈°tƒõn√° bouda', icon: 'üõñ', type: 'empty', zone: 'medium', x: 6, y: 0, desc: 'Pr√°zdn√° chatrƒç.' },
            { id: 'empty_29', name: 'Zrezivƒõl√Ω tank', icon: 'ü™ñ', type: 'empty', zone: 'medium', x: 6, y: 1, desc: 'Vrak tanku.' },
            
            // Nebezpeƒçn√° z√≥na - rohy
            { id: 'empty_30', name: 'Toxick√° lou≈æe', icon: '‚ò¢Ô∏è', type: 'empty', zone: 'danger', x: 2, y: -6, desc: 'Radioaktivn√≠ voda.', radiation: 3 },
            { id: 'empty_31', name: 'Sp√°len√Ω les', icon: 'üî•', type: 'empty', zone: 'danger', x: -2, y: -6, desc: 'Oho≈ôel√© kmeny.' },
            { id: 'empty_32', name: 'Kost≈ôice', icon: 'üíÄ', type: 'empty', zone: 'danger', x: 2, y: 6, desc: 'Poz≈Østatky obƒõt√≠.' },
            { id: 'empty_33', name: 'Jed. oblak', icon: 'üí®', type: 'empty', zone: 'danger', x: -2, y: 6, desc: 'Toxick√Ω plyn.', radiation: 5 },
            { id: 'empty_34', name: 'Zniƒçen√Ω konvoj', icon: 'üöõ', type: 'empty', zone: 'danger', x: -6, y: 3, desc: 'Rozst≈ô√≠len√© kamiony.' },
            { id: 'empty_35', name: 'Vybuchl√° stanice', icon: '‚õΩ', type: 'empty', zone: 'danger', x: -6, y: -3, desc: 'Ruiny benz√≠nky.' },
            { id: 'empty_36', name: 'Masov√Ω hrob', icon: '‚ö∞Ô∏è', type: 'empty', zone: 'danger', x: 6, y: 3, desc: 'Dƒõsiv√© m√≠sto.' },
            { id: 'empty_37', name: 'Zamo≈ôen√° z√≥na', icon: '‚ò£Ô∏è', type: 'empty', zone: 'danger', x: 6, y: -3, desc: 'Chemick√Ω √∫nik.', radiation: 5 },
            
            // Smrteln√° z√≥na - okraje
            { id: 'empty_38', name: 'Kr√°ter bomby', icon: 'üí•', type: 'empty', zone: 'deadly', x: 0, y: -8, desc: 'M√≠sto dopadu.', radiation: 15 },
            { id: 'empty_39', name: 'Mrtv√° z√≥na', icon: '‚ò†Ô∏è', type: 'empty', zone: 'deadly', x: 0, y: 8, desc: 'Nic tu ne≈æije.', radiation: 20 },
            { id: 'empty_40', name: 'Rozpadl√Ω most', icon: 'üåâ', type: 'empty', zone: 'deadly', x: -8, y: 0, desc: 'Z≈ô√≠cen√Ω p≈ôechod.' },
            { id: 'empty_41', name: 'Atomov√© ruiny', icon: '‚ò¢Ô∏è', type: 'empty', zone: 'deadly', x: 8, y: 0, desc: 'Siln√° radiace.', radiation: 20 },
            { id: 'empty_42', name: 'Vyp√°len√° vesnice', icon: 'üèöÔ∏è', type: 'empty', zone: 'deadly', x: -8, y: -4, desc: 'Jen popel.' },
            { id: 'empty_43', name: 'Opu≈°tƒõn√Ω sklad', icon: 'üì¶', type: 'empty', zone: 'deadly', x: 8, y: 4, desc: 'Pr√°zdn√© reg√°ly.' },
            { id: 'empty_44', name: 'Z≈ô√≠cen√° vƒõ≈æ', icon: 'üóº', type: 'empty', zone: 'deadly', x: -4, y: -7, desc: 'Zbytky ant√©ny.' },
            { id: 'empty_45', name: 'Zasypan√© metro', icon: 'üöá', type: 'empty', zone: 'deadly', x: 4, y: 7, desc: 'Zavalen√Ω vchod.' },
            
            // === FRAKƒåN√ç LOKACE ===
            { id: 'bazaar', name: 'Velk√Ω bazar', icon: 'üè™', type: 'faction', zone: 'medium', x: 6, y: 2,
              desc: 'Hlavn√≠ tr≈æi≈°tƒõ Obchodn√≠ gildy. Nejlep≈°√≠ ceny a vz√°cn√© zbo≈æ√≠.', 
              faction: 'traders', enemies: [], dangerLevel: 0 },
            { id: 'bunker', name: 'Vƒõdeck√Ω bunkr', icon: 'üî¨', type: 'faction', zone: 'danger', x: -6, y: -5,
              desc: 'Tajn√° laborato≈ô Vƒõdc≈Ø Enkl√°vy. Pokroƒçil√Ω v√Ωzkum a technologie.',
              faction: 'scientists', enemies: ['robot', 'experiment'], dangerLevel: 3, radiation: 5 },
            { id: 'mutant_village', name: 'Mutant√≠ vesnice', icon: '‚ò£Ô∏è', type: 'faction', zone: 'danger', x: -6, y: 6,
              desc: 'Osada Mutant√≠ho kmene. P≈ôekvapivƒõ m√≠rumilovn√≠... pokud je nerozƒç√≠l√≠≈°.',
              faction: 'mutants', enemies: [], dangerLevel: 2, radiation: 10 },
            { id: 'toxic_zone', name: 'Toxick√° z√≥na', icon: '‚ò¢Ô∏è', type: 'faction', zone: 'deadly', x: -8, y: 5,
              desc: '√özem√≠ ovl√°dan√© mutanty. Extr√©mn√≠ radiace, ale cenn√© suroviny.',
              faction: 'mutants', enemies: ['mutant', 'toxic_beast'], dangerLevel: 5, radiation: 25 },
            { id: 'checkpoint', name: 'Vojensk√Ω checkpoint', icon: 'üéñÔ∏è', type: 'faction', zone: 'medium', x: 3, y: -5,
              desc: 'Hl√≠dkov√© stanovi≈°tƒõ Vojensk√©ho remnantu. Discipl√≠na a po≈ô√°dek.',
              faction: 'military', enemies: [], dangerLevel: 1 },
            
            // === TAJN√Å LOKACE - odhalena Z√°hadnou ≈æenou ===
            { id: 'ancient_vault', name: 'Starovƒõk√Ω trezor', icon: 'üèõÔ∏è', type: 'dungeon', zone: 'deadly', x: 8, y: -7,
              desc: 'Prad√°vn√Ω trezor pln√Ω poklad≈Ø a nebezpeƒç√≠. Odhaleno Z√°hadnou ≈æenou.',
              enemies: ['robot', 'sentinel', 'ancient_guardian'], dangerLevel: 5, radiation: 15,
              secret: true, loot: ['legendary', 'rare', 'tech'] },
            
            // Dal≈°√≠ v√Ωpl≈à pro hustotu
            { id: 'empty_46', name: 'Star√Ω kan√°l', icon: 'üö∞', type: 'empty', zone: 'medium', x: 2, y: -2, desc: 'Vyschl√Ω odtok.' },
            { id: 'empty_47', name: 'Rozbit√Ω hang√°r', icon: 'üèóÔ∏è', type: 'empty', zone: 'medium', x: -3, y: -3, desc: 'Pr√°zdn√° hala.' },
            { id: 'empty_48', name: 'Kovov√Ω odpad', icon: 'üóëÔ∏è', type: 'empty', zone: 'medium', x: 4, y: 3, desc: 'Hromada odpadu.' },
            { id: 'empty_49', name: 'Opu≈°tƒõn√Ω bunkr', icon: 'üö™', type: 'empty', zone: 'medium', x: -3, y: 3, desc: 'Zabetonovan√Ω vchod.' },
            { id: 'empty_50', name: 'Zniƒçen√° silnice', icon: 'üõ£Ô∏è', type: 'empty', zone: 'medium', x: 3, y: -3, desc: 'Rozbit√Ω asfalt.' }
        ];
        
        // === PVP FRAKƒåN√ç SYST√âM ===
        const PVP_FACTIONS = {
            kory: { 
                id: 'kory', 
                name: 'Koryho n√°sledovn√≠ci', 
                icon: 'üî¥', 
                color: '#e53935', 
                colorLight: '#ff6659',
                desc: 'Chaos a destrukce. Star√Ω svƒõt mus√≠ sho≈ôet!',
                bonus: { damage: 0.05 } // +5% damage
            },
            koudy: { 
                id: 'koudy', 
                name: 'Koudyho nadƒõje', 
                icon: 'üîµ', 
                color: '#1e88e5', 
                colorLight: '#6ab7ff',
                desc: '≈ò√°d a vƒõda. Zachr√°n√≠me lidstvo!',
                bonus: { xp: 0.05 } // +5% XP
            },
            independent: { 
                id: 'independent', 
                name: 'Nez√°visl√≠', 
                icon: 'üü£', 
                color: '#9c27b0', 
                colorLight: '#ce93d8',
                desc: 'Svoboda a neutralita. Nikomu nedlu≈æ√≠me!',
                bonus: { loot: 0.05 } // +5% loot chance
            }
        };
        
        // Helper funkce pro z√≠sk√°n√≠ n√°zvu a popisu lokace
        function getLocName(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            return loc ? loc.name : locId;
        }
        
        function getLocDesc(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            return loc ? (loc.desc || '') : '';
        }
        
        // Helper funkce pro z√≠sk√°n√≠ n√°zvu crafting receptu
        function getCraftingName(recipeId) {
            const recipe = CRAFTING.find(r => r.id === recipeId);
            return recipe ? recipe.name : recipeId;
        }
        
        // Helper funkce pro z√≠sk√°n√≠ celkov√©ho poƒçtu suroviny (invent√°≈ô hr√°ƒçe + sklad osady)
        function getTotalResource(resourceId, includeSettlement = true) {
            const playerAmount = state.resources[resourceId] || 0;
            if (!includeSettlement) return playerAmount;
            const settlementAmount = state.settlement?.resources?.[resourceId] || 0;
            return playerAmount + settlementAmount;
        }
        
        // Helper funkce pro z√≠sk√°n√≠ n√°zvu osadn√≠ka
        function getSettlerName(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            return type ? type.name : typeId;
        }
        
        // Helper funkce pro z√≠sk√°n√≠ n√°zvu vlny n√°jezdu
        function getRaidWaveName(waveNumber) {
            const waveNames = ['Prvn√≠ vlna', 'Druh√° vlna', 'T≈ôet√≠ vlna', 'ƒåtvrt√° vlna', 'P√°t√° vlna', '≈†est√° vlna'];
            return waveNames[waveNumber - 1] || `Vlna ${waveNumber}`;
        }
        
        // Funkce pro v√Ωpoƒçet vzd√°lenosti v km mezi dvƒõma lokacemi
        function getDistanceKm(loc1, loc2) {
            const dx = (loc2.x - loc1.x) * GRID_SIZE_KM;
            const dy = (loc2.y - loc1.y) * GRID_SIZE_KM;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // Funkce pro v√Ωpoƒçet Z√ÅKLADN√çHO ƒçasu cesty (bez vozidla - to se poƒç√≠t√° pozdƒõji)
        function getBaseTravelTime(loc1, loc2) {
            const distKm = getDistanceKm(loc1, loc2);
            let timeMin = distKm * WALK_SPEED_MIN_PER_KM;
            
            // Zpomalen√≠ v nebezpeƒçn√Ωch z√≥n√°ch (opatrnost)
            if (loc2.zone === 'danger') timeMin *= 1.2;
            if (loc2.zone === 'deadly') timeMin *= 1.5;
            
            return Math.ceil(timeMin);
        }
        
        // Funkce pro z√≠sk√°n√≠ sousedn√≠ch lokac√≠ (max vzd√°lenost 3 km)
        function getAdjacentLocations(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            if (!loc) return [];
            
            return WORLD_LOCATIONS.filter(l => {
                if (l.id === locId) return false;
                const dist = getDistanceKm(loc, l);
                return dist <= 8; // Max 8 km pro p≈ô√≠mou cestu
            }).sort((a, b) => getDistanceKm(loc, a) - getDistanceKm(loc, b)); // Se≈ôadit podle vzd√°lenosti
        }
        
        // Generov√°n√≠ cest dynamicky
        function generatePaths() {
            const paths = [];
            
            WORLD_LOCATIONS.forEach(loc => {
                const neighbors = getAdjacentLocations(loc.id);
                neighbors.forEach(neighbor => {
                    // Zkontroluj jestli cesta u≈æ neexistuje
                    const exists = paths.some(p => 
                        (p.from === loc.id && p.to === neighbor.id) ||
                        (p.from === neighbor.id && p.to === loc.id)
                    );
                    
                    if (!exists) {
                        const distKm = getDistanceKm(loc, neighbor);
                        const timeMin = getBaseTravelTime(loc, neighbor);
                        const dangerLevel = Math.max(
                            loc.zone === 'deadly' ? 5 : loc.zone === 'danger' ? 3 : loc.zone === 'medium' ? 1 : 0,
                            neighbor.zone === 'deadly' ? 5 : neighbor.zone === 'danger' ? 3 : neighbor.zone === 'medium' ? 1 : 0
                        );
                        
                        paths.push({
                            from: loc.id,
                            to: neighbor.id,
                            distance: Math.round(distKm * 10) / 10, // Vzd√°lenost v km (1 desetinn√© m√≠sto)
                            time: timeMin, // ƒåas v minut√°ch (z√°kladn√≠, bez vozidla)
                            danger: dangerLevel,
                            name: loc.name + ' ‚Üí ' + neighbor.name
                        });
                    }
                });
            });
            
            return paths;
        }
        
        const WORLD_PATHS = generatePaths();
        
        // === EVENTY NA CEST√ÅCH ===
        const TRAVEL_EVENTS = [
            // === POZITIVN√ç EVENTY ===
            { id: 'find_loot', name: 'N√°lez!', icon: 'üéÅ', type: 'loot', chance: 0.20,
              text: 'Na cestƒõ vid√≠≈° nƒõco lesknouc√≠ho se v tr√°vƒõ...' },
            { id: 'friendly_trader', name: 'Potuln√Ω obchodn√≠k', icon: 'üß≥', type: 'trader', chance: 0.08,
              text: 'Potk√°v√°≈° potuln√©ho obchodn√≠ka s batohem pln√Ωm zbo≈æ√≠.' },
            { id: 'hidden_cache', name: 'Skryt√° skr√Ω≈°', icon: 'üì¶', type: 'cache', chance: 0.06,
              text: 'V≈°imne≈° si nen√°padn√©ho vstupu do skryt√© skr√Ω≈°e!' },
            { id: 'injured_survivor', name: 'Zranƒõn√Ω p≈ôe≈æiv≈°√≠', icon: 'ü§ï', type: 'choice', chance: 0.10,
              text: 'Na cestƒõ le≈æ√≠ zranƒõn√Ω ƒçlovƒõk. Pom≈Ø≈æe≈° mu?' },
            
            // === J√çDLO/PIT√ç - SN√ç≈ΩEN√â ≈†ANCE, MEN≈†√ç HODNOTY ===
            { id: 'water_source', name: 'ƒåist√Ω pramen', icon: 'üíß', type: 'resource', chance: 0.03,
              text: 'Nach√°z√≠≈° mal√Ω pramen ƒçist√© vody!' },
            { id: 'dirty_puddle', name: 'Kaln√° lou≈æe', icon: 'üí¶', type: 'dirty_water', chance: 0.06,
              text: 'Nach√°z√≠≈° kalnou lou≈æi. Riskne≈° napit√≠?' },
            { id: 'food_scraps', name: 'Zbytky j√≠dla', icon: 'üçñ', type: 'food_scraps', chance: 0.05,
              text: 'Nach√°z√≠≈° nap≈Øl snƒõden√© konzervy a zbytky j√≠dla.' },
            
            { id: 'herb_patch', name: 'Pole bylin', icon: 'üåø', type: 'resource', chance: 0.10,
              text: 'Naraz√≠≈° na m√≠sto porostl√© l√©ƒçiv√Ωmi bylinami.' },
            { id: 'abandoned_vehicle', name: 'Opu≈°tƒõn√© vozidlo', icon: 'üöó', type: 'explore', chance: 0.05,
              text: 'U cesty stoj√≠ opu≈°tƒõn√© auto. Mo≈æn√° je v nƒõm nƒõco u≈æiteƒçn√©ho.' },
            
            // === SPOLEƒåN√çCI ===
            { id: 'stray_dog', name: 'Zatoulan√Ω pes', icon: 'üêï', type: 'companion', chance: 0.12,
              text: 'Z k≈ôov√≠ vyl√©z√° vychrtl√Ω pes a prosebnƒõ na tebe hled√≠.', 
              firstOnly: true, companionId: 'dog' },
            { id: 'lost_cat', name: 'Zatoulan√° koƒçka', icon: 'üêà', type: 'companion', chance: 0.08,
              text: 'Naraz√≠≈° na koƒçku, kter√° se k tobƒõ p≈ôitul√≠.',
              firstOnly: true, companionId: 'cat' },
            { id: 'injured_crow', name: 'Zranƒõn√Ω havran', icon: 'ü¶Ö', type: 'companion', chance: 0.05,
              text: 'Na zemi le≈æ√≠ zranƒõn√Ω havran. Vyl√©ƒç√≠≈° ho?',
              firstOnly: true, companionId: 'crow' },
            
            // === NEGATIVN√ç EVENTY ===
            { id: 'ambush', name: 'P≈ôepaden√≠!', icon: 'üí•', type: 'combat', chance: 0.18,
              text: 'Z √∫krytu vyskoƒçili nep≈ô√°tel√©!' },
            { id: 'trap', name: 'Past!', icon: 'ü™§', type: 'trap', chance: 0.08,
              text: '≈†l√°pne≈° do pasti!' },
            { id: 'rad_storm', name: 'Radiaƒçn√≠ bou≈ôe', icon: '‚ò¢Ô∏è', type: 'radiation', chance: 0.06,
              text: 'Obloha se zbarvila do zelena. Radiaƒçn√≠ bou≈ôe!' },
            { id: 'breakdown', name: 'Vyƒçerp√°n√≠', icon: 'üò∞', type: 'exhaustion', chance: 0.12,
              text: 'Cesta tƒõ vyƒçerp√°v√° v√≠c ne≈æ jsi ƒçekal.' },
            { id: 'spoiled_food', name: 'Zka≈æen√© j√≠dlo', icon: 'ü§¢', type: 'sickness', chance: 0.05,
              text: 'Nƒõco ti nesedlo v ≈æaludku...' },
            { id: 'thief', name: 'Zlodƒõj!', icon: 'ü•∑', type: 'theft', chance: 0.04,
              text: 'Nƒõkdo tƒõ okradl, zat√≠mco jsi nebyl ve st≈ôehu!' },
            
            // === NEUTR√ÅLN√ç/VOLBA ===
            { id: 'strange_noise', name: 'Podivn√Ω zvuk', icon: 'üëÇ', type: 'choice', chance: 0.12,
              text: 'Sly≈°√≠≈° podivn√Ω zvuk z k≈ôov√≠. Prozkoum√°≈° to?' },
            { id: 'shortcut', name: 'Zkratka', icon: 'üõ§Ô∏è', type: 'choice', chance: 0.08,
              text: 'Vid√≠≈° mo≈ænou zkratku, ale vypad√° nebezpeƒçnƒõ.' },
            { id: 'abandoned_camp', name: 'Opu≈°tƒõn√Ω t√°bor', icon: 'üèïÔ∏è', type: 'explore', chance: 0.10,
              text: 'Naraz√≠≈° na ƒçerstvƒõ opu≈°tƒõn√Ω t√°bor.' },
            { id: 'mysterious_stranger', name: 'Z√°hadn√Ω cizinec', icon: 'üß•', type: 'choice', chance: 0.05,
              text: 'Potk√°v√°≈° z√°hadn√©ho cizince v kapuci. Promluv√≠ s tebou?' },
            { id: 'hidden_bunker_entrance', name: 'Skryt√Ω vchod do bunkru', icon: 'üö™', type: 'explore', chance: 0.03,
              text: 'V≈°imne≈° si zamaskovan√©ho vchodu do bunkru.' },
            { id: 'campfire_remains', name: 'Zbytky ohni≈°tƒõ', icon: 'üî•', type: 'rest', chance: 0.04,
              text: 'Nach√°z√≠≈° zbytky ned√°vn√©ho ohni≈°tƒõ. M≈Ø≈æe≈° si kr√°tce odpoƒçinout.' }
        ];
        
        // Pomocn√° funkce pro z√≠sk√°n√≠ companion dat
        function getCompanionData(companionId) {
            return COMPANIONS.find(c => c.id === companionId);
        }
        
        // === MULTIPLAYER GLOBAL VARIABLES ===
        let firebaseApp = null;
        let firebaseDB = null;
        let firebaseAuth = null;
        let currentUser = null; // P≈ôihl√°≈°en√Ω u≈æivatel
        let isGuest = true; // Hraje jako host?
        let multiplayerEnabled = false;
        let chatMessages = [];
        let marketplaceOffers = [];
        let pvpChallenges = [];
        let chatListener = null;
        let privateMessages = {}; // Soukrom√© zpr√°vy
        let unreadPMCount = 0; // Poƒçet nep≈ôeƒçten√Ωch soukrom√Ωch zpr√°v (glob√°ln√≠)
        let friendsList = []; // Seznam p≈ô√°tel
        let friendRequests = []; // ≈Ω√°dosti o p≈ô√°telstv√≠
        
        // === XP KONSTANTA ===
        // xpNeed = 350 + (level * 50)
        // Level 1‚Üí2: 400 XP, Level 2‚Üí3: 450 XP, atd.
        
        // === STATE ===
        let state = {
            char: { name: '', gender: null, level: 1, xp: 0, xpNeed: 400, totalXP: 0, classId: null, points: 10, levelUpPoints: 0, skillPoints: 0,
                    hp: 100, maxHp: 100, attrs: { str: 5, int: 5, agi: 5, per: 5, end: 5, lck: 5 },
                    abilityLastUsed: 0 }, // Cooldown pro speci√°ln√≠ schopnost
            status: { hunger: 100, thirst: 100, energy: 100, mood: 100, radiation: 0 },
            time: { gameStart: Date.now(), realStart: Date.now(), last: Date.now(), days: 0, hours: 0, mins: 0, totalElapsed: 0 },
            
            // === NOV√ù WORLD SYST√âM ===
            world: {
                currentLocation: 'shelter',
                visitedLocations: ['shelter'],
                unlockedPaths: [],
                discoveredSecrets: [],
                traveling: false,
                travelTo: null,
                travelPath: null,
                travelStart: 0,
                travelDuration: 0,
                travelProgress: 0,
                pendingEvent: null,
                locationCooldowns: {},
                exploredRooms: {},
                bossesDefeated: [],
                questItems: {}, // Quest itemy na lokac√≠ch
                groundLoot: {} // P≈ôedmƒõty na zemi (lokace -> [items])
            },
            
            // Minim√°ln√≠ zpƒõtn√° kompatibilita (pouze pro star√© ulo≈æen√© hry)
            map: { inBase: true, traveling: false },
            
            inv: [
                // Prvn√≠ kniha - nalezen√° v √∫krytu
                { id: 'lore_1', name: 'Den√≠k vƒõdce I', icon: 'üìï', type: 'lore', weight: 0, price: 0, rarity: 'rare' }
            ],
            equipped: {
                weapon: null,
                armor: null,
                gloves: null,
                boots: null
            },
            starterToolChosen: false, // Flag pro v√Ωbƒõr poƒç√°teƒçn√≠ho n√°stroje
            money: 0, // üí∞ Mƒõna
            carryWeight: 0,
            maxCarryWeight: 50,
            lastSleepTime: 0, // Track when player last slept
            sleepEndTime: null, // When sleep will end
            isSleeping: false, // Player is currently sleeping
            currentAction: null, // Current timed action (hunt, mine, fish, explore)
            resources: { 
                wood: 0,      // üå≤ D≈ôevo - z√°kladn√≠
                metal: 0,     // ‚öôÔ∏è Kov - z√°kladn√≠
                stone: 0,     // ü™® K√°men - z√°kladn√≠
                cloth: 0,     // üßµ L√°tka - z√°kladn√≠
                fuel: 0,      // ‚õΩ Palivo - pro vozidla
                leather: 0,   // ü¶¥ K≈Ø≈æe - ze zv√≠≈ôat
                herbs: 0,     // üåø Byliny - pro lektvary
                chemicals: 0, // üß™ Chemik√°lie - pro pokroƒçil√©
                electronics: 0, // üíæ Elektronika - vz√°cn√©
                glass: 0,     // üîÆ Sklo - pro optiku
                rope: 0,      // ‚û∞ Provaz - pro crafting
                gunpowder: 0, // üí• St≈ôeln√Ω prach - pro munici
                scrap: 0,     // üóëÔ∏è ≈†rot - z ruin
                copper: 0,     // üî∂ Mƒõƒè - pro elektroniku
                silver: 0,    // ‚¨ú St≈ô√≠bro - pro ≈°perky
                gold: 0,      // üü° Zlato - pro luxusn√≠ vƒõci
                crystal: 0,   // üí† Krystal - pro magick√© vƒõci
                acid: 0,      // üü¢ Kyselina - z mutant≈Ø
                fur: 0,       // ü¶ä Ko≈æe≈°ina - ze zv√≠≈ôat
                mutant_blood: 0, // ü©∏ Mutant√≠ krev
                raw_meat: 0,  // ü•© Syrov√© maso
                fish: 0       // üêü Ryba
            },
            baseStorage: { food: 0, water: 0 },
            baseCapacity: 40,
            baseItems: [],
            base: ['wall'],
            buildQueue: [], // Fronta budov ve stavbƒõ
            skills: {},
            stats: { 
                kills: 0, deaths: 0, travelled: 0, itemsCrafted: 0, totalMoneyEarned: 0,
                bossKills: 0, flawlessWins: 0, maxCombo: 0, treasuresFound: 0,
                nearDeathExp: 0, maxRadiation: 0, itemsSold: 0, legendaryFound: 0,
                pacifistDays: 0, radstormsSurvived: 0, lastKillDay: -1,
                chatMessagesSent: 0, // Poƒçet odeslan√Ωch zpr√°v v chatu
                // Combat tracking
            },
            achievements: [],
            readBooks: [],
            casinoTokens: 1000,
            casinoLastTokenDay: 0,
            casinoLastTokenTime: Date.now(), // Nastavit na teƒè, aby nedostal bonus hned po startu
            lastFreeHerbs: Date.now(), // ƒåas posledn√≠ch bylin od Marty - nastavit na teƒè aby nedostal hned
            dailyQuests: {
                lastReset: 0,
                quests: [],
                completed: [],
                progress: {
                    kills: 0,
                    explored: 0,
                    crafted: 0,
                    moneyEarned: 0,
                    travelled: 0
                }
            },
            diary: '',
            log: [],
            traderQuests: [], // √ökoly od obchodn√≠k≈Ø
            confirmed: false,
            activeTab: 'multiplayer',
            craftFilter: 'all', // Filtr pro crafting
            lootFilter: {
                // Auto-loot filtr - co sb√≠rat automaticky
                consumables: true,
                weapons: true,
                armor: true,
                ammo: true,
                resources: true,
                tools: true,
                minRarity: 'common' // common, uncommon, rare, epic, legendary
            },
            buildingCooldowns: {
                // Track last visit timestamp for special buildings
                hospitals: {}, // { "q,r": timestamp }
                workshops: {}, // { "q,r": timestamp }
                factories: {}  // { "q,r": timestamp }
            },
            shopMoney: {
                // Denn√≠ limit penƒõz obchodn√≠k≈Ø { locationId: { money: number, lastReset: timestamp } }
            },
            settlement: {
                level: 1,
                prosperity: 10, // Zaƒç√≠n√°me s malou prosperitou d√≠ky budov√°m
                settlers: [], // Array of settler objects with { id, type, name, hp, maxHp, morale, skill, assignedTo }
                buildings: ['garden', 'water'], // Zaƒç√≠n√°me se zahradou a sbƒõraƒçem vody
                lastRaid: 0, // Timestamp of last raid
                resources: { 
                    food: 3, water: 3, fuel: 0,
                    // Suroviny ve skladu osady
                    wood: 0, metal: 0, stone: 0, cloth: 0, leather: 0,
                    herbs: 0, chemicals: 0, electronics: 0, glass: 0,
                    rope: 0, gunpowder: 0, scrap: 0, copper: 0
                },
                power: { produced: 0, consumed: 0, stored: 0, maxStorage: 20 }, // Elektrick√Ω syst√©m
                defense: 0, // Total defense value
                morale: 50, // 0-100 celkov√° mor√°lka osady
                specialization: null, // Vybran√° specializace
                activeEvent: null, // Aktu√°ln√≠ ud√°lost
                lastEventCheck: 0, // Posledn√≠ kontrola ud√°lost√≠
                visitingMerchant: null, // Obchodn√≠k na n√°v≈°tƒõvƒõ { until: timestamp, items: [] }
                activeQuests: [], // Aktivn√≠ mise od osadn√≠k≈Ø
                completedQuests: [], // Dokonƒçen√© mise
                raidWave: 0, // Aktu√°ln√≠ vlna p≈ôi raidu
                lastDailyUpdate: 0, // Posledn√≠ denn√≠ aktualizace
                firstVisit: true, // Pro zobrazen√≠ v√Ωbƒõru prvn√≠ho osadn√≠ka
                raidCooldown: 0, // ƒåas do dal≈°√≠ho mo≈æn√©ho n√°jezdu
                raidsDefended: 0, // Poƒçet odra≈æen√Ωch n√°jezd≈Ø
                eventLog: [] // Historie ud√°lost√≠ osady
            },
            // === DUNGEON SYST√âM ===
            dungeon: {
                active: null, // ID aktivn√≠ho dungeonu
                floor: 0, // Aktu√°ln√≠ patro (0 = p≈ô√≠zem√≠)
                maxFloor: 0, // Nejhlub≈°√≠ dosa≈æen√© patro
                cleared: {}, // { dungeonId: { floors: [clearedFloors], clearedAt: timestamp } }
                loot: [] // Nasb√≠ran√Ω loot v dungeonu
            },
            // === NPC VZTAHY ===
            npcRelations: {
                // { npcId: { trust: 0-100, gifts: 0, quests: 0, lastTalk: timestamp } }
            },
            npcQuests: {}, // Aktivn√≠ questy od NPC { npcId: { id: questId, startKills, startExplored, completed: [] } }
            npcTrust: {}, // D≈Øvƒõra u NPC { npcId: number }
            // === NOV√â SYST√âMY ===
            weather: {
                current: 'sunny',
                lastChange: Date.now(),
                duration: 3600000 // 1 hodina v ms
            },
            companions: [], // [{ id, hp, maxHp }]
            treasureLocation: null, // { q, r } - m√≠sto pokladu z mapy
            equippedAccessory: null, // ID nasazen√©ho dopl≈àku (prsten, amulet, atd.)
            weaponCoating: null, // { effect: 'poison'/'fire', uses: 5 }
            combatBonuses: { // Doƒçasn√© bonusy
                damageBonus: 0,
                defenseBonus: 0,
                expires: 0
            },
            // === DAL≈†√ç NOV√â SYST√âMY ===
            factions: { // Reputace s frakcemi (-100 a≈æ +100)
                traders: 0,
                scientists: 0,
                raiders: -20, // Zaƒç√≠n√°me trochu nep≈ô√°telsky s bandity
                mutants: 0,
                military: 0
            },
            mutations: [], // Pole aktivn√≠ch mutac√≠
            buffs: [], // Doƒçasn√© buffy [{ id, value, expires }]
            stashes: {}, // Skr√Ω≈°e na mapƒõ { "q,r": [items] }
            horde: {
                active: false,
                wave: 0,
                lastHorde: 0, // Timestamp posledn√≠ hordy
                nextHorde: Date.now() + 86400000 // Za 1 den
            },
            radio: {
                hasRadio: false,
                messages: [],
                lastMessage: 0
            },
            skills_secondary: { // Sekund√°rn√≠ skilly
                fishing: 0,
                mining: 0,
                hunting: 0,
                cooking: 0,
                alchemy: 0
            },
            // === HLAVN√ç P≈ò√çBƒöH ===
            mainQuest: {
                currentQuest: 'intro',
                completedQuests: [],
                questProgress: {},
                npcMet: [],
                storyComplete: false,
                chapter: 0
            },
            // === CUSTOMIZACE ===
            appearance: {
                hairstyle: 'short',
                hairColor: 'brown',
                skinTone: 'medium',
                outfit: 'survivor',
                title: 'P≈ôe≈æiv≈°√≠'
            },
            badges: [],
            unlockedOutfits: ['survivor'],
            unlockedTitles: ['survivor'],
            // === SKILL TREE ===
            skillTree: {
                combat: {},
                defense: {},
                survival: {},
                exploration: {},
                crafting: {}
            },
            skillTreePoints: 0,
            // === STORY KARMA SYST√âM - Kory vs Koudy ===
            storyKarma: {
                kory: 0,   // -100 a≈æ +100, karma u Koryho
                koudy: 0,  // -100 a≈æ +100, karma u Koudyho
                componentsGiven: { kory: 0, koudy: 0 }, // Kolik komponent≈Ø d√°no komu
                ending: null // 'dark', 'hope', 'neutral'
            }
        };
        
        // Helper functions
        function updateCarryWeight() {
            state.carryWeight = 0;
            
            // Invent√°≈ô - pouze p≈ôedmƒõty, NE suroviny (ty jsou v osadƒõ/skladu)
            state.inv.forEach(item => {
                state.carryWeight += (item.weight || 0) * (item.count || 1);
            });
            
            // P≈ôiƒçti v√°hu item≈Ø vystaven√Ωch na tr≈æi≈°ti (dokud se neprodaj√≠, st√°le je "nese≈°")
            const myName = getPlayerName();
            if (typeof marketplaceOffers !== 'undefined' && marketplaceOffers) {
                marketplaceOffers.forEach(offer => {
                    if (offer.seller === myName && offer.status === 'active') {
                        const itemWeight = offer.item?.weight || 0;
                        const itemCount = offer.count || offer.item?.count || 1;
                        state.carryWeight += itemWeight * itemCount;
                    }
                });
            }
            
            // Nosnost: z√°klad 50kg + 5kg za ka≈æd√Ω bod s√≠ly nad 5 + batoh + skill + exoskelet
            const strBonus = Math.max(0, (state.char.attrs?.str || 5) - 5) * 5; // +5kg za ka≈æd√Ω bod s√≠ly nad 5
            const backpack = state.inv.find(i => i.id === 'backpack');
            const backpackBonus = backpack ? 20 : 0;
            // Skill K≈ôeƒçek - hledej v skillTree i v star√©m syst√©mu
            const packRatLevel = state.skillTree?.survival?.pack_rat || state.skills?.['pack_rat'] || getSkillLevel('pack_rat') || 0;
            const skillBonus = packRatLevel * 10;
            
            // Exoskelet bonus (+50% nosnost)
            const boots = state.equipped?.boots;
            const exoBonus = (boots?.special === 'exo') ? 0.5 : 0;
            
            const baseCapacity = 50 + strBonus + backpackBonus + skillBonus;
            state.maxCarryWeight = Math.floor(baseCapacity * (1 + exoBonus));
        }
        
        // Wrapper funkce pro kompatibilitu
        function calculateCurrentWeight() {
            updateCarryWeight();
            return state.carryWeight || 0;
        }
        
        // Glow efekt pro rare itemy
        function addRareGlow(element, rarity) {
            const glowColors = {
                common: 'none',
                uncommon: '0 0 5px rgba(76, 175, 80, 0.5)',
                rare: '0 0 10px rgba(33, 150, 243, 0.7)',
                epic: '0 0 15px rgba(156, 39, 176, 0.8)',
                legendary: '0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.5)'
            };
            
            if (glowColors[rarity]) {
                element.style.boxShadow = glowColors[rarity];
            }
        }
        
        // Damage flash efekt
        function damageFlash() {
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 0, 0, 0.3);
                pointer-events: none;
                z-index: 9995;
                animation: damageFlashAnim 0.2s ease-out forwards;
            `;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 200);
        }
        
        // Heal flash efekt
        function healFlash() {
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(76, 175, 80, 0.2);
                pointer-events: none;
                z-index: 9995;
                animation: damageFlashAnim 0.3s ease-out forwards;
            `;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
        }
        
        function calculateMaxWeight() {
            updateCarryWeight();
            return state.maxCarryWeight || 50;
        }
        
        function canAddItem(item, count = 1) {
            const weight = (item.weight || 0) * count;
            return (state.carryWeight + weight) <= state.maxCarryWeight;
        }
        
        // Modal pro vybr√°n√≠ p≈ôedmƒõtu k vyhozen√≠ kdy≈æ je invent√°≈ô pln√Ω
        let pendingPickupItem = null;
        let pendingPickupCount = 0;
        
        function showDropItemModal(item, count) {
            pendingPickupItem = item;
            pendingPickupCount = count;
            
            const neededWeight = (item.weight || 0) * count;
            const currentWeight = state.carryWeight || 0;
            const maxWeight = state.maxCarryWeight || 50;
            
            // Se≈ôaƒè invent√°≈ô podle v√°hy (nejtƒõ≈æ≈°√≠ prvn√≠)
            const sortedInv = [...state.inv].sort((a, b) => ((b.weight || 0) * (b.count || 1)) - ((a.weight || 0) * (a.count || 1)));
            
            let itemsHtml = sortedInv.slice(0, 15).map((invItem, idx) => {
                const itemWeight = (invItem.weight || 0) * (invItem.count || 1);
                const itemName = invItem.name || getItemName(invItem.id) || invItem.id;
                const realIdx = state.inv.indexOf(invItem);
                return `
                    <button class="btn" onclick="dropItemAndPickup(${realIdx})" 
                            style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #2a2a2a; text-align: left;">
                        <span>${invItem.icon || 'üì¶'} ${itemName} ${(invItem.count || 1) > 1 ? 'x' + (invItem.count || 1) : ''}</span>
                        <span style="color: #f44336;">${itemWeight.toFixed(1)}kg</span>
                    </button>
                `;
            }).join('');
            
            showModal('‚ö†Ô∏è Pln√Ω invent√°≈ô!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #ff9800;">Chce≈° vz√≠t:</p>
                    <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0;">
                        <span style="font-size: 1.5rem;">${item.icon || 'üì¶'}</span>
                        <strong style="color: #4caf50;"> ${item.name || getItemName(item.id)}</strong>
                        <span style="color: #888;"> (${neededWeight.toFixed(1)}kg)</span>
                    </div>
                    <p style="color: #888; font-size: 0.85rem;">
                        Nosnost: ${currentWeight.toFixed(1)}/${maxWeight}kg
                    </p>
                    <p style="color: #f44336; font-size: 0.85rem;">
                        Pot≈ôebuje≈° uvolnit: ${(currentWeight + neededWeight - maxWeight).toFixed(1)}kg
                    </p>
                </div>
                
                <p style="color: #aaa; margin-bottom: 0.5rem;">Vyber co vyhod√≠≈°:</p>
                <div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${itemsHtml}
                </div>
                
                <button class="btn" onclick="closeModal(); pendingPickupItem = null;" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    ‚ùå Nevz√≠t p≈ôedmƒõt
                </button>
            `);
        }
        
        function dropItemAndPickup(invIndex) {
            if (invIndex < 0 || invIndex >= state.inv.length) return;
            
            const droppedItem = state.inv[invIndex];
            const droppedName = droppedItem.name || getItemName(droppedItem.id) || droppedItem.id;
            
            // Odeber p≈ôedmƒõt z invent√°≈ôe
            state.inv.splice(invIndex, 1);
            updateCarryWeight();
            
            addLog('Vyhodil jsi: ' + droppedName, 'üóëÔ∏è');
            notifyWarning('Vyhozeno', droppedName);
            
            // Zkus znovu p≈ôidat nov√Ω p≈ôedmƒõt
            if (pendingPickupItem) {
                const item = pendingPickupItem;
                const count = pendingPickupCount;
                pendingPickupItem = null;
                pendingPickupCount = 0;
                
                if (canAddItem(item, count)) {
                    closeModal();
                    addItemToInventory(item, count);
                    notifySuccess('Vzato!', item.name || getItemName(item.id));
                } else {
                    // St√°le nedost m√≠sta - zobraz znovu
                    showDropItemModal(item, count);
                }
            }
        }
        
        // Pomocn√° funkce pro z√≠sk√°n√≠ levelu skillu
        // === HELPER FUNKCE PRO MAPU (kompatibilita star√Ω/nov√Ω syst√©m) ===
        function isInBase() {
            return state.world.currentLocation === 'shelter';
        }
        
        function isPlayerTraveling() {
            return state.world.traveling || state.map.traveling;
        }
        
        function getCurrentLocationId() {
            return state.world.currentLocation;
        }
        
        function getCurrentLocation() {
            return WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
        }
        
        // Synchronizace star√©ho map.inBase s nov√Ωm syst√©mem
        function syncMapState() {
            state.map.inBase = (state.world.currentLocation === 'shelter');
            state.map.traveling = state.world.traveling;
        }
        
        function getSkillLevel(skillId) {
            // Nejprve zkus star√Ω SKILLS syst√©m
            if (state.skills && state.skills[skillId]) {
                return state.skills[skillId];
            }
            
            // Pak zkus SKILL_TREE
            if (state.skillTree) {
                for (const branchId of Object.keys(state.skillTree)) {
                    if (state.skillTree[branchId][skillId]) {
                        return state.skillTree[branchId][skillId];
                    }
                }
            }
            
            return 0;
        }
        
        // Automatick√© konzumov√°n√≠ kdy≈æ hr√°ƒç um√≠r√° (pokud m√° perk)
        function autoConsumeIfDying() {
            // Zkontroluj jestli m√° hr√°ƒç perk "Pud sebez√°chovy"
            const hasAutoConsume = getSkillLevel('auto_consume') > 0;
            if (!hasAutoConsume) return;
            
            // Pr√°h pro automatick√© konzumov√°n√≠
            const DANGER_THRESHOLD = 15;
            
            // Auto-j√≠dlo kdy≈æ hlad pod prahem
            if (state.status.hunger < DANGER_THRESHOLD) {
                const foodItems = state.inv.filter(i => 
                    i.type === 'consumable' && 
                    (i.effect === 'hunger' || (i.effect === 'health' && i.id.includes('food')))
                ).sort((a, b) => (a.value || 0) - (b.value || 0)); // Nejslab≈°√≠ prvn√≠
                
                if (foodItems.length > 0) {
                    const food = foodItems[0];
                    const value = food.value || 30;
                    state.status.hunger = Math.min(100, state.status.hunger + value);
                    
                    // Odeber z invent√°≈ôe
                    if (food.count && food.count > 1) {
                        food.count--;
                    } else {
                        const idx = state.inv.indexOf(food);
                        if (idx > -1) state.inv.splice(idx, 1);
                    }
                    
                    addLog(`üß† Pud sebez√°chovy: Automaticky snƒõdl ${food.name}`, food.icon);
                }
            }
            
            // Auto-pit√≠ kdy≈æ ≈æ√≠ze≈à pod prahem
            if (state.status.thirst < DANGER_THRESHOLD) {
                const drinkItems = state.inv.filter(i => 
                    i.type === 'consumable' && i.effect === 'thirst'
                ).sort((a, b) => (a.value || 0) - (b.value || 0)); // Nejslab≈°√≠ prvn√≠
                
                if (drinkItems.length > 0) {
                    const drink = drinkItems[0];
                    const value = drink.value || 30;
                    state.status.thirst = Math.min(100, state.status.thirst + value);
                    
                    // Odeber z invent√°≈ôe
                    if (drink.count && drink.count > 1) {
                        drink.count--;
                    } else {
                        const idx = state.inv.indexOf(drink);
                        if (idx > -1) state.inv.splice(idx, 1);
                    }
                    
                    addLog(`üß† Pud sebez√°chovy: Automaticky vypil ${drink.name}`, drink.icon);
                }
            }
            
            // Auto-l√©ƒçen√≠ kdy≈æ HP pod 20%
            if (state.status.hp < getMaxHp() * 0.2) {
                const healItems = state.inv.filter(i => 
                    i.type === 'consumable' && i.effect === 'health'
                ).sort((a, b) => (a.value || 0) - (b.value || 0)); // Nejslab≈°√≠ prvn√≠
                
                if (healItems.length > 0) {
                    const heal = healItems[0];
                    const value = heal.value || 20;
                    state.status.hp = Math.min(getMaxHp(), state.status.hp + value);
                    
                    // Odeber z invent√°≈ôe
                    if (heal.count && heal.count > 1) {
                        heal.count--;
                    } else {
                        const idx = state.inv.indexOf(heal);
                        if (idx > -1) state.inv.splice(idx, 1);
                    }
                    
                    addLog(`üß† Pud sebez√°chovy: Automaticky pou≈æil ${heal.name}`, heal.icon);
                }
            }
        }
        
        // === LOOT FILTR ===
        const RARITY_ORDER = ['common', 'uncommon', 'rare', 'epic', 'legendary'];
        
        // Zkontroluje jestli item projde loot filtrem
        function passesLootFilter(item) {
            if (!state.lootFilter) return true; // ≈Ω√°dn√Ω filtr = sb√≠rej v≈°e
            
            const filter = state.lootFilter;
            const itemType = item.type;
            const itemRarity = item.rarity || 'common';
            
            // Kontrola typu
            if (itemType === 'consumable' && !filter.consumables) return false;
            if (itemType === 'weapon' && !filter.weapons) return false;
            if (itemType === 'armor' && !filter.armor) return false;
            if (itemType === 'ammo' && !filter.ammo) return false;
            if (itemType === 'resource' && !filter.resources) return false;
            if (itemType === 'tool' && !filter.tools) return false;
            
            // Kontrola rarity
            const minRarityIdx = RARITY_ORDER.indexOf(filter.minRarity || 'common');
            const itemRarityIdx = RARITY_ORDER.indexOf(itemRarity);
            if (itemRarityIdx < minRarityIdx) return false;
            
            return true;
        }
        
        // Zobraz√≠ nastaven√≠ loot filtru
        function showLootFilterSettings() {
            const filter = state.lootFilter || {
                consumables: true, weapons: true, armor: true,
                ammo: true, resources: true, tools: true, minRarity: 'common'
            };
            
            const rarityOptions = [
                { id: 'common', name: '‚ö™ Common+', desc: 'Sb√≠rej v≈°e' },
                { id: 'uncommon', name: 'üü¢ Uncommon+', desc: 'Ignoruj common' },
                { id: 'rare', name: 'üîµ Rare+', desc: 'Jen vz√°cn√©' },
                { id: 'epic', name: 'üü£ Epic+', desc: 'Jen epick√©' },
                { id: 'legendary', name: 'üü° Legendary', desc: 'Jen legend√°rn√≠' }
            ];
            
            showModal('üéí Nastaven√≠ Auto-Lootu', `
                <p style="color: #888; font-size: 0.85rem; margin-bottom: 1rem;">
                    Vyber co chce≈° automaticky sb√≠rat. Ostatn√≠ z≈Østane na zemi.
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterConsumables" ${filter.consumables ? 'checked' : ''} onchange="updateLootFilter('consumables', this.checked)">
                        <span>üçñ Spot≈ôebn√≠</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterWeapons" ${filter.weapons ? 'checked' : ''} onchange="updateLootFilter('weapons', this.checked)">
                        <span>‚öîÔ∏è Zbranƒõ</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterArmor" ${filter.armor ? 'checked' : ''} onchange="updateLootFilter('armor', this.checked)">
                        <span>üõ°Ô∏è Zbroje</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterAmmo" ${filter.ammo ? 'checked' : ''} onchange="updateLootFilter('ammo', this.checked)">
                        <span>üî∏ Munice</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterResources" ${filter.resources ? 'checked' : ''} onchange="updateLootFilter('resources', this.checked)">
                        <span>üì¶ Suroviny</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="filterTools" ${filter.tools ? 'checked' : ''} onchange="updateLootFilter('tools', this.checked)">
                        <span>üîß N√°stroje</span>
                    </label>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.8rem;">Minim√°ln√≠ vz√°cnost:</label>
                    <select id="filterMinRarity" onchange="updateLootFilter('minRarity', this.value)" 
                            style="width: 100%; padding: 0.5rem; margin-top: 0.3rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        ${rarityOptions.map(r => `
                            <option value="${r.id}" ${filter.minRarity === r.id ? 'selected' : ''}>${r.name} - ${r.desc}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="resetLootFilter()" style="background: #555;">üîÑ Reset</button>
                    <button class="btn" onclick="closeModal()" style="background: #4caf50;">‚úì Hotovo</button>
                </div>
            `);
        }
        
        function updateLootFilter(key, value) {
            if (!state.lootFilter) state.lootFilter = {
                consumables: true, weapons: true, armor: true,
                ammo: true, resources: true, tools: true, minRarity: 'common'
            };
            state.lootFilter[key] = value;
            saveGame();
        }
        
        function resetLootFilter() {
            state.lootFilter = {
                consumables: true, weapons: true, armor: true,
                ammo: true, resources: true, tools: true, minRarity: 'common'
            };
            showLootFilterSettings();
        }
        
        // === RECYKLACE ITEM≈Æ ===
        function recycleItem(itemIndex) {
            const item = state.inv[itemIndex];
            if (!item) return;
            
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            
            // Nelze recyklovat consumables a nƒõkter√© speci√°ln√≠ itemy
            if (itemData.type === 'consumable' || itemData.type === 'ammo' || itemData.type === 'resource') {
                notifyWarning('Nelze recyklovat', 'Tento typ p≈ôedmƒõtu nelze recyklovat');
                return;
            }
            
            // Vypoƒç√≠tej materi√°ly
            const materials = calculateRecycleMaterials(itemData);
            
            if (Object.keys(materials).length === 0) {
                notifyWarning('Nelze recyklovat', 'Z tohoto p≈ôedmƒõtu nez√≠sk√°≈° ≈æ√°dn√© materi√°ly');
                return;
            }
            
            // Zobraz potvrzen√≠
            let materialsHtml = '';
            for (const [mat, amount] of Object.entries(materials)) {
                const matIcon = { metal: 'üî©', wood: 'ü™µ', cloth: 'üßµ', leather: 'ü¶é', electronics: 'üì±', chemicals: 'üß™', scrap: '‚öôÔ∏è', glass: 'ü™ü', stone: 'ü™®' }[mat] || 'üì¶';
                materialsHtml += `<div style="display: inline-block; background: #2a2a2a; padding: 0.3rem 0.6rem; border-radius: 4px; margin: 0.2rem;">${matIcon} ${amount}x ${mat}</div>`;
            }
            
            showModal(`‚ôªÔ∏è Recyklovat ${item.icon} ${item.name}?`, `
                <p style="color: #888;">Rozlo≈æ√≠≈° p≈ôedmƒõt a z√≠sk√°≈° suroviny:</p>
                <div style="margin: 1rem 0;">${materialsHtml}</div>
                <p style="color: #ff9800; font-size: 0.85rem;">‚ö†Ô∏è P≈ôedmƒõt bude zniƒçen!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="confirmRecycle(${itemIndex})" style="background: #4caf50;">‚ôªÔ∏è Recyklovat</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚úó Zru≈°it</button>
                </div>
            `);
        }
        
        function calculateRecycleMaterials(itemData) {
            const materials = {};
            const price = itemData.price || 50;
            const rarity = itemData.rarity || 'common';
            
            // Z√°kladn√≠ materi√°ly podle typu
            if (itemData.type === 'weapon') {
                materials.metal = Math.max(1, Math.floor(price / 40));
                if (itemData.ammoType) materials.scrap = Math.max(1, Math.floor(price / 60));
                if (rarity === 'rare' || rarity === 'epic') materials.electronics = 1;
            } else if (itemData.type === 'armor') {
                if (itemData.id?.includes('leather') || itemData.defense < 10) {
                    materials.leather = Math.max(1, Math.floor(price / 35));
                    materials.cloth = Math.max(1, Math.floor(price / 50));
                } else {
                    materials.metal = Math.max(1, Math.floor(price / 40));
                    materials.cloth = Math.max(1, Math.floor(price / 60));
                }
                if (rarity === 'rare' || rarity === 'epic') materials.chemicals = 1;
            } else if (itemData.type === 'tool') {
                materials.metal = Math.max(1, Math.floor(price / 50));
                materials.wood = Math.max(1, Math.floor(price / 60));
            }
            
            // Bonus za vy≈°≈°√≠ rarity
            const rarityMultiplier = { common: 0.5, uncommon: 0.6, rare: 0.75, epic: 0.85, legendary: 1 }[rarity] || 0.5;
            
            for (const key of Object.keys(materials)) {
                materials[key] = Math.max(1, Math.floor(materials[key] * rarityMultiplier));
            }
            
            return materials;
        }
        
        function confirmRecycle(itemIndex) {
            const item = state.inv[itemIndex];
            if (!item) { closeModal(); return; }
            
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const materials = calculateRecycleMaterials(itemData);
            
            // P≈ôidej materi√°ly
            for (const [mat, amount] of Object.entries(materials)) {
                state.resources[mat] = (state.resources[mat] || 0) + amount;
            }
            
            // Odeber item
            if (item.count && item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            notifySuccess('‚ôªÔ∏è Recyklov√°no!', `${item.name} rozlo≈æeno na suroviny`);
            addLog(`Recykloval jsi ${item.name}`, '‚ôªÔ∏è');
            
            closeModal();
            renderFull();
        }
        
        // Z√≠sk√° v≈°echny bojov√© bonusy hr√°ƒçe ze skill≈Ø
        function getPlayerCombatSkillEffects() {
            const effects = {
                damageBonus: 0,      // +X% damage
                critChance: 0,       // +X ≈°ance na krit
                armorPierce: 0,      // Ignoruje X% obrany
                berserkerBonus: 0,   // +X% damage p≈ôi n√≠zk√©m HP
                executeBonus: 0,     // +X% damage na nep≈ô√°tele pod 20% HP
                defense: 0,          // +X obrany
                blockChance: 0,      // X% ≈°ance blokovat √∫tok
                lastStand: 0         // X% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫der
            };
            
            if (!state.skills) return effects;
            
            // Projdi v≈°echny skill vƒõtve
            for (const [branchId, branch] of Object.entries(SKILL_TREE)) {
                branch.skills.forEach(skill => {
                    const level = state.skills[skill.id] || 0;
                    if (level > 0 && skill.effect) {
                        Object.entries(skill.effect).forEach(([key, value]) => {
                            if (typeof value === 'number' && effects.hasOwnProperty(key)) {
                                effects[key] += value * level;
                            }
                        });
                    }
                });
            }
            
            return effects;
        }
        
        // V√Ωpoƒçet bonus≈Ø z budov
        function getBuildingBonuses() {
            const bonuses = {
                morale: 0,
                settlementMorale: 0,
                hp: 0,
                energy: 0,
                defense: 0,
                baseCapacity: 0,
                foodBonus: 0,
                tradingBonus: 0,
                damageBonus: 0,
                weaponBonus: 0,
                xpBonus: 0,
                guardBonus: 0,
                vision: 0,
                cooking: false,
                weatherProtection: false,
                hygiene: false,
                crafting: false,
                foodPreserve: false
            };
            
            // Base budovy
            if (state.base) {
                state.base.forEach(buildingId => {
                    const building = BUILDINGS.find(b => b.id === buildingId);
                    if (building && building.effect) {
                        Object.keys(building.effect).forEach(key => {
                            if (typeof bonuses[key] === 'number') {
                                bonuses[key] += building.effect[key];
                            } else if (typeof bonuses[key] === 'boolean') {
                                bonuses[key] = bonuses[key] || building.effect[key];
                            }
                        });
                    }
                });
            }
            
            // Settlement budovy
            if (state.settlement?.buildings) {
                state.settlement.buildings.forEach(buildingId => {
                    const building = BUILDINGS.find(b => b.id === buildingId);
                    if (building && building.effect) {
                        Object.keys(building.effect).forEach(key => {
                            if (typeof bonuses[key] === 'number') {
                                bonuses[key] += building.effect[key];
                            } else if (typeof bonuses[key] === 'boolean') {
                                bonuses[key] = bonuses[key] || building.effect[key];
                            }
                        });
                    }
                });
            }
            
            return bonuses;
        }
        
        // Kontrola jestli m√°≈° budovu
        function hasBuilding(buildingId) {
            return state.base?.includes(buildingId) || state.settlement?.buildings?.includes(buildingId);
        }
        
        // === INVENTORY UTILITIES ===
        
        /**
         * Validuje integritu invent√°≈ôe a oprav√≠ chyby
         * @returns {object} Report o nalezen√Ωch a opraven√Ωch probl√©mech
         */
        function validateInventory() {
            const report = {
                checked: 0,
                fixed: 0,
                removed: 0,
                issues: []
            };
            
            if (!Array.isArray(state.inv)) {
                state.inv = [];
                report.issues.push('Invent√°≈ô nebyl pole - resetov√°n');
                return report;
            }
            
            // Filtruj neplatn√© polo≈æky
            const validItems = [];
            
            state.inv.forEach((item, index) => {
                report.checked++;
                
                // Z√°kladn√≠ validace
                if (!item || typeof item !== 'object') {
                    report.removed++;
                    report.issues.push(`Index ${index}: Neplatn√Ω item (null/undefined)`);
                    return;
                }
                
                if (!item.id) {
                    report.removed++;
                    report.issues.push(`Index ${index}: Item bez ID`);
                    return;
                }
                
                // Oprav count
                if (item.count !== undefined) {
                    const originalCount = item.count;
                    item.count = safeInteger(item.count, 1, 1, GAME_CONSTANTS.MAX_STACK_SIZE);
                    if (item.count !== originalCount) {
                        report.fixed++;
                        report.issues.push(`${item.id}: count ${originalCount} ‚Üí ${item.count}`);
                    }
                }
                
                // Oprav durability
                if (item.durability !== undefined) {
                    item.durability = safeInteger(item.durability, 100, 0, 100);
                }
                
                // Oprav damage/defense
                if (item.damage !== undefined) {
                    item.damage = safeInteger(item.damage, 0, 0);
                }
                if (item.defense !== undefined) {
                    item.defense = safeInteger(item.defense, 0, 0);
                }
                
                validItems.push(item);
            });
            
            state.inv = validItems;
            
            if (report.issues.length > 0) {
                GameLogger.warn('inventory', `Inventory validation: ${report.fixed} fixed, ${report.removed} removed`, report.issues);
            }
            
            return report;
        }
        
        /**
         * Najde item v invent√°≈ôi podle ID nebo predik√°tu
         * @param {string|function} idOrPredicate - ID itemu nebo predik√°tov√° funkce
         * @returns {object|null} Nalezen√Ω item nebo null
         */
        function findInventoryItem(idOrPredicate) {
            if (!state.inv) return null;
            
            if (typeof idOrPredicate === 'function') {
                return state.inv.find(idOrPredicate) || null;
            }
            
            return state.inv.find(i => i.id === idOrPredicate) || null;
        }
        
        /**
         * Spoƒç√≠t√° celkov√Ω poƒçet item≈Ø dan√©ho ID
         * @param {string} itemId - ID itemu
         * @returns {number} Celkov√Ω poƒçet
         */
        function countInventoryItems(itemId) {
            if (!state.inv) return 0;
            
            return state.inv
                .filter(i => i.id === itemId)
                .reduce((sum, i) => sum + (i.count || 1), 0);
        }
        
        // Bezpeƒçn√© odebr√°n√≠ itemu z invent√°≈ôe (spr√°vnƒõ zpracuje count)
        function removeItemFromInventory(item, amount = 1) {
            if (!item) return false;
            
            // Validace amount
            amount = safeInteger(amount, 1, 1);
            
            // Zajisti ≈æe count existuje
            const currentCount = item.count || 1;
            
            if (currentCount <= amount) {
                // Odeber cel√Ω item podle reference
                const idx = state.inv.indexOf(item);
                if (idx > -1) {
                    state.inv.splice(idx, 1);
                    updateCarryWeight();
                    GameLogger.debug('inventory', `Removed: ${item.name || item.id}`, { amount });
                    return true;
                }
                return false;
            } else {
                // Sni≈æ poƒçet
                item.count = currentCount - amount;
                updateCarryWeight();
                GameLogger.debug('inventory', `Reduced: ${item.name || item.id}`, { from: currentCount, to: item.count });
                return true;
            }
        }
        
        // === GROUND LOOT SYST√âM ===
        // P≈ôid√° p≈ôedmƒõt na zem na danou lokaci (nebo aktu√°ln√≠)
        function addToGroundLoot(item, targetLocation = null) {
            if (!item) return;
            const location = targetLocation || state.world?.currentLocation || 'shelter';
            if (!state.world.groundLoot) state.world.groundLoot = {};
            if (!state.world.groundLoot[location]) state.world.groundLoot[location] = [];
            
            // P≈ôidej timestamp pro p≈ô√≠padn√© expirov√°n√≠
            item.droppedAt = Date.now();
            state.world.groundLoot[location].push(item);
            
            addLog(`üì¶ ${item.icon || 'üì¶'} ${item.name} z≈Østalo na zemi`, 'üì¶');
        }
        
        // Z√≠sk√° p≈ôedmƒõty na zemi na aktu√°ln√≠ lokaci
        function getGroundLoot() {
            const location = state.world?.currentLocation || 'shelter';
            return state.world.groundLoot?.[location] || [];
        }
        
        // Sebere p≈ôedmƒõt ze zemƒõ
        function pickupGroundLoot(index) {
            const location = state.world?.currentLocation || 'shelter';
            const groundItems = state.world.groundLoot?.[location];
            if (!groundItems || !groundItems[index]) return;
            
            const item = groundItems[index];
            const count = item.count || 1;
            
            if (canAddItem(item, count)) {
                // Vytvo≈ô kopii bez droppedAt
                const itemCopy = {...item};
                delete itemCopy.droppedAt;
                
                addItemToInventory(itemCopy, count);
                groundItems.splice(index, 1);
                notifySuccess('Sebr√°no!', `${item.icon} ${item.name}`);
                
                // Pokud je≈°tƒõ nƒõco z≈Østalo, znovu zobraz modal
                if (groundItems.length > 0) {
                    showGroundLoot();
                } else {
                    closeModal();
                    renderFull();
                }
            } else {
                notifyWarning('Pln√Ω invent√°≈ô!', 'Uvolni m√≠sto v invent√°≈ôi');
            }
        }
        
        // Sebere v≈°e ze zemƒõ
        function pickupAllGroundLoot() {
            const location = state.world?.currentLocation || 'shelter';
            const groundItems = state.world.groundLoot?.[location];
            if (!groundItems || groundItems.length === 0) return;
            
            let picked = 0;
            let remaining = [];
            
            groundItems.forEach(item => {
                const count = item.count || 1;
                if (canAddItem(item, count)) {
                    // Vytvo≈ô kopii bez droppedAt
                    const itemCopy = {...item};
                    delete itemCopy.droppedAt;
                    
                    addItemToInventory(itemCopy, count, true);
                    picked++;
                } else {
                    remaining.push(item);
                }
            });
            
            state.world.groundLoot[location] = remaining;
            
            if (picked > 0) {
                notifySuccess('Sebr√°no!', `${picked} p≈ôedmƒõt≈Ø`);
            }
            if (remaining.length > 0) {
                notifyWarning('Pln√Ω invent√°≈ô', `${remaining.length} p≈ôedmƒõt≈Ø z≈Østalo na zemi`);
                // Znovu zobraz modal s t√≠m co zbylo
                showGroundLoot();
            } else {
                closeModal();
                renderFull();
            }
        }
        
        // Zobraz√≠ modal s p≈ôedmƒõty na zemi
        function showGroundLoot() {
            const groundItems = getGroundLoot();
            
            if (groundItems.length === 0) {
                notifyWarning('Pr√°zdno', 'Na zemi nic nen√≠');
                return;
            }
            
            let itemsHtml = groundItems.map((item, idx) => {
                const count = item.count || 1;
                const countText = count > 1 ? ` x${count}` : '';
                const rarityColors = { common: '#888', uncommon: '#4caf50', rare: '#2196f3', epic: '#9c27b0', legendary: '#ffd700' };
                const color = rarityColors[item.rarity] || '#888';
                
                return `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.5rem;">${item.icon || 'üì¶'}</span>
                        <div style="flex: 1;">
                            <div style="color: ${color}; font-weight: bold;">${item.name}${countText}</div>
                            ${item.damage ? `<span style="color: #c62828; font-size: 0.8rem;">‚öîÔ∏è ${item.damage}</span>` : ''}
                            ${item.defense ? `<span style="color: #2196f3; font-size: 0.8rem;">üõ°Ô∏è ${item.defense}</span>` : ''}
                        </div>
                        <button class="btn" onclick="pickupGroundLoot(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4caf50;">Vz√≠t</button>
                    </div>
                `;
            }).join('');
            
            showModal('üì¶ P≈ôedmƒõty na zemi', `
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    ${itemsHtml}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="pickupAllGroundLoot()" style="background: #ff9800;">üì• Vz√≠t v≈°e</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚úó Zav≈ô√≠t</button>
                </div>
            `);
        }
        
        // Centr√°ln√≠ funkce pro p≈ôid√°n√≠ p≈ôedmƒõtu do invent√°≈ôe se stackov√°n√≠m
        function addItemToInventory(item, count = 1, silent = false) {
            if (!item) return false;
            
            // Resources jdou do state.resources, ne do inv
            if (item.type === 'resource') {
                const resourceId = item.id;
                state.resources[resourceId] = (state.resources[resourceId] || 0) + count;
                SoundSystem.play('pickup');
                if (!silent) {
                    notifySuccess(item.icon + ' +' + count, item.name);
                }
                return true;
            }
            
            // Kontrola unique item≈Ø (kompas, dalekohled, batoh) - max 1
            if (item.unique || item.maxStack === 1) {
                const alreadyHas = state.inv.some(i => i.id === item.id);
                if (alreadyHas) {
                    if (!silent) {
                        notifyWarning('U≈æ m√°≈° ' + item.name, 'M≈Ø≈æe≈° m√≠t pouze jeden');
                    }
                    return false;
                }
            }
            
            // Kontrola v√°hy
            if (!canAddItem(item, count)) {
                if (!silent) {
                    SoundSystem.play('error');
                    // Nab√≠dni mo≈ænost vyhodit nƒõco
                    showDropItemModal(item, count);
                }
                return false;
            }
            
            // Stackovateln√© typy: consumable, ammo, food, throwable
            const stackableTypes = ['consumable', 'ammo', 'food', 'throwable'];
            
            if (stackableTypes.includes(item.type) || item.stackable) {
                // Hledej existuj√≠c√≠ stack podle ID, ale ne pokud m√° stackId (rozdƒõlen√Ω stack)
                const existing = state.inv.find(i => i.id === item.id && !i.stackId);
                if (existing && !item.stackId) {
                    existing.count = (existing.count || 1) + count;
                    SoundSystem.play('pickup');
                    updateCarryWeight();
                    return true;
                }
            }
            
            // P≈ôidej nov√Ω p≈ôedmƒõt
            const newItem = {...item};
            
            // Dopl≈à chybƒõj√≠c√≠ vlastnosti z ITEMS definice (price, weight, atd.)
            if (!newItem.price || !newItem.weight || !newItem.special) {
                const itemDef = ITEMS.find(i => i.id === item.id);
                if (itemDef) {
                    if (!newItem.price && itemDef.price) newItem.price = itemDef.price;
                    if (!newItem.weight && itemDef.weight) newItem.weight = itemDef.weight;
                    if (!newItem.rarity && itemDef.rarity) newItem.rarity = itemDef.rarity;
                    if (!newItem.special && itemDef.special) newItem.special = itemDef.special;
                    if (!newItem.defense && itemDef.defense) newItem.defense = itemDef.defense;
                }
            }
            
            if (stackableTypes.includes(item.type) || item.stackable) {
                newItem.count = count;
                newItem.stackable = true;
            }
            state.inv.push(newItem);
            SoundSystem.play('pickup');
            updateCarryWeight();
            
            // === ACHIEVEMENT TRACKING ===
            // Legendary item found
            if (item.rarity === 'legendary') {
                state.stats.legendaryFound = (state.stats.legendaryFound || 0) + 1;
            }
            // Rare+ items found
            if (item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary') {
                state.stats.rareFound = (state.stats.rareFound || 0) + 1;
            }
            
            // === COMPANION QUEST - item objective ===
            if (typeof checkCompanionQuestObjectives === 'function') {
                checkCompanionQuestObjectives('item', item.id);
            }
            
            return true;
        }
        
        // Bezpeƒçn√© p≈ôid√°n√≠ s upozornƒõn√≠m - pro loot, odmƒõny atd.
        function tryAddItemToInventory(item, count = 1) {
            if (!item) return { success: false, reason: 'no_item' };
            
            const weight = (item.weight || 0) * count;
            const freeSpace = state.maxCarryWeight - state.carryWeight;
            
            if (weight > freeSpace) {
                // Kolik se vejde?
                const canFit = item.weight > 0 ? Math.floor(freeSpace / item.weight) : count;
                
                if (canFit > 0) {
                    // P≈ôidej kolik se vejde
                    addItemToInventory(item, canFit, true);
                    notifyWarning('Invent√°≈ô skoro pln√Ω!', 'Vzal jsi jen ' + canFit + 'x ' + item.name);
                    return { success: true, added: canFit, dropped: count - canFit };
                } else {
                    notifyWarning(t('notifications', 'inventoryFull'), 'Nem≈Ø≈æe≈° vz√≠t ' + item.name);
                    return { success: false, reason: 'full', dropped: count };
                }
            }
            
            addItemToInventory(item, count, true);
            return { success: true, added: count, dropped: 0 };
        }
        
        // === VIZU√ÅLN√ç EFEKTY ===
        
        // Floating number effect (damage, heal, XP, money)
        function showFloatingNumber(value, type = 'damage', x = null, y = null) {
            const el = document.createElement('div');
            el.className = `floating-number ${type}`;
            
            // Prefix based on type
            let prefix = '';
            if (type === 'heal' || type === 'xp' || type === 'money') prefix = '+';
            if (type === 'damage') prefix = '-';
            if (type === 'crit') prefix = 'üí•';
            
            el.textContent = prefix + value;
            
            // Position - center of screen or custom
            if (x === null) x = window.innerWidth / 2 + (Math.random() - 0.5) * 100;
            if (y === null) y = window.innerHeight / 2;
            
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            
            document.body.appendChild(el);
            
            // Remove after animation
            setTimeout(() => el.remove(), 1500);
        }
        
        // Screen shake effect
        function screenShake(intensity = 5, duration = 300) {
            const container = document.querySelector('.container');
            if (!container) return;
            
            container.style.transition = 'none';
            const startTime = Date.now();
            
            function shake() {
                const elapsed = Date.now() - startTime;
                if (elapsed < duration) {
                    const x = (Math.random() - 0.5) * intensity * 2;
                    const y = (Math.random() - 0.5) * intensity * 2;
                    container.style.transform = `translate(${x}px, ${y}px)`;
                    requestAnimationFrame(shake);
                } else {
                    container.style.transform = '';
                    container.style.transition = '';
                }
            }
            shake();
        }
        
        // Particle burst effect
        function particleBurst(x, y, color = '#ffd700', count = 10) {
            const container = document.createElement('div');
            container.className = 'particle-container';
            container.style.left = x + 'px';
            container.style.top = y + 'px';
            document.body.appendChild(container);
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.background = color;
                particle.style.left = '0px';
                particle.style.top = '0px';
                
                // Random direction
                const angle = (Math.PI * 2 / count) * i;
                const distance = 30 + Math.random() * 50;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                particle.style.animation = `particleFloat 0.8s ease-out forwards`;
                particle.style.transform = `translate(${tx}px, ${ty}px)`;
                
                container.appendChild(particle);
            }
            
            setTimeout(() => container.remove(), 1000);
        }
        
        // Flash element effect
        function flashElement(element, color = '#fff', duration = 200) {
            if (!element) return;
            const original = element.style.filter;
            element.style.filter = `brightness(2) drop-shadow(0 0 10px ${color})`;
            setTimeout(() => {
                element.style.filter = original;
            }, duration);
        }
        
        // Level up celebration effect
        function levelUpEffect() {
            // Nov√Ω level up efekt
            if (typeof triggerLevelUpEffect === 'function') triggerLevelUpEffect();
            
            // Screen flash
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, transparent 70%);
                pointer-events: none; z-index: 9998;
                animation: fadeInScale 0.3s ease-out forwards;
            `;
            document.body.appendChild(flash);
            
            // Particles
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const x = window.innerWidth / 2 + (Math.random() - 0.5) * 200;
                    const y = window.innerHeight / 2 + (Math.random() - 0.5) * 200;
                    particleBurst(x, y, ['#ffd700', '#ff9800', '#ffeb3b'][Math.floor(Math.random() * 3)], 8);
                }, i * 100);
            }
            
            setTimeout(() => flash.remove(), 1000);
        }
        
        // Craft success effect
        function craftSuccessEffect(element) {
            if (element) {
                element.classList.add('fade-in-scale');
                setTimeout(() => element.classList.remove('fade-in-scale'), 400);
            }
            particleBurst(window.innerWidth / 2, window.innerHeight / 2, '#8bc34a', 8);
        }
        
        // Combat hit effect
        function combatHitEffect(isPlayer = false, damage = 0, isCrit = false) {
            if (isPlayer) {
                screenShake(isCrit ? 8 : 4, 200);
                showFloatingNumber(damage, 'damage');
                if (typeof triggerDamageShake === 'function') triggerDamageShake();
                if (typeof playCombatSound === 'function') playCombatSound('playerHit');
            } else {
                showFloatingNumber(damage, isCrit ? 'crit' : 'damage');
                if (typeof playCombatSound === 'function') playCombatSound(isCrit ? 'crit' : 'enemyHit');
                if (isCrit) {
                    screenShake(3, 150);
                }
            }
        }
        
        // === COMBAT DETECTION ===
        /**
         * Zjist√≠ jestli pr√°vƒõ prob√≠h√° boj
         * @returns {boolean} True pokud prob√≠h√° boj
         */
        function isInCombat() {
            return !!(window.combatState || state.inCombat || window.combatInProgress);
        }
        
        // === CENTRALIZOVAN√â HP UTILITY ===
        // Pou≈æij tyto funkce m√≠sto p≈ô√≠m√©ho p≈ô√≠stupu k state.char.hp
        
        /**
         * Bezpeƒçnƒõ z√≠sk√° aktu√°ln√≠ HP
         * @returns {number} Aktu√°ln√≠ HP
         */
        function getPlayerHP() {
            return safeInteger(state.char?.hp, 0, 0, getPlayerMaxHP());
        }
        
        /**
         * Bezpeƒçnƒõ z√≠sk√° maxim√°ln√≠ HP
         * @returns {number} Maxim√°ln√≠ HP
         */
        function getPlayerMaxHP() {
            return safeInteger(state.char?.maxHp, 100, 1, GAME_CONSTANTS.MAX_HP);
        }
        
        /**
         * Vyl√©ƒç√≠ hr√°ƒçe o zadan√© mno≈æstv√≠ HP
         * @param {number} amount - Mno≈æstv√≠ HP k vyl√©ƒçen√≠
         * @param {boolean} allowOverheal - Povolit p≈ôekroƒçen√≠ maxHP (default: false)
         * @returns {number} Skuteƒçnƒõ vyl√©ƒçen√© HP
         */
        function healPlayer(amount, allowOverheal = false) {
            amount = safeInteger(amount, 0, 0);
            if (amount <= 0) return 0;
            
            const currentHP = getPlayerHP();
            const maxHP = getPlayerMaxHP();
            
            // Companion bonus pro l√©ƒçen√≠
            let bonusMultiplier = 1;
            if (typeof getAllCompanionBonuses === 'function') {
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.healingBonus > 0) {
                    bonusMultiplier = 1 + compBonuses.healingBonus;
                }
            }
            
            const finalAmount = Math.floor(amount * bonusMultiplier);
            const maxHeal = allowOverheal ? GAME_CONSTANTS.MAX_HP : maxHP;
            const newHP = Math.min(currentHP + finalAmount, maxHeal);
            const actualHeal = newHP - currentHP;
            
            state.char.hp = newHP;
            
            return actualHeal;
        }
        
        /**
         * Zp≈Øsob√≠ damage hr√°ƒçi
         * @param {number} amount - Mno≈æstv√≠ damage
         * @param {string} source - Zdroj damage (pro logging)
         * @param {boolean} canKill - M≈Ø≈æe zab√≠t hr√°ƒçe? (default: true)
         * @returns {number} Skuteƒçn√Ω damage
         */
        function damagePlayer(amount, source = 'unknown', canKill = true) {
            amount = safeInteger(amount, 0, 0);
            if (amount <= 0) return 0;
            
            const currentHP = getPlayerHP();
            const minHP = canKill ? 0 : 1;
            const newHP = Math.max(minHP, currentHP - amount);
            const actualDamage = currentHP - newHP;
            
            state.char.hp = newHP;
            
            // Log pro debugging
            if (actualDamage > 0) {
                console.log(`üíî Damage: -${actualDamage} HP from ${source} (${currentHP} ‚Üí ${newHP})`);
            }
            
            // Trigger efekty p≈ôi n√≠zk√©m HP
            if (newHP <= state.char.maxHp * 0.25 && newHP > 0) {
                // N√≠zk√© HP warning efekt
                if (typeof addLowHPEffect === 'function') addLowHPEffect();
            }
            
            return actualDamage;
        }
        
        /**
         * Nastav√≠ HP na pln√©
         */
        function fullHealPlayer() {
            state.char.hp = getPlayerMaxHP();
        }
        
        /**
         * Kontrola zda je hr√°ƒç na≈æivu
         * @returns {boolean}
         */
        function isPlayerAlive() {
            return getPlayerHP() > 0;
        }
        
        function getMoney() {
            // Z√°kladn√≠ pen√≠ze
            let total = state.money || 0;
            
            // P≈ôiƒçti pen√≠ze z invent√°≈ôe (pokud tam nƒõjak√© jsou jako item)
            if (state.inv) {
                state.inv.forEach(item => {
                    if (item.id === 'money' && item.count) {
                        total += item.count;
                    }
                });
            }
            
            return total;
        }
        
        // === CASINO ≈ΩETONY ===
        const MAX_CASINO_TOKENS = 9999999;
        
        function getCasinoTokens() {
            return safeInteger(state.casinoTokens, 0, 0);
        }
        
        function addCasinoTokens(amount) {
            amount = safeInteger(amount);
            const newTotal = (state.casinoTokens || 0) + amount;
            state.casinoTokens = Math.max(0, Math.min(newTotal, MAX_CASINO_TOKENS));
        }
        
        function checkDailyCasinoTokens() {
            const now = Date.now();
            const lastTokenTime = state.casinoLastTokenTime || 0;
            const oneDayMs = 24 * 60 * 60 * 1000; // 24 hodin v ms
            
            // Bonus jen jednou za 24 re√°ln√Ωch hodin
            if (now - lastTokenTime >= oneDayMs) {
                state.casinoLastTokenTime = now;
                addCasinoTokens(1000);
                addLog('üé∞ Denn√≠ bonus: +1000 ≈æeton≈Ø do kasina!', 'üé∞');
                notifySuccess('Casino bonus!', '+1000 üé´ ≈æeton≈Ø');
                saveGame();
                return true;
            }
            return false;
        }
        
        function exchangeTokensForMoney() {
            const tokensBefore = getCasinoTokens();
            const moneyBefore = state.money || 0;
            
            console.log('üí± Exchange: tokeny p≈ôed:', tokensBefore, 'pen√≠ze p≈ôed:', moneyBefore);
            
            if (tokensBefore < 5000) {
                notifyWarning('M√°lo ≈æeton≈Ø!', 'Pot≈ôebuje≈° 5000 üé´');
                return false;
            }
            
            addCasinoTokens(-5000);
            
            // P≈ôidej pen√≠ze P≈ò√çMO m√≠sto p≈ôes addMoney (kter√° m√° ochranu proti <=0)
            state.money = (state.money || 0) + 200;
            
            const tokensAfter = getCasinoTokens();
            const moneyAfter = state.money;
            
            console.log('üí± Exchange: tokeny po:', tokensAfter, 'pen√≠ze po:', moneyAfter);
            console.log('üí± Exchange: zmƒõna token≈Ø:', tokensAfter - tokensBefore, 'zmƒõna penƒõz:', moneyAfter - moneyBefore);
            
            notifySuccess('V√Ωmƒõna!', `-5000 üé´ ‚Üí +200 üí∞ (m√°≈° ${moneyAfter} üí∞)`);
            saveGame();
            renderGame();
            return true;
        }
        
        // Bezpeƒçn√© p≈ôiƒçten√≠ casino gambled progress
        function addCasinoGambledProgress() {
            if (!state.dailyQuests) state.dailyQuests = {};
            if (!state.dailyQuests.progress) state.dailyQuests.progress = {};
            state.dailyQuests.progress.gambled = (state.dailyQuests.progress.gambled || 0) + 1;
            if (typeof checkDailyQuests === 'function') checkDailyQuests();
        }
        
        // P≈ôid√°n√≠ radiace s ohledem na buff odolnosti
        function addRadiation(amount) {
            if (amount <= 0) return;
            
            // MUTANT je imunn√≠ na radiaci
            if (state.char.classId === 'mutant' || state.char.class === 'mutant') {
                return; // ≈Ω√°dn√° radiace
            }
            
            let finalAmount = amount;
            
            // Kontrola rad_resist buffu
            if (state.buffs?.radResist && state.buffs.radResist.until > Date.now()) {
                const reduction = state.buffs.radResist.value / 100; // nap≈ô. 50 = 50%
                finalAmount = Math.floor(amount * (1 - reduction));
                if (finalAmount < amount) {
                    console.log(`Rad-X: sn√≠≈æeno z ${amount} na ${finalAmount} radiace`);
                }
            }
            
            // Kontrola plynov√© masky nebo hazmat obleku
            const armor = state.equipped?.armor;
            if (armor?.special === 'rad_resist') {
                finalAmount = Math.floor(finalAmount * 0.7); // -30%
            } else if (armor?.special === 'rad_immune') {
                finalAmount = Math.floor(finalAmount * 0.5); // -50% (ne 100% imunita)
            }
            
            // ‚ò£Ô∏è Mutant√≠ frakce - radResist bonus
            const factionBonuses = getFactionBonuses();
            if (factionBonuses.radResist > 0) {
                finalAmount = Math.floor(finalAmount * (1 - factionBonuses.radResist));
            }
            
            // ‚ò¢Ô∏è Exotic bonus - Radiaƒçn√≠ talisman (-50% radiace trvale)
            if (state.exoticBonuses?.radResistPermanent > 0) {
                finalAmount = Math.floor(finalAmount * (1 - state.exoticBonuses.radResistPermanent));
            }
            
            state.status.radiation = Math.min(100, state.status.radiation + finalAmount);
            
            // Track max radiation pro achievement
            if (state.status.radiation > (state.stats.maxRadiation || 0)) {
                state.stats.maxRadiation = state.status.radiation;
            }
        }
        
        // Konsolidace invent√°≈ôe - slouƒç√≠ duplicitn√≠ stacky stejn√Ωch item≈Ø
        function consolidateInventory() {
            const stackableTypes = ['consumable', 'resource', 'ammo', 'food', 'throwable'];
            const consolidated = [];
            const seen = {};
            
            state.inv.forEach(item => {
                // P≈ôeskoƒç "money" itemy - pen√≠ze jsou v state.money
                if (item.id === 'money') {
                    // P≈ôeveƒè na skuteƒçn√© pen√≠ze pokud existuj√≠
                    if (item.count) {
                        state.money = (state.money || 0) + item.count;
                    }
                    return; // Nep≈ôid√°vej do invent√°≈ôe
                }
                
                // Itemy s stackId jsou rozdƒõlen√© stacky - NESLUƒåOVAT
                if (item.stackId) {
                    consolidated.push(item);
                    return;
                }
                
                // Stackovateln√© itemy slouƒçit (pouze ty bez stackId)
                if ((stackableTypes.includes(item.type) || item.stackable) && !item.durability) {
                    if (seen[item.id]) {
                        // P≈ôidej k existuj√≠c√≠mu stacku
                        seen[item.id].count = (seen[item.id].count || 1) + (item.count || 1);
                    } else {
                        // Nov√Ω stack
                        const newItem = {...item, count: item.count || 1, stackable: true};
                        seen[item.id] = newItem;
                        consolidated.push(newItem);
                    }
                } else {
                    // Ne-stackovateln√© itemy (zbranƒõ, brnƒõn√≠ s durability)
                    consolidated.push(item);
                }
            });
            
            state.inv = consolidated;
            updateCarryWeight();
        }
        
        function addMoney(amount) {
            // Validace vstupu
            amount = safeInteger(amount, 0);
            if (amount <= 0) return;
            
            // DEBUG: Log pro sledov√°n√≠ V≈†ECH vƒõt≈°√≠ch penƒõ≈æn√≠ch p≈ô√≠jm≈Ø
            if (amount > 100) {
                console.warn(`üí∞ Penƒõ≈æn√≠ p≈ô√≠jem: ${amount}üí∞ (celkem bude: ${(state.money || 0) + amount})`);
                console.trace('Zdroj penƒõz:');
            }
            
            // Ochrana proti extr√©mn√≠m hodnot√°m (max 5000 najednou)
            const MAX_SINGLE_TRANSACTION = 5000;
            if (amount > MAX_SINGLE_TRANSACTION) {
                console.error(`üö® EXTR√âMN√ç penƒõ≈æn√≠ p≈ô√≠jem omezen: ${amount}üí∞ ‚Üí ${MAX_SINGLE_TRANSACTION}`);
                amount = MAX_SINGLE_TRANSACTION;
            }
            
            // P≈ôidej pen√≠ze s kontrolou maxima
            const newTotal = (state.money || 0) + amount;
            state.money = Math.min(newTotal, GAME_CONSTANTS.MAX_MONEY);
            
            // Pokud bylo dosa≈æeno maxima, loguj
            if (newTotal > GAME_CONSTANTS.MAX_MONEY) {
                console.warn(`üí∞ Dosa≈æen limit penƒõz: ${GAME_CONSTANTS.MAX_MONEY}`);
            }
            
            // Statistiky
            state.stats = state.stats || {};
            state.stats.totalMoneyEarned = (state.stats.totalMoneyEarned || 0) + amount;
            
            // Daily quests
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.moneyEarned = (state.dailyQuests.progress.moneyEarned || 0) + amount;
                checkDailyQuests();
            }
            checkAchievements();
            
            // Floating money number (only for significant amounts)
            if (amount >= 10) {
                showFloatingNumber(amount, 'money');
            }
        }
        
        function removeMoney(amount) {
            // Validace
            amount = safeInteger(amount, 0);
            if (amount <= 0) return false;
            
            // Nejprve p≈ôeveƒè pen√≠ze z invent√°≈ôe do state.money
            if (state.inv) {
                state.inv = state.inv.filter(item => {
                    if (item.id === 'money' && item.count) {
                        state.money = (state.money || 0) + item.count;
                        return false; // Odstra≈à z invent√°≈ôe
                    }
                    return true;
                });
            }
            
            if ((state.money || 0) < amount) return false;
            state.money = (state.money || 0) - amount;
            return true;
        }
        
        // === AMMO SYSTEM ===
        function getAmmoCount(ammoType) {
            // Mapov√°n√≠ ammoType na mo≈æn√° ID item≈Ø a n√°zvy
            const ammoIds = {
                'arrow': ['ammo_arrow'],
                'bolt': ['ammo_bolt'],
                '9mm': ['ammo_9mm'],
                '556': ['ammo_556'],
                '762': ['ammo_762'],
                'shell': ['ammo_shell'],
                'fuel': ['ammo_fuel', 'fuel']
            };
            const ammoNames = {
                'arrow': ['≈†√≠py', '≈†√≠p', 'Arrow'],
                'bolt': ['≈†ipky', '≈†ipka', 'Bolt'],
                '9mm': ['N√°boje 9mm', '9mm'],
                '556': ['N√°boje 5.56', '5.56'],
                '762': ['N√°boje 7.62', '7.62'],
                'shell': ['Brokov√© n√°boje', 'Broky', 'Shell'],
                'fuel': ['Palivo', 'Benz√≠n', 'Kanystr', 'Fuel']
            };
            
            const possibleIds = ammoIds[ammoType] || [];
            const possibleNames = ammoNames[ammoType] || [];
            
            // 1. Hledej podle ammoType
            let ammoItem = state.inv.find(i => i.type === 'ammo' && i.ammoType === ammoType);
            if (ammoItem) return ammoItem.count || 1;
            
            // 2. Hledej podle ID
            ammoItem = state.inv.find(i => possibleIds.includes(i.id));
            if (ammoItem) return ammoItem.count || 1;
            
            // 3. Hledej podle n√°zvu (fallback pro star√© save)
            ammoItem = state.inv.find(i => possibleNames.some(n => i.name?.includes(n)));
            if (ammoItem) return ammoItem.count || 1;
            
            // Speci√°ln√≠ p≈ô√≠pad: fuel m≈Ø≈æe b√Ωt i jako resource (Benz√≠n/Palivo)
            if (ammoType === 'fuel') {
                const fuelResource = state.inv.find(i => 
                    i.id === 'fuel' || 
                    (i.type === 'resource' && (i.name === 'Benz√≠n' || i.name === 'Palivo' || i.name?.toLowerCase().includes('palivo') || i.name?.toLowerCase().includes('benz√≠n')))
                );
                if (fuelResource) return fuelResource.count || 1;
                // Nebo v resources
                if (state.resources?.fuel) return state.resources.fuel;
            }
            
            return 0;
        }
        
        function consumeAmmo(ammoType, amount = 1) {
            // Mapov√°n√≠ ammoType na mo≈æn√° ID item≈Ø
            const ammoIds = {
                'arrow': ['ammo_arrow'],
                'bolt': ['ammo_bolt'],
                '9mm': ['ammo_9mm'],
                '556': ['ammo_556'],
                '762': ['ammo_762'],
                'shell': ['ammo_shell'],
                'fuel': ['ammo_fuel', 'fuel']
            };
            
            const possibleIds = ammoIds[ammoType] || [];
            
            // Hledej podle ammoType
            let ammoItem = state.inv.find(i => i.type === 'ammo' && i.ammoType === ammoType);
            
            // Hledej podle ID
            if (!ammoItem) {
                ammoItem = state.inv.find(i => possibleIds.includes(i.id));
            }
            
            // Speci√°ln√≠ p≈ô√≠pad: fuel m≈Ø≈æe b√Ωt i jako resource (Benz√≠n/Palivo)
            if (!ammoItem && ammoType === 'fuel') {
                ammoItem = state.inv.find(i => 
                    i.id === 'fuel' || 
                    (i.type === 'resource' && (i.name === 'Benz√≠n' || i.name === 'Palivo' || i.name?.toLowerCase().includes('palivo') || i.name?.toLowerCase().includes('benz√≠n')))
                );
                // Nebo z resources
                if (!ammoItem && state.resources?.fuel >= amount) {
                    state.resources.fuel -= amount;
                    return true;
                }
            }
            
            if (!ammoItem || (ammoItem.count || 1) < amount) return false;
            
            ammoItem.count = (ammoItem.count || 1) - amount;
            if (ammoItem.count <= 0) {
                state.inv = state.inv.filter(i => i !== ammoItem);
            }
            return true;
        }
        
        function addAmmo(ammoType, amount) {
            const ammoItem = state.inv.find(i => i.type === 'ammo' && i.ammoType === ammoType);
            if (ammoItem) {
                ammoItem.count = (ammoItem.count || 0) + amount;
            } else {
                // Najdi definici n√°boje v ITEMS
                const ammoData = ITEMS.find(i => i.type === 'ammo' && i.ammoType === ammoType);
                if (ammoData) {
                    state.inv.push({...ammoData, count: amount});
                }
            }
        }
        
        function getAmmoName(ammoType) {
            const names = {
                'arrow': '≈†√≠py',
                'bolt': '≈†ipky',
                '9mm': 'N√°boje 9mm',
                '556': 'N√°boje 5.56',
                '762': 'N√°boje 7.62',
                'shell': 'Brokov√© n√°boje',
                'fuel': 'Palivo'
            };
            return names[ammoType] || ammoType;
        }
        
        function pad(n) { return String(n).padStart(2, '0'); }
        
        function addLog(text, icon = '') {
            const time = `Den ${state.time.days}, ${pad(state.time.hours)}:${pad(state.time.mins)}`;
            state.log = state.log || [];
            state.log.push({ time, text: (icon ? icon + ' ' : '') + text, timestamp: Date.now() });
            if (state.log.length > 50) state.log = state.log.slice(-50);
        }
        
        function clearGameLog() {
            state.log = [];
            if (state.settlement) state.settlement.eventLog = [];
            notifySuccess('Den√≠k vymaz√°n');
            renderFull();
        }
        
        // === NOTIFIKACE SYST√âM ===
        // === SYST√âMOV√â NOTIFIKACE (pro mobil) ===
        let systemNotificationsEnabled = false;
        let notificationQueue = [];
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Tento prohl√≠≈æeƒç nepodporuje notifikace');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                systemNotificationsEnabled = true;
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                systemNotificationsEnabled = permission === 'granted';
                return systemNotificationsEnabled;
            }
            
            return false;
        }
        
        function sendSystemNotification(title, body, icon) {
            icon = icon || 'üéÆ';
            // Pou≈æij nov√Ω MobileNotifications syst√©m
            MobileNotifications.send(icon + ' ' + title, {
                body: body,
                tag: 'survival-hero-' + Date.now(),
                renotify: true
            });
            
            // Fallback na star√Ω syst√©m pokud MobileNotifications nen√≠ aktivn√≠
            if (!MobileNotifications.enabled && systemNotificationsEnabled && Notification.permission === 'granted') {
                try {
                    var notification = new Notification('üéÆ ' + title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚ò¢Ô∏è</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚ò¢Ô∏è</text></svg>',
                        tag: 'survival-hero-' + Date.now(),
                        requireInteraction: true,
                        vibrate: [200, 100, 200],
                        renotify: true,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    setTimeout(function() { notification.close(); }, 10000);
                } catch (e) {
                    console.log('Notifikace error:', e);
                }
            }
        }
        
        // Kontrola jestli bƒõ≈æ√≠me jako PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }
        
        // Inicializace notifikac√≠ p≈ôi naƒçten√≠
        document.addEventListener('DOMContentLoaded', () => {
            // Event delegation pro header stats - zabr√°n√≠ Google vyhled√°v√°n√≠
            const headerStats = document.getElementById('headerStats');
            if (headerStats) {
                headerStats.addEventListener('click', (e) => {
                    const statEl = e.target.closest('.stat.clickable');
                    if (statEl) {
                        e.preventDefault();
                        e.stopPropagation();
                        const statType = statEl.dataset.stat;
                        if (statType && typeof window.showStatInfo === 'function') {
                            window.showStatInfo(statType);
                        } else {
                            console.log('showStatInfo not ready, statType:', statType);
                        }
                    }
                });
                
                // Tak√© pro touch eventy na mobilu
                headerStats.addEventListener('touchend', (e) => {
                    const statEl = e.target.closest('.stat.clickable');
                    if (statEl) {
                        e.preventDefault();
                        const statType = statEl.dataset.stat;
                        if (statType && typeof window.showStatInfo === 'function') {
                            window.showStatInfo(statType);
                        }
                    }
                });
            }
            
            // Pokud je PWA, hned po≈æ√°dej o povolen√≠
            if (isPWA()) {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        console.log('‚úì Notifikace povoleny pro PWA');
                    }
                });
            } else {
                // Po≈æ√°dat o povolen√≠ po prvn√≠ interakci
                document.addEventListener('click', function enableNotifications() {
                    requestNotificationPermission();
                    document.removeEventListener('click', enableNotifications);
                }, { once: true });
            }
            
            // Zobraz banner pro povolen√≠ notifikac√≠
            setTimeout(() => {
                if (Notification.permission === 'default') {
                    showNotificationPrompt();
                }
            }, 5000);
        });
        
        function showNotificationPrompt() {
            if (localStorage.getItem('notificationPromptDismissed')) return;
            
            const banner = document.createElement('div');
            banner.id = 'notificationBanner';
            banner.style.cssText = `
                position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
                background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
                border: 2px solid #39FF14; border-radius: 10px; padding: 1rem;
                z-index: 10000; max-width: 90%; width: 350px; text-align: center;
                box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
            `;
            banner.innerHTML = `
                <p style="margin-bottom: 0.8rem; color: #fff;">üîî Chce≈° dost√°vat notifikace o ud√°lostech ve h≈ôe?</p>
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button onclick="enableNotificationsFromBanner()" style="padding: 0.5rem 1rem; background: #39FF14; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Povolit</button>
                    <button onclick="dismissNotificationBanner()" style="padding: 0.5rem 1rem; background: #555; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Ne, d√≠ky</button>
                </div>
            `;
            document.body.appendChild(banner);
        }
        
        function enableNotificationsFromBanner() {
            requestNotificationPermission().then(granted => {
                if (granted) {
                    sendSystemNotification('Notifikace zapnuty!', 'Bude≈° dost√°vat upozornƒõn√≠ o ud√°lostech ve h≈ôe.');
                }
            });
            dismissNotificationBanner();
        }
        
        function dismissNotificationBanner() {
            const banner = document.getElementById('notificationBanner');
            if (banner) banner.remove();
            localStorage.setItem('notificationPromptDismissed', 'true');
        }
        
        function showNotification(title, text, type = 'info', icon = 'üì¢') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${text ? `<div class="notification-text">${text}</div>` : ''}
                </div>
            `;
            
            container.appendChild(notif);
            
            // P≈ôehr√°t zvuk podle typu
            if (type === 'legendary' || type === 'epic') {
                SoundSystem.play('rare_item');
            } else if (type === 'success') {
                SoundSystem.play('pickup');
            } else if (type === 'danger') {
                SoundSystem.play('error');
            }
            
            // Automatick√© odstranƒõn√≠ po animaci
            setTimeout(() => {
                if (notif.parentNode) {
                    notif.parentNode.removeChild(notif);
                }
            }, 4000);
        }
        
        // Pomocn√© funkce pro r≈Øzn√© typy notifikac√≠
        function notifySuccess(title, text = '') {
            showNotification(title, text, 'success', '‚úÖ');
            addLog(title, '‚úÖ');
        }
        
        function notifyWarning(title, text = '') {
            showNotification(title, text, 'warning', '‚ö†Ô∏è');
            addLog(title, '‚ö†Ô∏è');
        }
        
        function notifyDanger(title, text = '') {
            showNotification(title, text, 'danger', '‚ùå');
            addLog(title, '‚ùå');
        }
        
        // Alias pro notifyError
        function notifyError(title, text = '') {
            showNotification(title, text, 'danger', '‚ùå');
            addLog(title, '‚ùå');
        }
        
        function notifyInfo(title, text = '') {
            showNotification(title, text, 'info', '‚ÑπÔ∏è');
            addLog(title, '‚ÑπÔ∏è');
        }
        
        function notifyLoot(itemName, rarity = 'common', icon = 'üéÅ') {
            const rarityTypes = {
                'common': 'info',
                'uncommon': 'success', 
                'rare': 'info',
                'epic': 'epic',
                'legendary': 'legendary'
            };
            const type = rarityTypes[rarity] || 'info';
            showNotification('Nalezeno!', itemName, type, icon);
            addLog(`Nalezeno: ${itemName}`, icon);
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.itemsFound = (state.dailyQuests.progress.itemsFound || 0) + 1;
                checkDailyQuests();
            }
        }
        
        function notifyBuild(buildingName, icon = 'üèóÔ∏è') {
            showNotification('Postaveno!', buildingName, 'success', icon);
            addLog(`Postaveno: ${buildingName}`, icon);
        }
        
        function notifyTravel(locationName, icon = 'üó∫Ô∏è') {
            showNotification('C√≠l dosa≈æen', locationName, 'success', icon);
            addLog(`Dorazil na: ${locationName}`, 'üó∫Ô∏è');
        }
        
        function notifyLevel(level) {
            showNotification(t('notifications', 'levelUp'), `Dosa≈æen level ${level}`, 'legendary', '‚≠ê');
            addLog(`Level up! Nyn√≠ level ${level}`, '‚≠ê');
        }
        
        function notifyQuest(questName, icon = 'üìú') {
            showNotification('Quest splnƒõn!', questName, 'epic', icon);
            addLog(`Quest splnƒõn: ${questName}`, 'üìú');
        }
        
        function notifyCombat(message, isVictory = true) {
            if (isVictory) {
                showNotification(t('combat', 'victory'), message, 'success', '‚öîÔ∏è');
            } else {
                showNotification('Boj!', message, 'warning', '‚öîÔ∏è');
            }
        }
        
        function notifySettlement(message, icon = 'üèòÔ∏è') {
            showNotification('Osada', message, 'info', icon);
            addLog(message, icon);
        }
        
        // === POƒåAS√ç SYST√âM ===
        function updateWeather() {
            const now = Date.now();
            if (now - state.weather.lastChange > state.weather.duration) {
                // Zmƒõna poƒças√≠
                const roll = Math.random();
                let cumulative = 0;
                for (const weather of WEATHER_TYPES) {
                    cumulative += weather.chance;
                    if (roll < cumulative) {
                        if (state.weather.current !== weather.id) {
                            state.weather.current = weather.id;
                            state.weather.lastChange = now;
                            state.weather.duration = (30 + Math.random() * 60) * 60 * 1000; // 30-90 minut
                            addLog('Poƒças√≠ se zmƒõnilo na: ' + getWeatherName(weather.id), weather.icon);
                            
                            // Radiaƒçn√≠ bou≈ôe - speci√°ln√≠ efekt
                            if (weather.id === 'radstorm' && !state.map.inBase) {
                                state.status.radiation = Math.min(100, state.status.radiation + 15);
                                addLog('Radiaƒçn√≠ bou≈ôe! +15 radiace', '‚ò¢Ô∏è');
                            }
                        }
                        break;
                    }
                }
            }
        }
        
        // === OTEV√çRAC√ç DOBA ===
        const SHOP_HOURS = {
            settlement: { open: 6, close: 22, name: 'Obchod v osadƒõ' },
            caravan: { open: 8, close: 20, name: 'Karavana' },
            military: { open: 6, close: 18, name: 'Vojensk√Ω t√°bor' },
            scientists: { open: 0, close: 24, name: 'Laborato≈ô' }, // Non-stop
            mutants: { open: 20, close: 6, name: 'Mutant√≠ trh' }, // Noƒçn√≠!
            blacksmith: { open: 7, close: 19, name: 'Kov√°≈ô' },
            wandering: { open: 10, close: 16, name: 'Potuln√Ω obchodn√≠k' } // Jen p√°r hodin dennƒõ
        };
        
        function isShopOpen(shopType) {
            const hours = SHOP_HOURS[shopType];
            if (!hours) return true; // Nezn√°m√Ω typ = v≈ædy otev≈ôeno
            
            const currentHour = new Date().getHours();
            
            // Speci√°ln√≠ p≈ô√≠pad pro noƒçn√≠ obchody (open > close, nap≈ô. 20-6)
            if (hours.open > hours.close) {
                return currentHour >= hours.open || currentHour < hours.close;
            }
            
            // Non-stop (0-24)
            if (hours.open === 0 && hours.close === 24) return true;
            
            return currentHour >= hours.open && currentHour < hours.close;
        }
        
        function getShopClosedMessage(shopType) {
            const hours = SHOP_HOURS[shopType];
            if (!hours) return 'Zav≈ôeno';
            
            const currentHour = new Date().getHours();
            const openTime = hours.open.toString().padStart(2, '0') + ':00';
            const closeTime = hours.close === 24 ? '24:00' : hours.close.toString().padStart(2, '0') + ':00';
            
            // Kdy otev≈ôe?
            let opensIn;
            if (hours.open > hours.close) {
                // Noƒçn√≠ obchod
                if (currentHour < hours.close) {
                    opensIn = hours.open - currentHour + 24;
                } else {
                    opensIn = hours.open - currentHour;
                }
            } else {
                if (currentHour < hours.open) {
                    opensIn = hours.open - currentHour;
                } else {
                    opensIn = 24 - currentHour + hours.open;
                }
            }
            
            return `üåô ${hours.name} je zav≈ôeno!\n\n‚è∞ Otev√≠rac√≠ doba: ${openTime} - ${closeTime}\n‚è≥ Otev≈ôe za: ${opensIn} hodin`;
        }
        
        // === FRAKCE FUNKCE ===
        function getReputation(factionId) {
            return state.factions[factionId] || 0;
        }
        
        function getReputationLevel(factionId) {
            const rep = getReputation(factionId);
            return REPUTATION_LEVELS.find(l => rep >= l.min && rep <= l.max) || REPUTATION_LEVELS[2]; // default neutral
        }
        
        function getReputationLevelName(levelId) {
            const levelNames = {
                enemy: 'Nep≈ô√≠tel', hostile: 'Nep≈ô√°telsk√Ω', neutral: 'Neutr√°ln√≠', friendly: 'P≈ô√°telsk√Ω', allied: 'Spojenec'
            };
            return levelNames[levelId] || levelId;
        }
        
        function changeReputation(factionId, amount, reason) {
            if (!state.factions) state.factions = {};
            const oldRep = state.factions[factionId] || 0;
            const oldLevel = getReputationLevel(factionId);
            
            state.factions[factionId] = Math.max(-100, Math.min(100, oldRep + amount));
            
            const newLevel = getReputationLevel(factionId);
            const faction = FACTIONS.find(f => f.id === factionId);
            
            // Notifikace
            const sign = amount > 0 ? '+' : '';
            const color = amount > 0 ? '#8bc34a' : '#f44336';
            addLog(`${faction?.icon || 'üë•'} ${faction?.name || factionId}: ${sign}${amount} reputace${reason ? ' (' + reason + ')' : ''}`, faction?.icon || 'üë•');
            
            // Zmƒõna √∫rovnƒõ
            if (oldLevel.id !== newLevel.id) {
                const isImproved = REPUTATION_LEVELS.indexOf(newLevel) > REPUTATION_LEVELS.indexOf(oldLevel);
                const factionName = getFactionName(factionId);
                const oldLevelName = getReputationLevelName(oldLevel.id);
                const newLevelName = getReputationLevelName(newLevel.id);
                showModal(
                    isImproved ? ('üéâ Reputace vzrostla!') : ('‚ö†Ô∏è Reputace klesla!'),
                    `<div style="text-align: center;">
                        <div style="font-size: 3rem;">${faction?.icon || 'üë•'}</div>
                        <h3 style="color: ${faction?.color || '#888'};">${factionName}</h3>
                        <p style="margin: 1rem 0;">
                            <span style="color: ${oldLevel.color};">${oldLevel.icon} ${oldLevelName}</span>
                            <span style="margin: 0 0.5rem;">‚Üí</span>
                            <span style="color: ${newLevel.color};">${newLevel.icon} ${newLevelName}</span>
                        </p>
                        <p style="color: #888; font-size: 0.9rem;">
                            ${isImproved ? getFactionBonusText(factionId) : getFactionPenaltyText(factionId)}
                        </p>
                    </div>`
                );
            }
            
            // Rivalov√© - nƒõkter√© frakce jsou protich≈Ødn√©
            if (amount > 0) {
                // Pomoc obchodn√≠k≈Øm zhor≈°√≠ vztahy s n√°jezdn√≠ky
                if (factionId === 'traders' && amount > 5) {
                    state.factions.raiders = Math.max(-100, (state.factions.raiders || 0) - Math.floor(amount / 2));
                }
                // Pomoc n√°jezdn√≠k≈Øm zhor≈°√≠ vztahy s obchodn√≠ky a vojensk√Ωm
                if (factionId === 'raiders' && amount > 5) {
                    state.factions.traders = Math.max(-100, (state.factions.traders || 0) - Math.floor(amount / 2));
                    state.factions.military = Math.max(-100, (state.factions.military || 0) - Math.floor(amount / 3));
                }
                // Pomoc vƒõdc≈Øm zlep≈°√≠ vztahy s vojensk√Ωm
                if (factionId === 'scientists' && amount > 5) {
                    state.factions.military = Math.min(100, (state.factions.military || 0) + Math.floor(amount / 3));
                }
            }
        }
        
        function getFactionBonusText(factionId) {
            const faction = FACTIONS.find(f => f.id === factionId);
            const rep = getReputation(factionId);
            
            if (rep >= 100 && faction?.bonuses?.allied) {
                return 'üåü ' + faction.bonuses.allied.desc;
            }
            if (rep >= 50 && faction?.bonuses?.friendly) {
                return '‚úÖ ' + faction.bonuses.friendly.desc;
            }
            return '';
        }
        
        function getFactionPenaltyText(factionId) {
            const level = getReputationLevel(factionId);
            
            const penaltyTexts = {
                traders: { hostile: '+50% ceny', enemy: 'Neobchoduj√≠, √∫toƒç√≠' },
                scientists: { hostile: 'Nepom√°haj√≠', enemy: 'Sabotuj√≠ tv√© vybaven√≠' },
                raiders: { hostile: '30% ≈°ance na p≈ôepaden√≠', enemy: '60% p≈ôepaden√≠, raidy na osadu' },
                mutants: { hostile: '√ötoƒç√≠ v rad. z√≥n√°ch', enemy: 'Lov√≠ tƒõ' },
                military: { hostile: 'Neobchoduj√≠ zbranƒõ', enemy: 'St≈ôelba na potk√°n√≠' }
            };
            
            if (level.id === 'hostile' && penaltyTexts[factionId]?.hostile) {
                return '‚ö†Ô∏è ' + penaltyTexts[factionId].hostile;
            }
            if (level.id === 'enemy' && penaltyTexts[factionId]?.enemy) {
                return 'üíÄ ' + penaltyTexts[factionId].enemy;
            }
            return '';
        }
        
        // === AKTIVN√ç FRAKƒåN√ç BONUSY ===
        function getFactionBonuses() {
            const bonuses = {
                // Traders
                priceDiscount: 0,
                specialItems: false,
                freeHealing: false,
                // Scientists  
                craftBonus: 0,
                techAccess: false,
                labAccess: false,
                // Raiders
                safePassage: false,
                blackMarket: false,
                // Mutants
                radResist: 0,
                mutantAllies: false,
                // Military
                weaponAccess: false,
                training: false,
                eliteWeapons: false,
                tacticalBonus: 0
            };
            
            // Traders
            const tradersRep = getReputation('traders');
            const tradersFaction = FACTIONS.find(f => f.id === 'traders');
            if (tradersRep >= 100 && tradersFaction?.bonuses?.allied) {
                bonuses.priceDiscount = tradersFaction.bonuses.allied.priceDiscount || 0;
                bonuses.freeHealing = true;
                bonuses.specialItems = true;
            } else if (tradersRep >= 50 && tradersFaction?.bonuses?.friendly) {
                bonuses.priceDiscount = tradersFaction.bonuses.friendly.priceDiscount || 0;
                bonuses.specialItems = true;
            }
            
            // Scientists
            const scientistsRep = getReputation('scientists');
            const scientistsFaction = FACTIONS.find(f => f.id === 'scientists');
            if (scientistsRep >= 100 && scientistsFaction?.bonuses?.allied) {
                bonuses.craftBonus = 0.05;
                bonuses.techAccess = true;
                bonuses.labAccess = true;
            } else if (scientistsRep >= 50 && scientistsFaction?.bonuses?.friendly) {
                bonuses.craftBonus = scientistsFaction.bonuses.friendly.craftBonus || 0;
                bonuses.techAccess = true;
            }
            
            // Mutants
            const mutantsRep = getReputation('mutants');
            const mutantsFaction = FACTIONS.find(f => f.id === 'mutants');
            if (mutantsRep >= 100 && mutantsFaction?.bonuses?.allied) {
                bonuses.radResist = mutantsFaction.bonuses.allied.radResist || 0;
                bonuses.mutantAllies = true;
            } else if (mutantsRep >= 50 && mutantsFaction?.bonuses?.friendly) {
                bonuses.radResist = mutantsFaction.bonuses.friendly.radResist || 0;
            }
            
            // Military
            const militaryRep = getReputation('military');
            const militaryFaction = FACTIONS.find(f => f.id === 'military');
            if (militaryRep >= 100 && militaryFaction?.bonuses?.allied) {
                bonuses.weaponAccess = true;
                bonuses.training = true;
                bonuses.eliteWeapons = true;
                bonuses.tacticalBonus = militaryFaction.bonuses.allied.tacticalBonus || 0;
            } else if (militaryRep >= 50 && militaryFaction?.bonuses?.friendly) {
                bonuses.weaponAccess = true;
                bonuses.training = true;
            }
            
            return bonuses;
        }
        
        function getPriceModifier() {
            const traderLevel = getReputationLevel('traders');
            const faction = FACTIONS.find(f => f.id === 'traders');
            
            let modifier = 1;
            if (traderLevel.id === 'allied') modifier = 1 - (faction.bonuses.allied.priceDiscount || 0);
            else if (traderLevel.id === 'friendly') modifier = 1 - (faction.bonuses.friendly.priceDiscount || 0);
            else if (traderLevel.id === 'hostile') modifier = 1 + (faction.penalties.hostile.priceIncrease || 0);
            else if (traderLevel.id === 'enemy') modifier = 2; // 2x ceny
            
            // Companion skills price bonus (lep≈°√≠ ceny)
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.priceBonus > 0) {
                modifier -= compBonuses.priceBonus; // Sn√≠≈æen√≠ cen
            }
            
            return Math.max(0.5, modifier); // Minimum 50% ceny
        }
        
        // === JEDNOTN√Å FUNKCE PRO V√ùPOƒåET CENY ===
        // Pou≈æ√≠v√° se v obchodƒõ, n√°kupn√≠m dialogu i p≈ôi n√°kupu
        function calculateItemPrice(basePrice) {
            let price = basePrice;
            
            // 1. Sb√≠rej v≈°echny slevy NEJD≈ò√çVE (p≈ôed markup!)
            let totalDiscount = 0;
            
            // Pohlav√≠ - ≈æeny maj√≠ 5% slevu
            if (state.char?.gender === 'female') {
                totalDiscount += 0.05;
            }
            
            // Trader class passive - sleva z dovednosti (-30%)
            const traderDiscount = getClassPassiveValue('shopDiscount');
            if (traderDiscount) {
                totalDiscount += traderDiscount;
            }
            
            // Reputace s obchodn√≠ky (max 10%)
            const repMod = getPriceModifier();
            if (repMod < 1) {
                totalDiscount += (1 - repMod);
            }
            
            // Osadn√≠k obchodn√≠k - 10% sleva
            const hasTraderSettler = state.settlement?.settlers?.some(s => s.type === 'trader_s');
            if (hasTraderSettler) {
                totalDiscount += 0.10;
            }
            
            // N√°v≈°tƒõvuj√≠c√≠ obchodn√≠k - 10% sleva
            if (state.settlement?.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until) {
                totalDiscount += 0.10;
            }
            
            // NPC bonus (Star√Ω obchodn√≠k apod.)
            const npcBonuses = getNPCBonuses();
            if (npcBonuses.shopDiscount > 0) {
                totalDiscount += npcBonuses.shopDiscount;
            }
            
            // üß≠ Exotic bonus - Obchodnick√Ω kompas
            if (state.exoticBonuses?.shopDiscount > 0) {
                totalDiscount += state.exoticBonuses.shopDiscount;
            }
            
            // MAX 50% sleva celkem! (zv√Ω≈°eno z 40%)
            totalDiscount = Math.min(0.50, totalDiscount);
            
            // 2. Aplikuj slevu na Z√ÅKLADN√ç cenu
            price = Math.floor(price * (1 - totalDiscount));
            
            // 3. MARKUP - obchodn√≠ci maj√≠ mar≈æi (+30%, sn√≠≈æeno z +50%)
            // Ale jen pokud hr√°ƒç NEM√Å trader class (trader nakupuje za velkoobchodn√≠ ceny)
            if (state.char?.classId !== 'trader') {
                price = Math.floor(price * 1.3);
            }
            
            // 4. Inflace (+1% za den, max +20%, sn√≠≈æeno z +30%)
            const inflationRate = Math.min(0.2, (state.time?.days || 0) * 0.01);
            price = Math.floor(price * (1 + inflationRate));
            
            return Math.max(1, price); // Minimum 1 coin
        }
        
        function canTradeWith(factionId) {
            const level = getReputationLevel(factionId);
            const faction = FACTIONS.find(f => f.id === factionId);
            if (level.id === 'enemy' && faction?.penalties?.enemy?.noTrade) return false;
            return true;
        }
        
        function showFactionsModal() {
            const facTexts = {
                noBonusPenalty: '≈Ω√°dn√© bonusy ani postihy',
                howToGetRep: 'Jak z√≠skat reputaci',
                traders: 'Obchodn√≠ci', tradersDesc: 'Obchoduj, pl≈à jejich questy',
                scientists: 'Vƒõdci', scientistsDesc: 'P≈ôines artefakty, pom√°hej s v√Ωzkumem',
                raiders: 'N√°jezdn√≠ci', raidersDesc: 'P≈ôepad√°vej karavany (zhor≈°√≠ ostatn√≠)',
                mutants: 'Mutanti', mutantsDesc: 'Pom√°hej v zamo≈ôen√Ωch z√≥n√°ch',
                military: 'Vojensk√Ω', militaryDesc: 'Eliminuj hrozby, pl≈à rozkazy'
            };
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            FACTIONS.forEach(faction => {
                const rep = getReputation(faction.id);
                const level = getReputationLevel(faction.id);
                const percentage = ((rep + 100) / 200) * 100;
                const factionName = getFactionName(faction.id);
                const factionDesc = getFactionDesc(faction.id);
                const levelName = getReputationLevelName(level.id);
                
                html += `
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 1rem; border-radius: 10px; margin-bottom: 0.8rem; border: 2px solid ${faction.color}40;">
                        <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 2rem;">${faction.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${faction.color};">${factionName}</div>
                                <div style="font-size: 0.75rem; color: #888;">${factionDesc}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${level.color}; font-weight: bold;">${level.icon} ${levelName}</div>
                                <div style="font-size: 0.8rem; color: #666;">${rep > 0 ? '+' : ''}${rep}</div>
                            </div>
                        </div>
                        
                        <!-- Progress bar -->
                        <div style="height: 8px; background: #0a0a0a; border-radius: 4px; overflow: hidden; position: relative; border: 1px solid #333;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${percentage}%; background: linear-gradient(90deg, #8B0000, #f44336, #ff9800, #4caf50, #ffd700); border-radius: 3px;"></div>
                            <div style="position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: #666;"></div>
                        </div>
                        
                        <!-- Bonusy/Penalty -->
                        <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                            ${level.id === 'allied' || level.id === 'friendly' ? 
                                `<span style="color: #8bc34a;">${getFactionBonusText(faction.id)}</span>` : 
                                (level.id === 'hostile' || level.id === 'enemy' ? 
                                    `<span style="color: #f44336;">${getFactionPenaltyText(faction.id)}</span>` : 
                                    `<span style="color: #666;">${facTexts.noBonusPenalty}</span>`
                                )
                            }
                        </div>
                    </div>
                `;
            });
            
            // Tipy
            html += `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-top: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">üí° ${facTexts.howToGetRep}</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">
                        <li>üè™ <strong>${facTexts.traders}:</strong> ${facTexts.tradersDesc}</li>
                        <li>üî¨ <strong>${facTexts.scientists}:</strong> ${facTexts.scientistsDesc}</li>
                        <li>üíÄ <strong>${facTexts.raiders}:</strong> ${facTexts.raidersDesc}</li>
                        <li>‚ò£Ô∏è <strong>${facTexts.mutants}:</strong> ${facTexts.mutantsDesc}</li>
                        <li>üéñÔ∏è <strong>${facTexts.military}:</strong> ${facTexts.militaryDesc}</li>
                    </ul>
                </div>
            `;
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + ('Zav≈ô√≠t') + '</button>';
            
            showModal('üë• Frakce a reputace', html);
        }
        
        // === FRAKƒåN√ç INTERAKCE ===
        function showFactionInteraction(factionId) {
            const faction = FACTIONS.find(f => f.id === factionId);
            if (!faction) return;
            
            const rep = getReputation(factionId);
            const level = getReputationLevel(factionId);
            
            // Bonusy podle levelu
            let bonusesHtml = '<div style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">';
            bonusesHtml += '<h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">üéÅ Bonusy vztahu:</h4>';
            
            const bonusLevels = [
                { id: 'friendly', name: 'P≈ô√°telsk√Ω (50+)', bonus: faction.bonuses?.friendly?.desc || 'Speci√°ln√≠ v√Ωhody', minRep: 50 },
                { id: 'allied', name: 'Spojenec (100+)', bonus: faction.bonuses?.allied?.desc || 'Maxim√°ln√≠ v√Ωhody', minRep: 100 }
            ];
            
            bonusLevels.forEach(bl => {
                const achieved = rep >= bl.minRep;
                bonusesHtml += `<div style="padding: 0.4rem; margin-bottom: 0.3rem; background: ${achieved ? '#1a2a1a' : '#1a1a1a'}; border-radius: 4px; border-left: 3px solid ${achieved ? '#4caf50' : '#333'};">
                    <span style="color: ${achieved ? '#8bc34a' : '#666'};">${achieved ? '‚úÖ' : '‚óã'} ${bl.name}</span>
                    <div style="font-size: 0.75rem; color: #888; margin-left: 1.2rem;">${bl.bonus}</div>
                </div>`;
            });
            bonusesHtml += '</div>';
            
            // Progress bar
            const nextLevel = rep < 50 ? 50 : (rep < 100 ? 100 : 100);
            const progress = Math.min(100, Math.max(0, ((rep + 100) / 200) * 100)); // -100 to 100 range
            
            // Specifick√© tipy pro ka≈ædou frakci
            const factionTips = {
                traders: 'Nakupuj v obchodech, pl≈à obchodn√≠ questy, investuj pen√≠ze',
                military: 'Zab√≠jej mutanty a n√°jezdn√≠ky, tr√©nuj v t√°bo≈ôe, pl≈à mise',
                survivors: 'Zachra≈àuj p≈ôe≈æiv≈°√≠, pom√°hej osad√°m, d√°vej j√≠dlo a vodu',
                scientists: 'P≈ôines vzorky a dokumenty, pomoz s v√Ωzkumem, najdi data',
                mutants: 'P≈ôines mutantn√≠ krev nebo org√°ny, ne√∫toƒç√≠ na mutanty, obchoduj',
                raiders: 'Pozor: N√°jezdn√≠ci jsou nep≈ô√°tel√©! Reputace kles√° p≈ôi boji.'
            };
            
            const tip = factionTips[factionId] || 'Pl≈à questy a obchoduj';
            
            // Dary pro zlep≈°en√≠ reputace
            const giftOptions = {
                traders: { item: 'money', amount: 100, repGain: 5, text: 'üí∞ Investovat 100 penƒõz (+5 rep)' },
                military: { item: 'ammo', ammoType: '9mm', amount: 20, repGain: 3, text: 'üî´ Darovat 20 munice 9mm (+3 rep)' },
                survivors: { item: 'food', amount: 5, repGain: 4, text: 'üçñ Darovat 5 j√≠dla (+4 rep)' },
                scientists: { item: 'chemicals', amount: 10, repGain: 5, text: 'üß™ Darovat 10 chemik√°li√≠ (+5 rep)' },
                mutants: { item: 'mutant_blood', amount: 3, repGain: 8, text: 'ü©∏ Darovat 3 mutantn√≠ krev (+8 rep)' }
            };
            
            const gift = giftOptions[factionId];
            let giftHtml = '';
            if (gift && factionId !== 'raiders') {
                let hasResource = false;
                if (gift.item === 'money') {
                    hasResource = getMoney() >= gift.amount;
                } else if (gift.item === 'ammo') {
                    const ammoType = gift.ammoType || '9mm';
                    const ammoInState = state.ammo?.[ammoType] || 0;
                    const ammoInInv = state.inv.filter(i => i.ammoType === ammoType || i.id === 'ammo_' + ammoType).reduce((sum, i) => sum + (i.count || 1), 0);
                    hasResource = (ammoInState + ammoInInv) >= gift.amount;
                } else if (gift.item === 'food') {
                    const foodItems = state.inv.filter(i => i.type === 'food' || i.id === 'canned_food' || i.id === 'dried_meat' || i.id === 'bread');
                    const totalFood = foodItems.reduce((sum, i) => sum + (i.count || 1), 0);
                    hasResource = totalFood >= gift.amount;
                } else {
                    // Ostatn√≠ itemy z invent√°≈ôe
                    const resourceItem = state.inv.find(i => i.id === gift.item);
                    hasResource = resourceItem && (resourceItem.count || 1) >= gift.amount;
                }
                
                giftHtml = `
                    <button class="btn" onclick="giveFactionGift('${factionId}')" style="width: 100%; margin-top: 0.5rem; background: ${hasResource ? '#4caf50' : '#555'};" ${hasResource ? '' : 'disabled'}>
                        ${gift.text}
                    </button>
                `;
            }
            
            showModal(faction.icon + ' ' + faction.name, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${faction.icon}</div>
                    <p style="color: #888; font-size: 0.9rem;">${faction.desc}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: ${level.color}; font-weight: bold;">${level.icon} ${level.name}</span>
                        <span style="color: #ffd700;">${rep} / 100</span>
                    </div>
                    <div style="background: #0a0a0a; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #f44336, #ff9800, #4caf50);"></div>
                    </div>
                </div>
                
                ${bonusesHtml}
                
                <div style="background: #1a1a2a; padding: 0.6rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <p style="color: #64b5f6; font-size: 0.85rem; margin: 0;">
                        üí° <strong>Jak zv√Ω≈°it reputaci:</strong> ${tip}
                    </p>
                </div>
                
                ${giftHtml}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${t('ui', 'close')}</button>
            `);
        }
        
        // Darov√°n√≠ pro zlep≈°en√≠ reputace
        function giveFactionGift(factionId) {
            const giftOptions = {
                traders: { item: 'money', amount: 100, repGain: 5 },
                military: { item: 'ammo', ammoType: '9mm', amount: 20, repGain: 3 },
                survivors: { item: 'food', amount: 5, repGain: 4 },
                scientists: { item: 'chemicals', amount: 10, repGain: 5 },
                mutants: { item: 'mutant_blood', amount: 3, repGain: 8 }
            };
            
            const gift = giftOptions[factionId];
            if (!gift) return;
            
            // Kontrola zdroj≈Ø
            if (gift.item === 'money') {
                if (getMoney() < gift.amount) {
                    notifyWarning('Nedostatek penƒõz!', `Pot≈ôebuje≈° ${gift.amount} üí∞`);
                    return;
                }
                addMoney(-gift.amount);
            } else if (gift.item === 'ammo') {
                // Speci√°ln√≠ handling pro munici - kontroluj state.ammo A invent√°≈ô
                const ammoType = gift.ammoType || '9mm';
                const ammoInState = state.ammo?.[ammoType] || 0;
                // Tak√© kontroluj invent√°≈ô - vyroben√© n√°boje
                const ammoInInv = state.inv.filter(i => i.ammoType === ammoType || (i.id === 'ammo_' + ammoType)).reduce((sum, i) => sum + (i.count || 1), 0);
                const totalAmmo = ammoInState + ammoInInv;
                
                if (totalAmmo < gift.amount) {
                    notifyWarning('Nedostatek munice!', `Pot≈ôebuje≈° ${gift.amount}x ${ammoType} n√°boj≈Ø (m√°≈° ${totalAmmo})`);
                    return;
                }
                
                // Odeber nejd≈ô√≠v z state.ammo, pak z invent√°≈ôe
                let toRemove = gift.amount;
                if (state.ammo?.[ammoType] > 0) {
                    const fromState = Math.min(toRemove, state.ammo[ammoType]);
                    state.ammo[ammoType] -= fromState;
                    toRemove -= fromState;
                }
                // Zbytek z invent√°≈ôe
                if (toRemove > 0) {
                    const ammoItems = state.inv.filter(i => i.ammoType === ammoType || i.id === 'ammo_' + ammoType);
                    for (const item of ammoItems) {
                        if (toRemove <= 0) break;
                        const count = item.count || 1;
                        if (count <= toRemove) {
                            toRemove -= count;
                            state.inv = state.inv.filter(i => i !== item);
                        } else {
                            item.count -= toRemove;
                            toRemove = 0;
                        }
                    }
                }
            } else if (gift.item === 'food') {
                // J√≠dlo m≈Ø≈æe b√Ωt v invent√°≈ôi jako canned_food, dried_meat, atd.
                const foodItems = state.inv.filter(i => i.type === 'food' || i.id === 'canned_food' || i.id === 'dried_meat' || i.id === 'bread');
                const totalFood = foodItems.reduce((sum, i) => sum + (i.count || 1), 0);
                if (totalFood < gift.amount) {
                    notifyWarning('Nedostatek j√≠dla!', `Pot≈ôebuje≈° ${gift.amount}x j√≠dlo`);
                    return;
                }
                // Odeber j√≠dlo z invent√°≈ôe
                let toRemove = gift.amount;
                for (const item of foodItems) {
                    if (toRemove <= 0) break;
                    const count = item.count || 1;
                    if (count <= toRemove) {
                        toRemove -= count;
                        state.inv = state.inv.filter(i => i !== item);
                    } else {
                        item.count -= toRemove;
                        toRemove = 0;
                    }
                }
            } else {
                // Ostatn√≠ zdroje (chemicals, mutant_blood, atd.) - hledej v invent√°≈ôi
                const resourceItem = state.inv.find(i => i.id === gift.item);
                const currentAmount = resourceItem ? (resourceItem.count || 1) : 0;
                if (currentAmount < gift.amount) {
                    notifyWarning('Nedostatek zdroj≈Ø!', `Pot≈ôebuje≈° ${gift.amount}x ${gift.item}`);
                    return;
                }
                if (resourceItem.count && resourceItem.count > gift.amount) {
                    resourceItem.count -= gift.amount;
                } else {
                    state.inv = state.inv.filter(i => i !== resourceItem);
                }
            }
            
            // P≈ôidej reputaci
            changeReputation(factionId, gift.repGain, 'dar frakci');
            
            const faction = FACTIONS.find(f => f.id === factionId);
            notifySuccess('Dar p≈ôijat!', `+${gift.repGain} reputace s ${faction?.name || factionId}`);
            
            // Refresh modal
            closeModal();
            setTimeout(() => showFactionDetail(factionId), 100);
        }
        
        function openFactionShop(factionId) {
            const faction = FACTIONS.find(f => f.id === factionId);
            if (!faction) return;
            
            const level = getReputationLevel(factionId);
            
            // Sleva/p≈ôir√°≈æka podle reputace
            let priceMultiplier = 1;
            let discountText = '';
            if (level.id === 'allied') {
                priceMultiplier = 0.6;
                discountText = '<span style="color: #8bc34a;">-40% sleva (Spojenec)</span>';
            } else if (level.id === 'friendly') {
                priceMultiplier = 0.8;
                discountText = '<span style="color: #8bc34a;">-20% sleva (P≈ô√°telsk√Ω)</span>';
            } else if (level.id === 'hostile') {
                priceMultiplier = 1.5;
                discountText = '<span style="color: #f44336;">+50% p≈ôir√°≈æka (Nep≈ô√°telsk√Ω)</span>';
            }
            
            // Speci√°ln√≠ zbo≈æ√≠ podle frakce
            let specialItems = [];
            if (factionId === 'traders') {
                specialItems = ITEMS.filter(i => 
                    i.rarity === 'rare' || 
                    i.rarity === 'uncommon' ||
                    i.type === 'food' ||
                    i.type === 'medicine' ||
                    i.type === 'weapon'
                ).slice(0, 15);
            } else if (factionId === 'scientists') {
                specialItems = ITEMS.filter(i => 
                    i.id.includes('stim') || 
                    i.id.includes('rad') || 
                    i.id.includes('chem') ||
                    i.type === 'medicine'
                ).slice(0, 10);
            } else if (factionId === 'military') {
                specialItems = ITEMS.filter(i => 
                    i.type === 'weapon' || 
                    i.type === 'armor' ||
                    i.type === 'ammo'
                ).slice(0, 10);
            } else if (factionId === 'mutants') {
                specialItems = ITEMS.filter(i => 
                    i.id.includes('mutant') || 
                    i.id.includes('rad') ||
                    i.type === 'food'
                ).slice(0, 8);
            } else {
                specialItems = ITEMS.slice(0, 10);
            }
            
            // Filtruj prodejn√© polo≈æky z invent√°≈ôe (ne nasazen√©)
            const sellableItems = state.inv.filter(item => 
                !item.equipped && 
                !isItemEquipped(item) &&
                item.id !== 'water_bottle' &&
                item.id !== 'flashlight'
            );
            
            // Stav shopu - co zobrazujeme
            state.factionShopTab = state.factionShopTab || 'buy';
            state.factionShopPage = state.factionShopPage || 0;
            
            const ITEMS_PER_PAGE = 6;
            const tab = state.factionShopTab;
            
            let contentHtml = '';
            
            if (tab === 'buy') {
                // NAKUPOV√ÅN√ç
                const startIdx = state.factionShopPage * ITEMS_PER_PAGE;
                const pageItems = specialItems.slice(startIdx, startIdx + ITEMS_PER_PAGE);
                const totalPages = Math.ceil(specialItems.length / ITEMS_PER_PAGE);
                
                contentHtml = '<div style="min-height: 280px;">';
                pageItems.forEach(item => {
                    // Pou≈æij item.price, ne item.value (value je efekt, ne cena!)
                    const basePrice = item.price || item.value || 50;
                    // Ujisti se ≈æe cena je kladn√°
                    const price = Math.floor(Math.abs(basePrice) * priceMultiplier);
                    const canAfford = getMoney() >= price;
                    
                    contentHtml += `
                        <div style="display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem; border: 1px solid #333;">
                            <span style="font-size: 1.3rem; width: 30px; text-align: center;">${item.icon}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
                                <div style="font-size: 0.7rem; color: #888;">${item.type || ''}</div>
                            </div>
                            <button class="btn" onclick="buyFromFactionShop('${factionId}', '${item.id}', ${price})" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; white-space: nowrap; ${canAfford ? '' : 'opacity: 0.5;'}"
                                    ${canAfford ? '' : 'disabled'}>
                                Koupit ${price}üí∞
                            </button>
                        </div>
                    `;
                });
                contentHtml += '</div>';
                
                // Navigace str√°nek
                if (totalPages > 1) {
                    contentHtml += `
                        <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn" onclick="state.factionShopPage = Math.max(0, state.factionShopPage - 1); openFactionShop('${factionId}')" 
                                    style="padding: 0.2rem 0.5rem;" ${state.factionShopPage === 0 ? 'disabled style="opacity:0.5"' : ''}>‚óÄ</button>
                            <span style="color: #888;">${state.factionShopPage + 1} / ${totalPages}</span>
                            <button class="btn" onclick="state.factionShopPage = Math.min(${totalPages - 1}, state.factionShopPage + 1); openFactionShop('${factionId}')" 
                                    style="padding: 0.2rem 0.5rem;" ${state.factionShopPage >= totalPages - 1 ? 'disabled style="opacity:0.5"' : ''}>‚ñ∂</button>
                        </div>
                    `;
                }
            } else {
                // PROD√ÅV√ÅN√ç
                if (sellableItems.length === 0) {
                    contentHtml = '<p style="text-align: center; color: #888; padding: 2rem;">Nem√°≈° nic na prodej.</p>';
                } else {
                    const startIdx = state.factionShopPage * ITEMS_PER_PAGE;
                    const pageItems = sellableItems.slice(startIdx, startIdx + ITEMS_PER_PAGE);
                    const totalPages = Math.ceil(sellableItems.length / ITEMS_PER_PAGE);
                    
                    contentHtml = '<div style="min-height: 280px;">';
                    pageItems.forEach((item, idx) => {
                        const actualIdx = startIdx + idx;
                        // Pou≈æij item.price, ne item.value
                        const basePrice = item.price || Math.abs(item.value) || 20;
                        const sellPrice = Math.max(1, Math.floor(basePrice * 0.35)); // 35% hodnoty, min 1
                        const count = item.count || 1;
                        
                        contentHtml += `
                            <div style="display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem; border: 1px solid #333;">
                                <span style="font-size: 1.3rem; width: 30px; text-align: center;">${item.icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: bold; font-size: 0.9rem;">${item.name} ${count > 1 ? `(${count}x)` : ''}</div>
                                    <div style="font-size: 0.7rem; color: #888;">${item.type || ''}</div>
                                </div>
                                <div style="display: flex; gap: 0.3rem;">
                                    <button class="btn" onclick="sellToFactionShop('${factionId}', ${actualIdx}, 1, ${sellPrice})" 
                                            style="padding: 0.25rem 0.4rem; font-size: 0.75rem;">
                                        1x ${sellPrice}üí∞
                                    </button>
                                    ${count > 1 ? `
                                        <button class="btn" onclick="sellToFactionShop('${factionId}', ${actualIdx}, ${count}, ${sellPrice * count})" 
                                                style="padding: 0.25rem 0.4rem; font-size: 0.75rem; background: #4a4a2a;">
                                            V≈°e ${sellPrice * count}üí∞
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    contentHtml += '</div>';
                    
                    // Navigace str√°nek
                    if (totalPages > 1) {
                        contentHtml += `
                            <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <button class="btn" onclick="state.factionShopPage = Math.max(0, state.factionShopPage - 1); openFactionShop('${factionId}')" 
                                        style="padding: 0.2rem 0.5rem;" ${state.factionShopPage === 0 ? 'disabled style="opacity:0.5"' : ''}>‚óÄ</button>
                                <span style="color: #888;">${state.factionShopPage + 1} / ${totalPages}</span>
                                <button class="btn" onclick="state.factionShopPage = Math.min(${totalPages - 1}, state.factionShopPage + 1); openFactionShop('${factionId}')" 
                                        style="padding: 0.2rem 0.5rem;" ${state.factionShopPage >= totalPages - 1 ? 'disabled style="opacity:0.5"' : ''}>‚ñ∂</button>
                            </div>
                        `;
                    }
                }
            }
            
            showModal(faction.icon + ' ' + ('Obchod - ') + faction.name, `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span>üí∞ <strong style="color: #ffd700;">${state.money}</strong></span>
                    ${discountText}
                </div>
                
                <div style="display: flex; gap: 0.3rem; margin-bottom: 0.8rem;">
                    <button class="btn" onclick="state.factionShopTab = 'buy'; state.factionShopPage = 0; openFactionShop('${factionId}')" 
                            style="flex: 1; ${tab === 'buy' ? 'background: var(--rust);' : 'background: #333;'}">
                        üõí ${'Nakoupit'}
                    </button>
                    <button class="btn" onclick="state.factionShopTab = 'sell'; state.factionShopPage = 0; openFactionShop('${factionId}')" 
                            style="flex: 1; ${tab === 'sell' ? 'background: var(--rust);' : 'background: #333;'}">
                        üíµ ${'Prodat'}
                    </button>
                </div>
                
                ${contentHtml}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.8rem; background: #555;">${'Zav≈ô√≠t'}</button>
            `);
        }
        
        function buyFromFactionShop(factionId, itemId, price) {
            const item = ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // Kontrola unique item≈Ø
            if (item.unique) {
                const alreadyHas = state.inv.some(i => i.id === itemId);
                if (alreadyHas) {
                    notifyWarning('U≈æ m√°≈° ' + item.name, 'M≈Ø≈æe≈° m√≠t pouze jeden');
                    return;
                }
            }
            
            if (state.money < price) {
                showModal('‚ùå Nedostatek penƒõz', ('Nem√°≈° dost penƒõz na tento n√°kup!'));
                return;
            }
            
            // Kontrola v√°hy
            const itemWeight = item.weight || 1;
            const currentWeight = calculateCurrentWeight();
            const maxWeight = calculateMaxWeight();
            
            if (currentWeight + itemWeight > maxWeight) {
                showModal('‚ùå Pln√Ω invent√°≈ô', ('Nem√°≈° m√≠sto v invent√°≈ôi!'));
                return;
            }
            
            state.money -= price;
            // P≈ôidej item s fromShop flagem
            const boughtItem = {
                ...item,
                fromShop: true,
                boughtPrice: price
            };
            addItemToInventory(boughtItem);
            addLog(`Koupil jsi ${item.name} za ${price} üí∞`, 'üõí');
            notifySuccess('N√°kup', `${item.icon} ${item.name}`);
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            renderFull();
            openFactionShop(factionId); // Refresh shopu
        }
        
        function sellToFactionShop(factionId, invIndex, amount, totalPrice) {
            const item = state.inv[invIndex];
            if (!item) return;
            
            const count = item.count || 1;
            const toSell = Math.min(amount, count);
            
            addMoney(totalPrice); // Pou≈æij addMoney m√≠sto p≈ô√≠m√©ho p≈ôi≈ôazen√≠
            
            if (toSell >= count) {
                state.inv.splice(invIndex, 1);
            } else {
                item.count = count - toSell;
            }
            
            addLog(`Prodal jsi ${item.name}${toSell > 1 ? ` (${toSell}x)` : ''} za ${totalPrice} üí∞`, 'üíµ');
            notifySuccess('Prod√°no', `+${totalPrice} üí∞`);
            
            // Daily quest progress - sold
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + toSell;
                checkDailyQuests();
            }
            
            renderFull();
            openFactionShop(factionId); // Refresh shopu
        }
        
        function investInFaction(factionId) {
            const amounts = [100, 500, 1000];
            const level = getReputationLevel('traders');
            const currentRep = state.factions?.traders || 0;
            
            // Bonus info podle levelu
            let bonusInfo = '';
            if (level.id === 'allied') {
                bonusInfo = '<div style="background: #1a3a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #4caf50;"><span style="color: #8bc34a;">‚úÖ SPOJENEC: -40% ceny v obchodƒõ, l√©ƒçen√≠ zdarma</span></div>';
            } else if (level.id === 'friendly') {
                bonusInfo = '<div style="background: #2a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #ffd700;"><span style="color: #ffd700;">üëç P≈ò√ÅTELSK√ù: -20% ceny, speci√°ln√≠ zbo≈æ√≠</span></div>';
            } else {
                bonusInfo = '<div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #666;"><span style="color: #888;">Investuj pro lep≈°√≠ vztahy a slevy!</span></div>';
            }
            
            showModal('üí∞ Investice do Obchodn√≠ gildy', `
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <span>üí∞ Tv√© pen√≠ze:</span>
                    <strong style="color: #ffd700;">${state.money}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <span>üìä Reputace:</span>
                    <strong style="color: ${level.color || '#888'};">${currentRep} (${level.name})</strong>
                </div>
                ${bonusInfo}
                
                <div style="display: grid; gap: 0.5rem;">
                    ${amounts.map(a => `
                        <button class="btn" onclick="doInvestment(${a})" style="display: flex; justify-content: space-between; align-items: center; ${state.money >= a ? '' : 'opacity: 0.5; cursor: not-allowed;'}" ${state.money >= a ? '' : 'disabled'}>
                            <span>Investovat ${a} üí∞</span>
                            <span style="color: #8bc34a;">+${Math.floor(a/20)} rep</span>
                        </button>
                    `).join('')}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function doInvestment(amount) {
            if (state.money < amount) {
                notifyWarning(t('notifications', 'notEnoughMoney'), 'Nem√°≈° dost penƒõz!');
                return;
            }
            state.money -= amount;
            const repGain = Math.floor(amount / 20);
            changeReputation('traders', repGain, 'investice');
            
            notifySuccess('Investice!', `+${repGain} reputace u Obchodn√≠ gildy`);
            renderFull();
            
            // Znovu otev≈ôi dialog s aktualizovan√Ωmi hodnotami
            investInFaction('traders');
        }
        
        function showFactionResearch(factionId) {
            showModal('üî¨ Vƒõdeck√Ω v√Ωzkum', `
                <p style="color: #888; margin-bottom: 1rem;">Vƒõdci Enkl√°vy nab√≠zej√≠ pokroƒçil√Ω v√Ωzkum a vylep≈°en√≠.</p>
                
                <div style="display: grid; gap: 0.8rem;">
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 6px; border: 1px solid #00bcd4;">
                        <h4 style="color: #00bcd4; margin: 0;">üíâ Genetick√© vylep≈°en√≠</h4>
                        <p style="color: #888; font-size: 0.85rem;">Trvale +5 max HP.</p>
                        <button class="btn" onclick="buyGeneticUpgrade()" style="margin-top: 0.5rem;">Koupit (150 üí∞)</button>
                    </div>
                    
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 6px; border: 1px solid #00bcd4;">
                        <h4 style="color: #00bcd4; margin: 0;">üìä Mapa radiace</h4>
                        <p style="color: #888; font-size: 0.85rem;">Z√≠skej informace o radiaci v oblasti.</p>
                        <button class="btn" onclick="getRadiationMap()" style="margin-top: 0.5rem;">Koupit (100 üí∞)</button>
                    </div>
                    
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 6px; border: 1px solid #00bcd4;">
                        <h4 style="color: #00bcd4; margin: 0;">üß¨ Stabiliz√°tor mutac√≠</h4>
                        <p style="color: #888; font-size: 0.85rem;">Trval√° imunita v≈Øƒçi nov√Ωm mutac√≠m.</p>
                        <button class="btn" onclick="buyMutationStabilizer()" style="margin-top: 0.5rem;" ${state.mutationImmunity === 'permanent' ? 'disabled' : ''}>
                            ${state.mutationImmunity === 'permanent' ? '‚úì Ji≈æ zakoupeno' : 'Koupit (750 üí∞)'}
                        </button>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function buyGeneticUpgrade() {
            if (getMoney() < 150) {
                notifyError(t('notifications', 'notEnoughMoney'), 'Pot≈ôebuje≈° 150 üí∞');
                return;
            }
            addMoney(-150);
            state.char.maxHp = (state.char.maxHp || 100) + 5;
            state.char.hp = Math.min(state.char.hp + 5, state.char.maxHp);
            
            // Ulo≈æ poƒçet zakoupen√Ωch vylep≈°en√≠ pro perzistenci
            state.geneticUpgrades = (state.geneticUpgrades || 0) + 1;
            
            saveGame(true);
            
            showModal('üíâ Genetick√© vylep≈°en√≠!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üíâ</div>
                    <p style="color: #8bc34a; font-weight: bold;">+5 maxim√°ln√≠ HP!</p>
                    <p style="color: #888;">Nov√© maximum: ${state.char.maxHp} HP</p>
                </div>
                <button class="btn" onclick="closeModal(); showFactionResearch('scientists');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function buyMutationStabilizer() {
            if (state.mutationImmunity === 'permanent') {
                notifyWarning('Ji≈æ m√°≈°', 'U≈æ m√°≈° trvalou imunitu v≈Øƒçi mutac√≠m!');
                return;
            }
            if (getMoney() < 750) {
                notifyError(t('notifications', 'notEnoughMoney'), 'Pot≈ôebuje≈° 750 üí∞');
                return;
            }
            addMoney(-750);
            state.mutationImmunity = 'permanent';
            
            saveGame(true);
            
            showModal('üß¨ Stabiliz√°tor aplikov√°n!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üß¨</div>
                    <p style="color: #8bc34a; font-weight: bold;">TRVAL√Å imunita v≈Øƒçi mutac√≠m!</p>
                    <p style="color: #888;">U≈æ nikdy nez√≠sk√°≈° nov√© mutace.</p>
                </div>
                <button class="btn" onclick="closeModal(); showFactionResearch('scientists');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function openMutantTrade() {
            // Kontrola otev√≠rac√≠ doby - mutanti obchoduj√≠ v NOCI!
            if (!isShopOpen('mutants')) {
                showModal('‚òÄÔ∏è Mutanti se skr√Ωvaj√≠', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">‚ò£Ô∏èüåÖ</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Mutanti se skr√Ωvaj√≠ p≈ôed sluncem!</p>
                        <p style="color: #888; margin: 1rem 0;">‚è∞ Obchod: 20:00 - 06:00 (noc)</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu√°ln√≠ ƒças: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #8bc34a; font-size: 0.8rem; margin-top: 0.5rem;">üåô Vra≈• se po setmƒõn√≠.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            showModal('üß¨ Mutant√≠ obchod', `
                <p style="color: #888; margin-bottom: 1rem;">Mutanti obchoduj√≠ s unik√°tn√≠mi surovinami.</p>
                
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">‚ò£Ô∏è Mutant√≠ krev</span>
                            <p style="color: #888; font-size: 0.75rem; margin: 0;">Pro crafting speci√°ln√≠ch p≈ôedmƒõt≈Ø</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('mutant_blood')" style="padding: 0.3rem 0.6rem;">50 üí∞</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">ü•© Mutant√≠ maso</span>
                            <p style="color: #8bc34a; font-size: 0.75rem; margin: 0;">-80 hlad, +20 HP</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('mutant_meat')" style="padding: 0.3rem 0.6rem;">30 üí∞</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">üíÄ Radaway</span>
                            <p style="color: #ff9800; font-size: 0.75rem; margin: 0;">-50 radiace</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('radaway')" style="padding: 0.3rem 0.6rem;">80 üí∞</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1a1a1a; border-radius: 6px;">
                        <div>
                            <span style="font-size: 1.2rem;">üíé Mutant√≠ krystal</span>
                            <p style="color: #9c27b0; font-size: 0.75rem; margin: 0;">Vz√°cn√° surovina pro v√Ωzkum</p>
                        </div>
                        <button class="btn" onclick="buyMutantItem('mutant_crystal')" style="padding: 0.3rem 0.6rem;">120 üí∞</button>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function buyMutantItem(itemId) {
            const prices = {
                'mutant_blood': 50,
                'mutant_meat': 30,
                'radaway': 80,
                'mutant_crystal': 120
            };
            const price = prices[itemId];
            if (!price) return;
            
            if (state.money < price) {
                notifyError(t('notifications', 'notEnoughMoney'), `Pot≈ôebuje≈° ${price} üí∞`);
                return;
            }
            
            state.money -= price;
            
            const itemNames = {
                'mutant_blood': '‚ò£Ô∏è Mutant√≠ krev',
                'mutant_meat': 'ü•© Mutant√≠ maso',
                'radaway': 'üíÄ Radaway',
                'mutant_crystal': 'üíé Mutant√≠ krystal'
            };
            
            if (itemId === 'mutant_blood' || itemId === 'mutant_crystal') {
                // P≈ôidat jako item do invent√°≈ôe, ne do resources
                const itemDef = ITEMS.find(i => i.id === itemId);
                if (itemDef) {
                    const newItem = { ...itemDef, count: 1, fromShop: true, boughtPrice: price };
                    addItemToInventory(newItem, 1);
                } else {
                    // Fallback pokud nen√≠ v ITEMS
                    state.resources[itemId] = (state.resources[itemId] || 0) + 1;
                }
            } else if (itemId === 'mutant_meat') {
                // P≈ôidej jako konzumovateln√Ω p≈ôedmƒõt
                const meat = {
                    id: 'mutant_meat',
                    name: 'Mutant√≠ maso',
                    icon: 'ü•©',
                    type: 'consumable',
                    effect: 'hunger',
                    value: 80,
                    healValue: 20,
                    count: 1,
                    fromShop: true,
                    boughtPrice: price
                };
                addItemToInventory(meat, 1);
            } else {
                const item = ITEMS.find(i => i.id === itemId);
                if (item) {
                    const boughtItem = { ...item, fromShop: true, boughtPrice: price };
                    addItemToInventory(boughtItem, 1);
                }
            }
            
            notifySuccess('Koupeno!', `Z√≠skal jsi ${itemNames[itemId]}`);
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            openMutantTrade(); // Refresh
        }
        
        function getRadiationMap() {
            if (getMoney() < 100) {
                notifyError(t('notifications', 'notEnoughMoney'), 'Pot≈ôebuje≈° 100 üí∞');
                return;
            }
            addMoney(-100);
            saveGame(true);
            
            // Uk√°≈æ radiaƒçn√≠ info o okoln√≠ch lokac√≠ch
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const connectedLocs = currentLoc?.connections || [];
            
            let radInfo = connectedLocs.map(locId => {
                const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                if (!loc) return '';
                const radLevel = loc.radiation || (loc.zone === 'deadly' ? 'Vysok√°' : loc.zone === 'danger' ? 'St≈ôedn√≠' : 'N√≠zk√°');
                const radColor = radLevel === 'Vysok√°' || loc.zone === 'deadly' ? '#f44336' : 
                                 radLevel === 'St≈ôedn√≠' || loc.zone === 'danger' ? '#ff9800' : '#8bc34a';
                return `<div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin: 0.3rem 0;">
                    <span>${loc.name}</span>
                    <span style="color: ${radColor};">‚ò¢Ô∏è ${radLevel}</span>
                </div>`;
            }).join('');
            
            if (!radInfo) radInfo = '<p style="color: #888;">' + ('≈Ω√°dn√© dostupn√© lokace.') + '</p>';
            
            showModal('üìä Mapa radiace', `
                <p style="color: #888; margin-bottom: 1rem;">Radiaƒçn√≠ √∫rovnƒõ okoln√≠ch lokac√≠:</p>
                ${radInfo}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function showMilitaryTraining() {
            // Kontrola otev√≠rac√≠ doby
            if (!isShopOpen('military')) {
                showModal('üåô T√°bor odpoƒç√≠v√°', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üéñÔ∏èüí§</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Voj√°ci odpoƒç√≠vaj√≠!</p>
                        <p style="color: #888; margin: 1rem 0;">‚è∞ V√Ωcvik: 06:00 - 18:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu√°ln√≠ ƒças: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #555; font-size: 0.8rem; margin-top: 0.5rem;">üí° Vra≈• se r√°no na tr√©nink.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Kontrola ≈æe m√° hr√°ƒç p≈ô√≠stup k tr√©ninku
            const factionBonuses = getFactionBonuses();
            if (!factionBonuses.training) {
                notifyWarning('üîí P≈ô√≠stup odep≈ôen', 'Pot≈ôebuje≈° alespo≈à 50 reputace u Vojensk√©ho remnantu!');
                return;
            }
            
            // Elitn√≠ zbranƒõ jako Allied bonus?
            const eliteWeaponsInfo = factionBonuses.eliteWeapons 
                ? '<p style="color: #ffd700; font-size: 0.85rem; margin-bottom: 0.5rem;">‚≠ê Spojenec: +5% bonus damage v boji!</p>'
                : '<p style="color: #666; font-size: 0.8rem; margin-bottom: 0.5rem;">üí° Na 100 rep z√≠sk√°≈° +5% damage bonus</p>';
            
            showModal('üéñÔ∏è Vojensk√Ω tr√©nink', `
                <p style="color: #888; margin-bottom: 0.5rem;">Vojensk√Ω remnant nab√≠z√≠ bojov√Ω v√Ωcvik.</p>
                ${eliteWeaponsInfo}
                <p style="color: #4caf50; font-size: 0.85rem; margin-bottom: 1rem;">‚ú® Bonusy jsou permanentn√≠!</p>
                
                <div style="display: grid; gap: 0.8rem;">
                    <button class="btn" onclick="doMilitaryTraining('combat')" ${state.money >= 100 && (state.trainingBonuses?.combat || 0) < 0.15 ? '' : 'disabled style="opacity: 0.5;"'}>
                        ‚öîÔ∏è Bojov√Ω tr√©nink (100 üí∞) ‚Üí +5% damage
                        <span style="font-size: 0.75rem; display: block; color: #888;">${state.trainingBonuses?.combat ? Math.round(state.trainingBonuses.combat * 100) + '% / 15% max' : '0% / 15% max'}</span>
                    </button>
                    <button class="btn" onclick="doMilitaryTraining('defense')" ${state.money >= 100 && (state.trainingBonuses?.defense || 0) < 0.15 ? '' : 'disabled style="opacity: 0.5;"'}>
                        üõ°Ô∏è Obrann√Ω tr√©nink (100 üí∞) ‚Üí +5% obrana
                        <span style="font-size: 0.75rem; display: block; color: #888;">${state.trainingBonuses?.defense ? Math.round(state.trainingBonuses.defense * 100) + '% / 15% max' : '0% / 15% max'}</span>
                    </button>
                    <button class="btn" onclick="doMilitaryTraining('survival')" ${state.money >= 75 && (state.trainingBonuses?.survival || 0) < 0.05 ? '' : 'disabled style="opacity: 0.5;"'}>
                        üèïÔ∏è P≈ôe≈æit√≠ (75 üí∞) ‚Üí +5% efektivita j√≠dla/vody
                        <span style="font-size: 0.75rem; display: block; color: #888;">${state.trainingBonuses?.survival ? '‚úì Dokonƒçeno' : 'Jednor√°zov√Ω'}</span>
                    </button>
                </div>
                
                <p style="color: #666; font-size: 0.8rem; margin-top: 1rem; text-align: center;">üí∞ Tv√© pen√≠ze: ${state.money}</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">${t('ui', 'close')}</button>
            `);
        }
        
        function doMilitaryTraining(type) {
            // Validace typu tr√©ninku
            const validTypes = ['combat', 'defense', 'survival'];
            if (!validTypes.includes(type)) {
                console.error('doMilitaryTraining: Neplatn√Ω typ tr√©ninku:', type);
                return;
            }
            
            const costs = { combat: 100, defense: 100, survival: 75 };
            const bonuses = { combat: 0.05, defense: 0.05, survival: 0.05 };
            const maxBonuses = { combat: 0.15, defense: 0.15, survival: 0.05 }; // 3x combat/defense, 1x survival
            const cost = costs[type];
            
            if (!cost || state.money < cost) {
                notifyWarning('Nedostatek penƒõz', `Pot≈ôebuje≈° ${cost} üí∞`);
                return;
            }
            
            // Kontrola limitu
            if (!state.trainingBonuses) state.trainingBonuses = {};
            const currentBonus = state.trainingBonuses[type] || 0;
            const maxBonus = maxBonuses[type];
            
            if (currentBonus >= maxBonus) {
                notifyWarning('Maximum dosa≈æeno', 'U≈æ jsi dos√°hl maxim√°ln√≠ √∫rovnƒõ tohoto tr√©ninku!');
                return;
            }
            
            state.money -= cost;
            changeReputation('military', 5, 'tr√©nink');
            
            // P≈ôidej bonus (5% za tr√©nink)
            const bonusAmount = bonuses[type];
            state.trainingBonuses[type] = Math.min(maxBonus, currentBonus + bonusAmount);
            
            closeModal();
            const typeNames = { combat: 'bojov√Ω', defense: 'obrann√Ω', survival: 'p≈ôe≈æit√≠' };
            const newTotal = Math.round(state.trainingBonuses[type] * 100);
            showModal('‚úÖ Tr√©nink dokonƒçen!', `
                <p>Dokonƒçil jsi ${typeNames[type] || type} tr√©nink!</p>
                <p style="color: #8bc34a;">+5% bonus! (celkem ${newTotal}%)</p>
                ${state.trainingBonuses[type] >= maxBonus ? '<p style="color: #ffd700;">üéñÔ∏è Maximum dosa≈æeno!</p>' : ''}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function hireMercenary() {
            const cost = 500;
            
            showModal('‚öîÔ∏è Najmi ≈æold√°ka', `
                <p style="color: #888; margin-bottom: 1rem;">Vojensk√Ω remnant nab√≠z√≠ ≈æold√°ky na doƒçasnou pomoc.</p>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 6px; border: 1px solid #607d8b; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                        <span style="font-size: 2rem;">üéñÔ∏è</span>
                        <div>
                            <div style="font-weight: bold;">Vojensk√Ω ≈æold√°k</div>
                            <div style="font-size: 0.8rem; color: #888;">+30 damage, +20 obrana na 5 bitev</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="doHireMercenary()" ${state.money >= cost ? '' : 'disabled style="opacity: 0.5;"'}>
                    Najmout za ${cost} üí∞
                </button>
                <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">üí∞ Tv√© pen√≠ze: ${state.money}</p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê ${'Zru≈°it'}</button>
            `);
        }
        
        function doHireMercenary() {
            if (state.money < 500) return;
            state.money -= 500;
            
            state.mercenary = { battles: 5, damage: 30, defense: 20 };
            changeReputation('military', 5, 'tr√©nink');
            
            closeModal();
            showModal('‚úÖ ≈Ωold√°k najat!', `
                <p>Vojensk√Ω ≈æold√°k tƒõ bude doprov√°zet dal≈°√≠ch 5 bitev.</p>
                <p style="color: #8bc34a;">+30 damage, +20 obrana</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // === LABORATO≈ò VƒöDC≈Æ ===
        function openScientistsLab() {
            const factionBonuses = getFactionBonuses();
            if (!factionBonuses.techAccess) {
                notifyWarning('üîí P≈ô√≠stup odep≈ôen', 'Pot≈ôebuje≈° alespo≈à 50 reputace u Vƒõdc≈Ø!');
                return;
            }
            
            const isAllied = factionBonuses.labAccess; // 100+ rep
            
            showModal('üß™ Laborato≈ô Enkl√°vy', `
                <p style="color: #00bcd4; margin-bottom: 1rem;">Vƒõdci ti nab√≠z√≠ sv√© slu≈æby.</p>
                ${isAllied ? '<p style="color: #ffd700; font-size: 0.85rem; margin-bottom: 1rem;">‚≠ê Spojenec: Pr√©miov√© slu≈æby odemƒçeny!</p>' : ''}
                
                <div style="display: grid; gap: 0.8rem;">
                    <button class="btn" onclick="labAnalyzeItem()" style="background: linear-gradient(135deg, #00bcd4, #0097a7);">
                        üî¨ Analyzovat item (50 üí∞)
                        <span style="font-size: 0.75rem; display: block; color: #b2ebf2;">Odhal√≠ skryt√© vlastnosti</span>
                    </button>
                    
                    <button class="btn" onclick="labUpgradeWeapon()" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                        ‚ö° Vylep≈°it zbra≈à (200 üí∞)
                        <span style="font-size: 0.75rem; display: block; color: #ffe0b2;">+10% damage</span>
                    </button>
                    
                    <button class="btn" onclick="labUpgradeArmor()" style="background: linear-gradient(135deg, #3f51b5, #303f9f);">
                        üõ°Ô∏è Vylep≈°it brnƒõn√≠ (200 üí∞)
                        <span style="font-size: 0.75rem; display: block; color: #c5cae9;">+10% defense</span>
                    </button>
                    
                    ${isAllied ? `
                        <button class="btn" onclick="labCreateStimpack()" style="background: linear-gradient(135deg, #4caf50, #388e3c);">
                            üíâ Vyrobit Super Stimpak (100 üí∞ + 5 chemik√°li√≠)
                            <span style="font-size: 0.75rem; display: block; color: #c8e6c9;">L√©ƒç√≠ 150 HP</span>
                        </button>
                        
                        <button class="btn" onclick="labCreateRadaway()" style="background: linear-gradient(135deg, #8bc34a, #689f38);">
                            ‚ò¢Ô∏è Vyrobit Rad-Away+ (75 üí∞ + 3 chemik√°li√≠)
                            <span style="font-size: 0.75rem; display: block; color: #dcedc8;">Odstran√≠ 60 radiace</span>
                        </button>
                    ` : `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px dashed #333; text-align: center;">
                            <p style="color: #666; margin: 0;">üîí Pr√©miov√© slu≈æby</p>
                            <p style="color: #444; font-size: 0.75rem; margin: 0.3rem 0 0 0;">Vy≈æaduje 100 reputace</p>
                        </div>
                    `}
                </div>
                
                <p style="color: #666; font-size: 0.8rem; margin-top: 1rem; text-align: center;">üí∞ Tv√© pen√≠ze: ${state.money} | üß™ Chemik√°lie: ${state.resources?.chemicals || 0}</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">Zav≈ô√≠t</button>
            `);
        }
        
        function labAnalyzeItem() {
            if (state.money < 50) {
                notifyWarning('Nedostatek penƒõz', 'Pot≈ôebuje≈° 50 üí∞');
                return;
            }
            
            // Najdi item k anal√Ωze (zbra≈à nebo brnƒõn√≠ bez analyzed flagu)
            const analyzableItems = state.inv.filter(i => 
                ['weapon', 'armor', 'helmet', 'gloves', 'boots'].includes(i.type) && !i.analyzed
            );
            
            if (analyzableItems.length === 0) {
                notifyWarning('Nic k anal√Ωze', 'Nem√°≈° ≈æ√°dn√© vybaven√≠ k anal√Ωze');
                return;
            }
            
            // Vyber n√°hodn√Ω item
            const item = analyzableItems[Math.floor(Math.random() * analyzableItems.length)];
            state.money -= 50;
            item.analyzed = true;
            
            // Odhal skryt√Ω bonus
            const bonusRoll = Math.random();
            let bonusText = '';
            if (bonusRoll < 0.3) {
                // +5% damage/defense
                if (item.damage) { item.damage = Math.ceil(item.damage * 1.05); bonusText = '+5% damage'; }
                else if (item.defense) { item.defense = Math.ceil(item.defense * 1.05); bonusText = '+5% defense'; }
            } else if (bonusRoll < 0.5) {
                // Durability bonus
                if (item.maxDurability) { item.maxDurability += 20; item.durability = Math.min(item.durability + 20, item.maxDurability); }
                bonusText = '+20 max v√Ωdr≈æ';
            } else {
                bonusText = '≈Ω√°dn√Ω skryt√Ω potenci√°l';
            }
            
            item.name = item.name + ' üî¨';
            
            showModal('üî¨ Anal√Ωza dokonƒçena', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${item.icon}</div>
                    <h3 style="color: #00bcd4;">${item.name}</h3>
                    <p style="color: ${bonusText.includes('≈Ω√°dn√Ω') ? '#888' : '#8bc34a'}; margin: 1rem 0;">${bonusText}</p>
                </div>
                <button class="btn" onclick="openScientistsLab()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>
            `);
            renderFull();
        }
        
        function labUpgradeWeapon() {
            if (state.money < 200) {
                notifyWarning('Nedostatek penƒõz', 'Pot≈ôebuje≈° 200 üí∞');
                return;
            }
            
            const weapon = state.equipped?.weapon;
            if (!weapon) {
                notifyWarning('≈Ω√°dn√° zbra≈à', 'Nasaƒè zbra≈à kterou chce≈° vylep≈°it');
                return;
            }
            
            if (weapon.labUpgraded) {
                notifyWarning('Ji≈æ vylep≈°eno', 'Tato zbra≈à u≈æ byla vylep≈°ena v laborato≈ôi');
                return;
            }
            
            state.money -= 200;
            weapon.damage = Math.ceil(weapon.damage * 1.1);
            weapon.labUpgraded = true;
            weapon.name = weapon.name + ' ‚ö°';
            
            showModal('‚ö° Zbra≈à vylep≈°ena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${weapon.icon}</div>
                    <h3 style="color: #ff9800;">${weapon.name}</h3>
                    <p style="color: #8bc34a; margin: 1rem 0;">Damage: ${weapon.damage} (+10%)</p>
                </div>
                <button class="btn" onclick="openScientistsLab()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>
            `);
            renderFull();
        }
        
        function labUpgradeArmor() {
            if (state.money < 200) {
                notifyWarning('Nedostatek penƒõz', 'Pot≈ôebuje≈° 200 üí∞');
                return;
            }
            
            const armor = state.equipped?.armor;
            if (!armor) {
                notifyWarning('≈Ω√°dn√© brnƒõn√≠', 'Nasaƒè brnƒõn√≠ kter√© chce≈° vylep≈°it');
                return;
            }
            
            if (armor.labUpgraded) {
                notifyWarning('Ji≈æ vylep≈°eno', 'Toto brnƒõn√≠ u≈æ bylo vylep≈°eno v laborato≈ôi');
                return;
            }
            
            state.money -= 200;
            armor.defense = Math.ceil(armor.defense * 1.1);
            armor.labUpgraded = true;
            armor.name = armor.name + ' ‚ö°';
            
            showModal('‚ö° Brnƒõn√≠ vylep≈°eno!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${armor.icon}</div>
                    <h3 style="color: #3f51b5;">${armor.name}</h3>
                    <p style="color: #8bc34a; margin: 1rem 0;">Defense: ${armor.defense} (+10%)</p>
                </div>
                <button class="btn" onclick="openScientistsLab()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>
            `);
            renderFull();
        }
        
        function labCreateStimpack() {
            if (state.money < 100) {
                notifyWarning('Nedostatek penƒõz', 'Pot≈ôebuje≈° 100 üí∞');
                return;
            }
            if ((state.resources?.chemicals || 0) < 5) {
                notifyWarning('Nedostatek chemik√°li√≠', 'Pot≈ôebuje≈° 5 chemik√°li√≠');
                return;
            }
            
            state.money -= 100;
            state.resources.chemicals -= 5;
            
            const superStim = {
                id: 'super_stimpack_lab',
                name: 'Super Stimpak ‚öóÔ∏è',
                icon: 'üíâ',
                type: 'consumable',
                effect: 'health',
                value: 150,
                weight: 0.3,
                price: 200
            };
            
            addItemToInventory(superStim, 1);
            notifySuccess('üíâ Vyrobeno!', 'Super Stimpak (150 HP)');
            openScientistsLab();
        }
        
        function labCreateRadaway() {
            if (state.money < 75) {
                notifyWarning('Nedostatek penƒõz', 'Pot≈ôebuje≈° 75 üí∞');
                return;
            }
            if ((state.resources?.chemicals || 0) < 3) {
                notifyWarning('Nedostatek chemik√°li√≠', 'Pot≈ôebuje≈° 3 chemik√°li√≠');
                return;
            }
            
            state.money -= 75;
            state.resources.chemicals -= 3;
            
            const radawayPlus = {
                id: 'radaway_plus_lab',
                name: 'Rad-Away+ ‚öóÔ∏è',
                icon: '‚ò¢Ô∏è',
                type: 'consumable',
                effect: 'radiation',
                value: -60,
                weight: 0.2,
                price: 150
            };
            
            addItemToInventory(radawayPlus, 1);
            notifySuccess('‚ò¢Ô∏è Vyrobeno!', 'Rad-Away+ (-60 radiace)');
            openScientistsLab();
        }
        
        function cureMutations() {
            const repLevel = getReputationLevel('scientists');
            if (repLevel.id !== 'allied') {
                showModal('‚ùå P≈ô√≠stup odep≈ôen', `
                    <p>L√©ƒçba mutac√≠ vy≈æaduje status Spojenec u Vƒõdc≈Ø Enkl√°vy.</p>
                    <p style="color: #888;">Aktu√°ln√≠ status: ${repLevel.name}</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const mutations = state.mutations || [];
            if (mutations.length === 0) {
                showModal('‚ò£Ô∏è L√©ƒçba mutac√≠', `
                    <p style="color: #8bc34a;">Nem√°≈° ≈æ√°dn√© mutace k vyl√©ƒçen√≠!</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const cost = mutations.length * 200;
            
            let mutationsHtml = mutations.map(m => {
                const mut = MUTATIONS?.find(mut => mut.id === m) || { name: m, icon: 'üß¨' };
                return `<div style="padding: 0.3rem; background: #2a1a2a; margin: 0.2rem 0; border-radius: 4px;">${mut.icon || 'üß¨'} ${mut.name || m}</div>`;
            }).join('');
            
            showModal('‚ò£Ô∏è L√©ƒçba mutac√≠', `
                <p style="color: #888; margin-bottom: 1rem;">Vƒõdci Enkl√°vy mohou odstranit tv√© mutace experiment√°ln√≠ l√©ƒçbou.</p>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Tv√© mutace (${mutations.length}):</div>
                    ${mutationsHtml}
                </div>
                
                <p style="color: #ff9800;">Cena: ${cost} üí∞</p>
                <p style="color: #666; font-size: 0.8rem;">üí∞ Tv√© pen√≠ze: ${state.money}</p>
                
                <button class="btn" onclick="doCureMutations()" ${state.money >= cost ? '' : 'disabled style="opacity: 0.5;"'} style="width: 100%; margin-top: 0.5rem; background: #8bc34a;">
                    üß¨ Vyl√©ƒçit v≈°echny mutace
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">‚Üê ${'Zru≈°it'}</button>
            `);
        }
        
        function doCureMutations() {
            const mutations = state.mutations || [];
            const cost = mutations.length * 200;
            
            if (state.money < cost) {
                notifyError('M√°lo penƒõz!', `Pot≈ôebuje≈° ${cost} üí∞`);
                return;
            }
            
            state.money -= cost;
            const cured = mutations.length;
            state.mutations = [];
            
            // Pokud byl mutant (5 mutac√≠), p≈ôeveƒè zpƒõt na p≈Øvodn√≠ povol√°n√≠
            if (state.char.class === 'mutant') {
                state.char.class = 'survivor'; // V√Ωchoz√≠ povol√°n√≠
                notifySuccess('Promƒõna!', 'U≈æ nejsi mutant!');
            }
            
            closeModal();
            showModal('‚úÖ Mutace vyl√©ƒçeny!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">üß¨</div>
                    <p style="color: #8bc34a; font-weight: bold;">Vyl√©ƒçeno ${cured} mutac√≠!</p>
                    <p style="color: #888;">Tv√© tƒõlo je opƒõt ƒçist√©.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getFactionReputationLevel(factionId) {
            return getReputationLevel(factionId);
        }
        
        function getCurrentWeather() {
            return WEATHER_TYPES.find(w => w.id === state.weather.current) || WEATHER_TYPES[0];
        }
        
        function showWeatherInfo() {
            const weather = getCurrentWeather();
            const timeRemaining = Math.max(0, Math.ceil((state.weather.lastChange + state.weather.duration - Date.now()) / 60000));
            
            // Zjisti jestli m√° havrana s prediction
            const compBonuses = getAllCompanionBonuses();
            const hasPrediction = compBonuses.prediction;
            
            const weatherTexts = {
                weatherEffects: 'Efekty poƒças√≠:', speed: 'Rychlost', radiation: 'Radiace', mood: 'N√°lada',
                combatEffects: 'Bojov√© efekty:', yourDamage: 'Tv≈Øj damage', enemyDamage: 'Enemy damage',
                weatherChange: 'Zmƒõna poƒças√≠ za ~', minutes: 'minut'
            };
            
            // Bojov√© modifik√°tory
            const playerDmgText = weather.effect.playerDmgMod !== 1.0 
                ? `${weather.effect.playerDmgMod > 1 ? '+' : ''}${Math.round((weather.effect.playerDmgMod - 1) * 100)}%`
                : '0%';
            const enemyDmgText = weather.effect.enemyDmgMod !== 1.0 
                ? `${weather.effect.enemyDmgMod > 1 ? '+' : ''}${Math.round((weather.effect.enemyDmgMod - 1) * 100)}%`
                : '0%';
            
            // P≈ôedpovƒõƒè p≈ô√≠≈°t√≠ho poƒças√≠ (pokud m√° havrana s prediction)
            let predictionHtml = '';
            if (hasPrediction) {
                // Simuluj p≈ô√≠≈°t√≠ poƒças√≠ na z√°kladƒõ ≈°anc√≠
                const nextWeatherOptions = WEATHER_TYPES.filter(w => w.chance > 0).sort((a, b) => b.chance - a.chance);
                const topPredictions = nextWeatherOptions.slice(0, 3);
                
                predictionHtml = `
                    <div style="background: linear-gradient(135deg, #1a2a3a, #0a1a2a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #2196f3;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2196f3;">ü¶ÖüîÆ Havranovo proroctv√≠</h4>
                        <p style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">Mo≈æn√© zmƒõny poƒças√≠:</p>
                        ${topPredictions.map(w => `
                            <div style="display: flex; justify-content: space-between; margin: 0.2rem 0;">
                                <span>${w.icon} ${getWeatherName(w.id)}</span>
                                <span style="color: #ffd700;">${Math.round(w.chance * 100)}%</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            showModal(weather.icon + ' ' + getWeatherName(weather.id), `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${weather.icon}</div>
                    <p style="color: #999; margin-top: 0.5rem;">${getWeatherDesc(weather.id)}</p>
                </div>
                
                <h4 style="margin-bottom: 0.5rem;">üìä ${weatherTexts.weatherEffects}</h4>
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="margin: 0.3rem 0;">üö∂ <strong>${weatherTexts.speed}:</strong> ${Math.round(weather.effect.speedMod * 100)}%</p>
                    <p style="margin: 0.3rem 0;">‚ò¢Ô∏è <strong>${weatherTexts.radiation}:</strong> ${weather.effect.radMod > 1 ? '+' : ''}${Math.round((weather.effect.radMod - 1) * 100)}%</p>
                    <p style="margin: 0.3rem 0;">üòä <strong>${weatherTexts.mood}:</strong> ${weather.effect.moodMod > 1 ? '+' : ''}${Math.round((weather.effect.moodMod - 1) * 100)}%</p>
                </div>
                
                <h4 style="margin-bottom: 0.5rem;">‚öîÔ∏è ${weatherTexts.combatEffects}</h4>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a4a2a;">
                    <p style="margin: 0.3rem 0; color: ${weather.effect.playerDmgMod >= 1 ? '#8bc34a' : '#ff9800'};">‚öîÔ∏è <strong>${weatherTexts.yourDamage}:</strong> ${playerDmgText}</p>
                    <p style="margin: 0.3rem 0; color: ${weather.effect.enemyDmgMod <= 1 ? '#8bc34a' : '#ff4444'};">üëπ <strong>${weatherTexts.enemyDamage}:</strong> ${enemyDmgText}</p>
                </div>
                
                ${predictionHtml}
                
                <p style="color: #999; font-size: 0.85rem; text-align: center;">
                    ‚è±Ô∏è ${weatherTexts.weatherChange}${timeRemaining} ${weatherTexts.minutes}
                </p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>
            `);
        }
        
        function showClassAbilityInfo() {
            const classData = CLASSES[state.char.classId];
            if (!classData) return;
            
            showModal(`${classData.icon} ${classData.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${classData.icon}</div>
                    <h3 style="margin: 0; color: ${classData.color};">${classData.name}</h3>
                    <p style="color: #888; margin: 0.3rem 0;">${classData.desc}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffd700;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">‚ö° Aktivn√≠ schopnost</h4>
                    <p style="color: #fff; margin: 0; font-size: 1rem;">${classData.ability}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #2a1a2a, #1a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #9c27b0;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #9c27b0;">üîÆ Pasivn√≠ schopnost</h4>
                    <p style="color: #fff; margin: 0; font-size: 1rem;">${classData.passive}</p>
                </div>
                
                ${classData.bonuses ? `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--toxic-green);">üìä Bonusy k atribut≈Øm</h4>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            ${Object.entries(classData.bonuses).map(([attr, bonus]) => {
                                const attrNames = { str: 'üí™ S√≠la', end: '‚ù§Ô∏è V√Ωdr≈æ', agi: 'üèÉ Obratnost', per: 'üëÅÔ∏è Vn√≠m√°n√≠', int: 'üß† Inteligence', lck: 'üçÄ ≈†tƒõst√≠' };
                                return '<div style="text-align: center;"><div style="color: var(--toxic-green); font-weight: bold;">+' + bonus + '</div><div style="font-size: 0.75rem; color: #888;">' + (attrNames[attr] || attr) + '</div></div>';
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${classData.weapon ? `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--rust-light);">üó°Ô∏è Startovn√≠ zbra≈à</h4>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <span style="font-size: 1.5rem;">${classData.weapon.icon}</span>
                            <span>${classData.weapon.name}</span>
                            <span style="color: #ff4444;">(+${classData.weapon.dmg} DMG)</span>
                        </div>
                    </div>
                ` : ''}
                
                ${classData.restrictions ? `
                    <div style="background: linear-gradient(135deg, #2a1a1a, #1a0a0a); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #c62828;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #c62828;">‚ö†Ô∏è Omezen√≠</h4>
                        <p style="color: #ff6666; margin: 0; font-size: 0.9rem;">${classData.restrictions}</p>
                    </div>
                ` : ''}
                
                ${classData.baseDefense ? `
                    <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #76ff03;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #76ff03;">üõ°Ô∏è P≈ôirozen√° obrana</h4>
                        <p style="color: #76ff03; margin: 0; font-size: 1rem;">+${classData.baseDefense} DEF (mutant√≠ k≈Ø≈æe)</p>
                    </div>
                ` : ''}
                
                ${state.char.classId === 'mutant' ? `
                    <div style="background: linear-gradient(135deg, #1a2a2a, #0a1a1a); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #00bcd4;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #00bcd4;">üß¨ Mutant√≠ odolnost</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">‚ò¢Ô∏è</span>
                                <span style="color: #76ff03;">-50% radiace</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üß™</span>
                                <span style="color: #76ff03;">50% odolnost na jedy</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üí™</span>
                                <span style="color: #76ff03;">+15% DMG v radioaktivn√≠ch z√≥n√°ch</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">‚ù§Ô∏è</span>
                                <span style="color: #76ff03;">+3 HP regenerace p≈ôi z√°sahu</span>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: ${classData.color};">${t('ui', 'close')}</button>
            `);
        }
        
        function showAttackInfo() {
            const weapon = state.equipped?.weapon || null;
            const baseAttack = 5;
            const strBonus = state.char.attrs.str;
            
            // Mutant m√° v≈ædy dr√°py jako z√°lo≈æn√≠ zbra≈à
            let weaponDmg = 0;
            let weaponName = '';
            let weaponIcon = '';
            if (weapon) {
                weaponDmg = weapon.damage;
                weaponName = weapon.name;
                weaponIcon = weapon.icon;
            } else if (state.char.class === 'mutant') {
                weaponDmg = 20;
                weaponName = 'Mutant√≠ dr√°py';
                weaponIcon = 'ü¶é';
            }
            
            let classBonus = 0;
            let classBonusText = '';
            if (state.char.classId === 'raider') {
                classBonus = Math.floor((baseAttack + strBonus + weaponDmg) * 0.3);
                classBonusText = 'Raider (+30%)';
            } else if (state.char.classId === 'berserker') {
                classBonus = Math.floor((baseAttack + strBonus + weaponDmg) * 0.5);
                classBonusText = 'Berserker (+50%)';
            }
            
            let buildingBonus = 0;
            if (state.base.includes('armory')) {
                buildingBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus) * 0.1);
            }
            
            // Mutace bonusy
            let mutationBonus = 0;
            let mutationBonusText = '';
            if (state.mutations?.includes('berserker_blood')) {
                mutationBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus + buildingBonus) * 0.25);
                mutationBonusText = 'üî¥ Berserk≈ô√≠ krev (+25%)';
            }
            
            // Skill tree bonus
            const skillTreeBonus = getSkillTreeBonus('damageBonus');
            let skillBonus = 0;
            if (skillTreeBonus > 0) {
                skillBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus + buildingBonus) * skillTreeBonus);
            }
            
            // Training bonus
            let trainingBonus = 0;
            if (state.trainingBonuses?.combat > 0) {
                trainingBonus = Math.floor((baseAttack + strBonus + weaponDmg + classBonus + buildingBonus + mutationBonus) * state.trainingBonuses.combat);
            }
            
            const total = baseAttack + strBonus + weaponDmg + classBonus + buildingBonus + mutationBonus + skillBonus + trainingBonus;
            
            const coatingInfo = state.weaponCoating ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>${state.weaponCoating.effect === 'poison' ? 'üß™ Jedov√Ω povlak' : 'üî• Z√°paln√Ω povlak'}</span>
                    <span style="color: ${state.weaponCoating.effect === 'poison' ? '#9c27b0' : '#ff5722'};">${state.weaponCoating.uses} pou≈æit√≠</span>
                </div>
            ` : '';
            
            const specialInfo = weapon?.special ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>‚≠ê Speci√°ln√≠ efekt</span>
                    <span style="color: #ffd700;">${
                        weapon.special === 'poison' ? '‚ò†Ô∏è Jed 30%' :
                        weapon.special === 'bleed' ? 'ü©∏ Krv√°cen√≠ 25%' :
                        weapon.special === 'stun' ? 'üí´ Omr√°ƒçen√≠ 20%' :
                        weapon.special
                    }</span>
                </div>
            ` : '';
            
            // Mutant regenerace info
            const mutantInfo = state.char.class === 'mutant' ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>ü¶é Regenerace</span>
                    <span style="color: #76ff03;">+2 HP/z√°sah</span>
                </div>
            ` : '';
            
            showModal('‚öîÔ∏è √ötok - Detaily', `
                <div style="background: linear-gradient(135deg, #2a1a1a, #1a0a0a); padding: 1rem; border-radius: 10px; border: 2px solid #8B0000; margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: #ff4444; font-weight: bold;">‚öîÔ∏è ${total}</div>
                    <div style="text-align: center; color: #888;">Celkov√Ω √∫tok</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #ff6666;">üìä Slo≈æen√≠ √∫toku:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>ü•ä Z√°kladn√≠ √∫tok</span>
                        <span style="color: #8bc34a;">+${baseAttack}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>üí™ S√≠la (STR ${state.char.attrs.str})</span>
                        <span style="color: #8bc34a;">+${strBonus}</span>
                    </div>
                    ${weaponDmg > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${weaponIcon} ${weaponName}</span>
                            <span style="color: #8bc34a;">+${weaponDmg}</span>
                        </div>
                    ` : `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>‚úä Hol√© ruce</span>
                            <span style="color: #666;">+0</span>
                        </div>
                    `}
                    ${classBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>üé≠ ${classBonusText}</span>
                            <span style="color: #ffd700;">+${classBonus}</span>
                        </div>
                    ` : ''}
                    ${buildingBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>üèõÔ∏è Zbrojnice (+10%)</span>
                            <span style="color: #ffd700;">+${buildingBonus}</span>
                        </div>
                    ` : ''}
                    ${mutationBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${mutationBonusText}</span>
                            <span style="color: #f44336;">+${mutationBonus}</span>
                        </div>
                    ` : ''}
                    ${skillBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>üìö Skill tree (+${Math.round(skillTreeBonus * 100)}%)</span>
                            <span style="color: #64b5f6;">+${skillBonus}</span>
                        </div>
                    ` : ''}
                    ${trainingBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>üéñÔ∏è Vojensk√Ω tr√©nink (+${Math.round(state.trainingBonuses.combat * 100)}%)</span>
                            <span style="color: #9c27b0;">+${trainingBonus}</span>
                        </div>
                    ` : ''}
                    ${coatingInfo}
                    ${specialInfo}
                    ${mutantInfo}
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">üí° Jak zv√Ω≈°it √∫tok</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy≈° atribut S√≠la (STR)</li>
                        <li>Vyrob√≠ si lep≈°√≠ zbra≈à</li>
                        <li>Postav Zbrojnici v osadƒõ (+10%)</li>
                        <li>Pou≈æij povlak na zbra≈à</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function showDefenseInfo() {
            const armor = state.equipped?.armor || null;
            const helmet = state.equipped?.helmet || null;
            const gloves = state.equipped?.gloves || null;
            const boots = state.equipped?.boots || null;
            const accessory = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
            
            const endBonus = Math.floor(state.char.attrs.end * 0.5);
            const armorDef = armor ? armor.defense : 0;
            const helmetDef = helmet ? helmet.defense : 0;
            const glovesDef = gloves ? gloves.defense : 0;
            const bootsDef = boots ? boots.defense : 0;
            const accDef = (accessory?.bonus === 'defense') ? accessory.value : 0;
            const mutantDef = state.char.class === 'mutant' ? 10 : 0;
            
            const total = endBonus + armorDef + helmetDef + glovesDef + bootsDef + accDef + mutantDef;
            
            // Mutant info
            const mutantInfo = state.char.class === 'mutant' ? `
                <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                    <span>ü¶é Mutant√≠ k≈Ø≈æe</span>
                    <span style="color: #76ff03;">+10</span>
                </div>
                <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; border: 1px solid #76ff03;">
                    <p style="color: #76ff03; margin: 0; font-size: 0.8rem;">‚ö†Ô∏è Nem≈Ø≈æe≈° nosit brnƒõn√≠ ani helmy - jsi p≈ô√≠li≈° velk√Ω!</p>
                </div>
            ` : '';
            
            showModal('üõ°Ô∏è Obrana - Detaily', `
                <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 10px; border: 2px solid var(--toxic-dark); margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: var(--toxic-green); font-weight: bold;">üõ°Ô∏è ${total}</div>
                    <div style="text-align: center; color: #888;">Celkov√° obrana</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #8bc34a;">üìä Slo≈æen√≠ obrany:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>üíö V√Ωdr≈æ (END ${state.char.attrs.end})</span>
                        <span style="color: #8bc34a;">+${endBonus}</span>
                    </div>
                    ${mutantInfo}
                    ${armor && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${armor.icon} ${armor.name}</span>
                            <span style="color: #8bc34a;">+${armorDef}</span>
                        </div>
                    ` : (state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>üëï Bez zbroje</span>
                            <span style="color: #666;">+0</span>
                        </div>
                    ` : '')}
                    ${helmet && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${helmet.icon} ${helmet.name}</span>
                            <span style="color: #8bc34a;">+${helmetDef}</span>
                        </div>
                    ` : ''}
                    ${gloves && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${gloves.icon} ${gloves.name}</span>
                            <span style="color: #ff9800;">+${glovesDef}</span>
                        </div>
                    ` : ''}
                    ${boots && state.char.class !== 'mutant' ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${boots.icon} ${boots.name}</span>
                            <span style="color: #00bcd4;">+${bootsDef}</span>
                        </div>
                    ` : ''}
                    ${accDef > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${accessory.icon} ${accessory.name}</span>
                            <span style="color: #ffd700;">+${accDef}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">üí° Jak zv√Ω≈°it obranu</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy≈° atribut V√Ωdr≈æ (END)</li>
                        ${state.char.class !== 'mutant' ? '<li>Vyrob√≠ si lep≈°√≠ zbroj a helmu</li>' : ''}
                        <li>Nasaƒè Drahokamov√Ω p≈ô√≠vƒõsek (+10)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function showCritInfo() {
            const perBonus = (state.char.attrs.per - 5) * 3;
            const lckBonus = (state.char.attrs.lck - 5) * 2;
            const baseCrit = 5;
            
            let classBonus = 0;
            let classBonusText = '';
            if (state.char.classId === 'assassin') {
                classBonus = 40;
                classBonusText = 'Assassin (+40%)';
            }
            
            const accessory = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
            const accBonus = (accessory?.bonus === 'crit') ? accessory.value : 0;
            
            const total = Math.min(75, baseCrit + Math.max(0, perBonus) + Math.max(0, lckBonus) + classBonus + accBonus);
            
            showModal('üí• Kritick√Ω z√°sah - Detaily', `
                <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 1rem; border-radius: 10px; border: 2px solid var(--warning-yellow); margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: var(--warning-yellow); font-weight: bold;">üí• ${total}%</div>
                    <div style="text-align: center; color: #888;">≈†ance na kritick√Ω z√°sah</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #ffd700;">üìä Slo≈æen√≠ kritu:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>üéØ Z√°kladn√≠ ≈°ance</span>
                        <span style="color: #8bc34a;">+${baseCrit}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>üëÅÔ∏è Vn√≠m√°n√≠ (PER ${state.char.attrs.per})</span>
                        <span style="color: ${perBonus >= 0 ? '#8bc34a' : '#ff6666'};">${perBonus >= 0 ? '+' : ''}${perBonus}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>üçÄ ≈†tƒõst√≠ (LCK ${state.char.attrs.lck})</span>
                        <span style="color: ${lckBonus >= 0 ? '#8bc34a' : '#ff6666'};">${lckBonus >= 0 ? '+' : ''}${lckBonus}%</span>
                    </div>
                    ${classBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>üé≠ ${classBonusText}</span>
                            <span style="color: #ffd700;">+${classBonus}%</span>
                        </div>
                    ` : ''}
                    ${accBonus > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>${accessory.icon} ${accessory.name}</span>
                            <span style="color: #ffd700;">+${accBonus}%</span>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #8B0000; margin-bottom: 1rem;">
                    <div style="color: #ff6666; font-weight: bold;">‚öîÔ∏è Kritick√Ω z√°sah = 2x damage!</div>
                    <div style="color: #aaa; font-size: 0.85rem;">Maximum: 75%</div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">üí° Jak zv√Ω≈°it krit</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy≈° atribut Vn√≠m√°n√≠ (PER) - +3% za bod</li>
                        <li>Zvy≈° atribut ≈†tƒõst√≠ (LCK) - +2% za bod</li>
                        <li>Nasaƒè Krystalov√Ω fokus (+15%)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function showDodgeInfo() {
            const baseDodge = 2;
            const agiBonus = (state.char.attrs.agi - 5) * 2;
            
            const total = Math.min(40, baseDodge + Math.max(0, agiBonus));
            
            showModal('üí® √öhyb - Detaily', `
                <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 1rem; border-radius: 10px; border: 2px solid #3949AB; margin-bottom: 1rem;">
                    <div style="text-align: center; font-size: 3rem; color: #7986CB; font-weight: bold;">üí® ${total}%</div>
                    <div style="text-align: center; color: #888;">≈†ance na √∫hyb</div>
                </div>
                
                <h4 style="margin-bottom: 0.5rem; color: #7986CB;">üìä Slo≈æen√≠ √∫hybu:</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>ü¶∂ Z√°kladn√≠ ≈°ance</span>
                        <span style="color: #8bc34a;">+${baseDodge}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                        <span>‚ö° Obratnost (AGI ${state.char.attrs.agi})</span>
                        <span style="color: ${agiBonus >= 0 ? '#8bc34a' : '#ff6666'};">${agiBonus >= 0 ? '+' : ''}${agiBonus}%</span>
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--toxic-dark); margin-bottom: 1rem;">
                    <div style="color: #8bc34a; font-weight: bold;">üõ°Ô∏è √öhyb = ≈Ω√°dn√© zranƒõn√≠!</div>
                    <div style="color: #aaa; font-size: 0.85rem;">Maximum: 40%</div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">üí° Jak zv√Ω≈°it √∫hyb</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Zvy≈° atribut Obratnost (AGI) - +2% za bod nad 5</li>
                        <li>V boji pou≈æij akci üí® √öhyb (100% na 1 kolo)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        // === INFO O SUROVINƒö ===
        function showResourceInfo(key, icon, name, desc, color) {
            const amount = state.resources[key] || 0;
            
            // Najdi craftingy kter√© tuto surovinu pou≈æ√≠vaj√≠
            const usedIn = CRAFTING.filter(c => c.requires && c.requires[key]).slice(0, 5);
            
            // Najdi zbranƒõ kter√© pou≈æ√≠vaj√≠ tuto surovinu jako munici (nap≈ô. palivo pro ≈ôetƒõzovou pilu)
            const weaponsUsing = ITEMS.filter(i => i.type === 'weapon' && i.ammoType === key);
            
            // Kontrola trvanlivosti
            const perishable = {
                'raw_meat': { days: 2, name: 'Syrov√© maso' },
                'fish': { days: 2, name: 'Ryba' },
                'herbs': { days: 5, name: 'Byliny' }
            };
            
            let freshness = '';
            if (perishable[key] && amount > 0) {
                const timestamp = state.foodTimestamps?.[key] || state.time.days;
                const daysSince = state.time.days - timestamp;
                const daysLeft = perishable[key].days - daysSince;
                
                let freshColor = '#8bc34a';
                let freshText = 'ƒåerstv√©';
                if (daysLeft <= 1) {
                    freshColor = '#f44336';
                    freshText = '‚ö†Ô∏è ZKAZ√ç SE DNES!';
                } else if (daysLeft <= 2) {
                    freshColor = '#ff9800';
                    freshText = '‚ö†Ô∏è Brzy se zkaz√≠!';
                } else if (daysLeft <= 4) {
                    freshColor = '#ffc107';
                    freshText = 'Je≈°tƒõ ƒçerstv√©';
                }
                
                const daysWord = daysLeft === 1 ? 'den' : daysLeft < 5 ? 'dny' : 'dn√≠';
                freshness = `
                    <div style="background: #1a1a0a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid ${freshColor};">
                        <div style="color: ${freshColor}; font-weight: bold; font-size: 1.1rem;">üïê ${freshText}</div>
                        <div style="color: #888; font-size: 0.8rem; margin-top: 0.3rem;">${'Zb√Ωv√°'} ${daysLeft} ${daysWord}</div>
                        <div style="background: #0a0a0a; height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="height: 100%; width: ${(daysLeft / perishable[key].days) * 100}%; background: linear-gradient(90deg, ${freshColor}, ${daysLeft > 4 ? '#8bc34a' : freshColor}); transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }
            
            showModal(`${icon} ${name}`, `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${icon}</div>
                    <h2 style="color: ${color}; margin: 0.5rem 0;">${name}</h2>
                    <p style="color: #888; font-size: 0.9rem;">${desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${color};">
                        <div style="font-size: 2rem; font-weight: bold; color: ${color};">${amount}</div>
                        <div style="color: #888; font-size: 0.8rem;">${'v invent√°≈ôi'}</div>
                    </div>
                    
                    ${freshness}
                    
                    ${usedIn.length > 0 ? `
                        <div style="text-align: left; margin-top: 1rem;">
                            <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">üîß ${'Pou≈æ√≠v√° se na:'}</div>
                            ${usedIn.map(c => `
                                <div style="background: #0a0a0a; padding: 0.4rem; margin: 0.3rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${c.icon || 'üì¶'} ${c.name || c.id}</span>
                                    <span style="color: ${c.requires[key] <= amount ? '#8bc34a' : '#f44336'}; font-size: 0.8rem;">${c.requires[key]}x</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${weaponsUsing.length > 0 ? `
                        <div style="text-align: left; margin-top: 1rem;">
                            <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">‚öîÔ∏è ${'Munice pro zbranƒõ:'}</div>
                            ${weaponsUsing.map(w => `
                                <div style="background: #0a0a0a; padding: 0.4rem; margin: 0.3rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${w.icon} ${w.name}</span>
                                    <span style="color: #ff9800; font-size: 0.8rem;">‚öîÔ∏è ${w.damage} DMG</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${'Zav≈ô√≠t'}</button>
            `);
        }
        
        function showEquipmentSlot(slotType) {
            // Najdi aktu√°lnƒõ nasazen√© vybaven√≠
            let equipped = null;
            let available = [];
            let slotName = '';
            let slotIcon = '';
            let statName = '';
            let statIcon = '';
            
            // Lokalizovan√© n√°zvy
            const slotNames = {
                helmet: 'Helma',
                weapon: 'Zbra≈à',
                armor: 'Zbroj',
                gloves: 'Rukavice',
                boots: 'Boty'
            };
            const statNames = {
                defense: 'Obrana',
                attack: '√ötok'
            };
            
            if (slotType === 'helmet') {
                equipped = state.equipped?.helmet || null;
                available = state.inv.filter(i => i.type === 'helmet');
                slotName = slotNames.helmet;
                slotIcon = '‚õëÔ∏è';
                statName = statNames.defense;
                statIcon = 'üõ°Ô∏è';
            } else if (slotType === 'weapon') {
                equipped = state.equipped?.weapon || null;
                available = state.inv.filter(i => i.type === 'weapon');
                slotName = slotNames.weapon;
                slotIcon = '‚öîÔ∏è';
                statName = statNames.attack;
                statIcon = '‚öîÔ∏è';
            } else if (slotType === 'armor') {
                equipped = state.equipped?.armor || null;
                available = state.inv.filter(i => i.type === 'armor');
                slotName = slotNames.armor;
                slotIcon = 'üõ°Ô∏è';
                statName = statNames.defense;
                statIcon = 'üõ°Ô∏è';
            } else if (slotType === 'gloves') {
                equipped = state.equipped?.gloves || null;
                available = state.inv.filter(i => i.type === 'gloves');
                slotName = slotNames.gloves;
                slotIcon = 'ü•ä';
                statName = statNames.defense;
                statIcon = 'üõ°Ô∏è';
            } else if (slotType === 'boots') {
                equipped = state.equipped?.boots || null;
                available = state.inv.filter(i => i.type === 'boots');
                slotName = slotNames.boots;
                slotIcon = 'ü•æ';
                statName = statNames.defense;
                statIcon = 'üõ°Ô∏è';
            }
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Aktu√°lnƒõ nasazen√©
            html += `<h4 style="color: var(--toxic-green); margin-bottom: 0.5rem;">${slotIcon} ${'Nasazeno:'} ${slotName}</h4>`;
            if (equipped) {
                const statValue = slotType === 'weapon' ? equipped.damage : equipped.defense;
                const durabilityBar = equipped.durability !== undefined ? `
                    <div style="margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.2rem;">
                            <span>üîß Stav</span>
                            <span>${equipped.durability}/${equipped.maxDurability}</span>
                        </div>
                        <div style="height: 6px; background: #1a1a1a; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${(equipped.durability/equipped.maxDurability)*100}%; background: ${(equipped.durability/equipped.maxDurability) > 0.5 ? '#8bc34a' : (equipped.durability/equipped.maxDurability) > 0.2 ? '#ff9800' : '#f44336'};"></div>
                        </div>
                    </div>
                ` : '';
                
                const specialText = equipped.special ? `<div style="color: #ffd700; font-size: 0.8rem; margin-top: 0.3rem;">‚≠ê Speci√°l: ${
                    equipped.special === 'poison' ? '‚ò†Ô∏è Jed (30% otr√°v√≠)' :
                    equipped.special === 'bleed' ? 'ü©∏ Krv√°cen√≠ (25%)' :
                    equipped.special === 'stun' ? 'üí´ Omr√°ƒçen√≠ (20%)' :
                    equipped.special === 'rad_resist' ? '‚ò¢Ô∏è Odolnost radiaci' :
                    equipped.special === 'rad_immune' ? '‚ò¢Ô∏è -50% radiace' :
                    equipped.special
                }</div>` : '';
                
                // Zobraz coating pokud je weapon
                const coatingText = (slotType === 'weapon' && state.weaponCoating) ? `
                    <div style="color: ${state.weaponCoating.effect === 'poison' ? '#9c27b0' : '#ff5722'}; font-size: 0.8rem; margin-top: 0.3rem;">
                        ${state.weaponCoating.effect === 'poison' ? 'üß™ Jedov√Ω povlak' : 'üî• Z√°paln√Ω povlak'}: ${state.weaponCoating.uses} pou≈æit√≠
                    </div>
                ` : '';
                
                // Zobraz n√°boje pokud je weapon s ammoType
                const ammoText = (slotType === 'weapon' && equipped.ammoType) ? `
                    <div style="color: ${getAmmoCount(equipped.ammoType) > 0 ? '#4caf50' : '#f44336'}; font-size: 0.85rem; margin-top: 0.3rem;">
                        üî∏ N√°boje (${getAmmoName(equipped.ammoType)}): <strong>${getAmmoCount(equipped.ammoType)}</strong>
                        ${getAmmoCount(equipped.ammoType) === 0 ? ' <span style="color: #ff9800;">‚ö†Ô∏è Nelze st≈ô√≠let!</span>' : ''}
                    </div>
                ` : '';
                
                html += `
                    <div style="background: linear-gradient(135deg, #2a2a2a, #1a1a1a); padding: 1rem; border-radius: 10px; border: 2px solid var(--toxic-dark); margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 3rem;">${equipped.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #fff; font-size: 1.1rem;">${equipped.name}</div>
                                <div style="color: #8bc34a; font-size: 0.9rem;">${statIcon} ${statName}: +${statValue}</div>
                                ${specialText}
                                ${coatingText}
                                ${ammoText}
                                ${durabilityBar}
                            </div>
                        </div>
                        <button class="btn" onclick="unequipItem('${slotType}')" style="width: 100%; margin-top: 0.8rem; background: #c62828; padding: 0.5rem;">
                            ‚ùå ${'Sundat'}
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; border: 2px dashed #444; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 2rem; color: #555;">${slotIcon}</div>
                        <div style="color: #666;">${'Nic nenasazeno'}</div>
                    </div>
                `;
            }
            
            // Dostupn√© v invent√°≈ôi
            html += `<h4 style="color: var(--warning-yellow); margin-bottom: 0.5rem;">üì¶ ${'Dostupn√© v invent√°≈ôi'}</h4>`;
            if (available.length > 0) {
                html += '<div style="display: grid; gap: 0.5rem;">';
                available.forEach(item => {
                    const isEquipped = (slotType === 'weapon' && state.equipped?.weapon?.id === item.id) ||
                                       (slotType === 'armor' && state.equipped?.armor?.id === item.id) ||
                                       (slotType === 'helmet' && state.equipped?.helmet?.id === item.id) ||
                                       (slotType === 'gloves' && state.equipped?.gloves?.id === item.id) ||
                                       (slotType === 'boots' && state.equipped?.boots?.id === item.id);
                    const statValue = slotType === 'weapon' ? item.damage : item.defense;
                    const specialIcon = item.special ? ' ‚≠ê' : '';
                    const clickAction = isEquipped ? '' : `equipItem('${item.id}', '${slotType}')`;
                    const cursor = isEquipped ? 'default' : 'pointer';
                    
                    // Poƒçet n√°boj≈Ø pro zbranƒõ
                    const ammoInfo = (slotType === 'weapon' && item.ammoType) ? 
                        `<span style="color: ${getAmmoCount(item.ammoType) > 0 ? '#4caf50' : '#f44336'}; font-size: 0.75rem; margin-left: 0.5rem;">üî∏${getAmmoCount(item.ammoType)}</span>` : '';
                    
                    html += `
                        <div onclick="${clickAction}" style="background: ${isEquipped ? '#1a2a1a' : '#2a2a2a'}; padding: 0.8rem; border-radius: 8px; border: 2px solid ${isEquipped ? '#8bc34a' : '#444'}; display: flex; align-items: center; gap: 0.8rem; cursor: ${cursor}; ${!isEquipped ? 'transition: all 0.2s; ' : ''}">
                            <div style="font-size: 2rem;">${item.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${isEquipped ? '#8bc34a' : '#fff'};">${getItemName(item.id)}${specialIcon}${ammoInfo}</div>
                                <div style="font-size: 0.85rem; color: #888;">${statIcon} +${statValue} ${statName}</div>
                            </div>
                            ${isEquipped ? '<span style="color: #8bc34a; font-size: 0.8rem;">‚úì ' + ('Nasazeno') + '</span>' : '<span style="color: #666; font-size: 0.8rem;">' + ('Klikni pro nasazen√≠') + '</span>'}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center;">' + ('Nem√°≈° ≈æ√°dn√© p≈ôedmƒõty tohoto typu.') + '</p>';
            }
            
            const equipTips = {
                weapon: 'Vyrob si lep≈°√≠ zbra≈à v craftingu! Speci√°ln√≠ zbranƒõ maj√≠ bonusov√© efekty jako jed nebo krv√°cen√≠.',
                armor: 'Tƒõ≈æ≈°√≠ zbroj m√° lep≈°√≠ obranu, ale v√°≈æ√≠ v√≠ce. Nezapome≈à na opravu!',
                helmet: 'Helmy chr√°n√≠ hlavu a nƒõkter√© maj√≠ speci√°ln√≠ efekty jako noƒçn√≠ vidƒõn√≠.',
                gloves: 'Rukavice zvy≈°uj√≠ obranu a nƒõkter√© d√°vaj√≠ bonusy k boji beze zbranƒõ.',
                boots: 'Boty zvy≈°uj√≠ obranu a nƒõkter√© d√°vaj√≠ bonusy k √∫hybu nebo rychlosti.',
                default: 'Vybaven√≠ zlep≈°uje tv√© statistiky v boji.'
            };
            
            // Tipy
            html += `
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-top: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">üí° ${'Tip'}</h4>
                    <p style="margin: 0; font-size: 0.8rem; color: #aaa;">
                        ${equipTips[slotType] || equipTips.default}
                    </p>
                </div>
            `;
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal(`${slotIcon} ${slotName}`, html);
        }
        
        function showAccessoryModal() {
            // Najdi v≈°echny accessory v invent√°≈ôi
            const accessories = state.inv.filter(i => i.type === 'accessory');
            const equipped = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Aktu√°lnƒõ nasazen√Ω
            html += '<h4 style="color: var(--toxic-green); margin-bottom: 0.5rem;">üíç ' + ('Nasazen√Ω doplnƒõk') + '</h4>';
            if (equipped) {
                html += `
                    <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 1rem; border-radius: 10px; border: 2px solid #ffd700; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 3rem;">${equipped.icon}</div>
                        <div style="font-weight: bold; color: #ffd700; margin-top: 0.5rem;">${getItemName(equipped.id)}</div>
                        <div style="color: #8bc34a; font-size: 0.9rem;">${equipped.desc || ''}</div>
                        <button class="btn" onclick="unequipAccessory()" style="margin-top: 0.8rem; background: #555;">‚úó ${'Sundat'}</button>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; border: 2px dashed #444; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 2rem; color: #555;">üíç</div>
                        <div style="color: #666;">${'≈Ω√°dn√Ω doplnƒõk'}</div>
                    </div>
                `;
            }
            
            // Dostupn√© dopl≈àky
            html += '<h4 style="color: var(--warning-yellow); margin-bottom: 0.5rem;">üì¶ ' + ('Dostupn√© dopl≈àky') + '</h4>';
            if (accessories.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">';
                accessories.forEach(acc => {
                    const isEquipped = state.equippedAccessory === acc.id;
                    html += `
                        <div onclick="${isEquipped ? '' : `equipAccessory('${acc.id}')`}" style="background: ${isEquipped ? '#1a2a1a' : '#2a2a2a'}; padding: 0.8rem; border-radius: 8px; text-align: center; cursor: ${isEquipped ? 'default' : 'pointer'}; border: 2px solid ${isEquipped ? '#8bc34a' : '#444'};">
                            <div style="font-size: 2rem;">${acc.icon}</div>
                            <div style="font-weight: bold; font-size: 0.9rem; color: ${isEquipped ? '#8bc34a' : '#fff'};">${getItemName(acc.id)}</div>
                            <div style="font-size: 0.75rem; color: #888;">${acc.desc || ''}</div>
                            ${isEquipped ? '<div style="color: #8bc34a; font-size: 0.7rem; margin-top: 0.3rem;">‚úì ' + ('Nasazeno') + '</div>' : ''}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center;">' + ('Nem√°≈° ≈æ√°dn√© dopl≈àky. Vyrob je z drah√Ωch kov≈Ø!') + '</p>';
            }
            
            const accTexts = {
                types: 'Typy dopl≈àk≈Ø', silverRing: 'St≈ô√≠brn√Ω prsten', goldAmulet: 'Zlat√Ω amulet', crystalFocus: 'Krystalov√Ω fokus', gemPendant: 'Drahokamov√Ω p≈ô√≠vƒõsek',
                loot: 'loot', crit: 'kritick√Ω z√°sah', defense: 'obrana'
            };
            
            // Info o bonusech
            html += `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-top: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">üí° ${accTexts.types}</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">
                        <li>üíç <strong>${accTexts.silverRing}:</strong> +10% ${accTexts.loot}</li>
                        <li>üìø <strong>${accTexts.goldAmulet}:</strong> +15% XP</li>
                        <li>üîÆ <strong>${accTexts.crystalFocus}:</strong> +15% ${accTexts.crit}</li>
                        <li>üíé <strong>${accTexts.gemPendant}:</strong> +10 ${accTexts.defense}</li>
                    </ul>
                </div>
            `;
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('üíç Dopl≈àky', html);
        }
        
        function equipItem(itemId, slotType) {
            // Zamkni v√Ωmƒõnu vybaven√≠ bƒõhem cestov√°n√≠
            if (state.map?.traveling) {
                notifyWarning('Nelze zmƒõnit', 'Bƒõhem cestov√°n√≠ nelze mƒõnit vybaven√≠!');
                return;
            }
            
            // Mutant nem≈Ø≈æe nosit brnƒõn√≠
            if ((slotType === 'armor' || slotType === 'gloves' || slotType === 'boots') && state.char.class === 'mutant') {
                showModal('‚ùå Nelze nasadit', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">ü¶é</div>
                        <p>Jsi p≈ô√≠li≈° velk√Ω a zdeformovan√Ω na bƒõ≈æn√© vybaven√≠!</p>
                        <p style="color: #76ff03;">Tv√° mutant√≠ k≈Ø≈æe ti d√°v√° +10 p≈ôirozen√© obrany.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const item = state.inv.find(i => i.id === itemId && i.type === slotType);
            if (!item) {
                // Zkus√≠me naj√≠t jen podle ID pokud se neshoduje typ
                const itemAny = state.inv.find(i => i.id === itemId);
                if (itemAny) {
                    if (slotType === 'weapon' && itemAny.type === 'weapon') {
                        state.equipped = state.equipped || {};
                        state.equipped.weapon = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'armor' && itemAny.type === 'armor') {
                        state.equipped = state.equipped || {};
                        state.equipped.armor = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'gloves' && itemAny.type === 'gloves') {
                        state.equipped = state.equipped || {};
                        state.equipped.gloves = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'boots' && itemAny.type === 'boots') {
                        state.equipped = state.equipped || {};
                        state.equipped.boots = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    } else if (slotType === 'helmet' && itemAny.type === 'helmet') {
                        state.equipped = state.equipped || {};
                        state.equipped.helmet = itemAny;
                        addLog('Nasazeno: ' + itemAny.name, itemAny.icon);
                        notifySuccess('Nasazeno!', itemAny.name);
                        closeModal();
                        renderFull();
                    }
                }
                return;
            }
            
            // Nastav do state.equipped
            state.equipped = state.equipped || {};
            if (slotType === 'weapon') {
                state.equipped.weapon = item;
            } else if (slotType === 'armor') {
                state.equipped.armor = item;
            } else if (slotType === 'helmet') {
                state.equipped.helmet = item;
            } else if (slotType === 'gloves') {
                state.equipped.gloves = item;
            } else if (slotType === 'boots') {
                state.equipped.boots = item;
            }
            
            addLog('Nasazeno: ' + item.name, item.icon);
            notifySuccess('Nasazeno!', item.name);
            
            // Zav≈ôi modal a p≈ôekresli
            closeModal();
            renderFull();
        }
        
        function equipAccessoryByIndex(idx) {
            const accessory = state.inv[idx];
            if (!accessory) return;
            equipAccessory(accessory.id);
        }
        
        function equipAccessory(accId) {
            const accessory = state.inv.find(i => i.id === accId && i.type === 'accessory');
            if (!accessory) return;
            
            state.equippedAccessory = accId;
            addLog('Nasazen doplnƒõk: ' + accessory.name, accessory.icon);
            notifySuccess('Nasazeno!', accessory.name);
            showAccessoryModal();
            renderFull();
        }
        
        function unequipAccessory() {
            if (!state.equippedAccessory) return;
            
            const accessory = state.inv.find(i => i.id === state.equippedAccessory);
            state.equippedAccessory = null;
            addLog('Sund√°n doplnƒõk: ' + (accessory?.name || '?'), 'üíç');
            showAccessoryModal();
            renderFull();
        }
        
        function showCompanionsInfo() {
            const compTexts = {
                noCompanions: 'Zat√≠m nem√°≈° ≈æ√°dn√© spoleƒçn√≠ky.',
                companionInfo: 'Spoleƒçn√≠ci nepot≈ôebuj√≠ j√≠dlo ani vodu automaticky. Bojuj√≠ samostatnƒõ!',
                availableCompanions: 'Dostupn√≠ spoleƒçn√≠ci:',
                event: 'Event', hireTip: 'Najmi spoleƒçn√≠ky v OSADƒö (üêï) nebo je potkej p≈ôi cestov√°n√≠!',
                skills: 'dovednost√≠', fed: 'Nakrmen', hungry: 'Hladov√Ω', watered: 'Napojen', thirsty: '≈Ω√≠zniv√Ω',
                loyalty: 'Loajalita', feed: 'Krmit', equipment: 'V√Ωbava', skillTree: 'Dovednosti', dismiss: 'Propustit',
                nextQuest: 'P≈ô√≠≈°t√≠ quest', goTo: 'Jdi na', allQuestsDone: 'V≈°echny questy dokonƒçeny!'
            };
            
            if (!state.companions || state.companions.length === 0) {
                // Nem√°m spoleƒçn√≠ky - zobrazit n√°hled
                showModal('üë• Spoleƒçn√≠ci', `
                    <p style="color: #999; text-align: center; margin-bottom: 1rem;">${compTexts.noCompanions}</p>
                    <p style="color: #4caf50; font-size: 0.8rem; text-align: center; margin-bottom: 1rem;">‚ÑπÔ∏è ${compTexts.companionInfo}</p>
                    
                    <h4 style="margin-bottom: 0.5rem;">${compTexts.availableCompanions}</h4>
                    <div style="max-height: 45vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${COMPANIONS.map(c => {
                            const compName = c.name;
                            const compAbility = c.ability;
                            return `
                            <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.8rem;">
                                    <div style="font-size: 2rem;">${c.icon}</div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0; font-size: 0.95rem;">${compName}</h4>
                                        <p style="color: #8bc34a; font-size: 0.75rem; margin: 0.2rem 0;">${compAbility}</p>
                                        <p style="font-size: 0.75rem; margin: 0.2rem 0; color: #888;">
                                            ‚ù§Ô∏è ${c.hp} | ‚öîÔ∏è ${c.damage} | üõ°Ô∏è ${c.defense}
                                        </p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="color: #ffd700; font-weight: bold; margin: 0;">${c.cost > 0 ? c.cost + ' üí∞' : 'üéÅ ' + compTexts.event}</p>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">
                        üí° ${compTexts.hireTip}
                    </p>
                    
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${'Zav≈ô√≠t'}</button>
                `);
                return;
            }
            
            // M√°m spoleƒçn√≠ky - zobrazit jejich info
            const currentCount = state.companions.filter(c => !c.isDead).length;
            
            showModal('üë• Tvoji spoleƒçn√≠ci', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${state.companions.map(comp => {
                        // Oprav chybƒõj√≠c√≠ atributy p≈ô√≠mo p≈ôi renderov√°n√≠ (pro star√© save)
                        if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                            if (!comp.id) comp.id = 'survivor';
                            if (!comp.type) comp.type = 'human';
                            if (comp.canEquip === undefined) comp.canEquip = true;
                        }
                        
                        const companion = COMPANIONS.find(c => c.id === comp.id) || comp; // Fallback na samotn√©ho comp
                        const compIcon = companion.icon || comp.icon || 'üë§';
                        const compName = comp.name || companion.name || 'Spoleƒçn√≠k';
                        // Priorita: comp.type (ulo≈æen√Ω), companion.type (z definice), fallback 'human'
                        const compType = comp.type || companion.type || 'human';
                        const hpPercent = comp.maxHp > 0 ? Math.round((comp.hp / comp.maxHp) * 100) : 0;
                        const level = comp.level || 1;
                        const xp = comp.xp || 0;
                        const nextLevelXp = COMPANION_XP_TABLE[level] || 9999;
                        const xpPercent = nextLevelXp > 0 ? Math.min(100, Math.round((xp / nextLevelXp) * 100)) : 0;
                        const skillPoints = comp.skillPoints || 0;
                        const learnedSkills = comp.skills || [];
                        
                        return `
                            <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border: 2px solid ${skillPoints > 0 ? '#ffd700' : '#333'};">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="font-size: 2.5rem;">${compIcon}</div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <h4 style="margin: 0;">${compName}</h4>
                                            <span style="background: #ff9800; color: #000; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">Lv.${level}</span>
                                        </div>
                                        <p style="color: #8bc34a; font-size: 0.8rem; margin: 0.2rem 0;">üéØ ${learnedSkills.length} dovednost√≠</p>
                                    </div>
                                    ${skillPoints > 0 ? `<div style="background: #ffd700; color: #000; padding: 0.3rem 0.6rem; border-radius: 6px; font-weight: bold; animation: pulse 1s infinite;">+${skillPoints} SP</div>` : ''}
                                </div>
                                
                                <!-- HP bar -->
                                <div style="margin-top: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                        <span>‚ù§Ô∏è ${comp.hp}/${comp.maxHp}</span>
                                        <span>‚öîÔ∏è ${getCompanionStat(comp, 'damage')}</span>
                                        <span>üõ°Ô∏è ${getCompanionStat(comp, 'defense')}</span>
                                    </div>
                                    <div style="background: #1a1a1a; height: 6px; border-radius: 3px; margin-top: 0.2rem; overflow: hidden;">
                                        <div style="background: ${hpPercent > 50 ? '#4caf50' : hpPercent > 25 ? '#ff9800' : '#c62828'}; height: 100%; width: ${hpPercent}%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Vybaven√≠ (jen pro lidi) -->
                                ${(compType === 'human' || comp.canEquip) && comp.equipped && (comp.equipped.weapon || comp.equipped.armor || comp.equipped.helmet || comp.equipped.gloves || comp.equipped.boots || comp.equipped.accessory) ? `
                                    <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem; flex-wrap: wrap;">
                                        ${comp.equipped.weapon ? `<span style="background: #3a2a2a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.weapon.icon || '‚öîÔ∏è'} ${comp.equipped.weapon.name}</span>` : ''}
                                        ${comp.equipped.armor ? `<span style="background: #2a3a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.armor.icon || 'üõ°Ô∏è'} ${comp.equipped.armor.name}</span>` : ''}
                                        ${comp.equipped.helmet ? `<span style="background: #2a2a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.helmet.icon || 'ü™ñ'} ${comp.equipped.helmet.name}</span>` : ''}
                                        ${comp.equipped.gloves ? `<span style="background: #3a2a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.gloves.icon || 'üß§'} ${comp.equipped.gloves.name}</span>` : ''}
                                        ${comp.equipped.boots ? `<span style="background: #2a3a2a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.boots.icon || 'üë¢'} ${comp.equipped.boots.name}</span>` : ''}
                                        ${comp.equipped.accessory ? `<span style="background: #3a3a2a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;">${comp.equipped.accessory.icon || 'üíç'} ${comp.equipped.accessory.name}</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                <!-- Stav sytosti -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.3rem;">
                                    <div style="background: #1a1a1a; padding: 0.3rem; border-radius: 4px; text-align: center;">
                                        ${(() => {
                                            const now = Date.now();
                                            const DAY_MS = 24 * 60 * 60 * 1000;
                                            const timeSinceFed = now - (comp.lastFedTime || 0);
                                            const needsFood = timeSinceFed >= DAY_MS;
                                            const hoursLeft = Math.max(0, Math.floor((DAY_MS - timeSinceFed) / (60 * 60 * 1000)));
                                            
                                            if (needsFood || !comp.lastFedTime) {
                                                return `<span style="font-size: 0.75rem; color: #c62828;">üçñ ‚úó Hladov√Ω</span>`;
                                            } else {
                                                return `<span style="font-size: 0.75rem; color: #4caf50;">üçñ ‚úì OK (${hoursLeft}h)</span>`;
                                            }
                                        })()}
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.3rem; border-radius: 4px; text-align: center;">
                                        ${(() => {
                                            const now = Date.now();
                                            const DAY_MS = 24 * 60 * 60 * 1000;
                                            const timeSinceWatered = now - (comp.lastWateredTime || 0);
                                            const needsWater = timeSinceWatered >= DAY_MS;
                                            const hoursLeft = Math.max(0, Math.floor((DAY_MS - timeSinceWatered) / (60 * 60 * 1000)));
                                            
                                            if (needsWater || !comp.lastWateredTime) {
                                                return `<span style="font-size: 0.75rem; color: #c62828;">üíß ‚úó ≈Ω√≠zniv√Ω</span>`;
                                            } else {
                                                return `<span style="font-size: 0.75rem; color: #2196f3;">üíß ‚úì OK (${hoursLeft}h)</span>`;
                                            }
                                        })()}
                                    </div>
                                </div>
                                
                                <!-- XP bar -->
                                <div style="margin-top: 0.3rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #888;">
                                        <span>‚≠ê XP</span>
                                        <span>${xp}/${nextLevelXp}</span>
                                    </div>
                                    <div style="background: #1a1a1a; height: 4px; border-radius: 2px; margin-top: 0.1rem; overflow: hidden;">
                                        <div style="background: #ffd700; height: 100%; width: ${xpPercent}%;"></div>
                                    </div>
                                </div>
                                
                                <!-- QUEST INFO -->
                                ${(() => {
                                    const questData = COMPANION_QUESTS[comp.id];
                                    if (!questData) return '';
                                    
                                    if (comp.activeQuest) {
                                        const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
                                        return `
                                            <div style="background: #2a1a3a; padding: 0.5rem; border-radius: 6px; margin-top: 0.4rem; border: 1px solid #9c27b0;">
                                                <div style="color: #ce93d8; font-size: 0.8rem; font-weight: bold;">üìú ${chapter?.title || 'Aktivn√≠ quest'}</div>
                                                <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">${chapter?.description || ''}</div>
                                            </div>
                                        `;
                                    } else {
                                        // Najdi dal≈°√≠ quest a jeho podm√≠nky
                                        const completedQuests = comp.completedQuests || [];
                                        const nextQuest = questData.chapters.find(c => !completedQuests.includes(c.id));
                                        if (nextQuest) {
                                            const trigger = nextQuest.trigger;
                                            const needLoyalty = trigger.loyalty || 0;
                                            const currentLoyalty = comp.loyalty || 0;
                                            const needLocation = trigger.location;
                                            const locName = needLocation ? WORLD_LOCATIONS.find(l => l.id === needLocation)?.name : null;
                                            
                                            return `
                                                <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.4rem; border: 1px solid #4a6a4a;">
                                                    <div style="color: #8bc34a; font-size: 0.75rem; font-weight: bold;">üí≠ P≈ô√≠≈°t√≠ quest: ${nextQuest.title}</div>
                                                    <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                                                        ${needLoyalty > 0 ? `<span style="color: ${currentLoyalty >= needLoyalty ? '#4caf50' : '#ff9800'};">‚ù§Ô∏è Loajalita: ${currentLoyalty}/${needLoyalty}</span> ` : ''}
                                                        ${locName ? `<span style="color: #2196f3;">üìç Jdi na: ${locName}</span>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        } else if (completedQuests.length > 0) {
                                            return `<div style="background: #1a1a1a; padding: 0.3rem; border-radius: 4px; margin-top: 0.4rem; text-align: center; font-size: 0.75rem; color: #ffd700;">‚úÖ V≈°echny questy dokonƒçeny!</div>`;
                                        }
                                        return '';
                                    }
                                })()}
                                
                                <!-- Loyalty bar -->
                                <div style="margin-top: 0.3rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #888;">
                                        <span>‚ù§Ô∏è Loajalita</span>
                                        <span>${comp.loyalty || 0}/100</span>
                                    </div>
                                    <div style="background: #1a1a1a; height: 4px; border-radius: 2px; margin-top: 0.1rem; overflow: hidden;">
                                        <div style="background: #e91e63; height: 100%; width: ${comp.loyalty || 0}%;"></div>
                                    </div>
                                </div>
                                
                                ${(() => {
                                    const pendingItem = getCompanionPendingQuestItem(comp.uniqueId || comp.id);
                                    if (pendingItem) {
                                        return `
                                            <div style="background: linear-gradient(135deg, #4caf50, #2e7d32); padding: 0.6rem; border-radius: 6px; margin-top: 0.4rem; text-align: center;">
                                                <button class="btn" onclick="deliverQuestItemToCompanion('${comp.uniqueId || comp.id}')" style="background: #fff; color: #2e7d32; font-size: 0.85rem; padding: 0.5rem 1rem; width: 100%;">
                                                    üì¶ P≈ôedat ${pendingItem.itemIcon} ${pendingItem.itemName}
                                                </button>
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}
                                
                                <div style="display: grid; grid-template-columns: ${(compType === 'human' || comp.canEquip || comp.id === 'survivor') ? 'repeat(5, 1fr)' : 'repeat(4, 1fr)'}; gap: 0.4rem; margin-top: 0.5rem;">
                                    <button class="btn" onclick="showFeedCompanionDialog('${comp.uniqueId || comp.id}')" style="background: #ff9800; font-size: 0.75rem; padding: 0.4rem;">üçñ ${currentLang === "en" ? "Feed" : "Krmit"}</button>
                                    ${(compType === 'human' || comp.canEquip || comp.id === 'survivor') ? `<button class="btn" onclick="showCompanionEquipment('${comp.uniqueId || comp.id}')" style="background: #9c27b0; font-size: 0.75rem; padding: 0.4rem;">üéΩ V√Ωbava</button>` : ''}
                                    <button class="btn" onclick="showCompanionSkillTree('${comp.uniqueId || comp.id}')" style="background: ${skillPoints > 0 ? 'var(--rust)' : '#444'}; font-size: 0.75rem; padding: 0.4rem;">üå≥ Skill</button>
                                    <button class="btn" onclick="renameCompanion('${comp.uniqueId || comp.id}')" style="background: #2196f3; font-size: 0.75rem; padding: 0.4rem;">‚úèÔ∏è ${currentLang === "en" ? "Name" : "Jm√©no"}</button>
                                    <button class="btn" onclick="confirmDismissCompanion('${comp.uniqueId || comp.id}')" style="background: #333; font-size: 0.75rem; padding: 0.4rem;">üëã ${currentLang === "en" ? "Dismiss" : "Pryƒç"}</button>
                                </div>
                                ${comp.id === 'engineer_npc' ? (comp.skills?.includes('masterwork') ? `
                                    <button class="btn" onclick="technicianUpgradeEquipment()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #ff9800, #f57c00);">
                                        ‚ö° Vylep≈°it vybaven√≠ (+5 DMG/DEF, 20‚öôÔ∏è)
                                    </button>
                                ` : `
                                    <div style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: #333; border-radius: 6px; text-align: center; font-size: 0.8rem;">
                                        üîí Vylep≈°en√≠ vybaven√≠ - odemkni skill "Mistrovsk√° pr√°ce" (Tier 3)
                                    </div>
                                `) : ''}
                                ${comp.id === 'engineer_npc' ? `
                                    <div style="margin-top: 0.5rem; padding: 0.4rem; background: #1a2a1a; border-radius: 4px; font-size: 0.75rem; color: #8bc34a;">
                                        ${comp.skills?.includes('trap') ? '‚úÖ ü™§ Bojov√© pasti aktivn√≠ (15-30 DMG na zaƒç√°tku boje)' : 'üîí ü™§ Bojov√© pasti (Tier 1)'}<br>
                                        ${comp.skills?.includes('turret') ? '‚úÖ üî´ Vƒõ≈æiƒçka aktivn√≠ (+5 DMG ka≈æd√© kolo)' : 'üîí üî´ Vƒõ≈æiƒçka (Tier 2)'}<br>
                                        ${comp.skills?.includes('robot') ? '‚úÖ ü§ñ Robot aktivn√≠ (+20 DMG ka≈æd√© kolo)' : 'üîí ü§ñ Bojov√Ω robot (Tier 3)'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <p style="color: #999; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">
                    ${'Spoleƒçn√≠ci:'} ${state.companions.length}/${getMaxCompanions()} | ${'Spoleƒçn√≠ci z√≠sk√°vaj√≠ XP z boj≈Ø!'}
                </p>
                <p style="color: #ff9800; font-size: 0.8rem; text-align: center; margin: 0.3rem 0;">
                    ‚ö†Ô∏è ${'Denn√≠ spot≈ôeba:'} ${state.companions.filter(c => !c.isDead).length}x üçñ ${'j√≠dlo'} + ${state.companions.filter(c => !c.isDead).length}x üíß ${'voda'}
                </p>
                
                ${currentCount < getMaxCompanions() ? `
                    <p style="color: #888; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">
                        üí° ${'Dal≈°√≠ spoleƒçn√≠ky najmi v OSADƒö (üêï) nebo je potkej p≈ôi cestov√°n√≠!'}
                    </p>
                ` : `
                    <p style="color: #888; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">
                        ‚¨ÜÔ∏è ${'Zvy≈° level pro v√≠ce spoleƒçn√≠k≈Ø!'}
                    </p>
                `}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${'Zav≈ô√≠t'}</button>
            `);
        }
        
        function getCompanionStat(comp, stat) {
            const base = COMPANIONS.find(c => c.id === comp.id) || comp;
            
            let value = base[stat] || comp[stat] || 0;
            
            // P≈ôidej bonus z levelu spoleƒçn√≠ka
            const level = comp.level || 1;
            if (stat === 'damage') {
                value += (level - 1) * 2; // +2 damage za ka≈æd√Ω level
            }
            if (stat === 'defense') {
                value += (level - 1) * 1; // +1 defense za ka≈æd√Ω level
            }
            
            // P≈ôidej bonusy z vybaven√≠
            if (comp.equipped) {
                if (stat === 'damage' && comp.equipped.weapon) {
                    value += comp.equipped.weapon.damage || 0;
                }
                if (stat === 'defense') {
                    if (comp.equipped.armor) value += comp.equipped.armor.defense || 0;
                    if (comp.equipped.helmet) value += comp.equipped.helmet.defense || 0;
                    if (comp.equipped.gloves) value += comp.equipped.gloves.defense || 0;
                    if (comp.equipped.boots) value += comp.equipped.boots.defense || 0;
                }
            }
            
            // P≈ôidej bonusy ze skill≈Ø - pou≈æij survivor tree pro dynamick√© companiony
            let skillTree = COMPANION_SKILL_TREES[comp.id];
            if (!skillTree && (base.type === 'human' || comp.type === 'human')) {
                skillTree = COMPANION_SKILL_TREES['survivor'];
            }
            
            if (skillTree && comp.skills) {
                comp.skills.forEach(skillId => {
                    Object.values(skillTree.trees).forEach(tree => {
                        const skill = tree.skills.find(s => s.id === skillId);
                        if (skill?.effect?.[stat]) {
                            value += skill.effect[stat];
                        }
                    });
                });
            }
            
            return value;
        }
        
        // Z√≠skej travelSpeed bonus ze v≈°ech companion skills
        function getCompanionTravelSpeedBonus() {
            if (!state.companions || state.companions.length === 0) return 0;
            
            let totalBonus = 0;
            
            state.companions.forEach(comp => {
                if (!comp.skills || comp.skills.length === 0) return;
                
                const base = COMPANIONS.find(c => c.id === comp.id) || comp;
                let skillTree = COMPANION_SKILL_TREES[comp.id];
                if (!skillTree && (base.type === 'human' || comp.type === 'human')) {
                    skillTree = COMPANION_SKILL_TREES['survivor'];
                }
                
                if (skillTree) {
                    comp.skills.forEach(skillId => {
                        Object.values(skillTree.trees).forEach(tree => {
                            const skill = tree.skills.find(s => s.id === skillId);
                            if (skill?.effect?.travelSpeed) {
                                totalBonus += skill.effect.travelSpeed;
                            }
                        });
                    });
                }
            });
            
            return totalBonus;
        }
        
        // Z√≠skej V≈†ECHNY bonusy ze v≈°ech companion skills
        function getAllCompanionBonuses() {
            const bonuses = {
                damage: 0,
                defense: 0,
                hp: 0,
                critChance: 0,
                critDamage: 0,
                dodgeChance: 0,
                lootChance: 0,
                xpBonus: 0,
                priceBonus: 0,
                ambushReduction: 0,
                travelSpeed: 0,
                healingBonus: 0,
                rareChance: 0,
                doubleLoot: 0,
                healPlayerAfterCombat: 0,
                regenAfterCombat: 0,
                visionRange: 0,
                partyDamage: 0,
                hiddenChance: 0,
                // Boolean efekty
                fetchLoot: false,
                surviveChance: 0,
                resurrectChance: 0,
                stealChance: 0,
                enemyWarning: false,
                firstStrikeCrit: false,
                ignoreTerrrain: false,
                prediction: false, // Havran - p≈ôedpovƒõƒè poƒças√≠ a event≈Ø
                questReveal: false, // Havran - odhalen√≠ quest lokac√≠
                // Technik efekty
                autoRepair: false,
                canUpgrade: false,
                durabilityBonus: 0,
                craftCostReduction: 0,
                craftBonus: 0,
                specialRecipes: false,
                canTrap: false,
                turretDamage: 0,
                canBuildRobot: false,
                freeRepair: false // Z√°kladn√≠ schopnost technika
            };
            
            if (!state.companions || state.companions.length === 0) return bonuses;
            
            // Kontrola z√°kladn√≠ch schopnost√≠ spoleƒçn√≠k≈Ø
            state.companions.forEach(comp => {
                const base = COMPANIONS.find(c => c.id === comp.id) || comp;
                // Technik m√° z√°kladn√≠ schopnost opravy zdarma
                if (comp.id === 'engineer_npc' || base.id === 'engineer_npc') {
                    bonuses.freeRepair = true;
                }
            });
            
            state.companions.forEach(comp => {
                if (!comp.skills || comp.skills.length === 0) return;
                
                const base = COMPANIONS.find(c => c.id === comp.id) || comp;
                let skillTree = COMPANION_SKILL_TREES[comp.id];
                if (!skillTree && (base.type === 'human' || comp.type === 'human')) {
                    skillTree = COMPANION_SKILL_TREES['survivor'];
                }
                
                if (skillTree) {
                    comp.skills.forEach(skillId => {
                        Object.values(skillTree.trees).forEach(tree => {
                            const skill = tree.skills.find(s => s.id === skillId);
                            if (skill?.effect) {
                                Object.entries(skill.effect).forEach(([key, value]) => {
                                    if (typeof value === 'boolean') {
                                        bonuses[key] = value;
                                    } else if (typeof value === 'number') {
                                        bonuses[key] = (bonuses[key] || 0) + value;
                                    }
                                });
                            }
                        });
                    });
                }
            });
            
            return bonuses;
        }
        
        function showCompanionSkillTree(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Oprav chybƒõj√≠c√≠ atributy pro star√© freed_slave spoleƒçn√≠ky
            if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                if (!comp.id) comp.id = 'survivor';
                if (!comp.type) comp.type = 'human';
            }
            
            const companion = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compIcon = companion.icon || comp.icon || 'üë§';
            const compName = comp.name || companion.name || 'Spoleƒçn√≠k';
            
            // Najdi skill tree - pou≈æij comp.id pro mapov√°n√≠ na skill tree
            // Pro freed_slave v≈ædy pou≈æij survivor tree
            let skillTree = COMPANION_SKILL_TREES[comp.id];
            let treeId = comp.id;
            
            // Fallback na survivor tree pro freed_slave nebo human type
            if (!skillTree) {
                // Dynamick√Ω companion - pou≈æij survivor tree pro lidi, jinak zobraz zpr√°vu
                const compType = companion.type || comp.type || 'human';
                if (compType === 'human') {
                    skillTree = COMPANION_SKILL_TREES['survivor'];
                    treeId = 'survivor';
                }
            }
            
            if (!skillTree) {
                showModal(`${compIcon} ${compName}`, `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">${compIcon}</div>
                        <p style="color: #888;">Tento spoleƒçn√≠k nem√° strom dovednost√≠.</p>
                        <p style="color: #666; font-size: 0.85rem;">Z√≠sk√°v√° XP z boj≈Ø a pom√°h√° ti v boji.</p>
                    </div>
                    <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê ${'Zpƒõt'}</button>
                `);
                return;
            }
            
            const level = comp.level || 1;
            const skillPoints = comp.skillPoints || 0;
            const learnedSkills = comp.skills || [];
            
            let treesHtml = '';
            Object.entries(skillTree.trees).forEach(([treeId, tree]) => {
                treesHtml += `
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid ${tree.color};">
                        <h4 style="margin: 0 0 0.5rem 0; color: ${tree.color};">${tree.icon} ${tree.name}</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${tree.skills.map(skill => {
                                const isLearned = learnedSkills.includes(skill.id);
                                const canLearn = !isLearned && skillPoints > 0 && level >= skill.tier && 
                                    (!skill.requires || learnedSkills.includes(skill.requires));
                                const isLocked = !isLearned && !canLearn;
                                
                                return `
                                    <div onclick="${canLearn ? `learnCompanionSkill('${companionId}', '${skill.id}')` : ''}" 
                                         style="background: ${isLearned ? '#1a3a1a' : canLearn ? '#2a2a1a' : '#0a0a0a'}; 
                                                padding: 0.5rem; border-radius: 6px; text-align: center; min-width: 80px;
                                                border: 2px solid ${isLearned ? '#4caf50' : canLearn ? '#ffd700' : '#333'};
                                                cursor: ${canLearn ? 'pointer' : 'default'};
                                                opacity: ${isLocked ? '0.5' : '1'};">
                                        <div style="font-size: 1.5rem;">${skill.icon}</div>
                                        <div style="font-size: 0.7rem; font-weight: bold; color: ${isLearned ? '#8bc34a' : '#fff'};">${skill.name}</div>
                                        <div style="font-size: 0.6rem; color: #888;">${skill.desc}</div>
                                        <div style="font-size: 0.6rem; color: #ff9800;">Tier ${skill.tier}</div>
                                        ${isLearned ? '<div style="color: #4caf50; font-size: 0.7rem;">‚úì</div>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            showModal(`${compIcon} ${compName} - ${'Dovednosti'}`, `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem; background: #1a1a1a; border-radius: 8px;">
                    <div>
                        <span style="color: #ff9800; font-weight: bold;">Level ${level}</span>
                        <span style="color: #888; margin-left: 0.5rem;">|</span>
                        <span style="color: #888; margin-left: 0.5rem;">${learnedSkills.length} ${'dovednost√≠'}</span>
                    </div>
                    <div style="background: ${skillPoints > 0 ? '#ffd700' : '#333'}; color: ${skillPoints > 0 ? '#000' : '#666'}; padding: 0.3rem 0.8rem; border-radius: 6px; font-weight: bold;">
                        ${skillPoints} SP
                    </div>
                </div>
                
                <div style="max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${treesHtml}
                </div>
                
                <p style="color: #888; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">
                    ${skillPoints > 0 ? ('üí° Klikni na dovednost pro nauƒçen√≠') : ('üí° Z√≠skej SP levelov√°n√≠m spoleƒçn√≠ka')}
                </p>
                
                <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${'Zpƒõt'}</button>
            `);
        }
        
        function learnCompanionSkill(companionId, skillId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            const skillPoints = comp.skillPoints || 0;
            if (skillPoints <= 0) {
                notifyWarning('Nedostatek SP', 'Nem√°≈° body dovednost√≠!');
                return;
            }
            
            // Pro dynamick√© spoleƒçn√≠ky (survivor) pou≈æij survivor skill tree
            let treeId = comp.id;
            if (!COMPANION_SKILL_TREES[treeId] && (comp.type === 'human')) {
                treeId = 'survivor';
            }
            
            const skillTree = COMPANION_SKILL_TREES[treeId];
            if (!skillTree) {
                notifyWarning('Chyba', 'Skill tree nenalezen');
                return;
            }
            
            let skill = null;
            let treeName = '';
            
            Object.values(skillTree.trees).forEach(tree => {
                const found = tree.skills.find(s => s.id === skillId);
                if (found) {
                    skill = found;
                    treeName = tree.name;
                }
            });
            
            if (!skill) return;
            
            // Zkontroluj requirements
            comp.skills = comp.skills || [];
            if (skill.requires && !comp.skills.includes(skill.requires)) {
                notifyWarning('Zamƒçeno', 'Mus√≠≈° nejd≈ô√≠v nauƒçit p≈ôedchoz√≠ dovednost!');
                return;
            }
            
            // Nauƒç skill
            comp.skills.push(skillId);
            comp.skillPoints--;
            
            // Aplikuj efekty na staty
            if (skill.effect.hp) comp.maxHp = (comp.maxHp || 80) + skill.effect.hp;
            
            notifySuccess('Dovednost nauƒçena!', `${skill.icon} ${skill.name}`);
            SoundSystem.play('levelup');
            
            showCompanionSkillTree(comp.uniqueId || comp.id);
        }
        
        function addCompanionXP(amount) {
            if (!state.companions || state.companions.length === 0) return;
            
            state.companions.forEach(comp => {
                comp.xp = (comp.xp || 0) + amount;
                comp.level = comp.level || 1;
                
                // === P≈òIDEJ LOAJALITU ZA BOJ ===
                const loyaltyGain = Math.max(1, Math.floor(amount / 20)); // 1 loajalita za ka≈æd√Ωch 20 XP
                comp.loyalty = Math.min(100, (comp.loyalty || 0) + loyaltyGain);
                
                // Check level up
                const nextLevelXp = COMPANION_XP_TABLE[comp.level] || 9999;
                if (comp.xp >= nextLevelXp && comp.level < 10) {
                    comp.xp -= nextLevelXp;
                    comp.level++;
                    comp.skillPoints = (comp.skillPoints || 0) + 1;
                    
                    // Bonus HP p≈ôi level up
                    const baseCompanion = COMPANIONS.find(c => c.id === comp.id);
                    comp.maxHp = (comp.maxHp || baseCompanion.hp) + 5;
                    comp.hp = Math.min(comp.hp + 10, comp.maxHp);
                    
                    // Bonus loajalita za level up
                    comp.loyalty = Math.min(100, (comp.loyalty || 0) + 5);
                    
                    const companion = COMPANIONS.find(c => c.id === comp.id) || comp;
                    const compIcon = companion.icon || comp.icon || 'üë§';
                    const compName = comp.name || companion.name || 'Spoleƒçn√≠k';
                    notifySuccess(`${compIcon} Level UP!`, `${compName} je level ${comp.level}! +1 SP`);
                    addLog(`${compIcon} ${compName} dos√°hl level ${comp.level}!`, '‚≠ê');
                }
            });
        }
        
        // === VYBAVEN√ç SPOLEƒåN√çK≈Æ ===
        function showCompanionEquipment(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Oprav chybƒõj√≠c√≠ atributy pro star√© freed_slave spoleƒçn√≠ky
            if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                if (!comp.id) comp.id = 'survivor';
                if (!comp.type) comp.type = 'human';
                if (comp.canEquip === undefined) comp.canEquip = true;
            }
            
            const companion = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compType = comp.type || companion.type || 'human';
            
            // Povol vybaven√≠ pro lidi, survivor, freed_slave a ty s canEquip
            const isFreedSlave = comp.uniqueId && comp.uniqueId.startsWith('freed_slave');
            if (compType !== 'human' && comp.id !== 'survivor' && !comp.canEquip && !isFreedSlave) {
                notifyError('Nelze vybavit', 'Pouze lid≈°t√≠ spoleƒçn√≠ci mohou nosit vybaven√≠.');
                return;
            }
            
            // Inicializuj equipped pokud neexistuje
            if (!comp.equipped) {
                comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null };
            }
            
            // Z√≠skej ID p≈ôedmƒõt≈Ø vybaven√Ωch JIN√ùMI companiony (ne t√≠mto)
            const otherCompanionEquipped = new Set();
            state.companions.forEach(c => {
                if ((c.id !== companionId && c.uniqueId !== companionId) && c.equipped) {
                    ['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].forEach(slot => {
                        if (c.equipped[slot]?.id) {
                            otherCompanionEquipped.add(c.equipped[slot].id);
                        }
                    });
                }
            });
            
            // Najdi dostupn√© p≈ôedmƒõty v invent√°≈ôi (vyfiltruj ty co maj√≠ jin√≠ companioni)
            const weapons = state.inv.filter(i => i.type === 'weapon' && !otherCompanionEquipped.has(i.id));
            const armors = state.inv.filter(i => i.type === 'armor' && !otherCompanionEquipped.has(i.id));
            const helmets = state.inv.filter(i => i.type === 'helmet' && !otherCompanionEquipped.has(i.id));
            const gloves = state.inv.filter(i => i.type === 'gloves' && !otherCompanionEquipped.has(i.id));
            const boots = state.inv.filter(i => i.type === 'boots' && !otherCompanionEquipped.has(i.id));
            const accessories = state.inv.filter(i => (i.type === 'accessory' || i.id === 'compass' || i.id === 'binoculars') && !otherCompanionEquipped.has(i.id));
            
            const currentWeapon = comp.equipped.weapon;
            const currentArmor = comp.equipped.armor;
            const currentHelmet = comp.equipped.helmet;
            const currentGloves = comp.equipped.gloves;
            const currentBoots = comp.equipped.boots;
            const currentAccessory = comp.equipped.accessory;
            
            const compIcon = companion.icon || comp.icon || 'üë§';
            const compName = comp.name || companion.name || 'Spoleƒçn√≠k';
            
            showModal(`üéΩ ${'Vybaven√≠:'} ${compName}`, `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- Header -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; background: #1a2a1a; padding: 0.8rem; border-radius: 8px;">
                        <div style="font-size: 2.5rem;">${compIcon}</div>
                        <div>
                            <h4 style="margin: 0;">${compName}</h4>
                            <div style="font-size: 0.8rem; color: #888;">
                                ‚öîÔ∏è ${getCompanionStat(comp, 'damage')} | üõ°Ô∏è ${getCompanionStat(comp, 'defense')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ZBRA≈á -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #ff6b6b; font-weight: bold;">‚öîÔ∏è ${'Zbra≈à'}</span>
                            ${currentWeapon ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'weapon')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentWeapon ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #ff6b6b;">
                                ${currentWeapon.icon || '‚öîÔ∏è'} ${getItemName(currentWeapon.id)} - ‚öîÔ∏è+${currentWeapon.damage || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'≈Ω√°dn√° zbra≈à'}</div>
                        `}
                        ${weapons.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${weapons.map(w => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'weapon', '${w.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #2a3a4a; text-align: left; font-size: 0.8rem;">
                                        ${w.icon || '‚öîÔ∏è'} ${getItemName(w.id)} (‚öîÔ∏è+${w.damage || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : `<div style="color: #555; font-size: 0.75rem;">${'≈Ω√°dn√© zbranƒõ v invent√°≈ôi'}</div>`}
                    </div>
                    
                    <!-- ZBROJ -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #4ecdc4; font-weight: bold;">üõ°Ô∏è ${'Zbroj'}</span>
                            ${currentArmor ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'armor')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentArmor ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #4ecdc4;">
                                ${currentArmor.icon || 'üõ°Ô∏è'} ${getItemName(currentArmor.id)} - üõ°Ô∏è+${currentArmor.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'≈Ω√°dn√° zbroj'}</div>
                        `}
                        ${armors.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${armors.map(a => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'armor', '${a.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #2a4a4a; text-align: left; font-size: 0.8rem;">
                                        ${a.icon || 'üõ°Ô∏è'} ${getItemName(a.id)} (üõ°Ô∏è+${a.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : `<div style="color: #555; font-size: 0.75rem;">${'≈Ω√°dn√© zbroje v invent√°≈ôi'}</div>`}
                    </div>
                    
                    <!-- HELMA -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #795548; font-weight: bold;">‚õëÔ∏è ${'Helma'}</span>
                            ${currentHelmet ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'helmet')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentHelmet ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #795548;">
                                ${currentHelmet.icon || '‚õëÔ∏è'} ${getItemName(currentHelmet.id)} - üõ°Ô∏è+${currentHelmet.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'≈Ω√°dn√° helma'}</div>
                        `}
                        ${helmets.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${helmets.map(h => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'helmet', '${h.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #4a3a2a; text-align: left; font-size: 0.8rem;">
                                        ${h.icon || '‚õëÔ∏è'} ${getItemName(h.id)} (üõ°Ô∏è+${h.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">' + ('≈Ω√°dn√© helmy v invent√°≈ôi') + '</div>'}
                    </div>
                    
                    <!-- DOPLNƒöK -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #ffd700; font-weight: bold;">üíç ${'Doplnƒõk'}</span>
                            ${currentAccessory ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'accessory')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">${'Sundat'}</button>` : ''}
                        </div>
                        ${currentAccessory ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #ffd700;">
                                ${currentAccessory.icon || 'üíç'} ${getItemName(currentAccessory.id)}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">${'≈Ω√°dn√Ω doplnƒõk'}</div>
                        `}
                        ${accessories.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${accessories.map(acc => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'accessory', '${acc.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #4a4a2a; text-align: left; font-size: 0.8rem;">
                                        ${acc.icon || 'üíç'} ${getItemName(acc.id)}
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">' + ('≈Ω√°dn√© dopl≈àky v invent√°≈ôi') + '</div>'}
                    </div>
                    
                    <!-- RUKAVICE -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #ff9800; font-weight: bold;">ü•ä Rukavice</span>
                            ${currentGloves ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'gloves')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">Sundat</button>` : ''}
                        </div>
                        ${currentGloves ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #ff9800;">
                                ${currentGloves.icon || 'ü•ä'} ${currentGloves.name} - üõ°Ô∏è+${currentGloves.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">≈Ω√°dn√© rukavice</div>
                        `}
                        ${gloves.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${gloves.map(g => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'gloves', '${g.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #4a3a2a; text-align: left; font-size: 0.8rem;">
                                        ${g.icon || 'ü•ä'} ${g.name} (üõ°Ô∏è+${g.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">≈Ω√°dn√© rukavice v invent√°≈ôi</div>'}
                    </div>
                    
                    <!-- BOTY -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #00bcd4; font-weight: bold;">ü•æ Boty</span>
                            ${currentBoots ? `<button class="btn" onclick="unequipCompanionItem('${companionId}', 'boots')" style="background: #c62828; font-size: 0.7rem; padding: 0.2rem 0.5rem;">Sundat</button>` : ''}
                        </div>
                        ${currentBoots ? `
                            <div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; border-left: 3px solid #00bcd4;">
                                ${currentBoots.icon || 'ü•æ'} ${currentBoots.name} - üõ°Ô∏è+${currentBoots.defense || 0}
                            </div>
                        ` : `
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">≈Ω√°dn√© boty</div>
                        `}
                        ${boots.length > 0 ? `
                            <div style="margin-top: 0.5rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                ${boots.map(b => `
                                    <button class="btn" onclick="equipCompanionItem('${companionId}', 'boots', '${b.id}')" 
                                            style="display: block; width: 100%; margin-bottom: 0.2rem; padding: 0.3rem; background: #2a3a4a; text-align: left; font-size: 0.8rem;">
                                        ${b.icon || 'ü•æ'} ${b.name} (üõ°Ô∏è+${b.defense || 0})
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #555; font-size: 0.75rem;">≈Ω√°dn√© boty v invent√°≈ôi</div>'}
                    </div>
                    
                    <!-- N√ÅBOJE -->
                    ${comp.equipped?.weapon?.ammoType ? `
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #ffeb3b; font-weight: bold;">üî´ N√°boje (${getAmmoName(comp.equipped.weapon.ammoType)})</span>
                            <span style="color: #4caf50;">${comp.ammo || 0} ks</span>
                        </div>
                        <div style="color: #888; font-size: 0.75rem; margin-top: 0.4rem; text-align: center; padding: 0.3rem; background: #1a1a1a; border-radius: 4px;">
                            ‚úì Automaticky bere z tv√©ho invent√°≈ôe v boji
                        </div>
                        <div style="color: #666; font-size: 0.7rem; margin-top: 0.3rem; text-align: center;">
                            Tv√© n√°boje: ${getAmmoCount(comp.equipped.weapon.ammoType)} ks
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${'Zpƒõt'}</button>
            `);
        }
        
        function equipCompanionItem(companionId, slot, itemId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) {
                notifyError('Chyba', ('Spoleƒçn√≠k nenalezen'));
                return;
            }
            
            // Najdi p≈ôedmƒõt v invent√°≈ôi
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) {
                notifyError('Chyba', ('P≈ôedmƒõt nenalezen v invent√°≈ôi'));
                return;
            }
            
            const item = state.inv[itemIndex];
            
            // Inicializuj equipped pokud neexistuje
            if (!comp.equipped) {
                comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null };
            }
            
            // Pokud u≈æ m√° nƒõco vybaven√©ho, vra≈• to do invent√°≈ôe
            if (comp.equipped[slot]) {
                const oldItem = {...comp.equipped[slot]};
                // P≈ôidej star√Ω p≈ôedmƒõt zpƒõt do invent√°≈ôe
                const existingOld = state.inv.find(i => i.id === oldItem.id);
                if (existingOld) {
                    existingOld.count = (existingOld.count || 1) + 1;
                } else {
                    oldItem.count = 1;
                    state.inv.push(oldItem);
                }
            }
            
            // Vybav√≠ nov√Ω p≈ôedmƒõt
            comp.equipped[slot] = {...item, count: 1};
            
            // Odeber z invent√°≈ôe (jen 1 kus)
            if (item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            updateCarryWeight();
            notifySuccess('Vybaveno!', `${comp.name} m√° nyn√≠ ${item.name}`);
            addLog(`${comp.name} vybaven: ${item.name}`, item.icon || 'üéΩ');
            saveGame(true);
            
            // P≈ôekresli cel√© UI aby se invent√°≈ô spr√°vnƒõ aktualizoval
            renderFull();
            
            showCompanionEquipment(companionId);
        }
        
        function unequipCompanionItem(companionId, slot) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.equipped || !comp.equipped[slot]) {
                notifyError('Chyba', ('Nelze sundat - nic nen√≠ vybaveno'));
                return;
            }
            
            const item = {...comp.equipped[slot]};
            
            // Pokud sund√°v√°me zbra≈à a spoleƒçn√≠k m√° n√°boje, vr√°t√≠me je hr√°ƒçi
            if (slot === 'weapon' && comp.ammo > 0 && item.ammoType) {
                addAmmo(item.ammoType, comp.ammo);
                notifyInfo('N√°boje vr√°ceny', `+${comp.ammo} ${getAmmoName(item.ammoType)}`);
                comp.ammo = 0;
            }
            
            // Kontrola v√°hy
            if (!canAddItem(item, 1)) {
                notifyWarning(t('notifications', 'inventoryFull'), 'Neunese≈° ' + item.name);
                return;
            }
            
            // Vra≈• do invent√°≈ôe
            const existing = state.inv.find(i => i.id === item.id);
            if (existing) {
                existing.count = (existing.count || 1) + 1;
            } else {
                item.count = 1;
                state.inv.push(item);
            }
            
            // Odeber z vybaven√≠
            comp.equipped[slot] = null;
            
            updateCarryWeight();
            notifySuccess('Sund√°no!', `${item.name} vr√°ceno do invent√°≈ôe`);
            saveGame();
            
            showCompanionEquipment(companionId);
        }
        
        // Dej n√°boje spoleƒçn√≠kovi
        function giveAmmoToCompanion(companionId, amount) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) {
                notifyError('Chyba', 'Spoleƒçn√≠k nenalezen');
                return;
            }
            
            // Zjisti typ n√°boj≈Ø ze zbranƒõ
            const ammoType = comp.equipped?.weapon?.ammoType;
            if (!ammoType) {
                notifyError('Chyba', 'Spoleƒçn√≠k nem√° zbra≈à vy≈æaduj√≠c√≠ n√°boje');
                return;
            }
            
            // Zkontroluj jestli hr√°ƒç m√° dost n√°boj≈Ø
            const playerAmmo = getAmmoCount(ammoType);
            if (playerAmmo < amount) {
                notifyWarning('Nedostatek n√°boj≈Ø', `M√°≈° jen ${playerAmmo} n√°boj≈Ø`);
                return;
            }
            
            // Odeber n√°boje hr√°ƒçi
            consumeAmmo(ammoType, amount);
            
            // P≈ôidej n√°boje spoleƒçn√≠kovi
            if (!comp.ammo) comp.ammo = 0;
            comp.ammo += amount;
            
            notifySuccess('N√°boje p≈ôed√°ny', `${comp.name} m√° nyn√≠ ${comp.ammo} n√°boj≈Ø`);
            saveGame();
            
            showCompanionEquipment(companionId);
        }
        
        // Z√≠sk√° celkov√Ω stat spoleƒçn√≠ka vƒçetnƒõ vybaven√≠
        function confirmDismissCompanion(companionId) {
            const companion = COMPANIONS.find(c => c.id === companionId);
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            const level = comp?.level || 1;
            const displayName = comp?.name || companion?.name || 'Spoleƒçn√≠k';
            
            showModal('Propustit spoleƒçn√≠ka?', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${companion?.icon || 'üêæ'}</div>
                    <h3>${displayName}</h3>
                    <p style="color: #ff9800;">Level ${level}</p>
                </div>
                <p style="color: #c62828; text-align: center;">‚ö†Ô∏è Ztrat√≠≈° v≈°echny jeho dovednosti a level!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showCompanionsInfo()" style="background: #555;">‚ùå Ne</button>
                    <button class="btn" onclick="dismissCompanion('${companionId}'); closeModal();" style="background: #c62828;">‚úì Propustit</button>
                </div>
            `);
        }
        
        // Technik companion - vylep≈°en√≠ vybaven√≠ (skill Mistrovsk√° pr√°ce)
        function technicianUpgradeEquipment() {
            const metalCost = 20;
            
            if ((state.resources?.metal || 0) < metalCost) {
                notifyWarning('M√°lo kovu!', `Technik pot≈ôebuje ${metalCost}‚öôÔ∏è kovu`);
                return;
            }
            
            // Vyber co vylep≈°it
            const hasWeapon = state.equipped?.weapon;
            const hasArmor = state.equipped?.armor;
            
            if (!hasWeapon && !hasArmor) {
                notifyWarning('≈Ω√°dn√© vybaven√≠!', 'Nasaƒè zbra≈à nebo zbroj k vylep≈°en√≠');
                return;
            }
            
            // Z√≠skej bonus od kov√°≈ôe osadn√≠ka
            const blacksmithBonus = getSettlerUpgradeBonus();
            const totalBonus = 5 + blacksmithBonus;
            const bonusText = blacksmithBonus > 0 ? ` (+${blacksmithBonus} kov√°≈ô)` : '';
            
            showModal('‚ö° Technik vylep≈°uje', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üîß</div>
                    <p style="color: #ff9800;">Vyber vybaven√≠ k vylep≈°en√≠ (+${totalBonus}${bonusText})</p>
                    <p style="color: #888; font-size: 0.85rem;">Cena: ${metalCost}‚öôÔ∏è kovu</p>
                </div>
                <div style="display: grid; gap: 0.5rem;">
                    ${hasWeapon ? `
                        <button class="btn" onclick="doTechnicianUpgrade('weapon')" style="background: #ff5722;">
                            ‚öîÔ∏è ${state.equipped.weapon.name} (+${totalBonus} DMG)
                        </button>
                    ` : ''}
                    ${hasArmor ? `
                        <button class="btn" onclick="doTechnicianUpgrade('armor')" style="background: #2196f3;">
                            üõ°Ô∏è ${state.equipped.armor.name} (+${totalBonus} DEF)
                        </button>
                    ` : ''}
                    <button class="btn" onclick="showCompanionsInfo()" style="background: #555;">‚ùå Zru≈°it</button>
                </div>
            `);
        }
        
        function doTechnicianUpgrade(type) {
            const metalCost = 20;
            
            if ((state.resources?.metal || 0) < metalCost) {
                notifyWarning('M√°lo kovu!', `Pot≈ôebuje≈° ${metalCost}‚öôÔ∏è`);
                return;
            }
            
            state.resources.metal -= metalCost;
            
            const blacksmithBonus = getSettlerUpgradeBonus();
            const totalBonus = 5 + blacksmithBonus;
            
            if (type === 'weapon' && state.equipped?.weapon) {
                state.equipped.weapon.damage = (state.equipped.weapon.damage || 10) + totalBonus;
                state.equipped.weapon.name = state.equipped.weapon.name + ' ‚ö°';
                notifySuccess('‚ö° Vylep≈°eno!', `${state.equipped.weapon.name}: +${totalBonus} DMG`);
            } else if (type === 'armor' && state.equipped?.armor) {
                state.equipped.armor.defense = (state.equipped.armor.defense || 5) + totalBonus;
                state.equipped.armor.name = state.equipped.armor.name + ' ‚ö°';
                notifySuccess('‚ö° Vylep≈°eno!', `${state.equipped.armor.name}: +${totalBonus} DEF`);
            }
            
            closeModal();
            renderFull();
        }
        
        function renameCompanion(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            const companion = COMPANIONS.find(c => c.id === companionId);
            
            showModal(`‚úèÔ∏è ${'P≈ôejmenovat spoleƒçn√≠ka'}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${companion?.icon || comp.icon || 'üêæ'}</div>
                    <p style="color: #888;">${'Aktu√°ln√≠ jm√©no:'} ${comp.name}</p>
                </div>
                <input type="text" id="renameCompanionInput" value="${comp.name}" 
                       style="width: 100%; padding: 0.8rem; margin-bottom: 1rem; background: #1a1a1a; 
                              border: 2px solid var(--rust); border-radius: 8px; color: #fff; font-size: 1rem;"
                       placeholder="${'Nov√© jm√©no...'}" maxlength="20">
                <button class="btn" onclick="confirmRenameCompanion('${companionId}')" 
                        style="width: 100%; background: var(--toxic-dark);">‚úì ${'P≈ôejmenovat'}</button>
                <button class="btn" onclick="showCompanionsInfo()" 
                        style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó ${'Zru≈°it'}</button>
            `);
        }
        
        function confirmRenameCompanion(companionId) {
            const nameInput = document.getElementById('renameCompanionInput');
            const newName = nameInput ? nameInput.value.trim() : null;
            
            if (newName && newName.length > 0) {
                const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
                if (comp) {
                    const oldName = comp.name;
                    comp.name = newName;
                    notifySuccess('P≈ôejmenov√°no!', `${oldName} ‚Üí ${newName}`);
                    addLog(`P≈ôejmenoval spoleƒçn√≠ka: ${newName}`, comp.icon || 'üêæ');
                }
            }
            showCompanionsInfo();
        }
        
        // Dialog pro ruƒçn√≠ krmen√≠ spoleƒçn√≠ka
        function showFeedCompanionDialog(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            const companion = COMPANIONS.find(c => c.id === companionId);
            
            // Najdi j√≠dlo a pit√≠ v invent√°≈ôi - roz≈°√≠≈ôen√Ω filtr
            const foodItems = state.inv.filter(i => {
                // P≈ô√≠mo podle type
                if (i.type === 'food') return true;
                // Consumables kter√© d√°vaj√≠ hunger/health/energy
                if (i.type === 'consumable') {
                    const itemData = ITEMS.find(d => d.id === i.id);
                    const effect = i.effect || itemData?.effect;
                    return effect === 'hunger' || effect === 'health' || effect === 'energy';
                }
                // P≈ô√≠mo zkontroluj effect na itemu
                if (i.effect === 'hunger' || i.effect === 'health' || i.effect === 'energy') return true;
                return false;
            });
            
            // P≈ôidej syrov√© maso z resources (jen pro zv√≠≈ôec√≠ spoleƒçn√≠ky)
            if ((state.resources?.raw_meat || 0) > 0) {
                foodItems.push({
                    id: 'raw_meat',
                    name: 'Syrov√© maso',
                    icon: 'ü•©',
                    count: state.resources.raw_meat,
                    isResource: true // Oznaƒçen√≠ ≈æe je to z resources
                });
            }
            
            const waterItems = state.inv.filter(i => {
                // P≈ô√≠mo podle type
                if (i.type === 'drink' || i.type === 'water') return true;
                // Consumables kter√© d√°vaj√≠ thirst
                if (i.type === 'consumable') {
                    const itemData = ITEMS.find(d => d.id === i.id);
                    const effect = i.effect || itemData?.effect;
                    return effect === 'thirst';
                }
                // P≈ô√≠mo zkontroluj effect na itemu
                if (i.effect === 'thirst') return true;
                // Itemy s "voda/water" v n√°zvu
                if (i.name?.toLowerCase().includes('voda') || i.id?.includes('water')) return true;
                return false;
            });
            
            const hpPercent = comp.maxHp > 0 ? Math.round((comp.hp / comp.maxHp) * 100) : 0;
            const needsFood = comp.hunger === undefined || comp.hunger < 100;
            const needsWater = comp.thirst === undefined || comp.thirst < 100;
            
            let html = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${companion?.icon || 'üêæ'}</div>
                    <h3 style="margin: 0;">${comp.name || companion?.name || 'Spoleƒçn√≠k'}</h3>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span>‚ù§Ô∏è HP:</span>
                            <span style="color: ${hpPercent > 50 ? '#4caf50' : hpPercent > 25 ? '#ff9800' : '#c62828'};">${comp.hp}/${comp.maxHp}</span>
                        </div>
                        <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${hpPercent}%; background: ${hpPercent > 50 ? '#4caf50' : hpPercent > 25 ? '#ff9800' : '#c62828'};"></div>
                        </div>
                    </div>
                </div>
                
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">üçñ D√°t j√≠dlo:</h4>
                <div style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem;">
            `;
            
            if (foodItems.length === 0) {
                html += `<p style="color: #666; text-align: center; padding: 0.5rem;">${currentLang === "en" ? "You have no food" : "Nem√°≈° ≈æ√°dn√© j√≠dlo"}</p>`;
            } else {
                foodItems.forEach(item => {
                    const itemData = ITEMS.find(d => d.id === item.id);
                    const count = item.count || 1;
                    // Speci√°ln√≠ hodnota pro syrov√© maso
                    const healAmount = item.id === 'raw_meat' ? 30 : (itemData?.value || 20);
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="font-size: 1.3rem;">${item.icon || itemData?.icon || 'üçñ'}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-size: 0.9rem;">${item.name} ${count > 1 ? `<span style="color: #ffd700;">√ó${count}</span>` : ''}</div>
                                <div style="color: #4caf50; font-size: 0.75rem;">+${healAmount} HP ${item.id === 'raw_meat' ? '<span style="color: #ff9800;">(syrov√©)</span>' : ''}</div>
                            </div>
                            <button class="btn" onclick="feedCompanionItem('${companionId}', '${item.id}', 'food')" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">` + (currentLang === "en" ? "Give" : "D√°t") + `</button>
                        </div>
                    `;
                });
            }
            
            html += `</div>
                <h4 style="color: #2196f3; margin-bottom: 0.5rem;">üíß D√°t pit√≠:</h4>
                <div style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem;">
            `;
            
            if (waterItems.length === 0) {
                html += `<p style="color: #666; text-align: center; padding: 0.5rem;">${currentLang === "en" ? "You have no drinks" : "Nem√°≈° ≈æ√°dn√© pit√≠"}</p>`;
            } else {
                waterItems.forEach(item => {
                    const itemData = ITEMS.find(d => d.id === item.id);
                    const count = item.count || 1;
                    const healAmount = Math.floor((itemData?.value || 20) / 2);
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="font-size: 1.3rem;">${item.icon}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-size: 0.9rem;">${item.name} ${count > 1 ? `<span style="color: #ffd700;">√ó${count}</span>` : ''}</div>
                                <div style="color: #2196f3; font-size: 0.75rem;">+${healAmount} HP</div>
                            </div>
                            <button class="btn" onclick="feedCompanionItem('${companionId}', '${item.id}', 'water')" style="background: #2196f3; padding: 0.3rem 0.6rem; font-size: 0.8rem;">` + (currentLang === "en" ? "Give" : "D√°t") + `</button>
                        </div>
                    `;
                });
            }
            
            html += `</div>
                <button class="btn" onclick="showCompanionsInfo()" style="width: 100%; background: #555;">‚Üê ${'Zpƒõt'}</button>
            `;
            
            showModal(`üçñ ${'Nakrmit'} ${comp.name || companion?.name}`, html);
        }
        
        // Nakrmit spoleƒçn√≠ka konkr√©tn√≠m itemem
        function feedCompanionItem(companionId, itemId, type) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Speci√°ln√≠ p≈ô√≠pad pro raw_meat z resources
            if (itemId === 'raw_meat') {
                if ((state.resources?.raw_meat || 0) <= 0) {
                    notifyWarning('Chyba', 'Nem√°≈° syrov√© maso');
                    return;
                }
                
                const healAmount = 30;
                const oldHp = comp.hp;
                comp.hp = Math.min(comp.maxHp, comp.hp + healAmount);
                const actualHeal = comp.hp - oldHp;
                
                // Odeber z resources
                state.resources.raw_meat--;
                
                // Loajalita
                const loyaltyGain = 3;
                comp.loyalty = Math.min(100, (comp.loyalty || 0) + loyaltyGain);
                comp.lastFed = true;
                comp.lastFedTime = Date.now(); // Timestamp pro 24h syst√©m
                
                const companion = COMPANIONS.find(c => c.id === companionId);
                const compName = comp.name || companion?.name || 'Spoleƒçn√≠k';
                
                notifySuccess(`${compName} nakrmen!`, `+${actualHeal} HP, +${loyaltyGain} ‚ù§Ô∏è loajalita`);
                addLog(`ü•© ${compName} nakrmen syrov√Ωm masem: +${actualHeal} HP, +${loyaltyGain} ‚ù§Ô∏è`, companion?.icon || 'üêæ');
                
                // Daily quest progress
                if (state.dailyQuests?.progress) {
                    state.dailyQuests.progress.fedCompanion = (state.dailyQuests.progress.fedCompanion || 0) + 1;
                    checkDailyQuests();
                }
                
                saveGame();
                showFeedCompanionDialog(companionId);
                return;
            }
            
            const item = state.inv.find(i => i.id === itemId);
            if (!item) {
                notifyWarning('Chyba', 'Item nenalezen');
                return;
            }
            
            const itemData = ITEMS.find(d => d.id === itemId);
            const healAmount = type === 'food' ? (itemData?.value || 20) : Math.floor((itemData?.value || 20) / 2);
            
            // P≈ôidej HP
            const oldHp = comp.hp;
            comp.hp = Math.min(comp.maxHp, comp.hp + healAmount);
            const actualHeal = comp.hp - oldHp;
            
            // Nastav stav nakrmen√≠/napojen√≠ + timestamp
            const now = Date.now();
            if (type === 'food') {
                comp.lastFed = true;
                comp.lastFedTime = now;
            } else if (type === 'water') {
                comp.lastWatered = true;
                comp.lastWateredTime = now;
            }
            
            // === P≈òIDEJ LOAJALITU ===
            const loyaltyGain = type === 'food' ? 3 : 2;
            comp.loyalty = Math.min(100, (comp.loyalty || 0) + loyaltyGain);
            
            // Odeber item - najdi ho znovu podle indexu pro jistotu
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex !== -1) {
                const invItem = state.inv[itemIndex];
                if (invItem.count && invItem.count > 1) {
                    invItem.count--;
                } else {
                    state.inv.splice(itemIndex, 1);
                }
            }
            
            const companion = COMPANIONS.find(c => c.id === companionId);
            const compName = comp.name || companion?.name || 'Spoleƒçn√≠k';
            
            const actionText = type === 'food' ? 'nakrmen' : 'napojen';
            notifySuccess(`${compName} ${actionText}!`, `+${actualHeal} HP, +${loyaltyGain} ‚ù§Ô∏è loajalita`);
            addLog(`${type === 'food' ? 'üçñ' : 'üíß'} ${compName} ${actionText}: +${actualHeal} HP, +${loyaltyGain} ‚ù§Ô∏è`, companion?.icon || 'üêæ');
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.fedCompanion = (state.dailyQuests.progress.fedCompanion || 0) + 1;
                checkDailyQuests();
            }
            
            saveGame();
            showFeedCompanionDialog(companionId);
        }
        
        // Denn√≠ spot≈ôeba j√≠dla a vody pro spoleƒçn√≠ky (ka≈æd√Ωch 24 hodin re√°ln√©ho ƒçasu)
        function feedCompanions() {
            if (!state.companions || state.companions.length === 0) return;
            
            const now = Date.now();
            const DAY_MS = 24 * 60 * 60 * 1000; // 24 hodin v ms
            
            const aliveCompanions = state.companions.filter(c => !c.isDead);
            if (aliveCompanions.length === 0) return;
            
            let fedCompanions = [];
            let hungryCompanions = [];
            
            aliveCompanions.forEach(comp => {
                // Inicializace timestamp≈Ø pokud chyb√≠
                if (!comp.lastFedTime) comp.lastFedTime = now;
                if (!comp.lastWateredTime) comp.lastWateredTime = now;
                
                // Zkontroluj jestli uplynulo 24 hodin od posledn√≠ho nakrmen√≠
                const needsFood = (now - comp.lastFedTime) >= DAY_MS;
                const needsWater = (now - comp.lastWateredTime) >= DAY_MS;
                
                if (!needsFood && !needsWater) {
                    // Je≈°tƒõ nepot≈ôebuje krmit
                    return;
                }
                
                let fed = !needsFood; // Pokud nepot≈ôebuje, pova≈æuj za najeden√©ho
                let watered = !needsWater;
                
                // Pot≈ôebuje j√≠dlo?
                if (needsFood) {
                    const foodItems = state.inv.filter(i => {
                        const itemData = ITEMS.find(d => d.id === i.id);
                        return itemData && itemData.type === 'consumable' && itemData.effect === 'hunger';
                    });
                    
                    if (foodItems.length > 0) {
                        const food = foodItems[0];
                        if (food.count && food.count > 1) {
                            food.count--;
                        } else {
                            state.inv = state.inv.filter(i => i !== food);
                        }
                        fed = true;
                        comp.lastFed = true;
                        comp.lastFedTime = now;
                    } else {
                        comp.lastFed = false;
                    }
                }
                
                // Pot≈ôebuje vodu?
                if (needsWater) {
                    const waterItems = state.inv.filter(i => {
                        const itemData = ITEMS.find(d => d.id === i.id);
                        return itemData && itemData.type === 'consumable' && itemData.effect === 'thirst';
                    });
                    
                    if (waterItems.length > 0) {
                        const water = waterItems[0];
                        if (water.count && water.count > 1) {
                            water.count--;
                        } else {
                            state.inv = state.inv.filter(i => i !== water);
                        }
                        watered = true;
                        comp.lastWatered = true;
                        comp.lastWateredTime = now;
                    } else {
                        comp.lastWatered = false;
                    }
                }
                
                if (fed && watered) {
                    fedCompanions.push(comp.name);
                } else {
                    hungryCompanions.push(comp.name);
                    // Penalizace za hlad/≈æ√≠ze≈à
                    if (!fed) {
                        comp.hp = Math.max(1, (comp.hp || comp.maxHp || 50) - 10);
                    }
                    if (!watered) {
                        comp.hp = Math.max(1, (comp.hp || comp.maxHp || 50) - 15);
                    }
                }
            });
            
            // Notifikace
            if (fedCompanions.length > 0) {
                addLog(`üçñüíß Spoleƒçn√≠ci nakrmeni: ${fedCompanions.join(', ')}`, 'üêæ');
            }
            if (hungryCompanions.length > 0) {
                notifyWarning('Hladov√≠ spoleƒçn√≠ci!', `${hungryCompanions.join(', ')} nemaj√≠ co j√≠st/p√≠t!`);
                addLog(`‚ö†Ô∏è Hladov√≠ spoleƒçn√≠ci: ${hungryCompanions.join(', ')}`, 'üò¢');
                // Push notifikace na mobil
                MobileNotifications.notifyCompanionHungry(hungryCompanions.join(', '));
            }
            
            updateCarryWeight();
        }
        
        // === RYBA≈òEN√ç ===
        function startFishing(skipLocationCheck = false) {
            if (!state.inv.find(i => i.id === 'fishing_rod' || i.id === 'fishing_rod_uncommon' || i.bonus === 'fishing')) {
                showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° üé£ Ryb√°≈ôsk√Ω prut pro ryba≈ôen√≠!');
                return;
            }
            
            if (!skipLocationCheck) {
                // Nov√Ω syst√©m - kontrola zda lokace umo≈æ≈àuje ryba≈ôen√≠
                const currentLoc = getCurrentLocation();
                const canFish = currentLoc?.actions?.includes('fish') || 
                               currentLoc?.resource === 'water' || 
                               currentLoc?.id === 'small_pond' ||
                               currentLoc?.type === 'resource' && currentLoc?.id?.includes('pond');
                if (!canFish) {
                    showModal('‚ùå ≈†patn√© m√≠sto', 'M≈Ø≈æe≈° ryba≈ôit pouze u vody (rybn√≠k, jezero)!');
                    return;
                }
            }
            
            // Pokud p≈ôeskakujeme kontrolu (z timed action), rovnou dej v√Ωsledek
            if (skipLocationCheck) {
                completeFishing();
                return;
            }
            
            showModal('üé£ Ryba≈ôen√≠...', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; animation: bounce 1s infinite;">üé£</div>
                    <p>ƒåek√°≈° na √∫lovek...</p>
                    <div class="progress-bar" style="margin: 1rem 0;">
                        <div id="fishingProgress" style="width: 0%; height: 20px; background: #2196f3; border-radius: 10px; transition: width 0.1s;"></div>
                    </div>
                </div>
            `);
            
            let progress = 0;
            const fishingInterval = setInterval(() => {
                progress += 2;
                const progressBar = document.getElementById('fishingProgress');
                if (progressBar) progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(fishingInterval);
                    completeFishing();
                }
            }, 100);
        }
        
        function completeFishing() {
            const skillBonus = (state.skills_secondary?.fishing || 0) * 0.05;
            
            // Bonus z ryb√°≈ôsk√©ho prutu
            let rodBonus = 0;
            const rod = state.inv.find(i => i.id === 'fishing_rod_uncommon') || state.inv.find(i => i.id === 'fishing_rod');
            if (rod) {
                const rodData = ITEMS.find(it => it.id === rod.id);
                rodBonus = (rodData?.bonusValue || rod.bonusValue || 1) * 0.05; // +5% za ka≈æd√Ω bonusValue
            }
            
            const roll = Math.random() + skillBonus + rodBonus;
            
            // 30% ≈°ance ≈æe nic nechyt√≠≈° (sn√≠≈æeno bonusem z prutu)
            const failChance = Math.max(0.10, 0.30 - rodBonus);
            if (Math.random() < failChance) {
                showModal('üé£ Nic!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üåä</div>
                        <p style="color: #888;">Tentokr√°t nic... Ryby jsou chyt≈ôej≈°√≠.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showActionModal('fish');" style="width: 100%; margin-top: 0.5rem;">üé£ Zkusit znovu</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                `);
                return;
            }
            
            let caught = null;
            let cumulative = 0;
            
            for (const fish of FISH_TYPES) {
                cumulative += fish.chance;
                if (roll < cumulative) {
                    caught = fish;
                    break;
                }
            }
            
            if (!caught) caught = FISH_TYPES[0]; // Fallback na malou rybu
            
            // Zvy≈° fishing skill
            state.skills_secondary = state.skills_secondary || { fishing: 0, mining: 0, hunting: 0, cooking: 0, alchemy: 0 };
            state.skills_secondary.fishing = Math.min(10, (state.skills_secondary.fishing || 0) + 0.1);
            
            if (caught.junk) {
                showModal('üé£ √ölovek!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">${caught.icon}</div>
                        <p>Chytil jsi ${caught.name}... to nen√≠ moc u≈æiteƒçn√©.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            if (caught.special === 'treasure') {
                const money = Math.floor(Math.random() * 200) + 100;
                addMoney(money);
                const rareItem = ITEMS.filter(i => i.rarity === 'rare')[Math.floor(Math.random() * ITEMS.filter(i => i.rarity === 'rare').length)];
                if (rareItem && canAddItem(rareItem, 1)) {
                    state.inv.push({...rareItem, count: 1});
                }
                showModal('üé£ POKLAD!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üì¶</div>
                        <p style="color: #ffd700;">Vyt√°hl jsi truhliƒçku s pokladem!</p>
                        <p>+${money} üí∞</p>
                        ${rareItem ? `<p>+${rareItem.icon} ${rareItem.name}</p>` : ''}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${currentLang === "en" ? "Great!" : "Skvƒõl√©!"}</button>
                `);
                return;
            }
            
            if (caught.special === 'wish') {
                showModal('üé£ ZLAT√Å RYBKA!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">‚ú®üêü‚ú®</div>
                        <p style="color: #ffd700;">Chytil jsi zlatou rybku! Spln√≠ ti p≈ô√°n√≠!</p>
                    </div>
                    <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="wishHealth()" style="background: #c62828;">‚ù§Ô∏è ${currentLang === "en" ? "Full health" : "Pln√© zdrav√≠"}</button>
                        <button class="btn" onclick="wishMoney()" style="background: #ffd700; color: #000;">üí∞ 500 penƒõz</button>
                        <button class="btn" onclick="wishXP()" style="background: #9c27b0;">‚≠ê 200 XP</button>
                    </div>
                `);
                return;
            }
            
            // Norm√°ln√≠ ryba
            state.resources.fish = (state.resources.fish || 0) + 1;
            markFoodAsNew('fish');
            if (caught.radiation) {
                state.status.radiation = Math.min(100, state.status.radiation + caught.radiation);
            }
            
            showModal('üé£ √ölovek!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${caught.icon}</div>
                    <h3>${caught.name}</h3>
                    <p style="color: #8bc34a;">+1 ryba</p>
                    <p style="color: #999;">Hodnota: ${caught.value} üí∞</p>
                    ${caught.radiation ? `<p style="color: #ff9800;">+${caught.radiation} radiace</p>` : ''}
                </div>
                <button class="btn" onclick="closeModal(); showActionModal('fish');" style="width: 100%; margin-top: 0.5rem;">üé£ Ryba≈ôit znovu</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
            `);
        }
        
        function wishHealth() { state.char.hp = state.char.maxHp; closeModal(); addLog('Zlat√° rybka ti vyl√©ƒçila v≈°echna zranƒõn√≠!', '‚ú®'); }
        function wishMoney() { addMoney(500); closeModal(); addLog('Zlat√° rybka ti dala 500 penƒõz!', '‚ú®'); }
        function wishXP() { addXP(200); closeModal(); addLog('Zlat√° rybka ti dala 200 XP!', '‚ú®'); }
        
        // === ƒåASOVAN√â AKCE ===
        function calculateActionTimeModifier(actionType) {
            let modifier = 1.0;
            
            // Poƒças√≠
            const weather = getCurrentWeather();
            if (weather) {
                if (weather.id === 'rain') modifier *= 1.3;
                else if (weather.id === 'storm') modifier *= 1.5;
                else if (weather.id === 'fog') modifier *= 1.2;
                else if (weather.id === 'radstorm') modifier *= 1.4;
            }
            
            // Skilly postavy
            const per = state.char.attrs?.per || 5;
            const agi = state.char.attrs?.agi || 5;
            const str = state.char.attrs?.str || 5;
            
            // R≈Øzn√© skilly pro r≈Øzn√© akce
            if (actionType === 'hunt') {
                modifier *= 1 - ((per - 5) * 0.05); // Vn√≠mavost zrychluje lov
            } else if (actionType === 'mine') {
                modifier *= 1 - ((str - 5) * 0.05); // S√≠la zrychluje tƒõ≈æbu
            } else if (actionType === 'explore') {
                modifier *= 1 - ((per - 5) * 0.04); // Vn√≠mavost zrychluje pr≈Øzkum
                modifier *= 1 - ((agi - 5) * 0.03); // Obratnost tak√©
            } else if (actionType === 'fish') {
                const lck = state.char.attrs?.lck || 5;
                modifier *= 1 - ((lck - 5) * 0.04); // ≈†tƒõst√≠ zrychluje rybolov
            }
            
            // Skill fast_travel sni≈æuje ƒças v≈°ech akc√≠
            const fastTravelLevel = state.skills?.['fast_travel'] || 0;
            if (fastTravelLevel > 0) {
                modifier *= 1 - (fastTravelLevel * 0.05);
            }
            
            // Minimum 0.5, maximum 2.0
            return Math.max(0.5, Math.min(2.0, modifier));
        }
        
        // P≈ôeklad n√°zvu akce
        function getActionName(actionType) {
            const names = {
                'hunt': 'lov',
                'mine': 'tƒõ≈æbu',
                'fish': 'ryba≈ôen√≠',
                'explore': 'pr≈Øzkum',
                'gather': 'sbƒõr'
            };
            return names[actionType] || actionType;
        }
        
        function startTimedAction(actionType) {
            console.log('startTimedAction called with:', actionType);
            
            // Kontrola zda neprob√≠h√° cestov√°n√≠
            if (state.world.traveling || state.map.traveling) {
                notifyWarning('Cestuje≈°!', 'Nejd≈ô√≠ve dokonƒçi nebo zru≈° cestov√°n√≠!');
                return;
            }
            
            // Kontrola zda u≈æ neprob√≠h√° jin√° akce
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                notifyWarning('Akce prob√≠h√°', 'Nejd≈ô√≠ve dokonƒçi nebo zru≈° prob√≠haj√≠c√≠ akci!');
                return;
            }
            
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // Kontrola vybaven√≠ P≈òED zapoƒçet√≠m akce
            if (actionType === 'hunt') {
                const huntingWeapon = state.inv.find(i => 
                    i.id === 'hunting_bow' || i.id === 'crossbow' || i.id === 'wooden_bow' || i.id === 'bow' ||
                    (i.type === 'weapon' && i.icon === 'üèπ')
                );
                if (!huntingWeapon) {
                    showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° üèπ Luk nebo Ku≈°i pro lov!');
                    return;
                }
                // Kontrola ≈°√≠p≈Ø/≈°ipek
                if (huntingWeapon.ammoType) {
                    const ammoCount = getAmmoCount(huntingWeapon.ammoType);
                    if (ammoCount < 1) {
                        showModal('‚ùå Chyb√≠ munice', `Pot≈ôebuje≈° ${getAmmoName(huntingWeapon.ammoType)} pro ${huntingWeapon.name}!`);
                        return;
                    }
                }
            }
            if (actionType === 'mine') {
                if (!state.inv.find(i => i.id === 'pickaxe')) {
                    showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° ‚õèÔ∏è Krump√°ƒç pro tƒõ≈æbu!');
                    return;
                }
            }
            if (actionType === 'fish') {
                if (!state.inv.find(i => i.id === 'fishing_rod' || i.id === 'fishing_rod_uncommon' || i.bonus === 'fishing')) {
                    showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° üé£ Ryb√°≈ôsk√Ω prut pro rybolov!');
                    return;
                }
            }
            if (actionType === 'alchemy') {
                if (!state.inv.find(i => i.id === 'alchemy_set')) {
                    showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° ‚öóÔ∏è Alchymistickou sadu!');
                    return;
                }
                // Kontrola surovin
                const herbs = state.resources?.herbs || 0;
                const chemicals = state.resources?.chemicals || 0;
                if (herbs + chemicals < 2) {
                    showModal('‚ùå Nedostatek surovin', `Pot≈ôebuje≈° alespo≈à 2 suroviny (byliny nebo chemik√°lie).<br><br>M√°≈°: üåø ${herbs} bylin, üß™ ${chemicals} chemik√°li√≠`);
                    return;
                }
            }
            
            // Kontrola energie P≈òED odeƒçten√≠m pokusu
            if (state.status.energy < 10) {
                showModal('‚ùå Vyƒçerp√°n√≠', 'Nem√°≈° dost energie! Pot≈ôebuje≈° alespo≈à 10 ‚ö°');
                return;
            }
            
            // Kontrola a pou≈æit√≠ denn√≠ho limitu
            const limitedActions = ['hunt', 'mine', 'fish', 'explore', 'gather'];
            if (limitedActions.includes(actionType) && location) {
                const limit = checkDailyActionLimit(actionType, location.id);
                if (!limit.canDo) {
                    notifyWarning('Denn√≠ limit', 'Tuto akci zde u≈æ nelze prov√©st (3/3)');
                    return;
                }
                useActionLimit(actionType, location.id);
            }
            
            const timeModifier = calculateActionTimeModifier(actionType);
            console.log('timeModifier:', timeModifier);
            // Z√°kladn√≠ ƒçasy v minut√°ch
            const baseTimes = { hunt: 5, mine: 4, fish: 6, explore: 5, gather: 3, alchemy: 7 };
            const baseTime = baseTimes[actionType] || 5;
            const actualTime = Math.max(1, Math.round(baseTime * timeModifier));
            const durationMs = actualTime * 60 * 1000; // Minuty na ms
            
            // Ulo≈æ stav akce
            state.currentAction = {
                type: actionType,
                startTime: Date.now(),
                duration: durationMs,
                endTime: Date.now() + durationMs
            };
            
            // Auto-save aby se akce zachovala p≈ôi refreshi
            saveGame(true);
            
            // Aktualizuj UI aby se zak√°zaly ostatn√≠ akce
            renderFull();
            
            // Zobraz progress (v minut√°ch)
            showActionProgress(actionType, actualTime);
        }
        
        // Obnoven√≠ prob√≠haj√≠c√≠ akce po refreshi/naƒçten√≠ hry
        function resumeCurrentAction() {
            if (!state.currentAction) return;
            
            const now = Date.now();
            const action = state.currentAction;
            
            // Akce u≈æ skonƒçila bƒõhem doby co byla str√°nka zav≈ôen√°
            if (now >= action.endTime) {
                console.log('‚è∞ Akce dokonƒçena bƒõhem offline:', action.type);
                // Dokonƒçi akci
                setTimeout(() => completeTimedAction(action.type), 500);
                return;
            }
            
            // Akce st√°le prob√≠h√° - obnov ji
            const remainingMs = action.endTime - now;
            const remainingMins = Math.ceil(remainingMs / 60000);
            console.log(`‚ñ∂Ô∏è Obnovuji akci: ${action.type}, zb√Ωv√° ${remainingMins} min`);
            
            // Spus≈• progress tracking (bez zobrazen√≠ modalu)
            showActionProgress(action.type, remainingMins, true);
            
            // Informuj hr√°ƒçe
            const icons = { hunt: 'üèπ', mine: '‚õèÔ∏è', fish: 'üé£', explore: 'üîç', gather: 'üß∫' };
            const names = { hunt: 'Lov', mine: 'Tƒõ≈æba', fish: 'Rybolov', explore: 'Pr≈Øzkum', gather: 'Sb√≠r√°n√≠' };
            notifySuccess(
                'Akce obnovena',
                `${icons[action.type]} ${names[action.type]} pokraƒçuje...`
            );
        }
        
        function showActionProgress(actionType, totalMinutes, isResumed = false) {
            const icons = { hunt: 'üèπ', mine: '‚õèÔ∏è', fish: 'üé£', explore: 'üîç', gather: 'üß∫', alchemy: '‚öóÔ∏è' };
            const names = { hunt: 'Lov', mine: 'Tƒõ≈æba', fish: 'Rybolov', explore: 'Pr≈Øzkum', gather: 'Sb√≠r√°n√≠', alchemy: 'Alchymie' };
            
            // Spust√≠me interval pro kontrolu dokonƒçen√≠ A aktualizaci UI
            const checkProgress = () => {
                if (!state.currentAction || state.currentAction.type !== actionType) return;
                
                const now = Date.now();
                if (now >= state.currentAction.endTime) {
                    completeTimedAction(actionType);
                } else {
                    setTimeout(checkProgress, 1000); // Ka≈ædou sekundu
                }
                
                // P≈ôekresli mapu kv≈Øli progress baru KA≈ΩDOU SEKUNDU
                if (state.activeTab === 'map' && document.getElementById('mapContainer')) {
                    const modal = document.getElementById('modal');
                    if (!modal?.classList.contains('show')) {
                        renderWorldMap();
                    }
                }
            };
            
            // Spus≈• kontrolu na pozad√≠
            setTimeout(checkProgress, 1000);
            
            // P≈ôekresli mapu aby se zobrazil progress bar
            renderWorldMap();
            
            // Po refreshi nezobrazuj modal znovu, jen ti≈°e pokraƒçuj
            if (isResumed) return;
            
            // Zobraz velk√Ω modal s progress barem
            const now = Date.now();
            const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            
            showModal(icons[actionType] + ' ' + names[actionType], `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${icons[actionType]}</div>
                    <p style="margin-bottom: 1rem;">Prob√≠h√° ${names[actionType].toLowerCase()}...</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="height: 20px; background: #333; border-radius: 10px; overflow: hidden;">
                            <div id="actionProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.3s;"></div>
                        </div>
                        <p id="actionProgressText" style="margin: 0.5rem 0 0 0; color: #ffd700; font-size: 1.2rem;">${mins}:${String(secs).padStart(2, '0')}</p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #4caf50;">‚úì Zav≈ô√≠t (bƒõ≈æ√≠ na pozad√≠)</button>
                        <button class="btn" onclick="cancelTimedAction()" style="flex: 1; background: #c62828;">‚ùå Zru≈°it</button>
                    </div>
                    <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem;">Progress bar vid√≠≈° nad mapou</p>
                </div>
            `);
            
            // Update progress bar v modalu
            const updateModalProgress = () => {
                if (!state.currentAction || state.currentAction.type !== actionType) return;
                
                const now = Date.now();
                const elapsed = now - state.currentAction.startTime;
                const progress = Math.min(100, (elapsed / state.currentAction.duration) * 100);
                const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
                
                const progressBar = document.getElementById('actionProgressBar');
                const progressText = document.getElementById('actionProgressText');
                
                if (progressBar) progressBar.style.width = progress + '%';
                if (progressText) {
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    progressText.textContent = `${mins}:${String(secs).padStart(2, '0')}`;
                }
                
                if (progress < 100 && progressBar) {
                    setTimeout(updateModalProgress, 100);
                }
            };
            
            setTimeout(updateModalProgress, 100);
        }
        
        // Zobraz√≠ modal s progress barem pro akce (kliknut√≠m na progress bar)
        function showActionProgressModal() {
            if (!state.currentAction) return;
            
            const icons = { hunt: 'üèπ', mine: '‚õèÔ∏è', fish: 'üé£', explore: 'üîç', gather: 'üß∫' };
            const names = { hunt: 'Lov', mine: 'Tƒõ≈æba', fish: 'Rybolov', explore: 'Pr≈Øzkum', gather: 'Sb√≠r√°n√≠' };
            const actionType = state.currentAction.type;
            
            const now = Date.now();
            const elapsed = now - state.currentAction.startTime;
            const progress = Math.min(100, (elapsed / state.currentAction.duration) * 100);
            const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            
            showModal(icons[actionType] + ' ' + names[actionType], `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${icons[actionType]}</div>
                    <p style="margin-bottom: 1rem;">Prob√≠h√° ${names[actionType].toLowerCase()}...</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="height: 20px; background: #333; border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #4caf50, #8bc34a);"></div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #ffd700; font-size: 1.2rem;">${mins}:${String(secs).padStart(2, '0')}</p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #4caf50;">‚úì Zav≈ô√≠t (bƒõ≈æ√≠ na pozad√≠)</button>
                        <button class="btn" onclick="cancelTimedAction()" style="flex: 1; background: #c62828;">‚ùå Zru≈°it</button>
                    </div>
                </div>
            `);
        }
        
        function cancelTimedAction() {
            // Potvrzovac√≠ dialog
            const confirmTitle = '‚ö†Ô∏è Zru≈°it akci?';
            const confirmText = 'Opravdu chce≈° zru≈°it tuto akci? Toto se poƒç√≠t√° jako vyu≈æit√≠ denn√≠ho limitu!';
            
            showModal(confirmTitle, `
                <div style="text-align: center;">
                    <p style="color: #ff9800; margin-bottom: 1rem;">${confirmText}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">
                            ‚Üê ${'Zpƒõt'}
                        </button>
                        <button class="btn" onclick="confirmCancelTimedAction()" style="background: #c62828;">
                            ‚ùå ${'Ano, zru≈°it'}
                        </button>
                    </div>
                </div>
            `);
        }
        
        function confirmCancelTimedAction() {
            state.currentAction = null;
            closeModal();
            notifyWarning('Akce zru≈°ena');
            renderWorldMap();
        }
        
        function completeTimedAction(actionType) {
            const icons = { hunt: 'üèπ', mine: '‚õèÔ∏è', fish: 'üé£', explore: 'üîç', gather: 'üß∫', alchemy: '‚öóÔ∏è' };
            const names = { hunt: 'Lov', mine: 'Tƒõ≈æba', fish: 'Rybolov', explore: 'Pr≈Øzkum', gather: 'Sb√≠r√°n√≠', alchemy: 'Alchymie' };
            
            state.currentAction = null;
            
            // Notifikace o dokonƒçen√≠
            notifySuccess(`${icons[actionType]} ${names[actionType]} dokonƒçen!`, '');
            
            // Spus≈• skuteƒçnou akci
            if (actionType === 'hunt') {
                executeHunting();
            } else if (actionType === 'mine') {
                executeMining();
            } else if (actionType === 'fish') {
                executeFishing();
            } else if (actionType === 'explore') {
                executeExploring();
            } else if (actionType === 'gather') {
                executeGathering();
            } else if (actionType === 'alchemy') {
                executeAlchemy();
            }
            
            // P≈ôekresli mapu
            renderWorldMap();
        }
        
        function executeHunting() {
            startHunting();
        }
        
        function executeMining() {
            startMining();
        }
        
        function executeFishing() {
            startFishing(true); // true = skip location check (already done)
        }
        
        function executeGathering() {
            // Spust√≠ sb√≠r√°n√≠ - limit u≈æ je odebr√°n v startTimedAction
            gatherResources(true); // true = skip limit check
        }
        
        function executeExploring() {
            // Mal√© zpo≈ædƒõn√≠ aby se spr√°vnƒõ zav≈ôel p≈ôedchoz√≠ modal
            setTimeout(() => {
                exploreLocation(true); // Skip limit check - already done in startTimedAction
            }, 100);
        }
        
        function executeAlchemy() {
            // Kontrola alchymistick√© sady
            if (!state.inv.find(i => i.id === 'alchemy_set')) {
                showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° ‚öóÔ∏è Alchymistickou sadu!');
                return;
            }
            
            // Zjisti dostupn√© suroviny
            const herbs = state.resources?.herbs || 0;
            const chemicals = state.resources?.chemicals || 0;
            const totalMaterials = herbs + chemicals;
            
            if (totalMaterials < 2) {
                showModal('‚öóÔ∏è Nedostatek surovin', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üåø</div>
                        <p style="color: #888;">Nem√°≈° dostatek bylin nebo chemik√°li√≠.</p>
                        <p style="color: #666; font-size: 0.85rem;">M√°≈°: üåø ${herbs} bylin, üß™ ${chemicals} chemik√°li√≠</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">OK</button>
                `);
                return;
            }
            
            // Skill bonus
            const alchemySkill = state.skills_secondary?.alchemy || 0;
            const skillBonus = alchemySkill * 0.1; // +10% za level
            
            // Urƒç√≠me co vyrob√≠me podle dostupn√Ωch surovin
            let results = [];
            let herbsUsed = 0;
            let chemsUsed = 0;
            
            // Z√°kladn√≠ ≈°ance na r≈Øzn√© produkty
            const roll = Math.random() + skillBonus;
            
            // Spot≈ôeba surovin (2-4 podle skillu)
            const baseConsumption = Math.max(2, Math.floor(4 - alchemySkill * 0.3));
            
            if (roll > 0.85 && chemicals >= 2 && herbs >= 2) {
                // Vz√°cn√© - RadAway
                results.push({ id: 'radaway', name: 'RadAway', icon: '‚ò¢Ô∏è', count: 1 });
                herbsUsed = 2;
                chemsUsed = 2;
            } else if (roll > 0.6 && herbs >= 2) {
                // L√©k√°rniƒçka
                results.push({ id: 'medkit', name: 'L√©k√°rniƒçka', icon: '‚öïÔ∏è', count: 1 });
                herbsUsed = 2;
                chemsUsed = Math.min(1, chemicals);
            } else if (roll > 0.4 && chemicals >= 2) {
                // Stimpak
                results.push({ id: 'stimpack', name: 'Stimpak', icon: 'üíâ', count: 1 });
                herbsUsed = Math.min(1, herbs);
                chemsUsed = 2;
            } else if (herbs >= 1) {
                // Z√°kladn√≠ band√°≈æ
                results.push({ id: 'bandage', name: 'Band√°≈æ', icon: 'ü©π', count: 1 + Math.floor(Math.random() * 2) });
                herbsUsed = Math.min(baseConsumption, herbs);
                chemsUsed = 0;
            } else {
                // Jen chemik√°lie - antidotum
                results.push({ id: 'antidote', name: 'Antidotum', icon: 'üíä', count: 1 });
                herbsUsed = 0;
                chemsUsed = Math.min(baseConsumption, chemicals);
            }
            
            // Bonus ≈°ance na extra item p≈ôi vysok√©m skillu
            if (alchemySkill >= 3 && Math.random() < 0.25) {
                results.push({ id: 'bandage', name: 'Band√°≈æ', icon: 'ü©π', count: 1 });
            }
            
            // Odeƒçti suroviny
            state.resources.herbs = Math.max(0, herbs - herbsUsed);
            state.resources.chemicals = Math.max(0, chemicals - chemsUsed);
            
            // P≈ôidej v√Ωsledky do invent√°≈ôe
            results.forEach(item => {
                const existing = state.inv.find(i => i.id === item.id);
                if (existing) {
                    existing.count = (existing.count || 1) + item.count;
                } else {
                    const itemDef = ITEMS.find(i => i.id === item.id) || {};
                    state.inv.push({
                        id: item.id,
                        name: item.name,
                        icon: item.icon,
                        type: 'consumable',
                        effect: itemDef.effect || 'hp',
                        value: itemDef.value || 20,
                        count: item.count,
                        weight: itemDef.weight || 0.3
                    });
                }
            });
            
            // Zvy≈° alchemy skill
            state.skills_secondary.alchemy = Math.min(10, (state.skills_secondary.alchemy || 0) + 0.15);
            
            // Statistiky
            state.stats.itemsCrafted = (state.stats.itemsCrafted || 0) + results.reduce((sum, r) => sum + r.count, 0);
            
            // V√Ωsledn√Ω modal
            let resultsHtml = results.map(r => `<div style="display: flex; align-items: center; gap: 0.5rem; margin: 0.3rem 0;">
                <span style="font-size: 1.5rem;">${r.icon}</span>
                <span>${r.name} x${r.count}</span>
            </div>`).join('');
            
            showModal('‚öóÔ∏è Alchymie dokonƒçena!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">‚öóÔ∏è</div>
                </div>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">Vyrobeno:</h4>
                    ${resultsHtml}
                </div>
                <p style="color: #888; font-size: 0.85rem; text-align: center;">
                    Spot≈ôebov√°no: üåø ${herbsUsed} bylin, üß™ ${chemsUsed} chemik√°li√≠
                </p>
                <p style="color: #666; font-size: 0.8rem; text-align: center;">
                    Zb√Ωv√°: üåø ${state.resources.herbs} bylin, üß™ ${state.resources.chemicals} chemik√°li√≠
                </p>
                <button class="btn" onclick="closeModal(); showActionModal('alchemy');" style="width: 100%; margin-top: 0.5rem;">‚öóÔ∏è M√≠chat znovu</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Hotovo</button>
            `);
            
            checkAchievements();
        }
        
        // === Tƒö≈ΩBA ===
        function startMining() {
            // Kontrola krump√°ƒçe
            if (!state.inv.find(i => i.id === 'pickaxe')) {
                showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° ‚õèÔ∏è Krump√°ƒç pro tƒõ≈æbu!');
                return;
            }
            
            // 30% ≈°ance ≈æe nic nenajde≈°
            if (Math.random() < 0.30) {
                showModal('‚õèÔ∏è Nic!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">ü™®</div>
                        <p style="color: #888;">Jen pr√°zdn√° sk√°la... Zkus jinde.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showActionModal('mine');" style="width: 100%; margin-top: 0.5rem;">‚õèÔ∏è Zkusit znovu</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                `);
                return;
            }
            
            const skillBonus = (state.skills_secondary?.mining || 0) * 0.05;
            const roll = Math.random() + skillBonus;
            
            let found = null;
            let cumulative = 0;
            
            for (const ore of ORES) {
                cumulative += ore.chance;
                if (roll < cumulative) {
                    found = ore;
                    break;
                }
            }
            
            if (!found) found = ORES[0]; // Fallback na ≈æelezo
            
            // Zvy≈° mining skill
            state.skills_secondary.mining = Math.min(10, (state.skills_secondary.mining || 0) + 0.1);
            
            // P≈ôidej surovinu
            if (found.smeltTo) {
                state.resources[found.smeltTo] = (state.resources[found.smeltTo] || 0) + 1;
            }
            
            // Bonusov√° ≈°ance na mƒõƒè (15%)
            if (Math.random() < 0.15) {
                state.resources.copper = (state.resources.copper || 0) + 1;
                addLog('+1 üü§ Mƒõƒè (bonus)', 'üü§');
            }
            
            if (found.radiation) {
                state.status.radiation = Math.min(100, state.status.radiation + found.radiation);
            }
            
            showModal('‚õèÔ∏è Vytƒõ≈æeno!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${found.icon}</div>
                    <h3>${found.name}</h3>
                    <p style="color: #8bc34a;">+1 ${found.smeltTo}</p>
                    ${found.radiation ? `<p style="color: #ff9800;">+${found.radiation} radiace</p>` : ''}
                </div>
                <button class="btn" onclick="closeModal(); showActionModal('mine');" style="width: 100%; margin-top: 0.5rem;">‚õèÔ∏è Tƒõ≈æit znovu</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
            `);
        }
        
        // === LOV ===
        function startHunting() {
            // Povolen√© zbranƒõ pro lov: loveck√Ω luk, ku≈°e, d≈ôevƒõn√Ω luk, nebo jak√°koliv zbra≈à s ikonou üèπ
            const huntingWeapon = state.inv.find(i => 
                i.id === 'hunting_bow' || 
                i.id === 'crossbow' || 
                i.id === 'wooden_bow' ||
                i.id === 'bow' ||
                (i.type === 'weapon' && i.icon === 'üèπ')
            );
            
            if (!huntingWeapon) {
                showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° luk nebo ku≈°i pro lov! üèπ');
                return;
            }
            
            // Vyber zv√≠≈ôe
            const animal = HUNTABLE_ANIMALS[Math.floor(Math.random() * HUNTABLE_ANIMALS.length)];
            
            showModal(('üèπ Lov: ') + animal.name, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${animal.icon}</div>
                    <p>Spat≈ôil jsi ${animal.name}!</p>
                    <p style="color: #999;">HP: ${animal.hp} | Rychlost: ${animal.speed}</p>
                    ${animal.aggressive ? '<p style="color: #ff9800;">‚ö†Ô∏è Agresivn√≠ - m≈Ø≈æe za√∫toƒçit!</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="huntAnimal('${animal.id}')" style="background: #c62828;">üèπ St≈ô√≠let</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">üèÉ Nechat b√Ωt</button>
                </div>
            `);
        }
        
        function huntAnimal(animalId) {
            const animal = HUNTABLE_ANIMALS.find(a => a.id === animalId);
            if (!animal) {
                console.error('huntAnimal: Animal not found:', animalId);
                notifyError('Chyba', 'Zv√≠≈ôe nebylo nalezeno.');
                return;
            }
            
            // Spot≈ôeba ≈°√≠p≈Ø/≈°ipek - zkontroluj EQUIPPED weapon
            const equippedWeapon = state.equipped?.weapon;
            const huntingWeapon = equippedWeapon && (
                equippedWeapon.id === 'hunting_bow' || equippedWeapon.id === 'crossbow' || 
                equippedWeapon.id === 'wooden_bow' || equippedWeapon.id === 'bow' ||
                equippedWeapon.ammoType === 'arrow' || equippedWeapon.ammoType === 'bolt'
            ) ? equippedWeapon : state.inv.find(i => 
                i.id === 'hunting_bow' || i.id === 'crossbow' || i.id === 'wooden_bow' || i.id === 'bow' ||
                (i.type === 'weapon' && i.icon === 'üèπ')
            );
            
            if (huntingWeapon?.ammoType) {
                if (!consumeAmmo(huntingWeapon.ammoType, 1)) {
                    showModal('‚ùå Chyb√≠ munice', `Nem√°≈° ${getAmmoName(huntingWeapon.ammoType)}!<br><button class="btn" onclick="closeModal()" style="width:100%; margin-top:1rem;">OK</button>`);
                    return;
                }
            }
            
            const skillBonus = (state.skills_secondary?.hunting || 0) * 5;
            const hitChance = 0.6 + (state.char.attrs.per * 0.02) + (skillBonus * 0.01);
            
            if (Math.random() < hitChance) {
                // √öspƒõ≈°n√Ω z√°sah
                state.skills_secondary.hunting = Math.min(10, (state.skills_secondary.hunting || 0) + 0.15);
                
                // Loot - sn√≠≈æeno o 30%
                let lootDisplay = [];
                Object.entries(animal.loot).forEach(([item, baseAmount]) => {
                    const amount = Math.max(1, Math.floor(baseAmount * 0.7)); // -30%, min 1
                    if (item === 'meat') {
                        state.resources.raw_meat = (state.resources.raw_meat || 0) + amount;
                        markFoodAsNew('raw_meat', amount);
                        lootDisplay.push({ item: 'ü•© Syrov√© maso', amount });
                    } else if (item === 'cloth') {
                        state.resources.cloth = (state.resources.cloth || 0) + amount;
                        lootDisplay.push({ item: 'üßµ L√°tka', amount });
                    } else if (item === 'leather') {
                        state.resources.leather = (state.resources.leather || 0) + amount;
                        lootDisplay.push({ item: 'ü¶¥ K≈Ø≈æe', amount });
                    } else {
                        // Ostatn√≠ p≈ôedmƒõty (radx, atd.)
                        state.resources[item] = (state.resources[item] || 0) + amount;
                        const icons = { radx: 'üíä', radaway: '‚ò¢Ô∏è' };
                        lootDisplay.push({ item: (icons[item] || 'üì¶') + ' ' + item, amount });
                    }
                });
                
                addXP(animal.xp);
                
                if (animal.radiation) {
                    state.status.radiation = Math.min(100, state.status.radiation + animal.radiation);
                }
                
                showModal('üèπ √öspƒõ≈°n√Ω lov!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üéØ</div>
                        <h3>Ulovil jsi ${animal.name}!</h3>
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            ${lootDisplay.map(l => `<p style="color: #8bc34a; margin: 0.3rem 0;">+${l.amount} ${l.item}</p>`).join('')}
                        </div>
                        <p style="color: #ffd700;">+${animal.xp} XP</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showActionModal('hunt');" style="width: 100%; margin-top: 0.5rem;">üèπ Lovit znovu</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                `);
            } else {
                // Minut√≠
                if (animal.aggressive) {
                    // Zv√≠≈ôe √∫toƒç√≠!
                    closeModal();
                    startCombat({ 
                        id: 'hunt_' + animal.id, 
                        name: animal.name, 
                        icon: animal.icon, 
                        hp: animal.hp, 
                        damage: Math.floor(animal.hp / 5), 
                        defense: 2, 
                        xp: animal.xp,
                        loot: animal.loot
                    });
                } else {
                    showModal('üèπ Minul!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">üí®</div>
                            <p>${animal.name} utekl!</p>
                        </div>
                        <button class="btn" onclick="closeModal(); showActionModal('hunt');" style="width: 100%; margin-top: 0.5rem;">üèπ Zkusit znovu</button>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Hotovo'}</button>
                    `);
                }
            }
        }
        
        // === VA≈òEN√ç A ALCHYMIE ===
        function openCookingMenu() {
            if (!state.inv.find(i => i.id === 'cooking_pot')) {
                showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° üç≥ Hrnec pro va≈ôen√≠!');
                return;
            }
            
            const cookingRecipes = RECIPES.filter(r => r.type === 'cooking');
            
            showModal('üç≥ Va≈ôen√≠', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${cookingRecipes.map(recipe => {
                        const canCraft = Object.entries(recipe.requires).every(([res, amt]) => 
                            (state.resources[res] || 0) >= amt || state.inv.some(i => i.id === res && (i.count || 1) >= amt)
                        );
                        return `
                            <div style="background: #2a2a2a; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 8px; ${!canCraft ? 'opacity: 0.5;' : ''}">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 2rem;">${recipe.icon}</span>
                                    <div style="flex: 1;">
                                        <strong>${recipe.name}</strong>
                                        <p style="font-size: 0.8rem; color: #999;">${recipe.desc}</p>
                                        <p style="font-size: 0.75rem; color: #ff9800;">
                                            Pot≈ôeba: ${Object.entries(recipe.requires).map(([r, a]) => `${a}x ${r}`).join(', ')}
                                        </p>
                                    </div>
                                    <button class="btn" onclick="cook('${recipe.id}')" ${!canCraft ? 'disabled' : ''} style="padding: 0.4rem 0.8rem;">Va≈ôit</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function openAlchemyMenu() {
            if (!state.inv.find(i => i.id === 'alchemy_set')) {
                showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° ‚öóÔ∏è Alchymistickou sadu!');
                return;
            }
            
            const alchemyRecipes = RECIPES.filter(r => r.type === 'alchemy');
            
            showModal('‚öóÔ∏è Alchymie', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${alchemyRecipes.map(recipe => {
                        const canCraft = Object.entries(recipe.requires).every(([res, amt]) => 
                            (state.resources[res] || 0) >= amt || state.inv.some(i => i.id === res && (i.count || 1) >= amt)
                        );
                        return `
                            <div style="background: #2a2a2a; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 8px; ${!canCraft ? 'opacity: 0.5;' : ''}">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 2rem;">${recipe.icon}</span>
                                    <div style="flex: 1;">
                                        <strong>${recipe.name}</strong>
                                        <p style="font-size: 0.8rem; color: #999;">${recipe.desc}</p>
                                        <p style="font-size: 0.75rem; color: #ff9800;">
                                            Pot≈ôeba: ${Object.entries(recipe.requires).map(([r, a]) => `${a}x ${r}`).join(', ')}
                                        </p>
                                    </div>
                                    <button class="btn" onclick="brew('${recipe.id}')" ${!canCraft ? 'disabled' : ''} style="padding: 0.4rem 0.8rem;">M√≠chat</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function cook(recipeId) {
            const recipe = RECIPES.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Spot≈ôebuj ingredience
            Object.entries(recipe.requires).forEach(([res, amt]) => {
                if (state.resources[res] >= amt) {
                    state.resources[res] -= amt;
                    // Pokud do≈°lo j√≠dlo kter√© se kaz√≠, sma≈æ timestamp
                    if (state.resources[res] === 0 && state.foodTimestamps?.[res]) {
                        delete state.foodTimestamps[res];
                    }
                } else {
                    const item = state.inv.find(i => i.id === res);
                    if (item) {
                        if (item.count > amt) item.count -= amt;
                        else state.inv = state.inv.filter(i => i.id !== res);
                    }
                }
            });
            
            // Vytvo≈ô j√≠dlo
            const food = {
                id: recipe.id,
                name: recipe.name,
                icon: recipe.icon,
                type: 'consumable',
                effect: recipe.result.effect,
                value: recipe.result.value,
                count: 1
            };
            
            const existing = state.inv.find(i => i.id === recipe.id);
            if (existing) existing.count = (existing.count || 1) + 1;
            else state.inv.push(food);
            
            state.skills_secondary.cooking = Math.min(10, (state.skills_secondary.cooking || 0) + 0.1);
            
            // Daily quest progress - cooked
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.cooked = (state.dailyQuests.progress.cooked || 0) + 1;
            }
            checkDailyQuests();
            
            addLog('Uva≈ôil jsi ' + recipe.name, recipe.icon);
            openCookingMenu();
        }
        
        function brew(recipeId) {
            const recipe = RECIPES.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Spot≈ôebuj ingredience
            Object.entries(recipe.requires).forEach(([res, amt]) => {
                if (state.resources[res] >= amt) {
                    state.resources[res] -= amt;
                    // Pokud do≈°lo j√≠dlo kter√© se kaz√≠, sma≈æ timestamp
                    if (state.resources[res] === 0 && state.foodTimestamps?.[res]) {
                        delete state.foodTimestamps[res];
                    }
                } else {
                    const item = state.inv.find(i => i.id === res);
                    if (item) {
                        if (item.count > amt) item.count -= amt;
                        else state.inv = state.inv.filter(i => i.id !== res);
                    }
                }
            });
            
            // Vytvo≈ô lektvar
            const potion = {
                id: recipe.id,
                name: recipe.name,
                icon: recipe.icon,
                type: 'consumable',
                effect: recipe.result.effect,
                value: recipe.result.value,
                buff: recipe.result.buff,
                duration: recipe.result.duration,
                count: 1
            };
            
            const existing = state.inv.find(i => i.id === recipe.id);
            if (existing) existing.count = (existing.count || 1) + 1;
            else state.inv.push(potion);
            
            state.skills_secondary.alchemy = Math.min(10, (state.skills_secondary.alchemy || 0) + 0.15);
            
            addLog('Nam√≠chal jsi ' + recipe.name, recipe.icon);
            openAlchemyMenu();
        }
        
        // === MUTACE ===
        function checkForMutation() {
            if (state.status.radiation < 50) return;
            
            // Imunita proti mutac√≠m (z Buƒçovic)
            if (state.mutationImmunity === 'permanent') return;
            
            // ≈†ance na mutaci p≈ôi vysok√© radiaci (0.05% - 2.5% za check) - ZPOMALENO
            const chance = (state.status.radiation - 50) * 0.0005;
            if (Math.random() > chance) return;
            
            // üß¨ Exotic bonus - Mutant√≠ ≈æl√°za (blokuje mutaci)
            if (state.exoticBonuses?.mutationResist > 0) {
                state.exoticBonuses.mutationResist--;
                notifySuccess('üß¨ Mutace zablokov√°na!', 'Mutant√≠ ≈æl√°za tƒõ ochr√°nila!');
                return;
            }
            
            // Vyber n√°hodnou mutaci kterou je≈°tƒõ nem√°m
            const availableMutations = MUTATIONS.filter(m => !state.mutations?.includes(m.id));
            if (availableMutations.length === 0) return;
            
            const mutation = availableMutations[Math.floor(Math.random() * availableMutations.length)];
            
            state.mutations = state.mutations || [];
            state.mutations.push(mutation.id);
            
            // Aplikuj efekty
            if (mutation.effect.maxHp) state.char.maxHp += mutation.effect.maxHp;
            if (mutation.effect.defense) state.char.baseDefense = (state.char.baseDefense || 0) + mutation.effect.defense;
            if (mutation.effect.perception) state.char.attrs.per += mutation.effect.perception;
            if (mutation.effect.str) state.char.attrs.str += mutation.effect.str;
            if (mutation.effect.agi) state.char.attrs.agi += mutation.effect.agi;
            if (mutation.effect.int) state.char.attrs.int += mutation.effect.int;
            
            // Zvuky a notifikace
            SoundSystem.play('mutation');
            
            const humor = getRandomHumor('mutation');
            
            showModal('‚ò¢Ô∏è MUTACE!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${mutation.icon}</div>
                    <h3 style="color: #ff9800; margin-bottom: 0.5rem;">${mutation.name}</h3>
                    <p style="color: #666; font-style: italic; font-size: 0.8rem; margin-bottom: 1rem;">"${humor}"</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #4caf50;">
                        <p style="margin: 0; color: #8bc34a;">‚úì ${mutation.positive}</p>
                    </div>
                    
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #f44336;">
                        <p style="margin: 0; color: #ef5350;">‚úó ${mutation.negative}</p>
                    </div>
                    
                    <p style="color: #888; font-size: 0.85rem;">${mutation.desc}</p>
                    <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">Mutace: ${state.mutations.length}/5</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">üß¨ P≈ôijmout osud...</button>
            `);
            
            addLog('‚ò¢Ô∏è Z√≠skal jsi mutaci: ' + mutation.name, '‚ò¢Ô∏è');
            notifyWarning('Mutace!', mutation.name);
            
            // P≈ôi 5 mutac√≠ch AUTOMATICK√Å transformace na mutanta
            if (state.mutations.length >= 5 && state.char.classId !== 'mutant') {
                setTimeout(() => {
                    autoTransformToMutant();
                }, 1500);
            }
        }
        
        // Automatick√° transformace na mutanta p≈ôi 5 mutac√≠ch
        function autoTransformToMutant() {
            // Sundej brnƒõn√≠ a helmu
            if (state.equipped?.armor) {
                addItemToInventory(state.equipped.armor, 1);
                addLog('Sund√°no: ' + state.equipped.armor.name + ' (p≈ô√≠li≈° velk√Ω)', 'üö´');
                state.equipped.armor = null;
            }
            if (state.equipped?.helmet) {
                addItemToInventory(state.equipped.helmet, 1);
                addLog('Sund√°no: ' + state.equipped.helmet.name, 'üö´');
                state.equipped.helmet = null;
            }
            
            // Zmƒõ≈à t≈ô√≠du
            const oldClass = state.char.class;
            state.char.class = 'mutant';
            state.char.classId = 'mutant';
            
            // Bonusy mutanta
            state.char.str = (state.char.str || 5) + 3;
            state.char.end = (state.char.end || 5) + 3;
            state.char.maxHp += 30;
            state.char.hp = Math.min(state.char.hp + 30, state.char.maxHp);
            
            saveGame();
            renderFull();
            
            // Zobraz ozn√°men√≠
            showModal('ü¶é TRANSFORMACE DOKONƒåENA!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; animation: pulse 1s infinite;">ü¶é</div>
                    <h2 style="color: #76ff03; margin: 0.5rem 0; text-shadow: 0 0 20px #76ff03;">Stal ses MUTANTEM!</h2>
                    <p style="color: #888;">Tv√© tƒõlo pro≈°lo kompletn√≠ transformac√≠ po nashrom√°≈ædƒõn√≠ 5 mutac√≠.</p>
                    <p style="color: #666; font-size: 0.85rem;">Byl jsi: ${oldClass}</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #76ff03;">
                    <h4 style="color: #76ff03; margin: 0 0 0.5rem 0;">‚úÖ Nov√© schopnosti:</h4>
                    <div style="font-size: 0.85rem; color: #aaa; line-height: 1.6;">
                        ü¶é Dr√°py +20 DMG (z√°lo≈æn√≠ zbra≈à)<br>
                        üõ°Ô∏è Mutant√≠ k≈Ø≈æe +10 DEF<br>
                        ‚ò¢Ô∏è -50% radiace<br>
                        ‚öîÔ∏è +20% damage v rad z√≥n√°ch<br>
                        ‚ù§Ô∏è +2 HP p≈ôi ka≈æd√©m z√°sahu<br>
                        üí™ +3 STR, +3 END, +30 HP
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c62828;">
                    <div style="font-size: 0.85rem; color: #ff9800;">
                        ‚ö†Ô∏è U≈æ nem≈Ø≈æe≈° nosit brnƒõn√≠ ani helmy<br>
                        ‚ö†Ô∏è Transformace je TRVAL√Å!
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #76ff03; color: #000; font-weight: bold;">
                    ü¶é P≈ôijmout sv≈Øj nov√Ω osud
                </button>
            `);
            
            addLog('ü¶é TRANSFORMACE: Stal ses plnohodnotn√Ωm mutantem!', 'ü¶é');
        }
        
        // Nab√≠dka transformace na mutanta (zachov√°no pro kompatibilitu)
        function showMutantTransformOffer() {
            autoTransformToMutant();
        }
        
        // Transformace na mutanta (zachov√°no pro kompatibilitu)
        function becomeMutant() {
            autoTransformToMutant();
        }
        
        // === STASH/SKR√ù≈†E ===
        function openStashMenu() {
            // Pou≈æij ID aktu√°ln√≠ lokace jako kl√≠ƒç pro stash
            const key = state.world.currentLocation || 'shelter';
            const locationName = getCurrentLocation()?.name || 'Nezn√°m√° lokace';
            const stash = state.stashes?.[key] || [];
            
            const cacheTexts = {
                desc: 'M≈Ø≈æe≈° zde schovat p≈ôedmƒõty. ‚ö†Ô∏è Ka≈æd√° lokace m√° vlastn√≠ skr√Ω≈°!',
                inCache: 'Ve skr√Ω≈°i', empty: 'Pr√°zdn√°', yourInv: 'Tv≈Øj invent√°≈ô',
                emptyInv: 'Pr√°zdn√Ω', part: 'ƒå√°st', all: 'V≈°e'
            };
            
            showModal('üì¶ Skr√Ω≈°: ' + locationName, `
                <p style="color: #999; margin-bottom: 0.5rem;">${cacheTexts.desc}</p>
                <p style="color: #666; font-size: 0.75rem; margin-bottom: 1rem;">üìç Aktu√°ln√≠ lokace: ${locationName}</p>
                
                <h4>${cacheTexts.inCache} (${stash.length}):</h4>
                <div style="background: #2a2a2a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${stash.length > 0 ? stash.map((item, i) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem; gap: 0.3rem;">
                            <span style="flex: 1;">${item.icon || 'üì¶'} ${item.name || getItemName(item.id)} ${item.count > 1 ? `(${item.count}x)` : ''}</span>
                            ${item.count > 1 ? `<button class="btn" onclick="showStashQuantity('take', ${i}, ${item.count})" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; background: #666;">${cacheTexts.part}</button>` : ''}
                            <button class="btn" onclick="takeFromStash(${i}, ${item.count || 1})" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">${cacheTexts.all}</button>
                        </div>
                    `).join('') : '<p style="color: #666; text-align: center;">' + cacheTexts.empty + '</p>'}
                </div>
                
                <h4>${cacheTexts.yourInv}:</h4>
                <div style="background: #2a2a2a; padding: 0.5rem; border-radius: 8px; max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${state.inv.length > 0 ? state.inv.map((item, i) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem; gap: 0.3rem;">
                            <span style="flex: 1;">${item.icon || 'üì¶'} ${item.name || getItemName(item.id)} ${item.count > 1 ? `(${item.count}x)` : ''}</span>
                            ${item.count > 1 ? `<button class="btn" onclick="showStashQuantity('put', ${i}, ${item.count})" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; background: #666;">${cacheTexts.part}</button>` : ''}
                            <button class="btn" onclick="putInStash(${i}, ${item.count || 1})" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">${cacheTexts.all}</button>
                        </div>
                    `).join('') : '<p style="color: #666; text-align: center;">' + cacheTexts.emptyInv + '</p>'}
                </div>
                
                <button class="btn" onclick="showAllStashes()" style="width: 100%; margin-top: 0.5rem; background: #333; font-size: 0.8rem;">üîç Zobrazit v≈°echny skr√Ω≈°e</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function showAllStashes() {
            const stashes = state.stashes || {};
            const keys = Object.keys(stashes);
            
            if (keys.length === 0) {
                showModal('üì¶ V≈°echny skr√Ω≈°e', '<p style="color: #888; text-align: center;">Nem√°≈° ≈æ√°dn√© vƒõci ve skr√Ω≈°√≠ch.</p><button class="btn" onclick="openStashMenu()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>');
                return;
            }
            
            const currentLoc = state.world.currentLocation || 'shelter';
            
            let html = '<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            keys.forEach(key => {
                const items = stashes[key];
                if (items && items.length > 0) {
                    // Zkus naj√≠t lokaci podle kl√≠ƒçe
                    const locDef = WORLD_LOCATIONS?.find(l => l.id === key);
                    const locName = locDef?.name || key;
                    
                    // Kontrola jestli je hr√°ƒç na t√©to lokaci
                    const isCurrentLoc = key === currentLoc;
                    
                    const totalWeight = items.reduce((sum, item) => {
                        const itemDef = ITEMS.find(i => i.id === item.id);
                        return sum + ((item.weight || itemDef?.weight || 0) * (item.count || 1));
                    }, 0);
                    
                    html += `<div style="background: ${isCurrentLoc ? '#1a2a1a' : '#1a1a1a'}; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid ${isCurrentLoc ? '#4a7a4a' : '#333'};">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">`;
                    html += `<h4 style="margin: 0; color: ${isCurrentLoc ? '#8bc34a' : '#ff9800'};">üìç ${locName} ${isCurrentLoc ? '(jsi zde)' : ''}</h4>`;
                    html += `<span style="color: #666; font-size: 0.75rem;">‚öñÔ∏è ${totalWeight.toFixed(1)}kg</span>`;
                    html += `</div>`;
                    
                    items.forEach((item, idx) => {
                        const itemDef = ITEMS.find(i => i.id === item.id);
                        const weight = item.weight || itemDef?.weight || 0;
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; color: #ccc; font-size: 0.85rem; padding: 0.3rem 0; border-bottom: 1px solid #222;">`;
                        html += `<span style="flex: 1;">${item.icon || 'üì¶'} ${item.name || item.id} ${item.count > 1 ? '(' + item.count + 'x)' : ''}</span>`;
                        html += `<span style="color: #555; font-size: 0.7rem; margin-right: 0.5rem;">${(weight * (item.count || 1)).toFixed(1)}kg</span>`;
                        if (isCurrentLoc) {
                            html += `<button class="btn" onclick="takeFromStashByKey('${key}', ${idx})" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #4CAF50;">Vz√≠t</button>`;
                        }
                        html += `</div>`;
                    });
                    
                    if (!isCurrentLoc) {
                        html += `<div style="text-align: center; margin-top: 0.5rem; padding: 0.4rem; background: #2a2a2a; border-radius: 4px; color: #888; font-size: 0.75rem;">üö∂ Mus√≠≈° tam doj√≠t pro vyzvednut√≠</div>`;
                    }
                    
                    html += '</div>';
                }
            });
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>';
            
            showModal('üì¶ V≈°echny skr√Ω≈°e', html);
        }
        
        // Vyzvednut√≠ vƒõci ze skr√Ω≈°e podle kl√≠ƒçe (pro showAllStashes)
        function takeFromStashByKey(stashKey, itemIndex) {
            // Kontrola lokace
            const currentLoc = state.world.currentLocation || 'shelter';
            const isAtLocation = stashKey === currentLoc || (stashKey === 'shelter' && (!currentLoc || currentLoc === 'shelter'));
            
            if (!isAtLocation) {
                notifyWarning('üìç ≈†patn√° lokace', 'Mus√≠≈° b√Ωt na m√≠stƒõ kde m√°≈° skr√Ω≈°!');
                return;
            }
            
            if (!state.stashes?.[stashKey]?.[itemIndex]) {
                notifyWarning('Chyba', 'Polo≈æka nenalezena');
                return;
            }
            
            const item = state.stashes[stashKey][itemIndex];
            const count = item.count || 1;
            
            // Kontrola v√°hy - z√≠skej v√°hu z ITEMS definice pokud item nem√° weight
            const itemDef = ITEMS.find(i => i.id === item.id);
            const itemWeight = (item.weight || itemDef?.weight || 0) * count;
            const currentWeight = calculateCurrentWeight();
            const maxWeight = calculateMaxWeight();
            
            if (currentWeight + itemWeight > maxWeight) {
                notifyWarning('‚ùå Pln√Ω invent√°≈ô', `Neunese≈° to! (${currentWeight.toFixed(1)}/${maxWeight}kg)`);
                return;
            }
            
            // P≈ôidej weight do itemu pokud chyb√≠
            if (!item.weight && itemDef?.weight) {
                item.weight = itemDef.weight;
            }
            
            // Najdi existuj√≠c√≠ stack v invent√°≈ôi
            const existingInv = state.inv.find(i => i.id === item.id);
            
            if (existingInv) {
                existingInv.count = (existingInv.count || 1) + count;
            } else {
                state.inv.push({...item, count: count});
            }
            
            // Odeber ze skr√Ω≈°e
            state.stashes[stashKey].splice(itemIndex, 1);
            
            // Vyƒçisti pr√°zdn√© skr√Ω≈°e
            if (state.stashes[stashKey].length === 0) {
                delete state.stashes[stashKey];
            }
            
            updateCarryWeight();
            notifySuccess('üì¶ Vzato', `${item.name || item.id} ${count > 1 ? '(' + count + 'x)' : ''}`);
            
            // Obnov seznam skr√Ω≈°√≠
            showAllStashes();
        }
        
        function showStashQuantity(action, index, maxCount) {
            const key = state.world.currentLocation || 'shelter';
            const item = action === 'take' ? state.stashes[key][index] : state.inv[index];
            
            showModal('üì¶ Kolik kus≈Ø?', `
                <div style="text-align: center;">
                    <p>${item.icon || 'üì¶'} ${item.name || getItemName(item.id)}</p>
                    <p style="color: #888;">${'Dostupn√©'}: ${maxCount}x</p>
                    
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 1rem 0;">
                        <button class="btn" onclick="adjustStashQty(-10)" style="padding: 0.3rem 0.6rem;">-10</button>
                        <button class="btn" onclick="adjustStashQty(-1)" style="padding: 0.3rem 0.6rem;">-1</button>
                        <input type="number" id="stashQtyInput" value="1" min="1" max="${maxCount}" style="width: 60px; text-align: center; padding: 0.3rem; background: #1a1a1a; border: 1px solid #555; color: #fff; border-radius: 4px;">
                        <button class="btn" onclick="adjustStashQty(1)" style="padding: 0.3rem 0.6rem;">+1</button>
                        <button class="btn" onclick="adjustStashQty(10)" style="padding: 0.3rem 0.6rem;">+10</button>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="document.getElementById('stashQtyInput').value = ${maxCount}" style="flex: 1; background: #666;">Max</button>
                        <button class="btn" onclick="${action}FromStash(${index}, parseInt(document.getElementById('stashQtyInput').value))" style="flex: 2; background: var(--rust);">
                            ${action === 'take' ? ('Vz√≠t') : ('Schovat')}
                        </button>
                    </div>
                    
                    <button class="btn" onclick="openStashMenu()" style="width: 100%; margin-top: 0.5rem; background: #333;">‚Üê ${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function adjustStashQty(delta) {
            const input = document.getElementById('stashQtyInput');
            const max = parseInt(input.max);
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            if (val > max) val = max;
            input.value = val;
        }
        
        function putFromStash(itemIndex, amount) {
            // Alias pro kompatibilitu s showStashQuantity
            putInStash(itemIndex, amount);
        }
        
        function putInStash(itemIndex, amount = null) {
            const key = state.world.currentLocation || 'shelter';
            state.stashes = state.stashes || {};
            state.stashes[key] = state.stashes[key] || [];
            
            const item = state.inv[itemIndex];
            if (!item) return;
            
            const count = item.count || 1;
            const toMove = amount ? Math.min(amount, count) : count;
            
            // Najdi existuj√≠c√≠ stack ve skr√Ω≈°i - porovnej podle id a typu (a ammoType pro munici)
            const existingStash = state.stashes[key].find(i => 
                i.id === item.id && 
                i.type === item.type &&
                (item.type !== 'ammo' || i.ammoType === item.ammoType) &&
                !item.durability && !i.durability // Nestackuj po≈°koditeln√© vƒõci
            );
            
            if (existingStash && (item.stackable || item.type === 'ammo' || item.type === 'consumable' || item.type === 'material' || item.type === 'resource')) {
                existingStash.count = (existingStash.count || 1) + toMove;
            } else {
                state.stashes[key].push({...item, count: toMove});
            }
            
            // Odeber z invent√°≈ôe
            if (toMove >= count) {
                state.inv.splice(itemIndex, 1);
            } else {
                item.count = count - toMove;
            }
            
            updateCarryWeight();
            addLog('Schoval jsi ' + item.name + (toMove > 1 ? ` (${toMove}x)` : '') + ' do skr√Ω≈°e', 'üì¶');
            openStashMenu();
        }
        
        function takeFromStash(itemIndex, amount = null) {
            const key = state.world.currentLocation || 'shelter';
            if (!state.stashes?.[key]?.[itemIndex]) return;
            
            const item = state.stashes[key][itemIndex];
            const count = item.count || 1;
            const toMove = amount ? Math.min(amount, count) : count;
            
            // Kontrola v√°hy - z√≠skej v√°hu z ITEMS definice pokud item nem√° weight
            const itemDef = ITEMS.find(i => i.id === item.id);
            const itemWeight = (item.weight || itemDef?.weight || 0) * toMove;
            const currentWeight = calculateCurrentWeight();
            const maxWeight = calculateMaxWeight();
            
            if (currentWeight + itemWeight > maxWeight) {
                showModal('‚ùå Pln√Ω invent√°≈ô', `Nem√°≈° m√≠sto v invent√°≈ôi! (${currentWeight.toFixed(1)}/${maxWeight}kg, item v√°≈æ√≠ ${itemWeight.toFixed(1)}kg)`);
                return;
            }
            
            // P≈ôidej weight do itemu pokud chyb√≠
            if (!item.weight && itemDef?.weight) {
                item.weight = itemDef.weight;
            }
            
            // Najdi existuj√≠c√≠ stack v invent√°≈ôi - porovnej podle id a typu (a ammoType pro munici)
            const existingInv = state.inv.find(i => 
                i.id === item.id && 
                i.type === item.type &&
                (item.type !== 'ammo' || i.ammoType === item.ammoType) &&
                !item.durability && !i.durability // Nestackuj po≈°koditeln√© vƒõci
            );
            
            if (existingInv && (item.stackable || item.type === 'ammo' || item.type === 'consumable' || item.type === 'material' || item.type === 'resource')) {
                existingInv.count = (existingInv.count || 1) + toMove;
            } else {
                state.inv.push({...item, count: toMove});
            }
            
            // Odeber ze skr√Ω≈°e
            if (toMove >= count) {
                state.stashes[key].splice(itemIndex, 1);
            } else {
                item.count = count - toMove;
            }
            
            updateCarryWeight();
            addLog('Vzal jsi ' + item.name + (toMove > 1 ? ` (${toMove}x)` : '') + ' ze skr√Ω≈°e', 'üì¶');
            openStashMenu();
        }
        
        // === SPOJEN√ç STACK≈Æ V INVENT√Å≈òI ===
        function mergeInventoryStacks() {
            const merged = {};
            const nonStackable = [];
            let mergedCount = 0;
            
            state.inv.forEach(item => {
                // Vƒõci s durability nebo unique se nestackuj√≠
                if (item.durability !== undefined || item.unique || item._uniqueId) {
                    nonStackable.push(item);
                    return;
                }
                
                // Stackovateln√© typy
                const stackableTypes = ['ammo', 'consumable', 'material', 'resource'];
                if (!stackableTypes.includes(item.type) && !item.stackable) {
                    nonStackable.push(item);
                    return;
                }
                
                // Vytvo≈ô unik√°tn√≠ kl√≠ƒç pro stack
                const key = item.type === 'ammo' 
                    ? `${item.id}_${item.ammoType}` 
                    : item.id;
                
                if (merged[key]) {
                    merged[key].count = (merged[key].count || 1) + (item.count || 1);
                    mergedCount++;
                } else {
                    merged[key] = {...item, count: item.count || 1};
                }
            });
            
            // Sestav nov√Ω invent√°≈ô
            state.inv = [...Object.values(merged), ...nonStackable];
            
            updateCarryWeight();
            
            if (mergedCount > 0) {
                notifySuccess('Invent√°≈ô optimalizov√°n!', `Spojeno ${mergedCount} stack≈Ø`);
                addLog(`üì¶ Spojeno ${mergedCount} rozdƒõlen√Ωch stack≈Ø`, '‚úÖ');
            } else {
                notifyWarning('Nic ke spojen√≠', 'V≈°echny stacky jsou ji≈æ spojen√©');
            }
            
            renderFull();
        }
        
        // === DEN/NOC F√ÅZE ===
        function getCurrentDayPhase() {
            const hour = state.time.hours;
            return DAY_PHASES.find(p => p.hours.includes(hour)) || DAY_PHASES[1];
        }
        
        // === MUTANT INFO ===
        function showMutantInfo() {
            const isMutant = state.char.class === 'mutant';
            const mutations = state.mutations || [];
            const mutationCount = mutations.length;
            
            const mutTexts = {
                progress: 'Progres k transformaci', mutations: 'mutac√≠',
                transform: 'TRANSFORMOVAT SE V MUTANTA!', yourActiveMutations: 'Tv√© aktivn√≠ mutace',
                noMutations: 'Zat√≠m nem√°≈° ≈æ√°dn√© mutace', getMutations: 'Mutace z√≠sk√°v√°≈° p≈ôi radiaci nad 50%',
                allMutations: 'V≈°echny mutace (klikni pro detail)', whatYouGet: 'Co z√≠sk√°≈° jako mutant', yourBonuses: 'Tv√© mutant√≠ bonusy',
                drawbacks: 'Nev√Ωhody mutanta', yourLimitations: 'Tv√° omezen√≠',
                cantWearArmor: 'Nem≈Ø≈æe≈° nosit brnƒõn√≠', cantWearHelmets: 'Nem≈Ø≈æe≈° nosit helmy',
                loseClass: 'Ztrat√≠≈° p≈Øvodn√≠ t≈ô√≠du', irreversible: 'Transformace je NEVRATN√Å!',
                youAreMutant: 'JSI MUTANT!', readyToTransform: 'P≈òIPRAVEN K TRANSFORMACI!', mutationsTitle: 'MUTACE & MUTANT'
            };
            
            // Z√≠skej detaily mutac√≠ hr√°ƒçe
            const playerMutations = mutations.map(mId => MUTATIONS.find(m => m.id === mId)).filter(m => m);
            
            // Progress bar
            const progressPercent = (mutationCount / 5) * 100;
            const progressBar = !isMutant ? `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span style="color: #888; font-size: 0.85rem;">${mutTexts.progress}</span>
                        <span style="color: ${mutationCount >= 5 ? '#76ff03' : '#ff9800'}; font-size: 0.85rem; font-weight: bold;">${mutationCount}/5 ${mutTexts.mutations}</span>
                    </div>
                    <div style="background: #333; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #ff9800, ${mutationCount >= 5 ? '#76ff03' : '#ffb74d'}); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                    </div>
                </div>
            ` : '';
            
            // Tlaƒç√≠tko transformace
            const transformButton = (!isMutant && mutationCount >= 5) ? `
                <button class="btn" onclick="closeModal(); showMutantTransformOffer();" style="width: 100%; margin-bottom: 1rem; background: linear-gradient(135deg, #76ff03, #4caf50); color: #000; font-weight: bold; font-size: 1rem; padding: 0.8rem;">
                    ü¶é ${mutTexts.transform}
                </button>
            ` : '';
            
            // Hr√°ƒçovy mutace
            const playerMutationsHtml = playerMutations.length > 0 ? `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 0.9rem;">‚ò¢Ô∏è ${mutTexts.yourActiveMutations} (${playerMutations.length}):</h4>
                    <div style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${playerMutations.map(m => `
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem; border-bottom: 1px solid #333;">
                                <span style="font-size: 1.2rem;">${m.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.85rem; color: #fff;">${m.name}</div>
                                    <div style="font-size: 0.7rem; color: #8bc34a;">‚úì ${m.positive}</div>
                                    <div style="font-size: 0.7rem; color: #ef5350;">‚úó ${m.negative}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.3rem;">üß¨</div>
                    <p style="color: #666; margin: 0;">${mutTexts.noMutations}</p>
                    <p style="color: #888; font-size: 0.75rem; margin: 0.3rem 0 0 0;">${mutTexts.getMutations}</p>
                </div>
            `;
            
            // V≈°echny dostupn√© mutace
            const allMutationsHtml = `
                <details style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: #64b5f6; font-size: 0.9rem; padding: 0.5rem; background: #1a1a2a; border-radius: 8px;">
                        üìñ ${mutTexts.allMutations}
                    </summary>
                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem;">
                            ${MUTATIONS.map(m => {
                                const hasMutation = mutations.includes(m.id);
                                return `
                                    <div onclick="showMutationDetail('${m.id}')" style="cursor: pointer; text-align: center; padding: 0.4rem; background: ${hasMutation ? '#1a2a1a' : '#0a0a0a'}; border-radius: 6px; border: 1px solid ${hasMutation ? '#4caf50' : '#333'};">
                                        <div style="font-size: 1.3rem; ${hasMutation ? '' : 'opacity: 0.4;'}">${m.icon}</div>
                                        <div style="font-size: 0.6rem; color: ${hasMutation ? '#8bc34a' : '#666'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${m.name.split(' ')[0]}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </details>
            `;
            
            // Mutant bonusy
            const mutantBonusesHtml = `
                <details ${isMutant ? 'open' : ''} style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: #76ff03; font-size: 0.9rem; padding: 0.5rem; background: #1a2a1a; border-radius: 8px;">
                        ü¶é ${isMutant ? mutTexts.yourBonuses : mutTexts.whatYouGet}
                    </summary>
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 0 0 8px 8px; border: 1px solid #2a3a2a;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; font-size: 0.8rem;">
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">ü¶é ${'Dr√°py'} <span style="color: #ff4444;">+20 DMG</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">üõ°Ô∏è ${'K≈Ø≈æe'} <span style="color: #76ff03;">+10 DEF</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">‚ò¢Ô∏è ${'Radiace'} <span style="color: #76ff03;">-50%</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">‚öîÔ∏è ${'Rad z√≥ny'} <span style="color: #ff4444;">+20%</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">‚ù§Ô∏è ${'Regen'} <span style="color: #ff4444;">+2 HP/hit</span></div>
                            <div style="padding: 0.3rem; background: #0a1a0a; border-radius: 4px;">üí™ ${'Atributy'} <span style="color: #76ff03;">+3 STR/END</span></div>
                        </div>
                    </div>
                </details>
            `;
            
            // Mutant nev√Ωhody
            const mutantDrawbacksHtml = `
                <details ${isMutant ? 'open' : ''} style="margin-bottom: 1rem;">
                    <summary style="cursor: pointer; color: #c62828; font-size: 0.9rem; padding: 0.5rem; background: #2a1a1a; border-radius: 8px;">
                        ‚ö†Ô∏è ${isMutant ? mutTexts.yourLimitations : mutTexts.drawbacks}
                    </summary>
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 0 0 8px 8px; border: 1px solid #3a2a2a;">
                        <div style="font-size: 0.85rem; color: #ff6666;">
                            <div style="padding: 0.2rem 0;">üö´ ${mutTexts.cantWearArmor}</div>
                            <div style="padding: 0.2rem 0;">üö´ ${mutTexts.cantWearHelmets}</div>
                            ${!isMutant ? '<div style="padding: 0.2rem 0;">‚ö†Ô∏è ' + mutTexts.loseClass + '</div><div style="padding: 0.2rem 0;">‚ö†Ô∏è ' + mutTexts.irreversible + '</div>' : ''}
                        </div>
                    </div>
                </details>
            `;
            
            // Hlaviƒçka
            const headerHtml = isMutant ? `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">ü¶é</div>
                    <h2 style="color: #76ff03; margin: 0.3rem 0; font-size: 1.3rem;">${mutTexts.youAreMutant}</h2>
                </div>
            ` : `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem; ${mutationCount >= 5 ? '' : 'opacity: 0.6;'}">${mutationCount >= 5 ? 'ü¶é' : '‚ò¢Ô∏è'}</div>
                    <h2 style="color: ${mutationCount >= 5 ? '#76ff03' : '#ff9800'}; margin: 0.3rem 0; font-size: 1.2rem;">
                        ${mutationCount >= 5 ? mutTexts.readyToTransform : mutTexts.mutationsTitle}
                    </h2>
                </div>
            `;
            
            showModal('ü¶é Mutace & Mutant', `
                ${headerHtml}
                ${progressBar}
                ${transformButton}
                ${playerMutationsHtml}
                ${allMutationsHtml}
                ${mutantBonusesHtml}
                ${mutantDrawbacksHtml}
                <button class="btn" onclick="closeModal()" style="width: 100%; background: ${isMutant ? '#76ff03' : '#555'}; color: ${isMutant ? '#000' : '#fff'};">${t('ui', 'close')}</button>
            `);
        }
        
        // Detail jednotliv√© mutace
        function showMutationDetail(mutationId) {
            const m = MUTATIONS.find(mut => mut.id === mutationId);
            if (!m) return;
            
            const hasMutation = (state.mutations || []).includes(m.id);
            
            showModal(`${m.icon} ${m.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${m.icon}</div>
                    <div style="color: ${hasMutation ? '#76ff03' : '#888'}; font-size: 0.9rem;">${hasMutation ? '‚úì M√°≈° tuto mutaci' : '‚úó Nem√°≈° tuto mutaci'}</div>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #4caf50;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #8bc34a; font-size: 0.9rem;">‚úì V√Ωhoda</h4>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">${m.positive}</p>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #f44336;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #ef5350; font-size: 0.9rem;">‚úó Nev√Ωhoda</h4>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">${m.negative}</p>
                </div>
                
                <p style="color: #666; font-size: 0.8rem; text-align: center; margin-bottom: 1rem;">${m.desc}</p>
                
                <button class="btn" onclick="showMutantInfo()" style="width: 100%;"<>${'‚Üê Zpƒõt na p≈ôehled'}<</button>
            `);
        }
        
        // === STATUS DETAILY ===
        function showStatusDetails(type) {
            const status = state.status;
            const nomadBonus = hasClassPassive('consumptionReduction') ? 0.5 : 1.0;
            
            // Najdi itemy kter√© mohou doplnit dan√Ω status
            const relevantItems = state.inv.filter(item => {
                if (item.type !== 'consumable') return false;
                if (type === 'hunger') return item.effect === 'hunger';
                if (type === 'thirst') return item.effect === 'thirst';
                if (type === 'energy') return item.effect === 'energy';
                if (type === 'radiation') return item.effect === 'radiation' && item.value < 0;
                return false;
            });
            
            // Z√°kladn√≠ spot≈ôeby
            const baseConsumption = {
                hunger: { base: 0.5, travel: 0.7, name: 'Hlad', icon: 'üçñ', unit: '%/min' },
                thirst: { base: 0.7, travel: 1.0, name: '≈Ω√≠ze≈à', icon: 'üíß', unit: '%/min' },
                energy: { base: 0.3, travel: 1.5, name: 'Energie', icon: '‚ö°', unit: '%/min' },
                mood: { base: 0, travel: 0, name: 'N√°lada', icon: 'üòä', unit: '' },
                radiation: { base: 0, travel: 0.1, name: 'Radiace', icon: '‚ò¢Ô∏è', unit: '/min' }
            };
            
            const statusTexts = {
                critical: 'üíÄ KRITICK√â! Hroz√≠ smrt!', dangerLow: '‚ö†Ô∏è Nebezpeƒçnƒõ n√≠zk√©!',
                refillSoon: '‚ö° Dopl≈à brzy', ok: '‚úì V po≈ô√°dku',
                radLethal: '‚ò†Ô∏è SMRTELN√Å! Um√≠r√°≈°! (-10 HP/min)', radCritical: 'üíÄ KRITICK√â! (-5 HP/min, mutace!)',
                radDanger: '‚ö†Ô∏è Nebezpeƒçn√©! Nekles√° - pot≈ôebuje≈° RadAway!', radMild: '‚ò¢Ô∏è M√≠rn√° radiace (-1%/hod)',
                radSafe: '‚úì Bezpeƒçn√° √∫rove≈à (-2%/hod)',
                timeLeft: 'Vydr≈æ√≠ je≈°tƒõ', currentConsumption: 'Aktu√°ln√≠ spot≈ôeba',
                nomadPassive: 'Nom√°d pasivka', inShelter: 'V √∫krytu', traveling: 'Cestov√°n√≠',
                howToRefill: 'Jak doplnit', howToReduce: 'Jak sn√≠≈æit',
                foodItems: 'J√≠dlo - konzervovan√©, maso, fazole', cooking: 'Va≈ôen√≠ - lep≈°√≠ j√≠dlo z recept≈Ø',
                farmInShelter: 'Farma v √∫krytu - pasivn√≠ j√≠dlo',
                water: 'Voda - l√°hve, d≈æusy', cleanWater: 'ƒåist√° voda - lep≈°√≠ efekt',
                wellInShelter: 'Studna v √∫krytu - pasivn√≠ voda',
                energyDrinks: 'Energetick√© n√°poje', coffee: 'K√°va - rychl√Ω boost',
                sleepingBag: 'Spac√°k - sp√°nek (1 hodina)', restInShelter: 'Odpoƒçinek v √∫krytu',
                radaway: 'RadAway - sni≈æuje radiaci', antidote: 'Antidote lektvar - alchymie',
                hospital: 'Nemocnice - l√©ƒçba radiace', avoidRad: 'Vyh√Ωbej se vodƒõ a radioaktivn√≠m z√≥n√°m',
                dayTime: 'Denn√≠ doba ovliv≈àuje n√°ladu', stayInShelter: 'Pobyt v √∫krytu', completeQuests: 'Dokonƒçov√°n√≠ quest≈Ø',
                inInventory: 'M√°≈° v invent√°≈ôi'
            };
            
            const info = baseConsumption[type];
            const currentValue = Math.round(status[type]);
            
            // V√Ωpoƒçet aktu√°ln√≠ spot≈ôeby
            let currentRate = state.map.traveling ? info.travel : info.base;
            let rateModifiers = [];
            
            if (type === 'hunger' || type === 'thirst') {
                if (nomadBonus < 1) {
                    currentRate *= nomadBonus;
                    rateModifiers.push({ text: statusTexts.nomadPassive, value: '-50%', color: '#8bc34a' });
                }
            }
            
            if (state.map.inBase) {
                currentRate = 0;
                rateModifiers.push({ text: statusTexts.inShelter, value: '0', color: '#4caf50' });
            }
            
            if (state.map.traveling) {
                rateModifiers.push({ text: statusTexts.traveling, value: `+${Math.round((info.travel - info.base) * 100)}%`, color: '#ff9800' });
            }
            
            // V√Ωstraha + humor
            let warningText = '';
            let warningColor = '#8bc34a';
            let humorText = '';
            if (type !== 'radiation' && type !== 'mood') {
                if (currentValue <= 0) {
                    warningText = statusTexts.critical;
                    warningColor = '#c62828';
                    if (type === 'hunger') humorText = getRandomHumor('hunger');
                } else if (currentValue <= 20) {
                    warningText = statusTexts.dangerLow;
                    warningColor = '#ff9800';
                    if (type === 'hunger') humorText = getRandomHumor('hunger');
                } else if (currentValue <= 40) {
                    warningText = statusTexts.refillSoon;
                    warningColor = '#ffd700';
                } else {
                    warningText = statusTexts.ok;
                    warningColor = '#8bc34a';
                }
            } else if (type === 'radiation') {
                if (currentValue >= 100) {
                    warningText = statusTexts.radLethal;
                    warningColor = '#ff0000';
                } else if (currentValue >= 80) {
                    warningText = statusTexts.radCritical;
                    warningColor = '#c62828';
                } else if (currentValue >= 50) {
                    warningText = statusTexts.radDanger;
                    warningColor = '#ff9800';
                } else if (currentValue >= 25) {
                    warningText = statusTexts.radMild;
                    warningColor = '#ffd700';
                } else {
                    warningText = statusTexts.radSafe;
                    warningColor = '#8bc34a';
                }
            }
            
            // ƒåas do vyƒçerp√°n√≠
            let timeToEmpty = '';
            if (currentRate > 0 && currentValue > 0 && type !== 'radiation') {
                const minutesLeft = Math.floor(currentValue / currentRate);
                if (minutesLeft < 60) {
                    timeToEmpty = `${minutesLeft} min`;
                } else {
                    timeToEmpty = `${Math.floor(minutesLeft / 60)}h ${minutesLeft % 60}min`;
                }
            }
            
            showModal(`${info.icon} ${info.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${info.icon}</div>
                    <div style="font-size: 2rem; font-weight: bold; color: ${warningColor};">${currentValue}%</div>
                    <div style="color: ${warningColor}; font-size: 0.9rem;">${warningText}</div>
                    ${humorText ? `<div style="color: #888; font-style: italic; font-size: 0.8rem; margin-top: 0.3rem;">${humorText}</div>` : ''}
                    ${timeToEmpty && type !== 'radiation' ? `<div style="color: #999; font-size: 0.85rem; margin-top: 0.3rem;">‚è±Ô∏è ${statusTexts.timeLeft}: ${timeToEmpty}</div>` : ''}
                </div>
                
                <!-- Progress bar -->
                <div style="background: #1a1a1a; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 1rem;">
                    <div style="height: 100%; width: ${currentValue}%; background: ${type === 'radiation' ? 
                        (currentValue > 50 ? '#c62828' : currentValue > 25 ? '#ff9800' : '#8bc34a') : 
                        (currentValue < 20 ? '#c62828' : currentValue < 40 ? '#ff9800' : '#8bc34a')}; transition: width 0.3s;"></div>
                </div>
                
                <!-- Aktu√°ln√≠ spot≈ôeba -->
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0;">üìä ${statusTexts.currentConsumption}</h4>
                    <p style="margin: 0.3rem 0; font-size: 1.1rem;">
                        <strong>${type === 'radiation' ? '+' : '-'}${currentRate.toFixed(2)}</strong> ${info.unit}
                    </p>
                    ${rateModifiers.length > 0 ? `
                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #3a3a3a;">
                            ${rateModifiers.map(mod => `
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin: 0.2rem 0;">
                                    <span style="color: #999;">${mod.text}</span>
                                    <span style="color: ${mod.color};">${mod.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Jak doplnit -->
                <div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üí° ${type === 'radiation' ? statusTexts.howToReduce : statusTexts.howToRefill}</h4>
                    ${type === 'hunger' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">ü•´ ${statusTexts.foodItems}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üç≥ ${statusTexts.cooking}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üè° ${statusTexts.farmInShelter}</p>
                    ` : type === 'thirst' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üíß ${statusTexts.water}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üíé ${statusTexts.cleanWater}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üö∞ ${statusTexts.wellInShelter}</p>
                    ` : type === 'energy' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üîã ${statusTexts.energyDrinks}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">‚òï ${statusTexts.coffee}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üõèÔ∏è ${statusTexts.sleepingBag}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üè† ${statusTexts.restInShelter}</p>
                    ` : type === 'radiation' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">‚ò¢Ô∏è ${statusTexts.radaway}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">‚öóÔ∏è ${statusTexts.antidote}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üè• ${statusTexts.hospital}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">‚ö†Ô∏è ${statusTexts.avoidRad}</p>
                    ` : type === 'mood' ? `
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üåÖ ${statusTexts.dayTime}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üè† ${statusTexts.stayInShelter}</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;">üéâ ${statusTexts.completeQuests}</p>
                    ` : ''}
                </div>
                
                <!-- Dostupn√© itemy -->
                ${relevantItems.length > 0 ? `
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">üéí ${statusTexts.inInventory}</h4>
                        <div style="max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${relevantItems.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.3rem;">${item.icon}</span>
                                        <div>
                                            <div style="font-weight: bold;">${item.name}</div>
                                            <div style="font-size: 0.8rem; color: #8bc34a;">+${Math.abs(item.value)}${type === 'radiation' ? '' : '%'}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: #999;">${item.count || 1}x</span>
                                        <button class="btn" onclick="closeModal(); confirmUseItem('${item.id}');" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;">${'Pou≈æ√≠t'}</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div style="background: #3a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <p style="color: #ff9800; margin: 0;">‚ö†Ô∏è ${'Nem√°≈° ≈æ√°dn√© polo≈æky pro'} ${type === 'radiation' ? ('sn√≠≈æen√≠') : ('doplnƒõn√≠')}!</p>
                        <p style="color: #999; font-size: 0.85rem; margin: 0.5rem 0 0 0;">${'Najdi je p≈ôi pr≈Øzkumu nebo v obchodƒõ.'}</p>
                    </div>
                `}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">${t('ui', 'close')}</button>
            `);
        }

        // showMutationsInfo odstranƒõno - pou≈æ√≠v√°me showMutantInfo()
        // Star√° showMutationDetail odstranƒõna - m√°me novou v showMutantInfo sekci
        
        // === R√ÅDIO ===
        function useRadio() {
            // Na vys√≠laƒçi funguje r√°dio v≈ædy, jinde pot≈ôebuje≈° m√≠t r√°dio
            const atRadioTower = state.world.currentLocation === 'radio_tower';
            const hasRadio = state.inv.find(i => i.id === 'radio');
            
            const radioTexts = {
                noRadio: 'Nem√°≈° r√°dio!',
                whatRadioDoes: 'Co r√°dio um√≠:',
                radioNews: 'R√°diov√© zpr√°vy', radioNewsDesc: 'tipy, varov√°n√≠, p≈ô√≠bƒõhy',
                treasureCoords: 'Sou≈ôadnice poklad≈Ø', treasureDesc: 'obƒças zachyt√≠≈° polohu pokladu!',
                quests: 'Questy', questsDesc: 'mise od p≈ôe≈æiv≈°√≠ch',
                warnings: 'Varov√°n√≠', warningsDesc: 'info o nebezpeƒçn√Ωch oblastech',
                caravanInfo: 'Info o karavan√°ch', caravanDesc: 'kdy a kde jsou',
                howToGet: 'Jak z√≠skat r√°dio:',
                findExploring: 'Najdi p≈ôi pr≈Øzkumu budov',
                buyFromMerchant: 'Kup od obchodn√≠ka (~200 üí∞)',
                lootFromEnemies: 'Loot z nep≈ô√°tel',
                orGoToTower: 'Nebo jdi na', tower: 'Vys√≠laƒç'
            };
            
            if (!atRadioTower && !hasRadio) {
                showModal('üìª R√°dio', `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem; margin-bottom: 0.5rem;">üìª</div>
                        <div style="color: #ff6666; font-size: 1.1rem;">${radioTexts.noRadio}</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #333;">
                        <h4 style="margin: 0 0 0.8rem 0; color: #64b5f6;">üì° ${radioTexts.whatRadioDoes}</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; line-height: 1.8; color: #ccc;">
                            <li>üìú <strong>${radioTexts.radioNews}</strong> - ${radioTexts.radioNewsDesc}</li>
                            <li>üíé <strong>${radioTexts.treasureCoords}</strong> - ${radioTexts.treasureDesc}</li>
                            <li>üéØ <strong>${radioTexts.quests}</strong> - ${radioTexts.questsDesc}</li>
                            <li>‚ö†Ô∏è <strong>${radioTexts.warnings}</strong> - ${radioTexts.warningsDesc}</li>
                            <li>üê™ <strong>${radioTexts.caravanInfo}</strong> - ${radioTexts.caravanDesc}</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--toxic-dark);">
                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">üí° ${radioTexts.howToGet}</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem; color: #aaa;">
                            <li>üîç ${radioTexts.findExploring}</li>
                            <li>üõí ${radioTexts.buyFromMerchant}</li>
                            <li>üì¶ ${radioTexts.lootFromEnemies}</li>
                            <li>üì° ${radioTexts.orGoToTower} <strong>${radioTexts.tower}</strong>!</li>
                        </ul>
                    </div>
                    
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const message = RADIO_MESSAGES[Math.floor(Math.random() * RADIO_MESSAGES.length)];
            let content = message.message;
            
            // P≈ôidej lokaci pro questy (nov√Ω syst√©m)
            if (message.type === 'quest') {
                // Vyber n√°hodnou lokaci z WORLD_LOCATIONS
                const questLocations = WORLD_LOCATIONS.filter(l => 
                    l.type !== 'home' && l.type !== 'empty' && l.zone !== 'safe'
                );
                if (questLocations.length > 0) {
                    const questLoc = questLocations[Math.floor(Math.random() * questLocations.length)];
                    content += ` [${questLoc.name}]`;
                    
                    if (message.questType === 'treasure') {
                        state.treasureLocation = { 
                            locationId: questLoc.id,
                            locationName: questLoc.name,
                            expiresAt: Date.now() + 30 * 60 * 1000
                        };
                    }
                }
            }
            
            state.radio.messages = state.radio.messages || [];
            state.radio.messages.push({ message: content, time: Date.now() });
            
            // Z√≠skej info o karavan√°ch
            const caravanActive = state.caravan?.active || state.caravanPresent;
            const caravanTimeLeft = caravanActive && state.caravan?.until ? Math.max(0, Math.ceil((state.caravan.until - Date.now()) / 1000)) : 0;
            const nextCaravanCheck = state.caravan?.nextCheck ? Math.max(0, Math.ceil((state.caravan.nextCheck - Date.now()) / 60000)) : 60;
            const caravanInfo = caravanActive ? 
                `<div style="color: #ffd700;">üê™ ${'Karavana je v oblasti!'} (${Math.floor(caravanTimeLeft/60)}:${String(caravanTimeLeft%60).padStart(2,'0')})</div>
                 <button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 0.5rem; background: #8B4513;">üê™ ${'Nav≈°t√≠vit karavanu'}</button>` : 
                `<div style="color: #888;">üê™ ${'≈Ω√°dn√° karavana v dosahu'}</div>
                 <div style="color: #666; font-size: 0.8rem;">${'Dal≈°√≠ ≈°ance za'} ~${nextCaravanCheck} min (25-70%)</div>`;
            
            // Denn√≠ ƒças
            const hour = new Date().getHours();
            const dayTime = hour >= 6 && hour < 20 ? ('‚òÄÔ∏è Den') : ('üåô Noc');
            const dayTimeDesc = hour >= 6 && hour < 20 ? ('Bezpeƒçnƒõj≈°√≠ cestov√°n√≠') : ('V√≠ce nep≈ô√°tel, ale lep≈°√≠ loot');
            
            // Poklad info
            let treasureInfo = '';
            if (state.treasureLocation && state.treasureLocation.locationId) {
                const timeLeft = state.treasureLocation.expiresAt ? Math.max(0, Math.ceil((state.treasureLocation.expiresAt - Date.now()) / 60000)) : 0;
                if (timeLeft > 0) {
                    treasureInfo = `<div style="color: #ffd700; margin-top: 0.5rem;">üíé ${'Poklad v'}: <strong>${state.treasureLocation.locationName}</strong> <span style="color: #888;">(${timeLeft} min)</span></div>`;
                } else {
                    // Vypr≈°elo
                    state.treasureLocation = null;
                }
            }
            
            showModal('üìª R√°dio', `
                <!-- R√°diov√° zpr√°va -->
                <div style="background: #0a0a0a; padding: 1rem; border-radius: 8px; font-family: monospace; border: 1px solid #333; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">üìª ${'Zachycen√° zpr√°va'}</h4>
                    <p style="color: #666; font-size: 0.85rem;">*${'≈°um'}* ... *${'prask√°n√≠'}* ...</p>
                    <p style="margin: 0.5rem 0; color: #fff;">"${content}"</p>
                    <p style="color: #666; font-size: 0.85rem;">*${'≈°um'}* ...</p>
                </div>
                
                <!-- Obecn√© info -->
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.9rem;">üìä Info</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                        <div>${dayTime}</div>
                        <div style="color: #888;">${dayTimeDesc}</div>
                        <div>üìç ${'Lokace'}</div>
                        <div style="color: #888;">${WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation)?.name || ('Nezn√°m√°')}</div>
                        <div>üìÖ ${'Den'}</div>
                        <div style="color: #888;">${state.time.days + 1}</div>
                    </div>
                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                        ${caravanInfo}
                        ${treasureInfo}
                    </div>
                </div>
                
                <button class="btn" onclick="useRadio()" style="width: 100%; margin-top: 0.5rem;">üìª ${'Hledat dal≈°√≠ frekvenci'}</button>
                <button class="btn" onclick="closeModal(); showExportImport();" style="width: 100%; margin-top: 0.5rem; background: #6A1B9A;">üì± ${'P≈ôenos postavy'}</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Vypnout'}</button>
            `);
        }
        
        // Speci√°ln√≠ akce na vys√≠laƒçi - silnƒõj≈°√≠ sign√°l
        function useRadioTowerSignal() {
            // Cooldown 30 minut
            const cooldownKey = 'radio_tower_signal';
            const lastUse = state.cooldowns?.[cooldownKey] || 0;
            const cooldownTime = 30 * 60 * 1000; // 30 minut
            const now = Date.now();
            
            if (now - lastUse < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastUse)) / 60000);
                showModal('üì° Vys√≠laƒç', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üì°</div>
                        <p style="color: #ff9800;">Vys√≠laƒç se nab√≠j√≠...</p>
                        <p style="color: #888;">Dal≈°√≠ pou≈æit√≠ za ${remaining} minut</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Nastav cooldown
            if (!state.cooldowns) state.cooldowns = {};
            state.cooldowns[cooldownKey] = now;
            
            // N√°hodn√Ω efekt
            const effects = [
                { type: 'caravan', weight: 30, name: 'P≈ôivol√°n√≠ karavany', icon: 'üê™' },
                { type: 'treasure', weight: 20, name: 'Sou≈ôadnice pokladu', icon: 'üíé' },
                { type: 'bonus_xp', weight: 25, name: 'Motivuj√≠c√≠ zpr√°va', icon: '‚≠ê' },
                { type: 'item', weight: 15, name: 'Z√°silka z √©teru', icon: 'üì¶' },
                { type: 'enemy_info', weight: 10, name: 'Intel o nep≈ô√°tel√≠ch', icon: 'üéØ' }
            ];
            
            const totalWeight = effects.reduce((sum, e) => sum + e.weight, 0);
            let roll = Math.random() * totalWeight;
            let selectedEffect = effects[0];
            
            for (const effect of effects) {
                roll -= effect.weight;
                if (roll <= 0) {
                    selectedEffect = effect;
                    break;
                }
            }
            
            let resultHtml = '';
            
            switch (selectedEffect.type) {
                case 'caravan':
                    state.caravanPresent = true;
                    state.caravan = state.caravan || {};
                    state.caravan.active = true;
                    state.caravan.until = now + 10 * 60 * 1000; // 10 minut
                    resultHtml = `
                        <p style="color: #8bc34a;">Sign√°l p≈ôil√°kal karavanu!</p>
                        <p>Obchodn√≠k bude v oblasti 10 minut.</p>
                        <button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 0.5rem; background: #8B4513;">üê™ Nav≈°t√≠vit karavanu</button>
                    `;
                    break;
                    
                case 'treasure':
                    // Vyber n√°hodnou lokaci pro poklad (ne aktu√°ln√≠, ne shelter)
                    const treasureLocations = WORLD_LOCATIONS.filter(l => 
                        l.id !== state.world.currentLocation && 
                        l.id !== 'shelter' &&
                        !l.id.includes('bunker') // ne bunkry - tƒõ≈æko dostupn√©
                    );
                    const treasureLoc = treasureLocations[Math.floor(Math.random() * treasureLocations.length)];
                    
                    if (treasureLoc) {
                        state.treasureLocation = { 
                            locationId: treasureLoc.id, 
                            locationName: treasureLoc.name,
                            expiresAt: Date.now() + (60 * 60 * 1000) // 1 hodina na nalezen√≠
                        };
                        resultHtml = `
                            <p style="color: #ffd700;">Zachyceny sou≈ôadnice pokladu!</p>
                            <p>Poklad je v lokaci: <strong>${treasureLoc.icon} ${treasureLoc.name}</strong></p>
                            <p style="color: #888; font-size: 0.8rem;">M√°≈° 1 hodinu ne≈æ zmiz√≠!</p>
                        `;
                    } else {
                        // Fallback - dej hr√°ƒçi p≈ô√≠mo nƒõco
                        addXP(75);
                        resultHtml = `
                            <p style="color: #ffd700;">Sou≈ôadnice byly po≈°kozen√©...</p>
                            <p style="color: #8bc34a;">Ale z√≠skal jsi +75 XP za dek√≥dov√°n√≠!</p>
                        `;
                    }
                    break;
                    
                case 'bonus_xp':
                    const xpBonus = 50 + Math.floor(Math.random() * 50);
                    addXP(xpBonus);
                    resultHtml = `
                        <p style="color: #64b5f6;">Zachytil jsi motivuj√≠c√≠ zpr√°vu od p≈ôe≈æiv≈°√≠ch!</p>
                        <p style="color: #8bc34a;">+${xpBonus} XP</p>
                    `;
                    break;
                    
                case 'item':
                    const items = ['stimpak', 'bandage', 'canned_food', 'water_bottle', 'ammo_9mm'];
                    const itemId = items[Math.floor(Math.random() * items.length)];
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) {
                        const existing = state.inv.find(i => i.id === itemId);
                        if (existing) {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            state.inv.push({...item, count: 1});
                        }
                        resultHtml = `
                            <p style="color: #8bc34a;">Nƒõkdo ti poslal z√°silku!</p>
                            <p>${item.icon} ${item.name}</p>
                        `;
                    }
                    break;
                    
                case 'enemy_info':
                    addXP(25);
                    resultHtml = `
                        <p style="color: #ff9800;">Zachytil jsi vojenskou frekvenci!</p>
                        <p>Intel o pohybu nep≈ô√°tel v oblasti.</p>
                        <p style="color: #8bc34a;">+25 XP, +10% damage na 1 hodinu</p>
                    `;
                    // Doƒçasn√Ω bonus
                    state.tempBonuses = state.tempBonuses || {};
                    state.tempBonuses.damage = { value: 1.1, until: now + 60 * 60 * 1000 };
                    break;
            }
            
            SoundSystem.play('pickup');
            showModal('üì° Sign√°l z vys√≠laƒçe', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${selectedEffect.icon}</div>
                    <h3 style="color: #64b5f6;">${selectedEffect.name}</h3>
                    ${resultHtml}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            
            addLog(`Pou≈æil jsi vys√≠laƒç: ${selectedEffect.name}`, 'üì°');
            renderFull();
        }
        
        // === QUEST SYST√âM ===
        function getCurrentQuest() {
            if (!state.mainQuest?.currentQuest) return null;
            return MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
        }
        
        function openAllQuests() {
            const quest = getCurrentQuest();
            const completedStoryCount = state.mainQuest?.completedQuests?.length || 0;
            const dailyCompleted = state.dailyQuests.completed?.length || 0;
            const dailyTotal = state.dailyQuests.quests?.length || 0;
            
            // Spoƒç√≠tej aktivn√≠ NPC questy
            const activeNpcQuests = Object.entries(state.npcQuests || {}).filter(([npcId, q]) => q && q.id);
            const activeSettlerQuests = state.settlement?.activeQuests || [];
            
            showModal('üìã P≈ôehled √∫kol≈Ø', `
                <style>
                    .quest-tabs { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem; }
                    .quest-tab { flex: 1; min-width: 60px; padding: 0.5rem 0.3rem; background: #1a1a1a; border: 2px solid #333; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.7rem; transition: all 0.2s; }
                    .quest-tab:hover { border-color: #555; }
                    .quest-tab.active { border-color: var(--rust-light); background: linear-gradient(180deg, #2a2018, #1a1510); }
                    .quest-tab .tab-icon { font-size: 1.2rem; display: block; }
                    .quest-content { display: none; max-height: 350px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
                    .quest-content.active { display: block; }
                    .quest-card { background: #1a1a1a; padding: 0.7rem; border-radius: 6px; border: 1px solid #333; margin-bottom: 0.5rem; }
                    .quest-card.completed { background: linear-gradient(135deg, #1a3a1a, #0a2a0a); border-color: #4caf50; }
                    .quest-card.active-quest { 
                        border-color: #ff9800; 
                        border-width: 2px; 
                        background: linear-gradient(135deg, #2a2a1a, #1a1a0a);
                        box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
                    }
                    .quest-card.active-quest::before {
                        content: 'üìå AKTIVN√ç';
                        display: block;
                        font-size: 0.65rem;
                        color: #ff9800;
                        font-weight: bold;
                        margin-bottom: 0.3rem;
                        text-transform: uppercase;
                    }
                </style>
                
                <div class="quest-tabs">
                    <div class="quest-tab active" onclick="switchQuestTab('daily')" id="tab-btn-daily">
                        <span class="tab-icon">üìã</span>
                        ${'Denn√≠'} <span style="color: ${dailyCompleted >= dailyTotal ? '#8bc34a' : '#7986CB'};">${dailyCompleted}/${dailyTotal}</span>
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('story')" id="tab-btn-story">
                        <span class="tab-icon">üìú</span>
                        ${'P≈ô√≠bƒõh'}
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('npc')" id="tab-btn-npc">
                        <span class="tab-icon">üë•</span>
                        NPC <span style="color: #ff9800;">${activeNpcQuests.length > 0 ? '(' + activeNpcQuests.length + ')' : ''}</span>
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('settler')" id="tab-btn-settler">
                        <span class="tab-icon">üèòÔ∏è</span>
                        ${'Osada'} <span style="color: #ff9800;">${activeSettlerQuests.length > 0 ? '(' + activeSettlerQuests.length + ')' : ''}</span>
                    </div>
                    <div class="quest-tab" onclick="switchQuestTab('faction')" id="tab-btn-faction">
                        <span class="tab-icon">üèõÔ∏è</span>
                        ${'Frakce'}
                    </div>
                </div>
                
                <!-- DENN√ç √öKOLY -->
                <div class="quest-content active" id="quest-daily">
                    <div style="margin-bottom: 0.8rem; padding: 0.5rem; background: linear-gradient(90deg, #1a1a2a, #2a1a3a); border-radius: 6px; border: 1px solid #3949AB;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #7986CB; font-size: 0.85rem;">${currentLang === "en" ? "Completed:" : "Splnƒõno:"}</span>
                            <span style="color: ${dailyCompleted >= dailyTotal ? '#8bc34a' : '#ffd700'}; font-weight: bold;">${dailyCompleted}/${dailyTotal}</span>
                        </div>
                        <p style="color: #666; font-size: 0.7rem; margin-top: 0.2rem;">${currentLang === "en" ? "‚è∞ Resets every 24 hours" : "‚è∞ Resetuje se ka≈æd√Ωch 24 hodin"}</p>
                    </div>
                    
                    ${state.dailyQuests.quests && state.dailyQuests.quests.length > 0 ? 
                        state.dailyQuests.quests.map(dq => {
                            const completed = state.dailyQuests.completed?.includes(dq.id);
                            const progress = state.dailyQuests.progress || {};
                            
                            // Najdi origin√°ln√≠ quest pro target a progressKey
                            const originalQuest = DAILY_QUEST_POOL.find(q => q.id === dq.id);
                            let currentProgress = 0, targetProgress = 1;
                            
                            if (originalQuest && originalQuest.progressKey) {
                                currentProgress = progress[originalQuest.progressKey] || 0;
                                targetProgress = originalQuest.target || 1;
                            }
                            
                            const progressPercent = Math.min(100, (currentProgress / targetProgress) * 100);
                            
                            // P≈ôeklad quest name a desc
                            const questTranslation = TRANSLATIONS[currentLang]?.dailyQuests?.[dq.id];
                            const questName = questTranslation?.name || dq.name;
                            const questDesc = questTranslation?.desc || dq.desc;
                            
                            return '<div class="quest-card ' + (completed ? 'completed' : '') + '">' +
                                '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                    '<span style="font-size: 1.3rem;">' + dq.icon + '</span>' +
                                    '<div style="flex: 1;">' +
                                        '<div style="font-weight: bold; color: ' + (completed ? '#8bc34a' : '#fff') + '; font-size: 0.9rem;">' + questName + '</div>' +
                                        '<div style="font-size: 0.75rem; color: #888;">' + questDesc + '</div>' +
                                    '</div>' +
                                    '<span style="font-size: 1.2rem;">' + (completed ? '‚úÖ' : '‚è≥') + '</span>' +
                                '</div>' +
                                (!completed ? '<div style="margin-top: 0.4rem;"><div style="height: 4px; background: #0a0a0a; border-radius: 2px; overflow: hidden;"><div style="height: 100%; width: ' + progressPercent + '%; background: ' + (progressPercent >= 100 ? '#8bc34a' : '#ff9800') + ';"></div></div><div style="text-align: right; font-size: 0.65rem; color: #666;">' + currentProgress + '/' + targetProgress + '</div></div>' : '') +
                            '</div>';
                        }).join('')
                        : `<p style="text-align: center; color: #666;">${'≈Ω√°dn√© denn√≠ √∫koly'}</p>`
                    }
                </div>
                
                <!-- P≈ò√çBƒöHOV√â √öKOLY -->
                <div class="quest-content" id="quest-story">
                    <div style="margin-bottom: 0.8rem; padding: 0.4rem; background: linear-gradient(90deg, #1a1a2e, #16213e); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                            <span style="color: #ffd700;">üìñ ${'Kapitola'} ${state.mainQuest?.chapter || 0}/4</span>
                            <span style="color: #888;">${completedStoryCount}/${MAIN_QUESTS.length}</span>
                        </div>
                        <div style="background: #333; height: 5px; border-radius: 3px; overflow: hidden; margin-top: 0.4rem;">
                            <div style="background: linear-gradient(90deg, #ffd700, #ff9800); height: 100%; width: ${(state.mainQuest?.chapter || 0) * 25}%;"></div>
                        </div>
                    </div>
                    
                    ${state.mainQuest?.storyComplete ? 
                        '<div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #1a3a1a, #2a4a2a); border-radius: 8px;"><div style="font-size: 3rem;">üèÜ</div><h3 style="color: #ffd700; margin: 0.5rem 0;">' + ('P≈ò√çBƒöH DOKONƒåEN!') + '</h3><p style="color: #8bc34a; font-size: 0.9rem;">' + ('Zachr√°nil jsi lidstvo!') + '</p></div>'
                    : quest ? 
                        (function() {
                            // Kontrola zda jsou v≈°echny c√≠le splnƒõn√©
                            var allComplete = quest.objectives.every(function(obj) {
                                var prog = state.mainQuest?.questProgress?.[obj.id] || 0;
                                if (obj.type === 'visit_locations') return state.world.visitedLocations.length >= obj.target;
                                if (obj.type === 'location') return prog >= 1;
                                if (obj.type === 'explore') return prog >= obj.target;
                                if (obj.type === 'item') return state.inv.some(function(i) { return i.id === obj.target; });
                                if (obj.type === 'kill') return prog >= 1;
                                return prog >= 1;
                            });
                            
                            // Kontrola po≈æadovan√©ho itemu
                            var hasRequiredItem = !quest.requiresItem || state.inv.some(function(i) { return i.id === quest.requiresItem; });
                            var canComplete = allComplete && hasRequiredItem;
                            
                            return '<div class="quest-card active-quest">' +
                                '<h3 style="margin: 0; color: #d4722e; font-size: 1rem;">üìå ' + getMainQuestTitle(quest.id) + '</h3>' +
                                '<p style="color: #888; margin: 0.3rem 0; font-size: 0.8rem;">' + getMainQuestDesc(quest.id) + '</p>' +
                                '<div style="margin-top: 0.6rem;">' +
                                    quest.objectives.map(function(obj) {
                                        var prog = state.mainQuest?.questProgress?.[obj.id] || 0;
                                        var complete = false;
                                        var displayProg = '';
                                        var locationName = '';
                                        
                                        if (obj.type === 'visit_locations') { prog = state.world.visitedLocations.length; complete = prog >= obj.target; displayProg = Math.min(prog, obj.target) + '/' + obj.target; }
                                        else if (obj.type === 'location') { 
                                            complete = prog >= 1;
                                            // Zobraz n√°zev lokace
                                            var loc = WORLD_LOCATIONS.find(function(l) { return l.id === obj.target; });
                                            if (loc && !complete) locationName = ' <span style="color: #ff9800;">(üìç' + loc.name + ')</span>';
                                        }
                                        else if (obj.type === 'explore') { complete = prog >= obj.target; displayProg = prog + '/' + obj.target; }
                                        else if (obj.type === 'item') { complete = state.inv.some(function(i) { return i.id === obj.target; }); }
                                        else if (obj.type === 'kill') { complete = prog >= 1; }
                                        else { complete = prog >= 1; }
                                        
                                        return '<div style="display: flex; align-items: center; gap: 0.3rem; margin: 0.2rem 0; padding: 0.2rem 0.4rem; background: ' + (complete ? '#1a3a1a' : '#0a0a0a') + '; border-radius: 3px; font-size: 0.8rem;">' +
                                            '<span style="color: ' + (complete ? '#8bc34a' : '#666') + ';">' + (complete ? '‚úì' : '‚óã') + '</span>' +
                                            '<span style="flex: 1; ' + (complete ? 'text-decoration: line-through; color: #666;' : '') + '">' + obj.text + locationName + '</span>' +
                                            (displayProg ? '<span style="color: #888; font-size: 0.7rem;">' + displayProg + '</span>' : '') +
                                        '</div>';
                                    }).join('') +
                                '</div>' +
                                '<div style="margin-top: 0.5rem; padding: 0.3rem; background: #0a1a0a; border-radius: 3px; font-size: 0.75rem; color: #8bc34a;">üéÅ ' + quest.reward.xp + ' XP, ' + quest.reward.money + ' üí∞</div>' +
                                (canComplete ? '<button class="btn" onclick="manualCompleteQuest(\'' + quest.id + '\')" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #4caf50, #2e7d32); font-weight: bold;">‚úÖ ' + ('Dokonƒçit √∫kol') + '</button>' : '') +
                            '</div>';
                        })()
                    : '<p style="text-align: center; color: #666;">' + ('≈Ω√°dn√Ω aktivn√≠ p≈ô√≠bƒõhov√Ω quest') + '</p>'
                    }
                    
                    ${completedStoryCount > 0 ? 
                        '<details style="margin-top: 0.6rem;"><summary style="cursor: pointer; color: #888; font-size: 0.8rem;">üìö ' + ('Dokonƒçen√©') + ' (' + completedStoryCount + ')</summary><div style="margin-top: 0.4rem;">' +
                        (state.mainQuest?.completedQuests || []).map(function(qId) {
                            var q = MAIN_QUESTS.find(function(mq) { return mq.id === qId; });
                            return q ? '<div style="padding: 0.2rem 0.4rem; color: #666; font-size: 0.75rem;">‚úì ' + getMainQuestTitle(qId) + '</div>' : '';
                        }).join('') + '</div></details>'
                    : ''}
                    
                    <!-- ZJI≈†TƒöN√â INFORMACE O P≈ò√çBƒöHU -->
                    ${(function() {
                        const completed = state.mainQuest?.completedQuests || [];
                        const currentQuest = state.mainQuest?.currentQuest;
                        const karma = state.storyKarma || { kory: 0, koudy: 0, componentsGiven: { kory: 0, koudy: 0 } };
                        
                        // Informace podle progressu
                        const discoveries = [];
                        
                        // Po √∫vodu
                        if (completed.includes('intro') || ['find_stranger', 'meet_kory', 'meet_koudy'].includes(currentQuest) || completed.includes('find_stranger')) {
                            discoveries.push({
                                icon: 'üí•',
                                title: 'Apokalypsa',
                                text: 'Svƒõt byl zniƒçen nƒõjakou katastrofou. Projekt Genesis...'
                            });
                        }
                        
                        // Po setk√°n√≠ se starcem
                        if (completed.includes('find_stranger') || completed.includes('meet_kory')) {
                            discoveries.push({
                                icon: 'üë•',
                                title: 'Dva brat≈ôi',
                                text: 'Kory a Koudy - oba hledaj√≠ Projekt Genesis. Jeden z nich l≈æe. Ale kter√Ω?'
                            });
                        }
                        
                        // Po setk√°n√≠ s Korym
                        if (completed.includes('meet_kory') || completed.includes('meet_koudy')) {
                            discoveries.push({
                                icon: 'ü¶π',
                                title: 'Kory',
                                text: 'Charismatick√Ω mu≈æ. Mluv√≠ o "oƒçistƒõ" a "nov√©m svƒõtƒõ". S√≠dl√≠ v Trading Post.'
                            });
                        }
                        
                        // Po setk√°n√≠ s Koudym
                        if (completed.includes('meet_koudy') || completed.includes('first_component')) {
                            discoveries.push({
                                icon: 'üë®‚Äçüî¨',
                                title: 'Koudy',
                                text: 'Unaven√Ω vƒõdec. Tvrd√≠, ≈æe jeho bratr je nebezpeƒçn√Ω. S√≠dl√≠ v Research Facility.'
                            });
                        }
                        
                        // Po prvn√≠m komponentu
                        if (completed.includes('first_component') || completed.includes('first_choice')) {
                            discoveries.push({
                                icon: '‚ò¢Ô∏è',
                                title: 'Plutoniov√© j√°dro',
                                text: 'Prvn√≠ ze ƒçty≈ô komponent≈Ø Projektu Genesis. Radioaktivn√≠ a nebezpeƒçn√©.'
                            });
                        }
                        
                        // Po dokumentech
                        if (completed.includes('find_document') || completed.includes('second_choice')) {
                            discoveries.push({
                                icon: 'üìú',
                                title: 'Tajn√© dokumenty',
                                text: 'Projekt Genesis m≈Ø≈æe BUƒé vyƒçistit radiaci, NEBO vyvolat zk√°zu. Z√°le≈æ√≠ na konfiguraci!'
                            });
                        }
                        
                        // Po odhalen√≠ pravdy
                        if (completed.includes('truth_revealed') || completed.includes('third_choice')) {
                            discoveries.push({
                                icon: 'üîç',
                                title: 'PRAVDA ODHALENA',
                                text: 'Kory byl vedouc√≠m vojensk√©ho projektu. Vƒõ≈ô√≠, ≈æe lidstvo je "nemoc". Koudy se pokusil projekt sabotovat - proto do≈°lo k explozi!'
                            });
                        }
                        
                        // Po ƒçtvrt√©m komponentu - info o Buƒçovic√≠ch
                        if (completed.includes('fourth_component') || currentQuest === 'final_choice') {
                            discoveries.push({
                                icon: 'üè∞',
                                title: 'Buƒçovice - M√≠sto rozhodnut√≠',
                                text: 'Oba brat≈ôi se dozvƒõdƒõli, ≈æe m√°≈° v≈°echny komponenty. ƒåekaj√≠ na tebe v Buƒçovic√≠ch, hlavn√≠m mƒõstƒõ pustiny.'
                            });
                        }
                        
                        // Komponenty p≈ôed√°ny
                        if (karma.componentsGiven.kory > 0 || karma.componentsGiven.koudy > 0) {
                            discoveries.push({
                                icon: 'üì¶',
                                title: 'Komponenty p≈ôed√°ny',
                                text: 'Kory: ' + (karma.componentsGiven.kory || 0) + '/4 | Koudy: ' + (karma.componentsGiven.koudy || 0) + '/4'
                            });
                        }
                        
                        // Ending
                        if (state.storyKarma?.ending) {
                            const endingText = {
                                dark: 'üåë Kory aktivoval Genesis. Svƒõt byl "oƒçi≈°tƒõn".',
                                hope: 'üåÖ Koudy aktivoval Genesis. Svƒõt se zaƒç√≠n√° uzdravovat.',
                                neutral: '‚öñÔ∏è Projekt Genesis byl zniƒçen. Svƒõt z≈Øst√°v√° takov√Ω, jak√Ω je.'
                            };
                            discoveries.push({
                                icon: 'üèÜ',
                                title: 'KONEC P≈ò√çBƒöHU',
                                text: endingText[state.storyKarma.ending]
                            });
                        }
                        
                        if (discoveries.length === 0) return '';
                        
                        return '<details style="margin-top: 0.8rem; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 8px; padding: 0.5rem;" open>' +
                            '<summary style="cursor: pointer; color: #64b5f6; font-size: 0.9rem; font-weight: bold;">üîé Zji≈°tƒõn√© informace (' + discoveries.length + ')</summary>' +
                            '<div style="margin-top: 0.5rem;">' +
                                discoveries.map(function(d) {
                                    return '<div style="padding: 0.5rem; margin: 0.3rem 0; background: #0a0a1a; border-radius: 6px; border-left: 3px solid #64b5f6;">' +
                                        '<div style="display: flex; align-items: center; gap: 0.4rem;">' +
                                            '<span style="font-size: 1.2rem;">' + d.icon + '</span>' +
                                            '<span style="color: #fff; font-weight: bold; font-size: 0.85rem;">' + d.title + '</span>' +
                                        '</div>' +
                                        '<p style="margin: 0.3rem 0 0 0; color: #aaa; font-size: 0.75rem;">' + d.text + '</p>' +
                                    '</div>';
                                }).join('') +
                            '</div>' +
                        '</details>';
                    })()}
                </div>
                
                <!-- NPC √öKOLY -->
                <div class="quest-content" id="quest-npc">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">Aktivn√≠ √∫koly od NPC:</p>
                    
                    ${activeNpcQuests.length > 0 ? activeNpcQuests.map(function([npcId, npcQuest]) {
                        const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                        if (!npc) return '';
                        const trust = state.npcRelations?.[npcId]?.trust || 0;
                        const questDef = NPC_QUESTS[npcQuest.id];
                        
                        return '<div class="quest-card active-quest">' +
                            '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                '<span style="font-size: 1.5rem;">' + npc.icon + '</span>' +
                                '<div style="flex: 1;">' +
                                    '<div style="font-weight: bold; color: #fff; font-size: 0.9rem;">' + npc.name + '</div>' +
                                    '<div style="font-size: 0.7rem; color: #888;">üìç ' + (WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location) + '</div>' +
                                    '<div style="font-size: 0.7rem; color: #ffd700;">‚ù§Ô∏è D≈Øvƒõra: ' + trust + '</div>' +
                                '</div>' +
                            '</div>' +
                            (function() {
                                const progress = getNPCQuestProgress(npcQuest, questDef);
                                
                                const progressHtml = '<div style="margin-top: 0.3rem;">' +
                                    '<div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #888;">' +
                                    '<span>' + progress.label + ':</span>' +
                                    '<span style="color: ' + (progress.complete ? '#8bc34a' : '#ff9800') + ';">' + progress.current + '/' + progress.required + '</span>' +
                                    '</div>' +
                                    '<div style="height: 6px; background: #333; border-radius: 3px; overflow: hidden;">' +
                                    '<div style="height: 100%; width: ' + progress.percent + '%; background: linear-gradient(90deg, ' + (progress.complete ? '#4caf50, #8bc34a' : '#ff9800, #ffd700') + ');"></div>' +
                                    '</div>' +
                                    (progress.complete ? '<div style="text-align: center; color: #8bc34a; font-size: 0.7rem; margin-top: 0.2rem;">‚úì Splnƒõno! Vra≈• se pro odmƒõnu.</div>' : '') +
                                    '</div>';
                                
                                return '<div style="margin-top: 0.5rem; padding: 0.4rem; background: #0a0a0a; border-radius: 4px; border-left: 3px solid ' + (progress.complete ? '#4caf50' : '#ff9800') + ';">' +
                                    '<div style="color: ' + (progress.complete ? '#8bc34a' : '#ff9800') + '; font-size: 0.85rem; font-weight: bold;">üìå ' + (questDef?.name || 'Aktivn√≠ √∫kol') + '</div>' +
                                    '<div style="color: #888; font-size: 0.75rem;">' + (questDef?.desc || '') + '</div>' +
                                    (questDef?.details ? '<div style="color: #64b5f6; font-size: 0.7rem; margin-top: 0.3rem; padding: 0.3rem; background: #1a1a2a; border-radius: 3px;">' + questDef.details + '</div>' : '') +
                                    progressHtml +
                                '</div>';
                            })() +
                        '</div>';
                    }).join('') : '<div style="text-align: center; padding: 1rem; color: #666;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">üë•</div><p>≈Ω√°dn√© aktivn√≠ NPC √∫koly</p><p style="font-size: 0.8rem; color: #888;">Nav≈°tiv NPC a zeptej se na √∫koly</p></div>'}
                </div>
                
                <!-- OSADNICK√â √öKOLY -->
                <div class="quest-content" id="quest-settler">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">√ökoly od obyvatel tv√© osady:</p>
                    
                    ${activeSettlerQuests.length > 0 ? 
                        activeSettlerQuests.map(function(sq, sqIdx) {
                            const questDef = SETTLER_QUESTS.find(q => q.id === sq.questId);
                            const settler = state.settlement?.settlers?.find(s => s.name === sq.settlerName);
                            const settlerType = settler ? SETTLER_TYPES.find(t => t.id === settler.type) : null;
                            
                            return '<div class="quest-card active-quest" onclick="showSettlerQuestDetail(' + sqIdx + ')" style="cursor: pointer;">' +
                                '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                    '<span style="font-size: 1.3rem;">' + (questDef?.icon || 'üìã') + '</span>' +
                                    '<div style="flex: 1;">' +
                                        '<div style="font-weight: bold; color: #ff9800; font-size: 0.9rem;">' + (questDef?.name || '√ökol') + '</div>' +
                                        '<div style="font-size: 0.75rem; color: #888;">Od: ' + (sq.settlerName || 'Osadn√≠k') + ' ' + (settlerType?.icon || '') + '</div>' +
                                        '<div style="font-size: 0.75rem; color: #aaa;">' + (questDef?.desc || '') + '</div>' +
                                    '</div>' +
                                    '<span style="color: #4caf50;">‚Üí</span>' +
                                '</div>' +
                            '</div>';
                        }).join('')
                    : '<div style="text-align: center; padding: 1rem; color: #666;">' +
                        '<div style="font-size: 2rem; margin-bottom: 0.5rem;">üèòÔ∏è</div>' +
                        '<p>≈Ω√°dn√© aktivn√≠ √∫koly od osadn√≠k≈Ø</p>' +
                        '<p style="font-size: 0.75rem;">Osadn√≠ci ti obƒças nab√≠dnou mise</p>' +
                      '</div>'
                    }
                    
                    <div style="margin-top: 1rem; padding: 0.5rem; background: #0a0a0a; border-radius: 4px;">
                        <div style="color: #888; font-size: 0.75rem;">üë• Osadn√≠k≈Ø: ${state.settlement?.settlers?.length || 0}</div>
                        <div style="color: #888; font-size: 0.75rem;">üè† Budov: ${(state.base?.length || 0) + (state.settlement?.buildings?.length || 0)}</div>
                    </div>
                </div>
                
                <!-- FRAKCE -->
                <div class="quest-content" id="quest-faction">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">Tv√© vztahy s frakcemi v pustinƒõ:</p>
                    
                    ${FACTIONS.map(function(faction) {
                        const rep = state.factions?.[faction.id]?.reputation || 0;
                        const level = REPUTATION_LEVELS.find(l => rep >= l.min && rep <= l.max) || REPUTATION_LEVELS[2];
                        
                        return '<div class="quest-card" style="border-left: 3px solid ' + faction.color + ';">' +
                            '<div style="display: flex; align-items: center; gap: 0.6rem;">' +
                                '<span style="font-size: 1.5rem;">' + faction.icon + '</span>' +
                                '<div style="flex: 1;">' +
                                    '<div style="font-weight: bold; color: ' + faction.color + '; font-size: 0.9rem;">' + faction.name + '</div>' +
                                    '<div style="font-size: 0.7rem; color: #888;">' + faction.desc.substring(0, 50) + '...</div>' +
                                '</div>' +
                                '<div style="text-align: right;">' +
                                    '<div style="font-size: 1rem;">' + level.icon + '</div>' +
                                    '<div style="font-size: 0.7rem; color: ' + level.color + ';">' + level.name + '</div>' +
                                    '<div style="font-size: 0.65rem; color: #666;">' + rep + '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    }).join('')}
                    
                    <div style="margin-top: 1rem; padding: 0.6rem; background: linear-gradient(135deg, #1a1520, #201525); border-radius: 6px; border: 1px solid #9c27b0;">
                        <div style="font-weight: bold; color: #ce93d8; margin-bottom: 0.5rem;">‚öîÔ∏è Projekt Genesis</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div style="text-align: center; padding: 0.4rem; background: #1a0a0a; border-radius: 4px;">
                                <div style="font-size: 1.5rem;">ü¶π</div>
                                <div style="color: #ff5252; font-size: 0.85rem;">Kory</div>
                                <div style="color: #888; font-size: 0.7rem;">Karma: ${state.storyKarma?.kory || 0}</div>
                            </div>
                            <div style="text-align: center; padding: 0.4rem; background: #0a0a1a; border-radius: 4px;">
                                <div style="font-size: 1.5rem;">üë®‚Äçüî¨</div>
                                <div style="color: #64b5f6; font-size: 0.85rem;">Koudy</div>
                                <div style="color: #888; font-size: 0.7rem;">Karma: ${state.storyKarma?.koudy || 0}</div>
                            </div>
                        </div>
                        ${state.activeQuest ? 
                            '<div style="margin-top: 0.5rem; padding: 0.3rem; background: #0a0a0a; border-radius: 3px; text-align: center;"><span style="color: #ff9800; font-size: 0.8rem;">üìå Aktivn√≠: ' + (NPC_QUESTS[state.activeQuest.questId]?.name || 'Quest') + '</span></div>'
                        : ''}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function switchQuestTab(tab) {
            // Deaktivuj v≈°echny taby
            document.querySelectorAll('.quest-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.quest-content').forEach(c => c.classList.remove('active'));
            
            // Aktivuj vybran√Ω tab
            document.getElementById('tab-btn-' + tab)?.classList.add('active');
            document.getElementById('quest-' + tab)?.classList.add('active');
        }
        
        // Zachov√°me star√© funkce pro kompatibilitu
        function openDailyQuests() {
            openAllQuests();
        }
        
        // P≈ôesmƒõrov√°n√≠ na novou slouƒçenou funkci
        function openQuestLog() {
            openAllQuests();
            // Automaticky p≈ôepnout na p≈ô√≠bƒõhov√Ω tab
            setTimeout(() => switchQuestTab('story'), 50);
        }
        
        function updateQuestProgress(type, value) {
            if (!state.mainQuest?.currentQuest) return;
            
            const quest = getCurrentQuest();
            if (!quest) return;
            
            state.mainQuest.questProgress = state.mainQuest.questProgress || {};
            
            quest.objectives.forEach(obj => {
                if (obj.type === type) {
                    if (type === 'visit_locations') {
                        // Poƒç√≠t√° nav≈°t√≠ven√© lokace
                        state.mainQuest.questProgress[obj.id] = state.world.visitedLocations.length;
                    } else if (type === 'location') {
                        // Nov√Ω syst√©m - kontrola podle location ID
                        if (state.world.currentLocation === obj.target) {
                            state.mainQuest.questProgress[obj.id] = 1;
                        }
                    } else if (type === 'explore') {
                        state.mainQuest.questProgress[obj.id] = (state.mainQuest.questProgress[obj.id] || 0) + 1;
                    } else if (type === 'item') {
                        if (state.inv.some(i => i.id === obj.target)) {
                            state.mainQuest.questProgress[obj.id] = 1;
                        }
                    } else if (type === 'kill' && value === obj.target) {
                        state.mainQuest.questProgress[obj.id] = 1;
                    } else if (type === 'choice') {
                        // Choice quest - hr√°ƒç vyb√≠r√° mezi mo≈ænostmi (nap≈ô. komu p≈ôedat komponenty)
                        if (obj.targets && obj.targets.includes(value)) {
                            state.mainQuest.questProgress[obj.id] = 1;
                            state.mainQuest.choiceMade = value; // Ulo≈æ jakou volbu hr√°ƒç udƒõlal
                        }
                    } else if (type === 'interact') {
                        // Interakce s NPC nebo objektem
                        if (value === obj.id || value === obj.target) {
                            state.mainQuest.questProgress[obj.id] = 1;
                        }
                    } else if (type === 'build') {
                        // Stavba - kontrola zdroj≈Ø
                        if (obj.resources) {
                            const hasAll = Object.entries(obj.resources).every(([res, amt]) => state.resources[res] >= amt);
                            if (hasAll && value === obj.id) {
                                // Odeber zdroje
                                Object.entries(obj.resources).forEach(([res, amt]) => {
                                    state.resources[res] -= amt;
                                });
                                state.mainQuest.questProgress[obj.id] = 1;
                            }
                        }
                    } else if (type === 'collect') {
                        // Sb√≠r√°n√≠ item≈Ø - kontrola invent√°≈ôe
                        if (obj.items) {
                            const hasAll = obj.items.every(itemType => 
                                state.inv.some(i => i.type === itemType || i.id === itemType)
                            );
                            if (hasAll) {
                                state.mainQuest.questProgress[obj.id] = 1;
                            }
                        }
                    }
                }
                
                // Speci√°ln√≠ handling pro choice questy - vol√° se i p≈ôi location zmƒõnƒõ
                if (obj.type === 'choice' && type === 'location') {
                    if (obj.targets && obj.targets.includes(value)) {
                        state.mainQuest.questProgress[obj.id] = 1;
                        state.mainQuest.choiceMade = value;
                    }
                }
            });
            
            checkQuestComplete();
        }
        
        function checkQuestComplete() {
            const quest = getCurrentQuest();
            if (!quest) return;
            
            const allComplete = quest.objectives.every(obj => {
                const progress = state.mainQuest.questProgress?.[obj.id] || 0;
                if (obj.type === 'location') return progress >= 1;
                if (obj.type === 'visit_locations') return state.world.visitedLocations.length >= obj.target;
                if (obj.type === 'explore') return progress >= obj.target;
                if (obj.type === 'item') return state.inv.some(i => i.id === obj.target);
                if (obj.type === 'kill') return progress >= 1;
                if (obj.type === 'choice') return progress >= 1;
                if (obj.type === 'interact') return progress >= 1;
                if (obj.type === 'build') return progress >= 1;
                if (obj.type === 'collect') return progress >= 1;
                return progress >= 1;
            });
            
            // Kontrola po≈æadovan√Ωch item≈Ø
            if (quest.requiresItem && !state.inv.some(i => i.id === quest.requiresItem)) {
                return;
            }
            
            if (allComplete) {
                completeQuest(quest);
            }
        }
        
        // Manu√°ln√≠ dokonƒçen√≠ questu (tlaƒç√≠tko)
        function manualCompleteQuest(questId) {
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            // Ovƒõ≈ôen√≠ ≈æe je opravdu splnƒõn√Ω
            const allComplete = quest.objectives.every(obj => {
                const progress = state.mainQuest?.questProgress?.[obj.id] || 0;
                if (obj.type === 'location') return progress >= 1;
                if (obj.type === 'visit_locations') return state.world.visitedLocations.length >= obj.target;
                if (obj.type === 'explore') return progress >= obj.target;
                if (obj.type === 'item') return state.inv.some(i => i.id === obj.target);
                if (obj.type === 'kill') return progress >= 1;
                if (obj.type === 'choice') return progress >= 1;
                if (obj.type === 'interact') return progress >= 1;
                if (obj.type === 'build') return progress >= 1;
                if (obj.type === 'collect') return progress >= 1;
                return progress >= 1;
            });
            
            if (!allComplete) {
                showModal('‚ùå Nelze dokonƒçit', 'Nesplnil jsi v≈°echny c√≠le questu!');
                return;
            }
            
            // Kontrola po≈æadovan√Ωch item≈Ø
            if (quest.requiresItem && !state.inv.some(i => i.id === quest.requiresItem)) {
                showModal('‚ùå Chyb√≠ p≈ôedmƒõt', `Pot≈ôebuje≈°: ${quest.requiresItem}`);
                return;
            }
            
            closeModal();
            completeQuest(quest);
        }
        
        function completeQuest(quest) {
            // KRITICK√â: Nejd≈ô√≠v p≈ôidat do completedQuests aby se zabr√°nilo opakovan√©mu dokonƒçen√≠!
            if (!state.mainQuest) state.mainQuest = {};
            if (!state.mainQuest.completedQuests) state.mainQuest.completedQuests = [];
            
            // Kontrola zda u≈æ nen√≠ dokonƒçen (ochrana proti duplicit√°m)
            if (state.mainQuest.completedQuests.includes(quest.id)) {
                console.warn('‚ö†Ô∏è Quest u≈æ byl dokonƒçen:', quest.id);
                return;
            }
            
            // P≈ôidat do completed IHNED
            state.mainQuest.completedQuests.push(quest.id);
            state.mainQuest.questProgress = {};
            
            // Teƒè odmƒõny - s validac√≠
            if (quest.reward?.xp) addXP(quest.reward.xp);
            if (quest.reward?.money) addMoney(quest.reward.money);
            
            // Odeber quest itemy
            if (quest.requiresItem) {
                state.inv = state.inv.filter(i => i.id !== quest.requiresItem);
            }
            
            // P≈ôidej quest item odmƒõnu
            if (quest.reward.item) {
                const item = QUEST_ITEMS.find(i => i.id === quest.reward.item);
                if (item) {
                    state.inv.push({...item, count: 1});
                }
            }
            
            // NOV√â: Companion reward
            if (quest.reward?.companion) {
                const companionNames = ['Max', 'Elena', 'Viktor', 'Anna', 'Karel', 'Marie', 'Pavel', 'Zuzana'];
                const newCompanion = {
                    id: 'survivor',
                    uniqueId: 'companion_' + Date.now(),
                    name: companionNames[Math.floor(Math.random() * companionNames.length)],
                    icon: 'üßë',
                    type: 'human',
                    hp: 50 + Math.floor(Math.random() * 30),
                    maxHp: 80,
                    damage: 8 + Math.floor(Math.random() * 5),
                    defense: 4 + Math.floor(Math.random() * 3),
                    level: 1,
                    xp: 0,
                    skillPoints: 1,
                    skills: [],
                    equipped: { weapon: null, armor: null, helmet: null, gloves: null, boots: null },
                    loyalty: 60 + Math.floor(Math.random() * 20),
                    ability: 'P≈ôe≈æiv≈°√≠',
                    abilityDesc: 'Zku≈°en√Ω p≈ôe≈æiv≈°√≠ apokalypsy',
                    canEquip: true,
                    inCombat: true
                };
                addCompanionWithSwap(newCompanion, 'quest');
            }
            
            // Zjisti nextQuest - m≈Ø≈æe b√Ωt statick√Ω nebo z choiceEffects
            let nextQuestId = quest.nextQuest;
            let choiceDialog = null;
            
            // Pokud je to choice quest, pou≈æij nextQuest z choiceEffects podle volby hr√°ƒçe
            if (quest.isChoice && quest.choiceEffects && state.mainQuest.choiceMade) {
                const choice = state.mainQuest.choiceMade;
                const choiceEffect = quest.choiceEffects[choice];
                if (choiceEffect) {
                    if (choiceEffect.nextQuest) nextQuestId = choiceEffect.nextQuest;
                    if (choiceEffect.dialog) choiceDialog = choiceEffect.dialog;
                    // Aplikuj karma efekty
                    if (choiceEffect.karma) {
                        state.storyKarma = state.storyKarma || { kory: 0, koudy: 0 };
                        Object.entries(choiceEffect.karma).forEach(([key, val]) => {
                            state.storyKarma[key] = (state.storyKarma[key] || 0) + val;
                        });
                    }
                }
                state.mainQuest.choiceMade = null; // Reset volby
            }
            
            if (quest.ending) {
                // Konec p≈ô√≠bƒõhu!
                state.mainQuest.storyComplete = true;
                state.mainQuest.currentQuest = null;
                
                showModal('üèÜ P≈ò√çBƒöH DOKONƒåEN!', `
                    <div style="text-align: center;">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">üèÜ</div>
                        <h2 style="color: #ffd700;">GRATULACE!</h2>
                        <p style="margin: 1rem 0;">Dokonƒçil jsi hlavn√≠ p≈ô√≠bƒõh!</p>
                        <p style="color: #8bc34a;">Zachr√°nil jsi lidstvo p≈ôed vyhynut√≠m.</p>
                        <p style="color: #999; margin-top: 1rem;">S antivirem v rukou m≈Ø≈æe≈° zaƒç√≠t l√©ƒçit p≈ôe≈æiv≈°√≠ a budovat nov√Ω svƒõt.</p>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #ffd700;">üéÅ Bonusov√° odmƒõna:</p>
                            <p>+1000 XP, +1000 üí∞</p>
                            <p style="color: #9c27b0;">+ Titul: "Zachr√°nce lidstva"</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">üéâ Pokraƒçovat ve h≈ôe</button>
                `);
                
                addLog('üèÜ P≈ò√çBƒöH DOKONƒåEN! Zachr√°nil jsi lidstvo!', 'üèÜ');
                state.char.title = 'Zachr√°nce lidstva';
            } else if (nextQuestId) {
                // Automaticky nastav dal≈°√≠ quest
                const nextQuest = MAIN_QUESTS.find(q => q.id === nextQuestId);
                if (nextQuest) {
                    state.mainQuest.currentQuest = nextQuestId;
                    state.mainQuest.chapter = nextQuest.chapter;
                    
                    // Spawn quest item pokud je pot≈ôeba
                    if (nextQuest.spawnItem) {
                        const loc = WORLD_LOCATIONS.find(l => l.id === nextQuest.spawnItem.location);
                        if (loc) {
                            if (!state.world.questItems) state.world.questItems = {};
                            state.world.questItems[nextQuest.spawnItem.location] = nextQuest.spawnItem.id;
                            console.log(`üì¶ Quest item ${nextQuest.spawnItem.id} spawnut na lokaci ${nextQuest.spawnItem.location}`);
                        }
                    }
                }
                
                // Zobraz modal s informac√≠
                showModal('‚úÖ Quest dokonƒçen!', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                        <h3 style="color: #8bc34a;">${quest.title}</h3>
                        <p style="color: #999;">${choiceDialog || quest.dialog?.complete || 'Quest splnƒõn!'}</p>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #ffd700;">üéÅ Odmƒõna:</p>
                            <p>+${quest.reward.xp} XP${quest.reward.money ? `, +${quest.reward.money} üí∞` : ''}</p>
                        </div>
                        
                        ${nextQuestId ? (() => {
                            const nextQ = MAIN_QUESTS.find(q => q.id === nextQuestId);
                            const firstObj = nextQ?.objectives?.[0];
                            let locationHint = '';
                            if (firstObj?.type === 'location' && firstObj.target) {
                                const loc = WORLD_LOCATIONS.find(l => l.id === firstObj.target);
                                if (loc) locationHint = `<p style="color: #ff9800; margin: 0.5rem 0 0 0; font-size: 0.9rem;">üìç C√≠l: ${loc.name}</p>`;
                            }
                            return `
                            <div style="background: #1a2a3a; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #4a90d9;">
                                <p style="color: #4a90d9; margin: 0;">üìú Nov√Ω quest:</p>
                                <p style="color: #fff; margin: 0.5rem 0 0 0; font-weight: bold;">${nextQ?.title || 'Dal≈°√≠ √∫kol'}</p>
                                <p style="color: #aaa; margin: 0.3rem 0 0 0; font-size: 0.85rem;">${nextQ?.description || ''}</p>
                                ${locationHint}
                            </div>
                        `;
                        })() : ''}
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">‚úì OK</button>
                `);
            } else {
                // ≈Ω√°dn√Ω dal≈°√≠ quest
                state.mainQuest.currentQuest = null;
                showModal('‚úÖ Quest dokonƒçen!', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                        <h3 style="color: #8bc34a;">${quest.title}</h3>
                        <p style="color: #999;">${quest.dialog?.complete || 'Quest splnƒõn!'}</p>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="color: #ffd700;">üéÅ Odmƒõna:</p>
                            <p>+${quest.reward.xp} XP${quest.reward.money ? `, +${quest.reward.money} üí∞` : ''}</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">‚úì OK</button>
                `);
            }
            
            addLog('Quest dokonƒçen: ' + quest.title, '‚úÖ');
            renderFull();
        }
        
        function startNextQuest(questId) {
            if (!questId) return;
            
            const quest = MAIN_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            state.mainQuest.currentQuest = questId;
            state.mainQuest.chapter = quest.chapter;
            state.mainQuest.questProgress = {};
            
            showModal('üìú Nov√Ω quest!', `
                <div style="text-align: center;">
                    <p style="color: #ff9800; font-size: 0.9rem;">Kapitola ${quest.chapter}</p>
                    <h2 style="color: #d4722e; margin: 0.5rem 0;">${quest.title}</h2>
                    <p style="color: #999;">${quest.description}</p>
                    
                    ${quest.dialog?.start ? `
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-top: 1rem; font-style: italic; color: #aaa;">
                            "${quest.dialog.start}"
                        </div>
                    ` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">P≈ôijmout quest</button>
            `);
            
            addLog('Nov√Ω quest: ' + quest.title, 'üìú');
            
            // Spawn quest item pokud je pot≈ôeba
            if (quest.spawnItem) {
                // Najdi lokaci podle ID
                const loc = WORLD_LOCATIONS.find(l => l.id === quest.spawnItem.location);
                if (loc) {
                    // Ulo≈æ quest item do world lokace
                    if (!state.world.questItems) state.world.questItems = {};
                    state.world.questItems[quest.spawnItem.location] = quest.spawnItem.id;
                    console.log(`üì¶ Quest item ${quest.spawnItem.id} spawnut na lokaci ${quest.spawnItem.location}`);
                }
            }
        }
        
        function talkToNPC(npcId) {
            const npc = STORY_NPCS[npcId];
            if (!npc) return;
            
            const quest = getCurrentQuest();
            let dialogKey = 'first_meet';
            
            if (state.mainQuest?.npcMet?.includes(npcId)) {
                if (quest?.npc === npcId) {
                    dialogKey = 'quest_active';
                } else {
                    dialogKey = 'quest_complete';
                }
            }
            
            const dialogs = npc.dialogs[dialogKey] || npc.dialogs.first_meet;
            
            // Zajisti ≈æe dialogs je pole
            const dialogArray = Array.isArray(dialogs) ? dialogs : [dialogs];
            
            if (!state.mainQuest.npcMet) state.mainQuest.npcMet = [];
            if (!state.mainQuest.npcMet.includes(npcId)) {
                state.mainQuest.npcMet.push(npcId);
            }
            
            // Nastav quest progress pro location objective pokud je to NPC questu
            if (quest && quest.npc === npcId) {
                quest.objectives.forEach(obj => {
                    if (obj.type === 'location' && obj.target === npc.location) {
                        if (!state.mainQuest.questProgress) state.mainQuest.questProgress = {};
                        state.mainQuest.questProgress[obj.id] = 1;
                    }
                });
            }
            
            // === CHOICE QUEST CHECK ===
            // Pokud je aktivn√≠ isChoice quest a hr√°ƒç m√° po≈æadovan√Ω item, nab√≠dni p≈ôed√°n√≠
            if (quest?.isChoice && quest.requiresItem) {
                const hasItem = state.inv.some(i => i.id === quest.requiresItem);
                if (hasItem && (npcId === 'kory' || npcId === 'koudy')) {
                    // Uk√°≈æ dialog a pak nab√≠dni p≈ôed√°n√≠
                    showNPCDialogWithChoice(npc, dialogArray, 0, quest, npcId);
                    return;
                }
            }
            
            showNPCDialog(npc, dialogArray, 0);
        }
        
        // Dialog s mo≈ænost√≠ p≈ôed√°n√≠ quest itemu
        function showNPCDialogWithChoice(npc, dialogs, index, quest, npcId) {
            if (index >= dialogs.length) {
                // Po dialogu nab√≠dni p≈ôed√°n√≠
                showDeliveryChoice(npcId, quest);
                return;
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; min-height: 100px;">
                    <p style="font-size: 1.1rem; line-height: 1.6;">"${dialogs[index]}"</p>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                    <span style="color: #666;">${index + 1}/${dialogs.length}</span>
                    <button class="btn" onclick="showNPCDialogWithChoice(${JSON.stringify(npc).replace(/"/g, '&quot;')}, ${JSON.stringify(dialogs).replace(/"/g, '&quot;')}, ${index + 1}, ${JSON.stringify(quest).replace(/"/g, '&quot;')}, '${npcId}')" style="padding: 0.5rem 2rem;">
                        Dal≈°√≠ ‚Üí
                    </button>
                </div>
            `);
        }
        
        // Nab√≠dka p≈ôed√°n√≠ quest itemu
        function showDeliveryChoice(npcId, quest) {
            const npc = STORY_NPCS[npcId];
            const item = QUEST_ITEMS.find(i => i.id === quest.requiresItem);
            if (!item || !npc) {
                closeModal();
                return;
            }
            
            const otherNpcId = npcId === 'kory' ? 'koudy' : 'kory';
            const otherNpc = STORY_NPCS[otherNpcId];
            
            showModal(`${item.icon} P≈ôedat komponent?`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${item.icon}</div>
                    <h3 style="color: #ffd700;">${item.name}</h3>
                    <p style="color: #888; margin: 0.5rem 0;">M√°≈° komponent, kter√Ω ${npc.name} pot≈ôebuje.</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                    <p style="margin: 0; color: #8bc34a;"><strong>‚ö†Ô∏è D≈Øle≈æit√© rozhodnut√≠!</strong></p>
                    <p style="margin: 0.5rem 0 0 0; color: #aaa; font-size: 0.9rem;">
                        Komu d√°≈° ${item.name} ovlivn√≠ p≈ô√≠bƒõh.<br>
                        M≈Ø≈æe≈° j√≠t za ${otherNpc.icon} ${otherNpc.name} m√≠sto toho.
                    </p>
                </div>
                
                <button class="btn" onclick="deliverComponent('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, ${npcId === 'kory' ? '#c62828' : '#1565c0'} 0%, ${npcId === 'kory' ? '#8b0000' : '#0d47a1'} 100%);">
                    ${npc.icon} P≈ôedat ${npc.name}
                </button>
                <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    ‚úó Je≈°tƒõ ne
                </button>
            `);
        }
        
        // P≈ôed√°n√≠ komponenty NPC
        function deliverComponent(npcId) {
            const quest = getCurrentQuest();
            const npc = STORY_NPCS[npcId];
            
            if (!quest || !npc || !quest.isChoice) {
                closeModal();
                return;
            }
            
            // Odeber item z invent√°≈ôe
            const itemIndex = state.inv.findIndex(i => i.id === quest.requiresItem);
            if (itemIndex === -1) {
                notifyError('Chyba', ('Nem√°≈° pot≈ôebn√Ω p≈ôedmƒõt!'));
                closeModal();
                return;
            }
            
            const item = state.inv[itemIndex];
            if (item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            // Update quest progress
            state.mainQuest.questProgress = state.mainQuest.questProgress || {};
            quest.objectives.forEach(obj => {
                if (obj.type === 'choice') {
                    state.mainQuest.questProgress[obj.id] = 1;
                }
            });
            
            // Ulo≈æ volbu
            state.mainQuest.choiceMade = npcId;
            state.mainQuest.choices = state.mainQuest.choices || [];
            state.mainQuest.choices.push({ quest: quest.id, choice: npcId });
            
            // Aplikuj karma efekty
            const effect = quest.choiceEffects?.[npcId];
            if (effect?.karma) {
                state.storyKarma = state.storyKarma || {};
                Object.entries(effect.karma).forEach(([k, v]) => {
                    state.storyKarma[k] = (state.storyKarma[k] || 0) + v;
                });
            }
            
            // Log
            addLog(`P≈ôedal jsi ${QUEST_ITEMS.find(i => i.id === quest.requiresItem)?.name} ${npc.name}!`, npc.icon);
            
            // Zobraz reakci NPC
            const responseDialog = effect?.dialog || `${npc.name} p≈ôij√≠m√° komponent.`;
            
            closeModal();
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${npc.icon}</div>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                    <p style="font-size: 1.1rem; line-height: 1.6;">"${responseDialog}"</p>
                </div>
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                    <p style="margin: 0; color: #8bc34a;">‚úì Quest pokraƒçuje...</p>
                    <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                        Karma ${npc.name}: ${effect?.karma?.[npcId] > 0 ? '+' : ''}${effect?.karma?.[npcId] || 0}
                    </p>
                </div>
                <button class="btn" onclick="closeModal(); checkQuestComplete(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">
                    ‚úì Pokraƒçovat
                </button>
            `);
            
            saveGame();
        }
        
        function showNPCDialog(npc, dialogs, index) {
            if (index >= dialogs.length) {
                closeModal();
                checkQuestComplete();
                return;
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; min-height: 100px;">
                    <p style="font-size: 1.1rem; line-height: 1.6;">"${dialogs[index]}"</p>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                    <span style="color: #666;">${index + 1}/${dialogs.length}</span>
                    <button class="btn" onclick="showNPCDialog(${JSON.stringify(npc).replace(/"/g, '&quot;')}, ${JSON.stringify(dialogs).replace(/"/g, '&quot;')}, ${index + 1})" style="padding: 0.5rem 2rem;">
                        ${index < dialogs.length - 1 ? 'Dal≈°√≠ ‚Üí' : 'Zav≈ô√≠t'}
                    </button>
                </div>
            `);
        }
        
        function checkForNPCAtLocation() {
            const currentLocation = state.world.currentLocation;
            
            for (const [npcId, npc] of Object.entries(STORY_NPCS)) {
                // Nov√Ω syst√©m - NPC maj√≠ location jako string ID
                if (npc.location === currentLocation) {
                    // Je tu NPC
                    setTimeout(() => {
                        showModal(`${npc.icon} Setk√°n√≠!`, `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">${npc.icon}</div>
                                <h3>${npc.name}</h3>
                                <p style="color: #999;">Na≈°el jsi nƒõkoho!</p>
                            </div>
                            <button class="btn" onclick="talkToNPC('${npcId}')" style="width: 100%; margin-top: 1rem;">üó£Ô∏è Promluvit</button>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Ignorovat</button>
                        `);
                    }, 500);
                    return true;
                }
            }
            
            // Kontrola quest itemu - pou≈æij nov√Ω syst√©m
            if (state.world.questItems?.[currentLocation]) {
                const itemId = state.world.questItems[currentLocation];
                const item = QUEST_ITEMS.find(i => i.id === itemId);
                if (item && !state.inv.some(i => i.id === itemId)) {
                    setTimeout(() => {
                        showModal(`üì¶ N√°lez!`, `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">${item.icon}</div>
                                <h3 style="color: #ffd700;">${item.name}</h3>
                                <p style="color: #999;">${item.desc}</p>
                            </div>
                            <button class="btn" onclick="pickupQuestItem('${itemId}')" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">‚úì Vz√≠t</button>
                        `);
                    }, 500);
                    return true;
                }
            }
            
            return false;
        }
        
        function pickupQuestItem(itemId) {
            const item = QUEST_ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            state.inv.push({...item, count: 1});
            
            // Odeber z aktu√°ln√≠ lokace (nov√Ω syst√©m)
            const currentLocation = state.world.currentLocation;
            if (state.world.questItems?.[currentLocation]) {
                delete state.world.questItems[currentLocation];
            }
            
            closeModal();
            addLog('Z√≠skal jsi: ' + item.name, item.icon);
            updateQuestProgress('item', itemId);
        }
        
        // === CUSTOMIZACE POSTAVY ===
        function openCustomization() {
            const currentHair = HAIRSTYLES.find(h => h.id === state.appearance?.hairstyle) || HAIRSTYLES[1];
            const currentHairColor = HAIR_COLORS.find(c => c.id === state.appearance?.hairColor) || HAIR_COLORS[1];
            const currentSkin = SKIN_TONES.find(s => s.id === state.appearance?.skinTone) || SKIN_TONES[2];
            const currentOutfit = OUTFITS.find(o => o.id === state.appearance?.outfit) || OUTFITS[0];
            const currentTitle = TITLES.find(t => t.id === state.appearance?.title) || TITLES[0];
            
            showModal('üé® Customizace postavy', `
                <div style="max-height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- Avatar Preview -->
                    <div style="text-align: center; background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">${currentHair.icon}</div>
                        <h3 style="margin: 0.5rem 0 0 0;">${state.char.name}</h3>
                        <p style="color: #ffd700; margin: 0;">${currentTitle.name}</p>
                        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.5rem;">
                            ${(state.badges || []).slice(0, 5).map(b => {
                                const badge = BADGES.find(ba => ba.id === b);
                                return badge ? `<span title="${badge.name}">${badge.icon}</span>` : '';
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Hairstyle -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">üíá √öƒçes</h4>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.3rem;">
                            ${HAIRSTYLES.map(h => `
                                <button onclick="setAppearance('hairstyle', '${h.id}')" 
                                    style="padding: 0.5rem; font-size: 1.5rem; border-radius: 8px; border: 2px solid ${h.id === state.appearance?.hairstyle ? '#ffd700' : '#333'}; background: #2a2a2a; cursor: pointer;">
                                    ${h.icon}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Hair Color -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">üé® Barva vlas≈Ø</h4>
                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                            ${HAIR_COLORS.map(c => `
                                <button onclick="setAppearance('hairColor', '${c.id}')" 
                                    style="width: 30px; height: 30px; border-radius: 50%; border: 3px solid ${c.id === state.appearance?.hairColor ? '#ffd700' : '#333'}; background: ${c.color}; cursor: pointer;">
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Skin Tone -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">üë§ Odst√≠n pleti</h4>
                        <div style="display: flex; gap: 0.3rem;">
                            ${SKIN_TONES.map(s => `
                                <button onclick="setAppearance('skinTone', '${s.id}')" 
                                    style="width: 40px; height: 40px; border-radius: 8px; border: 3px solid ${s.id === state.appearance?.skinTone ? '#ffd700' : '#333'}; background: ${s.color}; cursor: pointer;">
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Outfit -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">üëï Obleƒçen√≠</h4>
                        <div style="display: grid; gap: 0.3rem;">
                            ${OUTFITS.map(o => {
                                const unlocked = state.unlockedOutfits?.includes(o.id) || o.id === 'survivor';
                                return `
                                    <button onclick="${unlocked ? `setAppearance('outfit', '${o.id}')` : ''}" 
                                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 8px; border: 2px solid ${o.id === state.appearance?.outfit ? '#ffd700' : '#333'}; background: ${unlocked ? '#2a2a2a' : '#1a1a1a'}; cursor: ${unlocked ? 'pointer' : 'not-allowed'}; opacity: ${unlocked ? 1 : 0.5};">
                                        <span style="font-size: 1.5rem;">${o.icon}</span>
                                        <div style="text-align: left;">
                                            <div>${o.name}</div>
                                            <div style="font-size: 0.75rem; color: #999;">${unlocked ? o.desc : 'üîí Zamƒçeno'}</div>
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0;">üè∑Ô∏è Titul</h4>
                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                            ${TITLES.map(t => {
                                const unlocked = state.unlockedTitles?.includes(t.id) || t.id === 'survivor';
                                return `
                                    <button onclick="${unlocked ? `setAppearance('title', '${t.id}')` : ''}" 
                                        style="padding: 0.4rem 0.8rem; border-radius: 15px; border: 2px solid ${t.id === state.appearance?.title ? '#ffd700' : '#333'}; background: ${unlocked ? '#2a2a2a' : '#1a1a1a'}; cursor: ${unlocked ? 'pointer' : 'not-allowed'}; opacity: ${unlocked ? 1 : 0.5}; font-size: 0.85rem;">
                                        ${unlocked ? t.name : 'üîí'}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Badges -->
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0;">üéñÔ∏è Odznaky (${state.badges?.length || 0}/${BADGES.length})</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${BADGES.map(b => {
                                const earned = state.badges?.includes(b.id);
                                return `
                                    <div title="${b.name}: ${b.desc}" style="padding: 0.5rem; border-radius: 8px; background: ${earned ? '#2a3a2a' : '#1a1a1a'}; border: 2px solid ${earned ? '#4caf50' : '#333'}; opacity: ${earned ? 1 : 0.4};">
                                        <span style="font-size: 1.5rem;">${b.icon}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `);
        }
        
        function setAppearance(key, value) {
            state.appearance = state.appearance || {};
            state.appearance[key] = value;
            openCustomization(); // Refresh
        }
        
        function checkUnlocks() {
            // Check outfit unlocks
            if (state.stats.kills >= 50 && !state.unlockedOutfits?.includes('military')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('military');
                addLog('Odemknuto obleƒçen√≠: Vojensk√©!', 'üéñÔ∏è');
            }
            if (state.mainQuest?.chapter >= 2 && !state.unlockedOutfits?.includes('scientist')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('scientist');
                addLog('Odemknuto obleƒçen√≠: Vƒõdeck√©!', 'ü•º');
            }
            if ((state.stats?.kills || 0) >= 100 && !state.unlockedOutfits?.includes('raider')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('raider');
                addLog('Odemknuto obleƒçen√≠: N√°jezdnick√©!', 'üíÄ');
            }
            if (state.mainQuest?.storyComplete && !state.unlockedOutfits?.includes('hero')) {
                state.unlockedOutfits = state.unlockedOutfits || ['survivor'];
                state.unlockedOutfits.push('hero');
                addLog('Odemknuto obleƒçen√≠: Hrdinsk√©!', 'ü¶∏');
            }
            
            // Check title unlocks
            if (state.stats.travelled >= 50 && !state.unlockedTitles?.includes('explorer')) {
                state.unlockedTitles = state.unlockedTitles || ['survivor'];
                state.unlockedTitles.push('explorer');
                addLog('Odemknut titul: Pr≈Øzkumn√≠k!', 'üó∫Ô∏è');
            }
            if (state.stats.kills >= 100 && !state.unlockedTitles?.includes('warrior')) {
                state.unlockedTitles = state.unlockedTitles || ['survivor'];
                state.unlockedTitles.push('warrior');
                addLog('Odemknut titul: V√°leƒçn√≠k!', '‚öîÔ∏è');
            }
            
            // Check badges
            if (state.stats.kills >= 1 && !state.badges?.includes('first_blood')) {
                state.badges = state.badges || [];
                state.badges.push('first_blood');
                showBadgeEarned(BADGES.find(b => b.id === 'first_blood'));
            }
            if (state.stats.bossKills >= 1 && !state.badges?.includes('boss_slayer')) {
                state.badges = state.badges || [];
                state.badges.push('boss_slayer');
                showBadgeEarned(BADGES.find(b => b.id === 'boss_slayer'));
            }
        }
        
        function showBadgeEarned(badge) {
            if (!badge) return;
            
            if (isInCombat()) {
                notifySuccess(`üéñÔ∏è ${badge.name}`, badge.desc);
                return;
            }
            
            showModal('üéñÔ∏è Odznak z√≠sk√°n!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${badge.icon}</div>
                    <h3 style="color: #ffd700;">${badge.name}</h3>
                    <p style="color: #999;">${badge.desc}</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${currentLang === "en" ? "Great!" : "Skvƒõl√©!"}</button>
            `);
        }
        
        // === SKILL TREE ===
        function openSkillTree() {
            const points = state.skillTreePoints || 0;
            
            showModal('üå≥ Strom schopnost√≠', `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="color: #ffd700; font-size: 1.1rem;">‚≠ê Body: <strong>${points}</strong></span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                    ${Object.entries(SKILL_TREE).map(([key, branch]) => `
                        <button onclick="showSkillBranch('${key}')" class="btn" style="padding: 0.8rem; background: ${branch.color}; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem;">
                            <span style="font-size: 1.5rem;">${branch.icon}</span>
                            <span>${branch.name}</span>
                        </button>
                    `).join('')}
                </div>
                
                <div id="skillBranchContent">
                    <p style="text-align: center; color: #666;">${'Vyber vƒõtev schopnost√≠'}</p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function showSkillBranch(branchId) {
            const branch = SKILL_TREE[branchId];
            if (!branch) return;
            
            const points = state.skillTreePoints || 0;
            const branchSkills = state.skillTree?.[branchId] || {};
            
            // Group skills by tier
            const tiers = [1, 2, 3, 4];
            
            document.getElementById('skillBranchContent').innerHTML = `
                <div style="background: linear-gradient(135deg, ${branch.color}22, ${branch.color}11); padding: 1rem; border-radius: 8px; border-left: 4px solid ${branch.color};">
                    <h3 style="margin: 0 0 1rem 0;">${branch.icon} ${branch.name}</h3>
                    
                    ${tiers.map(tier => {
                        const tierSkills = branch.skills.filter(s => s.tier === tier);
                        if (tierSkills.length === 0) return '';
                        
                        return `
                            <div style="margin-bottom: 1rem;">
                                <div style="color: #666; font-size: 0.8rem; margin-bottom: 0.3rem;">${'Tier'} ${tier}</div>
                                <div style="display: grid; gap: 0.5rem;">
                                    ${tierSkills.map(skill => {
                                        const level = branchSkills[skill.id] || 0;
                                        const maxed = level >= skill.maxLevel;
                                        
                                        // Check if requirements met
                                        let canUnlock = true;
                                        if (skill.requires) {
                                            canUnlock = (branchSkills[skill.requires] || 0) > 0;
                                        }
                                        
                                        const canUpgrade = points > 0 && !maxed && canUnlock;
                                        
                                        return `
                                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #2a2a2a; border-radius: 8px; opacity: ${canUnlock ? 1 : 0.5}; border: 2px solid ${maxed ? '#ffd700' : level > 0 ? '#4caf50' : '#333'};">
                                                <div style="font-size: 1.5rem;">${skill.icon}</div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: bold;">${skill.name}</div>
                                                    <div style="font-size: 0.8rem; color: #999;">${skill.desc}</div>
                                                    <div style="font-size: 0.75rem; color: ${maxed ? '#ffd700' : '#4caf50'};">
                                                        ${'Level:'} ${level}/${skill.maxLevel}
                                                    </div>
                                                </div>
                                                <button onclick="upgradeSkillTree('${branchId}', '${skill.id}')" 
                                                    class="btn" 
                                                    style="padding: 0.3rem 0.6rem; font-size: 0.8rem; ${canUpgrade ? '' : 'opacity: 0.5; cursor: not-allowed;'}"
                                                    ${canUpgrade ? '' : 'disabled'}>
                                                    ${maxed ? '‚úì' : '+'}
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function upgradeSkillTree(branchId, skillId) {
            if ((state.skillTreePoints || 0) <= 0) return;
            
            const branch = SKILL_TREE[branchId];
            const skill = branch?.skills.find(s => s.id === skillId);
            if (!skill) return;
            
            state.skillTree = state.skillTree || {};
            state.skillTree[branchId] = state.skillTree[branchId] || {};
            
            const currentLevel = state.skillTree[branchId][skillId] || 0;
            if (currentLevel >= skill.maxLevel) return;
            
            // Check requirements
            if (skill.requires) {
                const reqLevel = state.skillTree[branchId][skill.requires] || 0;
                if (reqLevel <= 0) return;
            }
            
            state.skillTree[branchId][skillId] = currentLevel + 1;
            state.skillTreePoints--;
            
            notifySuccess('Vylep≈°eno!', skill.name + ' ' + (currentLevel + 1) + '/' + skill.maxLevel);
            addLog('Vylep≈°eno: ' + skill.name + ' (' + (currentLevel + 1) + '/' + skill.maxLevel + ')', skill.icon);
            
            // Aktualizuj nosnost pokud se zmƒõnil pack_rat skill
            if (skill.effect?.carryWeight) {
                updateCarryWeight();
            }
            
            // Refresh cel√Ω skill tree modal
            openSkillTree();
            // Pak znovu zobraz vƒõtev
            setTimeout(() => showSkillBranch(branchId), 50);
        }
        
        function getSkillTreeBonus(effectKey) {
            let total = 0;
            
            for (const [branchId, branch] of Object.entries(SKILL_TREE)) {
                const branchSkills = state.skillTree?.[branchId] || {};
                
                for (const skill of branch.skills) {
                    const level = branchSkills[skill.id] || 0;
                    if (level > 0 && skill.effect[effectKey]) {
                        total += skill.effect[effectKey] * level;
                    }
                }
            }
            
            return total;
        }
        
        // Speci√°ln√≠ efekty brnƒõn√≠
        // === DETAILN√ç POPISY SPECI√ÅLN√çCH EFEKT≈Æ ===
        const SPECIAL_EFFECT_DETAILS = {
            // Armor
            'powered': { name: 'Pohon', effects: ['+5 obrana', '+5 √∫tok'], color: '#ffd700' },
            'stealth': { name: 'Stealth', effects: ['-50% ≈°ance na n√°hodn√Ω souboj', '+15% dodge'], color: '#9c27b0' },
            'berserker': { name: 'Berserker', effects: ['+30% obrany jako √∫tok', '-3 obrana'], color: '#f44336' },
            'phoenix': { name: 'F√©nix', effects: ['1x za boj: P≈ôe≈æije≈° smrteln√Ω z√°sah s 1 HP'], color: '#ff9800' },
            'titan': { name: 'Tit√°n', effects: ['+5 obrana', 'Imunita na kritick√© z√°sahy'], color: '#2196f3' },
            'scout': { name: 'Zvƒõd', effects: ['+15% dodge'], color: '#4caf50' },
            'medic': { name: 'Medik', effects: ['+50% efektivita l√©ƒçen√≠'], color: '#e91e63' },
            'mutant': { name: 'Mutant', effects: ['-50% radiace'], color: '#8bc34a' },
            'exo': { name: 'Exoskeleton', effects: ['+10% celkov√Ω damage'], color: '#ff5722' },
            'nano': { name: 'Nano', effects: ['+2 HP regenerace za kolo v boji'], color: '#00bcd4' },
            'intimidate': { name: 'Zastra≈°en√≠', effects: ['+2 √∫tok'], color: '#795548' },
            'scavenger': { name: 'Sbƒõraƒç', effects: ['+25% loot'], color: '#607d8b' },
            'camo': { name: 'Kamufl√°≈æ', effects: ['-30% ≈°ance na n√°hodn√Ω souboj'], color: '#3f51b5' },
            'nightvision': { name: 'Noƒçn√≠ vidƒõn√≠', effects: ['Bonus v noci', '≈Ω√°dn√Ω postih ve tmƒõ'], color: '#1a237e' },
            'agile': { name: 'Hbitost', effects: ['+10% dodge'], color: '#00e676' },
            'endurance': { name: 'V√Ωdr≈æ', effects: ['-30% spot≈ôeba energie p≈ôi cestov√°n√≠'], color: '#ff7043' },
            'block': { name: 'Blok', effects: ['+15% ≈°ance na blok'], color: '#5d4037' },
            'rad_resist': { name: 'Proti-rad', effects: ['-30% radiace'], color: '#ffeb3b' },
            'rad_immune': { name: 'Rad. ochrana', effects: ['-50% radiace'], color: '#76ff03' },
            // Gloves
            'block_bonus': { name: 'Blokov√°n√≠', effects: ['+10% ≈°ance na blok'], color: '#5d4037' },
            'unarmed_bonus': { name: 'Boj beze zbranƒõ', effects: ['+5 damage bez zbranƒõ'], color: '#ff5722' },
            'grip': { name: 'Pevn√Ω √∫chop', effects: ['+10% p≈ôesnost st≈ôelby', '+2 damage'], color: '#607d8b' },
            'bleed_punch': { name: 'Krvav√Ω √∫der', effects: ['√ötok pƒõst√≠ zp≈Øsob√≠ krv√°cen√≠', '+3 damage'], color: '#c62828' },
            'power_punch': { name: 'Silov√Ω √∫der', effects: ['+10 damage v boji zbl√≠zka'], color: '#d32f2f' },
            'medic_bonus': { name: 'Chirurg', effects: ['+20% efektivita l√©ƒçen√≠'], color: '#e91e63' },
            // Boots
            'dodge_bonus': { name: '√öhyb', effects: ['+10% dodge'], color: '#4caf50' },
            'speed_bonus': { name: 'Rychlost', effects: ['+2% rychlost cestov√°n√≠'], color: '#2196f3' },
            'stealth_move': { name: 'Tich√Ω pohyb', effects: ['-20% ≈°ance na p≈ôepaden√≠'], color: '#9c27b0' },
            'run_bonus': { name: 'Bƒõ≈æec', effects: ['+15% ≈°ance na √∫tƒõk z boje'], color: '#03a9f4' },
            'stomp': { name: 'Dupnut√≠', effects: ['+8 damage kopem'], color: '#795548' },
            'jump': { name: 'Skok', effects: ['+25% dodge', 'Vysok√Ω v√Ωskok'], color: '#ffc107' },
            'warm_feet': { name: 'Tepl√© nohy', effects: ['-15% spot≈ôeba energie'], color: '#ff7043' },
            'power_kick': { name: 'Silov√Ω kop', effects: ['+20% rychlost', '+10 obrana'], color: '#e65100' }
        };
        
        // Funkce pro zobrazen√≠ detailu speci√°ln√≠ho efektu
        function showSpecialEffectDetail(special) {
            const detail = SPECIAL_EFFECT_DETAILS[special];
            if (!detail) {
                showModal('‚ùì Nezn√°m√Ω efekt', `<p>Efekt "${special}" nem√° popis.</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>`);
                return;
            }
            
            let effectsHtml = detail.effects.map(e => `<div style="padding: 0.3rem 0; border-bottom: 1px solid #333;">‚úì ${e}</div>`).join('');
            
            showModal(`‚ú® ${detail.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="display: inline-block; padding: 0.5rem 1rem; background: ${detail.color}33; border: 2px solid ${detail.color}; border-radius: 8px; color: ${detail.color}; font-weight: bold;">
                        ${detail.name}
                    </div>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üìä Efekty:</h4>
                    ${effectsHtml}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
            `);
        }
        
        function getArmorSpecialEffects() {
            const effects = {
                bonusDefense: 0,
                bonusDamage: 0,
                bonusDodge: 0,
                bonusBlock: 0,
                radResist: 0,
                healBonus: 0,
                lootBonus: 0,
                xpBonus: 0,
                regenPerTurn: 0,
                encounterReduction: 0,
                energySaver: 0,
                speedBonus: 0,
                escapeBonus: 0,
                carryBonus: 0,
                critBonus: 0,
                damageMultiplier: 1.0,
                phoenix: false,
                stealth: false,
                nightBonus: false,
                critImmune: false
            };
            
            // Kontroluj armor, helmet, gloves a boots
            const equipment = [
                state.equipped?.armor,
                state.equipped?.helmet,
                state.equipped?.gloves,
                state.equipped?.boots
            ].filter(e => e && e.special);
            
            equipment.forEach(item => {
                switch (item.special) {
                    // Armor efekty
                    case 'powered': effects.bonusDefense += 5; effects.bonusDamage += 5; break;
                    case 'stealth': effects.stealth = true; effects.encounterReduction += 0.5; effects.bonusDodge += 0.15; break;
                    case 'berserker': effects.bonusDamage += Math.floor((item.defense || 0) * 0.3); effects.bonusDefense -= 3; break;
                    case 'phoenix': effects.phoenix = true; break;
                    case 'titan': effects.bonusDefense += 5; effects.critImmune = true; break;
                    case 'scout': effects.bonusDodge += 0.15; break;
                    case 'medic': effects.healBonus += 0.5; break;
                    case 'mutant': effects.radResist += 0.5; break;
                    case 'exo': effects.damageMultiplier = 1.1; break; // +10% damage
                    case 'nano': effects.regenPerTurn += 2; break;
                    case 'intimidate': effects.bonusDamage += 2; break;
                    case 'scavenger': effects.lootBonus += 0.25; break;
                    case 'camo': effects.encounterReduction += 0.3; break;
                    case 'nightvision': effects.nightBonus = true; break;
                    case 'agile': effects.bonusDodge += 0.1; break;
                    case 'endurance': effects.energySaver += 0.3; break;
                    case 'block': effects.bonusBlock += 0.15; break;
                    case 'rad_resist': effects.radResist += 0.3; break;
                    case 'rad_immune': effects.radResist += 1.0; break;
                    // Gloves efekty
                    case 'block_bonus': effects.bonusBlock += 0.1; break;
                    case 'unarmed_bonus': effects.bonusDamage += 5; break; // +5 damage beze zbranƒõ
                    case 'grip': effects.bonusDamage += 2; break; // +10% p≈ôesnost = +2 dmg
                    case 'bleed_punch': effects.bonusDamage += 3; break; // krv√°cen√≠
                    case 'power_punch': effects.bonusDamage += 10; break;
                    case 'medic_bonus': effects.healBonus += 0.2; break;
                    // Boots efekty
                    case 'dodge_bonus': effects.bonusDodge += 0.1; break;
                    case 'speed_bonus': effects.speedBonus += 0.02; break;
                    case 'stealth_move': effects.encounterReduction += 0.2; break;
                    case 'run_bonus': effects.escapeBonus += 0.15; break;
                    case 'stomp': effects.bonusDamage += 8; break;
                    case 'jump': effects.bonusDodge += 0.25; break;
                    case 'warm_feet': effects.energySaver += 0.15; break;
                    case 'power_kick': effects.speedBonus += 0.04; effects.bonusDefense += 10; break;
                    case 'exo': effects.damageMultiplier = 1.1; effects.carryBonus = 0.5; break;
                    case 'sturdy': effects.bonusDefense += 2; break;
                    case 'combat_stance': effects.critBonus = 0.05; break; // +5% crit
                    case 'light_feet': effects.speedBonus += 0.01; break; // +1% rychlost
                }
            });
            
            // Bonusy z n√°stroj≈Ø v invent√°≈ôi
            if (state.inv) {
                // Dalekohled - sni≈æuje ≈°anci na p≈ôepaden√≠ (vid√≠≈° nep≈ô√°tele d≈ô√≠v)
                if (state.inv.some(i => i.bonus === 'vision')) {
                    effects.encounterReduction += 0.15;
                }
                // Lano - bonus k √∫tƒõku
                if (state.inv.some(i => i.bonus === 'escape')) {
                    effects.escapeBonus += 0.2;
                }
            }
            
            return effects;
        }
        
        // === VOZIDLA ===
        // === KOMPANIONI ===
        // Adopce psa p≈ôi prvn√≠ cestƒõ
        function adoptDog() {
            const dogCompanion = COMPANIONS.find(c => c.id === 'dog');
            if (!dogCompanion) return;
            
            // P≈ôidej psa jako kompaniona s kompletn√≠mi atributy
            state.companions = state.companions || [];
            state.companions.push({
                id: dogCompanion.id,
                name: dogCompanion.name,
                icon: dogCompanion.icon,
                type: dogCompanion.type || 'animal',
                hp: dogCompanion.hp,
                maxHp: dogCompanion.hp,
                damage: dogCompanion.damage || 8,
                defense: dogCompanion.defense || 3,
                level: 1,
                xp: 0,
                skillPoints: 0,
                skills: [],
                loyalty: 60,
                inCombat: true
            });
            
            closeModal();
            addLog('üêï Vƒõrn√Ω pes se p≈ôipojil k tobƒõ!', 'üêï');
            showModal('üéâ Nov√Ω spoleƒçn√≠k!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">üêï</div>
                </div>
                <p style="color: var(--warning-yellow); font-weight: bold; text-align: center; font-size: 1.2rem;">Vƒõrn√Ω pes se p≈ôipojil k tobƒõ!</p>
                <p style="text-align: center; margin: 1rem 0;">Pes radostnƒõ sk√°ƒçe kolem tebe. Koneƒçnƒõ m√° zase p√°na!</p>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--toxic-dark);">
                    <p style="margin: 0.3rem 0; color: var(--toxic-green);"><strong>üîç ƒåmuchal</strong></p>
                    <p style="margin: 0.3rem 0; font-size: 0.85rem; color: #aaa;">+25% ≈°ance naj√≠t vz√°cnƒõj≈°√≠ p≈ôedmƒõty p≈ôi pr≈Øzkumu</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%;">‚úì ' + ('Skvƒõl√©!') + '</button>
            `);
            renderFull();
        }
        
        function showReviveCompanionModal() {
            const deadCompanion = state.companions?.find(c => c.isDead);
            if (!deadCompanion) {
                showModal('≈Ω√°dn√Ω mrtv√Ω spoleƒçn√≠k', 'V≈°ichni tvoji spoleƒçn√≠ci jsou na≈æivu!');
                return;
            }
            
            const compInfo = COMPANIONS.find(c => c.id === deadCompanion.id) || deadCompanion;
            const compName = deadCompanion.name || compInfo?.name || 'Spoleƒçn√≠k';
            const compIcon = deadCompanion.icon || compInfo?.icon || 'üë§';
            
            const reviveCost = compInfo?.cost > 0 ? Math.floor(compInfo.cost / 2) : 100;
            const hasMedkit = state.inv.find(i => i.id === 'medkit');
            const hasMoney = state.money >= reviveCost;
            
            showModal('üíÄ Mrtv√Ω spoleƒçn√≠k', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; opacity: 0.5;">${compIcon}</div>
                    <h3 style="color: #888;">${compName}</h3>
                    <p style="color: #c62828;">‚ò†Ô∏è Padl v boji</p>
                </div>
                <p style="margin-bottom: 1rem; text-align: center; color: #888;">Tv≈Øj spoleƒçn√≠k padl v boji. M≈Ø≈æe≈° ho o≈æivit nebo se s n√≠m rozlouƒçit.</p>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--warning-yellow);">Mo≈ænosti o≈æiven√≠:</h4>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="reviveCompanionWithMedkit('${deadCompanion.uniqueId || deadCompanion.id}')" 
                            style="flex: 1; background: ${hasMedkit ? '#4caf50' : '#555'};" ${!hasMedkit ? 'disabled' : ''}>
                            üíä L√©k√°rniƒçka ${hasMedkit ? '‚úì' : '(nem√°≈°)'}
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="reviveCompanionWithMoney('${deadCompanion.uniqueId || deadCompanion.id}', ${reviveCost})" 
                            style="flex: 1; background: ${hasMoney ? 'var(--warning-yellow)' : '#555'}; color: ${hasMoney ? '#000' : '#888'};" ${!hasMoney ? 'disabled' : ''}>
                            üí∞ ${reviveCost} penƒõz ${hasMoney ? '‚úì' : '(nem√°≈°)'}
                        </button>
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a2a2a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #c62828;">Nebo se rozlouƒçit:</h4>
                    <button class="btn" onclick="buryCompanion('${deadCompanion.uniqueId || deadCompanion.id}')" 
                        style="width: 100%; background: #4a2a2a; color: #c62828;">
                        ‚ö∞Ô∏è Poh≈ôb√≠t ${compName}
                    </button>
                    <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">Spoleƒçn√≠k bude odstranƒõn natrvalo</p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">‚Üê Zav≈ô√≠t</button>
            `);
        }
        
        function buryCompanion(companionId) {
            const compIndex = state.companions?.findIndex(c => (c.uniqueId === companionId || c.id === companionId) && c.isDead);
            if (compIndex === -1 || compIndex === undefined) {
                notifyWarning('Chyba', 'Spoleƒçn√≠k nenalezen');
                return;
            }
            
            const comp = state.companions[compIndex];
            const compInfo = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compName = comp.name || compInfo?.name || 'Spoleƒçn√≠k';
            const compIcon = comp.icon || compInfo?.icon || 'üë§';
            
            // Odstra≈à spoleƒçn√≠ka
            state.companions.splice(compIndex, 1);
            
            closeModal();
            addLog(`‚ö∞Ô∏è ${compName} byl poh≈ôben. Odpoƒç√≠vej v pokoji.`, 'üíÄ');
            
            showModal('‚ö∞Ô∏è Sbohem', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; opacity: 0.3;">${compIcon}</div>
                    <h3 style="color: #888;">${compName}</h3>
                    <p style="color: #666; font-style: italic; margin: 1rem 0;">"Odpoƒç√≠vej v pokoji, vƒõrn√Ω p≈ô√≠teli."</p>
                    <p style="color: #555; font-size: 0.85rem;">Spoleƒçn√≠k byl poh≈ôben a odstranƒõn z tv√© skupiny.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚úì Zav≈ô√≠t</button>
            `);
            renderFull();
        }
        
        function reviveCompanionWithMedkit(companionId) {
            const comp = state.companions?.find(c => (c.uniqueId === companionId || c.id === companionId) && c.isDead);
            if (!comp) return;
            
            const medkit = state.inv.find(i => i.id === 'medkit');
            if (!medkit) {
                showModal('Chyb√≠ l√©k√°rniƒçka', 'Nem√°≈° l√©k√°rniƒçku!');
                return;
            }
            
            // Spot≈ôebuj l√©k√°rniƒçku
            if (medkit.count > 1) {
                medkit.count--;
            } else {
                state.inv = state.inv.filter(i => i.id !== 'medkit');
            }
            
            // O≈æivit spoleƒçn√≠ka
            const compInfo = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compName = comp.name || compInfo?.name || 'Spoleƒçn√≠k';
            const compIcon = comp.icon || compInfo?.icon || 'üë§';
            const maxHp = comp.maxHp || compInfo?.hp || 50;
            
            comp.isDead = false;
            comp.hp = Math.floor(maxHp / 2); // O≈æiv√≠ se s polovinou HP
            comp.lastFed = false; // Reset - bude pot≈ôeba nakrmit
            comp.lastWatered = false; // Reset - bude pot≈ôeba napojit
            
            closeModal();
            addLog(`üíä ${compName} byl o≈æiven l√©k√°rniƒçkou!`, 'üíö');
            showModal('üíö Spoleƒçn√≠k o≈æiven!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${compIcon}</div>
                    <h3 style="color: var(--toxic-green);">${compName} je zpƒõt!</h3>
                    <p style="color: #888;">HP: ${comp.hp}/${maxHp}</p>
                    <p style="color: #ff9800; font-size: 0.85rem;">üçñ Nakrm ho a napoj!</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì Skvƒõl√©!</button>
            `);
            renderFull();
        }
        
        function reviveCompanionWithMoney(companionId, cost) {
            const comp = state.companions?.find(c => (c.uniqueId === companionId || c.id === companionId) && c.isDead);
            if (!comp) return;
            
            if (state.money < cost) {
                showModal(t('notifications', 'notEnoughMoney'), `Pot≈ôebuje≈° ${cost} penƒõz!`);
                return;
            }
            
            // Zapla≈•
            state.money -= cost;
            
            // O≈æivit spoleƒçn√≠ka
            const compInfo = COMPANIONS.find(c => c.id === comp.id) || comp;
            const compName = comp.name || compInfo?.name || 'Spoleƒçn√≠k';
            const compIcon = comp.icon || compInfo?.icon || 'üë§';
            const maxHp = comp.maxHp || compInfo?.hp || 50;
            
            comp.isDead = false;
            comp.hp = maxHp; // Pln√© HP za pen√≠ze
            comp.lastFed = false; // Reset - bude pot≈ôeba nakrmit
            comp.lastWatered = false; // Reset - bude pot≈ôeba napojit
            
            closeModal();
            addLog(`üí∞ ${compName} byl o≈æiven za ${cost} penƒõz!`, 'üíö');
            showModal('üíö Spoleƒçn√≠k o≈æiven!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${compIcon}</div>
                    <h3 style="color: var(--toxic-green);">${compName} je zpƒõt!</h3>
                    <p style="color: #888;">HP: ${comp.hp}/${maxHp} (pln√© zdrav√≠)</p>
                    <p style="color: var(--warning-yellow);">-${cost} üí∞</p>
                    <p style="color: #ff9800; font-size: 0.85rem;">üçñ Nakrm ho a napoj!</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì Skvƒõl√©!</button>
            `);
            renderFull();
        }
        
        function rescueCompanion(companionId) {
            const companion = COMPANIONS.find(c => c.id === companionId);
            if (!companion) return;
            
            // Pot≈ôebuje l√©k√°rniƒçku
            const medkit = state.inv.find(i => i.id === 'medkit');
            if (!medkit) {
                showModal('Chyb√≠ l√©k√°rniƒçka', 'Pot≈ôebuje≈° l√©k√°rniƒçku k vyl√©ƒçen√≠!');
                return;
            }
            
            // Spot≈ôebuj l√©k√°rniƒçku
            if (medkit.count > 1) {
                medkit.count--;
            } else {
                state.inv = state.inv.filter(i => i.id !== 'medkit');
            }
            
            // P≈ôidej kompaniona s kompletn√≠mi atributy
            state.companions = state.companions || [];
            state.companions.push({
                id: companion.id,
                name: companion.name,
                icon: companion.icon,
                type: companion.type || 'animal',
                hp: companion.hp,
                maxHp: companion.hp,
                damage: companion.damage || 10,
                defense: companion.defense || 5,
                level: 1,
                xp: 0,
                skillPoints: 0,
                skills: [],
                loyalty: 50,
                inCombat: true,
                equipped: companion.type === 'human' ? { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null } : null,
                canEquip: companion.type === 'human'
            });
            
            closeModal();
            addLog(companion.name + ' se p≈ôipojil k tobƒõ!', companion.icon);
            checkAchievements();
            showModal('üéâ Nov√Ω spoleƒçn√≠k!', 
                '<p>' + companion.icon + ' ' + companion.name + ' se p≈ôipojil k tobƒõ!</p>' +
                '<p style="color: #8bc34a;"><strong>Schopnost:</strong> ' + companion.ability + '</p>' +
                '<p style="color: #999;">' + companion.abilityDesc + '</p>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì ' + ('Skvƒõl√©!') + '</button>'
            );
            renderFull();
        }
        
        function hireCompanion(companionId) {
            const companion = COMPANIONS.find(c => c.id === companionId);
            if (!companion) return;
            
            if (getMoney() < companion.cost) {
                showModal(t('notifications', 'notEnoughMoney'), 'Nem√°≈° dost penƒõz na najmut√≠ ' + companion.name + '! Pot≈ôebuje≈° ' + companion.cost + ' üí∞');
                return;
            }
            
            if (state.companions?.find(c => c.id === companionId)) {
                showModal('U≈æ m√°≈°', 'Tohoto spoleƒçn√≠ka u≈æ m√°≈°!');
                return;
            }
            
            const newCompanion = {
                id: companion.id,
                uniqueId: `${companion.id}_${Date.now()}`, // Unik√°tn√≠ ID
                name: companion.name,
                icon: companion.icon,
                type: companion.type || 'animal',
                hp: companion.hp,
                maxHp: companion.hp,
                damage: companion.damage || 10,
                defense: companion.defense || 5,
                level: 1,
                xp: 0,
                skillPoints: 0,
                skills: [],
                loyalty: 50,
                equipped: companion.type === 'human' ? { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null } : null
            };
            
            state.companions = state.companions || [];
            
            if (state.companions.length >= getMaxCompanions()) {
                // Plno - ulo≈æ info o n√°kupu a nab√≠dni v√Ωmƒõnu
                window.pendingHireCompanion = { companion: newCompanion, cost: companion.cost };
                showCompanionSwapModal(newCompanion, 'hire');
                return;
            }
            
            // M√≠sto voln√© - rovnou najmi
            removeMoney(companion.cost);
            state.companions.push(newCompanion);
            
            addLog('Najal jsi ' + companion.name + '!', companion.icon);
            notifySuccess('Nov√Ω spoleƒçn√≠k!', companion.name + ' se k tobƒõ p≈ôidal!');
            checkAchievements();
            saveGame(true);
            showHireCompanionsModal();
        }
        
        function showHireCompanionsModal() {
            const currentCount = state.companions?.filter(c => !c.isDead).length || 0;
            const maxCount = getMaxCompanions();
            const canHire = currentCount < maxCount;
            
            // Dostupn√≠ spoleƒçn√≠ci k najmut√≠ (ti co nem√°≈°)
            const availableCompanions = COMPANIONS.filter(c => !state.companions?.find(sc => sc.id === c.id));
            
            let html = '<div style="margin-bottom: 1rem;">';
            html += '<p style="text-align: center; color: #8bc34a;">üë• Spoleƒçn√≠ci: ' + currentCount + '/' + maxCount + '</p>';
            if (!canHire) {
                html += '<p style="text-align: center; color: #ff9800; font-size: 0.85rem;">‚ö†Ô∏è M√°≈° maximum spoleƒçn√≠k≈Ø! Zvy≈° level pro v√≠ce m√≠st.</p>';
            }
            html += '<p style="text-align: center; color: #ff9800; font-size: 0.8rem; margin-top: 0.5rem;">üçñüíß Ka≈æd√Ω spoleƒçn√≠k spot≈ôebuje 1 j√≠dlo + 1 vodu dennƒõ!</p>';
            html += '</div>';
            
            if (availableCompanions.length === 0) {
                html += '<p style="text-align: center; color: #888;">V≈°echny spoleƒçn√≠ky u≈æ m√°≈°!</p>';
            } else {
                html += '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                availableCompanions.forEach(comp => {
                    const canAfford = getMoney() >= comp.cost;
                    const disabled = !canHire || !canAfford;
                    
                    html += '<div style="background: #2a2a2a; padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; border: 1px solid ' + (disabled ? '#444' : '#4a7c5a') + '; ' + (disabled ? 'opacity: 0.6;' : '') + '">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                    html += '<span style="font-size: 2rem;">' + comp.icon + '</span>';
                    html += '<div>';
                    html += '<div style="font-weight: bold; color: #fff;">' + comp.name + '</div>';
                    html += '<div style="font-size: 0.8rem; color: #888;">‚ù§Ô∏è ' + comp.hp + ' HP | ‚öîÔ∏è ' + comp.damage + ' DMG</div>';
                    html += '<div style="font-size: 0.75rem; color: #4caf50;">' + comp.ability + '</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '<button class="btn" onclick="hireCompanion(\'' + comp.id + '\')" ' + (disabled ? 'disabled' : '') + ' style="padding: 0.5rem 1rem; background: ' + (canAfford && canHire ? '#2e7d32' : '#555') + '; ' + (disabled ? 'pointer-events: none;' : '') + '">' + comp.cost + ' üí∞</button>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            html += '<p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 0.5rem;">M√°≈°: ' + getMoney() + ' üí∞</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">' + t('ui', 'close') + '</button>';
            
            showModal('üêï Najmout spoleƒçn√≠ka', html);
        }
        
        function dismissCompanion(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            // Vra≈• vybaven√≠ do invent√°≈ôe
            if (comp?.equipped) {
                ['weapon', 'armor', 'accessory'].forEach(slot => {
                    if (comp.equipped[slot]) {
                        const item = {...comp.equipped[slot]};
                        const existing = state.inv.find(i => i.id === item.id);
                        if (existing) {
                            existing.count = (existing.count || 1) + 1;
                        } else {
                            item.count = 1;
                            state.inv.push(item);
                        }
                    }
                });
                updateCarryWeight();
            }
            
            // Odeber spoleƒçn√≠ka - pou≈æij uniqueId pokud existuje, jinak id
            const compUniqueId = comp.uniqueId || comp.id;
            state.companions = state.companions.filter(c => {
                const cUniqueId = c.uniqueId || c.id;
                return cUniqueId !== compUniqueId;
            });
            
            const companion = COMPANIONS.find(c => c.id === comp.id);
            addLog((companion?.name || comp.name || 'Spoleƒçn√≠k') + ' ode≈°el', companion?.icon || 'üëã');
            saveGame(true);
            renderFull();
        }
        
        // === SPECI√ÅLN√ç SCHOPNOSTI POVOL√ÅN√ç ===
        function useClassAbility() {
            if (!state.char.classId) return;
            
            const ability = CLASS_ABILITIES[state.char.classId];
            if (!ability) return;
            
            const now = Date.now();
            const cooldownRemaining = (state.char.abilityLastUsed + ability.cooldown * 1000) - now;
            
            if (cooldownRemaining > 0) {
                showModal('‚è∞ Cooldown', 'Schopnost bude dostupn√° za ' + Math.ceil(cooldownRemaining / 1000) + ' sekund.');
                return;
            }
            
            state.char.abilityLastUsed = now;
            
            switch (ability.action) {
                case 'revealLoot':
                    // Sbƒõraƒç - odhal√≠ loot na aktu√°ln√≠ lokaci
                    const loot = ITEMS.filter(i => i.findChance > 0.3);
                    const found = loot[Math.floor(Math.random() * loot.length)];
                    if (found && canAddItem(found, 1)) {
                        state.inv.push({...found, count: found.type === 'consumable' ? 1 : undefined});
                        showModal(ability.icon + ' ' + ability.name, 'Na≈°el jsi: ' + found.icon + ' ' + found.name);
                    }
                    break;
                    
                case 'rage':
                    // N√°jezdn√≠k - bonus damage
                    state.combatBonuses.damageBonus = 50;
                    state.combatBonuses.expires = now + 60000;
                    showModal(ability.icon + ' ' + ability.name, '+50% damage na p≈ô√≠≈°t√≠ boj!');
                    break;
                    
                case 'quickHeal':
                    // Medik - rychl√© l√©ƒçen√≠
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + 40);
                    showModal(ability.icon + ' ' + ability.name, '+40 HP!');
                    break;
                    
                case 'emergencyRepair':
                    // Mechanik - oprava
                    state.inv.forEach(item => {
                        if (item.durability !== undefined) {
                            item.durability = Math.min(item.maxDurability || 100, item.durability + 30);
                        }
                    });
                    showModal(ability.icon + ' ' + ability.name, 'Vybaven√≠ opraveno o 30%!');
                    break;
                    
                case 'stealth':
                    // Stopa≈ô - vyhnut√≠ se nep≈ô√≠teli
                    state.combatBonuses.stealth = true;
                    state.combatBonuses.expires = now + 300000;
                    showModal(ability.icon + ' ' + ability.name, 'Vyhne≈° se dal≈°√≠mu nep≈ô√≠teli!');
                    break;
                    
                case 'secondWind':
                    // P≈ôe≈æiv≈°√≠ - druh√Ω dech
                    if (state.char.hp < state.char.maxHp * 0.2) {
                        state.char.hp = Math.floor(state.char.maxHp * 0.5);
                        showModal(ability.icon + ' ' + ability.name, 'HP obnoveno na 50%!');
                    } else {
                        showModal('‚ùå Nelze pou≈æ√≠t', 'M≈Ø≈æe≈° pou≈æ√≠t pouze kdy≈æ m√°≈° m√©nƒõ ne≈æ 20% HP!');
                        state.char.abilityLastUsed = 0; // Reset cooldown
                    }
                    break;
                    
                case 'haggle':
                    // Obchodn√≠k - lep≈°√≠ ceny
                    state.combatBonuses.haggle = true;
                    state.combatBonuses.expires = now + 300000;
                    showModal(ability.icon + ' ' + ability.name, '-30% ceny na 5 minut!');
                    break;
                    
                case 'bloodbath':
                    // Berserkr - AoE √∫tok
                    state.combatBonuses.aoeNextAttack = true;
                    showModal(ability.icon + ' ' + ability.name, 'P≈ô√≠≈°t√≠ √∫tok zas√°hne v≈°echny nep≈ô√°tele!');
                    break;
                    
                case 'deathStrike':
                    // Assassin - garantovan√Ω crit
                    state.combatBonuses.guaranteedCrit = true;
                    showModal(ability.icon + ' ' + ability.name, 'P≈ô√≠≈°t√≠ √∫tok je garantovan√Ω kritick√Ω z√°sah!');
                    break;
                    
                case 'ironSkin':
                    // Tank - blokuje damage
                    state.combatBonuses.ironSkin = true;
                    state.combatBonuses.expires = now + 60000;
                    showModal(ability.icon + ' ' + ability.name, 'Blokuje≈° ve≈°ker√Ω damage na p≈ô√≠≈°t√≠m kole!');
                    break;
                    
                case 'poisonCloud':
                    // Alchymista - jedovat√Ω oblak
                    state.combatBonuses.poisonCloud = 3; // 3 kola
                    showModal(ability.icon + ' ' + ability.name, 'Jedovat√Ω oblak otr√°vil v≈°echny nep≈ô√°tele na 3 kola!');
                    break;
                    
                case 'track':
                    // Lovec - najde zv√≠≈ôe
                    showModal(ability.icon + ' ' + ability.name, 'üêæ Na≈°el jsi stopy zv√≠≈ôete! Bonus na dal≈°√≠ lov.');
                    state.combatBonuses.trackingBonus = true;
                    break;
                    
                case 'megaBomb':
                    // Demoliƒç√°≈ô - velk√Ω v√Ωbuch
                    state.combatBonuses.megaBomb = 100; // 100 damage v≈°em
                    showModal(ability.icon + ' ' + ability.name, 'üí• MEGA BOMBA p≈ôipravena! 100 damage v≈°em nep≈ô√°tel≈Øm!');
                    break;
                    
                case 'desertWind':
                    // Nom√°d - okam≈æit√© cestov√°n√≠
                    if (state.map.traveling) {
                        state.map.traveling = false;
                        state.map.travelProgress = 0;
                        showModal(ability.icon + ' ' + ability.name, 'Dorazil jsi okam≈æitƒõ!');
                    } else {
                        showModal('‚ùå Nelze pou≈æ√≠t', 'Nejsi na cest√°ch!');
                        state.char.abilityLastUsed = 0;
                    }
                    break;
                    
                case 'radBurst':
                    // Mutant - radiaƒçn√≠ v√Ωbuch
                    state.combatBonuses.radBurst = { damage: 50, radiation: 20 };
                    showModal(ability.icon + ' ' + ability.name, 'Radiaƒçn√≠ energie p≈ôipravena! 50 damage + 20 radiace nep≈ô√°tel≈Øm!');
                    break;
                    
                case 'mindBlast':
                    // Psychik - ment√°ln√≠ √∫tok
                    state.combatBonuses.mindBlast = true;
                    showModal(ability.icon + ' ' + ability.name, 'Nep≈ô√≠tel p≈ôeskoƒç√≠ sv≈Øj p≈ô√≠≈°t√≠ tah!');
                    break;
            }
            
            addLog('Pou≈æil jsi schopnost: ' + ability.name, ability.icon);
            renderFull();
        }
        
        // === POMOC P≈òE≈ΩIV≈†√çMU EVENT ===
        function helpSurvivor() {
            closeModal();
            // N√°hodn√Ω nep≈ô√≠tel
            const enemies = ENEMIES.filter(e => e.tier <= 2);
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            
            // Po boji odmƒõna
            state.helpingSurvivor = true;
            startCombat({ id: enemy.id });
        }
        
        // === NEBEZPEƒåN√â SETK√ÅN√ç (DANGER/DEADLY Z√ìNY) ===
        function triggerDangerousEncounter(zone) {
            let tierFilter;
            let title;
            let description;
            
            if (zone === 'danger') {
                // Tier 3 nep≈ô√°tel√©
                tierFilter = e => e.tier === 3;
                title = '‚ö†Ô∏è Nebezpeƒçn√© setk√°n√≠!';
                description = 'V t√©to nebezpeƒçn√© oblasti na tebe ƒç√≠h√° siln√Ω nep≈ô√≠tel!';
            } else {
                // Deadly z√≥na - tier 4-5 (bossov√©)
                tierFilter = e => e.tier >= 4;
                title = 'üíÄ Smrteln√© nebezpeƒç√≠!';
                description = 'Narazil jsi na extr√©mnƒõ nebezpeƒçn√©ho protivn√≠ka!';
            }
            
            const enemies = ENEMIES.filter(tierFilter);
            if (enemies.length === 0) {
                // Fallback na tier 3
                const fallback = ENEMIES.filter(e => e.tier === 3);
                if (fallback.length > 0) {
                    const enemy = fallback[Math.floor(Math.random() * fallback.length)];
                    showDangerousEnemyModal(enemy, title, description);
                }
                return;
            }
            
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            showDangerousEnemyModal(enemy, title, description);
        }
        
        function showDangerousEnemyModal(enemy, title, description) {
            const isBoss = enemy.isBoss || enemy.tier >= 4;
            const borderColor = isBoss ? '#ff0000' : '#ff9800';
            
            showModal(title, `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem; ${isBoss ? 'animation: pulse 1s infinite;' : ''}">${enemy.icon}</div>
                    <h2 style="color: ${borderColor}; margin: 0.5rem 0;">${enemy.name}</h2>
                    ${isBoss ? '<span style="background: #8B0000; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">üëπ BOSS</span>' : ''}
                    <p style="color: #888; margin-top: 0.5rem;">${description}</p>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${borderColor};">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                            <div>
                                <div style="color: #f44336; font-size: 1.2rem; font-weight: bold;">${enemy.hp}</div>
                                <div style="color: #888; font-size: 0.8rem;">‚ù§Ô∏è HP</div>
                            </div>
                            <div>
                                <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${enemy.damage}</div>
                                <div style="color: #888; font-size: 0.8rem;">‚öîÔ∏è DMG</div>
                            </div>
                            <div>
                                <div style="color: #2196f3; font-size: 1.2rem; font-weight: bold;">${enemy.defense}</div>
                                <div style="color: #888; font-size: 0.8rem;">üõ°Ô∏è DEF</div>
                            </div>
                        </div>
                    </div>
                    
                    <p style="color: #ffd700; font-size: 0.9rem;">üéÅ Odmƒõna: ${enemy.xp} XP + vz√°cn√Ω loot</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal(); startCombat({id: '${enemy.id}'});" style="background: #8B0000;">
                        ‚öîÔ∏è Bojovat!
                    </button>
                    <button class="btn" onclick="tryToFlee('${enemy.id}')" style="background: #555;">
                        üèÉ Pokusit se ut√©ct (${isBoss ? '30%' : '50%'} ≈°ance)
                    </button>
                </div>
            `);
        }
        
        function tryToFlee(enemyId) {
            const enemy = ENEMIES.find(e => e.id === enemyId);
            const isBoss = enemy?.isBoss || enemy?.tier >= 4;
            const fleeChance = isBoss ? 0.30 : 0.50;
            
            // üî• Reset kill streak p≈ôi √∫tƒõku
            state.stats.killStreak = 0;
            
            if (Math.random() < fleeChance) {
                closeModal();
                showModal('üèÉ Utekl jsi!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üèÉ</div>
                        <p style="color: #8bc34a;">Poda≈ôilo se ti ut√©ct!</p>
                        <p style="color: #888;">Ale ztratil jsi nƒõjak√© suroviny...</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>
                `);
                // Ztr√°ta surovin
                const resources = ['wood', 'metal', 'cloth', 'food'];
                resources.forEach(r => {
                    if (state.resources[r] > 0) {
                        const loss = Math.floor(state.resources[r] * 0.1);
                        state.resources[r] = Math.max(0, state.resources[r] - loss);
                    }
                });
                addLog('Utekl jsi p≈ôed ' + enemy.name + '!', 'üèÉ');
            } else {
                closeModal();
                showModal('‚ùå Neuspƒõl jsi!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üò∞</div>
                        <p style="color: #f44336;">Nepoda≈ôilo se ti ut√©ct!</p>
                        <p style="color: #888;">${enemy.icon} ${enemy.name} tƒõ dostihl!</p>
                    </div>
                    <button class="btn" onclick="closeModal(); startCombat({id: '${enemyId}'})" style="width: 100%; margin-top: 1rem; background: #8B0000;">‚öîÔ∏è Mus√≠≈° bojovat!</button>
                `);
            }
            renderFull();
        }
        
        // === KARAVANA OBCHOD ===
        function openCaravanShop() {
            // Kontrola otev√≠rac√≠ doby
            if (!isShopOpen('caravan')) {
                showModal('üåô Karavana odpoƒç√≠v√°', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üê™üí§</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Obchodn√≠ci odpoƒç√≠vaj√≠!</p>
                        <p style="color: #888; margin: 1rem 0;">‚è∞ Otev√≠rac√≠ doba: 08:00 - 20:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu√°ln√≠ ƒças: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #555; font-size: 0.8rem; margin-top: 0.5rem;">üí° Karavana cestuje p≈ôes noc, vrac√≠ se r√°no.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Filtruj rare/epic itemy, ale VYLUƒå lore a cantBuy
            const rareItems = ITEMS.filter(i => 
                (i.rarity === 'rare' || i.rarity === 'epic') && 
                !i.cantBuy && 
                i.type !== 'lore'
            );
            const playerMoney = getMoney();
            
            // Zjisti jestli je hr√°ƒç v osadƒõ - pouze podle currentLocation
            const currentLoc = state.world?.currentLocation || '';
            const inSettlement = currentLoc === 'shelter' || currentLoc === 'settlement';
            
            console.log('üê™ Karavana - inSettlement:', inSettlement, 'currentLocation:', currentLoc);
            
            // Inicializuj z√°soby karavany pokud neexistuj√≠ nebo je nov√° karavana
            if (!state.caravanStock || state.caravanStock.generated !== state.caravan?.until) {
                state.caravanStock = {
                    generated: state.caravan?.until || Date.now(),
                    items: {}
                };
                // Ka≈æd√Ω item m√° n√°hodn√© mno≈æstv√≠ 1-5
                rareItems.forEach(item => {
                    state.caravanStock.items[item.id] = Math.floor(Math.random() * 5) + 1;
                });
            }
            
            // Rozdƒõl na kategorie (jen ty co maj√≠ z√°soby)
            const hasStock = (item) => (state.caravanStock.items[item.id] || 0) > 0;
            const consumables = rareItems.filter(i => i.type === 'consumable' && hasStock(i));
            const weapons = rareItems.filter(i => i.type === 'weapon' && hasStock(i));
            const armors = rareItems.filter(i => i.type === 'armor' && hasStock(i));
            const tools = rareItems.filter(i => i.type === 'tool' && hasStock(i));
            const others = rareItems.filter(i => !['consumable', 'weapon', 'armor', 'tool'].includes(i.type) && hasStock(i));
            
            const caravanShopTexts = {
                intro: 'Speci√°ln√≠ nab√≠dka vz√°cn√©ho zbo≈æ√≠!', youHave: 'M√°≈°', buy: 'Koupit'
            };
            
            const renderCaravanItem = (item) => {
                // Pou≈æij jednotnou funkci + extra 10% sleva od karavany
                const basePrice = calculateItemPrice(item.price);
                const price = Math.floor(basePrice * 0.9); // Karavana m√° nav√≠c 10% slevu
                const originalPrice = item.price;
                const stock = state.caravanStock.items[item.id] || 0;
                return `
                    <div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <span style="font-size: 1.3rem;">${item.icon}</span>
                            <strong>${getItemName(item.id)}</strong>
                            <span style="color: #888; font-size: 0.8rem; margin-left: 0.3rem;">(${stock}x)</span>
                            <span style="color: #ffd700; margin-left: 0.5rem;">üí∞ ${price}</span>
                            <span style="color: #999; text-decoration: line-through; margin-left: 0.3rem;">${originalPrice}</span>
                        </div>
                        <button class="btn" onclick="buyCaravanItem('${item.id}')" ${playerMoney < price || stock <= 0 ? 'disabled style="opacity:0.5;"' : ''} style="padding: 0.3rem 0.8rem;">${caravanShopTexts.buy}</button>
                    </div>
                `;
            };
            
            // Prodejn√≠ sekce - karavana kupuje v≈°e s bonusem +25%
            // Pokud hr√°ƒç NEN√ç v osadƒõ, prod√°v√° se ze skladu osady
            const renderCaravanSellItems = () => {
                const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25;
                let html = '';
                
                if (inSettlement) {
                    // Hr√°ƒç JE v osadƒõ - m≈Ø≈æe prodat z invent√°≈ôe
                    // Prodejn√© vƒõci
                    const sellableInv = state.inv.filter(i => !i.crafted && !i.fromCaravan && !i.fromShop && !isItemEquipped(i));
                    // Zamƒçen√© vƒõci
                    const lockedInv = state.inv.filter(i => (i.crafted || i.fromCaravan || i.fromShop) && !isItemEquipped(i));
                    
                    if (sellableInv.length === 0) {
                        return html + '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem√°≈° co prodat</p>';
                    }
                    
                    sellableInv.forEach((item, idx) => {
                        // P≈ôeskoƒç nasazen√© p≈ôedmƒõty
                        if (isItemEquipped(item)) return;
                        
                        // Najdi skuteƒçn√Ω index v p≈Øvodn√≠m invent√°≈ôi
                        const realIdx = state.inv.indexOf(item);
                        
                        const itemData = ITEMS.find(i => i.id === item.id) || item;
                        const basePrice = itemData.price || item.price;
                        if (!basePrice) return;
                        
                        // Karavana kupuje v≈°e - i po≈°kozen√©, za upravenou cenu
                        let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
                        
                        // Sn√≠≈æen√≠ ceny za po≈°kozen√≠
                        if (item.durability !== undefined && item.maxDurability) {
                            const durabilityRatio = item.durability / item.maxDurability;
                            sellPrice = Math.floor(sellPrice * durabilityRatio);
                            if (sellPrice < 1) sellPrice = 1;
                        }
                        
                        // Gender bonus
                        if (state.char.gender === 'female') {
                            sellPrice = Math.floor(sellPrice * 1.1);
                        }
                        
                        const countText = item.count > 1 ? ` (${item.count}x)` : '';
                        const durabilityText = item.durability !== undefined ? 
                            ` <span style="color: ${item.durability < 30 ? '#f44336' : '#888'}; font-size: 0.7rem;">[${item.durability}%]</span>` : '';
                        
                        html += `
                            <div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                                    <span style="font-size: 1.3rem;">${item.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 0.85rem;">${item.name}${durabilityText}</div>
                                        <div style="font-size: 0.8rem; color: #4caf50;">üí∞ ${sellPrice}${countText}</div>
                                    </div>
                                </div>
                                <button class="btn" onclick="sellToCaravan(${realIdx}, 'inv')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>
                            </div>
                        `;
                    });
                    
                    // Zobraz zamƒçen√© vƒõci
                    if (lockedInv.length > 0) {
                        html += `<div style="border-top: 1px solid #444; margin-top: 0.5rem; padding-top: 0.5rem;">
                            <p style="color: #666; font-size: 0.75rem; text-align: center; margin-bottom: 0.3rem;">üîí Nelze prodat:</p>`;
                        lockedInv.slice(0, 5).forEach((item) => {
                            const lockReason = item.crafted ? 'üî®' : (item.fromCaravan ? 'üê™' : 'üõí');
                            html += `<div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.3rem; border-radius: 4px; margin-bottom: 0.2rem; opacity: 0.5;">
                                <span style="font-size: 0.8rem; color: #666;">${item.icon} ${item.name}</span>
                                <span style="font-size: 0.7rem; color: #ff9800;">${lockReason}</span>
                            </div>`;
                        });
                        if (lockedInv.length > 5) {
                            html += `<p style="color: #555; font-size: 0.7rem; text-align: center;">...a ${lockedInv.length - 5} dal≈°√≠ch</p>`;
                        }
                        html += `</div>`;
                    }
                    
                    return html || '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem√°≈° co prodat</p>';
                } else {
                    // Hr√°ƒç NEN√ç v osadƒõ - prod√°v√° se ze skladu osady (baseItems)
                    html += '<p style="color: #ff9800; font-size: 0.85rem; margin-bottom: 0.5rem; text-align: center;">üì¶ Prodej ze skladu osady (nejsi v osadƒõ)</p>';
                    
                    // baseItems je sklad osady, ne stashes (to jsou skr√Ω≈°e)
                    const storageItems = state.baseItems || [];
                    if (storageItems.length === 0) {
                        return html + '<p style="text-align: center; color: #666; font-size: 0.85rem;">Sklad osady je pr√°zdn√Ω</p>';
                    }
                    
                    // Filtruj prodejn√© vƒõci (ne crafted, ne fromCaravan, ne fromShop)
                    const sellableItems = storageItems.filter(i => !i.crafted && !i.fromCaravan && !i.fromShop);
                    
                    if (sellableItems.length === 0) {
                        return html + '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem√°≈° co prodat ze skladu</p>';
                    }
                    
                    sellableItems.forEach((item) => {
                        // Najdi skuteƒçn√Ω index v baseItems
                        const realIdx = state.baseItems.indexOf(item);
                        
                        const itemData = ITEMS.find(i => i.id === item.id) || item;
                        const basePrice = itemData.price || item.price;
                        if (!basePrice) return;
                        
                        let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
                        
                        // Sn√≠≈æen√≠ ceny za po≈°kozen√≠
                        if (item.durability !== undefined && item.maxDurability) {
                            const durabilityRatio = item.durability / item.maxDurability;
                            sellPrice = Math.floor(sellPrice * durabilityRatio);
                            if (sellPrice < 1) sellPrice = 1;
                        }
                        
                        // Gender bonus
                        if (state.char.gender === 'female') {
                            sellPrice = Math.floor(sellPrice * 1.1);
                        }
                        
                        const countText = item.count > 1 ? ` (${item.count}x)` : '';
                        const durabilityText = item.durability !== undefined ? 
                            ` <span style="color: ${item.durability < 30 ? '#f44336' : '#888'}; font-size: 0.7rem;">[${item.durability}%]</span>` : '';
                        
                        html += `
                            <div style="background: #1a2a1a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #2a4a2a;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                                    <span style="font-size: 1.3rem;">${item.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 0.85rem;">${item.name}${durabilityText}</div>
                                        <div style="font-size: 0.8rem; color: #4caf50;">üí∞ ${sellPrice}${countText}</div>
                                    </div>
                                </div>
                                <button class="btn" onclick="sellToCaravan(${realIdx}, 'base')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>
                            </div>
                        `;
                    });
                    
                    return html || '<p style="text-align: center; color: #666; font-size: 0.85rem;">Sklad osady je pr√°zdn√Ω</p>';
                }
            };
            
            showModal('üê™ Karavana - Vz√°cn√© zbo≈æ√≠', `
                <p style="color: #ff9800; margin-bottom: 0.5rem;">${caravanShopTexts.intro} üí∞ ${caravanShopTexts.youHave}: ${playerMoney}</p>
                
                <div style="background: #1a1a1a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('caravanHoursInfo').style.display = document.getElementById('caravanHoursInfo').style.display === 'none' ? 'block' : 'none'">
                        <span style="color: #888; font-size: 0.75rem;">üïê Otev√≠rac√≠ doby ‚ñº</span>
                        <span style="color: #666; font-size: 0.7rem;">${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</span>
                    </div>
                    <div id="caravanHoursInfo" style="display: none; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #333; font-size: 0.7rem;">
                        <div style="display: grid; gap: 0.2rem;">
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('settlement') ? '#8bc34a' : '#666'};">üõí Osada <span>06-22</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('caravan') ? '#8bc34a' : '#666'};">üê™ Karavana <span>08-20</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('military') ? '#8bc34a' : '#666'};">üéñÔ∏è Vojensk√Ω <span>06-18</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('mutants') ? '#8bc34a' : '#666'};">‚ò£Ô∏è Mutanti <span>20-06üåô</span></div>
                            <div style="display: flex; justify-content: space-between; color: #8bc34a;">üß™ Laborato≈ô <span>non-stop</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('wandering') ? '#8bc34a' : '#666'};">üê™ Potuln√Ω <span>10-16</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Taby pro Koupit/Prodat -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button id="caravanTabBuy" class="btn" onclick="switchCaravanTab('buy')" style="flex: 1; background: #8B4513;">üõí Koupit</button>
                    <button id="caravanTabSell" class="btn" onclick="switchCaravanTab('sell')" style="flex: 1; background: #555;">üí∞ Prodat (+25%)</button>
                </div>
                
                <!-- Koupit sekce -->
                <div id="caravanBuySection">
                    <!-- Filtry -->
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.5rem;">
                        <button class="btn caravan-filter active" onclick="filterCaravan('all')" data-filter="all" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #8B4513;">V≈°e</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('consumable')" data-filter="consumable" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üçñ</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('weapon')" data-filter="weapon" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">‚öîÔ∏è</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('armor')" data-filter="armor" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üõ°Ô∏è</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('tool')" data-filter="tool" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üîß</button>
                        <button class="btn caravan-filter" onclick="filterCaravan('other')" data-filter="other" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üì¶</button>
                    </div>
                    
                    <div style="max-height: 40vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <div class="caravan-category" data-type="consumable">
                            ${consumables.length > 0 ? `
                                <h4 style="color: #ff9800; font-size: 0.8rem; margin: 0.5rem 0;">üçñ Spot≈ôebn√≠ (${consumables.length})</h4>
                                ${consumables.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="weapon">
                            ${weapons.length > 0 ? `
                                <h4 style="color: #c62828; font-size: 0.8rem; margin: 0.5rem 0;">‚öîÔ∏è Zbranƒõ (${weapons.length})</h4>
                                ${weapons.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="armor">
                            ${armors.length > 0 ? `
                                <h4 style="color: #2196f3; font-size: 0.8rem; margin: 0.5rem 0;">üõ°Ô∏è Zbroje (${armors.length})</h4>
                                ${armors.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="tool">
                            ${tools.length > 0 ? `
                                <h4 style="color: #9c27b0; font-size: 0.8rem; margin: 0.5rem 0;">üîß N√°stroje (${tools.length})</h4>
                                ${tools.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                        <div class="caravan-category" data-type="other">
                            ${others.length > 0 ? `
                                <h4 style="color: #8bc34a; font-size: 0.8rem; margin: 0.5rem 0;">üì¶ Ostatn√≠ (${others.length})</h4>
                                ${others.map(renderCaravanItem).join('')}
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Prodat sekce -->
                <div id="caravanSellSection" style="display: none;">
                    <p style="color: #4caf50; font-size: 0.85rem; margin-bottom: 0.5rem;">üê™ Karavana kupuje V≈†ECHNO - i po≈°kozen√© vƒõci!</p>
                    <div style="max-height: 45vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${renderCaravanSellItems()}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zav≈ô√≠t'}</button>
            `);
        }
        
        function switchCaravanTab(tab) {
            const buySection = document.getElementById('caravanBuySection');
            const sellSection = document.getElementById('caravanSellSection');
            const buyTab = document.getElementById('caravanTabBuy');
            const sellTab = document.getElementById('caravanTabSell');
            
            if (tab === 'buy') {
                buySection.style.display = 'block';
                sellSection.style.display = 'none';
                buyTab.style.background = '#8B4513';
                sellTab.style.background = '#555';
            } else {
                buySection.style.display = 'none';
                sellSection.style.display = 'block';
                buyTab.style.background = '#555';
                sellTab.style.background = '#d4722e';
            }
        }
        
        function sellToCaravan(itemIdx, source = 'inv') {
            // Zjisti odkud se prod√°v√° - z invent√°≈ôe, skladu osady nebo skr√Ω≈°e
            let item, itemList;
            
            if (source === 'base') {
                // Ze skladu osady (baseItems)
                if (!state.baseItems) {
                    notifyWarning('Chyba', 'Sklad osady neexistuje');
                    return;
                }
                itemList = state.baseItems;
                item = itemList[itemIdx];
            } else if (source === 'stash') {
                // Ze skr√Ω≈°e
                if (!state.stashes?.shelter) {
                    notifyWarning('Chyba', 'Skr√Ω≈° neexistuje');
                    return;
                }
                itemList = state.stashes.shelter;
                item = itemList[itemIdx];
            } else {
                // Z invent√°≈ôe
                itemList = state.inv;
                item = itemList[itemIdx];
            }
            
            if (!item) return;
            
            // Vycraftƒõn√© p≈ôedmƒõty nelze prodat obchodn√≠k≈Øm
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoruƒçnƒõ vyroben√© vƒõci obchodn√≠ci neberou. Zkus online tr≈æi≈°tƒõ!');
                return;
            }
            
            // Vƒõci koupen√© od karavany nelze prodat zpƒõt (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od karavany nelze prodat. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            // Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const basePrice = itemData.price || item.price;
            if (!basePrice) {
                notifyWarning('Nelze prodat', 'Tento p≈ôedmƒõt nem√° hodnotu');
                return;
            }
            
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25; // +25% ceny p≈ôi prodeji karavan√°m
            let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
            
            // Sn√≠≈æen√≠ ceny za po≈°kozen√≠
            if (item.durability !== undefined && item.maxDurability) {
                const durabilityRatio = item.durability / item.maxDurability;
                sellPrice = Math.floor(sellPrice * durabilityRatio);
                if (sellPrice < 1) sellPrice = 1;
            }
            
            // Gender bonus
            if (state.char.gender === 'female') {
                sellPrice = Math.floor(sellPrice * 1.1);
            }
            
            // P≈ôidej pen√≠ze
            addMoney(sellPrice);
            
            // Odeber z p≈ô√≠slu≈°n√©ho seznamu
            if (item.count && item.count > 1) {
                item.count--;
            } else {
                itemList.splice(itemIdx, 1);
            }
            
            const sourceText = source === 'stash' ? ' (ze skladu)' : '';
            notifySuccess('Prod√°no!', `${item.name}${sourceText} +${sellPrice} üí∞`);
            
            if (source === 'inv') {
                updateCarryWeight();
            }
            
            // Daily quest progress - sold
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + 1;
                checkDailyQuests();
            }
            
            // Refresh karavana shop a z≈Østa≈à na prodejn√≠m tabu
            openCaravanShop();
            setTimeout(() => switchCaravanTab('sell'), 50);
        }
        
        function filterCaravan(type) {
            // Aktualizuj aktivn√≠ tlaƒç√≠tko
            document.querySelectorAll('.caravan-filter').forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.style.background = '#8B4513';
                    btn.classList.add('active');
                } else {
                    btn.style.background = '#333';
                    btn.classList.remove('active');
                }
            });
            
            // Filtruj kategorie
            document.querySelectorAll('.caravan-category').forEach(cat => {
                if (type === 'all' || cat.dataset.type === type) {
                    cat.style.display = 'block';
                } else {
                    cat.style.display = 'none';
                }
            });
        }
        
        function buyCaravanItem(itemId) {
            const item = ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // Kontrola unique item≈Ø (spac√°k, kompas, atd.)
            if (item.unique) {
                const alreadyHas = state.inv.some(i => i.id === itemId);
                if (alreadyHas) {
                    notifyWarning('U≈æ m√°≈° ' + item.name, 'M≈Ø≈æe≈° m√≠t pouze jeden');
                    return;
                }
            }
            
            // Kontrola z√°sob
            if (!state.caravanStock?.items?.[itemId] || state.caravanStock.items[itemId] <= 0) {
                notifyWarning('Vyprod√°no!', 'Karavana u≈æ nem√° ' + item.name);
                return;
            }
            
            // Vypoƒç√≠tej cenu stejnƒõ jako v renderCaravanItem
            const basePrice = calculateItemPrice(item.price);
            const price = Math.floor(basePrice * 0.9); // Karavana m√° nav√≠c 10% slevu
            
            if (getMoney() < price) {
                notifyWarning('Nedostatek penƒõz!', 'Pot≈ôebuje≈° ' + price + ' üí∞');
                return;
            }
            
            // Sni≈æ z√°soby karavany
            state.caravanStock.items[itemId]--;
            
            // Zjisti jestli jsme v osadƒõ
            const inSettlement = state.currentTab === 'settlement' ||
                                 (state.settlement?.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until);
            
            if (inSettlement) {
                // V osadƒõ - ukl√°dej V≈†ECHNO do skladu osady
                removeMoney(price);
                
                if (item.type === 'resource') {
                    // Suroviny do settlement.resources
                    state.settlement.resources[item.id] = (state.settlement.resources[item.id] || 0) + 1;
                    notifySuccess('Do skladu!', '+1 ' + item.icon + ' ' + item.name);
                } else {
                    // Ostatn√≠ p≈ôedmƒõty do baseItems (sklad osady)
                    // Oznaƒç√≠me jako "z karavany" - ni≈æ≈°√≠ prodejn√≠ cena
                    if (!state.baseItems) state.baseItems = [];
                    const newItem = {
                        ...item,
                        count: 1,
                        fromCaravan: true, // Oznaƒçen√≠ pro ni≈æ≈°√≠ prodejn√≠ cenu
                        boughtPrice: price // Za kolik byl koupen
                    };
                    const existing = state.baseItems.find(i => i.id === item.id && i.fromCaravan && (item.stackable || item.type === 'consumable' || item.type === 'ammo'));
                    if (existing) {
                        existing.count = (existing.count || 1) + 1;
                    } else {
                        state.baseItems.push(newItem);
                    }
                    notifySuccess('Do skladu!', item.icon + ' ' + item.name);
                }
                
                addLog('Koupil jsi ' + item.name + ' od karavany (do skladu osady)', 'üê™');
            } else {
                // Mimo osadu - norm√°ln√≠ n√°kup do invent√°≈ôe
                if (!canAddItem(item, 1)) {
                    notifyWarning('Pln√Ω invent√°≈ô!', 'Neunese≈° ' + item.name);
                    return;
                }
                
                removeMoney(price);
                // Oznaƒç√≠me jako "z karavany"
                const newItem = {
                    ...item,
                    count: 1,
                    fromCaravan: true,
                    boughtPrice: price
                };
                addItemToInventory(newItem, 1);
                addLog('Koupil jsi ' + item.name + ' od karavany', 'üê™');
                notifySuccess('Zakoupeno!', item.icon + ' ' + item.name);
            }
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            openCaravanShop(); // Refresh
        }
        
        // === RENDER ===
        function render() {
            // Always update header
            document.getElementById('name').textContent = state.char.name;
            document.getElementById('level').textContent = state.char.level;
            const hpElement = document.getElementById('hp');
            hpElement.textContent = `${Math.round(state.char.hp)}/${state.char.maxHp}`;
            // Blik√°n√≠ p≈ôi kritick√©m HP
            const hpCritical = state.char.hp < state.char.maxHp * 0.2;
            hpElement.style.animation = hpCritical ? 'flash-red 0.5s infinite' : 'none';
            hpElement.style.color = hpCritical ? '#ff0000' : '';
            updateCarryWeight();
            document.getElementById('weight').textContent = `${state.carryWeight.toFixed(1)}/${state.maxCarryWeight}kg`;
            const dayText = 'Den';
            document.getElementById('time').textContent = `${dayText} ${state.time.days}, ${pad(state.time.hours)}:${pad(state.time.mins)}`;
            
            // Update status bars
            if (state.confirmed) {
                const weather = getCurrentWeather();
                const dayPhase = getCurrentDayPhase();
                
                // Determine danger levels for glowing effects
                const hungerDanger = state.status.hunger < 25;
                const thirstDanger = state.status.thirst < 25;
                const energyDanger = state.status.energy < 25;
                const radDanger = state.status.radiation > 50;
                const radCritical = state.status.radiation >= 80;
                const radLethal = state.status.radiation >= 100;
                
                document.getElementById('statusBars').innerHTML = `
                    <!-- Kompaktn√≠ unified panel -->
                    <div style="background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%); border: 1px solid #333; border-radius: 8px; padding: 0.4rem;">
                        <!-- Rychl√° tlaƒç√≠tka - 1 ≈ô√°dek -->
                        <div style="display: flex; gap: 0.25rem; margin-bottom: 0.4rem;">
                            <span onclick="showWeatherInfo()" style="flex: 1; background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid #444; color: #ffd700; text-align: center;">
                                ${weather.icon} ${getWeatherName(weather.id)}
                            </span>
                            <span style="flex: 1; background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; border: 1px solid #333; color: #888; text-align: center;">
                                ${dayPhase.icon} ${t('uiDetail', dayPhase.id) || dayPhase.name}
                            </span>
                            <span onclick="showCompanionsInfo()" style="flex: 1; background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${state.companions?.filter(c => !c.isDead).length ? '#4a6a4a' : '#333'}; color: ${state.companions?.filter(c => !c.isDead).length ? 'var(--toxic-green)' : '#666'}; text-align: center;">
                                üë• ${state.companions?.filter(c => !c.isDead).length || 0}/${getMaxCompanions()}
                            </span>
                            <span onclick="showMutantInfo()" style="flex: 1; background: linear-gradient(180deg, ${state.char.class === 'mutant' ? '#1a2a1a' : '#252525'} 0%, #1a1a1a 100%); padding: 0.25rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${state.char.class === 'mutant' ? '#76ff03' : (state.mutations?.length > 0 ? '#666' : '#333')}; color: ${state.char.class === 'mutant' ? '#76ff03' : (state.mutations?.length > 0 ? '#ff9800' : '#666')}; text-align: center;">
                                ü¶é ${state.mutations?.length || 0}/5
                            </span>
                        </div>
                        
                        <!-- Akƒçn√≠ tlaƒç√≠tka - men≈°√≠ -->
                        <div style="display: flex; gap: 0.25rem; margin-bottom: 0.4rem;">
                            <span onclick="showFactionsModal()" style="flex: 1; background: linear-gradient(180deg, #2a2a1a 0%, #1a1a0a 100%); padding: 0.3rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid #4a4a2a; color: #ffd700; text-align: center; font-weight: bold;">
                                üèõÔ∏è ${'Frakce'}
                            </span>
                            <span onclick="openAllQuests()" style="flex: 1; background: linear-gradient(180deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.3rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid ${(state.dailyQuests.completed?.length || 0) >= (state.dailyQuests.quests?.length || 3) ? '#4a6a4a' : '#4a2a2a'}; color: ${(state.dailyQuests.completed?.length || 0) >= (state.dailyQuests.quests?.length || 3) ? '#8bc34a' : '#ff9800'}; text-align: center; font-weight: bold;">
                                üìã ${'√ökoly'}
                            </span>
                            <span onclick="showCasino()" style="flex: 1; background: linear-gradient(180deg, #2a2a0a 0%, #1a1a00 100%); padding: 0.3rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; border: 1px solid #6a6a2a; color: #ffd700; text-align: center; font-weight: bold;">
                                üé∞ Casino
                            </span>
                        </div>
                        
                        <!-- Status bary - horizont√°ln√≠ -->
                        <div style="display: flex; gap: 0.15rem;">
                            <div onclick="showStatusDetails('hunger')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${hungerDanger ? '#ff4444' : '#2a2a2a'}; ${hungerDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">üçñ <span style="color: ${hungerDanger ? '#ff4444' : '#ff9900'};">${Math.round(state.status.hunger)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.hunger}%; background: linear-gradient(90deg, #ff6600, #ff9900); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('thirst')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${thirstDanger ? '#ff4444' : '#2a2a2a'}; ${thirstDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">üíß <span style="color: ${thirstDanger ? '#ff4444' : '#00aaff'};">${Math.round(state.status.thirst)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.thirst}%; background: linear-gradient(90deg, #0066ff, #00aaff); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('energy')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${energyDanger ? '#ff4444' : '#2a2a2a'}; ${energyDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">‚ö° <span style="color: ${energyDanger ? '#ff4444' : '#99ff00'};">${Math.round(state.status.energy)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.energy}%; background: linear-gradient(90deg, #66cc00, #99ff00); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('mood')" style="flex: 1; background: #151515; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid #2a2a2a;">
                                <div style="font-size: 0.65rem;">üß† <span style="color: #cc66ff;">${Math.round(state.status.mood)}%</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.mood}%; background: linear-gradient(90deg, #9933ff, #cc66ff); border-radius: 1px;"></div></div>
                            </div>
                            <div onclick="showStatusDetails('radiation')" style="flex: 1; background: ${radLethal ? '#2a0000' : '#151515'}; padding: 0.2rem; border-radius: 3px; text-align: center; cursor: pointer; border: 1px solid ${radLethal ? '#ff0000' : radCritical ? '#ff6600' : radDanger ? '#ff9900' : '#2a2a2a'}; ${radCritical ? 'animation: pulse-glow 0.5s infinite;' : radDanger ? 'animation: pulse-glow 1s infinite;' : ''}">
                                <div style="font-size: 0.65rem;">‚ò¢Ô∏è <span style="color: ${radLethal ? '#ff0000' : radCritical ? '#ff4400' : radDanger ? '#ff9900' : '#76ff03'};">${Math.round(state.status.radiation)}${radLethal ? '‚ò†Ô∏è' : radCritical ? '!' : ''}</span></div>
                                <div style="height: 2px; background: #333; border-radius: 1px; margin-top: 2px;"><div style="height: 100%; width: ${state.status.radiation}%; background: ${radLethal ? '#ff0000' : 'linear-gradient(90deg, #76ff03, #ff9900, #ff0000)'}; border-radius: 1px;"></div></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update travel timer if traveling
                if (state.map.traveling && state.activeTab === 'map') {
                    const remainingSec = Math.max(0, Math.ceil((state.map.travelStart + state.map.travelDuration - Date.now()) / 1000));
                    const mins = Math.floor(remainingSec / 60);
                    const secs = remainingSec % 60;
                    const timeText = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                    const timerEl = document.querySelector('.tab.active p');
                    if (timerEl && timerEl.textContent.includes('Zb√Ωv√°:')) {
                        timerEl.textContent = `Zb√Ωv√°: ${timeText}`;
                    }
                }
            }
            
            // Only render full UI on state change
            if (!state.confirmed) renderCreation();
        }
        
        function renderFull() {
            // Debug log pouze p≈ôi prvn√≠m renderov√°n√≠
            if (!window._renderFullLogged) {
                console.log('üé® renderFull() - confirmed:', state.confirmed);
                if (state.confirmed) window._renderFullLogged = true;
            }
            
            // KONTROLA XP syst√©mu - p≈ôepoƒç√≠tej level z totalXP
            if (state.confirmed && state.char?.level >= 1) {
                // Zajisti ≈æe totalXP existuje
                if (state.char.totalXP === undefined || state.char.totalXP === null) {
                    state.char.totalXP = state.char.xp || 0;
                }
                
                // P≈ôepoƒç√≠tej level z totalXP (t√≠m se oprav√≠ i bugnut√© ulo≈æen√© hry)
                if (typeof recalculateLevelFromTotalXP === 'function') {
                    recalculateLevelFromTotalXP();
                }
                
                // Debug log (jen jednou)
                if (!window._xpDebugLogged) {
                    console.log(`üéÆ XP Status: Level ${state.char.level}, XP: ${state.char.xp}/${state.char.xpNeed}, TotalXP: ${state.char.totalXP}`);
                    window._xpDebugLogged = true;
                }
            }
            
            // Aktualizuj maxHp podle skill≈Ø a atribut≈Ø
            if (state.confirmed && typeof calculateMaxHp === 'function') {
                const newMaxHp = calculateMaxHp();
                if (newMaxHp !== state.char.maxHp) {
                    const diff = newMaxHp - state.char.maxHp;
                    state.char.maxHp = newMaxHp;
                    // Pokud se maxHp zv√Ω≈°ilo, p≈ôidej HP
                    if (diff > 0) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + diff);
                    }
                }
            }
            
            // Aktualizuj nosnost podle skill≈Ø (pack_rat, s√≠la, batoh, exoskelet)
            if (state.confirmed && typeof updateCarryWeight === 'function') {
                updateCarryWeight();
            }
            
            // Migration: Fix ALL companions - runs on every render to ensure correctness
            if (state.companions && state.companions.length > 0) {
                state.companions.forEach(comp => {
                    // Najdi definici spoleƒçn√≠ka
                    const baseDef = COMPANIONS.find(c => c.id === comp.id);
                    
                    // Oprava freed_slave spoleƒçn√≠k≈Ø (speci√°ln√≠ p≈ô√≠pad)
                    if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                        comp.id = 'survivor';
                        comp.type = 'human';
                        comp.canEquip = true;
                    }
                    
                    // Dopl≈à chybƒõj√≠c√≠ atributy z definice nebo pou≈æij v√Ωchoz√≠ hodnoty
                    if (!comp.type) comp.type = baseDef?.type || 'human';
                    if (!comp.name) comp.name = baseDef?.name || 'Spoleƒçn√≠k';
                    if (!comp.icon) comp.icon = baseDef?.icon || 'üë§';
                    if (!comp.damage) comp.damage = baseDef?.damage || 10;
                    if (!comp.defense) comp.defense = baseDef?.defense || 5;
                    if (!comp.maxHp) comp.maxHp = baseDef?.hp || 50;
                    if (!comp.hp) comp.hp = comp.maxHp;
                    if (comp.level === undefined) comp.level = 1;
                    if (comp.xp === undefined) comp.xp = 0;
                    if (comp.skillPoints === undefined) comp.skillPoints = 0;
                    if (!comp.skills) comp.skills = [];
                    if (comp.loyalty === undefined) comp.loyalty = 50;
                    if (comp.inCombat === undefined) comp.inCombat = true;
                    
                    // Equipped jen pro lidi
                    if (comp.type === 'human' || comp.id === 'survivor') {
                        if (!comp.equipped) comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null, accessory: null };
                        if (comp.canEquip === undefined) comp.canEquip = true;
                    }
                });
            }
            
            // Migration: Add durability to weapons/armor that don't have it (runs once per render, safe)
            if (state.inv) {
                state.inv.forEach(item => {
                    if ((item.type === 'weapon' || item.type === 'armor') && item.durability === undefined) {
                        item.durability = 100;
                        item.maxDurability = 100;
                    }
                });
                
                // Konsoliduj invent√°≈ô - slouƒç duplicitn√≠ stacky
                consolidateInventory();
            }
            
            // Migration: Add settlement if missing
            if (!state.settlement) {
                state.settlement = {
                    level: 1,
                    prosperity: 0,
                    settlers: [],
                    buildings: [],
                    lastRaid: 0,
                    resources: { food: 10, water: 10 },
                    defense: 0,
                    lastUpdateDay: 0
                };
            }
            // Zajisti ≈æe v≈°echny properties existuj√≠
            if (!state.settlement.settlers) state.settlement.settlers = [];
            if (!state.settlement.buildings) state.settlement.buildings = [];
            if (!state.settlement.resources) state.settlement.resources = { food: 10, water: 10 };
            
            render();
            if (state.confirmed) renderGame();
            
            // Show sleep overlay if sleeping
            if (state.isSleeping && state.sleepEndTime) {
                const now = Date.now();
                const remaining = state.sleepEndTime - now;
                
                if (remaining > 0) {
                    const mins = Math.ceil(remaining / (60 * 1000));
                    const progress = ((state.sleepEndTime - state.lastSleepTime - remaining) / (state.sleepEndTime - state.lastSleepTime)) * 100;
                    
                    document.getElementById('modalContent').innerHTML = `
                        <div style="text-align: center;">
                            <h2 style="font-size: 3rem; margin: 0;">üí§</h2>
                            <h2 style="margin: 0.5rem 0;">Sp√≠≈°...</h2>
                            <p style="font-size: 1.2rem; color: #ff9800; margin: 1rem 0;">
                                ‚è±Ô∏è Zb√Ωv√°: <strong>${mins}</strong> minut
                            </p>
                            
                            <div style="background: #1a1a1a; height: 30px; border-radius: 15px; overflow: hidden; margin: 1.5rem 0; border: 2px solid #3a3a3a;">
                                <div style="background: linear-gradient(90deg, #8bc34a, #4caf50); height: 100%; width: ${progress}%; transition: width 1s;"></div>
                            </div>
                            
                            <p style="color: #999; font-size: 0.9rem;">
                                üîí Hra je zablokovan√° bƒõhem sp√°nku<br>
                                Bƒõhem t√©to doby nem≈Ø≈æe≈° dƒõlat nic
                            </p>
                        </div>
                    `;
                    document.getElementById('modal').classList.add('show');
                }
            }
        }
        
        function renderCreation() {
            // Use name from state - pokud pr√°zdn√©, zobraz placeholder
            const currentName = state.char.name || '(klikni pro zad√°n√≠ jm√©na)';
            
            const selectedClass = state.char.classId ? CLASSES[state.char.classId] : null;
            
            // Lokalizovan√© texty
            const texts = {
                createFirst: 'Nejprve vytvo≈ô postavu',
                gender: 'Pohlav√≠',
                selectGender: '‚ößÔ∏è Vybrat Pohlav√≠',
                class: 'Povol√°n√≠',
                selectClass: 'üé≠ Vybrat Povol√°n√≠',
                attributes: 'Atributy',
                freePoints: 'voln√© body',
                notSelected: 'Nevybr√°no'
            };
            
            document.getElementById('nav').innerHTML = `<div style="padding: 1rem; color: #999;">${texts.createFirst}</div>`;
            document.getElementById('main').innerHTML = `
                <div class="tab active">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <h2 style="margin: 0; flex: 1; min-width: 180px;">${t('charCreate', 'title')}</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="showLanguageSelector()" style="padding: 0.6rem 1rem; background: #333; font-size: 0.85rem;">
                                üåê
                            </button>
                            <button class="btn" onclick="showGameInfo()" style="padding: 0.6rem 1.2rem; background: #2196f3; font-size: 0.85rem; white-space: nowrap;">
                                ‚ÑπÔ∏è ${t('charCreate', 'whatIsThis')}
                            </button>
                        </div>
                    </div>
                    <label>${t('charCreate', 'name')}:</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                        <div style="flex: 1; background: #2a2a2a; padding: 0.8rem; border-radius: 6px; border: 1px solid #3a3a3a;">
                            <span id="nameDisplay" style="color: #e0e0e0;">${currentName}</span>
                        </div>
                        <button class="btn" onclick="editName()" style="padding: 0.8rem 1.2rem; background: #555;">‚úèÔ∏è</button>
                    </div>
                    
                    <h3>${texts.gender}</h3>
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        ${state.char.gender ? `
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="font-size: 3rem;">${getGenders()[state.char.gender].icon}</div>
                                <div>
                                    <h3 style="margin: 0;">${getGenders()[state.char.gender].name}</h3>
                                    <p style="color: #999; margin: 0.3rem 0;">${getGenders()[state.char.gender].desc}</p>
                                    <p style="color: #8bc34a; margin: 0.3rem 0;">
                                        ${Object.entries(GENDERS[state.char.gender].bonuses).map(([attr, bonus]) => 
                                            `+${bonus} ${getAttrs()[attr].name}`
                                        ).join(', ')}
                                    </p>
                                    <p style="color: #ff9800; margin: 0;">${getGenders()[state.char.gender].special}</p>
                                </div>
                            </div>
                        ` : `<p style="color: #999;">${texts.notSelected}</p>`}
                    </div>
                    <button class="btn" onclick="showGenders()" style="width: 100%; margin-bottom: 1rem;">${texts.selectGender}</button>
                    
                    <h3>${texts.class}</h3>
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        ${selectedClass ? `
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="font-size: 3rem;">${selectedClass.icon}</div>
                                <div>
                                    <h3 style="margin: 0;">${selectedClass.name}</h3>
                                    <p style="color: #999; margin: 0.3rem 0;">${selectedClass.desc}</p>
                                    <p style="color: #8bc34a; margin: 0.3rem 0;">${selectedClass.ability}</p>
                                    <p style="color: #ff9800; margin: 0;">${selectedClass.weapon.icon} ${selectedClass.weapon.name}</p>
                                </div>
                            </div>
                        ` : `<p style="color: #999;">${texts.notSelected}</p>`}
                    </div>
                    <button class="btn" onclick="showClasses()" style="width: 100%; margin-bottom: 1rem;">${texts.selectClass}</button>
                    
                    <h3>${texts.attributes} (${texts.freePoints}: ${state.char.points})</h3>
                    ${Object.entries(getAttrs()).map(([key, attr]) => `
                        <div class="attr-row">
                            <span style="flex: 1;">${attr.icon} <strong>${attr.name}</strong> (${attr.desc})</span>
                            <button class="attr-btn" onclick="changeAttr('${key}', -1)" ${state.char.attrs[key] <= 5 ? 'disabled' : ''}>‚àí</button>
                            <span style="font-size: 1.5rem; font-weight: bold; width: 30px; text-align: center;">${state.char.attrs[key]}</span>
                            <button class="attr-btn" onclick="changeAttr('${key}', 1)" ${state.char.points <= 0 ? 'disabled' : ''}>+</button>
                        </div>
                    `).join('')}
                    
                    <button class="btn" onclick="confirmCharacter()" style="width: 100%; margin-top: 1rem;">‚úì Potvrdit Postavu</button>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #333;">
                        <button class="btn" onclick="showImportSave()" style="width: 100%; background: #6A1B9A;">üì± ${'Importovat postavu z jin√©ho za≈ô√≠zen√≠'}</button>
                    </div>
                </div>
            `;
        }
        
        function renderGame() {
            try {
                console.log('üéÆ renderGame() started');
            document.getElementById('nav').innerHTML = `
                <button class="nav-btn ${state.activeTab === 'map' ? 'active' : ''}" data-tab="map">
                    <span class="icon">üó∫Ô∏è</span>
                    <span>${t('ui', 'map')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'inv' ? 'active' : ''}" data-tab="inv">
                    <span class="icon">üéí</span>
                    <span>${t('ui', 'inventory')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'char' ? 'active' : ''}" data-tab="char">
                    <span class="icon">‚ò¢Ô∏è</span>
                    <span>${'P≈ôe≈æiv≈°√≠'}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'craft' ? 'active' : ''}" data-tab="craft">
                    <span class="icon">üîß</span>
                    <span>${t('ui', 'craft')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'base' ? 'active' : ''}" data-tab="base">
                    <span class="icon">üèöÔ∏è</span>
                    <span>${t('ui', 'settlement')}</span>
                </button>
                <button class="nav-btn ${state.activeTab === 'multiplayer' ? 'active' : ''}" data-tab="multiplayer" style="background: ${multiplayerEnabled ? 'linear-gradient(180deg, #2a1a3a 0%, #1a0a2a 100%)' : ''}; border-color: ${multiplayerEnabled ? '#9c27b0' : ''};">
                    <span class="icon">${multiplayerEnabled ? 'üåê' : 'üì°'}</span>
                    <span>Online</span>
                </button>
            `;
            
            // Add event listeners to nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            document.getElementById('main').innerHTML = `
                <div class="tab ${state.activeTab === 'map' ? 'active' : ''}" id="tabMap">
                    <!-- NOV√ù MAPOV√ù SYST√âM -->
                    ${renderWorldMap()}
                </div>
                <div class="tab ${state.activeTab === 'inv' ? 'active' : ''}" id="tabInv">
                    <!-- HEADER -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--rust); flex-wrap: wrap; gap: 0.3rem;">
                        <h2 style="margin: 0; border: none; padding: 0; font-size: 1rem;">üéí ${t('inv', 'title').toUpperCase()}</h2>
                        <div style="display: flex; gap: 0.3rem; align-items: center;">
                            <span style="background: #1a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid var(--metal-light); font-size: 0.7rem;">
                                ‚öñÔ∏è<span style="color: ${state.carryWeight > state.maxCarryWeight * 0.8 ? '#ff9800' : 'var(--toxic-green)'};">${state.carryWeight.toFixed(1)}</span>/${state.maxCarryWeight}kg
                            </span>
                            <span style="background: #1a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid var(--warning-yellow); font-size: 0.7rem;">
                                üí∞<span style="color: var(--warning-yellow);">${state.money || 0}</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- HLAVN√ç LAYOUT: Equipment + Suroviny -->
                    <div class="responsive-2col" style="margin-bottom: 1rem;">
                        
                        <!-- VYBAVEN√ç - Character Slots -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem; text-align: center;">‚öîÔ∏è ${t('inv', 'equipment').toUpperCase()}</h3>
                            
                            ${(() => {
                                const weapon = state.equipped?.weapon || null;
                                const armor = state.equipped?.armor || null;
                                const gloves = state.equipped?.gloves || null;
                                const boots = state.equipped?.boots || null;
                                const helmet = state.equipped?.helmet || null;
                                const accessory = state.equippedAccessory ? state.inv.find(i => i.id === state.equippedAccessory) : null;
                                
                                let totalAttack = 5 + state.char.attrs.str;
                                if (weapon) totalAttack += weapon.damage || 0;
                                if (state.char.classId === 'raider') totalAttack = Math.floor(totalAttack * 1.3);
                                if (state.base.includes('armory')) totalAttack = Math.floor(totalAttack * 1.1);
                                
                                // Pou≈æij spr√°vnou funkci pro v√Ωpoƒçet obrany
                                const totalDefense = calculateDefense();
                                
                                return `
                                    <!-- Equipment Grid - 6 slot≈Ø -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; margin-bottom: 0.5rem;">
                                        <!-- Helmet -->
                                        <div onclick="showEquipmentSlot('helmet')" style="cursor: pointer; background: ${helmet ? 'linear-gradient(135deg, #1a2a1a, #0a1a0a)' : '#0a0a0a'}; border: 1px solid ${helmet ? 'var(--toxic-dark)' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${helmet ? helmet.icon : 'üé≠'}</div>
                                            <div style="font-size: 0.45rem; color: ${helmet ? 'var(--toxic-green)' : '#555'};">${helmet ? getItemName(helmet).substring(0,5) : 'Helma'}</div>
                                        </div>
                                        
                                        <!-- Armor -->
                                        <div onclick="showEquipmentSlot('armor')" style="cursor: pointer; background: ${armor ? 'linear-gradient(135deg, #1a1a2a, #0a0a1a)' : '#0a0a0a'}; border: 1px solid ${armor ? '#3949AB' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${armor ? armor.icon : 'üëï'}</div>
                                            <div style="font-size: 0.45rem; color: ${armor ? '#7986CB' : '#555'};">${armor ? getItemName(armor).substring(0, 5) : 'Zbroj'}</div>
                                        </div>
                                        
                                        <!-- Accessory -->
                                        <div onclick="showAccessoryModal()" style="cursor: pointer; background: ${accessory ? 'linear-gradient(135deg, #2a2a1a, #1a1a0a)' : '#0a0a0a'}; border: 1px solid ${accessory ? '#ffd700' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${accessory ? accessory.icon : 'üíç'}</div>
                                            <div style="font-size: 0.45rem; color: ${accessory ? '#ffd700' : '#555'};">${accessory ? getItemName(accessory).substring(0, 5) : 'Doplnƒõk'}</div>
                                        </div>
                                        
                                        <!-- Weapon -->
                                        <div onclick="showEquipmentSlot('weapon')" style="cursor: pointer; background: ${weapon ? 'linear-gradient(135deg, #2a1a1a, #1a0a0a)' : '#0a0a0a'}; border: 1px solid ${weapon ? '#8B0000' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${weapon ? weapon.icon : '‚úä'}</div>
                                            <div style="font-size: 0.45rem; color: ${weapon ? '#ff6666' : '#555'};">${weapon ? getItemName(weapon).substring(0, 5) : 'Zbra≈à'}</div>
                                            ${weapon?.ammoType ? `<div style="font-size: 0.4rem; color: ${getAmmoCount(weapon.ammoType) > 0 ? '#4caf50' : '#f44336'};">üî∏${getAmmoCount(weapon.ammoType)}</div>` : ''}
                                        </div>
                                        
                                        <!-- Gloves -->
                                        <div onclick="showEquipmentSlot('gloves')" style="cursor: pointer; background: ${gloves ? 'linear-gradient(135deg, #2a2a1a, #1a1a0a)' : '#0a0a0a'}; border: 1px solid ${gloves ? '#ff9800' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${gloves ? gloves.icon : 'ü•ä'}</div>
                                            <div style="font-size: 0.45rem; color: ${gloves ? '#ff9800' : '#555'};">${gloves ? getItemName(gloves).substring(0, 5) : 'Ruce'}</div>
                                        </div>
                                        
                                        <!-- Boots -->
                                        <div onclick="showEquipmentSlot('boots')" style="cursor: pointer; background: ${boots ? 'linear-gradient(135deg, #1a2a2a, #0a1a1a)' : '#0a0a0a'}; border: 1px solid ${boots ? '#00bcd4' : 'var(--metal-light)'}; border-radius: 4px; padding: 0.3rem; text-align: center; min-height: 45px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="font-size: 1.1rem;">${boots ? boots.icon : 'ü•æ'}</div>
                                            <div style="font-size: 0.45rem; color: ${boots ? '#00bcd4' : '#555'};">${boots ? getItemName(boots).substring(0, 5) : 'Boty'}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Combat Stats -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                                        <div onclick="showAttackInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid #8B0000;">
                                            <div style="font-size: 1.1rem; color: #ff4444; font-weight: bold;">‚öîÔ∏è${totalAttack}</div>
                                            <div style="font-size: 0.55rem; color: #666;">${'√öTOK'}</div>
                                        </div>
                                        <div onclick="showDefenseInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid var(--toxic-dark);">
                                            <div style="font-size: 1.1rem; color: var(--toxic-green); font-weight: bold;">üõ°Ô∏è${totalDefense}</div>
                                            <div style="font-size: 0.55rem; color: #666;">${'OBRANA'}</div>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                        
                        <!-- SUROVINY -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem; text-align: center;">üì¶ ${'SUROVINY'}</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.2rem;">
                                ${[
                                    { key: 'raw_meat', icon: 'ü•©', name: 'Syrov√© maso', color: '#D32F2F', desc: 'Syrov√© maso ze zv√≠≈ôat. ‚ö†Ô∏è Kaz√≠ se za 6 dn√≠! Upeƒç ho nebo prodej.' },
                                    { key: 'fish', icon: 'üêü', name: 'Ryby', color: '#1976D2', desc: 'ƒåerstv√© ryby. ‚ö†Ô∏è Kaz√≠ se za 4 dny! Chyt√°≈° u jezer a ≈ôek.' },
                                    { key: 'wood', icon: 'üå≤', name: 'D≈ôevo', color: '#8B4513', desc: 'Z√°kladn√≠ surovina pro stavbu a topen√≠. Najde≈° v les√≠ch a h√°j√≠ch.' },
                                    { key: 'metal', icon: '‚öôÔ∏è', name: 'Kov', color: '#607D8B', desc: 'Kovov√Ω ≈°rot a souƒç√°stky. Najde≈° v≈°ude, nejv√≠c v ruin√°ch a tov√°rn√°ch.' },
                                    { key: 'stone', icon: 'üóø', name: 'K√°men', color: '#757575', desc: 'Pevn√Ω materi√°l pro stavbu a n√°stroje. Bƒõ≈ænƒõ dostupn√Ω.' },
                                    { key: 'cloth', icon: 'üßµ', name: 'L√°tka', color: '#9C27B0', desc: 'Textilie pro v√Ωrobu obleƒçen√≠ a obvaz≈Ø. Najde≈° v obchodech a domech.' },
                                    { key: 'leather', icon: 'ü¶¥', name: 'K≈Ø≈æe', color: '#795548', desc: 'Vydƒõlan√© k≈Ø≈æe pro lehkou zbroj. Z√≠sk√°≈° z lovu zv√≠≈ôat v les√≠ch.' },
                                    { key: 'herbs', icon: 'üåø', name: 'Bylinky', color: '#4CAF50', desc: 'L√©ƒçiv√© rostliny. ‚ö†Ô∏è Kaz√≠ se za 10 dn√≠! Rostou v les√≠ch a u laborato≈ô√≠.' },
                                    { key: 'chemicals', icon: 'üß™', name: 'Chemik√°lie', color: '#00BCD4', desc: 'R≈Øzn√© chemick√© l√°tky. Najde≈° v nemocnic√≠ch, laborato≈ô√≠ch a tov√°rn√°ch.' },
                                    { key: 'electronics', icon: 'üíæ', name: 'Elektronika', color: '#2196F3', desc: 'Souƒç√°stky z elektronick√Ωch za≈ô√≠zen√≠. Hledej ve mƒõstech a laborato≈ô√≠ch.' },
                                    { key: 'fuel', icon: '‚õΩ', name: 'Palivo', color: '#FF5722', desc: 'Ho≈ôlavina pro gener√°tory a motorov√© zbranƒõ. Najde≈° na benz√≠nk√°ch a v tov√°rn√°ch.' },
                                    { key: 'gunpowder', icon: 'üí•', name: 'St≈ôeln√Ω prach', color: '#F44336', desc: 'Nebezpeƒçn√° l√°tka pro v√Ωrobu munice. Vyr√°b√≠ se z chemik√°li√≠.' },
                                    { key: 'scrap', icon: 'üî©', name: '≈†rot', color: '#9E9E9E', desc: 'Smƒõs kovu a plast≈Ø. V≈°ude v ruin√°ch, tov√°rn√°ch a mƒõstech.' },
                                    { key: 'glass', icon: 'üîÆ', name: 'Sklo', color: '#03A9F4', desc: 'St≈ôepy a sklenƒõn√© ƒç√°sti. Najde≈° ve mƒõstech, obchodech a nemocnic√≠ch.' },
                                    { key: 'rope', icon: '‚û∞', name: 'Provaz', color: '#8D6E63', desc: 'Lana a provazy. Vyr√°b√≠≈° z l√°tky, najde≈° ve skladech a na stavb√°ch.' }
                                ].map(r => `
                                    <div onclick="showResourceInfo('${r.key}', '${r.icon}', '${r.name}', '${r.desc}', '${r.color}')" style="cursor: pointer; background: #0a0a0a; padding: 0.2rem; border-radius: 3px; text-align: center; border: 1px solid ${state.resources[r.key] > 0 ? r.color : '#222'}; transition: transform 0.1s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="font-size: 0.8rem;">${r.icon}</div>
                                        <div style="font-size: 0.7rem; font-weight: bold; color: ${state.resources[r.key] > 0 ? r.color : '#333'};">${state.resources[r.key] || 0}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Vz√°cn√© suroviny -->
                            <div style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--metal-light);">
                                <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.4rem; text-align: center;">üíé ${'VZ√ÅCN√â'}</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                                    ${[
                                        { key: 'copper', icon: 'üü§', name: 'Mƒõƒè', desc: 'Vodiv√Ω kov pro elektroniku a munici.' },
                                        { key: 'silver', icon: '‚¨ú', name: 'St≈ô√≠bro', desc: 'Vz√°cn√Ω kov s antimikrobi√°ln√≠mi vlastnostmi.' },
                                        { key: 'gold', icon: 'üü°', name: 'Zlato', desc: 'Velmi cenn√Ω kov. Pou≈æ√≠v√° se jako mƒõna.' },
                                        { key: 'crystal', icon: 'üí†', name: 'Krystal', desc: 'Z√°hadn√© krystaly s energetick√Ωmi vlastnostmi.' },
                                        { key: 'fur', icon: 'ü¶ä', name: 'Ko≈æe≈°ina', desc: 'Tepl√° ko≈æe≈°ina ze zv√≠≈ôat. Pro zimn√≠ v√Ωstroj.' },
                                        { key: 'mutant_blood', icon: 'ü©∏', name: 'Mutant√≠ krev', desc: 'Toxick√° krev mutant≈Ø. Pro speci√°ln√≠ zbroje.' }
                                    ].map(r => `
                                        <div onclick="showResourceInfo('${r.key}', '${r.icon}', '${r.name}', '${r.desc}', 'var(--warning-yellow)')" style="cursor: pointer; background: #0a0a0a; padding: 0.3rem; border-radius: 4px; text-align: center; border: 1px solid ${state.resources[r.key] > 0 ? 'var(--warning-yellow)' : '#222'}; transition: transform 0.1s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                            <div style="font-size: 0.9rem;">${r.icon}</div>
                                            <div style="font-size: 0.8rem; font-weight: bold; color: ${state.resources[r.key] > 0 ? 'var(--warning-yellow)' : '#333'};">${state.resources[r.key] || 0}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INVENT√Å≈ò P≈òEDMƒöT≈Æ -->
                    <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 1rem; border-radius: 8px; border: 2px solid var(--metal-light);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h3 style="margin: 0; color: var(--rust-light);">üéí ${ui('items')} (${state.inv.length})</h3>
                            <div style="display: flex; gap: 0.2rem; flex-wrap: wrap; align-items: center;">
                                <button onclick="mergeInventoryStacks()" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; background: #9c27b0;" title="Spojit rozdƒõlen√© stacky">üîó</button>
                                <button onclick="filterInventory('all')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${(window.inventoryFilter || 'all') === 'all' ? 'background: var(--toxic-green); color: #000;' : 'background: var(--metal-mid);'}">V≈°e</button>
                                <button onclick="filterInventory('healing')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'healing' ? 'background: #E91E63;' : 'background: #880E4F;'}">‚ù§Ô∏è</button>
                                <button onclick="filterInventory('consumable')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'consumable' ? 'background: #FF6D00;' : 'background: #E65100;'}">üçñ</button>
                                <button onclick="filterInventory('weapon')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'weapon' ? 'background: #D32F2F;' : 'background: #8B0000;'}">‚öîÔ∏è</button>
                                <button onclick="filterInventory('armor')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'armor' ? 'background: #5C6BC0;' : 'background: #3949AB;'}">üõ°Ô∏è</button>
                                <button onclick="filterInventory('helmet')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'helmet' ? 'background: #7B1FA2;' : 'background: #4A148C;'}">‚õëÔ∏è</button>
                                <button onclick="filterInventory('gloves')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'gloves' ? 'background: #F57C00;' : 'background: #E65100;'}">ü•ä</button>
                                <button onclick="filterInventory('boots')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'boots' ? 'background: #00ACC1;' : 'background: #00838F;'}">ü•æ</button>
                                <button onclick="filterInventory('tool')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'tool' ? 'background: #8D6E63;' : 'background: #5D4037;'}">üîß</button>
                                <button onclick="filterInventory('ammo')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.65rem; ${window.inventoryFilter === 'ammo' ? 'background: #FFA000;' : 'background: #FF8F00;'}">üéØ</button>
                            </div>
                        </div>
                        
                        <!-- Nosnost bar -->
                        <div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.8rem; border: 1px solid var(--metal-light);">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.2rem;">
                                <span>üì¶ ${ui('capacity')}</span>
                                <span style="color: ${state.carryWeight > state.maxCarryWeight * 0.8 ? '#ff9800' : 'var(--toxic-green)'};">${state.carryWeight.toFixed(1)} / ${state.maxCarryWeight} kg</span>
                            </div>
                            <div style="background: #1a1a1a; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${Math.min(100, (state.carryWeight / state.maxCarryWeight) * 100)}%; background: linear-gradient(90deg, var(--toxic-green), ${state.carryWeight > state.maxCarryWeight * 0.8 ? '#ff9800' : 'var(--toxic-green)'});"></div>
                            </div>
                            <button onclick="showLootFilterSettings()" style="width: 100%; margin-top: 0.4rem; padding: 0.3rem; font-size: 0.7rem; background: #2a2a3a; border: 1px solid #444; border-radius: 4px; color: #888; cursor: pointer;">
                                üéí Auto-loot nastaven√≠
                            </button>
                        </div>
                        
                        ${(() => {
                            const currentFilter = window.inventoryFilter || 'all';
                            let filteredInv;
                            if (currentFilter === 'all') {
                                filteredInv = state.inv;
                            } else if (currentFilter === 'healing') {
                                filteredInv = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
                            } else {
                                filteredInv = state.inv.filter(i => i.type === currentFilter);
                            }
                            
                            if (state.inv.length === 0) {
                                return `<div style="text-align: center; padding: 3rem; color: #555;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                                    <div>Invent√°≈ô je pr√°zdn√Ω</div>
                                    <div style="font-size: 0.8rem; margin-top: 0.5rem;">Prozkoumej wasteland a sb√≠rej ko≈ôist!</div>
                                </div>`;
                            }
                            
                            if (filteredInv.length === 0) {
                                return `<div style="text-align: center; padding: 2rem; color: #666;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                                    <div>≈Ω√°dn√© p≈ôedmƒõty typu "${currentFilter}"</div>
                                    <button onclick="filterInventory('all')" class="btn" style="margin-top: 0.5rem; padding: 0.3rem 0.8rem; font-size: 0.8rem;">Zobrazit v≈°e</button>
                                </div>`;
                            }
                            
                            return `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.6rem; max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.5rem;">
                                ${filteredInv.map((i) => {
                                    const realIdx = state.inv.indexOf(i);
                                    const typeColors = {
                                        'consumable': { bg: '#1a1a0a', border: '#E65100', glow: 'rgba(230, 81, 0, 0.3)' },
                                        'weapon': { bg: '#1a0a0a', border: '#8B0000', glow: 'rgba(139, 0, 0, 0.3)' },
                                        'armor': { bg: '#0a0a1a', border: '#3949AB', glow: 'rgba(57, 73, 171, 0.3)' },
                                        'tool': { bg: '#1a1510', border: '#5D4037', glow: 'rgba(93, 64, 55, 0.3)' },
                                        'lore': { bg: '#1a1a2a', border: '#9c7cff', glow: 'rgba(156, 124, 255, 0.3)' },
                                        'misc': { bg: '#1a1a1a', border: '#616161', glow: 'rgba(97, 97, 97, 0.3)' }
                                    };
                                    const tc = typeColors[i.type] || typeColors.misc;
                                    
                                    let effectText = '';
                                    if (i.type === 'consumable') {
                                        if (i.effect === 'health') effectText = '‚ù§Ô∏è+' + i.value;
                                        else if (i.effect === 'hunger') effectText = 'üçñ+' + i.value + '%';
                                        else if (i.effect === 'thirst') effectText = 'üíß+' + i.value + '%';
                                        else if (i.effect === 'energy') effectText = '‚ö°+' + i.value + '%';
                                        else if (i.effect === 'radiation') effectText = '‚ò¢Ô∏è' + i.value;
                                        else if (i.effect === 'sleep') effectText = 'üí§ ' + ui('sleep');
                                    } else if (i.type === 'weapon') {
                                        effectText = '‚öîÔ∏è+' + i.damage + ' DMG';
                                        if (i.ammoType) effectText += ' üî∏' + getAmmoName(i.ammoType);
                                        if (i.special) effectText += ' ‚≠ê';
                                    } else if (i.type === 'armor') {
                                        effectText = 'üõ°Ô∏è+' + i.defense + ' DEF';
                                    } else if (i.type === 'throwable') {
                                        effectText = 'üí•' + (i.damage || '?') + ' DMG';
                                    } else if (i.type === 'weapon_coating') {
                                        effectText = (i.effect === 'poison' ? '‚ò†Ô∏è ' + ui('poison') : 'üî• ' + ui('fire')) + ' ' + (i.uses || 5) + 'x';
                                    } else if (i.type === 'accessory') {
                                        effectText = i.desc ? i.desc.substring(0, 15) : 'üíç';
                                    } else if (i.type === 'ammo') {
                                        const ammoNames = { 
                                            'arrow': 'üèπ ' + ui('bow'), 
                                            'bolt': 'üéØ ' + ui('crossbowAmmo'), 
                                            '9mm': 'üî´ ' + ui('pistolAmmo'), 
                                            '556': 'üî´ ' + ui('rifleAmmo'), 
                                            '762': 'üî´ ' + ui('sniperAmmo'), 
                                            'shell': 'üî´ ' + ui('shotgunAmmo'), 
                                            'fuel': 'üî• ' + ui('flameAmmo') 
                                        };
                                        effectText = ammoNames[i.ammoType] || ('üéØ ' + ui('ammo'));
                                    } else if (i.type === 'lore') {
                                        const isRead = state.readBooks?.includes(i.id);
                                        effectText = isRead ? 'üìñ ' + ui('readStatus') : 'üìï ' + ui('unread');
                                    } else if (i.type === 'gloves') {
                                        effectText = 'ü•ä+' + (i.defense || 0) + ' DEF';
                                        if (i.special) effectText += ' ‚≠ê';
                                    } else if (i.type === 'boots') {
                                        effectText = 'ü•æ+' + (i.defense || 0) + ' DEF';
                                        if (i.special === 'speed_bonus') effectText += ' üèÉ+10%';
                                        else if (i.special === 'dodge_bonus') effectText += ' üí®+10%';
                                        else if (i.special === 'stealth_move') effectText += ' ü•∑-20%';
                                        else if (i.special === 'run_bonus') effectText += ' üèÉ+15%';
                                        else if (i.special) effectText += ' ‚≠ê';
                                    } else if (i.type === 'helmet') {
                                        effectText = '‚õëÔ∏è+' + (i.defense || 0) + ' DEF';
                                        if (i.special) effectText += ' ‚≠ê';
                                    }
                                    
                                    // Clickable types - use index for unique identification
                                    const isClickable = i.type === 'consumable' || i.type === 'weapon_coating' || i.type === 'accessory' || i.type === 'weapon' || i.type === 'tool' || i.type === 'armor' || i.type === 'ammo' || i.type === 'throwable' || i.type === 'lore' || i.type === 'gloves' || i.type === 'boots' || i.type === 'helmet';
                                    let clickAction = '';
                                    if (i.type === 'consumable') clickAction = "confirmUseItemByIndex(" + realIdx + ")";
                                    else if (i.type === 'weapon_coating') clickAction = "applyWeaponCoatingByIndex(" + realIdx + ")";
                                    else if (i.type === 'accessory') clickAction = "equipAccessoryByIndex(" + realIdx + ")";
                                    else if (i.type === 'weapon') clickAction = "showWeaponOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'tool') clickAction = "showToolOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'armor') clickAction = "showArmorOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'gloves') clickAction = "showGlovesOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'boots') clickAction = "showBootsOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'helmet') clickAction = "showHelmetOptionsByIndex(" + realIdx + ")";
                                    else if (i.type === 'ammo') clickAction = "showAmmoInfoByIndex(" + realIdx + ")";
                                    else if (i.type === 'throwable') clickAction = "showThrowableInfoByIndex(" + realIdx + ")";
                                    else if (i.type === 'lore') clickAction = "readLoreBook('" + i.id + "')";
                                    
                                    return `
                                        <div class="card" onclick="${clickAction}" 
                                            style="background: linear-gradient(135deg, ${tc.bg}, #0a0a0a); border-color: ${isItemEquipped(i) ? '#4caf50' : (i.rarity ? RARITY_COLORS[i.rarity] : tc.border)}; padding: 0.6rem; cursor: ${isClickable ? 'pointer' : 'default'}; position: relative; ${isClickable ? 'box-shadow: 0 0 15px ' + (isItemEquipped(i) ? 'rgba(76, 175, 80, 0.5)' : (i.rarity ? RARITY_COLORS[i.rarity] + '44' : tc.glow)) + ';' : ''}">
                                            
                                            ${isItemEquipped(i) ? '<div style="position: absolute; top: 4px; left: 6px; background: #4caf50; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.6rem; font-weight: bold; color: #000;">‚úì NASAZENO</div>' : ''}
                                            
                                            ${i.count > 1 ? '<div style="position: absolute; top: 4px; right: 6px; background: var(--rust); padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">x' + i.count + '</div>' : ''}
                                            
                                            ${!isItemEquipped(i) && i.rarity ? '<div style="position: absolute; top: 4px; left: 6px; background: ' + RARITY_COLORS[i.rarity] + '22; border: 1px solid ' + RARITY_COLORS[i.rarity] + '; padding: 0.05rem 0.3rem; border-radius: 3px; font-size: 0.55rem; color: ' + RARITY_COLORS[i.rarity] + '; text-transform: uppercase;">' + (getRarityName(i.rarity) || i.rarity) + '</div>' : ''}
                                            
                                            <div style="text-align: center; ${i.rarity ? 'margin-top: 0.8rem;' : ''}">
                                                <div style="font-size: 2rem; margin-bottom: 0.3rem;">${i.icon}</div>
                                                <div style="font-size: 0.75rem; font-weight: bold; color: ${i.rarity ? RARITY_COLORS[i.rarity] : '#ddd'}; margin-bottom: 0.2rem;">${getItemName(i.id) || i.name}</div>
                                                ${effectText ? '<div style="font-size: 0.7rem; color: ' + tc.border + '; margin-bottom: 0.2rem;">' + effectText + '</div>' : ''}
                                                <div style="font-size: 0.65rem; color: #555;">‚öñÔ∏è${i.weight || 0}kg</div>
                                            </div>
                                            
                                            ${i.durability !== undefined ? `
                                                <div style="margin-top: 0.4rem; background: #0a0a0a; height: 4px; border-radius: 2px; overflow: hidden;">
                                                    <div style="height: 100%; width: ${(i.durability/i.maxDurability)*100}%; background: ${(i.durability/i.maxDurability) > 0.5 ? 'var(--toxic-green)' : (i.durability/i.maxDurability) > 0.2 ? 'var(--warning-yellow)' : '#ff4444'};"></div>
                                                </div>
                                            ` : ''}
                                            
                                            ${i.type === 'consumable' ? '<div style="font-size: 0.6rem; color: var(--toxic-green); text-align: center; margin-top: 0.3rem;">‚ñ∂ ' + ui('use') + '</div>' : ''}
                                            ${i.type === 'lore' ? '<div style="font-size: 0.6rem; color: #9c7cff; text-align: center; margin-top: 0.3rem;">üìñ ' + ui('read') + '</div>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>`;
                        })()}
                    </div>
                    
                    ${state.map.inBase ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #1a2a1a, #0a1a0a); border-radius: 8px; border: 2px solid var(--toxic-dark);">
                            <p style="color: var(--toxic-green); margin: 0; font-size: 0.85rem;">
                                üí° <strong>${'V √∫krytu'}</strong> - ${'m≈Ø≈æe≈° ukl√°dat vƒõci do skr√Ω≈°e p≈ôes z√°lo≈æku Osada'}
                            </p>
                        </div>
                    ` : ''}
                </div>
                <div class="tab ${state.activeTab === 'char' ? 'active' : ''}" id="tabChar">
                    <!-- HEADER -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--rust); flex-wrap: wrap; gap: 0.5rem;">
                        <h2 style="margin: 0; border: none; padding: 0; font-size: 1rem;">‚ò¢Ô∏è ${ui('survivor')}</h2>
                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                            <button class="btn" onclick="openCustomization()" style="padding: 0.3rem 0.6rem; font-size: 0.7rem;">üé® ${ui('look')}</button>
                            <button class="btn" onclick="openSkillTree()" style="padding: 0.3rem 0.6rem; font-size: 0.7rem; background: var(--toxic-dark);">üå≥ ${ui('skills')} ${state.skillTreePoints ? '(' + state.skillTreePoints + ')' : ''}</button>
                        </div>
                    </div>
                    
                    <!-- PROFIL + BOJOV√â STATS -->
                    <div class="responsive-2col" style="margin-bottom: 0.8rem;">
                        <!-- Profil -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <div style="display: flex; gap: 0.8rem; align-items: center; margin-bottom: 0.8rem;">
                                <div style="font-size: 2.5rem;">${CLASSES[state.char.classId]?.icon || 'üë§'}</div>
                                <div style="min-width: 0; flex: 1;">
                                    <div style="font-size: 1rem; font-weight: bold; color: var(--warning-yellow); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${state.char.name}</div>
                                    <div style="font-size: 0.7rem; color: #888;">${state.char.gender ? (GENDERS[state.char.gender].name) : ''} ${getClassName(state.char.classId)}</div>
                                    <div style="font-size: 0.65rem; color: var(--toxic-green);">${state.appearance?.title ? TITLES.find(t => t.id === state.appearance.title)?.name || '' : ''}</div>
                                </div>
                            </div>
                            
                            <!-- Level bar -->
                            <div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px; border: 1px solid var(--metal-light);">
                                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 0.2rem;">
                                    <span>‚≠ê Lv.${state.char.level}</span>
                                    <span style="color: var(--toxic-green);">${state.char.xp}/${state.char.xpNeed}</span>
                                </div>
                                <div style="background: #1a1a1a; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${(state.char.xp / state.char.xpNeed) * 100}%; background: linear-gradient(90deg, var(--rust), var(--warning-yellow));"></div>
                                </div>
                            </div>
                            
                            <!-- V√ùHODA POVOL√ÅN√ç -->
                            ${(() => {
                                const classData = CLASSES[state.char.classId];
                                if (!classData) return '';
                                
                                return `
                                    <div onclick="showClassAbilityInfo()" style="cursor: pointer; margin-top: 0.5rem; padding: 0.5rem; background: linear-gradient(135deg, ${classData.color}22, ${classData.color}11); border-radius: 6px; border: 1px solid ${classData.color}55;">
                                        <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.3rem;">
                                            <span style="font-size: 1rem;">${classData.icon}</span>
                                            <span style="font-size: 0.75rem; color: ${classData.color}; font-weight: bold;">${getClassName(state.char.classId)}</span>
                                        </div>
                                        <div style="font-size: 0.7rem; color: #ffd700; margin-bottom: 0.2rem;">‚ö° ${getClassAbility(state.char.classId)}</div>
                                        <div style="font-size: 0.65rem; color: #9c27b0;">üîÆ ${getClassPassive(state.char.classId)}</div>
                                    </div>
                                `;
                            })()}
                            
                            <!-- AKTIVN√ç DOVEDNOSTI ZE SKILL TREE -->
                            ${(() => {
                                // Sb√≠rej aktivn√≠ dovednosti ze v≈°ech vƒõtv√≠ skill tree
                                const activeSkills = [];
                                if (state.skillTree) {
                                    Object.entries(state.skillTree).forEach(([branchId, skills]) => {
                                        const branch = SKILL_TREE[branchId];
                                        if (branch && skills) {
                                            Object.entries(skills).forEach(([skillId, level]) => {
                                                if (level > 0) {
                                                    const skill = branch.skills.find(s => s.id === skillId);
                                                    if (skill) {
                                                        activeSkills.push({ ...skill, level, branchId, branchIcon: branch.icon, branchColor: branch.color });
                                                    }
                                                }
                                            });
                                        }
                                    });
                                }
                                
                                if (activeSkills.length === 0) {
                                    return `
                                        <div style="margin-top: 0.5rem; padding: 0.4rem; background: #0a0a0a; border-radius: 6px; border: 1px solid #333; text-align: center;">
                                            <span style="color: #666; font-size: 0.7rem;">${'üå≥ Nem√°≈° ≈æ√°dn√© dovednosti'}</span>
                                        </div>
                                    `;
                                }
                                
                                return `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: linear-gradient(135deg, #0a1a0a, #0a0a0a); border-radius: 6px; border: 1px solid var(--toxic-dark);">
                                        <div style="font-size: 0.7rem; color: var(--toxic-green); font-weight: bold; margin-bottom: 0.4rem;">${'üå≥ Aktivn√≠ dovednosti ('}${activeSkills.length})</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                                            ${activeSkills.map(skill => {
                                                return '<div onclick="openSkillTree()" style="cursor: pointer; background: linear-gradient(135deg, ' + skill.branchColor + '33, #0d0d0d); padding: 0.25rem 0.4rem; border-radius: 4px; border: 1px solid ' + skill.branchColor + '55; font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem;" title="' + skill.name + ': ' + skill.desc + '">' +
                                                    '<span>' + skill.icon + '</span>' +
                                                    '<span style="color: #fff; font-size: 0.65rem;">' + skill.name.substring(0, 8) + '</span>' +
                                                    '<span style="color: ' + skill.branchColor + '; font-weight: bold; font-size: 0.65rem;">' + skill.level + '</span>' +
                                                '</div>';
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            })()}
                            
                            <!-- Voln√© body -->
                            ${state.char.levelUpPoints > 0 || state.skillTreePoints > 0 ? `
                                <div style="margin-top: 0.5rem; padding: 0.4rem; background: linear-gradient(135deg, #1a2a1a, #0a1a0a); border-radius: 4px; border: 1px solid var(--toxic-dark);">
                                    <div style="font-size: 0.65rem; color: var(--toxic-green);">${'Voln√© body:'}</div>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.2rem; font-size: 0.7rem;">
                                        ${state.char.levelUpPoints > 0 ? '<span style="color: var(--warning-yellow);">üí™' + state.char.levelUpPoints + '</span>' : ''}
                                        ${state.skillTreePoints > 0 ? '<span style="color: var(--toxic-green);">üå≥' + state.skillTreePoints + '</span>' : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Bojov√© stats -->
                        <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--rust);">
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem;">${'‚öîÔ∏è BOJ'}</h3>
                            ${(() => {
                                let totalAttack = 5 + state.char.attrs.str;
                                const weapon = state.equipped?.weapon || null;
                                if (weapon) totalAttack += weapon.damage || 0;
                                if (state.char.classId === 'raider') totalAttack = Math.floor(totalAttack * 1.3);
                                if (state.base.includes('armory')) totalAttack = Math.floor(totalAttack * 1.1);
                                totalAttack = Math.floor(totalAttack * (1 + getSkillTreeBonus('damageBonus')));
                                
                                // Pou≈æij spr√°vnou funkci pro v√Ωpoƒçet obrany
                                const totalDefense = calculateDefense();
                                const armor = state.equipped?.armor || null;
                                
                                // Pou≈æij spr√°vn√© v√Ωpoƒçetn√≠ funkce
                                const critChance = Math.round(calculateCritChance() * 100);
                                const dodgeChance = Math.round(calculateDodgeChance() * 100);
                                
                                return `
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.3rem;">
                                        <div onclick="showAttackInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid #8B0000;">
                                            <div style="font-size: 1.1rem; color: #ff4444; font-weight: bold;">‚öîÔ∏è${totalAttack}</div>
                                            <div style="font-size: 0.55rem; color: #666;">√öTOK</div>
                                        </div>
                                        <div onclick="showDefenseInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid var(--toxic-dark);">
                                            <div style="font-size: 1.1rem; color: var(--toxic-green); font-weight: bold;">üõ°Ô∏è${totalDefense}</div>
                                            <div style="font-size: 0.55rem; color: #666;">DEF</div>
                                        </div>
                                        <div onclick="showCritInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid var(--warning-yellow);">
                                            <div style="font-size: 1rem; color: var(--warning-yellow); font-weight: bold;">üí•${critChance}%</div>
                                            <div style="font-size: 0.55rem; color: #666;">CRIT</div>
                                        </div>
                                        <div onclick="showDodgeInfo()" style="cursor: pointer; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center; border: 1px solid #3949AB;">
                                            <div style="font-size: 1rem; color: #7986CB; font-weight: bold;">üí®${dodgeChance}%</div>
                                            <div style="font-size: 0.55rem; color: #666;">√öHYB</div>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    
                    <!-- ATRIBUTY - kompaktn√≠ -->
                    <div style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 2px solid var(--metal-light); margin-bottom: 0.8rem;">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--rust-light); font-size: 0.8rem;">${'üí™ ATRIBUTY'}</h3>
                        <div class="responsive-6col">
                            ${Object.entries(ATTRS).map(([key, attr]) => {
                                const value = state.char.attrs[key] || 5;
                                return `
                                    <div onclick="${state.char.levelUpPoints > 0 ? 'levelUpAttr(\'' + key + '\')' : 'showAttrInfo(\'' + key + '\')'}" style="cursor: pointer; background: #0a0a0a; padding: 0.3rem; border-radius: 4px; text-align: center; border: 1px solid ${state.char.levelUpPoints > 0 ? 'var(--toxic-dark)' : 'var(--metal-light)'}; transition: transform 0.1s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="font-size: 1rem;">${attr.icon}</div>
                                        <div style="font-size: 0.9rem; font-weight: bold; color: var(--warning-yellow);">${value}</div>
                                        <div style="font-size: 0.5rem; color: #666;">${attr.name.substring(0,3)}</div>
                                        ${state.char.levelUpPoints > 0 ? '<div style="font-size: 0.5rem; color: var(--toxic-green);">+1</div>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- ACHIEVEMENTY -->
                    <details style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid var(--warning-yellow); margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: var(--warning-yellow); font-weight: bold;">
                            üèÜ ${'ACHIEVEMENTY'} (${state.achievements.length}/${ACHIEVEMENTS.length})
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                ${ACHIEVEMENTS.map(ach => {
                                    const unlocked = state.achievements.includes(ach.id);
                                    return `
                                        <div style="background: ${unlocked ? 'linear-gradient(135deg, #1a2a1a, #0a1a0a)' : '#0a0a0a'}; padding: 0.6rem; border-radius: 6px; border: 1px solid ${unlocked ? 'var(--toxic-dark)' : '#222'}; display: flex; align-items: center; gap: 0.5rem; opacity: ${unlocked ? '1' : '0.4'};">
                                            <div style="font-size: 1.5rem;">${unlocked ? ach.icon : 'üîí'}</div>
                                            <div>
                                                <div style="font-size: 0.8rem; font-weight: bold; color: ${unlocked ? 'var(--toxic-green)' : '#555'};">${getAchievementName(ach.id)}</div>
                                                <div style="font-size: 0.65rem; color: #666;">${getAchievementDesc(ach.id)}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                    
                    <!-- BESTI√Å≈ò -->
                    <details style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid #8B0000; margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: #ff4444; font-weight: bold;">
                            üìñ BESTI√Å≈ò (${Object.keys(state.stats.killsByType || {}).filter(k => (state.stats.killsByType || {})[k] > 0).length}/${ENEMIES.length})
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.8rem;">Seznam v≈°ech nep≈ô√°tel kter√© jsi porazil.</p>
                            <button class="btn" onclick="showBestiary()" style="width: 100%; background: linear-gradient(135deg, #8B0000, #4a0000);">
                                üìñ Otev≈ô√≠t besti√°≈ô
                            </button>
                        </div>
                    </details>
                    
                    <!-- STATISTIKY -->
                    <details style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid var(--rust); margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: var(--rust-light); font-weight: bold;">
                            üìä STATISTIKY
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid var(--rust);">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--rust-light);">${state.world?.visitedLocations?.length || 0}</div>
                                    <div style="font-size: 0.7rem; color: #666;">üó∫Ô∏è Lokac√≠</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid #8B0000;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: #ff4444;">${state.stats.kills}</div>
                                    <div style="font-size: 0.7rem; color: #666;">‚öîÔ∏è Zabit√≠</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid var(--warning-yellow);">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--warning-yellow);">${state.stats.totalMoneyEarned || 0}</div>
                                    <div style="font-size: 0.7rem; color: #666;">üí∞ Vydƒõlal</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid var(--toxic-dark);">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--toxic-green);">${state.stats.itemsCrafted}</div>
                                    <div style="font-size: 0.7rem; color: #666;">üî® Crafty</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid #3949AB;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: #7986CB;">${state.time.days}d ${state.time.hours}h</div>
                                    <div style="font-size: 0.7rem; color: #666;">üìÖ Hern√≠ ƒças</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.6rem; border-radius: 4px; text-align: center; border-left: 3px solid #6A1B9A;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: #9C27B0;">${Math.floor(state.time.totalElapsed / 3600)}h</div>
                                    <div style="font-size: 0.7rem; color: #666;">‚è±Ô∏è Real time</div>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <!-- HERN√ç DEN√çK -->
                    <details open style="background: linear-gradient(135deg, #1a1a1a, #0d0d0d); border-radius: 8px; border: 2px solid #4a4a4a; margin-bottom: 1rem;">
                        <summary style="padding: 1rem; cursor: pointer; color: #aaa; font-weight: bold;">
                            üìú HERN√ç DEN√çK
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; border-radius: 6px; padding: 0.5rem; border: 1px solid #333;">
                                ${(() => {
                                    const logs = state.log || [];
                                    const settlementLogs = state.settlement?.eventLog || [];
                                    
                                    // Kombinuj logy - p≈ôidej typ
                                    const allLogs = [
                                        ...logs.map(l => ({ ...l, type: 'player' })),
                                        ...settlementLogs.map(l => ({ 
                                            time: 'Den ' + l.day, 
                                            text: l.icon + ' ' + l.name + ': ' + l.desc,
                                            type: 'settlement',
                                            timestamp: l.timestamp || 0
                                        }))
                                    ];
                                    
                                    // Se≈ôaƒè podle ƒçasu (nejnovƒõj≈°√≠ naho≈ôe)
                                    allLogs.sort((a, b) => {
                                        const timeA = a.timestamp || 0;
                                        const timeB = b.timestamp || 0;
                                        return timeB - timeA;
                                    });
                                    
                                    if (allLogs.length === 0) {
                                        return '<div style="text-align: center; color: #555; padding: 1rem;">Zat√≠m ≈æ√°dn√© z√°znamy...</div>';
                                    }
                                    
                                    // Zobraz posledn√≠ch 50 z√°znam≈Ø
                                    return allLogs.slice(0, 50).map(log => {
                                        const bgColor = log.type === 'settlement' ? '#1a1a2a' : '#1a1a1a';
                                        const borderColor = log.type === 'settlement' ? '#3949AB' : '#333';
                                        const typeIcon = log.type === 'settlement' ? 'üèòÔ∏è' : 'üë§';
                                        return '<div style="padding: 0.4rem 0.6rem; margin-bottom: 0.3rem; background: ' + bgColor + '; border-radius: 4px; border-left: 3px solid ' + borderColor + '; font-size: 0.75rem;">' +
                                            '<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">' +
                                                '<span style="color: #888; flex-shrink: 0;">' + typeIcon + ' ' + log.time + '</span>' +
                                                '<span style="color: #ccc; text-align: right;">' + log.text + '</span>' +
                                            '</div>' +
                                        '</div>';
                                    }).join('');
                                })()}
                            </div>
                            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.7rem; color: #555;">üë§ Hr√°ƒç | üèòÔ∏è Osada</span>
                                <button class="btn" onclick="clearGameLog()" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; background: #333;">üóëÔ∏è Vymazat</button>
                            </div>
                        </div>
                    </details>
                    
                    <!-- OVL√ÅD√ÅN√ç HRY - jen p≈ôenos, hlavn√≠ akce v Online sekci -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <button class="btn" onclick="showExportImport()" style="background: #6A1B9A; font-size: 0.8rem; padding: 0.5rem 1rem;">üì± P≈ôenos save</button>
                        <button class="btn" onclick="showAuthModal()" style="background: #3949AB; font-size: 0.8rem; padding: 0.5rem 1rem;">üë§ Online √∫ƒçet</button>
                        <span style="margin-left: auto; font-size: 0.7rem; color: #555; align-self: center;">Seed: ${state.worldSeed}</span>
                    </div>
                </div>
                <div class="tab ${state.activeTab === 'craft' ? 'active' : ''}" id="tabCraft">
                    <h2>üî® ${t('craftUI', 'title')}</h2>
                    <!-- Zobrazen√≠ surovin -->
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.85rem;">
                            ${(() => {
                                const hasCryo = state.settlement?.buildings?.includes('cryo_storage') || state.base?.includes('cryo_storage');
                                const getFreshnessInfo = (itemId, maxDays) => {
                                    const frozen = 'Zmra≈æeno';
                                    const spoiled = 'Zka≈æen√©!';
                                    const tomorrow = 'Z√≠tra se zkaz√≠!';
                                    const daysText = 'dn√≠ zb√Ωv√°';
                                    const lastsText = `Vydr≈æ√≠ ${maxDays} dn√≠`;
                                    
                                    if (hasCryo) return { icon: '‚ùÑÔ∏è', text: frozen, color: '#00bcd4' };
                                    if (!state.foodTimestamps || !state.foodTimestamps[itemId]) return { icon: '', text: lastsText, color: '#8bc34a' };
                                    const daysLeft = maxDays - (state.time.days - state.foodTimestamps[itemId]);
                                    if (daysLeft <= 0) return { icon: 'üíÄ', text: spoiled, color: '#c62828' };
                                    if (daysLeft <= 1) return { icon: '‚ö†Ô∏è', text: tomorrow, color: '#ff9800' };
                                    if (daysLeft <= 2) return { icon: '‚è∞', text: `${daysLeft} ${daysText}`, color: '#ff9800' };
                                    return { icon: '‚úì', text: `${daysLeft} ${daysText}`, color: '#8bc34a' };
                                };
                                const meatInfo = getFreshnessInfo('raw_meat', 6);
                                const fishInfo = getFreshnessInfo('fish', 4);
                                const herbsInfo = getFreshnessInfo('herbs', 10);
                                return `
                                    <span style="cursor: help; ${(state.resources.raw_meat || 0) > 0 ? `color: ${meatInfo.color};` : ''}" 
                                          title="${t('resources', 'meat') || 'Syrov√© maso'} - ${meatInfo.text}">${meatInfo.icon}ü•© ${state.resources.raw_meat || 0}</span>
                                    <span style="cursor: help; ${(state.resources.fish || 0) > 0 ? `color: ${fishInfo.color};` : ''}" 
                                          title="${'Ryba'} - ${fishInfo.text}">${fishInfo.icon}üêü ${state.resources.fish || 0}</span>
                                    <span style="cursor: help; ${(state.resources.herbs || 0) > 0 ? `color: ${herbsInfo.color};` : ''}" 
                                          title="${t('resources', 'herbs')} - ${herbsInfo.text}">${herbsInfo.icon}üåø ${state.resources.herbs || 0}</span>
                                `;
                            })()}
                            <span title="${t('resources', 'wood')}">üå≤ ${state.resources.wood || 0}</span>
                            <span title="${t('resources', 'metal')}">‚öôÔ∏è ${state.resources.metal || 0}</span>
                            <span title="${t('resources', 'stone')}">üóø ${state.resources.stone || 0}</span>
                            <span title="${t('resources', 'cloth')}">üßµ ${state.resources.cloth || 0}</span>
                            <span title="${t('resources', 'leather')}">ü¶¥ ${state.resources.leather || 0}</span>
                            <span title="Provaz">‚û∞ ${state.resources.rope || 0}</span>
                            <span title="Chemik√°lie">üß™ ${state.resources.chemicals || 0}</span>
                            <span title="Sklo">üîÆ ${state.resources.glass || 0}</span>
                            <span title="Elektronika">üíæ ${state.resources.electronics || 0}</span>
                            <span title="Palivo">‚õΩ ${state.resources.fuel || 0}</span>
                            <span title="St≈ôeln√Ω prach">üí• ${state.resources.gunpowder || 0}</span>
                            <span title="Mƒõƒè">üü§ ${state.resources.copper || 0}</span>
                            <span title="≈†rot">üî© ${state.resources.scrap || 0}</span>
                        </div>
                    </div>
                    
                    <!-- Filtr kategori√≠ -->
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="filterCraft('all')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${!state.craftFilter || state.craftFilter === 'all' ? '' : 'background: #333;'}">üì¶ ${'V≈°e'}</button>
                        <button class="btn" onclick="filterCraft('weapon')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'weapon' ? '' : 'background: #333;'}">‚öîÔ∏è ${'Zbranƒõ'}</button>
                        <button class="btn" onclick="filterCraft('armor')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'armor' ? '' : 'background: #333;'}">üõ°Ô∏è ${'Zbroje'}</button>
                        <button class="btn" onclick="filterCraft('medical')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'medical' ? '' : 'background: #333;'}">‚öïÔ∏è ${'L√©ƒçiva'}</button>
                        <button class="btn" onclick="filterCraft('food')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'food' ? '' : 'background: #333;'}">üçñ ${'J√≠dlo'}</button>
                        <button class="btn" onclick="filterCraft('tool')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'tool' ? '' : 'background: #333;'}">üîß ${'N√°stroje'}</button>
                        <button class="btn" onclick="filterCraft('ammo')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'ammo' ? '' : 'background: #333;'}">üí£ ${'Munice'}</button>
                        <button class="btn" onclick="filterCraft('special')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; ${state.craftFilter === 'special' ? '' : 'background: #333;'}">‚ú® ${'Speci√°ln√≠'}</button>
                        ${getSkillLevel('legendary_smith') > 0 ? `<button class="btn" onclick="filterCraft('legendary')" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: ${state.craftFilter === 'legendary' ? 'linear-gradient(135deg, #ffd700, #ff8f00)' : '#333'}; ${state.craftFilter === 'legendary' ? 'color: #000;' : ''}">‚≠ê Legend√°rn√≠</button>` : ''}
                    </div>
                    
                    ${renderCraftingRecipes()}
                </div>
                <div class="tab ${state.activeTab === 'base' ? 'active' : ''}" id="tabBase">
                    <!-- HEADER S N√ÅZVEM OSADY -->
                    <div style="background: linear-gradient(135deg, #2a1a0a 0%, #1a0a00 100%); padding: 1.2rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #8B4513; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255,100,0,0.1) 0%, transparent 70%);"></div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h2 style="margin: 0; color: #ffd700; text-shadow: 0 0 10px rgba(255,200,0,0.3);">üèòÔ∏è ${state.settlement.name || t('settlementUI', 'title')}</h2>
                                <p style="margin: 0.3rem 0 0 0; color: #a0a0a0; font-size: 0.85rem; font-style: italic;">
                                    ${state.settlement.level === 1 ? ('"Skromn√Ω zaƒç√°tek v pustinƒõ..."') : 
                                      state.settlement.level === 2 ? ('"Rostouc√≠ komunita pln√° nadƒõje."') :
                                      state.settlement.level >= 3 ? ('"Ba≈°ta civilizace v divoƒçinƒõ!"') : ''}
                                </p>
                            </div>
                        </div>
                        
                        <!-- LEVEL & PROSPERITY BAR -->
                        <div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="background: #0a0a0a; padding: 0.5rem 1rem; border-radius: 20px; border: 2px solid ${state.settlement.level >= 3 ? '#ffd700' : state.settlement.level >= 2 ? '#c0c0c0' : '#cd7f32'};">
                                <span style="color: #888;">LVL</span> <strong style="font-size: 1.3rem; color: #fff;">${state.settlement.level}</strong>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.2rem;">
                                    <span style="color: #888;">${t('settlementUI', 'prosperity')}</span>
                                    <span style="color: ${state.settlement.prosperity >= 80 ? '#8bc34a' : '#ffd700'};">${state.settlement.prosperity}/100 ${state.settlement.prosperity >= 80 ? 'üåü' : ''}</span>
                                </div>
                                <div style="background: #0a0a0a; height: 12px; border-radius: 6px; overflow: hidden; border: 1px solid #333;">
                                    <div style="width: ${state.settlement.prosperity}%; height: 100%; background: linear-gradient(90deg, #8B4513, #ffd700); transition: width 0.5s; box-shadow: 0 0 10px rgba(255,200,0,0.3);"></div>
                                </div>
                                ${state.settlement.prosperity >= 100 && state.settlement.level < 5 ? 
                                    `<button class="btn" onclick="forceSettlementLevelUp()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(180deg, #ffd700 0%, #ff9800 100%); color: #000; font-weight: bold; padding: 0.5rem; border-radius: 6px;">üéâ ${'LEVEL UP OSADY!'}</button>` :
                                    (state.settlement.prosperity >= 80 ? `<p style="margin: 0.3rem 0 0 0; font-size: 0.75rem; color: #8bc34a;">‚ú® ${'Bl√≠≈æ√≠≈° se k dal≈°√≠mu levelu!'}</p>` : '')
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- RYCHL√ù P≈òEHLED - 2 ≈ô√°dky -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; margin-bottom: 0.4rem;">
                        <div onclick="showSettlementPopulationInfo()" style="background: linear-gradient(180deg, #1a2a1a 0%, #0a150a 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #2d4a2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">üë•</div>
                            <div style="font-size: 1rem; font-weight: bold; color: #8bc34a;">${state.settlement?.settlers?.length || 0}</div>
                            <div style="font-size: 0.6rem; color: #666;">${currentLang === "en" ? "Residents" : "Obyvatel√©"}</div>
                        </div>
                        <div onclick="showSettlementDefenseInfo()" style="background: linear-gradient(180deg, #2a1a1a 0%, #150a0a 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #4a2d2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">üõ°Ô∏è</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${calculateSettlementDefense() > 30 ? '#8bc34a' : calculateSettlementDefense() > 10 ? '#ff9800' : '#c62828'};">${calculateSettlementDefense()}</div>
                            <div style="font-size: 0.6rem; color: #666;">${currentLang === "en" ? "Defense" : "Obrana"}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; margin-bottom: 1rem;">
                        <div onclick="showSettlementFoodInfo()" style="background: linear-gradient(180deg, #2a2a1a 0%, #15150a 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #4a4a2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">üçñ</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${(state.settlement?.resources?.food || 0) > 20 ? '#8bc34a' : (state.settlement?.resources?.food || 0) > 5 ? '#ff9800' : '#c62828'};">${state.settlement?.resources?.food || 0}</div>
                            <div style="font-size: 0.6rem; color: ${calculateSettlementBalance().food >= 0 ? '#8bc34a' : '#c62828'};">${calculateSettlementBalance().food >= 0 ? '+' : ''}${calculateSettlementBalance().food}/den</div>
                        </div>
                        <div onclick="showSettlementWaterInfo()" style="background: linear-gradient(180deg, #1a2a2a 0%, #0a1515 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #2d4a4a; cursor: pointer;">
                            <div style="font-size: 1.1rem;">üíß</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${(state.settlement?.resources?.water || 0) > 20 ? '#8bc34a' : (state.settlement?.resources?.water || 0) > 5 ? '#ff9800' : '#c62828'};">${state.settlement?.resources?.water || 0}</div>
                            <div style="font-size: 0.6rem; color: ${calculateSettlementBalance().water >= 0 ? '#8bc34a' : '#c62828'};">${calculateSettlementBalance().water >= 0 ? '+' : ''}${calculateSettlementBalance().water}/den</div>
                        </div>
                        <div onclick="showSettlementPowerInfo()" style="background: linear-gradient(180deg, #2a2a0a 0%, #151505 100%); padding: 0.5rem 0.3rem; border-radius: 8px; text-align: center; border: 1px solid #4a4a2d; cursor: pointer;">
                            <div style="font-size: 1.1rem;">‚ö°</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${calculatePowerBalance() >= 0 ? '#ffd700' : '#c62828'};">${calculatePowerProduction()}/${calculatePowerConsumption()}</div>
                            <div style="font-size: 0.6rem; color: #666;">${currentLang === "en" ? "Power" : "Elekt≈ôina"}</div>
                        </div>
                    </div>
                    
                    <!-- HISTORIE UD√ÅLOST√ç -->
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; background: linear-gradient(90deg, #2a2a2a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 8px; border: 1px solid #444; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">üìú</span>
                            <span style="font-weight: bold;">${currentLang === "en" ? "Event History" : "Historie ud√°lost√≠"}</span>
                            <span style="color: #888; font-size: 0.85rem; margin-left: auto;">(${state.settlement.eventLog?.length || 0})</span>
                        </summary>
                        <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 0 0 8px 8px; border: 1px solid #333; border-top: none; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${state.settlement.eventLog && state.settlement.eventLog.length > 0 ? 
                                state.settlement.eventLog.slice(0, 10).map(e => `
                                    <div onclick="showEventDetail('${e.id}', '${e.name}', '${e.icon}', '${(e.desc || '').replace(/'/g, "\\'")}', '${(e.details || '').replace(/'/g, "\\'")}', ${e.day})" 
                                         style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #222; cursor: pointer; transition: background 0.2s;"
                                         onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">
                                        <span style="font-size: 1.2rem;">${e.icon}</span>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #ddd;">${e.name}</div>
                                            ${e.details ? `<div style="font-size: 0.75rem; color: #ff9800;">${e.details}</div>` : ''}
                                            <div style="font-size: 0.7rem; color: #666;">Den ${e.day}</div>
                                        </div>
                                        <span style="color: #444; font-size: 0.8rem;">‚Ä∫</span>
                                    </div>
                                `).join('') 
                            : '<p style="color: #555; text-align: center; margin: 1rem 0;">Zat√≠m ≈æ√°dn√© ud√°losti...</p>'}
                            
                            <div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid #333;">
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">üìä ${'≈†ance na ud√°losti (za hern√≠ den):'}</div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.2rem; font-size: 0.7rem;">
                                    <span style="color: #8bc34a;">üõí ${'Obchodn√≠k'}: 25%</span>
                                    <span style="color: #ff9800;">üí¢ ${'Spor'}: 15%</span>
                                    <span style="color: #8bc34a;">üåæ ${'Sklize≈à'}: 12%</span>
                                    <span style="color: #8bc34a;">üéâ ${'Oslava'}: 10%</span>
                                    <span style="color: #c62828;">ü¶† ${'Nemoc'}: 10%</span>
                                    <span style="color: #2196f3;">ü•æ ${'Uprchl√≠k'}: 10%</span>
                                    <span style="color: #2196f3;">üì¶ ${'N√°lez'}: 10%</span>
                                    <span style="color: #8bc34a;">üî¶ ${'Objev'}: 8%</span>
                                    <span style="color: #2196f3;">üêï ${'Pes'}: 8%</span>
                                    <span style="color: #2196f3;">ü©π ${'Cizinec'}: 8%</span>
                                    <span style="color: #2196f3;">‚öñÔ∏è ${'Spor'}: 8%</span>
                                    <span style="color: #ff9800;">ü¶ù ${'Kr√°de≈æ'}: 8%</span>
                                    <span style="color: #ff9800;">ü©∏ ${'Nehoda'}: 8%</span>
                                    <span style="color: #c62828;">üèÉ ${'√ötƒõk'}: 6%</span>
                                    <span style="color: #8bc34a;">üçº ${'Narozen√≠'}: 5%</span>
                                    <span style="color: #8bc34a;">‚ö° ${'Inspirace'}: 5%</span>
                                    <span style="color: #9c27b0;">üé≠ ${'Z√°hadn√Ω'}: 5%</span>
                                    <span style="color: #c62828;">üíÄ ${'Bandita'}: 5%</span>
                                    <span style="color: #2196f3;">üë∂ ${'D√≠tƒõ'}: 5%</span>
                                    <span style="color: #c62828;">üî• ${'Po≈æ√°r'}: 4%</span>
                                    <span style="color: #8bc34a;">üíç ${'Svatba'}: 3%</span>
                                    <span style="color: #ffd700;">üíé ${'Poklad'}: 3%</span>
                                    <span style="color: #ffd700;">‚ú® ${'Zlat√Ω vƒõk'}: 2%</span>
                                    <span style="color: #c62828;">‚ò†Ô∏è ${'Mor'}: 2%</span>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <!-- VAROV√ÅN√ç -->
                    ${calculatePowerBalance() < 0 ? `
                        <div style="background: linear-gradient(90deg, #4a4a1a 0%, #2a2a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffd700;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <span style="font-size: 1.5rem;">‚ö°</span>
                                <div style="flex: 1;">
                                    <strong style="color: #ffd700;">Nedostatek elekt≈ôiny!</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #888;">Chyb√≠ ${Math.abs(calculatePowerBalance())} ‚ö°. Nƒõkter√© budovy nefunguj√≠!</p>
                                </div>
                                <button onclick="showPowerModal()" style="padding: 0.4rem 0.8rem; background: #ff9800; border: none; color: #000; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold;">‚öôÔ∏è Spr√°va</button>
                            </div>
                        </div>
                    ` : ''}
                    ${calculateSettlementBalance().food < 0 ? `
                        <div style="background: linear-gradient(90deg, #4a1a1a 0%, #2a0a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #c62828; display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                            <div>
                                <strong style="color: #ff6b6b;">${'Nedostatek j√≠dla!'}</strong>
                                <p style="margin: 0; font-size: 0.85rem; color: #888;">Dennƒõ ubyde ${Math.abs(calculateSettlementBalance().food)} j√≠dla. Postav farmu nebo najmi farm√°≈ôe!</p>
                            </div>
                        </div>
                    ` : ''}
                    ${calculateSettlementBalance().water < 0 ? `
                        <div style="background: linear-gradient(90deg, #1a2a4a 0%, #0a1525 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #2196f3; display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 1.5rem;">üíß</span>
                            <div>
                                <strong style="color: #64b5f6;">${'Nedostatek vody!'}</strong>
                                <p style="margin: 0; font-size: 0.85rem; color: #888;">Dennƒõ ubyde ${Math.abs(calculateSettlementBalance().water)} vody. Postav studnu nebo sbƒõraƒç!</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? `
                        <div style="background: linear-gradient(90deg, #3a3a1a 0%, #2a2a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--warning-yellow); display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <span style="font-size: 2rem;">üõí</span>
                                <div>
                                    <strong style="color: var(--warning-yellow);">${'Obchodn√≠k na n√°v≈°tƒõvƒõ!'}</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #888;">${'Speci√°ln√≠ slevy. Zb√Ωv√°:'} ${Math.ceil((state.settlement.visitingMerchant.until - Date.now()) / 60000)} min</p>
                                </div>
                            </div>
                            <button class="btn" onclick="openCaravanShop()" style="background: var(--warning-yellow); color: #000; padding: 0.5rem 1rem;">üè™ Obchod</button>
                        </div>
                    ` : ''}
                    
                    <!-- FINANƒåN√ç P≈òEHLED OSADY -->
                    ${(() => {
                        const dailyMaintenance = calculateDailyMaintenance();
                        const dailyIncome = calculateDailyIncome();
                        const balance = dailyIncome - dailyMaintenance;
                        const playerMoney = state.money || 0;
                        // Pokud je balance z√°porn√°, spoƒç√≠tej kolik dn√≠ vydr≈æ√≠ pen√≠ze
                        const daysCanSurvive = balance < 0 ? Math.floor(playerMoney / Math.abs(balance)) : 999;
                        
                        return '<div onclick="showFinanceModal()" style="cursor: pointer; background: linear-gradient(90deg, #1a2a1a 0%, #0a1a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid ' + (balance >= 0 ? '#4a7c4a' : '#7c4a4a') + ';">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">' +
                                '<span style="font-size: 1rem; font-weight: bold; color: #ffd700;">üí∞ ' + ('Finance osady') + ' <span style="font-size: 0.7rem; color: #888;">(klikni)</span></span>' +
                                '<span style="color: #ffd700; font-weight: bold;">' + playerMoney + ' üí∞</span>' +
                            '</div>' +
                            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">' +
                                '<div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px;">' +
                                    '<div style="font-size: 0.65rem; color: #888;">' + ('P≈ô√≠jem/den') + '</div>' +
                                    '<div style="color: #8bc34a; font-weight: bold;">+' + dailyIncome + ' üí∞</div>' +
                                '</div>' +
                                '<div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px;">' +
                                    '<div style="font-size: 0.65rem; color: #888;">' + ('√ödr≈æba/den') + '</div>' +
                                    '<div style="color: #c62828; font-weight: bold;">-' + dailyMaintenance + ' üí∞</div>' +
                                '</div>' +
                                '<div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px;">' +
                                    '<div style="font-size: 0.65rem; color: #888;">' + ('Bilance') + '</div>' +
                                    '<div style="color: ' + (balance >= 0 ? '#8bc34a' : '#c62828') + '; font-weight: bold;">' + (balance >= 0 ? '+' : '') + balance + ' üí∞</div>' +
                                '</div>' +
                            '</div>' +
                            (balance < 0 ? '<div style="margin-top: 0.5rem; padding: 0.3rem; background: #2a0a0a; border-radius: 4px; text-align: center;">' +
                                '<span style="color: #ff6b6b; font-size: 0.75rem;">‚ö†Ô∏è ' + ('Dn√≠ do bankrotu: ') + '<strong>' + daysCanSurvive + '</strong></span>' +
                            '</div>' : '') +
                        '</div>';
                    })()}
                    
                    <!-- HLAVN√ç AKCE - 8 TLAƒå√çTEK -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.6rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="showSettlersModal()" style="background: linear-gradient(135deg, #2d4a2d 0%, #1a2e1a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #4a7c4a; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">üë•</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Residents" : "Obyvatel√©"}</span>
                            <span style="font-size: 0.75rem; color: #8bc34a;">${state.settlement?.settlers?.length || 0} ${currentLang === "en" ? "people" : "osob"}</span>
                        </button>
                        
                        <button class="btn" onclick="showBuildingsModal()" style="background: linear-gradient(135deg, #4a3d2d 0%, #2e251a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #7c6a4a; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">üèóÔ∏è</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Buildings" : "Budovy"}</span>
                            <span style="font-size: 0.75rem; color: #ff9800;">${(state.base?.length || 0) + (state.settlement?.buildings?.length || 0)} ${currentLang === "en" ? "built" : "postaveno"}</span>
                        </button>
                        
                        <button class="btn" onclick="showDefenseModal()" style="background: linear-gradient(135deg, #4a2d2d 0%, #2e1a1a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #7c4a4a; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">üõ°Ô∏è</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Defense" : "Obrana"}</span>
                            <span style="font-size: 0.75rem; color: ${calculateSettlementDefense() > 30 ? '#8bc34a' : '#c62828'};">${calculateSettlementDefense()} ${currentLang === "en" ? "points" : "bod≈Ø"}</span>
                        </button>
                        
                        <button class="btn" onclick="showSpecializationModal()" style="background: linear-gradient(135deg, #3d2d4a 0%, #251a2e 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #6a4a7c; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">üèõÔ∏è</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Specialization" : "Specializace"}</span>
                            <span style="font-size: 0.75rem; color: #9c27b0;">${state.settlement.specialization ? '‚úì' : ('≈Ω√°dn√°')}</span>
                        </button>
                        
                        <button class="btn" onclick="showStorageModal()" style="background: linear-gradient(135deg, #2d3d4a 0%, #1a252e 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid #4a6a7c; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">üì¶</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Storage" : "Sklad"}</span>
                            <span style="font-size: 0.75rem; color: #2196f3;">${state.baseItems?.length || 0} ${currentLang === "en" ? "items" : "vƒõc√≠"}</span>
                        </button>
                        
                        <button class="btn" onclick="showPowerModal()" style="background: linear-gradient(135deg, #4a4a1a 0%, #2e2e0a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid ${calculatePowerBalance() >= 0 ? '#7c7c2a' : '#7c2a2a'}; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">‚ö°</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Power" : "Elekt≈ôina"}</span>
                            <span style="font-size: 0.75rem; color: ${calculatePowerBalance() >= 0 ? '#ffd700' : '#c62828'};">${calculatePowerProduction()}/${calculatePowerConsumption()}</span>
                        </button>
                        
                        <button class="btn" onclick="summonCaravan()" style="background: linear-gradient(135deg, #4a3d2d 0%, #2e251a 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid ${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? '#8bc34a' : '#7c6a4a'}; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">üê™</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Caravan" : "Karavana"}</span>
                            <span style="font-size: 0.75rem; color: ${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? '#8bc34a' : '#ffa500'};">${state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until ? ('‚úì Zde') : '100üí∞'}</span>
                        </button>
                        
                        <button class="btn" onclick="showHireCompanionsModal()" style="background: linear-gradient(135deg, #2d4a3d 0%, #1a2e25 100%); padding: 0.8rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; border: 2px solid ${(state.companions?.length || 0) < getMaxCompanions() ? '#4a7c5a' : '#555'}; border-radius: 10px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.8rem;">üêï</span>
                            <span style="font-weight: bold; font-size: 0.85rem;">${currentLang === "en" ? "Companions" : "Spoleƒçn√≠ci"}</span>
                            <span style="font-size: 0.75rem; color: ${(state.companions?.length || 0) < getMaxCompanions() ? '#8bc34a' : '#888'};">${state.companions?.filter(c => !c.isDead).length || 0}/${getMaxCompanions()}</span>
                        </button>
                        
                        <button class="btn" onclick="showSettlementHelp()" style="background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); padding: 0.4rem 0.6rem; display: flex; align-items: center; justify-content: center; gap: 0.3rem; border: 1px solid #555; border-radius: 6px; font-size: 0.8rem;" title="${'N√°povƒõda k osadƒõ'}">
                            ‚ùì ${'Pomoc'}
                        </button>
                    </div>
                    
                    <!-- OBYVATEL√â - ≈ΩIV√ù P≈òEHLED -->
                    ${(state.settlement?.settlers?.length || 0) > 0 ? `
                        <!-- Rychl√© akce osady -->
                        ${(() => {
                            const hasBlacksmith = state.settlement.settlers.some(s => s.type === 'blacksmith');
                            const hasMedic = state.settlement.settlers.some(s => s.type === 'medic_s');
                            const hasTrader = state.settlement.settlers.some(s => s.type === 'trader_s');
                            
                            if (hasBlacksmith || hasMedic || hasTrader) {
                                return `
                                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.85rem;">‚ö° Slu≈æby osadn√≠k≈Ø</h4>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                            ${hasBlacksmith ? '<button class="btn" onclick="repairAtBlacksmith()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #5D4037;">‚öíÔ∏è Opravit vybaven√≠</button>' : ''}
                                            ${hasMedic ? '<button class="btn" onclick="healAtMedic()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #c62828;">‚öïÔ∏è L√©ƒçen√≠</button>' : ''}
                                            ${hasTrader ? `<button class="btn" onclick="tradeAtSettlement()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: ${isShopOpen('settlement') ? '#ff9800' : '#555'};">${isShopOpen('settlement') ? 'üí∞' : 'üåô'} Obchod${isShopOpen('settlement') ? '' : ' (zav≈ôeno)'}</button>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                        
                        <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 1rem; border-radius: 10px; border: 1px solid #333;">
                            <h4 style="margin: 0 0 0.8rem 0; color: var(--toxic-green); display: flex; align-items: center; gap: 0.5rem;">
                                <span>üë• ${'Tvoji lid√©'}</span>
                                <span style="font-size: 0.8rem; color: #666; font-weight: normal;">(${state.settlement?.settlers?.length || 0} ${'osob'})</span>
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                ${(state.settlement?.settlers || []).map((settler, idx) => {
                                    const type = SETTLER_TYPES.find(t => t.id === settler.type);
                                    const moods = ['üòä', 'üôÇ', 'üòê', 'üòü', 'üò¢'];
                                    const mood = moods[Math.floor(Math.random() * 3)]; // Vƒõt≈°inou happy
                                    // Podpora r≈Øzn√Ωch variant ulo≈æen√≠ levelu
                                    const skillLevel = settler.skillLevel || settler.level || 1;
                                    const skillData = SETTLER_SKILLS[type?.skill];
                                    const currentSkill = skillData?.levels[skillLevel - 1];
                                    return `
                                        <div onclick="showSettlerDetail(${idx})" style="background: #2a2a2a; padding: 0.6rem; border-radius: 8px; display: flex; align-items: center; gap: 0.6rem; border: 1px solid #3a3a3a; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#8bc34a'; this.style.background='#333'" onmouseout="this.style.borderColor='#3a3a3a'; this.style.background='#2a2a2a'">
                                            <div style="font-size: 1.8rem; position: relative;">
                                                ${type?.icon || 'üë§'}
                                                <span style="position: absolute; bottom: -2px; right: -2px; font-size: 0.7rem;">${mood}</span>
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-weight: bold; font-size: 0.9rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${settler.name}</div>
                                                <div style="font-size: 0.75rem; color: #888;">${getSettlerName(type?.id)} <span style="color: #ffd700;">‚≠ê${skillLevel}</span></div>
                                                <div style="font-size: 0.7rem; color: #8bc34a;">${currentSkill?.bonus || type?.desc || ''}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 2rem; border-radius: 10px; border: 2px dashed #333; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üèöÔ∏è</div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #666;">Osada je pr√°zdn√°</h3>
                            <p style="color: #555; margin: 0 0 1rem 0;">Najmi prvn√≠ obyvatele a zaƒçni budovat komunitu!</p>
                            <button class="btn" onclick="showSettlersModal()" style="background: var(--toxic-dark);">üë• Najmi obyvatele</button>
                        </div>
                    `}
                </div>
                
                <!-- MULTIPLAYER TAB -->
                <div class="tab ${state.activeTab === 'multiplayer' ? 'active' : ''}" id="tabMultiplayer">
                    ${renderMultiplayerTab()}
                </div>
            `;
            
            if (state.activeTab === 'map' && document.getElementById('canvas')) initMap();
                console.log('üéÆ renderGame() completed');
            } catch (error) {
                console.error('‚ùå renderGame error:', error);
                document.getElementById('main').innerHTML = '<div style="padding: 2rem; color: #ff6b6b;"><h2>Chyba p≈ôi renderov√°n√≠</h2><pre>' + error.message + '</pre></div>';
            }
        }
        
        function saveDiary() {
            const notes = document.getElementById('diaryNotes');
            if (notes) {
                state.diary = notes.value;
                showModal('üíæ Ulo≈æeno', 'Tvoje pozn√°mky byly ulo≈æeny!');
            }
        }
        
        // === ACTIONS ===
        function showGenders() {
            const title = 'V√Ωbƒõr Pohlav√≠';
            const closeText = 'Zav≈ô√≠t';
            const genders = getGenders();
            const attrs = getAttrs();
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${title}</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                    ${Object.entries(genders).map(([id, gender]) => `
                        <div class="card ${state.char.gender === id ? 'selected' : ''}" onclick="selectGender('${id}')" style="cursor: pointer;">
                            <div style="font-size: 4rem; text-align: center;">${gender.icon}</div>
                            <h3 style="text-align: center; margin: 0.5rem 0;">${gender.name}</h3>
                            <p style="text-align: center; font-size: 0.85rem; color: #999; margin-bottom: 0.5rem;">${gender.desc}</p>
                            <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p style="text-align: center; color: #8bc34a; font-weight: 600; margin: 0; font-size: 0.9rem;">
                                    ${Object.entries(GENDERS[id].bonuses).map(([attr, bonus]) => 
                                        `+${bonus} ${attrs[attr].name}`
                                    ).join('<br>')}
                                </p>
                            </div>
                            <p style="text-align: center; color: #ff9800; font-size: 0.85rem; margin: 0;">${gender.special}</p>
                        </div>
                    `).join('')}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${closeText}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        function selectGender(id) {
            state.char.gender = id;
            closeModal();
            renderFull();
        }
        
        function showClasses() {
            // Lokalizace
            const texts = {
                title: 'V√Ωbƒõr Povol√°n√≠',
                hint: 'Klikni na povol√°n√≠ pro v√≠ce informac√≠',
                close: 'Zav≈ô√≠t',
                combat: '‚öîÔ∏è Bojov√©',
                defense: 'üõ°Ô∏è Obrann√©',
                scout: 'üéØ Skautsk√©',
                support: '‚öïÔ∏è Podp≈Ørn√©',
                gather: 'üîç Sbƒõraƒçsk√©',
                tech: 'üîß Technick√©',
                special: '‚ú® Speci√°ln√≠'
            };
            
            // Seskup povol√°n√≠ do kategori√≠
            // Mutant nen√≠ ve v√Ωbƒõru - st√°v√° se j√≠m hr√°ƒç po 5 mutac√≠ch
            const categories = {
                combat: { name: texts.combat, classes: ['raider', 'berserker'] },
                defense: { name: texts.defense, classes: ['survivor', 'tank'] },
                scout: { name: texts.scout, classes: ['stalker', 'assassin'] },
                support: { name: texts.support, classes: ['medic', 'alchemist'] },
                gather: { name: texts.gather, classes: ['scavenger', 'hunter'] },
                tech: { name: texts.tech, classes: ['engineer', 'demolitionist'] },
                special: { name: texts.special, classes: ['trader', 'nomad', 'psychic'] }
            };
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${texts.title}</h2>
                <p style="color: #999; margin-bottom: 1rem; text-align: center;">${texts.hint}</p>
                
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${Object.entries(categories).map(([catId, cat]) => `
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #d4722e; margin: 0 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.3rem;">${cat.name}</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.5rem;">
                                ${cat.classes.map(id => {
                                    const cls = CLASSES[id];
                                    if (!cls) return '';
                                    return `
                                        <div class="card ${state.char.classId === id ? 'selected' : ''}" 
                                            onclick="showClassDetail('${id}')"
                                            style="padding: 0.8rem; border-left: 4px solid ${cls.color || '#d4722e'}; cursor: pointer; ${state.char.classId === id ? 'background: #2a3a2a;' : ''}">
                                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                                <div style="font-size: 2.5rem;">${cls.icon}</div>
                                                <div style="flex: 1;">
                                                    <h3 style="margin: 0; font-size: 1rem;">${getClassName(id)} ${state.char.classId === id ? '‚úì' : ''}</h3>
                                                    <p style="margin: 0.2rem 0 0 0; font-size: 0.75rem; color: #999;">${getClassDesc(id)}</p>
                                                </div>
                                                <div style="font-size: 1.2rem; color: #666;">‚ÑπÔ∏è</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${texts.close}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        // Detailn√≠ info o povol√°n√≠
        function showClassDetail(id) {
            const cls = CLASSES[id];
            if (!cls) return;
            
            // Popis v√Ωhod pro ka≈æd√© povol√°n√≠ - generov√°no z ability a passive
            const classGuides = {
                raider: {
                    playstyle: 'Agresivn√≠ bojovn√≠k',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['≈Ω√°dn√© obrann√© bonusy', 'N√°roƒçnƒõj≈°√≠ na l√©ƒçiva'],
                    tips: 'Nechej si klesnout HP pod 30% pro RAGE bonus. Nos hodnƒõ l√©ƒçiv.',
                    bestFor: 'Hr√°ƒçe co r√°di riskuj√≠ a √∫toƒç√≠'
                },
                berserker: {
                    playstyle: 'Zbƒõsil√Ω v√°leƒçn√≠k',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Sn√≠≈æen√° obrana', 'Velmi k≈ôehk√Ω'],
                    tips: 'Zab√≠jej rychle, stackuj Frenzy. Vyu≈æij bonus za zabit√≠.',
                    bestFor: 'Zku≈°en√© hr√°ƒçe co um√≠ vyh√Ωbat se damage'
                },
                survivor: {
                    playstyle: 'Odoln√Ω veter√°n',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Ni≈æ≈°√≠ damage', 'Pomalej≈°√≠ zab√≠jen√≠'],
                    tips: 'Last Stand tƒõ zachr√°n√≠ v kritick√Ωch situac√≠ch. Ide√°ln√≠ pro zaƒç√°teƒçn√≠ky.',
                    bestFor: 'Nov√© hr√°ƒçe a opatrn√Ω hern√≠ styl'
                },
                tank: {
                    playstyle: 'Nepr≈Øst≈ôeln√° zeƒè',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Sn√≠≈æen√° rychlost', 'Ni≈æ≈°√≠ damage'],
                    tips: 'Vyu≈æij svou odolnost k ochranƒõ spoleƒçn√≠k≈Ø. Damage dƒõlej zbranƒõmi.',
                    bestFor: 'Tanky styl, dlouh√© souboje'
                },
                stalker: {
                    playstyle: 'Tich√Ω lovec',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Pr≈Ømƒõrn√Ω damage', '≈Ω√°dn√© bojov√© bonusy'],
                    tips: 'Vyh√Ωbej se zbyteƒçn√Ωm boj≈Øm. ≈†et≈ô√≠≈° zdroje na del≈°√≠ v√Ωpravy.',
                    bestFor: 'Pr≈Øzkum a survival gameplay'
                },
                assassin: {
                    playstyle: 'Smrt√≠c√≠ st√≠n',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['N√≠zk√© HP', 'Spol√©h√° na kritick√© z√°sahy'],
                    tips: 'S dobr√Ωm vybaven√≠m kritick√© z√°sahy drt√≠. Kombinuj s crit zbranƒõmi.',
                    bestFor: 'High-risk, high-reward styl'
                },
                medic: {
                    playstyle: 'Poln√≠ chirurg',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Slab√Ω damage', 'Pomal√© zab√≠jen√≠'],
                    tips: 'Tv√° regenerace ≈°et≈ô√≠ l√©ƒçiva. Nos minimum zdravotnick√©ho materi√°lu.',
                    bestFor: 'Solo hr√°ƒçe, dlouh√© v√Ωpravy'
                },
                alchemist: {
                    playstyle: 'Mistr jed≈Ø',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['N√≠zk√Ω p≈ô√≠m√Ω damage', 'DOT pot≈ôebuje ƒças'],
                    tips: 'Otrav nep≈ô√≠tele a p≈ôe≈æ√≠vej. DOT damage se sƒç√≠t√°!',
                    bestFor: 'Taktick√Ω boj, boss fight'
                },
                scavenger: {
                    playstyle: 'Hledaƒç poklad≈Ø',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Slab√Ω v boji', 'Z√°vis√≠ na RNG'],
                    tips: 'Prozkoum√°vej v≈°echno! Dvojit√Ω loot = rychl√© zbohatnut√≠.',
                    bestFor: 'Sbƒõraƒçe a ekonomick√Ω gameplay'
                },
                hunter: {
                    playstyle: 'Mistr lovu',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['M√©nƒõ efektivn√≠ ve mƒõstech', 'Pr≈Ømƒõrn√Ω damage'],
                    tips: 'Lov je tv≈Øj hlavn√≠ zdroj j√≠dla a materi√°l≈Ø. Vyu≈æij mapu.',
                    bestFor: 'Survival a lov'
                },
                engineer: {
                    playstyle: 'Vyn√°lezce',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Pr≈Ømƒõrn√Ω bojovn√≠k', 'Pot≈ôebuje materi√°ly'],
                    tips: 'Tv√© vybaven√≠ vydr≈æ√≠ navƒõky! Investuj do kvalitn√≠ch zbran√≠.',
                    bestFor: 'Crafting a base building'
                },
                demolitionist: {
                    playstyle: 'V√Ωbu≈°n√Ω expert',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Nep≈ôedv√≠dateln√Ω', 'AoE je n√°hodn√©'],
                    tips: 'Nos gran√°ty a v√Ωbu≈°niny! AoE decimuje skupiny nep≈ô√°tel.',
                    bestFor: 'Boj proti skupin√°m'
                },
                trader: {
                    playstyle: 'Ekonomick√Ω magn√°t',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Slab√Ω bojovn√≠k', 'Z√°vis√≠ na obchodov√°n√≠'],
                    tips: 'Kupuj levnƒõ, prod√°vej draze. Pen√≠ze ≈ôe≈°√≠ vƒõt≈°inu probl√©m≈Ø.',
                    bestFor: 'Ekonomiku a obchodov√°n√≠'
                },
                nomad: {
                    playstyle: 'Pou≈°tn√≠ tul√°k',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Pr≈Ømƒõrn√Ω v boji', '≈Ω√°dn√© bojov√© bonusy'],
                    tips: 'Cestuje≈° rychle a levnƒõ. Prozkoumej celou mapu!',
                    bestFor: 'Pr≈Øzkum a rychl√© cestov√°n√≠'
                },
                mutant: {
                    playstyle: 'Zmutovan√° bestie',
                    strengths: [cls.ability, cls.passive.split(':')[1]?.trim() || cls.passive],
                    weaknesses: ['Nem≈Ø≈æe nosit zbroj ani helmu', 'Soci√°ln√≠ postihy'],
                    tips: 'Radiace tƒõ l√©ƒç√≠! Prozkoum√°vej radioaktivn√≠ z√≥ny bez obav.',
                    bestFor: 'Pr≈Øzkum nebezpeƒçn√Ωch z√≥n'
                },
                psychic: {
                    playstyle: 'Ment√°ln√≠ manipul√°tor',
                    strengths: ['Vid√≠≈° skryt√© lokace', '10% nep≈ô√≠tel uteƒçe', 'Pr≈Øzkum'],
                    weaknesses: ['Slab√Ω v p≈ô√≠m√©m boji', 'Pasivn√≠ schopnosti'],
                    tips: 'Tv√© ment√°ln√≠ schopnosti odhal√≠ tajn√© lokace na mapƒõ.',
                    bestFor: 'Pr≈Øzkum a vyh√Ωb√°n√≠ se boji'
                }
            };
            
            const guide = classGuides[id] || {};
            
            document.getElementById('modalContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${cls.icon}</div>
                    <h2 style="margin: 0; color: ${cls.color || '#d4722e'};">${cls.name}</h2>
                    <p style="color: #999; margin: 0.3rem 0;">${cls.desc}</p>
                    <span style="background: ${cls.color || '#333'}; padding: 0.2rem 0.8rem; border-radius: 20px; font-size: 0.8rem;">
                        ${guide.playstyle || 'Univerz√°ln√≠'}
                    </span>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">‚ú¶ Hlavn√≠ schopnost</h4>
                    <p style="margin: 0; font-size: 0.95rem;">${cls.ability}</p>
                </div>
                
                <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">‚ö° Pasivn√≠ schopnost</h4>
                    <p style="margin: 0; font-size: 0.95rem;">${cls.passive}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #4caf50; font-size: 0.9rem;">üí™ Siln√© str√°nky</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem;">
                            ${(guide.strengths || ['Univerz√°ln√≠']).map(s => `<li style="margin: 0.2rem 0;">${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #f44336; font-size: 0.9rem;">‚ö†Ô∏è Slab√© str√°nky</h4>
                        <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem;">
                            ${(guide.weaknesses || ['≈Ω√°dn√© speci√°ln√≠']).map(w => `<li style="margin: 0.2rem 0;">${w}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                ${guide.tips ? `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">üí° Tip pro hran√≠</h4>
                    <p style="margin: 0; font-size: 0.9rem;">${guide.tips}</p>
                </div>
                ` : ''}
                
                <div style="background: #222; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #c62828; font-size: 1.1rem;">${cls.weapon.icon}</span>
                            <span style="margin-left: 0.3rem;">${cls.weapon.name}</span>
                            <span style="color: #888;"> - ${cls.weapon.dmg} DMG</span>
                        </div>
                        <div style="color: #888; font-size: 0.85rem;">
                            ${cls.bonuses ? Object.entries(cls.bonuses).map(([attr, val]) => 
                                `<span style="color: #8bc34a;">+${val}</span> ${ATTRS[attr]?.icon || ''} ${ATTRS[attr]?.name || attr}`
                            ).join(' &nbsp;|&nbsp; ') : ''}
                        </div>
                    </div>
                </div>
                
                ${guide.bestFor ? `
                <div style="text-align: center; margin-bottom: 1rem; color: #888; font-size: 0.85rem;">
                    üéØ <strong>Ide√°ln√≠ pro:</strong> ${guide.bestFor}
                </div>
                ` : ''}
                
                ${cls.restrictions ? `
                <div style="background: #3a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <span style="color: #f44336;">‚õî ${cls.restrictions}</span>
                </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="showClasses()" style="background: #555;">
                        ‚Üê Zpƒõt na v√Ωbƒõr
                    </button>
                    <button class="btn" onclick="selectClass('${id}')" style="background: ${state.char.classId === id ? '#555' : '#4caf50'};">
                        ${state.char.classId === id ? '‚úì Vybr√°no' : '‚úì Vybrat toto povol√°n√≠'}
                    </button>
                </div>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        function selectClass(id) {
            state.char.classId = id;
            closeModal();
            renderFull();
        }
        
        function showModal(title, message, persistent = false) {
            // Pokud je aktivn√≠ PvP v√Ωzva, nepovolit jin√© modaly (kromƒõ PvP souvisej√≠c√≠ch)
            if (typeof pvpChallengeOverlayActive !== 'undefined' && pvpChallengeOverlayActive) {
                if (!title.includes('PvP') && !title.includes('‚öîÔ∏è') && !title.includes('Souboj')) {
                    console.log('‚ö†Ô∏è showModal blocked - PvP challenge overlay active');
                    return;
                }
            }
            
            // Pokud ƒçek√°me na heslo pro chr√°nƒõn√Ω √∫ƒçet, ten m√° p≈ôednost
            if (window._pendingPasswordPrompt && !title.includes('Chr√°nƒõn√Ω √∫ƒçet')) {
                console.log('‚ö†Ô∏è showModal blocked - waiting for password prompt');
                // Znovu zobraz password prompt
                setTimeout(() => renderProtectedNicknameModal(), 100);
                return;
            }
            
            // Pokud message obsahuje tlaƒç√≠tko, nep≈ôid√°vej OK
            const hasButton = message.includes('<button') || message.includes('onclick=');
            
            // Ulo≈æ modal do state pro perzistenci (pokud je persistent nebo obsahuje d≈Øle≈æit√© info)
            const isImportant = title.includes('‚öîÔ∏è') || title.includes('üíÄ') || title.includes('üéâ') || 
                               title.includes('Boj') || title.includes('Nep≈ô√≠tel') || title.includes('√ötok') ||
                               message.includes('startCombat') || message.includes('Bojovat');
            
            if (persistent || isImportant) {
                state.pendingModal = { title, message, timestamp: Date.now() };
            }
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${title}</h2>
                <div style="margin: 1rem 0;">${message}</div>
                ${hasButton ? '' : '<button class="btn" onclick="closeModal()" style="width: 100%;">OK</button>'}
            `;
            document.getElementById('modal').classList.add('show');
            
            // Modal scan efekt
            if (typeof addModalScanEffect === 'function') {
                setTimeout(() => addModalScanEffect(document.getElementById('modalContent')), 50);
            }
        }
        
        // Kontrola a zobrazen√≠ pending modalu po naƒçten√≠
        function checkPendingModal() {
            if (state.pendingModal) {
                const modal = state.pendingModal;
                // Zobraz ulo≈æen√Ω modal (max 5 minut star√Ω)
                if (Date.now() - modal.timestamp < 5 * 60 * 1000) {
                    setTimeout(() => {
                        document.getElementById('modalContent').innerHTML = `
                            <h2>${modal.title}</h2>
                            <div style="margin: 1rem 0;">${modal.message}</div>
                        `;
                        document.getElementById('modal').classList.add('show');
                    }, 500);
                } else {
                    // Star√Ω modal - sma≈æ
                    delete state.pendingModal;
                }
            }
        }
        
        function closeModal() {
            // Blokuj zav≈ôen√≠ modalu bƒõhem sp√°nku
            if (state.isSleeping && state.sleepEndTime && Date.now() < state.sleepEndTime) {
                return; // Nelze zav≈ô√≠t bƒõhem sp√°nku
            }
            
            document.getElementById('modal').classList.remove('show');
            // Vyma≈æ pending modal p≈ôi zav≈ôen√≠
            if (state.pendingModal) {
                delete state.pendingModal;
            }
        }
        
        function editName() {
            const currentName = state.char.name;
            
            document.getElementById('modalContent').innerHTML = `
                <h2>‚úèÔ∏è Zmƒõnit jm√©no</h2>
                <label style="display: block; margin-bottom: 0.5rem;">${'Zadej nov√© jm√©no:'}</label>
                <input type="text" id="nameEditInput" value="${currentName}" placeholder="Tv≈Øj jedineƒçn√Ω nick..." maxlength="20" style="width: 100%; padding: 0.8rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; color: #e0e0e0; font-size: 1rem; margin-bottom: 0.5rem;">
                <p style="color: #888; font-size: 0.75rem; margin-bottom: 1rem;">‚ö†Ô∏è Jm√©na jako "Zaoo", "Admin" atd. jsou chr√°nƒõn√°</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="saveName()">‚úì Ulo≈æit</button>
                </div>
            `;
            document.getElementById('modal').classList.add('show');
            
            // Focus input after modal opens
            setTimeout(() => {
                const input = document.getElementById('nameEditInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }
        
        function saveName() {
            const input = document.getElementById('nameEditInput');
            if (input && input.value.trim()) {
                const newName = input.value.trim();
                
                // Kontrola chr√°nƒõn√Ωch jmen
                const protectedNames = ['zaoo', 'admin', 'administrator', 'moderator', 'mod', 'gm', 'gamemaster', 'developer', 'dev', 'system'];
                const nameLower = newName.toLowerCase();
                
                if (protectedNames.includes(nameLower) || nameLower.includes('zaoo') || nameLower.includes('admin')) {
                    notifyWarning('‚ö†Ô∏è Chr√°nƒõn√© jm√©no!', 'Toto jm√©no nelze pou≈æ√≠t.');
                    return;
                }
                
                state.char.name = newName;
                const display = document.getElementById('nameDisplay');
                if (display) {
                    display.textContent = state.char.name;
                }
            }
            closeModal();
        }
        
        function changeAttr(key, delta) {
            if (delta > 0 && state.char.points <= 0) return;
            if (delta < 0 && state.char.attrs[key] <= 5) return;
            
            state.char.attrs[key] += delta;
            state.char.points -= delta;
            renderFull();
        }
        
        function confirmCharacter() {
            if (!state.char.name || state.char.name.trim() === '') {
                alert('Zadej jm√©no postavy!');
                return;
            }
            if (!state.char.gender) return alert('Vyber pohlav√≠!');
            if (!state.char.classId) return alert('Vyber povol√°n√≠!');
            if (state.char.points > 0) return alert('Rozdƒõl v≈°echny body!');
            
            // Name is already in state.char.name (updated via editName modal)
            if (!state.char.name || state.char.name.trim() === '') {
                state.char.name = 'P≈ôe≈æiv≈°√≠_' + Math.floor(Math.random() * 9000 + 1000);
            }
            
            // === KONTROLA CHR√ÅNƒöN√ùCH JMEN ===
            const protectedNames = ['zaoo', 'admin', 'administrator', 'moderator', 'mod', 'gm', 'gamemaster', 'developer', 'dev', 'system'];
            const nameLower = state.char.name.trim().toLowerCase();
            
            // Kontrola p≈ôesn√© shody nebo podobnosti
            if (protectedNames.includes(nameLower) || nameLower.includes('zaoo') || nameLower.includes('admin')) {
                alert('‚ö†Ô∏è Toto jm√©no je chr√°nƒõn√© a nelze ho pou≈æ√≠t! Zvol si jin√© jm√©no.');
                return;
            }
            
            const cls = CLASSES[state.char.classId];
            
            // Apply gender bonuses to attributes
            const gender = GENDERS[state.char.gender];
            if (gender && gender.bonuses) {
                Object.entries(gender.bonuses).forEach(([attr, bonus]) => {
                    state.char.attrs[attr] += bonus;
                });
            }
            
            // Apply class bonuses to attributes
            if (cls.bonuses) {
                Object.entries(cls.bonuses).forEach(([attr, bonus]) => {
                    state.char.attrs[attr] += bonus;
                });
            }
            
            // Calculate max HP
            state.char.maxHp = 100 + (state.char.attrs.end - 5) * 10;
            
            // Class HP bonuses
            if (state.char.classId === 'survivor') state.char.maxHp += 50;
            if (state.char.classId === 'tank') state.char.maxHp += 100;
            
            // Apply gender HP bonus (male gets +5% max HP)
            if (state.char.gender === 'male') {
                state.char.maxHp = Math.floor(state.char.maxHp * 1.05);
            }
            
            state.char.hp = state.char.maxHp;
            
            // Add starting weapon
            state.inv.push({ 
                id: cls.weapon.name.toLowerCase().replace(/\s+/g, '_'),
                name: cls.weapon.name, 
                icon: cls.weapon.icon, 
                type: 'weapon', 
                damage: cls.weapon.dmg,
                weight: 1
            });
            
            // Add starting armor
            state.inv.push({ 
                id: 'worn_jacket',
                name: 'Opot≈ôebovan√° bunda', 
                icon: 'üß•', 
                type: 'armor', 
                defense: 6,
                weight: 2,
                durability: 30,
                maxDurability: 50
            });
            
            // Add starting items (medkit + 3x water + 3x food + 2x energy + sleeping bag + 100 money)
            state.inv.push({ id: 'medkit', name: 'L√©k√°rniƒçka', icon: '‚öïÔ∏è', type: 'consumable', effect: 'health', value: 40, count: 1, weight: 1 });
            state.inv.push({ id: 'water', name: 'L√°hev vody', icon: 'üíß', type: 'consumable', effect: 'thirst', value: 40, count: 3, weight: 1 });
            state.inv.push({ id: 'food', name: 'Konzervovan√© j√≠dlo', icon: 'ü•´', type: 'consumable', effect: 'hunger', value: 35, count: 3, weight: 1 });
            state.inv.push({ id: 'energy', name: 'Energetick√Ω n√°poj', icon: 'üîã', type: 'consumable', effect: 'energy', value: 50, count: 2, weight: 0.5 });
            state.inv.push({ id: 'sleeping_bag', name: 'Spac√°k', icon: 'üõèÔ∏è', type: 'tool', effect: 'sleep', value: 1, weight: 2, stackable: false });
            addMoney(100);
            
            // Flag pro prvn√≠ cestu - setk√°n√≠ se psem
            state.firstJourneyDogEvent = true;
            
            // Poƒç√°teƒçn√≠ vybaven√≠ - 1x RadAway
            const radaway = ITEMS.find(i => i.id === 'radx');
            if (radaway) {
                state.inv.push({...radaway, count: 2});
                addLog('Dostal jsi 2x RadAway na zaƒç√°tek!', '‚ò¢Ô∏è');
            }
            
            // Poƒç√°teƒçn√≠ vybaven√≠ - sand√°ly
            const sandals = ITEMS.find(i => i.id === 'sandals');
            if (sandals) {
                state.inv.push({...sandals});
                addLog('Dostal jsi sand√°ly na zaƒç√°tek!', 'ü©¥');
            }
            
            // ≈†√≠py pro t≈ô√≠dy s lukem (hunter, stalker)
            if (state.char.classId === 'hunter' || state.char.classId === 'stalker') {
                const arrows = ITEMS.find(i => i.id === 'arrow' || i.ammoType === 'arrow');
                if (arrows) {
                    state.inv.push({...arrows, count: 20});
                    addLog('Dostal jsi 20 ≈°√≠p≈Ø k luku!', 'üèπ');
                } else {
                    // Fallback - vytvo≈ô ≈°√≠py ruƒçnƒõ
                    state.inv.push({
                        id: 'arrow',
                        name: '≈†√≠py',
                        icon: '‚ûµ',
                        type: 'ammo',
                        ammoType: 'arrow',
                        weight: 0.05,
                        count: 20
                    });
                    addLog('Dostal jsi 20 ≈°√≠p≈Ø k luku!', 'üèπ');
                }
            }
            
            // Initial log
            addLog(`Dobrodru≈æstv√≠ zaƒç√≠n√°! Stal ses: ${cls.name}`, 'üéÆ');
            
            state.confirmed = true;
            state.firstTravelDone = false; // Reset pro prvn√≠ cestu s psem
            console.log('‚úì Postava potvrzena - ukl√°d√°m hru...');
            
            // Generate initial daily quests
            generateDailyQuests();
            
            // Initialize main quest
            state.mainQuest = {
                currentQuest: 'intro',
                completedQuests: [],
                questProgress: {},
                npcMet: [],
                storyComplete: false,
                chapter: 0
            };
            
            // Zobraz √∫vodn√≠ quest
            setTimeout(() => {
                const introQuest = MAIN_QUESTS.find(q => q.id === 'intro');
                showModal('üìú P≈ô√≠bƒõh zaƒç√≠n√°...', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üåÖ</div>
                        <p style="font-style: italic; color: #999; margin-bottom: 1rem;">"${introQuest.dialog.start}"</p>
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px;">
                            <h3 style="color: #d4722e; margin: 0 0 0.5rem 0;">${introQuest.title}</h3>
                            <p style="margin: 0;">${introQuest.description}</p>
                        </div>
                        <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #3a3a5a;">
                            <p style="margin: 0; color: #9c7cff; font-size: 0.9rem;">üìï V √∫krytu jsi na≈°el star√Ω den√≠k...</p>
                            <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.8rem;">Pod√≠vej se do invent√°≈ôe!</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal(); offerTutorial();" style="width: 100%; margin-top: 1rem;">Zaƒç√≠t dobrodru≈æstv√≠</button>
                `);
            }, 500);
            
            // CRITICAL: Save game immediately after confirming character
            saveGame(true);
            console.log('‚úì Hra ulo≈æena s confirmed=true');
            
            renderFull();
        }
        
        // Nab√≠dka tutori√°lu pro nov√© hr√°ƒçe
        function offerTutorial() {
            showModal('üéì Tutori√°l', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üìö</div>
                    <h3 style="color: #8bc34a;">Jsi tu nov√Ω?</h3>
                    <p style="color: #888; margin: 1rem 0;">Chce≈° proj√≠t kr√°tk√Ωm tutori√°lem? Nauƒç√≠≈° se z√°klady p≈ôe≈æit√≠ v pustinƒõ.</p>
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left; font-size: 0.85rem;">
                        <div style="color: #4CAF50;">‚úì Jak funguj√≠ statistiky</div>
                        <div style="color: #4CAF50;">‚úì Jak pou≈æ√≠vat invent√°≈ô</div>
                        <div style="color: #4CAF50;">‚úì Jak cestovat po mapƒõ</div>
                        <div style="color: #4CAF50;">‚úì Jak funguje boj</div>
                        <div style="color: #4CAF50;">‚úì Jak z√≠skat spoleƒçn√≠ky</div>
                        <div style="color: #4CAF50;">‚úì Jak budovat osadu</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #333;">P≈ôeskoƒçit</button>
                    <button class="btn" onclick="closeModal(); showTutorial(0);" style="background: #4CAF50;">Spustit tutori√°l</button>
                </div>
            `);
        }
        
        function switchTab(tabName) {
            state.activeTab = tabName;
            
            // P≈ôepni obsah bez efektu
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active');
            
            const tabId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            const tab = document.getElementById(tabId);
            if (tab) tab.classList.add('active');
            
            if (tabName === 'map') setTimeout(initMap, 50);
            
            // Prvn√≠ n√°v≈°tƒõva v√Ωbavy - v√Ωbƒõr poƒç√°teƒçn√≠ho n√°stroje
            if (tabName === 'inv' && !state.starterToolChosen) {
                setTimeout(() => showStarterToolModal(), 100);
            }
                
            // Prvn√≠ n√°v≈°tƒõva osady - v√Ωbƒõr prvn√≠ho osadn√≠ka
            if (tabName === 'base' && state.settlement.firstVisit && state.settlement.settlers.length === 0) {
                setTimeout(() => showFirstSettlerModal(), 100);
            }
        }
        
        function showStarterToolModal() {
            showModal('üéÅ Vyber si poƒç√°teƒçn√≠ n√°stroj', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #aaa;">Jako p≈ôe≈æiv≈°√≠ zaƒç√≠n√°≈° s jedn√≠m n√°strojem. Vyber moud≈ôe!</p>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    <!-- Luk -->
                    <div onclick="chooseStarterTool('bow')" style="cursor: pointer; background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 8px; border: 2px solid #2E7D32; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">üèπ</div>
                            <div style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; color: #8bc34a;">D≈ôevƒõn√Ω luk</h3>
                                <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                                    Umo≈æ≈àuje <strong style="color: #8bc34a;">lovit zvƒõ≈ô</strong> v les√≠ch a pl√°n√≠ch.<br>
                                    Z√≠sk√°≈° ü•© maso a üßµ l√°tku z uloven√Ωch zv√≠≈ôat.
                                </p>
                                <p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.75rem;">‚öîÔ∏è +6 damage | Lokace: Les, Pl√°nƒõ</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Krump√°ƒç -->
                    <div onclick="chooseStarterTool('pickaxe')" style="cursor: pointer; background: linear-gradient(135deg, #1a1a1a, #0a0a0a); padding: 1rem; border-radius: 8px; border: 2px solid #5D4037; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">‚õèÔ∏è</div>
                            <div style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; color: #8D6E63;">Krump√°ƒç</h3>
                                <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                                    Umo≈æ≈àuje <strong style="color: #8D6E63;">tƒõ≈æit suroviny</strong> v hor√°ch.<br>
                                    Z√≠sk√°≈° üóø k√°men, ‚öôÔ∏è kov a vz√°cn√© rudy.
                                </p>
                                <p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.75rem;">üîß N√°stroj | Lokace: Hory, Doly</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prut -->
                    <div onclick="chooseStarterTool('fishing_rod')" style="cursor: pointer; background: linear-gradient(135deg, #0a1a2a, #0a0a1a); padding: 1rem; border-radius: 8px; border: 2px solid #1565C0; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">üé£</div>
                            <div style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; color: #64B5F6;">Ryb√°≈ôsk√Ω prut</h3>
                                <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                                    Umo≈æ≈àuje <strong style="color: #64B5F6;">chytat ryby</strong> u vody.<br>
                                    Z√≠sk√°≈° üêü ryby a obƒças vz√°cn√© √∫lovky.
                                </p>
                                <p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.75rem;">üîß N√°stroj | Lokace: Jezero, ≈òeka, Pob≈ôe≈æ√≠</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 1rem;">
                    üí° Ostatn√≠ n√°stroje m≈Ø≈æe≈° vyrobit v d√≠lnƒõ nebo naj√≠t ve svƒõtƒõ.
                </p>
            `);
        }
        
        function chooseStarterTool(toolType) {
            state.starterToolChosen = true;
            closeModal();
            
            if (toolType === 'bow') {
                state.inv.push({ 
                    id: 'wooden_bow', name: 'D≈ôevƒõn√Ω luk', icon: 'üèπ', type: 'weapon', 
                    damage: 6, weight: 1, price: 40, rarity: 'common', ammoType: 'arrow',
                    durability: 100, maxDurability: 100 
                });
                // Startovn√≠ ≈°√≠py
                addAmmo('arrow', 20);
                notifySuccess('Z√≠skal jsi D≈ôevƒõn√Ω luk!', ('M≈Ø≈æe≈° lovit zvƒõ≈ô üèπ (+20 ≈°√≠p≈Ø)'));
                addLog('Vybral sis d≈ôevƒõn√Ω luk jako poƒç√°teƒçn√≠ n√°stroj (+20 ≈°√≠p≈Ø)', 'üèπ');
            } else if (toolType === 'pickaxe') {
                state.inv.push({ 
                    id: 'pickaxe', name: 'Krump√°ƒç', icon: '‚õèÔ∏è', type: 'tool', 
                    bonus: 'mining', weight: 3, price: 100, rarity: 'uncommon', 
                    durability: 100, maxDurability: 100 
                });
                notifySuccess('Z√≠skal jsi Krump√°ƒç!', ('M≈Ø≈æe≈° tƒõ≈æit suroviny ‚õèÔ∏è'));
                addLog('Vybral sis krump√°ƒç jako poƒç√°teƒçn√≠ n√°stroj', '‚õèÔ∏è');
            } else if (toolType === 'fishing_rod') {
                state.inv.push({ 
                    id: 'fishing_rod', name: 'Ryb√°≈ôsk√Ω prut', icon: 'üé£', type: 'tool', 
                    bonus: 'fishing', bonusValue: 1, weight: 1, price: 50, rarity: 'common', 
                    durability: 100, maxDurability: 100 
                });
                notifySuccess('Z√≠skal jsi Ryb√°≈ôsk√Ω prut!', ('M≈Ø≈æe≈° chytat ryby üé£'));
                addLog('Vybral sis ryb√°≈ôsk√Ω prut jako poƒç√°teƒçn√≠ n√°stroj', 'üé£');
            }
            
            renderFull();
        }
        
        // Modal pro v√Ωbƒõr prvn√≠ho osadn√≠ka
        function showFirstSettlerModal() {
            let html = '<div style="text-align: center; margin-bottom: 1.5rem;">';
            html += '<div style="font-size: 4rem; margin-bottom: 0.5rem;">üèòÔ∏è</div>';
            html += '<h3 style="margin: 0; color: var(--toxic-green);">V√≠tej ve sv√© osadƒõ!</h3>';
            html += '<p style="color: #aaa; margin: 0.5rem 0;">Tvoje z√°kladna u≈æ m√° postavenou <strong style="color: #8bc34a;">üåø Zahradu</strong> a <strong style="color: #2196f3;">üíß Sbƒõraƒç de≈°≈•ov√© vody</strong>.</p>';
            html += '<p style="color: #ffd700;">Vyber si jednoho obyvatele, kter√Ω se k tobƒõ p≈ôid√° zdarma!</p>';
            html += '</div>';
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.8rem; max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0.5rem;">';
            
            SETTLER_TYPES.forEach(type => {
                html += '<div onclick="selectFirstSettler(\'' + type.id + '\')" style="background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer; border: 2px solid #333; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--toxic-green)\'; this.style.transform=\'scale(1.02)\'" onmouseout="this.style.borderColor=\'#333\'; this.style.transform=\'scale(1)\'">';
                html += '<div style="font-size: 2.5rem;">' + type.icon + '</div>';
                html += '<div style="font-weight: bold; margin: 0.3rem 0; color: #fff;">' + type.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: #8bc34a; margin-bottom: 0.3rem;">' + type.desc + '</div>';
                html += '<div style="font-size: 0.7rem; color: #ff9800;">Spot≈ôeba: -' + type.consumption.food + 'üçñ -' + type.consumption.water + 'üíß/den</div>';
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 1rem;">' + ('M≈Ø≈æe≈° zav≈ô√≠t a vybrat pozdƒõji - nab√≠dka z≈Østane!') + '</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">' + ('‚è∏Ô∏è Vybrat pozdƒõji') + '</button>';
            
            showModal('üéÅ Vyber sv√©ho prvn√≠ho osadn√≠ka', html);
        }
        
        function selectFirstSettler(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            if (!type) return;
            
            // Generuj jm√©no
            const names = ['Jan', 'Petr', 'Karel', 'Martin', 'Tom√°≈°', 'Pavel', 'Jakub', 'Ond≈ôej', 'Marie', 'Eva', 'Anna', 'Lucie', 'Petra', 'Jana', 'Tereza', 'Kate≈ôina', 'Hana', 'Zuzana'];
            const name = names[Math.floor(Math.random() * names.length)];
            
            const settler = {
                id: 'settler_' + Date.now(),
                type: typeId,
                name: name,
                hp: 100,
                maxHp: 100,
                morale: 70, // Zaƒç√≠n√° s dobrou mor√°lkou
                skillLevel: 1,
                xp: 0,
                assignedTo: null
            };
            
            state.settlement.settlers.push(settler);
            state.settlement.firstVisit = false; // Teƒè u≈æ vybral - u≈æ nenab√≠zet zdarma
            closeModal();
            
            addLog('üë• ' + name + ' (' + type.name + ') se p≈ôidal/a k tv√© osadƒõ!', 'üèòÔ∏è');
            
            showModal('üéâ Nov√Ω osadn√≠k!', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: 1rem;">${type.icon}</div>
                    <h2 style="margin: 0; color: var(--toxic-green);">${name}</h2>
                    <p style="color: #888; margin: 0.5rem 0;">${type.name}</p>
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                        <p style="margin: 0.3rem 0;"><strong>Schopnost:</strong> <span style="color: #8bc34a;">${type.desc}</span></p>
                        <p style="margin: 0.3rem 0;"><strong>Spot≈ôeba:</strong> <span style="color: #ff9800;">-${type.consumption.food}üçñ -${type.consumption.water}üíß dennƒõ</span></p>
                    </div>
                    <p style="color: #aaa; font-size: 0.9rem;">Tvoje osada teƒè produkuje zdroje a je p≈ôipravena r≈Øst!</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">‚úì V√Ωbornƒõ!</button>
                </div>
            `);
            
            saveGame(true);
            renderFull();
        }
        
        // === NOV√ù MAP SYST√âM ===
        
        // Hlavn√≠ renderov√°n√≠ mapy
        function renderWorldMap() {
            // Zajisti ≈æe currentLocation existuje
            if (!state.world.currentLocation) {
                state.world.currentLocation = 'shelter';
            }
            
            // === NAƒåTI FRAKƒåN√ç TERITORIA DO CACHE ===
            // Naƒçteme teritoria pro zobrazen√≠ barev na mapƒõ (refresh ka≈æd√Ωch 10s nebo p≈ôi prvn√≠m naƒçten√≠)
            const shouldRefreshCache = !window.territoryCache || 
                                       !window.territoryCacheTime || 
                                       (Date.now() - window.territoryCacheTime > 10000);
            
            if (multiplayerEnabled && firebaseDB && shouldRefreshCache) {
                window.territoryCacheTime = Date.now();
                firebaseDB.ref('territories').once('value').then(snapshot => {
                    window.territoryCache = snapshot.val() || {};
                    const ownedCount = Object.values(window.territoryCache).filter(t => t && t.owner).length;
                    console.log('üó∫Ô∏è Territory cache loaded:', Object.keys(window.territoryCache).length, 'territories,', ownedCount, 'owned');
                    // Debug: zobraz prvn√≠ch p√°r √∫zem√≠ s vlastn√≠kem
                    Object.entries(window.territoryCache).slice(0, 5).forEach(([id, t]) => {
                        if (t && t.owner) console.log('  üè¥', id, '-> owner:', t.owner);
                    });
                    // V≈ΩDY p≈ôekresli mapu po naƒçten√≠ cache
                    if (state.activeTab === 'map') {
                        setTimeout(() => renderFull(), 50);
                    }
                }).catch(e => console.log('Territory cache error:', e));
                
                // === NAƒåTI V√ÅLEƒåNOU Z√ìNU ===
                firebaseDB.ref('warZone').once('value').then(async snapshot => {
                    const warZone = snapshot.val();
                    if (warZone && warZone.endTime > Date.now()) {
                        window.activeWarZone = warZone;
                        console.log('‚öîÔ∏è War zone active:', warZone.locationId);
                    } else if (warZone && warZone.endTime <= Date.now()) {
                        // War zone expirovala - automaticky vyhodno≈•
                        console.log('‚öîÔ∏è War zone expired, auto-evaluating...');
                        window.activeWarZone = null;
                        await autoEvaluateExpiredWarZone(warZone);
                    } else {
                        window.activeWarZone = null;
                    }
                }).catch(e => console.log('War zone cache error:', e));
                
                // === NAƒåTI ZTRACEN√ù POKLAD ===
                firebaseDB.ref('treasure').once('value').then(snapshot => {
                    const treasure = snapshot.val();
                    if (treasure && treasure.endTime > Date.now()) {
                        window.activeTreasure = treasure;
                        console.log('üíé Treasure active:', treasure.locationId);
                    } else {
                        window.activeTreasure = null;
                    }
                }).catch(e => console.log('Treasure cache error:', e));
            }
            
            // === KONTROLA V≈†ECH QUEST PROGRESS P≈òI ZOBRAZEN√ç MAPY ===
            // Toto zajist√≠ ≈æe questy se aktualizuj√≠ i kdy≈æ hr√°ƒç u≈æ je v c√≠lov√© lokaci
            const currentLocationId = state.world.currentLocation;
            
            // 1. Main quest - p≈ô√≠bƒõhov√© questy
            if (state.mainQuest?.currentQuest) {
                updateQuestProgress('location', currentLocationId);
            }
            
            // 2. Timed questy - ƒçasovƒõ omezen√©
            if (state.timedQuests?.length > 0) {
                checkTimedQuestObjectives('location', currentLocationId);
            }
            
            // 3. Companion questy
            if (state.companions?.length > 0) {
                checkCompanionQuestObjectives('location', currentLocationId);
            }
            
            // Toggle quest tracker sbalen√≠/rozbalen√≠
            function toggleQuestTracker() {
                state.questTrackerCollapsed = !state.questTrackerCollapsed;
                renderFull();
            }
            window.toggleQuestTracker = toggleQuestTracker;
            
            // === QUEST TRACKER WIDGET ===
            function renderQuestTracker() {
                const activeQuests = [];
                
                // 0. ƒåasovƒõ limitovan√© questy - NEJVY≈†≈†√ç PRIORITA
                if (state.timedQuests) {
                    const activeTimed = state.timedQuests.filter(q => !q.completed && !q.failed);
                    activeTimed.forEach(tq => {
                        const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                        if (quest) {
                            const remaining = Math.max(0, tq.endTime - Date.now());
                            const minutes = Math.floor(remaining / 60000);
                            activeQuests.push({
                                type: 'timed',
                                icon: '‚è∞',
                                name: quest.name,
                                location: quest.location || null,
                                color: remaining < 5 * 60000 ? '#f44336' : '#ff9800',
                                timer: `${minutes}m`,
                                urgent: remaining < 5 * 60000
                            });
                        }
                    });
                }
                
                // 0b. Detektivn√≠ questy
                if (state.detectiveQuests) {
                    Object.entries(state.detectiveQuests).forEach(([questId, dq]) => {
                        if (!dq.solved) {
                            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
                            if (quest) {
                                activeQuests.push({
                                    type: 'detective',
                                    icon: 'üîç',
                                    name: quest.name,
                                    location: null,
                                    color: '#9c27b0',
                                    extra: `Stopy: ${dq.cluesFound.length}/${quest.requiredClues}`,
                                    questId: questId
                                });
                            }
                        }
                    });
                }
                
                // 0c. Companion questy
                if (state.companions) {
                    state.companions.forEach(comp => {
                        if (comp.activeQuest) {
                            const questData = COMPANION_QUESTS[comp.id];
                            const chapter = questData?.chapters.find(c => c.id === comp.activeQuest.id);
                            if (chapter) {
                                // Najdi prvn√≠ nesplnƒõn√Ω c√≠l typu location
                                let targetLocation = null;
                                if (chapter.objectives) {
                                    const incompleteObj = chapter.objectives.find((obj, i) => 
                                        !comp.activeQuest.objectives?.[i]?.completed && 
                                        (obj.type === 'location' || obj.type === 'explore')
                                    );
                                    if (incompleteObj) {
                                        targetLocation = incompleteObj.target;
                                    }
                                }
                                
                                activeQuests.push({
                                    type: 'companion',
                                    icon: comp.icon,
                                    name: chapter.title,
                                    location: targetLocation || chapter.trigger?.location || null,
                                    color: '#e91e63',
                                    extra: comp.name
                                });
                            }
                        }
                    });
                }
                
                // 1. Hlavn√≠ p≈ô√≠bƒõhov√Ω quest
                if (state.mainQuest?.currentQuest && !state.mainQuest.storyComplete) {
                    const quest = MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
                    if (quest) {
                        // Hledej lokaci v objectives - m≈Ø≈æe b√Ωt jako 'location' nebo 'target'
                        let questLocation = null;
                        if (quest.objectives && quest.objectives.length > 0) {
                            const obj = quest.objectives[0];
                            questLocation = obj.location || obj.target || null;
                        }
                        
                        activeQuests.push({
                            type: 'story',
                            icon: 'üìñ',
                            name: getMainQuestTitle(quest.id),
                            location: questLocation,
                            color: '#ffd700'
                        });
                    }
                }
                
                // 2. NPC questy
                if (state.npcQuests) {
                    Object.entries(state.npcQuests).forEach(([npcId, questData]) => {
                        if (questData?.id) {
                            const quest = NPC_QUESTS[questData.id];
                            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                            if (quest && npc) {
                                // Zkontroluj jestli je quest splnƒõn√Ω
                                const isComplete = typeof checkNPCQuestProgress === 'function' ? 
                                    checkNPCQuestProgress(questData, quest) : false;
                                
                                activeQuests.push({
                                    type: 'npc',
                                    icon: npc.icon,
                                    name: quest.name,
                                    npcName: npc.name,
                                    location: npc.location,
                                    color: isComplete ? '#4caf50' : '#ff9800',
                                    isQuestComplete: isComplete
                                });
                            }
                        }
                    });
                }
                
                // 3. Denn√≠ questy
                if (state.dailyQuests?.quests) {
                    const incomplete = state.dailyQuests.quests.filter(q => 
                        !state.dailyQuests.completed?.includes(q.id)
                    );
                    if (incomplete.length > 0) {
                        activeQuests.push({
                            type: 'daily',
                            icon: 'üìÖ',
                            name: `Denn√≠ √∫koly (${incomplete.length})`,
                            location: null,
                            color: '#2196f3'
                        });
                    }
                }
                
                // 4. Osadnick√© questy
                if (state.settlement?.activeQuests?.length > 0) {
                    activeQuests.push({
                        type: 'settler',
                        icon: 'üèòÔ∏è',
                        name: `√ökoly osadn√≠k≈Ø (${state.settlement.activeQuests.length})`,
                        location: 'shelter',
                        color: '#8bc34a'
                    });
                }
                
                if (activeQuests.length === 0) return '';
                
                // Kontrola jestli je quest tracker sbalen√Ω
                const isCollapsed = state.questTrackerCollapsed || false;
                
                let html = '<div style="background: linear-gradient(135deg, #1a1a2a 0%, #0d0d1a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #3949AB; margin-bottom: 1rem; pointer-events: auto; position: relative; z-index: 100;">';
                html += '<div onclick="toggleQuestTracker()" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ' + (isCollapsed ? '0' : '0.5rem') + '; cursor: pointer; user-select: none;">';
                html += '<span style="color: #7986CB; font-weight: bold; font-size: 0.9rem;">üìå ' + ('AKTIVN√ç QUESTY') + '</span>';
                html += '<span style="color: #555; font-size: 0.75rem;">' + activeQuests.length + ' ' + ('aktivn√≠') + ' ' + (isCollapsed ? '‚ñº' : '‚ñ≤') + '</span>';
                html += '</div>';
                
                if (!isCollapsed) {
                html += '<div style="display: flex; flex-direction: column; gap: 0.4rem; pointer-events: auto;">';
                activeQuests.forEach(q => {
                    const isHere = q.location === state.world.currentLocation;
                    const locationName = q.location ? (WORLD_LOCATIONS.find(l => l.id === q.location)?.name || q.location) : null;
                    const directionInfo = q.location && !isHere ? getDirectionToLocation(q.location) : null;
                    
                    // Speci√°ln√≠ onclick pro detektivn√≠ questy
                    const onClickAction = q.type === 'detective' ? 
                        `showDetectiveQuestStatus('${q.questId}')` : 
                        `showQuestTrackerDetail('${q.type}')`;
                    
                    html += '<div onclick="event.stopPropagation(); ' + onClickAction + '" style="cursor: pointer; background: ' + (isHere ? q.color + '22' : '#0a0a0a') + '; padding: 0.5rem; border-radius: 6px; border-left: 3px solid ' + q.color + '; display: flex; align-items: center; gap: 0.5rem; position: relative; z-index: 10; ' + (q.urgent ? 'animation: pulse 1s infinite;' : '') + '">';
                    html += '<span style="font-size: 1.2rem;">' + q.icon + '</span>';
                    html += '<div style="flex: 1; min-width: 0;">';
                    html += '<div style="font-size: 0.85rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + q.name + '</div>';
                    if (q.timer) {
                        html += '<div style="font-size: 0.75rem; color: ' + q.color + '; font-weight: bold;">‚è∞ ' + q.timer + ' ' + ('zb√Ωv√°') + '</div>';
                    }
                    if (q.extra) {
                        html += '<div style="font-size: 0.7rem; color: #888;">' + q.extra + '</div>';
                    }
                    if (q.npcName) {
                        html += '<div style="font-size: 0.7rem; color: #888;">' + ('Od:') + ' ' + q.npcName + '</div>';
                    }
                    if (locationName) {
                        html += '<div style="font-size: 0.7rem; color: ' + (isHere ? '#8bc34a' : '#666') + '; display: flex; align-items: center; gap: 0.3rem;">';
                        if (isHere) {
                            html += '<span style="color: #8bc34a;">üìç ' + ('Jsi tady') + '</span>';
                        } else {
                            html += '<span>üìç ' + locationName + '</span>';
                            if (directionInfo && directionInfo.distance > 0) {
                                html += '<span style="color: #888;">(' + directionInfo.arrow + ' ' + directionInfo.distance + ')</span>';
                            }
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                    // Fajfka jen pro splnƒõn√© questy, ne jen pro "jsi na lokaci"
                    if (q.isQuestComplete) {
                        html += '<span style="color: #4caf50; font-size: 1.2rem;" title="Quest splnƒõn - m≈Ø≈æe≈° odevzdat!">‚úì</span>';
                    } else if (isHere) {
                        html += '<span style="color: #ff9800; font-size: 0.9rem;" title="Jsi na m√≠stƒõ">üìç</span>';
                    }
                    html += '</div>';
                });
                html += '</div>';
                } // konec if (!isCollapsed)
                
                html += '</div>';
                return html;
            }
            
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation) || WORLD_LOCATIONS[0];
            
            // Ochrana proti neplatn√© lokaci
            if (!currentLoc || !currentLoc.id) {
                console.error('renderWorldMap: Invalid currentLoc, resetting to shelter. state.world.currentLocation was:', state.world.currentLocation);
                state.world.currentLocation = 'shelter';
                const shelterLoc = WORLD_LOCATIONS.find(l => l.id === 'shelter');
                if (!shelterLoc) {
                    return '<div style="color: #f44336; padding: 1rem;">Chyba: Nelze naj√≠t ≈æ√°dnou platnou lokaci</div>';
                }
                return renderWorldMap(); // Rekurzivn√≠ vol√°n√≠ s opravenou lokac√≠
            }
            
            // Debug: pokud lokace nen√≠ nalezena v WORLD_LOCATIONS
            if (!WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation)) {
                console.warn('renderWorldMap: Location not found, using fallback. Requested:', state.world.currentLocation, 'Using:', currentLoc.id);
            }
            
            const availablePaths = WORLD_PATHS.filter(p => 
                p.from === state.world.currentLocation || p.to === state.world.currentLocation
            );
            
            console.log('renderWorldMap: currentLocation =', state.world.currentLocation, ', paths found =', availablePaths.length, ', total paths =', WORLD_PATHS.length);
            
            // Debug: zobraz prvn√≠ 3 cesty ze WORLD_PATHS
            if (availablePaths.length === 0 && WORLD_PATHS.length > 0) {
                console.log('Sample paths:', WORLD_PATHS.slice(0, 3).map(p => p.from + ' -> ' + p.to));
            }
            
            const zoneColors = { safe: '#4CAF50', medium: '#FF9800', danger: '#f44336', deadly: '#9C27B0' };
            const zoneNames = { safe: 'üü¢ Bezpeƒçn√°', medium: 'üü° St≈ôedn√≠', danger: 'üî¥ Nebezpeƒçn√°', deadly: 'üíÄ Smrteln√°' };
            
            const uiTexts = {
                visited: 'Nav≈°t√≠veno',
                dangerLevel: '√örove≈à nebezpeƒç√≠',
                traveling: 'üö∂ CESTUJE≈†...',
                hunt: 'LOV',
                mine: 'Tƒö≈ΩBA',
                fish: 'RYBOLOV',
                explore: 'PR≈ÆZKUM',
                gather: 'SB√çR√ÅN√ç'
            };
            
            let html = '';
            
            // Aktu√°ln√≠ lokace header + AKCE V JEDNOM BOXU
            html += '<div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 1rem; border-radius: 8px; border: 2px solid ' + zoneColors[currentLoc.zone] + '; margin-bottom: 1rem;">';
            
            // Header s n√°zvem lokace
            html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">';
            html += '<div><div style="font-size: 2.5rem; display: inline-block; margin-right: 0.5rem;">' + currentLoc.icon + '</div>';
            html += '<div style="display: inline-block; vertical-align: top;"><h2 style="margin: 0; color: #fff;">' + getLocName(currentLoc.id) + '</h2>';
            html += '<span style="background: ' + zoneColors[currentLoc.zone] + '22; color: ' + zoneColors[currentLoc.zone] + '; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; border: 1px solid ' + zoneColors[currentLoc.zone] + ';">' + zoneNames[currentLoc.zone] + '</span></div></div>';
            html += '<div style="text-align: right;"><div style="font-size: 0.8rem; color: #888;">' + uiTexts.visited + ': ' + state.world.visitedLocations.length + '/' + WORLD_LOCATIONS.length + '</div></div></div>';
            
            // Popis lokace
            html += '<p style="margin: 0.8rem 0; color: #aaa; font-size: 0.9rem;">' + getLocDesc(currentLoc.id) + '</p>';
            if (currentLoc.dangerLevel) {
                html += '<p style="margin: 0 0 0.8rem 0; color: #ff9800; font-size: 0.8rem;">‚ö†Ô∏è ' + uiTexts.dangerLevel + ': ' + 'üíÄ'.repeat(currentLoc.dangerLevel) + '</p>';
            }
            
            // Poƒças√≠ (pokud nen√≠ ƒçisto)
            const weather = getCurrentWeather();
            if (weather && weather.id !== 'clear') {
                const weatherColor = weather.id === 'radstorm' ? '#ff9800' : '#4FC3F7';
                html += '<div style="background: ' + weatherColor + '22; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.8rem; border: 1px solid ' + weatherColor + ';">';
                html += '<span style="color: ' + weatherColor + ';">' + weather.icon + ' ' + weather.name + '</span>';
                if (weather.id === 'radstorm' && !state.map.inBase) {
                    html += ' <span style="color: #ff4444;">(+radiace venku!)</span>';
                }
                html += '</div>';
            }
            
            // AKCE - p≈ô√≠mo v info boxu
            if (!state.world.traveling) {
                html += '<div style="border-top: 1px solid #333; padding-top: 0.8rem; margin-top: 0.5rem;">';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                html += getLocationActionButtons(currentLoc);
                html += '</div>';
                
                // NPC na lokaci
                html += renderLocationNPCs(currentLoc);
                html += '</div>';
            }
            
            html += '</div>';
            
            // === QUEST TRACKER WIDGET ===
            html += renderQuestTracker();
            
            // === PROGRESS BARY (nad mapou) ===
            // Cestov√°n√≠ progress bar - s kontrolou validity
            if (state.world.traveling) {
                // Auto-reset pokud je traveling stav neplatn√Ω
                const now = Date.now();
                const travelEnd = (state.world.travelStart || 0) + (state.world.travelDuration || 0);
                
                // Pokud cestov√°n√≠ mƒõlo skonƒçit p≈ôed v√≠ce ne≈æ 10 sekundami, resetuj
                if (travelEnd > 0 && now > travelEnd + 10000) {
                    console.log('üîß Auto-reset: Cestov√°n√≠ mƒõlo skonƒçit, resetuji stav');
                    state.world.traveling = false;
                    state.map.traveling = false;
                    state.world.travelTo = null;
                    state.world.scheduledEvents = [];
                } 
                // Pokud chyb√≠ c√≠lov√° destinace, resetuj
                else if (!state.world.travelTo) {
                    console.log('üîß Auto-reset: Chyb√≠ c√≠lov√° destinace, resetuji stav');
                    state.world.traveling = false;
                    state.map.traveling = false;
                }
                // Pokud chyb√≠ travel duration, resetuj
                else if (!state.world.travelDuration || state.world.travelDuration <= 0) {
                    console.log('üîß Auto-reset: Chyb√≠ travel duration, resetuji stav');
                    state.world.traveling = false;
                    state.map.traveling = false;
                }
            }
            
            // Zobraz progress bar jen pokud je st√°le traveling
            if (state.world.traveling) {
                const targetLoc = WORLD_LOCATIONS.find(l => l.id === state.world.travelTo);
                const progress = Math.min(100, ((Date.now() - state.world.travelStart) / state.world.travelDuration) * 100);
                const remaining = Math.max(0, Math.ceil((state.world.travelStart + state.world.travelDuration - Date.now()) / 1000));
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                const timeDisplay = mins > 0 ? `${mins}:${String(secs).padStart(2, '0')}` : `${secs}s`;
                
                // Zjisti jestli byla c√≠lov√° lokace u≈æ nav≈°t√≠vena
                const isTargetVisited = targetLoc && state.world.visitedLocations?.includes(targetLoc.id);
                const targetName = isTargetVisited ? getLocName(targetLoc.id) : '??? Nezn√°m√° lokace';
                
                html += '<div style="background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%); padding: 1rem; border-radius: 8px; border: 2px solid var(--warning-yellow); margin-bottom: 1rem;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
                html += '<span style="color: var(--warning-yellow); font-weight: bold;">' + uiTexts.traveling + '</span>';
                html += '<span style="color: var(--toxic-green);">' + timeDisplay + '</span></div>';
                html += '<div style="background: #0a0a0a; height: 20px; border-radius: 10px; overflow: hidden; border: 1px solid var(--rust);">';
                html += '<div style="height: 100%; background: linear-gradient(90deg, var(--rust), var(--warning-yellow), var(--toxic-green)); width: ' + progress + '%; transition: width 0.5s;"></div></div>';
                html += '<p style="margin: 0.5rem 0 0 0; color: #888; font-size: 0.85rem; text-align: center;">' + getLocName(currentLoc.id) + ' ‚Üí ' + targetName + '</p>';
                html += '<button class="btn" onclick="cancelTravel()" style="width: 100%; margin-top: 0.5rem; background: #c62828; font-size: 0.85rem;">‚Ü©Ô∏è Vr√°tit se</button>';
                html += '</div>';
            }
            
            // Akce progress bar (pr≈Øzkum, lov, tƒõ≈æba, rybolov, sb√≠r√°n√≠)
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                const icons = { hunt: 'üèπ', mine: '‚õèÔ∏è', fish: 'üé£', explore: 'üîç', gather: 'üß∫' };
                const names = { hunt: uiTexts.hunt, mine: uiTexts.mine, fish: uiTexts.fish, explore: uiTexts.explore, gather: uiTexts.gather };
                const colors = { hunt: '#4caf50', mine: '#ff9800', fish: '#2196f3', explore: '#9c27b0', gather: '#8bc34a' };
                
                const actionType = state.currentAction.type;
                const now = Date.now();
                const progress = Math.min(100, ((now - state.currentAction.startTime) / state.currentAction.duration) * 100);
                const remaining = Math.max(0, Math.ceil((state.currentAction.endTime - now) / 1000));
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                
                html += `<div onclick="showActionProgressModal()" style="cursor: pointer; background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 1rem; border-radius: 8px; border: 2px solid ${colors[actionType]}; margin-bottom: 1rem;">`;
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
                html += `<span style="color: ${colors[actionType]}; font-weight: bold;">${icons[actionType]} ${names[actionType]}...</span>`;
                html += `<span style="color: var(--toxic-green);">${mins}:${String(secs).padStart(2, '0')}</span></div>`;
                html += '<div style="background: #0a0a0a; height: 20px; border-radius: 10px; overflow: hidden; border: 1px solid #333;">';
                html += `<div style="height: 100%; background: linear-gradient(90deg, ${colors[actionType]}, #8bc34a); width: ${progress}%; transition: width 0.5s;"></div></div>`;
                html += `<p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.75rem; text-align: center;">${'Klikni pro detaily nebo zru≈°en√≠'}</p></div>`;
            }
            
            // === OBSAZOV√ÅN√ç √öZEM√ç PROGRESS BAR ===
            if (state.territoryCapture) {
                const locationId = state.world?.currentLocation;
                const capture = state.territoryCapture[locationId];
                if (capture && capture.startTime) {
                    // Dynamick√Ω v√Ωpoƒçet progressu z ƒçasu (stejnƒõ jako cestov√°n√≠)
                    const CAPTURE_DURATION = 30 * 60 * 1000; // 30 minut v ms
                    const elapsed = Date.now() - capture.startTime;
                    const progress = Math.min(100, (elapsed / CAPTURE_DURATION) * 100);
                    const remainingMs = Math.max(0, CAPTURE_DURATION - elapsed);
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    const mins = Math.floor(remainingSeconds / 60);
                    const secs = remainingSeconds % 60;
                    
                    const factionData = typeof PVP_FACTIONS !== 'undefined' && capture.faction ? PVP_FACTIONS[capture.faction] : null;
                    const factionColor = factionData?.color || '#ff9800';
                    const factionName = factionData?.name || 'Tv√° frakce';
                    
                    html += `<div onclick="showTerritoryInfo('${locationId}')" style="cursor: pointer; background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; border: 2px solid ${factionColor}; margin-bottom: 1rem;">`;
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
                    html += `<span style="color: ${factionColor}; font-weight: bold;">üè¥ Obsazov√°n√≠ √∫zem√≠</span>`;
                    html += `<span style="color: var(--toxic-green);">${mins}:${String(secs).padStart(2, '0')}</span></div>`;
                    html += '<div style="background: #0a0a0a; height: 20px; border-radius: 10px; overflow: hidden; border: 1px solid #333;">';
                    html += `<div style="height: 100%; background: linear-gradient(90deg, ${factionColor}, #ffd700); width: ${progress}%; transition: width 0.5s;"></div></div>`;
                    html += `<p style="margin: 0.5rem 0 0 0; color: #888; font-size: 0.75rem; text-align: center;">${progress.toFixed(0)}% pro ${factionName} ‚Ä¢ Z≈Østa≈à na m√≠stƒõ!</p>`;
                    html += `<button class="btn" onclick="event.stopPropagation(); cancelTerritoryCapture('${locationId}')" style="width: 100%; margin-top: 0.5rem; background: #c62828; font-size: 0.85rem;">‚ùå Zru≈°it obsazov√°n√≠</button>`;
                    html += '</div>';
                }
            }
            
            // P≈òEHLED SVƒöTA - mapa
            html += renderWorldOverview(zoneColors);
            
            return html;
        }
        
        // Pomocn√° funkce pro generov√°n√≠ tlaƒç√≠tek akc√≠
        function getLocationActionButtons(location) {
            let html = '';
            
            // === GROUND LOOT - p≈ôedmƒõty na zemi ===
            const groundItems = getGroundLoot();
            if (groundItems.length > 0) {
                html += `<button onclick="showGroundLoot()" style="
                    background: linear-gradient(135deg, #ff9800, #f57c00);
                    color: white;
                    border: none;
                    padding: 0.6rem 1rem;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.4rem;
                    font-size: 0.9rem;
                    font-weight: bold;
                    animation: pulse 1.5s infinite;
                ">
                    <span style="font-size: 1.2rem;">üì¶</span>
                    <span>Na zemi (${groundItems.length})</span>
                </button>`;
            }
            
            // Typy kde NELZE lovit/tƒõ≈æit (mƒõstsk√©/indoor lokace)
            const noHuntingTypes = ['shop', 'service', 'medical', 'home', 'settlement', 'empty', 'city'];
            const noMiningTypes = ['shop', 'service', 'medical', 'home', 'settlement', 'rest', 'empty', 'city'];
            
            // Konkr√©tn√≠ lokace bez p≈ô√≠rody (silnice, mƒõsta, budovy) - ani lov ani tƒõ≈æba
            const noNatureLocations = ['highway', 'gas_station', 'metro_entrance', 'subway_tunnels', 'old_bunker', 'power_plant', 'bucovice', 'shopping_mall', 'hospital', 'police_station', 'school'];
            
            // Typy kde lze va≈ôit (pot≈ôebuje≈° ohe≈à nebo kuchy≈à)
            const canCookTypes = ['home', 'rest', 'settlement', 'explore', 'resource'];
            
            // Typy kde lze dƒõlat alchymii (pot≈ôebuje≈° klid)
            const canAlchemyTypes = ['home', 'medical', 'settlement'];
            
            // === DOMOV (shelter) ===
            if (location.id === 'shelter') {
                // Lokalizovan√© texty pro akce
                const actionTexts = {
                    out: 'Ven',
                    inside: 'Dovnit≈ô',
                    sleep: 'Sp√°nek',
                    stash: 'Skr√Ω≈°',
                    settlement: 'Osada',
                    relations: 'Vztahy',
                    radio: 'R√°dio',
                    cooking: 'Va≈ôen√≠',
                    alchemy: 'Alchymie',
                    abyss: 'Propast',
                    revive: 'O≈æivit'
                };
                
                if (state.map.inBase) {
                    html += renderActionButton('üö™', actionTexts.out, 'toggleBase()', 'var(--rust)');
                } else {
                    html += renderActionButton('üè†', actionTexts.inside, 'toggleBase()', 'var(--toxic-dark)');
                }
                html += renderActionButton('üõèÔ∏è', actionTexts.sleep, "showActionModal('sleep')", '#3949AB');
                html += renderActionButton('üì¶', actionTexts.stash, 'openStashMenu()', '#455A64');
                html += renderActionButton('üèòÔ∏è', actionTexts.settlement, "switchTab('base')", '#9C27B0');
                html += renderActionButton('üë•', actionTexts.relations, 'showNPCRelations()', '#E91E63');
                html += renderActionButton('üìª', actionTexts.radio, 'useRadio()', '#283593');
                html += renderActionButton('üç≥', actionTexts.cooking, "showActionModal('cook')", '#E65100');
                html += renderActionButton('‚öóÔ∏è', actionTexts.alchemy, "showActionModal('alchemy')", '#6A1B9A');
                
                // Propast - endgame dungeon (viditeln√Ω od level 10, vstup od 15)
                if ((state.char.level || 1) >= 10) {
                    html += renderActionButton('üï≥Ô∏è', actionTexts.abyss, 'showAbyssEntrance()', '#1a0a2a');
                }
                
                const deadCompanion = state.companions?.find(c => c.isDead);
                if (deadCompanion) {
                    html += renderActionButton('üíÄ', actionTexts.revive, 'showReviveCompanionModal()', '#c62828');
                }
                return html; // Shelter m√° speci√°ln√≠ akce, konec
            }
            
            // === OBCHODY ===
            if (location.type === 'shop') {
                const shopText = 'Obchod';
                html += renderActionButton('üõí', shopText, 'openShop()', 'var(--rust-light)');
            }
            
            // === SLU≈ΩBY (d√≠lna) ===
            if (location.type === 'service') {
                const repairText = 'Opravit';
                html += renderActionButton('üîß', repairText, 'visitWorkshop()', '#5D4037');
            }
            
            // === ZDRAVOTNICTV√ç ===
            if (location.type === 'medical') {
                const healText = 'L√©ƒçit se';
                const searchText = 'Prohledat';
                html += renderActionButton('üíä', healText, 'visitHospital()', '#c62828');
                html += renderActionButton('üîç', searchText, "showActionModal('explore')", 'var(--rust)');
            }
            
            // === PR≈ÆZKUM ===
            if (location.type === 'explore' || location.type === 'dungeon') {
                const searchText = 'Prohledat';
                html += renderActionButton('üîç', searchText, "showActionModal('explore')", 'var(--rust)');
            }
            
            // === DUNGEON S PATRY ===
            if (location.type === 'dungeon') {
                console.log('üè∞ Location is dungeon:', location.id);
                console.log('üè∞ DUNGEON_FLOORS keys:', Object.keys(DUNGEON_FLOORS || {}));
                console.log('üè∞ Has floors:', !!DUNGEON_FLOORS?.[location.id]);
                
                if (DUNGEON_FLOORS && DUNGEON_FLOORS[location.id]) {
                    console.log('üè∞ Rendering ENTER button for dungeon:', location.id);
                    const enterText = 'Vstoupit';
                    html += renderActionButton('üè∞', enterText, `enterDungeon('${location.id}')`, '#6A1B9A');
                } else {
                    console.warn('üè∞ Dungeon without floors:', location.id);
                    // Fallback - zobraz alespo≈à prohled√°n√≠
                    html += renderActionButton('üîç', 'Prohledat', "showActionModal('explore')", 'var(--rust)');
                }
            }
            
            // === NEP≈ò√ÅTELSK√â ===
            if (location.type === 'hostile' || (location.type === 'dungeon' && !DUNGEON_FLOORS[location.id])) {
                // Zkontroluj zda lokace byla vyƒçi≈°tƒõn√°
                const isCleared = state.clearedLocations?.includes(location.id);
                
                if (isCleared) {
                    // Lokace vyƒçi≈°tƒõn√° - zobraz speci√°ln√≠ akce
                    const clearedText = '‚úì Lokace vyƒçi≈°tƒõn√°';
                    html += `<div style="background: #1a3a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">${clearedText}</div>`;
                    
                    // Speci√°ln√≠ akce pro r≈Øzn√© lokace
                    if (location.id === 'slave_camp') {
                        // Zkontroluj zda zajatci u≈æ byli osvobozeni
                        if (!state.freedSlaves) {
                            const freeText = 'Osvobodit zajatce';
                            html += renderActionButton('‚õìÔ∏è', freeText, 'freeSlaves()', '#4caf50');
                        } else {
                            const freedText = 'Zajatci u≈æ byli osvobozeni';
                            html += `<div style="color: #888; font-size: 0.8rem; text-align: center;">${freedText}</div>`;
                        }
                    } else if (location.id === 'raider_camp') {
                        const searchCampText = 'Prohledat t√°bor';
                        html += renderActionButton('üîç', searchCampText, "showActionModal('explore')", 'var(--rust)');
                        
                        // Zkontroluj timed quests pro rescue_hostage
                        const rescueQuest = state.timedQuests?.find(tq => 
                            tq.id === 'rescue_hostage' && !tq.completed && !tq.failed &&
                            tq.objectives.some(o => o.id === 'free_hostage' && !o.completed)
                        );
                        if (rescueQuest) {
                            const freeHostageText = 'Osvobodit rukojm√≠';
                            html += renderActionButton('üôè', freeHostageText, "completeInteractObjective('free_hostage')", '#4caf50');
                        }
                    }
                    
                    // Obecn√° kontrola timed quest≈Ø s interact objectives
                    if (state.timedQuests) {
                        state.timedQuests.filter(tq => !tq.completed && !tq.failed).forEach(tq => {
                            const quest = typeof TIMED_QUESTS !== 'undefined' ? TIMED_QUESTS.find(q => q.id === tq.id) : null;
                            if (quest && quest.location === location.id) {
                                tq.objectives.forEach((obj, i) => {
                                    const questObj = quest.objectives[i];
                                    if (questObj.type === 'interact' && !obj.completed) {
                                        // Zkontroluj zda p≈ôedchoz√≠ c√≠le jsou splnƒõny
                                        const prevComplete = tq.objectives.slice(0, i).every(o => o.completed);
                                        if (prevComplete) {
                                            html += renderActionButton('üéØ', questObj.text, `completeInteractObjective('${questObj.id}')`, '#ff9800');
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    // Mo≈ænost znovu raidu (respawn)
                    html += renderActionButton('üîÑ', 'Raid znovu', 'raidLocation()', '#555');
                } else {
                    html += renderActionButton('‚öîÔ∏è', 'Raid', 'raidLocation()', '#8B0000');
                }
            }
            
            // === ZDROJE ===
            if (location.type === 'resource' && location.resource !== 'water') {
                // Pro vodn√≠ zdroje je speci√°ln√≠ tlaƒç√≠tko "Nabrat vodu"
                const gatherLimit = checkDailyActionLimit('gather', location.id);
                if (gatherLimit.canDo) {
                    html += renderActionButton('üß∫', 'Sb√≠rat (' + gatherLimit.remaining + '/3)', "showActionModal('gather')", '#4CAF50');
                } else {
                    const hours = Math.ceil(gatherLimit.resetIn / (1000 * 60 * 60));
                    html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>üß∫ Vyƒçerp√°no (' + hours + 'h)</button>';
                }
            }
            
            // === NEBEZPEƒåN√â (radiace) - pou≈æij standardn√≠ pr≈Øzkum ===
            if (location.type === 'dangerous') {
                html += renderActionButton('‚ò¢Ô∏è', 'Prozkoumat', "showActionModal('explore')", '#ff5722');
            }
            
            // === T√ÅBO≈òI≈†Tƒö ===
            if (location.type === 'rest') {
                html += renderActionButton('üí§', 'Odpoƒçinek', 'restAtCamp()', '#3949AB');
                html += renderActionButton('üî•', 'T√°bor√°k', 'makeCampfire()', '#E65100');
                html += renderActionButton('üç≥', 'Va≈ôen√≠', "showActionModal('cook')", '#E65100');
                html += renderActionButton('üîç', 'Prohledat', "showActionModal('explore')", 'var(--rust)');
            }
            
            // === VYS√çLAƒå - R√ÅDIO ===
            if (location.id === 'radio_tower') {
                html += renderActionButton('üìª', 'R√°dio', 'useRadio()', '#283593');
                html += renderActionButton('üì°', 'Sign√°l', 'useRadioTowerSignal()', '#1565C0');
            }
            
            // === FRIENDLY NPC na lokac√≠ch ===
            const npcsHere = FRIENDLY_NPCS.filter(n => n.location === location.id);
            if (npcsHere.length > 0) {
                npcsHere.forEach(npc => {
                    html += renderActionButton(npc.icon, npc.name, `showNPCDetail('${npc.id}')`, '#E91E63');
                });
            }
            
            // === OSADY ===
            if (location.type === 'settlement') {
                // Z√°kladn√≠ settlement akce
                html += renderActionButton('üõí', 'Obchod', 'openShop()', 'var(--rust-light)');
                html += renderActionButton('üí§', 'Odpoƒçinek', 'showRestInfo()', '#3949AB');
            }
            
            // === BUƒåOVICE - HLAVN√ç MƒöSTO ===
            if (location.id === 'bucovice') {
                html += renderActionButton('üõí', 'Tr≈æi≈°tƒõ', 'openBucoviceMarket()', 'var(--rust-light)');
                html += renderActionButton('üç∫', 'Hospoda', 'visitBucoviceTavern()', '#8D6E63');
                html += renderActionButton('üè•', 'L√©ƒçitel', 'visitBucoviceHealer()', '#4CAF50');
                html += renderActionButton('üìú', 'N√°stƒõnka', 'showBucoviceBounties()', '#ff9800');
                html += renderActionButton('üí§', 'Hotel', 'restAtBucovice()', '#3949AB');
                html += renderActionButton('üîç', 'Prohledat', "showActionModal('explore')", '#607d8b');
                html += renderActionButton('‚öñÔ∏è', 'Karma', 'showStoryKarma()', '#9c27b0');
                
                // Kontrola fin√°le - m√° hr√°ƒç v≈°echny 4 komponenty?
                const hasAllComponents = ['plutonium_core', 'quantum_stabilizer', 'fusion_cell', 'ai_module'].every(
                    compId => state.inv?.some(i => i.id === compId)
                );
                
                if (hasAllComponents && !state.storyKarma?.ending) {
                    html += '<div style="margin-top: 0.5rem; padding: 0.5rem; background: linear-gradient(135deg, #4a1a4a, #1a4a4a); border-radius: 8px; border: 2px solid #ffd700;">';
                    html += '<div style="text-align: center; color: #ffd700; font-weight: bold; margin-bottom: 0.3rem;">‚ö†Ô∏è FIN√ÅLE P≈ò√çBƒöHU</div>';
                    html += '<p style="color: #aaa; font-size: 0.8rem; margin: 0 0 0.5rem 0; text-align: center;">M√°≈° v≈°echny 4 komponenty. Oba brat≈ôi jsou zde a ƒçekaj√≠ na tebe.</p>';
                    html += renderActionButton('ü¶π', 'Kory', 'showFinalChoice("kory")', '#e91e63');
                    html += renderActionButton('üë®‚Äçüî¨', 'Koudy', 'showFinalChoice("koudy")', '#2196f3');
                    html += renderActionButton('üí•', 'Zniƒçit v≈°e', 'showFinalChoice("destroy")', '#f44336');
                    html += '</div>';
                }
            }
            
            // === FRAKƒåN√ç LOKACE ===
            if (location.type === 'faction' && location.faction) {
                const faction = FACTIONS.find(f => f.id === location.faction);
                const repLevel = getFactionReputationLevel(location.faction);
                
                // Z√°kladn√≠ interakce s frakc√≠
                html += renderActionButton(faction?.icon || 'üèõÔ∏è', faction?.name || 'Frakce', "showFactionInteraction('" + location.faction + "')", faction?.color || '#ffd700');
                
                // Obchod pokud nejsou nep≈ô√°tel√©
                if (repLevel.id !== 'enemy' && repLevel.id !== 'hostile') {
                    html += renderActionButton('üõí', 'Obchod', "openFactionShop('" + location.faction + "')", 'var(--rust-light)');
                }
                
                // Speci√°ln√≠ akce podle frakce
                if (location.faction === 'traders') {
                    html += renderActionButton('üí∞', 'Investovat', "investInFaction('traders')", '#ffd700');
                }
                if (location.faction === 'scientists') {
                    html += renderActionButton('üî¨', 'V√Ωzkum', "showFactionResearch('scientists')", '#00bcd4');
                    
                    // P≈ô√≠stup do laborato≈ôe vy≈æaduje 50+ rep
                    const scientistsBonuses = getFactionBonuses();
                    if (scientistsBonuses.techAccess) {
                        html += renderActionButton('üß™', 'Laborato≈ô', "openScientistsLab()", '#00bcd4');
                    } else {
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled title="Pot≈ôebuje≈° 50+ reputace u Vƒõdc≈Ø">üß™ Laborato≈ô (üîí)</button>';
                    }
                    
                    if (repLevel.id === 'allied' || (getReputation('scientists') >= 100)) {
                        html += renderActionButton('‚ò£Ô∏è', 'L√©ƒçba mutac√≠', 'cureMutations()', '#8bc34a');
                    }
                }
                if (location.faction === 'mutants') {
                    html += renderActionButton('üß¨', 'Mutant√≠ obchod', "openMutantTrade()", '#8bc34a');
                }
                if (location.faction === 'military') {
                    // Tr√©nink vy≈æaduje alespo≈à P≈ô√°telsk√Ω status (50+ rep)
                    const militaryBonuses = getFactionBonuses();
                    if (militaryBonuses.training) {
                        html += renderActionButton('üéñÔ∏è', 'Tr√©nink', "showMilitaryTraining()", '#607d8b');
                    } else {
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled title="Pot≈ôebuje≈° 50+ reputace u Military">üéñÔ∏è Tr√©nink (üîí)</button>';
                    }
                }
                
                // Odpoƒçinek pokud p≈ô√°tel≈°t√≠
                if (repLevel.id === 'friendly' || repLevel.id === 'allied') {
                    html += renderActionButton('üí§', 'Odpoƒçinek', 'restAtCamp()', '#3949AB');
                }
            }
            
            // === SPECI√ÅLN√ç ZDROJE ===
            if (location.actions?.includes('fish') || location.id === 'lake' || location.id === 'small_pond' || location.resource === 'fish') {
                const hasFishingRod = state.inv.find(i => i.id === 'fishing_rod' || i.id === 'fishing_rod_uncommon');
                if (!hasFishingRod) {
                    html += '<button class="btn" onclick="notifyWarning(\'Chyb√≠ vybaven√≠\', \'Pot≈ôebuje≈° üé£ Ryb√°≈ôsk√Ω prut pro rybolov!\')" style="background: #333; color: #666; flex: 1;">üé£ Rybolov (üîí prut)</button>';
                } else {
                    // showActionModal('fish') automaticky zjist√≠ jestli m√° lokace spoty a zobraz√≠ v√Ωbƒõr
                    html += renderActionButton('üé£', 'Rybolov', "showActionModal('fish')", '#1565C0');
                }
            }
            if (location.resource === 'water') {
                html += renderActionButton('üíß', 'Nabrat vodu', 'collectWater()', '#1565C0');
            }
            if (location.resource === 'fuel') {
                html += renderActionButton('‚õΩ', 'ƒåerpat palivo', 'collectFuel()', '#ff9800');
            }
            
            // === LOV - jen venku v p≈ô√≠rodƒõ ===
            if (!noHuntingTypes.includes(location.type) && location.zone !== 'deadly' && !noNatureLocations.includes(location.id)) {
                const hasHuntingWeapon = state.inv.find(i => 
                    i.id === 'hunting_bow' || i.id === 'crossbow' || i.id === 'wooden_bow' || i.id === 'bow' ||
                    (i.type === 'weapon' && i.icon === 'üèπ')
                );
                if (!hasHuntingWeapon) {
                    html += '<button class="btn" onclick="notifyWarning(\'Chyb√≠ vybaven√≠\', \'Pot≈ôebuje≈° üèπ Luk nebo Ku≈°i pro lov!\')" style="background: #333; color: #666; flex: 1;">üèπ Lov (üîí luk)</button>';
                } else {
                    const huntLimit = checkDailyActionLimit('hunt', location.id);
                    if (huntLimit.canDo) {
                        html += renderActionButton('üèπ', 'Lov (' + huntLimit.remaining + '/3)', "showActionModal('hunt')", '#2E7D32');
                    } else {
                        const hours = Math.ceil(huntLimit.resetIn / (1000 * 60 * 60));
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>üèπ Vyƒçerp√°no (' + hours + 'h)</button>';
                    }
                }
            }
            
            // === Tƒö≈ΩBA - jen tam kde jsou sk√°ly/zem ===
            if (!noMiningTypes.includes(location.type) && location.zone !== 'deadly' && !noNatureLocations.includes(location.id)) {
                // Tƒõ≈æba hlavnƒõ v explore, resource, dangerous, dungeon, hostile, mine
                if (['explore', 'resource', 'dangerous', 'dungeon', 'hostile', 'mine'].includes(location.type)) {
                    const hasPickaxe = state.inv.find(i => i.id === 'pickaxe');
                    if (!hasPickaxe) {
                        html += '<button class="btn" onclick="notifyWarning(\'Chyb√≠ vybaven√≠\', \'Pot≈ôebuje≈° ‚õèÔ∏è Krump√°ƒç pro tƒõ≈æbu!\')" style="background: #333; color: #666; flex: 1;">‚õèÔ∏è Tƒõ≈æba (üîí krump√°ƒç)</button>';
                    } else {
                        const mineLimit = checkDailyActionLimit('mine', location.id);
                        if (mineLimit.canDo) {
                            html += renderActionButton('‚õèÔ∏è', 'Tƒõ≈æba (' + mineLimit.remaining + '/3)', "showActionModal('mine')", '#5D4037');
                        } else {
                            const hours = Math.ceil(mineLimit.resetIn / (1000 * 60 * 60));
                            html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>‚õèÔ∏è Vyƒçerp√°no (' + hours + 'h)</button>';
                        }
                    }
                }
            }
            
            // === SB√çR√ÅN√ç D≈òEVA - jen v lesn√≠ch lokac√≠ch (nikdy na resource lokac√≠ch) ===
            if (location.type !== 'resource') {
                const isForestLocation = location.id === 'forest_edge' || location.id === 'dense_forest' || location.icon === 'üå≤' || location.icon === 'üå≥';
                if (isForestLocation) {
                    const gatherLimit = checkDailyActionLimit('gather', location.id);
                    if (gatherLimit.canDo) {
                        html += renderActionButton('ü™µ', 'Sb√≠r√°n√≠ (' + gatherLimit.remaining + '/3)', "showActionModal('gather')", '#6D4C41');
                    } else {
                        const hours = Math.ceil(gatherLimit.resetIn / (1000 * 60 * 60));
                        html += '<button class="btn" style="background: #333; color: #666; cursor: not-allowed; flex: 1;" disabled>ü™µ Vyƒçerp√°no (' + hours + 'h)</button>';
                    }
                }
            }
            
            // === FRAKƒåN√ç V√ÅLKA - na v≈°ech lokac√≠ch kromƒõ shelter ===
            if (location.id !== 'shelter') {
                const playerFaction = getPlayerFaction();
                if (playerFaction) {
                    const factionData = PVP_FACTIONS[playerFaction];
                    html += renderActionButton(factionData.icon, '√özem√≠', 'showTerritoryActions()', factionData.color);
                } else {
                    html += renderActionButton('üè¥', 'Frakce', 'showFactionSelection()', '#ff9800');
                }
                
                // === V√ÅLEƒåN√Å Z√ìNA - pokud je aktivn√≠ na t√©to lokaci ===
                if (window.activeWarZone && window.activeWarZone.locationId === location.id) {
                    html += renderActionButton('‚öîÔ∏è', 'V√ÅLKA!', 'showWarZoneUI()', '#f44336');
                }
                
                // === ZTRACEN√ù POKLAD - pokud je aktivn√≠ na t√©to lokaci ===
                if (window.activeTreasure && window.activeTreasure.locationId === location.id && window.activeTreasure.endTime > Date.now()) {
                    const myName = state.char?.name || '';
                    const safeName = myName.replace(/[.\[\]#$/]/g, '_');
                    const alreadyClaimed = window.activeTreasure.claimedBy && window.activeTreasure.claimedBy[safeName];
                    
                    if (alreadyClaimed) {
                        html += `<button class="btn" style="background: #333; color: #888; font-size: 0.75rem; padding: 0.6rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 65px; border-radius: 8px; cursor: not-allowed; opacity: 0.6;"><span style="font-size: 1.4rem;">‚úÖ</span><span>M√°≈°</span></button>`;
                    } else {
                        html += renderActionButton('üíé', 'POKLAD!', 'claimTreasure()', '#ffd700');
                    }
                }
            }
            
            // === PR√ÅZDN√â LOKACE - ≈æ√°dn√© akce ===
            // Empty lokace nemaj√≠ ≈æ√°dn√© akce
            
            return html;
        }
        
        // Rozhl√©dnut√≠ se na pr√°zdn√© lokaci
        function lookAround() {
            const messages = [
                'Rozhl√©dne≈° se kolem... Nic zaj√≠mav√©ho. Jako tv≈Øj ≈æivot.',
                'Pusto a pr√°zdno. Jen v√≠tr, prach a existenci√°ln√≠ pr√°zdnota.',
                'Ticho. ≈Ω√°dn√© zn√°mky ≈æivota. Perfektn√≠ m√≠sto pro piknik!',
                'M√≠sto jako ka≈æd√© jin√© v pustinƒõ. Depresivn√≠.',
                'Nic k vidƒõn√≠. Mo≈æn√° p≈ô√≠≈°tƒõ. Nebo nikdy.',
                'Zd√° se, ≈æe tu opravdu nic nen√≠. P≈ôekvapen√≠!',
                'Na≈°el jsi... nic. Gratuluji.',
                'Pr√°zdnota z√≠r√° zpƒõt. Mrkla prvn√≠.',
                'Rozhl√©dl ses. Litoval jsi. Pokraƒçuje≈°.'
            ];
            
            // Obƒças p≈ôidej zvl√°≈°tn√≠ n√°lez
            if (Math.random() < 0.15) {
                const finds = getRandomHumor('finds');
                addLog(finds, 'üíÄ');
                notifyInfo('Zvl√°≈°tn√≠ n√°lez...', finds);
                return;
            }
            
            const msg = messages[Math.floor(Math.random() * messages.length)];
            addLog(msg, 'üëÅÔ∏è');
            notifyInfo('Pr≈Øzkum', msg);
        }
        
        // P≈ôehled svƒõta - 2D mapa
        // === SVƒöTOV√â STRANY - Helper funkce ===
        function getDirectionToLocation(targetLocationId) {
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const targetLoc = WORLD_LOCATIONS.find(l => l.id === targetLocationId);
            
            if (!currentLoc || !targetLoc) return { direction: '', arrow: '', distance: 0 };
            
            const dx = targetLoc.x - currentLoc.x;
            const dy = targetLoc.y - currentLoc.y;
            const distance = Math.abs(dx) + Math.abs(dy); // Manhattan distance
            
            // Urƒçen√≠ smƒõru
            let direction = '';
            let arrow = '';
            
            if (dx === 0 && dy === 0) {
                direction = 'zde';
                arrow = 'üìç';
            } else if (Math.abs(dx) > Math.abs(dy) * 2) {
                // P≈ôev√°≈ænƒõ v√Ωchod/z√°pad
                if (dx > 0) { direction = 'na v√Ωchodƒõ'; arrow = '‚û°Ô∏è'; }
                else { direction = 'na z√°padƒõ'; arrow = '‚¨ÖÔ∏è'; }
            } else if (Math.abs(dy) > Math.abs(dx) * 2) {
                // P≈ôev√°≈ænƒõ sever/jih
                if (dy > 0) { direction = 'na jihu'; arrow = '‚¨áÔ∏è'; }
                else { direction = 'na severu'; arrow = '‚¨ÜÔ∏è'; }
            } else {
                // Diagon√°ln√≠
                if (dx > 0 && dy < 0) { direction = 'na severov√Ωchodƒõ'; arrow = '‚ÜóÔ∏è'; }
                else if (dx > 0 && dy > 0) { direction = 'na jihov√Ωchodƒõ'; arrow = '‚ÜòÔ∏è'; }
                else if (dx < 0 && dy < 0) { direction = 'na severoz√°padƒõ'; arrow = '‚ÜñÔ∏è'; }
                else { direction = 'na jihoz√°padƒõ'; arrow = '‚ÜôÔ∏è'; }
            }
            
            return { direction, arrow, distance, dx, dy };
        }
        
        function getDirectionText(targetLocationId) {
            const { direction, arrow, distance } = getDirectionToLocation(targetLocationId);
            if (distance === 0) return '';
            return `${arrow} ${direction} (${distance} ${distance === 1 ? 'pole' : distance < 5 ? 'pole' : 'pol√≠'})`;
        }
        
        function renderWorldOverview(zoneColors) {
            let html = '';
            
            // === SOU≈òADNICE HR√ÅƒåE ===
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const coordsText = currentLoc ? `[${currentLoc.x}, ${currentLoc.y}]` : `[${state.map?.x || 0}, ${state.map?.y || 0}]`;
            
            html += '<details open style="background: #1a1a1a; border-radius: 8px; border: 1px solid var(--metal-light); margin-bottom: 1rem;">';
            html += '<summary style="padding: 0.8rem; cursor: pointer; color: var(--rust-light); font-weight: bold; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>üó∫Ô∏è ' + ('Mapa svƒõta') + '</span>';
            html += '<span style="color: #8bc34a; font-size: 0.85rem; font-family: monospace; background: #0a0a0a; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid #333;">üìç ' + coordsText + '</span>';
            html += '</summary>';
            html += '<div style="padding: 0.5rem; overflow-x: auto;">';
            
            // Najdi rozsah mapy
            let minX = 0, maxX = 0, minY = 0, maxY = 0;
            WORLD_LOCATIONS.forEach(loc => {
                if (loc.x < minX) minX = loc.x;
                if (loc.x > maxX) maxX = loc.x;
                if (loc.y < minY) minY = loc.y;
                if (loc.y > maxY) maxY = loc.y;
            });
            
            const cellSize = 36;
            const width = (maxX - minX + 1) * cellSize;
            const height = (maxY - minY + 1) * cellSize;
            
            // === MAPA S KOMPASEM UVNIT≈ò ===
            html += '<div style="position: relative; width: ' + width + 'px; height: ' + height + 'px; margin: 0 auto; background: #0a0a0a; border: 1px solid #333; border-radius: 4px;">';
            
            // === KOMPAS v prav√©m horn√≠m rohu mapy ===
            html += '<div style="position: absolute; top: 5px; right: 5px; width: 40px; height: 40px; background: radial-gradient(circle, #1a1a2a 0%, #0d0d1a 100%); border-radius: 50%; border: 1px solid #3a3a5a; display: flex; align-items: center; justify-content: center; z-index: 20; opacity: 0.9;">';
            html += '<div style="position: relative; width: 32px; height: 32px;">';
            html += '<div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); color: #ff4444; font-size: 0.65rem; font-weight: bold;">S</div>';
            html += '<div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); color: #666; font-size: 0.55rem;">J</div>';
            html += '<div style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.55rem;">Z</div>';
            html += '<div style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.55rem;">V</div>';
            html += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 4px; background: #ffd700; border-radius: 50%;"></div>';
            html += '</div></div>';
            
            // Vykreslen√≠ lokac√≠
            WORLD_LOCATIONS.forEach(loc => {
                const isHere = loc.id === state.world.currentLocation;
                const isVisited = state.world.visitedLocations.includes(loc.id);
                const isRevealed = state.world.revealedLocations?.includes(loc.id);
                const isKnown = isVisited || isRevealed; // Lokace je zn√°m√° pokud nav≈°t√≠vena NEBO odhalena
                const left = (loc.x - minX) * cellSize;
                const top = (loc.y - minY) * cellSize;
                
                // Zjisti jestli je lokace dostupn√° (m√° p≈ô√≠mou cestu)
                const hasPath = WORLD_PATHS.some(p => 
                    (p.from === state.world.currentLocation && p.to === loc.id) || 
                    (p.to === state.world.currentLocation && p.from === loc.id)
                );
                
                let bgColor = '#1a1a1a';
                let borderColor = '#333';
                let cursor = 'default';
                let clickAction = '';
                
                if (isHere) {
                    bgColor = 'var(--toxic-dark)';
                    borderColor = 'var(--toxic-green)';
                    // P≈ôid√°me pulsuj√≠c√≠ efekt pro aktu√°ln√≠ pozici
                } else if (hasPath) {
                    // Dostupn√° lokace - lze kliknout
                    bgColor = isKnown ? '#2a2a2a' : '#1a1a0a';
                    borderColor = isKnown ? zoneColors[loc.zone] : '#555';
                    cursor = 'pointer';
                    clickAction = isKnown ? "showLocationPreview('" + loc.id + "')" : "quickTravel('" + loc.id + "')";
                } else if (isKnown) {
                    // Nav≈°t√≠ven√°/odhalen√° ale nedostupn√° - uk√°≈æ info
                    bgColor = isRevealed && !isVisited ? '#2a1a3a' : '#2a2a2a'; // Fialov√© pozad√≠ pro odhalen√© ale nenav≈°t√≠ven√©
                    borderColor = zoneColors[loc.zone] + '44';
                    cursor = 'pointer';
                    clickAction = "showLocationPreview('" + loc.id + "')";
                } else {
                    // Nezn√°m√° a nedostupn√° - zobraz alespo≈à koordin√°ty po kliknut√≠
                    cursor = 'pointer';
                    clickAction = "showCoordsInfo(" + loc.x + ", " + loc.y + ", '???')";
                }
                
                const opacity = isHere ? 1 : (hasPath ? 1 : (isKnown ? 0.5 : 0.2));
                
                // Tooltip se sou≈ôadnicemi
                const tooltipText = isKnown ? (loc.name + ' [' + loc.x + ',' + loc.y + ']') : (hasPath ? '??? [' + loc.x + ',' + loc.y + '] (dostupn√©)' : '???');
                
                // Kontrola jestli m√° lokace skr√Ω≈° s vƒõcmi
                const hasStash = state.stashes?.[loc.id]?.length > 0;
                
                // Frakƒçn√≠ barva r√°meƒçku (pokud je √∫zem√≠ obsazen√©) - zobraz i pro nezn√°m√© lokace!
                let factionBorderColor = null;
                let factionBorderStyle = '';
                let territoryOwnerName = '';
                try {
                    if (window.territoryCache && window.territoryCache[loc.id] && window.territoryCache[loc.id].owner) {
                        const ownerFaction = PVP_FACTIONS[window.territoryCache[loc.id].owner];
                        if (ownerFaction) {
                            factionBorderColor = ownerFaction.color;
                            factionBorderStyle = ` box-shadow: 0 0 5px ${ownerFaction.color}50;`;
                            territoryOwnerName = ownerFaction.name;
                        }
                    }
                } catch(e) {
                    console.log('Territory cache error:', e);
                }
                
                // === V√ÅLEƒåN√Å Z√ìNA - v√Ωrazn√© ƒçerven√© sv√≠cen√≠ ===
                let isWarZone = false;
                if (window.activeWarZone && window.activeWarZone.locationId === loc.id && window.activeWarZone.endTime > Date.now()) {
                    isWarZone = true;
                    factionBorderColor = '#ff0000';
                    factionBorderStyle = ` box-shadow: 0 0 60px #ff0000, 0 0 120px #ff0000dd, 0 0 180px #ff0000aa, inset 0 0 60px #ff000088; animation: war-zone-pulse 1.5s infinite ease-in-out; border-color: #ff0000 !important; z-index: 10; background: radial-gradient(circle, #ff000055 0%, #ff000022 50%, transparent 70%) !important;`;
                    territoryOwnerName = '‚öîÔ∏è V√ÅLKA';
                }
                
                // === ZTRACEN√ù POKLAD - zlat√© sv√≠cen√≠ ===
                let isTreasure = false;
                if (window.activeTreasure && window.activeTreasure.locationId === loc.id && window.activeTreasure.endTime > Date.now()) {
                    isTreasure = true;
                    if (!isWarZone) { // War zone m√° p≈ôednost
                        factionBorderColor = '#ffd700';
                        factionBorderStyle = ` box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700aa; animation: treasure-pulse 1.5s infinite ease-in-out; border-color: #ffd700 !important; z-index: 10;`;
                        territoryOwnerName = 'üíé POKLAD';
                    }
                }
                
                // Pou≈æij frakƒçn√≠ barvu pokud existuje, jinak p≈Øvodn√≠
                const finalBorderColor = factionBorderColor || borderColor;
                const borderWidth = (factionBorderColor || isWarZone || isTreasure) ? '3px' : '2px';
                
                // War zone a treasure styl m√° p≈ôednost p≈ôed ostatn√≠mi
                let finalStyle = factionBorderStyle;
                if (isHere && !isWarZone && !isTreasure) {
                    finalStyle += ' animation: pulse-glow 1.5s infinite; box-shadow: 0 0 10px var(--toxic-green);';
                }
                
                html += '<div onclick="' + clickAction + '" style="position: absolute; left: ' + left + 'px; top: ' + top + 'px; width: ' + (cellSize - 2) + 'px; height: ' + (cellSize - 2) + 'px; background: ' + bgColor + '; border: ' + borderWidth + ' solid ' + finalBorderColor + '; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: ' + cursor + '; opacity: ' + (factionBorderColor ? Math.max(0.6, opacity) : opacity) + ';' + finalStyle + '" title="' + tooltipText + (territoryOwnerName ? ' [' + territoryOwnerName + ']' : '') + '">';
                
                // Zobraz ikonu - pro aktu√°ln√≠ pozici p≈ôidej üìç, pro skr√Ω≈° p≈ôidej üì¶
                if (isHere) {
                    html += '<span style="position: relative;">' + loc.icon + '<span style="position: absolute; top: -8px; right: -8px; font-size: 0.6rem;">üìç</span>' + (hasStash ? '<span style="position: absolute; bottom: -6px; left: -6px; font-size: 0.5rem;">üì¶</span>' : '') + '</span>';
                } else if (hasStash && isKnown) {
                    html += '<span style="position: relative;">' + loc.icon + '<span style="position: absolute; bottom: -6px; left: -6px; font-size: 0.5rem;">üì¶</span></span>';
                } else {
                    html += isKnown ? loc.icon : (hasPath ? '‚ùì' : '?');
                }
                html += '</div>';
            });
            
            html += '</div>';
            
            // Legenda s mini kompasem
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.8rem; padding: 0.5rem; background: #0d0d0d; border-radius: 6px;">';
            
            // Lev√° strana - legenda
            html += '<div style="display: flex; gap: 0.6rem; font-size: 0.6rem; flex-wrap: wrap;">';
            html += '<span style="color: var(--toxic-green);">üìç ' + ('Zde') + '</span>';
            html += '<span style="color: #4CAF50;">üü¢ ' + ('Bezpeƒçn√°') + '</span>';
            html += '<span style="color: #FF9800;">üü° ' + ('St≈ôedn√≠') + '</span>';
            html += '<span style="color: #f44336;">üî¥ ' + ('Nebezpeƒçn√°') + '</span>';
            html += '<span style="color: #8d6e63;">üì¶ ' + ('Skr√Ω≈°') + '</span>';
            html += '</div>';
            
            // Prav√° strana - mini kompas
            html += '<div style="display: flex; align-items: center; gap: 0.3rem; color: #666; font-size: 0.55rem;">';
            html += '<span style="color: #f44336;">' + ('S') + '</span>';
            html += '<span>‚Üë</span>';
            html += '</div>';
            
            html += '</div>';
            html += '<p style="text-align: center; font-size: 0.55rem; color: #444; margin: 0.3rem 0 0 0;">' + ('Klikni na lokaci pro info a sou≈ôadnice ‚Ä¢ ‚ùì = dostupn√°') + '</p>';
            
            // Tlaƒç√≠tko n√°povƒõdy
            html += '<div style="text-align: center; margin-top: 0.8rem; padding-top: 0.5rem; border-top: 1px solid #333;">';
            html += '<button class="btn" onclick="showMapHelp()" style="background: #3949AB; font-size: 0.8rem; padding: 0.5rem 1rem;">';
            html += '‚ùì ' + ('N√°povƒõda k mapƒõ') + '</button>';
            html += '</div>';
            
            html += '</div></details>';
            
            return html;
        }
        
        // N√°povƒõda k mapƒõ
        function showMapHelp() {
            const mapHelpTexts = {
                basics: 'Z√°klady mapy', basicsClick: 'Klikni na lokaci', basicsClickFull: 's ‚ùì pro cestov√°n√≠',
                basicsPos: 'oznaƒçuje tvou aktu√°ln√≠ pozici', basicsDistant: 'Vzd√°len√© lokace vy≈æaduj√≠ pr≈Øchod p≈ôes mezilokace',
                basicsDiscovered: 'Objeven√© lokace ukazuj√≠ svou ikonu',
                zones: 'Z√≥ny nebezpeƒç√≠', zoneSafe: 'Bezpeƒçn√°', zoneSafeDesc: 'm√°lo nep≈ô√°tel, z√°kladn√≠ loot',
                zoneMedium: 'St≈ôedn√≠', zoneMediumDesc: 'ƒçastƒõj≈°√≠ boje, lep≈°√≠ odmƒõny',
                zoneDanger: 'Nebezpeƒçn√°', zoneDangerDesc: 'siln√≠ nep≈ô√°tel√©, vz√°cn√Ω loot',
                zoneDeadly: 'Smrteln√°', zoneDeadlyDesc: 'pouze pro zku≈°en√©, legend√°rn√≠ ko≈ôist',
                locTypes: 'Typy lokac√≠', shelter: '√ökryt', shelterDesc: 'tv≈Øj domov',
                shop: 'Obchod', shopDesc: 'n√°kup/prodej', workshop: 'D√≠lna', workshopDesc: 'opravy',
                hospital: 'Nemocnice', hospitalDesc: 'l√©ƒçen√≠', ruins: 'Ruiny', ruinsDesc: 'pr≈Øzkum',
                mine: 'D≈Øl', mineDesc: 'dungeon', settlement: 'Osada', settlementDesc: 'obchod, odpoƒçinek',
                camp: 'T√°bor', campDesc: 'odpoƒçinek', arena: 'Ar√©na', arenaDesc: 'gladi√°torsk√© boje',
                dangerous: 'Nebezpeƒçn√©', dangerousDesc: 'siln√≠ nep≈ô√°tel√©',
                actions: 'Akce na lokac√≠ch', hunt: 'Lov', huntDesc: 'z√≠skej maso a k≈Ø≈æe (p≈ô√≠roda)',
                mining: 'Tƒõ≈æba', miningDesc: 'z√≠skej k√°men a kov', fishing: 'Rybolov', fishingDesc: 'u vodn√≠ch ploch',
                search: 'Prohledat', searchDesc: 'najdi p≈ôedmƒõty a suroviny', raid: 'Raid', raidDesc: '√∫tok na nep≈ô√°telskou lokaci',
                gather: 'Sb√≠rat', gatherDesc: 'sbƒõr zdroj≈Ø (resource lokace)', enter: 'Vstoupit', enterDesc: 'vstup do dungeonu s patry',
                rest: 'Odpoƒçinek', restDesc: 'regenerace HP a energie',
                travel: 'Cestov√°n√≠', travelCosts: 'Cestov√°n√≠ spot≈ôebov√°v√°', travelCostsList: 'energii, hlad a ≈æ√≠ze≈à',
                travelRandom: 'Bƒõhem cesty m≈Ø≈æe≈° narazit na', travelRandomEvents: 'n√°hodn√© ud√°losti',
                travelRad: 'Radiaƒçn√≠ bou≈ôe', travelRadDesc: '3√ó radiace bƒõhem cesty!',
                travelStorm: 'Bou≈ôka', travelStormDesc: 'pomalej≈°√≠ cestov√°n√≠',
                travelDanger: 'Nebezpeƒçnƒõj≈°√≠ z√≥ny = vƒõt≈°√≠ ≈°ance na p≈ôepaden√≠',
                npcs: 'NPC na lokac√≠ch', npcsHave: 'Nƒõkter√© lokace maj√≠', npcsFriendly: 'p≈ô√°telsk√© NPC',
                npcsTalk: 'Mluv', npcsTalkDesc: 's nimi pro zv√Ω≈°en√≠ d≈Øvƒõry',
                npcsGifts: 'D√°vej dary', npcsGiftsDesc: 'pro rychlej≈°√≠ p≈ô√°telstv√≠',
                npcsRewards: 'P≈ôi vysok√© d≈Øvƒõ≈ôe odemkne≈°', npcsRewardsDesc: 'speci√°ln√≠ odmƒõny',
                dungeons: 'Dungeony', dungeonsFloors: 'Nƒõkter√© lokace maj√≠', dungeonsFloorsDesc: 'v√≠ce pater',
                dungeonsEach: 'Ka≈æd√© patro m√° sv√© nep≈ô√°tele a loot',
                dungeonsBoss: 'Na posledn√≠m pat≈ôe ƒçek√° BOSS', dungeonsCleared: 'Vyƒçi≈°tƒõn√° patra z≈Øst√°vaj√≠ pr≈Øchoz√≠'
            };
            
            showModal('‚ùì N√°povƒõda k mapƒõ', `
                <div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    
                    <!-- Z√ÅKLADY -->
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--toxic-dark);">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--toxic-green);">üó∫Ô∏è ${mapHelpTexts.basics}</h3>
                        <p style="font-size: 0.85rem; color: #aaa; margin: 0;">
                            ‚Ä¢ <strong>${mapHelpTexts.basicsClick}</strong> ${mapHelpTexts.basicsClickFull}<br>
                            ‚Ä¢ üìç ${mapHelpTexts.basicsPos}<br>
                            ‚Ä¢ ${mapHelpTexts.basicsDistant}<br>
                            ‚Ä¢ ${mapHelpTexts.basicsDiscovered}
                        </p>
                    </div>
                    
                    <!-- Z√ìNY -->
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #333;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #ffd700;">üéØ ${mapHelpTexts.zones}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;"><span style="color: #4CAF50;">üü¢ ${mapHelpTexts.zoneSafe}</span> - ${mapHelpTexts.zoneSafeDesc}</div>
                            <div style="margin-bottom: 0.3rem;"><span style="color: #FF9800;">üü° ${mapHelpTexts.zoneMedium}</span> - ${mapHelpTexts.zoneMediumDesc}</div>
                            <div style="margin-bottom: 0.3rem;"><span style="color: #f44336;">üî¥ ${mapHelpTexts.zoneDanger}</span> - ${mapHelpTexts.zoneDangerDesc}</div>
                            <div><span style="color: #9C27B0;">üíÄ ${mapHelpTexts.zoneDeadly}</span> - ${mapHelpTexts.zoneDeadlyDesc}</div>
                        </div>
                    </div>
                    
                    <!-- TYPY LOKAC√ç -->
                    <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #554;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #ff9800;">üìç ${mapHelpTexts.locTypes}</h3>
                        <div style="font-size: 0.8rem; color: #aaa; display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                            <div>üè† <strong>${mapHelpTexts.shelter}</strong> - ${mapHelpTexts.shelterDesc}</div>
                            <div>üõí <strong>${mapHelpTexts.shop}</strong> - ${mapHelpTexts.shopDesc}</div>
                            <div>üîß <strong>${mapHelpTexts.workshop}</strong> - ${mapHelpTexts.workshopDesc}</div>
                            <div>üè• <strong>${mapHelpTexts.hospital}</strong> - ${mapHelpTexts.hospitalDesc}</div>
                            <div>üèõÔ∏è <strong>${mapHelpTexts.ruins}</strong> - ${mapHelpTexts.ruinsDesc}</div>
                            <div>‚õèÔ∏è <strong>${mapHelpTexts.mine}</strong> - ${mapHelpTexts.mineDesc}</div>
                            <div>üèòÔ∏è <strong>${mapHelpTexts.settlement}</strong> - ${mapHelpTexts.settlementDesc}</div>
                            <div>‚õ∫ <strong>${mapHelpTexts.camp}</strong> - ${mapHelpTexts.campDesc}</div>
                            <div>üèüÔ∏è <strong>${mapHelpTexts.arena}</strong> - ${mapHelpTexts.arenaDesc}</div>
                            <div>üíÄ <strong>${mapHelpTexts.dangerous}</strong> - ${mapHelpTexts.dangerousDesc}</div>
                        </div>
                    </div>
                    
                    <!-- AKCE -->
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #335;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #64b5f6;">‚ö° ${mapHelpTexts.actions}</h3>
                        <div style="font-size: 0.8rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;">üèπ <strong>${mapHelpTexts.hunt}</strong> - ${mapHelpTexts.huntDesc}</div>
                            <div style="margin-bottom: 0.3rem;">‚õèÔ∏è <strong>${mapHelpTexts.mining}</strong> - ${mapHelpTexts.miningDesc}</div>
                            <div style="margin-bottom: 0.3rem;">üé£ <strong>${mapHelpTexts.fishing}</strong> - ${mapHelpTexts.fishingDesc}</div>
                            <div style="margin-bottom: 0.3rem;">üîç <strong>${mapHelpTexts.search}</strong> - ${mapHelpTexts.searchDesc}</div>
                            <div style="margin-bottom: 0.3rem;">‚öîÔ∏è <strong>${mapHelpTexts.raid}</strong> - ${mapHelpTexts.raidDesc}</div>
                            <div style="margin-bottom: 0.3rem;">üß∫ <strong>${mapHelpTexts.gather}</strong> - ${mapHelpTexts.gatherDesc}</div>
                            <div style="margin-bottom: 0.3rem;">üè∞ <strong>${mapHelpTexts.enter}</strong> - ${mapHelpTexts.enterDesc}</div>
                            <div>üí§ <strong>${mapHelpTexts.rest}</strong> - ${mapHelpTexts.restDesc}</div>
                        </div>
                    </div>
                    
                    <!-- CESTOV√ÅN√ç -->
                    <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #533;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #f44336;">üö∂ ${mapHelpTexts.travel}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ${mapHelpTexts.travelCosts} <strong>${mapHelpTexts.travelCostsList}</strong></div>
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ${mapHelpTexts.travelRandom} <strong>${mapHelpTexts.travelRandomEvents}</strong></div>
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ‚ò¢Ô∏è <strong>${mapHelpTexts.travelRad}</strong> - ${mapHelpTexts.travelRadDesc}</div>
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ‚õàÔ∏è <strong>${mapHelpTexts.travelStorm}</strong> - ${mapHelpTexts.travelStormDesc}</div>
                            <div>‚Ä¢ ${mapHelpTexts.travelDanger}</div>
                        </div>
                    </div>
                    
                    <!-- NPC -->
                    <div style="background: #2a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #535;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #E91E63;">üë• ${mapHelpTexts.npcs}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ${mapHelpTexts.npcsHave} <strong>${mapHelpTexts.npcsFriendly}</strong></div>
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ üí¨ <strong>${mapHelpTexts.npcsTalk}</strong> ${mapHelpTexts.npcsTalkDesc}</div>
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ üéÅ <strong>${mapHelpTexts.npcsGifts}</strong> ${mapHelpTexts.npcsGiftsDesc}</div>
                            <div>‚Ä¢ üìú ${mapHelpTexts.npcsRewards} <strong>${mapHelpTexts.npcsRewardsDesc}</strong></div>
                        </div>
                    </div>
                    
                    <!-- DUNGEONY -->
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; border: 1px solid #6A1B9A;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #BA68C8;">üè∞ ${mapHelpTexts.dungeons}</h3>
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ${mapHelpTexts.dungeonsFloors} <strong>${mapHelpTexts.dungeonsFloorsDesc}</strong></div>
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ${mapHelpTexts.dungeonsEach}</div>
                            <div style="margin-bottom: 0.3rem;">‚Ä¢ ${mapHelpTexts.dungeonsBoss}</div>
                            <div>‚Ä¢ ${mapHelpTexts.dungeonsCleared}</div>
                        </div>
                    </div>
                    
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        // Pomocn√© funkce pro renderov√°n√≠
        // Funkce pro vykreslen√≠ akƒçn√≠ho tlaƒç√≠tka
        function renderActionButton(icon, name, action, color) {
            // Kontrola zda prob√≠h√° akce (blokuj ƒçasovƒõ n√°roƒçn√© akce)
            const timedActions = ['hunt', 'mine', 'fish', 'explore', 'gather', 'cook', 'sleep'];
            const isTimedAction = timedActions.some(a => action.includes(a));
            const actionInProgress = state.currentAction && state.currentAction.endTime > Date.now();
            
            if (isTimedAction && actionInProgress) {
                // ≈†ed√© tlaƒç√≠tko s ƒçasem a vysvƒõtlen√≠m
                const remaining = Math.ceil((state.currentAction.endTime - Date.now()) / 1000);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                const actionNames = { hunt: 'Lov', mine: 'Tƒõ≈æba', fish: 'Rybolov', explore: 'Pr≈Øzkum', gather: 'Sb√≠r√°n√≠', cook: 'Va≈ôen√≠', sleep: 'Sp√°nek' };
                const currentActionName = actionNames[state.currentAction.type] || 'Akce';
                return `<button class="btn" onclick="notifyWarning('Prob√≠h√° akce', '${currentActionName} pr√°vƒõ prob√≠h√°. Poƒçkej ${mins}:${String(secs).padStart(2, '0')} nebo ji zru≈°.')" style="background: #333; color: #666; font-size: 0.75rem; padding: 0.6rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 65px; border-radius: 8px; cursor: pointer; opacity: 0.6;"><span style="font-size: 1.4rem;">‚è≥</span><span>${mins}:${String(secs).padStart(2, '0')}</span></button>`;
            }
            
            return '<button class="btn" onclick="' + action + '" style="background: ' + color + '; font-size: 0.75rem; padding: 0.6rem 0.5rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 65px; border-radius: 8px; transition: transform 0.1s;" onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"><span style="font-size: 1.4rem;">' + icon + '</span><span>' + name + '</span></button>';
        }
        
        // === VYLEP≈†EN√â AKCE S MODALY ===
        // Kontrola denn√≠ho limitu akc√≠ (3x za 24 hodin na lokaci)
        function checkDailyActionLimit(actionType, locationId) {
            if (!state.world.actionLimits) state.world.actionLimits = {};
            const key = actionType + '_' + locationId;
            const now = Date.now();
            
            // Pokud neexistuje z√°znam, vytvo≈ô nov√Ω
            if (!state.world.actionLimits[key]) {
                state.world.actionLimits[key] = { count: 0, resetTime: now + 24 * 60 * 60 * 1000 };
            }
            
            const data = state.world.actionLimits[key];
            
            // Reset po 24 hodin√°ch
            if (now > data.resetTime) {
                data.count = 0;
                data.resetTime = now + 24 * 60 * 60 * 1000;
            }
            
            return { 
                canDo: data.count < 3, 
                remaining: 3 - data.count,
                resetIn: data.resetTime - now 
            };
        }
        
        // === FISHING SPOT SYST√âM ===
        // Umo≈æ≈àuje v√≠ce nez√°visl√Ωch ryb√°≈ôsk√Ωch m√≠st na jedn√© lokaci
        let currentFishingSpot = 0;
        
        function showFishingSpotsSelection(location) {
            const spots = location.spots || 1;
            
            let html = '<div style="text-align: center;">';
            html += '<p style="color: #aaa; margin-bottom: 1rem;">Vyber ryb√°≈ôsk√© m√≠sto:</p>';
            html += '<div style="display: grid; grid-template-columns: repeat(' + Math.min(spots, 3) + ', 1fr); gap: 0.5rem;">';
            
            for (let i = 0; i < spots; i++) {
                const spotKey = location.id + '_spot' + i;
                const limit = checkDailyActionLimit('fish', spotKey);
                
                if (limit.canDo) {
                    html += `
                        <div onclick="showFishingSpotModal(${i})" style="cursor: pointer; padding: 1rem; background: linear-gradient(135deg, #1565C0, #0D47A1); border-radius: 8px; border: 2px solid #2196F3;">
                            <div style="font-size: 2rem;">üé£</div>
                            <div style="font-weight: bold; color: #fff;">M√≠sto ${i + 1}</div>
                            <div style="color: #8bc34a; font-size: 0.8rem;">${limit.remaining}/3 zb√Ωv√°</div>
                        </div>`;
                } else {
                    const hours = Math.ceil(limit.resetIn / (1000 * 60 * 60));
                    html += `
                        <div style="padding: 1rem; background: #333; border-radius: 8px; border: 2px solid #555; opacity: 0.6;">
                            <div style="font-size: 2rem; filter: grayscale(1);">üé£</div>
                            <div style="font-weight: bold; color: #666;">M√≠sto ${i + 1}</div>
                            <div style="color: #ff6b6b; font-size: 0.8rem;">VYƒåERP√ÅNO (${hours}h)</div>
                        </div>`;
                }
            }
            
            html += '</div>';
            html += '<p style="color: #888; font-size: 0.8rem; margin-top: 1rem;">üí° Ka≈æd√© m√≠sto m√° vlastn√≠ limit 3 akc√≠/24h</p>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zru≈°it</button>';
            html += '</div>';
            
            showModal('üé£ Rybolov - ' + location.name, html);
        }
        
        function showFishingSpotModal(spotIndex) {
            currentFishingSpot = spotIndex;
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const spotKey = location.id + '_spot' + spotIndex;
            const limit = checkDailyActionLimit('fish', spotKey);
            
            if (!limit.canDo) {
                const hours = Math.ceil(limit.resetIn / (1000 * 60 * 60));
                notifyWarning('Vyƒçerp√°no', `M√≠sto ${spotIndex + 1} je vyƒçerpan√©. Reset za ${hours}h`);
                return;
            }
            
            // Kontrola vybaven√≠
            if (!state.inv.find(i => i.id === 'fishing_rod')) {
                showModal('‚ùå Chyb√≠ vybaven√≠', 'Pot≈ôebuje≈° üé£ Ryb√°≈ôsk√Ω prut pro rybolov!');
                return;
            }
            
            showModal('üé£ Rybolov - M√≠sto ' + (spotIndex + 1), `
                <div style="text-align: center;">
                    <p style="color: #aaa;">Ryb√°≈ôsk√© m√≠sto ${spotIndex + 1} z ${location.spots || 1}</p>
                    <p style="color: #8bc34a;">Zb√Ωv√° pokus≈Ø: ${limit.remaining}/3</p>
                    <div style="margin: 1rem 0; padding: 1rem; background: #1a1a1a; border-radius: 8px;">
                        <p>üêü Mo≈æn√© √∫lovky: Mal√° ryba, St≈ôedn√≠ ryba, Velk√° ryba</p>
                        <p style="font-size: 0.8rem; color: #888;">‚ú® Vz√°cnƒõ: Zlat√° rybka, Perla</p>
                    </div>
                    <button class="btn" onclick="startFishingAtSpot(${spotIndex})" style="width: 100%; background: #1565C0;">
                        üé£ Hodit udici
                    </button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                        Zru≈°it
                    </button>
                </div>
            `);
        }
        
        function startFishingAtSpot(spotIndex) {
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            const spotKey = location.id + '_spot' + spotIndex;
            
            // Kontrola limitu
            const limit = checkDailyActionLimit('fish', spotKey);
            if (!limit.canDo) {
                notifyWarning('Vyƒçerp√°no', 'Toto m√≠sto je vyƒçerpan√©!');
                closeModal();
                return;
            }
            
            // Pou≈æij limit pro tento konkr√©tn√≠ spot
            useActionLimit('fish', spotKey);
            
            // Spus≈• ryba≈ôen√≠ (pou≈æij existuj√≠c√≠ syst√©m)
            currentFishingSpot = spotIndex;
            closeModal();
            
            // Zahaj ryba≈ôen√≠ s vlastn√≠m callback
            startFishing();
        }
        
        function useActionLimit(actionType, locationId) {
            if (!state.world.actionLimits) state.world.actionLimits = {};
            const key = actionType + '_' + locationId;
            const now = Date.now();
            
            // Pokud neexistuje z√°znam, vytvo≈ô nov√Ω
            if (!state.world.actionLimits[key]) {
                state.world.actionLimits[key] = { count: 0, resetTime: now + 24 * 60 * 60 * 1000 };
            }
            
            state.world.actionLimits[key].count++;
        }
        
        function showActionModal(actionType) {
            const location = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // === FISH NA LOKAC√çCH SE SPOTY ===
            // Pokud je to ryba≈ôen√≠ a lokace m√° v√≠ce spot≈Ø, zobraz v√Ωbƒõr spot≈Ø
            if (actionType === 'fish' && location && location.spots && location.spots > 1) {
                showFishingSpotsSelection(location);
                return;
            }
            
            // Kontrola zda u≈æ neprob√≠h√° jin√° akce
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                const icons = { hunt: 'üèπ', mine: '‚õèÔ∏è', fish: 'üé£', explore: 'üîç', gather: 'üß∫', alchemy: '‚öóÔ∏è' };
                const names = { hunt: 'Lov', mine: 'Tƒõ≈æba', fish: 'Rybolov', explore: 'Pr≈Øzkum', gather: 'Sb√≠r√°n√≠', alchemy: 'Alchymie' };
                const currentType = state.currentAction.type;
                const remaining = Math.ceil((state.currentAction.endTime - Date.now()) / 1000);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                
                notifyWarning('Akce prob√≠h√°', `${icons[currentType]} ${names[currentType]} - zb√Ωv√° ${mins}:${String(secs).padStart(2, '0')}`);
                showActionProgressModal();
                return;
            }
            
            // Kontrola denn√≠ho limitu pro akce na lokaci
            const limitedActions = ['hunt', 'mine', 'fish', 'explore', 'gather'];
            if (limitedActions.includes(actionType)) {
                const limit = checkDailyActionLimit(actionType, location.id);
                if (!limit.canDo) {
                    const hours = Math.floor(limit.resetIn / 3600000);
                    const mins = Math.floor((limit.resetIn % 3600000) / 60000);
                    notifyWarning('Denn√≠ limit', `${actionType === 'hunt' ? 'Lov' : actionType === 'mine' ? 'Tƒõ≈æba' : actionType === 'fish' ? 'Rybolov' : actionType === 'gather' ? 'Sb√≠r√°n√≠' : 'Pr≈Øzkum'} zde u≈æ 3x vyu≈æit. Reset za ${hours}h ${mins}m`);
                    return;
                }
            }
            
            // V√Ωpoƒçet ƒçasov√©ho modifik√°toru podle skill≈Ø a poƒças√≠
            const timeModifier = calculateActionTimeModifier(actionType);
            const weather = getCurrentWeather();
            
            const actions = {
                hunt: {
                    icon: 'üèπ',
                    name: 'Lov',
                    desc: 'Vydej se na lov divok√© zvƒõ≈ôe v okol√≠.',
                    baseTime: 5, // 5 minut
                    rewards: ['üçñ Maso (j√≠dlo)', 'ü¶¥ K≈Ø≈æe (materi√°l)', 'üí∞ Pen√≠ze z prodeje'],
                    risks: ['‚öîÔ∏è Nebezpeƒçn√° zvƒõ≈ô m≈Ø≈æe za√∫toƒçit', '‚ö° Spot≈ôeba energie', '‚è±Ô∏è Zabere ƒças'],
                    requirements: ['üèπ Lep≈°√≠ zbra≈à = lep≈°√≠ √∫lovky', 'üëÅÔ∏è Vn√≠mavost pom√°h√°'],
                    tip: 'V les√≠ch a u vody je v√≠ce zvƒõ≈ôe. Nebezpeƒçn√© z√≥ny maj√≠ silnƒõj≈°√≠ (ale cennƒõj≈°√≠) tvory.',
                    action: "startTimedAction('hunt')",
                    btnText: 'üèπ Vydat se na lov',
                    btnColor: '#2E7D32'
                },
                mine: {
                    icon: '‚õèÔ∏è',
                    name: 'Tƒõ≈æba',
                    desc: 'Hledej suroviny v zemi a trosk√°ch.',
                    baseTime: 4, // 4 minuty
                    rewards: ['üóø K√°men', '‚öôÔ∏è Kov', 'üíé Vz√°cn√© rudy (nƒõkdy)'],
                    risks: ['üí™ Vy≈æaduje s√≠lu', '‚ö° Spot≈ôeba energie', '‚ò¢Ô∏è V nƒõkter√Ωch z√≥n√°ch radiace'],
                    requirements: ['‚õèÔ∏è Krump√°ƒç pom√°h√°', 'üí™ S√≠la = v√≠ce surovin'],
                    tip: 'Hory a jeskynƒõ maj√≠ nejlep≈°√≠ v√Ωtƒõ≈ænost. V nebezpeƒçn√Ωch z√≥n√°ch m≈Ø≈æe≈° naj√≠t vz√°cn√© kovy.',
                    action: "startTimedAction('mine')",
                    btnText: '‚õèÔ∏è Zaƒç√≠t tƒõ≈æit',
                    btnColor: '#5D4037'
                },
                fish: {
                    icon: 'üé£',
                    name: 'Rybolov',
                    desc: 'Chytej ryby v bl√≠zk√©m vodn√≠m zdroji.',
                    baseTime: 6, // 6 minut
                    rewards: ['üêü Ryby (j√≠dlo)', '‚ú® Vz√°cn√© √∫lovky', 'üì¶ Obƒças nƒõco zvl√°≈°tn√≠ho'],
                    risks: ['‚è±Ô∏è Vy≈æaduje trpƒõlivost', 'üåßÔ∏è Poƒças√≠ ovliv≈àuje √∫lovky'],
                    requirements: ['üé£ Prut pom√°h√°', 'üçÄ ≈†tƒõst√≠ = lep≈°√≠ √∫lovky'],
                    tip: 'Jezero m√° nejvƒõt≈°√≠ ryby. Zlat√° rybka je velmi vz√°cn√° - pr√Ω spln√≠ p≈ô√°n√≠!',
                    action: "startTimedAction('fish')",
                    btnText: 'üé£ Hodit udici',
                    btnColor: '#1565C0'
                },
                cook: {
                    icon: 'üç≥',
                    name: 'Va≈ôen√≠',
                    desc: 'P≈ôiprav j√≠dlo z dostupn√Ωch surovin.',
                    baseTime: 2, // 2 minuty
                    rewards: ['üçñ Lep≈°√≠ j√≠dlo', '‚ö° Bonus energie', '‚ù§Ô∏è Nƒõkdy i l√©ƒçen√≠'],
                    risks: ['üî• Pot≈ôebuje≈° ohe≈à/kuchy≈à', 'üì¶ Spot≈ôeba surovin'],
                    requirements: ['üçñ Maso, ryby, byliny', 'üî• Ohe≈à nebo kuchy≈à'],
                    tip: 'Va≈ôen√© j√≠dlo d√°v√° v√≠c energie ne≈æ syrov√©. Nƒõkter√© recepty d√°vaj√≠ speci√°ln√≠ bonusy.',
                    action: 'openCookingMenu()',
                    btnText: 'üç≥ Otev≈ô√≠t va≈ôen√≠',
                    btnColor: '#E65100'
                },
                alchemy: {
                    icon: '‚öóÔ∏è',
                    name: 'Alchymie',
                    desc: 'M√≠chej lektvary a l√©ky z bylin.',
                    baseTime: 7, // 7 minut
                    rewards: ['‚ù§Ô∏è L√©ƒçiv√© lektvary', '‚ò¢Ô∏è Anti-radiaƒçn√≠ l√©ky', 'üí™ Doƒçasn√© bonusy'],
                    risks: ['üåø Spot≈ôeba bylin', '‚öóÔ∏è Pot≈ôeba alchym. sady'],
                    requirements: ['‚öóÔ∏è Alchymistick√° sada', 'üåø Byliny', 'üß™ Chemik√°lie'],
                    tip: 'ƒå√≠m v√≠ce bylin a chemik√°li√≠ m√°≈°, t√≠m lep≈°√≠ lektvary vyrob√≠≈°!',
                    action: "startTimedAction('alchemy')",
                    btnText: '‚öóÔ∏è Zaƒç√≠t m√≠chat',
                    btnColor: '#6A1B9A'
                },
                explore: {
                    icon: 'üîç',
                    name: 'Pr≈Øzkum',
                    desc: 'Prohledej lokaci a najdi skryt√© vƒõci.',
                    baseTime: 5, // 5 minut
                    rewards: ['üì¶ Loot a p≈ôedmƒõty', 'üí∞ Pen√≠ze', 'üóùÔ∏è Kl√≠ƒçe a vz√°cnosti'],
                    risks: ['‚öîÔ∏è M≈Ø≈æe≈° narazit na nep≈ô√°tele', '‚è±Ô∏è Zabere ƒças'],
                    requirements: ['üëÅÔ∏è Vn√≠mavost = v√≠ce lootu', 'üçÄ ≈†tƒõst√≠ pom√°h√°'],
                    tip: 'Ka≈æd√° lokace m√° omezenou z√°sobu lootu. Nƒõkter√© maj√≠ skryt√© m√≠stnosti!',
                    action: "startTimedAction('explore')",
                    btnText: 'üîç Prohledat',
                    btnColor: 'var(--rust)'
                },
                gather: {
                    icon: 'üß∫',
                    name: 'Sb√≠r√°n√≠',
                    desc: 'Sb√≠rej suroviny v okol√≠.',
                    baseTime: 3, // 3 minuty
                    rewards: ['ü™® K√°men', 'üå≤ D≈ôevo', 'üåø Byliny', 'üíé Vz√°cn√© materi√°ly'],
                    risks: ['‚ö° Spot≈ôeba energie', '‚è±Ô∏è Zabere ƒças'],
                    requirements: ['üëÅÔ∏è Vn√≠mavost pom√°h√°', 'üí™ S√≠la pro tƒõ≈æ≈°√≠ pr√°ci'],
                    tip: 'Skalnat√© oblasti d√°vaj√≠ k√°men a rudy, lesy d≈ôevo a byliny. Vz√°cn√© materi√°ly jsou bonus!',
                    action: "startTimedAction('gather')",
                    btnText: 'üß∫ Zaƒç√≠t sb√≠rat',
                    btnColor: '#4CAF50'
                },
                sleep: {
                    icon: 'üõèÔ∏è',
                    name: 'Sp√°nek',
                    desc: 'Odpoƒçi≈à si a regeneruj energii v √∫krytu.',
                    baseTime: 0,
                    rewards: ['‚ö° Pln√° energie (100%)', '‚ù§Ô∏è Regenerace HP (+50%)', '‚ö° Okam≈æit√Ω efekt'],
                    risks: ['üö´ ≈Ω√°dn√° rizika v √∫krytu'],
                    requirements: ['üè† B√Ωt v √∫krytu'],
                    tip: 'Sp√°nek v √∫krytu je okam≈æit√Ω a bez vedlej≈°√≠ch efekt≈Ø. Spac√°k venku trv√° 1 hodinu.',
                    action: "startSleep()",
                    btnText: 'üõèÔ∏è J√≠t sp√°t',
                    btnColor: '#3949AB'
                },
            };
            
            const a = actions[actionType];
            if (!a) return;
            
            // Vypoƒç√≠tej skuteƒçn√Ω ƒças akce
            let actualTime = a.baseTime || 0;
            if (actualTime > 0) {
                actualTime = Math.max(1, Math.round(actualTime * timeModifier));
            }
            
            let html = '<div style="text-align: left;">';
            html += '<p style="color: #aaa; margin-bottom: 1rem;">' + a.desc + '</p>';
            
            // Zobraz ƒças akce
            if (actualTime > 0) {
                let timeColor = '#8bc34a';
                let timeNote = '';
                if (timeModifier > 1.2) {
                    timeColor = '#ff9800';
                    timeNote = ' (zpomaleno)';
                } else if (timeModifier < 0.8) {
                    timeColor = '#4caf50';
                    timeNote = ' (zrychleno)';
                }
                
                html += '<div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">';
                html += '<span>‚è±Ô∏è ' + ('Doba trv√°n√≠:') + '</span>';
                html += '<span style="color: ' + timeColor + '; font-weight: bold;">' + actualTime + ' min' + timeNote + '</span>';
                html += '</div>';
                
                // Poƒças√≠ info
                if (weather && weather.id !== 'clear') {
                    let weatherEffect = '';
                    if (weather.id === 'rain') weatherEffect = 'D√©≈°≈• zpomaluje akce';
                    else if (weather.id === 'fog') weatherEffect = 'Mlha ztƒõ≈æuje pr≈Øzkum';
                    else if (weather.id === 'radstorm') weatherEffect = '‚ò¢Ô∏è Radiaƒçn√≠ bou≈ôe!';
                    else if (weather.id === 'storm') weatherEffect = 'Bou≈ôka zpomaluje v≈°e';
                    
                    if (weatherEffect) {
                        html += '<div style="background: #2a2a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem;">';
                        html += '<span style="color: #ff9800;">' + weather.icon + ' ' + weatherEffect + '</span>';
                        html += '</div>';
                    }
                }
            }
            
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">';
            
            html += '<div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d4a2d;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">‚úÖ ' + ('Odmƒõny') + '</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            a.rewards.forEach(r => html += '<li>' + r + '</li>');
            html += '</ul></div>';
            
            html += '<div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #4a2d2d;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #c62828; font-size: 0.9rem;">‚ö†Ô∏è ' + ('Rizika') + '</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            a.risks.forEach(r => html += '<li>' + r + '</li>');
            html += '</ul></div>';
            
            html += '</div>';
            
            html += '<div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a; margin-bottom: 1rem;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.9rem;">üìã ' + ('Po≈æadavky') + '</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            a.requirements.forEach(r => html += '<li>' + r + '</li>');
            html += '</ul></div>';
            
            html += '<div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #4a4a2d; margin-bottom: 1rem;">';
            html += '<p style="margin: 0; font-size: 0.85rem;"><span style="color: #ffd700;">üí° Tip:</span> <span style="color: #aaa;">' + a.tip + '</span></p>';
            html += '</div>';
            
            // Zobraz zb√Ωvaj√≠c√≠ pokusy pro limitovan√© akce (limitedActions definovan√© na zaƒç√°tku funkce)
            if (limitedActions.includes(actionType)) {
                const limit = checkDailyActionLimit(actionType, location.id);
                html += '<div style="text-align: center; margin-bottom: 0.5rem; font-size: 0.85rem; color: ' + (limit.remaining > 1 ? '#8bc34a' : '#ff9800') + ';">';
                html += 'üìä Zb√Ωv√°: ' + limit.remaining + '/3 dnes na t√©to lokaci';
                html += '</div>';
            }
            
            html += '<div style="display: flex; gap: 0.5rem;">';
            html += '<button class="btn" onclick="closeModal()" style="flex: 1; background: #333;">‚ùå Zav≈ô√≠t</button>';
            html += '<button class="btn" onclick="closeModal(); setTimeout(() => { ' + a.action + ' }, 50);" style="flex: 2; background: ' + a.btnColor + ';">' + a.btnText + '</button>';
            html += '</div>';
            html += '</div>';
            
            showModal(a.icon + ' ' + a.name, html);
        }
        
        // NPC na aktu√°ln√≠ lokaci
        function renderLocationNPCs(location) {
            let html = '';
            const npcsHere = [];
            
            // Kontrola NPC podle lokace
            if (typeof STORY_NPCS !== 'undefined') {
                for (const [npcId, npc] of Object.entries(STORY_NPCS)) {
                    // NPC je na t√©to lokaci?
                    if (npc.location === location.id) {
                        // V≈Ødce p≈ôe≈æiv≈°√≠ch jen po dokonƒçen√≠ p≈ô√≠bƒõhu
                        if (npcId === 'survivor_leader' && !state.mainQuest?.storyComplete) continue;
                        
                        // Gener√°l jen pokud m√°me spr√°vn√Ω quest
                        if (npcId === 'general' && state.mainQuest?.currentQuest !== 'find_general') continue;
                        
                        npcsHere.push({ id: npcId, ...npc });
                    }
                }
            }
            
            if (npcsHere.length > 0) {
                html += '<div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid var(--metal-light);">';
                html += '<h4 style="margin: 0 0 0.5rem 0; color: #9C27B0;">üë• Postavy</h4>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                npcsHere.forEach(npc => {
                    html += '<button class="btn" onclick="talkToNPC(\'' + npc.id + '\')" style="background: #6A1B9A; padding: 0.5rem 1rem;">' + npc.icon + ' ' + npc.name + '</button>';
                });
                html += '</div></div>';
            }
            
            return html;
        }
        
        // Bonus hrdiny
        function renderHeroBonus() {
            const cls = CLASSES[state.char.classId];
            if (!cls) return '';
            
            let html = '<div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid var(--metal-light);">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: var(--warning-yellow);">‚≠ê ' + cls.name + '</h4>';
            html += '<p style="margin: 0; font-size: 0.8rem; color: #888;">' + (cls.passive || cls.desc || '') + '</p>';
            
            // Speci√°ln√≠ schopnost cooldown
            const now = Date.now();
            const lastUsed = state.char.abilityLastUsed || 0;
            const cooldown = 300000; // 5 minut
            const remaining = Math.max(0, cooldown - (now - lastUsed));
            
            if (remaining > 0) {
                html += '<p style="margin: 0.3rem 0 0 0; font-size: 0.75rem; color: #666;">Schopnost: ' + Math.ceil(remaining / 1000) + 's</p>';
            } else {
                html += '<button class="btn" onclick="useClassAbility()" style="margin-top: 0.5rem; background: var(--warning-yellow); color: #000; font-size: 0.75rem;">‚ö° ' + (cls.ability || 'Schopnost') + '</button>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Rychl√Ω p≈ôesun z mapy na lokaci
        // === N√ÅHLED LOKACE ===
        function showLocationPreview(locId) {
            const loc = WORLD_LOCATIONS.find(l => l.id === locId);
            if (!loc) return;
            
            // Pokud lokace nen√≠ zn√°m√°, zobraz jen z√°kladn√≠ info s mo≈ænost√≠ cestovat
            const isVisited = state.world.visitedLocations?.includes(loc.id);
            const isRevealed = state.world.revealedLocations?.includes(loc.id);
            const isKnown = isVisited || isRevealed;
            
            // Zjisti jestli je lokace dostupn√° (m√° p≈ô√≠mou cestu)
            const hasPath = WORLD_PATHS.some(p => 
                (p.from === state.world.currentLocation && p.to === loc.id) || 
                (p.to === state.world.currentLocation && p.from === loc.id)
            );
            
            // Pro nezn√°m√© lokace bez p≈ô√≠m√© cesty - jen koordin√°ty
            if (!isKnown && !hasPath) {
                showCoordsInfo(loc.x, loc.y, '??? Nezn√°m√° lokace');
                return;
            }
            
            // Pro nezn√°m√© ale dostupn√© lokace - pou≈æij quickTravel (m√° vlastn√≠ modal)
            if (!isKnown && hasPath) {
                quickTravel(locId);
                return;
            }
            
            // Zjisti co lze na lokaci dƒõlat
            let activities = [];
            
            // Z√°kladn√≠ akce podle typu
            if (loc.type === 'explore' || loc.type === 'dangerous') {
                activities.push({ icon: 'üîç', name: 'Pr≈Øzkum', desc: 'Hledej p≈ôedmƒõty a suroviny' });
            }
            if (loc.type === 'water' || loc.id?.includes('lake') || loc.id?.includes('river') || loc.id?.includes('pond') || loc.actions?.includes('fish')) {
                activities.push({ icon: 'üé£', name: 'Ryba≈ôen√≠', desc: 'Chytej ryby' });
            }
            if (loc.type === 'water' || loc.id?.includes('lake') || loc.id?.includes('river') || loc.resource === 'water') {
                activities.push({ icon: 'üíß', name: 'Sbƒõr vody', desc: 'Napl≈à l√°hve vodou' });
            }
            if (loc.type === 'forest' || loc.id?.includes('forest') || loc.id?.includes('grove')) {
                activities.push({ icon: 'ü™ì', name: 'Tƒõ≈æba d≈ôeva', desc: 'Sb√≠rej d≈ôevo' });
                activities.push({ icon: 'üèπ', name: 'Lov', desc: 'Lov zvƒõ≈ôe' });
                activities.push({ icon: 'üåø', name: 'Sbƒõr bylin', desc: 'Sb√≠rej l√©ƒçiv√© rostliny' });
            }
            if (loc.type === 'mine' || loc.id?.includes('mine') || loc.id?.includes('quarry')) {
                activities.push({ icon: '‚õèÔ∏è', name: 'Tƒõ≈æba', desc: 'Tƒõ≈æ k√°men a rudu' });
            }
            if (loc.type === 'dungeon') {
                activities.push({ icon: 'üè∞', name: 'Dungeon', desc: 'Prozkoumej podzem√≠ (mus√≠≈° b√Ωt na m√≠stƒõ)' });
            }
            if (loc.type === 'npc' || loc.type === 'trader' || loc.type === 'faction') {
                activities.push({ icon: 'üó£Ô∏è', name: 'NPC', desc: 'Mluv s postavami' });
                activities.push({ icon: 'üõí', name: 'Obchod', desc: 'Nakupuj a prod√°vej' });
            }
            if (loc.type === 'medical' || loc.id?.includes('hospital')) {
                activities.push({ icon: 'üíä', name: 'L√©k√°rna', desc: 'Najdi l√©ky a obvazy' });
            }
            if (loc.type === 'gas_station' || loc.id?.includes('gas')) {
                activities.push({ icon: '‚õΩ', name: 'Palivo', desc: 'Seber palivo' });
            }
            if (loc.type === 'hostile') {
                activities.push({ icon: '‚öîÔ∏è', name: 'Boj', desc: 'Bojuj s nep≈ô√°teli' });
                activities.push({ icon: 'üí∞', name: 'Loot', desc: 'Z√≠skej ko≈ôist' });
            }
            
            // Speci√°ln√≠ suroviny
            if (loc.zone === 'danger' || loc.zone === 'deadly') {
                activities.push({ icon: '‚ò£Ô∏è', name: 'Vz√°cn√© suroviny', desc: 'Elektronika, chemie, palivo' });
            }
            
            // Nep≈ô√°tel√©
            let enemiesHtml = '';
            if (loc.enemies && loc.enemies.length > 0) {
                const enemyList = loc.enemies.slice(0, 4).map(eId => {
                    const e = ENEMIES.find(en => en.id === eId);
                    return e ? e.icon : '?';
                }).join(' ');
                enemiesHtml = `
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #8B0000;">
                        <span style="color: #f44336;">‚öîÔ∏è Nep≈ô√°tel√©:</span> ${enemyList}
                    </div>
                `;
            }
            
            // Z√≥na
            const zoneInfo = {
                'safe': { color: '#4CAF50', name: 'üü¢ Bezpeƒçn√° z√≥na' },
                'medium': { color: '#FF9800', name: 'üü° St≈ôedn√≠ riziko' },
                'danger': { color: '#f44336', name: 'üî¥ Nebezpeƒçn√° z√≥na' },
                'deadly': { color: '#9C27B0', name: 'üíÄ Smrteln√° z√≥na' }
            };
            const zone = zoneInfo[loc.zone] || zoneInfo['medium'];
            
            // Najdi cestu a vzd√°lenost
            const path = WORLD_PATHS.find(p => 
                (p.from === state.world.currentLocation && p.to === locId) || 
                (p.to === state.world.currentLocation && p.from === locId)
            );
            
            // Svƒõtov√° strana
            const directionInfo = getDirectionToLocation(locId);
            
            let distance = '?';
            let travelTime = '?';
            
            if (path) {
                distance = path.distance + ' km';
                travelTime = path.time;
                
                // Aplikuj poƒças√≠
                const weather = getCurrentWeather();
                const weatherMod = weather?.effect?.speedMod || 1.0;
                if (weatherMod !== 1.0) {
                    travelTime = Math.ceil(travelTime / weatherMod);
                }
                
                travelTime = travelTime + ' min';
            } else {
                // Nen√≠ p≈ô√≠m√° cesta - spoƒç√≠tej Manhattan distance jako odhad
                const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
                if (currentLoc) {
                    const manhattanDist = Math.abs(loc.x - currentLoc.x) + Math.abs(loc.y - currentLoc.y);
                    distance = 'cca ' + manhattanDist + ' pol√≠';
                    travelTime = ''; // Nezobrazovat - uk√°≈æe se v travel modalu
                }
            }
            
            showModal(`${loc.icon} ${loc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${loc.icon}</div>
                    <div style="background: #0a0a0a; padding: 0.3rem 0.8rem; border-radius: 6px; display: inline-block; margin: 0.3rem 0; border: 1px solid #333;">
                        <span style="color: #8bc34a; font-family: monospace; font-size: 0.9rem;">üìç [${loc.x}, ${loc.y}]</span>
                    </div>
                    <div style="color: ${zone.color}; font-size: 0.8rem; margin-top: 0.3rem;">${zone.name}</div>
                    <div style="color: #888; font-size: 0.8rem; margin-top: 0.2rem;">${directionInfo.arrow} ${directionInfo.distance} pol√≠</div>
                    <p style="color: #888; font-size: 0.85rem; margin: 0.5rem 0;">${loc.desc || ''}</p>
                    ${loc.radiation ? `<div style="color: #ff9800;">‚ò¢Ô∏è Radiace: ${loc.radiation}/min</div>` : ''}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">üìã Aktivity:</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem;">
                        ${activities.length > 0 ? activities.map(a => `
                            <div style="background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center;">
                                <div style="font-size: 1.2rem;">${a.icon}</div>
                                <div style="font-size: 0.7rem; color: #aaa;">${a.name}</div>
                            </div>
                        `).join('') : '<div style="color: #555; grid-column: span 2; text-align: center;">≈Ω√°dn√© speci√°ln√≠ aktivity</div>'}
                    </div>
                    ${enemiesHtml}
                </div>
                
                <div style="display: flex; justify-content: space-between; color: #888; font-size: 0.8rem; margin-bottom: 1rem;">
                    <span>üìç Vzd√°lenost: ${distance}</span>
                    ${travelTime ? `<span>‚è±Ô∏è Cesta: ${travelTime}</span>` : ''}
                </div>
                
                ${loc.type === 'dungeon' ? `
                    <div style="background: #2a1a3a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.8rem; border: 1px solid #6A1B9A;">
                        <p style="color: #ce93d8; font-size: 0.85rem; margin: 0; text-align: center;">
                            üè∞ <strong>Dungeon</strong> - nejd≈ô√≠v sem doputuj, pak m≈Ø≈æe≈° vstoupit!
                        </p>
                    </div>
                ` : ''}
                
                ${hasPath ? `
                    <button class="btn" onclick="closeModal(); quickTravel('${loc.id}')" style="width: 100%; background: var(--toxic-dark);">
                        üö∂ ${t('ui', 'travel')}
                    </button>
                ` : `
                    <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.8rem; border: 1px solid #ff9800;">
                        <p style="color: #ff9800; font-size: 0.85rem; margin: 0; text-align: center;">
                            ‚ö†Ô∏è Nen√≠ p≈ô√≠m√° cesta - mus√≠≈° j√≠t p≈ôes bli≈æ≈°√≠ lokace
                        </p>
                    </div>
                `}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    ‚úó ${t('ui', 'close')}
                </button>
            `);
        }
        
        // === ZOBRAZEN√ç SOU≈òADNIC PRO MOBIL ===
        // P≈ôi kliknut√≠ na pole zobraz√≠ jeho sou≈ôadnice
        function showCoordsInfo(x, y, name = '???') {
            const currentLoc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            let distanceInfo = '';
            let navigationButton = '';
            
            if (currentLoc) {
                const dx = x - currentLoc.x;
                const dy = y - currentLoc.y;
                const manhattanDist = Math.abs(dx) + Math.abs(dy);
                
                // Smƒõr
                let direction = '';
                if (dy < 0) direction += 'S';
                if (dy > 0) direction += 'J';
                if (dx > 0) direction += 'V';
                if (dx < 0) direction += 'Z';
                
                distanceInfo = `
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="color: #888; font-size: 0.75rem;">Vzd√°lenost</div>
                                <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${manhattanDist} pol√≠</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.75rem;">Smƒõr</div>
                                <div style="color: #4FC3F7; font-size: 1.2rem; font-weight: bold;">${direction || 'üìç'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Najdi nejbli≈æ≈°√≠ dostupnou lokaci smƒõrem k c√≠li
                const availablePaths = WORLD_PATHS.filter(p => 
                    p.from === state.world.currentLocation || p.to === state.world.currentLocation
                );
                
                let bestNext = null;
                let bestScore = Infinity;
                
                availablePaths.forEach(path => {
                    const nextLocId = path.from === state.world.currentLocation ? path.to : path.from;
                    const nextLoc = WORLD_LOCATIONS.find(l => l.id === nextLocId);
                    if (nextLoc) {
                        // Vzd√°lenost od dal≈°√≠ lokace k c√≠li
                        const distToTarget = Math.abs(nextLoc.x - x) + Math.abs(nextLoc.y - y);
                        if (distToTarget < bestScore) {
                            bestScore = distToTarget;
                            bestNext = nextLoc;
                        }
                    }
                });
                
                if (bestNext && bestScore < manhattanDist) {
                    const isKnown = state.world.visitedLocations?.includes(bestNext.id) || 
                                   state.world.revealedLocations?.includes(bestNext.id);
                    navigationButton = `
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem; border: 1px solid #4caf50;">
                            <p style="color: #8bc34a; font-size: 0.85rem; margin: 0 0 0.5rem 0;">
                                üß≠ Nejbli≈æ≈°√≠ cesta t√≠mto smƒõrem:
                            </p>
                            <button class="btn" onclick="closeModal(); quickTravel('${bestNext.id}')" style="width: 100%; background: var(--toxic-dark);">
                                ${isKnown ? bestNext.icon : '‚ùì'} ${isKnown ? bestNext.name : 'Nezn√°m√° lokace'} [${bestNext.x}, ${bestNext.y}]
                            </button>
                        </div>
                    `;
                }
            }
            
            showModal('üìç Sou≈ôadnice', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üó∫Ô∏è</div>
                    <div style="background: #0d1a0d; padding: 1rem; border-radius: 10px; border: 2px solid #4CAF50; margin: 1rem 0;">
                        <div style="color: #8bc34a; font-family: monospace; font-size: 2rem; font-weight: bold;">
                            [${x}, ${y}]
                        </div>
                    </div>
                    <p style="color: #888; font-size: 0.9rem;">${name}</p>
                    ${distanceInfo}
                    ${navigationButton}
                    <p style="color: #555; font-size: 0.75rem; margin-top: 1rem;">
                        üí° X = v√Ωchod/z√°pad, Y = sever/jih<br>
                        Z√°porn√© Y = sever, Kladn√© Y = jih
                    </p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚úì OK</button>
            `);
        }
        
        function quickTravel(targetId) {
            if (state.world.traveling) {
                notifyWarning('Nelze', 'U≈æ cestuje≈°!');
                return;
            }
            if (targetId === state.world.currentLocation) return;
            
            const target = WORLD_LOCATIONS.find(l => l.id === targetId);
            const current = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!target || !current) return;
            
            const isVisited = state.world.visitedLocations.includes(targetId);
            
            // Najdi cestu (p≈ô√≠mou)
            const path = WORLD_PATHS.find(p => 
                (p.from === state.world.currentLocation && p.to === targetId) || 
                (p.to === state.world.currentLocation && p.from === targetId)
            );
            
            if (path) {
                const dangerColor = ['#4CAF50', '#8BC34A', '#FF9800', '#f44336', '#9C27B0'][path.danger] || '#888';
                
                // Z√≠skej poƒças√≠
                const weather = getCurrentWeather();
                let weatherMod = weather?.effect?.speedMod || 1.0;
                
                // P≈ôepoƒçti ƒças s vozidlem a poƒças√≠m
                let travelTime = path.time;
                let vehicleInfo = '';
                let weatherInfo = '';
                let npcBonusInfo = '';
                
                // NPC bonusy jsou n√≠≈æe v sekci "POSEL JIN BONUSY"
                let travelBonus = 1.0;
                
                // Nom√°d class bonus - 50% rychlej≈°√≠ cestov√°n√≠
                let nomadBonusInfo = '';
                if (hasClassPassive('travelSpeedBonus')) {
                    const nomadSpeedBonus = getClassPassiveValue('travelSpeedBonus') || 0;
                    travelBonus -= nomadSpeedBonus; // -50%
                    nomadBonusInfo = `<p style="color: #8d6e63;">üèúÔ∏è Nom√°d: -${Math.round(nomadSpeedBonus * 100)}% ƒças</p>`;
                }
                
                // === SKILLS BONUSY ===
                let skillsBonusInfo = '';
                
                // Debug log pro skills
                console.log('üö∂ Travel skills:', {
                    agi: state.char.attrs?.agi,
                    pathfinder: state.skillTree?.exploration?.pathfinder || state.skills?.['pathfinder'],
                    fast_travel: state.skillTree?.exploration?.fast_travel || state.skills?.['fast_travel'],
                    skillTree: state.skillTree,
                    oldSkills: state.skills
                });
                
                // Zobraz sekci bonus≈Ø v≈ædy, i kdy≈æ jsou pr√°zdn√©
                let hasSomeBonus = false;
                
                // AGILITY BONUS - ka≈æd√Ω bod AGI nad 5 = -2% ƒças cestov√°n√≠
                const agiBonus = Math.max(0, (state.char.attrs?.agi || 5) - 5) * 0.02;
                if (agiBonus > 0) {
                    travelBonus -= agiBonus;
                    skillsBonusInfo += `<p style="color: #64b5f6;">üèÉ Obratnost (${state.char.attrs?.agi || 5}): -${Math.round(agiBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // pathfinder skill - Pr≈Øzkumn√≠k (-3% per level) - je ve SKILL_TREE vƒõtvi EXPLORATION
                const pathfinderLevel = state.skillTree?.exploration?.pathfinder || state.skills?.['pathfinder'] || 0;
                if (pathfinderLevel > 0) {
                    const pathfinderBonus = pathfinderLevel * 0.03;
                    travelBonus -= pathfinderBonus;
                    skillsBonusInfo += `<p style="color: #64b5f6;">üë£ Pr≈Øzkumn√≠k (${pathfinderLevel}): -${Math.round(pathfinderBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // fast_travel skill - Rychl√Ω pochod (-5% per level) - pokud existuje
                const fastTravelLevel = state.skillTree?.exploration?.fast_travel || state.skillTree?.survival?.fast_travel || state.skills?.['fast_travel'] || 0;
                if (fastTravelLevel > 0) {
                    const fastTravelBonus = fastTravelLevel * 0.05;
                    travelBonus -= fastTravelBonus;
                    skillsBonusInfo += `<p style="color: #64b5f6;">üèÉ Rychl√Ω pochod (${fastTravelLevel}): -${Math.round(fastTravelBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // Kompas bonus
                const hasCompass = state.inv?.some(i => i.id === 'compass' || i.bonus === 'navigation');
                if (hasCompass) {
                    travelBonus -= 0.015;
                    skillsBonusInfo += `<p style="color: #ffb74d;">üß≠ Kompas: -1.5%</p>`;
                    hasSomeBonus = true;
                }
                
                // Companion skills bonus (Stopa≈ô/pathfinder atd.)
                const companionTravelBonus = getCompanionTravelSpeedBonus();
                if (companionTravelBonus > 0) {
                    travelBonus -= companionTravelBonus;
                    skillsBonusInfo += `<p style="color: #81c784;">üêæ Spoleƒçn√≠k: -${Math.round(companionTravelBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // Boots speed bonus (Turistick√© boty +10%, Exo boty +20%)
                const armorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : { speedBonus: 0 };
                if (armorEffects.speedBonus > 0) {
                    travelBonus -= armorEffects.speedBonus;
                    const bootsName = state.equipped?.boots?.name || 'Boty';
                    skillsBonusInfo += `<p style="color: #2196f3;">üë¢ ${bootsName}: -${Math.round(armorEffects.speedBonus * 100)}%</p>`;
                    hasSomeBonus = true;
                } else if (state.equipped?.boots && state.equipped.boots.special) {
                    // Zobraz boty i kdy≈æ nemaj√≠ speed bonus (ale maj√≠ jin√Ω efekt)
                    const bootsSpecialNames = {
                        'dodge_bonus': 'üí® +10% √∫hyb',
                        'stealth_move': 'ü•∑ -20% p≈ôepaden√≠',
                        'run_bonus': 'üèÉ +15% √∫tƒõk',
                        'stomp': 'ü¶∂ +8 damage',
                        'jump': 'ü¶ò +25% dodge',
                        'warm_feet': '‚ùÑÔ∏è -15% energie',
                        'combat_stance': '‚öîÔ∏è +5% krit',
                        'sturdy': 'üîß +2 DEF',
                        'exo': 'ü¶æ +50% nosnost'
                    };
                    const effectName = bootsSpecialNames[state.equipped.boots.special] || state.equipped.boots.special;
                    skillsBonusInfo += `<p style="color: #9e9e9e;">üë¢ ${state.equipped.boots.name}: ${effectName} <span style="font-size: 0.8rem;">(ne rychlost)</span></p>`;
                }
                
                // Mutace bonusy pro cestov√°n√≠
                const mutBonuses = getMutationBonuses();
                if (mutBonuses.travelSpeed > 0) {
                    travelBonus -= mutBonuses.travelSpeed;
                    skillsBonusInfo += `<p style="color: #9c27b0;">‚ö° Rychl√Ω metabolismus: -${Math.round(mutBonuses.travelSpeed * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                if (mutBonuses.speed < 0) {
                    travelBonus -= mutBonuses.speed; // speed je z√°porn√Ω, tak≈æe -= -0.2 = +0.2
                    skillsBonusInfo += `<p style="color: #f44336;">ü¶¥ ≈Ωelezn√© kosti: +${Math.round(Math.abs(mutBonuses.speed) * 100)}%</p>`;
                    hasSomeBonus = true;
                }
                
                // === POSEL JIN BONUSY ===
                // Rychl√© cesty (trust 50+) = -5%
                if (state.secrets?.includes('jin_fast_routes')) {
                    travelBonus -= 0.05;
                    skillsBonusInfo += `<p style="color: #00bcd4;">üèÉ Rychl√© cesty (Jin): -5%</p>`;
                    hasSomeBonus = true;
                }
                // Tajn√© zkratky (trust 100) = -10%
                if (state.secrets?.includes('jin_secret_shortcuts')) {
                    travelBonus -= 0.10;
                    skillsBonusInfo += `<p style="color: #4caf50;">üó∫Ô∏è Tajn√© zkratky (Jin): -10%</p>`;
                    hasSomeBonus = true;
                }
                // P√©≈•a temporary bonus
                if (state.secretPathExpires && Date.now() < state.secretPathExpires) {
                    travelBonus -= 0.25;
                    const remainingMs = state.secretPathExpires - Date.now();
                    const remainingMin = Math.ceil(remainingMs / 60000);
                    skillsBonusInfo += `<p style="color: #e91e63;">üéØ P√©≈•ovy zkratky: -25% (${remainingMin} min)</p>`;
                    hasSomeBonus = true;
                }
                
                // Pokud nejsou ≈æ√°dn√© bonusy, zobraz info
                if (!hasSomeBonus) {
                    skillsBonusInfo = `<p style="color: #666; font-size: 0.8rem;">üí° Tip: Zvy≈° Obratnost nebo nauƒç se skill Pr≈Øzkumn√≠k pro rychlej≈°√≠ cestov√°n√≠</p>`;
                }
                
                // === V√ùPOƒåET FIN√ÅLN√çHO ƒåASU ===
                // 1. Z√°klad
                const baseTime = path.time;
                let finalTime = baseTime;
                
                // 2. Aplikuj poƒças√≠ PRVN√ç (zpomalen√≠/zrychlen√≠)
                let weatherAddedTime = 0;
                if (weatherMod !== 1.0) {
                    const weatherTime = Math.ceil(baseTime / weatherMod);
                    weatherAddedTime = weatherTime - baseTime;
                    finalTime = weatherTime;
                    if (weatherAddedTime > 0) {
                        weatherInfo = '<p style="color: #ff9800;">' + weather.icon + ' ' + weather.name + ': +' + weatherAddedTime + ' min</p>';
                    } else if (weatherAddedTime < 0) {
                        weatherInfo = '<p style="color: #8bc34a;">' + weather.icon + ' ' + weather.name + ': ' + weatherAddedTime + ' min</p>';
                    }
                }
                
                // 3. Aplikuj bonusy na ƒças PO poƒças√≠
                let savedTime = 0;
                if (travelBonus < 1.0) {
                    const timeBeforeBonuses = finalTime;
                    finalTime = Math.max(1, Math.ceil(finalTime * Math.max(0.1, travelBonus)));
                    savedTime = timeBeforeBonuses - finalTime;
                    npcBonusInfo = '<p style="color: #8bc34a; font-weight: bold;">‚è±Ô∏è Celkem: ' + finalTime + ' min (√∫spora ' + savedTime + ' min)</p>';
                }
                
                // Pou≈æij fin√°ln√≠ ƒças
                travelTime = finalTime;
                
                let dangerWarning = '';
                let travelFunction = 'startTravel';
                let buttonText = 'üö∂ Vyrazit';
                let buttonColor = 'var(--rust)';
                
                const travelTexts = {
                    unexplored: 'Neprozkouman√° oblast', unknown: 'Nev√≠≈°, co tƒõ tam ƒçek√°...',
                    distance: 'Vzd√°lenost', time: 'ƒåas', danger: 'Nebezpeƒç√≠?', unknownDanger: 'Nezn√°m√©',
                    dangerWarn: 'NEBEZPEƒåN√Å CESTA!', goDanger: 'J√≠t (nebezpeƒçn√©!)', cancel: 'Zru≈°it',
                    safe: 'Bezpeƒçn√©', noPath: 'Nen√≠ p≈ô√≠m√° cesta!', needOther: 'Mus√≠≈° j√≠t p≈ôes jin√© lokace.'
                };
                
                if (path.danger >= 3) {
                    dangerWarning = '<p style="color: #f44336; font-weight: bold;">‚ö†Ô∏è ' + travelTexts.dangerWarn + '</p>';
                    travelFunction = 'confirmTravel'; // P≈ôeskoƒçit druh√Ω modal
                    buttonText = '‚öîÔ∏è ' + travelTexts.goDanger;
                    buttonColor = '#8B0000';
                }
                
                // Pokud lokace NEN√ç nav≈°t√≠ven√°, skryj detaily
                if (!isVisited) {
                    showModal('üó∫Ô∏è Nezn√°m√° lokace', 
                        '<div style="text-align: center;">' +
                        '<div style="font-size: 3rem; margin: 0.5rem 0;">‚ùì</div>' +
                        '<h3 style="margin: 0.3rem 0; color: #888;">' + travelTexts.unexplored + '</h3>' +
                        '<p style="color: #666; font-size: 0.85rem;">' + travelTexts.unknown + '</p>' +
                        '<div style="background: #0a0a0a; padding: 0.4rem 0.8rem; border-radius: 6px; display: inline-block; margin: 0.5rem 0; border: 1px solid #333;">' +
                        '<span style="color: #8bc34a; font-family: monospace; font-size: 0.9rem;">üìç [' + target.x + ', ' + target.y + ']</span>' +
                        '</div>' +
                        '<p style="color: #888;">' + travelTexts.distance + ': ' + path.distance + ' km</p>' +
                        '<p style="color: #888;">‚è±Ô∏è Z√°klad: ' + path.time + ' min</p>' +
                        weatherInfo +
                        nomadBonusInfo +
                        skillsBonusInfo +
                        npcBonusInfo +
                        vehicleInfo +
                        '<p style="color: ' + dangerColor + ';">' + (path.danger > 0 ? '‚ö†Ô∏è'.repeat(path.danger) + ' ' + travelTexts.danger : '? ' + travelTexts.unknownDanger) + '</p>' +
                        dangerWarning +
                        '</div>' +
                        '<button class="btn" onclick="' + travelFunction + '(\'' + targetId + '\')" style="width: 100%; margin-top: 1rem; background: ' + buttonColor + ';">' + buttonText + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó ' + travelTexts.cancel + '</button>'
                    );
                } else {
                    // Nav≈°t√≠ven√° lokace - zobraz v≈°echny info
                    showModal('üó∫Ô∏è Cestovat?', 
                        '<div style="text-align: center;">' +
                        '<div style="font-size: 3rem; margin: 0.5rem 0;">' + target.icon + '</div>' +
                        '<h3 style="margin: 0.3rem 0;">' + target.name + '</h3>' +
                        '<div style="background: #0a0a0a; padding: 0.3rem 0.6rem; border-radius: 4px; display: inline-block; margin: 0.3rem 0; border: 1px solid #333;">' +
                        '<span style="color: #8bc34a; font-family: monospace; font-size: 0.8rem;">üìç [' + target.x + ', ' + target.y + ']</span>' +
                        '</div>' +
                        '<p style="color: #888;">' + travelTexts.distance + ': ' + path.distance + ' km</p>' +
                        '<p style="color: #888;">‚è±Ô∏è Z√°klad: ' + path.time + ' min</p>' +
                        weatherInfo +
                        nomadBonusInfo +
                        skillsBonusInfo +
                        npcBonusInfo +
                        vehicleInfo +
                        '<p style="color: ' + dangerColor + ';">' + (path.danger > 0 ? '‚ö†Ô∏è'.repeat(path.danger) + ' ' + travelTexts.danger.replace('?','') : '‚úì ' + travelTexts.safe) + '</p>' +
                        dangerWarning +
                        '</div>' +
                        '<button class="btn" onclick="' + travelFunction + '(\'' + targetId + '\')" style="width: 100%; margin-top: 1rem; background: ' + buttonColor + ';">' + buttonText + '</button>' +
                        '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó ' + travelTexts.cancel + '</button>'
                    );
                }
            } else {
                // Nen√≠ p≈ô√≠m√° cesta - spoƒç√≠tej vzd√°lenost
                const dist = getDistanceKm(current, target);
                const noPathTexts = {
                    distance: 'Vzd√°lenost', noPath: 'Nen√≠ p≈ô√≠m√° cesta!', needOther: 'Mus√≠≈° j√≠t p≈ôes jin√© lokace.'
                };
                showModal('üó∫Ô∏è ' + (isVisited ? target.name : ('Nezn√°m√° lokace')), 
                    '<div style="text-align: center;">' +
                    '<div style="font-size: 3rem; margin: 0.5rem 0;">' + (isVisited ? target.icon : '‚ùì') + '</div>' +
                    '<div style="background: #0a0a0a; padding: 0.4rem 0.8rem; border-radius: 6px; display: inline-block; margin: 0.5rem 0; border: 1px solid #333;">' +
                    '<span style="color: #8bc34a; font-family: monospace; font-size: 0.9rem;">üìç [' + target.x + ', ' + target.y + ']</span>' +
                    '</div>' +
                    '<p style="color: #888;">' + noPathTexts.distance + ': ' + dist.toFixed(1) + ' km</p>' +
                    '<p style="color: #ff9800;">‚ö†Ô∏è ' + noPathTexts.noPath + '</p>' +
                    '<p style="color: #666; font-size: 0.85rem;">' + noPathTexts.needOther + '</p>' +
                    '</div>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
                );
            }
        }
        
        function startTravel(targetLocationId) {
            if (state.world.traveling) return;
            
            // Kontrola zda neprob√≠h√° akce (lov, tƒõ≈æba, ryba≈ôen√≠...)
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                notifyWarning('Akce prob√≠h√°!', 'Nejd≈ô√≠ve dokonƒçi nebo zru≈° ' + getActionName(state.currentAction.type) + '!');
                return;
            }
            
            const currentLoc = state.world.currentLocation;
            const path = WORLD_PATHS.find(p => 
                (p.from === currentLoc && p.to === targetLocationId) || (p.to === currentLoc && p.from === targetLocationId)
            );
            
            if (!path) { showModal('‚ùå Chyba', 'K t√©to lokaci nevede ≈æ√°dn√° cesta!'); return; }
            
            const targetLoc = WORLD_LOCATIONS.find(l => l.id === targetLocationId);
            const isVisited = state.world.visitedLocations?.includes(targetLocationId);
            
            if (path.danger >= 3) {
                const hour = new Date().getHours();
                const isNight = hour < 6 || hour >= 20;
                const nightWarning = isNight ? '<p style="color: #9c27b0; font-style: italic; margin-top: 0.5rem;">' + getRandomHumor('night') + '</p>' : '';
                
                showModal('‚ö†Ô∏è Nebezpeƒçn√° cesta!', 
                    '<div style="text-align: center;"><div style="font-size: 3rem;">' + (isVisited ? (targetLoc?.icon || '‚ùì') : '‚ùì') + '</div>' +
                    '<h3>' + (isVisited ? (targetLoc?.name || '???') : '??? Nezn√°m√° lokace') + '</h3>' +
                    '<p style="color: #ff9800;">Nebezpeƒç√≠: ' + 'üíÄ'.repeat(path.danger) + '</p>' +
                    '<p style="color: #888;">ƒåas: ' + path.time + ' min</p>' +
                    (isNight ? '<p style="color: #9c27b0;">üåô Je noc - v√≠ce nep≈ô√°tel!</p>' : '') +
                    nightWarning +
                    '</div>' +
                    '<button class="btn" onclick="confirmTravel(\'' + targetLocationId + '\')" style="width: 100%; margin-top: 1rem; background: #8B0000;">‚öîÔ∏è J√≠t (na vlastn√≠ nebezpeƒç√≠)</button>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó Rad≈°i ne</button>'
                );
                return;
            }
            confirmTravel(targetLocationId);
        }
        
        function confirmTravel(targetLocationId) {
            closeModal();
            const currentLoc = state.world.currentLocation;
            const path = WORLD_PATHS.find(p => 
                (p.from === currentLoc && p.to === targetLocationId) || (p.to === currentLoc && p.from === targetLocationId)
            );
            if (!path) return;
            
            // Z√≠skej aktu√°ln√≠ poƒças√≠
            const weather = getCurrentWeather();
            const weatherMod = weather?.effect?.speedMod || 1.0;
            
            // === V√ùPOƒåET FIN√ÅLN√çHO ƒåASU (stejn√© po≈ôad√≠ jako v zobrazen√≠) ===
            // 1. Z√°klad
            const baseTime = path.time;
            let travelTimeMin = baseTime;
            let weatherInfo = '';
            
            // 2. Aplikuj poƒças√≠ PRVN√ç (zpomalen√≠/zrychlen√≠)
            if (weatherMod !== 1.0) {
                travelTimeMin = Math.ceil(travelTimeMin / weatherMod);
                if (weatherMod < 1) {
                    weatherInfo = weather.icon + ' ' + weather.name + ' zpomaluje cestu!';
                }
            }
            
            // 3. Spoƒç√≠tej v≈°echny bonusy
            let travelBonus = 1.0;
            
            // Nom√°d class bonus - 25% rychlej≈°√≠ cestov√°n√≠
            if (hasClassPassive('travelSpeedBonus')) {
                const nomadSpeedBonus = getClassPassiveValue('travelSpeedBonus') || 0;
                travelBonus -= nomadSpeedBonus;
            }
            
            // AGILITY BONUS - ka≈æd√Ω bod AGI nad 5 = -2% ƒças cestov√°n√≠
            const agiBonus = Math.max(0, (state.char.attrs?.agi || 5) - 5) * 0.02;
            if (agiBonus > 0) {
                travelBonus -= agiBonus;
            }
            
            // pathfinder skill - Pr≈Øzkumn√≠k (-3% per level) - ze SKILL_TREE vƒõtev EXPLORATION
            const pathfinderLevel = state.skillTree?.exploration?.pathfinder || state.skills?.['pathfinder'] || 0;
            if (pathfinderLevel > 0) {
                const pathfinderBonus = pathfinderLevel * 0.03;
                travelBonus -= pathfinderBonus;
            }
            
            // fast_travel skill - Rychl√Ω pochod (-5% per level, max 5) - ze SKILL_TREE
            const fastTravelLevel = state.skillTree?.exploration?.fast_travel || state.skillTree?.survival?.fast_travel || state.skills?.['fast_travel'] || 0;
            if (fastTravelLevel > 0) {
                const fastTravelBonus = fastTravelLevel * 0.05;
                travelBonus -= fastTravelBonus;
            }
            
            // Kompas bonus
            const hasCompass = state.inv?.some(i => i.id === 'compass' || i.bonus === 'navigation');
            if (hasCompass) {
                travelBonus -= 0.015;
            }
            
            // Companion skills bonus (Stopa≈ô/pathfinder atd.)
            const companionTravelBonus = getCompanionTravelSpeedBonus();
            if (companionTravelBonus > 0) {
                travelBonus -= companionTravelBonus;
            }
            
            // Boots speed bonus (Turistick√© boty +2%, Exo boty +4%)
            const armorEffects2 = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : { speedBonus: 0 };
            if (armorEffects2.speedBonus > 0) {
                travelBonus -= armorEffects2.speedBonus;
            }
            
            // NPC bonusy pro cestov√°n√≠
            if (state.secrets?.includes('jin_fast_routes')) travelBonus -= 0.05;
            if (state.secrets?.includes('jin_secret_shortcuts')) travelBonus -= 0.10;
            if (state.secretPathExpires && Date.now() < state.secretPathExpires) travelBonus -= 0.25;
            
            // Mutace: travelSpeed bonus (fast_metabolism = -10%, iron_bones speed = +20%)
            const mutBonuses = getMutationBonuses();
            if (mutBonuses.travelSpeed > 0) {
                travelBonus -= mutBonuses.travelSpeed; // fast_metabolism: 0.1 = -10%
            }
            if (mutBonuses.speed < 0) {
                travelBonus -= mutBonuses.speed; // iron_bones: -0.2 = +20% ƒças (tak≈æe -= -0.2 = +0.2)
            }
            
            // 4. Aplikuj bonusy na ƒças PO poƒças√≠
            if (travelBonus < 1.0) {
                travelTimeMin = Math.max(1, Math.ceil(travelTimeMin * Math.max(0.1, travelBonus)));
            }
            
            // Minimum 1 minuta
            travelTimeMin = Math.max(1, travelTimeMin);
            
            // Debug log
            console.log(`üö∂ Travel: base=${baseTime}, weatherMod=${weatherMod}, afterWeather=${Math.ceil(baseTime/weatherMod)}, bonus=${travelBonus.toFixed(2)}, final=${travelTimeMin}`);
            
            state.world.traveling = true;
            state.world.travelTo = targetLocationId;
            state.world.travelPath = path;
            state.world.travelStart = Date.now();
            state.world.travelDuration = travelTimeMin * 60 * 1000; // Minuty na ms
            
            // Auto-save aby se cestov√°n√≠ zachovalo p≈ôi refreshi
            saveGame(true);
            
            // Nastaven√≠ spot≈ôeby bƒõhem cesty (ovlivnƒõno poƒças√≠m)
            const travelSeconds = travelTimeMin * 60;
            let hungerMod = 2, thirstMod = 2.2, energyMod = 2.5;
            
            // Poƒças√≠ ovliv≈àuje spot≈ôebu
            if (weather) {
                // D√©≈°≈• a bou≈ôka - vƒõt≈°√≠ spot≈ôeba energie
                if (weather.id === 'rain') { energyMod *= 1.3; }
                if (weather.id === 'storm') { energyMod *= 1.5; thirstMod *= 1.2; }
                if (weather.id === 'radstorm') { energyMod *= 2; }
                // Sluneƒçno - vƒõt≈°√≠ ≈æ√≠ze≈à
                if (weather.id === 'sunny') { thirstMod *= 1.2; }
            }
            
            state.map.travelHungerRate = (100 / 86400) * hungerMod;
            state.map.travelThirstRate = (100 / 86400) * thirstMod;
            state.map.travelEnergyRate = (100 / 86400) * energyMod;
            
            // Radiace podle nebezpeƒç√≠ a poƒças√≠ (v√Ωraznƒõ sn√≠≈æeno)
            let radMod = weather?.effect?.radMod || 1.0;
            state.map.travelRadRate = (path.danger || 0) * 0.0002 * radMod; // 0.0002 m√≠sto 0.001 (5x m√©nƒõ)
            state.map.travelRadAccumulated = 0; // Reset radiace za cestu (max 20%)
            
            // Synchronizace pro zpƒõtnou kompatibilitu
            state.map.traveling = true;
            state.map.inBase = false;
            
            const targetLoc = WORLD_LOCATIONS.find(l => l.id === targetLocationId);
            const isTargetVisited = state.world.visitedLocations?.includes(targetLocationId);
            const targetName = isTargetVisited ? (targetLoc?.name || '???') : '??? Nezn√°m√° lokace';
            let logMsg = 'Cesta: ' + (path.distance || '?') + ' km ‚Üí ' + targetName + ' üö∂';
            if (weatherInfo) logMsg += ' | ' + weatherInfo;
            
            notifyInfo('Vyd√°v√°≈° se na cestu', targetName + ' (' + travelTimeMin + ' min)');
            addLog(logMsg, 'üö∂');
            
            // Napl√°nuj eventy (ulo≈æ√≠ se do state, p≈ôe≈æij√≠ refresh)
            scheduleTravelEvents(path, travelTimeMin);
            renderFull();
        }
        
        function scheduleTravelEvents(path, travelTimeMin) {
            const duration = travelTimeMin * 60 * 1000; // ms
            const dangerLevel = path.danger || 0;
            const startTime = state.world.travelStart;
            
            console.log('scheduleTravelEvents: duration =', duration, 'ms, danger =', dangerLevel);
            
            // Inicializuj pole napl√°novan√Ωch event≈Ø
            state.world.scheduledEvents = [];
            
            // Reset faction ambush flag - max 1 za cestu
            state.world.factionAmbushTriggered = false;
            
            // PRVN√ç CESTA - garantovan√Ω pes
            if (!state.firstTravelDone && !state.companions?.length && !state.rejectedCompanions?.includes('dog')) {
                state.firstTravelDone = true;
                const eventTime = startTime + (duration * 0.3); // 30% cesty
                state.world.scheduledEvents.push({
                    type: 'companion',
                    eventId: 'stray_dog',
                    triggerAt: eventTime,
                    triggered: false
                });
                console.log('Scheduling DOG event at', duration * 0.3, 'ms (', new Date(eventTime).toLocaleTimeString(), ')');
            } else {
                // Norm√°ln√≠ eventy - MAX 2 za cestu
                const baseEvents = 1;
                const dangerBonus = Math.random() < (dangerLevel * 0.2) ? 1 : 0; // 20% ≈°ance za ka≈æd√Ω danger level
                const eventCount = Math.min(baseEvents + dangerBonus, 2); // MAX 2 eventy
                
                for (let i = 0; i < eventCount; i++) {
                    const eventOffset = duration * (0.2 + (i * 0.25) + Math.random() * 0.15);
                    const eventTime = startTime + eventOffset;
                    state.world.scheduledEvents.push({
                        type: 'random',
                        triggerAt: eventTime,
                        dangerLevel: dangerLevel,
                        triggered: false
                    });
                    console.log('Scheduling event', i, 'at', eventOffset, 'ms (', new Date(eventTime).toLocaleTimeString(), ')');
                }
            }
            
            console.log('Total events scheduled:', state.world.scheduledEvents.length);
        }
        
        // Kontrola event≈Ø - vol√° se v game loop
        function checkScheduledEvents() {
            if (!state.world.traveling || !state.world.scheduledEvents) return;
            
            // Pokud prob√≠h√° boj, nezobrazuj eventy
            if (window.combatState) return;
            
            // Pokud je modal u≈æ otev≈ôen√Ω, nezobrazuj dal≈°√≠
            const modal = document.getElementById('modal');
            if (modal && modal.classList.contains('show')) return;
            
            const now = Date.now();
            
            for (let event of state.world.scheduledEvents) {
                // Pokud event byl triggered ale ne resolved, znovu zobraz modal
                if (event.triggered && !event.resolved) {
                    console.log('Re-showing unresolved event:', event.type);
                    showUnresolvedEvent(event);
                    return; // Zobraz jen jeden najednou
                }
                
                if (event.triggered) continue;
                if (now < event.triggerAt) continue;
                
                // Spus≈• event
                event.triggered = true;
                console.log('Triggering scheduled event:', event.type);
                
                if (event.type === 'companion') {
                    const dogEvent = TRAVEL_EVENTS.find(e => e.id === event.eventId);
                    if (dogEvent) {
                        handleCompanionEvent(dogEvent);
                    }
                } else if (event.type === 'random') {
                    triggerTravelEvent(event.dangerLevel);
                }
            }
        }
        
        // Znovu zobraz nevy≈ôe≈°en√Ω event po refreshi
        function showUnresolvedEvent(event) {
            if (event.type === 'companion') {
                const dogEvent = TRAVEL_EVENTS.find(e => e.id === event.eventId);
                if (dogEvent) {
                    handleCompanionEvent(dogEvent);
                }
            } else if (event.type === 'random' && event.selectedEventId) {
                // M√°me ulo≈æen√Ω konkr√©tn√≠ event - najdi ho a zpracuj
                const savedEvent = TRAVEL_EVENTS.find(e => e.id === event.selectedEventId);
                if (savedEvent) {
                    console.log('Restoring saved event:', savedEvent.name);
                    
                    // Oznaƒç jako resolved HNED aby se nezacyklilo
                    event.resolved = true;
                    
                    // Notifikace jen jednou (p≈ôi refreshi str√°nky)
                    if (!event.notified) {
                        event.notified = true;
                        notifySuccess('üîÑ Event obnoven', savedEvent.name);
                    }
                    
                    // Zpracuj event podle jeho typu
                    switch (savedEvent.type) {
                        case 'combat':
                            handleCombatEvent(event.dangerLevel);
                            break;
                        case 'loot':
                            handleLootEvent();
                            break;
                        case 'radiation':
                            handleRadiationEvent(event.dangerLevel);
                            break;
                        case 'trap':
                            handleTrapEvent();
                            break;
                        case 'merchant':
                            handleMerchantEvent();
                            break;
                        case 'companion':
                            handleCompanionEvent(savedEvent);
                            break;
                        case 'mystery':
                            handleMysteryEvent();
                            break;
                        case 'treasure':
                            handleTreasureEvent();
                            break;
                        case 'survivor':
                            handleSurvivorEvent();
                            break;
                        case 'weather':
                            handleWeatherEvent();
                            break;
                        default:
                            // Fallback - zobraz jako loot nebo combat
                            if (Math.random() < 0.5) {
                                handleLootEvent();
                            } else {
                                handleCombatEvent(event.dangerLevel);
                            }
                    }
                } else {
                    // Event nenalezen - vygeneruj nov√Ω
                    triggerTravelEvent(event.dangerLevel);
                }
            } else {
                // Nem√°me ulo≈æen√Ω event, vygeneruj nov√Ω
                triggerTravelEvent(event.dangerLevel);
            }
        }
        
        // Oznaƒç aktu√°ln√≠ event jako vy≈ôe≈°en√Ω
        function resolveCurrentEvent() {
            if (!state.world.scheduledEvents) return;
            
            for (let event of state.world.scheduledEvents) {
                if (event.triggered && !event.resolved) {
                    event.resolved = true;
                    console.log('Event resolved:', event.type);
                    break;
                }
            }
        }
        
        function triggerTravelEvent(dangerLevel) {
            console.log('triggerTravelEvent called, traveling =', state.world.traveling);
            if (!state.world.traveling) return;
            
            // Najdi aktu√°ln√≠ event a oznaƒç ho jako resolved HNED na zaƒç√°tku
            // (aby se nezacyklil p≈ôi faction ambush)
            for (let event of state.world.scheduledEvents || []) {
                if (event.triggered && !event.resolved && event.type === 'random') {
                    event.resolved = true;
                    break;
                }
            }
            
            // === FACTION AMBUSH CHECK ===
            // Kontrola nep≈ô√°telsk√Ωch frakc√≠ - raiders maj√≠ ambushChance
            // LIMIT: Max 1 faction ambush za cestu
            if (typeof FACTIONS !== 'undefined' && !state.world.factionAmbushTriggered) {
                const raidersFaction = FACTIONS.find(f => f.id === 'raiders');
                if (raidersFaction && state.factionRep) {
                    const rep = state.factionRep.raiders || 0;
                    let ambushChance = 0;
                    
                    if (rep <= -50) {
                        // Enemy status - 60% ambush
                        ambushChance = 0.6;
                    } else if (rep <= -25) {
                        // Hostile status - 30% ambush
                        ambushChance = 0.3;
                    }
                    
                    if (ambushChance > 0 && Math.random() < ambushChance) {
                        // Faction ambush! Oznaƒç ≈æe u≈æ probƒõhl
                        state.world.factionAmbushTriggered = true;
                        console.log('Faction ambush triggered! Raiders rep:', rep);
                        addLog('‚ö†Ô∏è N√°jezdn√≠ci ti nastra≈æili past!', 'üíÄ');
                        
                        // Spawn raiders combat
                        const raiderEnemy = ENEMIES.find(e => e.id === 'raider') || ENEMIES.find(e => e.faction === 'raiders');
                        if (raiderEnemy) {
                            showModal('üíÄ P≈ôepaden√≠ n√°jezdn√≠k≈Ø!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem;">üíÄ</div>
                                    <h3 style="color: #f44336;">N√°jezdn√≠ci!</h3>
                                    <p style="color: #888;">Tv√° ≈°patn√° povƒõst u n√°jezdn√≠k≈Ø tƒõ dostihla!</p>
                                    <p style="color: #ff9800; font-size: 0.9rem;">Reputace: ${rep}</p>
                                </div>
                                <button class="btn" onclick="closeModal(); startCombat({id: 'raider'}, true);" style="width: 100%; margin-top: 1rem; background: #c62828;">
                                    ‚öîÔ∏è Bojovat!
                                </button>
                            `);
                            return; // Nepokraƒçuj s norm√°ln√≠m eventem
                        }
                    }
                }
            }
            
            // Vyber n√°hodn√Ω event
            const roll = Math.random();
            let cumulative = 0;
            let selectedEvent = null;
            
            // Filtruj eventy - firstOnly eventy pouze pokud nem√°me/neodm√≠tli spoleƒçn√≠ka
            const availableEvents = TRAVEL_EVENTS.filter(e => {
                if (e.firstOnly && e.companionId) {
                    // Spoleƒçn√≠ka m≈Ø≈æeme z√≠skat jen jednou
                    const hasCompanion = state.companions?.some(c => c.id === e.companionId);
                    const rejectedCompanion = state.rejectedCompanions?.includes(e.companionId);
                    return !hasCompanion && !rejectedCompanion;
                }
                return true;
            });
            
            console.log('Available events:', availableEvents.length, 'roll =', roll);
            
            for (const event of availableEvents) {
                cumulative += event.chance;
                if (roll < cumulative) {
                    selectedEvent = event;
                    break;
                }
            }
            
            console.log('Selected event:', selectedEvent?.name || 'none');
            
            if (!selectedEvent) {
                // Fallback - v≈ædy nƒõjak√Ω event
                selectedEvent = availableEvents.find(e => e.type === 'combat') || availableEvents[0];
                console.log('Fallback event:', selectedEvent?.name);
            }
            
            if (!selectedEvent) return;
            
            // Ulo≈æ vybran√Ω event pro p≈ô√≠pad refreshe
            for (let event of state.world.scheduledEvents) {
                if (event.triggered && !event.resolved && event.type === 'random') {
                    event.selectedEventId = selectedEvent.id;
                    event.selectedEventType = selectedEvent.type;
                    // Ulo≈æ hru aby se event zachoval p≈ôi refreshi
                    saveGame(true);
                    break;
                }
            }
            
            // Syst√©mov√° notifikace o eventu
            sendSystemNotification(selectedEvent.name, selectedEvent.text || 'Nƒõco se dƒõje na cestƒõ!', selectedEvent.icon);
            
            // Push notifikace na mobil
            MobileNotifications.notifyTravelEvent(selectedEvent.name, selectedEvent.icon);
            
            // Zpracuj event podle typu
            switch (selectedEvent.type) {
                case 'combat':
                    handleCombatEvent(dangerLevel);
                    break;
                case 'loot':
                    handleLootEvent();
                    break;
                case 'radiation':
                    handleRadiationEvent(dangerLevel);
                    break;
                case 'trap':
                    handleTrapEvent();
                    break;
                case 'exhaustion':
                    handleExhaustionEvent();
                    break;
                case 'companion':
                    handleCompanionEvent(selectedEvent);
                    break;
                case 'resource':
                    handleResourceEvent(selectedEvent);
                    break;
                case 'dirty_water':
                    handleResourceEvent(selectedEvent);
                    break;
                case 'food_scraps':
                    handleResourceEvent(selectedEvent);
                    break;
                case 'choice':
                    handleChoiceEvent(selectedEvent);
                    break;
                case 'explore':
                    handleExploreEvent(selectedEvent);
                    break;
                case 'rest':
                    handleRestEvent(selectedEvent);
                    break;
                case 'theft':
                    handleTheftEvent();
                    break;
                case 'sickness':
                    handleSicknessEvent();
                    break;
                case 'cache':
                    handleCacheEvent(selectedEvent);
                    break;
                case 'trader':
                    handleTraderEvent(selectedEvent);
                    break;
                default:
                    // Zobraz generick√Ω event
                    showModal(selectedEvent.icon + ' ' + selectedEvent.name,
                        '<p>' + selectedEvent.text + '</p>' +
                        '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>'
                    );
            }
        }
        
        function handleCombatEvent(dangerLevel) {
            const enemyIndex = Math.min(ENEMIES.length - 1, Math.floor(Math.random() * (5 + dangerLevel * 3)));
            const enemy = ENEMIES[enemyIndex];
            const humor = getRandomHumor('combatStart');
            MobileNotifications.notifyCombat(enemy.name);
            showModal('üí• P≈ôepaden√≠!', 
                '<p>Z √∫krytu vyskoƒçili nep≈ô√°tel√©!</p>' +
                '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"' + humor + '"</p>' +
                '<div style="text-align: center; margin: 1rem 0;"><div style="font-size: 3rem;">' + enemy.icon + '</div>' +
                '<h3 style="color: var(--warning-yellow);">' + enemy.name + '</h3>' +
                '<p style="color: #888;">HP: ' + enemy.hp + ' | DMG: ' + enemy.damage + '</p></div>' +
                '<button class="btn" onclick="fightTravelEnemy(\'' + enemy.id + '\')" style="width: 100%; margin-bottom: 0.5rem; background: #8B0000;">‚öîÔ∏è ' + ('Bojovat!') + '</button>' +
                '<button class="btn" onclick="tryToFleeTravel(\'' + enemy.id + '\')" style="width: 100%; background: #555;">üèÉ Strategick√Ω √∫stup!</button>'
            );
        }
        
        function handleLootEvent() {
            // ≈†ance na lore knihu (3%)
            if (Math.random() < 0.03) {
                const ownedLore = state.inv.filter(i => i.id?.startsWith('lore_')).map(i => i.id);
                const availableLore = ITEMS.filter(i => i.id?.startsWith('lore_') && !ownedLore.includes(i.id));
                
                if (availableLore.length > 0) {
                    availableLore.sort((a, b) => a.id.localeCompare(b.id));
                    const loreBook = availableLore[0];
                    
                    if (canAddItem(loreBook, 1)) {
                        addItemToInventory(loreBook, 1, true);
                        notifyLoot(loreBook.name, 'epic', loreBook.icon);
                        addLog('üìï Nalezen vz√°cn√Ω den√≠k!', 'üìï');
                        
                        showModal('üìï Vz√°cn√Ω n√°lez!', 
                            '<p>Na cestƒõ jsi na≈°el nƒõco zaj√≠mav√©ho!</p>' +
                            '<div style="text-align: center; margin: 1rem 0;"><div style="font-size: 3rem;">' + loreBook.icon + '</div>' +
                            '<h3 style="color: #ffd700;">' + loreBook.name + '</h3>' +
                            '<p style="color: #888;">Star√Ω den√≠k... mo≈æn√° obsahuje d≈Øle≈æit√© informace.</p></div>' +
                            '<button class="btn" onclick="continueTravel()" style="width: 100%;">‚úì Skvƒõl√©!</button>'
                        );
                        return;
                    }
                }
            }
            
            // Filtruj itemy kter√© se daj√≠ n√°hodnƒõ naj√≠t (ne lore, ne quest itemy, ne cantBuy)
            const lootableItems = ITEMS.filter(i => 
                !i.id?.startsWith('lore_') && 
                !i.id?.startsWith('quest_') && 
                !i.cantBuy &&
                i.type !== 'lore'
            );
            
            const lootItem = lootableItems[Math.floor(Math.random() * lootableItems.length)];
            let humor = '';
            let itemAdded = false;
            let itemName = lootItem?.name || 'Nic u≈æiteƒçn√©ho';
            let itemIcon = lootItem?.icon || 'üì¶';
            let extraText = '';
            
            if (lootItem) {
                if (canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1, true);
                    notifyLoot(lootItem.name, lootItem.rarity, lootItem.icon);
                    MobileNotifications.notifyLootFound(lootItem.name, lootItem.icon);
                    addLog(`üéÅ Na cestƒõ nalezeno: ${lootItem.icon} ${lootItem.name}`, 'üéÅ');
                    humor = lootItem.rarity === 'rare' || lootItem.rarity === 'epic' ? getRandomHumor('lootGood') : getRandomHumor('lootJunk');
                    itemAdded = true;
                } else {
                    // Ulo≈æ na zem c√≠lov√© lokace
                    addToGroundLoot({...lootItem}, state.map.travelTo || state.world.currentLocation);
                    humor = 'Nem√°m m√≠sto, ale nech√°m to tu le≈æet...';
                    extraText = '<p style="color: #ff9800; font-size: 0.9rem;">üì¶ Pln√Ω invent√°≈ô! P≈ôedmƒõt z≈Østal na zemi.</p>';
                }
            } else {
                humor = getRandomHumor('lootEmpty');
            }
            showModal('üéÅ N√°lez!', 
                '<p>Na cestƒõ jsi nƒõco na≈°el!</p>' +
                '<div style="text-align: center; margin: 1rem 0;"><div style="font-size: 3rem;">' + itemIcon + '</div>' +
                '<h3 style="color: ' + (itemAdded ? 'var(--toxic-green)' : '#888') + ';">' + itemName + '</h3>' +
                extraText +
                '<p style="color: #666; font-style: italic; margin-top: 0.5rem;">"' + humor + '"</p></div>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%;">‚úì ' + (itemAdded ? 'Beru!' : 'Jdu d√°l...') + '</button>'
            );
        }
        
        function handleRadiationEvent(dangerLevel) {
            const radGain = 5 + dangerLevel * 5;
            
            // Kontrola ochrany na radiaci (hazmat oblek atd.)
            const armor = state.equipped?.armor;
            const hasRadProtection = armor?.special === 'rad_immune' || armor?.special === 'rad_resist';
            const reduction = hasRadProtection ? (armor?.special === 'rad_immune' ? 0.5 : 0.3) : 0;
            const actualRadGain = Math.floor(radGain * (1 - reduction));
            
            addRadiation(actualRadGain);
            const humor = getRandomHumor('radiation');
            
            if (hasRadProtection) {
                const reductionPct = Math.floor(reduction * 100);
                notifyWarning('Radiace (sn√≠≈æeno)!', `‚ò¢Ô∏è Oblek -${reductionPct}%`);
                showModal('‚ò¢Ô∏è Radiaƒçn√≠ bou≈ôe!', 
                    '<p>Obloha se zbarvila do zelena!</p>' +
                    `<p style="color: #76ff03;">ü•º Tv≈Øj oblek sn√≠≈æil radiaci o ${reductionPct}%!</p>` +
                    `<p style="color: #ff9800;">+${actualRadGain} radiace (m√≠sto ${radGain})</p>` +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>'
                );
            } else {
                notifyWarning('Radiace!', '+' + actualRadGain + ' ‚ò¢Ô∏è');
                showModal('‚ò¢Ô∏è Radiaƒçn√≠ bou≈ôe!', 
                    '<p>Obloha se zbarvila do zelena!</p>' +
                    '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + humor + '"</p>' +
                    '<p style="color: #ff9800; font-size: 1.2rem;">+' + actualRadGain + ' radiace</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Sv√≠t√≠m d√°l...</button>'
                );
            }
        }
        
        function handleTrapEvent() {
            const damage = 10 + Math.floor(Math.random() * 15);
            state.char.hp = Math.max(1, state.char.hp - damage);
            const humor = getRandomHumor('trap');
            notifyDanger('Past!', '-' + damage + ' HP');
            showModal('ü™§ Past!', 
                '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"' + humor + '"</p>' +
                '<p style="color: #f44336; font-size: 1.2rem; margin-top: 0.5rem;">-' + damage + ' HP</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Kulh√°m d√°l...</button>'
            );
        }
        
        function handleExhaustionEvent() {
            state.status.energy = Math.max(0, state.status.energy - 20);
            const humor = getRandomHumor('exhaustion');
            notifyWarning('Vyƒçerp√°n√≠', '-20 ' + ('energie'));
            showModal('üò∞ Vyƒçerp√°n√≠', 
                '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"' + humor + '"</p>' +
                '<p style="color: #ff9800; font-size: 1.2rem; margin-top: 0.5rem;">-20 energie</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì *vzdych√°* ...d√°l</button>'
            );
        }
        
        function handleCompanionEvent(event) {
            const companion = getCompanionData(event.companionId);
            if (!companion) return;
            
            // Syst√©mov√° notifikace
            sendSystemNotification(event.name, event.text || 'Na≈°el jsi spoleƒçn√≠ka!', event.icon);
            
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' +
                '<div style="text-align: center; margin: 1rem 0;">' +
                '<div style="font-size: 4rem;">' + companion.icon + '</div>' +
                '<h3 style="color: var(--toxic-green);">' + companion.name + '</h3>' +
                '<p style="color: #888; font-size: 0.85rem;">' + companion.abilityDesc + '</p></div>' +
                '<button class="btn" onclick="adoptCompanion(\'' + companion.id + '\')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">‚ù§Ô∏è Vz√≠t k sobƒõ</button>' +
                '<button class="btn" onclick="confirmLeaveCompanion(\'' + companion.id + '\', \'' + companion.name + '\', \'' + companion.icon + '\')" style="width: 100%; background: #555;">‚úó Nechat b√Ωt</button>'
            );
        }
        
        function confirmLeaveCompanion(companionId, name, icon) {
            showModal('‚ö†Ô∏è Opravdu odej√≠t?', 
                '<div style="text-align: center; margin: 1rem 0;">' +
                '<div style="font-size: 3rem;">' + icon + '</div>' +
                '<p style="color: #ff9800;">Tohoto spoleƒçn√≠ka u≈æ nikdy nepotk√°≈°!</p>' +
                '<p style="color: #888; font-size: 0.85rem;">' + name + ' z≈Østane s√°m v pustinƒõ...</p></div>' +
                '<button class="btn" onclick="adoptCompanion(\'' + companionId + '\')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">‚ù§Ô∏è Zmƒõnit n√°zor - vz√≠t k sobƒõ</button>' +
                '<button class="btn" onclick="leaveCompanionForever(\'' + companionId + '\')" style="width: 100%; background: #8B0000;">üíî Ano, nechat ho</button>'
            );
        }
        
        function leaveCompanionForever(companionId) {
            // Oznaƒç ≈æe jsme tohoto spoleƒçn√≠ka odm√≠tli (u≈æ se neobjev√≠)
            if (!state.rejectedCompanions) state.rejectedCompanions = [];
            state.rejectedCompanions.push(companionId);
            
            notifyWarning('Ode≈°el jsi', 'Spoleƒçn√≠k z≈Østal s√°m...');
            continueTravel();
        }
        
        function adoptCompanion(companionId, customName = null) {
            const companion = getCompanionData(companionId);
            if (!companion) {
                console.error('adoptCompanion: Unknown companion', companionId);
                return;
            }
            
            if (!state.companions) state.companions = [];
            
            // Max spoleƒçn√≠ci podle levelu
            if (state.companions.length >= getMaxCompanions()) {
                showModal('‚ö†Ô∏è Pln√Ω t√Ωm', 
                    '<div style="text-align: center;">' +
                    '<p>U≈æ m√°≈° maxim√°ln√≠ poƒçet spoleƒçn√≠k≈Ø (' + getMaxCompanions() + ').</p>' +
                    '<p style="color: #888;">Propus≈• jednoho ve spr√°vƒõ spoleƒçn√≠k≈Ø, pokud chce≈° nov√©ho.</p>' +
                    '<p style="color: #4caf50; font-size: 0.85rem; margin-top: 0.5rem;">üí° Vy≈°≈°√≠ level = v√≠ce spoleƒçn√≠k≈Ø!</p>' +
                    '</div>' +
                    '<button class="btn" onclick="closeModal(); continueTravel();" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úì OK</button>'
                );
                return;
            }
            
            // P≈ôidej spoleƒçn√≠ka s defaultn√≠m jm√©nem
            const newCompanion = {...companion, hp: companion.hp, maxHp: companion.hp};
            state.companions.push(newCompanion);
            closeModal();
            resolveCurrentEvent(); // Oznaƒç event jako vy≈ôe≈°en√Ω
            notifySuccess('Nov√Ω spoleƒçn√≠k!', newCompanion.name + ' se k tobƒõ p≈ôidal!');
            addLog(newCompanion.name + ' se stal tv√Ωm spoleƒçn√≠kem!', companion.icon);
            
            // Pokud cestujeme, pokraƒçuj
            renderFull();
        }
        
        function confirmAdoptCompanion(companionId) {
            adoptCompanion(companionId);
        }
        
        // Renamed to avoid duplicate - for travel context
        function swapCompanionTravel(newCompanionId) {
            const newCompanion = getCompanionData(newCompanionId);
            if (!newCompanion) return;
            
            const oldCompanion = state.companions[0];
            state.companions = [{...newCompanion, hp: newCompanion.hp, maxHp: newCompanion.hp}];
            
            closeModal();
            notifySuccess('V√Ωmƒõna!', oldCompanion.name + ' ‚Üí ' + newCompanion.name);
            addLog('Vymƒõnil spoleƒçn√≠ka: ' + newCompanion.name, newCompanion.icon);
            renderFull();
        }
        
        function handleResourceEvent(event) {
            let resourceType = 'herbs';
            let amount = 2 + Math.floor(Math.random() * 3);
            
            if (event.id === 'water_source') {
                // Dopl≈à ≈æ√≠ze≈à - SN√ç≈ΩENO
                state.status.thirst = Math.min(100, state.status.thirst + 15);
                renderFull(); // Aktualizuj UI
                
                // Men≈°√≠ ≈°ance na l√°hev vody (50%)
                if (Math.random() < 0.5) {
                    const waterBottle = ITEMS.find(i => i.id === 'water_bottle');
                    if (waterBottle) {
                        addItemToInventory(waterBottle, 1);
                        addLog(`üíß ƒåist√Ω pramen: +15 ≈æ√≠ze≈à, +1x üíß L√°hev vody`, 'üíß');
                        notifySuccess('ƒåerstv√° voda!', `+15 ≈æ√≠ze≈à, +1x üíß`);
                    }
                } else {
                    addLog('üíß ƒåist√Ω pramen: +15 ≈æ√≠ze≈à', 'üíß');
                    notifySuccess('ƒåerstv√° voda!', '+15 ' + ('≈æ√≠ze≈à'));
                }
            } else if (event.id === 'dirty_puddle') {
                // Kaln√° lou≈æe - riziko radiace - hr√°ƒç si vybere
                showModal('üí¶ Kaln√° lou≈æe', 
                    '<p>Nach√°z√≠≈° kalnou lou≈æi. Voda vypad√° pochybnƒõ...</p>' +
                    '<button class="btn" onclick="drinkDirtyWater()" style="width: 100%; margin-bottom: 0.5rem; background: #ff9800;">üí¶ Nap√≠t se (+20 ≈æ√≠ze≈à, riziko radiace)</button>' +
                    '<button class="btn" onclick="closeModal(); continueTravel();" style="width: 100%; background: #555;">‚úó Nechat b√Ωt</button>'
                );
                return; // D≈Øle≈æit√© - nepokraƒçovat d√°l
            } else if (event.id === 'food_scraps') {
                // Zbytky j√≠dla - mal√° hodnota
                const hungerGain = 8 + Math.floor(Math.random() * 7); // 8-15 hlad
                state.status.hunger = Math.min(100, state.status.hunger + hungerGain);
                addLog(`üçñ Zbytky j√≠dla: +${hungerGain} hlad`, 'üçñ');
                notifySuccess('Zbytky j√≠dla', `+${hungerGain} hlad`);
                renderFull(); // Aktualizuj UI
                showModal('üçñ Zbytky j√≠dla', 
                    '<p>Na≈°el jsi nap≈Øl snƒõden√© konzervy a zbytky j√≠dla. Lep≈°√≠ ne≈æ nic...</p>' +
                    '<p style="color: var(--toxic-green);">+' + hungerGain + ' hlad</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>'
                );
                return; // D≈Øle≈æit√© - nepokraƒçovat d√°l
            } else if (event.id === 'herb_patch') {
                state.resources.herbs = (state.resources.herbs || 0) + amount;
                addLog(`üåø Pole bylin: +${amount} byliny`, 'üåø');
                notifySuccess('Byliny!', '+' + amount + ' üåø');
            }
            
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>'
            );
        }
        
        function handleChoiceEvent(event) {
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' +
                '<button class="btn" onclick="investigateEvent(\'' + event.id + '\')" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust);">üîç Prozkoumat</button>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; background: #555;">‚úó Ignorovat</button>'
            );
        }
        
        function investigateEvent(eventId) {
            closeModal();
            const roll = Math.random();
            
            if (roll < 0.4) {
                // Dobr√Ω v√Ωsledek
                const lootItem = ITEMS[Math.floor(Math.random() * 15)];
                if (lootItem && canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1);
                    addLog(`üîç Pr≈Øzkum: Nalezeno ${lootItem.icon} ${lootItem.name}`, 'üîç');
                    notifyLoot(lootItem.name, lootItem.rarity, lootItem.icon);
                }
                showModal('üéÅ ≈†tƒõst√≠!', 
                    '<p>Na≈°el jsi nƒõco u≈æiteƒçn√©ho!</p>' +
                    '<div style="text-align: center; font-size: 2rem; margin: 1rem 0;">' + (lootItem?.icon || 'üì¶') + '</div>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%;">‚úì Pokraƒçovat</button>'
                );
            } else if (roll < 0.7) {
                // Nic
                showModal('üòê Nic', 
                    '<p>Nena≈°el jsi nic zaj√≠mav√©ho.</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%;">‚úì Pokraƒçovat</button>'
                );
            } else {
                // ≈†patn√Ω v√Ωsledek - boj nebo past
                handleCombatEvent(1);
            }
        }
        
        function handleExploreEvent(event) {
            const roll = Math.random();
            let reward = '';
            
            if (roll < 0.5) {
                const lootItem = ITEMS[Math.floor(Math.random() * 20)];
                if (lootItem && canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1);
                    addLog(`üîç ${event.name}: Nalezeno ${lootItem.icon} ${lootItem.name}`, 'üîç');
                    reward = '<p style="color: var(--toxic-green);">Na≈°el jsi: ' + lootItem.icon + ' ' + lootItem.name + '</p>';
                }
            } else if (roll < 0.7) {
                const money = 10 + Math.floor(Math.random() * 30);
                addMoney(money);
                addLog(`üîç ${event.name}: Nalezeno ${money} üí∞`, 'üîç');
                reward = '<p style="color: #ffd700;">Na≈°el jsi: ' + money + ' üí∞</p>';
            }
            
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p>' + reward +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>'
            );
        }
        
        function handleRestEvent(event) {
            const energyGain = 8 + Math.floor(Math.random() * 8); // 8-15 energie (sn√≠≈æeno z 15-30)
            state.status.energy = Math.min(100, state.status.energy + energyGain);
            renderFull(); // Aktualizuj UI
            notifySuccess('Kr√°tk√Ω odpoƒçinek', '+' + energyGain + ' ' + ('energie'));
            showModal(event.icon + ' ' + event.name, 
                '<p>' + event.text + '</p><p style="color: var(--toxic-green);">+' + energyGain + ' energie</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>'
            );
        }
        
        function drinkDirtyWater() {
            closeModal();
            state.status.thirst = Math.min(100, state.status.thirst + 20);
            renderFull(); // Aktualizuj UI ihned
            
            // 40% ≈°ance na radiaci
            if (Math.random() < 0.4) {
                const radGain = 5 + Math.floor(Math.random() * 10); // 5-15 radiace
                addRadiation(radGain);
                renderFull(); // Aktualizuj UI po radiaci
                addLog(`üí¶ Kaln√° voda: +20 ≈æ√≠ze≈à, +${radGain} radiace!`, '‚ò¢Ô∏è');
                notifyWarning('Kontaminovan√° voda!', `+20 ≈æ√≠ze≈à, +${radGain} ‚ò¢Ô∏è`);
                showModal('üí¶ Kontaminovan√°!', 
                    '<p>Voda byla kontaminovan√°!</p>' +
                    '<p style="color: var(--toxic-green);">+20 ≈æ√≠ze≈à</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' ‚ò¢Ô∏è radiace</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì *ka≈°le* ...d√°l</button>'
                );
            } else {
                addLog('üí¶ Kaln√° voda: +20 ≈æ√≠ze≈à (mƒõl jsi ≈°tƒõst√≠)', 'üí¶');
                notifySuccess('Mƒõl jsi ≈°tƒõst√≠!', '+20 ≈æ√≠ze≈à');
                showModal('üí¶ V po≈ô√°dku!', 
                    '<p>Voda chutnala divnƒõ, ale vypad√° ≈æe jsi v po≈ô√°dku.</p>' +
                    '<p style="color: var(--toxic-green);">+20 ≈æ√≠ze≈à</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Fuj, ale ok</button>'
                );
            }
        }
        
        function handleTheftEvent() {
            const money = getMoney();
            if (money > 0) {
                const stolen = Math.min(money, 5 + Math.floor(Math.random() * 20));
                removeMoney(stolen);
                const humor = getRandomHumor('theftFail');
                notifyDanger('Okraden!', '-' + stolen + ' üí∞');
                showModal('ü•∑ Zlodƒõj!', 
                    '<p>Nƒõkdo tƒõ okradl!</p>' +
                    '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + humor + '"</p>' +
                    '<p style="color: #f44336; font-size: 1.2rem;">-' + stolen + ' üí∞</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì *nad√°v√°* ...d√°l</button>'
                );
            } else {
                showModal('ü•∑ Zlodƒõj!', 
                    '<p>Nƒõkdo se tƒõ pokusil okr√°st!</p>' +
                    '<p style="color: #666; font-style: italic; font-size: 0.8rem;">"Plot twist: Nem√°≈° co ukr√°st. Kdo je teƒè chud√°k?"</p>' +
                    '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì Ha! ≈Ωebr√°k 1, Zlodƒõj 0</button>'
                );
            }
        }
        
        function handleSicknessEvent() {
            state.status.hunger = Math.max(0, state.status.hunger - 15);
            const damage = 5;
            state.char.hp = Math.max(1, state.char.hp - damage);
            const humor = getRandomHumor('foodWeird');
            notifyWarning('Nevolnost', '-15 ' + ('hlad') + ', -' + damage + ' HP');
            showModal('ü§¢ Nevolnost', 
                '<p>Nƒõco ti nesedlo v ≈æaludku...</p>' +
                '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + humor + '"</p>' +
                '<p style="color: #ff9800;">-15 hlad, -' + damage + ' HP</p>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem;">‚úì *g√∫√∫√∫√∫* ...d√°l</button>'
            );
        }
        
        function handleCacheEvent(event) {
            // Generuj n√°hodn√Ω loot ze skr√Ω≈°e
            const possibleLoot = [
                { type: 'money', min: 50, max: 200 },
                { type: 'resource', resource: 'metal', min: 3, max: 10 },
                { type: 'resource', resource: 'wood', min: 5, max: 15 },
                { type: 'resource', resource: 'cloth', min: 3, max: 8 },
                { type: 'resource', resource: 'chemicals', min: 1, max: 5 },
                { type: 'item', items: ['medkit', 'bandage', 'food', 'water', 'stimpack'] }
            ];
            
            // Vyber 2-4 druhy lootu
            const lootCount = 2 + Math.floor(Math.random() * 3);
            const selectedLoot = [];
            const usedTypes = [];
            
            for (let i = 0; i < lootCount; i++) {
                const available = possibleLoot.filter((_, idx) => !usedTypes.includes(idx));
                if (available.length === 0) break;
                
                const idx = possibleLoot.indexOf(available[Math.floor(Math.random() * available.length)]);
                usedTypes.push(idx);
                const loot = possibleLoot[idx];
                
                if (loot.type === 'money') {
                    const amount = loot.min + Math.floor(Math.random() * (loot.max - loot.min));
                    addMoney(amount);
                    selectedLoot.push({ icon: 'üí∞', text: `${amount} penƒõz` });
                } else if (loot.type === 'resource') {
                    const amount = loot.min + Math.floor(Math.random() * (loot.max - loot.min));
                    state.resources[loot.resource] = (state.resources[loot.resource] || 0) + amount;
                    const icons = { metal: '‚öôÔ∏è', wood: 'üå≤', cloth: 'üßµ', chemicals: 'üß™' };
                    const names = { metal: 'kovu', wood: 'd≈ôeva', cloth: 'l√°tky', chemicals: 'chemik√°li√≠', scrap: '≈°rotu', fuel: 'paliva', electronics: 'elektroniky', herbs: 'bylin' };
                    selectedLoot.push({ icon: icons[loot.resource] || 'üì¶', text: `${amount} ${names[loot.resource] || loot.resource}` });
                } else if (loot.type === 'item') {
                    const itemId = loot.items[Math.floor(Math.random() * loot.items.length)];
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item && canAddItem(item, 1)) {
                        state.inv.push({...item});
                        selectedLoot.push({ icon: item.icon, text: item.name });
                    }
                }
            }
            
            const lootHtml = selectedLoot.map(l => `<div style="padding: 0.3rem 0;">${l.icon} ${l.text}</div>`).join('');
            const findHumor = getRandomHumor('finds');
            
            showModal(event.icon + ' ' + event.name,
                '<p>' + event.text + '</p>' +
                '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin: 0.5rem 0;">"' + findHumor + '"</p>' +
                '<div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4CAF50;">' +
                '<h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">üéÅ Nalezeno:</h4>' +
                lootHtml +
                '</div>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">‚úì Beru v≈°echno!</button>'
            );
            
            addLog('Na≈°el jsi skrytou skr√Ω≈°!', 'üì¶');
            notifySuccess('Skr√Ω≈°!', 'Nalezeny z√°soby');
        }
        
        function handleTraderEvent(event) {
            // Generuj n√°hodn√© zbo≈æ√≠ od potuln√©ho obchodn√≠ka
            const traderItems = [];
            const itemPool = ITEMS.filter(i => i.type === 'consumable' || i.type === 'ammo' || i.type === 'resource');
            
            // Vyber 4-6 n√°hodn√Ωch item≈Ø
            const itemCount = 4 + Math.floor(Math.random() * 3);
            const usedIds = [];
            
            for (let i = 0; i < itemCount; i++) {
                const available = itemPool.filter(it => !usedIds.includes(it.id));
                if (available.length === 0) break;
                const item = available[Math.floor(Math.random() * available.length)];
                usedIds.push(item.id);
                // Cena se slevou 10-30%
                const discount = 0.7 + Math.random() * 0.2;
                const price = Math.floor((item.price || 20) * discount);
                traderItems.push({...item, traderPrice: price});
            }
            
            // Ulo≈æ zbo≈æ√≠ do stavu pro n√°kup
            state.travelTraderItems = traderItems;
            
            const itemsHtml = traderItems.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span>${item.icon} ${item.name}</span>
                    <button class="btn" onclick="buyFromTravelTrader(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" ${state.money < item.traderPrice ? 'disabled' : ''}>
                        ${item.traderPrice} üí∞
                    </button>
                </div>
            `).join('');
            
            const traderQuote = getRandomHumor('trader');
            
            showModal(event.icon + ' ' + event.name,
                '<p>' + event.text + '</p>' +
                '<p style="color: #888; font-style: italic; font-size: 0.85rem; margin: 0.5rem 0;">"' + traderQuote + '"</p>' +
                '<p style="color: #ffd700; margin: 0.5rem 0;">üí∞ Tvoje pen√≠ze: ' + state.money + '</p>' +
                '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin: 1rem 0;">' +
                itemsHtml +
                '</div>' +
                '<button class="btn" onclick="continueTravel()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úì Sbohem, obchodn√≠ku</button>'
            );
            
            addLog('Potkal jsi potuln√©ho obchodn√≠ka!', 'üß≥');
        }
        
        function buyFromTravelTrader(idx) {
            if (!state.travelTraderItems || !state.travelTraderItems[idx]) return;
            
            const item = state.travelTraderItems[idx];
            
            // Kontrola unique item≈Ø
            const itemDef = ITEMS.find(i => i.id === item.id);
            if (itemDef?.unique) {
                const alreadyHas = state.inv.some(i => i.id === item.id);
                if (alreadyHas) {
                    notifyWarning('U≈æ m√°≈° ' + item.name, 'M≈Ø≈æe≈° m√≠t pouze jeden');
                    return;
                }
            }
            
            if (state.money < item.traderPrice) {
                notifyWarning('Nedostatek penƒõz!');
                return;
            }
            
            if (!canAddItem(item, 1)) {
                notifyWarning(t('notifications', 'inventoryFull'));
                return;
            }
            
            state.money -= item.traderPrice;
            // P≈ôidej item s fromShop flagem
            const boughtItem = { ...item, fromShop: true, boughtPrice: item.traderPrice };
            addItemToInventory(boughtItem, 1);
            notifySuccess('Koupeno!', item.name);
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            // Odeber polo≈æku z nab√≠dky
            state.travelTraderItems.splice(idx, 1);
            
            // Znovu zobraz obchod
            const event = { icon: 'üß≥', name: 'Potuln√Ω obchodn√≠k', text: 'Co dal≈°√≠ho si p≈ôeje≈°?' };
            handleTraderEvent(event);
        }

        function fightTravelEnemy(enemyId) {
            closeModal();
            state.world.resumeAfterCombat = true;
            startCombat({id: enemyId});
        }
        
        function tryToFleeTravel(enemyId) {
            const fleeChance = 0.3 + (state.char.attrs.agi - 5) * 0.05;
            if (Math.random() < fleeChance) {
                const humor = getRandomHumor('fleeSuccess');
                notifySuccess('Utekl jsi!', humor);
                continueTravel();
            } else {
                const humor = getRandomHumor('fleeFail');
                notifyDanger('√ötƒõk selhal!', humor);
                fightTravelEnemy(enemyId);
            }
        }
        
        function continueTravel() {
            resolveCurrentEvent(); // Oznaƒç event jako vy≈ôe≈°en√Ω
            closeModal();
            renderFull();
        }
        
        // Zru≈°en√≠ cestov√°n√≠ - vr√°tit se zpƒõt
        function cancelTravel() {
            if (!state.world.traveling) return;
            
            // Zjisti odkud jsme vy≈°li (p≈ôedchoz√≠ lokace)
            const fromLocation = state.world.currentLocation;
            
            // Zru≈° cestov√°n√≠
            state.world.traveling = false;
            state.world.travelTo = null;
            state.world.travelPath = null;
            state.world.scheduledEvents = [];
            
            // Synchronizace pro zpƒõtnou kompatibilitu
            state.map.traveling = false;
            
            addLog('Vr√°til ses zpƒõt na ' + getLocName(fromLocation), '‚Ü©Ô∏è');
            notifyInfo('‚Ü©Ô∏è Cesta zru≈°ena', 'Vr√°til ses na ' + getLocName(fromLocation));
            
            renderFull();
        }
        
        function checkTravelComplete() {
            if (!state.world.traveling) return;
            
            const now = Date.now();
            if (now >= state.world.travelStart + state.world.travelDuration) {
                // Dorazili jsme
                state.world.traveling = false;
                state.world.currentLocation = state.world.travelTo;
                
                // P≈ôidej do nav≈°t√≠ven√Ωch
                const isNewLocation = !state.world.visitedLocations.includes(state.world.travelTo);
                if (isNewLocation) {
                    state.world.visitedLocations.push(state.world.travelTo);
                    notifySuccess('Nov√° lokace objevena!', WORLD_LOCATIONS.find(l => l.id === state.world.travelTo)?.name);
                    
                    // Daily quest progress - explored (pouze nov√©)
                    if (state.dailyQuests.progress) {
                        state.dailyQuests.progress.explored = (state.dailyQuests.progress.explored || 0) + 1;
                        checkDailyQuests();
                    }
                    
                    // Update Settler quest progress (patrol - prozkoumej X lokac√≠)
                    if (state.settlement?.activeQuests) {
                        state.settlement.activeQuests.forEach(sq => {
                            const questDef = SETTLER_QUESTS.find(q => q.id === sq.questId);
                            if (questDef?.request?.action === 'explore') {
                                if (!sq.progress) sq.progress = {};
                                sq.progress.explored = (sq.progress.explored || 0) + 1;
                            }
                        });
                    }
                }
                
                // === UPDATE NPC QUEST PROGRESS (pro KA≈ΩDOU cestu) ===
                if (state.npcQuests) {
                    Object.keys(state.npcQuests).forEach(npcId => {
                        const quest = state.npcQuests[npcId];
                        if (!quest || !quest.id) return;
                        
                        const questDef = NPC_QUESTS[quest.id];
                        if (!questDef || !questDef.requirement) return;
                        
                        // Zajisti ≈æe progress existuje
                        if (!quest.progress) {
                            quest.progress = { explored: 0, kills: 0, escortLocations: 0, travels: 0 };
                        }
                        
                        // EXPLORE questy - poƒç√≠t√° JAK√âKOLIV nav≈°t√≠ven√© lokace (ne jen nov√©)
                        // Proto≈æe hr√°ƒç m≈Ø≈æe m√≠t quest "prozkoumej 3 lokace" i kdy≈æ u≈æ lokace nav≈°t√≠vil
                        if (questDef.requirement.explore) {
                            quest.progress.explored = (quest.progress.explored || 0) + 1;
                            console.log(`üó∫Ô∏è Explore progress pro ${quest.id}: ${quest.progress.explored}/${questDef.requirement.explore}`);
                        }
                        
                        // ESCORT questy - poƒç√≠t√° ka≈ædou cestu
                        if (questDef.requirement.escort) {
                            quest.progress.escortLocations = (quest.progress.escortLocations || 0) + 1;
                            console.log(`üê™ Escort progress pro ${quest.id}: ${quest.progress.escortLocations}/${questDef.requirement.travels || 3}`);
                        }
                        
                        // TRAVELS questy (nap≈ô. deliver_package - nav≈°tiv X lokac√≠)
                        if (questDef.requirement.travels && !questDef.requirement.escort) {
                            quest.progress.travels = (quest.progress.travels || 0) + 1;
                            console.log(`üö∂ Travels progress pro ${quest.id}: ${quest.progress.travels}/${questDef.requirement.travels}`);
                        }
                        
                        // VISIT questy - nav≈°tiv konkr√©tn√≠ lokaci
                        if (questDef.requirement.visit && state.world.currentLocation === questDef.requirement.visit) {
                            quest.progress.visited = true;
                            console.log(`üìç Visit quest ${quest.id} splnƒõn - dos√°hl lokace ${questDef.requirement.visit}`);
                            notifySuccess('Quest progress!', `Dos√°hl jsi c√≠lov√© lokace`);
                        }
                    });
                }
                
                // Speci√°ln√≠ quest triggery p≈ôi pr≈Øzkumu
                checkSpecialQuestTriggers(state.world.currentLocation);
                
                travelEventTimeouts.forEach(t => clearTimeout(t));
                travelEventTimeouts = [];
                
                // Daily quest progress - travelled (ka≈æd√° cesta)
                if (!state.dailyQuests.progress) state.dailyQuests.progress = {};
                state.dailyQuests.progress.travelled = (state.dailyQuests.progress.travelled || 0) + 1;
                checkDailyQuests();
                
                const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
                notifyTravel(loc?.name || '???', loc?.icon || 'üìç');
                addLog('Dorazil na: ' + (loc?.name || '???'), '‚úÖ');
                
                // === V√ÅLEƒåN√Å Z√ìNA - zobraz UI pokud jsme na v√°leƒçn√© lokaci ===
                checkAndShowWarZone();
                
                // === KONTROLA POKLADU ===
                if (state.treasureLocation && state.treasureLocation.locationId === state.world.currentLocation) {
                    // Zkontroluj jestli nevypr≈°el
                    if (!state.treasureLocation.expiresAt || Date.now() < state.treasureLocation.expiresAt) {
                        // Nalezen poklad! Velk√© odmƒõny za cestu
                        const treasureRewards = [
                            { money: 500 + Math.floor(Math.random() * 500), xp: 150 + Math.floor(Math.random() * 100), tokens: 100 },
                            { money: 400 + Math.floor(Math.random() * 400), xp: 200, item: 'stimpak', itemCount: 3 },
                            { money: 800 + Math.floor(Math.random() * 700), xp: 250 },
                            { money: 300 + Math.floor(Math.random() * 300), xp: 100, tokens: 200 + Math.floor(Math.random() * 100), item: 'bandage', itemCount: 5 },
                            { money: 600 + Math.floor(Math.random() * 600), xp: 175, item: 'medkit', itemCount: 1 },
                            { money: 1000 + Math.floor(Math.random() * 500), xp: 300, tokens: 150 } // jackpot
                        ];
                        const reward = treasureRewards[Math.floor(Math.random() * treasureRewards.length)];
                        
                        // Dej odmƒõny
                        if (reward.money) state.money = (state.money || 0) + reward.money;
                        if (reward.xp) addXP(reward.xp);
                        if (reward.tokens) addCasinoTokens(reward.tokens);
                        if (reward.item) {
                            const itemDef = ITEMS.find(i => i.id === reward.item);
                            if (itemDef) {
                                for (let i = 0; i < (reward.itemCount || 1); i++) {
                                    state.inv.push({...itemDef, count: 1});
                                }
                            }
                        }
                        
                        // Sma≈æ poklad
                        const treasureName = state.treasureLocation.locationName;
                        state.treasureLocation = null;
                        state.stats = state.stats || {};
                        state.stats.treasuresFound = (state.stats.treasuresFound || 0) + 1;
                        
                        setTimeout(() => {
                            const itemInfo = reward.item ? ITEMS.find(i => i.id === reward.item) : null;
                            showModal('üíé POKLAD NALEZEN!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem; margin-bottom: 1rem;">üíéüéâ</div>
                                    <h3 style="color: #ffd700; margin-bottom: 1rem;">Na≈°el jsi poklad!</h3>
                                    <p style="color: #888; margin-bottom: 1rem;">Ukryt√Ω v lokaci ${treasureName}</p>
                                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; border: 2px solid #4caf50;">
                                        ${reward.money ? `<p style="color: #ffd700; font-size: 1.3rem; font-weight: bold;">+${reward.money} üí∞</p>` : ''}
                                        ${reward.xp ? `<p style="color: #8bc34a; font-size: 1.1rem;">+${reward.xp} XP</p>` : ''}
                                        ${reward.tokens ? `<p style="color: #9c27b0; font-size: 1.1rem;">+${reward.tokens} üé´</p>` : ''}
                                        ${itemInfo ? `<p style="color: #64b5f6;">+${reward.itemCount || 1}x ${itemInfo.icon} ${itemInfo.name}</p>` : ''}
                                    </div>
                                </div>
                                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">Super!</button>
                            `);
                        }, 1000);
                        
                        saveGame(true);
                    } else {
                        // Poklad vypr≈°el
                        state.treasureLocation = null;
                    }
                }
                
                // Syst√©mov√° notifikace
                sendSystemNotification('Dorazil jsi!', loc?.name || 'Nov√° lokace', 'üìç');
                MobileNotifications.notifyTravelComplete(loc?.name || 'Nov√° lokace');
                
                // Quest notifikace - upozornƒõn√≠ na questy na t√©to lokaci
                setTimeout(() => {
                    checkQuestNotifications(state.world.currentLocation);
                }, 1500);
                
                // Speci√°ln√≠ uv√≠t√°n√≠ pro Buƒçovice
                if (state.world.currentLocation === 'bucovice') {
                    setTimeout(() => {
                        showBucoviceWelcome();
                    }, 800);
                }
                
                // XP za cestu
                addXP(5 + Math.floor(Math.random() * 10));
                
                // Radiace na nebezpeƒçn√Ωch lokac√≠ch (men≈°√≠ d√°vka p≈ôi p≈ô√≠jezdu)
                if (loc?.radiation) {
                    // Radiace je per-minute, p≈ôi p≈ô√≠jezdu dostane≈° jen zlomek
                    let radGain = Math.ceil(loc.radiation * 0.2); // 20% z hodnoty
                    // Mutant class: -50% radiace
                    if (state.char.class === 'mutant') {
                        radGain = Math.floor(radGain * 0.5);
                    }
                    // Mutace Radiaƒçn√≠ adaptace: -70% radiace
                    if (state.mutations?.includes('radiation_adaptation')) {
                        radGain = Math.floor(radGain * 0.3);
                    }
                    if (radGain > 0) {
                        state.status.radiation = Math.min(100, state.status.radiation + radGain);
                        notifyWarning('Radiace!', '+' + radGain + ' ‚ò¢Ô∏è');
                    }
                }
                
                state.world.travelTo = null;
                state.world.travelPath = null;
                
                // Synchronizace pro zpƒõtnou kompatibilitu
                state.map.traveling = false;
                state.map.inBase = (state.world.currentLocation === 'shelter');
                
                // Aktualizuj quest progress
                updateQuestProgress('location', state.world.currentLocation);
                updateQuestProgress('visit_locations', state.world.visitedLocations.length);
                
                // Kontrola timed a companion quest≈Ø
                checkTimedQuestObjectives('location', state.world.currentLocation);
                checkCompanionQuestObjectives('location', state.world.currentLocation);
                
                // Kontrola daily quest≈Ø
                checkDailyQuests();
                
                // Kontrola achievement≈Ø po cestƒõ
                checkAchievements();
                
                renderFull();
            }
        }
        
        // Sb√≠r√°n√≠ zdroj≈Ø na resource lokac√≠ch
        function gatherResources(skipLimitCheck = false) {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            // Povolit sb√≠r√°n√≠ pro resource lokace NEBO pro lesn√≠ lokace
            const isForest = loc && (loc.id === 'forest_edge' || loc.id === 'dense_forest' || loc.icon === 'üå≤' || loc.icon === 'üå≥');
            if (!loc || (loc.type !== 'resource' && !isForest)) return;
            
            // Kontrola denn√≠ho limitu (3x za 24 hodin) - p≈ôeskoƒçit pokud vol√°no z executeGathering
            if (!skipLimitCheck) {
                const limit = checkDailyActionLimit('gather', loc.id);
                if (!limit.canDo) {
                    const hours = Math.ceil(limit.resetIn / (1000 * 60 * 60));
                    notifyWarning('Vyƒçerp√°no', 'Tato lokace je vyƒçerpan√°. Reset za ' + hours + ' hodin.');
                    return;
                }
                // Pou≈æij limit
                useActionLimit('gather', loc.id);
            }
            
            state.status.energy = Math.max(0, state.status.energy - 5);
            
            // Sb√≠r√°n√≠ podle lokace
            let gathered = [];
            
            if (loc.id === 'berry_bushes') {
                // Bobule a byliny
                const berries = 2 + Math.floor(Math.random() * 3);
                const herbs = 1 + Math.floor(Math.random() * 2);
                state.resources.herbs = (state.resources.herbs || 0) + herbs;
                gathered.push({ name: 'Byliny', amount: herbs, icon: 'üåø' });
                
                // P≈ôidej j√≠dlo (bobule)
                const berryItem = { id: 'berries', name: 'Bor≈Øvky', icon: 'ü´ê', type: 'consumable', effect: 'hunger', value: 15, weight: 0.2, count: berries };
                const existing = state.inv.find(i => i.id === 'berries');
                if (existing) {
                    existing.count = (existing.count || 1) + berries;
                } else {
                    state.inv.push(berryItem);
                }
                gathered.push({ name: 'Bor≈Øvky', amount: berries, icon: 'ü´ê' });
            } else if (loc.id === 'water_well') {
                // Voda
                const water = 2 + Math.floor(Math.random() * 2);
                const waterItem = { id: 'water', name: 'L√°hev vody', icon: 'üíß', type: 'consumable', effect: 'thirst', value: 40, weight: 1, count: water };
                const existing = state.inv.find(i => i.id === 'water');
                if (existing) {
                    existing.count = (existing.count || 1) + water;
                } else {
                    state.inv.push(waterItem);
                }
                gathered.push({ name: 'L√°hev vody', amount: water, icon: 'üíß' });
            } else if (loc.id === 'forest_edge') {
                // D≈ôevo a byliny
                const wood = 3 + Math.floor(Math.random() * 3);
                const herbs = 1 + Math.floor(Math.random() * 2);
                state.resources.wood = (state.resources.wood || 0) + wood;
                state.resources.herbs = (state.resources.herbs || 0) + herbs;
                gathered.push({ name: 'D≈ôevo', amount: wood, icon: 'üå≤' });
                gathered.push({ name: 'Byliny', amount: herbs, icon: 'üåø' });
            } else if (loc.id === 'dense_forest') {
                // Hust√Ω les - v√≠ce d≈ôeva, mo≈æn√° k≈Ø≈æe
                const wood = 4 + Math.floor(Math.random() * 4);
                const herbs = 2 + Math.floor(Math.random() * 2);
                state.resources.wood = (state.resources.wood || 0) + wood;
                state.resources.herbs = (state.resources.herbs || 0) + herbs;
                gathered.push({ name: 'D≈ôevo', amount: wood, icon: 'üå≤' });
                gathered.push({ name: 'Byliny', amount: herbs, icon: 'üåø' });
                // ≈†ance na k≈Ø≈æi (spadan√© vƒõtve s mechem)
                if (Math.random() < 0.3) {
                    state.resources.leather = (state.resources.leather || 0) + 1;
                    gathered.push({ name: 'K≈Ø≈æe', amount: 1, icon: 'ü¶¥' });
                }
            } else if (loc.resource === 'stone' || loc.id === 'quarry_01') {
                // K√°men a ruda
                const stone = 4 + Math.floor(Math.random() * 4);
                const metal = Math.floor(Math.random() * 3);
                state.resources.stone = (state.resources.stone || 0) + stone;
                gathered.push({ name: 'K√°men', amount: stone, icon: 'ü™®' });
                if (metal > 0) {
                    state.resources.metal = (state.resources.metal || 0) + metal;
                    gathered.push({ name: '≈Ωelezo', amount: metal, icon: '‚öôÔ∏è' });
                }
                // Mal√° ≈°ance na mƒõƒè
                if (Math.random() < 0.15) {
                    state.resources.copper = (state.resources.copper || 0) + 1;
                    gathered.push({ name: 'Mƒõƒè', amount: 1, icon: 'üî∂' });
                }
            } else {
                // Obecn√© - n√°hodn√© suroviny
                const resources = ['wood', 'stone', 'cloth', 'herbs'];
                const resId = resources[Math.floor(Math.random() * resources.length)];
                const amount = 2 + Math.floor(Math.random() * 3);
                state.resources[resId] = (state.resources[resId] || 0) + amount;
                const icons = { wood: 'üå≤', stone: 'ü™®', cloth: 'üßµ', herbs: 'üåø' };
                const names = { wood: 'D≈ôevo', stone: 'K√°men', cloth: 'L√°tka', herbs: 'Byliny' };
                gathered.push({ name: names[resId], amount: amount, icon: icons[resId] });
            }
            
            // Zobraz v√Ωsledek
            const remainingLimit = checkDailyActionLimit('gather', loc.id);
            let resultHtml = '<div style="text-align: center;">';
            resultHtml += '<div style="font-size: 3rem; margin-bottom: 1rem;">üß∫</div>';
            resultHtml += '<h3 style="color: var(--toxic-green);">Nasb√≠r√°no!</h3>';
            resultHtml += '<div style="margin: 1rem 0;">';
            gathered.forEach(g => {
                resultHtml += '<p>' + g.icon + ' ' + g.name + ': <strong>+' + g.amount + '</strong></p>';
            });
            resultHtml += '</div>';
            resultHtml += '<p style="color: #888; font-size: 0.85rem;">Zb√Ωv√° pokus≈Ø: ' + remainingLimit.remaining + '/3</p>';
            resultHtml += '</div>';
            if (remainingLimit.canDo) {
                resultHtml += '<button class="btn" onclick="closeModal(); showActionModal(\'gather\');" style="width: 100%; margin-top: 0.5rem;">üß∫ Sb√≠rat znovu</button>';
            }
            resultHtml += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #333;">OK</button>';
            
            showModal('üß∫ Sb√≠r√°n√≠', resultHtml);
            addXP(3 + Math.floor(Math.random() * 5));
            updateCarryWeight();
            renderFull();
        }
        
        // Pr≈Øzkum nebezpeƒçn√© oblasti
        function exploreDangerousArea() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            // Cooldown
            const cooldownKey = 'dangerous_' + loc.id;
            const lastExplore = state.world.locationCooldowns[cooldownKey] || 0;
            const cooldownTime = 10 * 60 * 1000; // 10 minut
            const now = Date.now();
            
            if (now - lastExplore < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastExplore)) / 1000);
                const mins = Math.floor(remaining / 60);
                notifyWarning('Nebezpeƒç√≠!', 'Poƒçkej ' + mins + ' min');
                return;
            }
            
            state.world.locationCooldowns[cooldownKey] = now;
            
            // Radiace
            const radGain = loc.radiation || 10;
            state.status.radiation = Math.min(100, state.status.radiation + radGain);
            
            // N√°hodn√Ω v√Ωsledek
            const roll = Math.random();
            if (roll < 0.4) {
                // Boj
                const enemyId = loc.enemies?.[Math.floor(Math.random() * loc.enemies.length)] || 'mutant';
                showModal('‚ö†Ô∏è Nebezpeƒç√≠!', 
                    '<p>V nebezpeƒçn√© oblasti jsi narazil na nep≈ô√≠tele!</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' ‚ò¢Ô∏è radiace</p>' +
                    '<button class="btn" onclick="closeModal(); startCombat({id: \'' + enemyId + '\'});" style="width: 100%; margin-top: 1rem; background: #8B0000;">‚öîÔ∏è Bojovat</button>'
                );
            } else if (roll < 0.7) {
                // Vz√°cn√Ω loot
                const rareItems = ['radaway', 'stimpack', 'electronics', 'chemicals'];
                const itemId = rareItems[Math.floor(Math.random() * rareItems.length)];
                state.resources[itemId] = (state.resources[itemId] || 0) + 1;
                showModal('üíé Vz√°cn√Ω n√°lez!', 
                    '<p>V nebezpeƒçn√© oblasti jsi na≈°el nƒõco cenn√©ho!</p>' +
                    '<p style="color: #8bc34a;">+1 ' + itemId + '</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' ‚ò¢Ô∏è radiace</p>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
                );
                addXP(20);
            } else {
                // Nic
                showModal('‚ò¢Ô∏è Pr√°zdno', 
                    '<p>Nic zaj√≠mav√©ho jsi nena≈°el, jen radiaci...</p>' +
                    '<p style="color: #ff9800;">+' + radGain + ' ‚ò¢Ô∏è radiace</p>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
                );
            }
            renderFull();
        }
        
        // Odpoƒçinek v t√°bo≈ôe
        function showRestInfo() {
            const hpGain = 20;
            const energyGain = 30;
            
            showModal('üí§ Odpoƒçinek', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">‚õ∫</div>
                    <p style="color: #888;">Odpoƒçi≈à si v bezpeƒç√≠ osady.</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">Co z√≠sk√°≈°:</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.3rem; font-size: 0.9rem;">
                        <div>‚ù§Ô∏è +${hpGain} HP</div>
                        <div>‚ö° +${energyGain} Energie</div>
                        <div>üçñ -10 Hlad</div>
                        <div>üíß -10 ≈Ω√≠ze≈à</div>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal(); restAtCamp();" style="width: 100%; background: #3949AB;">
                    üí§ Odpoƒçinout
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    ‚úó Zru≈°it
                </button>
            `);
        }
        
        function restAtCamp() {
            const energyCost = 0;
            const hpGain = 20;
            const energyGain = 30;
            
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + hpGain);
            state.status.energy = Math.min(100, state.status.energy + energyGain);
            state.status.hunger = Math.max(0, state.status.hunger - 10);
            state.status.thirst = Math.max(0, state.status.thirst - 10);
            
            showModal('üí§ Odpoƒçinek', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">‚õ∫</div>' +
                '<h3>Odpoƒçinul sis v t√°bo≈ôe</h3>' +
                '<p style="color: #8bc34a;">+' + hpGain + ' HP, +' + energyGain + ' energie</p>' +
                '<p style="color: #ff9800;">-10 hlad, -10 ≈æ√≠ze≈à</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
            );
            addLog('Odpoƒçinek v t√°bo≈ôe', '‚õ∫');
            renderFull();
        }
        
        // T√°bor√°k
        function makeCampfire() {
            const woodCost = 3;
            const currentWood = state.resources.wood || 0;
            
            if (currentWood < woodCost) {
                notifyWarning('Nedostatek', `Pot≈ôebuje≈° ${woodCost} d≈ôeva (m√°≈° ${currentWood})`);
                return;
            }
            
            // Zobraz potvrzovac√≠ dialog
            showModal('üî• Rozdƒõlat t√°bor√°k?', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üî•</div>
                    <p style="color: #888;">Rozdƒõl√°≈° ohe≈à a m≈Ø≈æe≈° va≈ôit j√≠dlo.</p>
                </div>
                
                <div style="background: #2a1a0a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #E65100;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #ff9800;">üå≤ Cena:</span>
                        <span style="color: #fff; font-weight: bold;">${woodCost} d≈ôeva</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <span style="color: #888;">M√°≈°:</span>
                        <span style="color: ${currentWood >= woodCost ? '#8bc34a' : '#f44336'};">${currentWood} d≈ôeva</span>
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.9rem;">‚úì Bonus: +20 n√°lada</p>
                    <p style="color: #ff9800; margin: 0.3rem 0 0 0; font-size: 0.9rem;">üç≥ Umo≈æn√≠ va≈ôen√≠ j√≠dla</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="confirmCampfire()" style="background: #E65100;">üî• Rozdƒõlat</button>
                </div>
            `);
        }
        
        function confirmCampfire() {
            if ((state.resources.wood || 0) < 3) {
                notifyWarning('Nedostatek', 'Pot≈ôebuje≈° 3 d≈ôeva');
                closeModal();
                return;
            }
            
            state.resources.wood -= 3;
            state.status.mood = Math.min(100, (state.status.mood || 50) + 20);
            
            showModal('üî• T√°bor√°k ho≈ô√≠!', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">üî•</div>' +
                '<h3 style="color: #8bc34a;">Rozdƒõlal jsi ohe≈à</h3>' +
                '<p style="color: #8bc34a;">+20 n√°lada</p>' +
                '<p style="color: #888; font-size: 0.85rem;">-3 d≈ôeva</p>' +
                '<p style="margin-top: 1rem; color: #ff9800;">Teƒè m≈Ø≈æe≈° va≈ôit!</p>' +
                '</div>' +
                '<button class="btn" onclick="openCookingMenu()" style="width: 100%; margin-top: 0.5rem; background: #E65100;">üç≥ Va≈ôit</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó Zav≈ô√≠t</button>'
            );
            renderFull();
        }
        
        // Mluvit s NPC na lokaci
        function talkToLocationNPC() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            // Najdi STORY_NPC na t√©to lokaci
            for (const [npcId, npc] of Object.entries(STORY_NPCS)) {
                if (npc.location === loc.id) {
                    // V≈Ødce p≈ôe≈æiv≈°√≠ch jen po dokonƒçen√≠ p≈ô√≠bƒõhu
                    if (npcId === 'survivor_leader' && !state.mainQuest?.storyComplete) continue;
                    
                    // Gener√°l jen pokud m√°me spr√°vn√Ω quest
                    if (npcId === 'general' && state.mainQuest?.currentQuest !== 'find_general') continue;
                    
                    // Na≈°li jsme NPC - zavolej talkToNPC
                    talkToNPC(npcId);
                    return;
                }
            }
            
            // Hermit/Poustevn√≠k - speci√°ln√≠ NPC
            if (loc.id === 'hermit_hut') {
                showModal('üßô Poustevn√≠k', 
                    '<div style="text-align: center;">' +
                    '<div style="font-size: 3rem;">üßô</div>' +
                    '<p>"Ahoj, poutn√≠ku. Jsem tu s√°m u≈æ mnoho let..."</p>' +
                    '<p>"Mohu ti nab√≠dnout moudrost, nebo l√©ƒçen√≠."</p>' +
                    '</div>' +
                    '<button class="btn" onclick="hermitHeal()" style="width: 100%; margin-top: 0.5rem; background: #c62828;">üíä L√©ƒçen√≠ (50üí∞)</button>' +
                    '<button class="btn" onclick="hermitWisdom()" style="width: 100%; margin-top: 0.5rem; background: #9C27B0;">üìú Moudrost</button>' +
                    '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">‚úó Odej√≠t</button>'
                );
                return;
            }
            
            // Potuln√Ω obchodn√≠k - speci√°ln√≠ exotick√© zbo≈æ√≠
            if (loc.id === 'wandering_merchant') {
                openExoticShop();
                return;
            }
            
            // ≈Ω√°dn√Ω NPC nenalezen
            showModal('ü§∑ Nikdo tu nen√≠', 
                '<p>Na t√©to lokaci nen√≠ nikdo, s k√Ωm bys mohl mluvit.</p>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
            );
        }
        
        function hermitHeal() {
            if (getMoney() < 50) {
                notifyWarning('Nedostatek', 'Pot≈ôebuje≈° 50 üí∞');
                return;
            }
            removeMoney(50);
            state.char.hp = state.char.maxHp;
            state.status.radiation = 0;
            closeModal();
            notifySuccess('Vyl√©ƒçen!', 'Pln√© HP, 0 radiace');
            renderFull();
        }
        
        function hermitWisdom() {
            const wisdoms = [
                "V pustinƒõ p≈ôe≈æije ten, kdo um√≠ ƒçekat.",
                "Voda je cennƒõj≈°√≠ ne≈æ zlato.",
                "Nikdy necestuj v noci bez svƒõtla.",
                "Mutanti se boj√≠ ohnƒõ.",
                "Ka≈æd√Ω nep≈ô√≠tel m√° slabinu."
            ];
            const wisdom = wisdoms[Math.floor(Math.random() * wisdoms.length)];
            addXP(10);
            showModal('üìú Moudrost', 
                '<div style="text-align: center;">' +
                '<p style="font-style: italic; color: #9C27B0;">"' + wisdom + '"</p>' +
                '<p style="color: #8bc34a; margin-top: 1rem;">+10 XP</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>'
            );
        }
        
        // === POTULN√ù OBCHODN√çK - VYLEP≈†EN√â EXOTICK√â ZBO≈Ω√ç ===
        const EXOTIC_ITEMS = [
            { id: 'ancient_map', name: 'Star√° mapa', icon: 'üó∫Ô∏è', price: 400, desc: 'Odhal√≠ 3 n√°hodn√© lokace', effect: 'reveal_locations', rarity: 'rare' },
            { id: 'mysterious_serum', name: 'Z√°hadn√© s√©rum', icon: 'üíâ', price: 750, desc: '+5 max HP trvale', effect: 'permanent_hp', rarity: 'epic' },
            { id: 'traders_compass', name: 'Obchodnick√Ω kompas', icon: 'üß≠', price: 500, desc: '-10% n√°kupn√≠ ceny trvale', effect: 'shop_discount', rarity: 'rare' },
            { id: 'lucky_coin', name: '≈†≈•astn√° mince', icon: 'ü™ô', price: 450, desc: '+15% ≈°ance na lep≈°√≠ loot', effect: 'luck_bonus', rarity: 'rare' },
            { id: 'mutant_gland', name: 'Mutant√≠ ≈æl√°za', icon: 'üß¨', price: 800, desc: 'Imunita v≈Øƒçi 1 mutaci', effect: 'mutation_resist', rarity: 'epic' },
            { id: 'pre_war_tech', name: 'P≈ôedv√°leƒçn√° tech', icon: 'üìü', price: 1000, desc: '+25% XP na 48 hodin', effect: 'xp_boost', rarity: 'epic' },
            { id: 'exotic_spice', name: 'Exotick√© ko≈ôen√≠', icon: 'üå∂Ô∏è', price: 200, desc: 'Dvojn√°sobn√Ω efekt j√≠dla (5x)', effect: 'food_boost', rarity: 'uncommon' },
            { id: 'caravan_whistle', name: 'Karavann√≠ p√≠≈°≈•alka', icon: 'üéµ', price: 600, desc: 'P≈ôivol√° karavanu kamkoliv (3x)', effect: 'summon_caravan', rarity: 'rare' },
            { id: 'radiation_talisman', name: 'Radiaƒçn√≠ talisman', icon: '‚ò¢Ô∏è', price: 700, desc: '-50% radiace trvale', effect: 'rad_resist', rarity: 'epic' },
            { id: 'legendary_blueprint', name: 'Legend√°rn√≠ pl√°n', icon: 'üìú', price: 1500, desc: 'Nauƒç√≠ legendary recept', effect: 'learn_recipe', rarity: 'legendary' },
            { id: 'enhanced_stimpack', name: 'Vylep≈°en√Ω stimpak', icon: 'üíâ', price: 300, desc: 'L√©ƒç√≠ 200 HP (3x)', effect: 'super_heal', rarity: 'rare' },
            { id: 'void_crystal', name: 'Krystal pr√°zdnoty', icon: 'üíé', price: 1200, desc: '+10% v≈°echen damage trvale', effect: 'damage_boost', rarity: 'legendary' }
        ];
        
        function generateWanderingStock() {
            // Generuj z√°soby - 4-5 n√°hodn√Ωch polo≈æek s mno≈æstv√≠m 1
            const shuffled = [...EXOTIC_ITEMS].sort(() => Math.random() - 0.5);
            const count = 4 + Math.floor(Math.random() * 2);
            const stock = {};
            
            shuffled.slice(0, count).forEach(item => {
                stock[item.id] = 1; // Ka≈æd√Ω item jen 1x
            });
            
            return stock;
        }
        
        function openExoticShop() {
            // Kontrola otev√≠rac√≠ doby
            if (!isShopOpen('wandering')) {
                showModal('üåô Obchodn√≠k odpoƒç√≠v√°', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üê™üí§</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Potuln√Ω obchodn√≠k odpoƒç√≠v√°!</p>
                        <p style="color: #888; margin: 1rem 0;">‚è∞ Otev√≠rac√≠ doba: 10:00 - 16:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu√°ln√≠ ƒças: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                        <p style="color: #555; font-size: 0.8rem; margin-top: 0.5rem;">üí° Obchodn√≠k cestuje brzy r√°no a veƒçer.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Inicializuj nebo resetuj z√°soby ka≈æd√© 3 dny
            const now = Date.now();
            const threeDays = 3 * 24 * 60 * 60 * 1000;
            
            if (!state.wanderingMerchant || (now - (state.wanderingMerchant.lastRestock || 0)) > threeDays) {
                state.wanderingMerchant = {
                    lastRestock: now,
                    stock: generateWanderingStock()
                };
            }
            
            const stock = state.wanderingMerchant.stock;
            const available = EXOTIC_ITEMS.filter(item => (stock[item.id] || 0) > 0);
            
            // ƒåas do resetu
            const nextRestock = new Date((state.wanderingMerchant.lastRestock || now) + threeDays);
            const hoursUntilRestock = Math.max(0, Math.ceil((nextRestock - now) / 3600000));
            const daysUntilRestock = Math.floor(hoursUntilRestock / 24);
            const remainingHours = hoursUntilRestock % 24;
            const restockText = daysUntilRestock > 0 
                ? `${daysUntilRestock}d ${remainingHours}h` 
                : `${remainingHours}h`;
            
            const rarityColors = {
                uncommon: '#4caf50',
                rare: '#2196f3', 
                epic: '#9c27b0',
                legendary: '#ffd700'
            };
            
            let itemsHtml = available.length > 0 ? available.map(item => {
                const canAfford = getMoney() >= item.price;
                const rarityColor = rarityColors[item.rarity] || '#888';
                return `
                    <div style="background: linear-gradient(135deg, #2a2a1a, #1a1a0a); padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; border: 2px solid ${rarityColor}; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-size: 1.3rem;">${item.icon} <span style="color: ${rarityColor};">${item.name}</span></div>
                            <div style="font-size: 0.8rem; color: #888;">${item.desc}</div>
                            <div style="font-size: 0.7rem; color: ${rarityColor}; text-transform: uppercase;">${item.rarity}</div>
                        </div>
                        <button class="btn" onclick="buyExoticItem('${item.id}')" style="background: ${canAfford ? rarityColor : '#333'}; color: ${canAfford ? '#fff' : '#666'}; ${!canAfford ? 'cursor: not-allowed;' : ''}">
                            üí∞ ${item.price}
                        </button>
                    </div>
                `;
            }).join('') : '<p style="text-align: center; color: #666; padding: 2rem;">Vyprod√°no! Vra≈• se za p√°r dn√≠.</p>';
            
            showModal('üê™ Potuln√Ω obchodn√≠k', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üê™</div>
                    <p style="color: #ffd700; font-style: italic;">"M√°m vz√°cn√© vƒõci, kter√© jinde nenajde≈°..."</p>
                    <p style="color: #888;">üí∞ Tv√© pen√≠ze: ${getMoney()}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #888; font-size: 0.8rem;">‚è∞ Otev≈ôeno: 10:00 - 16:00</span>
                    <span style="color: #ff9800; font-size: 0.8rem;">üîÑ Reset: ${restockText}</span>
                </div>
                
                <div style="max-height: 280px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${itemsHtml}
                </div>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.5rem;">‚ö†Ô∏è Omezen√© z√°soby! Ka≈æd√Ω item jen 1x za 3 dny.</p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Odej√≠t</button>
            `);
        }
        
        function buyExoticItem(itemId) {
            const item = EXOTIC_ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // Kontrola z√°sob
            if (!state.wanderingMerchant?.stock || (state.wanderingMerchant.stock[itemId] || 0) <= 0) {
                notifyWarning('Vyprod√°no!', 'Tento p≈ôedmƒõt u≈æ nem√°m');
                return;
            }
            
            if (getMoney() < item.price) {
                notifyWarning('M√°lo penƒõz!', `Pot≈ôebuje≈° ${item.price} üí∞`);
                return;
            }
            
            removeMoney(item.price);
            
            // Odeber ze z√°sob
            state.wanderingMerchant.stock[itemId]--;
            
            // Aplikuj efekt
            switch(item.effect) {
                case 'reveal_locations':
                    const unvisited = WORLD_LOCATIONS.filter(l => !state.world.visitedLocations?.includes(l.id) && l.type !== 'empty');
                    const toReveal = unvisited.slice(0, 3).map(l => l.id);
                    if (!state.world.revealedLocations) state.world.revealedLocations = [];
                    state.world.revealedLocations.push(...toReveal);
                    notifySuccess('Mapa pou≈æita!', `Odhaleno ${toReveal.length} lokac√≠`);
                    break;
                    
                case 'permanent_hp':
                    state.char.maxHp = (state.char.maxHp || 100) + 5;
                    state.char.hp = Math.min(state.char.hp + 5, state.char.maxHp);
                    notifySuccess('S√©rum √∫ƒçinkuje!', '+5 max HP trvale!');
                    break;
                    
                case 'shop_discount':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.shopDiscount = (state.exoticBonuses.shopDiscount || 0) + 0.1;
                    notifySuccess('Kompas aktivn√≠!', '-10% n√°kupn√≠ ceny trvale!');
                    break;
                    
                case 'luck_bonus':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.luck = (state.exoticBonuses.luck || 0) + 0.15;
                    notifySuccess('≈†tƒõst√≠!', '+15% ≈°ance na lep≈°√≠ loot (trvale)');
                    break;
                    
                case 'mutation_resist':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.mutationResist = (state.exoticBonuses.mutationResist || 0) + 1;
                    notifySuccess('Ochrana!', 'P≈ô√≠≈°t√≠ mutace bude zablokov√°na');
                    break;
                    
                case 'xp_boost':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.xpBoost = Date.now() + (48 * 60 * 60 * 1000);
                    notifySuccess('Tech aktivov√°na!', '+25% XP na 48 hodin');
                    break;
                    
                case 'food_boost':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.foodBoost = (state.exoticBonuses.foodBoost || 0) + 5;
                    notifySuccess('Ko≈ôen√≠!', 'Dal≈°√≠ch 5 j√≠del m√° dvojn√°sobn√Ω efekt');
                    break;
                    
                case 'summon_caravan':
                    // P≈ôidej do invent√°≈ôe jako pou≈æiteln√Ω p≈ôedmƒõt (3 pou≈æit√≠)
                    const existing = state.inv.find(i => i.id === 'caravan_whistle');
                    if (existing) {
                        existing.count = (existing.count || 1) + 3;
                    } else {
                        state.inv.push({ id: 'caravan_whistle', name: 'Karavann√≠ p√≠≈°≈•alka', icon: 'üéµ', type: 'consumable', count: 3, desc: 'P≈ôivol√° karavanu' });
                    }
                    notifySuccess('P√≠≈°≈•alka z√≠sk√°na!', '3x pou≈æit√≠ - p≈ôivol√° karavanu kamkoliv');
                    break;
                    
                case 'rad_resist':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.radResistPermanent = (state.exoticBonuses.radResistPermanent || 0) + 0.5;
                    notifySuccess('Talisman aktivn√≠!', '-50% radiace trvale!');
                    break;
                    
                case 'super_heal':
                    // P≈ôidej do invent√°≈ôe (3 pou≈æit√≠)
                    const existingStim = state.inv.find(i => i.id === 'enhanced_stimpack');
                    if (existingStim) {
                        existingStim.count = (existingStim.count || 1) + 3;
                    } else {
                        state.inv.push({ id: 'enhanced_stimpack', name: 'Vylep≈°en√Ω stimpak', icon: 'üíâ', type: 'consumable', effect: 'health', value: 200, count: 3, weight: 0.3 });
                    }
                    notifySuccess('Stimpaky z√≠sk√°ny!', '3x Vylep≈°en√Ω stimpak (200 HP)');
                    break;
                    
                case 'damage_boost':
                    state.exoticBonuses = state.exoticBonuses || {};
                    state.exoticBonuses.damageBoost = (state.exoticBonuses.damageBoost || 0) + 0.1;
                    notifySuccess('Krystal absorbov√°n!', '+10% v≈°echen damage trvale!');
                    break;
                    
                case 'learn_recipe':
                    // P≈ôidej n√°hodn√Ω legend√°rn√≠ recept
                    const legendaryRecipes = ['legendary_blade', 'power_armor', 'plasma_rifle'];
                    const recipe = legendaryRecipes[Math.floor(Math.random() * legendaryRecipes.length)];
                    state.learnedRecipes = state.learnedRecipes || [];
                    if (!state.learnedRecipes.includes(recipe)) {
                        state.learnedRecipes.push(recipe);
                        notifySuccess('Nov√Ω recept!', `Nauƒçil ses: ${recipe}`);
                    } else {
                        // Refund pokud u≈æ m√°
                        addMoney(item.price);
                        notifyInfo('U≈æ zn√°≈°', 'Tento recept u≈æ um√≠≈°, pen√≠ze vr√°ceny');
                    }
                    break;
            }
            
            closeModal();
            renderFull();
        }
        
        // Nav≈°t√≠vit osadu p≈ôe≈æiv≈°√≠ch
        function visitSettlement() {
            showModal('üèòÔ∏è Osada p≈ôe≈æiv≈°√≠ch', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">üèòÔ∏è</div>' +
                '<p>Mal√° komunita p≈ôe≈æiv≈°√≠ch tƒõ v√≠t√°.</p>' +
                '<p style="color: #888;">M≈Ø≈æe≈° zde obchodovat a odpoƒç√≠vat.</p>' +
                '</div>' +
                '<button class="btn" onclick="openShop()" style="width: 100%; margin-top: 0.5rem; background: var(--rust-light);">üõí Obchod</button>' +
                '<button class="btn" onclick="restAtCamp()" style="width: 100%; margin-top: 0.5rem; background: #3949AB;">üí§ Odpoƒçinek</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">‚úó Odej√≠t</button>'
            );
        }
        
        // ƒåerpat palivo
        function collectFuel() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            // Cooldown
            const cooldownKey = 'fuel_' + loc.id;
            const lastCollect = state.world.locationCooldowns[cooldownKey] || 0;
            const cooldownTime = 5 * 60 * 1000;
            const now = Date.now();
            
            if (now - lastCollect < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastCollect)) / 1000);
                const mins = Math.floor(remaining / 60);
                notifyWarning('ƒåekej', 'Poƒçkej ' + mins + ' min');
                return;
            }
            
            state.world.locationCooldowns[cooldownKey] = now;
            
            const amount = 2 + Math.floor(Math.random() * 3);
            state.resources.fuel = (state.resources.fuel || 0) + amount;
            
            showModal('‚õΩ Palivo', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 3rem;">‚õΩ</div>' +
                '<h3>Naƒçerpal jsi palivo!</h3>' +
                '<p style="color: #8bc34a;">+' + amount + ' paliva</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%;">OK</button>'
            );
            addXP(5);
            renderFull();
        }

        function exploreLocation(skipLimitCheck = false) {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) {
                console.log('exploreLocation: No location found');
                return;
            }
            
            console.log('exploreLocation called for:', loc.name, 'skipLimitCheck:', skipLimitCheck);
            
            // Kontrola denn√≠ho limitu (3x za 24 hodin) - p≈ôeskoƒçit pokud vol√°no z executeExploring
            if (!skipLimitCheck) {
                const limit = checkDailyActionLimit('explore', loc.id);
                if (!limit.canDo) {
                    const hours = Math.floor(limit.resetIn / 3600000);
                    const mins = Math.floor((limit.resetIn % 3600000) / 60000);
                    notifyWarning('Lokace vyƒçerpan√°', `U≈æ jsi prozkoumal 3x. Dal≈°√≠ za ${hours}h ${mins}m`);
                    return;
                }
                
                // Cooldown check - 5 minut mezi pr≈Øzkumy
                const cooldownKey = 'explore_' + loc.id;
                const now = Date.now();
                const lastExplore = state.world.locationCooldowns?.[cooldownKey] || 0;
                const cooldownTime = 5 * 60 * 1000; // 5 minut
                
                if (now - lastExplore < cooldownTime) {
                    const remaining = Math.ceil((cooldownTime - (now - lastExplore)) / 1000);
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    notifyWarning('Poƒçkej chv√≠li', `Dal≈°√≠ pr≈Øzkum za ${mins}:${String(secs).padStart(2, '0')}`);
                    return;
                }
                
                // Pou≈æij limit a nastav cooldown
                useActionLimit('explore', loc.id);
                if (!state.world.locationCooldowns) state.world.locationCooldowns = {};
                state.world.locationCooldowns[cooldownKey] = now;
            }
            
            // Kontrola quest item≈Ø na t√©to lokaci
            if (state.world.questItems && state.world.questItems[loc.id]) {
                const questItemId = state.world.questItems[loc.id];
                const questItem = QUEST_ITEMS.find(i => i.id === questItemId);
                if (questItem) {
                    // Nalezen quest item! (quest itemy maj√≠ v≈ædy p≈ôednost - nulov√° v√°ha)
                    delete state.world.questItems[loc.id];
                    const questItemCopy = {...questItem, count: 1, weight: 0}; // Quest itemy nev√°≈æ√≠
                    state.inv.push(questItemCopy);
                    updateQuestProgress('item', questItemId);
                    
                    showModal('üìú Quest p≈ôedmƒõt nalezen!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">${questItem.icon}</div>
                            <h3 style="color: #ffd700;">${questItem.name}</h3>
                            <p style="color: #888;">${questItem.desc || ''}</p>
                            <p style="color: #8bc34a; margin-top: 1rem;">P≈ôedmƒõt p≈ôid√°n do invent√°≈ôe!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">‚úì V√Ωbornƒõ!</button>
                    `);
                    addLog('Nalezen quest p≈ôedmƒõt: ' + questItem.name, 'üìú');
                    renderFull();
                    return;
                }
            }
            
            // === COMPANION QUEST ITEMS ===
            // Kontrola companion quest item≈Ø spawnovan√Ωch na t√©to lokaci
            if (state.world.questItemSpawns) {
                for (const [itemId, spawnData] of Object.entries(state.world.questItemSpawns)) {
                    if (spawnData.location === loc.id) {
                        const questItem = QUEST_ITEMS.find(i => i.id === itemId);
                        if (questItem && !state.inv.some(i => i.id === itemId)) {
                            // 50% ≈°ance naj√≠t companion quest item
                            if (Math.random() < 0.5) {
                                // Nalezen!
                                delete state.world.questItemSpawns[itemId];
                                const questItemCopy = {...questItem, count: 1, weight: 0};
                                state.inv.push(questItemCopy);
                                
                                // Update companion quest objective
                                const comp = state.companions?.find(c => c.id === spawnData.companion);
                                if (comp?.activeQuest) {
                                    comp.activeQuest.objectives.forEach(obj => {
                                        if (obj.target === itemId) {
                                            obj.completed = true;
                                        }
                                    });
                                }
                                
                                showModal('üíù Companion Quest Item!', `
                                    <div style="text-align: center;">
                                        <div style="font-size: 4rem; margin-bottom: 1rem;">${questItem.icon}</div>
                                        <h3 style="color: #e91e63;">${questItem.name}</h3>
                                        <p style="color: #888;">${questItem.desc || ''}</p>
                                        <p style="color: #8bc34a; margin-top: 1rem;">Pro quest spoleƒçn√≠ka!</p>
                                    </div>
                                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #e91e63;">‚úì V√Ωbornƒõ!</button>
                                `);
                                addLog('Nalezen p≈ôedmƒõt pro spoleƒçn√≠ka: ' + questItem.name, 'üíù');
                                renderFull();
                                return;
                            }
                        }
                    }
                }
            }
            
            // Kontrola detektivn√≠ch stop na t√©to lokaci
            if (state.detectiveQuests) {
                Object.entries(state.detectiveQuests).forEach(([questId, dq]) => {
                    if (dq.solved) return;
                    const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
                    if (!quest) return;
                    
                    // Hledej stopy na t√©to lokaci
                    Object.entries(quest.clueLocations).forEach(([clueId, clueLoc]) => {
                        if (clueLoc === loc.id && !dq.cluesFound.includes(clueId)) {
                            // 40% ≈°ance naj√≠t stopu p≈ôi pr≈Øzkumu
                            if (Math.random() < 0.4) {
                                findClue(questId, clueId);
                            }
                        }
                    });
                });
            }
            
            // Radiace pro dangerous lokace
            if (loc.type === 'dangerous' && loc.radiation) {
                const radGain = loc.radiation || 5;
                state.status.radiation = Math.min(100, state.status.radiation + radGain);
                addLog(`+${radGain} ‚ò¢Ô∏è radiace`, '‚ò¢Ô∏è');
            }
            
            // === COMPANION QUEST - explore objective ===
            checkCompanionQuestObjectives('explore', loc.id);
            
            // ≈†ance na boj - z√°vis√≠ na z√≥nƒõ a danger level
            let combatChance = 0.15 + (loc.dangerLevel || 0) * 0.1;
            if (loc.zone === 'safe') combatChance = 0.10;
            if (loc.zone === 'medium') combatChance = Math.min(0.30, combatChance);
            if (loc.zone === 'danger') combatChance = Math.min(0.45, combatChance);
            if (loc.zone === 'deadly') combatChance = Math.min(0.55, combatChance);
            if (loc.type === 'dangerous') combatChance = Math.min(0.50, combatChance + 0.15);
            
            if (loc.enemies && loc.enemies.length > 0 && Math.random() < combatChance) {
                // Vyber n√°hodn√©ho nep≈ô√≠tele
                const enemyId = loc.enemies[Math.floor(Math.random() * loc.enemies.length)];
                const enemy = ENEMIES.find(e => e.id === enemyId) || ENEMIES[0];
                
                // Poƒçet nep≈ô√°tel - z√°vis√≠ na danger level
                let enemyCount = 1;
                const multiChance = 0.15 + (loc.dangerLevel || 0) * 0.1;
                if (Math.random() < multiChance) {
                    enemyCount = 2 + Math.floor(Math.random() * Math.min(3, loc.dangerLevel || 1));
                    enemyCount = Math.min(enemyCount, 4);
                }
                
                // Obƒças sm√≠≈°en√° skupina (pokud m√° lokace v√≠ce typ≈Ø nep≈ô√°tel)
                let displayHtml = '';
                if (enemyCount > 1 && loc.enemies.length > 1 && Math.random() < 0.35) {
                    // Sm√≠≈°en√° skupina
                    let mixedEnemies = [];
                    for (let i = 0; i < enemyCount; i++) {
                        const eid = loc.enemies[Math.floor(Math.random() * loc.enemies.length)];
                        const e = ENEMIES.find(en => en.id === eid);
                        if (e) mixedEnemies.push(e);
                    }
                    displayHtml = `
                        <div style="display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
                            ${mixedEnemies.map(e => `<div style="text-align: center; background: #2a1a1a; padding: 0.5rem; border-radius: 8px;">
                                <div style="font-size: 1.8rem;">${e.icon}</div>
                                <div style="font-size: 0.7rem; color: #888;">${e.name}</div>
                            </div>`).join('')}
                        </div>
                        <p style="color: #ff6b6b; text-align: center; font-weight: bold;">${enemyCount}x nep≈ô√°tel√©!</p>`;
                } else {
                    // Skupina stejn√Ωch nep≈ô√°tel
                    displayHtml = `
                        <div style="text-align: center; margin: 1rem 0;">
                            <div style="font-size: 3rem;">${enemy.icon}${enemyCount > 1 ? `<span style="font-size: 1.5rem; vertical-align: top; color: #ff6b6b;">√ó${enemyCount}</span>` : ''}</div>
                            <h3 style="margin: 0.5rem 0;">${enemy.name}</h3>
                            ${enemyCount > 1 ? `<p style="color: #ff6b6b; margin: 0;">${`Skupina ${enemyCount} nep≈ô√°tel!`}</p>` : ''}
                        </div>`;
                }
                
                showModal('‚öîÔ∏è Nep≈ô√≠tel!', 
                    '<p>P≈ôi pr≈Øzkumu jsi narazil na nep≈ô√≠tele!</p>' +
                    displayHtml +
                    `<button class="btn" onclick="startCombat({id:'${enemy.id}'}, false, false, ${enemyCount})" style="width: 100%; background: #8B0000;">‚öîÔ∏è ' + ('Bojovat!') + '</button>`
                );
                return;
            }
            
            // Loot - z√°vis√≠ na typu lokace a z√≥nƒõ urƒçuje maxim√°ln√≠ raritu
            let lootPool = [];
            
            // Scout skill bonus - zv√Ω≈°en√° ≈°ance na vz√°cn√© p≈ôedmƒõty
            const scoutLevel = state.skills?.['scout'] || 0;
            const rareLootBonus = scoutLevel * 0.05; // +5% za level
            
            if (loc.zone === 'safe') {
                // Safe z√≥na: jen common a uncommon (s bonusem m≈Ø≈æe b√Ωt rare)
                const allowRare = rareLootBonus > 0 && Math.random() < rareLootBonus;
                lootPool = ITEMS.filter(i => 
                    (i.type === 'consumable' || i.type === 'resource' || i.type === 'tool') &&
                    (!i.rarity || i.rarity === 'common' || i.rarity === 'uncommon' || (allowRare && i.rarity === 'rare'))
                );
            } else if (loc.zone === 'medium') {
                // Medium z√≥na: common, uncommon, rare (s bonusem m≈Ø≈æe b√Ωt epic)
                const allowEpic = rareLootBonus > 0 && Math.random() < rareLootBonus;
                lootPool = ITEMS.filter(i => 
                    (i.type === 'consumable' || i.type === 'weapon' || i.type === 'armor' || i.type === 'resource') &&
                    (!i.rarity || i.rarity === 'common' || i.rarity === 'uncommon' || i.rarity === 'rare' || (allowEpic && i.rarity === 'epic'))
                );
            } else if (loc.zone === 'danger') {
                // Danger z√≥na: v≈°echno kromƒõ legendary (s bonusem m≈Ø≈æe b√Ωt legendary)
                const allowLegendary = rareLootBonus > 0 && Math.random() < rareLootBonus * 0.5;
                lootPool = ITEMS.filter(i => 
                    (i.rarity !== 'legendary' || allowLegendary) && i.findChance && i.findChance > 0
                );
            } else if (loc.zone === 'deadly') {
                // Deadly z√≥na: m≈Ø≈æe padat v≈°echno vƒçetnƒõ legendary
                lootPool = ITEMS.filter(i => i.findChance && i.findChance > 0);
            } else {
                // Fallback - bez legendary
                lootPool = ITEMS.filter(i => 
                    (i.type === 'consumable' || i.type === 'resource') &&
                    i.rarity !== 'legendary' && i.rarity !== 'epic'
                );
            }
            
            // Fallback pokud je lootPool pr√°zdn√Ω
            if (lootPool.length === 0) lootPool = ITEMS.filter(i => i.type === 'consumable' || i.type === 'resource').slice(0, 20);
            
            // ≈†ance na pr√°zdn√Ω n√°lez (ZV√ù≈†ENO - m√©nƒõ lootu)
            let emptyChance = 0.50; // Bylo 0.30, nyn√≠ 50% ≈°ance ≈æe nic nenajde≈°
            if (loc.zone === 'safe') emptyChance = 0.55;    // Bylo 0.35
            if (loc.zone === 'medium') emptyChance = 0.48;  // Bylo 0.28
            if (loc.zone === 'danger') emptyChance = 0.42;  // Bylo 0.22
            if (loc.zone === 'deadly') emptyChance = 0.35;  // Bylo 0.18
            
            const isEmpty = Math.random() < emptyChance;
            
            const lootItem = isEmpty ? null : lootPool[Math.floor(Math.random() * lootPool.length)];
            let foundItems = [];
            let groundItems = []; // Polo≈æky kter√© z≈Østaly na zemi
            
            console.log('Explore loot item:', lootItem?.name || 'EMPTY');
            
            if (lootItem) {
                // Zkontroluj loot filtr
                const passesFilter = passesLootFilter(lootItem);
                
                if (!passesFilter) {
                    // Hr√°ƒç nechce tento typ - nech na zemi
                    addToGroundLoot({...lootItem});
                    groundItems.push(lootItem.icon + ' ' + lootItem.name + ' (filtr)');
                } else if (canAddItem(lootItem, 1)) {
                    addItemToInventory(lootItem, 1);
                    notifyLoot(lootItem.name, lootItem.rarity, lootItem.icon);
                    foundItems.push(lootItem.icon + ' ' + lootItem.name);
                } else {
                    // Ulo≈æ na zem
                    addToGroundLoot({...lootItem});
                    groundItems.push(lootItem.icon + ' ' + lootItem.name);
                }
            }
            
            // Suroviny - z√°vis√≠ na typu lokace
            let resources = ['wood', 'metal', 'stone', 'cloth', 'scrap'];
            
            // Speci√°ln√≠ suroviny podle typu lokace
            if (loc.type === 'gas_station' || loc.id?.includes('gas') || loc.id?.includes('fuel')) {
                resources = ['fuel', 'scrap', 'metal', 'rope'];
            } else if (loc.type === 'explore' && (loc.id?.includes('city') || loc.id?.includes('ruin') || loc.id?.includes('mall'))) {
                resources = ['scrap', 'glass', 'cloth', 'electronics', 'rope'];
            } else if (loc.type === 'dungeon' && (loc.id?.includes('factory') || loc.id?.includes('plant'))) {
                resources = ['fuel', 'chemicals', 'scrap', 'metal', 'gunpowder'];
            } else if (loc.id?.includes('hospital') || loc.id?.includes('lab') || loc.id?.includes('research')) {
                resources = ['chemicals', 'glass', 'electronics', 'herbs'];
            } else if (loc.id?.includes('military') || loc.id?.includes('bunker') || loc.id?.includes('army')) {
                resources = ['metal', 'gunpowder', 'electronics', 'scrap', 'ammo'];
            } else if (loc.zone === 'danger' || loc.zone === 'deadly') {
                resources = ['scrap', 'metal', 'fuel', 'chemicals', 'electronics', 'gunpowder'];
            } else if (loc.type === 'forest' || loc.id?.includes('forest') || loc.id?.includes('grove')) {
                resources = ['wood', 'herbs', 'cloth', 'leather', 'rope'];
            } else if (loc.id?.includes('lake') || loc.id?.includes('river') || loc.id?.includes('water')) {
                resources = ['wood', 'stone', 'cloth', 'rope'];
            } else if (loc.id?.includes('mine') || loc.id?.includes('quarry') || loc.id?.includes('cave')) {
                resources = ['stone', 'metal', 'copper', 'scrap'];
            }
            
            // Poƒçet surovin - sn√≠≈æeno o 30%
            const baseResCount = isEmpty ? Math.floor(Math.random() * 2) : 1 + Math.floor(Math.random() * (1 + (loc.dangerLevel || 0)));
            const resCount = Math.max(1, Math.floor(baseResCount * 0.7)); // -30%
            let foundResources = [];
            
            const resIcons = { 
                wood: 'ü™µ', metal: '‚öôÔ∏è', stone: 'üóø', cloth: 'üßµ', scrap: 'üî©',
                fuel: '‚õΩ', glass: 'üîÆ', chemicals: 'üß™', electronics: 'üíæ',
                herbs: 'üåø', leather: 'ü¶¥', gunpowder: 'üí•', rope: '‚û∞', copper: 'üü§'
            };
            
            for (let i = 0; i < resCount; i++) {
                const res = resources[Math.floor(Math.random() * resources.length)];
                const baseAmount = 1 + Math.floor(Math.random() * 3);
                const amount = Math.max(1, Math.floor(baseAmount * 0.7)); // -30%
                state.resources[res] = (state.resources[res] || 0) + amount;
                const icon = RESOURCE_ICONS[res] || 'üì¶';
                const name = RESOURCE_NAMES[res] || res;
                foundResources.push(`+${amount} ${icon} ${name}`);
            }
            
            // Pen√≠ze (men≈°√≠ ≈°ance p≈ôi pr√°zdn√©m n√°lezu)
            let moneyFound = 0;
            const moneyChance = isEmpty ? 0.15 : 0.4;
            if (Math.random() < moneyChance) {
                moneyFound = 5 + Math.floor(Math.random() * 20 * (1 + (loc.dangerLevel || 0)));
                addMoney(moneyFound);
            }
            
            // XP za pr≈Øzkum
            const xpGain = 5 + (loc.dangerLevel || 0) * 3;
            addXP(xpGain);
            
            // === ≈†ANCE NA LORE KNIHU ===
            // Vy≈°≈°√≠ ≈°ance v nebezpeƒçn√Ωch lokac√≠ch (ruiny, laborato≈ôe, bunkry)
            let loreChance = 0.02; // 2% z√°kladn√≠
            if (loc.id?.includes('ruin') || loc.id?.includes('city')) loreChance = 0.05;
            if (loc.id?.includes('lab') || loc.id?.includes('research') || loc.id?.includes('hospital')) loreChance = 0.08;
            if (loc.id?.includes('bunker') || loc.id?.includes('military')) loreChance = 0.06;
            if (loc.zone === 'danger') loreChance += 0.02;
            if (loc.zone === 'deadly') loreChance += 0.04;
            
            if (Math.random() < loreChance) {
                // Najdi lore knihu kterou hr√°ƒç je≈°tƒõ nem√°
                const ownedLore = state.inv.filter(i => i.id?.startsWith('lore_')).map(i => i.id);
                const availableLore = ITEMS.filter(i => i.id?.startsWith('lore_') && !ownedLore.includes(i.id));
                
                if (availableLore.length > 0) {
                    // Dej p≈ôednost knih√°m v po≈ôad√≠ (lore_2 p≈ôed lore_3 atd.)
                    availableLore.sort((a, b) => a.id.localeCompare(b.id));
                    const loreBook = availableLore[0];
                    
                    if (canAddItem(loreBook, 1)) {
                        addItemToInventory(loreBook, 1);
                        foundItems.push(loreBook.icon + ' ' + loreBook.name + ' (VZ√ÅCN√â!)');
                        notifyLoot(loreBook.name, 'epic', loreBook.icon);
                        addLog('üìï Nalezen vz√°cn√Ω den√≠k!', 'üìï');
                    } else {
                        // Lore knihy na zem
                        addToGroundLoot({...loreBook});
                        groundItems.push(loreBook.icon + ' ' + loreBook.name + ' (VZ√ÅCN√â!)');
                    }
                }
            }
            
            // Daily quest progress - explored (jen nov√© lokace se poƒç√≠taj√≠ jinde)
            if (state.dailyQuests.progress) {
                checkDailyQuests();
            }
            
            // === RANDOM EVENTY ===
            // ≈†ance na event z√°vis√≠ na z√≥nƒõ
            let eventChance = 0.15; // 15% z√°kladn√≠
            if (loc.zone === 'medium') eventChance = 0.20;
            if (loc.zone === 'danger') eventChance = 0.25;
            if (loc.zone === 'deadly') eventChance = 0.30;
            
            if (Math.random() < eventChance) {
                // Vyber vhodn√Ω event podle z√≥ny
                const availableEvents = RANDOM_EVENTS.filter(e => {
                    // Nƒõkter√© eventy jen v urƒçit√Ωch z√≥n√°ch
                    if (e.id === 'radiation_storm' && loc.zone === 'safe') return false;
                    if (e.id === 'animal_attack' && loc.zone === 'deadly') return false; // V deadly jsou silnƒõj≈°√≠
                    return true;
                });
                
                // Vyber n√°hodn√Ω event podle ≈°ance
                let totalChance = availableEvents.reduce((sum, e) => sum + e.chance, 0);
                let roll = Math.random() * totalChance;
                let cumulative = 0;
                
                for (const event of availableEvents) {
                    cumulative += event.chance;
                    if (roll <= cumulative) {
                        // Speci√°ln√≠ handling pro danger/deadly z√≥ny
                        if ((loc.zone === 'danger' || loc.zone === 'deadly') && event.id === 'animal_attack') {
                            // V tƒõ≈æk√Ωch z√≥n√°ch naraz√≠≈° na silnƒõj≈°√≠ nep≈ô√°tele
                            triggerDangerousEncounter(loc.zone);
                        } else {
                            event.trigger();
                        }
                        break;
                    }
                }
            }
            
            const limitInfo = checkDailyActionLimit('explore', loc.id);
            const usedCount = 3 - limitInfo.remaining;
            
            // Humor podle v√Ωsledku
            let humor = '';
            if (isEmpty && foundResources.length <= 1 && moneyFound === 0) {
                humor = getRandomHumor('lootEmpty');
            } else if (lootItem?.rarity === 'rare' || lootItem?.rarity === 'epic') {
                humor = getRandomHumor('lootGood');
            } else {
                humor = getRandomHumor('lootJunk');
            }
            
            showModal('üîç Pr≈Øzkum dokonƒçen', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üîç</div>
                    <p style="margin-bottom: 0.5rem;">Prohledal jsi <strong>${loc.name}</strong></p>
                    <p style="color: #666; font-style: italic; font-size: 0.8rem; margin-bottom: 1rem;">"${humor}"</p>
                </div>
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4CAF50;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üì¶ Nalezeno:</h4>
                    ${foundItems.length > 0 ? `<p style="color: var(--toxic-green);">${foundItems.join(', ')}</p>` : `<p style="color: #888;">${'≈Ω√°dn√© p≈ôedmƒõty...'}</p>`}
                    ${groundItems.length > 0 ? `<p style="color: #ff9800;">üì¶ Na zemi: ${groundItems.join(', ')}</p>` : ''}
                    ${foundResources.length > 0 ? `<p style="color: var(--warning-yellow);">${foundResources.join(', ')}</p>` : ''}
                    ${moneyFound > 0 ? `<p style="color: #ffd700;">+${moneyFound} üí∞</p>` : ''}
                    <p style="color: #8bc34a; margin-top: 0.5rem;">+${xpGain} XP</p>
                </div>
                <p style="font-size: 0.8rem; color: #666; text-align: center;">Pr≈Øzkumy: ${usedCount}/3 dnes na t√©to lokaci</p>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">‚úì Jdeme d√°l</button>
            `);
            
            addLog('Pr≈Øzkum: ' + loc.name, 'üîç');
            
            // Zkontroluj speci√°ln√≠ quest triggery (find_npc, rescue, artifact)
            checkSpecialQuestTriggers(loc.id);
            
            renderFull();
        }
        
        function raidLocation() {
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            if (!loc) return;
            
            showModal(('‚öîÔ∏è Raid: ') + loc.name, 
                '<p style="color: #ff9800;">P≈ôiprav se na boj!</p>' +
                '<p>Lokace je pln√° nep≈ô√°tel. Bude≈° ƒçelit nƒõkolika vln√°m!</p>' +
                '<button class="btn" onclick="startRaid()" style="width: 100%; margin-top: 1rem; background: #8B0000;">‚öîÔ∏è Zaƒç√≠t raid!</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó Zru≈°it</button>'
            );
        }
        
        function startRaid() {
            closeModal();
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // Ulo≈æ informaci o raidu pro pozdƒõj≈°√≠ zpracov√°n√≠
            window.currentRaidLocation = loc?.id;
            
            // Vyber nep≈ô√≠tele z lokace, nebo podle z√≥ny
            let enemy;
            if (loc?.enemies && loc.enemies.length > 0) {
                // Pou≈æij nep≈ô√≠tele definovan√© pro tuto lokaci
                const enemyId = loc.enemies[Math.floor(Math.random() * loc.enemies.length)];
                enemy = ENEMIES.find(e => e.id === enemyId);
            }
            
            // Fallback podle z√≥ny
            if (!enemy) {
                const zoneTiers = {
                    'safe': [1],
                    'medium': [1, 2],
                    'danger': [2, 3],
                    'deadly': [4, 5]
                };
                const tiers = zoneTiers[loc?.zone] || [1, 2];
                const zoneEnemies = ENEMIES.filter(e => tiers.includes(e.tier));
                enemy = zoneEnemies[Math.floor(Math.random() * zoneEnemies.length)] || ENEMIES[0];
            }
            
            // isVillageRaid je jen pro p≈ôepaden√≠ vesnic (ne pro √∫tok na nep≈ô√°telsk√© t√°bory)
            startCombat({id: enemy.id}, false, false);
        }
        
        function collectWater() {
            // Cooldown 24 hodin
            const cooldownKey = 'water_' + state.world.currentLocation;
            const lastCollect = state.world.locationCooldowns?.[cooldownKey] || 0;
            const cooldownTime = 24 * 60 * 60 * 1000; // 24 hodin
            const now = Date.now();
            
            if (now - lastCollect < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastCollect)) / 1000);
                const hours = Math.floor(remaining / 3600);
                const mins = Math.floor((remaining % 3600) / 60);
                notifyWarning('Studna je vyƒçerpan√°', `Dal≈°√≠ voda za ${hours}h ${mins}m`);
                return;
            }
            
            if (!state.world.locationCooldowns) state.world.locationCooldowns = {};
            state.world.locationCooldowns[cooldownKey] = now;
            
            // 2-3 vody
            const amount = 2 + Math.floor(Math.random() * 2);
            const waterItem = ITEMS.find(i => i.id === 'water') || { id: 'water', name: 'Voda', icon: 'üíß', type: 'consumable', effect: 'thirst', value: 30, weight: 1 };
            
            const existing = state.inv.find(i => i.id === 'water');
            if (existing) {
                existing.count = (existing.count || 1) + amount;
            } else {
                state.inv.push({...waterItem, count: amount});
            }
            
            notifySuccess('Nabral jsi vodu!', `+${amount} üíß`);
            addLog(`Nabral jsi ${amount}x vodu ze studny`, 'üíß');
            addXP(2);
            renderFull();
        }
        
        // Osvobozen√≠ zajatc≈Ø z otrok√°≈ôsk√©ho t√°bora
        function freeSlaves() {
            if (state.freedSlaves) {
                notifyWarning('U≈æ osvobozeno', 'Zajatci u≈æ byli osvobozeni!');
                return;
            }
            
            state.freedSlaves = true;
            
            // Odmƒõny
            const xpGain = 200;
            const moneyGain = 150;
            addXP(xpGain);
            addMoney(moneyGain);
            
            // Reputace
            changeReputation('survivors', 30, 'osvobozen√≠ zajatc≈Ø');
            changeReputation('raiders', -50, 'zniƒçen√≠ otrok√°≈ôsk√©ho t√°bora');
            
            // Update quest pokud existuje
            if (state.activeQuests) {
                const slaveQuest = state.activeQuests.find(q => q.id === 'rescue_slaves' || q.objectives?.some(o => o.type === 'free_slaves'));
                if (slaveQuest) {
                    slaveQuest.completed = true;
                }
            }
            
            // ≈†ance na nov√©ho spoleƒçn√≠ka
            const companionChance = Math.random();
            let companionHtml = '';
            
            if (companionChance < 0.3) {
                // Osvobozen√Ω zajatec chce se p≈ôipojit
                const newCompanion = {
                    id: 'survivor',
                    uniqueId: 'freed_slave_' + Date.now(),
                    name: 'Osvobozen√Ω zajatec',
                    icon: 'üôè',
                    type: 'human',
                    hp: 80,
                    maxHp: 80,
                    damage: 12,
                    defense: 8,
                    loyalty: 70,
                    skills: [],
                    level: 1,
                    xp: 0,
                    skillPoints: 1,
                    equipped: { weapon: null, armor: null, helmet: null, gloves: null, boots: null },
                    canEquip: true,
                    inCombat: true,
                    ability: 'P≈ôe≈æiv≈°√≠',
                    abilityDesc: 'Osvobozen√Ω zajatec, vdƒõƒçn√Ω za z√°chranu'
                };
                
                state.companions = state.companions || [];
                
                if (state.companions.length < getMaxCompanions()) {
                    // M√≠sto je voln√©
                    state.companions.push(newCompanion);
                    companionHtml = `
                        <div style="background: #1a2a3a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #2196f3;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">üë§ Nov√Ω spoleƒçn√≠k!</h4>
                            <p style="color: #888; margin: 0;">"D√≠ky za z√°chranu! P≈Øjdu s tebou."</p>
                        </div>
                    `;
                } else {
                    // Plno - nab√≠dni v√Ωmƒõnu po zav≈ôen√≠ tohoto modalu
                    window.pendingCompanionAfterModal = newCompanion;
                    companionHtml = `
                        <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #ff9800;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">üë§ Chce se p≈ôidat!</h4>
                            <p style="color: #888; margin: 0;">Jeden ze zajatc≈Ø chce j√≠t s tebou, ale m√°≈° plno spoleƒçn√≠k≈Ø.</p>
                        </div>
                    `;
                }
            }
            
            showModal('‚õìÔ∏è Zajatci osvobozeni!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">üôè</div>
                    <h3 style="color: #8bc34a; margin: 0.5rem 0;">Osvobodil jsi zajatce!</h3>
                    <p style="color: #888;">Vdƒõƒçn√≠ p≈ôe≈æiv≈°√≠ ti dƒõkuj√≠ za z√°chranu.</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="color: #ffd700; margin: 0.3rem 0;">‚≠ê +${xpGain} XP</div>
                        <div style="color: #ffd700; margin: 0.3rem 0;">üí∞ +${moneyGain} penƒõz</div>
                        <div style="color: #8bc34a; margin: 0.3rem 0;">üë• +30 reputace s P≈ôe≈æiv≈°√≠mi</div>
                    </div>
                    
                    ${companionHtml}
                </div>
                <button class="btn" onclick="closeFreeSlavesModal();" style="width: 100%; margin-top: 1rem; background: #4caf50;">‚úì ' + ('Skvƒõl√©!') + '</button>
            `);
            
            addLog('Osvobodil jsi zajatce z otrok√°≈ôsk√©ho t√°bora!', '‚õìÔ∏è');
        }
        
        function closeFreeSlavesModal() {
            closeModal();
            renderFull();
            
            // Zkontroluj jestli ƒçek√° companion na v√Ωmƒõnu
            if (window.pendingCompanionAfterModal) {
                const newCompanion = window.pendingCompanionAfterModal;
                window.pendingCompanionAfterModal = null;
                setTimeout(() => {
                    showCompanionSwapModal(newCompanion, 'freed_slave');
                }, 300);
            }
        }
        
        function restAtShelter() {
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + 30);
            state.status.energy = Math.min(100, state.status.energy + 40);
            notifySuccess('Odpoƒçinul sis', '+30 HP, +40 ' + ('energie'));
            addLog('Odpoƒçinek v √∫krytu', 'üõèÔ∏è');
            renderFull();
        }
        
        // === STAR√â HEX FUNKCE ODSTRANƒöNY ===
        // Hex canvas syst√©m byl nahrazen WORLD_LOCATIONS syst√©mem
        let canvas, ctx, offsetX = 0, offsetY = 0;
        let hexSize = 50;
        const SQRT3 = Math.sqrt(3);
        
        function initMap() { return; }
        function drawMap() { return; }
        function drawHex(q, r) { return; }
        function generateHex(q, r) { return { terrain: 0, discovered: true, explored: true }; }
        function findPath(fromQ, fromR, toQ, toR) { return []; }
        
        // clickHex - pr√°zdn√° pro kompatibilitu
        function clickHex(q, r) {
            // Hex syst√©m odstranƒõn - pou≈æij WORLD_LOCATIONS
            console.log('clickHex deprecated - use WORLD_LOCATIONS system');
            return;
        }
        
        // travelTo - pr√°zdn√° pro kompatibilitu
        function travelTo(q, r, minutes) {
            console.log('travelTo deprecated - use travelToLocation');
            return;
        }
        // === SYST√âM N√ÅHODN√ùCH EVENT≈Æ BƒöHEM CESTY ===
        let scheduledEventTimeouts = [];
        
        function clearScheduledEvents() {
            scheduledEventTimeouts.forEach(t => clearTimeout(t));
            scheduledEventTimeouts = [];
        }
        
        function scheduleRandomEvents(travelMinutes) {
            // VYPNUTO - eventy jsou jen na world mapƒõ p≈ôes scheduleTravelEvents
            // Hex mapa je jen pro lok√°ln√≠ pohyb, eventy by byly otravn√©
            clearScheduledEvents();
            state.map.scheduledTravelEvents = [];
            
            // Dog event p≈ôi prvn√≠ cestƒõ z≈Øst√°v√°
            if (state.firstJourneyDogEvent) {
                const eventTime = Date.now() + 2000;
                state.map.scheduledTravelEvents.push({ type: 'dog', triggerAt: eventTime });
                
                const dogTimeout = setTimeout(() => {
                    if (!state.map.traveling) return;
                    state.firstJourneyDogEvent = false;
                    pauseTravelForEvent();
                    showDogEvent();
                }, 2000);
                scheduledEventTimeouts.push(dogTimeout);
                return;
            }
            
            // ≈Ω√°dn√© dal≈°√≠ eventy na hex mapƒõ
            console.log('üìÖ Hex map eventy vypnuty - pou≈æ√≠v√° se world map');
        }
        
        // Obnov eventy po refreshi
        function restoreScheduledEvents() {
            if (!state.map.traveling || !state.map.scheduledTravelEvents) return;
            
            clearScheduledEvents();
            const now = Date.now();
            
            for (const event of state.map.scheduledTravelEvents) {
                if (event.triggerAt <= now) {
                    // Event mƒõl probƒõhnout - spus≈• ho ihned
                    console.log('‚ö° Spou≈°t√≠m opo≈ædƒõn√Ω event:', event.type);
                    setTimeout(() => {
                        if (!state.map.traveling) return;
                        if (event.type === 'dog') {
                            state.firstJourneyDogEvent = false;
                            pauseTravelForEvent();
                            showDogEvent();
                        } else {
                            triggerRandomTravelEvent(event.forceEncounter);
                        }
                    }, 100);
                    return; // Jen jeden event najednou
                } else {
                    // Event je v budoucnosti - napl√°nuj ho
                    const delay = event.triggerAt - now;
                    console.log(`üìÖ Obnovuji event za ${Math.round(delay/1000)}s`);
                    
                    const timeout = setTimeout(() => {
                        if (!state.map.traveling) return;
                        if (event.type === 'dog') {
                            state.firstJourneyDogEvent = false;
                            pauseTravelForEvent();
                            showDogEvent();
                        } else {
                            triggerRandomTravelEvent(event.forceEncounter);
                        }
                    }, delay);
                    scheduledEventTimeouts.push(timeout);
                }
            }
        }
        
        function showDogEvent() {
            showModal('üêï Opu≈°tƒõn√Ω pes!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 5rem;">üêï</div>
                </div>
                <p style="margin-bottom: 1rem;">Na kraji cesty vid√≠≈° vychrtl√©ho psa. Vypad√° opu≈°tƒõnƒõ, ale p≈ô√°telsky vrt√≠ ocasem.</p>
                <p style="color: var(--toxic-green); margin-bottom: 1rem;">Vypad√°, ≈æe by se k tobƒõ r√°d p≈ôidal!</p>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--rust);">
                    <p style="margin: 0.3rem 0; color: var(--warning-yellow);"><strong>üêï Vƒõrn√Ω pes</strong></p>
                    <p style="margin: 0.3rem 0; font-size: 0.85rem;">‚ù§Ô∏è HP: 50 | ‚öîÔ∏è DMG: 8 | üõ°Ô∏è DEF: 3</p>
                    <p style="margin: 0.3rem 0; font-size: 0.85rem; color: var(--toxic-green);">üîç ƒåmuchal: +25% ≈°ance naj√≠t vz√°cnƒõj≈°√≠ p≈ôedmƒõty</p>
                </div>
                <button class="btn" onclick="adoptDog(); resumeTravel();" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">ü¶¥ P≈ôijmout psa</button>
                <button class="btn" onclick="closeModal(); resumeTravel();" style="width: 100%; background: #555;">üö∂ J√≠t d√°l</button>
            `);
        }
        
        function pauseTravelForEvent() {
            if (!state.map.traveling) return;
            
            // Ulo≈æ zb√Ωvaj√≠c√≠ ƒças
            const elapsed = Date.now() - state.map.travelStart;
            state.map.travelPaused = true;
            state.map.travelRemainingTime = state.map.travelDuration - elapsed;
            state.map.traveling = false;
            
            // Zru≈° v≈°echny napl√°novan√© eventy (spust√≠me nov√© po resumeTravel)
            clearScheduledEvents();
            
            addLog('‚è∏Ô∏è Cesta p≈ôeru≈°ena!', '‚ö†Ô∏è');
            renderFull();
        }
        
        function resumeTravel() {
            closeModal();
            
            if (!state.map.travelPaused) return;
            
            // Pokraƒçuj v cestƒõ se zb√Ωvaj√≠c√≠m ƒçasem
            state.map.traveling = true;
            state.map.travelStart = Date.now();
            state.map.travelDuration = state.map.travelRemainingTime;
            state.map.travelPaused = false;
            
            // Napl√°nuj dal≈°√≠ eventy pro zb√Ωvaj√≠c√≠ ƒças
            const remainingMinutes = state.map.travelRemainingTime / 60000;
            if (remainingMinutes > 0.5) { // Jen pokud zb√Ωv√° v√≠c ne≈æ 30 sekund
                scheduleRandomEvents(remainingMinutes);
            }
            
            addLog('‚ñ∂Ô∏è Pokraƒçuje≈° v cestƒõ...', 'üö∂');
            renderFull();
        }
        
        function triggerRandomTravelEvent(forceEncounter = false) {
            if (!state.map.traveling) return;
            
            pauseTravelForEvent();
            
            // 15% ≈°ance na dynamick√Ω event
            if (!forceEncounter && Math.random() < 0.15) {
                const dynamicEvent = checkForDynamicEvent();
                if (dynamicEvent) {
                    triggerDynamicEvent(dynamicEvent);
                    return;
                }
            }
            
            const roll = Math.random();
            
            // Companion ambush reduction
            const compBonuses = getAllCompanionBonuses();
            let ambushReduction = compBonuses.ambushReduction || 0;
            
            // Hr√°ƒçovy skilly pro sn√≠≈æen√≠ p≈ôepaden√≠
            const stealthLevel = state.skills?.['stealth'] || 0;
            if (stealthLevel > 0) {
                ambushReduction += stealthLevel * 0.15; // -15% za level
            }
            
            // Skill tree bonusy
            ambushReduction += getSkillTreeBonus('ambushReduction') || 0;
            
            const enemyChance = Math.max(0.1, 0.5 - ambushReduction); // Z√°kladn√≠ 50%, sn√≠≈æeno bonusy
            
            // Vynucen√Ω encounter na neprozkouman√©m √∫zem√≠ NEBO ≈°ance na nep≈ô√≠tele
            if (forceEncounter || roll < enemyChance) {
                // Pokud m√° companion ambushReduction, m≈Ø≈æe se vyhnout i vynucen√©mu
                if (forceEncounter && ambushReduction > 0 && Math.random() < ambushReduction) {
                    // Vyhnul se p≈ôepaden√≠ d√≠ky spoleƒçn√≠kovi
                    showModal('üëÄ ' + ('Tƒõsnƒõ!'), `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem;">üêæ</div>
                            <p style="color: #8bc34a;">Tv≈Øj spoleƒçn√≠k tƒõ vƒças varoval p≈ôed nebezpeƒç√≠m!</p>
                            <p style="color: #888;">Vyhnul ses p≈ôepaden√≠.</p>
                        </div>
                        <button class="btn" onclick="resumeTravel()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>
                    `);
                    return;
                }
                
                const enemy = ENEMIES[Math.floor(Math.random() * ENEMIES.length)];
                const isAmbush = forceEncounter; // P≈ôepaden√≠ p≈ôi vynucen√©m
                showModal(isAmbush ? 'üí• P≈òEPADEN√ç!' : '‚ö†Ô∏è Setk√°n√≠!', `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">${enemy.icon}</div>
                        <h3 style="color: var(--warning-yellow);">${enemy.name}</h3>
                        <p style="color: #888;">HP: ${enemy.hp} | DMG: ${enemy.damage} | DEF: ${enemy.defense}</p>
                    </div>
                    <p style="margin-bottom: 1rem;">Bƒõhem cesty jsi narazil na nep≈ô√≠tele!</p>
                    <button class="btn" onclick="startCombatDuringTravel('${enemy.id}')" style="width: 100%; margin-bottom: 0.5rem;">‚öîÔ∏è ' + ('Bojovat!') + '</button>
                    <button class="btn" onclick="tryToFleeDuringTravel('${enemy.id}')" style="width: 100%; background: #555;">üèÉ Pokusit se ut√©ct</button>
                `);
                return;
            }
            
            // 30% ≈°ance na loot
            if (roll < 0.8) {
                const lootRoll = Math.random();
                let foundItem = null;
                
                for (const item of ITEMS) {
                    if (lootRoll < item.findChance && item.findChance > 0) {
                        foundItem = item;
                        break;
                    }
                }
                
                if (foundItem) {
                    const rarityColor = { 'common': '#fff', 'uncommon': '#8bc34a', 'rare': '#2196f3', 'epic': '#9c27b0', 'legendary': '#ffd700' }[foundItem.rarity] || '#fff';
                    
                    if (canAddItem(foundItem, 1)) {
                        if (foundItem.type === 'consumable') {
                            const existing = state.inv.find(i => i.id === foundItem.id);
                            if (existing) existing.count = (existing.count || 1) + 1;
                            else state.inv.push({...foundItem, count: 1});
                        } else {
                            state.inv.push({...foundItem, durability: 100, maxDurability: 100});
                        }
                        
                        // Notifikace
                        notifyLoot(foundItem.name, foundItem.rarity, foundItem.icon);
                        
                        // Speci√°ln√≠ modal pro easter eggy
                        const isEasterEgg = foundItem.desc && foundItem.rarity === 'legendary';
                        
                        showModal(isEasterEgg ? 'üéÆ EASTER EGG!' : 'üéÅ N√°lez!', `
                            <div style="text-align: center;">
                                ${isEasterEgg ? '<div style="font-size: 1rem; color: #ffd700; margin-bottom: 0.5rem;">‚ú® LEGEND√ÅRN√ç N√ÅLEZ! ‚ú®</div>' : ''}
                                <div style="font-size: 4rem; ${isEasterEgg ? 'animation: pulse 1s infinite;' : ''}">${foundItem.icon}</div>
                                <h3 style="color: ${rarityColor};">${foundItem.name}</h3>
                                <p style="color: #888;">[${foundItem.rarity.toUpperCase()}]</p>
                                ${foundItem.desc ? `<p style="color: #aaa; font-style: italic; margin: 0.5rem 0;">"${foundItem.desc}"</p>` : ''}
                                <p style="margin: 1rem 0;">${isEasterEgg ? 'Na≈°el jsi legend√°rn√≠ p≈ôedmƒõt z jin√©ho svƒõta!' : 'Na≈°el jsi nƒõco u≈æiteƒçn√©ho na cestƒõ!'}</p>
                                <button class="btn" onclick="resumeTravel()" style="width: 100%;">‚úì Pokraƒçovat</button>
                            </div>
                        `);
                        
                        if (foundItem.rarity === 'rare' || foundItem.rarity === 'epic' || foundItem.rarity === 'legendary') {
                            SoundSystem.play('rare_item');
                            // Easter egg speci√°ln√≠ efekt
                            if (foundItem.desc) {
                                setTimeout(() => {
                                    addLog(`üéÆ "${foundItem.desc}"`, '‚ú®');
                                }, 1000);
                            }
                        } else {
                            SoundSystem.play('pickup');
                        }
                    } else {
                        showModal('üéÅ N√°lez!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">${foundItem.icon}</div>
                                <h3 style="color: ${rarityColor};">${foundItem.name}</h3>
                                <p style="color: #ff9800;">‚ö†Ô∏è Pln√Ω invent√°≈ô! Nem≈Ø≈æe≈° vz√≠t.</p>
                                <button class="btn" onclick="resumeTravel()" style="width: 100%;">‚úì Pokraƒçovat</button>
                            </div>
                        `);
                    }
                } else {
                    // Suroviny m√≠sto itemu
                    const resourceTypes = ['wood', 'metal', 'stone', 'cloth'];
                    const resType = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
                    const amount = Math.floor(Math.random() * 3) + 1;
                    state.resources[resType] = (state.resources[resType] || 0) + amount;
                    
                    const resInfo = { wood: 'ü™µ D≈ôevo', metal: '‚öôÔ∏è Kov', stone: 'ü™® K√°men', cloth: 'üßµ L√°tka' };
                    
                    showModal('üéÅ N√°lez!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">${resInfo[resType].split(' ')[0]}</div>
                            <h3>${resInfo[resType].split(' ')[1]} x${amount}</h3>
                            <p style="margin: 1rem 0;">Na≈°el jsi suroviny na cestƒõ!</p>
                            <button class="btn" onclick="resumeTravel()" style="width: 100%;">‚úì Pokraƒçovat</button>
                        </div>
                    `);
                    SoundSystem.play('pickup');
                }
                return;
            }
            
            // 20% ≈°ance na n√°hodn√Ω event
            const eventRoll = Math.random();
            if (eventRoll < 0.5) {
                // Nalezen√© pen√≠ze
                const money = Math.floor(Math.random() * 50) + 10;
                addMoney(money);
                showModal('üí∞ ≈†tƒõst√≠!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üí∞</div>
                        <h3 style="color: var(--warning-yellow);">+${money} penƒõz</h3>
                        <p style="margin: 1rem 0;">Na≈°el jsi opu≈°tƒõnou penƒõ≈æenku!</p>
                        <button class="btn" onclick="resumeTravel()" style="width: 100%;">‚úì Pokraƒçovat</button>
                    </div>
                `);
            } else {
                // L√©ƒçen√≠
                const heal = Math.floor(Math.random() * 20) + 10;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + heal);
                showModal('üíö Odpoƒçinek!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üåø</div>
                        <h3 style="color: var(--toxic-green);">+${heal} HP</h3>
                        <p style="margin: 1rem 0;">Na≈°el jsi klidn√© m√≠sto k odpoƒçinku.</p>
                        <button class="btn" onclick="resumeTravel()" style="width: 100%;">‚úì Pokraƒçovat</button>
                    </div>
                `);
            }
        }
        
        function startCombatDuringTravel(enemyId) {
            closeModal();
            // Po boji se cesta obnov√≠
            state.world.resumeAfterCombat = true;
            startCombat({id: enemyId});
        }
        
        function tryToFleeDuringTravel(enemyId) {
            const fleeChance = 0.3 + (state.char.attrs.agi - 5) * 0.05;
            if (Math.random() < fleeChance) {
                addLog('√öspƒõ≈°nƒõ jsi utekl!', 'üèÉ');
                resumeTravel();
            } else {
                addLog('√ötƒõk se nezda≈ôil!', '‚ùå');
                startCombatDuringTravel(enemyId);
            }
        }
        
        // ============================================================
        // === üé≤ DYNAMICK√â EVENTY SYSTEM ===
        // ============================================================
        
        function checkForDynamicEvent() {
            // Kontrola p≈ôi cestov√°n√≠ nebo pr≈Øzkumu
            if (!state.dynamicEvents) state.dynamicEvents = { triggered: [], cooldown: 0 };
            
            // Cooldown mezi eventy (min 5 minut hern√≠ho ƒçasu)
            if (state.dynamicEvents.cooldown > Date.now()) return null;
            
            const eligibleEvents = DYNAMIC_EVENTS.filter(e => {
                if (state.dynamicEvents.triggered.includes(e.id) && Math.random() > 0.3) return false; // 30% ≈°ance na opakov√°n√≠
                if (e.minLevel && state.char.level < e.minLevel) return false;
                return Math.random() < e.triggerChance;
            });
            
            if (eligibleEvents.length === 0) return null;
            
            const event = eligibleEvents[Math.floor(Math.random() * eligibleEvents.length)];
            state.dynamicEvents.cooldown = Date.now() + 5 * 60 * 1000; // 5 min cooldown
            
            return event;
        }
        
        function triggerDynamicEvent(event) {
            if (!event) return;
            
            state.dynamicEvents.triggered.push(event.id);
            state.dynamicEvents.currentEvent = event;
            
            let choicesHtml = event.choices.map((choice, idx) => {
                let disabled = false;
                let disabledReason = '';
                
                if (choice.requirements) {
                    if (choice.requirements.item) {
                        // Kontroluj konkr√©tn√≠ item NEBO typ (food = jak√©koliv j√≠dlo)
                        let hasItem = false;
                        if (choice.requirements.item === 'food') {
                            hasItem = state.inv.some(i => i.type === 'consumable' && i.effect === 'hunger');
                        } else if (choice.requirements.item === 'medkit') {
                            hasItem = state.inv.some(i => i.id === 'medkit' || i.id === 'bandage' || i.id === 'stimpack');
                        } else {
                            hasItem = state.inv.some(i => i.id === choice.requirements.item);
                        }
                        if (!hasItem) {
                            disabled = true;
                            const itemNames = { 'food': 'j√≠dlo', 'medkit': 'l√©ky', 'water': 'vodu' };
                            disabledReason = `(Pot≈ôebuje≈°: ${itemNames[choice.requirements.item] || choice.requirements.item})`;
                        }
                    }
                    if (choice.requirements.money && state.money < choice.requirements.money) {
                        disabled = true;
                        disabledReason = `(Pot≈ôebuje≈°: ${choice.requirements.money} üí∞)`;
                    }
                    if (choice.requirements.attr) {
                        const [attr, value] = Object.entries(choice.requirements.attr)[0];
                        if (state.char.attrs[attr] < value) {
                            disabled = true;
                            const attrNames = { str: 'S√çL', agi: 'OBR', end: 'V√ùD', int: 'INT', per: 'VN√ç', cha: 'CHA' };
                            disabledReason = `(Pot≈ôebuje≈°: ${attrNames[attr] || attr.toUpperCase()} ${value}+)`;
                        }
                    }
                }
                
                return `
                    <button class="btn" onclick="handleDynamicEventChoice(${idx})" 
                        style="width: 100%; margin-bottom: 0.5rem; text-align: left; padding: 0.8rem; ${disabled ? 'opacity: 0.5;' : ''}"
                        ${disabled ? 'disabled' : ''}>
                        ${choice.text} ${disabledReason ? `<span style="color: #f44336; font-size: 0.8rem;">${disabledReason}</span>` : ''}
                    </button>
                `;
            }).join('');
            
            showModal(`${event.icon} ${event.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${event.icon}</div>
                    <p style="color: #ccc; font-size: 1rem; line-height: 1.5;">${event.description}</p>
                </div>
                <div style="margin-top: 1rem;">
                    ${choicesHtml}
                </div>
            `);
        }
        
        function handleDynamicEventChoice(choiceIdx) {
            const event = state.dynamicEvents.currentEvent;
            if (!event) return;
            
            const choice = event.choices[choiceIdx];
            if (!choice) return;
            
            // Spot≈ôebuj item pokud pot≈ôeba
            if (choice.consumeItem && choice.requirements?.item) {
                let itemIdx = -1;
                
                // Najdi spr√°vn√Ω item podle typu
                if (choice.requirements.item === 'food') {
                    itemIdx = state.inv.findIndex(i => i.type === 'consumable' && i.effect === 'hunger');
                } else if (choice.requirements.item === 'medkit') {
                    itemIdx = state.inv.findIndex(i => i.id === 'medkit' || i.id === 'bandage' || i.id === 'stimpack');
                } else {
                    itemIdx = state.inv.findIndex(i => i.id === choice.requirements.item);
                }
                
                if (itemIdx !== -1) {
                    const item = state.inv[itemIdx];
                    addLog(`Pou≈æito: ${item.icon} ${item.name}`, 'üì¶');
                    if (item.count > 1) state.inv[itemIdx].count--;
                    else state.inv.splice(itemIdx, 1);
                }
            }
            
            // Spot≈ôebuj pen√≠ze
            if (choice.requirements?.money) {
                state.money -= choice.requirements.money;
                addLog(`Zaplaceno: ${choice.requirements.money} üí∞`, 'üí∞');
            }
            
            const outcome = choice.outcome;
            
            // Quest trigger
            if (outcome.quest) {
                startTimedQuest(outcome.quest);
                showModal('üìã Nov√Ω √∫kol!', `
                    <div style="text-align: center;">
                        <p>${outcome.text}</p>
                        <button class="btn" onclick="closeModal(); resumeTravel();" style="width: 100%; margin-top: 1rem;">‚úì P≈ôijmout</button>
                    </div>
                `);
                return;
            }
            
            // Combat trigger
            if (outcome.combat) {
                closeModal();
                state.dynamicEvents.pendingOutcome = outcome;
                startDynamicEventCombat(outcome.combat);
                return;
            }
            
            // Random outcome
            if (outcome.random) {
                const roll = Math.random();
                let cumulative = 0;
                for (const possibility of outcome.random) {
                    cumulative += possibility.chance;
                    if (roll <= cumulative) {
                        applyEventOutcome(possibility);
                        return;
                    }
                }
            }
            
            // Success/Failure outcome
            if (outcome.success) {
                const roll = Math.random();
                if (roll <= outcome.success.chance) {
                    applyEventOutcome(outcome.success);
                } else if (outcome.failure) {
                    applyEventOutcome(outcome.failure);
                }
            } else {
                // Direct outcome
                applyEventOutcome(outcome);
            }
        }
        
        function applyEventOutcome(result) {
            let resultHtml = `<p style="margin-bottom: 1rem;">${result.text}</p>`;
            let rewards = [];
            let penalties = [];
            
            // Apply rewards
            if (result.reward) {
                if (result.reward.money) {
                    addMoney(result.reward.money);
                    rewards.push(`+${result.reward.money} üí∞`);
                }
                if (result.reward.xp) {
                    addXP(result.reward.xp);
                    rewards.push(`+${result.reward.xp} XP`);
                }
                if (result.reward.karma) {
                    state.karma = (state.karma || 0) + result.reward.karma;
                    rewards.push(`+${result.reward.karma} Karma`);
                }
                if (result.reward.items) {
                    result.reward.items.forEach(itemId => {
                        const item = ITEMS.find(i => i.id === itemId);
                        if (item && canAddItem(item, 1)) {
                            state.inv.push({...item, count: 1});
                            rewards.push(`+${item.icon} ${item.name}`);
                        }
                    });
                }
                if (result.reward.resources) {
                    Object.entries(result.reward.resources).forEach(([res, amt]) => {
                        state.resources[res] = (state.resources[res] || 0) + amt;
                        rewards.push(`+${amt} ${res}`);
                    });
                }
                if (result.reward.reputation) {
                    Object.entries(result.reward.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        rewards.push(`${amt > 0 ? '+' : ''}${amt} rep (${faction})`);
                    });
                }
                if (result.reward.unlockLocation) {
                    if (!state.unlockedLocations) state.unlockedLocations = [];
                    state.unlockedLocations.push(result.reward.unlockLocation);
                    rewards.push(`üó∫Ô∏è Nov√° lokace odkryta!`);
                }
            }
            
            // Apply penalties
            if (result.penalty) {
                if (result.penalty.hp) {
                    state.char.hp = Math.max(1, state.char.hp + result.penalty.hp);
                    penalties.push(`${result.penalty.hp} HP`);
                }
                if (result.penalty.money) {
                    state.money = Math.max(0, state.money + result.penalty.money);
                    penalties.push(`${result.penalty.money} üí∞`);
                }
                if (result.penalty.karma) {
                    state.karma = (state.karma || 0) + result.penalty.karma;
                    penalties.push(`${result.penalty.karma} Karma`);
                }
                if (result.penalty.reputation) {
                    Object.entries(result.penalty.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        penalties.push(`${amt} rep (${faction})`);
                    });
                }
            }
            
            if (rewards.length > 0) {
                resultHtml += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <span style="color: #4caf50;">‚úì Z√≠sk√°v√°≈°:</span> ${rewards.join(', ')}
                </div>`;
            }
            if (penalties.length > 0) {
                resultHtml += `<div style="background: #2a1a1a; padding: 0.5rem; border-radius: 4px;">
                    <span style="color: #f44336;">‚úó Ztr√°ty:</span> ${penalties.join(', ')}
                </div>`;
            }
            
            showModal('üìã V√Ωsledek', `
                <div style="text-align: center;">
                    ${resultHtml}
                    <button class="btn" onclick="closeModal(); if(state.map.travelPaused) resumeTravel(); else renderFull();" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>
                </div>
            `);
            
            state.dynamicEvents.currentEvent = null;
        }
        
        function startDynamicEventCombat(combatData) {
            // Combat s v√≠ce nep≈ô√°teli z dynamic events
            const enemies = combatData.enemies.map(enemyId => {
                return ENEMIES.find(e => e.id === enemyId) || ENEMIES[0];
            });
            
            state.world.resumeAfterCombat = true;
            state.dynamicEvents.combatData = combatData;
            
            if (enemies.length > 1) {
                startCombatWithGroup(enemies, 'dynamic_event');
            } else {
                startCombat(enemies[0]);
            }
        }
        
        // ============================================================
        // === ‚è∞ ƒåASOVƒö LIMITOVAN√â QUESTY ===
        // ============================================================
        
        function startTimedQuest(questId) {
            const quest = TIMED_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            if (!state.timedQuests) state.timedQuests = [];
            
            state.timedQuests.push({
                id: quest.id,
                startTime: Date.now(),
                endTime: Date.now() + quest.timeLimit,
                objectives: quest.objectives.map(o => ({...o, completed: false})),
                failed: false,
                completed: false
            });
            
            addLog(`‚è∞ Nov√Ω ƒçasov√Ω √∫kol: ${quest.name}!`, 'üìã');
            notifyWarning('ƒåasov√Ω √∫kol!', `${quest.name} - ` + (`m√°≈° ${Math.floor(quest.timeLimit / 60000)} minut!`));
        }
        
        function updateTimedQuests() {
            if (!state.timedQuests) return;
            
            const now = Date.now();
            state.timedQuests.forEach(tq => {
                if (tq.completed || tq.failed) return;
                
                // Kontrola ƒçasu
                if (now >= tq.endTime) {
                    tq.failed = true;
                    const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                    if (quest?.failureConsequence) {
                        applyTimedQuestFailure(quest);
                    }
                }
            });
        }
        
        function applyTimedQuestFailure(quest) {
            addLog(`‚ùå √ökol selhal: ${quest.name}`, 'üíÄ');
            notifyError('√ökol selhal!', quest.failureConsequence.text);
            
            if (quest.failureConsequence.penalty) {
                const p = quest.failureConsequence.penalty;
                if (p.reputation) {
                    Object.entries(p.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                    });
                }
                if (p.karma) state.karma = (state.karma || 0) + p.karma;
                if (p.settlers) state.settlement.settlers = Math.max(0, (state.settlement?.settlers || 0) + p.settlers);
            }
        }
        
        function completeTimedQuest(questId) {
            const tqIdx = state.timedQuests?.findIndex(q => q.id === questId);
            if (tqIdx === -1) return;
            
            const tq = state.timedQuests[tqIdx];
            const quest = TIMED_QUESTS.find(q => q.id === questId);
            
            tq.completed = true;
            
            // Aplikuj odmƒõny
            if (quest.reward) {
                if (quest.reward.money) addMoney(quest.reward.money);
                if (quest.reward.xp) addXP(quest.reward.xp);
                if (quest.reward.reputation) {
                    Object.entries(quest.reward.reputation).forEach(([faction, amt]) => {
                        if (!state.factionReputation) state.factionReputation = {};
                        state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                    });
                }
                // NOV√â: Companion reward
                if (quest.reward.companion) {
                    const companionNames = ['Max', 'Elena', 'Viktor', 'Anna', 'Karel', 'Marie', 'Pavel', 'Zuzana'];
                    const newCompanion = {
                        id: 'survivor', // Pou≈æije survivor skill tree
                        uniqueId: 'companion_' + Date.now(),
                        name: companionNames[Math.floor(Math.random() * companionNames.length)],
                        icon: 'üßë',
                        type: 'human',
                        hp: 50 + Math.floor(Math.random() * 30),
                        maxHp: 80,
                        damage: 8 + Math.floor(Math.random() * 5),
                        defense: 4 + Math.floor(Math.random() * 3),
                        level: 1,
                        xp: 0,
                        skillPoints: 1,
                        skills: [],
                        equipped: { weapon: null, armor: null, helmet: null, gloves: null, boots: null },
                        loyalty: 60 + Math.floor(Math.random() * 20),
                        ability: 'P≈ôe≈æiv≈°√≠',
                        abilityDesc: 'Zku≈°en√Ω p≈ôe≈æiv≈°√≠ apokalypsy',
                        canEquip: true,
                        inCombat: true
                    };
                    addCompanionWithSwap(newCompanion, 'quest');
                }
            }
            
            addLog(`‚úÖ √ökol splnƒõn: ${quest.name}!`, 'üèÜ');
            notifySuccess('√ökol splnƒõn!', quest.name);
            
            // Zobraz modal s odmƒõnou
            showModal('üèÜ Quest dokonƒçen!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${quest.icon}</div>
                    <h3 style="color: #4caf50;">${quest.name}</h3>
                    <p style="color: #888;">Splnil jsi v≈°echny c√≠le vƒças!</p>
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px; margin: 1rem 0;">
                        <p style="color: #4caf50; margin: 0;">
                            üéÅ Odmƒõna: ${quest.reward.money || 0} üí∞, ${quest.reward.xp || 0} XP
                        </p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%;">‚úì V√Ωbornƒõ!</button>
                </div>
            `);
        }
        
        // Kontrola splnƒõn√≠ c√≠l≈Ø timed quest≈Ø
        function checkTimedQuestObjectives(action, target) {
            if (!state.timedQuests) return;
            
            state.timedQuests.filter(tq => !tq.completed && !tq.failed).forEach(tq => {
                const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                if (!quest) return;
                
                let allComplete = true;
                
                tq.objectives.forEach((obj, i) => {
                    if (obj.completed) return;
                    
                    const questObj = quest.objectives[i];
                    
                    // Kontrola podle typu c√≠le
                    if (questObj.type === 'location' && action === 'location' && target === questObj.target) {
                        obj.completed = true;
                        addLog(`‚úì C√≠l splnƒõn: ${questObj.text}`, 'üìã');
                    }
                    if (questObj.type === 'item' && action === 'item' && state.inv.some(i => i.id === questObj.target)) {
                        obj.completed = true;
                        addLog(`‚úì C√≠l splnƒõn: ${questObj.text}`, 'üìã');
                    }
                    if (questObj.type === 'combat' && action === 'combat_victory') {
                        obj.completed = true;
                        addLog(`‚úì C√≠l splnƒõn: ${questObj.text}`, 'üìã');
                    }
                    // Interact se spln√≠ automaticky po splnƒõn√≠ p≈ôedchoz√≠ch c√≠l≈Ø na spr√°vn√© lokaci
                    if (questObj.type === 'interact' && action === 'interact' && target === questObj.id) {
                        obj.completed = true;
                        addLog(`‚úì C√≠l splnƒõn: ${questObj.text}`, 'üìã');
                    }
                    // Search - prohled√°n√≠ lokace (vol√° se p≈ôi explore/search akci)
                    if (questObj.type === 'search' && action === 'search' && target === questObj.target) {
                        obj.completed = true;
                        addLog(`‚úì C√≠l splnƒõn: ${questObj.text}`, 'üîç');
                    }
                    // Skill check - kontrola dovednosti (vol√° se p≈ôi pou≈æit√≠ skillu)
                    if (questObj.type === 'skill_check' && action === 'skill_check') {
                        // Kontrola po≈æadovan√©ho skillu
                        const requiredSkill = questObj.skill || 'int';
                        const requiredValue = questObj.value || 5;
                        const playerValue = state.char.attrs[requiredSkill] || 0;
                        
                        if (playerValue >= requiredValue) {
                            obj.completed = true;
                            addLog(`‚úì C√≠l splnƒõn: ${questObj.text}`, 'üéØ');
                        } else {
                            addLog(`‚ùå Nesplnƒõno: Pot≈ôebuje≈° ${requiredSkill.toUpperCase()} ${requiredValue}+`, 'üéØ');
                        }
                    }
                    
                    if (!obj.completed) allComplete = false;
                });
                
                // V≈°echny c√≠le splnƒõny?
                if (allComplete) {
                    completeTimedQuest(tq.id);
                }
            });
        }
        
        // Dokonƒç√≠ interact objective v timed questu
        function completeInteractObjective(objectiveId) {
            checkTimedQuestObjectives('interact', objectiveId);
            
            // Speci√°ln√≠ efekty pro r≈Øzn√© objectives
            if (objectiveId === 'free_hostage') {
                showModal('üôè Rukojm√≠ osvobozen!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üôè</div>
                        <h3 style="color: #8bc34a;">Zachr√°nil jsi rukojm√≠!</h3>
                        <p style="color: #888;">"Dƒõkuji ti! Myslel jsem, ≈æe um≈ôu..."</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">‚úì V√Ωbornƒõ!</button>
                `);
                SoundSystem.play('victory');
            } else if (objectiveId === 'find_mother') {
                showModal('üë© Matka nalezena!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üë©</div>
                        <h3 style="color: #8bc34a;">Na≈°el jsi matku d√≠tƒõte!</h3>
                        <p style="color: #888;">"Moje d√≠tƒõ! Kde je?"</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">‚úì V√Ωbornƒõ!</button>
                `);
                SoundSystem.play('victory');
            } else if (objectiveId === 'find_survivor') {
                showModal('üìª P≈ôe≈æiv≈°√≠ nalezen!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üë§</div>
                        <h3 style="color: #8bc34a;">Na≈°el jsi zdroj sign√°lu!</h3>
                        <p style="color: #888;">"Koneƒçnƒõ nƒõkdo p≈ôi≈°el!"</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #4caf50;">‚úì V√Ωbornƒõ!</button>
                `);
                SoundSystem.play('victory');
            }
            
            renderFull();
        }
        
        // Kontrola splnƒõn√≠ c√≠l≈Ø companion quest≈Ø
        function checkCompanionQuestObjectives(action, target) {
            if (!state.companions) return;
            
            state.companions.forEach(comp => {
                if (!comp.activeQuest) return;
                
                const questData = COMPANION_QUESTS[comp.id];
                if (!questData) return;
                
                const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
                if (!chapter) return;
                
                let allComplete = true;
                
                comp.activeQuest.objectives.forEach((obj, i) => {
                    if (obj.completed) return;
                    
                    const chapterObj = chapter.objectives[i];
                    
                    // Kontrola podle typu c√≠le
                    if (chapterObj.type === 'location' && action === 'location' && target === chapterObj.target) {
                        obj.completed = true;
                        addLog(`üíù ${comp.name}: C√≠l splnƒõn!`, 'üìã');
                    }
                    if (chapterObj.type === 'explore' && action === 'explore' && target === chapterObj.target) {
                        obj.completed = true;
                        addLog(`üíù ${comp.name}: C√≠l splnƒõn!`, 'üìã');
                    }
                    if (chapterObj.type === 'item' && action === 'item' && state.inv.some(i => i.id === chapterObj.target)) {
                        obj.completed = true;
                        addLog(`üíù ${comp.name}: C√≠l splnƒõn!`, 'üìã');
                    }
                    if (chapterObj.type === 'combat' && action === 'combat_victory') {
                        obj.completed = true;
                        addLog(`üíù ${comp.name}: C√≠l splnƒõn!`, 'üìã');
                    }
                    
                    if (!obj.completed) allComplete = false;
                });
                
                // V≈°echny c√≠le splnƒõny?
                if (allComplete) {
                    completeCompanionQuest(comp.id);
                }
            });
        }
        
        function renderTimedQuestTracker() {
            if (!state.timedQuests || state.timedQuests.filter(q => !q.completed && !q.failed).length === 0) return '';
            
            const activeQuests = state.timedQuests.filter(q => !q.completed && !q.failed);
            const now = Date.now();
            
            return activeQuests.map(tq => {
                const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                if (!quest) return '';
                
                const remaining = Math.max(0, tq.endTime - now);
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const urgency = remaining < 10 * 60000 ? '#f44336' : remaining < 30 * 60000 ? '#ff9800' : '#4caf50';
                
                // Najdi prvn√≠ nesplnƒõn√Ω c√≠l s lokac√≠
                const nextObjective = tq.objectives.find(o => !o.completed);
                let targetLocation = null;
                if (nextObjective) {
                    const questObj = quest.objectives.find(qo => qo.id === nextObjective.id);
                    if (questObj?.target) {
                        targetLocation = WORLD_LOCATIONS.find(l => l.id === questObj.target);
                    } else if (questObj?.location) {
                        targetLocation = WORLD_LOCATIONS.find(l => l.id === questObj.location);
                    }
                }
                
                return `
                    <div style="background: #1a1a2a; padding: 0.6rem; border-radius: 6px; border-left: 3px solid ${urgency}; margin-bottom: 0.5rem; cursor: pointer;" onclick="showTimedQuestDetail('${tq.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">${quest.icon} ${quest.name}</span>
                            <span style="color: ${urgency}; font-family: monospace; font-size: 1.1rem; ${remaining < 10 * 60000 ? 'animation: pulse 1s infinite;' : ''}">‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}</span>
                        </div>
                        ${targetLocation ? `<div style="font-size: 0.75rem; color: #64b5f6; margin-top: 0.3rem;">üìç C√≠l: ${targetLocation.icon} ${targetLocation.name}</div>` : ''}
                        <div style="font-size: 0.8rem; color: #888; margin-top: 0.3rem;">${nextObjective ? '‚Üí ' + quest.objectives.find(o => o.id === nextObjective.id)?.text : quest.description}</div>
                    </div>
                `;
            }).join('');
        }
        
        function showTimedQuestDetail(questId) {
            const tq = state.timedQuests?.find(q => q.id === questId);
            const quest = TIMED_QUESTS.find(q => q.id === questId);
            if (!tq || !quest) return;
            
            const remaining = Math.max(0, tq.endTime - Date.now());
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            const urgency = remaining < 10 * 60000 ? '#f44336' : remaining < 30 * 60000 ? '#ff9800' : '#4caf50';
            
            let objectivesHtml = quest.objectives.map((obj, i) => {
                const done = tq.objectives[i]?.completed;
                let locationInfo = '';
                
                if (obj.target) {
                    const loc = WORLD_LOCATIONS.find(l => l.id === obj.target);
                    if (loc) locationInfo = ` ‚Üí ${loc.icon} ${loc.name} (${loc.x}, ${loc.y})`;
                } else if (obj.location) {
                    const loc = WORLD_LOCATIONS.find(l => l.id === obj.location);
                    if (loc) locationInfo = ` ‚Üí ${loc.icon} ${loc.name} (${loc.x}, ${loc.y})`;
                }
                
                return `
                    <div style="padding: 0.4rem; background: ${done ? '#1a2a1a' : '#2a1a1a'}; border-radius: 4px; margin-bottom: 0.3rem;">
                        <span style="color: ${done ? '#4caf50' : '#ff9800'};">${done ? '‚úì' : '‚óã'}</span>
                        ${obj.text}
                        ${locationInfo ? `<div style="font-size: 0.75rem; color: #64b5f6; margin-top: 0.2rem;">${locationInfo}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            showModal(`${quest.icon} ${quest.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem; color: ${urgency}; font-family: monospace; ${remaining < 10 * 60000 ? 'animation: pulse 1s infinite;' : ''}">
                        ‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}
                    </div>
                    <p style="color: #888;">${quest.description}</p>
                </div>
                
                <h4 style="color: #ffd700; margin-bottom: 0.5rem;">üìã C√≠le:</h4>
                ${objectivesHtml}
                
                <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 6px; margin-top: 1rem; border: 1px solid #f44336;">
                    <p style="color: #f44336; font-size: 0.85rem; margin: 0;">
                        ‚ö†Ô∏è P≈ôi selh√°n√≠: ${quest.failureConsequence.text}
                    </p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${'Zpƒõt'}</button>
            `);
        }
        
        // ============================================================
        // === üîç DETEKTIVN√ç QUESTY ===
        // ============================================================
        
        function startDetectiveQuest(questId) {
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            if (!state.detectiveQuests) state.detectiveQuests = {};
            
            state.detectiveQuests[questId] = {
                id: questId,
                startTime: Date.now(),
                endTime: quest.timeLimit ? Date.now() + quest.timeLimit : null,
                cluesFound: [],
                suspectsInterrogated: [],
                accusation: null,
                solved: false
            };
            
            addLog(`üîç Nov√Ω p≈ô√≠pad: ${quest.name}`, 'üìã');
            showDetectiveQuestIntro(quest);
        }
        
        function showDetectiveQuestIntro(quest) {
            let suspectsHtml = quest.suspects.map(s => `
                <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span style="font-size: 1.5rem;">${s.icon}</span>
                    <div>
                        <div style="font-weight: bold;">${s.name}</div>
                        <div style="font-size: 0.8rem; color: #888;">Motiv: ${s.motive}</div>
                    </div>
                </div>
            `).join('');
            
            showModal(`üîç ${quest.name}`, `
                <div style="margin-bottom: 1rem;">
                    <p style="color: #ccc; line-height: 1.5;">${quest.description}</p>
                </div>
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">Podez≈ôel√≠:</h4>
                ${suspectsHtml}
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px; margin-top: 1rem;">
                    <p style="color: #4caf50; margin: 0;">üí° Sb√≠rej stopy na r≈Øzn√Ωch lokac√≠ch a vysl√Ωchej podez≈ôel√©. A≈æ bude≈° m√≠t ${quest.requiredClues} stopy, m≈Ø≈æe≈° nƒõkoho obvinit.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">üîç Zaƒç√≠t vy≈°et≈ôov√°n√≠</button>
            `);
        }
        
        function findClue(questId, clueId) {
            if (!state.detectiveQuests?.[questId]) return false;
            
            const dq = state.detectiveQuests[questId];
            if (dq.cluesFound.includes(clueId)) return false;
            
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!quest) return false;
            
            dq.cluesFound.push(clueId);
            
            // Najdi ke kter√© stopƒõ pat≈ô√≠
            let suspectName = '';
            quest.suspects.forEach(s => {
                if (s.clues.includes(clueId)) suspectName = s.name;
            });
            
            const clueNames = {
                'bloody_knife': 'üî™ Zakrv√°cen√Ω n≈Ø≈æ',
                'torn_cloth': 'üëî Roztrhan√© obleƒçen√≠',
                'angry_letter': 'üìù Zlostn√Ω dopis',
                'witness_testimony': 'üëÅÔ∏è Svƒõdectv√≠ svƒõdka',
                'perfume_bottle': 'üß¥ Lahviƒçka parf√©mu',
                'love_letter': 'üíå Milostn√Ω dopis',
                'debt_note': 'üìã Dlu≈æn√≠ √∫pis',
                'brass_knuckles': 'üëä Boxery',
                'child_toy': 'üß∏ Dƒõtsk√° hraƒçka',
                'footprints': 'üë£ Stopy',
                'slaver_note': 'üìú Zpr√°va otrok√°≈ô≈Ø',
                'cage_marks': '‚õìÔ∏è Stopy po kleci',
                'chemical_residue': 'üß™ Chemick√© reziduum',
                'lab_notes': 'üìí Laboratorn√≠ z√°pisky',
                'faction_symbol': '‚öîÔ∏è Symbol frakce',
                'poison_vial': '‚ò†Ô∏è Lahviƒçka jedu'
            };
            
            showModal('üîç Stopa nalezena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${clueNames[clueId]?.split(' ')[0] || 'üîç'}</div>
                    <h3 style="color: #ffd700;">${clueNames[clueId] || clueId}</h3>
                    ${suspectName ? `<p style="color: #888;">Ukazuje na: <strong>${suspectName}</strong></p>` : ''}
                    <p style="margin-top: 1rem;">Stopy: ${dq.cluesFound.length}/${quest.requiredClues}</p>
                    ${dq.cluesFound.length >= quest.requiredClues ? 
                        `<p style="color: #4caf50;">${'‚úì M√°≈° dost stop! M≈Ø≈æe≈° obvinit podez≈ôel√©ho.'}</p>` : ''}
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì Pokraƒçovat</button>
                </div>
            `);
            
            return true;
        }
        
        function accuseSuspect(questId, suspectId) {
            const dq = state.detectiveQuests?.[questId];
            if (!dq) return;
            
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!quest) return;
            
            if (dq.cluesFound.length < quest.requiredClues) {
                notifyWarning('Nedostatek d≈Økaz≈Ø!', `Pot≈ôebuje≈° alespo≈à ${quest.requiredClues} stop.`);
                return;
            }
            
            const suspect = quest.suspects.find(s => s.id === suspectId);
            if (!suspect) return;
            
            dq.accusation = suspectId;
            dq.solved = true;
            
            if (suspect.isGuilty) {
                // Spr√°vn√© obvinƒõn√≠!
                addLog(`üéâ P≈ô√≠pad vy≈ôe≈°en! ${suspect.name} byl vinen!`, 'üîç');
                
                if (quest.reward) {
                    if (quest.reward.money) addMoney(quest.reward.money);
                    if (quest.reward.xp) addXP(quest.reward.xp);
                    if (quest.reward.reputation) {
                        Object.entries(quest.reward.reputation).forEach(([faction, amt]) => {
                            if (!state.factionReputation) state.factionReputation = {};
                            state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        });
                    }
                    if (quest.reward.title) {
                        if (!state.titles) state.titles = [];
                        state.titles.push(quest.reward.title);
                    }
                }
                
                showModal('üéâ P≈ô√≠pad vy≈ôe≈°en!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üèÜ</div>
                        <h3 style="color: #4caf50;">${suspect.name} byl vinen!</h3>
                        <p>Tvoje dedukce byla spr√°vn√°. Spravedlnosti bylo uƒçinƒõno zadost.</p>
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px; margin: 1rem 0;">
                            <p style="color: #4caf50;">Odmƒõna: ${quest.reward.money || 0} üí∞, ${quest.reward.xp || 0} XP</p>
                            ${quest.reward.title ? `<p style="color: #ffd700;">üèÖ Nov√Ω titul: ${quest.reward.title}</p>` : ''}
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%;">‚úì V√Ωbornƒõ!</button>
                    </div>
                `);
            } else {
                // ≈†patn√© obvinƒõn√≠
                addLog(`‚ùå ≈†patn√© obvinƒõn√≠! ${suspect.name} byl nevinn√Ω!`, 'üîç');
                
                if (quest.wrongAccusation?.penalty) {
                    const p = quest.wrongAccusation.penalty;
                    if (p.reputation) {
                        Object.entries(p.reputation).forEach(([faction, amt]) => {
                            if (!state.factionReputation) state.factionReputation = {};
                            state.factionReputation[faction] = (state.factionReputation[faction] || 0) + amt;
                        });
                    }
                    if (p.karma) state.karma = (state.karma || 0) + p.karma;
                }
                
                showModal('‚ùå ≈†patn√© obvinƒõn√≠!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üòî</div>
                        <h3 style="color: #f44336;">${suspect.name} byl nevinn√Ω!</h3>
                        <p>${quest.wrongAccusation?.text || 'Obvinil jsi nevinn√©ho ƒçlovƒõka.'}</p>
                        <p style="color: #ff9800; margin-top: 1rem;">Skuteƒçn√Ω pachatel unikl...</p>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">üòû Pokraƒçovat</button>
                    </div>
                `);
            }
        }
        
        function showDetectiveQuestStatus(questId) {
            const dq = state.detectiveQuests?.[questId];
            const quest = DETECTIVE_QUESTS.find(q => q.id === questId);
            if (!dq || !quest) return;
            
            const clueNames = {
                'bloody_knife': 'üî™ Zakrv√°cen√Ω n≈Ø≈æ',
                'torn_cloth': 'üëî Roztrhan√© obleƒçen√≠',
                'angry_letter': 'üìù Zlostn√Ω dopis',
                'witness_testimony': 'üëÅÔ∏è Svƒõdectv√≠',
                'perfume_bottle': 'üß¥ Parf√©m',
                'love_letter': 'üíå Milostn√Ω dopis',
                'debt_note': 'üìã Dlu≈æn√≠ √∫pis',
                'brass_knuckles': 'üëä Boxery'
            };
            
            let cluesHtml = dq.cluesFound.length > 0 ? 
                dq.cluesFound.map(c => `<span style="background: #2a2a1a; padding: 0.2rem 0.5rem; border-radius: 3px; margin: 0.2rem;">${clueNames[c] || c}</span>`).join('') :
                '<span style="color: #666;">Zat√≠m ≈æ√°dn√© stopy</span>';
            
            let suspectsHtml = quest.suspects.map(s => {
                const cluesForSuspect = s.clues.filter(c => dq.cluesFound.includes(c)).length;
                const canAccuse = dq.cluesFound.length >= quest.requiredClues;
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.6rem; border-radius: 4px; margin-bottom: 0.3rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">${s.icon}</span>
                            <div>
                                <div style="font-weight: bold;">${s.name}</div>
                                <div style="font-size: 0.75rem; color: #888;">Stopy: ${cluesForSuspect}/${s.clues.length}</div>
                            </div>
                        </div>
                        ${canAccuse ? `<button class="btn" onclick="accuseSuspect('${questId}', '${s.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #c62828;">‚öñÔ∏è Obvinit</button>` : ''}
                    </div>
                `;
            }).join('');
            
            showModal(`üîç ${quest.name}`, `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #ffd700;">üìã Nalezen√© stopy (${dq.cluesFound.length}/${quest.requiredClues}):</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin: 0.5rem 0;">
                        ${cluesHtml}
                    </div>
                </div>
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">Podez≈ôel√≠:</h4>
                ${suspectsHtml}
                ${dq.cluesFound.length < quest.requiredClues ? 
                    `<p style="color: #888; font-size: 0.85rem; margin-top: 1rem;">${'üí° Najdi v√≠ce stop ne≈æ bude≈° moci nƒõkoho obvinit.'}</p>` : 
                    `<p style="color: #4caf50; font-size: 0.85rem; margin-top: 1rem;">${'‚úì M√°≈° dost d≈Økaz≈Ø! Vyber podez≈ôel√©ho a obvi≈à ho.'}</p>`}
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        // ============================================================
        // === üë• COMPANION QUESTY ===
        // ============================================================
        
        function checkCompanionQuests() {
            if (!state.companions || state.companions.length === 0) return;
            
            state.companions.forEach(comp => {
                const questData = COMPANION_QUESTS[comp.id];
                if (!questData) return;
                
                if (!comp.completedQuests) comp.completedQuests = [];
                if (!comp.activeQuest) {
                    // Hledej nov√Ω quest
                    for (const chapter of questData.chapters) {
                        if (comp.completedQuests.includes(chapter.id)) continue;
                        if (checkCompanionQuestTrigger(comp.id, chapter)) {
                            triggerCompanionQuest(comp.id, chapter);
                            break;
                        }
                    }
                }
            });
        }
        
        function triggerCompanionQuest(companionId, chapter) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp) return;
            
            comp.activeQuest = {
                id: chapter.id,
                objectives: chapter.objectives.map(o => ({...o, completed: false})),
                startTime: Date.now()
            };
            
            const questData = COMPANION_QUESTS[companionId];
            
            // === SPAWN QUEST ITEMS ===
            // Pro ka≈æd√Ω objective typu 'item', spawnuj item na p≈ô√≠slu≈°n√© lokaci
            chapter.objectives.forEach(obj => {
                if (obj.type === 'item' && obj.target) {
                    // Urƒçi spawn lokaci
                    const spawnLocations = {
                        'old_collar': 'old_farm',
                        'dogtags': 'military_base',
                        'medical_records': 'hospital',
                        'lab_samples': 'research_facility',
                        'secret_documents': 'underground_bunker',
                        'family_photo': 'ruined_houses',
                        'old_toy': 'playground',
                        'ancient_relic': 'ancient_ruins'
                    };
                    
                    const spawnLocation = spawnLocations[obj.target] || chapter.trigger?.location || 'shelter';
                    
                    // Ulo≈æ quest item do world state
                    if (!state.world.questItemSpawns) state.world.questItemSpawns = {};
                    state.world.questItemSpawns[obj.target] = {
                        location: spawnLocation,
                        companion: companionId,
                        questId: chapter.id
                    };
                    
                    console.log(`üì¶ Spawned quest item: ${obj.target} at ${spawnLocation}`);
                }
            });
            
            // Pokud prob√≠h√° boj, odlo≈æ zobrazen√≠ questu
            if (isInCombat()) {
                // Ulo≈æ pro zobrazen√≠ po boji
                if (!state._pendingCompanionQuests) state._pendingCompanionQuests = [];
                state._pendingCompanionQuests.push({ companionId, chapter, questData, comp });
                notifySuccess(`üíù ${comp.name}`, 'M√° pro tebe nov√Ω √∫kol!');
                addLog(`üíù ${comp.name} m√° pro tebe √∫kol: ${chapter.title}`, 'üêæ');
                return;
            }
            
            showModal(`${questData.icon} ${questData.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${comp.icon}</div>
                    <h3 style="color: #ffd700;">${chapter.title}</h3>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ccc; font-style: italic; line-height: 1.5;">"${chapter.dialog.start}"</p>
                </div>
                <p style="color: #888; margin-bottom: 1rem;">${chapter.description}</p>
                <h4 style="color: #ff9800;">C√≠le:</h4>
                <ul style="color: #ccc; margin: 0.5rem 0;">
                    ${chapter.objectives.map(o => `<li>${o.text}</li>`).join('')}
                </ul>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">üêæ Pom≈Ø≈æu ti!</button>
            `);
            
            addLog(`üíù ${comp.name} m√° pro tebe √∫kol: ${chapter.title}`, 'üêæ');
        }
        
        // P≈ôed√°n√≠ quest itemu spoleƒçn√≠kovi
        function deliverQuestItemToCompanion(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.activeQuest) return;
            
            // Najdi quest data
            const questData = COMPANION_QUESTS[comp.id];
            if (!questData) return;
            
            const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
            if (!chapter) return;
            
            // Najdi item objective
            const itemObjective = chapter.objectives.find(o => o.type === 'item');
            if (!itemObjective) return;
            
            // Kontrola jestli m√°≈° item
            const item = state.inv.find(i => i.id === itemObjective.target);
            if (!item) {
                notifyWarning('Chyb√≠ p≈ôedmƒõt', `Nem√°≈° ${itemObjective.text}`);
                return;
            }
            
            // Odeber item z invent√°≈ôe
            removeItemFromInventory(item, 1);
            
            // Oznaƒç objective jako splnƒõn√Ω
            const questObj = comp.activeQuest.objectives.find(o => {
                const chapterObj = chapter.objectives.find(co => co.text === o.text);
                return chapterObj && chapterObj.type === 'item';
            });
            if (questObj) questObj.completed = true;
            
            // Zkontroluj jestli jsou v≈°echny c√≠le splnƒõny
            const allComplete = comp.activeQuest.objectives.every(o => o.completed);
            
            if (allComplete) {
                completeCompanionQuest(companionId);
            } else {
                notifySuccess('üì¶ P≈ôed√°no!', `${comp.name} obdr≈æel ${item.name}`);
                addLog(`üì¶ P≈ôedal jsi ${item.name} spoleƒçn√≠kovi ${comp.name}`, 'üíù');
                showCompanionsInfo(); // Refresh
            }
            
            saveGame();
        }
        
        // Zjist√≠ jestli spoleƒçn√≠k ƒçek√° na quest item
        function getCompanionPendingQuestItem(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.activeQuest) return null;
            
            const questData = COMPANION_QUESTS[comp.id];
            if (!questData) return null;
            
            const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
            if (!chapter) return null;
            
            // Najdi nesplnƒõn√Ω item objective
            for (let i = 0; i < chapter.objectives.length; i++) {
                const obj = chapter.objectives[i];
                const questObj = comp.activeQuest.objectives[i];
                
                if (obj.type === 'item' && !questObj?.completed) {
                    // M√° hr√°ƒç tento item?
                    const hasItem = state.inv.some(item => item.id === obj.target);
                    if (hasItem) {
                        const itemDef = QUEST_ITEMS.find(qi => qi.id === obj.target) || ITEMS.find(it => it.id === obj.target);
                        return {
                            itemId: obj.target,
                            itemName: itemDef?.name || obj.target,
                            itemIcon: itemDef?.icon || 'üì¶'
                        };
                    }
                }
            }
            return null;
        }
        
        function completeCompanionQuest(companionId) {
            const comp = state.companions.find(c => c.id === companionId || c.uniqueId === companionId);
            if (!comp || !comp.activeQuest) return;
            
            const questData = COMPANION_QUESTS[companionId];
            const chapter = questData.chapters.find(c => c.id === comp.activeQuest.id);
            if (!chapter) return;
            
            comp.completedQuests.push(chapter.id);
            
            // Aplikuj odmƒõny
            if (chapter.reward) {
                if (chapter.reward.companionXP) {
                    comp.xp = (comp.xp || 0) + chapter.reward.companionXP;
                }
                if (chapter.reward.bond) {
                    comp.loyalty = (comp.loyalty || 50) + chapter.reward.bond;
                }
                if (chapter.reward.skill) {
                    if (!comp.unlockedSkills) comp.unlockedSkills = [];
                    comp.unlockedSkills.push(chapter.reward.skill);
                }
                if (chapter.reward.stats) {
                    Object.entries(chapter.reward.stats).forEach(([stat, val]) => {
                        comp[stat] = (comp[stat] || 0) + val;
                    });
                }
            }
            
            showModal(`üíù Quest dokonƒçen!`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${comp.icon}</div>
                    <h3 style="color: #4caf50;">${chapter.title}</h3>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p style="color: #ccc; font-style: italic;">"${chapter.dialog.complete}"</p>
                </div>
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 6px;">
                    <p style="color: #4caf50; margin: 0;">
                        ${chapter.reward.bond ? `+${chapter.reward.bond} Pouto` : ''}
                        ${chapter.reward.skill ? ` | üÜï Nov√° schopnost: ${chapter.reward.skill}` : ''}
                    </p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">üíù Skvƒõl√©!</button>
            `);
            
            comp.activeQuest = null;
            addLog(`üíù ${comp.name}: Quest splnƒõn!`, 'üèÜ');
        }
        
        // Aktualizace p≈ôi game tick
        setInterval(() => {
            updateTimedQuests();
            checkCompanionQuests();
        }, 10000); // Ka≈æd√Ωch 10 sekund
        
        // Fronta pro level up zpr√°vy bƒõhem boje
        let pendingLevelUp = null;
        
        // Vypoƒç√≠t√° level z celkov√Ωch XP
        // Level 1: 0 XP, Level 2: 100 XP, Level 3: 250 XP, Level 4: 475 XP, ...
        // Vzorec pro XP pot≈ôebn√© na level N: sum(100 * 1.5^(i-1)) pro i=1 to N-1
        function getLevelFromTotalXP(totalXP) {
            let level = 1;
            let xpNeeded = 0;
            while (true) {
                const xpForNextLevel = Math.floor(BASE_XP * Math.pow(1.5, level - 1));
                if (xpNeeded + xpForNextLevel > totalXP) break;
                xpNeeded += xpForNextLevel;
                level++;
                if (level > 100) break; // Max level cap
            }
            return level;
        }
        
        // Vypoƒç√≠t√° celkov√© XP pot≈ôebn√© pro dosa≈æen√≠ dan√©ho levelu
        function getTotalXPForLevel(level) {
            let total = 0;
            for (let i = 1; i < level; i++) {
                total += Math.floor(BASE_XP * Math.pow(1.5, i - 1));
            }
            return total;
        }
        
        // Vypoƒç√≠t√° XP pot≈ôebn√© pro dal≈°√≠ level
        function getXPForNextLevel(level) {
            return Math.floor(BASE_XP * Math.pow(1.5, level - 1));
        }
        
        function addXP(amount) {
            // === XP SYST√âM ZALO≈ΩEN√ù NA TOTALXP ===
            // totalXP = celkov√© z√≠skan√© XP (nikdy nekles√°)
            // level = vypoƒç√≠t√°no z totalXP
            // xp = progress k dal≈°√≠mu levelu
            // xpNeed = kolik pot≈ôebuje≈° pro dal≈°√≠ level
            
            // Validace pomoc√≠ safe utility
            amount = safeInteger(amount, 0, 0);
            if (amount <= 0) {
                console.warn('‚ùå addXP: neplatn√Ω amount:', amount);
                return;
            }
            
            let finalAmount = amount;
            
            // INT bonus (+10% za bod nad 5)
            const intBonus = Math.max(0, ((state.char?.attrs?.int || 5) - 5) * 0.1);
            finalAmount = Math.floor(finalAmount * (1 + intBonus));
            
            // Companion bonus
            if (typeof getAllCompanionBonuses === 'function') {
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.xpBonus > 0) {
                    finalAmount = Math.floor(finalAmount * (1 + compBonuses.xpBonus));
                }
            }
            
            // üìü Exotic bonus - P≈ôedv√°leƒçn√° tech (+25% XP na 48h)
            if (state.exoticBonuses?.xpBoost && state.exoticBonuses.xpBoost > Date.now()) {
                finalAmount = Math.floor(finalAmount * 1.25);
            }
            
            // üîµ Frakƒçn√≠ bonus - Koudyho nadƒõje (+5% XP)
            const factionBonus = getFactionBonus();
            if (factionBonus.xp > 0) {
                finalAmount = Math.floor(finalAmount * (1 + factionBonus.xp));
            }
            
            // Max 1000 XP najednou (anti-cheat)
            const MAX_XP_PER_ACTION = 1000;
            finalAmount = Math.min(finalAmount, MAX_XP_PER_ACTION);
            
            // Kontrola max level
            if ((state.char.level || 1) >= GAME_CONSTANTS.MAX_LEVEL) {
                console.log('üéÆ Max level dosa≈æen, XP se nep≈ôid√°v√°');
                return;
            }
            
            // P≈ôidej k totalXP s kontrolou maxima
            const oldLevel = state.char.level || 1;
            const newTotalXP = (state.char.totalXP || 0) + finalAmount;
            state.char.totalXP = Math.min(newTotalXP, GAME_CONSTANTS.MAX_XP);
            
            console.log(`üéÆ +${finalAmount} XP | TotalXP: ${state.char.totalXP}`);
            
            // Vypoƒç√≠tej level z totalXP
            recalculateLevelFromTotalXP();
            
            const levelsGained = state.char.level - oldLevel;
            
            // Floating number
            if (typeof showFloatingNumber === 'function') {
                showFloatingNumber(finalAmount, 'xp');
            }
            
            // Level up efekty
            if (levelsGained > 0) {
                state.char.skillPoints = (state.char.skillPoints || 0) + levelsGained;
                state.char.levelUpPoints = (state.char.levelUpPoints || 0) + levelsGained;
                state.skillTreePoints = (state.skillTreePoints || 0) + levelsGained;
                state.char.hp = state.char.maxHp;
                
                if (typeof checkAchievements === 'function') checkAchievements();
                if (typeof checkUnlocks === 'function') checkUnlocks();
                
                let lvlMsg = `üéâ LEVEL UP! Dos√°hl jsi level ${state.char.level}!`;
                if (levelsGained > 1) lvlMsg += ` (+${levelsGained} level≈Ø)`;
                lvlMsg += `<br>+${levelsGained} bod${levelsGained > 1 ? 'y' : ''} atribut≈Ø | +${levelsGained} bod${levelsGained > 1 ? 'y' : ''} schopnost√≠`;
                lvlMsg += `<br>‚ù§Ô∏è HP doplnƒõno na maximum!`;
                
                pendingLevelUp = { level: state.char.level, message: lvlMsg };
            }
            
            if (typeof renderFull === 'function') renderFull();
        }
        
        // P≈ôepoƒç√≠t√° level, xp a xpNeed z totalXP
        function recalculateLevelFromTotalXP() {
            const totalXP = state.char?.totalXP || 0;
            let level = 1;
            let xpUsed = 0;
            
            // Vzorec: xpNeed = BASE_XP * (XP_MULTIPLIER ^ (level-1))
            const BASE = GAME_CONSTANTS.BASE_XP_REQUIREMENT;
            const MULT = GAME_CONSTANTS.XP_MULTIPLIER;
            
            while (level < GAME_CONSTANTS.MAX_LEVEL) {
                const xpForThisLevel = Math.floor(BASE * Math.pow(MULT, level - 1));
                if (xpUsed + xpForThisLevel > totalXP) break;
                xpUsed += xpForThisLevel;
                level++;
            }
            
            state.char.level = level;
            state.char.xp = totalXP - xpUsed; // Zbytek XP
            state.char.xpNeed = Math.floor(BASE * Math.pow(MULT, level - 1)); // Kolik pot≈ôebuji pro dal≈°√≠ level
            
            console.log(`üìä Level: ${level}, XP: ${state.char.xp}/${state.char.xpNeed}, TotalXP: ${totalXP}`);
        }
        
        function getPendingLevelUp() {
            const lvl = pendingLevelUp;
            pendingLevelUp = null;
            return lvl;
        }
        
        // === INFO O ATRIBUTU ===
        // === QUEST TRACKER FUNCTIONS ===
        function showQuestTrackerDetail(questType) {
            if (questType === 'story') {
                // Zobraz detail p≈ô√≠bƒõhov√©ho questu
                const quest = MAIN_QUESTS.find(q => q.id === state.mainQuest?.currentQuest);
                if (quest) {
                    let objectivesHtml = '';
                    let allComplete = true;
                    
                    if (quest.objectives) {
                        objectivesHtml = '<div style="margin-top: 1rem;"><h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üìã C√≠le:</h4>';
                        quest.objectives.forEach(obj => {
                            const savedProgress = state.mainQuest?.questProgress?.[obj.id] || 0;
                            const target = obj.target;
                            let done = false;
                            let displayProgress = '';
                            
                            if (obj.type === 'location') {
                                // Kontroluj ulo≈æen√Ω progress NEBO aktu√°ln√≠ lokaci
                                done = savedProgress >= 1 || state.world.currentLocation === target;
                                // Automaticky ulo≈æ progress pokud jsme na c√≠lov√© lokaci
                                if (state.world.currentLocation === target && savedProgress < 1) {
                                    if (!state.mainQuest.questProgress) state.mainQuest.questProgress = {};
                                    state.mainQuest.questProgress[obj.id] = 1;
                                    done = true;
                                }
                            } else if (obj.type === 'visit_locations') {
                                const visited = state.world.visitedLocations?.length || 0;
                                done = visited >= target;
                                displayProgress = `(${Math.min(visited, target)}/${target})`;
                            } else if (obj.type === 'item') {
                                done = state.inv.some(i => i.id === target);
                            } else if (obj.type === 'explore') {
                                done = savedProgress >= target;
                                displayProgress = `(${savedProgress}/${target})`;
                            } else if (obj.type === 'kill') {
                                done = savedProgress >= 1;
                            } else {
                                done = savedProgress >= 1;
                            }
                            
                            if (!done) allComplete = false;
                            
                            const locName = obj.type === 'location' ? (WORLD_LOCATIONS.find(l => l.id === target)?.name || target) : null;
                            
                            objectivesHtml += `<div style="padding: 0.4rem; background: ${done ? '#1a2a1a' : '#1a1a1a'}; border-radius: 4px; margin-bottom: 0.3rem; border-left: 3px solid ${done ? '#4caf50' : '#666'};">
                                <span style="color: ${done ? '#8bc34a' : '#aaa'};">${done ? '‚úì' : '‚óã'} ${obj.text}</span>
                                ${displayProgress ? `<span style="color: #888; font-size: 0.8rem;"> ${displayProgress}</span>` : ''}
                                ${locName ? `<div style="font-size: 0.75rem; color: #666;">üìç ${locName}</div>` : ''}
                            </div>`;
                        });
                        objectivesHtml += '</div>';
                    }
                    
                    // Kontrola po≈æadovan√©ho itemu
                    const hasRequiredItem = !quest.requiresItem || state.inv.some(i => i.id === quest.requiresItem);
                    const canComplete = allComplete && hasRequiredItem;
                    
                    showModal('üìñ ' + quest.title, `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 0.8rem; color: #ffd700;">Kapitola ${quest.chapter}</div>
                        </div>
                        <p style="color: #aaa;">${quest.description || quest.desc || ''}</p>
                        ${objectivesHtml}
                        ${quest.reward ? `<div style="margin-top: 1rem; padding: 0.5rem; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <span style="color: #ffd700;">üéÅ Odmƒõna: ${quest.reward.xp || 0} XP, ${quest.reward.money || 0} üí∞</span>
                        </div>` : ''}
                        ${canComplete ? `
                            <button class="btn" onclick="manualCompleteQuest('${quest.id}')" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #4caf50, #2e7d32); font-weight: bold;">
                                ‚úÖ Dokonƒçit a z√≠skat odmƒõnu
                            </button>
                        ` : ''}
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: ${canComplete ? '0.5rem' : '1rem'}; background: #555;">${t('ui', 'close')}</button>
                    `);
                } else {
                    showModal('üìñ P≈ô√≠bƒõh', '<p style="color: #888;">≈Ω√°dn√Ω aktivn√≠ p≈ô√≠bƒõhov√Ω quest.</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>');
                }
            } else if (questType === 'npc') {
                // Zobraz seznam NPC quest≈Ø
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                let hasQuests = false;
                
                Object.entries(state.npcQuests || {}).forEach(([npcId, questData]) => {
                    if (questData?.id) {
                        hasQuests = true;
                        const quest = NPC_QUESTS[questData.id];
                        const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                        if (quest && npc) {
                            const locName = WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location;
                            const canComplete = checkNPCQuestProgress(questData, quest);
                            const isAtNpc = state.world.currentLocation === npc.location;
                            
                            html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${canComplete ? '#4caf50' : '#ff9800'};">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${npc.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: ${canComplete ? '#4caf50' : '#ff9800'};">${quest.name}</div>
                                        <div style="font-size: 0.8rem; color: #888;">Od: ${npc.name}</div>
                                    </div>
                                    ${canComplete ? '<span style="color: #4caf50;">‚úÖ</span>' : ''}
                                </div>
                                <p style="margin: 0; color: #aaa; font-size: 0.9rem;">${quest.desc}</p>
                                <div style="margin-top: 0.5rem; background: #0a0a0a; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                    ${renderQuestProgress(questData, quest)}
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">üìç Odevzdat: ${locName}</div>
                                <div style="margin-top: 0.3rem; font-size: 0.8rem; color: #ffd700;">üéÅ Odmƒõna: ${quest.reward?.money || 0} üí∞, ${quest.reward?.trust || 0} ‚ù§Ô∏è</div>
                                ${canComplete ? `
                                    ${isAtNpc ? `
                                        <button class="btn" onclick="completeNPCQuest('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: #4caf50;">‚úÖ Odevzdat quest</button>
                                    ` : `
                                        <div style="margin-top: 0.5rem; padding: 0.4rem; background: #2a2a1a; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #ff9800;">
                                            ‚ö†Ô∏è Jdi k ${npc.name} pro odevzd√°n√≠
                                        </div>
                                    `}
                                ` : ''}
                            </div>`;
                        }
                    }
                });
                
                if (!hasQuests) {
                    html += '<p style="color: #666; text-align: center;">≈Ω√°dn√© aktivn√≠ NPC questy.<br>Nav≈°tiv p≈ô√°telsk√° NPC pro nov√© √∫koly!</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('üë• NPC Questy', html);
                
            } else if (questType === 'daily') {
                // Zobraz denn√≠ questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                if (state.dailyQuests?.quests?.length > 0) {
                    state.dailyQuests.quests.forEach(q => {
                        const completed = state.dailyQuests.completed?.includes(q.id);
                        // Zjisti progress podle typu questu - pou≈æij progressKey a target z definice
                        let progress = 0;
                        let target = q.target || 1;
                        
                        // Najdi definici questu pro progressKey
                        const questDef = DAILY_QUEST_POOL.find(dq => dq.id === q.id);
                        if (questDef && questDef.progressKey) {
                            progress = state.dailyQuests.progress?.[questDef.progressKey] || 0;
                        } else {
                            // Fallback pro star√© questy
                            if (q.id === 'kill_enemies') { progress = state.dailyQuests.progress?.kills || 0; }
                            else if (q.id === 'explore_hexes') { progress = state.dailyQuests.progress?.explored || 0; }
                            else if (q.id === 'craft_items') { progress = state.dailyQuests.progress?.crafted || 0; }
                            else if (q.id === 'collect_money') { progress = state.dailyQuests.progress?.moneyEarned || 0; }
                            else if (q.id === 'travel_distance') { progress = state.dailyQuests.progress?.travelled || 0; }
                            else if (q.id === 'collect_loot') { progress = state.dailyQuests.progress?.itemsFound || 0; }
                            else if (q.id === 'feed_companion') { progress = state.dailyQuests.progress?.companionFed || 0; }
                        }
                        
                        // Odmƒõna podle typu
                        let rewardText = '';
                        if (q.id === 'kill_enemies') rewardText = '80 üí∞';
                        else if (q.id === 'explore_hexes') rewardText = '50 XP';
                        else if (q.id === 'craft_items') rewardText = '10üå≤ 5‚öôÔ∏è';
                        else if (q.id === 'collect_money') rewardText = '40 XP';
                        else if (q.id === 'travel_distance') rewardText = '60 üí∞ 20 XP';
                        else if (q.id === 'collect_loot') rewardText = '70 üí∞';
                        else if (q.id === 'feed_companion') rewardText = '25 XP';
                        else rewardText = 'üéÅ';
                        
                        html += `<div style="background: ${completed ? '#1a2a1a' : '#1a1a1a'}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${completed ? '#4caf50' : '#2196f3'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; color: ${completed ? '#8bc34a' : '#fff'};">${completed ? '‚úì' : '‚óã'} ${q.icon || ''} ${q.name}</span>
                                <span style="color: #ffd700; font-size: 0.8rem;">üéÅ ${rewardText}</span>
                            </div>
                            <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">${q.desc}</p>
                            <div style="margin-top: 0.5rem; background: #0a0a0a; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${Math.min(100, (progress/target)*100)}%; background: ${completed ? '#4caf50' : '#2196f3'};"></div>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.2rem;">${progress}/${target}</div>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">' + ('≈Ω√°dn√© denn√≠ questy.') + '</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('üìÖ Denn√≠ √∫koly', html);
                
            } else if (questType === 'settler') {
                // Zobraz osadnick√© questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                if (state.settlement?.activeQuests?.length > 0) {
                    state.settlement.activeQuests.forEach(sq => {
                        const questDef = SETTLER_QUESTS?.find(q => q.id === sq.questId);
                        html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #8bc34a;">
                            <div style="font-weight: bold; color: #8bc34a;">${questDef?.icon || 'üìã'} ${questDef?.name || sq.questId}</div>
                            <div style="font-size: 0.8rem; color: #888;">Od: ${sq.settlerName || 'Osadn√≠k'}</div>
                            <p style="margin: 0.3rem 0 0 0; color: #aaa; font-size: 0.85rem;">${questDef?.desc || ''}</p>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">≈Ω√°dn√© aktivn√≠ √∫koly od osadn√≠k≈Ø.</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('üèòÔ∏è √ökoly osadn√≠k≈Ø', html);
            } else if (questType === 'timed') {
                // Zobraz ƒçasovƒõ limitovan√© questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                const activeTimedQuests = state.timedQuests?.filter(q => !q.completed && !q.failed) || [];
                
                if (activeTimedQuests.length > 0) {
                    activeTimedQuests.forEach(tq => {
                        const quest = TIMED_QUESTS.find(q => q.id === tq.id);
                        if (!quest) return;
                        
                        const remaining = Math.max(0, tq.endTime - Date.now());
                        const minutes = Math.floor(remaining / 60000);
                        const seconds = Math.floor((remaining % 60000) / 1000);
                        const urgency = remaining < 5 * 60000 ? '#f44336' : remaining < 15 * 60000 ? '#ff9800' : '#4caf50';
                        
                        html += `
                            <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${urgency};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 1.5rem;">${quest.icon}</span>
                                    <span style="color: ${urgency}; font-family: monospace; font-size: 1.2rem; font-weight: bold;">‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}</span>
                                </div>
                                <h3 style="margin: 0.5rem 0; color: #fff;">${quest.name}</h3>
                                <p style="color: #888; margin: 0.3rem 0;">${quest.description}</p>
                                <div style="margin-top: 0.5rem; background: #0a0a0a; padding: 0.5rem; border-radius: 4px;">
                                    <h4 style="color: #ff9800; margin: 0 0 0.3rem 0; font-size: 0.9rem;">C√≠le:</h4>
                                    ${quest.objectives.map((obj, i) => {
                                        const completed = tq.objectives[i]?.completed;
                                        return `<div style="color: ${completed ? '#4caf50' : '#aaa'};">${completed ? '‚úì' : '‚óã'} ${obj.text}</div>`;
                                    }).join('')}
                                </div>
                                <div style="margin-top: 0.5rem; color: #ffd700; font-size: 0.85rem;">
                                    üéÅ Odmƒõna: ${quest.reward.money || 0} üí∞, ${quest.reward.xp || 0} XP
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">≈Ω√°dn√© ƒçasovƒõ limitovan√© questy.</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('‚è∞ ƒåasov√© questy', html);
            } else if (questType === 'companion') {
                // Zobraz companion questy
                let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                const companionsWithQuests = state.companions?.filter(c => c.activeQuest) || [];
                
                if (companionsWithQuests.length > 0) {
                    companionsWithQuests.forEach(comp => {
                        const questData = COMPANION_QUESTS[comp.id];
                        const chapter = questData?.chapters.find(c => c.id === comp.activeQuest.id);
                        if (!chapter) return;
                        
                        html += `
                            <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #e91e63;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 2rem;">${comp.icon}</span>
                                    <div>
                                        <div style="font-weight: bold; color: #e91e63;">${chapter.title}</div>
                                        <div style="font-size: 0.8rem; color: #888;">${comp.name}</div>
                                    </div>
                                </div>
                                <p style="color: #aaa; margin: 0.5rem 0;">${chapter.description}</p>
                                <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                    <h4 style="color: #ff9800; margin: 0 0 0.3rem 0; font-size: 0.9rem;">C√≠le:</h4>
                                    ${chapter.objectives.map((obj, i) => {
                                        const completed = comp.activeQuest.objectives[i]?.completed;
                                        return `<div style="color: ${completed ? '#4caf50' : '#aaa'};">${completed ? '‚úì' : '‚óã'} ${obj.text}</div>`;
                                    }).join('')}
                                </div>
                                <div style="margin-top: 0.5rem; color: #ffd700; font-size: 0.85rem;">
                                    üéÅ Odmƒõna: +${chapter.reward.bond || 0} Pouto ${chapter.reward.skill ? ', üÜï ' + chapter.reward.skill : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">≈Ω√°dn√© aktivn√≠ companion questy.</p>';
                    html += '<p style="color: #888; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">Cestuj se sv√Ωmi spoleƒçn√≠ky a buduj s nimi pouto.</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
                
                showModal('üíù Companion questy', html);
            }
        }
        
        // Kontrola quest≈Ø na aktu√°ln√≠ lokaci - vol√° se p≈ôi p≈ô√≠chodu na lokaci
        function checkQuestNotifications(locationId) {
            const notifications = [];
            
            // 1. NPC quest na t√©to lokaci
            if (state.npcQuests) {
                Object.entries(state.npcQuests).forEach(([npcId, questData]) => {
                    if (questData?.id) {
                        const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
                        if (npc && npc.location === locationId) {
                            const quest = NPC_QUESTS[questData.id];
                            notifications.push({
                                icon: npc.icon,
                                title: 'Quest: ' + (quest?.name || 'Aktivn√≠ √∫kol'),
                                text: npc.name + ' tu na tebe ƒçek√°!',
                                color: '#ff9800'
                            });
                        }
                    }
                });
            }
            
            // 2. NPC bez questu - m≈Ø≈æe≈° z√≠skat nov√Ω
            FRIENDLY_NPCS.filter(n => n.location === locationId && !n.rival).forEach(npc => {
                const hasQuest = state.npcQuests?.[npc.id]?.id;
                if (!hasQuest) {
                    notifications.push({
                        icon: npc.icon,
                        title: npc.name,
                        text: 'Mo≈æn√° m√° pro tebe √∫kol!',
                        color: '#2196f3'
                    });
                }
            });
            
            // 3. Hlavn√≠ p≈ô√≠bƒõhov√Ω quest
            if (state.mainQuest?.currentQuest && !state.mainQuest.storyComplete) {
                const quest = MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
                if (quest?.objectives) {
                    const relevantObj = quest.objectives.find(o => o.location === locationId);
                    if (relevantObj) {
                        notifications.push({
                            icon: 'üìñ',
                            title: 'P≈ô√≠bƒõhov√Ω quest!',
                            text: relevantObj.desc || quest.title,
                            color: '#ffd700'
                        });
                    }
                }
            }
            
            // Zobraz notifikace
            if (notifications.length > 0) {
                notifications.forEach((n, i) => {
                    setTimeout(() => {
                        notifySuccess(n.title, n.text);
                    }, i * 800);
                });
            }
        }
        
        function showSkillDetail(skillId) {
            const skill = SKILLS.find(s => s.id === skillId);
            if (!skill) return;
            
            const currentLevel = state.skills?.[skillId] || 0;
            const totalBonus = skill.value * currentLevel;
            
            // Popis efektu podle typu
            const effectDescriptions = {
                'hunger_efficiency': { name: 'Sn√≠≈æen√≠ spot≈ôeby hladu', unit: '%', multiplier: 100 },
                'thirst_efficiency': { name: 'Sn√≠≈æen√≠ spot≈ôeby ≈æ√≠znƒõ', unit: '%', multiplier: 100 },
                'energy_efficiency': { name: 'Sn√≠≈æen√≠ spot≈ôeby energie', unit: '%', multiplier: 100 },
                'loot_chance': { name: 'Bonus k ≈°anci na loot', unit: '%', multiplier: 100 },
                'travel_speed': { name: 'Zkr√°cen√≠ ƒçasu cestov√°n√≠', unit: '%', multiplier: 100 },
                'radiation_resistance': { name: 'Sn√≠≈æen√≠ zisku radiace', unit: '%', multiplier: 100 },
                'max_health': { name: 'Bonus k max HP', unit: ' HP', multiplier: 1 },
                'xp_bonus': { name: 'Bonus k z√≠skan√Ωm XP', unit: '%', multiplier: 100 },
                'loot_quality': { name: 'Bonus ke kvalitƒõ lootu', unit: '%', multiplier: 100 },
                'health_regen': { name: 'Regenerace HP za minutu', unit: ' HP/min', multiplier: 1 },
                'repair': { name: 'Sleva na opravy', unit: '%', multiplier: 100 }
            };
            
            const effect = effectDescriptions[skill.type] || { name: skill.type, unit: '', multiplier: 1 };
            const currentBonus = (totalBonus * effect.multiplier).toFixed(0);
            const perLevelBonus = (skill.value * effect.multiplier).toFixed(0);
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${skill.icon}</div>
                    <h3 style="margin: 0.5rem 0; color: var(--toxic-green);">${skill.name}</h3>
                    <div style="color: #888; font-size: 0.9rem;">${skill.desc}</div>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #888;">Aktu√°ln√≠ √∫rove≈à:</span>
                        <span style="font-size: 1.2rem; font-weight: bold; color: var(--warning-yellow);">${currentLevel} / ${skill.maxLevel}</span>
                    </div>
                    
                    <div style="height: 8px; background: #0a0a0a; border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem;">
                        <div style="height: 100%; width: ${(currentLevel / skill.maxLevel) * 100}%; background: linear-gradient(90deg, var(--toxic-dark), var(--toxic-green));"></div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a2a1a, #0a1a0a); padding: 1rem; border-radius: 8px; border: 1px solid var(--toxic-dark); margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--toxic-green);">üìä Efekt</h4>
                    <div style="display: grid; gap: 0.3rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #aaa;">${effect.name}:</span>
                            <span style="color: var(--toxic-green); font-weight: bold;">${currentLevel > 0 ? '+' + currentBonus + effect.unit : 'Neaktivn√≠'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                            <span style="color: #666;">Za ka≈æd√Ω level:</span>
                            <span style="color: #888;">+${perLevelBonus}${effect.unit}</span>
                        </div>
                        ${currentLevel < skill.maxLevel ? `
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 0.3rem; padding-top: 0.3rem; border-top: 1px solid #333;">
                                <span style="color: #666;">P≈ôi max levelu:</span>
                                <span style="color: #ffd700;">+${(skill.value * skill.maxLevel * effect.multiplier).toFixed(0)}${effect.unit}</span>
                            </div>
                        ` : `
                            <div style="text-align: center; margin-top: 0.5rem; color: #ffd700;">‚≠ê MAXIM√ÅLN√ç √öROVE≈á ‚≠ê</div>
                        `}
                    </div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.85rem;">üí° Tip</h4>
                    <p style="margin: 0; font-size: 0.8rem; color: #aaa;">
                        Dovednosti z√≠sk√°v√°≈° automaticky p≈ôi hran√≠ nebo je m≈Ø≈æe≈° vylep≈°it v üå≥ Stromu dovednost√≠.
                    </p>
                </div>
            `;
            
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal(`${skill.icon} ${skill.name}`, html);
        }
        
        function showAttrInfo(attrKey) {
            const attr = ATTRS[attrKey];
            const value = state.char.attrs[attrKey] || 5;
            
            const attrEffects = {
                str: {
                    title: 'S√≠la',
                    effects: [
                        { name: '√ötok', formula: '+1 za bod', current: `+${value}` },
                        { name: 'Nosnost', formula: '+2kg za bod', current: `+${value * 2}kg` },
                        { name: 'Po≈°kozen√≠ beze zbranƒõ', formula: '+0.5 za bod', current: `+${(value * 0.5).toFixed(1)}` }
                    ],
                    desc: 'S√≠la urƒçuje fyzickou zdatnost. Ovliv≈àuje po≈°kozen√≠ v boji a kolik toho unese≈°.'
                },
                end: {
                    title: 'V√Ωdr≈æ',
                    effects: [
                        { name: 'Max HP', formula: '+5 za bod', current: `+${value * 5}` },
                        { name: 'Obrana', formula: '+0.5 za bod', current: `+${(value * 0.5).toFixed(1)}` },
                        { name: 'Odolnost radiaci', formula: '+1% za bod', current: `+${value}%` }
                    ],
                    desc: 'V√Ωdr≈æ urƒçuje tv√© zdrav√≠ a odolnost. V√≠ce v√Ωdr≈æe = v√≠ce ≈æivot≈Ø a lep≈°√≠ obrana.'
                },
                agi: {
                    title: 'Hbitost',
                    effects: [
                        { name: '√öhyb', formula: '+2% za bod nad 5', current: `${2 + Math.max(0, value - 5) * 2}%` },
                        { name: 'Rychlost pohybu', formula: '+2% za bod nad 5', current: `+${Math.max(0, value - 5) * 2}%` },
                        { name: '≈†ance na √∫tƒõk', formula: '+3% za bod nad 5', current: `+${Math.max(0, value - 5) * 3}%` }
                    ],
                    desc: 'Hbitost urƒçuje rychlost a obratnost. Pom√°h√° vyh√Ωbat se √∫tok≈Øm a rychleji cestovat.'
                },
                int: {
                    title: 'Inteligence',
                    effects: [
                        { name: 'XP bonus', formula: '+2% za bod', current: `+${value * 2}%` },
                        { name: 'Efektivita craftingu', formula: '+3% za bod', current: `+${value * 3}%` },
                        { name: 'Ceny v obchodƒõ', formula: '-1% za bod', current: `-${value}%` }
                    ],
                    desc: 'Inteligence ovliv≈àuje uƒçen√≠ a chytrost. Z√≠sk√°v√°≈° v√≠ce XP a lep≈°√≠ ceny.'
                },
                per: {
                    title: 'Vn√≠m√°n√≠',
                    effects: [
                        { name: 'Kritick√Ω z√°sah', formula: '+3% za bod', current: `${value * 3}%` },
                        { name: '≈†ance na loot', formula: '+2% za bod', current: `+${value * 2}%` },
                        { name: 'Detekce past√≠', formula: '+5% za bod', current: `+${value * 5}%` }
                    ],
                    desc: 'Vn√≠m√°n√≠ urƒçuje pozornost a smysly. Pom√°h√° naj√≠t lep≈°√≠ loot a kriticky zas√°hnout.'
                },
                lck: {
                    title: '≈†tƒõst√≠',
                    effects: [
                        { name: 'Kritick√Ω z√°sah', formula: '+2% za bod', current: `+${value * 2}%` },
                        { name: 'Vz√°cn√Ω loot', formula: '+3% za bod', current: `+${value * 3}%` },
                        { name: 'N√°hodn√© eventy', formula: '+2% za bod', current: `+${value * 2}%` }
                    ],
                    desc: '≈†tƒõst√≠ ovliv≈àuje n√°hodu ve tv≈Øj prospƒõch. V√≠ce vz√°cn√©ho lootu a lep≈°√≠ eventy.'
                }
            };
            
            const info = attrEffects[attrKey];
            
            showModal(`${attr.icon} ${info.title}`, `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${attr.icon}</div>
                    <h2 style="color: var(--warning-yellow); margin: 0.5rem 0;">${info.title}</h2>
                    <p style="color: #888; font-size: 0.85rem;">${info.desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid var(--warning-yellow);">
                        <div style="font-size: 2.5rem; font-weight: bold; color: var(--warning-yellow);">${value}</div>
                        <div style="color: #888; font-size: 0.8rem;">aktu√°ln√≠ hodnota</div>
                    </div>
                    
                    <div style="text-align: left; margin-top: 1rem;">
                        <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">üìä Efekty:</div>
                        ${info.effects.map(e => `
                            <div style="background: #0a0a0a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="color: #ccc;">${e.name}</span>
                                    <span style="color: #666; font-size: 0.75rem; margin-left: 0.5rem;">(${e.formula})</span>
                                </div>
                                <span style="color: var(--toxic-green); font-weight: bold;">${e.current}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${state.char.levelUpPoints > 0 ? `
                        <button class="btn" onclick="closeModal(); levelUpAttr('${attrKey}')" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">
                            ‚¨ÜÔ∏è Zv√Ω≈°it na ${value + 1} (m√°≈° ${state.char.levelUpPoints} bod≈Ø)
                        </button>
                    ` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: ${state.char.levelUpPoints > 0 ? '0.5rem' : '1rem'}; ${state.char.levelUpPoints > 0 ? 'background: #555;' : ''}">${t('ui', 'close')}</button>
            `);
        }
        
        function levelUpAttr(attr) {
            if (state.char.levelUpPoints <= 0) return;
            state.char.attrs[attr]++;
            state.char.levelUpPoints--;
            
            // Update max HP if endurance increased
            if (attr === 'end') {
                state.char.maxHp = 100 + state.char.attrs.end * 5;
                if (state.char.classId === 'survivor') state.char.maxHp += 30;
            }
            
            addLog(`Zv√Ω≈°il jsi atribut na ${state.char.attrs[attr]}`, '‚¨ÜÔ∏è');
            renderFull();
        }
        
        function upgradeSkill(skillId) {
            if (state.char.skillPoints <= 0) return;
            
            const skill = SKILLS.find(s => s.id === skillId);
            const currentLevel = state.skills[skillId] || 0;
            if (currentLevel >= skill.maxLevel) return;
            
            state.skills[skillId] = currentLevel + 1;
            state.char.skillPoints--;
            
            // Apply skill effects
            if (skill.type === 'max_health') {
                state.char.maxHealth += skill.value;
            }
            
            notifySuccess('üéØ Dovednost vylep≈°ena!', `${skill.icon} ${skill.name} ‚Üí Lv${state.skills[skillId]}`);
            saveGame(true);
            renderFull();
            showAllSkills(); // Znovu otev≈ôi panel
        }
        
        function showAllSkills() {
            const skillPoints = state.char.skillPoints || 0;
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem;">üéØ</div>
                    <p style="color: #888;">Investuj body do dovednost√≠ pro trval√© bonusy</p>
                    <div style="background: ${skillPoints > 0 ? 'var(--toxic-dark)' : '#333'}; padding: 0.5rem 1rem; border-radius: 8px; display: inline-block; margin-top: 0.5rem;">
                        <span style="color: ${skillPoints > 0 ? 'var(--toxic-green)' : '#888'}; font-weight: bold;">
                            ‚≠ê Dostupn√© body: ${skillPoints}
                        </span>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem; max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.3rem;">
            `;
            
            SKILLS.forEach(skill => {
                const currentLevel = state.skills?.[skill.id] || 0;
                const isMaxed = currentLevel >= skill.maxLevel;
                const canUpgrade = skillPoints > 0 && !isMaxed;
                
                // V√Ωpoƒçet bonusu
                const effectDescriptions = {
                    'hunger_efficiency': '%', 'thirst_efficiency': '%', 'energy_efficiency': '%',
                    'loot_chance': '%', 'travel_speed': '%', 'radiation_resistance': '%',
                    'max_health': ' HP', 'xp_bonus': '%', 'loot_quality': '%',
                    'health_regen': ' HP/min', 'repair': '%', 'auto_consume': ''
                };
                const unit = effectDescriptions[skill.type] || '';
                const multiplier = unit === ' HP' || unit === ' HP/min' ? 1 : 100;
                const currentBonus = (skill.value * currentLevel * multiplier).toFixed(0);
                
                html += `
                    <div style="background: linear-gradient(135deg, ${currentLevel > 0 ? '#1a2a1a' : '#1a1a1a'}, #0d0d0d); padding: 0.8rem; border-radius: 8px; border: 1px solid ${currentLevel > 0 ? 'var(--toxic-dark)' : '#333'};">
                        <div style="display: flex; align-items: center; gap: 0.6rem;">
                            <div style="font-size: 1.8rem;">${skill.icon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: ${currentLevel > 0 ? 'var(--toxic-green)' : '#fff'};">${skill.name}</span>
                                    <span style="color: ${isMaxed ? '#ffd700' : '#888'}; font-size: 0.85rem;">Lv ${currentLevel}/${skill.maxLevel}</span>
                                </div>
                                <div style="color: #888; font-size: 0.75rem; margin: 0.2rem 0;">${skill.desc}</div>
                                <div style="height: 4px; background: #0a0a0a; border-radius: 2px; overflow: hidden; margin-top: 0.3rem;">
                                    <div style="height: 100%; width: ${(currentLevel / skill.maxLevel) * 100}%; background: ${isMaxed ? '#ffd700' : 'var(--toxic-green)'};"></div>
                                </div>
                                ${currentLevel > 0 ? `<div style="color: var(--toxic-green); font-size: 0.7rem; margin-top: 0.2rem;">Aktu√°lnƒõ: +${currentBonus}${unit}</div>` : ''}
                            </div>
                            ${canUpgrade ? `
                                <button onclick="upgradeSkill('${skill.id}')" style="background: var(--toxic-dark); border: none; color: var(--toxic-green); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    +1
                                </button>
                            ` : isMaxed ? `
                                <span style="color: #ffd700; font-size: 0.8rem;">MAX</span>
                            ` : `
                                <span style="color: #666; font-size: 0.8rem;">üîí</span>
                            `}
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `;
            
            showModal('üéØ Dovednosti', html);
        }
        
        // Helper funkce pro renderov√°n√≠ prodejn√≠ch polo≈æek
        function renderSellItems() {
            if (state.inv.length === 0) {
                return '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem√°≈° co prodat</p>';
            }
            
            let html = '';
            state.inv.forEach(function(item, index) {
                // P≈ôeskoƒç nasazen√© p≈ôedmƒõty
                if (isItemEquipped(item)) return;
                
                const itemData = ITEMS.find(function(i) { return i.id === item.id; }) || item;
                const price = itemData.price || item.price;
                if (!price) return;
                
                let sellPrice = Math.floor(price * 0.35);
                
                if (state.char.gender === 'female') {
                    sellPrice = Math.floor(sellPrice * 1.1);
                }
                
                const traderSellBonus = getClassPassiveValue('sellBonus');
                if (traderSellBonus) {
                    sellPrice = Math.floor(sellPrice * (1 + traderSellBonus));
                }
                
                const hasTraderSettler = state.settlement?.settlers?.some(function(s) { return s.type === 'trader_s'; });
                if (hasTraderSettler) {
                    sellPrice = Math.floor(sellPrice * 1.25);
                }
                
                // üèóÔ∏è Bonus z Tr≈æi≈°tƒõ (+20%)
                const bonuses = getBuildingBonuses();
                if (bonuses.tradingBonus > 0) {
                    sellPrice = Math.floor(sellPrice * (1 + bonuses.tradingBonus));
                }
                
                const countText = item.count ? ' (' + item.count + 'x)' : '';
                
                html += '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                html += '<span style="font-size: 1.3rem;">' + item.icon + '</span>';
                html += '<div><div style="font-weight: bold; font-size: 0.85rem;">' + item.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: #ffd700;">üí∞ ' + sellPrice + countText + '</div></div></div>';
                html += '<button class="btn" onclick="showSellDialogByIndex(' + index + ')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>';
                html += '</div>';
            });
            
            return html || '<p style="text-align: center; color: #666; font-size: 0.85rem;">Nem√°≈° co prodat</p>';
        }
        
        function renderSellResources() {
            let html = '';
            const entries = Object.entries(state.resources).filter(function(e) { return e[1] > 0; });
            
            entries.forEach(function(entry) {
                const resId = entry[0];
                const amount = entry[1];
                const itemData = ITEMS.find(function(i) { return i.id === resId; });
                if (!itemData || !itemData.price) return;
                
                let sellPrice = Math.floor(itemData.price * 0.35);
                
                const hasTraderSettler = state.settlement?.settlers?.some(function(s) { return s.type === 'trader_s'; });
                if (hasTraderSettler) {
                    sellPrice = Math.floor(sellPrice * 1.25);
                }
                
                // üèóÔ∏è Bonus z Tr≈æi≈°tƒõ (+20%)
                const bonuses = getBuildingBonuses();
                if (bonuses.tradingBonus > 0) {
                    sellPrice = Math.floor(sellPrice * (1 + bonuses.tradingBonus));
                }
                
                html += '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
                html += '<span style="font-size: 1.3rem;">' + itemData.icon + '</span>';
                html += '<div><div style="font-weight: bold; font-size: 0.85rem;">' + itemData.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: #ffd700;">üí∞ ' + sellPrice + '/ks (' + amount + 'x)</div></div></div>';
                html += '<button class="btn" onclick="showSellResourceDialog(\'' + resId + '\')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #d4722e;">Prodat</button>';
                html += '</div>';
            });
            
            return html || '<p style="color: #666; font-size: 0.85rem;">≈Ω√°dn√© suroviny</p>';
        }
        
        // === SYST√âM PENƒöZ OBCHODN√çK≈Æ ===
        const SHOP_MONEY_LIMITS = {
            default: 2000,      // Bƒõ≈æn√Ω obchod
            trader_hub: 5000,   // Obchodn√≠ centrum
            caravan: 3000,      // Karavana
            pawnshop: 1000      // Zastav√°rna
        };
        
        // Z√≠sk√° aktu√°ln√≠ pen√≠ze obchodu na lokaci
        function getShopMoney(locationId = null) {
            const loc = locationId || state.world?.currentLocation || 'shelter';
            if (!state.shopMoney) state.shopMoney = {};
            
            const shopData = state.shopMoney[loc];
            const now = Date.now();
            const dayMs = 24 * 60 * 60 * 1000;
            
            // Zjisti typ obchodu a limit
            const location = WORLD_LOCATIONS?.find(l => l.id === loc);
            let limit = SHOP_MONEY_LIMITS.default;
            if (location?.id === 'trader_hub' || location?.specialization === 'trade') {
                limit = SHOP_MONEY_LIMITS.trader_hub;
            }
            
            // Reset ka≈æd√Ω den
            if (!shopData || (now - shopData.lastReset) > dayMs) {
                state.shopMoney[loc] = { money: limit, lastReset: now, limit: limit };
                return limit;
            }
            
            return shopData.money;
        }
        
        // Sn√≠≈æ√≠ pen√≠ze obchodu
        function reduceShopMoney(amount, locationId = null) {
            const loc = locationId || state.world?.currentLocation || 'shelter';
            if (!state.shopMoney) state.shopMoney = {};
            
            // Zajisti ≈æe existuje z√°znam
            getShopMoney(loc);
            
            state.shopMoney[loc].money = Math.max(0, state.shopMoney[loc].money - amount);
            return state.shopMoney[loc].money;
        }
        
        // Z√≠sk√° ƒças do resetu obchodu
        function getShopResetTime(locationId = null) {
            const loc = locationId || state.world?.currentLocation || 'shelter';
            if (!state.shopMoney?.[loc]) return 0;
            
            const dayMs = 24 * 60 * 60 * 1000;
            const resetTime = state.shopMoney[loc].lastReset + dayMs;
            return Math.max(0, resetTime - Date.now());
        }
        
        function openShop() {
            console.log('üõí openShop() called');
            
            try {
                // Filtruj items kter√© maj√≠ cenu a jsou k prodeji
                const shopItems = ITEMS.filter(item => item.price && item.price > 0 && !item.cantBuy);
                console.log('üõí shopItems count:', shopItems.length);
            
            // Rozdƒõl na kategorie
            const consumables = shopItems.filter(i => i.type === 'consumable');
            const weapons = shopItems.filter(i => i.type === 'weapon');
            const armors = shopItems.filter(i => i.type === 'armor');
            const tools = shopItems.filter(i => i.type === 'tool');
            const resources = shopItems.filter(i => i.type === 'resource');
            const ammo = shopItems.filter(i => i.type === 'ammo');
            
            const renderShopItem = (item) => {
                const shopItemTexts = {
                    tool: 'N√°stroj', resource: 'Surovina', ammoFor: 'Munice pro'
                };
                
                let desc = '';
                if (item.type === 'consumable') {
                    if (item.effect === 'health') desc = '‚ù§Ô∏è +' + item.value + ' HP';
                    else if (item.effect === 'hunger') desc = 'üçñ +' + item.value + '%';
                    else if (item.effect === 'thirst') desc = 'üíß +' + item.value + '%';
                    else if (item.effect === 'energy') desc = '‚ö° +' + item.value + '%';
                    else if (item.effect === 'radiation') desc = '‚ò¢Ô∏è ' + item.value;
                } else if (item.type === 'weapon') {
                    desc = '‚öîÔ∏è ' + item.damage + ' DMG';
                    if (item.ammoType) desc += ' | üî∏ ' + getAmmoName(item.ammoType);
                    // P≈ôidej dal≈°√≠ atributy zbranƒõ
                    if (item.critChance) desc += ' | üí• ' + Math.round(item.critChance * 100) + '% krit';
                    if (item.critMultiplier && item.critMultiplier > 1.5) desc += ' | x' + item.critMultiplier + ' krit DMG';
                    if (item.accuracy) desc += ' | üéØ ' + Math.round(item.accuracy * 100) + '%';
                    if (item.range) desc += ' | üìè ' + item.range + 'm';
                    if (item.armorPen) desc += ' | üî± ' + item.armorPen + ' pr≈Øraz';
                    if (item.attackSpeed && item.attackSpeed !== 1) desc += ' | ‚ö° ' + item.attackSpeed + 'x rychlost';
                    if (item.special) desc += ' | ‚ú® ' + item.special;
                } else if (item.type === 'armor') {
                    desc = 'üõ°Ô∏è ' + item.defense + ' DEF';
                    // P≈ôidej dal≈°√≠ atributy zbroje
                    if (item.radiation) desc += ' | ‚ò¢Ô∏è -' + item.radiation + ' rad';
                    if (item.stealth) desc += ' | ü•∑ +' + item.stealth + ' stealth';
                    if (item.speed) desc += ' | üèÉ ' + (item.speed > 0 ? '+' : '') + item.speed + '% rychlost';
                    if (item.hp) desc += ' | ‚ù§Ô∏è +' + item.hp + ' HP';
                    if (item.special) desc += ' | ‚ú® ' + item.special;
                } else if (item.type === 'tool') {
                    desc = 'üîß ' + shopItemTexts.tool;
                    if (item.bonus) desc += ' | ‚ú® ' + item.bonus;
                } else if (item.type === 'resource') {
                    desc = 'üì¶ ' + shopItemTexts.resource;
                } else if (item.type === 'ammo') {
                    desc = 'üî∏ ' + shopItemTexts.ammoFor + ' ' + getAmmoName(item.ammoType);
                }
                
                // Pou≈æij jednotnou funkci pro v√Ωpoƒçet ceny
                const originalPrice = item.price;
                const displayPrice = calculateItemPrice(originalPrice);
                
                const canAfford = getMoney() >= displayPrice;
                const hasDiscount = displayPrice < originalPrice;
                
                let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                html += '<span style="font-size: 1.5rem;">' + item.icon + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + getItemName(item.id) + '</div>';
                html += '<div style="font-size: 0.75rem; color: #8bc34a;">' + desc + '</div>';
                html += '<div style="font-size: 0.85rem; color: #ffd700;">üí∞ ' + displayPrice;
                if (hasDiscount) {
                    html += ' <span style="color: #999; text-decoration: line-through; font-size: 0.75rem;">' + originalPrice + '</span>';
                }
                html += '</div></div></div>';
                html += '<button class="btn" onclick="showBuyDialog(\'' + item.id + '\')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;';
                if (!canAfford) html += ' opacity: 0.5; pointer-events: none;';
                html += '">' + ('Koupit') + '</button>';
                html += '</div>';
                return html;
            };
            
            const traderQuote = getRandomHumor('trader');
            
            const shopTexts = {
                title: 'Obchod', discount: 'Sleva od obchodn√≠ka', buy: 'Koupit', sell: 'Prodat',
                consumables: 'Spot≈ôebn√≠', weapons: 'Zbranƒõ', ammo: 'Munice',
                armors: 'Zbroje', tools: 'N√°stroje', resources: 'Suroviny',
                items: 'P≈ôedmƒõty', closeShop: 'Zav≈ô√≠t obchod', tool: 'N√°stroj', resource: 'Surovina',
                ammoFor: 'Munice pro'
            };
            
            // Zjisti jestli m√° hr√°ƒç slevu od karavany
            const merchantDiscount = (state.caravan?.active && Date.now() < state.caravan?.until) || 
                                     (state.settlement?.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until) ? 0.2 : 0;
            
            // Pen√≠ze obchodu
            const currentShopMoney = getShopMoney();
            const shopLimit = state.shopMoney?.[state.world?.currentLocation]?.limit || SHOP_MONEY_LIMITS.default;
            const shopMoneyPercent = Math.round((currentShopMoney / shopLimit) * 100);
            const shopMoneyColor = shopMoneyPercent > 50 ? '#4caf50' : shopMoneyPercent > 20 ? '#ff9800' : '#f44336';
            
            document.getElementById('modalContent').innerHTML = `
                <h2>üè™ ${shopTexts.title}</h2>
                <p style="color: #888; font-style: italic; text-align: center; margin-bottom: 0.5rem; font-size: 0.85rem;">"${traderQuote}"</p>
                ${merchantDiscount > 0 ? '<p style="background: var(--warning-yellow); color: #000; padding: 0.5rem; border-radius: 5px; text-align: center; margin-bottom: 1rem;">üê™ ' + shopTexts.discount + ': -20%!</p>' : ''}
                <p style="text-align: center; font-size: 1.1rem; margin-bottom: 0.5rem;">
                    <strong>üí∞ ${getMoney()}</strong> | <strong>üé´ ${getCasinoTokens()}</strong>
                </p>
                
                <!-- Pen√≠ze obchodn√≠ka -->
                <div style="background: #1a1a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                        <span style="color: #888;">üè¶ Obchodn√≠k m√°:</span>
                        <span style="color: ${shopMoneyColor}; font-weight: bold;">${currentShopMoney.toLocaleString()} / ${shopLimit.toLocaleString()} üí∞</span>
                    </div>
                    <div style="background: #333; height: 6px; border-radius: 3px; margin-top: 0.3rem; overflow: hidden;">
                        <div style="height: 100%; width: ${shopMoneyPercent}%; background: ${shopMoneyColor}; transition: width 0.3s;"></div>
                    </div>
                    <p style="color: #666; font-size: 0.7rem; margin: 0.2rem 0 0 0; text-align: right;">Obnovuje se dennƒõ</p>
                </div>
                
                <!-- Taby pro Koupit/Prodat -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button id="shopTabBuy" class="btn" onclick="switchShopTab('buy')" style="flex: 1; background: #2e7d32;">üõí ${shopTexts.buy}</button>
                    <button id="shopTabSell" class="btn" onclick="switchShopTab('sell')" style="flex: 1; background: #555;">üí∞ ${shopTexts.sell}</button>
                </div>
                
                <!-- Koupit sekce -->
                <div id="shopBuySection">
                    <!-- Filtry -->
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.5rem;">
                        <button class="btn shop-filter active" onclick="filterShop('all')" data-filter="all" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #4caf50;">V≈°e</button>
                        <button class="btn shop-filter" onclick="filterShop('consumable')" data-filter="consumable" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üçñ</button>
                        <button class="btn shop-filter" onclick="filterShop('weapon')" data-filter="weapon" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">‚öîÔ∏è</button>
                        <button class="btn shop-filter" onclick="filterShop('ammo')" data-filter="ammo" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üî∏</button>
                        <button class="btn shop-filter" onclick="filterShop('armor')" data-filter="armor" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üõ°Ô∏è</button>
                        <button class="btn shop-filter" onclick="filterShop('tool')" data-filter="tool" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üîß</button>
                        <button class="btn shop-filter" onclick="filterShop('resource')" data-filter="resource" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">üì¶</button>
                    </div>
                    
                    <div id="shopItemsList" style="max-height: 45vh; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;">
                        <div class="shop-category" data-type="consumable">
                            ${consumables.length > 0 ? `
                                <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">üçñ ${shopTexts.consumables} (${consumables.length})</h4>
                                ${consumables.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="weapon">
                            ${weapons.length > 0 ? `
                                <h4 style="color: #c62828; font-size: 0.85rem; margin: 0.5rem 0;">‚öîÔ∏è ${shopTexts.weapons} (${weapons.length})</h4>
                                ${weapons.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="ammo">
                            ${ammo.length > 0 ? `
                                <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">üî∏ ${shopTexts.ammo} (${ammo.length})</h4>
                                ${ammo.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="armor">
                            ${armors.length > 0 ? `
                                <h4 style="color: #2196f3; font-size: 0.85rem; margin: 0.5rem 0;">üõ°Ô∏è ${shopTexts.armors} (${armors.length})</h4>
                                ${armors.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="tool">
                            ${tools.length > 0 ? `
                                <h4 style="color: #9c27b0; font-size: 0.85rem; margin: 0.5rem 0;">üîß ${shopTexts.tools} (${tools.length})</h4>
                                ${tools.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                        
                        <div class="shop-category" data-type="resource">
                            ${resources.length > 0 ? `
                                <h4 style="color: #8bc34a; font-size: 0.85rem; margin: 0.5rem 0;">üì¶ ${shopTexts.resources} (${resources.length})</h4>
                                ${resources.map(renderShopItem).join('')}
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Prodat sekce -->
                <div id="shopSellSection" style="max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; display: none;">
                    <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">üì¶ ${shopTexts.items}</h4>
                    ${renderSellItems()}
                    
                    <h4 style="color: #8bc34a; font-size: 0.85rem; margin: 0.8rem 0 0.3rem 0;">üì¶ ${shopTexts.resources}</h4>
                    ${renderSellResources()}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">${shopTexts.closeShop}</button>
            `;
            console.log('üõí openShop() setting modal content done');
            document.getElementById('modal').classList.add('show');
            console.log('üõí openShop() modal shown');
            } catch (error) {
                console.error('üõí openShop() ERROR:', error);
                showModal('‚ùå Chyba', 'Nepoda≈ôilo se otev≈ô√≠t obchod: ' + error.message);
            }
        }
        
        function switchShopTab(tab) {
            const buySection = document.getElementById('shopBuySection');
            const sellSection = document.getElementById('shopSellSection');
            const buyTab = document.getElementById('shopTabBuy');
            const sellTab = document.getElementById('shopTabSell');
            
            if (tab === 'buy') {
                buySection.style.display = 'block';
                sellSection.style.display = 'none';
                buyTab.style.background = '#2e7d32';
                sellTab.style.background = '#555';
            } else {
                buySection.style.display = 'none';
                sellSection.style.display = 'block';
                buyTab.style.background = '#555';
                sellTab.style.background = '#d4722e';
            }
        }
        
        function filterShop(type) {
            // Aktualizuj aktivn√≠ tlaƒç√≠tko
            document.querySelectorAll('.shop-filter').forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.style.background = '#4caf50';
                    btn.classList.add('active');
                } else {
                    btn.style.background = '#333';
                    btn.classList.remove('active');
                }
            });
            
            // Filtruj kategorie
            document.querySelectorAll('.shop-category').forEach(cat => {
                if (type === 'all' || cat.dataset.type === type) {
                    cat.style.display = 'block';
                } else {
                    cat.style.display = 'none';
                }
            });
        }
        
        function buyItem(itemId, amount = 1) {
            const itemData = ITEMS.find(i => i.id === itemId);
            if (!itemData) {
                console.error('buyItem: Item not found:', itemId);
                return;
            }
            
            // Kontrola unique item≈Ø (spac√°k, kompas, atd.)
            if (itemData.unique) {
                const alreadyHas = state.inv.some(i => i.id === itemId);
                if (alreadyHas) {
                    notifyWarning('U≈æ m√°≈° ' + itemData.name, 'M≈Ø≈æe≈° m√≠t pouze jeden');
                    return;
                }
            }
            
            // Kontrola v√°hy P≈òED n√°kupem
            const itemWeight = (itemData.weight || 0) * amount;
            if (state.carryWeight + itemWeight > state.maxCarryWeight) {
                notifyWarning('P≈ô√≠li≈° tƒõ≈æk√©!', ('Neunese≈° ') + amount + 'x ' + itemData.name);
                SoundSystem.play('error');
                return;
            }
            
            // Pou≈æij jednotnou funkci pro v√Ωpoƒçet ceny
            const price = calculateItemPrice(itemData.price);
            
            // === TRADER CLASS BONUS: +10% ≈°ance na rare ===
            if (state.char.classId === 'trader' && Math.random() < 0.10) {
                // Bonus item!
                const bonusItems = ['medkit', 'stimpack', 'radx', 'ammo_9mm', 'ammo_shell'];
                const bonusId = bonusItems[Math.floor(Math.random() * bonusItems.length)];
                const bonusItem = ITEMS.find(i => i.id === bonusId);
                if (bonusItem) {
                    addItemToInventory(bonusItem, 1, true);
                    notifySuccess('üí∞ Obchodn√≠ instinkt!', 'Dostal jsi bonus: ' + bonusItem.name);
                }
            }
            
            const totalPrice = price * amount;
            const currentMoney = getMoney();
            
            if (currentMoney < totalPrice) {
                notifyWarning('Nedostatek penƒõz!', 'Pot≈ôebuje≈° ' + totalPrice + ' üí∞');
                return;
            }
            
            if (!removeMoney(totalPrice)) {
                console.error('buyItem: Could not remove money');
                return;
            }
            
            // P≈ôid√°n√≠ do invent√°≈ôe
            if (itemData.type === 'resource') {
                state.resources[itemId] = (state.resources[itemId] || 0) + amount;
            } else if (itemData.type === 'ammo') {
                // Ammo se p≈ôid√°v√° v mno≈æstv√≠ kter√© hr√°ƒç koupil
                addAmmo(itemData.ammoType, amount);
                notifySuccess('Zakoupeno!', itemData.name + ' x' + amount);
                updateCarryWeight();
                changeReputation('traders', 1, 'n√°kup');
                openShop();
                return;
            } else {
                // Pro v≈°echny ostatn√≠ typy - stackovateln√© i ne
                const existing = state.inv.find(i => i.id === itemId && i.fromShop);
                if (existing && (itemData.stackable || itemData.type === 'consumable')) {
                    existing.count = (existing.count || 1) + amount;
                } else {
                    // Pro nestackovateln√© itemy p≈ôidej ka≈æd√Ω zvl√°≈°≈•
                    for (let i = 0; i < amount; i++) {
                        const newItem = {
                            ...itemData,
                            count: 1,
                            fromShop: true, // Anti-exploit flag
                            boughtPrice: price,
                            durability: itemData.type === 'weapon' || itemData.type === 'armor' || itemData.type === 'gloves' || itemData.type === 'boots' ? 100 : undefined,
                            maxDurability: itemData.type === 'weapon' || itemData.type === 'armor' || itemData.type === 'gloves' || itemData.type === 'boots' ? 100 : undefined
                        };
                        state.inv.push(newItem);
                    }
                }
            }
            
            console.log('buyItem: Added', amount + 'x', itemData.name, 'to inventory');
            notifySuccess('Zakoupeno!', itemData.name + (amount > 1 ? ' x' + amount : ''));
            updateCarryWeight();
            saveGame(); // Ulo≈æ ihned
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + amount;
                checkDailyQuests();
            }
            
            // Mal√° zmƒõna reputace s obchodn√≠ky p≈ôi obchodov√°n√≠
            if (totalPrice >= 50 && Math.random() < 0.3) {
                changeReputation('traders', 1, 'obchodov√°n√≠');
            }
            
            renderFull(); // Aktualizuj cel√© UI vƒçetnƒõ invent√°≈ôe
            openShop(); // Refresh shop
        }
        
        // Modal pro v√Ωbƒõr mno≈æstv√≠ p≈ôi n√°kupu
        function showBuyDialog(itemId) {
            const itemData = ITEMS.find(i => i.id === itemId);
            if (!itemData) return;
            
            // Pou≈æij jednotnou funkci pro v√Ωpoƒçet ceny
            const price = calculateItemPrice(itemData.price);
            
            const maxBuyMoney = Math.floor(getMoney() / price);
            
            // Limit podle v√°hy
            const itemWeight = itemData.weight || 0;
            const freeWeight = state.maxCarryWeight - state.carryWeight;
            const maxBuyWeight = itemWeight > 0 ? Math.floor(freeWeight / itemWeight) : 999;
            
            const maxBuy = Math.min(maxBuyMoney, maxBuyWeight);
            
            if (maxBuyMoney <= 0) {
                notifyWarning('Nedostatek penƒõz!', 'Pot≈ôebuje≈° alespo≈à ' + price + ' üí∞');
                return;
            }
            
            if (maxBuyWeight <= 0) {
                notifyWarning(t('notifications', 'inventoryFull'), ('Neunese≈° ') + itemData.name);
                return;
            }
            
            // Pokud lze koupit jen 1, rovnou kup
            if (maxBuy === 1) {
                buyItem(itemId, 1);
                return;
            }
            
            window.currentBuyItem = itemId;
            window.currentBuyPrice = price;
            window.currentBuyMax = maxBuy;
            window.currentBuyAmount = 1;
            
            updateBuyDialog();
        }
        
        function updateBuyDialog() {
            const itemData = ITEMS.find(i => i.id === window.currentBuyItem);
            const amount = window.currentBuyAmount;
            const total = window.currentBuyPrice * amount;
            const totalWeight = (itemData.weight || 0) * amount;
            const freeWeight = state.maxCarryWeight - state.carryWeight;
            
            showModal(('üõí Koupit ') + itemData.icon + ' ' + itemData.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena: ' + window.currentBuyPrice + ' üí∞ | V√°ha: ' + (itemData.weight || 0) + 'kg</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeBuyAmount(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeBuyAmount(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeBuyAmount(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeBuyAmount(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<p style="color: #ffd700; font-size: 1.2rem; margin: 0.5rem 0;">Celkem: ' + total + ' üí∞</p>' +
                    '<p style="color: ' + (totalWeight > freeWeight ? '#f44336' : '#888') + '; font-size: 0.85rem;">V√°ha: ' + totalWeight.toFixed(1) + 'kg / Volno: ' + freeWeight.toFixed(1) + 'kg</p>' +
                    '<p style="color: #888; font-size: 0.8rem;">Max: ' + window.currentBuyMax + ' ks | M√°≈°: ' + getMoney() + ' üí∞</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="buyItem(window.currentBuyItem, window.currentBuyAmount); closeModal();" style="background: #2e7d32;">‚úì Koupit</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">‚úó Zru≈°it</button>' +
                '</div>'
            );
        }
        
        function changeBuyAmount(delta) {
            window.currentBuyAmount = Math.max(1, Math.min(window.currentBuyMax, window.currentBuyAmount + delta));
            updateBuyDialog();
        }
        
        function sellItem(itemId, amount = 1) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) {
                console.error('sellItem: Item not found in inventory:', itemId);
                return;
            }
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === itemId) || item;
            
            // Vycraftƒõn√© p≈ôedmƒõty nelze prodat obchodn√≠k≈Øm
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoruƒçnƒõ vyroben√© vƒõci obchodn√≠ci neberou. Zkus online tr≈æi≈°tƒõ!');
                return;
            }
            
            // Vƒõci koupen√© od karavany nelze prodat obchodn√≠k≈Øm (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od karavany nelze prodat. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            // Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            if (!itemData.price) {
                notifyWarning('Nelze prodat', 'Tento p≈ôedmƒõt nem√° hodnotu');
                return;
            }
            
            let sellPrice = Math.floor(itemData.price * 0.35); // Sn√≠≈æeno na 35% - crafting se mus√≠ vyplatit!
            
            // Apply gender bonus (female gets 10% better selling prices)
            if (state.char.gender === 'female') {
                sellPrice = Math.floor(sellPrice * 1.1);
            }
            
            // Bonus od obchodn√≠ka v osadƒõ
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) {
                sellPrice = Math.floor(sellPrice * 1.25);
            }
            
            const totalPrice = sellPrice * amount;
            
            // === KONTROLA PENƒöZ OBCHODU ===
            const shopMoney = getShopMoney();
            if (shopMoney < totalPrice) {
                if (shopMoney <= 0) {
                    const resetTime = getShopResetTime();
                    const hours = Math.floor(resetTime / 3600000);
                    const mins = Math.floor((resetTime % 3600000) / 60000);
                    notifyWarning('Obchodn√≠k nem√° pen√≠ze!', `Dnes u≈æ vyƒçerpal z√°sobu. Reset za ${hours}h ${mins}m`);
                    return;
                }
                // M≈Ø≈æe prodat jen ƒç√°st
                const maxCanSell = Math.floor(shopMoney / sellPrice);
                if (maxCanSell < 1) {
                    notifyWarning('Obchodn√≠k nem√° dost', `M√° jen ${shopMoney} üí∞, pot≈ôebuje ${totalPrice} üí∞`);
                    return;
                }
                // Upozorni a prodej jen co jde
                notifyWarning('Omezen√Ω v√Ωkup', `Obchodn√≠k m√° jen na ${maxCanSell}x. Zkus prodat m√©nƒõ.`);
                return;
            }
            
            // Odeƒçti z penƒõz obchodu
            reduceShopMoney(totalPrice);
            
            addMoney(totalPrice);
            state.stats.itemsSold = (state.stats.itemsSold || 0) + amount;
            
            // Odebr√°n√≠ z invent√°≈ôe
            if (item.count && item.count > amount) {
                item.count -= amount;
            } else if (item.count && item.count === amount) {
                state.inv.splice(itemIndex, 1);
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            console.log('sellItem: Sold', amount + 'x', item.name, 'for', totalPrice);
            notifySuccess('Prod√°no!', item.name + (amount > 1 ? ' x' + amount : '') + ' +' + totalPrice + ' üí∞');
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + amount;
                checkDailyQuests();
            }
            
            updateCarryWeight();
            openShop(); // Refresh shop
            switchShopTab('sell'); // Z≈Østa≈à na prodejn√≠m tabu
        }
        
        // Modal pro v√Ωbƒõr mno≈æstv√≠ p≈ôi prodeji
        function showSellDialog(itemId) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;
            showSellDialogByIndex(itemIndex);
        }
        
        // Prodej podle indexu v invent√°≈ôi - ≈ôe≈°√≠ probl√©m s duplicitn√≠mi ID (nap≈ô. den√≠ky)
        function showSellDialogByIndex(itemIndex) {
            if (itemIndex < 0 || itemIndex >= state.inv.length) return;
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const maxSell = item.count || 1;
            
            if (!itemData.price && !item.price) {
                notifyWarning('Nelze prodat', 'Tento p≈ôedmƒõt nem√° hodnotu');
                return;
            }
            
            // Pokud m√°≈° jen 1, rovnou prodej
            if (maxSell === 1) {
                sellItemByIndex(itemIndex, 1);
                return;
            }
            
            let sellPrice = Math.floor((itemData.price || item.price) * 0.35);
            if (state.char.gender === 'female') sellPrice = Math.floor(sellPrice * 1.1);
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) sellPrice = Math.floor(sellPrice * 1.25);
            
            window.currentSellIndex = itemIndex;
            window.currentSellPrice = sellPrice;
            window.currentSellMax = maxSell;
            window.currentSellAmount = 1;
            
            updateSellDialogByIndex();
        }
        
        function updateSellDialogByIndex() {
            const item = state.inv[window.currentSellIndex];
            if (!item) return;
            
            const amount = window.currentSellAmount;
            const total = window.currentSellPrice * amount;
            
            showModal(('üí∞ Prodat ') + item.icon + ' ' + item.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena za kus: ' + window.currentSellPrice + ' üí∞</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeSellAmountByIndex(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeSellAmountByIndex(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeSellAmountByIndex(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeSellAmountByIndex(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<div style="display: flex; justify-content: center; gap: 0.5rem; margin: 0.5rem 0;">' +
                        '<button class="btn" onclick="window.currentSellAmount = window.currentSellMax; updateSellDialogByIndex();" style="padding: 0.3rem 0.8rem; background: #666; font-size: 0.8rem;">V≈°e (' + window.currentSellMax + ')</button>' +
                    '</div>' +
                    '<p style="color: #4caf50; font-size: 1.2rem; margin: 1rem 0;">Z√≠sk√°≈°: +' + total + ' üí∞</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">M√°≈°: ' + window.currentSellMax + ' ks</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="sellItemByIndex(window.currentSellIndex, window.currentSellAmount);" style="background: #d4722e;">‚úì Prodat</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">‚úó Zru≈°it</button>' +
                '</div>'
            );
        }
        
        function changeSellAmountByIndex(delta) {
            window.currentSellAmount = Math.max(1, Math.min(window.currentSellMax, window.currentSellAmount + delta));
            updateSellDialogByIndex();
        }
        
        // Prodej podle indexu - spr√°vnƒõ prod√° konkr√©tn√≠ item i kdy≈æ maj√≠ stejn√° ID
        function sellItemByIndex(itemIndex, amount = 1) {
            if (itemIndex < 0 || itemIndex >= state.inv.length) {
                console.error('sellItemByIndex: Invalid index:', itemIndex);
                return;
            }
            
            const item = state.inv[itemIndex];
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            
            // Vycraftƒõn√© p≈ôedmƒõty nelze prodat obchodn√≠k≈Øm
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoruƒçnƒõ vyroben√© vƒõci obchodn√≠ci neberou. Zkus online tr≈æi≈°tƒõ!');
                return;
            }
            
            // Vƒõci koupen√© od karavany nelze prodat obchodn√≠k≈Øm (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od karavany nelze prodat. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            // Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            const price = itemData.price || item.price;
            if (!price) {
                notifyWarning('Nelze prodat', 'Tento p≈ôedmƒõt nem√° hodnotu');
                return;
            }
            
            let sellPrice = Math.floor(price * 0.35);
            
            // Apply gender bonus (female gets 10% better selling prices)
            if (state.char.gender === 'female') {
                sellPrice = Math.floor(sellPrice * 1.1);
            }
            
            // Bonus od obchodn√≠ka v osadƒõ
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) {
                sellPrice = Math.floor(sellPrice * 1.25);
            }
            
            const totalPrice = sellPrice * amount;
            
            // === KONTROLA PENƒöZ OBCHODU ===
            const shopMoney = getShopMoney();
            if (shopMoney < totalPrice) {
                if (shopMoney <= 0) {
                    const resetTime = getShopResetTime();
                    const hours = Math.floor(resetTime / 3600000);
                    const mins = Math.floor((resetTime % 3600000) / 60000);
                    notifyWarning('Obchodn√≠k nem√° pen√≠ze!', `Dnes u≈æ vyƒçerpal z√°sobu. Reset za ${hours}h ${mins}m`);
                    return;
                }
                const maxCanSell = Math.floor(shopMoney / sellPrice);
                notifyWarning('Omezen√Ω v√Ωkup', `Obchodn√≠k m√° jen na ${maxCanSell}x. Zkus prodat m√©nƒõ.`);
                return;
            }
            
            // Odeƒçti z penƒõz obchodu
            reduceShopMoney(totalPrice);
            
            addMoney(totalPrice);
            state.stats.itemsSold = (state.stats.itemsSold || 0) + amount;
            
            // Odebr√°n√≠ z invent√°≈ôe
            if (item.count && item.count > amount) {
                item.count -= amount;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            console.log('sellItemByIndex: Sold', amount + 'x', item.name, 'for', totalPrice);
            notifySuccess('Prod√°no!', item.name + (amount > 1 ? ' x' + amount : '') + ' +' + totalPrice + ' üí∞');
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + amount;
                checkDailyQuests();
            }
            
            updateCarryWeight();
            openShop(); // Refresh shop
            switchShopTab('sell'); // Z≈Østa≈à na prodejn√≠m tabu
        }

        function updateSellDialog() {
            const item = state.inv.find(i => i.id === window.currentSellItem);
            const amount = window.currentSellAmount;
            const total = window.currentSellPrice * amount;
            
            showModal(('üí∞ Prodat ') + item.icon + ' ' + item.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena za kus: ' + window.currentSellPrice + ' üí∞</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeSellAmount(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeSellAmount(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeSellAmount(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeSellAmount(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<div style="display: flex; justify-content: center; gap: 0.5rem; margin: 0.5rem 0;">' +
                        '<button class="btn" onclick="window.currentSellAmount = window.currentSellMax; updateSellDialog();" style="padding: 0.3rem 0.8rem; background: #666; font-size: 0.8rem;">V≈°e (' + window.currentSellMax + ')</button>' +
                    '</div>' +
                    '<p style="color: #4caf50; font-size: 1.2rem; margin: 1rem 0;">Z√≠sk√°≈°: +' + total + ' üí∞</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">M√°≈°: ' + window.currentSellMax + ' ks</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="sellItem(window.currentSellItem, window.currentSellAmount);" style="background: #d4722e;">‚úì Prodat</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">‚úó Zru≈°it</button>' +
                '</div>'
            );
        }
        
        function changeSellAmount(delta) {
            window.currentSellAmount = Math.max(1, Math.min(window.currentSellMax, window.currentSellAmount + delta));
            updateSellDialog();
        }
        
        function sellResource(resId, amount = 1) {
            if (!state.resources[resId] || state.resources[resId] <= 0) return;
            
            const itemData = ITEMS.find(i => i.id === resId);
            if (!itemData || !itemData.price) return;
            
            // Omez na dostupn√© mno≈æstv√≠
            amount = Math.min(amount, state.resources[resId]);
            
            let sellPrice = Math.floor(itemData.price * 0.35);
            
            // Bonus od obchodn√≠ka v osadƒõ
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) {
                sellPrice = Math.floor(sellPrice * 1.25);
            }
            
            const totalPrice = sellPrice * amount;
            addMoney(totalPrice);
            state.resources[resId] -= amount;
            
            notifySuccess('Prod√°no!', itemData.name + (amount > 1 ? ' x' + amount : '') + ' +' + totalPrice + ' üí∞');
            openShop(); // Refresh shop
        }
        
        // Dialog pro prodej surovin
        function showSellResourceDialog(resId) {
            const itemData = ITEMS.find(i => i.id === resId);
            if (!itemData || !state.resources[resId]) return;
            
            const maxSell = state.resources[resId];
            
            // Pokud m√°≈° jen 1, rovnou prodej
            if (maxSell === 1) {
                sellResource(resId, 1);
                return;
            }
            
            let sellPrice = Math.floor(itemData.price * 0.35);
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader');
            if (hasTrader) sellPrice = Math.floor(sellPrice * 1.25);
            
            window.currentSellResId = resId;
            window.currentSellResPrice = sellPrice;
            window.currentSellResMax = maxSell;
            window.currentSellResAmount = 1;
            
            updateSellResourceDialog();
        }
        
        function updateSellResourceDialog() {
            const itemData = ITEMS.find(i => i.id === window.currentSellResId);
            const amount = window.currentSellResAmount;
            const total = window.currentSellResPrice * amount;
            
            showModal(('üí∞ Prodat ') + itemData.icon + ' ' + itemData.name, 
                '<div style="text-align: center;">' +
                    '<p style="color: #888; margin-bottom: 1rem;">Cena za kus: ' + window.currentSellResPrice + ' üí∞</p>' +
                    '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;">' +
                        '<button class="btn" onclick="changeSellResAmount(-10)" style="padding: 0.5rem 1rem; background: #444;">-10</button>' +
                        '<button class="btn" onclick="changeSellResAmount(-1)" style="padding: 0.5rem 1rem; background: #555;">-1</button>' +
                        '<span style="font-size: 1.5rem; min-width: 60px; color: #ffd700;">' + amount + '</span>' +
                        '<button class="btn" onclick="changeSellResAmount(1)" style="padding: 0.5rem 1rem; background: #555;">+1</button>' +
                        '<button class="btn" onclick="changeSellResAmount(10)" style="padding: 0.5rem 1rem; background: #444;">+10</button>' +
                    '</div>' +
                    '<div style="display: flex; justify-content: center; gap: 0.5rem; margin: 0.5rem 0;">' +
                        '<button class="btn" onclick="window.currentSellResAmount = window.currentSellResMax; updateSellResourceDialog();" style="padding: 0.3rem 0.8rem; background: #666; font-size: 0.8rem;">V≈°e (' + window.currentSellResMax + ')</button>' +
                    '</div>' +
                    '<p style="color: #4caf50; font-size: 1.2rem; margin: 1rem 0;">Z√≠sk√°≈°: +' + total + ' üí∞</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">M√°≈°: ' + window.currentSellResMax + ' ks</p>' +
                '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="sellResource(window.currentSellResId, window.currentSellResAmount); closeModal();" style="background: #d4722e;">‚úì Prodat</button>' +
                    '<button class="btn" onclick="openShop()" style="background: #555;">‚úó Zru≈°it</button>' +
                '</div>'
            );
        }
        
        function changeSellResAmount(delta) {
            window.currentSellResAmount = Math.max(1, Math.min(window.currentSellResMax, window.currentSellResAmount + delta));
            updateSellResourceDialog();
        }
        
        function startSleeping() {
            closeModal();
            
            const now = Date.now();
            state.lastSleepTime = now;
            state.sleepEndTime = now + (60 * 60 * 1000); // 1 hour
            state.isSleeping = true;
            
            addLog('Usnul jsi ve spac√°ku (1 hodina)', 'üí§');
            renderFull();
        }
        
        // Sp√°nek v √∫krytu (bez spot≈ôeby j√≠dla a ≈æ√≠znƒõ)
        function startSleep() {
            // Kontrola, ≈æe jsme v √∫krytu
            if (!state.map?.inBase && state.world?.currentLocation !== 'shelter') {
                notifyWarning('Zde nelze sp√°t', 'Mus√≠≈° b√Ωt v √∫krytu');
                return;
            }
            
            // Kontrola cooldownu (20 minut)
            const lastSleep = state.lastShelterSleep || 0;
            const cooldownMs = 20 * 60 * 1000; // 20 minut
            const timeSinceSleep = Date.now() - lastSleep;
            
            if (timeSinceSleep < cooldownMs) {
                const remaining = Math.ceil((cooldownMs - timeSinceSleep) / 60000);
                showModal('üò¥ Je≈°tƒõ nem√°≈° √∫navu', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üõèÔ∏è</div>
                        <p style="color: #ff9800;">Nen√≠ ti do span√≠ - odpoƒç√≠val jsi p≈ôed chv√≠l√≠.</p>
                        <p style="color: #888; margin-top: 0.5rem;">Dal≈°√≠ sp√°nek za: <strong style="color: #4caf50;">${remaining} minut</strong></p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            showModal('üõèÔ∏è Sp√°nek', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üõèÔ∏è</div>
                    <p style="color: #aaa; margin-bottom: 1rem;">${'Spi v √∫krytu a obnov energii a zdrav√≠.'}</p>
                    
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: left;">
                        <div style="color: #8bc34a; margin-bottom: 0.5rem;">‚úÖ ${'V√Ωhody:'}</div>
                        <div style="color: #aaa; font-size: 0.9rem;">
                            ‚Ä¢ ‚ö° ${'Pln√° obnova energie'}<br>
                            ‚Ä¢ ‚ù§Ô∏è ${'Regenerace HP (+50%)'}<br>
                            ‚Ä¢ üõ°Ô∏è ${'Bez ztr√°ty hladu/≈æ√≠znƒõ'}<br>
                            ‚Ä¢ ‚è∞ ${'Cooldown: 20 minut'}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå ${'Zru≈°it'}</button>
                        <button class="btn" onclick="doShelterSleep()" style="background: #3949AB;">üí§ ${'Sp√°t'}</button>
                    </div>
                </div>
            `);
        }
        
        function doShelterSleep() {
            closeModal();
            
            // Nastav cooldown
            state.lastShelterSleep = Date.now();
            
            // Obnov energii na maximum
            state.status.energy = 100;
            
            // Regenerace HP (50% maxHP)
            const healAmount = Math.floor(state.char.maxHp * 0.5);
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
            
            // Daily quest progress - healing
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.healed = (state.dailyQuests.progress.healed || 0) + healAmount;
                checkDailyQuests();
            }
            
            addLog('Dob≈ôe ses vyspal v √∫krytu. Energie obnovena!', 'üí§');
            notifySuccess('Odpoƒçat√Ω!', `‚ö° 100% | ‚ù§Ô∏è +${healAmount} HP`);
            
            saveGame();
            renderFull();
        }
        
        // Inventory filter (visual only - re-renders with filter)
        window.inventoryFilter = 'all';
        function filterInventory(type) {
            window.inventoryFilter = type;
            // Mus√≠me znovu vykreslit cel√Ω invent√°≈ô
            if (state.activeTab === 'inv') {
                renderGame();
            }
        }
        
        // === MO≈ΩNOSTI PRO ZBRANƒö ===
        function showWeaponOptions(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            showWeaponOptionsByIndex(state.inv.indexOf(item));
        }
        
        function showWeaponOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.weapon === item;
            const durabilityPct = item.durability !== undefined ? Math.round((item.durability / item.maxDurability) * 100) : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            // V√Ωpoƒçet ceny opravy
            const repairCost = item.durability !== undefined ? Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100) : 0;
            const canRepair = item.durability !== undefined && item.durability < item.maxDurability && state.money >= repairCost;
            const needsRepair = item.durability !== undefined && item.durability < item.maxDurability;
            
            // Easter egg special effects descriptions
            const specialDescriptions = {
                'poison': '‚ò†Ô∏è Otravuje nep≈ô√≠tele',
                'bleed': 'ü©∏ Zp≈Øsobuje krv√°cen√≠',
                'stun': '‚ö° Omr√°ƒç√≠ nep≈ô√≠tele',
                'fire': 'üî• Zapaluje nep≈ô√≠tele',
                'block': 'üõ°Ô∏è +15% ≈°ance na blok',
                'block_bonus': 'üõ°Ô∏è +10% ≈°ance na blok',
                'dodge_bonus': 'üí® +10% ≈°ance na √∫hyb',
                'powered': '‚ö° +5 obrana, +5 damage',
                'stealth': 'ü•∑ -50% ≈°ance na p≈ôepaden√≠, +15% dodge',
                'berserker': 'üëπ +30% damage, -3 obrana',
                'phoenix': 'üî• Jednou za boj: p≈ôe≈æije≈° smrteln√Ω z√°sah s 30% HP',
                'titan': 'ü¶æ +5 obrana, imunita na krit',
                'scout': 'üèÉ +15% dodge',
                'medic': 'üè• +50% efektivita l√©ƒçen√≠',
                'mutant': 'üß¨ +50% odolnost v≈Øƒçi radiaci a jed≈Øm',
                'exo': 'ü¶ø +50% nosnost, +10% damage',
                'nano': 'üî¨ +2 HP regenerace ka≈æd√© kolo',
                'intimidate': 'üíÄ +2 damage',
                'scavenger': 'üéí +25% bonus loot',
                'camo': 'üåø -30% ≈°ance na n√°hodn√© souboje',
                'nightvision': 'üåô +15% damage v noci',
                'agile': 'üèÉ +10% dodge',
                'rad_resist': '‚ò¢Ô∏è -30% radiace',
                'rad_immune': '‚ò¢Ô∏è -50% radiace',
                'night_vision': 'üëÅÔ∏è Noƒçn√≠ vidƒõn√≠',
                'fireproof': 'üî• Imunita na ohe≈à',
                'insulated': '‚ö° Imunita na elekt≈ôinu',
                'warm': '‚ùÑÔ∏è -30% ztr√°ta energie p≈ôi cestov√°n√≠',
                'endurance': 'üèÉ -30% ztr√°ta energie p≈ôi cestov√°n√≠',
                'flash_protect': 'üí° Ochrana p≈ôed oslepen√≠m',
                'sturdy': 'ü¶µ +5% stabilita',
                // Easter egg zbranƒõ
                'freeman': 'üî∂ Lambda Core: +25% kritick√Ω z√°sah',
                'silver': 'üåô St≈ô√≠brn√© ost≈ô√≠: +100% damage proti p≈ô√≠≈°er√°m',
                'silverhand': 'ü§ò Rockerboy: Pr≈Ørazn√© n√°boje ignoruj√≠ zbroj',
                'devastation': 'üíÄ Devastace: Masivn√≠ plo≈°n√© po≈°kozen√≠',
                'evil_bane': '‚ú® Zhouba zla: +200% damage proti boss≈Øm'
            };
            
            const specialText = item.special ? (specialDescriptions[item.special] || `‚≠ê ${item.special}`) : '';
            
            // Info o munici
            const itemData = ITEMS.find(i => i.id === item.id) || item;
            const ammoType = item.ammoType || itemData.ammoType;
            let ammoInfo = '';
            if (ammoType) {
                const ammoNames = {
                    '9mm': 'üî∏ 9mm n√°boje',
                    '556': 'üî∂ 5.56 n√°boje',
                    '762': 'üî∑ 7.62 n√°boje',
                    'shell': 'üî¥ Brokov√© n√°boje',
                    'arrow': '‚ûµ ≈†√≠py',
                    'bolt': 'üî© ≈†ipky do ku≈°e',
                    'fuel': '‚õΩ Palivo'
                };
                const ammoCount = getAmmoCount(ammoType);
                ammoInfo = `<p style="color: #ff9800; margin: 0.3rem 0;">üî∏ Munice: ${ammoNames[ammoType] || ammoType} (m√°≈°: ${ammoCount}x)</p>`;
            } else {
                ammoInfo = `<p style="color: #4caf50; margin: 0.3rem 0;">‚öîÔ∏è Zbra≈à na bl√≠zko - nevy≈æaduje munici</p>`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    ${item.desc ? `<p style="color: #888; font-style: italic; font-size: 0.85rem; margin: 0.3rem 0;">"${item.desc}"</p>` : ''}
                    <p style="color: #c62828; margin: 0.5rem 0;">‚öîÔ∏è Damage: +${item.damage}</p>
                    ${ammoInfo}
                    ${specialText ? `<p style="color: #9c27b0;">${specialText}</p>` : ''}
                    
                    ${item.durability !== undefined ? `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>${'üîß V√Ωdr≈æ:'}</span>
                                <span style="color: ${durabilityColor};">${item.durability}/${item.maxDurability}</span>
                            </div>
                            <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${durabilityPct}%; background: ${durabilityColor};"></div>
                            </div>
                            ${needsRepair ? `
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                                    <span style="color: #888; font-size: 0.85rem;">üí∞ ${'Cena opravy:'} <strong style="color: ${canRepair ? '#ffd700' : '#f44336'};">${repairCost} üí∞</strong></span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">‚úÖ Nasazeno</p>' : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${needsRepair ? `<button class="btn" onclick="repairItemForMoney(${idx})" style="background: ${canRepair ? '#2196f3' : '#555'};" ${!canRepair ? 'disabled' : ''}>üîß ${'Opravit za'} ${repairCost} üí∞</button>` : ''}
                    ${!isEquipped ? `<button class="btn" onclick="equipWeaponByIndex(${idx})" style="background: #4caf50;">‚úã ${'Nasadit'}</button>` : `<button class="btn" onclick="unequipWeapon()" style="background: #ff9800;">üëã ${'Sundat'}</button>`}
                    <button class="btn" onclick="recycleItem(${idx})" style="background: #795548;">‚ôªÔ∏è Recyklovat</button>
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è ${'Zahodit'}</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function equipWeaponByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Zamkni v√Ωmƒõnu vybaven√≠ bƒõhem cestov√°n√≠ (ALE ne bƒõhem boje - to je taktika)
            if (state.map?.traveling && !window.combatState) {
                notifyWarning('Nelze zmƒõnit', 'Bƒõhem cestov√°n√≠ nelze mƒõnit vybaven√≠!');
                return;
            }
            
            // P≈ôidej unik√°tn√≠ ID pro spr√°vn√© propojen√≠ po load
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.weapon = item;
            
            closeModal();
            notifySuccess('Zbra≈à nasazena!', item.name);
            renderFull();
        }
        
        function equipWeapon(itemId) {
            // Pro zpƒõtnou kompatibilitu - najdi prvn√≠ nenasazen√Ω item s t√≠mto ID
            const item = state.inv.find(i => i.id === itemId && !isItemEquipped(i)) || state.inv.find(i => i.id === itemId);
            if (!item) return;
            
            // Zamkni v√Ωmƒõnu vybaven√≠ bƒõhem cestov√°n√≠ (ALE ne bƒõhem boje - to je taktika)
            if (state.map?.traveling && !window.combatState) {
                notifyWarning('Nelze zmƒõnit', 'Bƒõhem cestov√°n√≠ nelze mƒõnit vybaven√≠!');
                return;
            }
            
            // P≈ôidej unik√°tn√≠ ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.weapon = item;
            
            closeModal();
            notifySuccess('Zbra≈à nasazena!', item.name);
            renderFull();
        }
        
        function unequipWeapon() {
            // Zamkni v√Ωmƒõnu vybaven√≠ bƒõhem cestov√°n√≠ (ALE ne bƒõhem boje)
            if (state.map?.traveling && !window.combatState) {
                notifyWarning('Nelze zmƒõnit', 'Bƒõhem cestov√°n√≠ nelze mƒõnit vybaven√≠!');
                return;
            }
            
            state.equipped = state.equipped || {};
            state.equipped.weapon = null;
            
            closeModal();
            notifySuccess('Zbra≈à sund√°na');
            renderFull();
        }
        
        function unequipItem(slotType) {
            // Zamkni v√Ωmƒõnu vybaven√≠ bƒõhem cestov√°n√≠
            if (state.map?.traveling) {
                notifyWarning('Nelze zmƒõnit', 'Bƒõhem cestov√°n√≠ nelze mƒõnit vybaven√≠!');
                return;
            }
            
            state.equipped = state.equipped || {};
            
            if (slotType === 'weapon') state.equipped.weapon = null;
            else if (slotType === 'armor') state.equipped.armor = null;
            else if (slotType === 'helmet') state.equipped.helmet = null;
            else if (slotType === 'gloves') state.equipped.gloves = null;
            else if (slotType === 'boots') state.equipped.boots = null;
            
            closeModal();
            notifySuccess('P≈ôedmƒõt sund√°n');
            renderFull();
        }
        
        // üîß OPRAVA P≈òEDMƒöTU ZA PEN√çZE
        function repairItemForMoney(idx) {
            const item = state.inv[idx];
            if (!item || item.durability === undefined) return;
            
            let repairCost = Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100);
            
            // Technik companion = opravy zdarma
            const companionBonuses = getAllCompanionBonuses();
            const freeRepair = companionBonuses.freeRepair;
            
            // Kov√°≈ô osadn√≠k = opravy zdarma
            const blacksmithSettler = state.settlement?.settlers?.find(s => s.type === 'blacksmith_s');
            const settlerFreeRepair = blacksmithSettler ? true : false;
            
            if (freeRepair || settlerFreeRepair) {
                repairCost = 0;
            }
            
            if (repairCost > 0 && state.money < repairCost) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot≈ôebuje≈° ${repairCost} üí∞`);
                return;
            }
            
            if (item.durability >= item.maxDurability) {
                notifyWarning('Nen√≠ pot≈ôeba', 'P≈ôedmƒõt je v perfektn√≠m stavu');
                return;
            }
            
            // Odeƒçti pen√≠ze (pokud nejsou zdarma) a oprav
            if (repairCost > 0) {
                state.money -= repairCost;
                state.stats.moneySpentOnRepairs = (state.stats.moneySpentOnRepairs || 0) + repairCost;
            }
            item.durability = item.maxDurability;
            
            closeModal();
            if (freeRepair) {
                notifySuccess('üîß Opraveno zdarma!', `${item.name} - Technik to zvl√°dl!`);
            } else if (settlerFreeRepair) {
                notifySuccess('üîß Opraveno zdarma!', `${item.name} - Kov√°≈ô v osadƒõ pomohl!`);
            } else {
                notifySuccess('üîß Opraveno!', `${item.name} je jako nov√Ω! (-${repairCost} üí∞)`);
            }
            saveGame();
            renderFull();
        }
        
        // üîß OPRAVIT V≈†E - hromadn√° oprava
        function repairAllItems() {
            let totalCost = 0;
            let itemsToRepair = [];
            
            state.inv.forEach((item, idx) => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    const cost = Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100);
                    totalCost += cost;
                    itemsToRepair.push({ item, idx, cost });
                }
            });
            
            if (itemsToRepair.length === 0) {
                notifySuccess('V≈°e v po≈ô√°dku', '≈Ω√°dn√Ω p≈ôedmƒõt nepot≈ôebuje opravu');
                return;
            }
            
            if (state.money < totalCost) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot≈ôebuje≈° ${totalCost} üí∞ na opravu v≈°eho`);
                return;
            }
            
            showModal('üîß Opravit v≈°e?', `
                <div style="text-align: center; padding: 1rem;">
                    <p>Opravit <strong>${itemsToRepair.length}</strong> p≈ôedmƒõt≈Ø?</p>
                    <p style="font-size: 1.5rem; color: #ffd700; margin: 1rem 0;">${totalCost} üí∞</p>
                    <p style="color: #888; font-size: 0.85rem;">M√°≈°: ${state.money} üí∞</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="confirmRepairAll(${totalCost})" style="background: #4caf50;">‚úÖ Opravit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                </div>
            `);
        }
        
        function confirmRepairAll(totalCost) {
            state.money -= totalCost;
            
            state.inv.forEach(item => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    item.durability = item.maxDurability;
                }
            });
            
            state.stats.moneySpentOnRepairs = (state.stats.moneySpentOnRepairs || 0) + totalCost;
            
            closeModal();
            notifySuccess('üîß V≈°e opraveno!', `-${totalCost} üí∞`);
            saveGame();
            renderFull();
        }
        
        // === MO≈ΩNOSTI PRO N√ÅSTROJE ===
        function showToolOptions(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            showToolOptionsByIndex(state.inv.indexOf(item));
        }
        
        function showToolOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const durabilityPct = item.durability !== undefined ? Math.round((item.durability / item.maxDurability) * 100) : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            // Kompletn√≠ seznam bonus≈Ø n√°stroj≈Ø
            const bonusDescriptions = {
                'mining': { icon: '‚õèÔ∏è', desc: 'Umo≈æ≈àuje tƒõ≈æbu kamene a rud', status: 'Funguje automaticky' },
                'fishing': { icon: 'üé£', desc: 'Umo≈æ≈àuje rybolov u vody', status: 'Jdi k vodƒõ a pou≈æij akci Rybolov' },
                'hunting': { icon: 'üèπ', desc: 'Bonus k lovu zvƒõ≈ôe', status: '+20% ≈°ance na √∫spƒõ≈°n√Ω lov' },
                'cooking': { icon: 'üç≥', desc: 'Lep≈°√≠ efektivita va≈ôen√≠', status: '+10% hodnota j√≠dla' },
                'alchemy': { icon: '‚öóÔ∏è', desc: 'V√Ωroba lektvar≈Ø a elix√≠r≈Ø', status: 'Odemyk√° alchymistick√© recepty' },
                'capacity': { icon: 'üéí', desc: 'Zv√Ω≈°en√° nosnost', status: '+20 kg nosnost (aktivn√≠)' },
                'climbing': { icon: 'üßó', desc: 'P≈ô√≠stup k horsk√Ωm oblastem', status: 'Umo≈æ≈àuje cestovat p≈ôes hory' },
                'escape': { icon: 'üèÉ', desc: 'Snaz≈°√≠ √∫tƒõk z boje', status: '+20% ≈°ance na √∫tƒõk' },
                'vision': { icon: 'üî≠', desc: 'Lep≈°√≠ p≈ôehled o okol√≠', status: '+1 viditelnost na mapƒõ' },
                'navigation': { icon: 'üß≠', desc: 'Rychlej≈°√≠ cestov√°n√≠', status: '-7.5% ƒças cestov√°n√≠' },
                'stealth': { icon: 'ü•∑', desc: 'Men≈°√≠ ≈°ance na p≈ôepaden√≠', status: '-30% ≈°ance na nep≈ô√°telsk√© setk√°n√≠' },
                'light': { icon: 'üî¶', desc: 'Svƒõtlo v temnotƒõ', status: 'Lep≈°√≠ viditelnost v noci' },
                'sharpen': { icon: '‚öîÔ∏è', desc: 'Ost≈ôen√≠ zbran√≠', status: 'Klikni pro +5 DMG doƒçasnƒõ' },
                'smelt': { icon: 'üî•', desc: 'Taven√≠ rud na kovy', status: 'P≈ôemƒõ≈à rudu na kov' },
                'food': { icon: 'üçñ', desc: 'Pasivn√≠ sbƒõr j√≠dla', status: '+1 j√≠dlo/den v osadƒõ' },
                'water': { icon: 'üíß', desc: 'ƒåi≈°tƒõn√≠ vody', status: '+2 ƒçist√° voda/den v osadƒõ' },
                'power': { icon: '‚ö°', desc: 'Energie pro osadu', status: 'Bonus k produkci osady' },
                'signal': { icon: 'üì°', desc: 'P≈ôivol√°n√≠ obchodn√≠k≈Ø', status: 'Klikni pro p≈ôivol√°n√≠ karavany' },
                'radiation': { icon: '‚ò¢Ô∏è', desc: 'Mƒõ≈ôen√≠ radiace', status: 'Zobrazuje √∫rove≈à radiace v oblasti' },
                'sleep': { icon: 'üí§', desc: 'Odpoƒçinek na 1 hodinu', status: '+50 HP, +80 Energie, -30 Hlad, -40 ≈Ω√≠ze≈à' }
            };
            
            const bonus = bonusDescriptions[item.bonus] || bonusDescriptions[item.effect] || { icon: 'üîß', desc: item.desc || 'Speci√°ln√≠ n√°stroj', status: 'Dr≈æ v invent√°≈ôi' };
            
            // Speci√°ln√≠ akce pro nƒõkter√© n√°stroje
            let specialAction = '';
            if (item.bonus === 'sharpen') {
                specialAction = `<button class="btn" onclick="useSharpen(${idx})" style="background: #ff9800;">‚öîÔ∏è Naost≈ôit zbra≈à (+5 DMG)</button>`;
            } else if (item.bonus === 'signal') {
                specialAction = `<button class="btn" onclick="useSignal(${idx})" style="background: #2196f3;">üì° P≈ôivolat karavanu</button>`;
            } else if (item.bonus === 'smelt') {
                specialAction = `<button class="btn" onclick="useSmelt(${idx})" style="background: #ff5722;">üî• Tavit rudu</button>`;
            } else if (item.effect === 'sleep') {
                specialAction = `<button class="btn" onclick="closeModal(); useItem('sleeping_bag');" style="background: #8bc34a;">üí§ J√≠t sp√°t (1 hodina)</button>`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0;">${item.name}</h3>
                    <p style="color: #8bc34a; margin: 0.5rem 0;">${bonus.icon} ${bonus.desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0; color: #ffd700;"><strong>Status:</strong> ${bonus.status}</p>
                    </div>
                    
                    ${item.durability !== undefined ? `
                        <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>${'üîß V√Ωdr≈æ:'}</span>
                                <span style="color: ${durabilityColor};">${item.durability}/${item.maxDurability}</span>
                            </div>
                            <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${durabilityPct}%; background: ${durabilityColor};"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${specialAction}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        // Speci√°ln√≠ akce n√°stroj≈Ø
        function useSharpen(idx) {
            const weapon = state.equipped?.weapon;
            if (!weapon) {
                showModal('‚öîÔ∏è Brus', 'Nem√°≈° vybavenou zbra≈à k naost≈ôen√≠!');
                return;
            }
            if (!state.weaponBuff) state.weaponBuff = { damage: 0, fights: 0 };
            state.weaponBuff.damage += 5;
            state.weaponBuff.fights += 5;
            closeModal();
            showModal('‚öîÔ∏è Naost≈ôeno!', `${weapon.icon} ${weapon.name} je ost≈ôej≈°√≠!<br><span style="color: #8bc34a;">+5 DMG na 5 boj≈Ø</span>`);
            renderFull();
        }
        
        function useSignal(idx) {
            if (state.caravan?.active) {
                showModal('üì° Vys√≠laƒçka', 'Karavana u≈æ je v oblasti!');
                return;
            }
            state.caravan = state.caravan || {};
            state.caravan.active = true;
            state.caravan.until = Date.now() + 600000; // 10 minut
            closeModal();
            notifySuccess('üì° Sign√°l odesl√°n!', 'Karavana doraz√≠ za chv√≠li');
            addLog('P≈ôivolal jsi karavanu vys√≠laƒçkou!', 'üì°');
            renderFull();
        }
        
        function useSmelt(idx) {
            // Kontrola jestli m√°≈° rudu
            const oreTypes = ['iron_ore', 'copper_ore', 'silver_ore', 'gold_ore'];
            const hasOre = oreTypes.some(ore => (state.resources[ore] || 0) > 0);
            
            if (!hasOre) {
                showModal('üî• Kamenn√° pec', 'Nem√°≈° ≈æ√°dnou rudu k taven√≠!<br><span style="color: #888;">Z√≠skej rudu tƒõ≈æbou (‚õèÔ∏è Krump√°ƒç)</span>');
                return;
            }
            
            showModal('üî• Taven√≠ rudy', `
                <p style="margin-bottom: 1rem;">Vyber rudu k roztaven√≠:</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${(state.resources.iron_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('iron_ore', 'metal')">ü™® ≈Ωelezn√° ruda (${state.resources.iron_ore}) ‚Üí ‚öôÔ∏è Kov</button>` : ''}
                    ${(state.resources.copper_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('copper_ore', 'copper')">üü§ Mƒõdƒõn√° ruda (${state.resources.copper_ore}) ‚Üí üü§ Mƒõƒè</button>` : ''}
                    ${(state.resources.silver_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('silver_ore', 'silver')">‚¨ú St≈ô√≠brn√° ruda (${state.resources.silver_ore}) ‚Üí ‚¨ú St≈ô√≠bro</button>` : ''}
                    ${(state.resources.gold_ore || 0) > 0 ? `<button class="btn" onclick="smeltOre('gold_ore', 'gold')">üü° Zlat√° ruda (${state.resources.gold_ore}) ‚Üí üü° Zlato</button>` : ''}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function smeltOre(oreType, metalType) {
            if ((state.resources[oreType] || 0) < 1) return;
            state.resources[oreType]--;
            state.resources[metalType] = (state.resources[metalType] || 0) + 2;
            closeModal();
            const icons = { metal: '‚öôÔ∏è', copper: 'üü§', silver: '‚¨ú', gold: 'üü°' };
            showModal('üî• Roztaveno!', `+2 ${icons[metalType]} ${metalType}`);
            renderFull();
        }
        
        // === MO≈ΩNOSTI PRO BRNƒöN√ç ===
        function showArmorOptions(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            showArmorOptionsByIndex(state.inv.indexOf(item));
        }
        
        function showArmorOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.armor === item;
            const durabilityPct = item.durability !== undefined ? Math.round((item.durability / item.maxDurability) * 100) : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            // V√Ωpoƒçet ceny opravy
            const repairCost = item.durability !== undefined ? Math.ceil((item.maxDurability - item.durability) * (item.price || 50) / 100) : 0;
            const canRepair = item.durability !== undefined && item.durability < item.maxDurability && state.money >= repairCost;
            const needsRepair = item.durability !== undefined && item.durability < item.maxDurability;
            
            // Popis speci√°ln√≠ch efekt≈Ø brnƒõn√≠
            const specialDescriptions = {
                'powered': '‚ö° +5 obrana, +5 damage',
                'stealth': 'ü•∑ -50% ≈°ance na p≈ôepaden√≠, +15% dodge',
                'berserker': 'üëπ +30% damage, -3 obrana',
                'phoenix': 'üî• Jednou za boj: p≈ôe≈æije≈° smrt s 30% HP',
                'titan': 'ü¶æ +5 obrana, imunita na kritick√© z√°sahy',
                'scout': 'üèÉ +15% dodge',
                'medic': 'üè• +50% efektivita l√©ƒçen√≠',
                'mutant': 'üß¨ +50% odolnost v≈Øƒçi radiaci a jed≈Øm',
                'exo': 'ü¶ø +50% nosnost, +10% damage',
                'nano': 'üî¨ +2 HP regenerace ka≈æd√© kolo v boji',
                'intimidate': 'üíÄ +2 damage',
                'scavenger': 'üéí +25% bonus loot',
                'camo': 'üåø -30% ≈°ance na n√°hodn√© souboje',
                'nightvision': 'üåô +15% damage v noci',
                'agile': 'üèÉ +10% dodge',
                'block': 'üõ°Ô∏è +15% ≈°ance na blok',
                'block_bonus': 'üõ°Ô∏è +10% ≈°ance na blok',
                'dodge_bonus': 'üí® +10% ≈°ance na √∫hyb',
                'rad_resist': '‚ò¢Ô∏è -30% radiace',
                'rad_immune': '‚ò¢Ô∏è -50% radiace',
                'night_vision': 'üëÅÔ∏è Noƒçn√≠ vidƒõn√≠',
                'fireproof': 'üî• Imunita na ohe≈à',
                'insulated': '‚ö° Imunita na elekt≈ôinu',
                'warm': '‚ùÑÔ∏è -30% ztr√°ta energie p≈ôi cestov√°n√≠',
                'endurance': 'üèÉ -30% ztr√°ta energie p≈ôi cestov√°n√≠'
            };
            
            const specialText = item.special ? (specialDescriptions[item.special] || `‚≠ê ${item.special}`) : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    ${item.desc ? `<p style="color: #888; font-style: italic; font-size: 0.85rem; margin: 0.3rem 0;">"${item.desc}"</p>` : ''}
                    <p style="color: #3949AB; margin: 0.5rem 0;">üõ°Ô∏è Obrana: +${item.defense}</p>
                    <p style="color: #888; margin: 0.2rem 0; font-size: 0.85rem;">‚öñÔ∏è V√°ha: ${item.weight || 0} kg</p>
                    ${specialText ? `<p style="color: #9c27b0; margin: 0.5rem 0;">${specialText}</p>` : ''}
                    
                    ${item.durability !== undefined ? `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>${'üîß V√Ωdr≈æ:'}</span>
                                <span style="color: ${durabilityColor};">${item.durability}/${item.maxDurability}</span>
                            </div>
                            <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${durabilityPct}%; background: ${durabilityColor};"></div>
                            </div>
                            ${needsRepair ? `
                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                                    <span style="color: #888; font-size: 0.85rem;">üí∞ ${'Cena opravy:'} <strong style="color: ${canRepair ? '#ffd700' : '#f44336'};">${repairCost} üí∞</strong></span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">‚úÖ Nasazeno</p>' : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${needsRepair ? `<button class="btn" onclick="repairItemForMoney(${idx})" style="background: ${canRepair ? '#2196f3' : '#555'};" ${!canRepair ? 'disabled' : ''}>üîß Opravit za ${repairCost} üí∞</button>` : ''}
                    ${!isEquipped ? `<button class="btn" onclick="equipArmorByIndex(${idx})" style="background: #4caf50;">‚úã Nasadit</button>` : `<button class="btn" onclick="unequipArmor()" style="background: #ff9800;">üëã Sundat</button>`}
                    <button class="btn" onclick="recycleItem(${idx})" style="background: #795548;">‚ôªÔ∏è Recyklovat</button>
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function showAmmoInfoByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const ammoNames = { 
                'arrow': { name: '≈†√≠py', weapon: 'Luk', icon: 'üèπ' },
                'bolt': { name: '≈†ipky', weapon: 'Ku≈°e', icon: 'üéØ' },
                '9mm': { name: 'N√°boje 9mm', weapon: 'Pistole', icon: 'üî´' },
                '556': { name: 'N√°boje 5.56', weapon: '√ötoƒçn√° pu≈°ka', icon: 'üî´' },
                '762': { name: 'N√°boje 7.62', weapon: 'Odst≈ôelovaƒçka', icon: 'üéØ' },
                'shell': { name: 'Brokov√© n√°boje', weapon: 'Brokovnice', icon: 'üî´' },
                'fuel': { name: 'Palivo', weapon: 'Plamenomet', icon: 'üî•' }
            };
            const ammoInfo = ammoNames[item.ammoType] || { name: item.name, weapon: 'Nezn√°m√°', icon: 'üéØ' };
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #ff9800; font-size: 1.3rem; margin: 0.5rem 0;">üì¶ Poƒçet: ${item.count || 1}</p>
                    <p style="color: #888; margin: 0.5rem 0;">${ammoInfo.icon} Pro zbra≈à: ${ammoInfo.weapon}</p>
                    <p style="color: #666; font-size: 0.85rem;">‚öñÔ∏è V√°ha: ${((item.weight || 0.1) * (item.count || 1)).toFixed(1)} kg</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${(item.count || 1) > 1 ? `<button class="btn" onclick="showSplitStackDialog(${idx})" style="background: #2196f3;">‚úÇÔ∏è Rozdƒõlit stack</button>` : ''}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function showThrowableInfoByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Z√≠skej n√°zev munice pokud je to ranged zbra≈à
            let ammoInfo = '';
            if (item.ammoType) {
                const ammoCount = getAmmoCount(item.ammoType);
                ammoInfo = `<p style="color: #ff9800; margin: 0.5rem 0;">üî∏ Munice: ${getAmmoName(item.ammoType)} (m√°≈°: ${ammoCount})</p>`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    ${item.damage ? `<p style="color: #ff4444; margin: 0.5rem 0;">${`üí• Po≈°kozen√≠: ${item.damage}`}</p>` : ''}
                    ${ammoInfo}
                    ${item.aoe ? `<p style="color: #ff9800;">${'üî• Plo≈°n√Ω efekt'}</p>` : ''}
                    ${item.special ? `<p style="color: #9c27b0;">${`‚≠ê Speci√°ln√≠: ${item.special}`}</p>` : ''}
                    ${item.effect === 'escape' ? `<p style="color: #4caf50;">${'üí® Umo≈æ≈àuje √∫tƒõk z boje'}</p>` : ''}
                    <p style="color: #888; margin: 0.5rem 0;">üì¶ Poƒçet: ${item.count || 1}</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${(item.count || 1) > 1 ? `<button class="btn" onclick="showSplitStackDialog(${idx})" style="background: #2196f3;">‚úÇÔ∏è Rozdƒõlit stack</button>` : ''}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function equipArmorByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Zamkni v√Ωmƒõnu vybaven√≠ bƒõhem cestov√°n√≠
            if (state.map?.traveling) {
                notifyWarning('Nelze zmƒõnit', 'Bƒõhem cestov√°n√≠ nelze mƒõnit vybaven√≠!');
                return;
            }
            
            // Kontrola ≈æe to je skuteƒçnƒõ zbroj
            if (item.type !== 'armor') {
                showModal('‚ùå Nelze nasadit', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">${item.icon || '‚ùå'}</div>
                        <p>${'Tento p≈ôedmƒõt nen√≠ zbroj!'}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Mutant nem≈Ø≈æe nosit brnƒõn√≠
            if (state.char.class === 'mutant') {
                showModal('‚ùå Nelze nasadit', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">ü¶é</div>
                        <p>Jsi p≈ô√≠li≈° velk√Ω a zdeformovan√Ω na bƒõ≈æn√© brnƒõn√≠!</p>
                        <p style="color: #76ff03;">Tv√° mutant√≠ k≈Ø≈æe ti d√°v√° +10 p≈ôirozen√© obrany.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // P≈ôidej unik√°tn√≠ ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.armor = item;
            
            closeModal();
            notifySuccess('Brnƒõn√≠ nasazeno!', item.name);
            renderFull();
        }
        
        function equipArmor(itemId) {
            // Pro zpƒõtnou kompatibilitu
            const item = state.inv.find(i => i.id === itemId && i.type === 'armor' && !isItemEquipped(i)) || state.inv.find(i => i.id === itemId && i.type === 'armor');
            if (item) {
                const idx = state.inv.indexOf(item);
                equipArmorByIndex(idx);
            }
        }
        
        function unequipArmor() {
            // Zamkni v√Ωmƒõnu vybaven√≠ bƒõhem cestov√°n√≠
            if (state.map?.traveling) {
                notifyWarning('Nelze zmƒõnit', 'Bƒõhem cestov√°n√≠ nelze mƒõnit vybaven√≠!');
                return;
            }
            
            state.equipped = state.equipped || {};
            state.equipped.armor = null;
            
            closeModal();
            notifySuccess('Brnƒõn√≠ sund√°no');
            renderFull();
        }
        
        // === RUKAVICE ===
        function showGlovesOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.gloves === item;
            const durabilityPct = item.durability ? (item.durability / item.maxDurability) * 100 : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            const glovesSpecials = {
                'block_bonus': 'üõ°Ô∏è +10% ≈°ance na blok',
                'unarmed_bonus': 'üëä +5 damage beze zbranƒõ',
                'grip': 'üéØ +10% p≈ôesnost st≈ôelby',
                'bleed_punch': 'ü©∏ √ötok pƒõst√≠ zp≈Øsob√≠ krv√°cen√≠',
                'power_punch': 'üí™ +10 damage v boji zbl√≠zka',
                'medic_bonus': 'üè• +20% efektivita l√©ƒçen√≠',
                'rad_resist': '‚ò¢Ô∏è -20% radiace'
            };
            const specialText = item.special ? (glovesSpecials[item.special] || `‚≠ê ${item.special}`) : '';
            const specialClickable = item.special ? `<p onclick="showSpecialEffectDetail('${item.special}')" style="color: #9c27b0; margin: 0.5rem 0; cursor: pointer; text-decoration: underline;">${specialText} ‚ÑπÔ∏è</p>` : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #ff9800; margin: 0.5rem 0;">ü•ä Obrana: +${item.defense}</p>
                    ${specialClickable}
                    ${item.durability !== undefined ? `<p style="color: ${durabilityColor};">${`üîß V√Ωdr≈æ: ${item.durability}/${item.maxDurability}`}</p>` : ''}
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">‚úÖ Nasazeno</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${!isEquipped ? `<button class="btn" onclick="equipGlovesByIndex(${idx})" style="background: #4caf50;">‚úã Nasadit</button>` : `<button class="btn" onclick="unequipGloves()" style="background: #ff9800;">üëã Sundat</button>`}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function equipGlovesByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // P≈ôidej unik√°tn√≠ ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.gloves = item;
            
            closeModal();
            notifySuccess('Rukavice nasazeny!', item.name);
            renderFull();
        }
        
        function unequipGloves() {
            state.equipped = state.equipped || {};
            state.equipped.gloves = null;
            
            closeModal();
            notifySuccess('Rukavice sund√°ny');
            renderFull();
        }
        
        // === BOTY ===
        function showBootsOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.boots === item;
            const durabilityPct = item.durability ? (item.durability / item.maxDurability) * 100 : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            const bootsSpecials = {
                'dodge_bonus': 'üí® +10% ≈°ance na √∫hyb',
                'speed_bonus': 'üèÉ +10% rychlost cestov√°n√≠',
                'stealth_move': 'ü•∑ -20% ≈°ance na p≈ôepaden√≠',
                'run_bonus': 'üèÉ +15% rychlost √∫tƒõku',
                'stomp': 'ü¶∂ Siln√Ω kop (+8 damage)',
                'jump': 'ü¶ò +25% dodge',
                'warm_feet': '‚ùÑÔ∏è -15% ztr√°ta energie',
                'power_kick': 'ü¶ø +20% rychlost, +10 defense',
                'exo': 'ü¶æ +50% nosnost, +10% damage',
                'sturdy': 'üîß +2 defense (stabilita)',
                'combat_stance': '‚öîÔ∏è +5% kritick√Ω z√°sah',
                'light_feet': 'ü©¥ +5% rychlost cestov√°n√≠'
            };
            const specialText = item.special ? (bootsSpecials[item.special] || `‚≠ê ${item.special}`) : '';
            const specialClickable = item.special ? `<p onclick="showSpecialEffectDetail('${item.special}')" style="color: #9c27b0; margin: 0.5rem 0; cursor: pointer; text-decoration: underline;">${specialText} ‚ÑπÔ∏è</p>` : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #00bcd4; margin: 0.5rem 0;">ü•æ Obrana: +${item.defense}</p>
                    ${specialClickable}
                    ${item.durability !== undefined ? `<p style="color: ${durabilityColor};">${`üîß V√Ωdr≈æ: ${item.durability}/${item.maxDurability}`}</p>` : ''}
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">‚úÖ Nasazeno</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${!isEquipped ? `<button class="btn" onclick="equipBootsByIndex(${idx})" style="background: #4caf50;">‚úã Nasadit</button>` : `<button class="btn" onclick="unequipBoots()" style="background: #ff9800;">üëã Sundat</button>`}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function equipBootsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // P≈ôidej unik√°tn√≠ ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.boots = item;
            
            console.log('üë¢ Equipped boots:', item.name, 'special:', item.special);
            
            closeModal();
            notifySuccess('Boty nasazeny!', item.name + (item.special ? ' (' + item.special + ')' : ''));
            renderFull();
        }
        
        function unequipBoots() {
            state.equipped = state.equipped || {};
            state.equipped.boots = null;
            
            closeModal();
            notifySuccess('Boty sund√°ny');
            renderFull();
        }
        
        // === HELMA ===
        function showHelmetOptionsByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const isEquipped = state.equipped?.helmet === item;
            const durabilityPct = item.durability ? (item.durability / item.maxDurability) * 100 : 100;
            const durabilityColor = durabilityPct > 50 ? '#4caf50' : durabilityPct > 20 ? '#ff9800' : '#f44336';
            
            const helmetSpecials = {
                'crit_immune': 'üõ°Ô∏è Imunita na kritick√© z√°sahy',
                'rad_resist': '‚ò¢Ô∏è -30% radiace',
                'night_vision': 'üëÅÔ∏è Noƒçn√≠ vidƒõn√≠',
                'gas_filter': '‚òÅÔ∏è Imunita na jedy',
                'headshot_protect': 'üéØ -50% damage na hlavu'
            };
            const specialText = item.special ? (helmetSpecials[item.special] || `‚≠ê ${item.special}`) : '';
            const specialClickable = item.special ? `<p onclick="showSpecialEffectDetail('${item.special}')" style="color: #9c27b0; margin: 0.5rem 0; cursor: pointer; text-decoration: underline;">${specialText} ‚ÑπÔ∏è</p>` : '';
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #795548; margin: 0.5rem 0;">‚õëÔ∏è Obrana: +${item.defense}</p>
                    ${specialClickable}
                    ${item.durability !== undefined ? `<p style="color: ${durabilityColor};">${`üîß V√Ωdr≈æ: ${item.durability}/${item.maxDurability}`}</p>` : ''}
                    ${isEquipped ? '<p style="color: #4caf50; font-weight: bold;">‚úÖ Nasazeno</p>' : ''}
                </div>
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    ${!isEquipped ? `<button class="btn" onclick="equipHelmetByIndex(${idx})" style="background: #4caf50;">‚úã Nasadit</button>` : `<button class="btn" onclick="unequipHelmet()" style="background: #ff9800;">üëã Sundat</button>`}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function equipHelmetByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // P≈ôidej unik√°tn√≠ ID
            if (!item._uniqueId) {
                item._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            state.equipped = state.equipped || {};
            state.equipped.helmet = item;
            
            closeModal();
            notifySuccess('Helma nasazena!', item.name);
            renderFull();
        }
        
        function unequipHelmet() {
            state.equipped = state.equipped || {};
            state.equipped.helmet = null;
            
            closeModal();
            notifySuccess('Helma sund√°na');
            renderFull();
        }
        
        // === ZAHOZEN√ç P≈òEDMƒöTU ===
        function dropItemByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Pokud m√° v√≠ce kus≈Ø, zobraz dialog pro v√Ωbƒõr poƒçtu
            if (item.count && item.count > 1) {
                showDropAmountDialog(idx);
                return;
            }
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon === item) state.equipped.weapon = null;
            if (state.equipped?.armor === item) state.equipped.armor = null;
            if (state.equipped?.gloves === item) state.equipped.gloves = null;
            if (state.equipped?.boots === item) state.equipped.boots = null;
            if (state.equipped?.helmet === item) state.equipped.helmet = null;
            
            // Odeber z invent√°≈ôe
            state.inv.splice(idx, 1);
            
            // Aktualizuj nosnost
            updateCarryWeight();
            
            closeModal();
            addLog('Zahodil jsi ' + item.name, 'üóëÔ∏è');
            notifyWarning('Zahozeno', item.name);
            renderFull();
        }
        
        // Dialog pro v√Ωbƒõr poƒçtu k zahozen√≠
        function showDropAmountDialog(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const maxDrop = item.count || 1;
            const defaultDrop = 1;
            
            showModal(`üóëÔ∏è ${'Zahodit'} ${item.icon} ${item.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${item.icon}</div>
                    <p style="color: #888;">${'M√°≈°'}: <strong style="color: #ffd700;">${item.count}x</strong></p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <label style="color: #888; display: block; margin-bottom: 0.5rem;">${'Kolik zahodit?'}</label>
                    <input type="range" id="dropAmount" min="1" max="${maxDrop}" value="${defaultDrop}" 
                        style="width: 100%;"
                        oninput="document.getElementById('dropValue').textContent = this.value; document.getElementById('keepValue').textContent = (${maxDrop} - parseInt(this.value));">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span style="color: #666;">1</span>
                        <span style="color: #f44336; font-size: 1.2rem; font-weight: bold;" id="dropValue">${defaultDrop}</span>
                        <span style="color: #666;">${maxDrop}</span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-around; background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">${'Ponechat'}</div>
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;" id="keepValue">${maxDrop - defaultDrop}</div>
                    </div>
                    <div style="color: #555; font-size: 2rem;">üóëÔ∏è</div>
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">${'Zahodit'}</div>
                        <div style="color: #f44336; font-size: 1.5rem; font-weight: bold;" id="dropValueDisplay">${defaultDrop}</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="confirmDropAmount(${idx})" style="flex: 1; background: #c62828;">
                        üóëÔ∏è ${'Zahodit'}
                    </button>
                    <button class="btn" onclick="confirmDropAll(${idx})" style="flex: 1; background: #8B0000;">
                        üíÄ ${'Zahodit v≈°e'}
                    </button>
                </div>
                <button class="btn" onclick="closeModal(); showItemDetails(${idx});" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    ‚Üê ${'Zpƒõt'}
                </button>
            `);
            
            // Synchronizuj oba displeje - pou≈æij closure pro maxDrop
            const maxDropValue = maxDrop;
            setTimeout(() => {
                const slider = document.getElementById('dropAmount');
                if (slider) {
                    slider.oninput = function() {
                        document.getElementById('dropValue').textContent = this.value;
                        document.getElementById('dropValueDisplay').textContent = this.value;
                        document.getElementById('keepValue').textContent = maxDropValue - parseInt(this.value);
                    };
                }
            }, 100);
        }
        
        function confirmDropAmount(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const dropAmount = parseInt(document.getElementById('dropAmount')?.value || 1);
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon === item) state.equipped.weapon = null;
            if (state.equipped?.armor === item) state.equipped.armor = null;
            if (state.equipped?.gloves === item) state.equipped.gloves = null;
            if (state.equipped?.boots === item) state.equipped.boots = null;
            if (state.equipped?.helmet === item) state.equipped.helmet = null;
            
            // Odeber z invent√°≈ôe
            if (item.count && item.count > dropAmount) {
                item.count -= dropAmount;
            } else {
                state.inv.splice(idx, 1);
            }
            
            // Aktualizuj nosnost
            updateCarryWeight();
            
            closeModal();
            addLog('Zahodil jsi ' + dropAmount + 'x ' + item.name, 'üóëÔ∏è');
            notifyWarning('Zahozeno', dropAmount + 'x ' + item.name);
            renderFull();
        }
        
        function confirmDropAll(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            const dropAmount = item.count || 1;
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon === item) state.equipped.weapon = null;
            if (state.equipped?.armor === item) state.equipped.armor = null;
            if (state.equipped?.gloves === item) state.equipped.gloves = null;
            if (state.equipped?.boots === item) state.equipped.boots = null;
            if (state.equipped?.helmet === item) state.equipped.helmet = null;
            
            // Odeber cel√Ω stack
            state.inv.splice(idx, 1);
            
            // Aktualizuj nosnost
            updateCarryWeight();
            
            closeModal();
            addLog('Zahodil jsi ' + dropAmount + 'x ' + item.name, 'üóëÔ∏è');
            notifyWarning('Zahozeno', dropAmount + 'x ' + item.name);
            renderFull();
        }
        
        // === ROZDƒöLEN√ç STACKU ===
        function showSplitStackDialog(idx) {
            const item = state.inv[idx];
            if (!item || !item.count || item.count <= 1) {
                notifyError('Nelze rozdƒõlit', 'M√°≈° jen 1 kus');
                return;
            }
            
            const maxSplit = item.count - 1;
            const defaultSplit = Math.floor(item.count / 2);
            const totalCount = item.count;
            
            showModal(`‚úÇÔ∏è Rozdƒõlit ${item.icon} ${item.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${item.icon}</div>
                    <p style="color: #888;">Celkem: <strong style="color: #ffd700;">${item.count}x</strong></p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <label style="color: #888; display: block; margin-bottom: 0.5rem;">Kolik oddƒõlit do nov√©ho stacku?</label>
                    <input type="range" id="splitAmount" min="1" max="${maxSplit}" value="${defaultSplit}" 
                        style="width: 100%;"
                        oninput="document.getElementById('splitValue').textContent = this.value; document.getElementById('originalStack').textContent = (${totalCount} - parseInt(this.value)) + 'x'; document.getElementById('newStack').textContent = this.value + 'x';">
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span style="color: #666;">1</span>
                        <span style="color: #ffd700; font-size: 1.2rem; font-weight: bold;" id="splitValue">${defaultSplit}</span>
                        <span style="color: #666;">${maxSplit}</span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-around; background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">P≈Øvodn√≠ stack</div>
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;" id="originalStack">${item.count - defaultSplit}x</div>
                    </div>
                    <div style="color: #555; font-size: 2rem;">‚Üí</div>
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Nov√Ω stack</div>
                        <div style="color: #2196f3; font-size: 1.5rem; font-weight: bold;" id="newStack">${defaultSplit}x</div>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="splitStack(${idx}, parseInt(document.getElementById('splitAmount').value))" style="background: #4caf50;">
                        ‚úÇÔ∏è Rozdƒõlit
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function splitStack(idx, amount) {
            const item = state.inv[idx];
            if (!item || !item.count || item.count <= 1) return;
            if (amount <= 0 || amount >= item.count) return;
            
            console.log('splitStack: idx=', idx, 'amount=', amount, 'item.count before=', item.count);
            
            const originalCount = item.count;
            
            // Vytvo≈ô NOV√ù objekt ruƒçnƒõ (ne spread) s unik√°tn√≠m stackId
            const newItem = {
                id: item.id,
                name: item.name,
                icon: item.icon,
                type: item.type,
                effect: item.effect,
                value: item.value,
                weight: item.weight,
                price: item.price,
                rarity: item.rarity,
                stackable: true,
                count: amount,
                stackId: 'split_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            // Zkop√≠ruj dal≈°√≠ vlastnosti pokud existuj√≠
            if (item.buff) newItem.buff = item.buff;
            if (item.duration) newItem.duration = item.duration;
            if (item.ammoType) newItem.ammoType = item.ammoType;
            if (item.damage) newItem.damage = item.damage;
            if (item.aoe) newItem.aoe = item.aoe;
            if (item.special) newItem.special = item.special;
            
            // Sni≈æ p≈Øvodn√≠ stack
            item.count = originalCount - amount;
            
            console.log('splitStack: item.count after=', item.count, 'newItem.count=', newItem.count);
            console.log('splitStack: inv length before push=', state.inv.length);
            
            // P≈ôidej nov√Ω stack na konec invent√°≈ôe
            state.inv.push(newItem);
            
            console.log('splitStack: inv length after push=', state.inv.length);
            console.log('splitStack: state.inv items:', state.inv.map(i => i.name + ' x' + (i.count || 1)));
            
            closeModal();
            notifySuccess('Stack rozdƒõlen', `${item.name}: ${item.count}x + ${newItem.count}x`);
            saveGame(true);
            renderFull();
            
            // Debug po renderFull
            console.log('splitStack: after renderFull, inv length=', state.inv.length);
        }
        
        function dropItem(itemId) {
            const itemIndex = state.inv.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;
            
            const item = state.inv[itemIndex];
            
            // Pokud je nasazeno, sundej
            if (state.equipped?.weapon?.id === itemId) state.equipped.weapon = null;
            if (state.equipped?.armor?.id === itemId) state.equipped.armor = null;
            
            // Odeber z invent√°≈ôe
            if (item.count > 1) {
                item.count--;
            } else {
                state.inv.splice(itemIndex, 1);
            }
            
            closeModal();
            notifyWarning('Zahozeno', item.name);
            addLog(`Zahodil jsi ${item.name}`, 'üóëÔ∏è');
            renderFull();
        }

        function confirmUseItemByIndex(idx) {
            const item = state.inv[idx];
            if (!item) return;
            
            // Pro spac√°k pou≈æij existuj√≠c√≠ logiku
            if (item.effect === 'sleep') {
                useItem(item.id);
                return;
            }
            
            // Popis efektu
            let effectDesc = '';
            if (item.effect === 'health') {
                effectDesc = `‚ù§Ô∏è Vyl√©ƒç√≠ <strong>+${item.value} HP</strong>`;
            } else if (item.effect === 'hunger') {
                effectDesc = `üçñ Nasyt√≠ <strong>+${item.value}%</strong> hladu`;
            } else if (item.effect === 'thirst') {
                effectDesc = `üíß Osvƒõ≈æ√≠ <strong>+${item.value}%</strong> ≈æ√≠znƒõ`;
            } else if (item.effect === 'energy') {
                effectDesc = `‚ö° Dod√° <strong>+${item.value}%</strong> energie`;
            } else if (item.effect === 'radiation') {
                effectDesc = `‚ò¢Ô∏è Radiace <strong>${item.value}</strong>`;
            } else if (item.buff) {
                effectDesc = `‚ú® Buff: <strong>+${item.value} ${item.buff}</strong> na ${Math.floor((item.duration || 300) / 60)} min`;
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${RARITY_COLORS[item.rarity] || '#fff'};">${item.name}</h3>
                    ${item.rarity ? `<p style="color: ${RARITY_COLORS[item.rarity]}; font-size: 0.8rem; margin: 0.2rem 0; text-transform: uppercase;">${getRarityName(item.rarity)}</p>` : ''}
                    <p style="color: #999; margin: 0.5rem 0;">‚öñÔ∏è V√°ha: ${item.weight || 0} kg</p>
                    ${item.count > 1 ? `<p style="color: #ffd700;">${`üì¶ Poƒçet: ${item.count}x`}</p>` : ''}
                    
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0; font-size: 1.1rem;">${effectDesc}</p>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal(); useItem('${item.id}');" style="background: #4caf50;">‚úì Pou≈æ√≠t</button>
                    ${item.count > 1 ? `<button class="btn" onclick="showSplitStackDialog(${idx})" style="background: #2196f3;">‚úÇÔ∏è Rozdƒõlit stack (${item.count}x)</button>` : ''}
                    <button class="btn" onclick="dropItemByIndex(${idx})" style="background: #c62828;">üóëÔ∏è Zahodit</button>
                    <button class="btn" onclick="closeModal()" style="background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        function confirmUseItem(itemId) {
            const idx = state.inv.findIndex(i => i.id === itemId);
            if (idx !== -1) {
                confirmUseItemByIndex(idx);
            }
        }
        
        function useItem(itemId) {
            console.log('=== useItem called ===');
            console.log('itemId:', itemId);
            
            const item = state.inv.find(i => i.id === itemId);
            console.log('item from inventory:', item);
            
            if (!item) {
                console.log('ERROR: item not found in inventory');
                return;
            }
            
            // Knihy - p≈ôeƒçti
            if (item.type === 'lore') {
                readLoreBook(item.id);
                return;
            }
            
            // SPAC√ÅK - speci√°ln√≠ handling P≈òED kontrolou consumable typu
            if (item.effect === 'sleep') {
                console.log('Sleep effect detected!');
                const now = Date.now();
                const timeSinceLastSleep = now - (state.lastSleepTime || 0);
                const hoursToWait = 24 * 60 * 60 * 1000;
                
                console.log('timeSinceLastSleep:', timeSinceLastSleep);
                console.log('hoursToWait:', hoursToWait);
                
                if (timeSinceLastSleep < hoursToWait) {
                    const hoursLeft = Math.ceil((hoursToWait - timeSinceLastSleep) / (60 * 60 * 1000));
                    showModal('üò¥ Nejsi unaven√Ω', `<div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üò¥</div>
                        <p>Je≈°tƒõ nejsi dost unaven√Ω na sp√°nek.</p>
                        <p style="color: #ff9800;">M≈Ø≈æe≈° sp√°t znovu za <strong>${hoursLeft} hodin</strong>.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>`);
                    return;
                }
                
                console.log('Showing sleep confirmation modal...');
                
                // Show confirmation dialog
                const modalHTML = '<div style="text-align: left;">' +
                    '<p style="font-size: 1.1rem; color: #ff9800; text-align: center; margin-bottom: 1rem;">‚ö†Ô∏è Opravdu chce≈° j√≠t sp√°t na 1 hodinu?</p>' +
                    '<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                    '<h3 style="margin: 0 0 0.5rem 0; color: #d4722e;">‚è±Ô∏è Bƒõhem sp√°nku:</h3>' +
                    '<ul style="margin: 0.5rem 0; line-height: 1.8;">' +
                    '<li>üîí <strong>Nem≈Ø≈æe≈° dƒõlat NIC</strong> celou 1 hodinu re√°ln√©ho ƒçasu</li>' +
                    '<li>‚è∏Ô∏è Hra bude zablokovan√°</li>' +
                    '<li>‚è≥ ƒåas norm√°lnƒõ bƒõ≈æ√≠</li>' +
                    '</ul></div>' +
                    '<div style="background: #1a4d1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                    '<h3 style="margin: 0 0 0.5rem 0; color: #8bc34a;">‚úÖ Co se stane:</h3>' +
                    '<ul style="margin: 0.5rem 0; line-height: 1.8;">' +
                    '<li>‚ù§Ô∏è HP: <strong>+50</strong></li>' +
                    '<li>‚ö° Energie: <strong>+80</strong></li>' +
                    '</ul></div>' +
                    '<div style="background: #4d1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                    '<h3 style="margin: 0 0 0.5rem 0; color: #ff9800;">‚ö†Ô∏è Upozornƒõn√≠:</h3>' +
                    '<ul style="margin: 0.5rem 0; line-height: 1.8;">' +
                    '<li>üçñ Hlad: <strong>-30</strong></li>' +
                    '<li>üíß ≈Ω√≠ze≈à: <strong>-40</strong></li>' +
                    '</ul>' +
                    '<p style="margin: 0.5rem 0 0 0; color: #ff9800; font-size: 0.9rem;">üí° Ujisti se ≈æe m√°≈° dost j√≠dla a vody na pozdƒõji!</p>' +
                    '</div></div>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">' +
                    '<button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>' +
                    '<button class="btn" onclick="startSleeping()" style="background: #8bc34a;">üí§ Ano, j√≠t sp√°t</button>' +
                    '</div>';
                
                showModal('üí§ J√≠t sp√°t?', modalHTML);
                return;
            }
            
            // SRDCE BEHEMOTHA - permanentn√≠ +50 max HP
            if (item.id === 'mutant_heart') {
                // Kontrola jestli u≈æ bylo pou≈æito
                if (state.secrets?.includes('used_mutant_heart')) {
                    showModal('üíú Srdce Behemotha', `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem;">üíú</div>
                            <p style="color: #ff9800;">U≈æ jsi jednou srdce pou≈æil.</p>
                            <p style="color: #888;">Tv√© tƒõlo ji≈æ absorbovalo jeho s√≠lu.</p>
                            <p style="color: #666; font-size: 0.85rem; margin-top: 1rem;">M≈Ø≈æe≈° ho prodat za 4000 üí∞</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                    return;
                }
                
                // Potvrƒè pou≈æit√≠
                showModal('üíú Srdce Behemotha', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; animation: pulse 1s infinite;">üíú</div>
                        <p style="color: #9c27b0; font-size: 1.2rem; margin: 1rem 0;">Masivn√≠ srdce st√°le tepe...</p>
                        <p>Absorbovat jeho s√≠lu?</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4caf50;">
                            <p style="color: #8bc34a; margin: 0;">‚ú® <strong>+50 Max HP</strong> (permanentnƒõ)</p>
                        </div>
                        <p style="color: #888; font-size: 0.85rem;">Srdce bude zniƒçeno.</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                        <button class="btn" onclick="useMutantHeart()" style="background: linear-gradient(135deg, #9c27b0, #673ab7);">üíú Absorbovat</button>
                    </div>
                `);
                return;
            }
            
            // AI CHIP - vylep≈°en√≠ zbranƒõ nebo zbroje
            if (item.id === 'ai_chip') {
                showAIChipUpgradeModal();
                return;
            }
            
            if (item.type !== 'consumable') {
                console.log('ERROR: item is not consumable, type:', item.type);
                return;
            }
            
            console.log('item.effect:', item.effect);
            
            // For other consumables, use item data
            console.log('Processing other consumable...');
            
            if (item.effect === 'health') {
                let healAmount = item.value;
                
                // Companion skills healing bonus
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.healingBonus > 0) {
                    healAmount = Math.floor(healAmount * (1 + compBonuses.healingBonus));
                }
                
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                SoundSystem.play('pickup');
                showFloatingNumber(healAmount, 'heal');
                showModal('Pou≈æito', `${item.icon} ${item.name}!<br><span style="color: #8bc34a;">‚ù§Ô∏è +${healAmount} HP</span>${compBonuses.healingBonus > 0 ? '<br><span style="color: #81c784;">üêæ Bonus od spoleƒçn√≠ka!</span>' : ''}`);
                
                // Daily quest progress
                if (state.dailyQuests?.progress) {
                    state.dailyQuests.progress.healed = (state.dailyQuests.progress.healed || 0) + healAmount;
                    checkDailyQuests();
                }
            } else if (item.effect === 'radiation') {
                state.status.radiation = Math.max(0, state.status.radiation + item.value);
                SoundSystem.play('pickup');
                showModal('Pou≈æito', `${item.icon} ${item.name}!<br><span style="color: #8bc34a;">‚ò¢Ô∏è ${item.value} radiace</span>`);
            } else if (item.effect === 'rad_resist') {
                // Doƒçasn√° odolnost radiaci
                if (!state.buffs) state.buffs = {};
                state.buffs.radResist = { value: item.value, until: Date.now() + 300000 }; // 5 minut
                SoundSystem.play('pickup');
                showModal('Pou≈æito', `${item.icon} ${item.name}!<br><span style="color: #ffd700;">‚ò¢Ô∏è Odolnost radiaci +${item.value}% na 5 minut!</span>`);
            } else if (item.effect === 'all_stats') {
                // Bonus ke v≈°em stat≈Øm doƒçasnƒõ
                if (!state.buffs) state.buffs = {};
                state.buffs.allStats = { value: item.value, until: Date.now() + 600000 }; // 10 minut
                SoundSystem.play('pickup');
                showModal('Pou≈æito', `${item.icon} ${item.name}!<br><span style="color: #ffd700;">‚ú® +${item.value} ke v≈°em stat≈Øm na 10 minut!</span>`);
            } else if (item.effect === 'weapon_buff') {
                // Bonus k damage zbranƒõ
                if (!state.weaponBuff) state.weaponBuff = { damage: 0, fights: 0 };
                state.weaponBuff.damage += item.value;
                state.weaponBuff.fights += 10;
                SoundSystem.play('pickup');
                showModal('Pou≈æito', `${item.icon} ${item.name}!<br><span style="color: #ffd700;">‚öîÔ∏è +${item.value} damage na 10 boj≈Ø!</span>`);
            } else if (item.effect === 'repair') {
                // Opravn√° sada - najdi po≈°kozenou zbra≈à/zbroj
                const damagedItems = state.inv.filter(i => i.durability !== undefined && i.durability < i.maxDurability);
                const equippedWeapon = state.equipped?.weapon;
                const equippedArmor = state.equipped?.armor;
                
                if (equippedWeapon && equippedWeapon.durability < equippedWeapon.maxDurability) {
                    damagedItems.unshift(equippedWeapon);
                }
                if (equippedArmor && equippedArmor.durability < equippedArmor.maxDurability) {
                    damagedItems.unshift(equippedArmor);
                }
                
                if (damagedItems.length === 0) {
                    showModal('Opravn√° sada', 'Nem√°≈° ≈æ√°dn√© po≈°kozen√© vybaven√≠!');
                    return; // Nespot≈ôebov√°vej
                }
                
                // Zobraz v√Ωbƒõr
                showModal('üîß Opravn√° sada', `
                    <p style="margin-bottom: 1rem;">Vyber vybaven√≠ k opravƒõ (+${item.value} durability):</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${damagedItems.map((di, idx) => `
                            <button class="btn" onclick="repairWithKit('${item.id}', ${idx})" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${di.icon} ${di.name}</span>
                                <span style="color: #ff9800;">${di.durability}/${di.maxDurability}</span>
                            </button>
                        `).join('')}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚ùå Zru≈°it</button>
                `);
                // Ulo≈æ√≠me po≈°kozen√© itemy pro pozdƒõj≈°√≠ p≈ô√≠stup
                window._damagedItems = damagedItems;
                return; // Nespot≈ôebov√°vej je≈°tƒõ
            } else if (item.effect !== 'sleep') {
                // Standardn√≠ efekty (hunger, thirst, energy)
                let effectValue = item.value;
                
                // üéñÔ∏è Vojensk√Ω tr√©nink - survival bonus (+5% efektivita j√≠dla/vody za ka≈æd√Ω tr√©nink)
                if ((item.effect === 'hunger' || item.effect === 'thirst') && state.trainingBonuses?.survival > 0) {
                    effectValue = Math.floor(effectValue * (1 + state.trainingBonuses.survival));
                }
                
                // üå∂Ô∏è Exotic bonus - Exotick√© ko≈ôen√≠ (dvojn√°sobn√Ω efekt j√≠dla)
                if (item.effect === 'hunger' && state.exoticBonuses?.foodBoost > 0) {
                    effectValue = effectValue * 2;
                    state.exoticBonuses.foodBoost--;
                }
                
                state.status[item.effect] = Math.min(100, state.status[item.effect] + effectValue);
                SoundSystem.play('pickup');
                const effectNames = { hunger: 'üçñ Hlad', thirst: 'üíß ≈Ω√≠ze≈à', energy: '‚ö° Energie' };
                
                // APLIKACE SECONDARY EFEKT≈Æ (hp, energy, thirst z uva≈ôen√Ωch j√≠del)
                // Fallback: naƒçti secondary z receptu pokud item nem√° (star≈°√≠ ulo≈æen√© hry)
                let secondary = item.secondary;
                if (!secondary) {
                    const recipe = typeof CRAFTING !== 'undefined' ? CRAFTING.find(r => r.id === item.id) : null;
                    if (recipe?.result?.secondary) {
                        secondary = recipe.result.secondary;
                    }
                }
                
                let secondaryText = '';
                if (secondary) {
                    if (secondary.hp) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + secondary.hp);
                        secondaryText += `<br><span style="color: #f44336;">‚ù§Ô∏è HP +${secondary.hp}</span>`;
                    }
                    if (secondary.energy) {
                        state.status.energy = Math.min(100, state.status.energy + secondary.energy);
                        secondaryText += `<br><span style="color: #ffc107;">‚ö° Energie +${secondary.energy}%</span>`;
                    }
                    if (secondary.thirst) {
                        state.status.thirst = Math.min(100, state.status.thirst + secondary.thirst);
                        secondaryText += `<br><span style="color: #2196f3;">üíß ≈Ω√≠ze≈à +${secondary.thirst}%</span>`;
                    }
                    if (secondary.hunger) {
                        state.status.hunger = Math.min(100, state.status.hunger + secondary.hunger);
                        secondaryText += `<br><span style="color: #8bc34a;">üçñ Hlad +${secondary.hunger}%</span>`;
                    }
                }
                
                // Vtipn√° hl√°≈°ka pro j√≠dlo
                let foodHumor = '';
                if (item.effect === 'hunger') {
                    foodHumor = '<p style="color: #666; font-style: italic; font-size: 0.8rem; margin-top: 0.5rem;">"' + getRandomHumor('foodWeird') + '"</p>';
                }
                // Zobraz bonus pokud je aktivn√≠
                const bonusText = (item.effect === 'hunger' || item.effect === 'thirst') && state.trainingBonuses?.survival > 0 
                    ? `<br><span style="color: #ffd700; font-size: 0.8rem;">üéñÔ∏è Survival bonus: +${Math.floor(state.trainingBonuses.survival * 100)}%</span>` 
                    : '';
                showModal('Pou≈æito', `${item.icon} ${item.name}!<br><span style="color: #8bc34a;">${effectNames[item.effect] || item.effect} +${effectValue}%</span>${secondaryText}${bonusText}${foodHumor}`);
            }
            
            // Don't consume sleeping bag - it's reusable
            if (item.effect !== 'sleep') {
                removeItemFromInventory(item, 1);
            }
            
            // D≈ÆLE≈ΩIT√â: Ulo≈æ hru po pou≈æit√≠ itemu!
            saveGame(true);
            renderFull();
        }
        
        // Pou≈æit√≠ srdce behemota - +50 max HP permanentnƒõ
        function useMutantHeart() {
            const heart = state.inv.find(i => i.id === 'mutant_heart');
            if (!heart) return;
            
            // Oznaƒç jako pou≈æit√©
            if (!state.secrets) state.secrets = [];
            state.secrets.push('used_mutant_heart');
            
            // P≈ôidej +50 max HP
            state.char.maxHp += 50;
            state.char.hp += 50; // Vyl√©ƒç o stejnou hodnotu
            
            // Odeber srdce z invent√°≈ôe
            removeItemFromInventory(heart, 1);
            
            addLog('üíú Absorboval jsi s√≠lu srdce Behemotha! +50 Max HP', '‚ú®');
            
            closeModal();
            showModal('üíú S√çLA ABSORBOV√ÅNA!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; animation: pulse 1s infinite;">üí™</div>
                    <h2 style="color: #9c27b0; margin: 0.5rem 0; text-shadow: 0 0 20px #9c27b0;">+50 Max HP!</h2>
                    <p style="color: #888;">C√≠t√≠≈° jak tv√Ωm tƒõlem proud√≠ ob≈ô√≠ s√≠la.</p>
                    <p style="color: #8bc34a; margin-top: 1rem;">Nov√© max HP: <strong>${state.char.maxHp}</strong></p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">C√≠t√≠m se MOCN√ù!</button>
            `);
            
            saveGame();
            renderFull();
        }
        
        // AI CHIP - vylep≈°en√≠ zbranƒõ nebo zbroje o +10
        function showAIChipUpgradeModal() {
            const chip = state.inv.find(i => i.id === 'ai_chip');
            if (!chip) return;
            
            // Najdi zbranƒõ a zbroje v invent√°≈ôi
            const weapons = state.inv.filter(i => i.type === 'weapon' && i.damage);
            const armors = state.inv.filter(i => (i.type === 'armor' || i.type === 'helmet' || i.type === 'boots' || i.type === 'gloves') && i.defense !== undefined);
            
            // P≈ôidej nasazen√© p≈ôedmƒõty
            if (state.equipped?.weapon && state.equipped.weapon.damage) {
                weapons.unshift({ ...state.equipped.weapon, equipped: true });
            }
            if (state.equipped?.armor && state.equipped.armor.defense !== undefined) {
                armors.unshift({ ...state.equipped.armor, equipped: true });
            }
            if (state.equipped?.helmet && state.equipped.helmet.defense !== undefined) {
                armors.unshift({ ...state.equipped.helmet, equipped: true });
            }
            if (state.equipped?.boots && state.equipped.boots.defense !== undefined) {
                armors.unshift({ ...state.equipped.boots, equipped: true });
            }
            if (state.equipped?.gloves && state.equipped.gloves.defense !== undefined) {
                armors.unshift({ ...state.equipped.gloves, equipped: true });
            }
            
            let weaponsHtml = weapons.length > 0 ? weapons.map((w, i) => `
                <div onclick="upgradeItemWithAI('weapon', ${i})" style="cursor: pointer; background: #1a2a1a; padding: 0.6rem; margin: 0.3rem 0; border-radius: 6px; border: 1px solid #4caf50; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 1.3rem;">${w.icon || '‚öîÔ∏è'}</span>
                        <span style="color: #fff;">${w.name}</span>
                        ${w.equipped ? '<span style="color: #ffd700; font-size: 0.7rem;"> (nasazeno)</span>' : ''}
                    </div>
                    <div style="color: #ff6b6b;">
                        ${w.damage} ‚Üí <span style="color: #4caf50; font-weight: bold;">${w.damage + 10}</span> DMG
                    </div>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">≈Ω√°dn√© zbranƒõ</p>';
            
            let armorsHtml = armors.length > 0 ? armors.map((a, i) => `
                <div onclick="upgradeItemWithAI('armor', ${i})" style="cursor: pointer; background: #1a1a2a; padding: 0.6rem; margin: 0.3rem 0; border-radius: 6px; border: 1px solid #2196f3; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 1.3rem;">${a.icon || 'üõ°Ô∏è'}</span>
                        <span style="color: #fff;">${a.name}</span>
                        ${a.equipped ? '<span style="color: #ffd700; font-size: 0.7rem;"> (nasazeno)</span>' : ''}
                    </div>
                    <div style="color: #64b5f6;">
                        ${a.defense} ‚Üí <span style="color: #4caf50; font-weight: bold;">${a.defense + 10}</span> DEF
                    </div>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">≈Ω√°dn√© zbroje</p>';
            
            // Ulo≈æ seznamy pro pou≈æit√≠ v upgradeItemWithAI
            window._aiUpgradeWeapons = weapons;
            window._aiUpgradeArmors = armors;
            
            showModal('üß† AI Procesorov√© j√°dro', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üß†</div>
                    <p style="color: #9c27b0;">Vyber p≈ôedmƒõt k vylep≈°en√≠ (+10)</p>
                </div>
                
                <h4 style="color: #ff6b6b; margin: 0.5rem 0;">‚öîÔ∏è Zbranƒõ (+10 DMG)</h4>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${weaponsHtml}
                </div>
                
                <h4 style="color: #64b5f6; margin: 0.8rem 0 0.5rem 0;">üõ°Ô∏è Zbroje (+10 DEF)</h4>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${armorsHtml}
                </div>
                
                <p style="color: #888; font-size: 0.8rem; margin-top: 1rem; text-align: center;">
                    üí° AI chip bude spot≈ôebov√°n
                </p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚ùå Zru≈°it</button>
            `);
        }
        
        function upgradeItemWithAI(type, index) {
            const chip = state.inv.find(i => i.id === 'ai_chip');
            if (!chip) return;
            
            let item, isEquipped = false;
            
            if (type === 'weapon') {
                item = window._aiUpgradeWeapons[index];
                if (item.equipped) {
                    isEquipped = true;
                    state.equipped.weapon.damage += 10;
                    item = state.equipped.weapon;
                } else {
                    const invItem = state.inv.find(i => i.id === item.id && i.damage === item.damage);
                    if (invItem) {
                        invItem.damage += 10;
                        item = invItem;
                    }
                }
            } else {
                item = window._aiUpgradeArmors[index];
                if (item.equipped) {
                    isEquipped = true;
                    // Najdi ve kter√©m slotu je
                    if (state.equipped.armor?.id === item.id && state.equipped.armor?.defense === item.defense) {
                        state.equipped.armor.defense += 10;
                        item = state.equipped.armor;
                    } else if (state.equipped.helmet?.id === item.id && state.equipped.helmet?.defense === item.defense) {
                        state.equipped.helmet.defense += 10;
                        item = state.equipped.helmet;
                    } else if (state.equipped.boots?.id === item.id && state.equipped.boots?.defense === item.defense) {
                        state.equipped.boots.defense += 10;
                        item = state.equipped.boots;
                    } else if (state.equipped.gloves?.id === item.id && state.equipped.gloves?.defense === item.defense) {
                        state.equipped.gloves.defense += 10;
                        item = state.equipped.gloves;
                    }
                } else {
                    const invItem = state.inv.find(i => i.id === item.id && i.defense === item.defense);
                    if (invItem) {
                        invItem.defense += 10;
                        item = invItem;
                    }
                }
            }
            
            // Odeber AI chip
            removeItemFromInventory(chip, 1);
            
            const statName = type === 'weapon' ? 'DMG' : 'DEF';
            const statValue = type === 'weapon' ? item.damage : item.defense;
            
            addLog(`üß† Vylep≈°eno: ${item.name} (+10 ${statName})`, '‚ú®');
            
            closeModal();
            showModal('üß† VYLEP≈†ENO!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${item.icon || (type === 'weapon' ? '‚öîÔ∏è' : 'üõ°Ô∏è')}</div>
                    <h3 style="color: #9c27b0; margin: 0.5rem 0;">${item.name}</h3>
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4caf50;">
                        <p style="color: #4caf50; font-size: 1.3rem; margin: 0;">
                            ${type === 'weapon' ? '‚öîÔ∏è' : 'üõ°Ô∏è'} <strong>+10 ${statName}</strong>
                        </p>
                        <p style="color: #888; margin: 0.5rem 0 0 0;">Nov√° hodnota: <span style="color: #ffd700; font-weight: bold;">${statValue}</span></p>
                    </div>
                    <p style="color: #888; font-size: 0.85rem;">AI procesor byl integrov√°n do p≈ôedmƒõtu.</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #9c27b0, #673ab7);">üß† V√Ωbornƒõ!</button>
            `);
            
            saveGame();
            renderFull();
        }
        
        // Pomocn√° funkce pro opravu s opravnou sadou
        function repairWithKit(kitId, damagedIndex) {
            const kit = state.inv.find(i => i.id === kitId);
            if (!kit || !window._damagedItems) return;
            
            const damagedItem = window._damagedItems[damagedIndex];
            if (!damagedItem) return;
            
            // Oprav
            damagedItem.durability = Math.min(damagedItem.maxDurability, damagedItem.durability + kit.value);
            
            // Spot≈ôebuj kit
            kit.count--;
            if (kit.count <= 0) {
                state.inv = state.inv.filter(i => i.id !== kitId);
            }
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('üîß Opraveno!', `${damagedItem.icon} ${damagedItem.name}<br><span style="color: #8bc34a;">Durability: ${damagedItem.durability}/${damagedItem.maxDurability}</span>`);
            
            delete window._damagedItems;
            saveGame(true);
            renderFull();
        }
        
        function repairItem(itemId) {
            const item = state.inv.find(i => i.id === itemId);
            if (!item || item.durability === undefined) return;
            
            if (item.durability >= item.maxDurability) {
                showModal('Oprava', `${item.icon} ${item.name} je v perfektn√≠m stavu!`);
                return;
            }
            
            // Calculate repair cost (based on missing durability and item rarity)
            const missingDur = item.maxDurability - item.durability;
            const rarityMultiplier = {
                'common': 1,
                'uncommon': 1.5,
                'rare': 2,
                'epic': 3,
                'legendary': 5
            }[item.rarity] || 1;
            
            let baseCost = Math.ceil(missingDur * 0.2 * rarityMultiplier); // Sn√≠≈æeno z 0.5 na 0.2
            
            // Repair skill reduces cost
            const repairLevel = state.skills['repair'] || 0;
            if (repairLevel > 0) {
                const skill = SKILLS.find(s => s.id === 'repair');
                const discount = skill.value * repairLevel; // 50% per level
                baseCost = Math.ceil(baseCost * (1 - discount));
            }
            
            const metalCost = Math.max(1, Math.ceil(baseCost * 0.6));
            const stoneCost = Math.max(1, Math.ceil(baseCost * 0.4));
            
            // Check if player has resources
            if (state.resources.metal < metalCost || state.resources.stone < stoneCost) {
                showModal('Oprava', 
                    `<p>${currentLang === "en" ? "Not enough resources for repair!" : "Nem√°≈° dost surovin na opravu!"}</p>` +
                    `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                    `<p>‚öôÔ∏è ${currentLang === "en" ? `Need: ${metalCost} metal (have ${state.resources.metal})` : `Pot≈ôebuje≈°: ${metalCost} kovu (m√°≈° ${state.resources.metal})`}</p>` +
                    `<p>üóø ${currentLang === "en" ? `Need: ${stoneCost} stone (have ${state.resources.stone})` : `Pot≈ôebuje≈°: ${stoneCost} kamene (m√°≈° ${state.resources.stone})`}</p>` +
                    `</div>`
                );
                return;
            }
            
            // Perform repair
            state.resources.metal -= metalCost;
            state.resources.stone -= stoneCost;
            item.durability = item.maxDurability;
            
            SoundSystem.play('pickup');
            showModal('‚úÖ Opraveno!', 
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${item.icon}</div>` +
                `<h3>${item.name}</h3>` +
                `<p style="color: #8bc34a; margin: 1rem 0;">üîß Opraveno na ${item.maxDurability}/${item.maxDurability}!</p>` +
                `<p style="color: #999; font-size: 0.85rem;">Spot≈ôebov√°no: ${metalCost} kovu, ${stoneCost} kamene</p>` +
                `</div>`
            );
            addLog(`Opravil jsi ${item.name}`, 'üîß');
            renderFull();
        }
        
        function applyWeaponCoatingByIndex(idx) {
            const coating = state.inv[idx];
            if (!coating) return;
            applyWeaponCoating(coating.id);
        }
        
        function applyWeaponCoating(coatingId) {
            const coating = state.inv.find(i => i.id === coatingId);
            if (!coating || coating.type !== 'weapon_coating') return;
            
            const weapon = state.equipped?.weapon;
            if (!weapon) {
                showModal('‚ùå ≈Ω√°dn√° zbra≈à', '<p>Nem√°≈° nasazenou ≈æ√°dnou zbra≈à na kterou bys mohl aplikovat povlak!</p>');
                return;
            }
            
            // Check if weapon already has coating
            if (state.weaponCoating && state.weaponCoating.uses > 0) {
                showModal('‚ö†Ô∏è Ji≈æ pokryt√° zbra≈à', 
                    `<p>Tvoje zbra≈à u≈æ m√° povlak (${state.weaponCoating.effect}, zb√Ωv√° ${state.weaponCoating.uses} pou≈æit√≠).</p>` +
                    `<p style="color: #ff9800;">Chce≈° ho nahradit?</p>` +
                    `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">` +
                    `<button class="btn" onclick="closeModal()" style="background: #555;">Ne</button>` +
                    `<button class="btn" onclick="confirmApplyCoating('${coatingId}')" style="background: var(--toxic-dark);">Ano, nahradit</button>` +
                    `</div>`
                );
                return;
            }
            
            confirmApplyCoating(coatingId);
        }
        
        function confirmApplyCoating(coatingId) {
            const coating = state.inv.find(i => i.id === coatingId);
            if (!coating) return;
            
            const weapon = state.equipped?.weapon;
            
            // Apply coating
            state.weaponCoating = {
                effect: coating.effect,
                uses: coating.uses || 5
            };
            
            // Remove coating item
            if (coating.count > 1) {
                coating.count--;
            } else {
                state.inv = state.inv.filter(i => i.id !== coatingId);
            }
            
            const effectName = coating.effect === 'poison' ? '‚ò†Ô∏è Jedov√Ω' : 'üî• Z√°paln√Ω';
            
            closeModal();
            showModal('‚úÖ Povlak aplikov√°n!', 
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${weapon.icon}</div>` +
                `<h3>${weapon.name}</h3>` +
                `<p style="color: #8bc34a; margin: 1rem 0;">${effectName} povlak aplikov√°n!</p>` +
                `<p style="color: #888;">Vydr≈æ√≠ ${state.weaponCoating.uses} boj≈Ø.</p>` +
                `</div>`
            );
            addLog(`Aplikoval jsi ${coating.name} na ${weapon.name}`, coating.icon);
            renderFull();
        }
        
        function buildBuilding(id) {
            // Redirect to unified building function
            buildUnifiedBuilding(id);
        }
        
        // Store item in base
        function storeInBase(itemIdx) {
            const item = state.inv[itemIdx];
            if (!item || item.type === 'money') return; // Can't store money
            
            // Kontrola jestli je hr√°ƒç v osadƒõ
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('üìç Mus√≠≈° b√Ωt v osadƒõ', 'Pro ukl√°d√°n√≠ vƒõc√≠ se vra≈• do osady!');
                return;
            }
            
            // Kontrola jestli m√° postavenou budovu Sklad (kromƒõ j√≠dla a vody)
            const hasStorage = state.base?.includes('storage') || state.settlement?.buildings?.includes('storage');
            const isFoodOrWater = item.id === 'food' || item.id === 'water' || item.id === 'canned_food' || item.id === 'clean_water';
            
            if (!hasStorage && !isFoodOrWater) {
                showModal('üèóÔ∏è Pot≈ôebuje≈° Sklad!', `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <p style="color: #ff9800; margin-bottom: 1rem;">Pro ukl√°d√°n√≠ p≈ôedmƒõt≈Ø mus√≠≈° postavit budovu <strong>Sklad</strong>!</p>
                        <p style="color: #888; font-size: 0.85rem;">Bez skladu m≈Ø≈æe≈° ukl√°dat pouze j√≠dlo a vodu.</p>
                        <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">Cena: 15 d≈ôeva, 10 kamene</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">OK</button>
                `);
                return;
            }
            
            if (state.baseItems.length >= state.baseCapacity) {
                showModal('Pln√Ω √∫kryt!', 'Nem√°≈° m√≠sto v √∫krytu! Postav Sklad pro v√≠ce m√≠sta.');
                return;
            }
            
            // Remove from inventory and add to base
            if (item.count && item.count > 1) {
                // Stackovan√Ω item - p≈ôesunout 1 kus
                item.count--;
                
                // Zkus naj√≠t existuj√≠c√≠ stack v baseItems
                const existingInBase = state.baseItems.find(i => i.id === item.id && i.type === item.type);
                if (existingInBase) {
                    existingInBase.count = (existingInBase.count || 1) + 1;
                } else {
                    state.baseItems.push({...item, count: 1});
                }
            } else {
                // Jedin√Ω kus - zkus stackovat nebo p≈ôidej nov√Ω
                const existingInBase = state.baseItems.find(i => i.id === item.id && i.type === item.type);
                if (existingInBase && (item.type === 'consumable' || item.type === 'ammo' || item.type === 'throwable')) {
                    existingInBase.count = (existingInBase.count || 1) + (item.count || 1);
                    state.inv.splice(itemIdx, 1);
                } else {
                    state.baseItems.push(item);
                    state.inv.splice(itemIdx, 1);
                }
            }
            
            addLog(`Ulo≈æil jsi ${item.icon} ${item.name} do √∫krytu`, 'üì¶');
            updateCarryWeight();
            renderFull();
        }
        
        // Take item from base
        function takeFromBase(itemIdx) {
            // Kontrola jestli je hr√°ƒç v osadƒõ
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('üìç Mus√≠≈° b√Ωt v osadƒõ', 'Pro vyb√≠r√°n√≠ vƒõc√≠ se vra≈• do osady!');
                return;
            }
            
            const item = state.baseItems[itemIdx];
            if (!item) return;
            
            // Check weight
            if (!canAddItem(item, 1)) {
                SoundSystem.play('error');
                showModal('P≈ô√≠li≈° tƒõ≈æk√©!', ('Nem√°≈° m√≠sto v invent√°≈ôi!'));
                return;
            }
            
            // Add to inventory
            if (item.type === 'consumable') {
                const existing = state.inv.find(i => i.id === item.id);
                if (existing) {
                    existing.count = (existing.count || 1) + (item.count || 1);
                } else {
                    state.inv.push({...item});
                }
            } else {
                state.inv.push({...item});
            }
            
            // Remove from base
            state.baseItems.splice(itemIdx, 1);
            
            addLog(`Vzal jsi ${item.icon} ${item.name} z √∫krytu`, 'üì§');
            updateCarryWeight();
            renderFull();
            showStorageModal();
        }
        

// Fullscreen hex mapa odstranƒõna - pou≈æij WORLD_LOCATIONS syst√©m
function openFullscreenMap() {
    // P≈ôesmƒõruj na nov√Ω world map syst√©m
    showModal('üó∫Ô∏è Mapa', '<p>Pou≈æij z√°lo≈æku Mapa pro zobrazen√≠ svƒõta.</p><button class=\"btn\" onclick=\"closeModal(); switchTab(\'map\')" style=\"width: 100%; margin-top: 1rem;\">üó∫Ô∏è Otev≈ô√≠t mapu</button>');
}

        function toggleBase() {
            // V nov√©m syst√©mu: toggle mezi "uvnit≈ô √∫krytu" a "venku u √∫krytu"
            // M≈Ø≈æe≈° to udƒõlat jen kdy≈æ jsi v shelter lokaci
            
            if (isPlayerTraveling()) {
                showModal('Nelze', 'Nem≈Ø≈æe≈° vstoupit/opustit √∫kryt bƒõhem cestov√°n√≠!');
                return;
            }
            
            // V nov√©m WORLD syst√©mu: hr√°ƒç mus√≠ b√Ωt v 'shelter' lokaci
            if (state.world.currentLocation !== 'shelter') {
                showModal('P≈ô√≠li≈° daleko', 'Mus√≠≈° b√Ωt ve sv√©m √∫krytu abys mohl vstoupit dovnit≈ô!');
                return;
            }
            
            // Toggle stavu (uvnit≈ô/venku u shelter)
            state.map.inBase = !state.map.inBase;
            renderFull();
        }
        
        function collectStorage() {
            let collected = [];
            
            // Collect food
            if (state.baseStorage.food > 0) {
                const foodItem = ITEMS.find(i => i.id === 'food');
                const existing = state.inv.find(i => i.id === 'food');
                if (existing) {
                    existing.count = (existing.count || 1) + state.baseStorage.food;
                } else {
                    state.inv.push({...foodItem, count: state.baseStorage.food});
                }
                collected.push(`ü•´ ${state.baseStorage.food}x J√≠dlo`);
                state.baseStorage.food = 0;
            }
            
            // Collect water
            if (state.baseStorage.water > 0) {
                const waterItem = ITEMS.find(i => i.id === 'water');
                const existing = state.inv.find(i => i.id === 'water');
                if (existing) {
                    existing.count = (existing.count || 1) + state.baseStorage.water;
                } else {
                    state.inv.push({...waterItem, count: state.baseStorage.water});
                }
                collected.push(`üíß ${state.baseStorage.water}x Voda`);
                state.baseStorage.water = 0;
            }
            
            if (collected.length > 0) {
                showModal('Sebr√°no!', collected.join('<br>'));
            } else {
                showModal('Pr√°zdn√©', 'Ve skladu nic nen√≠.');
            }
            
            renderFull();
        }
        
        // === CRAFTING ===
        // Helper pro renderov√°n√≠ crafting recept≈Ø
        function renderCraftingRecipes() {
            const hasWorkshop = state.base.includes('workshop');
            const isTraveling = state.map.traveling;
            const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
            
            // Filtruj recepty - legend√°rn√≠ jen pokud m√° skill
            const filteredRecipes = CRAFTING.filter(r => {
                // Filtr podle kategorie
                if (state.craftFilter && state.craftFilter !== 'all' && r.category !== state.craftFilter) return false;
                // Legend√°rn√≠ recepty jen se skillem
                if (r.legendaryRequired && !hasLegendarySmith) return false;
                return true;
            });
            
            const portableRecipes = filteredRecipes.filter(r => r.portable === true);
            const workshopRecipes = filteredRecipes.filter(r => r.portable !== true);
            
            const resourceIcons = {
                wood: 'üå≤', metal: '‚öôÔ∏è', stone: 'üóø', cloth: 'üßµ', leather: 'ü¶¥',
                herbs: 'üåø', chemicals: 'üß™', glass: 'üîÆ', electronics: 'üíæ', fuel: '‚õΩ',
                rope: '‚û∞', raw_meat: 'ü•©', fish: 'üêü', gunpowder: 'üí•', copper: 'üü§',
                scrap: 'üî©', mutant_blood: 'ü©∏', acid: 'üü¢', crystal: 'üí†', silver: '‚¨ú', gold: 'üü°', gems: 'üíé',
                deathclaw_hand: 'ü¶ñ'
            };
            
            const catColors = {
                weapon: '#c62828', armor: '#1976d2', medical: '#d32f2f', 
                food: '#ff9800', tool: '#388e3c', ammo: '#7b1fa2', special: '#ffd700',
                legendary: '#ff6600'
            };
            
            const renderRecipe = (recipe, canCraftAny) => {
                const engineerReduction = hasClassPassive('craftCostReduction') ? 0.5 : 1.0;
                const adjustedRequires = {};
                Object.entries(recipe.requires).forEach(([res, amt]) => {
                    adjustedRequires[res] = Math.ceil(amt * engineerReduction);
                });
                
                const needsWorkshop = recipe.portable !== true;
                // Portable = pouze invent√°≈ô, D√≠lna = invent√°≈ô + sklad osady
                const useSettlement = needsWorkshop;
                const canCraft = canCraftAny && (!needsWorkshop || hasWorkshop) && Object.entries(adjustedRequires).every(([res, amt]) => getTotalResource(res, useSettlement) >= amt);
                const isLocked = needsWorkshop && !hasWorkshop;
                
                // Rarity
                const rarity = recipe.result.rarity;
                const rarityColor = RARITY_COLORS[rarity] || '#9e9e9e';
                const rarityName = getRarityName(rarity) || '';
                
                // Translated name
                const recipeName = getCraftingName(recipe.id);
                
                let resultDesc = '';
                if (recipe.result.type === 'weapon') {
                    resultDesc = '‚öîÔ∏è ' + recipe.result.damage + ' DMG';
                } else if (recipe.result.type === 'armor') {
                    resultDesc = 'üõ°Ô∏è ' + recipe.result.defense + ' DEF';
                } else if (recipe.result.type === 'consumable') {
                    if (recipe.result.effect === 'health') resultDesc = '‚ù§Ô∏è +' + recipe.result.value + ' HP';
                    else if (recipe.result.effect === 'thirst') resultDesc = 'üíß +' + recipe.result.value + '%';
                    else if (recipe.result.effect === 'hunger') resultDesc = 'üçñ +' + recipe.result.value + '%';
                    else if (recipe.result.effect === 'energy') resultDesc = '‚ö° +' + recipe.result.value + '%';
                    else if (recipe.result.effect === 'radiation') resultDesc = '‚ò¢Ô∏è ' + recipe.result.value;
                    else if (recipe.result.effect === 'repair') resultDesc = 'üîß +' + recipe.result.value + ' v√Ωdr≈æ';
                    
                    // P≈ôidej secondary efekty
                    if (recipe.result.secondary) {
                        const sec = recipe.result.secondary;
                        if (sec.hp) resultDesc += ' ‚ù§Ô∏è+' + sec.hp;
                        if (sec.thirst) resultDesc += ' üíß+' + sec.thirst;
                        if (sec.hunger) resultDesc += ' üçñ+' + sec.hunger;
                        if (sec.energy) resultDesc += ' ‚ö°+' + sec.energy;
                    }
                } else if (recipe.result.type === 'tool') {
                    resultDesc = recipe.result.desc || 'üîß ' + recipe.result.bonus;
                } else if (recipe.result.type === 'throwable') {
                    resultDesc = recipe.result.damage ? 'üí• ' + recipe.result.damage + ' DMG' : 'üí® ' + recipe.result.effect;
                } else if (recipe.result.type === 'ammo') {
                    resultDesc = 'üèπ ' + recipe.result.count + 'x';
                } else if (recipe.result.type === 'weapon_coating') {
                    resultDesc = (recipe.result.effect === 'poison' ? '‚ò†Ô∏è' : 'üî•') + ' ' + recipe.result.uses + 'x ' + ('pou≈æit√≠');
                } else if (recipe.result.type === 'accessory') {
                    resultDesc = recipe.result.desc || ('üíç Doplnƒõk');
                } else if (recipe.result.type === 'defense') {
                    resultDesc = 'üõ°Ô∏è +' + recipe.result.value + ' obrana';
                }
                
                const reqHtml = Object.entries(adjustedRequires).map(([res, amt]) => {
                    const icon = resourceIcons[res] || 'üì¶';
                    const has = getTotalResource(res, useSettlement);
                    const color = has >= amt ? '#8bc34a' : '#c62828';
                    return '<span style="color: ' + color + ';">' + icon + amt + '</span>';
                }).join(' ');
                
                return '<div class="card" onclick="showCraftDetail(\'' + recipe.id + '\')" style="cursor: pointer; ' + (!canCraft ? 'opacity: 0.6;' : '') + ' border-left: 3px solid ' + (rarity ? rarityColor : (catColors[recipe.category] || '#d4722e')) + '; min-width: 130px;">' +
                    (isLocked ? '<div style="position: absolute; top: 5px; right: 5px; font-size: 1rem;">üîí</div>' : '') +
                    '<div style="font-size: 2rem; text-align: center;">' + recipe.icon + '</div>' +
                    '<h3 style="text-align: center; margin: 0.2rem 0; font-size: 0.85rem; color: ' + rarityColor + ';">' + recipeName + '</h3>' +
                    (rarityName ? '<p style="text-align: center; font-size: 0.6rem; color: ' + rarityColor + '; margin: 0; text-transform: uppercase;">' + rarityName + '</p>' : '') +
                    '<p style="text-align: center; color: #8bc34a; font-size: 0.75rem; margin: 0.2rem 0;">' + resultDesc + '</p>' +
                    '<p style="text-align: center; font-size: 0.7rem; margin-top: 0.3rem; color: #999;">' + reqHtml + '</p>' +
                '</div>';
            };
            
            let html = '';
            
            // P≈òENOSN√â
            html += '<div style="margin-bottom: 1.5rem;">';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid #4CAF50;">';
            html += '<span style="font-size: 1.3rem;">üéí</span>';
            html += '<h3 style="margin: 0; color: #8bc34a;">' + ('NA CESTƒö') + '</h3>';
            html += '<span style="font-size: 0.75rem; color: #666; margin-left: auto;">' + (isTraveling ? ('üö∂ Cestuje≈°...') : ('‚úÖ Lze vyr√°bƒõt')) + '</span>';
            html += '</div>';
            
            if (portableRecipes.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.6rem;">';
                portableRecipes.forEach(r => { html += renderRecipe(r, !isTraveling); });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center; padding: 1rem;">≈Ω√°dn√© p≈ôenosn√© recepty v t√©to kategorii</p>';
            }
            html += '</div>';
            
            // D√çLNA
            html += '<div>';
            html += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 2px solid ' + (hasWorkshop ? '#2196f3' : '#c62828') + ';">';
            html += '<span style="font-size: 1.3rem;">üîß</span>';
            html += '<h3 style="margin: 0; color: ' + (hasWorkshop ? '#64b5f6' : '#ef5350') + ';">' + ('D√çLNA') + '</h3>';
            html += '<span style="font-size: 0.75rem; color: #666; margin-left: auto;">' + (hasWorkshop ? (isTraveling ? ('üö∂ Vra≈• se do √∫krytu') : ('‚úÖ D√≠lna dostupn√°')) : ('üîí Postav d√≠lnu v √∫krytu')) + '</span>';
            html += '</div>';
            
            if (workshopRecipes.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.6rem;">';
                workshopRecipes.forEach(r => { html += renderRecipe(r, hasWorkshop && !isTraveling); });
                html += '</div>';
            } else {
                html += '<p style="color: #666; text-align: center; padding: 1rem;">≈Ω√°dn√© d√≠lensk√© recepty v t√©to kategorii</p>';
            }
            html += '</div>';
            
            return html;
        }
        
        function filterCraft(category) {
            state.craftFilter = category;
            renderFull();
        }
        
        // Zobrazen√≠ detailu craftable itemu
        function showCraftDetail(recipeId) {
            const recipe = CRAFTING.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Engineer class = 50% reduction, Technik companion skill = dal≈°√≠ redukce
            let engineerReduction = hasClassPassive('craftCostReduction') ? 0.5 : 1.0;
            const companionBonuses = getAllCompanionBonuses();
            if (companionBonuses.craftCostReduction > 0) {
                engineerReduction = engineerReduction * (1 - companionBonuses.craftCostReduction);
            }
            
            // Check if can craft - portable vƒõci nepot≈ôebuj√≠ d√≠lnu
            const needsWorkshop = recipe.portable !== true;
            const useSettlement = needsWorkshop; // D√≠lna = invent√°≈ô + sklad
            let canCraft = (!needsWorkshop || state.base.includes('workshop')) && !state.map.traveling;
            const missingRes = [];
            
            for (const [res, amt] of Object.entries(recipe.requires)) {
                const adjustedAmt = Math.ceil(amt * engineerReduction);
                if (getTotalResource(res, useSettlement) < adjustedAmt) {
                    canCraft = false;
                    missingRes.push(res);
                }
            }
            
            // Get detailed info based on type
            let typeInfo = '';
            let usageInfo = '';
            
            if (recipe.result.type === 'weapon') {
                typeInfo = `<p style="color: #c62828; font-size: 1.1rem;">‚öîÔ∏è Zbra≈à - ${recipe.result.damage} DMG</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Vyber v invent√°≈ôi ‚Üí Vybavit</p>
                    <p>üîß <strong>Odolnost:</strong> 100/100 (opot≈ôebov√°v√° se bojem)</p>
                    ${recipe.result.special ? `<p>‚ú® <strong>Speci√°ln√≠:</strong> ${recipe.result.special === 'poison' ? 'Otrava' : recipe.result.special === 'bleed' ? 'Krv√°cen√≠' : recipe.result.special === 'stun' ? 'Omr√°ƒçen√≠' : recipe.result.special === 'fire' ? 'Ohe≈à' : recipe.result.special}</p>` : ''}
                    ${recipe.result.ammoType ? `<p>üî´ <strong>Munice:</strong> ${recipe.result.ammoType}</p>` : ''}
                `;
            } else if (recipe.result.type === 'armor') {
                const specialDescriptions = {
                    'rad_resist': '‚ò¢Ô∏è Odolnost radiaci (-30%)',
                    'rad_immune': '‚ò¢Ô∏è -50% radiace',
                    'powered': '‚ö° +5 obrana, +5 damage',
                    'stealth': 'ü•∑ -50% p≈ôepaden√≠, +15% dodge',
                    'berserker': 'üëπ +30% damage, -3 obrana',
                    'phoenix': 'üî• P≈ôe≈æije≈° smrt s 30% HP (1x za boj)',
                    'titan': 'ü¶æ +5 obrana, imunita na krit',
                    'scout': 'üèÉ +15% dodge',
                    'medic': 'üè• +50% efektivita l√©ƒçen√≠',
                    'mutant': 'üß¨ +50% odolnost radiace/jedy',
                    'exo': 'ü¶ø +50% nosnost, +10% damage',
                    'nano': 'üî¨ +2 HP regenerace/kolo',
                    'intimidate': 'üíÄ +2 damage',
                    'scavenger': 'üéí +25% bonus loot',
                    'camo': 'üåø -30% n√°hodn√© souboje',
                    'nightvision': 'üåô +15% damage v noci',
                    'agile': 'üèÉ +10% dodge',
                    'endurance': '‚ùÑÔ∏è -30% ztr√°ta energie',
                    'block': 'üõ°Ô∏è +15% blok',
                    'block_bonus': 'üõ°Ô∏è +10% blok',
                    'dodge_bonus': 'üí® +10% dodge',
                    'fireproof': 'üî• Imunita na ohe≈à',
                    'insulated': '‚ö° Imunita na elekt≈ôinu'
                };
                const specialText = recipe.result.special ? (specialDescriptions[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #1976d2; font-size: 1.1rem;">üõ°Ô∏è Zbroj - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Vyber v invent√°≈ôi ‚Üí Vybavit</p>
                    <p>üîß <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>‚ú® <strong>Speci√°ln√≠:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'consumable') {
                const effectNames = { health: '‚ù§Ô∏è L√©ƒçen√≠', hunger: 'üçñ Hlad', thirst: 'üíß ≈Ω√≠ze≈à', energy: '‚ö° Energie', radiation: '‚ò¢Ô∏è Radiace', repair: 'üîß Oprava', sleep: 'üí§ Sp√°nek' };
                typeInfo = `<p style="color: #ff9800; font-size: 1.1rem;">${effectNames[recipe.result.effect] || 'üì¶ Spot≈ôebn√≠'} ${recipe.result.value > 0 ? '+' : ''}${recipe.result.value}${recipe.result.effect === 'repair' ? ' durability' : '%'}</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Klikni v invent√°≈ôi ‚Üí Spot≈ôebuje se</p>
                    ${recipe.result.secondary ? `<p>‚ûï <strong>Bonus:</strong> ${Object.entries(recipe.result.secondary).map(([key, val]) => {
                        const names = { hp: '‚ù§Ô∏è HP', thirst: 'üíß ≈æ√≠ze≈à', energy: '‚ö° energie', radiation: '‚ò¢Ô∏è radiace' };
                        return `+${val} ${names[key] || key}`;
                    }).join(', ')}</p>` : ''}
                `;
            } else if (recipe.result.type === 'gloves') {
                const glovesSpecials = {
                    'block_bonus': 'üõ°Ô∏è +10% ≈°ance na blok',
                    'unarmed_bonus': 'üëä +5 damage beze zbranƒõ',
                    'grip': 'üéØ +10% p≈ôesnost st≈ôelby',
                    'bleed_punch': 'ü©∏ √ötok pƒõst√≠ zp≈Øsob√≠ krv√°cen√≠',
                    'power_punch': 'üí™ +10 damage v boji zbl√≠zka',
                    'medic_bonus': 'üè• +20% efektivita l√©ƒçen√≠',
                    'rad_resist': '‚ò¢Ô∏è -20% radiace'
                };
                const specialText = recipe.result.special ? (glovesSpecials[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #ff9800; font-size: 1.1rem;">ü•ä Rukavice - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Vyber v invent√°≈ôi ‚Üí Vybavit do slotu Ruce</p>
                    <p>üîß <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>‚ú® <strong>Speci√°ln√≠:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'boots') {
                const bootsSpecials = {
                    'dodge_bonus': 'üí® +10% ≈°ance na √∫hyb',
                    'speed_bonus': 'üèÉ +10% rychlost',
                    'stealth_move': 'ü•∑ -20% ≈°ance na p≈ôepaden√≠',
                    'run_bonus': 'üèÉ +15% rychlost √∫tƒõku',
                    'stomp': 'ü¶∂ Siln√Ω kop (+8 damage)',
                    'jump': 'ü¶ò +25% dodge',
                    'warm_feet': '‚ùÑÔ∏è -15% ztr√°ta energie',
                    'power_kick': 'ü¶ø +20% rychlost, +10 defense',
                    'exo': 'ü¶ø +50% nosnost, +10% damage'
                };
                const specialText = recipe.result.special ? (bootsSpecials[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #00bcd4; font-size: 1.1rem;">ü•æ Boty - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Vyber v invent√°≈ôi ‚Üí Vybavit do slotu Boty</p>
                    <p>üîß <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>‚ú® <strong>Speci√°ln√≠:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'helmet') {
                const helmetSpecials = {
                    'crit_immune': 'üõ°Ô∏è Imunita na kritick√© z√°sahy',
                    'rad_resist': '‚ò¢Ô∏è -30% radiace',
                    'night_vision': 'üëÅÔ∏è Noƒçn√≠ vidƒõn√≠',
                    'gas_filter': '‚òÅÔ∏è Imunita na jedy',
                    'headshot_protect': 'üéØ -50% damage na hlavu',
                    'flash_protect': 'üí• Ochrana p≈ôed oslepen√≠m'
                };
                const specialText = recipe.result.special ? (helmetSpecials[recipe.result.special] || recipe.result.special) : '';
                typeInfo = `<p style="color: #795548; font-size: 1.1rem;">‚õëÔ∏è Helma - ${recipe.result.defense} DEF</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Vyber v invent√°≈ôi ‚Üí Vybavit do slotu Helma</p>
                    <p>üîß <strong>Odolnost:</strong> 100/100</p>
                    ${specialText ? `<p>‚ú® <strong>Speci√°ln√≠:</strong> ${specialText}</p>` : ''}
                `;
            } else if (recipe.result.type === 'tool') {
                typeInfo = `<p style="color: #388e3c; font-size: 1.1rem;">üîß N√°stroj</p>`;
                usageInfo = `
                    <p>üìå <strong>Efekt:</strong> ${recipe.result.desc || 'Speci√°ln√≠ bonus'}</p>
                    <p>üí° <strong>Tip:</strong> ${recipe.result.bonus === 'capacity' ? 'Automaticky zv√Ω≈°√≠ nosnost kdy≈æ je v invent√°≈ôi' : recipe.result.bonus === 'fishing' ? 'Pot≈ôebuje≈° pro ryba≈ôen√≠' : recipe.result.bonus === 'light' ? 'Pou≈æij v noci pro lep≈°√≠ viditelnost' : recipe.result.bonus === 'stealth' ? 'Pasivn√≠ bonus - sn√≠≈æ√≠ ≈°anci na p≈ôepaden√≠' : 'Dr≈æ v invent√°≈ôi pro bonus'}</p>
                `;
            } else if (recipe.result.type === 'throwable') {
                typeInfo = `<p style="color: #7b1fa2; font-size: 1.1rem;">üí£ Vrhac√≠ - ${recipe.result.damage || 0} DMG</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> V boji vyber "Hodit" ‚Üí Zas√°hne nep≈ô√°tele</p>
                    ${recipe.result.aoe ? '<p>üí• <strong>Plo≈°n√Ω √∫tok:</strong> Zas√°hne v≈°echny nep≈ô√°tele</p>' : ''}
                    ${recipe.result.effect === 'escape' ? '<p>üèÉ <strong>Speci√°ln√≠:</strong> Umo≈æn√≠ √∫tƒõk z boje</p>' : ''}
                `;
            } else if (recipe.result.type === 'ammo') {
                typeInfo = `<p style="color: #7b1fa2; font-size: 1.1rem;">üî´ Munice - ${recipe.result.count}x</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Automaticky se spot≈ôebuje p≈ôi st≈ôelbƒõ</p>
                    <p>üî´ <strong>Pro zbranƒõ:</strong> ${recipe.result.itemId === 'ammo_arrow' ? 'Luk, Ku≈°e' : recipe.result.itemId === 'ammo_9mm' ? 'Pistole' : recipe.result.itemId === 'ammo_556' ? '√ötoƒçn√° pu≈°ka' : recipe.result.itemId === 'ammo_762' ? 'Sniper, Loveck√° pu≈°ka' : recipe.result.itemId === 'ammo_shell' ? 'Brokovnice' : 'R≈Øzn√©'}</p>
                `;
            } else if (recipe.result.type === 'weapon_coating') {
                typeInfo = `<p style="color: #ffd700; font-size: 1.1rem;">‚ú® Povlak na zbra≈à - ${recipe.result.uses}x</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Klikni v invent√°≈ôi ‚Üí Vyber zbra≈à k pota≈æen√≠</p>
                    <p>‚öîÔ∏è <strong>Efekt:</strong> ${recipe.result.effect === 'poison' ? 'Otr√°v√≠ nep≈ô√≠tele (+DMG over time)' : 'Zap√°l√≠ nep≈ô√≠tele (+DMG over time)'}</p>
                `;
            } else if (recipe.result.type === 'accessory') {
                typeInfo = `<p style="color: #ffd700; font-size: 1.1rem;">üíç Doplnƒõk</p>`;
                usageInfo = `
                    <p>üìå <strong>Pou≈æit√≠:</strong> Klikni v invent√°≈ôi ‚Üí Nasadit</p>
                    <p>‚ú® <strong>Bonus:</strong> ${recipe.result.desc || '+' + recipe.result.value + ' ' + recipe.result.bonus}</p>
                `;
            } else if (recipe.result.type === 'defense') {
                typeInfo = `<p style="color: #8B4513; font-size: 1.1rem;">üè∞ Obrann√° struktura</p>`;
                usageInfo = `
                    <p>üìå <strong>Efekt:</strong> +${recipe.result.value} obrana osady</p>
                    <p>üõ°Ô∏è <strong>Tip:</strong> Chr√°n√≠ p≈ôed n√°jezdy na osadu</p>
                `;
            }
            
            // Resource icons
            const icons = {
                wood: 'üå≤', metal: '‚öôÔ∏è', stone: 'üóø', cloth: 'üßµ', leather: 'ü¶¥', rope: '‚û∞', 
                herbs: 'üåø', chemicals: 'üß™', glass: 'üîÆ', electronics: 'üíæ', fuel: '‚õΩ', 
                gunpowder: 'üí•', copper: 'üü§', silver: '‚¨ú', gold: 'üü°', scrap: 'üî©',
                raw_meat: 'ü•©', fish: 'üêü', mutant_blood: 'ü©∏', acid: 'üü¢', crystal: 'üí†', gems: 'üíé'
            };
            
            showModal(`${recipe.icon} ${recipe.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${recipe.icon}</div>
                    ${typeInfo}
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #888;">üìã Jak pou≈æ√≠t:</h4>
                    <div style="font-size: 0.9rem; color: #aaa;">
                        ${usageInfo}
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid ${canCraft ? '#4CAF50' : '#c62828'};">
                    <h4 style="margin: 0 0 0.5rem 0; color: #888;">üß™ Pot≈ôebn√© suroviny:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${Object.entries(recipe.requires).map(([res, amt]) => {
                            const adjustedAmt = Math.ceil(amt * engineerReduction);
                            const has = state.resources[res] || 0;
                            const enough = has >= adjustedAmt;
                            return `<span style="background: ${enough ? '#1a3a1a' : '#3a1a1a'}; padding: 0.3rem 0.6rem; border-radius: 4px; color: ${enough ? '#8bc34a' : '#ff6b6b'};">
                                ${icons[res] || 'üì¶'} ${has}/${adjustedAmt}
                            </span>`;
                        }).join('')}
                    </div>
                    ${engineerReduction < 1 ? '<p style="color: #ffd700; font-size: 0.8rem; margin-top: 0.5rem;">üîß Engineer: -50% surovin!</p>' : ''}
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    ${canCraft ? `
                        <button class="btn" onclick="craftItem('${recipeId}'); closeModal();" style="background: #4CAF50;">
                            üî® Vyrobit
                        </button>
                    ` : `
                        <button class="btn" style="background: #555; cursor: not-allowed;" disabled>
                            üîí ${state.map.traveling ? 'Cestuje≈°...' : (needsWorkshop && !state.base.includes('workshop')) ? 'Pot≈ôebuje≈° d√≠lnu' : 'Chyb√≠ suroviny'}
                        </button>
                    `}
                    <button class="btn" onclick="closeModal()" style="background: #333;">
                        ‚Üê Zpƒõt
                    </button>
                </div>
            `);
        }
        
        function craftItem(recipeId) {
            const recipe = CRAFTING.find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Blokace bƒõhem sp√°nku
            if (state.isSleeping) {
                notifyWarning('üí§ Sp√≠≈°!', 'Nem≈Ø≈æe≈° vyr√°bƒõt bƒõhem sp√°nku.');
                return;
            }
            
            // Kontrola cestov√°n√≠
            if (state.map.traveling) {
                showModal('Nelze vyr√°bƒõt', 'üö∂ Cestuje≈°! Poƒçkej ne≈æ doraz√≠≈°.');
                return;
            }
            
            // Kontrola unique item≈Ø (spac√°k, kompas, atd.)
            const itemDef = ITEMS.find(i => i.id === recipeId);
            if (itemDef?.unique) {
                const alreadyHas = state.inv.some(i => i.id === recipeId);
                if (alreadyHas) {
                    notifyWarning('U≈æ m√°≈° ' + recipe.name, 'M≈Ø≈æe≈° m√≠t pouze jeden');
                    return;
                }
            }
            
            // Kontrola limitu past√≠ (max 2)
            if (recipeId === 'trap') {
                const trapCount = state.inv?.filter(i => i.bonus === 'food' || i.id === 'trap').length || 0;
                if (trapCount >= 2) {
                    notifyWarning('Maximum past√≠', 'M≈Ø≈æe≈° m√≠t maxim√°lnƒõ 2 pasti');
                    return;
                }
            }
            
            // Kontrola jestli pot≈ôebuje d√≠lnu
            const needsWorkshop = recipe.portable !== true;
            if (needsWorkshop && !state.base.includes('workshop')) {
                showModal('Pot≈ôebuje≈° d√≠lnu', 'üîß Tento p≈ôedmƒõt lze vyrobit pouze v d√≠lnƒõ. Postav si ji v √∫krytu!');
                return;
            }
            
            // Engineer bonus - 50% m√©nƒõ surovin + technik companion bonus
            let engineerReduction = hasClassPassive('craftCostReduction') ? 0.5 : 1.0;
            const companionBonuses = getAllCompanionBonuses();
            if (companionBonuses.craftCostReduction > 0) {
                engineerReduction = engineerReduction * (1 - companionBonuses.craftCostReduction);
            }
            
            // Portable = pouze invent√°≈ô, D√≠lna = invent√°≈ô + sklad osady
            const useSettlement = needsWorkshop;
            
            // Check resources (podle typu receptu)
            for (const [res, amt] of Object.entries(recipe.requires)) {
                const adjustedAmt = Math.ceil(amt * engineerReduction);
                if (getTotalResource(res, useSettlement) < adjustedAmt) {
                    showModal(t('notifications', 'notEnoughResources'), 'Nem√°≈° dostatek materi√°l≈Ø!');
                    return;
                }
            }
            
            // Consume resources
            for (const [res, amt] of Object.entries(recipe.requires)) {
                const adjustedAmt = Math.ceil(amt * engineerReduction);
                let remaining = adjustedAmt;
                
                // Nejprve odeƒçti z invent√°≈ôe hr√°ƒçe
                const playerHas = state.resources[res] || 0;
                const fromPlayer = Math.min(playerHas, remaining);
                state.resources[res] = playerHas - fromPlayer;
                remaining -= fromPlayer;
                
                // Zbytek odeƒçti ze skladu osady (pouze pokud useSettlement)
                if (remaining > 0 && useSettlement && state.settlement?.resources) {
                    const settlementHas = state.settlement.resources[res] || 0;
                    state.settlement.resources[res] = settlementHas - remaining;
                }
            }
            
            // Add crafted item
            if (recipe.result.type === 'resource') {
                // P≈ôid√°n√≠ suroviny p≈ô√≠mo do resources
                const resType = recipe.result.resource;
                const amount = recipe.result.amount || 1;
                state.resources[resType] = (state.resources[resType] || 0) + amount;
                showModal('Vyrobeno!', `${recipe.icon} ${recipe.name}! +${amount} ${resType}`);
                state.stats.itemsCrafted++;
                if (state.dailyQuests.progress) {
                    state.dailyQuests.progress.crafted = (state.dailyQuests.progress.crafted || 0) + 1;
                    checkDailyQuests();
                }
                checkAchievements();
                renderFull();
                return;
            } else if (recipe.result.type === 'consumable') {
                const existing = state.inv.find(i => i.id === recipeId);
                // Najdi v√°hu z ITEMS nebo pou≈æij rozumn√Ω default
                const itemDef = ITEMS.find(i => i.id === recipeId);
                const itemWeight = recipe.result.weight || itemDef?.weight || 0.3;
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    state.inv.push({id: recipeId, name: recipe.name, icon: recipe.icon, ...recipe.result, count: 1, weight: itemWeight});
                }
            } else if (recipe.result.type === 'throwable' || recipe.result.type === 'ammo') {
                // Pro ammo hledej podle itemId (nap≈ô. 'ammo_arrow'), pro ostatn√≠ podle recipeId
                const searchId = recipe.result.itemId || recipeId;
                const existing = state.inv.find(i => i.id === searchId);
                if (existing) {
                    existing.count = (existing.count || 1) + (recipe.result.count || 1);
                } else {
                    // Pou≈æij itemId jako id pro spr√°vn√© stackov√°n√≠ s nalezen√Ωmi p≈ôedmƒõty
                    const itemDef = ITEMS.find(it => it.id === recipe.result.itemId);
                    state.inv.push({
                        id: searchId, 
                        name: itemDef?.name || recipe.name, 
                        icon: itemDef?.icon || recipe.icon, 
                        type: recipe.result.type,
                        ammoType: recipe.result.ammoType || itemDef?.ammoType,
                        count: recipe.result.count || 1, 
                        weight: itemDef?.weight || 0.1
                    });
                }
            } else if (recipe.result.type === 'weapon_coating') {
                // Povlak na zbra≈à - stackable
                const existing = state.inv.find(i => i.id === recipeId);
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    state.inv.push({id: recipeId, name: recipe.name, icon: recipe.icon, ...recipe.result, count: 1, weight: 0.2});
                }
            } else if (recipe.result.type === 'accessory') {
                // Doplnƒõk - nestavkuje se
                state.inv.push({id: recipeId, name: recipe.name, icon: recipe.icon, ...recipe.result, weight: 0.5});
            } else if (recipe.result.type === 'defense') {
                // Obrann√° struktura - p≈ôid√°v√° obranu osadƒõ
                state.settlement.defense = (state.settlement.defense || 0) + (recipe.result.value || 0);
                showModal('Vyrobeno!', `${recipe.icon} ${recipe.name} postaven! +${recipe.result.value} obrana osady.`);
                checkAchievements();
                renderFull();
                return; // Exit early - don't add to inventory
            } else {
                // V√Ωchoz√≠ v√°hy podle typu
                const defaultWeights = {
                    'weapon': 2,
                    'armor': 4,
                    'gloves': 1,
                    'boots': 1.5,
                    'helmet': 1.5,
                    'tool': 1
                };
                const craftedItem = {
                    id: recipeId, 
                    name: recipe.name, 
                    icon: recipe.icon, 
                    ...recipe.result, 
                    weight: recipe.result.weight || defaultWeights[recipe.result.type] || 1,
                    crafted: true // Oznaƒçen√≠ ≈æe byl vycraftƒõn - nelze prodat obchodn√≠k≈Øm
                };
                
                // üî¨ Scientists frakce - craftBonus (+5% stats)
                const factionBonuses = getFactionBonuses();
                if (factionBonuses.craftBonus > 0) {
                    if (craftedItem.damage) {
                        const bonus = Math.ceil(craftedItem.damage * factionBonuses.craftBonus);
                        craftedItem.damage += bonus;
                        craftedItem.name += ' ‚öóÔ∏è'; // Oznaƒçen√≠ vylep≈°en√© vƒõci
                    }
                    if (craftedItem.defense) {
                        const bonus = Math.ceil(craftedItem.defense * factionBonuses.craftBonus);
                        craftedItem.defense += bonus;
                        if (!craftedItem.name.includes('‚öóÔ∏è')) craftedItem.name += ' ‚öóÔ∏è';
                    }
                }
                
                // Add durability to weapons, armor, gloves, boots
                if (['weapon', 'armor', 'gloves', 'boots', 'helmet'].includes(recipe.result.type)) {
                    craftedItem.durability = 100;
                    craftedItem.maxDurability = 100;
                }
                state.inv.push(craftedItem);
            }
            
            state.stats.itemsCrafted++;
            if (state.dailyQuests.progress) {
                state.dailyQuests.progress.crafted = (state.dailyQuests.progress.crafted || 0) + 1;
                checkDailyQuests();
            }
            
            // Craft success visual effect
            particleBurst(window.innerWidth / 2, window.innerHeight / 2, '#8bc34a', 12);
            
            const engineerText = engineerReduction < 1 ? ' (Engineer: -50% surovin)' : '';
            showModal('Vyrobeno!', `${recipe.icon} ${recipe.name} byl vyroben!${engineerText}`);
            checkAchievements();
            renderFull();
        }
        
        // === COMBAT ===
        function visitHospital() {
            // Pou≈æij ID aktu√°ln√≠ lokace jako kl√≠ƒç
            const key = state.world.currentLocation || 'shelter';
            const now = Date.now();
            const lastVisit = state.buildingCooldowns.hospitals[key] || 0;
            const daysSinceVisit = (now - lastVisit) / (1000 * 60 * 60 * 24);
            
            if (daysSinceVisit >= 3) {
                // Can collect
                const medkit = ITEMS.find(i => i.id === 'medkit');
                if (canAddItem(medkit, 1)) {
                    state.inv.push({...medkit, count: 1});
                    state.buildingCooldowns.hospitals[key] = now;
                    SoundSystem.play('pickup');
                    const doctorQuote = getRandomHumor('doctor');
                    showModal('üè• Nemocnice', 
                        '<p style="color: #888; font-style: italic; margin-bottom: 0.5rem;">"' + doctorQuote + '"</p>' +
                        '<p style="color: #8bc34a; font-weight: bold; margin-bottom: 1rem;">Na≈°el jsi l√©k√°rniƒçku!</p>' +
                        '<p>V opu≈°tƒõn√© nemocnici jsi na≈°el funkƒçn√≠ l√©k√°rniƒçku.</p>' +
                        '<p style="color: #999; font-size: 0.85rem; margin-top: 1rem;">‚è∞ Dal≈°√≠ l√©k√°rniƒçka bude k dispozici za 3 dny</p>'
                    );
                    addLog('Nav≈°t√≠vil jsi nemocnici', 'üè•');
                } else {
                    // Ulo≈æ na zem
                    addToGroundLoot({...medkit});
                    state.buildingCooldowns.hospitals[key] = now;
                    SoundSystem.play('pickup');
                    showModal('üè• Nemocnice', 
                        '<p style="color: #ff9800; font-weight: bold; margin-bottom: 1rem;">üì¶ L√©k√°rniƒçka z≈Østala na zemi!</p>' +
                        '<p>Pln√Ω invent√°≈ô - l√©k√°rniƒçka ƒçek√° na zemi.</p>' +
                        '<p style="color: #999; font-size: 0.85rem; margin-top: 1rem;">Uvolni m√≠sto a seber ji!</p>'
                    );
                }
            } else {
                const hoursLeft = Math.ceil((3 - daysSinceVisit) * 24);
                showModal('üè• Nemocnice', 
                    '<p>U≈æ jsi tu byl ned√°vno.</p>' +
                    `<p style="color: #ff9800;">‚è∞ Dal≈°√≠ l√©k√°rniƒçka za ${hoursLeft} hodin</p>`
                );
            }
            renderFull();
        }
        
        function visitWorkshop() {
            // Pou≈æij ID aktu√°ln√≠ lokace jako kl√≠ƒç
            const key = state.world.currentLocation || 'shelter';
            const now = Date.now();
            const lastVisit = state.buildingCooldowns.workshops[key] || 0;
            const daysSinceVisit = (now - lastVisit) / (1000 * 60 * 60 * 24);
            
            // Najdi po≈°kozen√© vybaven√≠
            const damagedItems = [];
            if (state.equipped?.weapon?.durability < state.equipped?.weapon?.maxDurability) {
                damagedItems.push({ item: state.equipped.weapon, type: 'equipped', slot: 'weapon' });
            }
            if (state.equipped?.armor?.durability < state.equipped?.armor?.maxDurability) {
                damagedItems.push({ item: state.equipped.armor, type: 'equipped', slot: 'armor' });
            }
            state.inv.forEach((item, idx) => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    damagedItems.push({ item, type: 'inventory', index: idx });
                }
            });
            
            let content = '';
            
            // Sb√≠r√°n√≠ surovin
            if (daysSinceVisit >= 3) {
                const woodGain = Math.floor(Math.random() * 5) + 5;
                const metalGain = Math.floor(Math.random() * 4) + 3;
                const stoneGain = Math.floor(Math.random() * 3) + 2;
                
                state.resources.wood += woodGain;
                state.resources.metal += metalGain;
                state.resources.stone += stoneGain;
                state.buildingCooldowns.workshops[key] = now;
                SoundSystem.play('pickup');
                
                content += `
                    <div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                        <p style="color: #8bc34a; font-weight: bold; margin-bottom: 0.5rem;">üì¶ Na≈°el jsi suroviny!</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <span>üå≤ +${woodGain}</span>
                            <span>‚öôÔ∏è +${metalGain}</span>
                            <span>üóø +${stoneGain}</span>
                        </div>
                    </div>
                `;
            } else {
                const hoursLeft = Math.ceil((3 - daysSinceVisit) * 24);
                content += `
                    <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #888;">üì¶ Suroviny: ‚è∞ ${hoursLeft} hodin</p>
                    </div>
                `;
            }
            
            // Oprava vybaven√≠
            content += `
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.8rem 0; color: #ff9800;">üîß Oprava vybaven√≠</h4>
                    <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.8rem;">Cena: 5 ‚öôÔ∏è kov + 10 üí∞ za item</p>
            `;
            
            if (damagedItems.length > 0) {
                content += `<div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                damagedItems.forEach((di, idx) => {
                    const canAfford = (state.resources.metal || 0) >= 5 && (state.money || 0) >= 10;
                    content += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px;">
                            <span>${di.item.icon} ${di.item.name}</span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #ff9800;">${di.item.durability}/${di.item.maxDurability}</span>
                                <button class="btn" onclick="repairAtWorkshop(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; ${canAfford ? 'background: #4CAF50;' : 'background: #555; cursor: not-allowed;'}" ${canAfford ? '' : 'disabled'}>
                                    Opravit
                                </button>
                            </div>
                        </div>
                    `;
                });
                content += `</div>`;
                window._workshopDamagedItems = damagedItems;
            } else {
                content += `<p style="color: #666; text-align: center;">‚úÖ V≈°e je v po≈ô√°dku!</p>`;
            }
            
            content += `</div>`;
            content += `<button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">‚Üê Zav≈ô√≠t</button>`;
            
            showModal('üè≠ Opu≈°tƒõn√° d√≠lna', content);
            addLog('Nav≈°t√≠vil jsi opu≈°tƒõnou d√≠lnu', 'üè≠');
            renderFull();
        }
        
        function repairAtWorkshop(damagedIndex) {
            if (!window._workshopDamagedItems) return;
            const di = window._workshopDamagedItems[damagedIndex];
            if (!di) return;
            
            // Kontrola surovin
            if ((state.resources.metal || 0) < 5 || (state.money || 0) < 10) {
                showModal('‚ùå Nelze opravit', 'Nem√°≈° dostatek surovin!<br>Pot≈ôebuje≈°: 5 ‚öôÔ∏è + 10 üí∞');
                return;
            }
            
            // Odeƒçti suroviny
            state.resources.metal -= 5;
            state.money -= 10;
            
            // Oprav na plno
            di.item.durability = di.item.maxDurability;
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('üîß Opraveno!', `${di.item.icon} ${di.item.name}<br><span style="color: #8bc34a;">Pln√° trvanlivost!</span>`);
            delete window._workshopDamagedItems;
            renderFull();
        }
        
        function visitFactory() {
            // Pou≈æij ID aktu√°ln√≠ lokace jako kl√≠ƒç
            const key = state.world.currentLocation || 'shelter';
            const now = Date.now();
            const lastVisit = state.buildingCooldowns.factories[key] || 0;
            const daysSinceVisit = (now - lastVisit) / (1000 * 60 * 60 * 24);
            
            if (daysSinceVisit >= 7) {
                // Can get weapon - pick random high-tier weapon
                const weaponPool = ITEMS.filter(i => i.type === 'weapon' && (i.rarity === 'uncommon' || i.rarity === 'rare'));
                const weapon = weaponPool[Math.floor(Math.random() * weaponPool.length)];
                const weaponWithDurability = {...weapon, durability: 100, maxDurability: 100};
                
                if (canAddItem(weapon, 1)) {
                    state.inv.push(weaponWithDurability);
                    state.buildingCooldowns.factories[key] = now;
                    SoundSystem.play('rare_item');
                    
                    showModal('üèóÔ∏è Zbrojn√≠ tov√°rna', 
                        '<p style="color: #2196f3; font-weight: bold; margin-bottom: 1rem;">Na≈°el jsi zbra≈à!</p>' +
                        `<div style="font-size: 3rem; text-align: center;">${weapon.icon}</div>` +
                        `<h3 style="text-align: center; color: #2196f3;">${weapon.name}</h3>` +
                        `<p style="text-align: center;">‚öîÔ∏è Damage: ${weapon.damage}</p>` +
                        '<p style="color: #999; font-size: 0.85rem; margin-top: 1rem; text-align: center;">‚è∞ Dal≈°√≠ zbra≈à za 7 dn√≠</p>'
                    );
                    addLog('Nav≈°t√≠vil jsi zbrojn√≠ tov√°rnu', 'üèóÔ∏è');
                } else {
                    // Ulo≈æ na zem
                    addToGroundLoot(weaponWithDurability);
                    state.buildingCooldowns.factories[key] = now;
                    SoundSystem.play('rare_item');
                    
                    showModal('üèóÔ∏è Zbrojn√≠ tov√°rna', 
                        '<p style="color: #ff9800; font-weight: bold; margin-bottom: 1rem;">üì¶ Zbra≈à z≈Østala na zemi!</p>' +
                        `<div style="font-size: 3rem; text-align: center;">${weapon.icon}</div>` +
                        `<h3 style="text-align: center; color: #2196f3;">${weapon.name}</h3>` +
                        '<p style="text-align: center; color: #888;">Pln√Ω invent√°≈ô - uvolni m√≠sto a seber ji!</p>'
                    );
                }
            } else {
                const hoursLeft = Math.ceil((7 - daysSinceVisit) * 24);
                showModal('üèóÔ∏è Zbrojn√≠ tov√°rna', 
                    '<p>U≈æ jsi tu byl ned√°vno.</p>' +
                    `<p style="color: #ff9800;">‚è∞ Dal≈°√≠ zbra≈à za ${hoursLeft} hodin</p>`
                );
            }
            renderFull();
        }
        
        // Settlement functions
        // === INFO MODALY PRO OSADU ===
        function showSettlementPopulationInfo() {
            const settlers = state.settlement.settlers;
            const maxSettlers = 999; // Bez limitu
            
            // Spoƒç√≠tej spot≈ôebu podle typu
            let totalFoodConsumption = 0;
            let totalWaterConsumption = 0;
            
            let settlersList = '';
            if (settlers.length === 0) {
                settlersList = '<p style="color: #666; text-align: center;">Zat√≠m ≈æ√°dn√≠ obyvatel√©</p>';
            } else {
                settlersList = settlers.map(s => {
                    const type = SETTLER_TYPES.find(t => t.id === s.type);
                    const skillData = SETTLER_SKILLS[type?.skill];
                    const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                    const consumption = levelData?.consumption || type?.consumption || { food: 1, water: 1 };
                    totalFoodConsumption += consumption.food || 0;
                    totalWaterConsumption += consumption.water || 0;
                    return `<div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.3rem;">
                        <span>${type?.icon || 'üë§'} ${s.name} (${type?.name || s.type})</span>
                        <span style="color: #888;">-${consumption.food}üçñ -${consumption.water}üíß</span>
                    </div>`;
                }).join('');
            }
            
            // Spoƒç√≠tej √∫dr≈æbu budov
            let totalMaintenance = 0;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance > 0) {
                    totalMaintenance += building.maintenance;
                }
            });
            
            // Sleva od stavitel≈Ø
            const builders = state.settlement?.settlers?.filter(s => s.type === 'builder') || [];
            let maintenanceDiscount = 0;
            builders.forEach(builder => {
                const level = builder.skillLevel || 1;
                maintenanceDiscount += 0.05 * level;
            });
            maintenanceDiscount = Math.min(0.5, maintenanceDiscount);
            const finalMaintenance = Math.floor(totalMaintenance * (1 - maintenanceDiscount));
            
            // Spoƒç√≠tej p≈ô√≠jem z obchodn√≠k≈Ø
            let traderIncome = 0;
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            traders.forEach(trader => {
                const level = trader.skillLevel || 1;
                const incomeByLevel = [10, 20, 35, 55, 80];
                traderIncome += incomeByLevel[level - 1] || 10;
            });
            if (state.settlement?.buildings?.includes('market') && traderIncome > 0) {
                traderIncome = Math.floor(traderIncome * 1.25);
            }
            
            const resTexts = {
                capacity: 'Kapacita z√°vis√≠ na √∫rovni osady',
                totalConsumption: 'Celkov√° spot≈ôeba obyvatel:',
                economy: 'Ekonomika osady:',
                maintenance: '√ödr≈æba budov:',
                traderIncome: 'P≈ô√≠jem z obchodn√≠k≈Ø:',
                netProfit: 'ƒåist√Ω zisk:',
                day: 'den'
            };
            
            showModal('üë• Obyvatel√© osady', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üë•</div>
                    <div style="font-size: 1.5rem; color: #8bc34a;">${settlers.length} obyvatel</div>
                    <p style="color: #888;">Osada √∫rovnƒõ ${state.settlement.level}</p>
                </div>
                
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${settlersList}
                </div>
                
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #4a2d2d; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">üìä ${resTexts.totalConsumption}</h4>
                    <div style="display: flex; justify-content: space-around;">
                        <span>üçñ -${totalFoodConsumption}/${resTexts.day}</span>
                        <span>üíß -${totalWaterConsumption}/${resTexts.day}</span>
                    </div>
                </div>
                
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d2d4a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">üí∞ ${resTexts.economy}</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span>üîß ${resTexts.maintenance}</span>
                        <span style="color: #ff6b6b;">-${finalMaintenance} üí∞/${resTexts.day}${maintenanceDiscount > 0 ? ' <span style="color:#8bc34a;font-size:0.75rem;">(-' + Math.round(maintenanceDiscount * 100) + '%)</span>' : ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span>üíπ ${resTexts.traderIncome}</span>
                        <span style="color: #8bc34a;">+${traderIncome} üí∞/${resTexts.day}</span>
                    </div>
                    <div style="border-top: 1px solid #444; padding-top: 0.3rem; margin-top: 0.3rem; display: flex; justify-content: space-between;">
                        <span><b>${resTexts.netProfit}</b></span>
                        <span style="color: ${traderIncome - finalMaintenance >= 0 ? '#8bc34a' : '#ff6b6b'}; font-weight: bold;">${traderIncome - finalMaintenance >= 0 ? '+' : ''}${traderIncome - finalMaintenance} üí∞/${resTexts.day}</span>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>
            `);
        }
        
        function showSettlementDefenseInfo() {
            const defTexts = {
                noDefense: '≈Ω√°dn√° obrana! Postav zdi nebo najmi str√°≈æce.',
                strength: 'S√≠la obrany proti n√°jezdn√≠k≈Øm',
                tips: 'Tipy:',
                tip1: 'Najmi str√°≈æce (+10-50 obrana)',
                tip2: 'Postav zdi, vƒõ≈æe, kas√°rny',
                tip3: 'Vy≈°≈°√≠ obrana = men≈°√≠ ztr√°ty p≈ôi n√°jezdu',
                barracksBonus: 'Kas√°rny bonus'
            };
            
            let defenseBreakdown = [];
            let totalDefense = 0;
            
            // Od str√°≈æc≈Ø
            state.settlement.settlers.forEach(settler => {
                if (settler.type === 'guard') {
                    const skillData = SETTLER_SKILLS['combat'];
                    const levelData = skillData?.levels[(settler.skillLevel || 1) - 1];
                    const def = levelData?.effect?.defense || 10;
                    defenseBreakdown.push({ name: `üõ°Ô∏è ${settler.name}`, value: def });
                    totalDefense += def;
                }
            });
            
            // Od budov
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.effect?.defense) {
                    const bName = building.name;
                    defenseBreakdown.push({ name: `üèóÔ∏è ${bName}`, value: building.effect.defense });
                    totalDefense += building.effect.defense;
                }
            });
            
            // Bonus z kas√°ren
            if (state.settlement.buildings.includes('barracks')) {
                const guards = state.settlement.settlers.filter(s => s.type === 'guard').length;
                const bonus = guards * 5;
                if (bonus > 0) {
                    defenseBreakdown.push({ name: `üè∞ ${defTexts.barracksBonus}`, value: bonus });
                    totalDefense += bonus;
                }
            }
            
            const breakdownHtml = defenseBreakdown.length > 0 
                ? defenseBreakdown.map(d => `<div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span>${d.name}</span>
                    <span style="color: #8bc34a;">+${d.value}</span>
                </div>`).join('')
                : `<p style="color: #666; text-align: center;">${defTexts.noDefense}</p>`;
            
            showModal('üõ°Ô∏è Obrana osady', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üõ°Ô∏è</div>
                    <div style="font-size: 1.5rem; color: ${totalDefense > 30 ? '#8bc34a' : totalDefense > 10 ? '#ff9800' : '#c62828'};">${totalDefense}</div>
                    <p style="color: #888;">${defTexts.strength}</p>
                </div>
                
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${breakdownHtml}
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 1px solid #2d4a2d;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üí° ${defTexts.tips}</h4>
                    <p style="color: #aaa; font-size: 0.85rem; margin: 0;">
                        ‚Ä¢ ${defTexts.tip1}<br>
                        ‚Ä¢ ${defTexts.tip2}<br>
                        ‚Ä¢ ${defTexts.tip3}
                    </p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>
            `);
        }
        
        function showSettlementFoodInfo() {
            const balance = calculateSettlementBalance();
            const current = state.settlement.resources.food;
            const daysLeft = balance.food < 0 ? Math.floor(current / Math.abs(balance.food)) : '‚àû';
            
            const foodTexts = {
                perDay: '/den', lastsFor: 'vydr≈æ√≠', days: 'dn√≠',
                production: 'Produkce', consumption: 'Spot≈ôeba', none: '≈Ω√°dn√°'
            };
            
            // Produkce
            let production = [];
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                const effect = levelData?.effect || {};
                
                // J√≠dlo p≈ô√≠mo
                let foodProd = effect.food || 0;
                // Farmland bonus
                if (type?.id === 'farmer' && state.settlement.buildings.includes('farmland')) {
                    foodProd += 2;
                }
                // Maso se poƒç√≠t√° jako j√≠dlo
                if (effect.meat) foodProd += effect.meat;
                
                if (foodProd > 0) {
                    production.push({ name: `${type?.icon || 'üë§'} ${s.name}`, value: foodProd });
                }
            });
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.production?.food) {
                    production.push({ name: `üèóÔ∏è ${getBuildingName(building.id)}`, value: building.production.food });
                }
            });
            
            // Spot≈ôeba
            let consumption = [];
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                const cons = levelData?.consumption?.food ?? type?.consumption?.food ?? 1;
                if (cons > 0) {
                    consumption.push({ name: `${type?.icon || 'üë§'} ${s.name}`, value: cons });
                }
            });
            
            const prodTotal = production.reduce((sum, p) => sum + p.value, 0);
            const consTotal = consumption.reduce((sum, c) => sum + c.value, 0);
            
            showModal('üçñ J√≠dlo v osadƒõ', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üçñ</div>
                    <div style="font-size: 1.5rem; color: ${current > 20 ? '#8bc34a' : current > 5 ? '#ff9800' : '#c62828'};">${current}</div>
                    <p style="color: ${balance.food >= 0 ? '#8bc34a' : '#c62828'};">${balance.food >= 0 ? '+' : ''}${balance.food}${foodTexts.perDay} (${foodTexts.lastsFor} ${daysLeft} ${foodTexts.days})</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #1a2a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #2d4a2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #8bc34a; font-size: 0.85rem;">üìà ${foodTexts.production}: +${prodTotal}</h4>
                        ${production.map(p => `<div style="font-size: 0.75rem; color: #aaa;">${p.name}: +${p.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + foodTexts.none + '</div>'}
                    </div>
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a2d2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ff6b6b; font-size: 0.85rem;">üìâ ${foodTexts.consumption}: -${consTotal}</h4>
                        ${consumption.map(c => `<div style="font-size: 0.75rem; color: #aaa;">${c.name}: -${c.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + foodTexts.none + '</div>'}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">‚úì OK</button>
            `);
        }
        
        function showSettlementWaterInfo() {
            const balance = calculateSettlementBalance();
            const current = state.settlement.resources.water;
            const daysLeft = balance.water < 0 ? Math.floor(current / Math.abs(balance.water)) : '‚àû';
            
            const waterTexts = {
                production: 'Produkce', consumption: 'Spot≈ôeba', none: '≈Ω√°dn√°',
                lastsFor: 'vydr≈æ√≠', days: 'dn√≠', day: 'den'
            };
            
            // Produkce
            let production = [];
            
            // Produkce od osadn√≠k≈Ø
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                const water = levelData?.effect?.water || 0;
                if (water > 0) production.push({ name: `${type?.icon || 'üë§'} ${s.name}`, value: water });
            });
            
            // Produkce z budov
            const allBuildings = [...(state.settlement?.buildings || []), ...(state.base || [])];
            console.log('üíß V≈°echny budovy pro v√Ωpoƒçet vody:', allBuildings);
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.production?.water) {
                    console.log('üíß Budova produkuje vodu:', building.id, building.production.water);
                    production.push({ name: `üèóÔ∏è ${getBuildingName(building.id)}`, value: building.production.water });
                }
            });
            
            // Spot≈ôeba
            let consumption = [];
            state.settlement.settlers.forEach(s => {
                const type = SETTLER_TYPES.find(t => t.id === s.type);
                const skillData = SETTLER_SKILLS[type?.skill];
                const levelData = skillData?.levels[(s.skillLevel || 1) - 1];
                // Pou≈æij spot≈ôebu z levelData, jinak z type, jinak default 1
                const cons = levelData?.consumption?.water ?? type?.consumption?.water ?? 1;
                if (cons > 0) {
                    consumption.push({ name: `${type?.icon || 'üë§'} ${s.name}`, value: cons });
                }
            });
            
            const prodTotal = production.reduce((sum, p) => sum + p.value, 0);
            const consTotal = consumption.reduce((sum, c) => sum + c.value, 0);
            
            showModal('üíß Voda v osadƒõ', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üíß</div>
                    <div style="font-size: 1.5rem; color: ${current > 20 ? '#8bc34a' : current > 5 ? '#ff9800' : '#c62828'};">${current}</div>
                    <p style="color: ${balance.water >= 0 ? '#8bc34a' : '#c62828'};">${balance.water >= 0 ? '+' : ''}${balance.water}/${waterTexts.day} (${waterTexts.lastsFor} ${daysLeft} ${waterTexts.days})</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #1a2a2a; padding: 0.5rem; border-radius: 8px; border: 1px solid #2d4a4a;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #64b5f6; font-size: 0.85rem;">üìà ${waterTexts.production}: +${prodTotal}</h4>
                        ${production.map(p => `<div style="font-size: 0.75rem; color: #aaa;">${p.name}: +${p.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + waterTexts.none + '</div>'}
                    </div>
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a2d2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ff6b6b; font-size: 0.85rem;">üìâ ${waterTexts.consumption}: -${consTotal}</h4>
                        ${consumption.map(c => `<div style="font-size: 0.75rem; color: #aaa;">${c.name}: -${c.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + waterTexts.none + '</div>'}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem;">‚úì OK</button>
            `);
        }
        
        function showSettlementPowerInfo() {
            const production = calculatePowerProduction();
            const consumption = calculatePowerConsumption();
            const balance = production - consumption;
            
            const powerTexts = {
                production: 'Produkce', consumption: 'Spot≈ôeba', balance: 'Bilance',
                sources: 'Zdroje', none: '≈Ω√°dn√©', insufficient: 'Nedostatek energie! Nƒõkter√© budovy nefunguj√≠. Postav gener√°tor nebo sol√°rn√≠ panely.'
            };
            
            // Zdroje energie
            let sources = [];
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.production?.power) {
                    sources.push({ name: `${building.icon} ${getBuildingName(building.id)}`, value: building.production.power });
                }
            });
            
            // Spot≈ôebiƒçe
            let consumers = [];
            [...state.settlement.buildings, ...state.base].forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building?.requiresPower) {
                    consumers.push({ name: `${building.icon} ${getBuildingName(building.id)}`, value: building.requiresPower, working: balance >= 0 });
                }
            });
            
            showModal('‚ö° Elekt≈ôina v osadƒõ', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">‚ö°</div>
                    <div style="font-size: 1.5rem; color: ${balance >= 0 ? '#ffd700' : '#c62828'};">${balance >= 0 ? '+' : ''}${balance}</div>
                    <p style="color: #888;">${powerTexts.production} ${production} / ${powerTexts.consumption} ${consumption}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #2a2a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a4a2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ffd700; font-size: 0.85rem;">‚ö° ${powerTexts.sources}: +${production}</h4>
                        ${sources.map(s => `<div style="font-size: 0.75rem; color: #aaa;">${s.name}: +${s.value}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + powerTexts.none + '</div>'}
                    </div>
                    <div style="background: #2a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #4a2d2d;">
                        <h4 style="margin: 0 0 0.3rem 0; color: #ff6b6b; font-size: 0.85rem;">üîå ${powerTexts.consumption}: -${consumption}</h4>
                        ${consumers.map(c => `<div style="font-size: 0.75rem; color: ${c.working ? '#aaa' : '#c62828'};">${c.name}: -${c.value} ${c.working ? '' : '‚ùå'}</div>`).join('') || '<div style="font-size: 0.75rem; color: #666;">' + powerTexts.none + '</div>'}
                    </div>
                </div>
                
                ${balance < 0 ? `
                    <div style="background: #4a1a1a; padding: 0.5rem; border-radius: 8px; border: 1px solid #8B0000;">
                        <p style="color: #ff6b6b; margin: 0; font-size: 0.85rem;">‚ö†Ô∏è ${powerTexts.insufficient}</p>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>
            `);
        }
        
        function calculateSettlementDefense() {
            let defense = state.settlement.defense || 0;
            
            // Guards add defense based on skill level
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Pro str√°≈æce pou≈æij obranu z √∫rovnƒõ dovednosti
                if (type.id === 'guard') {
                    const skillData = SETTLER_SKILLS['combat'];
                    const settlerLevel = settler.skillLevel || 1;
                    const levelData = skillData?.levels[settlerLevel - 1];
                    if (levelData?.effect?.defense) {
                        defense += levelData.effect.defense;
                    }
                } else if (type.defense) {
                    // Pro ostatn√≠ typy s obranou (z√°loha)
                    defense += type.defense;
                }
            });
            
            // Buildings add defense
            state.settlement.buildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.effect && building.effect.defense) {
                    defense += building.effect.defense;
                }
                // Barracks bonus for guards
                if (buildingId === 'barracks') {
                    const guards = state.settlement.settlers.filter(s => s.type === 'guard').length;
                    defense += guards * 5; // sn√≠≈æeno z 10 na 5
                }
            });
            
            // Base buildings defense
            state.base.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.effect && building.effect.defense) {
                    defense += building.effect.defense;
                }
            });
            
            return defense;
        }
        
        // === SYST√âM N√ÅJEZD≈Æ NA OSADU ===
        function checkForRaid() {
            const now = Date.now();
            const hoursSinceLastRaid = (now - (state.settlement.lastRaid || 0)) / (1000 * 60 * 60);
            
            // Minim√°lnƒõ 4 hodiny mezi n√°jezdy
            if (hoursSinceLastRaid < 4) return false;
            
            // ≈†ance na n√°jezd roste s ƒçasem a prosperitou
            const baseChance = 0.02; // 2% z√°kladn√≠ ≈°ance za tick
            const prosperityBonus = (state.settlement.prosperity || 0) * 0.001;
            const timeBonus = Math.min(0.1, hoursSinceLastRaid * 0.005);
            
            const raidChance = baseChance + prosperityBonus + timeBonus;
            
            // Zvƒõd sni≈æuje ≈°anci o 50%
            const hasScout = state.settlement.settlers.some(s => s.type === 'scout');
            const finalChance = hasScout ? raidChance * 0.5 : raidChance;
            
            return Math.random() < finalChance;
        }
        
        function startSettlementRaid() {
            state.settlement.lastRaid = Date.now();
            
            // P≈ôehraj alarm zvuk
            SoundSystem.play('raid');
            
            // Syst√©mov√° notifikace
            sendSystemNotification('‚öîÔ∏è N√ÅJEZD!', 'Tv√° osada je napadena! Bra≈à se!', '‚öîÔ∏è');
            
            // Urƒçi vlnu podle obt√≠≈ænosti (prosperity, dny p≈ôe≈æit√≠)
            let waveIndex = Math.min(4, Math.floor(state.time.days / 7));
            waveIndex = Math.min(waveIndex, Math.floor((state.settlement.prosperity || 0) / 30));
            
            const wave = RAID_WAVES[waveIndex];
            
            // Varov√°n√≠ od zvƒõda
            const hasScout = state.settlement.settlers.some(s => s.type === 'scout');
            
            const raidTexts = {
                scoutWarning: 'Zvƒõd tƒõ vƒças varoval!', enemies: 'Nep≈ô√°tel√©:',
                settlementDefense: 'Obrana osady:', guards: 'Str√°≈æci:',
                defendPersonally: 'Br√°nit osobnƒõ!', letDefense: 'Nechat obranu',
                fatiguePenalty: '-10% √∫tok (√∫nava)', returnsToSettlement: 'Vr√°t√≠ tƒõ do osady',
                guardsDefend: 'Str√°≈æci a vƒõ≈æe br√°n√≠', possibleLosses: 'Mo≈æn√© ztr√°ty z√°sob'
            };
            
            // Zjisti jestli je hr√°ƒç v osadƒõ
            const currentLoc = state.world?.currentLocation || '';
            const alreadyInSettlement = currentLoc === 'shelter' || currentLoc === 'settlement' || state.map?.inBase;
            
            // Text pro tlaƒç√≠tko osobn√≠ obrany
            const defendPenaltyText = alreadyInSettlement 
                ? '<span style="color: #4caf50;">‚úì Jsi v osadƒõ - ≈æ√°dn√° penalizace!</span>'
                : `‚ö†Ô∏è -50% ‚ö° -20% üçñ -20% üíß<br>${raidTexts.fatiguePenalty}<br>${raidTexts.returnsToSettlement}`;
            
            showModal('‚öîÔ∏è N√ÅJEZD NA OSADU!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; animation: pulse 1s infinite;">‚öîÔ∏è</div>
                    <h3 style="color: #ff4444; margin: 0.5rem 0;">${getRaidWaveName(waveIndex + 1)}!</h3>
                </div>
                
                ${hasScout ? `<p style="color: #8bc34a; text-align: center;">üëÅÔ∏è ${raidTexts.scoutWarning}</p>` : ''}
                
                <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #8B0000;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff6666;">üëπ ${raidTexts.enemies}</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${wave.enemies.map(e => {
                            const enemy = ENEMIES.find(en => en.id === e.type);
                            return `<span style="background: #1a1a1a; padding: 0.3rem 0.6rem; border-radius: 4px;">
                                ${enemy?.icon || 'üë§'} ${enemy?.name || e.type} x${e.count}
                            </span>`;
                        }).join('')}
                    </div>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--toxic-dark);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>üõ°Ô∏è ${raidTexts.settlementDefense}</span>
                        <span style="color: var(--toxic-green); font-weight: bold;">${calculateSettlementDefense()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span>üë• ${raidTexts.guards}</span>
                        <span>${state.settlement.settlers.filter(s => s.type === 'guard').length}</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div>
                        <button class="btn" onclick="defendSettlement(${waveIndex})" style="background: #8B0000; width: 100%;">
                            ‚öîÔ∏è ${raidTexts.defendPersonally}
                        </button>
                        <div style="font-size: 0.65rem; color: ${alreadyInSettlement ? '#4caf50' : '#ff9800'}; text-align: center; margin-top: 0.3rem;">
                            ${defendPenaltyText}
                        </div>
                    </div>
                    <div>
                        <button class="btn" onclick="autoDefendSettlement(${waveIndex})" style="background: #555; width: 100%;">
                            üè∞ ${raidTexts.letDefense}
                        </button>
                        <div style="font-size: 0.65rem; color: #888; text-align: center; margin-top: 0.3rem;">
                            ${raidTexts.guardsDefend}<br>
                            ${raidTexts.possibleLosses}
                        </div>
                    </div>
                </div>
            `, true);
        }
        
        function defendSettlement(waveIndex) {
            closeModal();
            const wave = RAID_WAVES[waveIndex];
            
            // Zjisti jestli je hr√°ƒç u≈æ v osadƒõ
            const currentLoc = state.world?.currentLocation || '';
            const alreadyInSettlement = currentLoc === 'shelter' || currentLoc === 'settlement' || state.map?.inBase;
            
            // === PENALIZACE ZA OSOBN√ç OBRANU ===
            // Pouze pokud NEN√ç v osadƒõ - mus√≠ se rychle vr√°tit
            if (!alreadyInSettlement) {
                const energyCost = Math.floor(state.status.energy * 0.5); // 50% energie
                const hungerCost = Math.floor(state.status.hunger * 0.2); // 20% j√≠dla
                const thirstCost = Math.floor(state.status.thirst * 0.2); // 20% ≈æ√≠znƒõ
                
                state.status.energy = Math.max(0, state.status.energy - energyCost);
                state.status.hunger = Math.max(0, state.status.hunger - hungerCost);
                state.status.thirst = Math.max(0, state.status.thirst - thirstCost);
                
                // P≈ôidej debuff za √∫navu (-10% damage)
                if (!state.combatDebuffs) state.combatDebuffs = {};
                state.combatDebuffs.fatigue = {
                    name: '√önava z cesty',
                    effect: -0.10, // -10% damage
                    fights: 1 // Plat√≠ jen pro tento boj
                };
                
                addLog('Spƒõch√°≈° br√°nit osadu! (-50% ‚ö°, -20% üçñ, -20% üíß)', 'üèÉ');
            } else {
                addLog('P≈ôipravuje≈° se k obranƒõ osady!', '‚öîÔ∏è');
            }
            
            // P≈ôesun do osady (pro jistotu)
            state.world.currentLocation = 'shelter';
            state.map.inBase = true;
            
            // Vytvo≈ô skupinu nep≈ô√°tel
            let enemyGroup = [];
            wave.enemies.forEach(e => {
                const enemyTemplate = ENEMIES.find(en => en.id === e.type);
                if (enemyTemplate) {
                    for (let i = 0; i < e.count; i++) {
                        enemyGroup.push({
                            ...enemyTemplate,
                            hp: enemyTemplate.hp,
                            maxHp: enemyTemplate.hp,
                            alive: true,
                            stunned: false,
                            poisoned: 0,
                            bleeding: 0
                        });
                    }
                }
            });
            
            // Bonus od obrany osady - sn√≠≈æen√≠ HP nep≈ô√°tel
            const defenseBonus = Math.min(0.5, calculateSettlementDefense() / 200);
            enemyGroup.forEach(e => {
                e.hp = Math.floor(e.hp * (1 - defenseBonus));
                e.maxHp = e.hp;
            });
            
            // Spus≈• boj
            window.raidWaveIndex = waveIndex;
            window.isSettlementRaid = true;
            startCombatWithGroup(enemyGroup, 'settlement_raid');
        }
        
        function autoDefendSettlement(waveIndex) {
            closeModal();
            const wave = RAID_WAVES[waveIndex];
            
            // Spoƒç√≠tej s√≠lu nep≈ô√°tel
            let enemyPower = 0;
            wave.enemies.forEach(e => {
                const enemy = ENEMIES.find(en => en.id === e.type);
                if (enemy) {
                    enemyPower += (enemy.hp + enemy.damage * 5) * e.count;
                }
            });
            
            // S√≠la obrany
            const defensePower = calculateSettlementDefense() * 3;
            const guardPower = state.settlement.settlers.filter(s => s.type === 'guard').length * 50;
            const totalDefense = defensePower + guardPower;
            
            // V√Ωsledek
            const defenseRatio = totalDefense / enemyPower;
            const winChance = Math.min(0.95, Math.max(0.1, defenseRatio));
            const won = Math.random() < winChance;
            
            if (won) {
                // V√≠tƒõzstv√≠
                state.settlement.raidsDefended = (state.settlement.raidsDefended || 0) + 1;
                const reward = wave.reward;
                
                addMoney(reward.money || 0);
                if (reward.xp > 0) addXP(reward.xp);
                
                showModal('üéâ Obrana √∫spƒõ≈°n√°!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üõ°Ô∏è</div>
                        <h3 style="color: #8bc34a;">Osada odrazila √∫tok!</h3>
                        <p>Tvoji str√°≈æci a obrann√© stavby ochr√°nili osadu.</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p>üí∞ +${reward.money} penƒõz</p>
                            <p>‚≠ê +${reward.xp} XP</p>
                        </div>
                        <p style="color: #888; font-size: 0.85rem;">Odra≈æeno n√°jezd≈Ø: ${state.settlement.raidsDefended}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
            } else {
                // Prohra - ztr√°ty
                const foodLoss = Math.floor((state.settlement.resources.food || 0) * 0.3);
                const waterLoss = Math.floor((state.settlement.resources.water || 0) * 0.2);
                const moneyLoss = Math.floor(state.money * 0.2);
                
                state.settlement.resources.food = Math.max(0, (state.settlement.resources.food || 0) - foodLoss);
                state.settlement.resources.water = Math.max(0, (state.settlement.resources.water || 0) - waterLoss);
                state.money = Math.max(0, state.money - moneyLoss);
                state.settlement.morale = Math.max(0, (state.settlement.morale || 50) - 20);
                
                // Mo≈æn√° ztr√°ta osadn√≠ka
                if (Math.random() < 0.3 && state.settlement.settlers.length > 0) {
                    const lostSettler = state.settlement.settlers.pop();
                    showModal('üíÄ Obrana selhala!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">üíÄ</div>
                            <h3 style="color: #ff4444;">N√°jezdn√≠ci vydrancovali osadu!</h3>
                            <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <p style="color: #ff6666;">üçñ -${foodLoss} j√≠dla</p>
                                <p style="color: #ff6666;">üíß -${waterLoss} vody</p>
                                <p style="color: #ff6666;">üí∞ -${moneyLoss} penƒõz</p>
                                <p style="color: #ff4444; margin-top: 0.5rem;">‚ò†Ô∏è ${lostSettler.name} zahynul!</p>
                            </div>
                            <p style="color: #ff9800;">üí° Postav v√≠ce obrann√Ωch staveb!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                } else {
                    showModal('üíÄ Obrana selhala!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">üíÄ</div>
                            <h3 style="color: #ff4444;">N√°jezdn√≠ci vydrancovali osadu!</h3>
                            <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <p style="color: #ff6666;">üçñ -${foodLoss} j√≠dla</p>
                                <p style="color: #ff6666;">üíß -${waterLoss} vody</p>
                                <p style="color: #ff6666;">üí∞ -${moneyLoss} penƒõz</p>
                            </div>
                            <p style="color: #ff9800;">üí° Postav v√≠ce obrann√Ωch staveb!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                    `);
                }
            }
            
            addLog(won ? ('Osada odrazila n√°jezd!') : ('N√°jezdn√≠ci vydrancovali osadu!'), won ? 'üõ°Ô∏è' : 'üíÄ');
            renderFull();
        }
        
        function handleRaidVictory() {
            const waveIndex = window.raidWaveIndex || 0;
            const wave = RAID_WAVES[waveIndex];
            
            state.settlement.raidsDefended = (state.settlement.raidsDefended || 0) + 1;
            
            const reward = wave.reward;
            addMoney(reward.money || 0);
            if (reward.xp > 0) addXP(reward.xp);
            
            addLog(`Osobnƒõ jsi odrazil n√°jezd! +${reward.money} üí∞, +${reward.xp} XP`, '‚öîÔ∏è');
            
            window.isSettlementRaid = false;
            window.raidWaveIndex = null;
        }
        
        // === DUNGEON SYST√âM ===
        function enterDungeon(dungeonId) {
            console.log('üè∞ enterDungeon called:', dungeonId);
            console.log('üè∞ Current location:', state.world?.currentLocation);
            console.log('üè∞ DUNGEON_FLOORS has this dungeon:', !!DUNGEON_FLOORS[dungeonId]);
            
            // DEBUG - zobraz info
            // alert('enterDungeon: ' + dungeonId + ', currentLocation: ' + state.world?.currentLocation);
            
            // Kontrola prob√≠haj√≠c√≠ akce (lov, tƒõ≈æba, pr≈Øzkum atd.)
            if (state.currentAction && state.currentAction.endTime > Date.now()) {
                const remaining = Math.ceil((state.currentAction.endTime - Date.now()) / 1000);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                notifyWarning('Prob√≠h√° akce', `Poƒçkej ${mins}:${String(secs).padStart(2, '0')} ne≈æ akce skonƒç√≠`);
                return;
            }
            
            // Kontrola cestov√°n√≠
            if (state.world?.traveling || state.map?.traveling) {
                notifyWarning('Cestuje≈°', 'Nejd≈ô√≠v dokonƒçi cestu!');
                return;
            }
            
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            console.log('üè∞ dungeonData:', dungeonData);
            if (!dungeonData) {
                notifyWarning('Chyba', 'Tento dungeon nem√° definovan√° patra. ID: ' + dungeonId);
                return;
            }
            
            // V≈°e OK - vstup do dungeonu
            console.log('üè∞ Entering dungeon...');
            // Zajisti ≈æe state.dungeon m√° v≈°echny pot≈ôebn√© properties
            if (!state.dungeon) {
                state.dungeon = { active: null, floor: 0, maxFloor: 0, cleared: {}, loot: [] };
            }
            // Zajisti ≈æe cleared existuje (pro star√© ulo≈æen√© hry)
            if (!state.dungeon.cleared) state.dungeon.cleared = {};
            if (!state.dungeon.loot) state.dungeon.loot = [];
            
            state.dungeon.active = dungeonId;
            state.dungeon.floor = 1;
            state.dungeon.loot = [];
            
            showDungeonUI();
        }
        
        function showDungeonUI() {
            if (!state.dungeon?.active) {
                console.error('üè∞ showDungeonUI: No active dungeon');
                return;
            }
            
            const dungeonId = state.dungeon.active;
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            
            if (!dungeonData) {
                console.error('üè∞ showDungeonUI: No dungeon data for', dungeonId);
                notifyWarning('Chyba', 'Dungeon data nenalezena');
                return;
            }
            
            const currentFloor = dungeonData.floors.find(f => f.floor === state.dungeon.floor);
            
            if (!currentFloor) {
                console.error('üè∞ showDungeonUI: No floor data for floor', state.dungeon.floor);
                // Reset na patro 1
                state.dungeon.floor = 1;
                const firstFloor = dungeonData.floors[0];
                if (!firstFloor) {
                    notifyWarning('Chyba', 'Dungeon nem√° ≈æ√°dn√° patra');
                    return;
                }
            }
            
            const floor = currentFloor || dungeonData.floors[0];
            // Zajisti ≈æe cleared objekt existuje
            if (!state.dungeon.cleared) state.dungeon.cleared = {};
            
            // === RESET DUNGEON≈Æ PO 24 HODIN√ÅCH ===
            const DUNGEON_RESET_TIME = 24 * 60 * 60 * 1000; // 24 hodin v ms
            const dungeonClearData = state.dungeon.cleared[dungeonId];
            let clearedFloors = [];
            
            if (dungeonClearData) {
                // Nov√Ω form√°t: { floors: [...], clearedAt: timestamp }
                if (dungeonClearData.clearedAt) {
                    const timeSinceClear = Date.now() - dungeonClearData.clearedAt;
                    if (timeSinceClear >= DUNGEON_RESET_TIME) {
                        // Reset dungeonu!
                        delete state.dungeon.cleared[dungeonId];
                        addLog(`üè∞ ${dungeonData.name} se resetoval - nep≈ô√°tel√© se vr√°tili!`, 'üîÑ');
                        clearedFloors = [];
                    } else {
                        clearedFloors = dungeonClearData.floors || [];
                    }
                } else if (Array.isArray(dungeonClearData)) {
                    // Star√Ω form√°t: [floors] - p≈ôeveƒè na nov√Ω, ale pou≈æij star√Ω timestamp (pokud existuje) nebo ponech null
                    // clearedAt bude nastaveno a≈æ p≈ôi dal≈°√≠m vyƒçi≈°tƒõn√≠ patra
                    state.dungeon.cleared[dungeonId] = {
                        floors: dungeonClearData,
                        clearedAt: null // Bude nastaveno p≈ôi vyƒçi≈°tƒõn√≠
                    };
                    clearedFloors = dungeonClearData;
                }
            }
            
            const isCleared = clearedFloors.includes(state.dungeon.floor);
            
            console.log('üè∞ showDungeonUI:', { 
                dungeonId, 
                floor: state.dungeon.floor, 
                totalFloors: dungeonData.floors.length,
                isCleared,
                clearedFloors: clearedFloors,
                clearData: state.dungeon.cleared[dungeonId]
            });
            
            // Vypoƒç√≠tej ƒças do resetu - pouze kdy≈æ jsou V≈†ECHNA patra vyƒçi≈°tƒõna
            let resetTimeText = '';
            const dungeonClearDataForUI = state.dungeon.cleared[dungeonId];
            const allFloorsAreCleared = clearedFloors.length >= dungeonData.floors.length;
            if (dungeonClearDataForUI && dungeonClearDataForUI.clearedAt && allFloorsAreCleared) {
                const timeUntilReset = (dungeonClearDataForUI.clearedAt + DUNGEON_RESET_TIME) - Date.now();
                if (timeUntilReset > 0) {
                    const hoursLeft = Math.floor(timeUntilReset / (60 * 60 * 1000));
                    const minsLeft = Math.floor((timeUntilReset % (60 * 60 * 1000)) / (60 * 1000));
                    resetTimeText = `<div style="font-size: 0.75rem; color: #64b5f6; margin-top: 0.3rem;">üîÑ Reset za: ${hoursLeft}h ${minsLeft}m</div>`;
                }
            }
            
            showModal(`üè∞ ${dungeonData.name}`, `
                <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0; color: #64b5f6;">Patro ${state.dungeon.floor}: ${floor.name}</h3>
                        ${isCleared ? '<span style="color: #8bc34a;">‚úì Vyƒçi≈°tƒõno</span>' : '<span style="color: #ff9800;">‚ö†Ô∏è Nevyƒçi≈°tƒõno</span>'}
                    </div>
                    <div style="font-size: 0.85rem; color: #888;">
                        Maxim√°ln√≠ patro: ${dungeonData.floors.length}
                    </div>
                    ${resetTimeText}
                </div>
                
                <!-- Progress -->
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.3rem;">
                        ${dungeonData.floors.map(f => `
                            <div style="flex: 1; height: 8px; border-radius: 4px; background: ${
                                clearedFloors.includes(f.floor) ? '#8bc34a' : 
                                f.floor === state.dungeon.floor ? '#ff9800' : '#333'
                            };"></div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Nep≈ô√°tel√© -->
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #8B0000;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff6666; font-size: 0.9rem;">üëπ Nep≈ô√°tel√© na pat≈ôe:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${floor.enemies.map(eId => {
                            const enemy = ENEMIES.find(e => e.id === eId);
                            return enemy ? `<span style="background: #1a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                                ${enemy.icon} ${enemy.name}
                            </span>` : '';
                        }).join('')}
                        ${floor.boss ? `<span style="background: #4a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; border: 1px solid #ff4444;">
                            üëæ BOSS: ${DUNGEON_BOSSES[floor.boss]?.name || floor.boss}
                        </span>` : ''}
                    </div>
                </div>
                
                <!-- Loot -->
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--toxic-dark);">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">üíé Mo≈æn√° ko≈ôist:</h4>
                    <div style="font-size: 0.85rem; color: #aaa;">
                        ${floor.loot.join(', ')}
                    </div>
                </div>
                
                <!-- Nasb√≠ran√Ω loot -->
                ${state.dungeon.loot.length > 0 ? `
                    <div style="background: #2a2a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <span style="color: #ffd700; font-size: 0.85rem;">üéí Nasb√≠r√°no: ${state.dungeon.loot.length} p≈ôedmƒõt≈Ø</span>
                    </div>
                ` : ''}
                
                <!-- Akce -->
                <div style="display: grid; gap: 0.5rem;">
                    ${!isCleared ? `
                        <button class="btn" onclick="exploreDungeonFloor()" style="background: #8B0000;">
                            ‚öîÔ∏è Prozkoumat patro
                        </button>
                    ` : `
                        ${state.dungeon.floor < dungeonData.floors.length ? `
                            <button class="btn" onclick="descendDungeon()" style="background: var(--toxic-dark);">
                                ‚¨áÔ∏è Sestoupit hloubƒõji
                            </button>
                        ` : `
                            <div style="text-align: center; color: #8bc34a; padding: 0.5rem;">
                                ‚úì Dungeon kompletnƒõ vyƒçi≈°tƒõn!
                            </div>
                        `}
                    `}
                    ${state.dungeon.floor > 1 ? `
                        <button class="btn" onclick="ascendDungeon()" style="background: #555;">
                            ‚¨ÜÔ∏è Vr√°tit se nahoru
                        </button>
                    ` : ''}
                    <button class="btn" onclick="exitDungeon()" style="background: #333;">
                        üö™ Opustit dungeon
                    </button>
                </div>
            `);
        }
        
        function exploreDungeonFloor() {
            closeModal();
            
            if (!state.dungeon?.active) {
                notifyWarning('Chyba', '≈Ω√°dn√Ω aktivn√≠ dungeon');
                return;
            }
            
            const dungeonId = state.dungeon.active;
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            
            if (!dungeonData) {
                notifyWarning('Chyba', 'Dungeon data nenalezena');
                return;
            }
            
            const currentFloor = dungeonData.floors.find(f => f.floor === state.dungeon.floor);
            
            if (!currentFloor) {
                notifyWarning('Chyba', 'Data patra nenalezena');
                return;
            }
            
            // Vytvo≈ô nep≈ô√°tele
            let enemyGroup = [];
            currentFloor.enemies.forEach(eId => {
                const enemy = ENEMIES.find(e => e.id === eId);
                if (enemy) {
                    const count = 1 + Math.floor(Math.random() * 2); // 1-2 ka≈æd√©ho typu
                    for (let i = 0; i < count; i++) {
                        enemyGroup.push({
                            ...enemy,
                            hp: enemy.hp,
                            maxHp: enemy.hp,
                            alive: true,
                            stunned: false,
                            poisoned: 0,
                            bleeding: 0
                        });
                    }
                }
            });
            
            // P≈ôidej bosse na posledn√≠m pat≈ôe
            if (currentFloor.boss) {
                const boss = DUNGEON_BOSSES[currentFloor.boss];
                if (boss) {
                    enemyGroup.push({
                        ...boss,
                        id: currentFloor.boss,
                        hp: boss.hp,
                        maxHp: boss.hp,
                        alive: true,
                        stunned: false,
                        poisoned: 0,
                        bleeding: 0,
                        isBoss: true
                    });
                }
            }
            
            window.isDungeonCombat = true;
            startCombatWithGroup(enemyGroup, 'dungeon');
        }
        
        function handleDungeonVictory() {
            console.log('üè∞ handleDungeonVictory called!', { dungeon: state.dungeon });
            
            if (!state.dungeon?.active) {
                console.error('üè∞ handleDungeonVictory: No active dungeon');
                // Zkus obnovit dungeon z lokace
                if (state.world?.currentLocation && DUNGEON_FLOORS[state.world.currentLocation]) {
                    console.log('üè∞ Attempting to restore dungeon from location:', state.world.currentLocation);
                    state.dungeon = {
                        active: state.world.currentLocation,
                        floor: 1,
                        loot: [],
                        cleared: state.dungeon?.cleared || {}
                    };
                } else {
                    closeModal();
                    renderFull();
                    return;
                }
            }
            
            const dungeonId = state.dungeon.active;
            const dungeonData = DUNGEON_FLOORS[dungeonId];
            
            console.log('üè∞ Processing victory for:', dungeonId, 'floor:', state.dungeon.floor);
            
            if (!dungeonData) {
                console.error('üè∞ handleDungeonVictory: No dungeon data for', dungeonId);
                notifyWarning('Chyba', 'Dungeon data nenalezena');
                return;
            }
            
            const currentFloor = dungeonData.floors.find(f => f.floor === state.dungeon.floor);
            
            if (!currentFloor) {
                console.error('üè∞ handleDungeonVictory: No floor data for floor', state.dungeon.floor);
                return;
            }
            
            // Zajisti ≈æe loot array existuje
            if (!state.dungeon.loot) state.dungeon.loot = [];
            
            // Oznaƒç patro jako vyƒçi≈°tƒõn√© (nov√Ω form√°t s timestampem)
            if (!state.dungeon.cleared) state.dungeon.cleared = {};
            if (!state.dungeon.cleared[dungeonId]) {
                state.dungeon.cleared[dungeonId] = { floors: [], clearedAt: null };
            }
            // Migrace star√©ho form√°tu
            if (Array.isArray(state.dungeon.cleared[dungeonId])) {
                state.dungeon.cleared[dungeonId] = { 
                    floors: state.dungeon.cleared[dungeonId], 
                    clearedAt: null // Nastav√≠ se n√≠≈æe
                };
            }
            if (!state.dungeon.cleared[dungeonId].floors) {
                state.dungeon.cleared[dungeonId].floors = [];
            }
            if (!state.dungeon.cleared[dungeonId].floors.includes(state.dungeon.floor)) {
                state.dungeon.cleared[dungeonId].floors.push(state.dungeon.floor);
                console.log('üè∞ Floor', state.dungeon.floor, 'marked as cleared!');
                notifySuccess('üè∞ Patro vyƒçi≈°tƒõno!', `Patro ${state.dungeon.floor} bylo vyƒçi≈°tƒõno`);
            }
            
            // Aktualizuj ƒças vyƒçi≈°tƒõn√≠ - POUZE kdy≈æ jsou vyƒçi≈°tƒõna V≈†ECHNA patra
            const allFloorsCleared = state.dungeon.cleared[dungeonId].floors.length >= dungeonData.floors.length;
            if (allFloorsCleared && !state.dungeon.cleared[dungeonId].clearedAt) {
                state.dungeon.cleared[dungeonId].clearedAt = Date.now();
                addLog(`üè∞ ${dungeonData.name} kompletnƒõ vyƒçi≈°tƒõn! Reset za 24 hodin.`, 'üèÜ');
            }
            
            // Generuj loot
            const lootGained = [];
            currentFloor.loot.forEach(lootType => {
                // Legendary m√° mnohem ni≈æ≈°√≠ ≈°anci
                let dropChance = 0.6; // 60% pro bƒõ≈æn√Ω loot
                if (lootType === 'legendary' || lootType === 'legendary_weapon' || lootType === 'legendary_armor' || lootType === 'legendary_item') {
                    dropChance = 0.03; // 3% pro legendary
                } else if (lootType === 'unique' || lootType === 'unique_artifact') {
                    dropChance = 0.02; // 2% pro unique
                } else if (lootType === 'rare_weapon' || lootType === 'rare_armor') {
                    dropChance = 0.15; // 15% pro rare
                }
                
                if (Math.random() < dropChance) {
                    lootGained.push(lootType);
                    state.dungeon.loot.push(lootType);
                }
            });
            
            // Aktualizuj max floor
            if (state.dungeon.floor > (state.dungeon.maxFloor || 0)) {
                state.dungeon.maxFloor = state.dungeon.floor;
            }
            
            addLog(`Vyƒçistil jsi patro ${state.dungeon.floor} v ${dungeonData.name}!`, 'üè∞');
            
            window.isDungeonCombat = false;
            
            // Ulo≈æ hru po vyƒçi≈°tƒõn√≠ patra
            saveGame();
            
            setTimeout(() => showDungeonUI(), 500);
        }
        
        function descendDungeon() {
            if (!state.dungeon) return;
            state.dungeon.floor++;
            showDungeonUI();
        }
        
        function ascendDungeon() {
            if (!state.dungeon) return;
            state.dungeon.floor--;
            showDungeonUI();
        }
        
        function exitDungeon() {
            if (!state.dungeon) {
                closeModal();
                return;
            }
            
            // P≈ôidej nasb√≠ran√Ω loot do invent√°≈ôe
            if (state.dungeon.loot && state.dungeon.loot.length > 0) {
                const resourceTypes = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'copper', 'scrap', 'fuel', 'rope', 'gunpowder', 'crystal', 'radaway', 'radx', 'ammo', 'medkit', 'plutonium_core', 'fusion_cell', 'ai_chip'];
                
                state.dungeon.loot.forEach(lootType => {
                    // Je to surovina?
                    if (resourceTypes.includes(lootType)) {
                        const amount = 1 + Math.floor(Math.random() * 3);
                        state.resources[lootType] = (state.resources[lootType] || 0) + amount;
                        const name = RESOURCE_NAMES[lootType] || lootType;
                        const icon = RESOURCE_ICONS[lootType] || 'üì¶';
                        addLog(`+${amount} ${icon} ${name} z dungeonu`, 'üì¶');
                    } else if (lootType === 'legendary' || lootType === 'legendary_weapon' || lootType === 'legendary_armor' || lootType === 'legendary_item') {
                        // Legend√°rn√≠ p≈ôedmƒõt
                        const legendaries = ITEMS.filter(i => i.rarity === 'legendary');
                        if (legendaries.length > 0) {
                            const item = legendaries[Math.floor(Math.random() * legendaries.length)];
                            if (canAddItem(item, 1)) {
                                addItemToInventory(item, 1);
                                notifyLoot(item.name, 'legendary', item.icon);
                            } else {
                                // Na zem pokud pln√Ω invent√°≈ô
                                addToGroundLoot({...item});
                                notifyWarning('üì¶ Na zemi', `${item.name} z≈Østal na zemi (pln√Ω invent√°≈ô)`);
                            }
                        }
                    } else {
                        // Ostatn√≠ - p≈ôidej pen√≠ze
                        addMoney(20 + Math.floor(Math.random() * 50));
                    }
                });
            }
            
            state.dungeon.active = null;
            state.dungeon.floor = 0;
            state.dungeon.loot = [];
            
            closeModal();
            renderFull();
        }
        
        // === ENDLESS DUNGEON - PROPAST ===
        // Nekoneƒçn√Ω dungeon pro endgame content
        const ABYSS_MODIFIERS = [
            { id: 'no_heal', name: 'üö´ Bez l√©ƒçen√≠', desc: 'L√©ƒçiva ne√∫ƒçinkuj√≠', floor: 5 },
            { id: 'double_dmg', name: '‚öîÔ∏è Dvojit√Ω damage', desc: 'V≈°ichni dƒõlaj√≠ 2x DMG', floor: 10 },
            { id: 'fog', name: 'üå´Ô∏è Mlha', desc: 'Viditelnost sn√≠≈æena', floor: 15 },
            { id: 'poison_air', name: '‚ò†Ô∏è Jedovat√Ω vzduch', desc: '+3 jed ka≈æd√© kolo', floor: 20 },
            { id: 'elite_only', name: 'üíÄ Jen elity', desc: 'V≈°ichni nep≈ô√°tel√© jsou elite', floor: 25 },
            { id: 'no_retreat', name: 'üö∑ Bez √∫stupu', desc: 'Nelze ut√©ct', floor: 30 }
        ];
        
        const ABYSS_BOSSES = [
            { floor: 10, name: 'Str√°≈æce Propasti', icon: 'üëπ', hp: 500, damage: 40, defense: 20, xp: 500 },
            { floor: 20, name: 'St√≠nov√Ω Tit√°n', icon: 'ü¶ç', hp: 800, damage: 55, defense: 30, xp: 800 },
            { floor: 30, name: 'Prastar√Ω Lich', icon: 'üíÄ', hp: 1200, damage: 70, defense: 40, xp: 1200 },
            { floor: 50, name: 'Vl√°dce Propasti', icon: 'üëë', hp: 2000, damage: 100, defense: 60, xp: 2000 }
        ];
        
        function showAbyssEntrance() {
            // Vy≈æaduje level 15+
            if ((state.char.level || 1) < 15) {
                showModal('üï≥Ô∏è Propast', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üï≥Ô∏è</div>
                        <h3 style="color: #ff4444;">Nejsi p≈ôipraven</h3>
                        <p style="color: #888;">Propast vy≈æaduje minim√°lnƒõ level 15.</p>
                        <p style="color: #ffd700;">Tv≈Øj level: ${state.char.level || 1}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
                `);
                return;
            }
            
            // Inicializuj abyss stats
            state.abyss = state.abyss || { maxFloor: 0, runs: 0, deaths: 0 };
            
            const highScore = state.abyss.maxFloor || 0;
            const runs = state.abyss.runs || 0;
            
            showModal('üï≥Ô∏è PROPAST - Endless Dungeon', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üï≥Ô∏è</div>
                    <p style="color: #888; font-size: 0.85rem;">Nekoneƒçn√Ω dungeon pro ty nejodv√°≈ænƒõj≈°√≠</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a0a2a, #0a0a1a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #9c27b0;">
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; color: #ffd700;">${highScore}</div>
                            <div style="font-size: 0.7rem; color: #888;">Rekord</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; color: #4caf50;">${runs}</div>
                            <div style="font-size: 0.7rem; color: #888;">Pokusy</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; color: #ff4444;">${state.abyss.deaths || 0}</div>
                            <div style="font-size: 0.7rem; color: #888;">Smrti</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <h4 style="color: #9c27b0; margin: 0 0 0.5rem 0;">üìú Pravidla:</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #aaa;">
                        <li>Ka≈æd√Ωch 10 pater = boss + checkpoint</li>
                        <li>Ka≈æd√Ωch 5 pater = nov√Ω modifik√°tor</li>
                        <li>ƒå√≠m hloubƒõji, t√≠m silnƒõj≈°√≠ nep≈ô√°tel√©</li>
                        <li>Smrt = konec runu (zachov√°≈° loot)</li>
                        <li>Unik√°tn√≠ Abyss loot pouze zde!</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="startAbyssRun()" style="flex: 2; background: linear-gradient(135deg, #9c27b0, #6a1b9a); padding: 0.8rem; font-weight: bold;">
                        üï≥Ô∏è Vstoupit do Propasti
                    </button>
                    <button class="btn" onclick="showAbyssLeaderboard()" style="flex: 1; background: #333;">
                        üèÜ
                    </button>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function startAbyssRun() {
            state.abyss = state.abyss || {};
            state.abyss.runs = (state.abyss.runs || 0) + 1;
            state.abyss.currentFloor = 1;
            state.abyss.loot = [];
            state.abyss.activeModifiers = [];
            state.abyss.inProgress = true;
            
            addLog('üï≥Ô∏è Vstoupil jsi do Propasti!', 'üï≥Ô∏è');
            showAbyssFloor();
        }
        
        function showAbyssFloor() {
            const floor = state.abyss.currentFloor;
            const isBossFloor = floor % 10 === 0;
            const isCheckpoint = floor % 10 === 0;
            
            // P≈ôidej modifik√°tor ka≈æd√Ωch 5 pater
            if (floor > 1 && floor % 5 === 1) {
                const availableMods = ABYSS_MODIFIERS.filter(m => m.floor <= floor && !state.abyss.activeModifiers.includes(m.id));
                if (availableMods.length > 0) {
                    const newMod = availableMods[Math.floor(Math.random() * availableMods.length)];
                    state.abyss.activeModifiers.push(newMod.id);
                    notifyWarning('Nov√Ω modifik√°tor!', `${newMod.name}: ${newMod.desc}`);
                }
            }
            
            // Modifik√°tory UI
            const modsHtml = state.abyss.activeModifiers.map(modId => {
                const mod = ABYSS_MODIFIERS.find(m => m.id === modId);
                return mod ? `<span style="background: #2a1a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; color: #ce93d8;">${mod.name}</span>` : '';
            }).join(' ');
            
            // Nep≈ô√°tel√© - scale s patrem
            const enemyCount = Math.min(6, 1 + Math.floor(floor / 5));
            const enemyScaling = 1 + (floor * 0.1); // +10% za patro
            
            showModal(`üï≥Ô∏è Propast - Patro ${floor}`, `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <div style="font-size: 2rem;">${isBossFloor ? 'üëπ' : 'üï≥Ô∏è'}</div>
                    <div style="color: ${isBossFloor ? '#ff4444' : '#9c27b0'}; font-weight: bold;">
                        ${isBossFloor ? '‚ö†Ô∏è BOSS FLOOR ‚ö†Ô∏è' : `Patro ${floor}`}
                    </div>
                    ${isCheckpoint ? '<div style="color: #4caf50; font-size: 0.8rem;">‚úì Checkpoint</div>' : ''}
                </div>
                
                ${modsHtml ? `<div style="margin-bottom: 0.5rem; text-align: center;">${modsHtml}</div>` : ''}
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: #888;">Nep≈ô√°tel√©:</span>
                        <span style="color: #ff6b6b;">${isBossFloor ? 'BOSS + ' + (enemyCount - 1) : enemyCount}x</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: #888;">S√≠la:</span>
                        <span style="color: #ffd700;">√ó${enemyScaling.toFixed(1)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: #888;">Loot z√≠sk√°n:</span>
                        <span style="color: #4caf50;">${state.abyss.loot?.length || 0} item≈Ø</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="startAbyssCombat()" style="flex: 2; background: #c62828; padding: 0.8rem;">
                        ‚öîÔ∏è Bojovat!
                    </button>
                    <button class="btn" onclick="exitAbyss()" style="flex: 1; background: #555;">
                        üö™ Odej√≠t
                    </button>
                </div>
            `);
        }
        
        function startAbyssCombat() {
            const floor = state.abyss.currentFloor;
            const isBossFloor = floor % 10 === 0;
            const hasEliteOnly = state.abyss.activeModifiers.includes('elite_only');
            
            // ≈†k√°lov√°n√≠
            const scaling = 1 + (floor * 0.1);
            
            // Seznam nep≈ô√°tel z r≈Øzn√Ωch tier podle patra
            const tierEnemies = {
                1: ['wolf', 'rad_roach', 'wild_dog'],
                2: ['raider', 'ghoul', 'mutant_rat'],
                3: ['mutant', 'raider_boss', 'feral_ghoul'],
                4: ['deathclaw', 'super_mutant', 'robot_security']
            };
            
            const tier = Math.min(4, Math.ceil(floor / 10));
            const enemyPool = tierEnemies[tier] || tierEnemies[1];
            
            const enemyGroup = [];
            const enemyCount = Math.min(6, 1 + Math.floor(floor / 5));
            
            // Boss na boss floorech
            if (isBossFloor) {
                const boss = ABYSS_BOSSES.find(b => b.floor === floor) || ABYSS_BOSSES[ABYSS_BOSSES.length - 1];
                enemyGroup.push({
                    ...boss,
                    id: 'abyss_boss_' + floor,
                    hp: Math.floor(boss.hp * scaling),
                    maxHp: Math.floor(boss.hp * scaling),
                    damage: Math.floor(boss.damage * scaling),
                    defense: Math.floor(boss.defense * scaling),
                    isBoss: true,
                    isElite: true
                });
            }
            
            // Norm√°ln√≠ nep≈ô√°tel√©
            const normalCount = isBossFloor ? enemyCount - 1 : enemyCount;
            for (let i = 0; i < normalCount; i++) {
                const enemyId = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                const enemyData = Object.values(ENEMIES).flat().find(e => e.id === enemyId) || 
                    { id: enemyId, name: 'Nep≈ô√≠tel', icon: 'üë§', hp: 50, damage: 10, defense: 5, xp: 20, loot: ['money'] };
                
                const isElite = hasEliteOnly || Math.random() < 0.15;
                
                enemyGroup.push({
                    ...enemyData,
                    id: enemyId + '_' + i,
                    hp: Math.floor(enemyData.hp * scaling * (isElite ? 2 : 1)),
                    maxHp: Math.floor(enemyData.hp * scaling * (isElite ? 2 : 1)),
                    damage: Math.floor(enemyData.damage * scaling * (isElite ? 1.5 : 1)),
                    defense: Math.floor(enemyData.defense * scaling * (isElite ? 1.3 : 1)),
                    xp: Math.floor(enemyData.xp * (1 + floor * 0.05) * (isElite ? 2.5 : 1)),
                    name: (isElite ? 'üíÄ ' : '') + enemyData.name,
                    isElite: isElite
                });
            }
            
            window.isAbyssCombat = true;
            startCombatWithGroup(enemyGroup, 'abyss');
        }
        
        function handleAbyssVictory() {
            const floor = state.abyss.currentFloor;
            
            // Loot - lep≈°√≠ s patrem
            const lootChance = 0.3 + (floor * 0.02);
            const possibleLoot = ['medkit', 'stimpack', 'radx', 'ammo_9mm', 'ammo_shell', 'money'];
            
            if (Math.random() < lootChance) {
                const lootId = possibleLoot[Math.floor(Math.random() * possibleLoot.length)];
                state.abyss.loot = state.abyss.loot || [];
                state.abyss.loot.push(lootId);
            }
            
            // Speci√°ln√≠ Abyss loot ka≈æd√Ωch 10 pater
            if (floor % 10 === 0) {
                state.abyss.loot.push('abyss_crystal');
                notifySuccess('üíé Abyss Krystal!', 'Vz√°cn√Ω drop z bosse!');
            }
            
            // Update max floor
            if (floor > (state.abyss.maxFloor || 0)) {
                state.abyss.maxFloor = floor;
                notifySuccess('üèÜ Nov√Ω rekord!', `Patro ${floor}!`);
            }
            
            // Pokraƒçuj na dal≈°√≠ patro
            state.abyss.currentFloor++;
            window.isAbyssCombat = false;
            
            setTimeout(() => showAbyssFloor(), 500);
        }
        
        function handleAbyssDefeat() {
            state.abyss.deaths = (state.abyss.deaths || 0) + 1;
            state.abyss.inProgress = false;
            
            const floor = state.abyss.currentFloor;
            const loot = state.abyss.loot || [];
            
            // P≈ôidej loot do invent√°≈ôe
            loot.forEach(itemId => {
                if (itemId === 'money') {
                    addMoney(50 + floor * 10);
                } else {
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) addItemToInventory(item, 1, true);
                }
            });
            
            window.isAbyssCombat = false;
            
            showModal('üíÄ P√°d do Temnoty', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">üíÄ</div>
                    <h3 style="color: #ff4444;">Propast tƒõ pohltila</h3>
                    <p style="color: #888;">Dos√°hl jsi patra ${floor}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #4caf50; margin: 0;">Zachr√°nƒõn√Ω loot: ${loot.length} item≈Ø</p>
                    </div>
                    
                    ${floor > (state.abyss.maxFloor || 0) - 1 ? '<p style="color: #ffd700;">üèÜ Nov√Ω osobn√≠ rekord!</p>' : ''}
                </div>
                <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; background: #555;">${'Pokraƒçovat'}</button>
            `);
        }
        
        function exitAbyss() {
            const loot = state.abyss.loot || [];
            const floor = state.abyss.currentFloor;
            
            // P≈ôidej loot do invent√°≈ôe
            loot.forEach(itemId => {
                if (itemId === 'money') {
                    addMoney(50 + floor * 10);
                } else {
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) addItemToInventory(item, 1, true);
                }
            });
            
            state.abyss.inProgress = false;
            window.isAbyssCombat = false;
            
            notifySuccess('Unikl jsi z Propasti!', `${loot.length} item≈Ø zachr√°nƒõno`);
            closeModal();
            renderFull();
        }
        
        function showAbyssLeaderboard() {
            // Jednoduch√Ω lok√°ln√≠ leaderboard (v budoucnu by mohl b√Ωt online)
            const myScore = state.abyss?.maxFloor || 0;
            
            showModal('üèÜ Propast - Leaderboard', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üèÜ</div>
                    <p style="color: #ffd700;">Tv≈Øj rekord: Patro ${myScore}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px;">
                    <h4 style="color: #9c27b0; margin: 0 0 0.5rem 0;">Miln√≠ky:</h4>
                    <div style="font-size: 0.85rem;">
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>ü•â Patro 10</span>
                            <span style="color: ${myScore >= 10 ? '#4caf50' : '#666'};">${myScore >= 10 ? '‚úì' : '‚úó'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>ü•à Patro 25</span>
                            <span style="color: ${myScore >= 25 ? '#4caf50' : '#666'};">${myScore >= 25 ? '‚úì' : '‚úó'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333;">
                            <span>ü•á Patro 50</span>
                            <span style="color: ${myScore >= 50 ? '#4caf50' : '#666'};">${myScore >= 50 ? '‚úì' : '‚úó'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0;">
                            <span>üëë Patro 100</span>
                            <span style="color: ${myScore >= 100 ? '#4caf50' : '#666'};">${myScore >= 100 ? '‚úì' : '‚úó'}</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="showAbyssEntrance()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }

        // === NPC VZTAHY ===
        function showNPCRelations() {
            state.npcRelations = state.npcRelations || {};
            
            // Filtruj jen NPC kter√© hr√°ƒç potkal (nav≈°t√≠vil jejich lokaci nebo jsou v npcMet)
            const metNPCs = FRIENDLY_NPCS.filter(npc => {
                // Kontrola jestli hr√°ƒç nav≈°t√≠vil lokaci NPC
                const npcLocation = npc.location;
                const visitedLocation = state.world?.visitedLocations?.includes(npcLocation);
                
                // Nebo je explicitnƒõ v npcMet
                const isInMet = state.mainQuest?.npcMet?.includes(npc.id);
                
                // Nebo m√° vztah (kv≈Øli zpƒõtn√© kompatibilitƒõ)
                const hasTrust = (state.npcRelations[npc.id]?.trust || 0) > 0;
                const hasGifts = (state.npcRelations[npc.id]?.gifts || 0) > 0;
                const hasQuests = (state.npcRelations[npc.id]?.quests || 0) > 0;
                const hasRelation = hasTrust || hasGifts || hasQuests;
                
                // Mus√≠≈° nav≈°t√≠vit lokaci NEBO m√≠t v npcMet NEBO u≈æ m√≠t vztah (zpƒõtn√° kompatibilita)
                return visitedLocation || isInMet || hasRelation;
            });
            
            if (metNPCs.length === 0) {
                showModal('üë• Vztahy s NPC', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë§</div>
                        <p style="color: #888;">Je≈°tƒõ jsi nepotkal ≈æ√°dn√© NPC.</p>
                        <p style="color: #666; font-size: 0.85rem;">${'Prozkoumej lokace a najdi p≈ô√°telsk√© p≈ôe≈æiv≈°√≠!'}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
                `);
                return;
            }
            
            const npcsHtml = metNPCs.map(npc => {
                const relation = state.npcRelations[npc.id] || { trust: 0, gifts: 0, quests: 0 };
                const trustLevelTexts = {
                    best: 'Nejlep≈°√≠ p≈ô√≠tel', good: 'Dobr√Ω p≈ô√≠tel', friend: 'P≈ô√≠tel', known: 'Zn√°m√Ω', stranger: 'Cizinec'
                };
                const trustLevel = relation.trust >= 100 ? trustLevelTexts.best : 
                                   relation.trust >= 75 ? trustLevelTexts.good :
                                   relation.trust >= 50 ? trustLevelTexts.friend :
                                   relation.trust >= 25 ? trustLevelTexts.known : trustLevelTexts.stranger;
                const trustColor = relation.trust >= 75 ? '#8bc34a' : 
                                   relation.trust >= 50 ? '#ffd700' :
                                   relation.trust >= 25 ? '#ff9800' : '#888';
                
                // Najdi n√°zev lokace
                const location = WORLD_LOCATIONS.find(l => l.id === npc.location);
                const locationName = location ? (location.name) : npc.location;
                
                return `
                    <div style="background: linear-gradient(135deg, #2a2a2a, #1a1a1a); padding: 1rem; border-radius: 8px; border: 2px solid ${trustColor}; cursor: pointer;" onclick="showNPCDetail('${npc.id}')">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2.5rem;">${npc.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #fff;">${npc.name}</div>
                                <div style="font-size: 0.75rem; color: #666;">üìç ${locationName}</div>
                                <div style="font-size: 0.8rem; color: ${trustColor};">${trustLevel}</div>
                                <div style="margin-top: 0.3rem; height: 6px; background: #1a1a1a; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${relation.trust}%; background: ${trustColor};"></div>
                                </div>
                            </div>
                            <div style="font-size: 1.2rem; color: ${trustColor};">‚ù§Ô∏è ${relation.trust}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            showModal('üë• Vztahy s NPC', `
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">
                    ${'Buduj vztahy s NPC - d√°vej dary, pl≈à jejich questy a odemkni speci√°ln√≠ odmƒõny!'}
                </p>
                <div style="display: grid; gap: 0.8rem; max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${npcsHtml}
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        // === BUƒåOVICE - HLAVN√ç MƒöSTO ===
        function showBucoviceWelcome() {
            // Kontrola jestli m√° v≈°echny komponenty pro fin√°le
            const hasAllComponents = ['plutonium_core', 'quantum_stabilizer', 'fusion_cell', 'ai_module'].every(
                compId => state.inv?.some(i => i.id === compId)
            );
            const hasEnding = state.storyKarma?.ending;
            
            let specialMessage = '';
            if (hasAllComponents && !hasEnding) {
                specialMessage = `
                    <div style="background: linear-gradient(135deg, #4a1a4a, #1a4a4a); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #ffd700;">
                        <div style="color: #ffd700; font-weight: bold; text-align: center;">‚ö†Ô∏è FIN√ÅLE P≈ò√çBƒöHU</div>
                        <p style="color: #aaa; font-size: 0.85rem; margin: 0.5rem 0; text-align: center;">
                            M√°≈° v≈°echny 4 komponenty Projektu Genesis!<br>
                            Oba brat≈ôi jsou zde a ƒçekaj√≠ na tv√© rozhodnut√≠.
                        </p>
                    </div>
                `;
            } else if (hasEnding) {
                const endingText = {
                    dark: 'üåë Temn√Ω konec - Kory zv√≠tƒõzil',
                    hope: 'üåÖ Konec nadƒõje - Koudy obnovuje svƒõt',
                    neutral: '‚öñÔ∏è Neutr√°ln√≠ - Projekt Genesis zniƒçen'
                };
                specialMessage = `
                    <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #4caf50;">
                        <div style="color: #4caf50; font-weight: bold; text-align: center;">üèÜ P≈ò√çBƒöH DOKONƒåEN</div>
                        <p style="color: #aaa; font-size: 0.85rem; margin: 0.3rem 0; text-align: center;">
                            ${endingText[hasEnding]}
                        </p>
                    </div>
                `;
            }
            
            showModal('üè∞ V√≠tej v Buƒçovic√≠ch!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">üè∞</div>
                    <p style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">Hlavn√≠ mƒõsto pustiny</p>
                    <p style="color: #888; font-size: 0.9rem;">Jedno z m√°la m√≠st, kter√© p≈ôe≈æilo apokalypsu vcelku.</p>
                </div>
                
                ${specialMessage}
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #fff; font-weight: bold; margin-bottom: 0.5rem;">üìç Co tu najde≈°:</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">üõí</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Tr≈æi≈°tƒõ - Obchody</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">üç∫</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Hospoda - J√≠dlo & drby</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">üè•</span>
                            <span style="color: #aaa; font-size: 0.85rem;">L√©ƒçitel - Zdrav√≠ & radiace</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">üìú</span>
                            <span style="color: #aaa; font-size: 0.85rem;">N√°stƒõnka - Denn√≠ √∫koly</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">üí§</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Hotel - Odpoƒçinek</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.4rem;">
                            <span style="font-size: 1.2rem;">üîç</span>
                            <span style="color: #aaa; font-size: 0.85rem;">Ulice - Prohledat</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #0a1a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #8bc34a; font-size: 0.85rem; margin: 0; text-align: center;">
                        üí° Tip: V hospodƒõ m≈Ø≈æe≈° poslouchat drby a dozvƒõdƒõt se u≈æiteƒçn√© informace o svƒõtƒõ!
                    </p>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: linear-gradient(135deg, #4a3a2a, #3a2a1a); border: 1px solid #8b7355;">
                    üö∂ Vej√≠t do mƒõsta
                </button>
            `);
        }
        
        function openBucoviceMarket() {
            // Speci√°ln√≠ obchod s lep≈°√≠m zbo≈æ√≠m
            showModal('üè∞ Tr≈æi≈°tƒõ Buƒçovic', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üõí</div>
                    <p style="color: #888;">Nejvƒõt≈°√≠ tr≈æi≈°tƒõ v cel√© pustinƒõ. Najde≈° tu v≈°e, co pot≈ôebuje≈°.</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal(); openShop();" style="background: var(--rust-light);">
                        üõí Obecn√Ω obchod
                    </button>
                    <button class="btn" onclick="openBucoviceWeaponShop();" style="background: #c62828;">
                        ‚öîÔ∏è Zbroj√≠≈ô
                    </button>
                    <button class="btn" onclick="openBucoviceArmorShop();" style="background: #1565c0;">
                        üõ°Ô∏è Kov√°≈ô
                    </button>
                    <button class="btn" onclick="openBucoviceToolShop();" style="background: #7b1fa2;">
                        üîß N√°stroj√°≈ô
                    </button>
                    <button class="btn" onclick="openBucoviceMedicShop();" style="background: #2e7d32;">
                        üíä L√©k√°rna
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>
            `);
        }
        
        function openBucoviceToolShop() {
            const tools = ITEMS.filter(i => i.type === 'tool' && i.price > 0);
            showModal('üîß N√°stroj√°≈ô', `
                <div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${tools.map(item => {
                        const price = calculateItemPrice(item.price);
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <span>${item.icon} ${item.name}</span>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} üí∞</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">üí∞ Tv√© pen√≠ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function openBucoviceWeaponShop() {
            const weapons = ITEMS.filter(i => i.type === 'weapon' && i.price > 0 && !i.cantBuy);
            showModal('‚öîÔ∏è Zbroj√≠≈ô', `
                <p style="color: #888; font-size: 0.85rem; text-align: center; margin-bottom: 0.5rem;">Specializovan√Ω obchod se zbranƒõmi</p>
                <div style="max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${weapons.sort((a, b) => a.price - b.price).map(item => {
                        const price = calculateItemPrice(item.price);
                        let desc = `${item.damage || 0} DMG`;
                        if (item.ammoType) desc += ` | üî∏${getAmmoName(item.ammoType)}`;
                        if (item.critChance) desc += ` | üí•${Math.round(item.critChance * 100)}%`;
                        if (item.range) desc += ` | üìè${item.range}m`;
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <div style="flex: 1;">
                                <div>${item.icon} ${item.name}</div>
                                <div style="font-size: 0.7rem; color: #8bc34a;">‚öîÔ∏è ${desc}</div>
                            </div>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} üí∞</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">üí∞ Tv√© pen√≠ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function openBucoviceArmorShop() {
            const armors = ITEMS.filter(i => (i.type === 'armor' || i.type === 'gloves' || i.type === 'boots' || i.type === 'helmet') && i.price > 0 && !i.cantBuy);
            showModal('üõ°Ô∏è Kov√°≈ô', `
                <p style="color: #888; font-size: 0.85rem; text-align: center; margin-bottom: 0.5rem;">Specializovan√Ω obchod se zbroj√≠</p>
                <div style="max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${armors.sort((a, b) => a.price - b.price).map(item => {
                        const price = calculateItemPrice(item.price);
                        let desc = `${item.defense || 0} DEF`;
                        if (item.radiation) desc += ` | ‚ò¢Ô∏è-${item.radiation}`;
                        if (item.hp) desc += ` | ‚ù§Ô∏è+${item.hp}`;
                        if (item.stealth) desc += ` | ü•∑+${item.stealth}`;
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <div style="flex: 1;">
                                <div>${item.icon} ${item.name}</div>
                                <div style="font-size: 0.7rem; color: #8bc34a;">üõ°Ô∏è ${desc}</div>
                            </div>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} üí∞</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">üí∞ Tv√© pen√≠ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function openBucoviceMedicShop() {
            const meds = ITEMS.filter(i => i.type === 'consumable' && i.price > 0 && !i.cantBuy && 
                (i.effect === 'health' || i.effect === 'radiation' || i.id.includes('med') || i.id.includes('rad') || i.id.includes('stim') || i.id.includes('antidote')));
            showModal('üíä L√©k√°rna', `
                <p style="color: #888; font-size: 0.85rem; text-align: center; margin-bottom: 0.5rem;">Specializovan√Ω obchod s l√©ƒçivy</p>
                <div style="max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${meds.sort((a, b) => a.price - b.price).map(item => {
                        const price = calculateItemPrice(item.price);
                        let desc = '';
                        if (item.effect === 'health') desc = `‚ù§Ô∏è +${item.value} HP`;
                        else if (item.effect === 'radiation') desc = `‚ò¢Ô∏è -${Math.abs(item.value)} rad`;
                        else desc = item.desc || '';
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; margin-bottom: 0.3rem; border-radius: 4px;">
                            <div style="flex: 1;">
                                <div>${item.icon} ${item.name}</div>
                                <div style="font-size: 0.7rem; color: #8bc34a;">${desc}</div>
                            </div>
                            <button class="btn" onclick="showBuyDialog('${item.id}')" style="padding: 0.3rem 0.6rem; ${getMoney() >= price ? '' : 'opacity: 0.5;'}">${price} üí∞</button>
                        </div>
                    `}).join('')}
                </div>
                <p style="color: #ffd700; text-align: center; margin-top: 0.5rem;">üí∞ Tv√© pen√≠ze: ${getMoney()}</p>
                <button class="btn" onclick="openBucoviceMarket()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function visitBucoviceTavern() {
            showModal('üç∫ Hospoda "U Star√©ho Bunkru"', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üç∫</div>
                    <p style="color: #888; font-style: italic;">"Co to bude, cizinƒçe?"</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #aaa; font-size: 0.85rem; margin: 0;">
                        Hostinsk√Ω se naklon√≠ bl√≠≈æ: "Sly≈°el jsem, ≈æe se v okol√≠ pohybuj√≠ dva divn√≠ chl√°pci. 
                        Jeden mluv√≠ o oƒçistƒõ svƒõta, druh√Ω o z√°chranƒõ. Oba hledaj√≠ nƒõjak√© komponenty... 
                        D√°vej si na nƒõ pozor."
                    </p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="buyDrink()" style="background: #8D6E63;">
                        üç∫ Pivo (5 üí∞) - Dopln√≠ 10 energie
                    </button>
                    <button class="btn" onclick="buyMeal()" style="background: #6D4C41;">
                        üçñ J√≠dlo (15 üí∞) - Dopln√≠ 30 j√≠dla
                    </button>
                    <button class="btn" onclick="listenToRumors()" style="background: #5D4037;">
                        üëÇ Poslouchat drby (zdarma)
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Odej√≠t</button>
            `);
        }
        
        function buyDrink() {
            if (getMoney() < 5) {
                notifyError('M√°lo penƒõz!', 'Pot≈ôebuje≈° 5 üí∞');
                return;
            }
            removeMoney(5);
            state.status.energy = Math.min((state.status.energy || 0) + 10, 100);
            notifySuccess('üç∫ Na zdrav√≠!', '+10 energie');
            renderFull();
            visitBucoviceTavern();
        }
        
        function buyMeal() {
            if (getMoney() < 15) {
                notifyError('M√°lo penƒõz!', 'Pot≈ôebuje≈° 15 üí∞');
                return;
            }
            removeMoney(15);
            state.status.hunger = Math.min((state.status.hunger || 0) + 30, 100);
            notifySuccess('üçñ Dobr√© j√≠dlo!', '+30 sytost');
            renderFull();
            visitBucoviceTavern();
        }
        
        function listenToRumors() {
            const rumors = [
                "\"Vojensk√° z√°kladna na severu je pln√° robot≈Ø, ale taky tam maj nejlep≈°√≠ zbranƒõ...\"",
                "\"Sly≈°el jsem, ≈æe v tajn√Ω laborato≈ôi na z√°padƒõ experimentovali s nƒõƒç√≠m dƒõsiv√Ωm.\"",
                "\"Ti dva brat≈ôi? Kory s√≠dl√≠ v Trading Postu, Koudy se schov√°v√° ve v√Ωzkumn√Ωm za≈ô√≠zen√≠.\"",
                "\"Projekt Genesis pr√Ω m≈Ø≈æe buƒè zachr√°nit nebo zniƒçit svƒõt. Z√°le≈æ√≠ kdo ho ovl√°dne.\"",
                "\"Star√Ω bunkr na v√Ωchodƒõ? Tam to v≈°echno zaƒçalo. Tam je odpovƒõƒè na v≈°echny ot√°zky.\"",
                "\"D√°vej si pozor na mutanty v ba≈æin√°ch. Ale prej tam maj vz√°cn√Ω loot.\"",
                "\"Karavany jezd√≠ ƒçastƒõji kdy≈æ m√°≈° r√°dio. Staƒç√≠ je p≈ôivolat.\"",
                "\"Elektr√°rna je nebezpeƒçn√°, ale je tam nƒõco d≈Øle≈æit√©ho pro ten jejich projekt.\""
            ];
            
            const rumor = rumors[Math.floor(Math.random() * rumors.length)];
            
            showModal('üëÇ Drby z hospody', `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #aaa; font-style: italic; margin: 0;">${rumor}</p>
                </div>
                <button class="btn" onclick="visitBucoviceTavern()" style="width: 100%; background: #555;">‚Üê Zpƒõt do hospody</button>
            `);
        }
        
        // === üé≤ KASINO SYST√âM ===
        
        function showCasino() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            showCasinoIntro();
        }
        
        // === PRAVIDLA HER ===
        function showGameRules(game) {
            const rulesCS = {
                highlow: {
                    title: 'üé≤ Vy≈°≈°√≠ / Ni≈æ≈°√≠ - Pravidla',
                    content: `<p><b>C√≠l:</b> Uhodne≈° souƒçet dvou kostek?</p><p><b>Jak hr√°t:</b></p><ul style="margin: 0.5rem 0; padding-left: 1.2rem;"><li>Zvol s√°zku</li><li>Tipni jestli souƒçet bude ni≈æ≈°√≠ (2-5), p≈ôesnƒõ 7, nebo vy≈°≈°√≠ (9-12)</li><li>‚ö†Ô∏è 6 a 8 = prohra (house edge)!</li></ul><p><b>V√Ωplaty:</b> Ni≈æ≈°√≠/Vy≈°≈°√≠: 2x, P≈ôesnƒõ 7: 5x</p>`
                },
                poker: {
                    title: 'üé≤ Poker Dice - Pravidla',
                    content: `<p><b>C√≠l:</b> Z√≠skej co nejlep≈°√≠ kombinaci s 5 kostkami.</p><p><b>Jak hr√°t:</b> M√°≈° 3 hody. Klikni na kostku pro zamknut√≠.</p><p><b>V√Ωplaty:</b> Dva p√°ry: 1x, Trojice: 1.5x, Full House: 3x, ƒåtve≈ôice: 6x, Postupka: 10-25x, Pƒõtice: 30x</p>`
                },
                slots: {
                    title: 'üçí Automaty - Pravidla',
                    content: `<p><b>C√≠l:</b> Z√≠skej 3 stejn√© symboly.</p><p><b>Jak hr√°t:</b> Zvol s√°zku, klikni Zatoƒçit.</p><p><b>V√Ωplaty (3 stejn√©):</b> üçí=8x, üçã=12x, ‚≠ê=18x, üçÄ=25x, üíé=40x, 7Ô∏è‚É£=60x</p><p style="color:#888;">≈†ance na trojici: ~2.8%</p>`
                },
                blackjack: {
                    title: 'üÉè Blackjack - Pravidla',
                    content: `<p><b>C√≠l:</b> Z√≠skej souƒçet co nejbl√≠≈æe 21, nep≈ôekroƒç!</p><p><b>Hodnoty:</b> 2-10=nomin√°l, J/Q/K=10, A=1 nebo 11</p><p><b>Hit</b>=dal≈°√≠ karta, <b>Stand</b>=st√°t</p><p><b>V√Ωplaty:</b> V√Ωhra: 2x, Blackjack: 2.5x</p>`
                },
                wheel: {
                    title: 'üé° Kolo ≈°tƒõst√≠ - Pravidla',
                    content: `<p><b>C√≠l:</b> Doufej ≈æe ≈°ipka uk√°≈æe na v√Ωhern√≠ sektor!</p><p><b>Sektory:</b> üíÄ(prohra)-8ks, 1.5x, 2x, 3x, 4x</p><p style="color:#f44336;">‚ö†Ô∏è 67% ≈°ance na prohru!</p>`
                },
                war: {
                    title: '‚öîÔ∏è War - Pravidla',
                    content: `<p><b>C√≠l:</b> Tv√° karta mus√≠ b√Ωt vy≈°≈°√≠ ne≈æ dealerova.</p><p><b>Hodnoty:</b> 2<3<...<K<A</p><p><b>V√Ωhra:</b> 2x s√°zka. Rem√≠za = dealer vyhr√°v√°.</p>`
                },
                craps: {
                    title: 'üé≤ Craps - Pravidla',
                    content: `<p><b>Pass Line:</b> 7/11=v√Ωhra, 2/3/12=prohra, jin√©=Point</p><p><b>Point:</b> Hoƒè Point=v√Ωhra, 7=prohra</p><p><b>V√Ωhra:</b> 2x s√°zka</p>`
                },
                keno: {
                    title: 'üî¢ Keno - Pravidla',
                    content: `<p><b>C√≠l:</b> Uhodni co nejv√≠ce ƒç√≠sel.</p><p><b>Jak:</b> Vyber 1-10 ƒç√≠sel, losuje se 10.</p><p><b>V√Ωplaty:</b> 5 tref=2x, 6=5x, 7=20x, 8=100x, 10=2000x</p>`
                }
            };
            const rulesEN = {
                highlow: {
                    title: 'üé≤ Higher / Lower - Rules',
                    content: `<p><b>Goal:</b> Guess the sum of two dice!</p><p><b>How to play:</b></p><ul style="margin: 0.5rem 0; padding-left: 1.2rem;"><li>Choose bet</li><li>Guess if sum will be lower, exactly 7, or higher</li></ul><p><b>Payouts:</b> Lower/Higher: 2x, Exactly 7: 5x</p>`
                },
                poker: {
                    title: 'üé≤ Poker Dice - Rules',
                    content: `<p><b>Goal:</b> Get the best combination with 5 dice.</p><p><b>How to play:</b> You have 3 rolls. Click dice to lock.</p><p><b>Payouts:</b> Two pairs: 1x, Three of a kind: 1.5x, Full House: 3x, Four of a kind: 6x, Straight: 10-25x, Five of a kind: 30x</p>`
                },
                slots: {
                    title: 'üçí Slots - Rules',
                    content: `<p><b>Goal:</b> Get 3 matching symbols.</p><p><b>How to play:</b> Choose bet, click Spin.</p><p><b>Payouts (3 same):</b> üçí=8x, üçã=12x, ‚≠ê=18x, üçÄ=25x, üíé=40x, 7Ô∏è‚É£=60x</p><p style="color:#888;">Triple chance: ~2.8%</p>`
                },
                blackjack: {
                    title: 'üÉè Blackjack - Rules',
                    content: `<p><b>Goal:</b> Get as close to 21 as possible, don't bust!</p><p><b>Values:</b> 2-10=face, J/Q/K=10, A=1 or 11</p><p><b>Hit</b>=draw card, <b>Stand</b>=stay</p><p><b>Payouts:</b> Win: 2x, Blackjack: 2.5x</p>`
                },
                wheel: {
                    title: 'üé° Wheel of Fortune - Rules',
                    content: `<p><b>Goal:</b> Hope the arrow lands on a winning sector!</p><p><b>Sectors:</b> üíÄ(lose)-8pcs, 1.5x, 2x, 3x, 4x</p><p style="color:#f44336;">‚ö†Ô∏è 67% chance to lose!</p>`
                },
                war: {
                    title: '‚öîÔ∏è War - Rules',
                    content: `<p><b>Goal:</b> Your card must be higher than dealer's.</p><p><b>Values:</b> 2<3<...<K<A</p><p><b>Win:</b> 2x bet. Tie = dealer wins.</p>`
                },
                craps: {
                    title: 'üé≤ Craps - Rules',
                    content: `<p><b>Pass Line:</b> 7/11=win, 2/3/12=lose, other=Point</p><p><b>Point:</b> Roll Point=win, 7=lose</p><p><b>Win:</b> 2x bet</p>`
                },
                keno: {
                    title: 'üî¢ Keno - Rules',
                    content: `<p><b>Goal:</b> Guess as many numbers as possible.</p><p><b>How:</b> Pick 1-10 numbers, 10 are drawn.</p><p><b>Payouts:</b> 5 hits=2x, 6=5x, 7=20x, 8=100x, 10=2000x</p>`
                }
            };
            
            const rules = rulesCS;
            const r = rules[game];
            if (!r) return;
            
            const backText = 'ZPƒöT KE H≈òE';
            showModal(r.title, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; max-height: 350px; overflow-y: auto; -webkit-overflow-scrolling: touch; font-size: 0.85rem;">
                    ${r.content}
                </div>
                <button class="btn" onclick="closeModal(); showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${backText}</button>
            `);
        }
        
        function showCasinoIntro() {
            const introTexts = {
                welcome: '"V√≠tej, poutn√≠ƒçe pustiny!"',
                desc: 'Tohle kasino je tu pro chv√≠le, kdy zrovna sed√≠≈° na tr≈Ønu, ƒçek√°≈° na autobus, nebo prostƒõ pot≈ôebuje≈° prokrastinovat. Nen√≠ to hlavn√≠ hra - je to <span style="color: #ffd700;">bonus pro chv√≠le nudy</span>.',
                whatAwaits: 'üé≤ Co tƒõ ƒçek√°:',
                higherLower: '<b>Vy≈°≈°√≠/Ni≈æ≈°√≠</b> - Tipni souƒçet kostek.',
                pokerDice: '<b>Poker Dice</b> - 5 kostek, 3 hody.',
                slots: '<b>Automaty</b> - Toƒç a doufej.',
                blackjack: '<b>Blackjack</b> - Klasika. 21 nebo bankrot.',
                wheel: '<b>Kolo ≈°tƒõst√≠</b> - Roztoƒç√≠≈°, kam dopadne?',
                war: '<b>War</b> - Tv√° karta vs dealer.',
                craps: '<b>Craps</b> - Klasick√© kasinov√© kostky.',
                keno: '<b>Keno</b> - Vyber ƒç√≠sla a ƒçekej na losov√°n√≠.',
                pawn: '<b>≈†mejd</b> - Vykoup√≠ tv≈Øj haramp√°d√≠.',
                warning: '‚ö†Ô∏è Varov√°n√≠: D≈Øm v≈ædycky vyhr√°v√°. V≈ædycky. Hraj zodpovƒõdnƒõ.',
                enter: 'üé∞ Vstoupit do kasina',
                leave: 'üö™ Rad≈°i ne, m√°m rozum'
            };
            
            showModal('üé∞ WASTELAND CASINO', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üé∞üöΩüé≤</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a1a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ffd70040;">
                    <p style="color: #ffd700; font-style: italic; margin: 0 0 0.5rem 0; text-align: center;">
                        ${introTexts.welcome}
                    </p>
                    <p style="color: #aaa; font-size: 0.85rem; margin: 0;">
                        ${introTexts.desc}
                    </p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0; font-size: 0.9rem;">${introTexts.whatAwaits}</h4>
                    <div style="font-size: 0.75rem; color: #aaa;">
                        <p style="margin: 0.3rem 0;">üé≤ ${introTexts.higherLower}</p>
                        <p style="margin: 0.3rem 0;">üé≤ ${introTexts.pokerDice}</p>
                        <p style="margin: 0.3rem 0;">üçí ${introTexts.slots}</p>
                        <p style="margin: 0.3rem 0;">üÉè ${introTexts.blackjack}</p>
                        <p style="margin: 0.3rem 0;">üé° ${introTexts.wheel}</p>
                        <p style="margin: 0.3rem 0;">‚öîÔ∏è ${introTexts.war}</p>
                        <p style="margin: 0.3rem 0;">üé≤ ${introTexts.craps}</p>
                        <p style="margin: 0.3rem 0;">üî¢ ${introTexts.keno}</p>
                        <p style="margin: 0.3rem 0;">ü§µ ${introTexts.pawn}</p>
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f4433640;">
                    <p style="color: #f44336; font-size: 0.75rem; margin: 0; text-align: center;">
                        ${introTexts.warning}
                    </p>
                </div>
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%); color: #000; font-weight: bold; padding: 0.8rem;">
                    ${introTexts.enter}
                </button>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                    ${introTexts.leave}
                </button>
            `);
        }
        
        function showCasinoMain() {
            consolidateInventory();
            
            const tokens = getCasinoTokens();
            const balance = (state.casinoStats?.totalWon || 0) - (state.casinoStats?.totalLost || 0);
            
            // Kontrola bonusu podle re√°ln√©ho ƒçasu (24 hodin)
            const now = Date.now();
            const lastTokenTime = state.casinoLastTokenTime || 0;
            const oneDayMs = 24 * 60 * 60 * 1000;
            const gotTodayBonus = (now - lastTokenTime) < oneDayMs;
            
            // Spoƒç√≠tej ƒças do dal≈°√≠ho bonusu
            let timeToBonus = '';
            if (gotTodayBonus) {
                const msLeft = oneDayMs - (now - lastTokenTime);
                const hoursLeft = Math.floor(msLeft / (60 * 60 * 1000));
                const minsLeft = Math.floor((msLeft % (60 * 60 * 1000)) / (60 * 1000));
                timeToBonus = `Reset za ${hoursLeft}h ${minsLeft}m`;
            }
            
            const casinoTexts = {
                tokens: 'kasinov√© ≈æetony',
                dailyBonus: 'Denn√≠ bonus:',
                claimed: '‚úì Z√≠sk√°no',
                ready: '+1000 üé´ p≈ôipraveno!',
                claim: 'Vyzvednout!',
                exchange: 'Smƒõn√°rna:',
                exchangeBtn: 'Vymƒõnit',
                odds: '‚ö†Ô∏è ≈†ance casina: 55% | Tvoje ≈°ance: 45%',
                higherLower: 'Vy≈°≈°√≠/Ni≈æ≈°√≠',
                pokerDice: 'Poker Dice',
                slots: 'Automaty',
                blackjack: 'Blackjack',
                wheelOfFortune: 'Kolo ≈°tƒõst√≠',
                war: 'War',
                craps: 'Craps',
                keno: 'Keno',
                pawnShop: '≈†mejd - Rychl√Ω v√Ωkup (za üí∞)',
                wins: 'V√Ωhry',
                losses: 'Prohry',
                balance: 'Bilance',
                info: 'Info',
                close: 'Zav≈ô√≠t'
            };
            
            showModal('üé∞ WASTELAND CASINO', `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <div style="font-size: 2rem;">üé∞üé≤üÉè</div>
                    <p style="color: #9c27b0; font-weight: bold; font-size: 1.3rem;">${tokens} üé´</p>
                    <p style="color: #888; font-size: 0.7rem;">${casinoTexts.tokens}</p>
                </div>
                
                <!-- INFO BOX -->
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 0.6rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #9c27b040;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">
                        <div style="font-size: 0.75rem;">
                            <span style="color: #ce93d8;">üìÖ ${casinoTexts.dailyBonus}</span>
                            <span style="color: ${gotTodayBonus ? '#888' : '#ffd700'};">${gotTodayBonus ? `${casinoTexts.claimed} (${timeToBonus})` : casinoTexts.ready}</span>
                        </div>
                        ${!gotTodayBonus ? `<button class="btn" onclick="checkDailyCasinoTokens(); showCasinoMain();" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); padding: 0.2rem 0.5rem; font-size: 0.7rem; color: #000; font-weight: bold;">${casinoTexts.claim}</button>` : ''}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.75rem;">
                            <span style="color: #ce93d8;">üí± ${casinoTexts.exchange}</span>
                            <span style="color: #aaa;">5000 üé´ ‚Üí 200 üí∞</span>
                        </div>
                        <button class="btn" onclick="if(exchangeTokensForMoney()) showCasinoMain();" style="background: ${tokens >= 5000 ? 'linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%)' : '#333'}; padding: 0.3rem 0.6rem; font-size: 0.7rem;" ${tokens >= 5000 ? '' : 'disabled'}>
                            ${casinoTexts.exchangeBtn}
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                    <button class="btn" onclick="showHighLowGame()" style="background: linear-gradient(135deg, #1a5a1a 0%, #2d8a2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">üé≤üé≤</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.higherLower}</div>
                    </button>
                    <button class="btn" onclick="showKeno()" style="background: linear-gradient(135deg, #3a3a1a 0%, #5a5a2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">üî¢</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.keno}</div>
                    </button>
                    ${isAdmin() ? `
                    <button class="btn" onclick="showPokerDice()" style="background: linear-gradient(135deg, #5a1a5a 0%, #8a2d8a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">üé≤üé≤üé≤</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.pokerDice}</div>
                    </button>
                    <button class="btn" onclick="showSlotMachine()" style="background: linear-gradient(135deg, #5a5a1a 0%, #8a8a2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">üçíüçãüçÄ</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.slots}</div>
                    </button>
                    <button class="btn" onclick="showBlackjack()" style="background: linear-gradient(135deg, #1a1a5a 0%, #2d2d8a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">üÉè‚ô†Ô∏è</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.blackjack}</div>
                    </button>
                    <button class="btn" onclick="showWheelOfFortune()" style="background: linear-gradient(135deg, #5a1a3a 0%, #8a2d5a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">üé°</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.wheelOfFortune}</div>
                    </button>
                    <button class="btn" onclick="showWarGame()" style="background: linear-gradient(135deg, #3a1a1a 0%, #5a2d2d 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">‚öîÔ∏èüÉè</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.war}</div>
                    </button>
                    <button class="btn" onclick="showCraps()" style="background: linear-gradient(135deg, #1a3a3a 0%, #2d5a5a 100%); padding: 0.5rem;">
                        <div style="font-size: 1.3rem;">üé≤üé≤</div>
                        <div style="font-weight: bold; font-size: 0.7rem;">${casinoTexts.craps}</div>
                    </button>
                    ` : `
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">üîí</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Poker Dice</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">üîí</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Automaty</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">üîí</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Blackjack</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">üîí</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Kolo ≈°tƒõst√≠</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">üîí</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">V√°lka</div>
                    </button>
                    <button class="btn" disabled style="background: #222; padding: 0.5rem; opacity: 0.5; cursor: not-allowed;">
                        <div style="font-size: 1.3rem;">üîí</div>
                        <div style="font-weight: bold; font-size: 0.65rem; color: #666;">Craps</div>
                    </button>
                    `}
                    <p style="grid-column: span 3; color: #666; font-size: 0.7rem; text-align: center; margin: 0.3rem 0 0 0;">üîß Dal≈°√≠ hry budou brzy dostupn√©!</p>
                </div>
                
                <button class="btn" onclick="showCasinoPawnShop()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #5a3a1a 0%, #8a5a2d 100%); padding: 0.5rem;">
                    <span style="font-size: 1rem;">ü§µ</span> <span style="font-weight: bold; font-size: 0.85rem;">${casinoTexts.pawnShop}</span>
                </button>
                
                <div style="margin-top: 0.5rem; padding: 0.3rem; background: #1a1a1a; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-around; text-align: center; font-size: 0.65rem;">
                        <div><span style="color: #4caf50;">${state.casinoStats?.totalWon || 0}</span><br><span style="color: #888;">${casinoTexts.wins} üé´</span></div>
                        <div><span style="color: #f44336;">${state.casinoStats?.totalLost || 0}</span><br><span style="color: #888;">${casinoTexts.losses} üé´</span></div>
                        <div><span style="color: ${balance >= 0 ? '#9c27b0' : '#f44336'};">${balance >= 0 ? '+' : ''}${balance}</span><br><span style="color: #888;">${casinoTexts.balance}</span></div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button class="btn" onclick="showCasinoIntro()" style="flex: 1; background: #333; font-size: 0.7rem;">‚ùì ${casinoTexts.info}</button>
                    <button class="btn" onclick="closeModal()" style="flex: 2; background: #555;">‚úï ${casinoTexts.close}</button>
                </div>
            `);
        }
        
        // === ≈†MEJD - RYCHL√ù V√ùKUP ===
        function showCasinoPawnShop() {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            
            const pawnTexts = {
                quote: '"Vykoup√≠m cokoliv, ≈æ√°dn√Ω ot√°zky..."',
                tokens: '≈Ωetony', items: 'P≈ôedmƒõty:', resources: 'Suroviny:',
                noItems: '≈Ω√°dn√© vƒõci k prodeji', sellAll: 'Prodat V≈†E', back: 'Casino', each: 'ks'
            };
            
            let itemsHtml = '';
            // Projdi v≈°echny itemy a zapamatuj si jejich SKUTEƒåN√ù index
            const sellableItems = [];
            state.inv.forEach((item, realIndex) => {
                // Neprod√°vej quest itemy a vybaven√© vƒõci
                if (item.quest) return;
                if (state.equipped?.weapon?.id === item.id) return;
                if (state.equipped?.armor?.id === item.id) return;
                sellableItems.push({ item, realIndex });
            });
            
            if (sellableItems.length > 0) {
                itemsHtml = '<div style="max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 0.5rem;">';
                sellableItems.forEach(({ item, realIndex }) => {
                    const basePrice = item.price || item.traderPrice || 20;
                    const sellPrice = Math.floor(basePrice * 0.5);
                    const qty = item.quantity || 1;
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #222; margin: 0.3rem 0; border-radius: 6px; gap: 0.5rem;">
                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.icon || 'üì¶'} ${getItemName(item.id) || item.name} ${qty > 1 ? '('+qty+')' : ''}</span>
                            <button class="btn" onclick="sellToPawnShop('item', ${realIndex})" style="background: #4caf50; padding: 0.4rem 0.8rem; font-size: 0.8rem; min-width: 70px;">
                                ${sellPrice * qty} üé´
                            </button>
                        </div>
                    `;
                });
                itemsHtml += '</div>';
            } else {
                itemsHtml = `<p style="color: #888; text-align: center; font-size: 0.85rem;">${pawnTexts.noItems}</p>`;
            }
            
            let resourcesHtml = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem;">';
            Object.entries(state.resources || {}).forEach(([res, amount]) => {
                if (amount > 0 && resourceValues[res]) {
                    const icons = { wood: 'ü™µ', metal: 'üî©', cloth: 'üßµ', electronics: 'üîå', chemicals: 'üß™', glass: 'üîÆ', food: 'ü•´', water: 'üíß', meds: 'üíä', fuel: '‚õΩ' };
                    const sellPrice = Math.floor(resourceValues[res] * 0.5);
                    resourcesHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; background: #222; border-radius: 6px; font-size: 0.85rem;">
                            <span>${icons[res] || 'üì¶'} ${amount}</span>
                            <button class="btn" onclick="sellToPawnShop('resource', '${res}')" style="background: #ff9800; padding: 0.3rem 0.5rem; font-size: 0.75rem;">
                                ${sellPrice}üé´/${pawnTexts.each}
                            </button>
                        </div>
                    `;
                }
            });
            resourcesHtml += '</div>';
            
            showModal('ü§µ ≈†MEJD - V√ùKUP', `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <div style="font-size: 2rem;">ü§µüé´üíµ</div>
                    <p style="color: #888; font-size: 0.8rem; font-style: italic;">${pawnTexts.quote}</p>
                    <p style="color: #ffd700;">${pawnTexts.tokens}: ${getCasinoTokens()} üé´</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #ff9800; font-size: 0.85rem;">üì¶ ${pawnTexts.items}</h4>
                    ${itemsHtml}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0 0 0.3rem 0; color: #ff9800; font-size: 0.85rem;">üß± ${pawnTexts.resources}</h4>
                    ${resourcesHtml}
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="sellAllToPawnShop()" style="flex: 1; background: #c62828; padding: 0.6rem; font-weight: bold;">
                        üí∏ ${pawnTexts.sellAll}
                    </button>
                    <button class="btn" onclick="showCasino()" style="flex: 1; background: #555; padding: 0.6rem;">
                        ‚Üê ${pawnTexts.back}
                    </button>
                </div>
            `);
        }
        
        function sellToPawnShop(type, identifier) {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            const icons = { wood: 'ü™µ', metal: 'üî©', cloth: 'üßµ', electronics: 'üîå', chemicals: 'üß™', glass: 'üîÆ', food: 'ü•´', water: 'üíß', meds: 'üíä', fuel: '‚õΩ' };
            
            let itemName = '';
            let sellPrice = 0;
            let itemIcon = 'üì¶';
            
            if (type === 'item') {
                const idx = parseInt(identifier);
                const item = state.inv[idx];
                if (!item) return;
                
                const basePrice = item.price || item.traderPrice || 20;
                sellPrice = Math.floor(basePrice * 0.5) * (item.quantity || 1);
                itemName = getItemName(item.id) || item.name;
                itemIcon = item.icon || 'üì¶';
            } else if (type === 'resource') {
                const res = identifier;
                const amount = state.resources[res] || 0;
                if (amount <= 0) return;
                
                sellPrice = Math.floor(resourceValues[res] * 0.5) * amount;
                itemName = `${amount}x ${res}`;
                itemIcon = icons[res] || 'üì¶';
            }
            
            // Zobraz potvrzen√≠
            showModal('‚ö†Ô∏è Potvrdit prodej', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${itemIcon}</div>
                    <p style="color: #ff9800; font-size: 1.1rem; margin-bottom: 0.5rem;">${'Opravdu prodat?'}</p>
                    <p style="color: #fff; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">${itemName}</p>
                    <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                        <span style="color: #888;">${'Dostane≈°:'}</span>
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;">+${sellPrice} üé´</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="showCasinoPawnShop()" style="flex: 1; background: #555; padding: 0.7rem; font-size: 1rem;">‚Üê ${'Zru≈°it'}</button>
                        <button class="btn" onclick="confirmSellToPawnShop('${type}', '${identifier}')" style="flex: 1; background: #c62828; padding: 0.7rem; font-size: 1rem;">üóëÔ∏è ${'Prodat'}</button>
                    </div>
                </div>
            `);
        }
        
        function confirmSellToPawnShop(type, identifier) {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            
            if (type === 'item') {
                const idx = parseInt(identifier);
                const item = state.inv[idx];
                if (!item) return;
                
                const basePrice = item.price || item.traderPrice || 20;
                const sellPrice = Math.floor(basePrice * 0.5);
                const qty = item.quantity || 1;
                const total = sellPrice * qty;
                
                addCasinoTokens(total);
                state.inv.splice(idx, 1);
                
                const humor = getRandomHumor('pawnShop');
                notifySuccess(`+${total} üí∞`, humor);
            } else if (type === 'resource') {
                const res = identifier;
                const amount = state.resources[res] || 0;
                if (amount <= 0) return;
                
                const sellPrice = Math.floor(resourceValues[res] * 0.5);
                const total = sellPrice * amount;
                
                addCasinoTokens(total);
                state.resources[res] = 0;
                
                const humor = getRandomHumor('pawnShop');
                notifySuccess(`+${total} üí∞`, humor);
            }
            
            saveGame(true);
            renderFull();
            showCasinoPawnShop();
        }
        
        function sellAllToPawnShop() {
            const resourceValues = {
                wood: 2, metal: 3, cloth: 2, electronics: 8, chemicals: 5, glass: 3, food: 2, water: 2, meds: 10, fuel: 5
            };
            
            let total = 0;
            
            // Prodej v≈°echny suroviny
            Object.entries(state.resources || {}).forEach(([res, amount]) => {
                if (amount > 0 && resourceValues[res]) {
                    const sellPrice = Math.floor(resourceValues[res] * 0.5);
                    total += sellPrice * amount;
                    state.resources[res] = 0;
                }
            });
            
            // Prodej v≈°echny prodejn√© p≈ôedmƒõty
            const toRemove = [];
            state.inv.forEach((item, idx) => {
                if (item.quest) return;
                if (state.equipped?.weapon?.id === item.id) return;
                if (state.equipped?.armor?.id === item.id) return;
                
                const basePrice = item.price || item.traderPrice || 20;
                const sellPrice = Math.floor(basePrice * 0.5);
                const qty = item.quantity || 1;
                total += sellPrice * qty;
                toRemove.push(idx);
            });
            
            // Odstra≈à prodan√© p≈ôedmƒõty (odzadu)
            toRemove.reverse().forEach(idx => state.inv.splice(idx, 1));
            
            addCasinoTokens(total);
            
            if (total > 0) {
                const humor = getRandomHumor('pawnShop');
                notifySuccess(`+${total} üí∞`, humor);
            } else {
                notifyError('Nic k prodeji', 'Nem√°≈° co prodat');
            }
            
            saveGame(true);
            renderFull();
            showCasinoPawnShop();
        }
        
        // === VY≈†≈†√ç / NI≈Ω≈†√ç ===
        function showHighLowGame() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0, highLowWins: 0, pokerWins: 0 };
            
            showModal('üé≤ Vy≈°≈°√≠ / Ni≈æ≈°√≠', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;" id="diceDisplay">üé≤ üé≤</div>
                    <p style="color: #888;">Souƒçet dvou kostek: 2-12</p>
                    <p style="color: #9c27b0; font-weight: bold;" id="highLowMoney">≈Ωetony: ${getCasinoTokens()} üé´</p>
                </div>
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p style="color: #8bc34a; margin: 0 0 0.5rem 0; text-align: center;">üéØ Pravidla:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; text-align: center; font-size: 0.8rem;">
                        <div style="background: #2a3a2a; padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #4caf50;">‚¨áÔ∏è Ni≈æ≈°√≠ (2-5)</div>
                            <div style="color: #9c27b0;">2x s√°zka</div>
                        </div>
                        <div style="background: #3a3a1a; padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #ff9800;">7Ô∏è‚É£ P≈ôesnƒõ 7</div>
                            <div style="color: #9c27b0;">5x s√°zka</div>
                        </div>
                        <div style="background: #2a3a2a; padding: 0.5rem; border-radius: 4px;">
                            <div style="color: #f44336;">‚¨ÜÔ∏è Vy≈°≈°√≠ (9-12)</div>
                            <div style="color: #9c27b0;">2x s√°zka</div>
                        </div>
                    </div>
                    <p style="color: #ff6666; font-size: 0.7rem; text-align: center; margin: 0.5rem 0 0 0;">‚ö†Ô∏è 6 a 8 = prohra (house edge)</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üé´ S√°zka:</label>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                        <button class="btn" onclick="setHighLowBet(50)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet50">50</button>
                        <button class="btn" onclick="setHighLowBet(100)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet100">100</button>
                        <button class="btn" onclick="setHighLowBet(250)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet250">250</button>
                        <button class="btn" onclick="setHighLowBet(500)" style="flex: 1; background: #333; padding: 0.5rem;" id="bet500">500</button>
                        <button class="btn" onclick="setHighLowBet(getCasinoTokens())" style="flex: 1; background: #8b0000; padding: 0.5rem;">ALL IN</button>
                    </div>
                    <p style="text-align: center; margin-top: 0.5rem; color: #9c27b0;" id="currentBetDisplay">Aktu√°ln√≠ s√°zka: 50 üé´</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="playHighLow('low')" style="background: linear-gradient(180deg, #1a5a1a 0%, #0a3a0a 100%); padding: 1rem;">
                        <div style="font-size: 1.5rem;">‚¨áÔ∏è</div>
                        <div>Ni≈æ≈°√≠</div>
                        <div style="font-size: 0.7rem; color: #aaa;">2-5</div>
                    </button>
                    <button class="btn" onclick="playHighLow('seven')" style="background: linear-gradient(180deg, #5a5a1a 0%, #3a3a0a 100%); padding: 1rem;">
                        <div style="font-size: 1.5rem;">7Ô∏è‚É£</div>
                        <div>Sedma</div>
                        <div style="font-size: 0.7rem; color: #aaa;">Jackpot!</div>
                    </button>
                    <button class="btn" onclick="playHighLow('high')" style="background: linear-gradient(180deg, #5a1a1a 0%, #3a0a0a 100%); padding: 1rem;">
                        <div style="font-size: 1.5rem;">‚¨ÜÔ∏è</div>
                        <div>Vy≈°≈°√≠</div>
                        <div style="font-size: 0.7rem; color: #aaa;">9-12</div>
                    </button>
                </div>
                
                <div id="highLowResult" style="margin-top: 1rem; text-align: center; min-height: 60px;"></div>
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt do kasina</button>
            `);
            
            window.currentHighLowBet = 50;
        }
        
        function setHighLowBet(amount) {
            const bet = Math.min(amount, getCasinoTokens());
            window.currentHighLowBet = Math.max(1, bet);
            document.getElementById('currentBetDisplay').innerHTML = `Aktu√°ln√≠ s√°zka: ${window.currentHighLowBet} üé´`;
            
            // Highlight selected
            ['bet10', 'bet25', 'bet50', 'bet100'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.background = '#333';
            });
        }
        
        function playHighLow(choice) {
            const bet = window.currentHighLowBet || 50;
            
            if (getCasinoTokens() < bet) {
                notifyError('M√°lo ≈æeton≈Ø!', `Pot≈ôebuje≈° ${bet} üé´`);
                return;
            }
            
            addCasinoTokens(-bet);
            const moneyEl = document.getElementById('highLowMoney');
            if (moneyEl) moneyEl.innerHTML = `≈Ωetony: ${getCasinoTokens()} üé´`;
            
            const diceDisplay = document.getElementById('diceDisplay');
            let animCount = 0;
            const diceEmojis = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            const animInterval = setInterval(() => {
                const d1 = diceEmojis[Math.floor(Math.random() * 6)];
                const d2 = diceEmojis[Math.floor(Math.random() * 6)];
                diceDisplay.innerHTML = d1 + ' ' + d2;
                diceDisplay.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
                animCount++;
                if (animCount > 15) {
                    clearInterval(animInterval);
                    finishHighLowRoll(choice, bet);
                }
            }, 80);
            SoundSystem.play('click');
        }
        
        function finishHighLowRoll(choice, bet) {
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            const total = dice1 + dice2;
            
            const diceEmojis = ['', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            const diceDisplay = document.getElementById('diceDisplay');
            diceDisplay.innerHTML = diceEmojis[dice1] + ' ' + diceEmojis[dice2];
            diceDisplay.style.transform = 'rotate(0deg)';
            
            let won = false;
            let multiplier = 0;
            
            if (choice === 'low' && total >= 2 && total <= 5) { won = true; multiplier = 2; }
            else if (choice === 'high' && total >= 9 && total <= 12) { won = true; multiplier = 2; }
            else if (choice === 'seven' && total === 7) { won = true; multiplier = 5; }
            
            const resultDiv = document.getElementById('highLowResult');
            
            // P≈ôiƒçti progress pro denn√≠ √∫kol
            addCasinoGambledProgress();
            
            if (won) {
                const winnings = bet * multiplier;
                addCasinoTokens(winnings);
                state.casinoStats.totalWon += winnings - bet;
                state.casinoStats.highLowWins++;
                const humor = multiplier >= 5 ? getRandomHumor('casinoJackpot') : getRandomHumor('casinoWin');
                resultDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1a3a1a 0%, #2a5a2a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #4caf50;">
                        <div style="font-size: 1.5rem;">üéâ</div>
                        <div style="color: #4caf50; font-weight: bold;">V√ùHRA! +${winnings} üé´</div>
                        <div style="color: #888; font-size: 0.75rem;">Souƒçet: ${total} (${multiplier}x)</div>
                        <div style="color: #8bc34a; font-size: 0.7rem; font-style: italic; margin-top: 0.3rem;">${humor}</div>
                    </div>`;
                SoundSystem.play('victory');
            } else {
                state.casinoStats.totalLost += bet;
                const humor = getRandomHumor('casinoLose');
                resultDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #3a1a1a 0%, #5a2a2a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #f44336;">
                        <div style="font-size: 1.5rem;">üò¢</div>
                        <div style="color: #f44336; font-weight: bold;">PROHRA -${bet} üé´</div>
                        <div style="color: #888; font-size: 0.75rem;">Souƒçet: ${total}</div>
                        <div style="color: #ff8a80; font-size: 0.7rem; font-style: italic; margin-top: 0.3rem;">${humor}</div>
                    </div>`;
                SoundSystem.play('damage');
            }
            
            const moneyEl = document.getElementById('highLowMoney');
            if (moneyEl) moneyEl.innerHTML = `≈Ωetony: ${getCasinoTokens()} üé´`;
            saveGame(true);
        }
        
        // === POKER DICE ===
        function showPokerDice() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0, highLowWins: 0, pokerWins: 0 };
            if (!state.pokerDice) state.pokerDice = { dice: [0,0,0,0,0], held: [false,false,false,false,false], rolls: 0, bet: 0, phase: 'betting' };
            
            state.pokerDice = { dice: [0,0,0,0,0], held: [false,false,false,false,false], rolls: 0, bet: 0, phase: 'betting' };
            
            renderPokerDice();
        }
        
        function renderPokerDice() {
            const pd = state.pokerDice;
            
            // Pro 14stƒõnnou kostku zobrazujeme ƒç√≠sla
            const diceHtml = pd.dice.map((d, i) => `
                <div onclick="togglePokerHold(${i})" style="
                    width: 50px; height: 50px; 
                    background: ${pd.held[i] ? 'linear-gradient(135deg, #ffd700 0%, #b8860b 100%)' : 'linear-gradient(135deg, #333 0%, #1a1a1a 100%)'};
                    border: 3px solid ${pd.held[i] ? '#ffd700' : '#555'};
                    border-radius: 50%;
                    display: flex; align-items: center; justify-content: center;
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: ${pd.held[i] ? '#000' : '#fff'};
                    cursor: ${pd.phase === 'rolling' ? 'pointer' : 'default'};
                    transition: all 0.2s;
                    ${pd.held[i] ? 'box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);' : ''}
                " id="pokerDie${i}">
                    ${d > 0 ? d : '?'}
                </div>
            `).join('');
            
            const handInfo = pd.rolls > 0 ? evaluatePokerHand(pd.dice) : { name: '-', multiplier: 0 };
            const maxRolls = 3;
            
            const payoutTable = `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin: 0.5rem 0; font-size: 0.65rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                        <span style="color: #9c27b0; font-weight: bold;">üé≤ 14stƒõnn√© kostky ‚Ä¢ 3 hody</span>
                        <button class="btn" onclick="showGameRules('poker')" style="padding: 0.15rem 0.4rem; background: #333; font-size: 0.6rem;">‚ùì</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.2rem;">
                        <div style="color: #888;">Dva p√°ry: <span style="color: #ffd700;">1x</span></div>
                        <div style="color: #c62828;">Trojice: <span style="color: #ffd700;">1.5x</span></div>
                        <div style="color: #888;">Full House: <span style="color: #ffd700;">3x</span></div>
                        <div style="color: #888;">ƒåtve≈ôice: <span style="color: #ffd700;">6x</span></div>
                        <div style="color: #888;">Mal√° postupka: <span style="color: #ffd700;">10x</span></div>
                        <div style="color: #888;">Pƒõtice: <span style="color: #ffd700;">30x</span></div>
                        <div style="color: #888;">Velk√° postupka: <span style="color: #ffd700;">25x</span></div>
                    </div>
                </div>
            `;
            
            let actionButtons = '';
            
            if (pd.phase === 'betting') {
                actionButtons = `
                    <div style="margin: 1rem 0;">
                        <label style="color: #888; font-size: 0.85rem;">üé´ S√°zka:</label>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="startPokerDice(10)" style="flex: 1; background: #333;">10</button>
                            <button class="btn" onclick="startPokerDice(25)" style="flex: 1; background: #333;">25</button>
                            <button class="btn" onclick="startPokerDice(50)" style="flex: 1; background: #333;">50</button>
                            <button class="btn" onclick="startPokerDice(100)" style="flex: 1; background: #333;">100</button>
                        </div>
                    </div>
                `;
            } else if (pd.phase === 'rolling') {
                actionButtons = `
                    <div style="margin: 1rem 0; text-align: center;">
                        <p style="color: #888; font-size: 0.85rem;">Klikni na kostky pro dr≈æen√≠, pak hoƒè znovu</p>
                        <p style="color: #ffd700;">Zb√Ωvaj√≠c√≠ hody: ${maxRolls - pd.rolls}</p>
                        <button class="btn" onclick="rollPokerDice()" style="background: linear-gradient(135deg, #5a1a5a 0%, #8a2d8a 100%); padding: 1rem; width: 100%;">
                            üé≤ Hodit ${pd.rolls === 0 ? '' : 'znovu'} (${maxRolls - pd.rolls} zb√Ωv√°)
                        </button>
                    </div>
                `;
            } else if (pd.phase === 'finished') {
                const result = evaluatePokerHand(pd.dice);
                const winnings = pd.bet * result.multiplier;
                const humor = result.multiplier >= 15 ? getRandomHumor('casinoJackpot') : (result.multiplier > 0 ? getRandomHumor('casinoWin') : getRandomHumor('casinoLose'));
                
                actionButtons = `
                    <div style="margin: 1rem 0; text-align: center;">
                        <div style="background: ${result.multiplier > 0 ? 'linear-gradient(135deg, #1a3a1a 0%, #2a5a2a 100%)' : 'linear-gradient(135deg, #3a1a1a 0%, #5a2a2a 100%)'}; padding: 1rem; border-radius: 8px; border: 2px solid ${result.multiplier > 0 ? '#4caf50' : '#f44336'};">
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${result.multiplier > 0 ? '#4caf50' : '#f44336'};">${result.name}</div>
                            ${result.multiplier > 0 ? `<div style="color: #ffd700; font-size: 1.3rem;">+${winnings} üé´ (${result.multiplier}x)</div>` : '<div style="color: #888;">≈Ω√°dn√° v√Ωhra</div>'}
                            <div style="color: ${result.multiplier > 0 ? '#8bc34a' : '#ff8a80'}; font-size: 0.7rem; font-style: italic; margin-top: 0.3rem;">${humor}</div>
                        </div>
                        <button class="btn" onclick="showPokerDice()" style="background: #5a1a5a; margin-top: 1rem; width: 100%;">üîÑ Hr√°t znovu</button>
                    </div>
                `;
            }
            
            showModal('üé≤ Poker Dice', `
                <div style="text-align: center;">
                    <p style="color: #9c27b0; font-weight: bold;">Tv√© ≈æetony: ${getCasinoTokens()} üé´</p>
                    ${pd.bet > 0 ? `<p style="color: #888;">S√°zka: ${pd.bet} üé´</p>` : ''}
                </div>
                
                <div style="display: flex; justify-content: center; gap: 0.5rem; margin: 1rem 0;">
                    ${diceHtml}
                </div>
                
                ${pd.rolls > 0 ? `
                    <div style="text-align: center; padding: 0.5rem; background: ${handInfo.multiplier > 0 ? '#1a2a1a' : '#2a2a2a'}; border-radius: 8px; margin: 0.5rem 0;">
                        <span style="color: ${handInfo.multiplier > 0 ? '#4caf50' : '#888'}; font-weight: bold;">${handInfo.name}</span>
                        ${handInfo.multiplier > 0 ? `<span style="color: #ffd700;"> (${handInfo.multiplier}x)</span>` : ''}
                    </div>
                ` : ''}
                
                ${payoutTable}
                ${actionButtons}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt do kasina</button>
            `);
        }
        
        function startPokerDice(bet) {
            if (getCasinoTokens() < bet) {
                notifyError('M√°lo ≈æeton≈Ø!', `Pot≈ôebuje≈° ${bet} üé´`);
                return;
            }
            
            addCasinoTokens(-bet);
            state.pokerDice.bet = bet;
            state.pokerDice.phase = 'rolling';
            state.pokerDice.rolls = 0;
            state.pokerDice.dice = [0,0,0,0,0];
            state.pokerDice.held = [false,false,false,false,false];
            
            renderPokerDice();
        }
        
        function togglePokerHold(index) {
            if (state.pokerDice.phase !== 'rolling' || state.pokerDice.rolls === 0) return;
            state.pokerDice.held[index] = !state.pokerDice.held[index];
            renderPokerDice();
        }
        
        function rollPokerDice() {
            const pd = state.pokerDice;
            
            if (pd.rolls >= 3) return; // 3 hody
            
            // Animace
            let animCount = 0;
            const animInterval = setInterval(() => {
                for (let i = 0; i < 5; i++) {
                    if (!pd.held[i]) {
                        const dieEl = document.getElementById(`pokerDie${i}`);
                        if (dieEl) {
                            // 14stƒõnn√° kostka (1-14)
                            dieEl.innerHTML = Math.floor(Math.random() * 14) + 1;
                            dieEl.style.transform = `rotate(${Math.random() * 30 - 15}deg)`;
                        }
                    }
                }
                animCount++;
                if (animCount > 12) {
                    clearInterval(animInterval);
                    finishPokerRoll();
                }
            }, 60);
            
            SoundSystem.play('click');
        }
        
        function finishPokerRoll() {
            const pd = state.pokerDice;
            
            // Hoƒè nepodr≈æen√Ωmi kostkami (14stƒõnn√° kostka)
            for (let i = 0; i < 5; i++) {
                if (!pd.held[i]) {
                    pd.dice[i] = Math.floor(Math.random() * 14) + 1;
                }
            }
            
            pd.rolls++;
            
            // Pokud je to 5. hod, vyhodno≈•
            if (pd.rolls >= 3) {
                pd.phase = 'finished';
                const result = evaluatePokerHand(pd.dice);
                
                // P≈ôiƒçti progress pro denn√≠ √∫kol
                addCasinoGambledProgress();
                
                if (result.multiplier > 0) {
                    const winnings = pd.bet * result.multiplier;
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - pd.bet;
                    state.casinoStats.pokerWins++;
                    SoundSystem.play('victory');
                } else {
                    state.casinoStats.totalLost += pd.bet;
                    SoundSystem.play('damage');
                }
            }
            
            saveGame(true);
            renderPokerDice();
        }
        
        function evaluatePokerHand(dice) {
            const sorted = [...dice].sort((a, b) => a - b);
            const counts = {};
            dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
            const values = Object.values(counts).sort((a, b) => b - a);
            
            // Pƒõtice (v≈°ech 5 stejn√Ωch) - extr√©mnƒõ vz√°cn√© s 14stƒõnnou kostkou
            if (values[0] === 5) return { name: 'üåü PƒöTICE! üåü', multiplier: 30 };
            
            // Velk√° postupka (5 ƒç√≠sel po sobƒõ z 1-14) - extr√©mnƒõ vz√°cn√©
            const uniqueSorted = [...new Set(sorted)].sort((a,b) => a-b);
            if (uniqueSorted.length === 5) {
                const isSequential = uniqueSorted.every((val, idx) => 
                    idx === 0 || val === uniqueSorted[idx-1] + 1
                );
                if (isSequential) {
                    return { name: 'üéØ Velk√° postupka!', multiplier: 25 };
                }
            }
            
            // ƒåtve≈ôice
            if (values[0] === 4) return { name: 'üíé ƒåtve≈ôice!', multiplier: 6 };
            
            // Mal√° postupka (4 ƒç√≠sla po sobƒõ z 1-14)
            if (uniqueSorted.length >= 4) {
                for (let i = 0; i <= uniqueSorted.length - 4; i++) {
                    const slice = uniqueSorted.slice(i, i + 4);
                    const isSeq = slice.every((val, idx) => 
                        idx === 0 || val === slice[idx-1] + 1
                    );
                    if (isSeq) {
                        return { name: 'üìà Mal√° postupka', multiplier: 10 };
                    }
                }
            }
            
            // Full House (trojice + p√°r)
            if (values[0] === 3 && values[1] === 2) return { name: 'üè† Full House!', multiplier: 3 };
            
            // Trojice
            if (values[0] === 3) return { name: 'üé≤ Trojice', multiplier: 1.5 };
            
            // Dva p√°ry - mal√° v√Ωhra
            if (values[0] === 2 && values[1] === 2) return { name: '‚úåÔ∏è Dva p√°ry', multiplier: 1 };
            
            // Jeden p√°r - nic
            if (values[0] === 2) return { name: 'üë´ P√°r', multiplier: 0 };
            
            // Nic
            return { name: 'Nic moc...', multiplier: 0 };
        }
        
        // === SLOT MACHINE ===
        function showSlotMachine() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.slotBet = 10;
            
            const slotTexts = {
                rules: 'Pravidla', tokens: '≈Ωetony', spin: 'ZATOƒåIT!', back: 'Casino'
            };
            
            showModal('üé∞ AUTOMATY', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('slots')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">‚ùì ${slotTexts.rules}</button>
                    <p style="color: #ffd700; margin: 0;">${slotTexts.tokens}: <span id="slotMoney">${getCasinoTokens()}</span> üé´</p>
                </div>
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 12px; margin: 0.5rem 0; border: 3px solid #ffd700;">
                    <div style="display: flex; justify-content: center; gap: 0.4rem;" id="slotReels">
                        <div style="width: 50px; height: 60px; background: #111; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid #444;">‚ùì</div>
                        <div style="width: 50px; height: 60px; background: #111; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid #444;">‚ùì</div>
                        <div style="width: 50px; height: 60px; background: #111; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid #444;">‚ùì</div>
                    </div>
                </div>
                <div style="background: #111; padding: 0.3rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.6rem; text-align: center; color: #888;">
                    üçí=8x | üçã=12x | ‚≠ê=18x | üçÄ=25x | üíé=40x | 7Ô∏è‚É£=60x
                </div>
                <div style="display: flex; gap: 0.3rem; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="setSlotBet(10)" id="slotBet10" style="flex: 1; background: #ffd700; color: #000;">10</button>
                    <button class="btn" onclick="setSlotBet(25)" id="slotBet25" style="flex: 1; background: #444;">25</button>
                    <button class="btn" onclick="setSlotBet(50)" id="slotBet50" style="flex: 1; background: #444;">50</button>
                </div>
                <button class="btn" onclick="spinSlots()" style="width: 100%; background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%); color: #000; font-weight: bold; padding: 0.8rem;">üé∞ ${slotTexts.spin}</button>
                <div id="slotResult" style="margin-top: 0.5rem; text-align: center; min-height: 30px;"></div>
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${slotTexts.back}</button>
            `);
        }
        
        function setSlotBet(amt) {
            window.slotBet = Math.min(amt, getCasinoTokens());
            ['slotBet10','slotBet25','slotBet50'].forEach(id => { const e = document.getElementById(id); if(e) { e.style.background='#444'; e.style.color='#fff'; }});
            const e = document.getElementById('slotBet'+amt); if(e) { e.style.background='#ffd700'; e.style.color='#000'; }
        }
        
        function spinSlots() {
            const bet = window.slotBet || 10;
            if (getCasinoTokens() < bet) { notifyError('M√°lo ≈æeton≈Ø!'); return; }
            addCasinoTokens(-bet);
            document.getElementById('slotMoney').textContent = getCasinoTokens();
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                addCasinoGambledProgress();
                checkDailyQuests();
            }
            
            // 6 symbol≈Ø m√≠sto 5 = tƒõ≈æ≈°√≠ trefit trojici
            const symbols = ['üçí','üçã','üçÄ','üíé','7Ô∏è‚É£','‚≠ê'];
            const weightedRandom = () => symbols[Math.floor(Math.random() * 6)];
            
            let spins = 0;
            const iv = setInterval(() => {
                document.getElementById('slotReels').innerHTML = [0,1,2].map(() => 
                    `<div style="width:50px;height:60px;background:#111;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:2rem;border:2px solid #ffd700;">${symbols[Math.floor(Math.random()*6)]}</div>`
                ).join('');
                if (++spins > 18) { clearInterval(iv); finishSlot(bet, [weightedRandom(),weightedRandom(),weightedRandom()]); }
            }, 70);
            SoundSystem.play('click');
        }
        
        function finishSlot(bet, r) {
            document.getElementById('slotReels').innerHTML = r.map(s => 
                `<div style="width:50px;height:60px;background:#111;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:2rem;border:2px solid #4caf50;">${s}</div>`
            ).join('');
            
            let m=0, t='';
            // House edge 55% - RTP 45%
            // Trojice = v√Ωhra - multiplik√°tory podle pravidel
            if (r[0]===r[1] && r[1]===r[2]) { 
                m = r[0]==='7Ô∏è‚É£'?60 : r[0]==='üíé'?40 : r[0]==='üçÄ'?25 : r[0]==='‚≠ê'?18 : r[0]==='üçã'?12 : 8; 
                t = m>=40?'üé∞ JACKPOT!':'Trojice!'; 
            }
            // Dvojice u≈æ nevyhr√°v√° - p≈ô√≠li≈° ƒçast√© (27.78%)
            
            const rd = document.getElementById('slotResult');
            
            // P≈ôiƒçti progress pro denn√≠ √∫kol
            addCasinoGambledProgress();
            
            if (m > 0) {
                const w = Math.floor(bet*m);
                addCasinoTokens(w);
                state.casinoStats.totalWon += w - bet;
                const humor = m >= 40 ? getRandomHumor('casinoJackpot') : getRandomHumor('casinoWin');
                rd.innerHTML = `<div style="color:#4caf50;font-weight:bold;">${t}</div><div style="color:#ffd700;">+${w} üé´</div><div style="color:#8bc34a;font-size:0.7rem;font-style:italic;">${humor}</div>`;
                SoundSystem.play('victory');
            } else {
                state.casinoStats.totalLost += bet;
                const humor = getRandomHumor('casinoSlots');
                rd.innerHTML = `<div style="color:#888;">Nic...</div><div style="color:#ff8a80;font-size:0.7rem;font-style:italic;">${humor}</div>`;
            }
            document.getElementById('slotMoney').textContent = getCasinoTokens();
            saveGame(true);
        }
        
        // === BLACKJACK ===
        function showBlackjack() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.bjBet = 20; window.bjState = null;
            
            const bjTexts = {
                rules: 'Pravidla', tokens: '≈Ωetony', dealer: 'DEALER', you: 'TY',
                deal: 'ROZDAT', hit: 'DAL≈†√ç', stand: 'ST√ÅT', back: 'Casino'
            };
            
            showModal('üÉè BLACKJACK', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('blackjack')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">‚ùì ${bjTexts.rules}</button>
                    <p style="color: #ffd700; margin: 0;">${bjTexts.tokens}: <span id="bjMoney">${getCasinoTokens()}</span> üé´</p>
                </div>
                <div style="background: #0a3a0a; padding: 0.8rem; border-radius: 10px; margin: 0.5rem 0; min-height: 150px;">
                    <div style="text-align: center; color: #888; font-size: 0.7rem;">${bjTexts.dealer}</div>
                    <div id="dealerCards" style="text-align: center; font-size: 1.6rem; min-height: 40px;">üÇ† üÇ†</div>
                    <div id="dealerScore" style="text-align: center; color: #ffd700; font-size: 0.8rem;"></div>
                    <div style="border-top: 2px dashed #2a5a2a; margin: 0.4rem 0;"></div>
                    <div id="playerCards" style="text-align: center; font-size: 1.6rem; min-height: 40px;">üÇ† üÇ†</div>
                    <div id="playerScore" style="text-align: center; color: #ffd700; font-size: 0.8rem;"></div>
                    <div style="text-align: center; color: #888; font-size: 0.7rem;">${bjTexts.you}</div>
                </div>
                <div id="bjControls">
                    <div style="display: flex; gap: 0.3rem; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="setBjBet(20)" id="bjBet20" style="flex:1;background:#ffd700;color:#000;">20</button>
                        <button class="btn" onclick="setBjBet(50)" id="bjBet50" style="flex:1;background:#444;">50</button>
                        <button class="btn" onclick="setBjBet(100)" id="bjBet100" style="flex:1;background:#444;">100</button>
                    </div>
                    <button class="btn" onclick="startBJ()" style="width:100%;background:#4caf50;font-weight:bold;">üÉè ${bjTexts.deal}</button>
                </div>
                <div id="bjActions" style="display:none;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="bjHit()" style="flex:1;background:#4caf50;font-weight:bold;">üì• ${bjTexts.hit}</button>
                        <button class="btn" onclick="bjStand()" style="flex:1;background:#f44336;font-weight:bold;">‚úã ${bjTexts.stand}</button>
                    </div>
                </div>
                <div id="bjResult" style="margin-top: 0.5rem; text-align: center;"></div>
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${bjTexts.back}</button>
            `);
        }
        
        function setBjBet(a) {
            window.bjBet = Math.min(a, getCasinoTokens());
            ['bjBet20','bjBet50','bjBet100'].forEach(id => { const e=document.getElementById(id); if(e){e.style.background='#444';e.style.color='#fff';} });
            const e=document.getElementById('bjBet'+a); if(e){e.style.background='#ffd700';e.style.color='#000';}
        }
        
        function createDeck() {
            const suits=['‚ô†','‚ô•','‚ô¶','‚ô£'], vals=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], deck=[];
            for(const s of suits) for(const v of vals) deck.push({suit:s,value:v,score:parseInt(v)||(v==='A'?11:10),display:v+s});
            for(let i=deck.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
            return deck;
        }
        
        function getScore(hand) { let s=hand.reduce((a,c)=>a+c.score,0), aces=hand.filter(c=>c.value==='A').length; while(s>21&&aces>0){s-=10;aces--;} return s; }
        
        function startBJ() {
            const bet=window.bjBet||20;
            if(getCasinoTokens()<bet){notifyError('M√°lo ≈æeton≈Ø!');return;}
            addCasinoTokens(-bet); document.getElementById('bjMoney').textContent=getCasinoTokens();
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                addCasinoGambledProgress();
                checkDailyQuests();
            }
            
            const deck=createDeck();
            window.bjState={deck,player:[deck.pop(),deck.pop()],dealer:[deck.pop(),deck.pop()],bet,done:false};
            updateBJ(false);
            document.getElementById('bjControls').style.display='none';
            document.getElementById('bjActions').style.display='block';
            document.getElementById('bjResult').innerHTML='';
            if(getScore(window.bjState.player)===21) bjStand();
            SoundSystem.play('click');
        }
        
        function updateBJ(showD) {
            const bj=window.bjState, ps=getScore(bj.player), ds=getScore(bj.dealer);
            document.getElementById('playerCards').innerHTML=bj.player.map(c=>`<span style="color:${c.suit==='‚ô•'||c.suit==='‚ô¶'?'#f44':'#fff'}">${c.display}</span>`).join(' ');
            document.getElementById('playerScore').textContent=`(${ps})`;
            if(showD) {
                document.getElementById('dealerCards').innerHTML=bj.dealer.map(c=>`<span style="color:${c.suit==='‚ô•'||c.suit==='‚ô¶'?'#f44':'#fff'}">${c.display}</span>`).join(' ');
                document.getElementById('dealerScore').textContent=`(${ds})`;
            } else {
                document.getElementById('dealerCards').innerHTML=`<span style="color:${bj.dealer[0].suit==='‚ô•'||bj.dealer[0].suit==='‚ô¶'?'#f44':'#fff'}">${bj.dealer[0].display}</span> üÇ†`;
                document.getElementById('dealerScore').textContent='(?)';
            }
        }
        
        function bjHit() { const bj=window.bjState; if(bj.done)return; bj.player.push(bj.deck.pop()); updateBJ(false); const s=getScore(bj.player); if(s>21)finishBJ('bust'); else if(s===21)bjStand(); }
        function bjStand() { const bj=window.bjState; if(bj.done)return; while(getScore(bj.dealer)<17)bj.dealer.push(bj.deck.pop()); updateBJ(true); const ps=getScore(bj.player),ds=getScore(bj.dealer); if(ds>21)finishBJ('dwin'); else if(ps>ds)finishBJ('win'); else if(ds>ps)finishBJ('lose'); else finishBJ('push'); }
        
        function finishBJ(r) {
            const bj=window.bjState; bj.done=true;
            document.getElementById('bjActions').style.display='none';
            let html='', w=0, humor='';
            const isBJ=bj.player.length===2&&getScore(bj.player)===21;
            
            if(r==='bust') { 
                humor = getRandomHumor('casinoBust');
                html=`<div style="color:#f44;">üí• P≈òET√ÅHL!</div><div>-${bj.bet} üé´</div><div style="color:#ff8a80;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalLost+=bj.bet; SoundSystem.play('damage'); 
            }
            else if(r==='dwin') { 
                w=bj.bet*2; 
                humor = getRandomHumor('casinoWin');
                html=`<div style="color:#4c5;">üéâ Dealer p≈ôet√°hl!</div><div style="color:#ffd700;">+${w} üé´</div><div style="color:#8bc34a;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalWon+=bj.bet; SoundSystem.play('victory'); 
            }
            else if(r==='win') { 
                w=isBJ?Math.floor(bj.bet*2.5):bj.bet*2; 
                humor = isBJ ? getRandomHumor('casinoJackpot') : getRandomHumor('casinoWin');
                html=`<div style="color:#4c5;">${isBJ?'üÉè BLACKJACK!':'üéâ V√ùHRA!'}</div><div style="color:#ffd700;">+${w} üé´</div><div style="color:#8bc34a;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalWon+=w-bj.bet; SoundSystem.play('victory'); 
            }
            else if(r==='lose') { 
                humor = getRandomHumor('casinoLose');
                html=`<div style="color:#f44;">üò¢ Prohra</div><div>-${bj.bet} üé´</div><div style="color:#ff8a80;font-size:0.7rem;font-style:italic;">${humor}</div>`; 
                state.casinoStats.totalLost+=bj.bet; SoundSystem.play('damage'); 
            }
            else { w=bj.bet; html=`<div style="color:#fa0;">ü§ù Rem√≠za - s√°zka vr√°cena</div>`; }
            
            if(w>0) addCasinoTokens(w);
            document.getElementById('bjMoney').textContent=getCasinoTokens();
            document.getElementById('bjResult').innerHTML=html+`<button class="btn" onclick="showBlackjack()" style="margin-top:0.3rem;background:#333;">üîÑ Znovu</button>`;
            updateBJ(true); saveGame(true);
        }
        
        // === KOLO ≈†TƒöST√ç ===
        function showWheelOfFortune() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            
            // House edge 55% - hr√°ƒç vyhr√°v√° 45%
            // 12 segment≈Ø: 7 proher (58%), 5 v√Ωher (42%) s n√≠zk√Ωmi multiplik√°tory
            // RTP: (0*7 + 1.3 + 1.5 + 1.8 + 2 + 2.5) / 12 = 9.1/12 = 75.8% * 42% = ~45% oƒçek√°van√Ω zisk
            const segments = [
                { label: 'üíÄ', multiplier: 0, color: '#2a0a0a' },
                { label: '1.3x', multiplier: 1.3, color: '#1a3a1a' },
                { label: 'üíÄ', multiplier: 0, color: '#2a0a0a' },
                { label: 'üíÄ', multiplier: 0, color: '#2a0a0a' },
                { label: '1.5x', multiplier: 1.5, color: '#1a4a1a' },
                { label: 'üíÄ', multiplier: 0, color: '#2a0a0a' },
                { label: '1.8x', multiplier: 1.8, color: '#1a4a1a' },
                { label: 'üíÄ', multiplier: 0, color: '#2a0a0a' },
                { label: 'üíÄ', multiplier: 0, color: '#2a0a0a' },
                { label: '2x', multiplier: 2, color: '#1a5a1a' },
                { label: 'üíÄ', multiplier: 0, color: '#2a0a0a' },
                { label: 'üéâ 2.5x', multiplier: 2.5, color: '#3a5a1a' }
            ];
            
            window.wheelSegments = segments;
            window.wheelBet = 0;
            window.wheelSpinning = false;
            
            renderWheelOfFortune();
        }
        
        function renderWheelOfFortune() {
            const segments = window.wheelSegments;
            const bet = window.wheelBet || 0;
            const spinning = window.wheelSpinning || false;
            
            // Vytvo≈ô SVG kolo - mnohem p≈ôehlednƒõj≈°√≠
            const size = 220;
            const center = size / 2;
            const radius = 100;
            const segmentAngle = 360 / segments.length;
            
            let wheelSVG = `<svg width="${size}" height="${size}" style="display: block; margin: 0 auto;">`;
            
            segments.forEach((seg, i) => {
                const startAngle = (i * segmentAngle - 90) * Math.PI / 180;
                const endAngle = ((i + 1) * segmentAngle - 90) * Math.PI / 180;
                
                const x1 = center + radius * Math.cos(startAngle);
                const y1 = center + radius * Math.sin(startAngle);
                const x2 = center + radius * Math.cos(endAngle);
                const y2 = center + radius * Math.sin(endAngle);
                
                const largeArc = segmentAngle > 180 ? 1 : 0;
                
                // Barvy: ƒçerven√° pro prohru, zelen√° pro v√Ωhru
                const color = seg.multiplier === 0 ? '#8B0000' : '#228B22';
                const textColor = '#fff';
                
                wheelSVG += `<path d="M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" 
                    fill="${color}" stroke="#ffd700" stroke-width="2"/>`;
                
                // Text uprost≈ôed segmentu
                const midAngle = ((i + 0.5) * segmentAngle - 90) * Math.PI / 180;
                const textRadius = radius * 0.65;
                const tx = center + textRadius * Math.cos(midAngle);
                const ty = center + textRadius * Math.sin(midAngle);
                
                const label = seg.multiplier === 0 ? 'üíÄ' : seg.multiplier + 'x';
                wheelSVG += `<text x="${tx}" y="${ty}" fill="${textColor}" font-size="${seg.multiplier === 0 ? '16' : '12'}" 
                    font-weight="bold" text-anchor="middle" dominant-baseline="middle">${label}</text>`;
            });
            
            // St≈ôed kola
            wheelSVG += `<circle cx="${center}" cy="${center}" r="20" fill="#1a1a1a" stroke="#ffd700" stroke-width="3"/>`;
            wheelSVG += `<text x="${center}" y="${center}" fill="#ffd700" font-size="14" font-weight="bold" text-anchor="middle" dominant-baseline="middle">üé∞</text>`;
            wheelSVG += `</svg>`;
            
            showModal('üé° Kolo ≈°tƒõst√≠', `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="showGameRules('wheel')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">‚ùì Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="wheelMoney">${getCasinoTokens()} üé´</p>
                </div>
                
                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 0.5rem; font-size: 0.75rem;">
                    <span style="color: #228B22;">üü¢ V√Ωhra</span>
                    <span style="color: #8B0000;">üî¥ Prohra</span>
                </div>
                
                <div style="position: relative;">
                    <div style="position: absolute; top: -5px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; z-index: 10;">‚ñº</div>
                    <div id="wheelContainer" style="transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);">
                        ${wheelSVG}
                    </div>
                </div>
                
                <div id="wheelResult" style="text-align: center; margin: 0.5rem 0; min-height: 40px;"></div>
                
                <div style="margin: 0.5rem 0;">
                    <label style="color: #888; font-size: 0.8rem;">S√°zka:</label>
                    <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                        <button class="btn" onclick="setWheelBet(10)" style="flex:1;background:${bet===10?'#ffd700':'#333'};color:${bet===10?'#000':'#fff'};">10</button>
                        <button class="btn" onclick="setWheelBet(25)" style="flex:1;background:${bet===25?'#ffd700':'#333'};color:${bet===25?'#000':'#fff'};">25</button>
                        <button class="btn" onclick="setWheelBet(50)" style="flex:1;background:${bet===50?'#ffd700':'#333'};color:${bet===50?'#000':'#fff'};">50</button>
                        <button class="btn" onclick="setWheelBet(100)" style="flex:1;background:${bet===100?'#ffd700':'#333'};color:${bet===100?'#000':'#fff'};">100</button>
                    </div>
                </div>
                
                <button class="btn" id="spinBtn" onclick="spinWheel()" style="width: 100%; background: linear-gradient(135deg, #5a1a3a 0%, #8a2d5a 100%); padding: 0.8rem; font-weight: bold;${spinning || bet === 0 ? ' opacity: 0.5; pointer-events: none;' : ''}">
                    üé° Roztoƒçit!
                </button>
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function setWheelBet(amount) {
            window.wheelBet = amount;
            renderWheelOfFortune();
        }
        
        function spinWheel() {
            if (window.wheelSpinning || window.wheelBet === 0) return;
            if (getCasinoTokens() < window.wheelBet) {
                notifyError('M√°lo ≈æeton≈Ø!', `Pot≈ôebuje≈° ${window.wheelBet} üé´`);
                return;
            }
            
            addCasinoTokens(-window.wheelBet);
            window.wheelSpinning = true;
            
            const segments = window.wheelSegments;
            const segmentAngle = 360 / segments.length;
            const randomSegment = Math.floor(Math.random() * segments.length);
            const extraSpins = 5 + Math.floor(Math.random() * 3);
            const finalRotation = extraSpins * 360 + (360 - randomSegment * segmentAngle - segmentAngle / 2);
            
            const wheel = document.getElementById('wheelContainer');
            wheel.style.transform = `rotate(${finalRotation}deg)`;
            
            SoundSystem.play('click');
            
            setTimeout(() => {
                const result = segments[randomSegment];
                const winnings = Math.floor(window.wheelBet * result.multiplier);
                
                let resultHtml = '';
                if (winnings > 0) {
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - window.wheelBet;
                    resultHtml = `<div style="color: #4caf50; font-size: 1.2rem;">üéâ V√ùHRA! +${winnings} üé´</div><div style="color: #888;">(${result.label})</div>`;
                    SoundSystem.play('victory');
                } else {
                    state.casinoStats.totalLost += window.wheelBet;
                    resultHtml = `<div style="color: #f44336; font-size: 1.2rem;">üíÄ Prohra!</div><div style="color: #888;">-${window.wheelBet} üé´</div>`;
                    SoundSystem.play('damage');
                }
                
                document.getElementById('wheelResult').innerHTML = resultHtml;
                document.getElementById('wheelMoney').textContent = getCasinoTokens() + ' üé´';
                
                window.wheelSpinning = false;
                saveGame(true);
            }, 4500);
        }
        
        // === WAR (V√ÅLKA) ===
        function showWarGame() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.warBet = 0;
            window.warPhase = 'betting';
            
            renderWarGame();
        }
        
        function renderWarGame() {
            const cardSuits = ['‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è'];
            const cardValues = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            
            showModal('‚öîÔ∏è War (V√°lka)', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('war')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">‚ùì Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="warMoney">${getCasinoTokens()} üé´</p>
                </div>
                
                <div style="display: flex; justify-content: space-around; margin: 1rem 0;">
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Ty</div>
                        <div id="playerCard" style="width: 60px; height: 85px; background: linear-gradient(135deg, #1a3a1a 0%, #2a4a2a 100%); border: 2px solid #4caf50; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto;">?</div>
                    </div>
                    <div style="display: flex; align-items: center; font-size: 2rem;">‚öîÔ∏è</div>
                    <div style="text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Dealer</div>
                        <div id="dealerCard" style="width: 60px; height: 85px; background: linear-gradient(135deg, #3a1a1a 0%, #4a2a2a 100%); border: 2px solid #c62828; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto;">?</div>
                    </div>
                </div>
                
                <div id="warResult" style="text-align: center; min-height: 50px;"></div>
                
                ${window.warPhase === 'betting' ? `
                    <div style="margin: 0.5rem 0;">
                        <label style="color: #888; font-size: 0.8rem;">S√°zka:</label>
                        <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="window.warBet=10;renderWarGame()" style="flex:1;background:${window.warBet===10?'#ffd700':'#333'};color:${window.warBet===10?'#000':'#fff'};">10</button>
                            <button class="btn" onclick="window.warBet=25;renderWarGame()" style="flex:1;background:${window.warBet===25?'#ffd700':'#333'};color:${window.warBet===25?'#000':'#fff'};">25</button>
                            <button class="btn" onclick="window.warBet=50;renderWarGame()" style="flex:1;background:${window.warBet===50?'#ffd700':'#333'};color:${window.warBet===50?'#000':'#fff'};">50</button>
                            <button class="btn" onclick="window.warBet=100;renderWarGame()" style="flex:1;background:${window.warBet===100?'#ffd700':'#333'};color:${window.warBet===100?'#000':'#fff'};">100</button>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="playWar()" style="width: 100%; background: linear-gradient(135deg, #3a1a1a 0%, #5a2d2d 100%); padding: 0.8rem;" ${window.warBet === 0 ? 'disabled' : ''}>
                        ‚öîÔ∏è Hr√°t!
                    </button>
                ` : ''}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function playWar() {
            if (window.warBet === 0) return;
            if (getCasinoTokens() < window.warBet) {
                notifyError('M√°lo ≈æeton≈Ø!', `Pot≈ôebuje≈° ${window.warBet} üé´`);
                return;
            }
            
            addCasinoTokens(-window.warBet);
            
            // Daily quest progress
            if (state.dailyQuests?.progress) {
                addCasinoGambledProgress();
                checkDailyQuests();
            }
            
            const cardValues = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const suits = ['‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è'];
            
            const playerValue = Math.floor(Math.random() * 13);
            const dealerValue = Math.floor(Math.random() * 13);
            const playerSuit = suits[Math.floor(Math.random() * 4)];
            const dealerSuit = suits[Math.floor(Math.random() * 4)];
            
            const playerCard = cardValues[playerValue] + playerSuit;
            const dealerCard = cardValues[dealerValue] + dealerSuit;
            
            document.getElementById('playerCard').innerHTML = playerCard;
            document.getElementById('dealerCard').innerHTML = dealerCard;
            
            SoundSystem.play('click');
            
            setTimeout(() => {
                let resultHtml = '';
                if (playerValue > dealerValue) {
                    // V√Ωhra = 1.9x s√°zka (ne 2x) = 46.15% * 1.9 = 87.7% RTP
                    const winnings = Math.floor(window.warBet * 1.9);
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - window.warBet;
                    resultHtml = `<div style="color: #4caf50; font-size: 1.2rem;">üéâ Vyhr√°v√°≈°! +${winnings} üé´</div>`;
                    SoundSystem.play('victory');
                } else if (playerValue < dealerValue) {
                    state.casinoStats.totalLost += window.warBet;
                    resultHtml = `<div style="color: #f44336; font-size: 1.2rem;">üíÄ Prohra! -${window.warBet} üé´</div>`;
                    SoundSystem.play('damage');
                } else {
                    // Rem√≠za = dealer vyhr√°v√° (jako v re√°ln√©m kasinu)
                    state.casinoStats.totalLost += window.warBet;
                    resultHtml = `<div style="color: #ff9800; font-size: 1.2rem;">‚öîÔ∏è Rem√≠za - dealer vyhr√°v√°!</div><div style="color: #f44336;">-${window.warBet} üé´</div>`;
                    SoundSystem.play('damage');
                }
                
                resultHtml += `<button class="btn" onclick="showWarGame()" style="margin-top: 0.5rem; background: #333;">üîÑ Znovu</button>`;
                document.getElementById('warResult').innerHTML = resultHtml;
                document.getElementById('warMoney').textContent = getCasinoTokens() + ' üé´';
                saveGame(true);
            }, 500);
        }
        
        // === CRAPS ===
        function showCraps() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.crapsBet = 0;
            window.crapsBetType = 'pass';
            window.crapsPoint = 0;
            window.crapsPhase = 'betting';
            
            renderCraps();
        }
        
        function renderCraps() {
            showModal('üé≤ Craps', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('craps')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">‚ùì Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="crapsMoney">${getCasinoTokens()} üé´</p>
                </div>
                
                <div style="background: #0a3a0a; padding: 1rem; border-radius: 8px; border: 3px solid #4caf50; margin: 0.5rem 0;">
                    <div style="display: flex; justify-content: center; gap: 1rem;" id="crapsDice">
                        <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000;">?</div>
                        <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000;">?</div>
                    </div>
                    ${window.crapsPoint > 0 ? `<div style="text-align: center; margin-top: 0.5rem; color: #ffd700;">Point: ${window.crapsPoint}</div>` : ''}
                </div>
                
                <div id="crapsResult" style="text-align: center; min-height: 40px; margin: 0.5rem 0;"></div>
                
                ${window.crapsPhase === 'betting' ? `
                    <div style="margin-bottom: 0.5rem;">
                        <label style="color: #888; font-size: 0.8rem;">Typ s√°zky:</label>
                        <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="window.crapsBetType='pass';renderCraps()" style="flex:1;background:${window.crapsBetType==='pass'?'#4caf50':'#333'};">Pass</button>
                            <button class="btn" onclick="window.crapsBetType='dontpass';renderCraps()" style="flex:1;background:${window.crapsBetType==='dontpass'?'#f44336':'#333'};">Don't Pass</button>
                        </div>
                        <div style="color: #666; font-size: 0.7rem; margin-top: 0.3rem;">
                            ${window.crapsBetType === 'pass' ? 'Come-out: 7,11=v√Ωhra, 2,3,12=prohra' : 'Come-out: 2,3=v√Ωhra, 7,11=prohra, 12=push'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <label style="color: #888; font-size: 0.8rem;">S√°zka:</label>
                        <div style="display: flex; gap: 0.3rem; margin-top: 0.3rem;">
                            <button class="btn" onclick="window.crapsBet=10;renderCraps()" style="flex:1;background:${window.crapsBet===10?'#ffd700':'#333'};color:${window.crapsBet===10?'#000':'#fff'};">10</button>
                            <button class="btn" onclick="window.crapsBet=25;renderCraps()" style="flex:1;background:${window.crapsBet===25?'#ffd700':'#333'};color:${window.crapsBet===25?'#000':'#fff'};">25</button>
                            <button class="btn" onclick="window.crapsBet=50;renderCraps()" style="flex:1;background:${window.crapsBet===50?'#ffd700':'#333'};color:${window.crapsBet===50?'#000':'#fff'};">50</button>
                            <button class="btn" onclick="window.crapsBet=100;renderCraps()" style="flex:1;background:${window.crapsBet===100?'#ffd700':'#333'};color:${window.crapsBet===100?'#000':'#fff'};">100</button>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="rollCraps()" style="width: 100%; background: linear-gradient(135deg, #1a3a3a 0%, #2d5a5a 100%); padding: 0.8rem;" ${window.crapsBet === 0 ? 'disabled' : ''}>
                        üé≤ Hodit kostky!
                    </button>
                ` : `
                    <button class="btn" onclick="rollCraps()" style="width: 100%; background: linear-gradient(135deg, #1a3a3a 0%, #2d5a5a 100%); padding: 0.8rem;">
                        üé≤ Hodit znovu (Point: ${window.crapsPoint})
                    </button>
                `}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function rollCraps() {
            if (window.crapsPhase === 'betting') {
                if (window.crapsBet === 0) return;
                if (getCasinoTokens() < window.crapsBet) {
                    notifyError('M√°lo ≈æeton≈Ø!', `Pot≈ôebuje≈° ${window.crapsBet} üé´`);
                    return;
                }
                addCasinoTokens(-window.crapsBet);
                
                // Daily quest progress
                if (state.dailyQuests?.progress) {
                    addCasinoGambledProgress();
                    checkDailyQuests();
                }
            }
            
            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;
            const total = die1 + die2;
            
            const diceEmojis = ['', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            document.getElementById('crapsDice').innerHTML = `
                <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">${diceEmojis[die1]}</div>
                <div style="width: 50px; height: 50px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">${diceEmojis[die2]}</div>
            `;
            
            SoundSystem.play('click');
            
            let resultHtml = `<div style="color: #888;">Souƒçet: ${total}</div>`;
            let gameOver = false;
            
            if (window.crapsPhase === 'betting') {
                // Come-out roll
                if (window.crapsBetType === 'pass') {
                    if (total === 7 || total === 11) {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">üéâ Natural! +${win} üé´</div>`;
                        gameOver = true;
                        SoundSystem.play('victory');
                    } else if (total === 2 || total === 3 || total === 12) {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">üíÄ Craps! -${window.crapsBet} üé´</div>`;
                        gameOver = true;
                        SoundSystem.play('damage');
                    } else {
                        window.crapsPoint = total;
                        window.crapsPhase = 'point';
                        resultHtml += `<div style="color: #ff9800;">Point nastaven: ${total}</div>`;
                    }
                } else {
                    if (total === 2 || total === 3) {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">üéâ V√Ωhra! +${win} üé´</div>`;
                        gameOver = true;
                        SoundSystem.play('victory');
                    } else if (total === 12) {
                        addCasinoTokens(window.crapsBet);
                        resultHtml += `<div style="color: #ff9800;">Push - s√°zka vr√°cena</div>`;
                        gameOver = true;
                    } else if (total === 7 || total === 11) {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">üíÄ Prohra! -${window.crapsBet} üé´</div>`;
                        gameOver = true;
                        SoundSystem.play('damage');
                    } else {
                        window.crapsPoint = total;
                        window.crapsPhase = 'point';
                        resultHtml += `<div style="color: #ff9800;">Point nastaven: ${total}</div>`;
                    }
                }
            } else {
                // Point phase
                if (total === window.crapsPoint) {
                    if (window.crapsBetType === 'pass') {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">üéâ Point! +${win} üé´</div>`;
                        SoundSystem.play('victory');
                    } else {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">üíÄ Point - prohra! -${window.crapsBet} üé´</div>`;
                        SoundSystem.play('damage');
                    }
                    gameOver = true;
                } else if (total === 7) {
                    if (window.crapsBetType === 'pass') {
                        state.casinoStats.totalLost += window.crapsBet;
                        resultHtml += `<div style="color: #f44336;">üíÄ Seven out! -${window.crapsBet} üé´</div>`;
                        SoundSystem.play('damage');
                    } else {
                        const win = window.crapsBet * 2;
                        addCasinoTokens(win);
                        state.casinoStats.totalWon += window.crapsBet;
                        resultHtml += `<div style="color: #4caf50;">üéâ Seven out - v√Ωhra! +${win} üé´</div>`;
                        SoundSystem.play('victory');
                    }
                    gameOver = true;
                } else {
                    resultHtml += `<div style="color: #888;">H√°ze≈° d√°l... (Point: ${window.crapsPoint})</div>`;
                }
            }
            
            if (gameOver) {
                resultHtml += `<button class="btn" onclick="showCraps()" style="margin-top: 0.5rem; background: #333;">üîÑ Nov√° hra</button>`;
                window.crapsPhase = 'betting';
                window.crapsPoint = 0;
            }
            
            document.getElementById('crapsResult').innerHTML = resultHtml;
            document.getElementById('crapsMoney').textContent = getCasinoTokens() + ' üé´';
            saveGame(true);
            
            if (!gameOver) {
                setTimeout(renderCraps, 100);
            }
        }
        
        // === KENO ===
        function showKeno() {
            if (!state.casinoStats) state.casinoStats = { totalWon: 0, totalLost: 0 };
            window.kenoSelected = [];
            window.kenoBet = 10;
            window.kenoDrawn = [];
            window.kenoPhase = 'selecting';
            
            renderKeno();
        }
        
        function renderKeno() {
            const gridHtml = Array.from({length: 40}, (_, i) => {
                const num = i + 1;
                const isSelected = window.kenoSelected.includes(num);
                const isDrawn = window.kenoDrawn.includes(num);
                const isHit = isSelected && isDrawn;
                
                let bg = '#333';
                if (isHit) bg = '#4caf50';
                else if (isSelected) bg = '#ffd700';
                else if (isDrawn) bg = '#666';
                
                return `<button onclick="toggleKenoNumber(${num})" style="width: 100%; aspect-ratio: 1; background: ${bg}; border: none; border-radius: 4px; color: ${isSelected ? '#000' : '#fff'}; font-weight: bold; font-size: 0.8rem; cursor: pointer;" ${window.kenoPhase !== 'selecting' ? 'disabled' : ''}>${num}</button>`;
            }).join('');
            
            const hits = window.kenoSelected.filter(n => window.kenoDrawn.includes(n)).length;
            
            showModal('üî¢ Keno', `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn" onclick="showGameRules('keno')" style="padding: 0.3rem 0.6rem; background: #333; font-size: 0.75rem;">‚ùì Pravidla</button>
                    <p style="color: #ffd700; font-weight: bold; margin: 0;" id="kenoMoney">${getCasinoTokens()} üé´</p>
                </div>
                <div style="text-align: center;">
                    <p style="color: #888; font-size: 0.75rem; margin: 0.3rem 0;">Vyber a≈æ 10 ƒç√≠sel (1-40)</p>
                    <p style="color: #4caf50; margin: 0;">Vybr√°no: ${window.kenoSelected.length}/10</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin: 0.5rem 0;">
                    ${gridHtml}
                </div>
                
                <div id="kenoResult" style="text-align: center; min-height: 30px;">
                    ${window.kenoPhase === 'result' ? `<div style="color: #4caf50;">Trefy: ${hits}/${window.kenoSelected.length}</div>` : ''}
                </div>
                
                ${window.kenoPhase === 'selecting' ? `
                    <div style="display: flex; gap: 0.3rem; margin: 0.5rem 0;">
                        <button class="btn" onclick="window.kenoBet=10;renderKeno()" style="flex:1;background:${window.kenoBet===10?'#ffd700':'#333'};color:${window.kenoBet===10?'#000':'#fff'};">10üé´</button>
                        <button class="btn" onclick="window.kenoBet=25;renderKeno()" style="flex:1;background:${window.kenoBet===25?'#ffd700':'#333'};color:${window.kenoBet===25?'#000':'#fff'};">25üé´</button>
                        <button class="btn" onclick="window.kenoBet=50;renderKeno()" style="flex:1;background:${window.kenoBet===50?'#ffd700':'#333'};color:${window.kenoBet===50?'#000':'#fff'};">50üé´</button>
                    </div>
                    
                    <button class="btn" onclick="playKeno()" style="width: 100%; background: linear-gradient(135deg, #3a3a1a 0%, #5a5a2d 100%); padding: 0.8rem;" ${window.kenoSelected.length === 0 ? 'disabled' : ''}>
                        üé± Losovat!
                    </button>
                ` : `
                    <button class="btn" onclick="showKeno()" style="width: 100%; background: #333; margin-top: 0.5rem;">
                        üîÑ Nov√° hra
                    </button>
                `}
                
                <button class="btn" onclick="showCasinoMain()" style="width: 100%; margin-top: 0.5rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function toggleKenoNumber(num) {
            if (window.kenoPhase !== 'selecting') return;
            
            const idx = window.kenoSelected.indexOf(num);
            if (idx >= 0) {
                window.kenoSelected.splice(idx, 1);
            } else if (window.kenoSelected.length < 10) {
                window.kenoSelected.push(num);
            }
            renderKeno();
        }
        
        function playKeno() {
            if (window.kenoSelected.length === 0) return;
            if (getCasinoTokens() < window.kenoBet) {
                notifyError('M√°lo ≈æeton≈Ø!', `Pot≈ôebuje≈° ${window.kenoBet} üé´`);
                return;
            }
            
            addCasinoTokens(-window.kenoBet);
            window.kenoPhase = 'drawing';
            
            // Losuj 10 ƒç√≠sel z 40
            const numbers = Array.from({length: 40}, (_, i) => i + 1);
            window.kenoDrawn = [];
            for (let i = 0; i < 10; i++) {
                const idx = Math.floor(Math.random() * numbers.length);
                window.kenoDrawn.push(numbers.splice(idx, 1)[0]);
            }
            
            SoundSystem.play('click');
            
            // Spoƒç√≠tej trefy
            const hits = window.kenoSelected.filter(n => window.kenoDrawn.includes(n)).length;
            const selected = window.kenoSelected.length;
            
            // V√Ωplatn√≠ tabulka - upraven√° pro lep≈°√≠ RTP (~80%)
            const payouts = {
                1: { 1: 3.5 },
                2: { 1: 1, 2: 12 },
                3: { 2: 2.5, 3: 25 },
                4: { 2: 1.5, 3: 6, 4: 40 },
                5: { 2: 1, 3: 4, 4: 15, 5: 80 },
                6: { 3: 2, 4: 6, 5: 25, 6: 150 },
                7: { 3: 1.5, 4: 4, 5: 12, 6: 50, 7: 300 },
                8: { 4: 2, 5: 6, 6: 25, 7: 100, 8: 800 },
                9: { 4: 1.5, 5: 4, 6: 15, 7: 50, 8: 300, 9: 1500 },
                10: { 5: 2, 6: 6, 7: 25, 8: 150, 9: 800, 10: 3000 }
            };
            
            const multiplier = payouts[selected]?.[hits] || 0;
            const winnings = window.kenoBet * multiplier;
            
            window.kenoPhase = 'result';
            
            // P≈ôiƒçti progress pro denn√≠ √∫kol
            addCasinoGambledProgress();
            
            setTimeout(() => {
                let resultHtml = `<div style="color: #888;">Trefy: ${hits}/${selected}</div>`;
                
                if (winnings > 0) {
                    addCasinoTokens(winnings);
                    state.casinoStats.totalWon += winnings - window.kenoBet;
                    resultHtml += `<div style="color: #4caf50; font-size: 1.2rem;">üéâ V√Ωhra! +${winnings} üé´ (${multiplier}x)</div>`;
                    SoundSystem.play('victory');
                } else {
                    state.casinoStats.totalLost += window.kenoBet;
                    resultHtml += `<div style="color: #f44336;">≈Ω√°dn√° v√Ωhra</div>`;
                    SoundSystem.play('damage');
                }
                
                document.getElementById('kenoResult').innerHTML = resultHtml;
                document.getElementById('kenoMoney').textContent = getCasinoTokens() + ' üé´';
                saveGame(true);
                renderKeno();
            }, 500);
        }
        
        function visitBucoviceHealer() {
            // Zkontroluj bonus od NPC
            const npcBonuses = getNPCBonuses();
            const isFreeHealing = npcBonuses.freeHealing;
            
            const healCost = isFreeHealing ? 0 : Math.max(10, Math.floor((state.char.maxHp - state.char.hp) / 2));
            const radCost = isFreeHealing ? 0 : Math.max(20, (state.status.radiation || 0) * 2);
            
            const now = Date.now();
            const healCooldown = 30 * 60 * 1000;
            const radCooldown = 60 * 60 * 1000;
            
            const healReady = !state.lastHealTime || (now - state.lastHealTime) >= healCooldown;
            const radReady = !state.lastRadCureTime || (now - state.lastRadCureTime) >= radCooldown;
            
            const healMinsLeft = healReady ? 0 : Math.ceil((healCooldown - (now - state.lastHealTime)) / 60000);
            const radMinsLeft = radReady ? 0 : Math.ceil((radCooldown - (now - state.lastRadCureTime)) / 60000);
            
            const freeHealingNote = isFreeHealing ? '<div style="background: #1a3a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; border: 1px solid #4caf50;"><span style="color: #8bc34a;">‚ú® L√©ƒçen√≠ ZDARMA d√≠ky d≈Øvƒõ≈ôe u Doktora!</span></div>' : '';
            
            showModal('üè• L√©ƒçitel Marek', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üë®‚Äç‚öïÔ∏è</div>
                    <p style="color: #888;">"Uka≈æ, co tƒõ bol√≠..."</p>
                </div>
                
                ${freeHealingNote}
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>‚ù§Ô∏è Zdrav√≠:</span>
                        <span>${state.char.hp}/${state.char.maxHp}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>‚ò¢Ô∏è Radiace:</span>
                        <span>${state.status.radiation || 0}</span>
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="healAtBucovice()" style="background: ${healReady && state.char.hp < state.char.maxHp ? '#4CAF50' : '#333'}; ${!healReady || state.char.hp >= state.char.maxHp ? 'opacity: 0.6;' : ''}">
                        ‚ù§Ô∏è Vyl√©ƒçit ${healCost > 0 ? '(' + healCost + ' üí∞)' : '(ZDARMA)'} ${!healReady ? '‚è≥ ' + healMinsLeft + 'min' : ''}
                    </button>
                    <button class="btn" onclick="cureRadiationAtBucovice()" style="background: ${radReady && (state.status.radiation || 0) > 0 ? '#ff9800' : '#333'}; ${!radReady || (state.status.radiation || 0) <= 0 ? 'opacity: 0.6;' : ''}">
                        ‚ò¢Ô∏è Odstranit radiaci ${radCost > 0 ? '(' + radCost + ' üí∞)' : '(ZDARMA)'} ${!radReady ? '‚è≥ ' + radMinsLeft + 'min' : ''}
                    </button>
                </div>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.5rem;">‚è∞ L√©ƒçba: 30min cooldown | Dekontaminace: 60min cooldown</p>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Odej√≠t</button>
            `);
        }
        
        function healAtBucovice() {
            const npcBonuses = getNPCBonuses();
            const isFreeHealing = npcBonuses.freeHealing;
            const cost = isFreeHealing ? 0 : Math.max(10, Math.floor((state.char.maxHp - state.char.hp) / 2));
            
            if (state.char.hp >= state.char.maxHp) {
                notifyInfo('Jsi zdrav√Ω', 'Nepot≈ôebuje≈° l√©ƒçen√≠');
                return;
            }
            if (!isFreeHealing && getMoney() < cost) {
                notifyError('M√°lo penƒõz!', `Pot≈ôebuje≈° ${cost} üí∞`);
                return;
            }
            
            // Cooldown check - 1x za 30 minut re√°ln√©ho ƒçasu
            const now = Date.now();
            const cooldown = 30 * 60 * 1000; // 30 minut
            if (state.lastHealTime && (now - state.lastHealTime) < cooldown) {
                const minsLeft = Math.ceil((cooldown - (now - state.lastHealTime)) / 60000);
                notifyWarning('L√©ƒçitel odpoƒç√≠v√°', `Zkus to za ${minsLeft} minut`);
                return;
            }
            
            if (cost > 0) removeMoney(cost);
            state.char.hp = state.char.maxHp;
            state.lastHealTime = now;
            
            notifySuccess('‚ù§Ô∏è Vyl√©ƒçen!', isFreeHealing ? 'Zdarma d√≠ky Doktorovi!' : 'Pln√© zdrav√≠');
            renderFull();
            visitBucoviceHealer();
        }
        
        function cureRadiationAtBucovice() {
            const npcBonuses = getNPCBonuses();
            const isFreeHealing = npcBonuses.freeHealing;
            const cost = isFreeHealing ? 0 : Math.max(20, (state.status.radiation || 0) * 2);
            
            if ((state.status.radiation || 0) <= 0) {
                notifyInfo('ƒåist√Ω', 'Nem√°≈° radiaci');
                return;
            }
            if (!isFreeHealing && getMoney() < cost) {
                notifyError('M√°lo penƒõz!', `Pot≈ôebuje≈° ${cost} üí∞`);
                return;
            }
            
            // Cooldown check - 1x za 60 minut re√°ln√©ho ƒçasu
            const now = Date.now();
            const cooldown = 60 * 60 * 1000; // 60 minut
            if (state.lastRadCureTime && (now - state.lastRadCureTime) < cooldown) {
                const minsLeft = Math.ceil((cooldown - (now - state.lastRadCureTime)) / 60000);
                notifyWarning('Dekontaminace nen√≠ p≈ôipravena', `Zkus to za ${minsLeft} minut`);
                return;
            }
            
            if (cost > 0) removeMoney(cost);
            state.status.radiation = 0;
            state.lastRadCureTime = now;
            
            notifySuccess('‚ò¢Ô∏è Oƒçi≈°tƒõn!', isFreeHealing ? 'Zdarma d√≠ky Doktorovi!' : 'Radiace odstranƒõna');
            renderFull();
            visitBucoviceHealer();
        }
        
        // === BOUNTY SYST√âM - N√ÅSTƒöNKA BUƒåOVIC ===
        const BOUNTIES = [
            // Loveck√© bounty
            { id: 'hunt_wolves', name: 'Vlƒç√≠ smeƒçka', desc: 'Zabij 3 vlky', icon: 'üê∫', type: 'kill', target: 'wolf', amount: 3, reward: { money: 120, xp: 80 }, zone: 'medium' },
            { id: 'hunt_mutants', name: 'Mutant√≠ hrozba', desc: 'Zabij 5 mutant≈Ø', icon: '‚ò£Ô∏è', type: 'kill', target: 'mutant', amount: 5, reward: { money: 200, xp: 150 }, zone: 'danger' },
            { id: 'hunt_raiders', name: 'N√°jezdn√≠ci', desc: 'Zabij 5 n√°jezdn√≠k≈Ø', icon: '‚öîÔ∏è', type: 'kill', target: 'raider', amount: 5, reward: { money: 180, xp: 120 }, zone: 'medium' },
            { id: 'hunt_ghouls', name: 'Gh√∫l√≠ oƒçista', desc: 'Zabij 4 gh√∫ly', icon: 'üíÄ', type: 'kill', target: 'ghoul', amount: 4, reward: { money: 150, xp: 100 }, zone: 'danger' },
            { id: 'hunt_robots', name: 'Kovov√° hrozba', desc: 'Zniƒç 3 roboty', icon: 'ü§ñ', type: 'kill', target: 'robot', amount: 3, reward: { money: 250, xp: 180 }, zone: 'deadly' },
            
            // Boss hunt bounties (deadly)
            { id: 'hunt_deathclaw', name: 'Zabij√°k Deathclaw≈Ø', desc: 'Zabij Deathclawa', icon: 'ü¶ñ', type: 'kill', target: 'deathclaw', amount: 1, reward: { money: 500, xp: 400 }, zone: 'deadly' },
            { id: 'hunt_behemoth', name: 'Lovec obr≈Ø', desc: 'Zabij Mutant Behemotha', icon: 'üëπ', type: 'kill', target: 'mutant_behemoth', amount: 1, reward: { money: 600, xp: 500 }, zone: 'deadly' },
            { id: 'hunt_glowing', name: 'Z√°≈ô√≠c√≠ smrt', desc: 'Zabij Z√°≈ô√≠c√≠ho', icon: '‚ò¢Ô∏è', type: 'kill', target: 'glowing_one', amount: 1, reward: { money: 400, xp: 300 }, zone: 'deadly' },
            
            // Sbƒõratelsk√© bounty
            { id: 'collect_scrap', name: '≈†rotov√° sb√≠rka', desc: 'P≈ôines 25 ≈°rotu', icon: 'üî©', type: 'resource', target: 'scrap', amount: 25, reward: { money: 100, xp: 50 } },
            { id: 'collect_metal', name: 'Kovov√° dod√°vka', desc: 'P≈ôines 20 kovu', icon: 'üîß', type: 'resource', target: 'metal', amount: 20, reward: { money: 150, xp: 60 } },
            { id: 'collect_herbs', name: 'Bylink√°≈ôstv√≠', desc: 'P≈ôines 15 bylin', icon: 'üåø', type: 'resource', target: 'herbs', amount: 15, reward: { money: 80, xp: 40 } },
            { id: 'collect_electronics', name: 'Elektronika', desc: 'P≈ôines 10 elektroniky', icon: 'üì±', type: 'resource', target: 'electronics', amount: 10, reward: { money: 180, xp: 70 } },
            { id: 'collect_fuel', name: 'Palivov√° krize', desc: 'P≈ôines 15 paliva', icon: '‚õΩ', type: 'resource', target: 'fuel', amount: 15, reward: { money: 200, xp: 80 } },
            
            // Pr≈Øzkumn√© bounty
            { id: 'explore_danger_zone', name: 'Nebezpeƒçn√Ω pr≈Øzkum', desc: 'Nav≈°tiv 3 nebezpeƒçn√© lokace', icon: 'üó∫Ô∏è', type: 'explore', target: 'danger', amount: 3, reward: { money: 200, xp: 150 } },
            { id: 'explore_deadly_zone', name: 'Smrteln√° v√Ωprava', desc: 'Nav≈°tiv 2 smrteln√© lokace', icon: 'üíÄ', type: 'explore', target: 'deadly', amount: 2, reward: { money: 350, xp: 250 } },
            { id: 'explore_dungeons', name: 'Dungeon Diver', desc: 'Prozkoumej 2 dungeony', icon: 'üèöÔ∏è', type: 'explore', target: 'dungeon', amount: 2, reward: { money: 250, xp: 200 } }
        ];
        
        function showBucoviceBounties() {
            // Inicializace bounty state
            if (!state.bounties) {
                state.bounties = {
                    active: [],
                    completed: [],
                    lastRefresh: Date.now()
                };
            }
            
            // Refresh bounties ka≈æd√Ωch 24 hodin (hern√≠ho ƒçasu) nebo p≈ôi nov√©m dni
            const now = Date.now();
            if (!state.bounties.dailyBounties || state.bounties.lastDay !== state.day) {
                generateDailyBounties();
                state.bounties.lastDay = state.day;
            }
            
            const dailyBounties = state.bounties.dailyBounties || [];
            const activeBounty = state.bounties.active?.[0];
            
            let html = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem;">üìú</div>
                    <p style="color: #888;">Denn√≠ √∫koly od mƒõstsk√© rady</p>
                    <p style="color: #ffd700; font-size: 0.8rem;">Den ${state.day || 1} - Nov√© √∫koly ka≈æd√Ω den</p>
                </div>
            `;
            
            // Aktivn√≠ bounty
            if (activeBounty) {
                const bountyDef = BOUNTIES.find(b => b.id === activeBounty.id);
                if (bountyDef) {
                    const progress = getBountyProgress(activeBounty);
                    const isComplete = progress >= bountyDef.amount;
                    
                    html += `
                        <div style="background: linear-gradient(135deg, #1a3a1a, #0a2a0a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid ${isComplete ? '#4caf50' : '#ff9800'};">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">${bountyDef.icon}</span>
                                <div>
                                    <div style="color: #ff9800; font-weight: bold;">üîÑ AKTIVN√ç: ${bountyDef.name}</div>
                                    <div style="color: #888; font-size: 0.85rem;">${bountyDef.desc}</div>
                                </div>
                            </div>
                            <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                    <span>Progres:</span>
                                    <span style="color: ${isComplete ? '#4caf50' : '#fff'};">${progress}/${bountyDef.amount}</span>
                                </div>
                                <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${Math.min(100, (progress / bountyDef.amount) * 100)}%; background: ${isComplete ? '#4caf50' : '#ff9800'};"></div>
                                </div>
                            </div>
                            <div style="color: #ffd700; font-size: 0.85rem;">üéÅ Odmƒõna: ${bountyDef.reward.money} üí∞, ${bountyDef.reward.xp} XP</div>
                            ${isComplete ? `
                                <button class="btn" onclick="completeBounty('${activeBounty.id}')" style="width: 100%; margin-top: 0.5rem; background: #4caf50;">
                                    ‚úÖ Odevzdat bounty
                                </button>
                            ` : `
                                <button class="btn" onclick="abandonBounty()" style="width: 100%; margin-top: 0.5rem; background: #c62828;">
                                    ‚ùå Vzd√°t se
                                </button>
                            `}
                        </div>
                    `;
                }
            }
            
            // Dostupn√© bounties
            html += `<div style="margin-bottom: 0.5rem; color: #aaa; font-size: 0.9rem;">Dostupn√© √∫koly:</div>`;
            
            dailyBounties.forEach(bountyId => {
                const bounty = BOUNTIES.find(b => b.id === bountyId);
                if (!bounty) return;
                
                const isActive = activeBounty?.id === bountyId;
                const isCompleted = state.bounties.completed?.includes(bountyId);
                
                if (isCompleted) {
                    html += `
                        <div style="padding: 0.6rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem; opacity: 0.5;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.3rem;">${bounty.icon}</span>
                                <div style="flex: 1;">
                                    <div style="color: #4caf50;">‚úì ${bounty.name}</div>
                                    <div style="color: #666; font-size: 0.8rem;">Dokonƒçeno</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (!isActive) {
                    html += `
                        <div style="padding: 0.6rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.4rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.3rem;">${bounty.icon}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff; font-weight: bold;">${bounty.name}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${bounty.desc}</div>
                                    <div style="color: #ffd700; font-size: 0.75rem;">üéÅ ${bounty.reward.money} üí∞, ${bounty.reward.xp} XP</div>
                                </div>
                                ${!activeBounty ? `
                                    <button class="btn" onclick="acceptBounty('${bounty.id}')" style="padding: 0.4rem 0.8rem; background: #ff9800;">
                                        P≈ôijmout
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Statistiky
            const completedToday = state.bounties.completed?.length || 0;
            html += `
                <div style="margin-top: 1rem; padding: 0.5rem; background: #0a0a0a; border-radius: 6px; text-align: center;">
                    <span style="color: #888; font-size: 0.8rem;">Dnes dokonƒçeno: ${completedToday}/3</span>
                </div>
            `;
            
            html += `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${t('ui', 'close')}</button>`;
            
            showModal('üìú N√°stƒõnka odmƒõn', html);
        }
        
        function generateDailyBounties() {
            // Vyber 3 n√°hodn√© bounties - mix typ≈Ø
            const killBounties = BOUNTIES.filter(b => b.type === 'kill');
            const resourceBounties = BOUNTIES.filter(b => b.type === 'resource');
            const exploreBounties = BOUNTIES.filter(b => b.type === 'explore');
            
            const daily = [];
            
            // 1 loveck√°
            if (killBounties.length > 0) {
                daily.push(killBounties[Math.floor(Math.random() * killBounties.length)].id);
            }
            
            // 1 sbƒõratelsk√°
            if (resourceBounties.length > 0) {
                let rb;
                do {
                    rb = resourceBounties[Math.floor(Math.random() * resourceBounties.length)];
                } while (daily.includes(rb.id));
                daily.push(rb.id);
            }
            
            // 1 pr≈Øzkumn√°
            if (exploreBounties.length > 0) {
                let eb;
                do {
                    eb = exploreBounties[Math.floor(Math.random() * exploreBounties.length)];
                } while (daily.includes(eb.id));
                daily.push(eb.id);
            }
            
            state.bounties.dailyBounties = daily;
            state.bounties.completed = []; // Reset completed p≈ôi nov√©m dni
            state.bounties.active = [];
        }
        
        function acceptBounty(bountyId) {
            const bounty = BOUNTIES.find(b => b.id === bountyId);
            if (!bounty) return;
            
            if (state.bounties.active?.length > 0) {
                notifyError('M√°≈° aktivn√≠ bounty', 'Nejd≈ô√≠v ji dokonƒçi nebo se vzdej');
                return;
            }
            
            state.bounties.active = [{
                id: bountyId,
                startKills: { ...state.stats?.killsByType } || {},
                startExplored: [...(state.world?.visitedLocations || [])],
                acceptedAt: Date.now()
            }];
            
            notifySuccess('üìú Bounty p≈ôijata!', bounty.name);
            addLog(`P≈ôijata bounty: ${bounty.name}`, 'üìú');
            showBucoviceBounties();
        }
        
        function getBountyProgress(activeBounty) {
            const bounty = BOUNTIES.find(b => b.id === activeBounty.id);
            if (!bounty) return 0;
            
            if (bounty.type === 'kill') {
                // Poƒç√≠tej kills od p≈ôijet√≠
                const startKills = activeBounty.startKills?.[bounty.target] || 0;
                const currentKills = state.stats?.killsByType?.[bounty.target] || 0;
                return currentKills - startKills;
            }
            
            if (bounty.type === 'resource') {
                // Aktu√°ln√≠ mno≈æstv√≠ suroviny - kontroluj v osadƒõ I v hr√°ƒçovƒõ invent√°≈ôi
                const settlementAmount = state.settlement?.resources?.[bounty.target] || 0;
                const playerAmount = state.resources?.[bounty.target] || 0;
                console.log(`üîç Bounty resource check: ${bounty.target} - settlement: ${settlementAmount}, player: ${playerAmount}`);
                return settlementAmount + playerAmount;
            }
            
            if (bounty.type === 'explore') {
                // Poƒç√≠tej novƒõ nav≈°t√≠ven√© lokace dan√©ho typu od p≈ôijet√≠
                const startLocs = activeBounty.startExplored || [];
                const currentLocs = state.world?.visitedLocations || [];
                const newLocs = currentLocs.filter(l => !startLocs.includes(l));
                
                if (bounty.target === 'danger' || bounty.target === 'deadly') {
                    return newLocs.filter(locId => {
                        const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                        return loc?.zone === bounty.target;
                    }).length;
                }
                
                if (bounty.target === 'dungeon') {
                    return newLocs.filter(locId => {
                        const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                        return loc?.type === 'dungeon';
                    }).length;
                }
            }
            
            return 0;
        }
        
        function completeBounty(bountyId) {
            const bounty = BOUNTIES.find(b => b.id === bountyId);
            if (!bounty) return;
            
            const activeBounty = state.bounties.active?.[0];
            if (!activeBounty || activeBounty.id !== bountyId) return;
            
            const progress = getBountyProgress(activeBounty);
            if (progress < bounty.amount) {
                notifyError('Nesplnƒõno', `Pot≈ôebuje≈°: ${bounty.amount}, m√°≈°: ${progress}`);
                return;
            }
            
            // Odeber suroviny pokud je to resource bounty
            if (bounty.type === 'resource') {
                let toRemove = bounty.amount;
                
                // Nejd≈ô√≠ve odeber z hr√°ƒçov√Ωch zdroj≈Ø
                const playerHas = state.resources?.[bounty.target] || 0;
                if (playerHas > 0) {
                    const removeFromPlayer = Math.min(playerHas, toRemove);
                    state.resources[bounty.target] -= removeFromPlayer;
                    toRemove -= removeFromPlayer;
                }
                
                // Pak z osady
                if (toRemove > 0 && state.settlement?.resources) {
                    state.settlement.resources[bounty.target] = (state.settlement.resources[bounty.target] || 0) - toRemove;
                }
            }
            
            // Dej odmƒõny
            addMoney(bounty.reward.money);
            addXP(bounty.reward.xp);
            
            // Oznaƒç jako dokonƒçen√©
            if (!state.bounties.completed) state.bounties.completed = [];
            state.bounties.completed.push(bountyId);
            state.bounties.active = [];
            
            notifySuccess('üìú Bounty dokonƒçena!', `+${bounty.reward.money} üí∞, +${bounty.reward.xp} XP`);
            addLog(`Bounty dokonƒçena: ${bounty.name}`, 'üèÜ');
            
            closeModal();
            renderFull();
            
            // Znovu otev≈ôi n√°stƒõnku
            setTimeout(() => showBucoviceBounties(), 300);
        }
        
        function abandonBounty() {
            if (!state.bounties.active?.length) return;
            
            const activeBounty = state.bounties.active[0];
            const bounty = BOUNTIES.find(b => b.id === activeBounty.id);
            
            showModal('‚ùå Vzd√°t se bounty?', `
                <p style="color: #aaa;">Opravdu se chce≈° vzd√°t √∫kolu "${bounty?.name}"?</p>
                <p style="color: #ff9800;">M≈Ø≈æe≈° ho znovu p≈ôijmout, ale progres se resetuje.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal(); showBucoviceBounties();" style="background: #555;">' + t('ui', 'cancel') + '</button>
                    <button class="btn" onclick="confirmAbandonBounty()" style="background: #c62828;">Vzd√°t se</button>
                </div>
            `);
        }
        
        function confirmAbandonBounty() {
            state.bounties.active = [];
            notifyInfo('Bounty zru≈°ena', 'M≈Ø≈æe≈° p≈ôijmout jinou');
            closeModal();
            showBucoviceBounties();
        }
        
        function restAtBucovice() {
            const now = Date.now();
            const cooldown = 4 * 60 * 60 * 1000; // 4 hodiny
            const isReady = !state.lastHotelTime || (now - state.lastHotelTime) >= cooldown;
            const hoursLeft = isReady ? 0 : Math.ceil((cooldown - (now - state.lastHotelTime)) / (60 * 60 * 1000));
            
            if (getMoney() < 20) {
                notifyError('M√°lo penƒõz!', 'Nocleh stoj√≠ 20 üí∞');
                return;
            }
            
            showModal('üè® Hotel "Nov√° Nadƒõje"', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üõèÔ∏è</div>
                    <p style="color: #888;">ƒåist√Ω pokoj, tepl√° postel, bezpeƒç√≠.</p>
                </div>
                
                <p style="text-align: center; color: #aaa;">P≈ôesp√°n√≠ za 20 üí∞ dopln√≠:</p>
                <ul style="color: #8bc34a; margin: 0.5rem 0;">
                    <li>‚ù§Ô∏è ${currentLang === "en" ? "Full health" : "Pln√© zdrav√≠"}</li>
                    <li>‚ö° Pln√° energie</li>
                </ul>
                
                ${!isReady ? `
                    <div style="background: #4d1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
                        <span style="color: #ff9800;">‚è≥ Nejsi unaven√Ω - m≈Ø≈æe≈° sp√°t za ${hoursLeft}h</span>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="confirmRestAtBucovice()" style="width: 100%; background: ${isReady ? '#3949AB' : '#333'}; ${!isReady ? 'opacity: 0.6;' : ''}">
                    üõèÔ∏è P≈ôespat (20 üí∞) ${!isReady ? '‚è≥' : ''}
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚úó Zru≈°it</button>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.5rem;">‚è∞ Cooldown: 4 hodiny re√°ln√©ho ƒçasu</p>
            `);
        }
        
        function confirmRestAtBucovice() {
            if (getMoney() < 20) {
                notifyError('M√°lo penƒõz!', 'Nocleh stoj√≠ 20 üí∞');
                return;
            }
            
            // Cooldown check - 1x za 4 hodiny re√°ln√©ho ƒçasu
            const now = Date.now();
            const cooldown = 4 * 60 * 60 * 1000; // 4 hodiny
            if (state.lastHotelTime && (now - state.lastHotelTime) < cooldown) {
                const hoursLeft = Math.ceil((cooldown - (now - state.lastHotelTime)) / (60 * 60 * 1000));
                notifyWarning('Nejsi unaven√Ω', `M≈Ø≈æe≈° p≈ôespat za ${hoursLeft} hodin`);
                closeModal();
                return;
            }
            
            removeMoney(20);
            state.char.hp = state.char.maxHp;
            state.status.energy = 100;
            state.lastHotelTime = now;
            
            closeModal();
            notifySuccess('üò¥ Dob≈ôe jsi spal!', 'Pln√© zdrav√≠ a energie!');
            renderFull();
        }
        
        // === FIN√ÅLN√ç VOLBA ===
        function showFinalChoice(choice) {
            const karma = state.storyKarma || { kory: 0, koudy: 0 };
            
            let title, description, confirmText, color;
            
            if (choice === 'kory') {
                title = 'ü¶π P≈ôedat v≈°e Korymu';
                description = `
                    <p>Kory stoj√≠ p≈ôed tebou s ≈°√≠len√Ωm √∫smƒõvem:</p>
                    <p style="color: #e91e63; font-style: italic;">"V√Ωbornƒõ! Vƒõdƒõl jsem, ≈æe pochop√≠≈°. Slab√≠ mus√≠ odej√≠t, aby siln√≠ mohli vzkv√©tat. Dnes se rod√≠ NOV√ù SVƒöT!"</p>
                    <p style="color: #f44336; font-weight: bold;">‚ö†Ô∏è VAROV√ÅN√ç: Toto aktivuje Genesis v DESTRUKƒåN√çM re≈æimu!</p>
                `;
                confirmText = 'üíÄ P≈ôedat Korymu (Temn√Ω konec)';
                color = '#e91e63';
            } else if (choice === 'koudy') {
                title = 'üë®‚Äçüî¨ P≈ôedat v≈°e Koudymu';
                description = `
                    <p>Koudy m√° slzy v oƒç√≠ch:</p>
                    <p style="color: #2196f3; font-style: italic;">"Dƒõkuji ti, p≈ô√≠teli. Dnes zaƒç√≠n√° obnova. Bude to trvat roky, mo≈æn√° desetilet√≠, ale svƒõt se uzdrav√≠. M√°me NADƒöJI."</p>
                    <p style="color: #4caf50; font-weight: bold;">‚úì Toto aktivuje Genesis v L√âƒåEBN√âM re≈æimu.</p>
                `;
                confirmText = 'üåÖ P≈ôedat Koudymu (Konec nadƒõje)';
                color = '#2196f3';
            } else {
                title = 'üí• Zniƒçit komponenty';
                description = `
                    <p>Pod√≠v√°≈° se na oba bratry. Ani jeden si nezaslou≈æ√≠ takovou moc.</p>
                    <p style="color: #888; font-style: italic;">"NE! Co to dƒõl√°≈°?!" k≈ôiƒç√≠ oba najednou.</p>
                    <p style="color: #ff9800; font-weight: bold;">‚öñÔ∏è Projekt Genesis bude nav≈ædy ztracen. Svƒõt z≈Østane takov√Ω, jak√Ω je.</p>
                `;
                confirmText = 'üí• Zniƒçit v≈°e (Neutr√°ln√≠ konec)';
                color = '#f44336';
            }
            
            showModal(title, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    ${description}
                </div>
                
                <p style="color: #ffd700; text-align: center; font-weight: bold;">Tato volba je NEVRATN√Å!</p>
                
                <button class="btn" onclick="executeFinalChoice('${choice}')" style="width: 100%; background: ${color}; margin-top: 0.5rem;">
                    ${confirmText}
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Rozmyslet si to</button>
            `);
        }
        
        function executeFinalChoice(choice) {
            closeModal();
            
            // Odeber komponenty z invent√°≈ôe
            ['plutonium_core', 'quantum_stabilizer', 'fusion_cell', 'ai_module'].forEach(compId => {
                state.inv = state.inv.filter(i => i.id !== compId);
            });
            
            // Nastav ending
            let ending;
            if (choice === 'kory') {
                ending = STORY_ENDINGS.dark;
                state.storyKarma.ending = 'dark';
                state.storyKarma.kory += 50;
            } else if (choice === 'koudy') {
                ending = STORY_ENDINGS.hope;
                state.storyKarma.ending = 'hope';
                state.storyKarma.koudy += 50;
            } else {
                ending = STORY_ENDINGS.neutral;
                state.storyKarma.ending = 'neutral';
            }
            
            // Odmƒõny za dokonƒçen√≠ p≈ô√≠bƒõhu
            addXP(500);
            addMoney(500);
            
            // Dokonƒçi p≈ô√≠bƒõh
            state.mainQuest.storyComplete = true;
            state.mainQuest.currentQuest = null;
            if (!state.mainQuest.completedQuests) state.mainQuest.completedQuests = [];
            if (!state.mainQuest.completedQuests.includes('final_choice')) {
                state.mainQuest.completedQuests.push('final_choice');
            }
            
            // Zobraz ending
            setTimeout(() => {
                showModal(ending.title, `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 4rem;">${choice === 'kory' ? 'üåë' : choice === 'koudy' ? 'üåÖ' : '‚öñÔ∏è'}</div>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #aaa; line-height: 1.6;">${ending.description}</p>
                    </div>
                    
                    <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #1a3a1a, #2a4a2a); border-radius: 8px;">
                        <div style="font-size: 2rem;">üèÜ</div>
                        <h3 style="color: #ffd700; margin: 0.5rem 0;">P≈ò√çBƒöH DOKONƒåEN!</h3>
                        <p style="color: #8bc34a; font-size: 0.9rem;">+500 XP, +500 üí∞</p>
                        <p style="color: #888; font-size: 0.85rem;">M≈Ø≈æe≈° pokraƒçovat ve h≈ôe a prozkoum√°vat svƒõt.</p>
                    </div>
                    
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">
                        üéâ Pokraƒçovat ve h≈ôe
                    </button>
                `);
            }, 500);
            
            addLog(`P≈ò√çBƒöH DOKONƒåEN: ${ending.title}`, 'üèÜ');
            saveGame(true);
            renderFull();
        }
        
        // === STORY KARMA SYST√âM ===
        function showStoryKarma() {
            const karma = state.storyKarma || { kory: 0, koudy: 0, componentsGiven: { kory: 0, koudy: 0 } };
            
            // Urƒçen√≠ strany
            let sideText = '‚öñÔ∏è Nerozhodnut';
            let sideColor = '#888';
            if (karma.componentsGiven.kory > karma.componentsGiven.koudy) {
                sideText = 'ü¶π Na stranƒõ Koryho';
                sideColor = '#e91e63';
            } else if (karma.componentsGiven.koudy > karma.componentsGiven.kory) {
                sideText = 'üë®‚Äçüî¨ Na stranƒõ Koudyho';
                sideColor = '#2196f3';
            }
            
            // Karma bar
            const karmaBalance = karma.kory - karma.koudy;
            const barPosition = 50 + (karmaBalance / 2);
            
            showModal('‚öñÔ∏è Projekt Genesis - Karma', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">‚öõÔ∏è</div>
                    <h3 style="margin: 0.5rem 0;">Projekt Genesis</h3>
                    <p style="color: ${sideColor}; font-weight: bold;">${sideText}</p>
                </div>
                
                <!-- Karma Balance Bar -->
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #2196f3;">üë®‚Äçüî¨ Koudy</span>
                        <span style="color: #e91e63;">Kory ü¶π</span>
                    </div>
                    <div style="height: 20px; background: linear-gradient(90deg, #2196f3, #888, #e91e63); border-radius: 10px; position: relative;">
                        <div style="position: absolute; top: -5px; left: ${barPosition}%; transform: translateX(-50%); width: 10px; height: 30px; background: #fff; border-radius: 5px; border: 2px solid #000;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                        <span>???</span>
                        <span>‚öñÔ∏è</span>
                        <span>???</span>
                    </div>
                </div>
                
                <!-- Komponenty -->
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">üì¶ Komponenty p≈ôed√°ny:</div>
                    <div style="display: flex; justify-content: space-around;">
                        <div style="text-align: center;">
                            <div style="color: #2196f3;">üë®‚Äçüî¨ Koudy</div>
                            <div style="font-size: 1.5rem;">${karma.componentsGiven?.koudy || 0}/4</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #e91e63;">ü¶π Kory</div>
                            <div style="font-size: 1.5rem;">${karma.componentsGiven?.kory || 0}/4</div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistiky -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 0.8rem; border-radius: 8px; border: 2px solid #2196f3; text-align: center;">
                        <div style="font-size: 1.5rem;">üë®‚Äçüî¨</div>
                        <div style="color: #2196f3; font-weight: bold;">Koudy</div>
                        <div style="font-size: 1.2rem; color: #fff;">‚ù§Ô∏è ${karma.koudy}</div>
                        <div style="font-size: 0.75rem; color: #888;">???</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #2a1a2a, #1a0a1a); padding: 0.8rem; border-radius: 8px; border: 2px solid #e91e63; text-align: center;">
                        <div style="font-size: 1.5rem;">ü¶π</div>
                        <div style="color: #e91e63; font-weight: bold;">Kory</div>
                        <div style="font-size: 1.2rem; color: #fff;">‚ù§Ô∏è ${karma.kory}</div>
                        <div style="font-size: 0.75rem; color: #888;">???</div>
                    </div>
                </div>
                
                <!-- Info podle progressu -->
                ${(() => {
                    const completed = state.mainQuest?.completedQuests || [];
                    const knows_brothers = completed.includes('find_stranger') || completed.includes('meet_kory') || completed.includes('meet_koudy');
                    const knows_genesis = completed.includes('meet_kory') || completed.includes('meet_koudy');
                    const knows_components = completed.includes('first_component');
                    
                    if (knows_components) {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">üí° Oba hledaj√≠ komponenty k Projektu Genesis. Komu pom≈Ø≈æe≈°?</p></div>';
                    } else if (knows_genesis) {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">üí° Zjisti v√≠ce o Projektu Genesis a o tom, co oba mu≈æi pl√°nuj√≠.</p></div>';
                    } else if (knows_brothers) {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">üí° Dva z√°hadn√≠ mu≈æi. Kdo jsou a co chtƒõj√≠?</p></div>';
                    } else {
                        return '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;"><p style="margin: 0; font-size: 0.85rem; color: #aaa;">üí° Prozkoumej svƒõt a zjisti v√≠ce o tƒõchto z√°hadn√Ωch postav√°ch.</p></div>';
                    }
                })()}
                
                <button class="btn" onclick="closeModal()" style="width: 100%;">${t('ui', 'close')}</button>
            `);
        }
        
        function showStoryNPC(npcId) {
            console.log('showStoryNPC called with:', npcId);
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            console.log('Found NPC:', npc);
            if (!npc) {
                console.log('NPC not found!');
                return;
            }
            
            const karma = state.storyKarma || { kory: 0, koudy: 0 };
            const myKarma = karma[npcId] || 0;
            const rivalId = npc.rival;
            const rivalKarma = karma[rivalId] || 0;
            
            const relation = state.npcRelations?.[npcId] || { trust: 0, gifts: 0, quests: 0 };
            
            // N√°lada podle karmy
            let moodText, moodColor;
            if (myKarma >= 50) {
                moodText = '‚ù§Ô∏è Spojenec';
                moodColor = '#4caf50';
            } else if (myKarma >= 20) {
                moodText = 'üòä P≈ô√°telsk√Ω';
                moodColor = '#8bc34a';
            } else if (myKarma >= -20) {
                moodText = 'üòê Neutr√°ln√≠';
                moodColor = '#888';
            } else if (myKarma >= -50) {
                moodText = 'üò† Nep≈ô√°telsk√Ω';
                moodColor = '#ff9800';
            } else {
                moodText = 'üíÄ Nep≈ô√≠tel';
                moodColor = '#f44336';
            }
            
            const npcColor = npcId === 'kory' ? '#e91e63' : '#2196f3';
            const rivalName = rivalId === 'kory' ? 'Kory' : 'Koudy';
            
            // Aktivn√≠ quest
            const activeQuestId = state.npcQuests?.[npcId]?.id;
            let activeQuestHtml = '';
            
            if (activeQuestId) {
                const activeQuest = NPC_QUESTS[activeQuestId];
                if (activeQuest) {
                    const canComplete = checkStoryQuestRequirements(activeQuest.requirement);
                    const progressText = getStoryQuestProgress(activeQuest.requirement);
                    
                    activeQuestHtml = `
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid ${canComplete ? '#4caf50' : npcColor};">
                            <h4 style="margin: 0 0 0.5rem 0; color: ${npcColor};">üîÑ Aktivn√≠ √∫kol:</h4>
                            <div style="font-weight: bold;">${activeQuest.name}</div>
                            <div style="font-size: 0.85rem; color: #aaa; margin: 0.3rem 0;">${activeQuest.desc}</div>
                            <div style="font-size: 0.85rem; color: ${canComplete ? '#4caf50' : '#ff9800'}; margin: 0.5rem 0;">
                                üìä Progres: ${progressText}
                            </div>
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">
                                üéÅ Odmƒõna: ${activeQuest.reward.money || 0} üí∞
                            </div>
                            ${canComplete ? `
                                <button class="btn" onclick="turnInStoryQuest('${npcId}', '${activeQuestId}')" 
                                    style="width: 100%; background: #4caf50; margin-top: 0.5rem;">
                                    ‚úÖ Odevzdat √∫kol
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            // Dostupn√© questy (pokud nem√° aktivn√≠)
            const availableQuests = npc.quests || [];
            let questsHtml = '';
            
            if (!activeQuestId) {
                // Norm√°ln√≠ NPC questy
                questsHtml = availableQuests.map(qId => {
                    const quest = NPC_QUESTS[qId];
                    if (!quest) return '';
                    const completed = state.npcQuests?.[npcId]?.completed?.includes(qId);
                    
                    if (completed) {
                        return `
                            <div style="padding: 0.5rem; background: #222; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                <span style="color: #4caf50;">‚úì</span> ${quest.name}
                            </div>
                        `;
                    }
                    
                    return `
                        <button class="btn" onclick="acceptStoryQuest('${npcId}', '${qId}')" 
                            style="width: 100%; margin-bottom: 0.3rem; background: ${npcColor}; text-align: left; padding: 0.6rem;">
                            <span style="font-size: 0.9rem;">${quest.name}</span>
                            <div style="font-size: 0.75rem; color: #ccc; margin-top: 0.2rem;">${quest.desc}</div>
                            ${quest.details ? `<div style="font-size: 0.7rem; color: #64b5f6; margin-top: 0.3rem; padding: 0.3rem; background: rgba(0,0,0,0.3); border-radius: 3px;">${quest.details}</div>` : ''}
                            <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">üéÅ ${quest.reward.money || 0} üí∞</div>
                        </button>
                    `;
                }).join('');
                
                // Speci√°ln√≠ questy (Detektivn√≠ a ƒåasov√©)
                if (npc.specialQuests && npc.specialQuests.length > 0) {
                    const specialQuestsHtml = npc.specialQuests.map(sqId => {
                        // Zkontroluj jestli quest u≈æ nen√≠ aktivn√≠ nebo splnƒõn√Ω
                        const isDetective = DETECTIVE_QUESTS.find(q => q.id === sqId);
                        const isTimed = TIMED_QUESTS.find(q => q.id === sqId);
                        
                        if (isDetective) {
                            const alreadyActive = state.detectiveQuests?.[sqId];
                            if (alreadyActive?.solved) {
                                return `<div style="padding: 0.5rem; background: #222; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                    <span style="color: #4caf50;">‚úì</span> üîç ${isDetective.name}
                                </div>`;
                            }
                            if (alreadyActive) {
                                return `<div style="padding: 0.5rem; background: #2a1a2a; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid #9c27b0;">
                                    <span style="color: #9c27b0;">üîÑ</span> üîç ${isDetective.name} (aktivn√≠)
                                </div>`;
                            }
                            return `
                                <button class="btn" onclick="acceptStoryQuest('${npcId}', '${sqId}')" 
                                    style="width: 100%; margin-bottom: 0.3rem; background: #6a1b9a; text-align: left; padding: 0.6rem;">
                                    <span style="font-size: 0.9rem;">üîç ${isDetective.name}</span>
                                    <div style="font-size: 0.75rem; color: #ccc; margin-top: 0.2rem;">${isDetective.description}</div>
                                    <div style="font-size: 0.7rem; color: #ce93d8; margin-top: 0.2rem;">üéÅ ${isDetective.reward?.money || 0} üí∞, ${isDetective.reward?.xp || 0} XP</div>
                                </button>
                            `;
                        }
                        
                        if (isTimed) {
                            const alreadyActive = state.timedQuests?.find(t => t.id === sqId);
                            if (alreadyActive?.completed) {
                                return `<div style="padding: 0.5rem; background: #222; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                    <span style="color: #4caf50;">‚úì</span> ‚è∞ ${isTimed.name}
                                </div>`;
                            }
                            if (alreadyActive && !alreadyActive.failed) {
                                const remaining = Math.max(0, alreadyActive.endTime - Date.now());
                                const mins = Math.floor(remaining / 60000);
                                return `<div style="padding: 0.5rem; background: #2a2a1a; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid #ff9800;">
                                    <span style="color: #ff9800;">üîÑ</span> ‚è∞ ${isTimed.name} (${mins}m zb√Ωv√°)
                                </div>`;
                            }
                            if (alreadyActive?.failed) {
                                return `<div style="padding: 0.5rem; background: #2a1a1a; border-radius: 6px; margin-bottom: 0.3rem; opacity: 0.6;">
                                    <span style="color: #f44336;">‚úó</span> ‚è∞ ${isTimed.name} (selhal)
                                </div>`;
                            }
                            return `
                                <button class="btn" onclick="acceptStoryQuest('${npcId}', '${sqId}')" 
                                    style="width: 100%; margin-bottom: 0.3rem; background: #e65100; text-align: left; padding: 0.6rem;">
                                    <span style="font-size: 0.9rem;">‚è∞ ${isTimed.name}</span>
                                    <div style="font-size: 0.75rem; color: #ccc; margin-top: 0.2rem;">${isTimed.description}</div>
                                    <div style="font-size: 0.7rem; color: #ffcc80; margin-top: 0.2rem;">‚è±Ô∏è ƒåasov√Ω limit: ${Math.floor(isTimed.timeLimit / 60000)} minut</div>
                                    <div style="font-size: 0.7rem; color: #888; margin-top: 0.2rem;">üéÅ ${isTimed.reward?.money || 0} üí∞, ${isTimed.reward?.xp || 0} XP</div>
                                </button>
                            `;
                        }
                        
                        return '';
                    }).join('');
                    
                    if (specialQuestsHtml) {
                        questsHtml += `<div style="margin-top: 0.5rem; border-top: 1px solid #333; padding-top: 0.5rem;">
                            <h5 style="color: #ff9800; margin: 0 0 0.3rem 0; font-size: 0.8rem;">‚≠ê Speci√°ln√≠ √∫koly:</h5>
                            ${specialQuestsHtml}
                        </div>`;
                    }
                }
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${npc.icon}</div>
                    <p style="color: #888; font-style: italic;">"${npc.personality}"</p>
                    <p style="color: ${moodColor}; font-weight: bold;">${moodText}</p>
                </div>
                
                <!-- Karma Bar -->
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <span style="color: ${npcColor};">Karma u ${npc.name}</span>
                        <span>${myKarma}/100</span>
                    </div>
                    <div style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${Math.max(0, myKarma)}%; background: ${npcColor};"></div>
                    </div>
                </div>
                
                <!-- Varov√°n√≠ o rivalovi -->
                ${rivalKarma > 30 ? `
                    <div style="background: #4a2a2a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #f44336;">
                        <p style="margin: 0; font-size: 0.85rem; color: #f44336;">
                            ‚ö†Ô∏è "${rivalName} o tobƒõ mluv√≠... D√°vej si pozor."
                        </p>
                    </div>
                ` : ''}
                
                <h4 style="color: ${npcColor}; margin-bottom: 0.5rem;">üìú √ökoly:</h4>
                ${activeQuestHtml}
                ${questsHtml || (activeQuestId ? '' : '<p style="color: #666;">V≈°echny √∫koly splnƒõny!</p>')}
                
                <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="talkToStoryNPC('${npcId}')" style="background: #555;">
                        üí¨ Mluvit
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #333;">
                        ‚Üê Zpƒõt
                    </button>
                </div>
            `);
        }
        
        function acceptStoryQuest(npcId, questId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            
            // === SPECI√ÅLN√ç QUESTY ===
            // ≈†erif Kowalski - Detektivn√≠ questy
            if (npc?.specialQuests?.includes(questId) && DETECTIVE_QUESTS.find(q => q.id === questId)) {
                startDetectiveQuest(questId);
                closeModal();
                return;
            }
            
            // Posel Jin - ƒåasov√© questy
            if (npc?.specialQuests?.includes(questId) && TIMED_QUESTS.find(q => q.id === questId)) {
                startTimedQuest(questId);
                closeModal();
                return;
            }
            
            // === NORM√ÅLN√ç NPC QUESTY ===
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // Ulo≈æ poƒç√°teƒçn√≠ stav pro tracking progressu
            state.npcQuests = state.npcQuests || {};
            state.npcQuests[npcId] = {
                id: questId,
                accepted: Date.now(),
                startKills: state.stats?.kills || 0,
                startExplored: state.world?.visitedLocations?.length || 0,
                completed: state.npcQuests[npcId]?.completed || []
            };
            
            notifySuccess('√ökol p≈ôijat!', quest.name);
            addLog(`P≈ôijat √∫kol od ${npc?.name || npcId}: ${quest.name}`, 'üìú');
            showStoryNPC(npcId);
        }
        
        function checkStoryQuestRequirements(req) {
            if (!req) return true;
            
            if (req.resource) {
                return (state.resources?.[req.resource] || 0) >= req.amount;
            }
            if (req.money) {
                return state.money >= req.money;
            }
            if (req.kills) {
                // Poƒç√≠t√° kills od p≈ôijet√≠ questu
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.kills
                );
                if (npcId) {
                    const startKills = state.npcQuests[npcId].startKills || 0;
                    const currentKills = state.stats?.kills || 0;
                    return (currentKills - startKills) >= req.kills;
                }
                return false;
            }
            if (req.explore) {
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.explore
                );
                if (npcId) {
                    const startExplored = state.npcQuests[npcId].startExplored || 0;
                    const currentExplored = state.world?.visitedLocations?.length || 0;
                    return (currentExplored - startExplored) >= req.explore;
                }
                return false;
            }
            
            return false;
        }
        
        function getStoryQuestProgress(req) {
            if (!req) return '???';
            
            if (req.resource) {
                const has = state.resources?.[req.resource] || 0;
                const icons = { metal: '‚öôÔ∏è', wood: 'üå≤', gunpowder: 'üí•', cloth: 'üßµ' };
                return `${icons[req.resource] || 'üì¶'} ${has}/${req.amount}`;
            }
            if (req.money) {
                return `üí∞ ${state.money}/${req.money}`;
            }
            if (req.kills) {
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.kills
                );
                if (npcId) {
                    const startKills = state.npcQuests[npcId].startKills || 0;
                    const currentKills = state.stats?.kills || 0;
                    const progress = Math.max(0, currentKills - startKills);
                    return `üíÄ ${progress}/${req.kills} zabit√Ωch`;
                }
                return `üíÄ 0/${req.kills} zabit√Ωch`;
            }
            if (req.explore) {
                const npcId = Object.keys(state.npcQuests || {}).find(id => 
                    state.npcQuests[id]?.id && NPC_QUESTS[state.npcQuests[id].id]?.requirement?.explore
                );
                if (npcId) {
                    const startExplored = state.npcQuests[npcId].startExplored || 0;
                    const currentExplored = state.world?.visitedLocations?.length || 0;
                    const progress = Math.max(0, currentExplored - startExplored);
                    return `üó∫Ô∏è ${progress}/${req.explore} lokac√≠`;
                }
                return `üó∫Ô∏è 0/${req.explore} lokac√≠`;
            }
            
            return '???';
        }
        
        function turnInStoryQuest(npcId, questId) {
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // Odebr√°n√≠ zdroj≈Ø
            if (quest.requirement.resource) {
                state.resources[quest.requirement.resource] -= quest.requirement.amount;
            }
            if (quest.requirement.money) {
                state.money -= quest.requirement.money;
            }
            
            // Zavolej kompletaci
            completeBucoviceQuest(npcId, questId);
            
            // Refresh UI
            closeModal();
            showStoryNPC(npcId);
        }
        
        function completeBucoviceQuest(npcId, questId) {
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // P≈ôidej odmƒõny
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            
            // Uprav karmu
            state.storyKarma = state.storyKarma || { kory: 0, koudy: 0, questsDone: { kory: 0, koudy: 0 } };
            
            if (quest.reward.karma_kory) {
                state.storyKarma.kory = Math.max(-100, Math.min(100, state.storyKarma.kory + quest.reward.karma_kory));
            }
            if (quest.reward.karma_koudy) {
                state.storyKarma.koudy = Math.max(-100, Math.min(100, state.storyKarma.koudy + quest.reward.karma_koudy));
            }
            
            // Poƒç√≠tadlo quest≈Ø
            state.storyKarma.questsDone[npcId] = (state.storyKarma.questsDone[npcId] || 0) + 1;
            
            // Oznaƒç jako dokonƒçen√Ω
            state.npcQuests[npcId].completed = state.npcQuests[npcId].completed || [];
            state.npcQuests[npcId].completed.push(questId);
            state.npcQuests[npcId].id = null;
            
            // Kontrola dominance
            checkBucoviceDominance();
            
            const rivalId = npcId === 'kory' ? 'koudy' : 'kory';
            const rivalName = rivalId === 'kory' ? 'Kory' : 'Koudy';
            
            notifySuccess('√ökol splnƒõn!', `+${quest.reward.money || 0} üí∞`);
            
            if (quest.reward[`karma_${rivalId}`] < 0) {
                notifyWarning('Karma', `${rivalName} o tobƒõ teƒè sm√Ω≈°l√≠ h≈Ø≈ô...`);
            }
            
            addLog(`Dokonƒçen √∫kol: ${quest.name}`, '‚úÖ');
        }
        
        function checkBucoviceDominance() {
            const karma = state.storyKarma;
            if (!karma) return;
            
            // Kontrola v√≠tƒõzstv√≠
            if (karma.kory >= 100 && karma.questsDone.kory >= 3) {
                karma.dominance = 'kory';
                if (!karma.ending) {
                    karma.ending = 'kory';
                    showModal('üòà Koryho v√≠tƒõzstv√≠!', `
                        <div style="text-align: center;">
                            <div style="font-size: 5rem;">üòàüî•</div>
                            <h2 style="color: #e91e63;">Chaos v√≠tƒõz√≠!</h2>
                            <p>D√≠ky tv√© pomoci Kory ovl√°dl Projekt Genesise. Mƒõsto je nyn√≠ centrem anarchie a svobody.</p>
                            <p style="color: #ff9800;">Kory tƒõ jmenoval ƒçestn√Ωm ƒçlenem gangu!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">üéâ Oslavit</button>
                    `);
                }
            } else if (karma.koudy >= 100 && karma.questsDone.koudy >= 3) {
                karma.dominance = 'koudy';
                if (!karma.ending) {
                    karma.ending = 'koudy';
                    showModal('üòá Koudyho v√≠tƒõzstv√≠!', `
                        <div style="text-align: center;">
                            <div style="font-size: 5rem;">üòá‚öñÔ∏è</div>
                            <h2 style="color: #2196f3;">≈ò√°d v√≠tƒõz√≠!</h2>
                            <p>D√≠ky tv√© pomoci Koudy nastolil po≈ô√°dek v Projekt Genesis√≠ch. Mƒõsto vzkv√©t√° pod jeho veden√≠m.</p>
                            <p style="color: #4caf50;">Koudy tƒõ jmenoval ƒçestn√Ωm str√°≈æcem!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">üéâ Oslavit</button>
                    `);
                }
            }
        }
        
        function talkToStoryNPC(npcId) {
            const karma = state.storyKarma?.[npcId] || 0;
            const rivalId = npcId === 'kory' ? 'koudy' : 'kory';
            const rivalName = rivalId === 'kory' ? 'Kory' : 'Koudy';
            const npcName = npcId === 'kory' ? 'Kory' : 'Koudy';
            
            let dialogues;
            if (npcId === 'kory') {
                dialogues = [
                    { karma: -50, text: '"Ztra≈• se, zr√°dƒçe! Pom√°h√°≈° tomu snobu Koudymu!"' },
                    { karma: 0, text: '"Hm? Co chce≈°? Pokud nejsi s n√°mi, jsi proti n√°m."' },
                    { karma: 30, text: '"Hele, nejsi ≈°patnej. Chaos je svoboda, ch√°pe≈°?"' },
                    { karma: 60, text: '"Br√°cho! Ty v√≠≈°, co je spr√°vn√Ω. Pojƒè, zbo≈ô√≠me ten jeho po≈ô√°dek!"' },
                    { karma: 100, text: '"Jsi jeden z n√°s! Spoleƒçnƒõ ovl√°dneme tohle mƒõsto!"' }
                ];
            } else {
                dialogues = [
                    { karma: -50, text: '"Odejdi. Pom√°h√°≈° tomu krimin√°ln√≠kovi Korymu."' },
                    { karma: 0, text: '"Dobr√Ω den. Mohu ti nƒõjak pomoci? ≈ò√°d je z√°klad civilizace."' },
                    { karma: 30, text: '"V√≠tej p≈ô√≠teli. Vid√≠m, ≈æe si cen√≠≈° po≈ô√°dku a spravedlnosti."' },
                    { karma: 60, text: '"Jsem r√°d, ≈æe jsi na na≈°√≠ stranƒõ. Spoleƒçnƒõ obnov√≠me m√≠r."' },
                    { karma: 100, text: '"Jsi m≈Øj nejcennƒõj≈°√≠ spojenec. Projekt Genesise ti budou vdƒõƒçn√© nav≈ædy!"' }
                ];
            }
            
            // Najdi spr√°vn√Ω dialog
            let dialogue = dialogues[0];
            for (const d of dialogues) {
                if (karma >= d.karma) dialogue = d;
            }
            
            showModal(`üí¨ ${npcName} ≈ô√≠k√°:`, `
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="font-size: 1.1rem; font-style: italic; margin: 0;">${dialogue.text}</p>
                </div>
                <button class="btn" onclick="showStoryNPC('${npcId}')" style="width: 100%;">${'Zpƒõt'}</button>
            `);
        }
        
        // Funkce pro z√≠sk√°n√≠ aktivn√≠ch bonus≈Ø od NPC
        function getNPCBonuses() {
            const bonuses = {
                freeHealing: false,       // Doktor Harris - l√©ƒçen√≠ zdarma
                shopDiscount: 0,          // Star√Ω obchodn√≠k - sleva 20%
                mapReveal: false,         // Zvƒõdka Maya - odhalen√≠ mapy
                canGetCompanion: false,   // Zvƒõdka Maya - companion
                weaponUpgrade: false,     // Kov√°≈ô Ivan - upgrade zbranƒõ
                legendarycraft: false,    // Kov√°≈ô Ivan - legendary craft
                prophecy: false,          // Z√°hadn√° ≈æena - proroctv√≠
                secretLocation: false,    // Z√°hadn√° ≈æena - tajn√° lokace
                freeExplosives: false,    // Kory - v√Ωbu≈°niny zdarma
                medicalTraining: false,   // Koudy/Doktor - med. tr√©nink
                craftedWeaponBonus: 0     // Mechanik Pepa - bonus DMG s craftƒõn√Ωmi zbranƒõmi
            };
            
            if (!state.npcRelations) return bonuses;
            
            // Star√Ω obchodn√≠k - sleva
            const merchant = state.npcRelations['old_merchant'];
            if (merchant?.trust >= 50) bonuses.shopDiscount = 0.2;
            if (merchant?.trust >= 100) bonuses.shopDiscount = 0.25;
            
            // Doktor Harris - l√©ƒçen√≠ zdarma
            const doc = state.npcRelations['doc_harris'];
            if (doc?.trust >= 50) bonuses.freeHealing = true;
            if (doc?.trust >= 100) bonuses.medicalTraining = true;
            
            // Zvƒõdka Maya - mapa a companion
            const maya = state.npcRelations['scout_maya'];
            if (maya?.trust >= 50) bonuses.mapReveal = true;
            if (maya?.trust >= 100) bonuses.canGetCompanion = true;
            
            // Kov√°≈ô Ivan - upgrade a legendary
            const ivan = state.npcRelations['blacksmith_ivan'];
            if (ivan?.trust >= 50) bonuses.weaponUpgrade = true;
            if (ivan?.trust >= 100) bonuses.legendarycraft = true;
            
            // Z√°hadn√° ≈æena - proroctv√≠ a tajn√° lokace
            const woman = state.npcRelations['mysterious_woman'];
            if (woman?.trust >= 50) bonuses.prophecy = true;
            if (woman?.trust >= 100) bonuses.secretLocation = true;
            
            // P√©≈•a - drby a tajn√° cesta
            const peta = state.npcRelations['kid_peta'];
            if (peta?.trust >= 50) bonuses.gossip = true; // Sly≈°√≠ drby - odhal√≠ NPC lokace
            if (peta?.trust >= 100) bonuses.secretPath = true; // Tajn√° cesta - rychl√© cestov√°n√≠
            
            // Babiƒçka Marta - bylinky a recept
            const marta = state.npcRelations['grandma_marta'];
            if (marta?.trust >= 50) bonuses.freeHerbs = true;
            if (marta?.trust >= 100) bonuses.secretRecipe = true;
            
            // Lovec Viktor - loveck√© tipy
            const viktor = state.npcRelations['hunter_viktor'];
            if (viktor?.trust >= 50) bonuses.huntingTips = true;
            if (viktor?.trust >= 100) bonuses.rareHunt = true;
            
            // Uƒçitelka Vƒõra - bonus XP
            const vera = state.npcRelations['teacher_vera'];
            if (vera?.trust >= 50) bonuses.xpBonus = 0.1; // +10% XP
            if (vera?.trust >= 100) bonuses.xpBonus = 0.2; // +20% XP
            
            // Kory - v√Ωbu≈°niny zdarma
            const kory = state.npcRelations['kory'];
            if (kory?.trust >= 50) bonuses.freeExplosives = true;
            
            // Koudy - l√©ƒçen√≠ zdarma
            const koudy = state.npcRelations['koudy'];
            if (koudy?.trust >= 50) bonuses.freeHealing = true;
            if (koudy?.trust >= 100) bonuses.medicalTraining = true;
            
            // Mechanik Pepa - bonus DMG s craftƒõn√Ωmi zbranƒõmi
            const pepa = state.npcRelations['mechanic_pepa'];
            if (pepa?.trust >= 50) bonuses.craftedWeaponBonus = 0.15; // +15% DMG
            if (pepa?.trust >= 100) bonuses.craftedWeaponBonus = 0.25; // +25% DMG
            
            return bonuses;
        }
        
        // Pomocn√° funkce pro nalezen√≠ deliver questu smƒõ≈ôuj√≠c√≠ho k dan√©mu NPC
        function findDeliverQuestForNPC(targetNpcId) {
            if (!state.npcQuests) return null;
            
            for (const [questGiverId, questData] of Object.entries(state.npcQuests)) {
                if (questData.deliverTarget === targetNpcId && questData.id) {
                    const quest = NPC_QUESTS[questData.id];
                    if (quest && quest.requirement?.deliver) {
                        // Kontrola jestli je quest splnƒõn (m√° dost surovin)
                        if (checkNPCQuestProgress(questData, quest)) {
                            return {
                                questGiverId,
                                quest,
                                activeQuest: questData
                            };
                        }
                    }
                }
            }
            return null;
        }
        
        function showNPCDetail(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) return;
            
            // Kontrola jestli m√° nƒõkdo deliver quest pro tohoto NPC
            const deliverQuestInfo = findDeliverQuestForNPC(npcId);
            if (deliverQuestInfo) {
                // Zobraz mo≈ænost odevzdat z√°silku
                const { questGiverId, quest, activeQuest } = deliverQuestInfo;
                const questGiver = FRIENDLY_NPCS.find(n => n.id === questGiverId);
                
                showModal(`üì¶ Doruƒçen√≠ z√°silek`, `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 3rem;">${npc.icon}</div>
                        <h3 style="color: #fff; margin: 0.5rem 0;">${npc.name}</h3>
                    </div>
                    <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"Aha, z√°soby od ${questGiver?.name || 'obchodn√≠ka'}! V√Ωbornƒõ, pr√°vƒõ je pot≈ôebuju."</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üéÅ Odmƒõna:</h4>
                        <p style="font-size: 0.9rem; color: #aaa;">
                            ${quest.reward.money ? `üí∞ ${quest.reward.money} penƒõz ` : ''}
                            ${quest.reward.trust ? `‚ù§Ô∏è +${quest.reward.trust} d≈Øvƒõry ` : ''}
                            ${quest.reward.xp ? `‚≠ê +${quest.reward.xp} XP` : ''}
                        </p>
                    </div>
                    
                    <button class="btn" onclick="completeDeliverQuest('${questGiverId}', '${npcId}')" style="width: 100%; background: #4caf50;">üì¶ P≈ôedat z√°soby</button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav≈ô√≠t</button>
                `);
                return;
            }
            
            // Kontrola jestli hr√°ƒç nav≈°t√≠vil lokaci NPC
            const npcLocation = npc.location;
            const visitedLocation = state.world?.visitedLocations?.includes(npcLocation);
            const isInMet = state.mainQuest?.npcMet?.includes(npc.id);
            const hasTrust = (state.npcRelations?.[npc.id]?.trust || 0) > 0;
            
            // Je hr√°ƒç PR√ÅVƒö TEƒé na lokaci NPC?
            const isAtNPCLocation = state.world?.currentLocation === npcLocation;
            
            if (!visitedLocation && !isInMet && !hasTrust) {
                showModal('‚ùì Nezn√°m√Ω NPC', `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                        <p style="color: #888;">Tohoto p≈ôe≈æiv≈°√≠ho jsi je≈°tƒõ nepotkal.</p>
                        <p style="color: #666; font-size: 0.85rem;">Nav≈°tiv lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npcLocation)?.name || npcLocation}</strong> abys ho objevil!</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            state.npcRelations = state.npcRelations || {};
            const relation = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0 };
            
            const trustLevel = relation.trust >= 100 ? 'Nejlep≈°√≠ p≈ô√≠tel' : 
                               relation.trust >= 75 ? 'Dobr√Ω p≈ô√≠tel' :
                               relation.trust >= 50 ? 'P≈ô√≠tel' :
                               relation.trust >= 25 ? 'Zn√°m√Ω' : 'Cizinec';
            
            // Odmƒõny
            let rewardsHtml = '';
            if (npc.rewards) {
                rewardsHtml = `
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--toxic-dark);">
                        <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">üéÅ Odmƒõny za d≈Øvƒõru:</h4>
                        <div style="font-size: 0.85rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
                                <span>50 d≈Øvƒõry:</span>
                                <span style="color: ${relation.trust >= 50 ? '#8bc34a' : '#888'};">
                                    ${relation.trust >= 50 ? '‚úì ' : 'üîí '}${npc.rewards.trust50}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
                                <span>100 d≈Øvƒõry:</span>
                                <span style="color: ${relation.trust >= 100 ? '#8bc34a' : '#888'};">
                                    ${relation.trust >= 100 ? '‚úì ' : 'üîí '}${npc.rewards.trust100}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Tlaƒç√≠tka - nƒõkter√© akce vy≈æaduj√≠ b√Ωt na lokaci NPC
            const locationWarning = !isAtNPCLocation ? `
                <div style="background: #3a2a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; text-align: center; border: 1px solid #ff9800;">
                    <span style="color: #ff9800;">üìç ${npc.name} je na lokaci: ${WORLD_LOCATIONS.find(l => l.id === npcLocation)?.name || npcLocation}</span>
                </div>
            ` : '';
            
            // Tlaƒç√≠tka podle toho jestli jsi na lokaci
            const talkButton = isAtNPCLocation 
                ? `<button class="btn" onclick="talkToFriendlyNPC('${npcId}')" style="background: #3949AB;">üí¨ Mluvit</button>`
                : `<button class="btn" style="background: #333; color: #666; cursor: not-allowed;" disabled title="Mus√≠≈° b√Ωt na lokaci NPC">üí¨ Mluvit (üìç)</button>`;
            
            const giftButton = isAtNPCLocation 
                ? `<button class="btn" onclick="giveGiftToNPC('${npcId}')" style="background: var(--toxic-dark);">üéÅ D√°t dar</button>`
                : `<button class="btn" style="background: #333; color: #666; cursor: not-allowed;" disabled title="Mus√≠≈° b√Ωt na lokaci NPC">üéÅ D√°t dar (üìç)</button>`;
            
            // Quest tlaƒç√≠tko tak√© vy≈æaduje b√Ωt na lokaci
            const questButton = isAtNPCLocation 
                ? `<button class="btn" onclick="askNPCQuest('${npcId}')" style="background: #ff9800;">üìú Zeptat se na √∫kol</button>`
                : `<button class="btn" style="background: #333; color: #666; cursor: not-allowed;" disabled title="Mus√≠≈° b√Ωt na lokaci NPC">üìú √ökoly (üìç)</button>`;
            
            // Tlaƒç√≠tko Dokonƒçit √∫kol - pokud m√° aktivn√≠ quest
            let completeQuestButton = '';
            const activeQuest = state.npcQuests?.[npcId];
            if (activeQuest && activeQuest.id && isAtNPCLocation) {
                const quest = NPC_QUESTS[activeQuest.id];
                if (quest) {
                    const canComplete = checkNPCQuestProgress(activeQuest, quest);
                    if (canComplete) {
                        completeQuestButton = `<button class="btn" onclick="completeNPCQuest('${npcId}')" style="background: #4caf50; animation: pulse 1s infinite;">‚úÖ Dokonƒçit √∫kol: ${quest.name}</button>`;
                    } else {
                        completeQuestButton = `<button class="btn" style="background: #333; color: #888;" disabled>üìã √ökol: ${quest.name} (nesplnƒõno)</button>`;
                    }
                }
            }
            
            showModal(`${npc.icon} ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem;">${npc.icon}</div>
                    <p style="color: #888; font-style: italic;">"${npc.personality}"</p>
                    <p style="color: #666; font-size: 0.85rem;">üìç ${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Vztah:</span>
                        <span style="color: #ffd700;">${trustLevel}</span>
                    </div>
                    <div style="height: 10px; background: #0a0a0a; border-radius: 5px; overflow: hidden;">
                        <div style="height: 100%; width: ${relation.trust}%; background: linear-gradient(90deg, #ff9800, #8bc34a);"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                        <span>‚ù§Ô∏è ${relation.trust}/100</span>
                        <span>üéÅ ${relation.gifts} dar≈Ø | üìú ${relation.quests} quest≈Ø</span>
                    </div>
                </div>
                
                ${rewardsHtml}
                
                ${locationWarning}
                
                ${getNPCSpecialActions(npcId, relation.trust)}
                
                ${completeQuestButton}
                
                <div style="display: grid; gap: 0.5rem;">
                    ${talkButton}
                    ${giftButton}
                    ${questButton}
                    <button class="btn" onclick="showNPCRelations()" style="background: #555;">
                        ‚Üê Zpƒõt
                    </button>
                </div>
            `);
        }
        
        // Speci√°ln√≠ akce pro NPC podle d≈Øvƒõry
        function getNPCSpecialActions(npcId, trust) {
            let html = '';
            
            // Star√Ω obchodn√≠k - v≈ædy zobraz obchod
            if (npcId === 'old_merchant') {
                html += `<button class="btn" onclick="closeModal(); openShop();" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust-light);">
                    üõí Otev≈ô√≠t obchod
                </button>`;
                if (trust >= 50) {
                    html += `<div style="background: #1a3a1a; padding: 0.3rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a; font-size: 0.8rem;">‚úì Sleva 20% aktivn√≠</div>`;
                }
            }
            
            // Zvƒõdka Maya - odhalen√≠ mapy
            if (npcId === 'scout_maya' && trust >= 50) {
                const alreadyRevealed = state.secrets?.includes('maya_map_reveal');
                if (!alreadyRevealed) {
                    html += `<button class="btn" onclick="revealMapFromMaya()" style="width: 100%; margin-bottom: 0.5rem; background: #2196f3;">
                        üó∫Ô∏è Odhal tajn√© lokace na mapƒõ
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Mapa odhalena</div>`;
                }
            }
            
            // Zvƒõdka Maya - companion
            if (npcId === 'scout_maya' && trust >= 100) {
                const hasCompanion = state.companions?.some(c => c.id === 'maya_companion');
                if (!hasCompanion) {
                    html += `<button class="btn" onclick="recruitMayaCompanion()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        üèÉ‚Äç‚ôÄÔ∏è Po≈æ√°dej Mayu o doprovod
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Maya je tv≈Øj companion</div>`;
                }
            }
            
            // Kov√°≈ô Ivan - upgrade zbranƒõ a zbroje
            if (npcId === 'blacksmith_ivan' && trust >= 50) {
                const blacksmithBonus = getSettlerUpgradeBonus();
                const totalDmg = 5 + blacksmithBonus;
                const totalDef = 5 + blacksmithBonus;
                const bonusText = blacksmithBonus > 0 ? ` <span style="color: #ffd700;">(+${blacksmithBonus} kov√°≈ô)</span>` : '';
                
                html += `<button class="btn" onclick="upgradeWeaponAtIvan()" style="width: 100%; margin-bottom: 0.5rem; background: #ff5722;">
                    üî® Vylep≈°it zbra≈à (+${totalDmg} DMG, 50‚öôÔ∏è)${bonusText}
                </button>`;
                html += `<button class="btn" onclick="upgradeArmorAtIvan()" style="width: 100%; margin-bottom: 0.5rem; background: #2196f3;">
                    üõ°Ô∏è Vylep≈°it zbroj (+${totalDef} DEF, 50‚öôÔ∏è)${bonusText}
                </button>`;
            }
            
            // Kov√°≈ô Ivan - legendary craft (vy≈æaduje skill Legend√°rn√≠ kov√°≈ô)
            if (npcId === 'blacksmith_ivan' && trust >= 100) {
                const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
                if (hasLegendarySmith) {
                    html += `<button class="btn" onclick="craftLegendaryAtIvan()" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #ffd700, #ff8f00); color: #000;">
                        ‚≠ê Vykovat legend√°rn√≠ zbra≈à (100‚öôÔ∏è 50üî© 20üì±)
                    </button>`;
                } else {
                    html += `<div style="background: #2a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; border: 1px solid #555;">
                        <span style="color: #888;">üîí Legend√°rn√≠ craft</span><br>
                        <span style="color: #ff9800; font-size: 0.75rem;">Vy≈æaduje skill "Legend√°rn√≠ kov√°≈ô" (≈òemeslo tier 4)</span>
                    </div>`;
                }
            }
            
            // Z√°hadn√° ≈æena - proroctv√≠
            if (npcId === 'mysterious_woman' && trust >= 50) {
                const hasProphecy = state.secrets?.includes('mysterious_prophecy');
                if (!hasProphecy) {
                    html += `<button class="btn" onclick="getProphecy()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        üîÆ Z√≠skej proroctv√≠
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Proroctv√≠ z√≠sk√°no (+10% XP)</div>`;
                }
            }
            
            // Z√°hadn√° ≈æena - tajn√° lokace
            if (npcId === 'mysterious_woman' && trust >= 100) {
                const hasSecret = state.secrets?.includes('secret_location_revealed');
                if (!hasSecret) {
                    html += `<button class="btn" onclick="revealSecretLocation()" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #9c27b0, #673ab7);">
                        üóùÔ∏è Odhal tajnou lokaci
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Tajn√° lokace odhalena</div>`;
                }
            }
            
            // Kory - v√Ωbu≈°niny zdarma
            if (npcId === 'kory' && trust >= 50) {
                const lastFreeExplosives = state.lastFreeExplosives || 0;
                const canGet = Date.now() - lastFreeExplosives > 24 * 60 * 60 * 1000; // 1x dennƒõ
                if (canGet) {
                    html += `<button class="btn" onclick="getFreeExplosives()" style="width: 100%; margin-bottom: 0.5rem; background: #c62828;">
                        üí£ Z√≠skej v√Ωbu≈°niny zdarma
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastFreeExplosives)) / 3600000);
                    html += `<div style="background: #2a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">üí£ V√Ωbu≈°niny za ${hoursLeft}h</div>`;
                }
            }
            
            // P√©≈•a - drby (odhal√≠ NPC)
            if (npcId === 'kid_peta' && trust >= 50) {
                html += `<button class="btn" onclick="getGossipFromPeta()" style="width: 100%; margin-bottom: 0.5rem; background: #ff9800;">
                    üëÇ Poslechnout drby
                </button>`;
            }
            
            // P√©≈•a - tajn√° cesta (rychl√© cestov√°n√≠)
            if (npcId === 'kid_peta' && trust >= 100) {
                const pathActive = state.secretPathExpires && Date.now() < state.secretPathExpires;
                if (pathActive) {
                    const hoursLeft = Math.ceil((state.secretPathExpires - Date.now()) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Tajn√° cesta aktivn√≠ (${hoursLeft}h)</div>`;
                } else {
                    html += `<button class="btn" onclick="learnSecretPath()" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        üõ§Ô∏è Aktivovat tajnou cestu (-50% ƒças, 24h)
                    </button>`;
                }
            }
            
            // Babiƒçka Marta - bylinky zdarma
            if (npcId === 'grandma_marta' && trust >= 50) {
                const lastFreeHerbs = state.lastFreeHerbs || 0;
                const canGet = Date.now() - lastFreeHerbs > 12 * 60 * 60 * 1000; // 2x dennƒõ
                if (canGet) {
                    html += `<button class="btn" onclick="getFreeHerbs()" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        üåø Z√≠skej bylinky zdarma (5x)
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((12 * 60 * 60 * 1000 - (Date.now() - lastFreeHerbs)) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">üåø Bylinky za ${hoursLeft}h</div>`;
                }
            }
            
            // Babiƒçka Marta - tajn√Ω recept
            if (npcId === 'grandma_marta' && trust >= 100) {
                const hasRecipe = state.secrets?.includes('marta_secret_recipe');
                if (!hasRecipe) {
                    html += `<button class="btn" onclick="learnSecretRecipe()" style="width: 100%; margin-bottom: 0.5rem; background: #8bc34a;">
                        üìú Nauƒçit se tajn√Ω recept (Super Stimpak)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Tajn√Ω recept nauƒçen</div>`;
                }
            }
            
            // Lovec Viktor - loveck√© tipy
            if (npcId === 'hunter_viktor' && trust >= 50) {
                html += `<button class="btn" onclick="getHuntingTips()" style="width: 100%; margin-bottom: 0.5rem; background: #795548;">
                    üèπ Loveck√© tipy (+25% loot ze zv√≠≈ôat)
                </button>`;
            }
            
            // Lovec Viktor - vz√°cn√° ko≈ôist
            if (npcId === 'hunter_viktor' && trust >= 100) {
                const lastRareHunt = state.lastRareHunt || 0;
                const canHunt = Date.now() - lastRareHunt > 24 * 60 * 60 * 1000;
                if (canHunt) {
                    html += `<button class="btn" onclick="goRareHunt()" style="width: 100%; margin-bottom: 0.5rem; background: #ff5722;">
                        ü¶å Lov vz√°cn√© ko≈ôisti
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastRareHunt)) / 3600000);
                    html += `<div style="background: #2a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">ü¶å Dal≈°√≠ lov za ${hoursLeft}h</div>`;
                }
            }
            
            // Kapit√°n Nov√°k - vojensk√Ω v√Ωcvik
            if (npcId === 'captain_novak' && trust >= 50) {
                const hasTrained = state.secrets?.includes('novak_military_training');
                if (!hasTrained) {
                    html += `<button class="btn" onclick="getMilitaryTraining()" style="width: 100%; margin-bottom: 0.5rem; background: #455a64;">
                        üéñÔ∏è Vojensk√Ω v√Ωcvik (+5 DMG permanentnƒõ)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Vojensk√Ω v√Ωcvik dokonƒçen</div>`;
                }
            }
            
            // Kapit√°n Nov√°k - tajemstv√≠ o ƒåern√©m
            if (npcId === 'captain_novak' && trust >= 100) {
                const hasSecret = state.secrets?.includes('novak_cerny_secret');
                if (!hasSecret) {
                    html += `<button class="btn" onclick="learnCernySecret()" style="width: 100%; margin-bottom: 0.5rem; background: #37474f;">
                        üíÄ Sly≈°et pravdu o Veliteli ƒåern√©m
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Pravda odhalena</div>`;
                }
            }
            
            // Mechanik Pepa - opravy levnƒõji
            if (npcId === 'mechanic_pepa' && trust >= 50) {
                html += `<button class="btn" onclick="repairAtPepa()" style="width: 100%; margin-bottom: 0.5rem; background: #795548;">
                    üîß Opravit vybaven√≠ (50% sleva)
                </button>`;
            }
            
            // Mechanik Pepa - vozidlo zmƒõnƒõno na master oprav√°≈ô
            if (npcId === 'mechanic_pepa' && trust >= 100) {
                const hasMaster = state.secrets?.includes('pepa_master_repair');
                if (!hasMaster) {
                    html += `<button class="btn" onclick="getMasterRepair()" style="width: 100%; margin-bottom: 0.5rem; background: #ff9800;">
                        üîß Nauƒçit se mistrovsk√© opravy (zdarma opravy)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Mistrovsk√© opravy nauƒçeny</div>`;
                }
            }
            
            // Sestra Anna - po≈æehn√°n√≠
            if (npcId === 'sister_anna' && trust >= 50) {
                const lastBlessing = state.lastBlessing || 0;
                const canBless = Date.now() - lastBlessing > 24 * 60 * 60 * 1000;
                if (canBless) {
                    html += `<button class="btn" onclick="getBlessing()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        ‚õ™ Po≈æehn√°n√≠ (+20% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫tok)
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastBlessing)) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">‚õ™ Po≈æehn√°n√≠ za ${hoursLeft}h</div>`;
                }
            }
            
            // Sestra Anna - svat√° relikvie
            if (npcId === 'sister_anna' && trust >= 100) {
                const hasRelic = state.secrets?.includes('anna_holy_relic');
                if (!hasRelic) {
                    html += `<button class="btn" onclick="getHolyRelic()" style="width: 100%; margin-bottom: 0.5rem; background: #ffd700; color: #000;">
                        ‚úùÔ∏è Z√≠skat svatou relikvii
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Relikvie z√≠sk√°na</div>`;
                }
            }
            
            // Pa≈°er√°k Radek - ƒçern√Ω trh
            if (npcId === 'smuggler_radek' && trust >= 50) {
                html += `<button class="btn" onclick="openBlackMarket()" style="width: 100%; margin-bottom: 0.5rem; background: #37474f;">
                    üé≠ ƒåern√Ω trh (vz√°cn√© p≈ôedmƒõty)
                </button>`;
            }
            
            // Pa≈°er√°k Radek - velk√© tajemstv√≠
            if (npcId === 'smuggler_radek' && trust >= 100) {
                const hasSecret = state.secrets?.includes('radek_big_secret');
                if (!hasSecret) {
                    html += `<button class="btn" onclick="learnBigSecret()" style="width: 100%; margin-bottom: 0.5rem; background: #212121;">
                        üïµÔ∏è Sly≈°et velk√© tajemstv√≠
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Tajemstv√≠ odhaleno</div>`;
                }
            }
            
            // Uƒçitelka Vƒõra - sirotek companion
            if (npcId === 'teacher_vera' && trust >= 100) {
                const hasOrphan = state.companions?.some(c => c.id === 'orphan_companion');
                if (!hasOrphan) {
                    html += `<button class="btn" onclick="adoptOrphan()" style="width: 100%; margin-bottom: 0.5rem; background: #e91e63;">
                        üë¶ Adoptovat sirotka (companion)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Sirotek adoptov√°n</div>`;
                }
            }
            
            // ≈†√≠len√Ω Jirka - varov√°n√≠
            if (npcId === 'crazy_jirka' && trust >= 50) {
                const hasWarning = state.secrets?.includes('jirka_warning');
                if (!hasWarning) {
                    html += `<button class="btn" onclick="getJirkaWarning()" style="width: 100%; margin-bottom: 0.5rem; background: #ff5722;">
                        ‚ö†Ô∏è Sly≈°et varov√°n√≠
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Varov√°n√≠ sly≈°eno</div>`;
                }
            }
            
            // ≈†√≠len√Ω Jirka - pravda o Korym
            if (npcId === 'crazy_jirka' && trust >= 100) {
                const hasTruth = state.secrets?.includes('jirka_kory_truth');
                if (!hasTruth) {
                    html += `<button class="btn" onclick="learnKoryTruth()" style="width: 100%; margin-bottom: 0.5rem; background: #c62828;">
                        üíÄ PRAVDA O KORYM
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Pravda odhalena</div>`;
                }
            }
            
            // Sta≈ôec Tom√°≈° - historie
            if (npcId === 'elder_tomas' && trust >= 50) {
                const hasHistory = state.secrets?.includes('tomas_history');
                if (!hasHistory) {
                    html += `<button class="btn" onclick="learnHistory()" style="width: 100%; margin-bottom: 0.5rem; background: #8d6e63;">
                        üìú Sly≈°et historii kraje
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Historie sly≈°ena</div>`;
                }
            }
            
            // Sta≈ôec Tom√°≈° - pravda o Z√°hadn√© ≈æenƒõ
            if (npcId === 'elder_tomas' && trust >= 100) {
                const hasTruth = state.secrets?.includes('tomas_woman_truth');
                if (!hasTruth) {
                    html += `<button class="btn" onclick="learnWomanTruth()" style="width: 100%; margin-bottom: 0.5rem; background: #673ab7;">
                        üîÆ Pravda o Z√°hadn√© ≈æenƒõ
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Pravda odhalena</div>`;
                }
            }
            
            // In≈æen√Ωrka Kl√°ra - tech vylep≈°en√≠
            if (npcId === 'engineer_klara' && trust >= 50) {
                html += `<button class="btn" onclick="getTechUpgrade()" style="width: 100%; margin-bottom: 0.5rem; background: #00bcd4;">
                    ‚ö° Tech vylep≈°en√≠ (+10 DEF vybaven√≠)
                </button>`;
            }
            
            // In≈æen√Ωrka Kl√°ra - d≈Økazy proti Koudymu
            if (npcId === 'engineer_klara' && trust >= 100) {
                const hasEvidence = state.secrets?.includes('klara_koudy_evidence');
                if (!hasEvidence) {
                    html += `<button class="btn" onclick="getKoudyEvidence()" style="width: 100%; margin-bottom: 0.5rem; background: #f44336;">
                        üìã D≈Økazy proti Koudymu
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì D≈Økazy z√≠sk√°ny</div>`;
                }
            }
            
            // Velitel ƒåern√Ω - p≈ô√≠mƒõ≈ô√≠
            if (npcId === 'commander_cerny' && trust >= 50) {
                const hasTruce = state.secrets?.includes('cerny_truce');
                if (!hasTruce) {
                    html += `<button class="btn" onclick="makeTruce()" style="width: 100%; margin-bottom: 0.5rem; background: #607d8b;">
                        ü§ù Uzav≈ô√≠t p≈ô√≠mƒõ≈ô√≠ (n√°jezdn√≠ci ne√∫toƒç√≠)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì P≈ô√≠mƒõ≈ô√≠ uzav≈ôeno</div>`;
                }
            }
            
            // Velitel ƒåern√Ω - pravda o v√°lce
            if (npcId === 'commander_cerny' && trust >= 100) {
                const hasTruth = state.secrets?.includes('cerny_war_truth');
                if (!hasTruth) {
                    html += `<button class="btn" onclick="learnWarTruth()" style="width: 100%; margin-bottom: 0.5rem; background: #263238;">
                        üíÄ Pravda o v√°lce
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Pravda sly≈°ena</div>`;
                }
            }
            
            // Kart√°≈ôka Rosa - vƒõ≈°tba
            if (npcId === 'fortune_rosa' && trust >= 50) {
                const lastFortune = state.lastFortune || 0;
                const canFortune = Date.now() - lastFortune > 12 * 60 * 60 * 1000;
                if (canFortune) {
                    html += `<button class="btn" onclick="getFortune()" style="width: 100%; margin-bottom: 0.5rem; background: #9c27b0;">
                        üÉè Vƒõ≈°tba (n√°hodn√Ω bonus)
                    </button>`;
                } else {
                    const hoursLeft = Math.ceil((12 * 60 * 60 * 1000 - (Date.now() - lastFortune)) / 3600000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">üÉè Vƒõ≈°tba za ${hoursLeft}h</div>`;
                }
            }
            
            // Kart√°≈ôka Rosa - le≈æ o Z√°hadn√© ≈æenƒõ
            if (npcId === 'fortune_rosa' && trust >= 100) {
                const hasLie = state.secrets?.includes('rosa_woman_lie');
                if (!hasLie) {
                    html += `<button class="btn" onclick="hearWomanLie()" style="width: 100%; margin-bottom: 0.5rem; background: #e91e63;">
                        üé≠ "Pravda" o Z√°hadn√© ≈æenƒõ
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #ff9800;">‚úì Sly≈°ena "pravda"</div>`;
                }
            }
            
            // ≈†erif Kowalski - p≈ô√≠stup k d≈Økaz≈Øm
            if (npcId === 'sheriff_kowalski' && trust >= 50) {
                html += `<button class="btn" onclick="accessEvidence()" style="width: 100%; margin-bottom: 0.5rem; background: #3f51b5;">
                    üìã Prozkoumat d≈Økazy (odhal√≠ quest info)
                </button>`;
            }
            
            // ≈†erif Kowalski - z√°stupce ≈°erifa
            if (npcId === 'sheriff_kowalski' && trust >= 100) {
                const isDeputy = state.secrets?.includes('kowalski_deputy');
                if (!isDeputy) {
                    html += `<button class="btn" onclick="becomeDeputy()" style="width: 100%; margin-bottom: 0.5rem; background: #ffd700; color: #000;">
                        üéñÔ∏è St√°t se z√°stupcem ≈°erifa
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Jsi z√°stupce ≈°erifa</div>`;
                }
            }
            
            // Posel Jin - rychlej≈°√≠ cestov√°n√≠
            if (npcId === 'messenger_jin' && trust >= 50) {
                const hasFastTravel = state.secrets?.includes('jin_fast_routes');
                if (!hasFastTravel) {
                    html += `<button class="btn" onclick="learnFastRoutes()" style="width: 100%; margin-bottom: 0.5rem; background: #00bcd4;">
                        üèÉ Nauƒçit se rychl√© cesty (-5% ƒças)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Rychl√© cesty nauƒçeny</div>`;
                }
            }
            
            // Posel Jin - tajn√© zkratky
            if (npcId === 'messenger_jin' && trust >= 100) {
                const hasShortcuts = state.secrets?.includes('jin_secret_shortcuts');
                if (!hasShortcuts) {
                    html += `<button class="btn" onclick="learnSecretShortcuts()" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        üó∫Ô∏è Tajn√© zkratky (-10% ƒças cestov√°n√≠)
                    </button>`;
                } else {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì Zkratky nauƒçeny</div>`;
                }
            }
            
            // Doktor Harris - l√©ƒçen√≠ zdarma
            if (npcId === 'doc_harris' && trust >= 50) {
                const lastFreeHeal = state.lastFreeHealHarris || 0;
                const canHeal = Date.now() - lastFreeHeal > 30 * 60 * 1000; // 30 minut cooldown
                const needsHeal = state.char.hp < state.char.maxHp;
                
                if (canHeal && needsHeal) {
                    html += `<button class="btn" onclick="freeHealFromNPC('doc_harris')" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        ‚ù§Ô∏è L√©ƒçen√≠ zdarma (pln√© HP)
                    </button>`;
                } else if (!needsHeal) {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì M√°≈° pln√© zdrav√≠</div>`;
                } else {
                    const minsLeft = Math.ceil((30 * 60 * 1000 - (Date.now() - lastFreeHeal)) / 60000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">‚ù§Ô∏è L√©ƒçen√≠ za ${minsLeft} min</div>`;
                }
            }
            
            // Koudy - l√©ƒçen√≠ zdarma
            if (npcId === 'koudy' && trust >= 50) {
                const lastFreeHeal = state.lastFreeHealKoudy || 0;
                const canHeal = Date.now() - lastFreeHeal > 30 * 60 * 1000; // 30 minut cooldown
                const needsHeal = state.char.hp < state.char.maxHp;
                
                if (canHeal && needsHeal) {
                    html += `<button class="btn" onclick="freeHealFromNPC('koudy')" style="width: 100%; margin-bottom: 0.5rem; background: #4caf50;">
                        ‚ù§Ô∏è L√©ƒçen√≠ zdarma (pln√© HP)
                    </button>`;
                } else if (!needsHeal) {
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #8bc34a;">‚úì M√°≈° pln√© zdrav√≠</div>`;
                } else {
                    const minsLeft = Math.ceil((30 * 60 * 1000 - (Date.now() - lastFreeHeal)) / 60000);
                    html += `<div style="background: #1a2a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; text-align: center; color: #888;">‚ù§Ô∏è L√©ƒçen√≠ za ${minsLeft} min</div>`;
                }
            }
            
            return html;
        }
        
        // === NPC BONUS FUNKCE ===
        
        function freeHealFromNPC(npcId) {
            if (state.char.hp >= state.char.maxHp) {
                notifyWarning('Pln√© zdrav√≠', 'Nepot≈ôebuje≈° l√©ƒçen√≠!');
                return;
            }
            
            // Nastav cooldown pro konkr√©tn√≠ NPC
            if (npcId === 'doc_harris') {
                state.lastFreeHealHarris = Date.now();
            } else if (npcId === 'koudy') {
                state.lastFreeHealKoudy = Date.now();
            }
            
            const oldHp = state.char.hp;
            state.char.hp = state.char.maxHp;
            const healed = state.char.maxHp - oldHp;
            
            const npcNames = {
                'doc_harris': 'Doktor Harris',
                'koudy': 'Koudy'
            };
            
            addLog(`‚ù§Ô∏è ${npcNames[npcId] || 'NPC'} tƒõ vyl√©ƒçil (+${healed} HP)`, 'üíö');
            notifySuccess('‚ù§Ô∏è Vyl√©ƒçen!', `+${healed} HP zdarma`);
            
            closeModal();
            showNPCDetail(npcId);
            renderFull();
        }
        
        function revealMapFromMaya() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('maya_map_reveal')) return;
            
            state.secrets.push('maya_map_reveal');
            
            // Odhal 10 n√°hodn√Ωch nenav≈°t√≠ven√Ωch lokac√≠
            const unvisited = WORLD_LOCATIONS.filter(l => !state.world.visitedLocations?.includes(l.id));
            const toReveal = unvisited.slice(0, 10).map(l => l.id);
            if (!state.world.revealedLocations) state.world.revealedLocations = [];
            state.world.revealedLocations.push(...toReveal);
            
            showModal('üó∫Ô∏è Mapa odhalena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üó∫Ô∏è</div>
                    <p>Maya ti uk√°zala ${toReveal.length} tajn√Ωch lokac√≠ na mapƒõ!</p>
                    <p style="color: #8bc34a;">Nyn√≠ je vid√≠≈° i kdy≈æ jsi je nenav≈°t√≠vil.</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('scout_maya');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function recruitMayaCompanion() {
            if (!state.companions) state.companions = [];
            if (state.companions.some(c => c.id === 'maya_companion' && !c.isDead)) return;
            
            const activeCompanions = state.companions.filter(c => !c.isDead).length;
            const maxCompanions = getMaxCompanions();
            if (activeCompanions >= maxCompanions) {
                notifyWarning('Pln√Ω t√Ωm!', `M√°≈° ${activeCompanions}/${maxCompanions} companion≈Ø`);
                return;
            }
            
            // Odstra≈à mrtvou Mayu pokud existuje
            state.companions = state.companions.filter(c => c.id !== 'maya_companion');
            
            state.companions.push({
                id: 'maya_companion',
                name: 'Maya',
                icon: 'üèÉ‚Äç‚ôÄÔ∏è',
                type: 'scout',
                hp: 60,
                maxHp: 60,
                damage: 15,
                defense: 5,
                special: 'Odhaluje pasti a skryt√© p≈ôedmƒõty'
            });
            
            showModal('üèÉ‚Äç‚ôÄÔ∏è Maya se p≈ôidala!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üèÉ‚Äç‚ôÄÔ∏è</div>
                    <p style="color: #8bc34a; font-weight: bold;">Maya je nyn√≠ tv≈Øj companion!</p>
                    <p style="color: #888;">+15 DMG v boji, odhaluje pasti</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('scout_maya');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Helper - z√≠sk√° bonus k vylep≈°en√≠ od kov√°≈ôe osadn√≠ka
        function getSettlerUpgradeBonus() {
            if (!state.settlement?.settlers) return 0;
            
            const blacksmith = state.settlement.settlers.find(s => s.type === 'blacksmith_s');
            if (!blacksmith) return 0;
            
            const skillData = SETTLER_SKILLS?.blacksmith;
            if (!skillData) return 0;
            
            const level = blacksmith.skillLevel || 1;
            const levelData = skillData.levels[level - 1];
            
            return levelData?.effect?.upgrade || 0;
        }
        
        function upgradeWeaponAtIvan() {
            if (!state.equipped?.weapon) {
                notifyWarning('≈Ω√°dn√° zbra≈à!', 'Nem√°≈° vybavenou zbra≈à k vylep≈°en√≠');
                return;
            }
            if ((state.resources?.metal || 0) < 50) {
                notifyWarning('M√°lo kovu!', 'Pot≈ôebuje≈° 50 ‚öôÔ∏è kovu');
                return;
            }
            
            state.resources.metal -= 50;
            
            // Z√°kladn√≠ bonus + bonus od kov√°≈ôe osadn√≠ka
            let upgradeBonus = 5;
            const blacksmithBonus = getSettlerUpgradeBonus();
            upgradeBonus += blacksmithBonus;
            
            state.equipped.weapon.damage = (state.equipped.weapon.damage || 10) + upgradeBonus;
            state.equipped.weapon.name = state.equipped.weapon.name + ' +';
            
            showModal('üî® Zbra≈à vylep≈°ena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">‚öîÔ∏è</div>
                    <p style="color: #8bc34a; font-weight: bold;">${state.equipped.weapon.name}</p>
                    <p>+${upgradeBonus} po≈°kozen√≠!${blacksmithBonus > 0 ? ` <span style="color: #ffd700;">(+${blacksmithBonus} od kov√°≈ôe)</span>` : ''}</p>
                    <p style="color: #ff9800;">Nov√© DMG: ${state.equipped.weapon.damage}</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('blacksmith_ivan');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function upgradeArmorAtIvan() {
            if (!state.equipped?.armor) {
                notifyWarning('≈Ω√°dn√° zbroj!', 'Nem√°≈° vybavenou zbroj k vylep≈°en√≠');
                return;
            }
            if ((state.resources?.metal || 0) < 50) {
                notifyWarning('M√°lo kovu!', 'Pot≈ôebuje≈° 50 ‚öôÔ∏è kovu');
                return;
            }
            
            state.resources.metal -= 50;
            
            // Z√°kladn√≠ bonus + bonus od kov√°≈ôe osadn√≠ka
            let upgradeBonus = 5;
            const blacksmithBonus = getSettlerUpgradeBonus();
            upgradeBonus += blacksmithBonus;
            
            state.equipped.armor.defense = (state.equipped.armor.defense || 5) + upgradeBonus;
            state.equipped.armor.name = state.equipped.armor.name + ' +';
            
            showModal('üõ°Ô∏è Zbroj vylep≈°ena!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üõ°Ô∏è</div>
                    <p style="color: #8bc34a; font-weight: bold;">${state.equipped.armor.name}</p>
                    <p>+${upgradeBonus} obrana!${blacksmithBonus > 0 ? ` <span style="color: #ffd700;">(+${blacksmithBonus} od kov√°≈ôe)</span>` : ''}</p>
                    <p style="color: #2196f3;">Nov√© DEF: ${state.equipped.armor.defense}</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('blacksmith_ivan');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function craftLegendaryAtIvan() {
            // Kontrola skillu
            const hasLegendarySmith = getSkillLevel('legendary_smith') > 0;
            if (!hasLegendarySmith) {
                notifyWarning('Chyb√≠ skill!', 'Pot≈ôebuje≈° skill "Legend√°rn√≠ kov√°≈ô" z vƒõtve ≈òemeslo');
                return;
            }
            
            const cost = { metal: 100, scrap: 50, electronics: 20 };
            if ((state.resources?.metal || 0) < cost.metal || 
                (state.resources?.scrap || 0) < cost.scrap ||
                (state.resources?.electronics || 0) < cost.electronics) {
                notifyWarning('M√°lo surovin!', `Pot≈ôebuje≈°: ${cost.metal}‚öôÔ∏è ${cost.scrap}üî© ${cost.electronics}üì±`);
                return;
            }
            
            state.resources.metal -= cost.metal;
            state.resources.scrap -= cost.scrap;
            state.resources.electronics -= cost.electronics;
            
            const legendaryWeapon = {
                id: 'legendary_blade_' + Date.now(),
                name: '‚≠ê Ivan≈Øv Legend√°rn√≠ Meƒç',
                icon: 'üó°Ô∏è',
                type: 'weapon',
                damage: 45,
                durability: 200,
                maxDurability: 200,
                rarity: 'legendary',
                desc: 'Mistrovsk√© d√≠lo kov√°≈ôe Ivana'
            };
            
            state.inv.push(legendaryWeapon);
            
            showModal('‚≠ê LEGEND√ÅRN√ç ZBRA≈á!', `
                <div style="text-align: center; background: linear-gradient(135deg, #2a2a0a, #1a1a0a); padding: 1rem; border-radius: 8px; border: 2px solid #ffd700;">
                    <div style="font-size: 3rem;">üó°Ô∏è</div>
                    <p style="color: #ffd700; font-weight: bold; font-size: 1.2rem;">${legendaryWeapon.name}</p>
                    <p style="color: #ff9800;">‚öîÔ∏è ${legendaryWeapon.damage} DMG</p>
                    <p style="color: #888;">Toto je skuteƒçn√© mistrovsk√© d√≠lo!</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('blacksmith_ivan');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getProphecy() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('mysterious_prophecy')) return;
            
            state.secrets.push('mysterious_prophecy');
            
            const prophecies = [
                "Vid√≠m... dvƒõ cesty. Bratr proti bratrovi. Tv√° volba rozhodne osud svƒõta.",
                "Hledej tam, kde slunce zapad√° do radioaktivn√≠ mlhy. Najde≈°, co hled√°≈°.",
                "D≈Øvƒõra je vz√°cnƒõj≈°√≠ ne≈æ zlato. Buduj ji, a svƒõt se ti otev≈ôe.",
                "Projekt Genesis... m≈Ø≈æe b√Ωt sp√°sou, nebo zk√°zou. Z√°le≈æ√≠ na srdci toho, kdo ho ovl√°dne."
            ];
            const prophecy = prophecies[Math.floor(Math.random() * prophecies.length)];
            
            showModal('üîÆ Proroctv√≠', `
                <div style="text-align: center; background: linear-gradient(135deg, #1a0a2a, #0a0a1a); padding: 1rem; border-radius: 8px; border: 1px solid #9c27b0;">
                    <div style="font-size: 3rem;">üîÆ</div>
                    <p style="color: #ce93d8; font-style: italic; font-size: 1.1rem;">"${prophecy}"</p>
                    <p style="color: #8bc34a; margin-top: 1rem;">‚ú® Bonus: +10% XP ze v≈°ech zdroj≈Ø!</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('mysterious_woman');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function revealSecretLocation() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('secret_location_revealed')) return;
            
            state.secrets.push('secret_location_revealed');
            
            // P≈ôidej tajnou lokaci do svƒõta
            if (!state.world.revealedLocations) state.world.revealedLocations = [];
            state.world.revealedLocations.push('ancient_vault');
            
            showModal('üóùÔ∏è Tajn√° lokace odhalena!', `
                <div style="text-align: center; background: linear-gradient(135deg, #1a0a2a, #0a0a1a); padding: 1rem; border-radius: 8px; border: 2px solid #ffd700;">
                    <div style="font-size: 3rem;">üèõÔ∏è</div>
                    <p style="color: #ffd700; font-weight: bold;">Starovƒõk√Ω trezor</p>
                    <p style="color: #888;">Z√°hadn√° ≈æena ti prozradila lokaci prad√°vn√©ho trezoru pln√©ho poklad≈Ø!</p>
                    <p style="color: #8bc34a; margin-top: 0.5rem;">üìç Nov√° lokace p≈ôid√°na na mapu!</p>
                    <p style="color: #ff9800; font-size: 0.85rem;">Nach√°z√≠ se v nebezpeƒçn√© z√≥nƒõ - buƒè p≈ôipraven!</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('mysterious_woman');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getFreeExplosives() {
            const lastFree = state.lastFreeExplosives || 0;
            if (Date.now() - lastFree < 24 * 60 * 60 * 1000) return;
            
            state.lastFreeExplosives = Date.now();
            
            // P≈ôidej v√Ωbu≈°niny
            const gunpowder = ITEMS.find(i => i.id === 'gunpowder');
            if (gunpowder) {
                const existing = state.inv.find(i => i.id === 'gunpowder');
                if (existing) {
                    existing.count = (existing.count || 1) + 5;
                } else {
                    state.inv.push({...gunpowder, count: 5});
                }
            }
            
            showModal('üí£ V√Ωbu≈°niny!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üí£</div>
                    <p style="color: #c62828; font-weight: bold;">Kory ti dal 5x st≈ôeln√Ω prach!</p>
                    <p style="color: #888;">"Pou≈æij je moud≈ôe... nebo ne. Je mi to jedno."</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('kory');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // P√©≈•a - drby
        function getGossipFromPeta() {
            const gossips = [
                "Sly≈°el jsem, ≈æe v opu≈°tƒõn√©m skladi≈°ti na severu je ukryt√Ω poklad...",
                "Obchodn√≠k v Buƒçovic√≠ch m√° pr√Ω tajnou z√°sobu vz√°cn√Ωch zbran√≠.",
                "V laborato≈ôi vidƒõli nƒõjak√©ho podivn√©ho mu≈æe. Pr√Ω tam nƒõco hled√°.",
                "N√°jezdn√≠ci pl√°nuj√≠ √∫tok na karavanu p≈ô√≠≈°t√≠ t√Ωden.",
                "V jeskyni na v√Ωchodƒõ ≈æije mutant, kter√Ω pr√Ω mluv√≠!",
                "≈†erif Kowalski m√° tajemstv√≠. Nƒõco skr√Ωv√° ve sv√©m stole.",
                "Sly≈°el jsem, ≈æe z√°hadn√° ≈æena nen√≠ to, za co se vyd√°v√°...",
                "V chemiƒçce je tajn√° m√≠stnost. Kl√≠ƒç m√° pr√Ω nƒõkdo z vƒõdc≈Ø."
            ];
            const gossip = gossips[Math.floor(Math.random() * gossips.length)];
            
            showModal('üëÇ Drby od P√©ti', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üë¶</div>
                    <p style="color: #ff9800; font-style: italic;">"${gossip}"</p>
                    <p style="color: #888; font-size: 0.8rem;">P√©≈•a se rozhl√©dne a zmiz√≠.</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('kid_peta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        // P√©≈•a - tajn√° cesta
        function learnSecretPath() {
            state.secretPathExpires = Date.now() + 24 * 60 * 60 * 1000; // 24 hodin
            
            showModal('üõ§Ô∏è Tajn√° cesta!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üõ§Ô∏è</div>
                    <p style="color: #4caf50; font-weight: bold;">P√©≈•a ti uk√°zal tajn√© zkratky!</p>
                    <p style="color: #888;">Cestov√°n√≠ je nyn√≠ o 50% rychlej≈°√≠.</p>
                    <p style="color: #ff9800;">‚è∞ Plat√≠ 24 hodin</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('kid_peta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Marta - bylinky zdarma
        function getFreeHerbs() {
            const lastFree = state.lastFreeHerbs || 0;
            if (Date.now() - lastFree < 12 * 60 * 60 * 1000) return;
            
            state.lastFreeHerbs = Date.now();
            state.resources.herbs = (state.resources.herbs || 0) + 5;
            
            showModal('üåø Bylinky!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üëµ</div>
                    <p style="color: #4caf50; font-weight: bold;">Babiƒçka Marta ti dala 5x bylinky!</p>
                    <p style="color: #888;">"Tyhle ti pomohou, mil√°ƒçku. Vracuj se!"</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('grandma_marta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Marta - tajn√Ω recept
        function learnSecretRecipe() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('marta_secret_recipe')) return;
            
            state.secrets.push('marta_secret_recipe');
            
            showModal('üìú Tajn√Ω recept!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üìú</div>
                    <p style="color: #8bc34a; font-weight: bold;">Nauƒçil ses recept na Super Stimpak!</p>
                    <p style="color: #888;">Nyn√≠ m≈Ø≈æe≈° v d√≠lnƒõ vyr√°bƒõt Super Stimpaky levnƒõji.</p>
                    <p style="color: #4caf50;">-50% surovin na Super Stimpak</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('grandma_marta');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Viktor - loveck√© tipy
        function getHuntingTips() {
            if (!state.secrets) state.secrets = [];
            if (!state.secrets.includes('viktor_hunting_tips')) {
                state.secrets.push('viktor_hunting_tips');
            }
            
            showModal('üèπ Loveck√© tipy!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üèπ</div>
                    <p style="color: #795548; font-weight: bold;">Viktor ti dal loveck√© tipy!</p>
                    <p style="color: #888;">"St≈ô√≠lej do srdce, ne do hlavy. M√©nƒõ pr√°ce s k≈Ø≈æ√≠."</p>
                    <p style="color: #4caf50;">+25% loot ze zv√≠≈ôat (trval√©)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('hunter_viktor');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // Viktor - vz√°cn√° ko≈ôist
        function goRareHunt() {
            const lastHunt = state.lastRareHunt || 0;
            if (Date.now() - lastHunt < 24 * 60 * 60 * 1000) return;
            
            state.lastRareHunt = Date.now();
            
            // Dej vz√°cn√© suroviny
            state.resources.leather = (state.resources.leather || 0) + 10;
            state.resources.fur = (state.resources.fur || 0) + 5;
            state.resources.raw_meat = (state.resources.raw_meat || 0) + 8;
            markFoodAsNew('raw_meat', 8);
            addMoney(150);
            addXP(100);
            
            showModal('ü¶å Vz√°cn√° ko≈ôist!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">ü¶å</div>
                    <p style="color: #ff5722; font-weight: bold;">√öspƒõ≈°n√Ω lov s Viktorem!</p>
                    <p style="color: #8bc34a;">Z√≠skal jsi:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; margin: 1rem 0;">
                        <div>ü¶¥ 10x K≈Ø≈æe</div>
                        <div>ü¶ä 5x Ko≈æe≈°ina</div>
                        <div>ü•© 8x Maso</div>
                        <div>üí∞ 150 penƒõz</div>
                    </div>
                    <p style="color: #2196f3;">+100 XP</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('hunter_viktor');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        // === NOV√â NPC FUNKCE ===
        
        function getMilitaryTraining() {
            if (!state.secrets) state.secrets = [];
            if (state.secrets.includes('novak_military_training')) return;
            
            state.secrets.push('novak_military_training');
            state.char.bonusDamage = (state.char.bonusDamage || 0) + 5;
            
            showModal('üéñÔ∏è Vojensk√Ω v√Ωcvik!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üéñÔ∏è</div>
                    <p>Kapit√°n Nov√°k tƒõ nauƒçil bojov√© techniky!</p>
                    <p style="color: #8bc34a; font-weight: bold;">+5 DMG permanentnƒõ</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('captain_novak');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function learnCernySecret() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('novak_cerny_secret');
            
            showModal('üíÄ Tajemstv√≠ o Veliteli ƒåern√©m', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üíÄ</div>
                </div>
                <p style="color: #ff9800;">"Velitel ƒåern√Ω... je m≈Øj bratr. P≈ôed v√°lkou byl voj√°k jako j√°."</p>
                <p style="margin-top: 0.5rem;">"V√°lka ho zlomila. Vidƒõl p≈ô√≠li≈° mnoho. Mysl√≠ si, ≈æe jedin√Ω zp≈Øsob jak p≈ôe≈æ√≠t je st√°t se pred√°torem."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Ale nƒõkde hluboko... je st√°le ƒçlovƒõk. V√≠m to."</p>
                <p style="margin-top: 1rem; color: #8bc34a;">Tato informace m≈Ø≈æe zmƒõnit tv≈Øj pohled na n√°jezdn√≠ky...</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('captain_novak');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function repairAtPepa() {
            const weapon = state.equipped?.weapon;
            const armor = state.equipped?.armor;
            
            if (!weapon && !armor) {
                notifyWarning('Nic k opravƒõ', 'Nem√°≈° vybaven√© vybaven√≠');
                return;
            }
            
            // Master repair = zdarma, jinak 50% sleva
            const isMaster = state.secrets?.includes('pepa_master_repair');
            const metalCost = isMaster ? 0 : 10;
            
            if (!isMaster && (state.resources?.metal || 0) < metalCost) {
                notifyWarning('M√°lo kovu', 'Pot≈ôebuje≈° 10‚öôÔ∏è');
                return;
            }
            
            if (!isMaster) state.resources.metal -= metalCost;
            if (weapon) { weapon.durability = weapon.maxDurability || 100; }
            if (armor) { armor.durability = armor.maxDurability || 100; }
            
            notifySuccess('Opraveno!', isMaster ? 'Pepa opravil tv√© vybaven√≠ zdarma!' : 'Pepa opravil tv√© vybaven√≠ za poloviƒçn√≠ cenu');
            showNPCDetail('mechanic_pepa');
        }
        
        function getMasterRepair() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('pepa_master_repair');
            
            showModal('üîß Mistrovsk√© opravy!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">üîß</div>
                    <p style="color: #ff9800; font-weight: bold;">Pepa tƒõ nauƒçil mistrovsk√© opravy!</p>
                    <p style="color: #8bc34a;">Opravy vybaven√≠ jsou nyn√≠ ZDARMA</p>
                    <p style="color: #888; font-size: 0.85rem;">(St√°le pot≈ôebuje≈° b√Ωt u Pepy)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('mechanic_pepa');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getBlessing() {
            state.lastBlessing = Date.now();
            state.blessingActive = Date.now() + 24 * 60 * 60 * 1000; // 24h
            
            showModal('‚õ™ Po≈æehn√°n√≠!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">‚õ™</div>
                    <p>Sestra Anna ti po≈æehnala.</p>
                    <p style="color: #9c27b0; font-weight: bold;">+20% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫tok (24h)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sister_anna');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function getHolyRelic() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('anna_holy_relic');
            
            const relic = {
                id: 'holy_relic',
                name: 'Svat√° relikvie',
                icon: '‚úùÔ∏è',
                type: 'accessory',
                defense: 5,
                special: 'holy',
                desc: '+10% XP, +5 DEF, imunita na proklet√≠',
                rarity: 'legendary'
            };
            state.inv.push(relic);
            
            showModal('‚úùÔ∏è Svat√° relikvie!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">‚úùÔ∏è</div>
                    <p style="color: #ffd700; font-weight: bold;">Z√≠skal jsi Svatou relikvii!</p>
                    <p style="color: #8bc34a;">+10% XP, +5 DEF, imunita na proklet√≠</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sister_anna');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function openBlackMarket() {
            const rareItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic').slice(0, 5);
            
            let html = '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            rareItems.forEach(item => {
                // ƒåern√Ω trh: z√°kladn√≠ cena + 50% p≈ôir√°≈æka
                const basePrice = calculateItemPrice(item.price);
                const price = Math.floor(basePrice * 1.5);
                html += `<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <div>${item.icon} ${item.name}</div>
                    <button class="btn" onclick="buyBlackMarketItem('${item.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">üí∞${price}</button>
                </div>`;
            });
            html += '</div>';
            
            showModal('üé≠ ƒåern√Ω trh', html + `<button class="btn" onclick="showNPCDetail('smuggler_radek')" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${'Zpƒõt'}</button>`);
        }
        
        function buyBlackMarketItem(itemId) {
            const item = ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            // ƒåern√Ω trh: z√°kladn√≠ cena + 50% p≈ôir√°≈æka
            const basePrice = calculateItemPrice(item.price);
            const price = Math.floor(basePrice * 1.5);
            
            if (getMoney() < price) {
                notifyWarning('M√°lo penƒõz', 'Pot≈ôebuje≈° ' + price + 'üí∞');
                return;
            }
            
            removeMoney(price);
            state.inv.push({...item, count: 1, durability: 100, maxDurability: 100});
            notifySuccess('Koupeno!', item.name);
            openBlackMarket();
        }
        
        function learnBigSecret() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('radek_big_secret');
            
            showModal('üïµÔ∏è Velk√© tajemstv√≠', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üïµÔ∏è</div>
                </div>
                <p style="color: #ff9800;">"Poslouchej dob≈ôe. ≈ò√≠k√°m ti to jen jednou."</p>
                <p style="margin-top: 0.5rem;">"Kory a Koudy... nejsou jen brat≈ôi. Jsou souƒç√°st√≠ vƒõt≈°√≠ho pl√°nu."</p>
                <p style="margin-top: 0.5rem;">"P≈ôed v√°lkou pracovali pro vl√°du. Projekt Oƒçista. A teƒè... jeden chce svƒõt zniƒçit, druh√Ω zachr√°nit."</p>
                <p style="margin-top: 0.5rem; color: #c62828;">"Ale oba l≈æou. Pravda je mnohem hor≈°√≠."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('smuggler_radek');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function adoptOrphan() {
            if (!state.companions) state.companions = [];
            
            const activeCompanions = state.companions.filter(c => !c.isDead).length;
            const maxCompanions = getMaxCompanions();
            if (activeCompanions >= maxCompanions) {
                notifyWarning('Pln√Ω t√Ωm!', `M√°≈° ${activeCompanions}/${maxCompanions} companion≈Ø`);
                return;
            }
            
            state.companions.push({
                id: 'orphan_companion',
                name: 'Tom√≠k',
                icon: 'üë¶',
                type: 'helper',
                hp: 30,
                maxHp: 30,
                damage: 5,
                defense: 2,
                special: 'Najde skryt√© p≈ôedmƒõty, +10% loot'
            });
            
            showModal('üë¶ Sirotek adoptov√°n!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üë¶</div>
                    <p style="color: #e91e63; font-weight: bold;">Tom√≠k se p≈ôidal k tobƒõ!</p>
                    <p style="color: #888;">Najde skryt√© p≈ôedmƒõty, +10% loot</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('teacher_vera');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function getJirkaWarning() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jirka_warning');
            
            showModal('‚ö†Ô∏è Jirkovo varov√°n√≠', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">ü§™</div>
                </div>
                <p style="color: #ff5722;">"Poslouchej! POSLOUCHEJ! Oni mƒõ maj√≠ za bl√°zna ale j√° V√çM!"</p>
                <p style="margin-top: 0.5rem;">"Kory... vidƒõl jsem co dƒõl√° v noci. V t√© star√© tov√°rnƒõ. Experimenty..."</p>
                <p style="margin-top: 0.5rem; color: #888;">*t≈ôese se*</p>
                <p style="margin-top: 0.5rem;">"Lid√© tam chod√≠ dovnit≈ô... ale ven vych√°z√≠ nƒõco jin√©ho."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('crazy_jirka');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnKoryTruth() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jirka_kory_truth');
            
            showModal('üíÄ PRAVDA O KORYM', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üíÄ</div>
                </div>
                <p style="color: #c62828; font-weight: bold;">"PRAVDA. Koneƒçnƒõ nƒõkdo, kdo chce sly≈°et PRAVDU!"</p>
                <p style="margin-top: 0.5rem;">"Kory nechce jen zniƒçit star√Ω svƒõt. On ho chce P≈òEDƒöLAT."</p>
                <p style="margin-top: 0.5rem;">"Ti jeho 'vyvolen√≠'? To jsou pokusn√≠ kr√°l√≠ci. Transformuje je. Nƒõco mezi ƒçlovƒõkem a... nƒõƒç√≠m jin√Ωm."</p>
                <p style="margin-top: 0.5rem; color: #9c27b0;">"A Koudy? Ten to v√≠. A NIƒåEMU nezabr√°n√≠. Proto≈æe pot≈ôebuje data pro sv≈Øj 'l√©k'."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Oba jsou monstra. Jen r≈Øzn√©ho druhu."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('crazy_jirka');" style="width: 100%; margin-top: 1rem;">To je... ≈°√≠len√©</button>
            `);
        }
        
        function learnHistory() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('tomas_history');
            addXP(50);
            
            showModal('üìú Historie kraje', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üßì</div>
                </div>
                <p>"P≈ôed v√°lkou tu bylo kr√°snƒõ. Pamatuji si ka≈æd√Ω strom, ka≈ædou cestu."</p>
                <p style="margin-top: 0.5rem;">"Ale v√°lka... v√°lka zmƒõnila v≈°echno. A nƒõkte≈ô√≠ lid√© se zmƒõnili v√≠c ne≈æ jin√≠."</p>
                <p style="margin-top: 0.5rem;">"Ta ≈æena, kter√© ≈ô√≠k√°te Z√°hadn√°? Zn√°m ji. Zn√°m ji velmi dob≈ôe."</p>
                <p style="margin-top: 0.5rem; color: #888;">*v√Ωznamnƒõ se odmlƒç√≠*</p>
                <p style="color: #2196f3;">+50 XP za znalosti</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('elder_tomas');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnWomanTruth() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('tomas_woman_truth');
            
            showModal('üîÆ Pravda o Z√°hadn√© ≈æenƒõ', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üîÆ</div>
                </div>
                <p style="color: #9c27b0;">"Jej√≠ prav√© jm√©no je Elena. Dr. Elena Voronova."</p>
                <p style="margin-top: 0.5rem;">"P≈ôed v√°lkou vedla Projekt Or√°kulum - v√Ωzkum p≈ôedv√≠d√°n√≠ budoucnosti pomoc√≠ radiace."</p>
                <p style="margin-top: 0.5rem;">"Experiment selhal... nebo uspƒõl? Z√°le≈æ√≠ jak se na to d√≠v√°≈°."</p>
                <p style="margin-top: 0.5rem; color: #ff9800;">"Teƒè opravdu vid√≠ budoucnost. Ale za stra≈°nou cenu."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Rosa? Ta jen l≈æe aby z√≠skala moc. Elena mluv√≠ pravdu - proto ji v≈°ichni nen√°vid√≠."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('elder_tomas');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function getTechUpgrade() {
            if ((state.resources?.electronics || 0) < 10) {
                notifyWarning('M√°lo elektroniky', 'Pot≈ôebuje≈° 10 elektroniky');
                return;
            }
            
            if (!state.equipped?.armor) {
                notifyWarning('≈Ω√°dn√© brnƒõn√≠', 'Nem√°≈° vybaven√© brnƒõn√≠ k vylep≈°en√≠');
                return;
            }
            
            state.resources.electronics -= 10;
            
            // Z√°kladn√≠ bonus + bonus od kov√°≈ôe osadn√≠ka
            let upgradeBonus = 10;
            const blacksmithBonus = getSettlerUpgradeBonus();
            upgradeBonus += blacksmithBonus;
            
            state.equipped.armor.defense = (state.equipped.armor.defense || 0) + upgradeBonus;
            state.equipped.armor.name = state.equipped.armor.name + ' [TECH]';
            
            const bonusText = blacksmithBonus > 0 ? ` (+${blacksmithBonus} od kov√°≈ôe)` : '';
            notifySuccess('Vylep≈°eno!', `Kl√°ra vylep≈°ila tv√© brnƒõn√≠: +${upgradeBonus} DEF${bonusText}`);
            showNPCDetail('engineer_klara');
        }
        
        function getKoudyEvidence() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('klara_koudy_evidence');
            
            const evidence = {
                id: 'koudy_evidence',
                name: 'D≈Økazy proti Koudymu',
                icon: 'üìã',
                type: 'quest_item',
                desc: 'Dokumenty o Koudyho experimentech'
            };
            state.inv.push(evidence);
            
            showModal('üìã D≈Økazy z√≠sk√°ny!', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üìã</div>
                </div>
                <p style="color: #f44336;">"Tady to m√°≈°. V≈°echno co pot≈ôebuje≈° vƒõdƒõt."</p>
                <p style="margin-top: 0.5rem;">"Koudy testuje sv≈Øj 'l√©k' na lidech. Na ≈æiv√Ωch lidech."</p>
                <p style="margin-top: 0.5rem;">"Vƒõt≈°ina... nep≈ôe≈æije. A ti co p≈ôe≈æij√≠?"</p>
                <p style="margin-top: 0.5rem; color: #888;">*zavrt√≠ hlavou*</p>
                <p style="margin-top: 0.5rem; color: #9c27b0;">"Lep≈°√≠ by bylo kdyby nep≈ôe≈æili."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('engineer_klara');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function makeTruce() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('cerny_truce');
            
            showModal('ü§ù P≈ô√≠mƒõ≈ô√≠ uzav≈ôeno', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">ü§ù</div>
                </div>
                <p style="color: #607d8b;">"Tak jo. M√°≈° moje slovo."</p>
                <p style="margin-top: 0.5rem;">"Moji mu≈æi na tebe neza√∫toƒç√≠. Dokud dodr≈æ√≠≈° svou ƒç√°st."</p>
                <p style="margin-top: 0.5rem; color: #8bc34a;">N√°jezdn√≠ci tƒõ nyn√≠ ignoruj√≠!</p>
                <p style="margin-top: 0.5rem; color: #888; font-size: 0.85rem;">(≈†ance na p≈ôepaden√≠ n√°jezdn√≠ky sn√≠≈æena o 90%)</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('commander_cerny');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnWarTruth() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('cerny_war_truth');
            
            showModal('üíÄ Pravda o v√°lce', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üíÄ</div>
                </div>
                <p style="color: #263238;">"Chce≈° vƒõdƒõt proƒç jsem se stal t√≠m, ƒç√≠m jsem?"</p>
                <p style="margin-top: 0.5rem;">"Proto≈æe jsem vidƒõl pravdu. V√°lka... nebyla n√°hoda."</p>
                <p style="margin-top: 0.5rem;">"Byla pl√°novan√°. P≈ôesnƒõ pl√°novan√°. A ti, kdo ji spustili?"</p>
                <p style="margin-top: 0.5rem; color: #c62828;">"Jsou st√°le na≈æivu. A st√°le tahaj√≠ za nitky."</p>
                <p style="margin-top: 0.5rem; color: #888;">"Kory a Koudy jsou jen loutky. Jako my v≈°ichni."</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('commander_cerny');" style="width: 100%; margin-top: 1rem;">Kdo za t√≠m stoj√≠?</button>
            `);
        }
        
        function getFortune() {
            // Kontrola cooldownu
            const lastFortune = state.lastFortune || 0;
            if (Date.now() - lastFortune < 12 * 60 * 60 * 1000) {
                const hoursLeft = Math.ceil((12 * 60 * 60 * 1000 - (Date.now() - lastFortune)) / 3600000);
                notifyWarning('Vƒõ≈°tba nen√≠ p≈ôipravena', `Zkus to za ${hoursLeft} hodin`);
                return;
            }
            
            state.lastFortune = Date.now();
            saveGame(); // Ulo≈æ ihned
            
            const fortunes = [
                { text: 'Vid√≠m cestu plnou zlata...', effect: () => { addMoney(100); return '+100üí∞'; } },
                { text: 'Tv√° s√≠la vzroste...', effect: () => { state.char.bonusDamage = (state.char.bonusDamage || 0) + 3; return '+3 DMG (24h)'; } },
                { text: '≈†tƒõstƒõna ti p≈ôeje...', effect: () => { state.fortuneBonus = Date.now() + 24*60*60*1000; return '+25% loot (24h)'; } },
                { text: 'Uzdraven√≠ p≈ôich√°z√≠...', effect: () => { state.char.hp = state.char.maxHp; return 'Pln√© HP'; } },
                { text: 'Energie tƒõ napl≈àuje...', effect: () => { state.status.energy = 100; return 'Pln√° energie'; } }
            ];
            
            const fortune = fortunes[Math.floor(Math.random() * fortunes.length)];
            const result = fortune.effect();
            
            showModal('üÉè Vƒõ≈°tba', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üÉè</div>
                    <p style="color: #9c27b0; font-style: italic;">"${fortune.text}"</p>
                    <p style="color: #8bc34a; font-weight: bold; margin-top: 1rem;">${result}</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('fortune_rosa');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function hearWomanLie() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('rosa_woman_lie');
            
            showModal('üé≠ "Pravda" o Z√°hadn√© ≈æenƒõ', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üÉè</div>
                </div>
                <p style="color: #e91e63;">"Ta ≈æena? Chce≈° vƒõdƒõt kdo opravdu je?"</p>
                <p style="margin-top: 0.5rem;">"Je to podvodnice! Jej√≠ 'vize' jsou l≈æi!"</p>
                <p style="margin-top: 0.5rem;">"P≈ôed v√°lkou kradla. Lhala. Niƒçila ≈æivoty."</p>
                <p style="margin-top: 0.5rem; color: #888;">*naklon√≠ se bl√≠≈æ*</p>
                <p style="margin-top: 0.5rem; color: #c62828;">"A teƒè manipuluje v≈°echny kolem. Nevƒõ≈ô j√≠. NIKOMU nevƒõ≈ô!"</p>
                <p style="margin-top: 1rem; color: #ff9800; font-size: 0.85rem;">Pozn√°mka: Toto m≈Ø≈æe b√Ωt le≈æ z rivality...</p>
                <button class="btn" onclick="closeModal(); showNPCDetail('fortune_rosa');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function accessEvidence() {
            const clues = [
                'üîç Stopy vedou k opu≈°tƒõn√© tov√°rnƒõ na severu',
                'üîç Svƒõdek vidƒõl podez≈ôelou postavu v noci',
                'üîç Nalezena krev u star√©ho mostu',
                'üîç Z√°hadn√© symboly na zdech kostela'
            ];
            const clue = clues[Math.floor(Math.random() * clues.length)];
            
            showModal('üìã D≈Økazy', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üìã</div>
                    <p>≈†erif ti uk√°zal slo≈æku s d≈Økazy.</p>
                    <p style="color: #3f51b5; margin-top: 1rem;">${clue}</p>
                    <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">Tato informace ti m≈Ø≈æe pomoct s questy.</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sheriff_kowalski');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function becomeDeputy() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('kowalski_deputy');
            
            const badge = {
                id: 'deputy_badge',
                name: 'Odznak z√°stupce',
                icon: 'üéñÔ∏è',
                type: 'accessory',
                defense: 3,
                special: 'authority',
                desc: 'NPC tƒõ respektuj√≠, +10% reputace'
            };
            state.inv.push(badge);
            
            showModal('üéñÔ∏è Z√°stupce ≈°erifa!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üéñÔ∏è</div>
                    <p style="color: #ffd700; font-weight: bold;">Jsi nyn√≠ z√°stupce ≈°erifa!</p>
                    <p>Z√≠skal jsi Odznak z√°stupce</p>
                    <p style="color: #8bc34a;">NPC tƒõ respektuj√≠, +10% reputace</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('sheriff_kowalski');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function learnFastRoutes() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jin_fast_routes');
            
            showModal('üèÉ Rychl√© cesty!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üèÉ</div>
                    <p>Jin ti uk√°zal efektivnƒõj≈°√≠ cesty!</p>
                    <p style="color: #00bcd4; font-weight: bold;">-5% ƒças cestov√°n√≠ permanentnƒõ</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('messenger_jin');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function learnSecretShortcuts() {
            if (!state.secrets) state.secrets = [];
            state.secrets.push('jin_secret_shortcuts');
            
            showModal('üó∫Ô∏è Tajn√© zkratky!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">üó∫Ô∏è</div>
                    <p>Jin ti odhalil v≈°echny tajn√© zkratky!</p>
                    <p style="color: #4caf50; font-weight: bold;">-10% ƒças cestov√°n√≠ permanentnƒõ</p>
                    <p style="color: #888; font-size: 0.85rem;">(Kombinuje se s rychl√Ωmi cestami)</p>
                </div>
                <button class="btn" onclick="closeModal(); showNPCDetail('messenger_jin');" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
        }
        
        function talkToFriendlyNPC(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) return;
            
            // === KONTROLA LOKACE ===
            // Hr√°ƒç mus√≠ b√Ωt na stejn√© lokaci jako NPC
            const currentLocation = state.world?.currentLocation;
            if (currentLocation !== npc.location) {
                showModal('üìç P≈ô√≠li≈° daleko', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üö´</div>
                        <p>${npc.name} nen√≠ pobl√≠≈æ.</p>
                        <p style="color: #888; font-size: 0.85rem;">Mus√≠≈° b√Ωt v lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</strong> abys mohl mluvit.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            state.npcRelations = state.npcRelations || {};
            state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
            
            const relation = state.npcRelations[npcId];
            const dialogues = NPC_DIALOGUES[npcId];
            
            // Bonus za mluven√≠ max jednou za 24 hodin (jednou dennƒõ)
            const now = Date.now();
            const hoursSinceLastTalk = (now - (relation.lastTalk || 0)) / (1000 * 60 * 60);
            let trustGain = 0;
            
            if (hoursSinceLastTalk >= 24) {
                trustGain = 2;
                relation.trust = Math.min(100, relation.trust + trustGain);
                relation.lastTalk = now;
            }
            
            // === TALK QUEST PROGRESS ===
            // Pokud m√° hr√°ƒç quest typu "talk" od tohoto NPC, spl≈à ho
            if (state.npcQuests && state.npcQuests[npcId]) {
                const quest = state.npcQuests[npcId];
                if (quest.id) {
                    const questDef = NPC_QUESTS[quest.id];
                    if (questDef?.requirement?.talk) {
                        if (!quest.progress) quest.progress = {};
                        if (!quest.progress.talked) {
                            quest.progress.talked = true;
                            console.log(`üí¨ Talk quest ${quest.id} splnƒõn - promluva s ${npcId}`);
                            notifySuccess('Quest splnƒõn!', `Dokonƒçil jsi rozhovor s ${npc.name}`);
                        }
                    }
                }
            }
            
            // Vyber pozdrav podle d≈Øvƒõry
            let greeting = '';
            if (dialogues?.greeting) {
                const greetings = relation.trust >= 70 ? dialogues.greeting.high :
                                  relation.trust >= 30 ? dialogues.greeting.medium :
                                  dialogues.greeting.low;
                greeting = greetings[Math.floor(Math.random() * greetings.length)];
            } else {
                greeting = `"Zdrav√≠m tƒõ, poutn√≠ku."`;
            }
            
            // Vygeneruj t√©mata k rozhovoru
            let topicsHtml = '';
            if (dialogues?.topics) {
                topicsHtml = '<h4 style="margin: 0.5rem 0; color: #888;">Na co se zept√°≈°?</h4>';
                topicsHtml += '<div style="display: grid; gap: 0.4rem;">';
                
                const topicNames = {
                    'about_self': 'üë§ O sobƒõ',
                    'about_radek': 'üé≠ O Radkovi',
                    'about_kory': 'ü¶π O Korym',
                    'about_koudy': 'üë®‚Äçüî¨ O Koudym',
                    'about_harris': 'üë®‚Äç‚öïÔ∏è O doktorovi',
                    'about_marta': 'üëµ O Martƒõ',
                    'about_vera': 'üìö O Vƒõ≈ôe',
                    'about_daughter': 'üëß O dce≈ôi',
                    'about_ivan': 'üî® O Ivanovi',
                    'about_cerny': 'üíÄ O ƒåern√©m',
                    'about_novak': 'üéñÔ∏è O Nov√°kovi',
                    'about_viktor': 'üèπ O Viktorovi',
                    'about_jirka': 'ü§™ O Jirkovi',
                    'about_rosa': 'üÉè O Rose',
                    'about_tomas': 'üßì O Tom√°≈°ovi',
                    'what_he_saw': 'üëÅÔ∏è Co jsi vidƒõl?',
                    'why_raider': '‚ùì Proƒç n√°jezdn√≠k?',
                    'secret': 'üîê Tajemstv√≠'
                };
                
                for (const [topicId, topic] of Object.entries(dialogues.topics)) {
                    const canAsk = relation.trust >= topic.trustRequired;
                    const alreadyAsked = relation.talkedTopics?.includes(`${npcId}_${topicId}`);
                    
                    if (canAsk) {
                        topicsHtml += `<button class="btn" onclick="askNPCTopic('${npcId}', '${topicId}')" 
                            style="text-align: left; padding: 0.5rem; ${alreadyAsked ? 'opacity: 0.7;' : ''}">
                            ${topicNames[topicId] || topicId} ${alreadyAsked ? '‚úì' : ''}
                        </button>`;
                    } else {
                        topicsHtml += `<button class="btn" disabled 
                            style="text-align: left; padding: 0.5rem; opacity: 0.4;">
                            üîí ${topicNames[topicId] || topicId} (${topic.trustRequired} d≈Øvƒõry)
                        </button>`;
                    }
                }
                topicsHtml += '</div>';
            }
            
            // Zm√≠nky o jin√Ωch NPC
            let mentionsHtml = '';
            if (dialogues?.mentions && Object.keys(dialogues.mentions).length > 0) {
                const mentionedNpc = Object.keys(dialogues.mentions)[Math.floor(Math.random() * Object.keys(dialogues.mentions).length)];
                const mention = dialogues.mentions[mentionedNpc];
                const mentionedNpcData = FRIENDLY_NPCS.find(n => n.id === mentionedNpc);
                if (mentionedNpcData && Math.random() > 0.5) {
                    mentionsHtml = `
                        <div style="background: #1a1a2a; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0; border-left: 3px solid #9c27b0;">
                            <span style="color: #888; font-size: 0.85rem;">üí¨ O ${mentionedNpcData.name}:</span>
                            <p style="margin: 0.2rem 0 0 0; font-style: italic;">"${mention}"</p>
                        </div>
                    `;
                }
            }
            
            showModal(`üí¨ ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${npc.icon}</div>
                    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--rust);">
                        <p style="font-style: italic; color: #ddd; margin: 0;">${greeting}</p>
                    </div>
                    ${trustGain > 0 ? `<p style="color: #8bc34a; margin-top: 0.5rem; font-size: 0.85rem;">‚ù§Ô∏è +${trustGain} d≈Øvƒõry</p>` : ''}
                </div>
                
                ${mentionsHtml}
                
                ${topicsHtml}
                
                <div style="display: grid; gap: 0.4rem; margin-top: 1rem;">
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="background: #555;">
                        ‚Üê Zpƒõt na profil
                    </button>
                </div>
            `);
        }
        
        function askNPCTopic(npcId, topicId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            const dialogues = NPC_DIALOGUES[npcId];
            const topic = dialogues?.topics?.[topicId];
            
            if (!npc || !topic) return;
            
            state.npcRelations = state.npcRelations || {};
            state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
            
            const relation = state.npcRelations[npcId];
            
            // Oznaƒç t√©ma jako probran√©
            if (!relation.talkedTopics) relation.talkedTopics = [];
            if (!relation.talkedTopics.includes(`${npcId}_${topicId}`)) {
                relation.talkedTopics.push(`${npcId}_${topicId}`);
                // Bonus XP za nov√© t√©ma
                addXP(10);
            }
            
            // Vyber n√°hodnou odpovƒõƒè z t√©matu
            const response = topic.lines[Math.floor(Math.random() * topic.lines.length)];
            
            // Speci√°ln√≠ efekty pro tajemstv√≠
            let specialEffect = '';
            if (topicId === 'secret') {
                specialEffect = `
                    <div style="background: linear-gradient(135deg, #2a1a2a, #1a2a2a); padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #9c27b0;">
                        <p style="color: #ffd700; font-weight: bold; margin: 0;">üîê Odhaleno tajemstv√≠!</p>
                        <p style="color: #888; font-size: 0.85rem; margin: 0.3rem 0 0 0;">Tato informace m≈Ø≈æe zmƒõnit v≈°e...</p>
                    </div>
                `;
                // P≈ôidej do den√≠ku
                if (!state.discoveredSecrets) state.discoveredSecrets = [];
                if (!state.discoveredSecrets.includes(`${npcId}_secret`)) {
                    state.discoveredSecrets.push(`${npcId}_secret`);
                    addXP(50);
                }
            }
            
            // Mo≈ænost pokraƒçovat v rozhovoru
            let continueOptions = '<div style="display: grid; gap: 0.4rem; margin-top: 1rem;">';
            
            // Najdi souvisej√≠c√≠ NPC ze zm√≠nky
            if (dialogues?.mentions) {
                const relatedNpcs = Object.keys(dialogues.mentions).slice(0, 2);
                relatedNpcs.forEach(relNpcId => {
                    const relNpc = FRIENDLY_NPCS.find(n => n.id === relNpcId);
                    if (relNpc) {
                        continueOptions += `
                            <button class="btn" onclick="talkToFriendlyNPC('${npcId}')" style="background: #3949AB;">
                                üí¨ "Povƒõz mi v√≠c o ${relNpc.name}..."
                            </button>
                        `;
                    }
                });
            }
            
            continueOptions += `
                <button class="btn" onclick="talkToFriendlyNPC('${npcId}')" style="background: var(--toxic-dark);">
                    üí¨ Zeptat se na nƒõco jin√©ho
                </button>
                <button class="btn" onclick="showNPCDetail('${npcId}')" style="background: #555;">
                    ‚Üê Zpƒõt na profil
                </button>
            </div>`;
            
            showModal(`üí¨ ${npc.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${npc.icon}</div>
                </div>
                
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--rust);">
                    <p style="font-style: italic; color: #ddd; margin: 0; line-height: 1.6;">${response}</p>
                </div>
                
                ${specialEffect}
                
                <p style="color: #8bc34a; margin-top: 0.5rem; font-size: 0.85rem; text-align: center;">‚ú® +10 XP</p>
                
                ${continueOptions}
            `);
            
            renderFull();
        }
        
        // === REAKCE NA KORYHO A KOUDYHO ===
        function respondToKory(response) {
            state.npcRelations = state.npcRelations || {};
            state.npcRelations['kory'] = state.npcRelations['kory'] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
            
            let text = '';
            let trustChange = 0;
            
            switch(response) {
                case 'interested':
                    text = `*Kory se usmƒõje - poprv√© up≈ô√≠mnƒõ*
                    
"Koneƒçnƒõ nƒõkdo, kdo chce SLY≈†ET ne≈æ soudit."

"M≈Øj otec vytvo≈ôil AURORU. Vakc√≠nu, kter√° mƒõla zachr√°nit svƒõt. M√≠sto toho ho zmƒõnila. J√° jsem jen... urychlil nevyhnuteln√©."

"Star√Ω svƒõt um√≠ral. Pomalu, bolestivƒõ. J√° mu dal rychlou smrt. A z popela..."

*uk√°≈æe na osadu kolem*

"...povst√°v√° nƒõco nov√©ho. Silnƒõj≈°√≠ho. Lid√©, kte≈ô√≠ p≈ôe≈æili, jsou ti NEJLEP≈†√ç z n√°s."

"Chce≈° se p≈ôidat? M≈Ø≈æu ti uk√°zat cestu k opravdov√© s√≠le."`;
                    trustChange = 10;
                    break;
                case 'suspicious':
                    text = `*Kory p≈ôik√Ωvne s respektem*
                    
"Dobr√° ot√°zka. Proƒç by mƒõl KDOKOLI vƒõ≈ôit ƒçlovƒõku, kter√©ho obvi≈àuj√≠ z konce svƒõta?"

"Nem√°m pro tebe odpovƒõƒè. Jen fakta."

"Pod√≠vej se kolem sebe. Vid√≠≈° ty lidi? Ti siln√≠ p≈ôe≈æili. Ti slab√≠ ne. To nen√≠ krutost - to je P≈ò√çRODA."

"M≈Øj bratr Koudy chce vr√°tit star√Ω svƒõt. Svƒõt, kter√Ω n√°s pomalu zab√≠jel. J√° chci postavit nov√Ω."

"Vƒõ≈ô si ƒçemu chce≈°. Ale a≈æ uvid√≠≈°, co Koudy opravdu dƒõl√° ve sv√© laborato≈ôi... mo≈æn√° zmƒõn√≠≈° n√°zor."`;
                    trustChange = 5;
                    break;
                case 'hostile':
                    text = `*Koryho oƒçi ztvrdnou, ale hlas z≈Østane klidn√Ω*
                    
"Masov√Ω vrah. Ano. Sly≈°el jsem to mnohokr√°t."

"V√≠≈°, kolik lid√≠ zem≈ôelo kv≈Øli STAR√âMU svƒõtu? V√°lky. Hlad. Nemoci. Miliardy za stalet√≠."

"J√° jsem to ukonƒçil. Rychle. Milosrdnƒõ."

*naklon√≠ se bl√≠≈æ*

"Ale jestli chce≈° nƒõkoho vinit... zeptej se m√©ho bratra, proƒç neudƒõlal NIC, kdy≈æ vƒõdƒõl co se chyst√°. Zeptej se, co OPRAVDU dƒõl√° v t√© jeho laborato≈ôi."

"Vra≈• se, a≈æ bude≈° p≈ôipraven poslouchat. Zat√≠m..."

*m√°vne rukou na odchod*`;
                    trustChange = -5;
                    break;
            }
            
            state.npcRelations['kory'].trust = Math.max(0, Math.min(100, state.npcRelations['kory'].trust + trustChange));
            
            showModal('ü¶π Kory', `
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #9c27b0; white-space: pre-line; line-height: 1.6;">
                    <p style="color: #ddd;">${text}</p>
                </div>
                <p style="color: ${trustChange >= 0 ? '#8bc34a' : '#c62828'}; text-align: center;">
                    ‚ù§Ô∏è ${trustChange >= 0 ? '+' : ''}${trustChange} d≈Øvƒõry s Korym
                </p>
                <button class="btn" onclick="showNPCDetail('kory')" style="width: 100%; margin-top: 1rem;">${'Pokraƒçovat'}</button>
            `);
            renderFull();
        }
        
        function respondToKoudy(response) {
            state.npcRelations = state.npcRelations || {};
            state.npcRelations['koudy'] = state.npcRelations['koudy'] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0, talkedTopics: [] };
            
            let text = '';
            let trustChange = 0;
            
            switch(response) {
                case 'helpful':
                    text = `*Koudyho unaven√© oƒçi se rozz√°≈ô√≠ nadƒõj√≠*
                    
"Opravdu? Ty... chce≈° pomoct?"

*ot≈ôe si ruce do pl√°≈°tƒõ*

"Pracuji na zp≈Øsobu, jak pou≈æ√≠t Genesis k OBNOVƒö. Vyƒçistit radiaci. Stabilizovat mutace. D√°t tomuhle svƒõtu druhou ≈°anci."

"Ale pot≈ôebuji komponenty. Jsou rozpt√Ωlen√© po cel√©m kraji. Nebezpeƒçn√° m√≠sta. Nebezpeƒçn√≠ lid√©."

"A m≈Øj bratr..." *povzdech* "...Kory hled√° tot√©≈æ. Ale on chce Genesis pou≈æ√≠t k... oƒçistƒõ. Zab√≠t v≈°echny, kdo nejsou 'dostateƒçnƒõ siln√≠'."

"Pomoz mi ho zastavit. Pomoz mi zachr√°nit, co zbylo."`;
                    trustChange = 10;
                    break;
                case 'curious':
                    text = `*Koudy p≈ôik√Ωvne a uk√°≈æe na sch√©mata na stƒõnƒõ*
                    
"Genesis. Projekt m√©ho bratra. Geni√°ln√≠ a dƒõsiv√Ω z√°rove≈à."

"V podstatƒõ je to planet√°rn√≠ transform√°tor. Dok√°≈æe p≈ôepsat... v≈°echno. DNA, ekosyst√©my, radiaci."

"M√° dvƒõ konfigurace. OBNOVA - vyƒçist√≠ svƒõt, d√° n√°m ≈°anci zaƒç√≠t znovu. A OƒåISTA - zabije v≈°echno kromƒõ tƒõch s 'kompatibiln√≠ genetikou'."

"Kory vƒõ≈ô√≠, ≈æe oƒçista je jedin√° cesta. ≈Ωe slab√≠ mus√≠ zem≈ô√≠t, aby siln√≠ mohli ≈æ√≠t."

*t≈ôese se mu hlas*

"J√° vƒõ≈ô√≠m... MUS√çM vƒõ≈ôit... ≈æe existuje jin√° cesta. ≈Ωe m≈Ø≈æeme b√Ωt lep≈°√≠ ne≈æ on."`;
                    trustChange = 5;
                    break;
                case 'blame':
                    text = `*Koudy sklop√≠ hlavu. Ticho trv√° dlouho.*
                    
"Ano."

"Ano, zniƒçil jsem svƒõt. J√° a m≈Øj bratr. A n√°≈° otec."

"AURORA byla na≈°e. Genesis byl n√°≈°. A kdy≈æ jsem vidƒõl, co Kory pl√°nuje..."

*hlas se zlom√≠*

"...neudƒõlal jsem DOST. Mohl jsem ho zastavit. Mohl jsem v≈°echno zve≈ôejnit. M√≠sto toho jsem doufal, ≈æe se m√Ωl√≠m."

"Tak≈æe ano. Vi≈à mƒõ. Zaslou≈æ√≠m si to."

*zvedne hlavu*

"Ale teƒè se sna≈æ√≠m to napravit. To je v≈°echno, co m≈Ø≈æu dƒõlat."`;
                    trustChange = 5;
                    break;
            }
            
            state.npcRelations['koudy'].trust = Math.max(0, Math.min(100, state.npcRelations['koudy'].trust + trustChange));
            
            showModal('üë®‚Äçüî¨ Koudy', `
                <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #4caf50; white-space: pre-line; line-height: 1.6;">
                    <p style="color: #ddd;">${text}</p>
                </div>
                <p style="color: ${trustChange >= 0 ? '#8bc34a' : '#c62828'}; text-align: center;">
                    ‚ù§Ô∏è ${trustChange >= 0 ? '+' : ''}${trustChange} d≈Øvƒõry s Koudym
                </p>
                <button class="btn" onclick="showNPCDetail('koudy')" style="width: 100%; margin-top: 1rem;">${'Pokraƒçovat'}</button>
            `);
            renderFull();
        }
        
        function giveGiftToNPC(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) return;
            
            // === KONTROLA LOKACE ===
            const currentLocation = state.world?.currentLocation;
            if (currentLocation !== npc.location) {
                showModal('üìç P≈ô√≠li≈° daleko', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üö´</div>
                        <p>${npc.name} nen√≠ pobl√≠≈æ.</p>
                        <p style="color: #888; font-size: 0.85rem;">Mus√≠≈° b√Ωt v lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</strong> abys mohl d√°t dar.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            // Uk√°zat v√Ωbƒõr dar≈Ø - pou≈æij suroviny z invent√°≈ôe nebo pen√≠ze
            // Vƒõt≈°√≠ dary maj√≠ LEP≈†√ç pomƒõr (bonus za ≈°tƒõdrost)
            const giftOptions = [
                { id: 'food', name: 'J√≠dlo (2x)', icon: 'üçñ', cost: { type: 'inv_resource', key: 'food', amount: 2 }, trust: 8 },
                { id: 'water', name: 'Voda (2x)', icon: 'üíß', cost: { type: 'inv_resource', key: 'water', amount: 2 }, trust: 8 },
                { id: 'herbs', name: 'Byliny (3x)', icon: 'üåø', cost: { type: 'inv_resource', key: 'herbs', amount: 3 }, trust: 12 },
                { id: 'metal', name: 'Kov (5x)', icon: '‚öôÔ∏è', cost: { type: 'inv_resource', key: 'metal', amount: 5 }, trust: 15 },
                { id: 'money_small', name: 'Pen√≠ze (25)', icon: 'üí∞', cost: { type: 'money', amount: 25 }, trust: 10 },
                { id: 'money_medium', name: 'Pen√≠ze (50)', icon: 'üí∞üí∞', cost: { type: 'money', amount: 50 }, trust: 22 }, // Bonus +2
                { id: 'money_big', name: 'Pen√≠ze (100)', icon: 'üí∞üí∞üí∞', cost: { type: 'money', amount: 100 }, trust: 50 } // Bonus +10 (100p = 5x v√≠c penƒõz, dostane≈° 5x v√≠c trust + bonus)
            ];
            
            // === SPECI√ÅLN√ç DAR: Prastar√Ω artefakt pro Z√°hadnou ≈æenu ===
            const hasArtifact = state.inv.some(i => i.id === 'unique_artifact');
            if (npcId === 'mysterious_woman' && hasArtifact) {
                giftOptions.unshift({
                    id: 'unique_artifact',
                    name: 'üè∫ Prastar√Ω artefakt',
                    icon: 'üè∫',
                    cost: { type: 'item', itemId: 'unique_artifact' },
                    trust: 100, // MAX trust!
                    special: true
                });
            }
            
            const giftsHtml = giftOptions.map(gift => {
                let canGive = false;
                let costText = '';
                
                if (gift.cost.type === 'inv_resource') {
                    canGive = (state.resources[gift.cost.key] || 0) >= gift.cost.amount;
                    costText = `${gift.cost.amount}x`;
                } else if (gift.cost.type === 'money') {
                    canGive = state.money >= gift.cost.amount;
                    costText = `${gift.cost.amount} üí∞`;
                } else if (gift.cost.type === 'item') {
                    canGive = state.inv.some(i => i.id === gift.cost.itemId);
                    costText = 'üè∫ LEGENDARY';
                }
                
                // Speci√°ln√≠ styling pro legendary dar
                const isSpecial = gift.special;
                const btnStyle = isSpecial 
                    ? 'background: linear-gradient(135deg, #9c27b0, #673ab7); border: 2px solid #ffd700;'
                    : '';
                
                return `
                    <button class="btn" onclick="confirmGift('${npcId}', '${gift.id}')" 
                        style="display: flex; justify-content: space-between; align-items: center; width: 100%; ${!canGive ? 'opacity: 0.5;' : ''} ${btnStyle}"
                        ${!canGive ? 'disabled' : ''}>
                        <span>${gift.icon} ${gift.name}</span>
                        <span style="font-size: 0.8rem; color: ${canGive ? (isSpecial ? '#ffd700' : '#8bc34a') : '#666'};">${costText} ‚Üí ‚ù§Ô∏è+${gift.trust}</span>
                    </button>
                `;
            }).join('');
            
            showModal(`üéÅ D√°t dar - ${npc.name}`, `
                <p style="color: #888; margin-bottom: 1rem;">Vyber dar pro ${npc.name}:</p>
                <div style="display: grid; gap: 0.5rem;">
                    ${giftsHtml}
                </div>
                <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function confirmGift(npcId, giftId) {
            const giftOptions = {
                'food': { cost: { type: 'inv_resource', key: 'food', amount: 2 }, trust: 8 },
                'water': { cost: { type: 'inv_resource', key: 'water', amount: 2 }, trust: 8 },
                'herbs': { cost: { type: 'inv_resource', key: 'herbs', amount: 3 }, trust: 12 },
                'metal': { cost: { type: 'inv_resource', key: 'metal', amount: 5 }, trust: 15 },
                'money_small': { cost: { type: 'money', amount: 25 }, trust: 10 },
                'money_medium': { cost: { type: 'money', amount: 50 }, trust: 22 },
                'money_big': { cost: { type: 'money', amount: 100 }, trust: 50 },
                'unique_artifact': { cost: { type: 'item', itemId: 'unique_artifact' }, trust: 100, special: true }
            };
            
            const gift = giftOptions[giftId];
            if (!gift) return;
            
            // === SPECI√ÅLN√ç DAR: Prastar√Ω artefakt pro Z√°hadnou ≈æenu ===
            if (giftId === 'unique_artifact' && npcId === 'mysterious_woman') {
                // Odeber artefakt z invent√°≈ôe
                const artifactIdx = state.inv.findIndex(i => i.id === 'unique_artifact');
                if (artifactIdx === -1) {
                    notifyWarning('Chyba', 'Nem√°≈° Prastar√Ω artefakt!');
                    return;
                }
                state.inv.splice(artifactIdx, 1);
                
                // Nastav trust na MAX
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0 };
                state.npcRelations[npcId].trust = 100;
                state.npcRelations[npcId].gifts++;
                
                // Speci√°ln√≠ odmƒõna - odhal tajnou lokaci + permanent bonus
                if (!state.world.revealedLocations) state.world.revealedLocations = [];
                state.world.revealedLocations.push('ancient_vault', 'secret_lab', 'hidden_bunker');
                
                // Permanent bonus: +10 max HP
                state.char.maxHp += 10;
                state.char.hp = Math.min(state.char.hp + 10, state.char.maxHp);
                
                showModal(`üîÆ Artefakt p≈ôijat!`, `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; animation: pulse 1s infinite;">üîÆ</div>
                        <p style="color: #9c27b0; font-style: italic; margin: 1rem 0;">"Koneƒçnƒõ... tohle jsem hledala cel√© roky."</p>
                        <p style="color: #ffd700; font-size: 1.1rem;">Z√°hadn√° ≈æena ti plnƒõ d≈Øvƒõ≈ôuje!</p>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #9c27b0;">
                            <p style="color: #8bc34a; margin: 0.3rem 0;">‚ù§Ô∏è D≈Øvƒõra: <strong>100/100</strong></p>
                            <p style="color: #9c27b0; margin: 0.3rem 0;">üó∫Ô∏è Odhaleny 3 tajn√© lokace!</p>
                            <p style="color: #ff9800; margin: 0.3rem 0;">üí™ +10 Max HP (permanentnƒõ)</p>
                        </div>
                        
                        <p style="color: #888; font-size: 0.85rem;">"Teƒè ti pov√≠m v≈°e... kdo jsem a proƒç jsem tady."</p>
                    </div>
                    <button class="btn" onclick="showNPCDetail('mysterious_woman')" style="width: 100%; margin-top: 1rem; background: #9c27b0;">üîÆ Poslouch√°m...</button>
                `);
                
                renderFull();
                saveGame();
                return;
            }
            
            // Odeƒçti n√°klady
            if (gift.cost.type === 'inv_resource') {
                state.resources[gift.cost.key] -= gift.cost.amount;
            } else if (gift.cost.type === 'money') {
                state.money -= gift.cost.amount;
            }
            
            // P≈ôidej d≈Øvƒõru
            state.npcRelations = state.npcRelations || {};
            state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0, lastTalk: 0 };
            state.npcRelations[npcId].trust = Math.min(100, state.npcRelations[npcId].trust + gift.trust);
            state.npcRelations[npcId].gifts++;
            
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            
            showModal(`üéÅ Dar p≈ôijat!`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${npc?.icon || 'üë§'}</div>
                    <p style="color: #8bc34a; font-size: 1.2rem; margin: 1rem 0;">‚ù§Ô∏è +${gift.trust} d≈Øvƒõry!</p>
                    <p style="color: #888;">${npc?.name || 'NPC'} si v√°≈æ√≠ tv√©ho daru.</p>
                </div>
                <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            
            renderFull();
        }
        
        function askNPCQuest(npcId) {
            console.log('üìú askNPCQuest called for:', npcId);
            
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            if (!npc) {
                console.log('üìú NPC not found!');
                notifyWarning('Chyba', 'NPC nenalezeno');
                return;
            }
            
            console.log('üìú NPC found:', npc.name, 'location:', npc.location);
            console.log('üìú Current location:', state.world?.currentLocation);
            
            // === KONTROLA LOKACE ===
            const currentLocation = state.world?.currentLocation;
            if (currentLocation !== npc.location) {
                console.log('üìú Location mismatch!');
                showModal('üìç P≈ô√≠li≈° daleko', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üö´</div>
                        <p>${npc.name} nen√≠ pobl√≠≈æ.</p>
                        <p style="color: #888; font-size: 0.85rem;">Mus√≠≈° b√Ωt v lokaci <strong>${WORLD_LOCATIONS.find(l => l.id === npc.location)?.name || npc.location}</strong> abys mohl p≈ôijmout nebo odevzdat quest.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">OK</button>
                `);
                return;
            }
            
            if (!npc.quests || npc.quests.length === 0) {
                showModal('üìú ≈Ω√°dn√© questy', `
                    <p>${npc.name} pro tebe moment√°lnƒõ nem√° ≈æ√°dn√Ω √∫kol.</p>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // === SPECI√ÅLN√ç PRVN√ç SETK√ÅN√ç S KORYM A KOUDYM ===
            state.storyProgress = state.storyProgress || {};
            
            // Kory - prvn√≠ setk√°n√≠
            if (npcId === 'kory' && !state.storyProgress.metKory) {
                state.storyProgress.metKory = true;
                const knowsKoudy = state.storyProgress.metKoudy;
                
                showModal('ü¶π Prvn√≠ setk√°n√≠ s Korym', `
                    <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #9c27b0;">
                        <p style="font-style: italic; color: #ddd; line-height: 1.6;">
                            *Vysok√Ω mu≈æ s pronikav√Ωma oƒçima tƒõ mƒõ≈ô√≠ pohledem*
                        </p>
                        <p style="color: #ccc; margin-top: 0.5rem;">
                            "Dal≈°√≠ tul√°k v pustinƒõ. Ale ty... ty m√°≈° v oƒç√≠ch nƒõco jin√©ho. Hlad. Ne po j√≠dle - po SMYSLU."
                        </p>
                        ${knowsKoudy ? `
                            <p style="color: #ff9800; margin-top: 0.5rem;">
                                *p≈ôimhou≈ô√≠ oƒçi* "Moment. Ten pohled... Mluvil jsi s m√Ωm bratrem, ≈æe? S Koudym?"
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Co ti ≈ôekl? ≈Ωe jsem monstrum? ≈Ωe chci zniƒçit svƒõt?" *trpk√Ω sm√≠ch* 
                                "On chce OPRAVIT star√Ω svƒõt. J√° chci postavit NOV√ù. Kdo z n√°s je vƒõt≈°√≠ bl√°zen?"
                            </p>
                        ` : `
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Mo≈æn√° jsi sly≈°el p≈ô√≠bƒõhy. O zk√°ze svƒõta. O Projektu AURORA. O bratrech, kte≈ô√≠ stoj√≠ proti sobƒõ."
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "≈ò√≠kaj√≠, ≈æe jsem zniƒçil star√Ω svƒõt. Mo≈æn√° maj√≠ pravdu. Ale ten svƒõt byl ZKA≈ΩEN√ù. 
                                Pln√Ω slaboch≈Ø, kte≈ô√≠ niƒçili planetu a naz√Ωvali to pokrokem."
                            </p>
                        `}
                        <p style="color: #9c27b0; margin-top: 0.5rem; font-weight: bold;">
                            "Z≈Østa≈à. Poslouchej. A mo≈æn√° pochop√≠≈°, proƒç jsem udƒõlal, co jsem udƒõlal."
                        </p>
                    </div>
                    
                    <p style="color: #ffd700; text-align: center;">‚≠ê +25 XP za p≈ô√≠bƒõhov√Ω moment</p>
                    
                    <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="respondToKory('interested')" style="background: #9c27b0;">
                            "Zaj√≠m√°≈° mƒõ. Pov√≠dej d√°l."
                        </button>
                        <button class="btn" onclick="respondToKory('suspicious')" style="background: #ff9800;">
                            "Proƒç bych ti mƒõl vƒõ≈ôit?"
                        </button>
                        <button class="btn" onclick="respondToKory('hostile')" style="background: #c62828;">
                            "Jsi masov√Ω vrah."
                        </button>
                    </div>
                `);
                addXP(25);
                renderFull();
                return;
            }
            
            // Koudy - prvn√≠ setk√°n√≠
            if (npcId === 'koudy' && !state.storyProgress.metKoudy) {
                state.storyProgress.metKoudy = true;
                const knowsKory = state.storyProgress.metKory;
                
                showModal('üë®‚Äçüî¨ Prvn√≠ setk√°n√≠ s Koudym', `
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #4caf50;">
                        <p style="font-style: italic; color: #ddd; line-height: 1.6;">
                            *Unavenƒõ vypadaj√≠c√≠ mu≈æ v laboratorn√≠m pl√°≈°ti zvedne hlavu od p≈ô√≠stroj≈Ø*
                        </p>
                        <p style="color: #ccc; margin-top: 0.5rem;">
                            "N√°v≈°tƒõva? To je... neobvykl√©. Vƒõt≈°ina lid√≠ se t√©hle budovƒõ vyh√Ωb√°. Boj√≠ se radiace. Nebo mƒõ."
                        </p>
                        ${knowsKory ? `
                            <p style="color: #ff9800; margin-top: 0.5rem;">
                                *zamraƒç√≠ se* "Poƒçkat. Pozn√°v√°m ten v√Ωraz. Mluvil jsi s m√Ωm bratrem. S Korym."
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Co ti nakukal? ≈Ωe je vizion√°≈ô? ≈Ωe buduje lep≈°√≠ svƒõt?" *povzdech*
                                "M≈Øj bratr vƒõ≈ô√≠, ≈æe zniƒçen√≠m star√©ho vytvo≈ô√≠ nov√©. J√° vƒõ≈ô√≠m, ≈æe m≈Ø≈æeme OPRAVIT co jsme rozbili."
                            </p>
                        ` : `
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Jmenuji se Karel. Ale v≈°ichni mi ≈ô√≠kaj√≠ Koudy. Jsem... byl jsem vƒõdec."
                            </p>
                            <p style="color: #ccc; margin-top: 0.5rem;">
                                "Tenhle svƒõt... moje rodina ho pomohla zniƒçit. AURORA. Genesis. Sly≈°el jsi ta jm√©na?"
                                *t≈ôese se mu ruka* "Sna≈æ√≠m se to napravit. Ale nƒõkdy... nƒõkdy nev√≠m, jestli je to v≈Øbec mo≈æn√©."
                            </p>
                        `}
                        <p style="color: #4caf50; margin-top: 0.5rem; font-weight: bold;">
                            "Jestli chce≈° pomoct... jestli chce≈° b√Ωt souƒç√°st√≠ nƒõƒçeho vƒõt≈°√≠ho... m≈Ø≈æu ti uk√°zat, na ƒçem pracuji."
                        </p>
                    </div>
                    
                    <p style="color: #ffd700; text-align: center;">‚≠ê +25 XP za p≈ô√≠bƒõhov√Ω moment</p>
                    
                    <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="respondToKoudy('helpful')" style="background: #4caf50;">
                            "Chci pomoct. Co m≈Ø≈æu udƒõlat?"
                        </button>
                        <button class="btn" onclick="respondToKoudy('curious')" style="background: #2196f3;">
                            "≈òekni mi v√≠c o Genesis."
                        </button>
                        <button class="btn" onclick="respondToKoudy('blame')" style="background: #ff9800;">
                            "Tak≈æe p≈ôizn√°v√°≈°, ≈æe jsi zniƒçil svƒõt?"
                        </button>
                    </div>
                `);
                addXP(25);
                renderFull();
                return;
            }
            
            // === NORM√ÅLN√ç QUEST SYST√âM ===
            
            // Kontrola jestli u≈æ quest m√°me - P≈òED v√Ωbƒõrem nov√©ho
            state.npcQuests = state.npcQuests || {};
            const activeQuest = state.npcQuests[npcId];
            
            // Pokud m√°me aktivn√≠ quest, zobraz jeho stav
            if (activeQuest && activeQuest.id) {
                const quest = NPC_QUESTS[activeQuest.id];
                if (quest) {
                    const canComplete = checkNPCQuestProgress(activeQuest, quest);
                    
                    // Pro deliver quest - kontrola jestli jsme u spr√°vn√©ho NPC
                    const isDeliverQuest = quest.requirement?.deliver;
                    const deliverTarget = activeQuest.deliverTarget;
                    const isAtDeliverTarget = isDeliverQuest && npcId === deliverTarget;
                    const isAtQuestGiver = !isDeliverQuest || npcId !== deliverTarget;
                    
                    // Pokud jsme u c√≠lov√©ho NPC pro doruƒçen√≠
                    if (isDeliverQuest && isAtDeliverTarget && canComplete) {
                        const questGiverNpcId = Object.keys(state.npcQuests).find(id => 
                            state.npcQuests[id]?.deliverTarget === npcId
                        );
                        
                        showModal(`üì¶ Doruƒçen√≠ z√°silek`, `
                            <div style="text-align: center; margin-bottom: 1rem;">
                                <div style="font-size: 3rem;">${npc.icon}</div>
                            </div>
                            <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"Aha, z√°soby od obchodn√≠ka! V√Ωbornƒõ, pr√°vƒõ je pot≈ôebuju."</p>
                            
                            <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üéÅ Odmƒõna:</h4>
                                <p style="font-size: 0.9rem; color: #aaa;">
                                    ${quest.reward.money ? `üí∞ ${quest.reward.money} penƒõz ` : ''}
                                    ${quest.reward.trust ? `‚ù§Ô∏è +${quest.reward.trust} d≈Øvƒõry ` : ''}
                                    ${quest.reward.xp ? `‚≠ê +${quest.reward.xp} XP` : ''}
                                </p>
                            </div>
                            
                            <button class="btn" onclick="completeDeliverQuest('${questGiverNpcId}', '${npcId}')" style="width: 100%; background: #4caf50;">üì¶ P≈ôedat z√°soby</button>
                            <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: #555;">Zpƒõt</button>
                        `);
                        return;
                    }
                    
                    // Norm√°ln√≠ zobrazen√≠ u zadavatele
                    let completeButton = '';
                    if (canComplete) {
                        if (isDeliverQuest) {
                            // U zadavatele deliver questu jen info
                            const targetNpc = FRIENDLY_NPCS.find(n => n.id === deliverTarget);
                            completeButton = `
                                <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #ff9800;">
                                    <p style="color: #ff9800; margin: 0;">üìç Dones z√°soby k: ${targetNpc?.icon || 'üë§'} ${targetNpc?.name || 'NPC'}</p>
                                </div>
                            `;
                        } else {
                            completeButton = `<button class="btn" onclick="completeNPCQuest('${npcId}')" style="width: 100%; background: #4caf50;">‚úÖ Odevzdat quest</button>`;
                        }
                    }
                    
                    showModal(`üìú ${quest.name}`, `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 3rem;">${npc.icon}</div>
                        </div>
                        <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"${quest.desc}"</p>
                        
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">üìã Postup:</h4>
                            ${renderQuestProgress(activeQuest, quest)}
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üéÅ Odmƒõna:</h4>
                            <p style="font-size: 0.9rem; color: #aaa;">
                                ${quest.reward.money ? `üí∞ ${quest.reward.money} penƒõz ` : ''}
                                ${quest.reward.trust ? `‚ù§Ô∏è +${quest.reward.trust} d≈Øvƒõry ` : ''}
                                ${quest.reward.xp ? `‚≠ê +${quest.reward.xp} XP` : ''}
                            </p>
                        </div>
                        
                        ${completeButton}
                        <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 0.5rem; background: #555;">Zpƒõt</button>
                    `);
                    return;
                }
            }
            
            // Nem√°me aktivn√≠ quest - vyber nov√Ω n√°hodnƒõ (ale ne u≈æ dokonƒçen√Ω)
            const completedQuests = state.npcQuests[npcId]?.completed || [];
            const availableQuests = npc.quests.filter(qId => !completedQuests.includes(qId));
            
            if (availableQuests.length === 0) {
                showModal('üìú V≈°e splnƒõno!', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">üèÜ</div>
                        <p>${npc?.name || 'NPC'} pro tebe u≈æ nem√° ≈æ√°dn√© dal≈°√≠ √∫koly.</p>
                        <p style="color: #8bc34a;">Splnil jsi v≈°echny questy!</p>
                    </div>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const questId = availableQuests[Math.floor(Math.random() * availableQuests.length)];
            const quest = NPC_QUESTS[questId];
            
            if (!quest) {
                showModal('üìú ≈Ω√°dn√© questy', `<p>Zkus to pozdƒõji.</p>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem;">OK</button>`);
                return;
            }
            
            // Nov√Ω quest - nab√≠dni p≈ôijmout
            showModal(`üìú ${quest.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${npc.icon}</div>
                </div>
                <p style="color: #ddd; font-style: italic; margin-bottom: 1rem;">"${quest.desc}"</p>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">üìã Po≈æadavky:</h4>
                    ${renderQuestRequirements(quest)}
                </div>
                
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üéÅ Odmƒõna:</h4>
                    <p style="font-size: 0.9rem; color: #aaa;">
                        ${quest.reward.money ? `üí∞ ${quest.reward.money} penƒõz ` : ''}
                        ${quest.reward.trust ? `‚ù§Ô∏è +${quest.reward.trust} d≈Øvƒõry ` : ''}
                        ${quest.reward.xp ? `‚≠ê +${quest.reward.xp} XP` : ''}
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="acceptNPCQuest('${npcId}', '${questId}')" style="flex: 1; background: #4caf50;">‚úÖ P≈ôijmout</button>
                    <button class="btn" onclick="showNPCDetail('${npcId}')" style="flex: 1; background: #555;">Odm√≠tnout</button>
                </div>
            `);
        }
        
        function renderQuestRequirements(quest) {
            const req = quest.requirement;
            let html = '<ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">';
            
            if (req.resources) html += `<li>P≈ôines ${req.resources} r≈Øzn√Ωch surovin</li>`;
            if (req.herbs) html += `<li>P≈ôines ${req.herbs}√ó byliny</li>`;
            if (req.metal) html += `<li>P≈ôines ${req.metal}√ó kov</li>`;
            if (req.explore) html += `<li>Prozkoumej ${req.explore} lokac√≠</li>`;
            if (req.kills) html += `<li>Zabij ${req.kills} nep≈ô√°tel</li>`;
            if (req.escort) html += `<li>Doprovoƒè karavanu (nav≈°tiv 3 lokace)</li>`;
            if (req.riddles) html += `<li>Odpovƒõz na ${req.riddles} h√°danky</li>`;
            
            html += '</ul>';
            return html;
        }
        
        function renderQuestProgress(activeQuest, quest) {
            const req = quest.requirement;
            const prog = activeQuest.progress || {};
            const start = activeQuest.startState || {};
            let html = '<ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">';
            
            if (req.resources) {
                // Poƒç√≠tej nasb√≠ran√© suroviny od p≈ôijet√≠ questu (stejnƒõ jako checkNPCQuestProgress)
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                const collected = Math.max(0, currentResources - startResources);
                html += `<li style="color: ${collected >= req.resources ? '#8bc34a' : '#ff9800'};">Suroviny: ${collected}/${req.resources}</li>`;
                
                // Pokud je to deliver quest a m√°me dost surovin, uka≈æ c√≠l
                if (req.deliver && collected >= req.resources) {
                    const targetNpcId = activeQuest.deliverTarget;
                    const targetNpc = FRIENDLY_NPCS.find(n => n.id === targetNpcId);
                    if (targetNpc) {
                        const targetLoc = findNPCLocation(targetNpcId);
                        html += `<li style="color: #2196f3;">üìç Dones k: ${targetNpc.icon} ${targetNpc.name}</li>`;
                        if (targetLoc) {
                            const loc = LOCATIONS[targetLoc];
                            html += `<li style="color: #888; font-size: 0.85rem;">   Lokace: ${loc?.name || targetLoc}</li>`;
                        }
                    }
                } else if (req.deliver) {
                    html += `<li style="color: #666;">üìç C√≠l doruƒçen√≠: (nasb√≠rej suroviny)</li>`;
                }
            }
            if (req.herbs) {
                const collected = Math.max(0, (state.resources?.herbs || 0) - (start.herbs || 0));
                html += `<li style="color: ${collected >= req.herbs ? '#8bc34a' : '#ff9800'};">Byliny: ${collected}/${req.herbs}</li>`;
            }
            if (req.metal) {
                const collected = Math.max(0, (state.resources?.metal || 0) - (start.metal || 0));
                html += `<li style="color: ${collected >= req.metal ? '#8bc34a' : '#ff9800'};">Kov: ${collected}/${req.metal}</li>`;
            }
            if (req.explore) {
                const current = prog.explored || 0;
                html += `<li style="color: ${current >= req.explore ? '#8bc34a' : '#ff9800'};">Prozkoum√°no: ${current}/${req.explore}</li>`;
            }
            if (req.kills) {
                const current = prog.kills || 0;
                html += `<li style="color: ${current >= req.kills ? '#8bc34a' : '#ff9800'};">Zabito: ${current}/${req.kills}</li>`;
            }
            if (req.escort) {
                const current = prog.escortLocations || 0;
                html += `<li style="color: ${current >= 3 ? '#8bc34a' : '#ff9800'};">Nav≈°t√≠ven√© lokace: ${current}/3</li>`;
            }
            
            html += '</ul>';
            return html;
        }
        
        function checkNPCQuestProgress(activeQuest, quest) {
            const req = quest.requirement;
            const prog = activeQuest.progress || {};
            const start = activeQuest.startState || {};
            
            // Sbƒõr r≈Øzn√Ωch surovin (poƒç√≠t√° se od p≈ôijet√≠)
            if (req.resources) {
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                const collected = currentResources - startResources;
                if (collected < req.resources) return false;
            }
            
            // Byliny (poƒç√≠t√° se od p≈ôijet√≠)
            if (req.herbs) {
                const collected = (state.resources?.herbs || 0) - (start.herbs || 0);
                if (collected < req.herbs) return false;
            }
            
            // Kov (poƒç√≠t√° se od p≈ôijet√≠)
            if (req.metal) {
                const collected = (state.resources?.metal || 0) - (start.metal || 0);
                if (collected < req.metal) return false;
            }
            
            // Konkr√©tn√≠ surovina (resource + amount) - pro Kory/Koudy questy - STAƒå√ç M√çT
            if (req.resource && req.amount) {
                const current = state.resources?.[req.resource] || 0;
                if (current < req.amount) return false;
            }
            
            // Pen√≠ze - ƒåERSTVƒö Z√çSKAN√â
            if (req.money) {
                const current = state.money || 0;
                const startMoney = start.money || 0;
                const earned = current - startMoney;
                if (earned < req.money) return false;
            }
            
            // Explore
            if (req.explore && (prog.explored || 0) < req.explore) return false;
            
            // Kills
            if (req.kills && (prog.kills || 0) < req.kills) return false;
            
            // Kill Alpha (zabij alfa pred√°tora)
            if (req.killAlpha && !prog.alphaKilled) return false;
            
            // Escort (karavana - nav≈°tiv X lokac√≠)
            if (req.escort) {
                const requiredLocations = req.travels || 3;
                if ((prog.escortLocations || 0) < requiredLocations) return false;
            }
            
            // Travels (bez escort - jen cesty, nap≈ô. deliver_package)
            if (req.travels && !req.escort) {
                if ((prog.travels || 0) < req.travels) return false;
            }
            
            // Find NPC (najdi p≈ôe≈æiv≈°√≠ho)
            if (req.find_npc && !prog.npcFound) return false;
            
            // Rescue (zachra≈à pacienta)
            if (req.rescue && !prog.rescued) return false;
            
            // Artifact (najdi artefakt)
            if (req.artifact && !prog.artifactFound) return false;
            
            // Riddles (h√°danky) - ≈ôe≈°√≠ se speci√°lnƒõ v startRiddleQuest
            if (req.riddles) return prog.riddlesSolved >= req.riddles;
            
            // Visit (nav≈°tiv konkr√©tn√≠ lokaci)
            if (req.visit) {
                if (!prog.visited) return false;
            }
            
            // Talk (promluv s NPC) - automaticky splnƒõno po p≈ôijet√≠ a zobrazen√≠ detailu
            if (req.talk) {
                if (!prog.talked) return false;
            }
            
            return true;
        }
        
        // Z√≠skej progress questu pro zobrazen√≠
        function getNPCQuestProgress(activeQuest, quest) {
            const req = quest.requirement;
            const prog = activeQuest.progress || {};
            const start = activeQuest.startState || {};
            
            let result = { current: 0, required: 1, label: '', complete: false, percent: 0 };
            
            if (req.resources) {
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                result.current = Math.max(0, currentResources - startResources);
                result.required = req.resources;
                result.label = 'üì¶ Suroviny';
            }
            else if (req.herbs) {
                result.current = Math.max(0, (state.resources?.herbs || 0) - (start.herbs || 0));
                result.required = req.herbs;
                result.label = 'üåø Byliny';
            }
            else if (req.metal) {
                result.current = Math.max(0, (state.resources?.metal || 0) - (start.metal || 0));
                result.required = req.metal;
                result.label = 'üî© Kov';
            }
            else if (req.resource && req.amount) {
                const icons = { gunpowder: 'üí•', metal: 'üî©', wood: 'ü™µ', cloth: 'üßµ', herbs: 'üåø' };
                const names = { gunpowder: 'St≈ôeln√Ω prach', metal: 'Kov', wood: 'D≈ôevo', cloth: 'L√°tka', herbs: 'Byliny' };
                result.current = Math.min(state.resources?.[req.resource] || 0, req.amount);
                result.required = req.amount;
                result.label = `${icons[req.resource] || 'üì¶'} ${names[req.resource] || req.resource}`;
            }
            else if (req.money) {
                const current = state.money || 0;
                const startMoney = start.money || 0;
                result.current = Math.max(0, current - startMoney);
                result.required = req.money;
                result.label = 'üí∞ Z√≠sk√°no';
            }
            else if (req.explore) {
                result.current = prog.explored || 0;
                result.required = req.explore;
                result.label = 'üó∫Ô∏è Lokace';
            }
            else if (req.kills) {
                result.current = prog.kills || 0;
                result.required = req.kills;
                result.label = 'üíÄ Zabito';
            }
            else if (req.killAlpha) {
                result.current = prog.alphaKilled ? 1 : 0;
                result.required = 1;
                result.label = 'üê∫ Alfa pred√°tor';
            }
            else if (req.escort) {
                result.current = prog.escortLocations || 0;
                result.required = req.travels || 3;
                result.label = 'üê™ Lokace';
            }
            else if (req.travels && !req.escort) {
                result.current = prog.travels || 0;
                result.required = req.travels;
                result.label = 'üö∂ Cesty';
            }
            else if (req.visit) {
                result.current = prog.visited ? 1 : 0;
                result.required = 1;
                result.label = `üìç Nav≈°tiv ${WORLD_LOCATIONS.find(l => l.id === req.visit)?.name || req.visit}`;
            }
            else if (req.talk) {
                result.current = prog.talked ? 1 : 0;
                result.required = 1;
                result.label = 'üí¨ Promluv';
            }
            else if (req.find_npc) {
                result.current = prog.npcFound ? 1 : 0;
                result.required = 1;
                result.label = 'üë§ P≈ôe≈æiv≈°√≠';
            }
            else if (req.rescue) {
                result.current = prog.rescued ? 1 : 0;
                result.required = 1;
                result.label = 'üÜò Zachr√°nƒõno';
            }
            else if (req.artifact) {
                result.current = prog.artifactFound ? 1 : 0;
                result.required = 1;
                result.label = 'üè∫ Artefakt';
            }
            else if (req.riddles) {
                result.current = prog.riddlesSolved || 0;
                result.required = req.riddles;
                result.label = 'üß© H√°danky';
            }
            
            result.complete = result.current >= result.required;
            result.percent = Math.min(100, (result.current / Math.max(1, result.required)) * 100);
            
            return result;
        }
        
        // === SPECI√ÅLN√ç QUEST TRIGGERY ===
        function checkSpecialQuestTriggers(locationId) {
            if (!state.npcQuests) return;
            
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            if (!loc) return;
            
            Object.entries(state.npcQuests).forEach(([npcId, questData]) => {
                if (!questData?.id || !questData.progress) return;
                const quest = NPC_QUESTS[questData.id];
                if (!quest) return;
                
                // Find NPC (najdi p≈ôe≈æiv≈°√≠ho) - v opu≈°tƒõn√Ωch budov√°ch, ruin√°ch, explore lokac√≠ch
                if (quest.requirement?.find_npc && !questData.progress.npcFound) {
                    const validTypes = ['explore', 'npc', 'settlement', 'empty'];
                    const validIds = ['ruined_village', 'abandoned_house', 'old_farm', 'motel', 'safehouse', 'old_church'];
                    if ((validTypes.includes(loc.type) || validIds.includes(loc.id)) && Math.random() < 0.25) {
                        questData.progress.npcFound = true;
                        console.log(`üë§ Find NPC quest splnƒõn na lokaci ${loc.id}`);
                        showModal('üë§ P≈ôe≈æiv≈°√≠ nalezen!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">üë§</div>
                                <p style="color: #8bc34a;">"D√≠ky bohu! Hledal jsem pomoc..."</p>
                                <p style="color: #888;">Na≈°el jsi ztracen√©ho p≈ôe≈æiv≈°√≠ho! Vra≈• se k zadavateli pro odmƒõnu.</p>
                            </div>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">‚úì V√Ωbornƒõ!</button>
                        `);
                        SoundSystem.play('victory');
                    }
                }
                
                // Rescue (zachra≈à pacienta) - v t√°borech n√°jezdn√≠k≈Ø, nebezpeƒçn√Ωch lokac√≠ch
                if (quest.requirement?.rescue && !questData.progress.rescued) {
                    const validTypes = ['hostile', 'dangerous', 'dungeon'];
                    const validIds = ['raider_camp', 'slave_camp', 'military_outpost', 'research_camp'];
                    if ((validTypes.includes(loc.type) || validIds.includes(loc.id)) && Math.random() < 0.3) {
                        questData.progress.rescued = true;
                        console.log(`üÜò Rescue quest splnƒõn na lokaci ${loc.id}`);
                        showModal('üÜò Pacient zachr√°nƒõn!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">üè•</div>
                                <p style="color: #8bc34a;">"Jsi m≈Øj zachr√°nce!"</p>
                                <p style="color: #888;">Osvobodil jsi zajatce! Vra≈• se k zadavateli pro odmƒõnu.</p>
                            </div>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">‚úì V√Ωbornƒõ!</button>
                        `);
                        SoundSystem.play('victory');
                    }
                }
                
                // Artifact (najdi artefakt) - v ruin√°ch, dungeonech, star√Ωch m√≠stech
                if (quest.requirement?.artifact && !questData.progress.artifactFound) {
                    const validTypes = ['dungeon', 'explore', 'dangerous'];
                    const validIds = ['ruins_north', 'ruins_south', 'old_bunker', 'underground_bunker', 'ancient_vault', 'secret_lab', 'old_church', 'cemetery'];
                    if ((validTypes.includes(loc.type) || validIds.includes(loc.id)) && Math.random() < 0.2) {
                        questData.progress.artifactFound = true;
                        console.log(`üè∫ Artifact quest splnƒõn na lokaci ${loc.id}`);
                        showModal('üè∫ Artefakt nalezen!', `
                            <div style="text-align: center;">
                                <div style="font-size: 4rem;">üè∫</div>
                                <p style="color: #9c27b0; font-style: italic;">"Prastar√Ω p≈ôedmƒõt pulzuje zvl√°≈°tn√≠ energi√≠..."</p>
                                <p style="color: #888;">Na≈°el jsi z√°hadn√Ω artefakt! Vra≈• se k Z√°hadn√© ≈æenƒõ pro odmƒõnu.</p>
                            </div>
                            <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #9c27b0;">‚úì Tajemn√©...</button>
                        `);
                        SoundSystem.play('victory');
                    }
                }
            });
        }
        
        function acceptNPCQuest(npcId, questId) {
            const quest = NPC_QUESTS[questId];
            if (!quest) return;
            
            // Speci√°ln√≠ handling pro h√°danky
            if (questId === 'solve_riddle') {
                startRiddleQuest(npcId);
                return;
            }
            
            state.npcQuests = state.npcQuests || {};
            
            // Pro "talk" questy - automaticky nastav talked na true p≈ôi p≈ôijet√≠
            // (proto≈æe u≈æ s NPC mluv√≠≈° kdy≈æ p≈ôij√≠m√°≈° quest)
            const isTalkQuest = quest.requirement?.talk === true;
            
            state.npcQuests[npcId] = {
                id: questId,
                startTime: Date.now(),
                progress: { explored: 0, kills: 0, escortLocations: 0, talked: isTalkQuest },
                // Ulo≈æit startovn√≠ stav pro sledov√°n√≠ progressu
                startState: {
                    herbs: state.resources?.herbs || 0,
                    metal: state.resources?.metal || 0,
                    wood: state.resources?.wood || 0,
                    cloth: state.resources?.cloth || 0,
                    leather: state.resources?.leather || 0,
                    electronics: state.resources?.electronics || 0,
                    chemicals: state.resources?.chemicals || 0,
                    gunpowder: state.resources?.gunpowder || 0,
                    kills: state.stats?.kills || 0,
                    explored: state.world?.visitedLocations?.length || 0,
                    resources: Object.values(state.resources || {}).reduce((a, b) => a + b, 0),
                    money: state.money || 0
                }
            };
            
            // Pokud je to deliver quest, vyber n√°hodn√©ho c√≠lov√©ho NPC (jin√©ho ne≈æ zadavatele)
            if (quest.requirement?.deliver && quest.deliverTargets) {
                const availableTargets = quest.deliverTargets.filter(t => t !== npcId && FRIENDLY_NPCS.find(n => n.id === t));
                if (availableTargets.length > 0) {
                    state.npcQuests[npcId].deliverTarget = availableTargets[Math.floor(Math.random() * availableTargets.length)];
                }
            }
            
            notifyQuest(quest.name + ' p≈ôijat!');
            addLog('P≈ôijal jsi quest: ' + quest.name, 'üìú');
            showNPCDetail(npcId);
        }
        
        // === SYST√âM H√ÅDANEK PRO Z√ÅHADNOU ≈ΩENU ===
        const RIDDLES = [
            { question: "Co m√° hlavu a patu, ale ≈æ√°dn√© nohy?", 
              correct: "Mince", 
              options: ["Mince", "Had", "St≈Øl"] },
            { question: "ƒå√≠m v√≠c bere≈°, t√≠m v√≠c roste. Co to je?", 
              correct: "D√≠ra", 
              options: ["D√≠ra", "Strom", "≈òeka"] },
            { question: "Co je lehƒç√≠ ne≈æ p√≠rko, ale ani nejsilnƒõj≈°√≠ ƒçlovƒõk ho neudr≈æ√≠ d√©le ne≈æ minutu?", 
              correct: "Dech", 
              options: ["Dech", "My≈°lenka", "Svƒõtlo"] },
            { question: "M√°m mƒõsta, ale ≈æ√°dn√© domy. M√°m lesy, ale ≈æ√°dn√© stromy. M√°m vodu, ale ≈æ√°dn√© ryby. Co jsem?", 
              correct: "Mapa", 
              options: ["Mapa", "Sen", "Vzpom√≠nka"] },
            { question: "Narod√≠m se vysok√°, zem≈ôu mal√°. Co jsem?", 
              correct: "Sv√≠ƒçka", 
              options: ["Sv√≠ƒçka", "Hora", "Vlna"] },
            { question: "Co m√° tv√°≈ô, ale nem≈Ø≈æe se usm√≠vat?", 
              correct: "Hodiny", 
              options: ["Hodiny", "Mƒõs√≠c", "Socha"] },
            { question: "ƒå√≠m v√≠c schne≈°, t√≠m v√≠c mokne≈°. Co to je?", 
              correct: "Ruƒçn√≠k", 
              options: ["Ruƒçn√≠k", "M√Ωdlo", "Vana"] },
            { question: "Co m≈Ø≈æe≈° chytit, ale nem≈Ø≈æe≈° hodit?", 
              correct: "Nachlazen√≠", 
              options: ["Nachlazen√≠", "St√≠n", "V√≠tr"] },
            { question: "Co m√° zuby, ale nekou≈°e?", 
              correct: "H≈ôeben", 
              options: ["H≈ôeben", "Kl√≠ƒç", "Z√°mek"] },
            { question: "Co pad√°, ale nikdy se nerozbije? Co se rozbije, ale nikdy nespadne?", 
              correct: "Noc a den", 
              options: ["Noc a den", "Voda a led", "Srdce a du≈°e"] },
            { question: "ƒå√≠m v√≠c z nƒõj bere≈°, t√≠m vƒõt≈°√≠ je. Co to je?",
              correct: "Studna",
              options: ["Studna", "Hora", "Mo≈ôe"] },
            { question: "Co bƒõ≈æ√≠, ale nem√° nohy?",
              correct: "ƒåas",
              options: ["ƒåas", "K√°men", "Hora"] }
        ];
        
        function startRiddleQuest(npcId) {
            // Vyber 3 n√°hodn√© h√°danky
            const shuffled = [...RIDDLES].sort(() => Math.random() - 0.5);
            state.riddleQuest = {
                npcId: npcId,
                riddles: shuffled.slice(0, 3),
                current: 0,
                correct: 0,
                attempts: 0
            };
            
            showRiddle();
        }
        
        function showRiddle() {
            const rq = state.riddleQuest;
            if (!rq || rq.current >= rq.riddles.length) {
                finishRiddleQuest();
                return;
            }
            
            const riddle = rq.riddles[rq.current];
            
            // Zam√≠chej mo≈ænosti odpovƒõd√≠
            const shuffledOptions = [...riddle.options].sort(() => Math.random() - 0.5);
            
            const optionsHtml = shuffledOptions.map(option => `
                <button class="btn" onclick="checkRiddleAnswer('${option}')" 
                    style="width: 100%; margin: 0.3rem 0; padding: 1rem; background: linear-gradient(135deg, #2a1a3a 0%, #1a1a2a 100%); border: 2px solid #9c27b0; font-size: 1rem;">
                    ${option}
                </button>
            `).join('');
            
            showModal('üîÆ H√°danka z√°hadn√© ≈æeny', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üîÆ</div>
                    <p style="color: #888; font-size: 0.85rem;">H√°danka ${rq.current + 1} z 3</p>
                    <p style="color: #8bc34a;">Spr√°vnƒõ: ${rq.correct} | ≈†patnƒõ: ${rq.attempts}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #9c27b0;">
                    <p style="color: #e1bee7; font-style: italic; font-size: 1.1rem; text-align: center;">
                        "${riddle.question}"
                    </p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    ${optionsHtml}
                </div>
                
                <button class="btn" onclick="cancelRiddleQuest()" style="width: 100%; margin-top: 0.5rem; background: #333; font-size: 0.85rem;">
                    üö™ Vzd√°t se
                </button>
            `);
        }
        
        function checkRiddleAnswer(selectedAnswer) {
            const rq = state.riddleQuest;
            if (!rq) return;
            
            const riddle = rq.riddles[rq.current];
            const isCorrect = selectedAnswer === riddle.correct;
            
            if (isCorrect) {
                // Spr√°vn√° odpovƒõƒè
                rq.correct++;
                rq.current++;
                
                showModal('üîÆ Spr√°vnƒõ!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">‚ú®</div>
                        <p style="color: #8bc34a; font-size: 1.2rem;">V√Ωbornƒõ!</p>
                        <p style="color: #888;">"${riddle.correct}" je spr√°vn√° odpovƒõƒè.</p>
                    </div>
                    <button class="btn" onclick="showRiddle()" style="width: 100%; margin-top: 1rem; background: #9c27b0;">
                        ${rq.current >= 3 ? 'üèÜ Dokonƒçit' : '‚û°Ô∏è Dal≈°√≠ h√°danka'}
                    </button>
                `);
                SoundSystem.play('victory');
            } else {
                // ≈†patn√° odpovƒõƒè
                rq.attempts++;
                rq.current++; // Posunout na dal≈°√≠ h√°danku
                
                showModal('üîÆ ≈†patnƒõ!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">‚ùå</div>
                        <p style="color: #f44336; font-size: 1.2rem;">Bohu≈æel ne...</p>
                        <p style="color: #888;">Spr√°vn√° odpovƒõƒè byla: <strong>${riddle.correct}</strong></p>
                    </div>
                    <button class="btn" onclick="showRiddle()" style="width: 100%; margin-top: 1rem; background: #9c27b0;">
                        ${rq.current >= 3 ? 'üèÜ Dokonƒçit' : '‚û°Ô∏è Dal≈°√≠ h√°danka'}
                    </button>
                `);
                SoundSystem.play('damage');
            }
        }
        
        function finishRiddleQuest() {
            const rq = state.riddleQuest;
            if (!rq) return;
            
            const npcId = rq.npcId;
            const success = rq.correct >= 2; // Pot≈ôeba aspo≈à 2 ze 3
            
            if (success) {
                // √öspƒõch - dej odmƒõny
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[npcId].trust = Math.min(100, state.npcRelations[npcId].trust + 25);
                state.npcRelations[npcId].quests++;
                
                // Odhal tajemstv√≠
                state.secrets = state.secrets || [];
                if (!state.secrets.includes('mysterious_prophecy')) {
                    state.secrets.push('mysterious_prophecy');
                }
                
                showModal('üîÆ Quest splnƒõn!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üèÜ</div>
                        <p style="color: #9c27b0; font-size: 1.2rem;">"Tv√° mysl je bystr√°, poutn√≠ƒçe..."</p>
                        <p style="color: #888;">Odpovƒõdƒõl jsi spr√°vnƒõ na ${rq.correct} z 3 h√°danek.</p>
                        
                        <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #9c27b0;">
                            <p style="color: #e1bee7; font-style: italic;">
                                "Poslouchej dob≈ôe... Dva brat≈ôi, Kory a Koudy, hledaj√≠ stejnou vƒõc - Projekt Genesis. 
                                Ale jejich cesty se rozch√°zej√≠. Jeden chce zniƒçit, druh√Ω zachr√°nit. 
                                Ty bude≈° muset vybrat stranu... nebo naj√≠t t≈ôet√≠ cestu."
                            </p>
                        </div>
                        
                        <p style="color: #8bc34a;">‚ù§Ô∏è +25 d≈Øvƒõry</p>
                        <p style="color: #ffd700;">üîì Odemknuto: Proroctv√≠</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem; background: #9c27b0;">
                        Pokraƒçovat
                    </button>
                `);
                SoundSystem.play('victory');
            } else {
                showModal('üîÆ Quest nesplnƒõn', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üòî</div>
                        <p style="color: #f44336;">"Vra≈• se, a≈æ bude tv√° mysl ost≈ôej≈°√≠..."</p>
                        <p style="color: #888;">Odpovƒõdƒõl jsi spr√°vnƒõ jen na ${rq.correct} z 3 h√°danek.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); showNPCDetail('${npcId}')" style="width: 100%; margin-top: 1rem; background: #555;">
                        Odej√≠t
                    </button>
                `);
            }
            
            delete state.riddleQuest;
            saveGame(true);
        }
        
        function cancelRiddleQuest() {
            delete state.riddleQuest;
            closeModal();
        }
        
        function completeNPCQuest(npcId) {
            const npc = FRIENDLY_NPCS.find(n => n.id === npcId);
            const activeQuest = state.npcQuests?.[npcId];
            
            if (!activeQuest) {
                notifyError('≈Ω√°dn√Ω aktivn√≠ quest', 'Nem√°≈° aktivn√≠ quest u tohoto NPC.');
                return;
            }
            
            const quest = NPC_QUESTS[activeQuest.id];
            
            if (!quest) {
                notifyError('Quest nenalezen', 'Quest data nenalezena.');
                return;
            }
            
            if (!checkNPCQuestProgress(activeQuest, quest)) {
                // Zobraz co chyb√≠
                const progress = getNPCQuestProgress(activeQuest, quest);
                notifyError('Quest nesplnƒõn', `${progress.label}: ${progress.current}/${progress.required}`);
                return;
            }
            
            // KONTROLA: Quest je splnƒõn√Ω (nasb√≠ran√© od p≈ôijet√≠)
            // A z√°rove≈à m√° hr√°ƒç dost na odevzd√°n√≠ (aktu√°lnƒõ)
            const start = activeQuest.startState || {};
            
            if (quest.requirement.herbs) {
                // Kontrola 1: nasb√≠ral dost OD p≈ôijet√≠
                const collected = (state.resources?.herbs || 0) - (start.herbs || 0);
                if (collected < quest.requirement.herbs) {
                    notifyError('Quest nesplnƒõn', `Nasb√≠rej je≈°tƒõ ${quest.requirement.herbs - collected} bylin.`);
                    return;
                }
                // Kontrola 2: m√° dost na odevzd√°n√≠
                if ((state.resources.herbs || 0) < quest.requirement.herbs) {
                    notifyError('Nem√°≈° dost bylin!', `Pot≈ôebuje≈° ${quest.requirement.herbs} bylin k odevzd√°n√≠.`);
                    return;
                }
            }
            if (quest.requirement.metal) {
                const collected = (state.resources?.metal || 0) - (start.metal || 0);
                if (collected < quest.requirement.metal) {
                    notifyError('Quest nesplnƒõn', `Nasb√≠rej je≈°tƒõ ${quest.requirement.metal - collected} kovu.`);
                    return;
                }
                if ((state.resources.metal || 0) < quest.requirement.metal) {
                    notifyError('Nem√°≈° dost kovu!', `Pot≈ôebuje≈° ${quest.requirement.metal} kovu k odevzd√°n√≠.`);
                    return;
                }
            }
            if (quest.requirement.resource && quest.requirement.amount) {
                const res = quest.requirement.resource;
                const current = state.resources?.[res] || 0;
                if (current < quest.requirement.amount) {
                    notifyError(`Nem√°≈° dost ${res}!`, `Pot≈ôebuje≈° ${quest.requirement.amount} ${res} k odevzd√°n√≠.`);
                    return;
                }
            }
            if (quest.requirement.money) {
                const earned = (state.money || 0) - (start.money || 0);
                if (earned < quest.requirement.money) {
                    notifyError('Quest nesplnƒõn', `Z√≠skej je≈°tƒõ ${quest.requirement.money - earned} üí∞.`);
                    return;
                }
                if (getMoney() < quest.requirement.money) {
                    notifyError('Nem√°≈° dost penƒõz!', `Pot≈ôebuje≈° ${quest.requirement.money} üí∞ k odevzd√°n√≠.`);
                    return;
                }
            }
            
            // Odeber suroviny
            if (quest.requirement.herbs) {
                state.resources.herbs = Math.max(0, (state.resources.herbs || 0) - quest.requirement.herbs);
            }
            if (quest.requirement.metal) {
                state.resources.metal = Math.max(0, (state.resources.metal || 0) - quest.requirement.metal);
            }
            if (quest.requirement.resource && quest.requirement.amount) {
                const res = quest.requirement.resource;
                state.resources[res] = Math.max(0, (state.resources[res] || 0) - quest.requirement.amount);
            }
            if (quest.requirement.money) {
                removeMoney(quest.requirement.money);
            }
            
            // Dej odmƒõny
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            if (quest.reward.trust) {
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[npcId] = state.npcRelations[npcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[npcId].trust = Math.min(100, (state.npcRelations[npcId].trust || 0) + quest.reward.trust);
                state.npcRelations[npcId].quests++;
            }
            
            // Karma pro Kory/Koudy
            if (quest.reward.karma_kory) {
                state.karma = state.karma || { kory: 0, koudy: 0 };
                state.karma.kory = (state.karma.kory || 0) + quest.reward.karma_kory;
            }
            if (quest.reward.karma_koudy) {
                state.karma = state.karma || { kory: 0, koudy: 0 };
                state.karma.koudy = (state.karma.koudy || 0) + quest.reward.karma_koudy;
            }
            
            // Ulo≈æ quest do seznamu dokonƒçen√Ωch
            const completedQuestId = activeQuest.id;
            if (!state.npcQuests[npcId].completed) {
                state.npcQuests[npcId].completed = [];
            }
            const completedList = state.npcQuests[npcId].completed;
            if (!completedList.includes(completedQuestId)) {
                completedList.push(completedQuestId);
            }
            
            // Sma≈æ aktivn√≠ quest ale zachovej completed list
            state.npcQuests[npcId] = { completed: completedList };
            saveGame(true);
            
            notifySuccess('Quest splnƒõn!', quest.name);
            addLog('Dokonƒçil jsi quest: ' + quest.name, '‚úÖ');
            
            showModal('üéâ Quest splnƒõn!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">üèÜ</div>
                    <h3 style="color: #8bc34a;">${quest.name}</h3>
                    <p>Odmƒõny z√≠sk√°ny!</p>
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        ${quest.reward.money ? `<div>üí∞ +${quest.reward.money} penƒõz</div>` : ''}
                        ${quest.reward.xp ? `<div>‚≠ê +${quest.reward.xp} XP</div>` : ''}
                        ${quest.reward.trust ? `<div>‚ù§Ô∏è +${quest.reward.trust} d≈Øvƒõry s ${npc?.name || 'NPC'}</div>` : ''}
                        ${quest.reward.karma_kory ? `<div style="color: ${quest.reward.karma_kory > 0 ? '#ff5722' : '#4caf50'};">üî• Karma Kory: ${quest.reward.karma_kory > 0 ? '+' : ''}${quest.reward.karma_kory}</div>` : ''}
                        ${quest.reward.karma_koudy ? `<div style="color: ${quest.reward.karma_koudy > 0 ? '#2196f3' : '#ff5722'};">üî¨ Karma Koudy: ${quest.reward.karma_koudy > 0 ? '+' : ''}${quest.reward.karma_koudy}</div>` : ''}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%;">V√Ωbornƒõ!</button>
                </div>
            `);
        }
        
        // Speci√°ln√≠ funkce pro odevzd√°n√≠ deliver questu u c√≠lov√©ho NPC
        function completeDeliverQuest(questGiverNpcId, deliverTargetNpcId) {
            const activeQuest = state.npcQuests?.[questGiverNpcId];
            if (!activeQuest) {
                notifyError('Quest nenalezen', 'Aktivn√≠ quest nebyl nalezen.');
                return;
            }
            
            const quest = NPC_QUESTS[activeQuest.id];
            if (!quest) {
                notifyError('Quest nenalezen', 'Quest data nenalezena.');
                return;
            }
            
            // Kontrola ≈æe m√°me dost surovin
            const start = activeQuest.startState || {};
            if (quest.requirement.resources) {
                const startResources = start.resources || 0;
                const currentResources = Object.values(state.resources || {}).reduce((a, b) => a + b, 0);
                const collected = currentResources - startResources;
                if (collected < quest.requirement.resources) {
                    notifyError('Quest nesplnƒõn', `Nasb√≠rej je≈°tƒõ ${quest.requirement.resources - collected} surovin.`);
                    return;
                }
            }
            
            // Odeber suroviny (celkov√Ω poƒçet - odeƒçteme z r≈Øzn√Ωch typ≈Ø)
            if (quest.requirement.resources) {
                let toRemove = quest.requirement.resources;
                const resourceTypes = ['wood', 'metal', 'cloth', 'leather', 'electronics', 'chemicals', 'herbs'];
                for (const res of resourceTypes) {
                    if (toRemove <= 0) break;
                    const available = state.resources?.[res] || 0;
                    const remove = Math.min(available, toRemove);
                    if (remove > 0) {
                        state.resources[res] = available - remove;
                        toRemove -= remove;
                    }
                }
            }
            
            // Dej odmƒõny
            const questGiverNpc = FRIENDLY_NPCS.find(n => n.id === questGiverNpcId);
            const deliverNpc = FRIENDLY_NPCS.find(n => n.id === deliverTargetNpcId);
            
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            if (quest.reward.trust) {
                // Trust jde zadavateli questu
                state.npcRelations = state.npcRelations || {};
                state.npcRelations[questGiverNpcId] = state.npcRelations[questGiverNpcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[questGiverNpcId].trust = Math.min(100, (state.npcRelations[questGiverNpcId].trust || 0) + quest.reward.trust);
                state.npcRelations[questGiverNpcId].quests++;
                
                // Trochu trustu i p≈ô√≠jemci
                state.npcRelations[deliverTargetNpcId] = state.npcRelations[deliverTargetNpcId] || { trust: 0, gifts: 0, quests: 0 };
                state.npcRelations[deliverTargetNpcId].trust = Math.min(100, (state.npcRelations[deliverTargetNpcId].trust || 0) + 5);
            }
            
            // Ulo≈æ quest do seznamu dokonƒçen√Ωch
            const completedQuestId = activeQuest.id;
            if (!state.npcQuests[questGiverNpcId].completed) {
                state.npcQuests[questGiverNpcId].completed = [];
            }
            const completedList = state.npcQuests[questGiverNpcId].completed;
            if (!completedList.includes(completedQuestId)) {
                completedList.push(completedQuestId);
            }
            
            // Sma≈æ aktivn√≠ quest
            state.npcQuests[questGiverNpcId] = { completed: completedList };
            saveGame(true);
            
            notifySuccess('Z√°soby doruƒçeny!', quest.name);
            addLog('Dokonƒçil jsi quest: ' + quest.name, '‚úÖ');
            
            showModal('üéâ Doruƒçeno!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">üì¶‚úÖ</div>
                    <h3 style="color: #8bc34a;">${quest.name}</h3>
                    <p>Z√°soby √∫spƒõ≈°nƒõ doruƒçeny k ${deliverNpc?.name || 'NPC'}!</p>
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        ${quest.reward.money ? `<div>üí∞ +${quest.reward.money} penƒõz</div>` : ''}
                        ${quest.reward.xp ? `<div>‚≠ê +${quest.reward.xp} XP</div>` : ''}
                        ${quest.reward.trust ? `<div>‚ù§Ô∏è +${quest.reward.trust} d≈Øvƒõry s ${questGiverNpc?.name || 'obchodn√≠kem'}</div>` : ''}
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%;">V√Ωbornƒõ!</button>
                </div>
            `);
        }
        
        function calculateSettlementProduction() {
            let food = 0, water = 0;
            
            // Z√°kladn√≠ produkce osady (mal√°, ale pom√°h√°)
            food += 1; // Z√°kladn√≠ sbƒõr
            water += 2; // Z√°kladn√≠ zdroj vody (potok, d√©≈°≈•)
            
            // Produkce z budov - o≈°et≈ôen√≠ pro undefined
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.production) {
                    // Budovy vy≈æaduj√≠c√≠ elekt≈ôinu funguj√≠ jen s proudem
                    if (building.requiresPower && calculatePowerBalance() < 0) return;
                    if (building.production.food) food += building.production.food;
                    if (building.production.water) water += building.production.water;
                }
            });
            
            // Produkce od osadn√≠k≈Ø - podle √∫rovnƒõ dovednosti
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Z√≠skej efekty z √∫rovnƒõ dovednosti
                const skillType = type.skill;
                const skillData = SETTLER_SKILLS[skillType];
                const settlerLevel = settler.skillLevel || 1;
                const levelData = skillData?.levels[settlerLevel - 1];
                const effect = levelData?.effect || {};
                
                // J√≠dlo (farm√°≈ô, nosiƒç vody s bonusem, lovec)
                if (effect.food) {
                    let bonus = effect.food;
                    // Farmland bonus pro farm√°≈ôe
                    if (type.id === 'farmer' && state.settlement.buildings.includes('farmland')) {
                        bonus += 2;
                    }
                    food += bonus;
                }
                
                // Maso od lovce se poƒç√≠t√° jako j√≠dlo
                if (effect.meat) {
                    food += effect.meat;
                }
                
                // Voda
                if (effect.water) {
                    water += effect.water;
                }
            });
            
            return { food, water };
        }
        
        function calculateSettlementBalance() {
            const prod = calculateSettlementProduction();
            const cons = calculateSettlementConsumption();
            return {
                food: prod.food - cons.food,
                water: prod.water - cons.water
            };
        }
        
        function calculateSettlementConsumption() {
            let food = 0, water = 0;
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Z√≠skej spot≈ôebu podle √∫rovnƒõ dovednosti osadn√≠ka
                const skillType = type.skill;
                const skillData = SETTLER_SKILLS[skillType];
                const settlerLevel = settler.skillLevel || 1;
                const levelData = skillData?.levels[settlerLevel - 1];
                
                // Pou≈æij spot≈ôebu z √∫rovnƒõ dovednosti, nebo z√°kladn√≠ z typu
                if (levelData && levelData.consumption) {
                    food += levelData.consumption.food || 0;
                    water += levelData.consumption.water || 0;
                } else {
                    food += type.consumption?.food || 1;
                    water += type.consumption?.water || 1;
                }
            });
            return {food, water};
        }
        
        function hireSettler(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            if (!type) return;
            
            // Kontrola unik√°tn√≠ch osadn√≠k≈Ø (max 1)
            if (type.unique) {
                const alreadyHas = state.settlement?.settlers?.some(s => s.type === typeId);
                if (alreadyHas) {
                    showModal('‚ùå U≈æ m√°≈° ' + type.name.toLowerCase(), `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">${type.icon}</div>
                            <p>V osadƒõ m≈Ø≈æe b√Ωt pouze <strong>jeden ${type.name.toLowerCase()}</strong>.</p>
                            <p style="color: #888; font-size: 0.85rem; margin-top: 0.5rem;">üí° Tip: M≈Ø≈æe≈° ho vylep≈°it v seznamu osadn√≠k≈Ø.</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
                    `);
                    return;
                }
            }
            
            if (getMoney() < type.cost) {
                showModal(t('notifications', 'notEnoughMoney'), `Pot≈ôebuje≈° ${type.cost} penƒõz!`);
                return;
            }
            
            // Varov√°n√≠ pokud bude z√°porn√° bilance vody/j√≠dla
            const currentBalance = calculateSettlementBalance();
            const newFoodBalance = currentBalance.food - (type.consumption?.food || 1);
            const newWaterBalance = currentBalance.water - (type.consumption?.water || 1);
            
            if (newFoodBalance < -5 || newWaterBalance < -5) {
                const warnings = [];
                if (newFoodBalance < -5) warnings.push(`üçñ J√≠dlo: ${newFoodBalance}/den`);
                if (newWaterBalance < -5) warnings.push(`üíß Voda: ${newWaterBalance}/den`);
                
                showModal('‚ö†Ô∏è Varov√°n√≠ - nedostatek zdroj≈Ø!', `
                    <p>Naj√≠m√°n√≠m dal≈°√≠ho osadn√≠ka bude≈° m√≠t <strong>kritick√Ω nedostatek</strong>:</p>
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; color: #c62828; font-weight: bold;">
                        ${warnings.join('<br>')}
                    </div>
                    <p style="color: #888; font-size: 0.9rem;">üí° Tip: Postav studnu (+6 vody) nebo najmi nosiƒçe vody (+2 vody, spot≈ôeba 0)</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                        <button class="btn" onclick="closeModal(); forceHireSettler('${typeId}')" style="background: #c62828;">‚ö†Ô∏è Najmout p≈ôesto</button>
                    </div>
                `);
                return;
            }
            
            forceHireSettler(typeId);
        }
        
        function forceHireSettler(typeId) {
            const type = SETTLER_TYPES.find(t => t.id === typeId);
            if (!type) return;
            
            // Kontrola unik√°tn√≠ch osadn√≠k≈Ø (max 1)
            if (type.unique) {
                const alreadyHas = state.settlement?.settlers?.some(s => s.type === typeId);
                if (alreadyHas) return;
            }
            
            if (getMoney() < type.cost) return;
            
            removeMoney(type.cost);
            
            // Generate random name
            const names = ['Jan', 'Marie', 'Petr', 'Anna', 'Karel', 'Eva', 'Tom√°≈°', 'Lenka', 'Pavel', 'Hana', 'Jakub', 'Tereza', 'Martin', 'Lucie', 'David', 'Kate≈ôina'];
            const randomName = names[Math.floor(Math.random() * names.length)];
            
            state.settlement.settlers.push({
                type: typeId,
                name: randomName,
                hiredAt: Date.now(),
                skillLevel: 1,
                xp: 0
            });
            
            state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 5);
            
            SoundSystem.play('pickup');
            showModal('‚úÖ Najmut!', 
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${type.icon}</div>` +
                `<h3>${randomName}</h3>` +
                `<p>${type.name} byl p≈ôid√°n do tv√© osady!</p>` +
                `<p style="color: #8bc34a;">+5 prosperity</p>` +
                `</div>`
            );
            addLog(`Najal jsi ${type.name}: ${randomName}`, 'üë•');
            checkAchievements();
            renderFull();
        }
        
        function fireSettler(index) {
            const settler = state.settlement.settlers[index];
            if (!settler) return;
            
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            
            showModal('Propustit obyvatele?',
                `<p>Opravdu chce≈° propustit ${settler.name} (${type.name})?</p>` +
                `<p style="color: #ff9800;">Nedostane≈° ≈æ√°dn√© pen√≠ze zpƒõt.</p>` +
                `<div style="display: flex; gap: 1rem; margin-top: 1rem;">` +
                `<button class="btn" onclick="confirmFireSettler(${index}); closeModal();" style="flex: 1; background: #c62828;">‚úì Propustit</button>` +
                `<button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">‚úó Zru≈°it</button>` +
                `</div>`
            );
        }
        
        function confirmFireSettler(index) {
            const settler = state.settlement.settlers[index];
            state.settlement.settlers.splice(index, 1);
            state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 3);
            addLog(`Propustil jsi ${settler.name}`, 'üëã');
            renderFull();
        }
        
        function buildUnifiedBuilding(buildingId) {
            console.log('üî® buildUnifiedBuilding CALLED with:', buildingId);
            
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) {
                console.log('üî® ERROR: Building not found:', buildingId);
                return;
            }
            console.log('üî® Building found:', building.name);
            
            // Ensure settlers array exists
            if (!state.settlement) state.settlement = {};
            if (!state.settlement.settlers) state.settlement.settlers = [];
            if (!state.settlement.buildings) state.settlement.buildings = [];
            
            // Kontrola stavitele
            const hasBuilder = state.settlement.settlers.some(s => s.type === 'builder');
            
            console.log('üî® hasBuilder:', hasBuilder, 'settlers:', state.settlement.settlers.map(s => ({type: s.type, name: s.name})));
            
            // Mus√≠≈° b√Ωt v osadƒõ/shelter NEBO m√≠t stavitele
            const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
            console.log('üî® inBase:', inBase, 'currentLocation:', state.world.currentLocation);
            
            if (!inBase && !hasBuilder) {
                console.log('üî® BLOCKED: Not in base and no builder');
                showModal('‚ùå Nelze stavƒõt', 'Mus√≠≈° b√Ωt v osadƒõ nebo m√≠t Stavitele v osadƒõ!');
                return;
            }
            
            // Check if already built or being built
            if (state.base.includes(buildingId) || state.settlement.buildings.includes(buildingId)) {
                console.log('üî® BLOCKED: Already built');
                showModal('Ji≈æ postaveno', 'Tuto budovu u≈æ m√°≈°!');
                return;
            }
            
            // Check if already in build queue
            if (state.buildQueue && state.buildQueue.some(b => b.id === buildingId)) {
                console.log('üî® BLOCKED: Already in queue');
                showModal('Ji≈æ se stav√≠', 'Tato budova se ji≈æ stav√≠!');
                return;
            }
            
            // Check level requirement
            if (building.level > state.settlement.level) {
                console.log('üî® BLOCKED: Level too low', building.level, '>', state.settlement.level);
                showModal('N√≠zk√Ω level', `${'Pot≈ôebuje≈° level'} ${building.level}!`);
                return;
            }
            
            console.log('üî® All checks passed, checking power...');
            
            // *** KONTROLA ELEKT≈òINY ***
            // Pokud budova pot≈ôebuje elekt≈ôinu, zkontroluj jestli bude≈° m√≠t dost
            if (building.requiresPower) {
                const currentBalance = calculatePowerBalance();
                const futureBalance = currentBalance - building.requiresPower;
                console.log('üî® Power check:', currentBalance, '->', futureBalance);
                
                if (futureBalance < 0) {
                    console.log('üî® Showing power warning modal');
                    // Zobraz varov√°n√≠ a zeptej se jestli chce pokraƒçovat
                    showModal('‚ö° Nedostatek elekt≈ôiny!', `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è‚ö°</div>
                            <p style="color: #ff9800; font-weight: bold;">Tato budova pot≈ôebuje ${building.requiresPower} ‚ö°</p>
                            <p style="color: #888;">Aktu√°ln√≠ bilance: ${currentBalance >= 0 ? '+' : ''}${currentBalance} ‚ö°</p>
                            <p style="color: #c62828;">Po stavbƒõ: ${futureBalance} ‚ö°</p>
                            
                            <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #c62828;">
                                <p style="color: #ff6b6b; margin: 0; font-size: 0.9rem;">‚ö†Ô∏è Budova nebude fungovat dokud nepostav√≠≈° gener√°tor!</p>
                            </div>
                            
                            <p style="color: #888; font-size: 0.85rem;">Tip: Nejd≈ô√≠v postav Sol√°rn√≠ panely üîÜ nebo Gener√°tor ‚öôÔ∏è</p>
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">‚Üê Zru≈°it</button>
                                <button class="btn" onclick="closeModal(); confirmBuildWithoutPower('${buildingId}')" style="flex: 1; background: #ff9800;">‚ö° Postavit p≈ôesto</button>
                            </div>
                        </div>
                    `);
                    return;
                }
            }
            
            console.log('üî® Calling proceedWithBuild...');
            // Pokraƒçuj se stavbou
            proceedWithBuild(buildingId);
        }
        
        function confirmBuildWithoutPower(buildingId) {
            proceedWithBuild(buildingId);
        }
        
        function proceedWithBuild(buildingId) {
            console.log('üî® proceedWithBuild CALLED with:', buildingId);
            
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) {
                console.log('üî® proceedWithBuild ERROR: Building not found');
                return;
            }
            
            // Kontrola stavitele
            const hasBuilder = state.settlement.settlers.some(s => s.type === 'builder');
            
            // Kontrola jestli je hr√°ƒç v osadƒõ
            const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
            
            console.log('üî® proceedWithBuild - hasBuilder:', hasBuilder, 'inBase:', inBase);
            
            // Check resources - kombinuj sklad osady + invent√°≈ô hr√°ƒçe (pouze pokud je v osadƒõ!)
            const settlementRes = state.settlement.resources || {};
            
            console.log('üî® Checking resources. Building cost:', building.cost);
            console.log('üî® Settlement resources:', settlementRes);
            console.log('üî® Player resources:', state.resources);
            
            for (const [res, amt] of Object.entries(building.cost)) {
                const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                const settlementHas = settlementRes[res] || 0;
                // Invent√°≈ô hr√°ƒçe se poƒç√≠t√° POUZE pokud je v osadƒõ
                const playerHas = inBase ? (state.resources[res] || 0) : 0;
                const totalHas = settlementHas + playerHas;
                
                console.log(`üî® Resource ${res}: need ${cost}, settlement has ${settlementHas}, player has ${playerHas}, total ${totalHas}`);
                
                if (totalHas < cost) {
                    console.log('üî® BLOCKED: Not enough', res);
                    if (!inBase && hasBuilder) {
                        showModal('‚ùå Nedostatek surovin', `<p>Stav√≠≈° na d√°lku - suroviny se berou pouze ze <strong>skladu osady</strong>!</p><p>Pot≈ôebuje≈° ${cost}x ${res}, v osadƒõ m√°≈° ${settlementHas}.</p><p style="color: #888; font-size: 0.85rem;">Tip: Vra≈• se do osady a ulo≈æ suroviny do skladu.</p>`);
                    } else {
                        showModal(t('notifications', 'notEnoughResources'), `${'Nem√°≈° dost materi√°l≈Ø! Pot≈ôebuje≈°'} ${cost}x ${res}, ${'m√°≈°'} ${totalHas}.`);
                    }
                    return;
                }
            }
            
            console.log('üî® All resources OK, consuming...');
            
            // Consume resources - preferuj SKLAD OSADY, pak invent√°≈ô hr√°ƒçe (pouze pokud je v osadƒõ!)
            for (const [res, amt] of Object.entries(building.cost)) {
                const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                let remaining = cost;
                
                // Nejd≈ô√≠v odeber ze SKLADU OSADY
                const fromSettlement = Math.min(settlementRes[res] || 0, remaining);
                if (fromSettlement > 0) {
                    settlementRes[res] = (settlementRes[res] || 0) - fromSettlement;
                    remaining -= fromSettlement;
                }
                
                // Zbytek z invent√°≈ôe hr√°ƒçe - POUZE pokud je v osadƒõ!
                if (remaining > 0 && inBase && state.resources[res]) {
                    state.resources[res] = (state.resources[res] || 0) - remaining;
                }
            }
            
            // Calculate build time (in minutes)
            // Base time: 10-120 minutes based on building cost
            const totalCost = Object.values(building.cost).reduce((a, b) => a + b, 0);
            let buildTime = Math.max(10, Math.min(120, totalCost * 1.0)); // 10-120 minut
            
            // Builder settler reduces time by 50%
            if (hasBuilder) {
                buildTime = Math.ceil(buildTime * 0.5);
            }
            
            // Add to build queue
            if (!state.buildQueue) state.buildQueue = [];
            state.buildQueue.push({
                id: buildingId,
                name: building.name,
                icon: building.icon,
                category: building.category,
                startTime: Date.now(),
                duration: buildTime * 60 * 1000, // Convert to milliseconds
                effect: building.effect
            });
            
            SoundSystem.play('pickup');
            addLog(`üî® Zaƒçala stavba: ${building.name}`, 'üèóÔ∏è');
            showModal('üî® Stavba zah√°jena!',
                `<div style="text-align: center;">` +
                `<div style="font-size: 3rem;">${building.icon}</div>` +
                `<h3>${building.name}</h3>` +
                `<p style="color: #ff9800;">‚è±Ô∏è ${'Doba stavby'}: ${buildTime} ${'min'}</p>` +
                `<p style="color: #888; font-size: 0.85rem;">${'Budova bude automaticky dokonƒçena'}</p>` +
                `</div>`
            );
            renderFull();
        }
        
        // Process build queue - called in game loop
        function processBuildQueue() {
            if (!state.buildQueue || state.buildQueue.length === 0) return;
            
            const now = Date.now();
            const completed = [];
            
            state.buildQueue = state.buildQueue.filter(build => {
                const elapsed = now - build.startTime;
                if (elapsed >= build.duration) {
                    // Building complete!
                    completed.push(build);
                    return false;
                }
                return true;
            });
            
            // Process completed buildings
            completed.forEach(build => {
                const building = BUILDINGS.find(b => b.id === build.id);
                
                // Add to appropriate array
                if (build.category === 'settlement') {
                    state.settlement.buildings.push(build.id);
                    state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 25);
                } else {
                    state.base.push(build.id);
                    state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 5);
                }
                
                // Apply effects
                if (build.effect && build.effect.baseCapacity) {
                    state.baseCapacity += build.effect.baseCapacity;
                }
                
                state.stats.itemsCrafted++;
                checkSettlementLevelUp();
                checkAchievements();
                
                SoundSystem.play('success');
                notifyBuild(build.name, build.icon);
                addLog(`‚úÖ Stavba dokonƒçena: ${build.name}`, 'üèóÔ∏è');
                
                // Show completion modal if player is in base AND NOT IN COMBAT
                if ((state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement') && !isInCombat()) {
                    const prosBonus = build.category === 'settlement' ? 25 : 5;
                    showModal('‚úÖ Stavba dokonƒçena!',
                        `<div style="text-align: center;">` +
                        `<div style="font-size: 3rem;">${build.icon}</div>` +
                        `<h3>${build.name}</h3>` +
                        `<p style="color: #8bc34a;">+${prosBonus} prosperity</p>` +
                        `</div>`
                    );
                }
            });
            
            if (completed.length > 0) {
                renderFull();
            }
        }
        
        function buildSettlementBuilding(buildingId) {
            // Redirectuji na unifikovanou funkci pro konzistenci
            buildUnifiedBuilding(buildingId);
        }
        
        function demolishBuilding(buildingId) {
            // Najdi budovu - hledej v BUILDINGS (obsahuje v≈°echny)
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) {
                notifyWarning('Budova nenalezena!');
                return;
            }
            
            // Zkontroluj jestli je budova postaven√° (v base nebo settlement)
            const inBase = state.base.indexOf(buildingId);
            const inSettlement = state.settlement.buildings.indexOf(buildingId);
            
            if (inBase === -1 && inSettlement === -1) {
                notifyWarning('Tato budova nen√≠ postaven√°!');
                return;
            }
            
            // Potvrzen√≠
            const refundText = building.cost ? Object.entries(building.cost).map(([k, v]) => {
                const icons = {wood: 'ü™µ', metal: 'üî©', stone: 'üóø', cloth: 'üßµ', electronics: 'üîå', glass: 'üîÆ'};
                return `${icons[k] || 'üì¶'} ${Math.floor(v * 0.5)} ${k}`;
            }).join(', ') : 'nic';
            
            showModal('üèóÔ∏è Zbourat budovu?', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${building.icon}</div>
                    <h3 style="color: #f44336; margin-bottom: 0.5rem;">${building.name}</h3>
                    <p style="color: #888;">Opravdu chce≈° zbourat tuto budovu?</p>
                    <p style="color: #888; font-size: 0.85rem;">Tato akce je nevratn√°!</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #4caf50;">
                        <p style="color: #4caf50; margin: 0;">‚ôªÔ∏è Vr√°cen√© suroviny (50%):</p>
                        <p style="color: #8bc34a; margin: 0.3rem 0 0 0;">${refundText}</p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">‚Üê Zru≈°it</button>
                        <button class="btn" onclick="confirmDemolish('${buildingId}')" style="flex: 1; background: #c62828;">üèóÔ∏è Zbourat</button>
                    </div>
                </div>
            `);
        }
        
        function confirmDemolish(buildingId) {
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) return;
            
            // Zkontroluj kde je budova
            const inBaseIndex = state.base.indexOf(buildingId);
            const inSettlementIndex = state.settlement.buildings.indexOf(buildingId);
            
            if (inBaseIndex === -1 && inSettlementIndex === -1) return;
            
            // Zapamatuj si stav elekt≈ôiny P≈òED zbour√°n√≠m
            const powerBefore = calculatePowerBalance();
            const hadPowerBefore = powerBefore >= 0;
            
            // Odeber budovu z p≈ô√≠slu≈°n√©ho seznamu
            if (inBaseIndex !== -1) {
                state.base.splice(inBaseIndex, 1);
            }
            if (inSettlementIndex !== -1) {
                state.settlement.buildings.splice(inSettlementIndex, 1);
            }
            
            // Vra≈• 50% surovin
            if (building.cost) {
                Object.entries(building.cost).forEach(([resource, amount]) => {
                    const refund = Math.floor(amount * 0.5);
                    if (state.settlement.resources[resource] !== undefined) {
                        state.settlement.resources[resource] += refund;
                    } else if (state.resources[resource] !== undefined) {
                        state.resources[resource] += refund;
                    }
                });
            }
            
            // Sni≈æ prosperitu
            state.settlement.prosperity = Math.max(0, (state.settlement.prosperity || 0) - 5);
            
            SoundSystem.play('sell');
            notifySuccess('Budova zbour√°na!', `${building.icon} ${building.name} byl/a odstranƒõna.`);
            addLog(`Zbour√°na budova: ${building.name}`, 'üèóÔ∏è');
            
            // Zkontroluj jestli se obnovila elekt≈ôina
            const powerAfter = calculatePowerBalance();
            const hasPowerAfter = powerAfter >= 0;
            
            if (!hadPowerBefore && hasPowerAfter) {
                // Elekt≈ôina se obnovila! Zjisti kter√© budovy teƒè funguj√≠
                const restoredBuildings = [];
                const allBuildings = [...state.base, ...state.settlement.buildings];
                allBuildings.forEach(bId => {
                    const b = BUILDINGS.find(x => x.id === bId);
                    if (b && b.requiresPower) {
                        restoredBuildings.push(b);
                    }
                });
                
                if (restoredBuildings.length > 0) {
                    const names = restoredBuildings.map(b => `${b.icon} ${b.name}`).join(', ');
                    setTimeout(() => {
                        notifySuccess('‚ö° Elekt≈ôina obnovena!', `Tyto budovy nyn√≠ funguj√≠: ${names}`);
                        addLog(`‚ö° Elekt≈ôina obnovena! Funguje: ${restoredBuildings.map(b => b.name).join(', ')}`, '‚ö°');
                    }, 500);
                }
            }
            
            closeModal();
            saveGame(true);
            renderFull();
        }
        
        function checkSettlementLevelUp() {
            if (state.settlement.prosperity >= 100 && state.settlement.level < 5) {
                forceSettlementLevelUp();
            }
        }
        
        function forceSettlementLevelUp() {
            if (state.settlement.level >= 5) {
                notifyWarning('Maximum!', 'Osada je ji≈æ na maxim√°ln√≠m levelu.');
                return;
            }
            if (state.settlement.prosperity < 100) {
                notifyWarning('Nedostatek!', 'Pot≈ôebuje≈° 100 prosperity.');
                return;
            }
            
            state.settlement.level++;
            state.settlement.prosperity = 0;
            
            SoundSystem.play('levelup');
            const greatText = 'Skvƒõl√©!';
            showModal('üéâ LEVEL UP OSADY!',
                `<div style="text-align: center;">` +
                `<div style="font-size: 4rem;">üèòÔ∏è</div>` +
                `<h2 style="color: #ffd700;">Level ${state.settlement.level}</h2>` +
                `<p style="color: #8bc34a; font-size: 1.2rem;">${'Tvoje osada roste!'}</p>` +
                `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                `<p>‚úÖ ${'√örove≈à osady'}: ${state.settlement.level}</p>` +
                `<p>‚úÖ ${'Nov√© budovy odemƒçeny!'}</p>` +
                `</div>` +
                `<button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; background: #8bc34a;">‚úì ${greatText}</button>` +
                `</div>`
            );
            addLog(`Osada dos√°hla level ${state.settlement.level}!`, 'üéâ');
            renderFull();
        }
        
        // Sbƒõraƒçi a lovci sb√≠raj√≠ ka≈ædou hodinu re√°ln√©ho ƒçasu
        function updateScavengerProduction() {
            if (!state.settlement || !state.settlement.settlers) return;
            
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Lovec lov√≠ ka≈ædou hodinu (mal√© mno≈æstv√≠)
                if (type.production && type.production.meat) {
                    if (Math.random() < 0.3) { // 30% ≈°ance za hodinu
                        let meat = 1;
                        if (settler.skill > 1) meat += Math.floor(settler.skill / 5);
                        state.settlement.resources.food = (state.settlement.resources.food || 0) + meat;
                        
                        if (Math.random() < 0.05 && settler.skill < 10) {
                            settler.skill = (settler.skill || 1) + 1;
                        }
                    }
                }
                
                // SBƒöRAƒå - sb√≠r√° suroviny ka≈æd√Ωch 6 hodin
                if (type.id === 'scavenger_s') {
                    const skillLevel = settler.skillLevel || 1;
                    const SETTLER_SKILLS_DATA = {
                        1: { min: 2, max: 4 },
                        2: { min: 3, max: 5 },
                        3: { min: 4, max: 7 },
                        4: { min: 5, max: 9 },
                        5: { min: 7, max: 12 }
                    };
                    const skillData = SETTLER_SKILLS_DATA[skillLevel] || SETTLER_SKILLS_DATA[1];
                    const amount = Math.floor(Math.random() * (skillData.max - skillData.min + 1)) + skillData.min;
                    const resources = ['wood', 'metal', 'stone', 'cloth', 'leather'];
                    
                    const gathered = {};
                    for (let i = 0; i < amount; i++) {
                        const res = resources[Math.floor(Math.random() * resources.length)];
                        state.settlement.resources[res] = (state.settlement.resources[res] || 0) + 1;
                        gathered[res] = (gathered[res] || 0) + 1;
                    }
                    
                    // ≈†ance na vz√°cnou surovinu (vy≈°≈°√≠ √∫rovnƒõ)
                    if (skillLevel >= 3 && Math.random() < 0.2) {
                        const rareRes = ['chemicals', 'electronics', 'glass'][Math.floor(Math.random() * 3)];
                        state.settlement.resources[rareRes] = (state.settlement.resources[rareRes] || 0) + 1;
                        gathered[rareRes] = (gathered[rareRes] || 0) + 1;
                    }
                    
                    const gatheredText = Object.entries(gathered).map(([k,v]) => `${v}x ${k}`).join(', ');
                    addLog(`üéí ${settler.name} nasb√≠ral: ${gatheredText}`, 'üéí');
                    notifySuccess(`üéí ${settler.name}`, `Nasb√≠ral: ${gatheredText}`);
                }
            });
        }
        
        // === SYST√âM KAZEN√ç J√çDLA ===
        // Syrov√© j√≠dlo se kaz√≠ po urƒçit√©m poƒçtu dn√≠
        const PERISHABLE_FOOD = {
            'raw_meat': { days: 2, name: 'Syrov√© maso', icon: 'ü•©' },
            'fish': { days: 2, name: 'Ryba', icon: 'üêü' },
            'small_fish': { days: 2, name: 'Mal√° ryba', icon: 'üêü' },
            'medium_fish': { days: 2, name: 'Kapr', icon: 'üê†' },
            'big_fish': { days: 2, name: 'Sumec', icon: 'üê°' },
            'berries': { days: 3, name: 'Bor≈Øvky', icon: 'ü´ê' },
            'herbs': { days: 5, name: 'Byliny', icon: 'üåø' }
        };
        
        function checkFoodSpoilage() {
            if (!state.confirmed) return;
            
            // Inicializace food timestamps
            if (!state.foodTimestamps) state.foodTimestamps = {};
            
            // Kryogenn√≠ sklad v osadƒõ zabra≈àuje kazen√≠
            const hasCryoStorage = state.settlement?.buildings?.includes('cryo_storage') || state.base?.includes('cryo_storage');
            if (hasCryoStorage) return;
            
            let spoiledItems = [];
            const currentDay = state.time.days;
            
            // Kontrola resources (raw_meat, fish, herbs, berries)
            Object.keys(PERISHABLE_FOOD).forEach(itemId => {
                const perishInfo = PERISHABLE_FOOD[itemId];
                const amount = state.resources[itemId] || 0;
                
                if (amount > 0) {
                    // Nastav timestamp pokud neexistuje
                    if (!state.foodTimestamps[itemId]) {
                        state.foodTimestamps[itemId] = currentDay;
                    }
                    
                    const daysSinceObtained = currentDay - state.foodTimestamps[itemId];
                    
                    if (daysSinceObtained >= perishInfo.days) {
                        // J√≠dlo se zkazilo!
                        const spoiledAmount = Math.min(amount, Math.ceil(amount * 0.5)); // Zkaz√≠ se polovina
                        state.resources[itemId] = Math.max(0, amount - spoiledAmount);
                        
                        if (spoiledAmount > 0) {
                            spoiledItems.push(`${perishInfo.icon} ${spoiledAmount}x ${perishInfo.name}`);
                        }
                        
                        // Reset timestamp pro zb√Ωvaj√≠c√≠ j√≠dlo
                        if (state.resources[itemId] > 0) {
                            state.foodTimestamps[itemId] = currentDay;
                        } else {
                            delete state.foodTimestamps[itemId];
                        }
                    }
                } else {
                    // Nem√°me tento resource - vyma≈æ timestamp
                    delete state.foodTimestamps[itemId];
                }
            });
            
            // Kontrola invent√°≈ôe - ryby a maso
            state.inv = state.inv.filter(item => {
                if (PERISHABLE_FOOD[item.id]) {
                    const perishInfo = PERISHABLE_FOOD[item.id];
                    
                    // Nastav timestamp pokud neexistuje
                    if (!item.obtainedDay) {
                        item.obtainedDay = currentDay;
                    }
                    
                    const daysSinceObtained = currentDay - item.obtainedDay;
                    
                    if (daysSinceObtained >= perishInfo.days) {
                        spoiledItems.push(`${perishInfo.icon} ${item.count || 1}x ${perishInfo.name}`);
                        return false; // Odstranit z invent√°≈ôe
                    }
                }
                return true;
            });
            
            // Notifikace pokud se nƒõco zkazilo
            if (spoiledItems.length > 0) {
                notifyWarning('ü¶† J√≠dlo se zkazilo!', spoiledItems.join(', '));
                addLog('Shnilo: ' + spoiledItems.join(', '), 'ü¶†');
            }
        }
        
        // P≈ôi z√≠sk√°n√≠ syrov√©ho j√≠dla nastav/aktualizuj timestamp
        function markFoodAsNew(itemId, addedAmount = 1) {
            if (PERISHABLE_FOOD[itemId]) {
                if (!state.foodTimestamps) state.foodTimestamps = {};
                
                const currentAmount = state.resources?.[itemId] || 0;
                const currentDay = state.time.days;
                
                if (!state.foodTimestamps[itemId] || currentAmount === 0) {
                    // Prvn√≠ kus nebo pr√°zdn√© - nastav na dne≈°ek
                    state.foodTimestamps[itemId] = currentDay;
                } else {
                    // U≈æ m√°me nƒõjak√© - spoƒç√≠tej v√°≈æen√Ω pr≈Ømƒõr ƒçerstvosti
                    const oldTimestamp = state.foodTimestamps[itemId];
                    const oldAmount = Math.max(1, currentAmount - addedAmount); // Kolik jsme mƒõli p≈ôed p≈ôid√°n√≠m
                    
                    // V√°≈æen√Ω pr≈Ømƒõr: (star√© * star√©_mno≈æstv√≠ + nov√© * nov√©_mno≈æstv√≠) / celkem
                    const weightedTimestamp = Math.round(
                        (oldTimestamp * oldAmount + currentDay * addedAmount) / (oldAmount + addedAmount)
                    );
                    
                    state.foodTimestamps[itemId] = weightedTimestamp;
                }
            }
        }
        
        function updateSettlementDaily() {
            if (!state.settlement) return;
            
            console.log('üìÖ updateSettlementDaily() called! Day:', state.time.days);
            console.log('üìÖ Settlers:', state.settlement.settlers?.map(s => `${s.name} (${s.type})`));
            
            // Process finances first (income and maintenance)
            processSettlementFinances();
            
            // Initialize morale if missing
            if (state.settlement.morale === undefined) state.settlement.morale = 50;
            
            // Migrace - p≈ôidej chybƒõj√≠c√≠ suroviny do skladu
            const allRes = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 
                           'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'copper', 
                           'silver', 'gold', 'crystal', 'gems', 'food', 'water', 'fuel'];
            allRes.forEach(r => {
                if (state.settlement.resources[r] === undefined) state.settlement.resources[r] = 0;
            });
            
            // Initialize production report
            const prodReport = { food: 0, water: 0, resources: {}, items: [] };
            
            // Calculate production
            let foodProd = 0, waterProd = 0;
            
            // Z√°kladn√≠ produkce osady (mal√°, ale pom√°h√°)
            foodProd += 1; // Z√°kladn√≠ sbƒõr
            waterProd += 2; // Z√°kladn√≠ zdroj vody (potok, d√©≈°≈•)
            prodReport.food += 1;
            prodReport.water += 2;
            
            // Base production from buildings - v≈°e jde do skladu osady
            BUILDINGS.forEach(b => {
                if (state.base.includes(b.id) || state.settlement.buildings.includes(b.id)) {
                    if (b.production) {
                        if (b.production.food) {
                            foodProd += b.production.food;
                            prodReport.food += b.production.food;
                        }
                        if (b.production.water) {
                            waterProd += b.production.water;
                            prodReport.water += b.production.water;
                        }
                        // Produkce surovin z budov - do skladu osady
                        if (b.production.wood) {
                            state.settlement.resources.wood += b.production.wood;
                            prodReport.resources.wood = (prodReport.resources.wood || 0) + b.production.wood;
                        }
                        if (b.production.metal) {
                            state.settlement.resources.metal += b.production.metal;
                            prodReport.resources.metal = (prodReport.resources.metal || 0) + b.production.metal;
                        }
                        if (b.production.stone) {
                            state.settlement.resources.stone += b.production.stone;
                            prodReport.resources.stone = (prodReport.resources.stone || 0) + b.production.stone;
                        }
                        if (b.production.cloth) {
                            state.settlement.resources.cloth += b.production.cloth;
                            prodReport.resources.cloth = (prodReport.resources.cloth || 0) + b.production.cloth;
                        }
                    }
                }
            });
            
            // Past na zvƒõ≈ô bonus - +2 j√≠dlo/den za ka≈ædou past v invent√°≈ôi (max 2 pasti)
            const traps = state.inv?.filter(i => i.bonus === 'food') || [];
            if (traps.length > 0) {
                const effectiveTraps = Math.min(traps.length, 2); // Max 2 pasti
                const trapFood = effectiveTraps * 2;
                foodProd += trapFood;
                prodReport.food += trapFood;
                prodReport.items.push({ name: 'üï∏Ô∏è Pasti na zvƒõ≈ô', value: '+' + trapFood + ' j√≠dla' + (traps.length > 2 ? ' (max 2)' : '') });
            }
            
            // Settler production - v≈°e do skladu osady, podle √∫rovnƒõ dovednosti
            state.settlement.settlers.forEach(settler => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                if (!type) return;
                
                // Z√≠skej efekty z √∫rovnƒõ dovednosti
                const skillType = type.skill;
                const skillData = SETTLER_SKILLS[skillType];
                const settlerLevel = settler.skillLevel || 1;
                const levelData = skillData?.levels[settlerLevel - 1];
                const effect = levelData?.effect || {};
                
                // Produkce j√≠dla (farm√°≈ô)
                if (effect.food) {
                    let food = effect.food;
                    if (state.settlement.buildings.includes('farmland')) food += 2;
                    if (state.settlement.specialization === 'farming') food = Math.floor(food * 1.5);
                    foodProd += food;
                    prodReport.food += food;
                }
                
                // Produkce vody (nosiƒç vody)
                if (effect.water) {
                    waterProd += effect.water;
                    prodReport.water += effect.water;
                }
                
                // Produkce masa (lovec) - poƒç√≠t√° se jako j√≠dlo
                if (effect.meat) {
                    foodProd += effect.meat;
                    prodReport.food += effect.meat;
                    
                    // Lovec tak√© produkuje k≈Ø≈æi podle √∫rovnƒõ
                    if (effect.leather) {
                        state.settlement.resources.leather = (state.settlement.resources.leather || 0) + effect.leather;
                        prodReport.resources.leather = (prodReport.resources.leather || 0) + effect.leather;
                    }
                }
                
                // Sbƒõraƒç - denn√≠ sbƒõr surovin DO SKLADU OSADY podle √∫rovnƒõ
                if (type.id === 'scavenger_s') {
                    const minRes = effect.minRes || 2;
                    const maxRes = effect.maxRes || 4;
                    const amount = Math.floor(Math.random() * (maxRes - minRes + 1)) + minRes;
                    const resources = ['wood', 'metal', 'stone', 'cloth', 'leather'];
                    
                    console.log(`üéí Sbƒõraƒç ${settler.name} sb√≠r√° ${amount} surovin...`);
                    
                    // Inicializuj historii sbƒõru pro tohoto sbƒõraƒçe
                    if (!settler.gatherHistory) settler.gatherHistory = [];
                    const todayGather = { day: state.world.day, items: [], resources: {} };
                    
                    for (let i = 0; i < amount; i++) {
                        const res = resources[Math.floor(Math.random() * resources.length)];
                        state.settlement.resources[res] = (state.settlement.resources[res] || 0) + 1;
                        prodReport.resources[res] = (prodReport.resources[res] || 0) + 1;
                        todayGather.resources[res] = (todayGather.resources[res] || 0) + 1;
                    }
                    
                    console.log('üéí Sbƒõraƒç nasb√≠ral:', todayGather.resources);
                    addLog(`üéí ${settler.name} nasb√≠ral: ${Object.entries(todayGather.resources).map(([k,v]) => `${v}x ${k}`).join(', ')}`, 'üéí');
                    
                    for (let i = 0; i < amount; i++) {
                        const res = resources[Math.floor(Math.random() * resources.length)];
                        state.settlement.resources[res] = (state.settlement.resources[res] || 0) + 1;
                        prodReport.resources[res] = (prodReport.resources[res] || 0) + 1;
                        todayGather.resources[res] = (todayGather.resources[res] || 0) + 1;
                    }
                    
                    // ≈†ance na vz√°cnou surovinu podle √∫rovnƒõ
                    const rareChance = effect.rareChance || 0.1;
                    if (Math.random() < rareChance) {
                        const rareRes = effect.electronics ? 'electronics' : ['chemicals', 'glass', 'scrap'][Math.floor(Math.random() * 3)];
                        state.settlement.resources[rareRes] = (state.settlement.resources[rareRes] || 0) + 1;
                        prodReport.resources[rareRes] = (prodReport.resources[rareRes] || 0) + 1;
                        todayGather.resources[rareRes] = (todayGather.resources[rareRes] || 0) + 1;
                        addLog(`üéí ${settler.name} na≈°el vz√°cnou surovinu: ${rareRes}!`, '‚ú®');
                    }
                    
                    // ≈†ance na p≈ôedmƒõt na √∫rovni 5
                    if (effect.itemChance && Math.random() < effect.itemChance) {
                        // Vybrat n√°hodn√Ω vz√°cn√Ω p≈ôedmƒõt
                        const rareItems = ITEMS.filter(i => (i.rarity === 'uncommon' || i.rarity === 'rare') && i.findChance > 0);
                        if (rareItems.length > 0) {
                            const foundItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                            // P≈ôidat do skladu osady jako baseItem
                            if (!state.baseItems) state.baseItems = [];
                            const existingItem = state.baseItems.find(i => i.id === foundItem.id);
                            if (existingItem && foundItem.type === 'consumable') {
                                existingItem.count = (existingItem.count || 1) + 1;
                            } else {
                                state.baseItems.push({...foundItem, count: 1});
                            }
                            addLog(`üéí ${settler.name} na≈°el ${foundItem.icon} ${foundItem.name}!`, '‚≠ê');
                            prodReport.items.push(foundItem.name);
                            todayGather.items.push(`${foundItem.icon} ${foundItem.name}`);
                        }
                    }
                    
                    // Ulo≈æ dne≈°n√≠ sbƒõr do historie (max 7 dn√≠)
                    settler.gatherHistory.unshift(todayGather);
                    if (settler.gatherHistory.length > 7) settler.gatherHistory.pop();
                }
                
                // Alchemist produces herbs + chemicals podle √∫rovnƒõ
                if (type.id === 'alchemist') {
                    const herbsAmount = effect.herbs || 1;
                    const chemsAmount = effect.chemicals || 1;
                    state.settlement.resources.herbs = (state.settlement.resources.herbs || 0) + herbsAmount;
                    state.settlement.resources.chemicals = (state.settlement.resources.chemicals || 0) + chemsAmount;
                    prodReport.resources.herbs = (prodReport.resources.herbs || 0) + herbsAmount;
                    prodReport.resources.chemicals = (prodReport.resources.chemicals || 0) + chemsAmount;
                }
                
                // D≈ôevorubec - produkuje d≈ôevo a dal≈°√≠ suroviny podle √∫rovnƒõ
                if (type.id === 'lumberjack') {
                    const woodAmount = effect.wood || 3;
                    state.settlement.resources.wood = (state.settlement.resources.wood || 0) + woodAmount;
                    prodReport.resources.wood = (prodReport.resources.wood || 0) + woodAmount;
                    
                    // Provaz od √∫rovnƒõ 3
                    if (effect.rope) {
                        state.settlement.resources.rope = (state.settlement.resources.rope || 0) + effect.rope;
                        prodReport.resources.rope = (prodReport.resources.rope || 0) + effect.rope;
                    }
                    
                    // ≈†rot od √∫rovnƒõ 4
                    if (effect.scrap) {
                        state.settlement.resources.scrap = (state.settlement.resources.scrap || 0) + effect.scrap;
                        prodReport.resources.scrap = (prodReport.resources.scrap || 0) + effect.scrap;
                    }
                    
                    // ≈†ance na vz√°cn√© d≈ôevo na √∫rovni 5
                    if (effect.rareWood && Math.random() < 0.15) {
                        // P≈ôid√° bonus d≈ôevo nebo speci√°ln√≠ surovinu
                        const bonusWood = Math.floor(Math.random() * 5) + 3;
                        state.settlement.resources.wood = (state.settlement.resources.wood || 0) + bonusWood;
                        prodReport.resources.wood = (prodReport.resources.wood || 0) + bonusWood;
                        addLog(`ü™ì ${settler.name} na≈°el vz√°cn√© d≈ôevo: +${bonusWood}!`, '‚ú®');
                    }
                }
                
                // Medic healing podle √∫rovnƒõ - POUZE KDY≈Ω JE HR√Åƒå V OSADƒö
                if (effect.healing) {
                    const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
                    
                    if (inBase) {
                        let healAmount = effect.healing;
                        if (state.settlement.specialization === 'medical') healAmount = Math.floor(healAmount * 1.5);
                        
                        // L√©ƒçen√≠ hr√°ƒçe
                        const oldPlayerHp = state.char.hp;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                        const playerHealed = state.char.hp - oldPlayerHp;
                        
                        // L√©ƒçen√≠ radiace hr√°ƒçe (polovina l√©ƒçen√≠)
                        let radHealed = 0;
                        if (state.char.radiation > 0) {
                            const radHeal = Math.floor(healAmount / 2);
                            const oldRad = state.char.radiation;
                            state.char.radiation = Math.max(0, state.char.radiation - radHeal);
                            radHealed = oldRad - state.char.radiation;
                        }
                        
                        // Heal companions too
                        let compHealed = 0;
                        state.companions?.forEach(c => {
                            if (!c.isDead) {
                                const compInfo = COMPANIONS.find(ci => ci.id === c.id);
                                const oldHp = c.hp;
                                c.hp = Math.min(c.maxHp || compInfo?.hp || 50, c.hp + healAmount);
                                compHealed += c.hp - oldHp;
                                
                                // L√©ƒçen√≠ radiace spoleƒçn√≠k≈Ø
                                if (c.radiation > 0) {
                                    const radHeal = Math.floor(healAmount / 2);
                                    c.radiation = Math.max(0, c.radiation - radHeal);
                                }
                            }
                        });
                        
                        // Log a notifikace
                        if (playerHealed > 0 || radHealed > 0 || compHealed > 0) {
                            let healMsg = `üíâ ${settler.name} l√©ƒçil: `;
                            if (playerHealed > 0) healMsg += `ty +${playerHealed} HP`;
                            if (radHealed > 0) healMsg += `, -${radHealed} ‚ò¢Ô∏è`;
                            if (compHealed > 0) healMsg += `, spoleƒçn√≠ci +${compHealed} HP`;
                            addLog(healMsg, 'üíâ');
                        }
                    }
                }
                
                // Osadn√≠k z√≠sk√°v√° XP ka≈æd√Ω den
                if (settlerLevel < 5) {
                    settler.xp = (settler.xp || 0) + Math.floor(Math.random() * 5) + 1; // 1-5 XP dennƒõ
                    const xpForNext = settlerLevel * 100;
                    if (settler.xp >= xpForNext) {
                        settler.xp = 0;
                        settler.skillLevel = settlerLevel + 1;
                        const newSkill = skillData?.levels[settler.skillLevel - 1];
                        addLog(`‚¨ÜÔ∏è ${settler.name} postoupil na √∫rove≈à ${settler.skillLevel}: ${newSkill?.name}!`, '‚≠ê');
                    }
                }
            });
            
            // Calculate consumption
            const consumption = calculateSettlementConsumption();
            
            // Apply production and consumption
            state.settlement.resources.food += foodProd - consumption.food;
            state.settlement.resources.water += waterProd - consumption.water;
            
            // Morale effects
            if (state.settlement.resources.food <= 0) {
                state.settlement.morale = Math.max(0, state.settlement.morale - 10);
            }
            if (state.settlement.resources.water <= 0) {
                state.settlement.morale = Math.max(0, state.settlement.morale - 10);
            }
            if (state.settlement.resources.food > consumption.food * 3 && state.settlement.resources.water > consumption.water * 3) {
                state.settlement.morale = Math.min(100, state.settlement.morale + 5);
            }
            
            // Check for starvation/dehydration
            if (state.settlement.resources.food < 0) {
                if (state.settlement.settlers.length > 0) {
                    const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                    const settler = state.settlement.settlers[idx];
                    state.settlement.settlers.splice(idx, 1);
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 10);
                    state.settlement.morale = Math.max(0, state.settlement.morale - 15);
                    addLog(`üò¢ ${settler.name} opustil osadu kv≈Øli hladu!`, 'üò¢');
                    SoundSystem.play('error');
                }
                state.settlement.resources.food = 0;
            }
            
            if (state.settlement.resources.water < 0) {
                if (state.settlement.settlers.length > 0) {
                    const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                    const settler = state.settlement.settlers[idx];
                    state.settlement.settlers.splice(idx, 1);
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 10);
                    state.settlement.morale = Math.max(0, state.settlement.morale - 15);
                    addLog(`üò¢ ${settler.name} opustil osadu kv≈Øli ≈æ√≠zni!`, 'üò¢');
                    SoundSystem.play('error');
                }
                state.settlement.resources.water = 0;
            }
            
            // Tavern morale bonus (weekly) - prosperity bonus odstranƒõn
            if (state.settlement.buildings.includes('tavern') && state.time.days % 7 === 0) {
                state.settlement.morale = Math.min(100, state.settlement.morale + 20);
                addLog('üç∫ Hospoda zv√Ω≈°ila mor√°lku osady!', 'üç∫');
            }
            
            // === √öDR≈ΩBA BUDOV ===
            let totalMaintenance = 0;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            const maintenanceReport = [];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance > 0) {
                    totalMaintenance += building.maintenance;
                    maintenanceReport.push({ name: building.name, cost: building.maintenance });
                }
            });
            
            // Stavitel sni≈æuje √∫dr≈æbu podle √∫rovnƒõ
            const builders = state.settlement?.settlers?.filter(s => s.type === 'builder') || [];
            let maintenanceDiscount = 0;
            builders.forEach(builder => {
                const level = builder.skillLevel || 1;
                // Sleva: 5%, 10%, 15%, 20%, 25%
                maintenanceDiscount += 0.05 * level;
            });
            maintenanceDiscount = Math.min(0.5, maintenanceDiscount); // Max 50% sleva
            
            const finalMaintenance = Math.floor(totalMaintenance * (1 - maintenanceDiscount));
            
            if (finalMaintenance > 0) {
                if (getMoney() >= finalMaintenance) {
                    removeMoney(finalMaintenance);
                    addLog(`üîß √ödr≈æba budov: -${finalMaintenance} üí∞${maintenanceDiscount > 0 ? ` (sleva ${Math.round(maintenanceDiscount * 100)}%)` : ''}`, 'üîß');
                } else {
                    // Nedostatek penƒõz - n√°hodn√° budova se po≈°kod√≠
                    const damageable = allBuildings.filter(id => {
                        const b = BUILDINGS.find(bd => bd.id === id);
                        return b && b.maintenance > 0;
                    });
                    if (damageable.length > 0) {
                        const damaged = damageable[Math.floor(Math.random() * damageable.length)];
                        const damagedBuilding = BUILDINGS.find(b => b.id === damaged);
                        // Odstra≈à budovu
                        if (state.base.includes(damaged)) {
                            state.base = state.base.filter(id => id !== damaged);
                        }
                        if (state.settlement?.buildings?.includes(damaged)) {
                            state.settlement.buildings = state.settlement.buildings.filter(id => id !== damaged);
                        }
                        state.settlement.morale = Math.max(0, state.settlement.morale - 10);
                        addLog(`‚ö†Ô∏è ${damagedBuilding?.name || damaged} se rozpadla kv≈Øli chybƒõj√≠c√≠ √∫dr≈æbƒõ!`, '‚ö†Ô∏è');
                        SoundSystem.play('error');
                    }
                }
            }
            
            // Kontrola level upu
            checkSettlementLevelUp();
            
            // Trading specialization income je u≈æ v calculateDailyIncome()
            
            // === PASIVN√ç P≈ò√çJEM Z OBCHODN√çK≈Æ ===
            const traders = state.settlement.settlers.filter(s => s.type === 'trader_s');
            if (traders.length > 0) {
                let totalTraderIncome = 0;
                traders.forEach(trader => {
                    const level = trader.skillLevel || 1;
                    // P≈ô√≠jem podle √∫rovnƒõ: 10, 20, 35, 55, 80 penƒõz/den
                    const incomeByLevel = [10, 20, 35, 55, 80];
                    const income = incomeByLevel[level - 1] || 10;
                    totalTraderIncome += income;
                });
                
                // Bonus za tr≈æi≈°tƒõ
                if (state.settlement.buildings.includes('market')) {
                    totalTraderIncome = Math.floor(totalTraderIncome * 1.25); // +25%
                }
                
                addMoney(totalTraderIncome);
                addLog(`üí∞ Obchodn√≠ci vydƒõlali ${totalTraderIncome} penƒõz!`, 'üí∞');
            }
            
            // Check for random settlement events
            checkSettlementEvents();
            
            // === GENEROV√ÅN√ç OSADNICK√ùCH QUEST≈Æ ===
            generateSettlerQuests();
            
            // Random raid chance (defense < 50 = 5% chance, scout reduces to 2%)
            const defense = calculateSettlementDefense();
            const hasScout = state.settlement.settlers.some(s => s.type === 'scout');
            let raidChance = defense < 50 ? 0.05 : 0.02;
            if (hasScout) raidChance *= 0.4; // Scout reduces raid chance by 60%
            if (state.settlement.specialization === 'military') raidChance *= 0.5;
            
            if (Math.random() < raidChance) {
                if (hasScout) {
                    addLog('üèÉ Zvƒõd varoval p≈ôed bl√≠≈æ√≠c√≠m se √∫tokem!', 'üèÉ');
                }
                triggerSettlementRaid();
            }
            
            // Check level up
            checkSettlementLevelUp();
            
            // Log daily summary
            const netFood = foodProd - consumption.food;
            const netWater = waterProd - consumption.water;
            addLog(`üèòÔ∏è Denn√≠ report: ${netFood >= 0 ? '+' : ''}${netFood}üçñ ${netWater >= 0 ? '+' : ''}${netWater}üíß | Mor√°lka: ${state.settlement.morale}%`, 'üèòÔ∏è');
        }
        
        // === GENEROV√ÅN√ç OSADNICK√ùCH QUEST≈Æ ===
        function generateSettlerQuests() {
            if (!state.settlement || !state.settlement.settlers || state.settlement.settlers.length === 0) return;
            if (!state.settlement.activeQuests) state.settlement.activeQuests = [];
            
            // Max 3 aktivn√≠ questy souƒçasnƒõ
            if (state.settlement.activeQuests.length >= 3) return;
            
            // 30% ≈°ance na nov√Ω quest ka≈æd√Ω den
            if (Math.random() > 0.3) return;
            
            // Vyber n√°hodn√©ho osadn√≠ka kter√Ω nem√° aktivn√≠ quest
            const settlersWithoutQuest = state.settlement.settlers.filter(s => 
                !state.settlement.activeQuests.some(q => q.settlerName === s.name)
            );
            
            if (settlersWithoutQuest.length === 0) return;
            
            const settler = settlersWithoutQuest[Math.floor(Math.random() * settlersWithoutQuest.length)];
            const settlerType = SETTLER_TYPES.find(t => t.id === settler.type);
            
            // Najdi quest pro tento typ osadn√≠ka
            const availableQuests = SETTLER_QUESTS.filter(q => q.settler === settler.type);
            if (availableQuests.length === 0) return;
            
            const quest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
            
            // P≈ôidej quest
            state.settlement.activeQuests.push({
                questId: quest.id,
                settlerName: settler.name,
                settlerType: settler.type,
                startDay: state.time.days,
                progress: {}
            });
            
            addLog(`üìã ${settler.name} (${settlerType?.icon || ''}) m√° pro tebe √∫kol: ${quest.name}`, 'üìã');
            notifySuccess('Nov√Ω √∫kol!', `${settler.name}: ${quest.name}`);
        }
        
        // Funkce pro splnƒõn√≠ osadnick√©ho questu
        function completeSettlerQuest(questIndex) {
            if (!state.settlement?.activeQuests?.[questIndex]) return;
            
            const sq = state.settlement.activeQuests[questIndex];
            const quest = SETTLER_QUESTS.find(q => q.id === sq.questId);
            if (!quest) return;
            
            // Kontrola po≈æadavk≈Ø
            if (quest.request.wood && (state.settlement.resources.wood || 0) < quest.request.wood) {
                notifyWarning('Chyb√≠ suroviny!', `Pot≈ôebuje≈° ${quest.request.wood} d≈ôeva`);
                return;
            }
            if (quest.request.metal && (state.settlement.resources.metal || 0) < quest.request.metal) {
                notifyWarning('Chyb√≠ suroviny!', `Pot≈ôebuje≈° ${quest.request.metal} kovu`);
                return;
            }
            if (quest.request.meat && (state.settlement.resources.food || 0) < quest.request.meat) {
                notifyWarning('Chyb√≠ suroviny!', `Pot≈ôebuje≈° ${quest.request.meat} j√≠dla/masa`);
                return;
            }
            if (quest.request.money && state.money < quest.request.money) {
                notifyWarning('Chyb√≠ pen√≠ze!', `Pot≈ôebuje≈° ${quest.request.money} üí∞`);
                return;
            }
            if (quest.request.item) {
                const hasItem = state.inv.some(i => i.id === quest.request.item);
                if (!hasItem) {
                    const itemName = ITEMS.find(i => i.id === quest.request.item)?.name || quest.request.item;
                    notifyWarning('Chyb√≠ p≈ôedmƒõt!', `Pot≈ôebuje≈°: ${itemName}`);
                    return;
                }
            }
            
            // Odeber po≈æadavky
            if (quest.request.wood) state.settlement.resources.wood -= quest.request.wood;
            if (quest.request.metal) state.settlement.resources.metal -= quest.request.metal;
            if (quest.request.meat) state.settlement.resources.food -= quest.request.meat;
            if (quest.request.money) state.money -= quest.request.money;
            if (quest.request.item) {
                const idx = state.inv.findIndex(i => i.id === quest.request.item);
                if (idx !== -1) {
                    if (state.inv[idx].count > 1) state.inv[idx].count--;
                    else state.inv.splice(idx, 1);
                }
            }
            
            // Dej odmƒõny
            if (quest.reward.money) addMoney(quest.reward.money);
            if (quest.reward.xp) addXP(quest.reward.xp);
            if (quest.reward.prosperity) state.settlement.prosperity += quest.reward.prosperity;
            if (quest.reward.defense) state.settlement.defense = (state.settlement.defense || 0) + quest.reward.defense;
            if (quest.reward.food) state.settlement.resources.food += quest.reward.food;
            
            // Odeber quest
            state.settlement.activeQuests.splice(questIndex, 1);
            
            addLog(`‚úÖ √ökol splnƒõn: ${quest.name}!`, '‚úÖ');
            notifySuccess('√ökol splnƒõn!', quest.name);
            
            // Aktualizuj UI
            renderFull();
        }
        
        // Funkce pro zobrazen√≠ detailu settler questu
        function showSettlerQuestDetail(questIndex) {
            if (!state.settlement?.activeQuests?.[questIndex]) return;
            
            const sq = state.settlement.activeQuests[questIndex];
            const quest = SETTLER_QUESTS.find(q => q.id === sq.questId);
            const settler = state.settlement.settlers.find(s => s.name === sq.settlerName);
            const settlerType = settler ? SETTLER_TYPES.find(t => t.id === settler.type) : null;
            
            if (!quest) return;
            
            // Kontrola co m√° hr√°ƒç
            let requirementsHtml = '';
            let canComplete = true;
            
            if (quest.request.wood) {
                const has = state.settlement.resources.wood || 0;
                const ok = has >= quest.request.wood;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">ü™µ D≈ôevo: ${has}/${quest.request.wood} ${ok ? '‚úì' : '‚úó'}</div>`;
            }
            if (quest.request.metal) {
                const has = state.settlement.resources.metal || 0;
                const ok = has >= quest.request.metal;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">üî© Kov: ${has}/${quest.request.metal} ${ok ? '‚úì' : '‚úó'}</div>`;
            }
            if (quest.request.meat) {
                const has = state.settlement.resources.food || 0;
                const ok = has >= quest.request.meat;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">ü•© Maso/J√≠dlo: ${has}/${quest.request.meat} ${ok ? '‚úì' : '‚úó'}</div>`;
            }
            if (quest.request.money) {
                const has = state.money;
                const ok = has >= quest.request.money;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#f44336'};">üí∞ Pen√≠ze: ${has}/${quest.request.money} ${ok ? '‚úì' : '‚úó'}</div>`;
            }
            if (quest.request.item) {
                const hasItem = state.inv.some(i => i.id === quest.request.item);
                if (!hasItem) canComplete = false;
                const itemData = ITEMS.find(i => i.id === quest.request.item);
                requirementsHtml += `<div style="color: ${hasItem ? '#4caf50' : '#f44336'};">${itemData?.icon || 'üì¶'} ${itemData?.name || quest.request.item}: ${hasItem ? '‚úì' : '‚úó'}</div>`;
            }
            if (quest.request.action) {
                // Pro akce jako 'patrol' - pot≈ôeba prozkoumat X lokac√≠
                const progress = sq.progress?.explored || 0;
                const ok = progress >= quest.request.count;
                if (!ok) canComplete = false;
                requirementsHtml += `<div style="color: ${ok ? '#4caf50' : '#ff9800'};">üîç Prozkoum√°no: ${progress}/${quest.request.count} ${ok ? '‚úì' : '...'}</div>`;
            }
            
            // Odmƒõny
            let rewardHtml = '';
            if (quest.reward.money) rewardHtml += `<span>üí∞ ${quest.reward.money}</span> `;
            if (quest.reward.xp) rewardHtml += `<span>‚≠ê ${quest.reward.xp} XP</span> `;
            if (quest.reward.prosperity) rewardHtml += `<span>üìà +${quest.reward.prosperity} prosperita</span> `;
            if (quest.reward.defense) rewardHtml += `<span>üõ°Ô∏è +${quest.reward.defense} obrana</span> `;
            if (quest.reward.food) rewardHtml += `<span>üçñ +${quest.reward.food} j√≠dla</span> `;
            
            showModal(`${quest.icon} ${quest.name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${quest.icon}</div>
                    <p style="color: #888; font-style: italic;">"${quest.desc}"</p>
                    <p style="color: #aaa;">Od: ${sq.settlerName} ${settlerType?.icon || ''}</p>
                </div>
                
                <h4 style="color: #ff9800; margin-bottom: 0.5rem;">üìã Po≈æadavky:</h4>
                <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem;">
                    ${requirementsHtml || '<div style="color: #888;">≈Ω√°dn√© speci√°ln√≠ po≈æadavky</div>'}
                </div>
                
                <h4 style="color: #4caf50; margin-bottom: 0.5rem;">üéÅ Odmƒõna:</h4>
                <div style="background: #1a2a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 1rem;">
                    ${rewardHtml || '≈Ω√°dn√°'}
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    ${canComplete ? 
                        `<button class="btn" onclick="completeSettlerQuest(${questIndex}); closeModal();" style="flex: 1; background: #4caf50;">‚úì Odevzdat</button>` :
                        `<button class="btn" style="flex: 1; opacity: 0.5;" disabled>‚úó Nesplnƒõno</button>`
                    }
                    <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">${'Zpƒõt'}</button>
                </div>
            `);
        }
        
        // === SETTLEMENT EVENTS ===
        function checkSettlementEvents() {
            if (!state.settlement) return;
            
            // Eventy se spou≈°t√≠ pouze pokud m√° hr√°ƒç alespo≈à jednoho osadn√≠ka
            const hasSettlers = state.settlement.settlers && state.settlement.settlers.length > 0;
            if (!hasSettlers) return;
            
            // Kontrola cooldownu - 1 event za 6 hodin hern√≠ho ƒçasu
            const now = Date.now();
            const sixHoursMs = 6 * 60 * 60 * 1000; // 6 hodin v ms
            
            if (!state.settlement.lastEventTime) {
                state.settlement.lastEventTime = now - sixHoursMs; // Prvn√≠ event hned
            }
            
            if (now - state.settlement.lastEventTime < sixHoursMs) {
                return; // Je≈°tƒõ neuplynulo 6 hodin
            }
            
            // Aktualizuj ƒças posledn√≠ho eventu
            state.settlement.lastEventTime = now;
            
            // Bonus ≈°ance na obchodn√≠ka s komunikaƒçn√≠ vƒõ≈æ√≠
            const hasCommTower = state.base?.includes('comms') || state.settlement?.buildings?.includes('comms');
            const merchantBonus = hasCommTower && hasPower() ? 0.1 : 0; // +10% ≈°ance s vƒõ≈æ√≠
            
            // Zam√≠chej eventy aby nebyly v≈ædy ve stejn√©m po≈ôad√≠
            const shuffledEvents = [...SETTLEMENT_EVENTS].sort(() => Math.random() - 0.5);
            
            // Vyber 1 event
            let selectedEvent = null;
            
            for (const event of shuffledEvents) {
                // Z√°kladn√≠ ≈°ance
                let eventChance = event.chance * 3; // Zv√Ω≈°en√° ≈°ance proto≈æe je jen 1 event za 6h
                
                // Obchodn√≠k m√° bonus ≈°anci s komunikaƒçn√≠ vƒõ≈æ√≠
                if (event.id === 'merchant') {
                    eventChance += merchantBonus;
                }
                
                if (Math.random() > eventChance) continue;
                
                // Check conditions
                const hasSettlers = state.settlement.settlers && state.settlement.settlers.length > 0;
                if (event.condition === 'lowMorale' && (!hasSettlers || state.settlement.morale > 30)) continue;
                if (event.condition === 'hasFarm' && !state.settlement.buildings?.includes('farmland')) continue;
                if (event.condition === 'noMedic' && hasSettlers && state.settlement.settlers.some(s => s.type === 'medic_s')) continue;
                if (event.condition === 'noGuard' && hasSettlers && state.settlement.settlers.some(s => s.type === 'guard')) continue;
                
                // Nƒõkter√© eventy pot≈ôebuj√≠ osadn√≠ky
                const needsSettlers = ['birth', 'wedding', 'dispute', 'runaway', 'accident', 'fire', 'sickness', 'injury', 'celebration'];
                if (needsSettlers.includes(event.id) && !hasSettlers) continue;
                
                selectedEvent = event;
                break;
            }
            
            // Pokud ≈æ√°dn√Ω event nepro≈°el, vyber n√°hodnƒõ z bezpeƒçn√Ωch
            if (!selectedEvent) {
                const safeEvents = shuffledEvents.filter(e => 
                    !e.condition &&
                    !['birth', 'wedding', 'dispute', 'runaway', 'accident', 'fire', 'sickness', 'injury'].includes(e.id)
                );
                if (safeEvents.length > 0) {
                    selectedEvent = safeEvents[0];
                }
            }
            
            // Spus≈• event
            if (selectedEvent) {
                triggerSettlementEvent(selectedEvent);
            }
        }
        
        // Zobraz dal≈°√≠ event z fronty
        function triggerNextSettlementEvent() {
            if (!state.pendingSettlementEvents || state.pendingSettlementEvents.length === 0) {
                return;
            }
            
            const event = state.pendingSettlementEvents.shift();
            triggerSettlementEvent(event);
        }
        
        function triggerSettlementEvent(event) {
            state.settlement.activeEvent = event;
            
            // Promƒõnn√° pro detaily eventu (kdo um≈ôel, co ukradli, atd.)
            let eventDetails = '';
            
            // Apply immediate effects
            if (event.prosperity) {
                state.settlement.prosperity = Math.max(0, Math.min(100, state.settlement.prosperity + event.prosperity));
            }
            if (event.morale) {
                state.settlement.morale = Math.max(0, Math.min(100, state.settlement.morale + event.morale));
            }
            
            let message = `<p style="margin-bottom: 1rem;">${event.desc}</p>`;
            let buttons = '';
            
            switch (event.effect) {
                case 'newSettler':
                    if (true) {
                        const randomType = SETTLER_TYPES[Math.floor(Math.random() * SETTLER_TYPES.length)];
                        const newSettler = { type: randomType.id, name: generateSettlerName(), hp: 100, maxHp: 100, morale: 50 };
                        state.settlement.settlers.push(newSettler);
                        message += `<p style="color: var(--toxic-green);">Nov√Ω obyvatel: ${randomType.icon} ${newSettler.name} (${randomType.name})</p>`;
                        eventDetails = `Nov√Ω: ${newSettler.name} (${randomType.name})`;
                    } else {
                        message = '<p>Osada je pln√°, nelze p≈ôijmout dal≈°√≠ho obyvatele.</p>';
                    }
                    break;
                
                case 'morale':
                    // Svatba - zv√Ω≈°√≠ mor√°lku
                    state.settlement.morale = Math.min(100, state.settlement.morale + (event.morale || 20));
                    message += `<p style="color: var(--toxic-green);">+${event.morale || 20} mor√°lka osady!</p>`;
                    message += `<p style="color: #ff69b4;">üíï Cel√° osada slav√≠!</p>`;
                    break;
                    
                case 'party':
                    // Oslava - zv√Ω≈°√≠ mor√°lku v≈°ech
                    state.settlement.morale = Math.min(100, state.settlement.morale + (event.morale || 25));
                    state.settlement.settlers.forEach(s => {
                        s.morale = Math.min(100, (s.morale || 50) + 15);
                    });
                    message += `<p style="color: var(--toxic-green);">+${event.morale || 25} mor√°lka osady!</p>`;
                    message += `<p style="color: #ffd700;">üéä V≈°ichni osadn√≠ci jsou ≈°≈•astnƒõj≈°√≠!</p>`;
                    break;
                    
                case 'conflict':
                    // Spor - sn√≠≈æ√≠ mor√°lku
                    state.settlement.morale = Math.max(0, state.settlement.morale + (event.morale || -15));
                    if (state.settlement.settlers.length >= 2) {
                        const settler1 = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        let settler2 = settler1;
                        while (settler2 === settler1 && state.settlement.settlers.length > 1) {
                            settler2 = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        }
                        message += `<p style="color: #ff9800;">${settler1.name} a ${settler2.name} se h√°daj√≠!</p>`;
                    }
                    message += `<p style="color: #c62828;">${event.morale || -15} mor√°lka osady</p>`;
                    break;
                    
                case 'injury':
                    // Nehoda - zran√≠ osadn√≠ka
                    if (state.settlement.settlers.length > 0) {
                        const injured = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        const type = SETTLER_TYPES.find(t => t.id === injured.type);
                        injured.hp = Math.max(10, (injured.hp || 100) - 40);
                        message += `<p style="color: #c62828;">${type?.icon || 'üë§'} ${injured.name} se v√°≈ænƒõ zranil!</p>`;
                        message += `<p style="color: #ff9800;">HP: ${injured.hp}/100</p>`;
                        if (state.settlement.settlers.some(s => s.type === 'medic_s')) {
                            injured.hp = Math.min(100, injured.hp + 20);
                            message += `<p style="color: var(--toxic-green);">Medik poskytl prvn√≠ pomoc! (+20 HP)</p>`;
                        } else {
                            message += `<p style="color: #888;">üí° S medikem by se zotavil rychleji.</p>`;
                        }
                    }
                    break;
                    
                case 'loseSettler':
                    if (state.settlement.settlers.length > 0) {
                        const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                        const lost = state.settlement.settlers.splice(idx, 1)[0];
                        const type = SETTLER_TYPES.find(t => t.id === lost.type);
                        message += `<p style="color: #c62828;">${type?.icon || 'üë§'} ${lost.name} utekl z osady!</p>`;
                    }
                    break;
                    
                case 'sickness':
                    const sickCount = Math.min(state.settlement.settlers.length, Math.floor(Math.random() * 3) + 1);
                    message += `<p style="color: #ff9800;">${sickCount} obyvatel onemocnƒõlo.</p>`;
                    if (!state.settlement.settlers.some(s => s.type === 'medic_s')) {
                        message += '<p style="color: #c62828;">Bez medika m≈Ø≈æe nemoc zab√≠t!</p>';
                        if (Math.random() < 0.3 && state.settlement.settlers.length > 0) {
                            const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                            const dead = state.settlement.settlers.splice(idx, 1)[0];
                            message += `<p style="color: #c62828;">üíÄ ${dead.name} zem≈ôel na nemoc!</p>`;
                        }
                    } else {
                        message += '<p style="color: var(--toxic-green);">Medik se o nƒõ postar√°.</p>';
                    }
                    break;
                    
                case 'food':
                    state.settlement.resources.food += event.food || 20;
                    message += `<p style="color: var(--toxic-green);">+${event.food || 20} üçñ j√≠dla!</p>`;
                    break;
                    
                case 'bonus':
                    const bonusRes = ['wood', 'metal', 'stone', 'cloth'][Math.floor(Math.random() * 4)];
                    const bonusAmt = Math.floor(Math.random() * 10) + 5;
                    state.resources[bonusRes] = (state.resources[bonusRes] || 0) + bonusAmt;
                    message += `<p style="color: var(--toxic-green);">+${bonusAmt}x ${bonusRes}!</p>`;
                    break;
                    
                case 'trade':
                    state.settlement.visitingMerchant = {
                        until: Date.now() + (event.duration || 10) * 60 * 1000, // duration v minut√°ch
                        discount: 0.2
                    };
                    message += '<p style="color: var(--warning-yellow);">Obchodn√≠k z≈Østane ' + (event.duration || 10) + ' minut. Nav≈°tiv obchod pro slevu!</p>';
                    break;
                    
                case 'skillUp':
                case 'skill':
                    if (state.settlement.settlers.length > 0) {
                        const settler = state.settlement.settlers[Math.floor(Math.random() * state.settlement.settlers.length)];
                        settler.skillLevel = (settler.skillLevel || 1) + 1;
                        const type = SETTLER_TYPES.find(t => t.id === settler.type);
                        message += `<p style="color: var(--toxic-green);">${type?.icon || 'üë§'} ${settler.name} se zlep≈°il! (Level ${settler.skillLevel})</p>`;
                    }
                    break;
                
                // === NOV√â EFEKTY ===
                case 'theft':
                    const stolenFood = Math.floor(Math.random() * 10) + 5;
                    const stolenWater = Math.floor(Math.random() * 8) + 3;
                    state.settlement.resources.food = Math.max(0, state.settlement.resources.food - stolenFood);
                    state.settlement.resources.water = Math.max(0, state.settlement.resources.water - stolenWater);
                    message += `<p style="color: #c62828;">Ztr√°ta: -${stolenFood} üçñ, -${stolenWater} üíß</p>`;
                    eventDetails = `-${stolenFood} üçñ, -${stolenWater} üíß`;
                    if (!state.settlement.settlers.some(s => s.type === 'guard')) {
                        message += '<p style="color: #ff9800;">üí° Str√°≈æce by tomu zabr√°nil!</p>';
                    }
                    break;
                    
                case 'fire':
                    const damageRoll = Math.random();
                    if (damageRoll < 0.3 && state.settlement.buildings.length > 0) {
                        const idx = Math.floor(Math.random() * state.settlement.buildings.length);
                        const destroyed = state.settlement.buildings.splice(idx, 1)[0];
                        const building = BUILDINGS.find(b => b.id === destroyed);
                        message += `<p style="color: #c62828;">üî• ${building?.name || destroyed} sho≈ôela!</p>`;
                        eventDetails = `Sho≈ôela: ${building?.name || destroyed}`;
                    } else {
                        const lostFood = Math.floor(state.settlement.resources.food * 0.2);
                        state.settlement.resources.food = Math.max(0, state.settlement.resources.food - lostFood);
                        message += `<p style="color: #ff9800;">Z√°soby po≈°kozeny: -${lostFood} üçñ</p>`;
                        eventDetails = `-${lostFood} üçñ`;
                    }
                    break;
                    
                case 'golden':
                    state.settlement.resources.food += 30;
                    state.settlement.resources.water += 30;
                    addMoney(200);
                    message += `<p style="color: #ffd700;">+30 üçñ, +30 üíß, +200 üí∞!</p>`;
                    eventDetails = '+30 üçñ, +30 üíß, +200 üí∞';
                    break;
                    
                case 'plague':
                    const plagueDeaths = Math.min(state.settlement.settlers.length, Math.floor(Math.random() * 3) + 1);
                    const deadNames = [];
                    for (let i = 0; i < plagueDeaths; i++) {
                        if (state.settlement.settlers.length > 0) {
                            const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                            const dead = state.settlement.settlers.splice(idx, 1)[0];
                            deadNames.push(dead.name);
                            message += `<p style="color: #c62828;">üíÄ ${dead.name} zem≈ôel!</p>`;
                        }
                    }
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 30);
                    eventDetails = deadNames.length > 0 ? `Zem≈ôeli: ${deadNames.join(', ')}` : '';
                    break;
                    
                case 'treasure':
                    const treasureMoney = Math.floor(Math.random() * 300) + 200;
                    addMoney(treasureMoney);
                    const rareRes = ['copper', 'silver', 'gold'][Math.floor(Math.random() * 3)];
                    state.resources[rareRes] = (state.resources[rareRes] || 0) + 3;
                    message += `<p style="color: #ffd700;">+${treasureMoney} üí∞, +3 ${rareRes}!</p>`;
                    eventDetails = `+${treasureMoney} üí∞, +3 ${rareRes}`;
                    // Track pro achievement
                    state.stats.treasuresFound = (state.stats.treasuresFound || 0) + 1;
                    break;
                
                // === ROZHODOVAC√ç EVENTY ===
                case 'choice_refugee':
                    const refugeeTexts = {
                        desc: 'Vyƒçerpan√Ω uprchl√≠k pros√≠ o p≈ôijet√≠ do osady.',
                        hint: 'Vypad√° ≈æe ut√≠k√° p≈ôed bandity...',
                        accept: 'P≈ôijmout (+1 osadn√≠k, -10 üçñ)',
                        reject: 'Odm√≠tnout (mo≈æn√° se vr√°t√≠ s bandity...)'
                    };
                    message = `<p>${refugeeTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${refugeeTexts.hint}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('refugee_accept')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            ‚úÖ ${refugeeTexts.accept}
                        </button>
                        <button class="btn" onclick="settlementChoice('refugee_reject')" style="width: 100%; background: #555;">
                            ‚ùå ${refugeeTexts.reject}
                        </button>
                    `;
                    break;
                    
                case 'choice_dog':
                    const dogTexts = {
                        desc: 'Vyhubl√Ω pes sed√≠ u br√°ny a prosebnƒõ kouk√°.',
                        hint: 'Vypad√° ≈æe by mohl b√Ωt u≈æiteƒçn√Ω...',
                        adopt: 'Adoptovat (-5 üçñ/den, +bonus k obranƒõ)',
                        feed: 'Nakrmit a pustit (-3 üçñ)',
                        ignore: 'Ignorovat'
                    };
                    message = `<p>${dogTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${dogTexts.hint}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('dog_adopt')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            üêï ${dogTexts.adopt}
                        </button>
                        <button class="btn" onclick="settlementChoice('dog_feed')" style="width: 100%; margin-bottom: 0.5rem; background: #5D4037;">
                            üçñ ${dogTexts.feed}
                        </button>
                        <button class="btn" onclick="settlementChoice('dog_ignore')" style="width: 100%; background: #555;">
                            üëã ${dogTexts.ignore}
                        </button>
                    `;
                    break;
                    
                case 'choice_mystery':
                    const mysteryOffer = Math.random() < 0.5 ? 'good' : 'bad';
                    state.settlement.mysteryOffer = mysteryOffer;
                    const mystTexts = {
                        desc: 'Z√°hadn√° postava v pl√°≈°ti nab√≠z√≠ obchod:',
                        offer: '"D√°m ti nƒõco cenn√©ho za 100 üí∞..."',
                        unknown: 'Nev√≠≈° co dostane≈°.',
                        accept: 'Zaplatit 100 üí∞ (risk!)', reject: 'Odm√≠tnout'
                    };
                    message = `<p>${mystTexts.desc}</p>
                        <p style="color: #ffd700;">${mystTexts.offer}</p>
                        <p style="color: #888; font-size: 0.9rem;">${mystTexts.unknown}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('mystery_accept')" style="width: 100%; margin-bottom: 0.5rem; background: #9C27B0;">
                            üé≤ ${mystTexts.accept}
                        </button>
                        <button class="btn" onclick="settlementChoice('mystery_reject')" style="width: 100%; background: #555;">
                            ‚ùå ${mystTexts.reject}
                        </button>
                    `;
                    break;
                    
                case 'choice_wounded':
                    const woundTexts = {
                        desc: 'Tƒõ≈æce zranƒõn√Ω cizinec le≈æ√≠ u cesty.',
                        hint: 'Mo≈æn√° m√° nƒõco cenn√©ho... nebo je to past.',
                        help: 'Pomoci (-1 medkit, mo≈æn√° odmƒõna)',
                        loot: 'Prohledat kapsy (zl√° karma)',
                        ignore: 'J√≠t d√°l'
                    };
                    message = `<p>${woundTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${woundTexts.hint}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('wounded_help')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            üíä ${woundTexts.help}
                        </button>
                        <button class="btn" onclick="settlementChoice('wounded_loot')" style="width: 100%; margin-bottom: 0.5rem; background: #8B0000;">
                            üíÄ ${woundTexts.loot}
                        </button>
                        <button class="btn" onclick="settlementChoice('wounded_ignore')" style="width: 100%; background: #555;">
                            üëã ${woundTexts.ignore}
                        </button>
                    `;
                    break;
                    
                case 'choice_bandit':
                    const banditTexts = {
                        desc: 'Bandita s jizvou p≈ôich√°z√≠ s "nab√≠dkou":',
                        threat: '"Pla≈• 50 üé´ t√Ωdnƒõ nebo... v√≠≈° co."',
                        pay: 'Zaplatit (m√≠r na t√Ωden)',
                        fight: 'Odm√≠tnout a bojovat!',
                        trick: 'Lst√≠ ho p≈ôelst√≠t (INT check)'
                    };
                    message = `<p>${banditTexts.desc}</p>
                        <p style="color: #c62828;">${banditTexts.threat}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('bandit_pay')" style="width: 100%; margin-bottom: 0.5rem; background: #555;">
                            üí∞ ${banditTexts.pay}
                        </button>
                        <button class="btn" onclick="settlementChoice('bandit_fight')" style="width: 100%; margin-bottom: 0.5rem; background: #8B0000;">
                            ‚öîÔ∏è ${banditTexts.fight}
                        </button>
                        <button class="btn" onclick="settlementChoice('bandit_trick')" style="width: 100%; background: #9C27B0;">
                            üé≠ ${banditTexts.trick}
                        </button>
                    `;
                    break;
                    
                case 'choice_child':
                    const childTexts = {
                        desc: 'Mal√© d√≠tƒõ stoj√≠ samo u br√°ny.',
                        quote: '"Maminka a tat√≠nek jsou... pryƒç."',
                        adopt: 'P≈ôijmout do osady (+morale, -3 üçñ/den)',
                        send: 'Poslat k obchodn√≠k≈Øm (bezpeƒçnƒõj≈°√≠)'
                    };
                    message = `<p>${childTexts.desc}</p>
                        <p style="color: #888; font-size: 0.9rem;">${childTexts.quote}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('child_adopt')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            üè† ${childTexts.adopt}
                        </button>
                        <button class="btn" onclick="settlementChoice('child_send')" style="width: 100%; background: #555;">
                            üó∫Ô∏è ${childTexts.send}
                        </button>
                    `;
                    break;
                    
                case 'choice_dispute':
                    const settler1 = state.settlement.settlers[0];
                    const settler2 = state.settlement.settlers[1] || settler1;
                    const dispTexts = {
                        desc: ' se h√°daj√≠ o nalezen√© z√°soby.',
                        question: 'Kdo m√° pravdu?',
                        first: ' m√° pravdu', second: ' m√° pravdu',
                        split: 'Rozdƒõlit spravedlivƒõ'
                    };
                    message = `<p>${settler1?.name || ('Osadn√≠k')} ${'a'} ${settler2?.name || ('jin√Ω osadn√≠k')}${dispTexts.desc}</p>
                        <p style="color: #888;">${dispTexts.question}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('dispute_first')" style="width: 100%; margin-bottom: 0.5rem; background: #2196f3;">
                            üëà ${settler1?.name || ('Prvn√≠')}${dispTexts.first}
                        </button>
                        <button class="btn" onclick="settlementChoice('dispute_second')" style="width: 100%; margin-bottom: 0.5rem; background: #FF9800;">
                            üëâ ${settler2?.name || ('Druh√Ω')}${dispTexts.second}
                        </button>
                        <button class="btn" onclick="settlementChoice('dispute_split')" style="width: 100%; background: #4CAF50;">
                            ü§ù ${dispTexts.split}
                        </button>
                    `;
                    break;
                    
                case 'choice_scavenger':
                    const scavTexts = {
                        desc: 'Sbƒõraƒç p≈ôinesl z√°hadnou bednu.',
                        quote: '"Nev√≠m co v n√≠ je... otev≈ôeme?"',
                        open: 'Otev≈ô√≠t (m≈Ø≈æe b√Ωt poklad nebo past!)',
                        sell: 'Prodat obchodn√≠kovi (50 üé´ jist√Ωch)',
                        careful: 'Opatrnƒõ prozkoumat (INT check)'
                    };
                    message = `<p>${scavTexts.desc}</p>
                        <p style="color: #ffd700;">${scavTexts.quote}</p>`;
                    buttons = `
                        <button class="btn" onclick="settlementChoice('scavenger_open')" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">
                            üì¶ ${scavTexts.open}
                        </button>
                        <button class="btn" onclick="settlementChoice('scavenger_sell')" style="width: 100%; margin-bottom: 0.5rem; background: #FF9800;">
                            üí∞ ${scavTexts.sell}
                        </button>
                        <button class="btn" onclick="settlementChoice('scavenger_careful')" style="width: 100%; background: #555;">
                            üîç ${scavTexts.careful}
                        </button>
                    `;
                    break;
                    
                default:
                    // Morale a party efekt
                    if (event.effect === 'morale' || event.effect === 'party' || event.effect === 'conflict' || event.effect === 'injury') {
                        // U≈æ zpracov√°no prosperity/morale v√Ω≈°e
                    }
                    break;
            }
            
            if (!buttons) {
                // Po kliknut√≠ na OK se zobraz√≠ dal≈°√≠ event (pokud existuje)
                const hasMoreEvents = state.pendingSettlementEvents && state.pendingSettlementEvents.length > 0;
                const okText = hasMoreEvents ? ('OK (dal≈°√≠ event ƒçek√°)') : 'OK';
                buttons = `<button class="btn" onclick="closeModal(); ${hasMoreEvents ? 'setTimeout(triggerNextSettlementEvent, 300);' : ''}" style="width: 100%;">${okText}</button>`;
            }
            
            // Syst√©mov√° notifikace
            sendSystemNotification(`${event.icon} ${event.name}`, event.desc, event.icon);
            
            // Nezobrazuj modal pokud:
            // 1. Prob√≠h√° akce (lov, tƒõ≈æba, atd.)
            // 2. Prob√≠h√° boj
            // 3. Hr√°ƒç nen√≠ v osadƒõ
            const isActionInProgress = state.currentAction && state.currentAction.endTime > Date.now();
            const inCombat = isInCombat();
            const inSettlement = state.world?.currentLocation === 'shelter' || state.world?.currentLocation === 'settlement';
            
            if (isActionInProgress || inCombat) {
                // Jen toast notifikace, modal se nezobraz√≠
                notifyWarning(`${event.icon} ${event.name}`, event.desc);
                // Ulo≈æ event pro pozdƒõj≈°√≠ zobrazen√≠ (voliteln√©)
                if (!state.pendingSettlementEvents) state.pendingSettlementEvents = [];
                // Event u≈æ byl aplikov√°n, jen nezobraz√≠me modal
                return;
            }
            
            // Pokud hr√°ƒç nen√≠ v osadƒõ, zobraz jen toast
            if (!inSettlement) {
                notifyWarning(`${event.icon} Osada: ${event.name}`, event.desc);
                return;
            }
            
            setTimeout(() => {
                showModal(`${event.icon} ${event.name}`, message + buttons, true);
            }, 500);
            
            // P≈ôidej do logu osady S DETAILY
            if (!state.settlement.eventLog) state.settlement.eventLog = [];
            state.settlement.eventLog.unshift({
                id: event.id,
                name: event.name,
                icon: event.icon,
                desc: event.desc,
                details: eventDetails, // Konkr√©tn√≠ detaily (kdo um≈ôel, co ukradli, atd.)
                day: state.time.days,
                timestamp: Date.now()
            });
            // Max 15 z√°znam≈Ø
            if (state.settlement.eventLog.length > 15) state.settlement.eventLog.pop();
            
            addLog(`${event.icon} ${event.name}: ${event.desc}`, event.icon);
        }
        
        // === SETTLEMENT CHOICE HANDLER ===
        // Zobrazen√≠ detailu ud√°losti z historie
        function showEventDetail(eventId, name, icon, desc, details, day) {
            const event = SETTLEMENT_EVENTS?.find(e => e.id === eventId);
            
            showModal(`${icon} ${name}`, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${icon}</div>
                    <div style="color: #888; font-size: 0.85rem;">Den ${day}</div>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ddd; margin: 0;">${desc || '≈Ω√°dn√Ω popis'}</p>
                </div>
                
                ${details ? `
                    <div style="background: #2a1a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #ff9800;">
                        <p style="color: #ff9800; margin: 0; font-size: 0.9rem;">üìã ${details}</p>
                    </div>
                ` : ''}
                
                ${event ? `
                    <div style="background: #0a1a0a; padding: 0.8rem; border-radius: 8px; border: 1px solid #333;">
                        <p style="color: #888; font-size: 0.8rem; margin: 0 0 0.5rem 0;">‚ÑπÔ∏è O ud√°losti:</p>
                        <p style="color: #8bc34a; font-size: 0.85rem; margin: 0;">${event.desc || ''}</p>
                    </div>
                ` : ''}
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zav≈ô√≠t</button>
            `);
        }
        
        function settlementChoice(choice) {
            closeModal();
            
            // Po rozhodnut√≠ zobraz dal≈°√≠ event
            setTimeout(triggerNextSettlementEvent, 500);
            
            let result = '';
            let resultType = 'info'; // 'success', 'warning', 'danger'
            
            switch(choice) {
                // REFUGEE
                case 'refugee_accept':
                    if (true) {
                        const randomType = SETTLER_TYPES[Math.floor(Math.random() * SETTLER_TYPES.length)];
                        const newSettler = { type: randomType.id, name: generateSettlerName(), hp: 100, maxHp: 100, morale: 70 };
                        state.settlement.settlers.push(newSettler);
                        state.settlement.resources.food = Math.max(0, state.settlement.resources.food - 10);
                        result = `${randomType.icon} ${newSettler.name} se p≈ôidal k osadƒõ!`;
                        resultType = 'success';
                    } else {
                        result = 'Osada je pln√°!';
                        resultType = 'warning';
                    }
                    break;
                case 'refugee_reject':
                    if (Math.random() < 0.3) {
                        result = '‚ö†Ô∏è Uprchl√≠k se vr√°til s bandity! P≈ôiprav se na n√°jezd!';
                        resultType = 'danger';
                        setTimeout(() => startSettlementRaid(), 2000);
                    } else {
                        result = 'Uprchl√≠k ode≈°el.';
                    }
                    break;
                    
                // DOG
                case 'dog_adopt':
                    if (!state.settlement.dog) {
                        state.settlement.dog = { name: 'Rex', defense: 5, adopted: Date.now() };
                        state.settlement.resources.food = Math.max(0, state.settlement.resources.food - 5);
                        result = 'üêï Rex je teƒè str√°≈æn√≠ pes osady! (+5 obrana)';
                        resultType = 'success';
                    } else {
                        result = 'U≈æ m√°≈° psa!';
                    }
                    break;
                case 'dog_feed':
                    state.settlement.resources.food = Math.max(0, state.settlement.resources.food - 3);
                    if (Math.random() < 0.5) {
                        result = 'Pes odbƒõhl... ale mo≈æn√° se vr√°t√≠!';
                        state.settlement.dogReturn = Date.now() + 3 * 24 * 60 * 60 * 1000;
                    } else {
                        result = 'Pes spokojenƒõ odbƒõhl.';
                    }
                    break;
                case 'dog_ignore':
                    state.settlement.morale = Math.max(0, state.settlement.morale - 5);
                    result = 'Osadn√≠ci jsou smutn√≠ ≈æe jsi psa vyhnal. (-5 morale)';
                    resultType = 'warning';
                    break;
                    
                // MYSTERY TRADER
                case 'mystery_accept':
                    if (state.money >= 100) {
                        state.money -= 100;
                        if (state.settlement.mysteryOffer === 'good') {
                            const goodItems = ['legendary_weapon', 'rare_armor', 'crystal'];
                            const item = goodItems[Math.floor(Math.random() * goodItems.length)];
                            state.resources[item] = (state.resources[item] || 0) + 1;
                            result = `üéâ Skvƒõl√Ω obchod! Dostal jsi ${item}!`;
                            resultType = 'success';
                        } else {
                            result = 'üò± Podvod! Dostal jsi jen kameny...';
                            resultType = 'danger';
                        }
                    } else {
                        result = ('Nem√°≈° dost penƒõz!');
                        resultType = 'warning';
                    }
                    break;
                case 'mystery_reject':
                    result = 'Z√°hadn√° postava zmizela v noci...';
                    break;
                    
                // WOUNDED
                case 'wounded_help':
                    const hasMedkit = state.inv.find(i => i.id === 'medkit');
                    if (hasMedkit) {
                        hasMedkit.count = (hasMedkit.count || 1) - 1;
                        if (hasMedkit.count <= 0) state.inv = state.inv.filter(i => i.id !== 'medkit');
                        if (Math.random() < 0.7) {
                            const reward = Math.floor(Math.random() * 150) + 50;
                            addMoney(reward);
                            result = `Cizinec se uzdravil a dal ti ${reward} üí∞ jako podƒõkov√°n√≠!`;
                            resultType = 'success';
                            state.settlement.morale = Math.min(100, state.settlement.morale + 10);
                        } else {
                            result = 'Cizinec zem≈ôel... ale osadn√≠ci oce≈àuj√≠ tvou snahu. (+morale)';
                            state.settlement.morale = Math.min(100, state.settlement.morale + 5);
                        }
                    } else {
                        result = 'Nem√°≈° medkit!';
                        resultType = 'warning';
                    }
                    break;
                case 'wounded_loot':
                    const lootMoney = Math.floor(Math.random() * 50) + 10;
                    addMoney(lootMoney);
                    state.settlement.morale = Math.max(0, state.settlement.morale - 15);
                    result = `Na≈°el jsi ${lootMoney} üí∞... ale osadn√≠ci tƒõ odsuzuj√≠. (-15 morale)`;
                    resultType = 'warning';
                    break;
                case 'wounded_ignore':
                    result = 'Ode≈°el jsi...';
                    break;
                    
                // BANDIT
                case 'bandit_pay':
                    if (state.money >= 50) {
                        state.money -= 50;
                        state.settlement.banditProtection = Date.now() + 7 * 24 * 60 * 60 * 1000;
                        result = 'Zaplatil jsi v√Ωpaln√©. T√Ωden klid od n√°jezd≈Ø.';
                    } else {
                        result = 'Nem√°≈° dost! Bandita se na≈°tval!';
                        resultType = 'danger';
                        setTimeout(() => startSettlementRaid(), 2000);
                    }
                    break;
                case 'bandit_fight':
                    result = '‚öîÔ∏è Bandita zavolal posily! P≈ôiprav se na boj!';
                    resultType = 'danger';
                    setTimeout(() => startSettlementRaid(), 1000);
                    break;
                case 'bandit_trick':
                    if (state.char.attrs.int >= 7) {
                        addMoney(50);
                        result = 'üé≠ P≈ôelstil jsi ho! Ukradl jsi MU pen√≠ze! (+50 üé´)';
                        resultType = 'success';
                    } else {
                        result = 'Nepoda≈ôilo se... bandita prohl√©dl tv≈Øj trik!';
                        resultType = 'danger';
                        setTimeout(() => startSettlementRaid(), 2000);
                    }
                    break;
                    
                // CHILD
                case 'child_adopt':
                    state.settlement.morale = Math.min(100, state.settlement.morale + 20);
                    state.settlement.child = { name: 'Mal√Ω ' + generateSettlerName().split(' ')[0], adopted: Date.now() };
                    result = 'üë∂ D√≠tƒõ m√° nov√Ω domov! Osadn√≠ci jsou dojat√≠. (+20 morale)';
                    resultType = 'success';
                    break;
                case 'child_send':
                    result = 'Poslal jsi d√≠tƒõ k bezpeƒçnƒõj≈°√≠m obchodn√≠k≈Øm.';
                    state.settlement.morale = Math.min(100, state.settlement.morale + 5);
                    break;
                    
                // DISPUTE
                case 'dispute_first':
                case 'dispute_second':
                    state.settlement.morale = Math.max(0, state.settlement.morale - 5);
                    result = 'Rozhodl jsi spor. Jeden osadn√≠k je nespokojen√Ω. (-5 morale)';
                    resultType = 'warning';
                    break;
                case 'dispute_split':
                    state.settlement.morale = Math.min(100, state.settlement.morale + 5);
                    result = 'Spravedliv√© rozdƒõlen√≠! Oba jsou spokojen√≠. (+5 morale)';
                    resultType = 'success';
                    break;
                    
                // SCAVENGER BOX
                case 'scavenger_open':
                    if (Math.random() < 0.6) {
                        const treasures = ['metal', 'electronics', 'chemicals', 'fuel'];
                        const t = treasures[Math.floor(Math.random() * treasures.length)];
                        const amt = Math.floor(Math.random() * 15) + 5;
                        state.resources[t] = (state.resources[t] || 0) + amt;
                        result = `üì¶ Poklad! +${amt} ${t}!`;
                        resultType = 'success';
                    } else {
                        const damage = 20;
                        const oldHp = state.char.hp;
                        state.char.hp = Math.max(1, state.char.hp - damage);
                        result = `üí• Past! Exploze ti ubl√≠≈æila! (-${damage} HP, ${oldHp} ‚Üí ${state.char.hp})`;
                        resultType = 'danger';
                        // Vizu√°ln√≠ efekt
                        if (typeof screenShake === 'function') screenShake(5, 200);
                        if (typeof showFloatingNumber === 'function') showFloatingNumber(damage, 'damage');
                        SoundSystem.play('damage');
                    }
                    break;
                case 'scavenger_sell':
                    addMoney(50);
                    result = 'Prodal jsi bednu za 50 üé´. Jistota je jistota.';
                    break;
                case 'scavenger_careful':
                    if (state.char.attrs.int >= 6) {
                        const isGood = Math.random() < 0.7;
                        if (isGood) {
                            const amt = Math.floor(Math.random() * 20) + 10;
                            state.resources.metal = (state.resources.metal || 0) + amt;
                            result = `üîç Opatrnƒõ jsi ji otev≈ôel. +${amt} kov!`;
                            resultType = 'success';
                        } else {
                            result = 'üîç Zjistil jsi ≈æe je to past a vyhodil jsi ji.';
                        }
                    } else {
                        result = 'Tv√° inteligence nestaƒç√≠ na bezpeƒçn√© prozkoum√°n√≠...';
                        resultType = 'warning';
                    }
                    break;
            }
            
            // Zobraz v√Ωsledek
            if (result) {
                const color = resultType === 'success' ? '#8bc34a' : resultType === 'danger' ? '#c62828' : resultType === 'warning' ? '#ff9800' : '#888';
                notifySuccess('V√Ωsledek', result);
                addLog(result, 'üìã');
            }
            
            renderFull();
        }
        
        // P≈ôivol√°n√≠ karavany za pen√≠ze
        function summonCaravan() {
            // Kontrola otev√≠rac√≠ doby - karavana cestuje v noci
            if (!isShopOpen('caravan')) {
                showModal('üåô Karavana cestuje', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üê™üåô</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Karavana je na cestƒõ!</p>
                        <p style="color: #888; margin: 1rem 0;">Obchodn√≠ci cestuj√≠ v noci a nelze je p≈ôivolat.</p>
                        <p style="color: #666; font-size: 0.9rem;">‚è∞ Dostupn√°: 08:00 - 20:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu√°ln√≠ ƒças: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const cost = 100;
            const hasCommTower = state.base?.includes('comms') || state.settlement?.buildings?.includes('comms');
            const hasPowerForTower = hasCommTower && hasPower();
            
            const caravanTexts = {
                inArea: 'Karavana je v oblasti!', remaining: 'Zb√Ωv√°', minutes: 'minut',
                noCaravan: '≈Ω√°dn√° karavana v osadƒõ', canSummon: 'M≈Ø≈æe≈° p≈ôivolat karavanu nebo poƒçkat na n√°hodnou n√°v≈°tƒõvu.',
                howWork: 'Jak funguj√≠ karavany', autoSpawn: 'Automatick√Ω spawn', chanceEvery: '≈°ance ka≈æd√Ωch', minutesWord: 'minut',
                randomEvent: 'Random event', chanceWhile: '≈°ance p≈ôi cestov√°n√≠',
                radio: 'Vys√≠laƒçka', summonFor: 'P≈ôivol√°n√≠ na', paid: 'Zaplacen√≠', hour: '1 hodinu',
                bonusChance: 'Bonusy k ≈°anci', contactNetwork: 'S√≠≈• kontakt≈Ø', tradeStation: 'Obchodn√≠ stanice',
                traderBonuses: 'Bonusy obchodn√≠ka', discount: 'Sleva na n√°kup', cheaperGoods: '20-25% levnƒõj≈°√≠ zbo≈æ√≠',
                specialGoods: 'Speci√°ln√≠ zbo≈æ√≠', rareItems: 'vz√°cn√© p≈ôedmƒõty', reputation: 'Reputace', improvesTrade: 'zlep≈°uje vztahy s Obchodn√≠ gildou',
                summonCaravan: 'P≈ôivolat karavanu', commTower: 'Komunikaƒçn√≠ vƒõ≈æ', built: 'postavena', missing: 'chyb√≠',
                power: 'Elekt≈ôina pro vƒõ≈æ', working: 'funguje', noPower: 'bez proudu!',
                money: 'penƒõz', youHave: 'm√°≈°', youHaveOnly: 'm√°≈° jen',
                buildTip: 'Postav Komunikaƒçn√≠ vƒõ≈æ v sekci Budovy (level 4).',
                powerTip: 'Vƒõ≈æ pot≈ôebuje 2‚ö°. Postav Gener√°tor nebo Sol√°rn√≠ panely.',
                traderRep: 'Reputace s Obchodn√≠ gildou', visitCaravan: 'Nav≈°t√≠vit karavanu', summonBtn: 'P≈ôivolat karavanu'
            };
            
            // Zkontroluj obƒõ varianty karavany
            const caravanActive = (state.caravan?.active && Date.now() < state.caravan.until) || 
                                  (state.settlement.visitingMerchant && Date.now() < state.settlement.visitingMerchant.until);
            const caravanUntil = state.caravan?.active ? state.caravan.until : state.settlement.visitingMerchant?.until;
            const timeRemaining = caravanActive ? Math.floor((caravanUntil - Date.now()) / 60000) : 0; // minuty
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Hlavn√≠ ikona
            html += '<div style="text-align: center; margin-bottom: 1rem;">';
            html += '<div style="font-size: 4rem;">üê™</div>';
            html += '</div>';
            
            // Status karavany
            if (caravanActive) {
                html += `
                    <div style="background: linear-gradient(135deg, #1a2a1a 0%, #0d150d 100%); padding: 1rem; border-radius: 10px; border: 2px solid #4caf50; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 1.5rem; color: #8bc34a; font-weight: bold;">‚úÖ ${caravanTexts.inArea}</div>
                        <p style="margin: 0.5rem 0 0 0; color: #aaa;">${caravanTexts.remaining}: <strong style="color: #ffd700;">${timeRemaining} ${caravanTexts.minutes}</strong></p>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: linear-gradient(135deg, #2a2a1a 0%, #15150d 100%); padding: 1rem; border-radius: 10px; border: 2px solid #7c6a4a; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 1.2rem; color: #ff9800;">‚ùå ${caravanTexts.noCaravan}</div>
                        <p style="margin: 0.5rem 0 0 0; color: #888;">${caravanTexts.canSummon}</p>
                    </div>
                `;
            }
            
            // Info o syst√©mu
            html += '<h4 style="color: var(--toxic-green); margin: 1rem 0 0.5rem 0;">üìä ' + caravanTexts.howWork + '</h4>';
            html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem;">';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>‚è∞ ' + caravanTexts.autoSpawn + ':</strong> <span style="color: #ffd700;">20%</span> ' + caravanTexts.chanceEvery + ' 24 hodin</p>';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>üé≤ ' + caravanTexts.randomEvent + ':</strong> <span style="color: #ffd700;">10%</span> ' + caravanTexts.chanceWhile + '</p>';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>üì° ' + caravanTexts.radio + ':</strong> ' + caravanTexts.summonFor + ' 10 ' + caravanTexts.minutesWord + '</p>';
            html += '<p style="margin: 0 0 0.5rem 0;"><strong>üí∞ ' + caravanTexts.paid + ':</strong> ' + caravanTexts.summonFor + ' ' + caravanTexts.hour + '</p>';
            html += '<p style="margin: 0; border-top: 1px solid #333; padding-top: 0.5rem; color: #888;"><strong>' + caravanTexts.bonusChance + ':</strong></p>';
            html += '<p style="margin: 0.3rem 0 0 0; font-size: 0.8rem;">üèπ Scout lvl 4: +10% | üì± ' + caravanTexts.contactNetwork + ': +20% | üè™ ' + caravanTexts.tradeStation + ': +15%</p>';
            html += '</div>';
            
            // Bonusy od karavany
            html += '<h4 style="color: var(--warning-yellow); margin: 1rem 0 0.5rem 0;">üéÅ ' + caravanTexts.traderBonuses + '</h4>';
            html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">';
            html += '<p style="margin: 0 0 0.3rem 0;">üí∞ <strong>' + caravanTexts.discount + '</strong> - ' + caravanTexts.cheaperGoods + '</p>';
            html += '<p style="margin: 0 0 0.3rem 0;">üì¶ <strong>' + caravanTexts.specialGoods + '</strong> - ' + caravanTexts.rareItems + '</p>';
            html += '<p style="margin: 0;">üè™ <strong>' + caravanTexts.reputation + '</strong> - ' + caravanTexts.improvesTrade + '</p>';
            html += '</div>';
            
            // P≈ôivol√°n√≠ karavany
            html += '<h4 style="color: #64b5f6; margin: 1rem 0 0.5rem 0;">üì° ' + caravanTexts.summonCaravan + '</h4>';
            html += '<div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
            
            // Checklist po≈æadavk≈Ø
            html += '<div style="margin-bottom: 0.8rem;">';
            html += `<p style="margin: 0 0 0.3rem 0; color: ${hasCommTower ? '#8bc34a' : '#c62828'};">${hasCommTower ? '‚úÖ' : '‚ùå'} ${caravanTexts.commTower} ${hasCommTower ? '(' + caravanTexts.built + ')' : '(' + caravanTexts.missing + ')'}</p>`;
            if (hasCommTower) {
                html += `<p style="margin: 0 0 0.3rem 0; color: ${hasPowerForTower ? '#8bc34a' : '#c62828'};">${hasPowerForTower ? '‚úÖ' : '‚ùå'} ${caravanTexts.power} ${hasPowerForTower ? '(' + caravanTexts.working + ')' : '(' + caravanTexts.noPower + ')'}</p>`;
            }
            html += `<p style="margin: 0; color: ${getMoney() >= cost ? '#8bc34a' : '#c62828'};">${getMoney() >= cost ? '‚úÖ' : '‚ùå'} ${cost} ${caravanTexts.money} ${getMoney() >= cost ? '(' + caravanTexts.youHave + ' ' + getMoney() + ')' : '(' + caravanTexts.youHaveOnly + ' ' + getMoney() + ')'}</p>`;
            html += '</div>';
            
            if (!hasCommTower) {
                html += '<p style="color: #ff9800; font-size: 0.85rem; margin: 0;">üí° ' + caravanTexts.buildTip + '</p>';
            } else if (!hasPowerForTower) {
                html += '<p style="color: #ff9800; font-size: 0.85rem; margin: 0;">üí° ' + caravanTexts.powerTip + '</p>';
            }
            
            html += '</div>';
            
            // Reputace s obchodn√≠ky
            const traderRep = getReputation('traders');
            const traderLevel = getReputationLevel('traders');
            html += '<h4 style="color: #ffd700; margin: 1rem 0 0.5rem 0;">üè™ ' + caravanTexts.traderRep + '</h4>';
            html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">`;
            html += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
            html += `<span style="color: ${traderLevel.color};">${traderLevel.icon} ${traderLevel.name}</span>`;
            html += `<span style="color: #888;">${traderRep > 0 ? '+' : ''}${traderRep}/100</span>`;
            html += `</div>`;
            html += `<div style="height: 6px; background: #0a0a0a; border-radius: 3px; margin-top: 0.5rem; overflow: hidden;">`;
            html += `<div style="height: 100%; width: ${((traderRep + 100) / 200) * 100}%; background: linear-gradient(90deg, #8B0000, #f44336, #ff9800, #4caf50, #ffd700);"></div>`;
            html += `</div>`;
            if (traderLevel.id === 'friendly' || traderLevel.id === 'allied') {
                html += `<p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #8bc34a;">${getFactionBonusText('traders')}</p>`;
            }
            html += '</div>';
            
            html += '</div>';
            
            // Tlaƒç√≠tka
            let buttons = '';
            if (caravanActive) {
                buttons = '<button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-bottom: 0.5rem; background: var(--toxic-dark);">üõí ' + caravanTexts.visitCaravan + '</button>';
                buttons += '<button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">' + ('Zav≈ô√≠t') + '</button>';
            } else {
                const canSummon = hasCommTower && hasPowerForTower && getMoney() >= cost;
                buttons = `<button class="btn" onclick="doSummonCaravan()" ${!canSummon ? 'disabled' : ''} style="width: 100%; margin-bottom: 0.5rem; ${!canSummon ? 'opacity: 0.5;' : 'background: var(--rust);'}">üê™ ${caravanTexts.summonBtn} (${cost} üí∞)</button>`;
                buttons += '<button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">' + ('Zav≈ô√≠t') + '</button>';
            }
            
            showModal('üê™ Obchodn√≠ karavana', html + buttons);
        }
        
        function doSummonCaravan() {
            // Kontrola otev√≠rac√≠ doby
            if (!isShopOpen('caravan')) {
                notifyWarning('Karavana cestuje', 'Zkus to mezi 08:00 a 20:00');
                return;
            }
            
            const cost = 100;
            const hasCommTower = state.base?.includes('comms') || state.settlement?.buildings?.includes('comms');
            
            if (!hasCommTower || !hasPower() || getMoney() < cost) return;
            
            removeMoney(cost);
            
            // Pou≈æij glob√°ln√≠ karavana syst√©m
            state.caravan = state.caravan || { active: false, until: 0, lastCheck: Date.now() };
            state.caravan.active = true;
            state.caravan.until = Date.now() + 60 * 60 * 1000; // 1 hodina (del≈°√≠ proto≈æe zaplacena)
            
            // Pro zpƒõtnou kompatibilitu
            state.settlement.visitingMerchant = {
                until: state.caravan.until,
                discount: 0.25
            };
            
            changeReputation('traders', 3, 'p≈ôivol√°n√≠ karavany');
            
            closeModal();
            showModal('üê™ Karavana dorazila!', 
                '<div style="text-align: center;">' +
                '<div style="font-size: 4rem;">üê™</div>' +
                '<h3 style="color: #8bc34a;">Obchodn√≠ karavana je zde!</h3>' +
                '<p style="color: #ffd700;">Speci√°ln√≠ sleva 25% na v≈°e!</p>' +
                '<p style="color: #888;">Z≈Østane 1 hodinu.</p>' +
                '</div>' +
                '<button class="btn" onclick="closeModal(); openCaravanShop();" style="width: 100%; margin-top: 1rem; background: var(--toxic-dark);">üõí Otev≈ô√≠t obchod</button>'
            );
            
            addLog('üê™ P≈ôivol√°na obchodn√≠ karavana!', 'üê™');
            renderFull();
        }
        
        function generateSettlerName() {
            const names = ['Adam', 'Eva', 'Jan', 'Marie', 'Petr', 'Anna', 'Pavel', 'Lucie', 'Tom√°≈°', 'Kate≈ôina', 
                          'Martin', 'Tereza', 'Jakub', 'Mark√©ta', 'David', 'Veronika', 'Filip', 'Michaela',
                          'Ond≈ôej', 'Barbora', 'Marek', 'Simona', 'Luk√°≈°', 'Petra', 'Matƒõj', 'Nikola'];
            return names[Math.floor(Math.random() * names.length)];
        }
        
        // === N√ÅPOVƒöDA OSADY ===
        // Oprava u kov√°≈ôe v osadƒõ (zdarma)
        function repairAtBlacksmith() {
            // Kontrola jestli jsme v osadƒõ
            const currentLoc = state.world?.currentLocation || '';
            const inSettlement = currentLoc === 'shelter' || currentLoc === 'settlement';
            if (!inSettlement) {
                showModal('‚ùå Mus√≠≈° b√Ωt v osadƒõ', 'Kov√°≈ô je v osadƒõ. Vra≈• se do osady, abys mohl opravit vybaven√≠.');
                return;
            }
            
            // Kontrola jestli m√°me kov√°≈ôe
            const hasBlacksmith = state.settlement?.settlers?.some(s => s.type === 'blacksmith');
            if (!hasBlacksmith) {
                showModal('‚ùå Chyb√≠ kov√°≈ô', 'Nem√°≈° kov√°≈ôe v osadƒõ! Najmi si ho za 1200 üí∞.');
                return;
            }
            
            // Najdi po≈°kozen√© vybaven√≠
            const damagedItems = [];
            if (state.equipped?.weapon?.durability < state.equipped?.weapon?.maxDurability) {
                damagedItems.push({ item: state.equipped.weapon, type: 'equipped', slot: 'weapon' });
            }
            if (state.equipped?.armor?.durability < state.equipped?.armor?.maxDurability) {
                damagedItems.push({ item: state.equipped.armor, type: 'equipped', slot: 'armor' });
            }
            state.inv.forEach((item, idx) => {
                if (item.durability !== undefined && item.durability < item.maxDurability) {
                    damagedItems.push({ item, type: 'inventory', index: idx });
                }
            });
            
            if (damagedItems.length === 0) {
                showModal('‚öíÔ∏è Kov√°≈ô', '‚úÖ Ve≈°ker√© vybaven√≠ je v po≈ô√°dku!<br><br><span style="color: #888;">Kov√°≈ô nem√° co opravovat.</span>');
                return;
            }
            
            let content = `
                <p style="color: #8bc34a; margin-bottom: 1rem;">üÜì Oprava zdarma d√≠ky kov√°≈ôi!</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            `;
            
            damagedItems.forEach((di, idx) => {
                content += `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px;">
                        <span>${di.item.icon} ${di.item.name}</span>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: #ff9800;">${di.item.durability}/${di.item.maxDurability}</span>
                            <button class="btn" onclick="repairFreeBlacksmith(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4CAF50;">
                                Opravit
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            content += `
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="repairAllBlacksmith()" style="flex: 1; background: #2196f3;">üîß Opravit v≈°e</button>
                    <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">‚Üê Zav≈ô√≠t</button>
                </div>
            `;
            
            window._blacksmithDamagedItems = damagedItems;
            showModal('‚öíÔ∏è Kov√°≈ô - Oprava', content);
        }
        
        function repairFreeBlacksmith(damagedIndex) {
            if (!window._blacksmithDamagedItems) return;
            const di = window._blacksmithDamagedItems[damagedIndex];
            if (!di) return;
            
            di.item.durability = di.item.maxDurability;
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('‚öíÔ∏è Opraveno!', `${di.item.icon} ${di.item.name}<br><span style="color: #8bc34a;">Pln√° trvanlivost!</span>`);
            delete window._blacksmithDamagedItems;
            renderFull();
        }
        
        function repairAllBlacksmith() {
            if (!window._blacksmithDamagedItems) return;
            
            let count = 0;
            window._blacksmithDamagedItems.forEach(di => {
                di.item.durability = di.item.maxDurability;
                count++;
            });
            
            SoundSystem.play('pickup');
            closeModal();
            showModal('‚öíÔ∏è V≈°e opraveno!', `üîß Opraveno ${count} p≈ôedmƒõt≈Ø!<br><span style="color: #8bc34a;">V≈°e m√° plnou trvanlivost.</span>`);
            delete window._blacksmithDamagedItems;
            renderFull();
        }
        
        // L√©ƒçen√≠ u medika v osadƒõ
        function healAtMedic() {
            // Kontrola jestli je hr√°ƒç v osadƒõ
            const inBase = state.world?.currentLocation === 'shelter' || state.world?.currentLocation === 'settlement' || state.map?.inBase;
            if (!inBase) {
                showModal('‚ùå P≈ô√≠li≈° daleko', 'Mus√≠≈° b√Ωt v osadƒõ, aby tƒõ medik mohl o≈°et≈ôit!');
                return;
            }
            
            const hasMedic = state.settlement?.settlers?.some(s => s.type === 'medic_s');
            if (!hasMedic) {
                showModal('‚ùå Chyb√≠ medik', 'Nem√°≈° medika v osadƒõ! Najmi si ho za 1000 üí∞.');
                return;
            }
            
            if (state.char.hp >= state.char.maxHp) {
                showModal('‚öïÔ∏è Medik', '‚úÖ Jsi zcela zdrav√Ω!<br><br><span style="color: #888;">Medik nem√° co l√©ƒçit.</span>');
                return;
            }
            
            const healAmount = Math.floor(state.char.maxHp * 0.5); // 50% max HP
            const actualHeal = Math.min(healAmount, state.char.maxHp - state.char.hp);
            state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
            
            SoundSystem.play('pickup');
            showFloatingNumber(actualHeal, 'heal');
            showModal('‚öïÔ∏è Medik', `Medik tƒõ o≈°et≈ôil!<br><span style="color: #8bc34a;">‚ù§Ô∏è +${actualHeal} HP</span><br><br><span style="color: #888;">HP: ${state.char.hp}/${state.char.maxHp}</span>`);
            renderFull();
        }
        
        // Obchod v osadƒõ
        function tradeAtSettlement() {
            // Obchodn√≠k v osadƒõ funguje i vzd√°lenƒõ - prodej/n√°kup jde p≈ôes sklad osady
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            // Kontrola otev√≠rac√≠ doby
            if (!isShopOpen('settlement')) {
                showModal('üåô Zav≈ôeno', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üò¥</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">Obchodn√≠k sp√≠!</p>
                        <p style="color: #888; margin: 1rem 0;">‚è∞ Otev√≠rac√≠ doba: 06:00 - 22:00</p>
                        <p style="color: #666; font-size: 0.9rem;">Aktu√°ln√≠ ƒças: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const hasTrader = state.settlement?.settlers?.some(s => s.type === 'trader_s');
            if (!hasTrader) {
                showModal('‚ùå Chyb√≠ obchodn√≠k', 'Nem√°≈° obchodn√≠ka v osadƒõ! Najmi si ho za 1500 üí∞.');
                return;
            }
            
            // Generuj zbo≈æ√≠ pokud nem√°me nebo je star√Ω
            if (!state.settlementShop || !state.settlementShop.items || state.settlementShop.day !== state.time.days) {
                generateSettlementShop();
            }
            
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25; // +25% ceny p≈ôi prodeji
            const buyDiscount = 0.9; // -10% ceny p≈ôi n√°kupu
            
            let content = `
                <p style="color: #8bc34a; margin-bottom: 0.5rem;">üí∞ Pen√≠ze: ${getMoney()}</p>
                <p style="color: #ff9800; font-size: 0.85rem; margin-bottom: 0.5rem;">üè∑Ô∏è Obchodn√≠k: +25% prodej, -10% n√°kup!</p>
                
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('shopHoursInfo').style.display = document.getElementById('shopHoursInfo').style.display === 'none' ? 'block' : 'none'">
                        <span style="color: #888; font-size: 0.8rem;">üïê Otev√≠rac√≠ doby obchod≈Ø</span>
                        <span style="color: #666; font-size: 0.7rem;">‚ñº</span>
                    </div>
                    <div id="shopHoursInfo" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                        <div style="display: grid; gap: 0.3rem; font-size: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('settlement') ? '#8bc34a' : '#666'};">
                                <span>üõí Obchod v osadƒõ</span><span>06:00 - 22:00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('caravan') ? '#8bc34a' : '#666'};">
                                <span>üê™ Karavana</span><span>08:00 - 20:00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('military') ? '#8bc34a' : '#666'};">
                                <span>üéñÔ∏è Vojensk√Ω tr√©nink</span><span>06:00 - 18:00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('mutants') ? '#8bc34a' : '#666'};">
                                <span>‚ò£Ô∏è Mutant√≠ trh</span><span>20:00 - 06:00 üåô</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: #8bc34a;">
                                <span>üß™ Laborato≈ô vƒõdc≈Ø</span><span>non-stop ‚úì</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('wandering') ? '#8bc34a' : '#666'};">
                                <span>üê™ Potuln√Ω obchodn√≠k</span><span>10:00 - 16:00</span>
                            </div>
                        </div>
                        <p style="color: #555; font-size: 0.7rem; margin: 0.5rem 0 0 0; text-align: center;">Aktu√°ln√≠ ƒças: ${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showSettlementShopBuy()" style="flex: 1; background: #2e7d32;">${'üõí Koupit'}</button>
                    <button class="btn" onclick="showSettlementShopSell()" style="flex: 1; background: #ff9800;">${'üí∞ Prodat'}</button>
                </div>
                
                <div id="settlementShopContent">
                    <p style="color: #888; text-align: center;">Vyber akci...</p>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="flex: 1; background: #555;">‚Üê Zav≈ô√≠t</button>
                    ${(() => {
                        const lastRefresh = state.lastShopRefresh || 0;
                        const canRefresh = Date.now() - lastRefresh > 24 * 60 * 60 * 1000;
                        if (canRefresh) {
                            return '<button class="btn" onclick="forceRefreshSettlementShop()" style="padding: 0.5rem; background: #2196f3;" title="Obnovit sortiment (1x za 24h)">üîÑ</button>';
                        } else {
                            const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastRefresh)) / 3600000);
                            return '<button class="btn" style="padding: 0.5rem; background: #333; opacity: 0.6;" disabled title="Dal≈°√≠ refresh za ' + hoursLeft + 'h">üîÑ ' + hoursLeft + 'h</button>';
                        }
                    })()}
                </div>
            `;
            
            showModal('üí∞ Osadn√≠ obchod', content);
        }
        
        function forceRefreshSettlementShop() {
            const lastRefresh = state.lastShopRefresh || 0;
            if (Date.now() - lastRefresh < 24 * 60 * 60 * 1000) {
                const hoursLeft = Math.ceil((24 * 60 * 60 * 1000 - (Date.now() - lastRefresh)) / 3600000);
                notifyWarning('‚è≥ Poƒçkej', `Dal≈°√≠ refresh za ${hoursLeft}h`);
                return;
            }
            
            state.lastShopRefresh = Date.now();
            state.settlementShop = null;
            generateSettlementShop();
            closeModal();
            openSettlementShop();
            notifySuccess('üîÑ Obchod obnoven', 'Nov√Ω sortiment!');
        }
        
        function generateSettlementShop() {
            // Generuj n√°hodn√© zbo≈æ√≠
            const possibleItems = ITEMS.filter(i => i.price && i.price > 0 && i.price < 500 && !i.cantBuy);
            const shopItems = [];
            
            // Vyber 8-12 n√°hodn√Ωch polo≈æek
            const count = 8 + Math.floor(Math.random() * 5);
            for (let i = 0; i < count && possibleItems.length > 0; i++) {
                const idx = Math.floor(Math.random() * possibleItems.length);
                const item = possibleItems.splice(idx, 1)[0];
                shopItems.push({
                    ...item,
                    stock: 1 + Math.floor(Math.random() * 3) // 1-3 kus≈Ø
                });
            }
            
            state.settlementShop = {
                items: shopItems,
                day: state.time.days
            };
        }
        
        function showSettlementShopBuy() {
            let buyDiscount = 0.9; // Z√°kladn√≠ sleva v osadƒõ
            
            // Sleva od Obchodn√≠ gildy
            const tradersRep = state.factions?.traders || 0;
            if (tradersRep >= 100) {
                buyDiscount *= 0.6; // Spojenec: -40%
            } else if (tradersRep >= 50) {
                buyDiscount *= 0.8; // P≈ô√°telsk√Ω: -20%
            }
            
            let html = '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            if (!state.settlementShop?.items?.length) {
                html += '<p style="color: #666; text-align: center;">Obchod je pr√°zdn√Ω. P≈ôijƒè z√≠tra!</p>';
            } else {
                state.settlementShop.items.forEach((item, idx) => {
                    const price = Math.floor((item.price || 10) * buyDiscount);
                    const canBuy = getMoney() >= price && item.stock > 0;
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.3rem;">
                            <div>
                                <span style="font-size: 1.2rem;">${item.icon}</span>
                                <span style="font-size: 0.85rem;">${item.name}</span>
                                <span style="color: #888; font-size: 0.7rem;">(${item.stock}x)</span>
                            </div>
                            <button class="btn" onclick="buyFromSettlement(${idx})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: ${canBuy ? '#2e7d32' : '#444'};" ${canBuy ? '' : 'disabled'}>
                                üí∞${price}
                            </button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('settlementShopContent').innerHTML = html;
        }
        
        function showSettlementShopSell() {
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25;
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            let html = '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Info o re≈æimu
            if (!isInShelter) {
                html += '<p style="color: #ff9800; font-size: 0.8rem; text-align: center; margin-bottom: 0.5rem;">üì¶ Prod√°v√°≈° ze skladu osady (nejsi v osadƒõ)</p>';
            }
            
            // Pomocn√° funkce pro z√≠sk√°n√≠ ceny itemu
            const getItemPrice = (item) => {
                if (item.price && item.price > 0) return item.price;
                const itemDef = ITEMS.find(i => i.id === item.id);
                return itemDef?.price || 0;
            };
            
            // Zdroj vƒõc√≠ - invent√°≈ô kdy≈æ v osadƒõ, sklad osady kdy≈æ mimo
            const sourceItems = isInShelter ? state.inv : (state.baseItems || []);
            const sourceType = isInShelter ? 'inv' : 'base';
            
            // Prodejn√© vƒõci
            const sellableItems = sourceItems.filter(i => getItemPrice(i) > 0 && !isItemEquipped(i) && !i.fromCaravan && !i.fromShop);
            const lockedItems = sourceItems.filter(i => getItemPrice(i) > 0 && !isItemEquipped(i) && (i.fromCaravan || i.fromShop));
            
            if (sellableItems.length === 0 && lockedItems.length === 0) {
                html += `<p style="color: #666; text-align: center;">${isInShelter ? 'Nem√°≈° nic na prodej.' : 'Sklad osady je pr√°zdn√Ω.'}</p>`;
            } else {
                sellableItems.forEach((item) => {
                    let sellPrice = Math.floor(getItemPrice(item) * 0.35 * traderBonus);
                    
                    if (item.durability !== undefined && item.maxDurability) {
                        const durabilityRatio = item.durability / item.maxDurability;
                        sellPrice = Math.floor(sellPrice * durabilityRatio);
                        if (sellPrice < 1) sellPrice = 1;
                    }
                    
                    const realIdx = sourceItems.indexOf(item);
                    
                    let specialInfo = '';
                    const itemData = ITEMS.find(i => i.id === item.id) || item;
                    if (itemData.special || item.special) {
                        const specialName = itemData.special || item.special;
                        const specialLabels = {
                            'speed_bonus': 'üèÉ+10% rychlost',
                            'dodge_bonus': 'üí®+10% √∫hyb',
                            'combat_stance': '‚öîÔ∏è+5% krit',
                            'light_feet': 'üèÉ+5% rychlost',
                            'stealth_move': 'ü•∑-20% p≈ôepaden√≠',
                            'run_bonus': 'üèÉ+15% √∫tƒõk',
                            'stomp': 'ü¶∂+8 damage',
                            'jump': 'ü¶ò+25% dodge',
                            'warm_feet': '‚ùÑÔ∏è-15% energie',
                            'power_kick': '‚ö°+20% rychlost',
                            'exo': 'üí™+50% nosnost',
                            'sturdy': 'üõ°Ô∏è+2 DEF'
                        };
                        specialInfo = specialLabels[specialName] || specialName;
                    }
                    
                    let durabilityInfo = '';
                    if (item.durability !== undefined) {
                        const durColor = item.durability < 30 ? '#f44336' : item.durability < 60 ? '#ff9800' : '#4caf50';
                        durabilityInfo = `<span style="color: ${durColor}; font-size: 0.7rem;">[${item.durability}%]</span>`;
                    }
                    
                    let statsInfo = '';
                    if (item.defense) statsInfo += `üõ°Ô∏è${item.defense} `;
                    if (item.damage) statsInfo += `‚öîÔ∏è${item.damage} `;
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.3rem;">
                            <div style="flex: 1;">
                                <div>
                                    <span style="font-size: 1.1rem;">${item.icon}</span>
                                    <span style="font-size: 0.85rem;">${item.name}</span>
                                    ${item.count > 1 ? '<span style="color: #888; font-size: 0.75rem;"> x' + item.count + '</span>' : ''}
                                    ${durabilityInfo}
                                </div>
                                <div style="font-size: 0.7rem; color: #888;">
                                    ${statsInfo}${specialInfo ? '<span style="color: #8bc34a;">' + specialInfo + '</span>' : ''}
                                </div>
                            </div>
                            <button class="btn" onclick="sellAtSettlement(${realIdx}, '${sourceType}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #ff9800;">
                                üí∞${sellPrice}
                            </button>
                        </div>
                    `;
                });
                
                if (lockedItems.length > 0) {
                    html += `<div style="border-top: 1px solid #444; margin-top: 0.5rem; padding-top: 0.5rem;">
                        <p style="color: #666; font-size: 0.75rem; text-align: center; margin-bottom: 0.3rem;">üîí Nelze p≈ôeprodat obchodn√≠kovi:</p>`;
                    lockedItems.forEach((item) => {
                        const lockReason = item.fromCaravan ? 'üê™ karavana' : 'üõí koupeno';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.2rem; opacity: 0.6;">
                                <div>
                                    <span style="font-size: 1rem;">${item.icon}</span>
                                    <span style="font-size: 0.8rem; color: #888;">${item.name}</span>
                                    ${item.count > 1 ? '<span style="color: #666; font-size: 0.7rem;"> x' + item.count + '</span>' : ''}
                                </div>
                                <span style="font-size: 0.7rem; color: #ff9800;">${lockReason}</span>
                            </div>
                        `;
                    });
                    html += `<p style="color: #555; font-size: 0.7rem; text-align: center; margin-top: 0.3rem;">üí° Prodej na online tr≈æi≈°ti</p></div>`;
                }
            }
            
            html += '</div>';
            document.getElementById('settlementShopContent').innerHTML = html;
        }
        
        function buyFromSettlement(itemIdx) {
            // N√°kup funguje i vzd√°lenƒõ - nakoupen√© vƒõci jdou do skladu osady
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            console.log('üõí buyFromSettlement - itemIdx:', itemIdx);
            console.log('üõí settlementShop:', state.settlementShop);
            
            const item = state.settlementShop?.items?.[itemIdx];
            console.log('üõí Item:', item);
            
            if (!item || item.stock <= 0) {
                console.log('üõí Item not found or out of stock!');
                return;
            }
            
            let buyDiscount = 0.9; // Z√°kladn√≠ sleva v osadƒõ
            
            // Sleva od Obchodn√≠ gildy
            const tradersRep = state.factions?.traders || 0;
            if (tradersRep >= 100) {
                buyDiscount *= 0.6; // Spojenec: -40%
            } else if (tradersRep >= 50) {
                buyDiscount *= 0.8; // P≈ô√°telsk√Ω: -20%
            }
            
            const price = Math.floor((item.price || 10) * buyDiscount);
            console.log('üõí Price:', price, 'Money:', getMoney());
            
            if (getMoney() < price) {
                notifyWarning('Nedostatek penƒõz!', 'Pot≈ôebuje≈° ' + price + ' üí∞');
                return;
            }
            
            // Pokud v osadƒõ - kontrola v√°hy, jinak jde do skladu
            if (isInShelter) {
                if (!canAddItem(item, 1)) {
                    notifyWarning(t('notifications', 'inventoryFull'), 'Neunese≈° dal≈°√≠ vƒõci.');
                    return;
                }
            }
            
            console.log('üõí Removing money and adding item...');
            removeMoney(price);
            
            // P≈ôidej item s flagem "koupeno" - nelze hned prodat zpƒõt
            const boughtItem = {
                ...item,
                fromShop: true,
                boughtPrice: price
            };
            
            if (isInShelter) {
                // V osadƒõ - do invent√°≈ôe
                addItemToInventory(boughtItem, 1);
            } else {
                // Mimo osadu - do skladu osady
                if (!state.baseItems) state.baseItems = [];
                state.baseItems.push(boughtItem);
                notifyInfo('üì¶ Do skladu', `${item.icon} ${item.name} p≈ôid√°no do skladu osady`);
            }
            item.stock--;
            
            console.log('üõí Done! New money:', getMoney());
            
            SoundSystem.play('pickup');
            showFloatingNumber(-price, 'money');
            
            // Daily quest progress - bought
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.bought = (state.dailyQuests.progress.bought || 0) + 1;
                checkDailyQuests();
            }
            
            showSettlementShopBuy(); // Refresh
        }
        
        function sellAtSettlement(itemIndex, sourceType = 'inv') {
            // Prodej funguje i vzd√°lenƒõ - prod√°v√° ze skladu osady
            const isInShelter = state.world?.currentLocation === 'shelter' || state.map?.inBase;
            
            // Pokud nen√≠ v osadƒõ ale source je inv, zmƒõ≈à na base
            if (!isInShelter && sourceType === 'inv') {
                sourceType = 'base';
            }
            
            const sourceArray = sourceType === 'base' ? (state.baseItems || []) : state.inv;
            const item = sourceArray[itemIndex];
            if (!item) return;
            
            // Vycraftƒõn√© p≈ôedmƒõty nelze prodat obchodn√≠k≈Øm
            if (item.crafted) {
                notifyWarning('Nelze prodat', 'Vlastnoruƒçnƒõ vyroben√© vƒõci obchodn√≠ci neberou. Zkus online tr≈æi≈°tƒõ!');
                return;
            }
            
            // Vƒõci koupen√© od karavany nelze prodat obchodn√≠k≈Øm (anti-exploit)
            if (item.fromCaravan) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od karavany nelze prodat. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            // Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt (anti-exploit)
            if (item.fromShop) {
                notifyWarning('Nelze prodat', 'Vƒõci koupen√© od obchodn√≠ka nelze prodat zpƒõt. Pou≈æij je nebo prodej na online tr≈æi≈°ti!');
                return;
            }
            
            const traderBonus = typeof getSettlementTradeBonus === 'function' ? getSettlementTradeBonus() : 1.25;
            // Z√≠skej cenu z itemu nebo z ITEMS definice
            const itemDef = ITEMS.find(i => i.id === item.id);
            const basePrice = item.price || itemDef?.price || 10;
            let sellPrice = Math.floor(basePrice * 0.35 * traderBonus);
            
            // Sn√≠≈æen√≠ ceny za po≈°kozen√≠
            if (item.durability !== undefined && item.maxDurability) {
                const durabilityRatio = item.durability / item.maxDurability;
                sellPrice = Math.floor(sellPrice * durabilityRatio);
                if (sellPrice < 1) sellPrice = 1;
            }
            
            addMoney(sellPrice);
            
            if (item.count > 1) {
                item.count--;
            } else {
                sourceArray.splice(itemIndex, 1);
            }
            
            state.stats.itemsSold = (state.stats.itemsSold || 0) + 1;
            SoundSystem.play('pickup');
            showFloatingNumber(sellPrice, 'money');
            
            // Daily quest progress - sold
            if (state.dailyQuests?.progress) {
                state.dailyQuests.progress.sold = (state.dailyQuests.progress.sold || 0) + 1;
                checkDailyQuests();
            }
            
            showSettlementShopSell(); // Refresh
        }
        
        function showSettlementHelp() {
            const helpTexts = {
                whatIs: 'Co je osada?', whatIsDesc: 'Osada je tvoje z√°kladna, kde m≈Ø≈æe≈° stavƒõt budovy, naj√≠mat osadn√≠ky a rozv√≠jet komunitu p≈ôe≈æiv≈°√≠ch.',
                basicStats: 'Z√°kladn√≠ statistiky', levelDesc: 'Urƒçuje max poƒçet osadn√≠k≈Ø (3 na level)', prosperityDesc: 'Zvy≈°uje se stavbami a ud√°lostmi, p≈ôi 100 level up', moraleDesc: 'Ovliv≈àuje produktivitu, p≈ôi n√≠zk√© osadn√≠ci ut√≠kaj√≠', defenseDesc: 'Chr√°n√≠ p≈ôed n√°jezdy bandit≈Ø',
                economy: 'Ekonomika osady', maintenanceDesc: 'Vƒõt≈°√≠ budovy stoj√≠ v√≠ce penƒõz/den', tradersDesc: 'Generuj√≠ pasivn√≠ p≈ô√≠jem (10-80üí∞/den podle levelu)', marketDesc: '+25% p≈ô√≠jem z obchodn√≠k≈Ø', builderDesc: 'Sni≈æuje √∫dr≈æbu budov (5-25% podle levelu)', warningDesc: 'Bez penƒõz na √∫dr≈æbu se budovy rozpadnou!',
                buildings: 'Budovy', buildingsDesc: 'Stav budovy za suroviny. Ka≈æd√° m√° unik√°tn√≠ efekt a denn√≠ √∫dr≈æbu:',
                bed: 'Postel', bedDesc: 'Regenerace HP a energie', well: 'Studna', wellDesc: 'Automatick√° produkce vody', garden: 'Zahrada', gardenDesc: 'Automatick√° produkce j√≠dla', walls: 'Zdi', wallsDesc: 'Zvy≈°uj√≠ obranu osady', reactor: 'Reaktor', reactorDesc: 'Energie pro budovy',
                settlers: 'Osadn√≠ci', settlersDesc: 'Naj√≠mej osadn√≠ky za pen√≠ze. Upgrady stoj√≠ dal≈°√≠ pen√≠ze!',
                farmer: 'Farm√°≈ô', farmerDesc: 'Produkuje j√≠dlo', guard: 'Str√°≈æce', guardDesc: 'Zvy≈°uje obranu', scavenger: 'Sbƒõraƒç', scavengerDesc: 'Sb√≠r√° n√°hodn√© suroviny', medic: 'Medik', medicDesc: 'L√©ƒç√≠ v≈°echny', builder: 'Stavitel', builderDesc: 'Slevy na stavby A √∫dr≈æbu!', trader: 'Obchodn√≠k', traderDesc: 'Pasivn√≠ p≈ô√≠jem penƒõz!',
                upgrades: 'Upgrade osadn√≠k≈Ø', upgradesDesc: 'Ka≈æd√Ω osadn√≠k m√° 5 level≈Ø. Vy≈°≈°√≠ level = lep≈°√≠ produkce, ale vy≈°≈°√≠ spot≈ôeba:',
                tips: 'Tipy', tip1: 'Zaƒçni s farm√°≈ôem a nosiƒçem vody pro z√°soby', tip2: 'Najmi obchodn√≠ka pro pasivn√≠ p≈ô√≠jem', tip3: 'Stavitel sn√≠≈æ√≠ n√°klady na √∫dr≈æbu', tip4: 'Sleduj panel Ekonomika v info obyvatel', tip5: 'Nevypl√°c√≠ se stavƒõt moc budov najednou!',
                understood: 'Rozum√≠m!'
            };
            
            showModal('‚ùì Jak funguje osada', `
                <div style="text-align: left; max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch; font-size: 0.9rem;">
                    
                    <h3 style="color: var(--toxic-green); margin-top: 0;">üèòÔ∏è ${helpTexts.whatIs}</h3>
                    <p>${helpTexts.whatIsDesc}</p>
                    
                    <h3 style="color: var(--rust-light);">üìä ${helpTexts.basicStats}</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Level</strong> - ${helpTexts.levelDesc}</li>
                        <li><strong>Prosperity</strong> - ${helpTexts.prosperityDesc}</li>
                        <li><strong>${'Mor√°lka'}</strong> - ${helpTexts.moraleDesc}</li>
                        <li><strong>${'Obrana'}</strong> - ${helpTexts.defenseDesc}</li>
                    </ul>
                    
                    <h3 style="color: var(--warning-yellow);">üí∞ ${helpTexts.economy}</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>üîß ${'√ödr≈æba budov'}</strong> - ${helpTexts.maintenanceDesc}</li>
                        <li><strong>üíπ ${'Obchodn√≠ci'}</strong> - ${helpTexts.tradersDesc}</li>
                        <li><strong>üè™ ${'Tr≈æi≈°tƒõ'}</strong> - ${helpTexts.marketDesc}</li>
                        <li><strong>üî® ${'Stavitel'}</strong> - ${helpTexts.builderDesc}</li>
                        <li><strong>‚ö†Ô∏è ${'Pozor!'}</strong> - ${helpTexts.warningDesc}</li>
                    </ul>
                    
                    <h3 style="color: var(--rust-light);">üèóÔ∏è ${helpTexts.buildings}</h3>
                    <p>${helpTexts.buildingsDesc}</p>
                    <ul style="line-height: 1.8;">
                        <li>üõèÔ∏è <strong>${helpTexts.bed}</strong> - ${helpTexts.bedDesc} (0üí∞/${'den'})</li>
                        <li>üíß <strong>${helpTexts.well}</strong> - ${helpTexts.wellDesc} (2üí∞/${'den'})</li>
                        <li>üå± <strong>${helpTexts.garden}</strong> - ${helpTexts.gardenDesc} (0üí∞/${'den'})</li>
                        <li>üß± <strong>${helpTexts.walls}</strong> - ${helpTexts.wallsDesc} (5üí∞/${'den'})</li>
                        <li>‚ò¢Ô∏è <strong>${helpTexts.reactor}</strong> - ${helpTexts.reactorDesc} (25üí∞/${'den'})</li>
                    </ul>
                    
                    <h3 style="color: var(--rust-light);">üë• ${helpTexts.settlers}</h3>
                    <p>${helpTexts.settlersDesc}</p>
                    <ul style="line-height: 1.8;">
                        <li>üåæ <strong>${helpTexts.farmer}</strong> (500üí∞) - ${helpTexts.farmerDesc}</li>
                        <li>üõ°Ô∏è <strong>${helpTexts.guard}</strong> (800üí∞) - ${helpTexts.guardDesc}</li>
                        <li>üéí <strong>${helpTexts.scavenger}</strong> (700üí∞) - ${helpTexts.scavengerDesc}</li>
                        <li>üíâ <strong>${helpTexts.medic}</strong> (1000üí∞) - ${helpTexts.medicDesc}</li>
                        <li>üî® <strong>${helpTexts.builder}</strong> (600üí∞) - ${helpTexts.builderDesc}</li>
                        <li>üí∞ <strong>${helpTexts.trader}</strong> (1500üí∞) - ${helpTexts.traderDesc}</li>
                    </ul>
                    
                    <h3 style="color: var(--rust-light);">üìà ${helpTexts.upgrades}</h3>
                    <p>${helpTexts.upgradesDesc}</p>
                    <ul style="line-height: 1.8;">
                        <li>Level 2: 350-600üí∞</li>
                        <li>Level 3: 700-1200üí∞</li>
                        <li>Level 4: 1400-2500üí∞</li>
                        <li>Level 5: 2800-5000üí∞</li>
                    </ul>
                    
                    <h3 style="color: var(--warning-yellow);">üí° ${helpTexts.tips}</h3>
                    <ul style="line-height: 1.8;">
                        <li>${helpTexts.tip1}</li>
                        <li>${helpTexts.tip2}</li>
                        <li>${helpTexts.tip3}</li>
                        <li>${helpTexts.tip4}</li>
                        <li>${helpTexts.tip5}</li>
                    </ul>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì ${helpTexts.understood}</button>
            `);
        }
        
        // === MODALY PRO OSADU ===
        function showSettlersModal() {
            const currentMoney = getMoney();
            const canHireMore = true; // Bez limitu
            
            const settlerTexts = {
                yourResidents: 'Tvoji obyvatel√©', hireNew: 'Najmi nov√© obyvatele',
                fullCapacity: 'Pln√° kapacita! Zvy≈° level osady (prosperity 100).',
                dismiss: 'Propustit'
            };
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Aktu√°ln√≠ obyvatel√©
            if (state.settlement.settlers.length > 0) {
                html += '<h3 style="color: var(--toxic-green); margin-top: 0;">üë• ' + settlerTexts.yourResidents + ' (' + state.settlement.settlers.length + ')</h3>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">';
                state.settlement.settlers.forEach((settler, idx) => {
                    const type = SETTLER_TYPES.find(t => t.id === settler.type);
                    html += '<div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; text-align: center;">';
                    html += '<div style="font-size: 2rem;">' + (type?.icon || 'üë§') + '</div>';
                    html += '<div style="font-weight: bold;">' + settler.name + '</div>';
                    html += '<div style="font-size: 0.8rem; color: #888;">' + getSettlerName(settler.type) + '</div>';
                    html += '<button class="btn" onclick="fireSettler(' + idx + '); showSettlersModal();" style="width: 100%; margin-top: 0.5rem; background: #c62828; font-size: 0.75rem;">‚ùå ' + settlerTexts.dismiss + '</button>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Naj√≠m√°n√≠
            html += '<h3 style="color: var(--rust-light);">üíº ' + settlerTexts.hireNew + '</h3>';
            if (!canHireMore) {
                html += '<p style="color: #ff9800;">‚ö†Ô∏è ' + settlerTexts.fullCapacity + '</p>';
            }
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">';
            SETTLER_TYPES.forEach(type => {
                const hasMoney = currentMoney >= type.cost;
                const countOfType = state.settlement.settlers.filter(s => s.type === type.id).length;
                const isUniqueAndOwned = type.unique && countOfType > 0;
                const btnDisabled = !canHireMore || !hasMoney || isUniqueAndOwned;
                const settlerName = getSettlerName(type.id);
                const settlerDesc = SETTLER_TRANSLATIONS[currentLang]?.[type.id]?.desc || type.desc;
                html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center; border: 1px solid ' + (isUniqueAndOwned ? '#4caf50' : '#333') + '; ' + (isUniqueAndOwned ? 'opacity: 0.7;' : '') + '">';
                html += '<div style="font-size: 2rem;">' + type.icon + '</div>';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + settlerName + (countOfType > 0 ? ' <span style="color: #8bc34a;">‚úì</span>' : '') + (type.unique ? ' <span style="font-size: 0.65rem; color: #888;">(max 1)</span>' : '') + '</div>';
                html += '<div style="font-size: 0.75rem; color: #888;">' + settlerDesc + '</div>';
                html += '<div style="font-size: 0.7rem; color: #ff9800; margin: 0.3rem 0;">-' + type.consumption.food + 'üçñ -' + type.consumption.water + 'üíß/' + ('den') + '</div>';
                if (isUniqueAndOwned) {
                    html += '<div style="color: #4caf50; font-size: 0.8rem; padding: 0.4rem;">‚úì M√°≈°</div>';
                } else {
                    html += '<button class="btn" onclick="hireSettler(\'' + type.id + '\'); showSettlersModal();" ' + (btnDisabled ? 'disabled' : '') + ' style="width: 100%; font-size: 0.8rem; ' + (btnDisabled ? 'opacity: 0.5;' : '') + '">üí∞ ' + type.cost + '</button>';
                }
                html += '</div>';
            });
            html += '</div></div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + ('Zav≈ô√≠t') + '</button>';
            
            showModal('üë• Obyvatel√© osady', html);
        }
        
        function showBuildingsModal() {
            const categoryNames = { living: 'üè† Bydlen√≠', production: '‚öôÔ∏è Produkce', utility: 'üîß Utility', defense: 'üõ°Ô∏è Obrana', settlement: 'üèòÔ∏è Osada' };
            const categoryColors = { living: '#8bc34a', production: '#2196f3', utility: '#ff9800', defense: '#c62828', settlement: '#9c27b0' };
            
            // Ensure settlers array exists
            if (!state.settlement) state.settlement = {};
            if (!state.settlement.settlers) state.settlement.settlers = [];
            
            const hasBuilder = state.settlement.settlers.some(s => s.type === 'builder');
            const powerBalance = calculatePowerBalance();
            
            console.log('üèóÔ∏è showBuildingsModal - hasBuilder:', hasBuilder, 'settlers:', state.settlement.settlers.map(s => s.type));
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            html += '<p style="color: #888; margin-bottom: 0.5rem;">' + ('Postaveno') + ': ' + (state.base.length + state.settlement.buildings.length) + ' ' + ('budov') + (hasBuilder ? ' | üî® ' + ('Stavitel: -50% ceny a ƒçasu') : '') + '</p>';
            html += '<p style="color: ' + (powerBalance >= 0 ? '#ffd700' : '#c62828') + '; margin-bottom: 1rem; font-size: 0.85rem;">‚ö° ' + ('Elekt≈ôina') + ': ' + calculatePowerProduction() + '/' + calculatePowerConsumption() + ' (' + (powerBalance >= 0 ? '+' : '') + powerBalance + ')</p>';
            
            // Show buildings under construction
            if (state.buildQueue && state.buildQueue.length > 0) {
                html += '<div style="background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%); border: 2px solid #ff9800; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">';
                html += '<h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">üî® ' + ('Ve v√Ωstavbƒõ') + '</h4>';
                state.buildQueue.forEach(build => {
                    const elapsed = Date.now() - build.startTime;
                    const progress = Math.min(100, (elapsed / build.duration) * 100);
                    const remaining = Math.max(0, Math.ceil((build.duration - elapsed) / 60000)); // minutes
                    html += '<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                    html += '<span>' + build.icon + ' ' + build.name + '</span>';
                    html += '<span style="color: #ff9800; font-size: 0.8rem;">‚è±Ô∏è ' + remaining + ' min</span>';
                    html += '</div>';
                    html += '<div style="height: 6px; background: #333; border-radius: 3px; margin-top: 0.3rem; overflow: hidden;">';
                    html += '<div style="height: 100%; width: ' + progress + '%; background: linear-gradient(90deg, #ff9800, #ffc107); transition: width 0.3s;"></div>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            ['living', 'production', 'utility', 'defense', 'settlement'].forEach(cat => {
                const buildings = BUILDINGS.filter(b => b.category === cat);
                if (buildings.length === 0) return;
                
                const builtCount = buildings.filter(b => state.base.includes(b.id) || state.settlement.buildings.includes(b.id)).length;
                
                html += '<div style="margin-bottom: 1rem;">';
                html += '<h4 style="color: ' + categoryColors[cat] + '; margin: 0 0 0.5rem 0;">' + categoryNames[cat] + ' (' + builtCount + '/' + buildings.length + ')</h4>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.5rem;">';
                
                buildings.forEach(building => {
                    const hasBuilding = state.base.includes(building.id) || state.settlement.buildings.includes(building.id);
                    const isBuilding = state.buildQueue && state.buildQueue.some(b => b.id === building.id);
                    const buildProgress = isBuilding ? state.buildQueue.find(b => b.id === building.id) : null;
                    const settlementRes = state.settlement.resources || {};
                    const canAfford = Object.entries(building.cost).every(([res, amt]) => {
                        const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                        const playerHas = state.resources[res] || 0;
                        const settlementHas = settlementRes[res] || 0;
                        return (playerHas + settlementHas) >= cost;
                    });
                    const levelOk = (building.level || 1) <= state.settlement.level;
                    const inBase = state.world.currentLocation === 'shelter' || state.world.currentLocation === 'settlement';
                    const canBuildLocation = inBase || hasBuilder; // Stavitel umo≈æ≈àuje stavƒõt odkudkoliv
                    const needsPower = building.requiresPower;
                    const hasPowerForIt = needsPower ? (powerBalance >= 0 || !hasBuilding) : true;
                    const canBuild = canAfford && levelOk && canBuildLocation && !isBuilding;
                    
                    html += '<div style="background: ' + (hasBuilding ? (hasPowerForIt ? '#1a2a1a' : '#2a1a1a') : (isBuilding ? '#2a2a1a' : '#1a1a1a')) + '; padding: 0.6rem; border-radius: 6px; text-align: center; border: 1px solid ' + (hasBuilding ? (hasPowerForIt ? '#4a7c4a' : '#7c4a4a') : (isBuilding ? '#ff9800' : '#333')) + ';">';
                    html += '<div style="font-size: 1.5rem;">' + building.icon + '</div>';
                    html += '<div style="font-size: 0.8rem; font-weight: bold;">' + getBuildingName(building.id) + '</div>';
                    html += '<div style="font-size: 0.65rem; color: #666;">' + getBuildingDesc(building.id) + '</div>';
                    
                    // Level requirement
                    if (building.level && building.level > 1) {
                        html += '<div style="font-size: 0.65rem; color: ' + (levelOk ? '#8bc34a' : '#ff9800') + '; margin-top: 0.2rem;">‚≠ê Level ' + building.level + '</div>';
                    }
                    
                    // Info o elekt≈ôinƒõ
                    if (building.production && building.production.power) {
                        html += '<div style="font-size: 0.7rem; color: #ffd700; margin-top: 0.2rem;">+' + building.production.power + ' ‚ö°</div>';
                    }
                    if (needsPower) {
                        html += '<div style="font-size: 0.7rem; color: #c62828; margin-top: 0.2rem;">-' + needsPower + ' ‚ö°</div>';
                    }
                    
                    if (hasBuilding) {
                        if (needsPower && !hasPowerForIt) {
                            html += '<div style="color: #c62828; font-size: 0.75rem; margin-top: 0.3rem;">‚ö†Ô∏è Bez proudu!</div>';
                        } else {
                            html += '<div style="color: #8bc34a; font-size: 0.75rem; margin-top: 0.3rem;">‚úÖ Postaveno</div>';
                        }
                        // Zobraz √∫dr≈æbu postaven√© budovy
                        if (building.maintenance > 0) {
                            html += '<div style="color: #ff9800; font-size: 0.65rem;">üîß ' + building.maintenance + ' üí∞/den</div>';
                        }
                        // Tlaƒç√≠tko zbour√°n√≠
                        html += '<button onclick="event.stopPropagation(); demolishBuilding(\'' + building.id + '\')" style="margin-top: 0.4rem; padding: 0.3rem 0.5rem; background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%); border: none; color: #fff; border-radius: 4px; cursor: pointer; font-size: 0.65rem; width: 100%;">üèóÔ∏è Zbourat</button>';
                    } else {
                        const costText = Object.entries(building.cost).map(([res, amt]) => {
                            const icons = {wood: 'üå≤', metal: '‚öôÔ∏è', stone: 'üóø', cloth: 'üßµ'};
                            const cost = hasBuilder ? Math.ceil(amt * 0.5) : amt;
                            const playerHas = state.resources[res] || 0;
                            const settlementHas = settlementRes[res] || 0;
                            const totalHas = playerHas + settlementHas;
                            return '<span style="color: ' + (totalHas >= cost ? '#8bc34a' : '#c62828') + ';">' + icons[res] + cost + '</span>';
                        }).join(' ');
                        html += '<div style="font-size: 0.7rem; margin: 0.3rem 0;">' + costText + '</div>';
                        
                        // Zobraz dobu stavby
                        const totalCost = Object.values(building.cost).reduce((a, b) => a + b, 0);
                        let buildTime = Math.max(10, Math.min(120, totalCost * 1.0));
                        if (hasBuilder) buildTime = Math.ceil(buildTime * 0.5);
                        html += '<div style="font-size: 0.65rem; color: #888; margin-bottom: 0.2rem;">‚è±Ô∏è ' + buildTime + ' min</div>';
                        
                        // Zobraz √∫dr≈æbu p≈ôed stavbou
                        if (building.maintenance > 0) {
                            html += '<div style="color: #ff9800; font-size: 0.65rem; margin-bottom: 0.2rem;">üîß ' + building.maintenance + ' üí∞/' + ('den') + '</div>';
                        }
                        
                        if (isBuilding) {
                            // Building under construction
                            const elapsed = Date.now() - buildProgress.startTime;
                            const progress = Math.min(100, (elapsed / buildProgress.duration) * 100);
                            const remaining = Math.max(0, Math.ceil((buildProgress.duration - elapsed) / 60000));
                            html += '<div style="color: #ff9800; font-size: 0.7rem; margin-top: 0.3rem;">üî® ' + ('Stav√≠ se...') + '</div>';
                            html += '<div style="height: 4px; background: #333; border-radius: 2px; margin-top: 0.2rem; overflow: hidden;">';
                            html += '<div style="height: 100%; width: ' + progress + '%; background: #ff9800;"></div>';
                            html += '</div>';
                            html += '<div style="font-size: 0.6rem; color: #888; margin-top: 0.2rem;">‚è±Ô∏è ' + remaining + ' min</div>';
                        } else if (!levelOk) {
                            html += '<div style="color: #ff9800; font-size: 0.7rem;">üîí ' + ('Pot≈ôeba level') + ' ' + building.level + '</div>';
                        } else if (!canBuildLocation) {
                            html += '<div style="color: #ff9800; font-size: 0.7rem;">üè† ' + ('Jdi do osady nebo najmi Stavitele') + '</div>';
                        } else {
                            html += '<button class="btn" onclick="buildUnifiedBuilding(\'' + building.id + '\');" ' + (!canBuild ? 'disabled' : '') + ' style="width: 100%; font-size: 0.7rem; padding: 0.3rem; ' + (!canBuild ? 'opacity: 0.5;' : '') + '">üî® ' + ('Stavƒõt') + '</button>';
                        }
                    }
                    html += '</div>';
                });
                html += '</div></div>';
            });
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('üèóÔ∏è Budovy', html);
        }
        
        function showDefenseModal() {
            const defense = calculateSettlementDefense();
            const guards = state.settlement.settlers.filter(s => s.type === 'guard').length;
            const hasWalls = state.base.includes('wall') || state.settlement.buildings.includes('wall');
            const hasBarracks = state.base.includes('barracks') || state.settlement.buildings.includes('barracks');
            const hasTowers = state.base.includes('tower') || state.settlement.buildings.includes('tower');
            const hasBunker = state.base.includes('bunker') || state.settlement.buildings.includes('bunker');
            const hasTurret = state.base.includes('turret') || state.settlement.buildings.includes('turret');
            const hasArmory = state.base.includes('armory') || state.settlement.buildings.includes('armory');
            
            const defModalTexts = {
                points: 'bod≈Ø', desc: 'Obrana chr√°n√≠ p≈ôed n√°jezdy bandit≈Ø',
                sources: 'Zdroje obrany:', guards: 'Str√°≈æci', walls: 'Hradby',
                barracks: 'Kas√°rny', tower: 'Str√°≈æn√≠ vƒõ≈æ', bunker: 'Bunker',
                turret: 'Auto vƒõ≈æ', armory: 'Zbrojnice',
                howToIncrease: 'Jak zv√Ω≈°it obranu:',
                tip1: 'Najmi str√°≈æce (+15 ka≈æd√Ω)', tip2: 'Postav hradby (+25) - Level 2',
                tip3: 'Postav str√°≈æn√≠ vƒõ≈æ (+15) - Level 2', tip4: 'Postav bunker (+60) - Level 4',
                tip5: 'Postav auto vƒõ≈æ (+50) - Level 5'
            };
            
            let html = '<div style="text-align: center; margin-bottom: 1rem;">';
            html += '<div style="font-size: 4rem;">üõ°Ô∏è</div>';
            html += '<div style="font-size: 2rem; color: ' + (defense > 50 ? '#8bc34a' : defense > 20 ? '#ff9800' : '#c62828') + '; font-weight: bold;">' + defense + ' ' + defModalTexts.points + '</div>';
            html += '<p style="color: #888;">' + defModalTexts.desc + '</p>';
            html += '</div>';
            
            html += '<h4 style="color: var(--rust-light);">üìä ' + defModalTexts.sources + '</h4>';
            html += '<div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
            html += '<p>üõ°Ô∏è ' + defModalTexts.guards + ': ' + guards + ' √ó 15 = <strong>' + (guards * 15) + '</strong></p>';
            html += '<p>üß± ' + defModalTexts.walls + ': ' + (hasWalls ? '‚úÖ +25' : '‚ùå 0') + '</p>';
            html += '<p>üõ°Ô∏è ' + defModalTexts.barracks + ': ' + (hasBarracks ? '‚úÖ +bonus' : '‚ùå 0') + '</p>';
            html += '<p>üóº ' + defModalTexts.tower + ': ' + (hasTowers ? '‚úÖ +15' : '‚ùå 0') + '</p>';
            html += '<p>üèöÔ∏è ' + defModalTexts.bunker + ': ' + (hasBunker ? '‚úÖ +60' : '‚ùå 0') + '</p>';
            html += '<p>üî´ ' + defModalTexts.turret + ': ' + (hasTurret ? '‚úÖ +50' : '‚ùå 0') + '</p>';
            html += '<p>‚öîÔ∏è ' + defModalTexts.armory + ': ' + (hasArmory ? '‚úÖ +10% DMG' : '‚ùå 0') + '</p>';
            html += '</div>';
            
            html += '<h4 style="color: var(--warning-yellow);">üí° ' + defModalTexts.howToIncrease + '</h4>';
            html += '<ul style="color: #888; font-size: 0.9rem;">';
            html += '<li>' + defModalTexts.tip1 + '</li>';
            html += '<li>' + defModalTexts.tip2 + '</li>';
            html += '<li>' + defModalTexts.tip3 + '</li>';
            html += '<li>' + defModalTexts.tip4 + '</li>';
            html += '<li>' + defModalTexts.tip5 + '</li>';
            html += '</ul>';
            
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + ('Zav≈ô√≠t') + '</button>';
            
            showModal('üõ°Ô∏è Obrana osady', html);
        }
        
        function showFinanceModal() {
            const playerMoney = state.money || 0;
            const dailyMaintenance = calculateDailyMaintenance();
            const dailyIncome = calculateDailyIncome();
            const balance = dailyIncome - dailyMaintenance;
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Hlavn√≠ p≈ôehled
            html += '<div style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">';
            html += '<div style="font-size: 2.5rem; color: #ffd700; font-weight: bold;">' + playerMoney + ' üí∞</div>';
            html += '<div style="color: #888; font-size: 0.9rem;">' + ('Celkov√© pen√≠ze') + '</div>';
            html += '<div style="margin-top: 0.5rem; font-size: 1.2rem; color: ' + (balance >= 0 ? '#8bc34a' : '#c62828') + ';">';
            html += (balance >= 0 ? 'üìà +' : 'üìâ ') + balance + ' üí∞/' + ('den');
            html += '</div>';
            html += '</div>';
            
            // === P≈ò√çJMY ===
            html += '<div style="background: #1a2a1a; border: 1px solid #4a7c4a; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">';
            html += '<h3 style="color: #8bc34a; margin: 0 0 0.5rem 0; font-size: 1rem;">üìà ' + ('P≈ò√çJMY') + '</h3>';
            
            // Danƒõ od osadn√≠k≈Ø
            const settlerCount = state.settlement?.settlers?.length || 0;
            const settlerTaxes = settlerCount * 2;
            if (settlerCount > 0) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>üë• Danƒõ od osadn√≠k≈Ø (' + settlerCount + ' √ó 2)</span>';
                html += '<span style="color: #8bc34a;">+' + settlerTaxes + ' üí∞</span>';
                html += '</div>';
            }
            
            // Trading post
            if (state.base.includes('trading_post') || state.settlement.buildings.includes('trading_post')) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>üè™ Trading post</span>';
                html += '<span style="color: #8bc34a;">+50 üí∞</span>';
                html += '</div>';
            }
            
            // Market/Tr≈æi≈°tƒõ
            if (state.base.includes('market') || state.settlement.buildings.includes('market')) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>üè¨ ' + ('Tr≈æi≈°tƒõ') + '</span>';
                html += '<span style="color: #8bc34a;">+30 üí∞</span>';
                html += '</div>';
            }
            
            // Trader settlers
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            if (traders.length > 0) {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>üë§ Obchodn√≠ci (' + traders.length + ' √ó 10)</span>';
                html += '<span style="color: #8bc34a;">+' + (traders.length * 10) + ' üí∞</span>';
                html += '</div>';
            }
            
            // Trade specialization
            if (state.settlement.specialization === 'trade') {
                html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #2a3a2a;">';
                html += '<span>üèõÔ∏è ' + ('Obchodn√≠ specializace') + '</span>';
                html += '<span style="color: #8bc34a;">+25 üí∞</span>';
                html += '</div>';
            }
            
            // Celkem p≈ô√≠jmy
            html += '<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: bold; font-size: 1.1rem;">';
            html += '<span>' + ('Celkem p≈ô√≠jmy') + '</span>';
            html += '<span style="color: #8bc34a;">+' + dailyIncome + ' üí∞/' + ('den') + '</span>';
            html += '</div>';
            html += '</div>';
            
            // === V√ùDAJE ===
            html += '<div style="background: #2a1a1a; border: 1px solid #7c4a4a; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">';
            html += '<h3 style="color: #c62828; margin: 0 0 0.5rem 0; font-size: 1rem;">üìâ ' + ('V√ùDAJE') + '</h3>';
            
            // √ödr≈æba budov
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            let totalMaintenance = 0;
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance && building.maintenance > 0) {
                    totalMaintenance += building.maintenance;
                    html += '<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #3a2a2a;">';
                    html += '<span>' + building.icon + ' ' + building.name + '</span>';
                    html += '<span style="color: #c62828;">-' + building.maintenance + ' üí∞</span>';
                    html += '</div>';
                }
            });
            
            if (totalMaintenance === 0) {
                html += '<div style="color: #888; text-align: center; padding: 0.5rem;">' + ('≈Ω√°dn√© n√°klady na √∫dr≈æbu') + '</div>';
            }
            
            // Celkem v√Ωdaje
            html += '<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: bold; font-size: 1.1rem;">';
            html += '<span>' + ('Celkem v√Ωdaje') + '</span>';
            html += '<span style="color: #c62828;">-' + dailyMaintenance + ' üí∞/' + ('den') + '</span>';
            html += '</div>';
            html += '</div>';
            
            // === BILANCE ===
            html += '<div style="background: ' + (balance >= 0 ? '#1a2a1a' : '#2a1a1a') + '; border: 2px solid ' + (balance >= 0 ? '#8bc34a' : '#c62828') + '; border-radius: 8px; padding: 1rem; text-align: center;">';
            html += '<div style="font-size: 0.9rem; color: #888;">' + ('Denn√≠ bilance') + '</div>';
            html += '<div style="font-size: 1.5rem; font-weight: bold; color: ' + (balance >= 0 ? '#8bc34a' : '#c62828') + ';">';
            html += (balance >= 0 ? '+' : '') + balance + ' üí∞/' + ('den');
            html += '</div>';
            if (balance < 0) {
                const daysLeft = Math.floor(playerMoney / Math.abs(balance));
                html += '<div style="margin-top: 0.5rem; color: #ff6b6b;">‚ö†Ô∏è ' + ('Bankrot za ') + daysLeft + ' ' + ('dn√≠') + '</div>';
            }
            html += '</div>';
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('üí∞ P≈ôehled financ√≠', html);
        }
        
        function showStorageModal() {
            // Sklad je p≈ô√≠stupn√Ω odkudkoliv pro PROHL√ç≈ΩEN√ç, ale transfer jen v osadƒõ
            const isInShelter = state.world?.currentLocation === 'shelter';
            
            const icons = { 
                wood: 'üå≤', metal: '‚öôÔ∏è', stone: 'üóø', cloth: 'üßµ', fuel: '‚õΩ', leather: 'ü¶¥', 
                herbs: 'üåø', chemicals: 'üß™', electronics: 'üíæ', glass: 'üîÆ', rope: '‚û∞', 
                gunpowder: 'üí•', scrap: 'üî©', food: 'üçñ', water: 'üíß',
                copper: 'üü§', silver: '‚¨ú', gold: 'üü°', copper_ore: 'ü™®', silver_ore: 'ü™®', gold_ore: 'ü™®',
                crystal: 'üíé', plastic: 'üß¥', raw_meat: 'ü•©', fish: 'üêü'
            };
            const names = {
                wood: 'D≈ôevo', metal: 'Kov', stone: 'K√°men', cloth: 'L√°tka', fuel: 'Palivo',
                leather: 'K≈Ø≈æe', herbs: 'Byliny', chemicals: 'Chemik√°lie', electronics: 'Elektronika',
                glass: 'Sklo', rope: 'Provaz', gunpowder: 'St≈ôeln√Ω prach', scrap: '≈†rot',
                food: 'J√≠dlo', water: 'Voda', copper: 'Mƒõƒè', silver: 'St≈ô√≠bro', gold: 'Zlato',
                copper_ore: 'Mƒõdƒõn√° ruda', silver_ore: 'St≈ô√≠brn√° ruda', gold_ore: 'Zlat√° ruda',
                crystal: 'Krystal', plastic: 'Plast', raw_meat: 'Syrov√© maso', fish: 'Ryba'
            };
            
            const storageTexts = {
                title: 'Sklad osady', inStorage: 'Ve skladu osady', withYou: 'U tebe',
                takeAll: 'Vz√≠t v≈°echny suroviny', storeAll: 'Ulo≈æit v≈°echny suroviny',
                resources: 'Suroviny', yourResources: 'Tvoje suroviny', storedItems: 'Ulo≈æen√© p≈ôedmƒõty',
                empty: 'Pr√°zdn√©', none: '≈Ω√°dn√©', noItems: '≈Ω√°dn√© p≈ôedmƒõty', take: 'Vz√≠t', all: 'V≈°e',
                amount: 'Mno≈æstv√≠', closeStorage: 'Zav≈ô√≠t sklad', consumable: 'Spot≈ôebn√≠'
            };
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
            
            // Migrace
            resourceKeys.forEach(r => {
                if (state.settlement.resources[r] === undefined) state.settlement.resources[r] = 0;
            });
            
            const balance = calculateSettlementBalance();
            
            // Renderov√°n√≠ polo≈æky suroviny
            const renderResourceRow = (res, fromSettlement) => {
                const icon = icons[res] || 'üì¶';
                const name = names[res] || res;
                const settlementAmt = state.settlement.resources[res] || 0;
                const playerAmt = state.resources[res] || 0;
                const amt = fromSettlement ? settlementAmt : playerAmt;
                
                if (amt <= 0) return '';
                
                let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                html += '<span style="font-size: 1.5rem;">' + icon + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + name + '</div>';
                html += '<div style="font-size: 0.85rem; color: #888;">' + storageTexts.amount + ': <span style="color: #ffd700;">' + amt + '</span></div>';
                html += '</div></div>';
                
                // Tlaƒç√≠tka pro transfer pouze v osadƒõ
                if (isInShelter) {
                    if (fromSettlement) {
                        html += '<div style="display: flex; gap: 0.2rem;">';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 1)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #4caf50;">+1</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 10)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #4caf50;">+10</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 999)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #8bc34a;">' + storageTexts.all + '</button>';
                        html += '</div>';
                    } else {
                        html += '<div style="display: flex; gap: 0.2rem;">';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 1)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #2196f3;">+1</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 10)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #2196f3;">+10</button>';
                        html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 999)" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #1976d2;">' + storageTexts.all + '</button>';
                        html += '</div>';
                    }
                }
                html += '</div>';
                return html;
            };
            
            // Renderov√°n√≠ p≈ôedmƒõtu ze skladu
            const renderStoredItem = (item, idx) => {
                let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                html += '<span style="font-size: 1.5rem;">' + item.icon + '</span>';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: bold; font-size: 0.9rem;">' + getItemName(item.id) + (item.count > 1 ? ' x' + item.count : '') + '</div>';
                let desc = '';
                if (item.type === 'weapon') desc = '‚öîÔ∏è ' + item.damage + ' DMG';
                else if (item.type === 'armor') desc = 'üõ°Ô∏è ' + item.defense + ' DEF';
                else if (item.type === 'consumable') desc = item.effect || storageTexts.consumable;
                else desc = item.type || '';
                html += '<div style="font-size: 0.75rem; color: #8bc34a;">' + desc + '</div>';
                html += '</div></div>';
                html += '<button class="btn" onclick="takeFromBase(' + idx + ')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #4caf50;">' + storageTexts.take + '</button>';
                html += '</div>';
                return html;
            };
            
            // Suroviny ve skladu osady
            let settlementResources = '';
            resourceKeys.forEach(res => {
                settlementResources += renderResourceRow(res, true);
            });
            
            // Suroviny u hr√°ƒçe
            let playerResources = '';
            resourceKeys.forEach(res => {
                playerResources += renderResourceRow(res, false);
            });
            
            // P≈ôedmƒõty ve skladu
            let storedItems = '';
            if (state.baseItems && state.baseItems.length > 0) {
                state.baseItems.forEach((item, idx) => {
                    storedItems += renderStoredItem(item, idx);
                });
            } else {
                storedItems = '<p style="color: #666; text-align: center; font-size: 0.85rem; padding: 1rem;">' + storageTexts.noItems + '</p>';
            }
            
            // P≈ôedmƒõty u hr√°ƒçe (kter√© lze ulo≈æit do skladu)
            let playerItems = '';
            const hasStorage = state.base?.includes('storage') || state.settlement?.buildings?.includes('storage');
            
            const storableItems = state.inv.filter(item => 
                item.type !== 'money' && 
                item.type !== 'resource' && 
                !isItemEquipped(item)
            );
            
            // Upozornƒõn√≠ pokud nem√° sklad
            if (!hasStorage && storableItems.length > 0) {
                playerItems = '<div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #ff9800;">';
                playerItems += '<p style="color: #ff9800; margin: 0 0 0.5rem 0; text-align: center;">üèóÔ∏è Pot≈ôebuje≈° postavit <strong>Sklad</strong>!</p>';
                playerItems += '<p style="color: #888; font-size: 0.8rem; margin: 0; text-align: center;">Pro ukl√°d√°n√≠ p≈ôedmƒõt≈Ø postav budovu Sklad (15 d≈ôeva, 10 kamene)</p>';
                playerItems += '</div>';
            }
            
            if (storableItems.length > 0) {
                storableItems.forEach((item, idx) => {
                    const realIdx = state.inv.indexOf(item);
                    const isFoodOrWater = item.id === 'food' || item.id === 'water' || item.id === 'canned_food' || item.id === 'clean_water';
                    const canStore = hasStorage || isFoodOrWater;
                    
                    let html = '<div style="background: #2a2a2a; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
                    html += '<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
                    html += '<span style="font-size: 1.3rem;">' + (item.icon || 'üì¶') + '</span>';
                    html += '<div style="flex: 1;">';
                    html += '<div style="font-weight: bold; font-size: 0.85rem;">' + (item.name || item.id) + (item.count > 1 ? ' x' + item.count : '') + '</div>';
                    let desc = '';
                    if (item.type === 'weapon') desc = '‚öîÔ∏è ' + (item.damage || 0) + ' DMG';
                    else if (item.type === 'armor' || item.type === 'helmet' || item.type === 'boots' || item.type === 'gloves') desc = 'üõ°Ô∏è ' + (item.defense || 0) + ' DEF';
                    else if (item.type === 'consumable') desc = 'üß™ ' + (item.effect || 'Spot≈ôebn√≠');
                    else desc = item.type || '';
                    html += '<div style="font-size: 0.7rem; color: #888;">' + desc + '</div>';
                    html += '</div></div>';
                    
                    if (canStore) {
                        html += '<button class="btn" onclick="storeInBase(' + realIdx + '); showStorageModal();" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #2196f3;">üì¶ Ulo≈æit</button>';
                    } else {
                        html += '<span style="color: #666; font-size: 0.7rem;">üîí Sklad</span>';
                    }
                    html += '</div>';
                    playerItems += html;
                });
            }
            
            document.getElementById('modalContent').innerHTML = `
                <h2>üì¶ ${storageTexts.title}</h2>
                
                ${!isInShelter ? `
                <div style="background: #3a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ff9800;">
                    <p style="color: #ff9800; margin: 0; text-align: center;">‚ö†Ô∏è Nejsi v osadƒõ - pouze prohl√≠≈æen√≠, p≈ôesuny zak√°z√°ny</p>
                </div>
                ` : ''}
                
                <!-- Z√°soby j√≠dla a vody -->
                <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem; padding: 0.8rem; background: #1a1a1a; border-radius: 8px;">
                    <div style="text-align: center;">
                        <span style="font-size: 1.5rem;">üçñ</span>
                        <span style="font-size: 1.3rem; color: #ffd700; font-weight: bold; margin: 0 0.3rem;">${state.settlement.resources.food || 0}</span>
                        <span style="font-size: 0.8rem; color: ${balance.food >= 0 ? '#8bc34a' : '#c62828'};">(${balance.food >= 0 ? '+' : ''}${balance.food}/d)</span>
                        ${isInShelter ? `
                        <div style="display: flex; gap: 0.2rem; margin-top: 0.3rem; justify-content: center;">
                            <button class="btn" onclick="transferSettlementResource('food', -1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #c62828;">-1</button>
                            <button class="btn" onclick="transferSettlementResource('food', 1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #4caf50;">+1</button>
                        </div>
                        ` : ''}
                    </div>
                    <div style="text-align: center;">
                        <span style="font-size: 1.5rem;">üíß</span>
                        <span style="font-size: 1.3rem; color: #2196f3; font-weight: bold; margin: 0 0.3rem;">${state.settlement.resources.water || 0}</span>
                        <span style="font-size: 0.8rem; color: ${balance.water >= 0 ? '#8bc34a' : '#c62828'};">(${balance.water >= 0 ? '+' : ''}${balance.water}/d)</span>
                        ${isInShelter ? `
                        <div style="display: flex; gap: 0.2rem; margin-top: 0.3rem; justify-content: center;">
                            <button class="btn" onclick="transferSettlementResource('water', -1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #c62828;">-1</button>
                            <button class="btn" onclick="transferSettlementResource('water', 1)" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #4caf50;">+1</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Dva sloupce -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- Lev√Ω sloupec - Sklad osady -->
                    <div>
                        <h3 style="text-align: center; color: #2196f3; margin-bottom: 0.5rem;">üì¶ ${storageTexts.inStorage}</h3>
                        ${isInShelter ? `<button class="btn" onclick="transferAllToPlayer()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">üéí ${storageTexts.takeAll}</button>` : ''}
                        
                        <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">üìä ${storageTexts.resources}</h4>
                        ${settlementResources || '<p style="color: #666; text-align: center; font-size: 0.85rem;">' + storageTexts.empty + '</p>'}
                        
                        <h4 style="color: #9c27b0; font-size: 0.85rem; margin: 0.8rem 0 0.3rem 0;">üéí ${storageTexts.storedItems} (${state.baseItems?.length || 0}/${state.baseCapacity})</h4>
                        ${storedItems}
                    </div>
                    
                    <!-- Prav√Ω sloupec - U hr√°ƒçe -->
                    <div>
                        <h3 style="text-align: center; color: #8bc34a; margin-bottom: 0.5rem;">üéí ${storageTexts.withYou}</h3>
                        ${isInShelter ? `<button class="btn" onclick="transferAllToSettlement()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; font-size: 0.8rem; background: #2196f3;">üì¶ ${storageTexts.storeAll}</button>` : ''}
                        
                        <h4 style="color: #ff9800; font-size: 0.85rem; margin: 0.5rem 0;">üìä ${storageTexts.yourResources}</h4>
                        ${playerResources || '<p style="color: #666; text-align: center; font-size: 0.85rem;">' + storageTexts.none + '</p>'}
                        
                        <h4 style="color: #9c27b0; font-size: 0.85rem; margin: 0.8rem 0 0.3rem 0;">üéí ${'Tvoje p≈ôedmƒõty'}</h4>
                        ${playerItems || '<p style="color: #666; text-align: center; font-size: 0.85rem;">' + storageTexts.noItems + '</p>'}
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì ${storageTexts.closeStorage}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        // === ELEKTRICK√ù SYST√âM ===
        function calculatePowerProduction() {
            let power = 0;
            const allBuildings = [...state.base, ...state.settlement.buildings];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.production && building.production.power) {
                    // Gener√°tor pot≈ôebuje palivo - bez paliva neprodukuje
                    if (building.consumption && building.consumption.fuel) {
                        const hasFuel = (state.settlement?.resources?.fuel || 0) >= building.consumption.fuel;
                        if (hasFuel) {
                            power += building.production.power;
                        }
                        // Bez paliva nepoƒç√≠tej produkci
                    } else {
                        // Sol√°rn√≠ panely, vƒõtrn√° turb√≠na - nepot≈ôebuj√≠ palivo
                        power += building.production.power;
                    }
                }
            });
            
            return power;
        }
        
        function calculatePowerConsumption() {
            let power = 0;
            const allBuildings = [...state.base, ...state.settlement.buildings];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.requiresPower) {
                    power += building.requiresPower;
                }
            });
            
            return power;
        }
        
        function calculatePowerBalance() {
            return calculatePowerProduction() - calculatePowerConsumption();
        }
        
        // Calculate daily maintenance cost for all buildings
        function calculateDailyMaintenance() {
            let total = 0;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            const settlementLevel = state.settlement?.level || 1;
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.maintenance) {
                    // Budovy na level 1 osady nemaj√≠ √∫dr≈æbu
                    if (settlementLevel >= 2) {
                        total += building.maintenance;
                    }
                }
            });
            
            // Settler taxes (2 per settler per day - they pay you!)
            // Skip - taxes are now income, not expense
            
            return total;
        }
        
        // Get settlement trade bonus (from traders and specialization)
        function getSettlementTradeBonus() {
            let bonus = 1.0; // Base 100%
            
            // Bonus from trader settlers
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            traders.forEach(trader => {
                const level = trader.skillLevel || 1;
                const traderSkill = SETTLER_SKILLS?.trading?.levels?.[level - 1];
                if (traderSkill?.effect?.tradeBonus) {
                    bonus += traderSkill.effect.tradeBonus;
                }
            });
            
            // Bonus from trading specialization
            if (state.settlement?.specialization === 'trading') {
                const spec = SETTLEMENT_SPECIALIZATIONS?.find(s => s.id === 'trading');
                if (spec?.bonus?.tradeBonus) {
                    bonus += spec.bonus.tradeBonus;
                }
            }
            
            // Bonus from market building
            if (state.settlement?.buildings?.includes('market')) {
                bonus += 0.1; // +10% za tr≈æi≈°tƒõ
            }
            
            return bonus;
        }
        
        // Calculate daily income from settlement
        function calculateDailyIncome() {
            let total = 0;
            const settlementLevel = state.settlement?.level || 1;
            const allBuildings = [...(state.base || []), ...(state.settlement?.buildings || [])];
            
            // Settler taxes (3 per settler per day, scales with settlement level)
            const settlerCount = state.settlement?.settlers?.length || 0;
            total += settlerCount * (2 + settlementLevel);
            
            // Income from buildings with income property
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.income) {
                    total += building.income;
                }
            });
            
            // Trading post generates income
            if (allBuildings.includes('trading_post')) {
                total += 50;
            }
            
            // Market generates income (scales with settlers)
            if (allBuildings.includes('market')) {
                total += 30 + (settlerCount * 3); // V√≠ce osadn√≠k≈Ø = v√≠ce obchodu
            }
            
            // Trader settlers generate extra income (scales with level)
            const traders = state.settlement?.settlers?.filter(s => s.type === 'trader_s') || [];
            traders.forEach(t => {
                const level = t.skillLevel || 1;
                total += 10 + (level * 5); // 15-35 za obchodn√≠ka podle √∫rovnƒõ
            });
            
            // Trading specialization bonus (+50 flat income)
            if (state.settlement.specialization === 'trading') {
                total += 50; // Flat +50 penƒõz/den podle popisu
            }
            
            // Prosperity bonus (high prosperity attracts wealth)
            const prosperity = state.settlement?.prosperity || 0;
            if (prosperity >= 80) total += 25;
            else if (prosperity >= 50) total += 10;
            
            return total;
        }
        
        // Process daily faction/territory income for PvP faction members
        async function processFactionTerritoryIncome() {
            // Kontrola jestli je hr√°ƒç ve frakci
            if (!state.pvpFaction || !multiplayerEnabled || !firebaseDB) return;
            
            const myFaction = state.pvpFaction;
            const factionData = PVP_FACTIONS[myFaction];
            if (!factionData) return;
            
            try {
                // Naƒçti vlastnƒõn√° √∫zem√≠
                const terrSnapshot = await firebaseDB.ref('territories').once('value');
                const territories = terrSnapshot.val() || {};
                
                // Spoƒç√≠tej √∫zem√≠ vlastnƒõn√° moj√≠ frakc√≠
                let ownedCount = 0;
                for (const [locId, terrData] of Object.entries(territories)) {
                    if (terrData.owner === myFaction) {
                        ownedCount++;
                    }
                }
                
                // Z√°kladn√≠ denn√≠ p≈ô√≠jem za ƒçlenstv√≠ ve frakci
                let factionIncome = 10; // 10 üí∞ za b√Ωt ve frakci
                
                // Bonus za vlastnƒõn√° √∫zem√≠ (5 üí∞ za √∫zem√≠)
                const territoryIncome = ownedCount * 5;
                
                // Bonus za contribution (1 üí∞ za ka≈æd√Ωch 100 contribution)
                const contribution = state.pvpFactionContribution || 0;
                const contributionBonus = Math.floor(contribution / 100);
                
                const totalIncome = factionIncome + territoryIncome + contributionBonus;
                
                if (totalIncome > 0) {
                    addMoney(totalIncome);
                    
                    let incomeDetails = [];
                    if (factionIncome > 0) incomeDetails.push(`ƒçlenstv√≠: ${factionIncome}`);
                    if (territoryIncome > 0) incomeDetails.push(`${ownedCount} √∫zem√≠: ${territoryIncome}`);
                    if (contributionBonus > 0) incomeDetails.push(`p≈ô√≠spƒõvek: ${contributionBonus}`);
                    
                    addLog(`${factionData.icon} Frakƒçn√≠ p≈ô√≠jem: +${totalIncome} üí∞ (${incomeDetails.join(', ')})`, 'üí∞');
                    
                    // Notifikace
                    if (totalIncome >= 20) {
                        notifySuccess(`${factionData.icon} Frakƒçn√≠ p≈ô√≠jem`, `+${totalIncome} üí∞ za ${factionData.name}`);
                    }
                }
                
                console.log(`üí∞ Faction income for ${myFaction}: ${totalIncome} (territories: ${ownedCount})`);
                
            } catch (e) {
                console.error('Faction income error:', e);
            }
        }
        
        // Process daily settlement finances (called in daily update)
        function processSettlementFinances() {
            const maintenance = calculateDailyMaintenance();
            const income = calculateDailyIncome();
            const balance = income - maintenance;
            
            // Add income first
            if (income > 0) {
                state.money = (state.money || 0) + income;
                addLog(`üí∞ P≈ô√≠jem osady: +${income}`, 'üí∞');
            }
            
            // Then deduct maintenance
            if (maintenance > 0) {
                if (state.money >= maintenance) {
                    state.money -= maintenance;
                    addLog(`üîß √ödr≈æba zaplacena: -${maintenance}`, 'üîß');
                } else {
                    // Not enough money - buildings start deteriorating
                    const unpaid = maintenance - state.money;
                    state.money = 0;
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 10);
                    addLog(`‚ö†Ô∏è Nelze zaplatit √∫dr≈æbu! -${unpaid} nezaplaceno. Prosperita -10`, '‚ö†Ô∏è');
                    
                    showNotification('Bankrot!', 'Nelze zaplatit √∫dr≈æbu budov!', 'error');
                }
            }
        }
        
        // Detail osadn√≠ka
        function showSettlerDetail(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            if (!type) return;
            
            const settlerDetailTexts = {
                mood: 'N√°lada', happy: 'Spokojen√Ω', fine: 'V pohodƒõ', neutral: 'Neutr√°ln√≠',
                level: '√örove≈à', consumption: 'Spot≈ôeba', perDay: '/den',
                currentBonuses: 'Aktu√°ln√≠ bonusy', noBonuses: '≈Ω√°dn√© speci√°ln√≠ bonusy',
                gatherHistory: 'Historie sbƒõru', day: 'Den', nothing: 'nic',
                foodDay: 'j√≠dla/den', waterDay: 'vody/den', meatDay: 'masa/den', leatherDay: 'k≈Ø≈æe/den',
                defense: 'obrana', attack: '√∫tok', hpDay: 'HP/den', buildings: 'stavby',
                prices: 'ceny', foodBonus: 'j√≠dlo', freeRepairs: 'Opravy zdarma', raidWarning: 'Varov√°n√≠ p≈ôed n√°jezdy',
                herbsDay: 'bylin/den', chemDay: 'chemik√°li√≠/den'
            };
            
            // Inicializace √∫rovnƒõ dovednosti
            if (!settler.skillLevel) settler.skillLevel = 1;
            if (!settler.xp) settler.xp = 0;
            
            // Z√≠sk√°n√≠ skill info
            const skillType = type.skill;
            const skillData = SETTLER_SKILLS[skillType];
            const currentLevel = settler.skillLevel;
            const currentSkill = skillData?.levels[currentLevel - 1];
            const nextSkill = skillData?.levels[currentLevel];
            
            // XP pot≈ôebn√© pro dal≈°√≠ √∫rove≈à (roste exponenci√°lnƒõ)
            const xpForNext = currentLevel < 5 ? currentLevel * 100 : null;
            const xpPercent = xpForNext ? Math.min(100, (settler.xp / xpForNext) * 100) : 100;
            
            // N√°lada
            const moods = [`üòä ${settlerDetailTexts.happy}`, `üôÇ ${settlerDetailTexts.fine}`, `üòê ${settlerDetailTexts.neutral}`];
            const moodIdx = settler.mood || Math.floor(Math.random() * 3);
            
            // Skill tree HTML
            let skillTreeHtml = '';
            if (skillData) {
                const skillName = skillData.name;
                skillTreeHtml = '<div style="margin-top: 1rem;">';
                skillTreeHtml += `<h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">${skillData.icon} ${skillName}</h4>`;
                skillTreeHtml += '<div style="display: flex; flex-direction: column; gap: 0.4rem;">';
                
                skillData.levels.forEach((lvl, idx) => {
                    const isUnlocked = currentLevel >= lvl.level;
                    const isCurrent = currentLevel === lvl.level;
                    const isNext = currentLevel + 1 === lvl.level;
                    const canAfford = isNext && getMoney() >= (lvl.cost || 0);
                    
                    let bgColor = '#1a1a1a';
                    let borderColor = '#333';
                    if (isUnlocked) { bgColor = '#1a2a1a'; borderColor = '#4a7a4a'; }
                    if (isCurrent) { bgColor = '#2a3a2a'; borderColor = '#8bc34a'; }
                    if (isNext) { bgColor = '#2a2a1a'; borderColor = '#7a7a4a'; }
                    
                    const lvlName = lvl.name; // Jm√©no je u≈æ ƒçesky v SETTLER_SKILLS
                    const lvlBonus = lvl.bonus;
                    
                    skillTreeHtml += `<div style="background: ${bgColor}; padding: 0.5rem; border-radius: 6px; border: 2px solid ${borderColor}; display: flex; align-items: center; gap: 0.5rem;">`;
                    skillTreeHtml += `<div style="width: 28px; height: 28px; background: ${isUnlocked ? '#4caf50' : '#333'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${isUnlocked ? '#fff' : '#666'};">${lvl.level}</div>`;
                    skillTreeHtml += '<div style="flex: 1;">';
                    skillTreeHtml += `<div style="font-weight: bold; color: ${isUnlocked ? '#8bc34a' : '#888'};">${lvlName}</div>`;
                    skillTreeHtml += `<div style="font-size: 0.75rem; color: ${isUnlocked ? '#aaa' : '#666'};">${lvlBonus}</div>`;
                    skillTreeHtml += '</div>';
                    
                    if (isUnlocked) {
                        skillTreeHtml += '<span style="color: #4caf50;">‚úì</span>';
                    } else if (isNext) {
                        skillTreeHtml += `<button class="btn" onclick="event.stopPropagation(); upgradeSettlerSkill(${settlerIdx})" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: ${canAfford ? '#ff9800' : '#555'};" ${!canAfford ? 'disabled' : ''}>üí∞ ${lvl.cost}</button>`;
                    } else {
                        skillTreeHtml += '<span style="color: #555;">üîí</span>';
                    }
                    
                    skillTreeHtml += '</div>';
                });
                
                skillTreeHtml += '</div></div>';
            }
            
            // Aktu√°ln√≠ bonusy z dovednosti
            let currentBonuses = '';
            if (currentSkill && currentSkill.effect) {
                const eff = currentSkill.effect;
                if (eff.food) currentBonuses += `üçñ +${eff.food} ${settlerDetailTexts.foodDay}<br>`;
                if (eff.water) currentBonuses += `üíß +${eff.water} ${settlerDetailTexts.waterDay}<br>`;
                if (eff.meat) currentBonuses += `ü•© +${eff.meat} ${settlerDetailTexts.meatDay}<br>`;
                if (eff.leather) currentBonuses += `ü¶¥ +${eff.leather} ${settlerDetailTexts.leatherDay}<br>`;
                if (eff.defense) currentBonuses += `üõ°Ô∏è +${eff.defense} ${settlerDetailTexts.defense}<br>`;
                if (eff.attack) currentBonuses += `‚öîÔ∏è +${eff.attack} ${settlerDetailTexts.attack}<br>`;
                if (eff.healing) currentBonuses += `‚ù§Ô∏è +${eff.healing} ${settlerDetailTexts.hpDay}<br>`;
                if (eff.discount) currentBonuses += `üèóÔ∏è -${eff.discount * 100}% ${settlerDetailTexts.buildings}<br>`;
                if (eff.tradeBonus) currentBonuses += `üí∞ +${eff.tradeBonus * 100}% ${settlerDetailTexts.prices}<br>`;
                if (eff.foodBonus) currentBonuses += `üç≥ +${(eff.foodBonus - 1) * 100}% ${settlerDetailTexts.foodBonus}<br>`;
                if (eff.freeRepair) currentBonuses += `üîß ${settlerDetailTexts.freeRepairs}<br>`;
                if (eff.upgrade) currentBonuses += `‚öîÔ∏è +${eff.upgrade} DMG/DEF vylep≈°en√≠<br>`;
                if (eff.raidWarning) currentBonuses += `üëÅÔ∏è ${settlerDetailTexts.raidWarning}<br>`;
                if (eff.herbs) currentBonuses += `üåø +${eff.herbs} ${settlerDetailTexts.herbsDay}<br>`;
                if (eff.chemicals) currentBonuses += `üß™ +${eff.chemicals} ${settlerDetailTexts.chemDay}<br>`;
            }
            
            const typeName = getSettlerName(type.id);
            const typeDesc = SETTLER_TRANSLATIONS[currentLang]?.[type.id]?.desc || type.desc;
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${type.icon} ${settler.name}</h2>
                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 12px; border: 2px solid #444;">
                            ${type.icon}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #888;">${settlerDetailTexts.mood}: ${moods[moodIdx]}</div>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.3rem 0; color: #8bc34a;">${typeName}</h3>
                        <p style="margin: 0 0 0.8rem 0; color: #888; font-size: 0.9rem;">${typeDesc}</p>
                        
                        <!-- XP Bar -->
                        <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.8rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span style="font-size: 0.8rem; color: #ffd700;">‚≠ê ${settlerDetailTexts.level} ${currentLevel}/5</span>
                                <span style="font-size: 0.75rem; color: #888;">${currentSkill?.name || ''}</span>
                            </div>
                            <div style="background: #0a0a0a; height: 10px; border-radius: 5px; overflow: hidden;">
                                <div style="width: ${xpPercent}%; height: 100%; background: linear-gradient(90deg, #ffd700, #ff9800); transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem; text-align: right;">
                                ${xpForNext ? `${settler.xp}/${xpForNext} XP` : 'MAX'}
                            </div>
                        </div>
                        
                        <!-- Spot≈ôeba -->
                        <div style="font-size: 0.85rem; color: #c62828;">
                            ${settlerDetailTexts.consumption}: ${currentSkill?.consumption?.food || type.consumption?.food || 1}üçñ ${currentSkill?.consumption?.water || type.consumption?.water || 1}üíß ${settlerDetailTexts.perDay}
                        </div>
                    </div>
                </div>
                
                <!-- Aktu√°ln√≠ bonusy -->
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #3a5a3a;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a; font-size: 0.9rem;">üìà ${settlerDetailTexts.currentBonuses} (${settlerDetailTexts.level.toLowerCase()} ${currentLevel})</h4>
                    <div style="font-size: 0.85rem; color: #aaa;">${currentBonuses || settlerDetailTexts.noBonuses}</div>
                </div>
                
                <!-- Historie sbƒõru pro sbƒõraƒçe -->
                ${settler.type === 'scavenger_s' && settler.gatherHistory && settler.gatherHistory.length > 0 ? `
                    <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #3a3a5a;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #64b5f6; font-size: 0.9rem;">üì¶ ${settlerDetailTexts.gatherHistory}</h4>
                        <div style="max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${settler.gatherHistory.map(g => {
                                const resIcons = { wood: 'ü™µ', metal: '‚öôÔ∏è', stone: 'ü™®', cloth: 'üßµ', leather: 'ü¶¥', chemicals: 'üß™', glass: 'üîÆ', scrap: '‚ôªÔ∏è', electronics: 'üíæ' };
                                const resList = Object.entries(g.resources || {}).map(([res, count]) => `${resIcons[res] || 'üì¶'}${count}`).join(' ');
                                const itemsList = g.items && g.items.length > 0 ? `<br><span style="color: #ffd700;">${g.items.join(', ')}</span>` : '';
                                return `<div style="background: #0a0a1a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                                    <span style="color: #888;">${settlerDetailTexts.day} ${g.day}:</span> ${resList || settlerDetailTexts.nothing}${itemsList}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Skill Tree -->
                ${skillTreeHtml}
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="event.stopPropagation(); renameSettler(${settlerIdx});" style="flex: 1; background: #2196f3;">‚úèÔ∏è ${'JM√âNO'}</button>
                    <button class="btn" onclick="event.stopPropagation(); dismissSettler(${settlerIdx});" style="flex: 1; background: #c62828;">üö™ ${'PROPUSTIT'}</button>
                </div>
                <button class="btn" onclick="event.stopPropagation(); closeModal();" style="width: 100%; margin-top: 0.5rem; background: #555; padding-bottom: 1rem;">${'‚úì ZAV≈ò√çT'}</button>
            `;
            document.getElementById('modal').classList.add('show');
        }
        
        // Upgrade dovednosti osadn√≠ka
        function upgradeSettlerSkill(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            const skillData = SETTLER_SKILLS[type?.skill];
            if (!skillData) return;
            
            const currentLevel = settler.skillLevel || 1;
            const maxLevel = skillData.levels.length; // Dynamick√Ω max level podle definice
            const nextSkill = skillData.levels[currentLevel];
            
            if (!nextSkill || currentLevel >= maxLevel) {
                showModal('‚ùå Maximum', 'Osadn√≠k u≈æ m√° maxim√°ln√≠ √∫rove≈à dovednosti!');
                return;
            }
            
            if (getMoney() < nextSkill.cost) {
                showModal('‚ùå Nedostatek penƒõz', `Pot≈ôebuje≈° ${nextSkill.cost} üí∞ pro upgrade na √∫rove≈à ${nextSkill.level}.`);
                return;
            }
            
            // Prov√©st upgrade
            removeMoney(nextSkill.cost);
            settler.skillLevel = nextSkill.level;
            settler.xp = 0;
            
            SoundSystem.play('levelup');
            addLog(`‚¨ÜÔ∏è ${settler.name} z√≠skal √∫rove≈à ${nextSkill.level}: ${nextSkill.name}!`, '‚≠ê');
            
            showSettlerDetail(settlerIdx);
            renderFull();
        }
        
        // Tr√©nov√°n√≠ osadn√≠ka
        function trainSettler(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const cost = 50;
            if (getMoney() < cost) {
                showModal('‚ùå Nedostatek penƒõz', `Pot≈ôebuje≈° ${cost} üí∞ pro tr√©nink.`);
                return;
            }
            
            // Dynamick√Ω max level
            const type = SETTLER_TYPES.find(t => t.id === settler.type);
            const skillData = SETTLER_SKILLS[type?.skill];
            const maxLevel = skillData?.levels?.length || 5;
            
            if (settler.skillLevel >= maxLevel) {
                showModal('‚ùå Maximum', 'Osadn√≠k u≈æ m√° maxim√°ln√≠ √∫rove≈à!');
                return;
            }
            
            removeMoney(cost);
            settler.xp = (settler.xp || 0) + 25 + Math.floor(Math.random() * 25);
            
            // Check level up
            const xpForNext = settler.skillLevel * 100;
            
            if (settler.xp >= xpForNext && settler.skillLevel < maxLevel) {
                settler.xp = 0;
                settler.skillLevel++;
                const newSkill = skillData?.levels[settler.skillLevel - 1];
                SoundSystem.play('levelup');
                addLog(`‚¨ÜÔ∏è ${settler.name} postoupil na √∫rove≈à ${settler.skillLevel}: ${newSkill?.name || ''}!`, '‚≠ê');
            } else if (settler.skillLevel >= maxLevel) {
                settler.xp = 0; // Reset XP na maxu
                SoundSystem.play('pickup');
                addLog(`üéì ${settler.name} je na maxim√°ln√≠ √∫rovni`, 'üìö');
            } else {
                SoundSystem.play('pickup');
                addLog(`üéì ${settler.name} tr√©noval a z√≠skal zku≈°enosti`, 'üìö');
            }
            
            showSettlerDetail(settlerIdx);
            renderFull();
        }
        
        // Propu≈°tƒõn√≠ osadn√≠ka
        function dismissSettler(settlerIdx) {
            console.log('üö™ dismissSettler called with index:', settlerIdx);
            const settler = state.settlement?.settlers?.[settlerIdx];
            if (!settler) {
                console.log('üö™ Settler not found!');
                return;
            }
            console.log('üö™ Settler to dismiss:', settler.name);
            
            showModal('‚ö†Ô∏è Propustit obyvatele?', `
                <p>Opravdu chce≈° propustit <strong>${settler.name}</strong>?</p>
                <p style="color: #ff9800; font-size: 0.9rem;">Tato akce je nevratn√°!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal();" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="confirmDismissSettler(${settlerIdx})" style="background: #c62828;">‚úì Propustit</button>
                </div>
            `);
        }
        
        function confirmDismissSettler(settlerIdx) {
            console.log('üö™ confirmDismissSettler called with index:', settlerIdx);
            const settler = state.settlement?.settlers?.[settlerIdx];
            if (!settler) {
                console.log('üö™ Settler not found for confirmation!');
                return;
            }
            
            const name = settler.name;
            state.settlement.settlers.splice(settlerIdx, 1);
            addLog(`üö™ ${name} opustil osadu`, 'üëã');
            notifySuccess('Obyvatel propu≈°tƒõn', `${name} opustil osadu`);
            closeModal();
            saveGame(true);
            renderFull();
        }
        
        // P≈ôejmenov√°n√≠ osadn√≠ka
        function renameSettler(settlerIdx) {
            const settler = state.settlement.settlers[settlerIdx];
            if (!settler) return;
            
            const newName = prompt('Zadej nov√© jm√©no:', settler.name);
            if (newName && newName.trim() !== '') {
                const oldName = settler.name;
                settler.name = newName.trim();
                addLog(`‚úèÔ∏è ${oldName} se nyn√≠ jmenuje ${settler.name}`, 'üìù');
                showSettlerDetail(settlerIdx);
                renderFull();
            }
        }
        
        // === 2D N√ÅHLED OSADY ===
        function showSettlementPreview() {
            const allBuildings = [...state.base, ...state.settlement.buildings];
            const settlers = state.settlement.settlers || [];
            
            document.getElementById('modalContent').innerHTML = `
                <h2>üó∫Ô∏è N√°hled osady</h2>
                <div style="background: linear-gradient(180deg, #1a2a1a 0%, #0a150a 100%); border: 3px solid #3a5a3a; border-radius: 12px; padding: 8px; margin-bottom: 1rem; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);">
                    <canvas id="settlementCanvas" width="560" height="420" style="width: 100%; border-radius: 8px; cursor: pointer;"></canvas>
                </div>
                <div id="buildingDetail" style="background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%); padding: 1rem; border-radius: 8px; min-height: 80px; border: 1px solid #444;">
                    <div style="text-align: center; color: #666;">
                        <span style="font-size: 2rem;">üèòÔ∏è</span>
                        <p style="margin: 0.5rem 0 0 0;">Klikni na budovu pro zobrazen√≠ detail≈Ø</p>
                    </div>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>
            `;
            document.getElementById('modal').classList.add('show');
            
            setTimeout(() => renderSettlementCanvas(), 50);
        }
        
        function renderSettlementCanvas() {
            const canvas = document.getElementById('settlementCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            
            // Pozad√≠ - gradient tr√°vy
            const bgGrad = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, W/2);
            bgGrad.addColorStop(0, '#2a4a2a');
            bgGrad.addColorStop(0.7, '#1a3a1a');
            bgGrad.addColorStop(1, '#0a2a0a');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, W, H);
            
            // Textura tr√°vy - n√°hodn√© teƒçky
            ctx.fillStyle = 'rgba(60, 100, 60, 0.3)';
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * W;
                const y = Math.random() * H;
                ctx.beginPath();
                ctx.arc(x, y, 1 + Math.random() * 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Hlavn√≠ cesty - kamenn√©
            const drawRoad = (x1, y1, x2, y2, width) => {
                ctx.strokeStyle = '#5a4a3a';
                ctx.lineWidth = width;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                
                // Okraje cesty
                ctx.strokeStyle = '#3a3a2a';
                ctx.lineWidth = width + 4;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                
                ctx.strokeStyle = '#6a5a4a';
                ctx.lineWidth = width - 2;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            };
            
            drawRoad(W/2, 0, W/2, H, 14);
            drawRoad(0, H/2, W, H/2, 14);
            drawRoad(W/4, H/4, W*3/4, H/4, 8);
            drawRoad(W/4, H*3/4, W*3/4, H*3/4, 8);
            
            // Centr√°ln√≠ n√°mƒõst√≠
            ctx.beginPath();
            ctx.arc(W/2, H/2, 35, 0, Math.PI * 2);
            ctx.fillStyle = '#4a4a3a';
            ctx.fill();
            ctx.strokeStyle = '#6a6a5a';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Font√°na uprost≈ôed
            ctx.beginPath();
            ctx.arc(W/2, H/2, 12, 0, Math.PI * 2);
            ctx.fillStyle = '#3a5a7a';
            ctx.fill();
            ctx.strokeStyle = '#7a7a7a';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            const allBuildings = [...state.base, ...state.settlement.buildings];
            const buildingPositions = [];
            
            // Rozm√≠stƒõn√≠ budov v kruhu kolem centra
            const zones = [
                { radius: 70, count: 6, startAngle: 0 },      // Vnit≈ôn√≠ kruh
                { radius: 130, count: 10, startAngle: 0.3 },  // St≈ôedn√≠ kruh
                { radius: 185, count: 12, startAngle: 0.15 }  // Vnƒõj≈°√≠ kruh
            ];
            
            let buildingIdx = 0;
            
            zones.forEach(zone => {
                for (let i = 0; i < zone.count && buildingIdx < allBuildings.length; i++) {
                    const buildingId = allBuildings[buildingIdx];
                    const building = BUILDINGS.find(b => b.id === buildingId);
                    if (!building) { buildingIdx++; continue; }
                    
                    const angle = zone.startAngle + (i / zone.count) * Math.PI * 2;
                    const x = W/2 + Math.cos(angle) * zone.radius;
                    const y = H/2 + Math.sin(angle) * zone.radius;
                    
                    drawBuilding(ctx, x, y, building, buildingPositions);
                    buildingIdx++;
                }
            });
            
            // Osadn√≠ci
            const settlers = state.settlement.settlers || [];
            settlers.forEach((settler, idx) => {
                const type = SETTLER_TYPES.find(t => t.id === settler.type);
                const angle = (idx / Math.max(settlers.length, 1)) * Math.PI * 2 + Date.now() / 5000;
                const radius = 40 + (idx % 3) * 25;
                const x = W/2 + Math.cos(angle) * radius;
                const y = H/2 + Math.sin(angle) * radius;
                
                // St√≠n
                ctx.beginPath();
                ctx.ellipse(x + 2, y + 4, 5, 3, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fill();
                
                // Tƒõlo
                ctx.beginPath();
                ctx.arc(x, y, 7, 0, Math.PI * 2);
                const settlerGrad = ctx.createRadialGradient(x-2, y-2, 0, x, y, 7);
                settlerGrad.addColorStop(0, '#ffe0a0');
                settlerGrad.addColorStop(1, '#c0a060');
                ctx.fillStyle = settlerGrad;
                ctx.fill();
                ctx.strokeStyle = '#806040';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Ikona profese
                if (type) {
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(type.icon, x, y - 12);
                }
            });
            
            // Dekorace - stromy kolem
            const drawTree = (x, y, size) => {
                // Kmen
                ctx.fillStyle = '#5a4030';
                ctx.fillRect(x - size/6, y, size/3, size/2);
                // Koruna
                ctx.beginPath();
                ctx.arc(x, y - size/4, size/2, 0, Math.PI * 2);
                ctx.fillStyle = '#2a6a2a';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x - size/4, y, size/3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + size/4, y, size/3, 0, Math.PI * 2);
                ctx.fill();
            };
            
            // Stromy na okraj√≠ch
            [[20, 30], [50, 380], [530, 50], [500, 370], [30, 200], [540, 220]].forEach(([x, y]) => {
                drawTree(x, y, 20 + Math.random() * 10);
            });
            
            // Plot kolem osady
            ctx.strokeStyle = '#6a5a4a';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.strokeRect(10, 10, W - 20, H - 20);
            ctx.setLineDash([]);
            
            // Br√°na
            ctx.fillStyle = '#8a6a4a';
            ctx.fillRect(W/2 - 20, H - 15, 40, 15);
            ctx.fillStyle = '#5a4a3a';
            ctx.fillRect(W/2 - 15, H - 12, 30, 10);
            ctx.fillStyle = '#3a3a2a';
            ctx.fillText('‚õ©Ô∏è', W/2, H - 5);
            
            window._settlementBuildingPositions = buildingPositions;
            
            // Click event pro detail budovy
            canvas.onclick = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mx = (e.clientX - rect.left) * scaleX;
                const my = (e.clientY - rect.top) * scaleY;
                
                let found = null;
                for (const pos of window._settlementBuildingPositions || []) {
                    const dist = Math.sqrt((mx - pos.x) ** 2 + (my - pos.y) ** 2);
                    if (dist < pos.size) {
                        found = pos;
                        break;
                    }
                }
                
                const detail = document.getElementById('buildingDetail');
                if (detail && found) {
                    const b = found.building;
                    let prodText = '';
                    if (b.production) {
                        const prods = Object.entries(b.production).map(([k, v]) => {
                            const icons = {food: 'üçñ', water: 'üíß', wood: 'üå≤', metal: '‚öôÔ∏è', stone: 'üóø', cloth: 'üßµ', power: '‚ö°'};
                            return `${icons[k] || 'üì¶'} +${v} ${k}`;
                        });
                        prodText = prods.join(', ');
                    }
                    
                    let defText = b.defense ? `üõ°Ô∏è +${b.defense} obrana` : '';
                    let powerText = b.requiresPower ? `‚ö° Spot≈ôeba: ${b.requiresPower}` : '';
                    
                    // Vr√°cen√© suroviny p≈ôi zbour√°n√≠ (50% n√°klad≈Ø)
                    let refundText = '';
                    if (b.cost) {
                        const refunds = Object.entries(b.cost).map(([k, v]) => {
                            const icons = {wood: 'ü™µ', metal: 'üî©', stone: 'üóø', cloth: 'üßµ', electronics: 'üîå', glass: 'üîÆ'};
                            return `${icons[k] || 'üì¶'} ${Math.floor(v * 0.5)}`;
                        });
                        refundText = refunds.join(' ');
                    }
                    
                    detail.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 3rem; background: linear-gradient(135deg, ${found.color} 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 10px; border: 2px solid #555;">${b.icon}</div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #fff;">${b.name}</h3>
                                <p style="margin: 0.3rem 0; color: #8bc34a;">${b.desc}</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${prodText ? `<span style="background: #1a3a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${prodText}</span>` : ''}
                                    ${defText ? `<span style="background: #3a1a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${defText}</span>` : ''}
                                    ${powerText ? `<span style="background: #3a3a1a; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${powerText}</span>` : ''}
                                </div>
                                <div style="margin-top: 0.8rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                                    <button onclick="demolishBuilding('${b.id}')" style="background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%); border: none; color: #fff; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                        üèóÔ∏è Zbourat ${refundText ? `(vr√°t√≠: ${refundText})` : ''}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (detail) {
                    detail.innerHTML = `
                        <div style="text-align: center; color: #666;">
                            <span style="font-size: 2rem;">üèòÔ∏è</span>
                            <p style="margin: 0.5rem 0 0 0;">Klikni na budovu pro zobrazen√≠ detail≈Ø</p>
                        </div>
                    `;
                }
            };
            
            // Hover efekt
            canvas.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mx = (e.clientX - rect.left) * scaleX;
                const my = (e.clientY - rect.top) * scaleY;
                
                let isOver = false;
                for (const pos of window._settlementBuildingPositions || []) {
                    const dist = Math.sqrt((mx - pos.x) ** 2 + (my - pos.y) ** 2);
                    if (dist < pos.size) {
                        isOver = true;
                        break;
                    }
                }
                canvas.style.cursor = isOver ? 'pointer' : 'default';
            };
        }
        
        function drawBuilding(ctx, x, y, building, positions) {
            // Barva podle kategorie
            let color = '#4a4a4a';
            let roofColor = '#3a3a3a';
            if (building.category === 'living') { color = '#4a6a4a'; roofColor = '#3a5a3a'; }
            else if (building.category === 'production') { color = '#4a5a6a'; roofColor = '#3a4a5a'; }
            else if (building.category === 'defense') { color = '#6a4a4a'; roofColor = '#5a3a3a'; }
            else if (building.category === 'utility') { color = '#6a6a4a'; roofColor = '#5a5a3a'; }
            
            // Velikost podle typu
            let size = 22;
            if (building.id === 'wall' || building.id === 'gate') size = 16;
            else if (building.id.includes('house') || building.id.includes('barracks')) size = 28;
            else if (building.id.includes('farm') || building.id.includes('warehouse')) size = 30;
            else if (building.id.includes('tower')) size = 20;
            
            // St√≠n
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(x + 3, y + size/2 + 2, size/2, size/4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Z√°kladna budovy
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(x - size/2, y - size/2, size, size, 3);
            ctx.fill();
            
            // Gradient efekt
            const grad = ctx.createLinearGradient(x - size/2, y - size/2, x + size/2, y + size/2);
            grad.addColorStop(0, 'rgba(255,255,255,0.2)');
            grad.addColorStop(0.5, 'rgba(255,255,255,0)');
            grad.addColorStop(1, 'rgba(0,0,0,0.2)');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.roundRect(x - size/2, y - size/2, size, size, 3);
            ctx.fill();
            
            // St≈ôecha
            ctx.fillStyle = roofColor;
            ctx.beginPath();
            ctx.moveTo(x - size/2 - 3, y - size/2);
            ctx.lineTo(x, y - size/2 - 10);
            ctx.lineTo(x + size/2 + 3, y - size/2);
            ctx.closePath();
            ctx.fill();
            
            // Okraj
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.roundRect(x - size/2, y - size/2, size, size, 3);
            ctx.stroke();
            
            // Ikona
            ctx.font = `${Math.max(12, size - 8)}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#000';
            ctx.shadowBlur = 3;
            ctx.fillText(building.icon, x, y + 2);
            ctx.shadowBlur = 0;
            
            positions.push({ x, y, size: size + 5, building, color });
        }
        
        
        function hasPower() {
            return calculatePowerBalance() >= 0;
        }
        
        function showPowerModal() {
            const produced = calculatePowerProduction();
            const consumed = calculatePowerConsumption();
            const balance = produced - consumed;
            const fuelPerDay = getFuelConsumption();
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // Hlavn√≠ p≈ôehled
            html += '<div style="text-align: center; margin-bottom: 1.5rem;">';
            html += '<div style="font-size: 4rem; margin-bottom: 0.5rem;">‚ö°</div>';
            html += '<div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem;">';
            html += '<div style="text-align: center;"><div style="font-size: 2rem; color: #8bc34a;">' + produced + '</div><div style="font-size: 0.8rem; color: #888;">Produkce</div></div>';
            html += '<div style="text-align: center;"><div style="font-size: 2rem; color: #c62828;">' + consumed + '</div><div style="font-size: 0.8rem; color: #888;">Spot≈ôeba</div></div>';
            html += '<div style="text-align: center;"><div style="font-size: 2rem; color: ' + (balance >= 0 ? '#ffd700' : '#ff5722') + ';">' + (balance >= 0 ? '+' : '') + balance + '</div><div style="font-size: 0.8rem; color: #888;">Bilance</div></div>';
            html += '</div>';
            
            // Status bar
            const statusColor = balance >= 0 ? '#8bc34a' : '#c62828';
            const statusText = balance >= 0 ? '‚úÖ Dostatek energie' : '‚ö†Ô∏è Nedostatek energie!';
            html += '<div style="background: ' + (balance >= 0 ? '#1a2a1a' : '#2a1a1a') + '; padding: 0.8rem; border-radius: 8px; border: 1px solid ' + statusColor + ';">';
            html += '<strong style="color: ' + statusColor + ';">' + statusText + '</strong>';
            if (balance < 0) {
                html += '<p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #aaa;">Nƒõkter√© budovy nefunguj√≠! Postav v√≠ce zdroj≈Ø energie.</p>';
            }
            html += '</div>';
            html += '</div>';
            
            // Palivo
            if (fuelPerDay > 0) {
                const fuelDays = state.settlement.resources.fuel ? Math.floor(state.settlement.resources.fuel / fuelPerDay) : 0;
                html += '<div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a4a2a;">';
                html += '<h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">‚õΩ Spot≈ôeba paliva</h4>';
                html += '<p style="margin: 0;">Gener√°tor spot≈ôebuje <strong>' + fuelPerDay + ' paliva/den</strong></p>';
                html += '<p style="margin: 0.3rem 0 0 0; color: #888;">Z√°soby: ' + (state.settlement.resources.fuel || 0) + ' paliva (' + fuelDays + ' dn√≠)</p>';
                html += '</div>';
            }
            
            // Zdroje energie
            html += '<h4 style="color: #8bc34a; margin-bottom: 0.5rem;">üîã Zdroje energie</h4>';
            html += '<div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">';
            
            const powerSources = BUILDINGS.filter(b => b.production && b.production.power);
            powerSources.forEach(building => {
                const hasIt = state.base.includes(building.id) || state.settlement.buildings.includes(building.id);
                // Kontrola paliva pro gener√°tor
                const needsFuel = building.consumption && building.consumption.fuel;
                const hasFuel = !needsFuel || (state.settlement?.resources?.fuel || 0) >= building.consumption.fuel;
                const isWorking = hasIt && hasFuel;
                
                html += '<div style="background: ' + (hasIt ? (isWorking ? '#1a2a1a' : '#2a1a1a') : '#1a1a1a') + '; padding: 0.8rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid ' + (hasIt ? (isWorking ? '#4a7c4a' : '#7c4a4a') : '#333') + ';">';
                html += '<div><span style="font-size: 1.2rem;">' + building.icon + '</span> <strong>' + building.name + '</strong> <span style="color: ' + (isWorking ? '#8bc34a' : '#666') + ';">' + (isWorking ? '+' : '‚ö†Ô∏è ') + building.production.power + ' ‚ö°</span>';
                if (needsFuel) {
                    html += ' <span style="color: ' + (hasFuel ? '#ff9800' : '#c62828') + '; font-size: 0.8rem;">(-' + building.consumption.fuel + ' ‚õΩ' + (hasFuel ? '' : ' CHYB√ç!') + ')</span>';
                }
                html += '</div>';
                if (hasIt) {
                    html += '<span style="color: ' + (isWorking ? '#8bc34a' : '#c62828') + ';">' + (isWorking ? '‚úÖ Funguje' : '‚ùå Bez paliva') + '</span>';
                } else {
                    html += '<span style="color: #666;">‚ùå</span>';
                }
                html += '</div>';
            });
            html += '</div>';
            
            // Budovy vy≈æaduj√≠c√≠ elekt≈ôinu
            html += '<h4 style="color: #c62828; margin-bottom: 0.5rem;">üîå Budovy vy≈æaduj√≠c√≠ energii</h4>';
            html += '<div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">';
            
            const powerConsumers = BUILDINGS.filter(b => b.requiresPower);
            powerConsumers.forEach(building => {
                const hasIt = state.base.includes(building.id) || state.settlement.buildings.includes(building.id);
                const working = hasIt && hasPower();
                html += '<div style="background: ' + (hasIt ? (working ? '#1a2a1a' : '#2a1a1a') : '#1a1a1a') + '; padding: 0.8rem; border-radius: 6px; border: 1px solid ' + (hasIt ? (working ? '#4a7c4a' : '#7c4a4a') : '#333') + ';">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<div><span style="font-size: 1.2rem;">' + building.icon + '</span> <strong>' + building.name + '</strong> <span style="color: #c62828;">-' + building.requiresPower + ' ‚ö°</span>';
                html += '<div style="font-size: 0.75rem; color: #888;">' + building.desc + '</div>';
                html += '</div>';
                if (hasIt) {
                    html += '<span style="color: ' + (working ? '#8bc34a' : '#c62828') + ';">' + (working ? '‚ö° Funguje' : '‚ùå Bez proudu') + '</span>';
                } else {
                    html += '<span style="color: #666;">Nepostaveno</span>';
                }
                html += '</div>';
                // Tlaƒç√≠tko pro zbour√°n√≠ budovy bez proudu
                if (hasIt && !working) {
                    html += '<div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">';
                    html += '<button onclick="closeModal(); demolishBuilding(\'' + building.id + '\')" style="flex: 1; padding: 0.4rem; background: #8b0000; border: none; color: #fff; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">üèóÔ∏è Zbourat</button>';
                    html += '</div>';
                }
                html += '</div>';
            });
            html += '</div>';
            
            // Tipy
            html += '<div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; border: 1px solid #2d2d4a;">';
            html += '<h4 style="margin: 0 0 0.5rem 0; color: #64b5f6;">üí° Tipy</h4>';
            html += '<ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; color: #aaa;">';
            html += '<li>‚òÄÔ∏è Sol√°rn√≠ panely nevy≈æaduj√≠ palivo</li>';
            html += '<li>‚ö° Gener√°tor produkuje nejv√≠c, ale pot≈ôebuje palivo</li>';
            html += '<li>üåÄ Vƒõtrn√° turb√≠na je dobr√Ω kompromis</li>';
            html += '<li>üîå Budovy bez elekt≈ôiny nefunguj√≠!</li>';
            html += '</ul>';
            html += '</div>';
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('‚ö° Elektrick√° s√≠≈•', html);
        }
        
        function getFuelConsumption() {
            let fuel = 0;
            const allBuildings = [...state.base, ...state.settlement.buildings];
            
            allBuildings.forEach(buildingId => {
                const building = BUILDINGS.find(b => b.id === buildingId);
                if (building && building.consumption && building.consumption.fuel) {
                    fuel += building.consumption.fuel;
                }
            });
            
            return fuel;
        }
        
        function showResourcesModal() {
            const icons = { 
                wood: 'üå≤', metal: '‚öôÔ∏è', stone: 'üóø', cloth: 'üßµ', fuel: '‚õΩ', leather: 'ü¶¥', 
                herbs: 'üåø', chemicals: 'üß™', electronics: 'üíæ', glass: 'üîÆ', rope: '‚û∞', 
                gunpowder: 'üí•', scrap: 'üî©', copper: 'üü§', silver: '‚¨ú', gold: 'üü°', 
                crystal: 'üí†', gems: 'üíé', food: 'üçñ', water: 'üíß'
            };
            const names = {
                wood: 'D≈ôevo', metal: 'Kov', stone: 'K√°men', cloth: 'L√°tka', fuel: 'Palivo',
                leather: 'K≈Ø≈æe', herbs: 'Byliny', chemicals: 'Chemik√°lie', electronics: 'Elektronika',
                glass: 'Sklo', rope: 'Provaz', gunpowder: 'St≈ôeln√Ω prach', scrap: '≈†rot',
                copper: 'Mƒõƒè', silver: 'St≈ô√≠bro', gold: 'Zlato', crystal: 'Krystal', gems: 'Drahokamy',
                food: 'J√≠dlo', water: 'Voda'
            };
            
            // Migrace - ujisti se ≈æe settlement.resources m√° v≈°echny kl√≠ƒçe
            Object.keys(icons).forEach(r => {
                if (state.settlement.resources[r] === undefined) state.settlement.resources[r] = 0;
            });
            
            let html = '<div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // === Z√ÅSOBY OSADY (j√≠dlo, voda) ===
            html += '<h4 style="color: #ffd700; margin-top: 0;">üè™ Z√°soby osady (j√≠dlo & voda)</h4>';
            html += '<p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Z√°soby pro obyvatele. M≈Ø≈æe≈° p≈ôidat nebo vz√≠t.</p>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-bottom: 1rem;">';
            
            // J√≠dlo
            html += '<div style="background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%); padding: 1rem; border-radius: 8px; border: 2px solid #4a4a2d;">';
            html += '<div style="text-align: center; margin-bottom: 0.5rem;">';
            html += '<span style="font-size: 2rem;">üçñ</span>';
            html += '<div style="font-size: 1.5rem; color: #ffd700; font-weight: bold;">' + (state.settlement.resources.food || 0) + '</div>';
            html += '<div style="font-size: 0.8rem; color: #888;">J√≠dlo v osadƒõ</div>';
            html += '</div>';
            html += '<div style="display: flex; gap: 0.3rem;">';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', -5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-5</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', -1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', 1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'food\', 5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+5</button>';
            html += '</div></div>';
            
            // Voda
            html += '<div style="background: linear-gradient(135deg, #1a2a2a 0%, #0a1a1a 100%); padding: 1rem; border-radius: 8px; border: 2px solid #2d4a4a;">';
            html += '<div style="text-align: center; margin-bottom: 0.5rem;">';
            html += '<span style="font-size: 2rem;">üíß</span>';
            html += '<div style="font-size: 1.5rem; color: #2196f3; font-weight: bold;">' + (state.settlement.resources.water || 0) + '</div>';
            html += '<div style="font-size: 0.8rem; color: #888;">Voda v osadƒõ</div>';
            html += '</div>';
            html += '<div style="display: flex; gap: 0.3rem;">';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', -5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-5</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', -1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #c62828;">-1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', 1)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+1</button>';
            html += '<button class="btn" onclick="transferSettlementResource(\'water\', 5)" style="flex: 1; padding: 0.4rem; font-size: 0.8rem; background: #4caf50;">+5</button>';
            html += '</div></div>';
            
            html += '</div>';
            
            // Info o spot≈ôebƒõ
            const balance = calculateSettlementBalance();
            html += '<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">';
            html += '<div style="font-size: 0.85rem; color: #888;">Denn√≠ bilance:</div>';
            html += '<div style="display: flex; justify-content: space-around; margin-top: 0.3rem;">';
            html += '<span style="color: ' + (balance.food >= 0 ? '#8bc34a' : '#c62828') + ';">üçñ ' + (balance.food >= 0 ? '+' : '') + balance.food + '/den</span>';
            html += '<span style="color: ' + (balance.water >= 0 ? '#8bc34a' : '#c62828') + ';">üíß ' + (balance.water >= 0 ? '+' : '') + balance.water + '/den</span>';
            html += '</div></div>';
            
            // === SKLAD SUROVIN OSADY ===
            html += '<h4 style="color: #2196f3; margin-top: 1rem;">üì¶ Sklad osady (suroviny)</h4>';
            html += '<p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">Suroviny ulo≈æen√© v osadƒõ. Osadn√≠ci je sem p≈ôid√°vaj√≠, ty je m≈Ø≈æe≈° vz√≠t.</p>';
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'copper'];
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">';
            resourceKeys.forEach(res => {
                const settlementAmt = state.settlement.resources[res] || 0;
                const playerAmt = state.resources[res] || 0;
                if (settlementAmt > 0 || playerAmt > 0 || ['wood', 'metal', 'stone', 'cloth'].includes(res)) {
                    html += '<div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; border: 1px solid #333;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">';
                    html += '<span style="font-size: 1.2rem;">' + (icons[res] || 'üì¶') + '</span>';
                    html += '<span style="font-size: 0.7rem; color: #888;">' + (names[res] || res) + '</span>';
                    html += '</div>';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">';
                    html += '<div style="text-align: center;">';
                    html += '<div style="font-size: 0.65rem; color: #666;">Osada</div>';
                    html += '<div style="font-size: 1rem; color: #2196f3; font-weight: bold;">' + settlementAmt + '</div>';
                    html += '</div>';
                    html += '<div style="text-align: center;">';
                    html += '<div style="font-size: 0.65rem; color: #666;">Ty</div>';
                    html += '<div style="font-size: 1rem; color: #8bc34a; font-weight: bold;">' + playerAmt + '</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '<div style="display: flex; gap: 0.2rem;">';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 1)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #4caf50;" title="Vz√≠t 1">‚Üê 1</button>';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toPlayer\', 5)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #4caf50;" title="Vz√≠t 5">‚Üê 5</button>';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 1)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #2196f3;" title="D√°t 1">1 ‚Üí</button>';
                    html += '<button class="btn" onclick="transferResource(\'' + res + '\', \'toSettlement\', 5)" style="flex: 1; padding: 0.25rem; font-size: 0.7rem; background: #2196f3;" title="D√°t 5">5 ‚Üí</button>';
                    html += '</div>';
                    html += '</div>';
                }
            });
            html += '</div>';
            
            // Rychl√© akce
            html += '<div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">';
            html += '<button class="btn" onclick="transferAllToSettlement()" style="flex: 1; background: #2196f3;">üì¶ Ulo≈æit v≈°e do osady</button>';
            html += '<button class="btn" onclick="transferAllToPlayer()" style="flex: 1; background: #4caf50;">üéí Vz√≠t v≈°e z osady</button>';
            html += '</div>';
            
            html += '</div>';
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">' + t('ui', 'close') + '</button>';
            
            showModal('üß∫ Sklad osady', html);
        }
        
        // P≈ôesun suroviny mezi hr√°ƒçem a osadou
        function transferResource(resource, direction, amount) {
            // Kontrola jestli je hr√°ƒç v osadƒõ
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('Nejsi v osadƒõ', 'P≈ôesuny surovin jsou mo≈æn√© pouze v osadƒõ!');
                return;
            }
            
            if (direction === 'toSettlement') {
                // Hr√°ƒç ‚Üí Osada
                const playerHas = state.resources[resource] || 0;
                const toTransfer = Math.min(amount, playerHas);
                if (toTransfer > 0) {
                    state.resources[resource] -= toTransfer;
                    state.settlement.resources[resource] = (state.settlement.resources[resource] || 0) + toTransfer;
                    SoundSystem.play('pickup');
                }
            } else {
                // Osada ‚Üí Hr√°ƒç
                const settlementHas = state.settlement.resources[resource] || 0;
                const toTransfer = Math.min(amount, settlementHas);
                if (toTransfer > 0) {
                    state.settlement.resources[resource] -= toTransfer;
                    state.resources[resource] = (state.resources[resource] || 0) + toTransfer;
                    SoundSystem.play('pickup');
                }
            }
            showStorageModal();
        }
        
        // P≈ôesun v≈°ech surovin do osady
        function transferAllToSettlement() {
            // Kontrola jestli je hr√°ƒç v osadƒõ
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('Nejsi v osadƒõ', 'P≈ôesuny surovin jsou mo≈æn√© pouze v osadƒõ!');
                return;
            }
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
            let transferred = 0;
            resourceKeys.forEach(res => {
                const amt = state.resources[res] || 0;
                if (amt > 0) {
                    state.settlement.resources[res] = (state.settlement.resources[res] || 0) + amt;
                    state.resources[res] = 0;
                    transferred += amt;
                }
            });
            if (transferred > 0) {
                SoundSystem.play('pickup');
                addLog(`Ulo≈æil jsi ${transferred} surovin do skladu osady`, 'üì¶');
            }
            showStorageModal();
        }
        
        // Vz√≠t v≈°echny suroviny z osady
        function transferAllToPlayer() {
            // Kontrola jestli je hr√°ƒç v osadƒõ
            if (state.world?.currentLocation !== 'shelter') {
                notifyWarning('Nejsi v osadƒõ', 'P≈ôesuny surovin jsou mo≈æn√© pouze v osadƒõ!');
                return;
            }
            
            const resourceKeys = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
            let transferred = 0;
            resourceKeys.forEach(res => {
                const amt = state.settlement.resources[res] || 0;
                if (amt > 0) {
                    state.resources[res] = (state.resources[res] || 0) + amt;
                    state.settlement.resources[res] = 0;
                    transferred += amt;
                }
            });
            if (transferred > 0) {
                SoundSystem.play('pickup');
                addLog(`Vzal jsi ${transferred} surovin ze skladu osady`, 'üéí');
            }
            showStorageModal();
        }
        
        // Z√≠skej v≈°echny polo≈æky j√≠dla/vody z invent√°≈ôe
        function getInventoryFoodItems() {
            return state.inv.filter(i => i.type === 'consumable' && (i.effect === 'hunger' || i.id?.includes('meat') || i.id?.includes('food') || i.id?.includes('ration')));
        }
        
        function getInventoryWaterItems() {
            return state.inv.filter(i => i.type === 'consumable' && (i.effect === 'thirst' || i.id?.includes('water')));
        }
        
        function getTotalFoodCount() {
            return getInventoryFoodItems().reduce((sum, i) => sum + (i.count || 1), 0);
        }
        
        function getTotalWaterCount() {
            return getInventoryWaterItems().reduce((sum, i) => sum + (i.count || 1), 0);
        }
        
        // Transfer food/water to/from settlement
        function transferSettlementResource(type, amount) {
            if (amount > 0) {
                // P≈ôidat do osady - vz√≠t z invent√°≈ôe
                const items = type === 'food' ? getInventoryFoodItems() : getInventoryWaterItems();
                const totalAvailable = items.reduce((sum, i) => sum + (i.count || 1), 0);
                
                if (totalAvailable < amount) {
                    notifyWarning('Nem√°≈° dost!', `M√°≈° jen ${totalAvailable}x ${type === 'food' ? 'j√≠dlo' : 'vodu'}`);
                    return;
                }
                
                // Odeber z invent√°≈ôe (od prvn√≠ch polo≈æek)
                let toRemove = amount;
                for (const item of items) {
                    if (toRemove <= 0) break;
                    const itemCount = item.count || 1;
                    const removeFromThis = Math.min(itemCount, toRemove);
                    item.count = itemCount - removeFromThis;
                    toRemove -= removeFromThis;
                }
                
                // Vyƒçisti pr√°zdn√© polo≈æky
                state.inv = state.inv.filter(i => !i.count || i.count > 0);
                
                // P≈ôidej do osady
                state.settlement.resources[type] = (state.settlement.resources[type] || 0) + amount;
                notifySuccess(`P≈ôid√°no do osady`, `+${amount} ${type === 'food' ? 'üçñ' : 'üíß'}`);
                renderFull();
            } else {
                // Vz√≠t z osady - d√°t do invent√°≈ôe
                const takeAmount = Math.abs(amount);
                if ((state.settlement.resources[type] || 0) < takeAmount) {
                    notifyWarning('V osadƒõ nen√≠ dost!', `Jen ${state.settlement.resources[type] || 0} ${type === 'food' ? 'üçñ' : 'üíß'}`);
                    return;
                }
                
                // Odeber z osady
                state.settlement.resources[type] -= takeAmount;
                
                // P≈ôidej do invent√°≈ôe
                const itemData = type === 'food' 
                    ? { id: 'settlement_food', name: 'Z√°soby j√≠dla', icon: 'üçñ', type: 'consumable', effect: 'hunger', value: 25, weight: 0.5 }
                    : { id: 'settlement_water', name: 'Z√°soby vody', icon: 'üíß', type: 'consumable', effect: 'thirst', value: 30, weight: 0.5 };
                
                const existing = state.inv.find(i => i.id === itemData.id);
                if (existing) {
                    existing.count = (existing.count || 1) + takeAmount;
                } else {
                    state.inv.push({...itemData, count: takeAmount});
                }
                
                notifySuccess(`Vzato z osady`, `+${takeAmount} ${type === 'food' ? 'üçñ' : 'üíß'}`);
                renderFull();
            }
        }
        
        // === SETTLEMENT SPECIALIZATION ===
        function showSpecializationModal() {
            const specTexts = {
                intro: 'Vyber specializaci pro svou osadu. Lze zmƒõnit kdykoliv.',
                guards: 'str√°≈æc≈Ø', traders: 'obchodn√≠k≈Ø', farmers: 'farm√°≈ô≈Ø', medics: 'medik≈Ø', builders: 'stavitel≈Ø',
                barracks: 'Kas√°rny', market: 'Tr≈æi≈°tƒõ', farmland: 'Farmland', infirmary: 'O≈°et≈ôovna', workshop: 'D√≠lna', forge: 'Kov√°rna',
                active: 'AKTIVN√ç', activate: 'Aktivovat', notMet: 'Nesplnƒõno'
            };
            
            let html = '<p style="margin-bottom: 1rem;">' + specTexts.intro + '</p>';
            
            html += '<div style="display: grid; gap: 0.5rem;">';
            SETTLEMENT_SPECIALIZATIONS.forEach(spec => {
                const isActive = state.settlement.specialization === spec.id;
                const canActivate = checkSpecializationRequirements(spec);
                const specName = spec.name;
                const specDesc = spec.desc;
                
                // Build requirements text
                let reqText = [];
                if (spec.requirement) {
                    if (spec.requirement.guards) {
                        const have = state.settlement.settlers.filter(s => s.type === 'guard').length;
                        const need = spec.requirement.guards;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üíÇ ${have}/${need} ${specTexts.guards}</span>`);
                    }
                    if (spec.requirement.traders) {
                        const have = state.settlement.settlers.filter(s => s.type === 'trader_s').length;
                        const need = spec.requirement.traders;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üíº ${have}/${need} ${specTexts.traders}</span>`);
                    }
                    if (spec.requirement.farmers) {
                        const have = state.settlement.settlers.filter(s => s.type === 'farmer').length;
                        const need = spec.requirement.farmers;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üë®‚Äçüåæ ${have}/${need} ${specTexts.farmers}</span>`);
                    }
                    if (spec.requirement.medics) {
                        const have = state.settlement.settlers.filter(s => s.type === 'medic_s').length;
                        const need = spec.requirement.medics;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">‚öïÔ∏è ${have}/${need} ${specTexts.medics}</span>`);
                    }
                    if (spec.requirement.builders) {
                        const have = state.settlement.settlers.filter(s => s.type === 'builder').length;
                        const need = spec.requirement.builders;
                        const ok = have >= need;
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üë∑ ${have}/${need} ${specTexts.builders}</span>`);
                    }
                    if (spec.requirement.barracks) {
                        const ok = state.settlement.buildings.includes('barracks');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üõ°Ô∏è ${specTexts.barracks} ${ok ? '‚úì' : '‚úó'}</span>`);
                    }
                    if (spec.requirement.market) {
                        const ok = state.settlement.buildings.includes('market');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üè™ ${specTexts.market} ${ok ? '‚úì' : '‚úó'}</span>`);
                    }
                    if (spec.requirement.farmland) {
                        const ok = state.settlement.buildings.includes('farmland');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üåæ ${specTexts.farmland} ${ok ? '‚úì' : '‚úó'}</span>`);
                    }
                    if (spec.requirement.infirmary) {
                        const ok = state.base.includes('infirmary');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üè• ${specTexts.infirmary} ${ok ? '‚úì' : '‚úó'}</span>`);
                    }
                    if (spec.requirement.workshop) {
                        const ok = state.base.includes('workshop');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">üîß ${specTexts.workshop} ${ok ? '‚úì' : '‚úó'}</span>`);
                    }
                    if (spec.requirement.forge) {
                        const ok = state.settlement.buildings.includes('forge') || state.base.includes('forge');
                        reqText.push(`<span style="color: ${ok ? '#8bc34a' : '#c62828'};">‚öíÔ∏è ${specTexts.forge} ${ok ? '‚úì' : '‚úó'}</span>`);
                    }
                }
                
                html += `
                    <div style="background: ${isActive ? 'var(--toxic-dark)' : '#2a2a2a'}; padding: 1rem; border-radius: 8px; border: 2px solid ${isActive ? 'var(--toxic-green)' : canActivate ? 'var(--metal-light)' : '#555'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0; color: ${isActive ? 'var(--toxic-green)' : '#fff'};">${spec.icon} ${specName}</h4>
                                <p style="margin: 0.3rem 0; font-size: 0.85rem; color: var(--toxic-green);">${specDesc}</p>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${reqText.join(' ')}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                ${isActive ? '<span style="color: var(--toxic-green); font-weight: bold;">‚úì ' + specTexts.active + '</span>' : 
                                  canActivate ? `<button class="btn" onclick="setSpecialization('${spec.id}')" style="padding: 0.5rem 1rem;">${specTexts.activate}</button>` :
                                  '<span style="color: #c62828; font-size: 0.8rem;">üîí ' + specTexts.notMet + '</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            html += '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">' + t('ui', 'close') + '</button>';
            
            showModal('üèõÔ∏è Specializace osady', html);
        }
        
        function checkSpecializationRequirements(spec) {
            if (!spec.requirement) return true;
            
            // Check settlers
            if (spec.requirement.guards) {
                const guardCount = state.settlement.settlers.filter(s => s.type === 'guard').length;
                if (guardCount < spec.requirement.guards) return false;
            }
            if (spec.requirement.traders) {
                const traderCount = state.settlement.settlers.filter(s => s.type === 'trader_s').length;
                if (traderCount < spec.requirement.traders) return false;
            }
            if (spec.requirement.farmers) {
                const farmerCount = state.settlement.settlers.filter(s => s.type === 'farmer').length;
                if (farmerCount < spec.requirement.farmers) return false;
            }
            if (spec.requirement.medics) {
                const medicCount = state.settlement.settlers.filter(s => s.type === 'medic_s').length;
                if (medicCount < spec.requirement.medics) return false;
            }
            if (spec.requirement.builders) {
                const builderCount = state.settlement.settlers.filter(s => s.type === 'builder').length;
                if (builderCount < spec.requirement.builders) return false;
            }
            
            // Check buildings
            if (spec.requirement.barracks && !state.settlement.buildings.includes('barracks')) return false;
            if (spec.requirement.market && !state.settlement.buildings.includes('market')) return false;
            if (spec.requirement.farmland && !state.settlement.buildings.includes('farmland')) return false;
            if (spec.requirement.infirmary && !state.base.includes('infirmary')) return false;
            if (spec.requirement.workshop && !state.base.includes('workshop')) return false;
            if (spec.requirement.forge && !state.settlement.buildings.includes('forge') && !state.base.includes('forge')) return false;
            
            return true;
        }
        
        function setSpecialization(specId) {
            state.settlement.specialization = specId;
            const spec = SETTLEMENT_SPECIALIZATIONS.find(s => s.id === specId);
            closeModal();
            addLog(`üèõÔ∏è Osada se specializovala na: ${spec.name}`, 'üèõÔ∏è');
            showModal('üèõÔ∏è Specializace aktivov√°na!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${spec.icon}</div>
                    <h3>${spec.name}</h3>
                    <p style="color: var(--toxic-green);">${spec.desc}</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
            `);
            renderFull();
        }
        
        function triggerSettlementRaid() {
            const defense = calculateSettlementDefense();
            const raiderPower = Math.floor(Math.random() * 30) + 20; // 20-50
            
            setTimeout(() => {
                if (defense >= raiderPower) {
                    // Successfully defended
                    const loot = Math.floor(Math.random() * 200) + 100;
                    addMoney(loot);
                    state.settlement.prosperity = Math.min(100, state.settlement.prosperity + 5);
                    
                    showModal('üõ°Ô∏è √ötok odra≈æen!',
                        `<div style="text-align: center;">` +
                        `<p style="color: #8bc34a; font-weight: bold; margin-bottom: 1rem;">Tv√° osada odrazila √∫tok raider≈Ø!</p>` +
                        `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                        `<p>üõ°Ô∏è Obrana: ${defense}</p>` +
                        `<p>‚öîÔ∏è Raide≈ôi: ${raiderPower}</p>` +
                        `</div>` +
                        `<p style="color: #ffd700;">üí∞ Loot z raider≈Ø: ${loot} penƒõz!</p>` +
                        `<p style="color: #8bc34a;">+5 prosperity</p>` +
                        `</div>`
                    );
                    addLog('Osada odrazila √∫tok!', 'üõ°Ô∏è');
                } else {
                    // Raid successful - lose resources
                    const foodLoss = Math.floor(state.settlement.resources.food * 0.3);
                    const waterLoss = Math.floor(state.settlement.resources.water * 0.3);
                    state.settlement.resources.food -= foodLoss;
                    state.settlement.resources.water -= waterLoss;
                    state.settlement.prosperity = Math.max(0, state.settlement.prosperity - 15);
                    
                    // Possible settler injury/death
                    if (state.settlement.settlers.length > 0 && Math.random() < 0.3) {
                        const idx = Math.floor(Math.random() * state.settlement.settlers.length);
                        const settler = state.settlement.settlers[idx];
                        state.settlement.settlers.splice(idx, 1);
                        
                        showModal('üíÄ Raid!',
                            `<div style="text-align: center;">` +
                            `<p style="color: #c62828; font-weight: bold; margin-bottom: 1rem;">Raide≈ôi p≈ôepadli tvou osadu!</p>` +
                            `<div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">` +
                            `<p>üõ°Ô∏è Obrana: ${defense} (slab√°!)</p>` +
                            `<p>‚öîÔ∏è Raide≈ôi: ${raiderPower}</p>` +
                            `</div>` +
                            `<p style="color: #ff9800;">Ztr√°ty:</p>` +
                            `<p>üçñ -${foodLoss} j√≠dla</p>` +
                            `<p>üíß -${waterLoss} vody</p>` +
                            `<p style="color: #c62828;">üíÄ ${settler.name} byl zabit!</p>` +
                            `<p style="color: #ff9800;">-15 prosperity</p>` +
                            `</div>`
                        );
                        addLog(`Raid! ${settler.name} zahynul!`, 'üíÄ');
                    } else {
                        showModal('‚ö†Ô∏è Raid!',
                            `<div style="text-align: center;">` +
                            `<p style="color: #ff9800; font-weight: bold; margin-bottom: 1rem;">Raide≈ôi p≈ôepadli tvou osadu!</p>` +
                            `<p style="color: #ff9800;">Ztr√°ty:</p>` +
                            `<p>üçñ -${foodLoss} j√≠dla</p>` +
                            `<p>üíß -${waterLoss} vody</p>` +
                            `<p style="color: #ff9800;">-15 prosperity</p>` +
                            `<p style="margin-top: 1rem; color: #999;">Zvy≈° obranu osady!</p>` +
                            `</div>`
                        );
                        addLog('Osada byla p≈ôepadena!', '‚ö†Ô∏è');
                    }
                    SoundSystem.play('death');
                }
            }, 1000);
        }
        
        function raidVillage() {
            closeModal();
            
            // Create multiple enemies for village raid (3-5)
            const enemyCount = Math.floor(Math.random() * 3) + 3; // 3-5 enemies
            const enemyTypes = ['raider', 'bandit', 'zombie', 'mutant'];
            const selectedEnemy = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            
            // Start combat with multiple enemies
            startCombat({id: selectedEnemy}, false, true); // true = village raid
        }
        
        // Pokus o √∫tƒõk
        // tryToFlee je definov√°na v√Ω≈°e (≈ô√°dek ~15403)
        
        // === START COMBAT WITH PREDEFINED GROUP ===
        // ============================================
        // === HEROES 3 STYLE COMBAT SYSTEM ===
        // ============================================
        
        // Bojov√° m≈ô√≠≈æka: 7 sloupc≈Ø x 3 ≈ô√°dky
        // Sloupce 0-2: nep≈ô√°tel√©, sloupec 3: st≈ôed, sloupce 4-6: hr√°ƒç
        const COMBAT_GRID = { cols: 9, rows: 5 };
        
        function startCombatWithGroup(enemyGroup, combatType = 'normal', skipPreCombat = false) {
            console.log('‚öîÔ∏è startCombatWithGroup called with', enemyGroup?.length || 0, 'enemies, type:', combatType);
            
            if (!enemyGroup || enemyGroup.length === 0) {
                console.error('‚öîÔ∏è startCombatWithGroup: No enemies!');
                notifyError('Chyba boje', '≈Ω√°dn√≠ nep≈ô√°tel√©!');
                return;
            }
            
            // === AUTOMATICK√â DOPLNƒöN√ç N√ÅBOJ≈Æ PRO COMPANIONY ===
            if (state.companions) {
                state.companions.forEach(comp => {
                    if (!comp.isDead && comp.equipped?.weapon?.ammoType) {
                        const ammoType = comp.equipped.weapon.ammoType;
                        const currentAmmo = comp.ammo || 0;
                        const maxAmmo = 50; // Max n√°boj≈Ø co companion pot≈ôebuje
                        
                        if (currentAmmo < maxAmmo) {
                            const needed = maxAmmo - currentAmmo;
                            const playerHas = getAmmoCount(ammoType);
                            const toGive = Math.min(needed, playerHas);
                            
                            if (toGive > 0) {
                                consumeAmmo(ammoType, toGive);
                                comp.ammo = currentAmmo + toGive;
                                console.log(`üî´ ${comp.name} dostal ${toGive} n√°boj≈Ø (typ: ${ammoType})`);
                            }
                        }
                    }
                });
            }
            
            // Pokud m√°me spoleƒçn√≠ky a nen√≠ p≈ôeskoƒçen√≠, uka≈æ pre-combat setup
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
            if (aliveCompanions.length > 0 && !skipPreCombat && !window._inPreCombatFlow) {
                console.log('üéÆ Showing pre-combat setup for', aliveCompanions.length, 'companions');
                showPreCombatSetup(enemyGroup, combatType);
                return;
            }
            
            // Reset flag
            window._inPreCombatFlow = false;
            
            closeModal();
            
            // Reset Phoenix efektu pro nov√Ω boj
            window.phoenixUsed = false;
            
            setTimeout(() => {
                // === ENEMY SCALING SYSTEM ===
                const playerLevel = state.char.level || 1;
                
                // Soft scaling: +5% HP/DMG za ka≈æd√Ω level nad 10
                let levelScaling = 1.0;
                if (playerLevel > 10) {
                    levelScaling = 1 + (playerLevel - 10) * 0.05;
                }
                
                // Day scaling: nep≈ô√°tel√© jsou silnƒõj≈°√≠ po 30 dnech
                const dayBonus = Math.min(0.3, (state.time.days || 0) * 0.01); // max +30%
                levelScaling *= (1 + dayBonus);
                
                // Vytvo≈ô jednotky na m≈ô√≠≈æce
                const units = [];
                let unitId = 0;
                
                // Rozm√≠sti nep≈ô√°tele po lev√© ƒç√°sti mapy (sloupce 0-3)
                // R≈Øzn√© formace podle poƒçtu nep≈ô√°tel
                const enemyCount = enemyGroup.length;
                let enemySpawnPositions = [];
                
                if (enemyCount === 1) {
                    // Jeden nep≈ô√≠tel - uprost≈ôed lev√© strany
                    enemySpawnPositions = [{ x: 2, y: 2 }];
                } else if (enemyCount === 2) {
                    // Dva nep≈ô√°tel√© - vedle sebe
                    enemySpawnPositions = [
                        { x: 1, y: 1 },
                        { x: 1, y: 3 }
                    ];
                } else if (enemyCount === 3) {
                    // T≈ôi nep≈ô√°tel√© - troj√∫heln√≠k
                    enemySpawnPositions = [
                        { x: 2, y: 2 },  // Vep≈ôedu
                        { x: 0, y: 1 },  // Vzadu naho≈ôe
                        { x: 0, y: 3 }   // Vzadu dole
                    ];
                } else if (enemyCount === 4) {
                    // ƒåty≈ôi nep≈ô√°tel√© - ƒçtverec
                    enemySpawnPositions = [
                        { x: 2, y: 1 },
                        { x: 2, y: 3 },
                        { x: 0, y: 1 },
                        { x: 0, y: 3 }
                    ];
                } else if (enemyCount <= 6) {
                    // 5-6 nep≈ô√°tel - dva ≈ôady
                    enemySpawnPositions = [
                        { x: 2, y: 1 },  // P≈ôedn√≠ ≈ôada
                        { x: 2, y: 2 },
                        { x: 2, y: 3 },
                        { x: 0, y: 1 },  // Zadn√≠ ≈ôada
                        { x: 0, y: 2 },
                        { x: 0, y: 3 }
                    ];
                } else {
                    // 7+ nep≈ô√°tel - t≈ôi ≈ôady p≈ôes celou v√Ω≈°ku
                    enemySpawnPositions = [
                        { x: 3, y: 0 },  // P≈ôedn√≠ ≈ôada
                        { x: 3, y: 1 },
                        { x: 3, y: 2 },
                        { x: 3, y: 3 },
                        { x: 3, y: 4 },
                        { x: 1, y: 0 },  // St≈ôedn√≠ ≈ôada
                        { x: 1, y: 1 },
                        { x: 1, y: 2 },
                        { x: 1, y: 3 },
                        { x: 1, y: 4 }
                    ];
                }
                
                enemyGroup.forEach((e, idx) => {
                    const pos = enemySpawnPositions[idx] || { x: idx % 3, y: idx % 5 };
                    
                    // === ELITE ENEMY SYSTEM ===
                    // 10% ≈°ance na elite (15% v dungeonech, 20% po dni 20)
                    let eliteChance = 0.10;
                    if (combatType === 'dungeon') eliteChance = 0.15;
                    if ((state.time.days || 0) > 20) eliteChance += 0.10;
                    
                    const isElite = Math.random() < eliteChance;
                    let eliteMultiplier = 1;
                    let elitePrefix = '';
                    let eliteIcon = e.icon;
                    
                    if (isElite) {
                        eliteMultiplier = 2; // 2x HP
                        elitePrefix = 'üíÄ ';
                        // Zmƒõ≈à barvu ikony nep≈ô√≠tele
                        eliteIcon = 'üíÄ' + e.icon;
                    }
                    
                    const scaledHp = Math.floor((e.hp || e.maxHp) * levelScaling * eliteMultiplier);
                    const scaledDmg = Math.floor(e.damage * levelScaling * (isElite ? 1.5 : 1));
                    const scaledDef = Math.floor(e.defense * levelScaling * (isElite ? 1.3 : 1));
                    
                    units.push({
                        id: unitId++,
                        ...e,
                        name: elitePrefix + e.name,
                        icon: eliteIcon,
                        isElite: isElite,
                        hp: scaledHp,
                        maxHp: scaledHp,
                        damage: scaledDmg,
                        defense: scaledDef,
                        xp: Math.floor(e.xp * (isElite ? 2.5 : 1)), // Elite d√°v√° 2.5x XP
                        speed: e.speed || 5 + Math.floor(Math.random() * 5),
                        x: pos.x,
                        y: pos.y,
                        team: 'enemy',
                        alive: true,
                        acted: false,
                        stunned: false,
                        poisoned: 0,
                        bleeding: 0
                    });
                });
                
                // P≈ôidej hr√°ƒçe (sloupec 5, ≈ô√°dek 1)
                units.push({
                    id: unitId++,
                    name: state.char.name || 'Hrdina',
                    icon: 'üßë',
                    hp: state.char.hp,
                    maxHp: state.char.maxHp,
                    damage: calculateDamage(),
                    defense: calculateDefense(),
                    speed: 10 + Math.floor((state.char.attrs?.agi || 5) / 2),
                    x: 7,  // Prav√° strana mapy
                    y: 2,  // St≈ôed
                    team: 'player',
                    isPlayer: true,
                    alive: true,
                    acted: false
                });
                
                // P≈ôidej ≈æiv√© spoleƒçn√≠ky
                if (state.companions) {
                    state.companions.filter(c => !c.isDead && c.hp > 0).forEach((comp, idx) => {
                        const compData = COMPANIONS.find(cd => cd.id === comp.id);
                        // Pro dynamick√© spoleƒçn√≠ky (rescued survivor) pou≈æij data z comp
                        const compIcon = comp.icon || compData?.icon || 'üë§';
                        const compName = comp.name || compData?.name || 'Spoleƒçn√≠k';
                        
                        // Pou≈æij getCompanionStat pro damage a defense (zahrnuje vybaven√≠)
                        const compDamage = getCompanionStat(comp, 'damage');
                        const compDefense = getCompanionStat(comp, 'defense');
                        
                        // Spawn pozice - pou≈æij override pokud existuje, jinak default
                        const compId = comp.uniqueId || comp.id;
                        let pos;
                        
                        if (window.companionPositionsOverride && window.companionPositionsOverride[compId]) {
                            pos = window.companionPositionsOverride[compId];
                            
                            // Pokud je spoleƒçn√≠k vylouƒçen√Ω z boje, p≈ôeskoƒç ho
                            if (pos.excluded || pos.id === 'excluded') {
                                console.log(`üö´ ${compName} vynech√°n z boje (excluded)`);
                                return; // P≈ôeskoƒç tohoto spoleƒçn√≠ka
                            }
                        } else {
                            // V√Ωchoz√≠ pozice kolem hr√°ƒçe (prav√° strana)
                            const defaultPositions = [
                                { x: 7, y: 1 }, { x: 7, y: 3 }, // Nad a pod hr√°ƒçem
                                { x: 8, y: 2 }, { x: 8, y: 1 }, { x: 8, y: 3 } // √öplnƒõ vpravo
                            ];
                            pos = defaultPositions[idx] || { x: 7, y: idx % 5 };
                        }
                        
                        units.push({
                            id: unitId++,
                            name: compName,
                            icon: compIcon,
                            hp: comp.hp,
                            maxHp: comp.maxHp,
                            damage: compDamage,
                            defense: compDefense,
                            speed: 8 + idx,
                            x: pos.x,
                            y: pos.y,
                            team: 'player',
                            isCompanion: true,
                            companionId: comp.uniqueId || comp.id, // Pou≈æij uniqueId pro dynamick√©
                            alive: true,
                            acted: false,
                            equipped: comp.equipped || null // Pro referenci v boji
                        });
                    });
                }
                
                // Cleanup pozic
                window.companionPositionsOverride = null;
                
                // Se≈ôaƒè podle rychlosti (sestupnƒõ)
                const turnOrder = [...units].sort((a, b) => b.speed - a.speed);
                
                // Initialize combat state - 2 AKCE SYST√âM
                window.combatState = {
                    units: units,
                    turnOrder: turnOrder,
                    currentTurnIndex: 0,
                    round: 1,
                    selectedUnit: null,
                    selectedAction: null,
                    validMoves: [],
                    validTargets: [],
                    combatType: combatType,
                    isVillageRaid: combatType === 'settlement_raid',
                    isDungeon: combatType === 'dungeon',
                    log: ['‚öîÔ∏è Boj zaƒç√≠n√°! Ka≈æd√Ω m√° 2 akce za kolo.'],
                    terrain: generateCombatTerrain(),
                    manualCompanions: state.settings?.manualCompanions || false // Ruƒçn√≠ ovl√°d√°n√≠ spoleƒçn√≠k≈Ø
                };
                
                // === TECHNIK BONUSY - PAST A Vƒö≈ΩIƒåKA ===
                const companionBonuses = getAllCompanionBonuses();
                
                // Past - zp≈Øsob√≠ damage na zaƒç√°tku boje n√°hodn√©mu nep≈ô√≠teli
                if (companionBonuses.canTrap) {
                    const enemies = units.filter(u => u.team === 'enemy' && u.alive);
                    if (enemies.length > 0) {
                        const trapTarget = enemies[Math.floor(Math.random() * enemies.length)];
                        const trapDamage = 15 + Math.floor(Math.random() * 16); // 15-30 DMG
                        trapTarget.hp = Math.max(0, trapTarget.hp - trapDamage);
                        if (trapTarget.hp <= 0) trapTarget.alive = false;
                        window.combatState.log.push(`ü™§ Past zas√°hla ${trapTarget.name} za ${trapDamage} DMG!`);
                        addLog(`ü™§ Past zas√°hla ${trapTarget.name} za ${trapDamage} DMG`, 'ü™§');
                    }
                }
                
                // Vƒõ≈æiƒçka - ulo≈æ√≠ bonus damage pro ka≈æd√© kolo
                if (companionBonuses.turretDamage > 0) {
                    window.combatState.turretDamage = companionBonuses.turretDamage;
                    window.combatState.log.push(`üî´ Vƒõ≈æiƒçka p≈ôipravena (+${companionBonuses.turretDamage} DMG ka≈æd√© kolo)`);
                }
                
                // Robot - silnƒõj≈°√≠ verze vƒõ≈æiƒçky
                if (companionBonuses.canBuildRobot) {
                    window.combatState.robotDamage = 20; // Robot dƒõl√° 20 DMG
                    window.combatState.log.push(`ü§ñ Bojov√Ω robot aktivov√°n (+20 DMG ka≈æd√© kolo)`);
                }
                
                // Nastav 2 akce ka≈æd√© jednotce
                units.forEach(u => {
                    u.actionsLeft = 2;
                    u.maxActions = 2;
                    u.defending = false;
                });
                
                // Zaƒçni prvn√≠ tah
                startNextTurn();
                
                renderHeroesCombatUI();
                document.getElementById('modal').classList.add('show');
            }, 100);
        }
        
        function generateCombatTerrain() {
            const terrain = [];
            const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
            
            // Ter√©n podle lokace
            let terrainPool = [
                { type: 'forest', icon: 'üå≤', defenseBonus: 0.2, name: 'Les', weight: 3 },
                { type: 'rock', icon: 'ü™®', blocked: true, name: 'Sk√°la', weight: 2 },
                { type: 'bush', icon: 'üåø', defenseBonus: 0.1, name: 'Ke≈ô', weight: 3 },
                { type: 'rubble', icon: 'üß±', defenseBonus: 0.1, speedPenalty: 0.3, name: 'Trosky', weight: 2 },
                { type: 'barrel', icon: 'üõ¢Ô∏è', defenseBonus: 0.15, name: 'Sudy', weight: 2 },
                { type: 'crate', icon: 'üì¶', defenseBonus: 0.1, name: 'Bedny', weight: 2 }
            ];
            
            // Speci√°ln√≠ ter√©n podle typu lokace
            if (loc?.id?.includes('swamp') || loc?.id?.includes('water') || loc?.id?.includes('lake')) {
                terrainPool = [
                    { type: 'water', icon: 'üíß', speedPenalty: 0.5, name: 'Voda', weight: 4 },
                    { type: 'deepwater', icon: 'üåä', blocked: true, name: 'Hlubok√° voda', weight: 2 },
                    { type: 'reed', icon: 'üåæ', defenseBonus: 0.1, name: 'R√°kos√≠', weight: 3 },
                    { type: 'mud', icon: 'üü§', speedPenalty: 0.3, name: 'Bahno', weight: 3 }
                ];
            } else if (loc?.id?.includes('forest') || loc?.id?.includes('grove')) {
                terrainPool = [
                    { type: 'forest', icon: 'üå≤', defenseBonus: 0.2, name: 'Les', weight: 4 },
                    { type: 'tree', icon: 'üå≥', blocked: true, name: 'Strom', weight: 2 },
                    { type: 'bush', icon: 'üåø', defenseBonus: 0.1, name: 'Ke≈ô', weight: 3 },
                    { type: 'log', icon: 'ü™µ', defenseBonus: 0.1, name: 'Kl√°da', weight: 2 }
                ];
            } else if (loc?.id?.includes('city') || loc?.id?.includes('ruin') || loc?.id?.includes('mall')) {
                terrainPool = [
                    { type: 'rubble', icon: 'üß±', defenseBonus: 0.15, speedPenalty: 0.2, name: 'Trosky', weight: 3 },
                    { type: 'car', icon: 'üöó', blocked: true, name: 'Vrak auta', weight: 2 },
                    { type: 'wall', icon: 'üèöÔ∏è', blocked: true, name: 'Zeƒè', weight: 2 },
                    { type: 'barrel', icon: 'üõ¢Ô∏è', defenseBonus: 0.15, name: 'Sudy', weight: 2 },
                    { type: 'fire', icon: 'üî•', damage: 8, name: 'Ohe≈à', weight: 1 }
                ];
            } else if (loc?.id?.includes('factory') || loc?.id?.includes('plant') || loc?.id?.includes('power')) {
                terrainPool = [
                    { type: 'machine', icon: '‚öôÔ∏è', blocked: true, name: 'Stroj', weight: 3 },
                    { type: 'barrel', icon: 'üõ¢Ô∏è', defenseBonus: 0.15, name: 'Sudy', weight: 2 },
                    { type: 'toxic', icon: '‚ò¢Ô∏è', damage: 5, radiation: 3, name: 'Toxick√Ω odpad', weight: 2 },
                    { type: 'crate', icon: 'üì¶', defenseBonus: 0.1, name: 'Bedny', weight: 2 },
                    { type: 'pipe', icon: 'üî©', defenseBonus: 0.1, name: 'Potrub√≠', weight: 2 }
                ];
            } else if (loc?.id?.includes('cave') || loc?.id?.includes('mine') || loc?.id?.includes('bunker')) {
                terrainPool = [
                    { type: 'rock', icon: 'ü™®', blocked: true, name: 'Sk√°la', weight: 3 },
                    { type: 'stalactite', icon: 'üóø', blocked: true, name: 'Stalagmit', weight: 2 },
                    { type: 'pit', icon: 'üï≥Ô∏è', damage: 10, name: 'Propast', weight: 1 },
                    { type: 'crystal', icon: 'üíé', defenseBonus: 0.1, name: 'Krystal', weight: 2 }
                ];
            }
            
            // P≈ôidej univerz√°ln√≠ ter√©ny
            terrainPool.push({ type: 'fire', icon: 'üî•', damage: 8, name: 'Ohe≈à', weight: 1 });
            
            // Celkov√° v√°ha pro weighted random
            const totalWeight = terrainPool.reduce((sum, t) => sum + t.weight, 0);
            
            // Vygeneruj m≈ô√≠≈æku
            for (let y = 0; y < COMBAT_GRID.rows; y++) {
                terrain[y] = [];
                for (let x = 0; x < COMBAT_GRID.cols; x++) {
                    // St≈ôedn√≠ sloupce (spawn z√≥ny) nechej voln√©
                    const isSpawnZone = x <= 1 || x >= COMBAT_GRID.cols - 2;
                    const isCenterPath = y === Math.floor(COMBAT_GRID.rows / 2);
                    
                    // 20-30% ≈°ance na ter√©n, m√©nƒõ ve spawn z√≥n√°ch
                    let terrainChance = isSpawnZone ? 0.08 : (isCenterPath ? 0.15 : 0.25);
                    
                    if (Math.random() < terrainChance) {
                        // Weighted random selection
                        let roll = Math.random() * totalWeight;
                        let selected = terrainPool[0];
                        for (const t of terrainPool) {
                            roll -= t.weight;
                            if (roll <= 0) {
                                selected = t;
                                break;
                            }
                        }
                        terrain[y][x] = { ...selected };
                        delete terrain[y][x].weight; // Nepot≈ôebujeme weight v ulo≈æen√©m ter√©nu
                    } else {
                        terrain[y][x] = { type: 'empty', icon: '¬∑' };
                    }
                }
            }
            
            // Zajisti pr≈Øchodnou cestu (alespo≈à jedna cesta z ka≈æd√© strany)
            const midY = Math.floor(COMBAT_GRID.rows / 2);
            for (let x = 0; x < COMBAT_GRID.cols; x++) {
                if (terrain[midY][x].blocked) {
                    terrain[midY][x] = { type: 'empty', icon: '¬∑' };
                }
            }
            
            return terrain;
        }
        
        function startNextTurn() {
            const cs = window.combatState;
            
            // Nejd≈ô√≠v zkontroluj konec boje
            if (checkCombatEnd()) return;
            
            // Najdi dal≈°√≠ ≈æivou jednotku s akcemi
            let attempts = 0;
            while (attempts < cs.turnOrder.length * 2) {
                const unit = cs.turnOrder[cs.currentTurnIndex];
                
                if (unit && unit.alive && unit.actionsLeft > 0) {
                    cs.selectedUnit = unit;
                    cs.selectedAction = null;
                    cs.validMoves = [];
                    cs.validTargets = [];
                    
                    // Nep≈ô√≠tel - automatick√Ω AI tah
                    if (unit.team === 'enemy') {
                        setTimeout(() => performAITurn(unit), 500);
                    }
                    // Spoleƒçn√≠k - AI nebo manu√°ln√≠ ovl√°d√°n√≠
                    else if (unit.isCompanion) {
                        if (cs.manualCompanions) {
                            // Manu√°ln√≠ ovl√°d√°n√≠ - hr√°ƒç ovl√°d√° spoleƒçn√≠ka
                            renderHeroesCombatUI();
                        } else {
                            // Automatick√© AI
                            setTimeout(() => performCompanionAITurn(unit), 400);
                        }
                    }
                    // Hr√°ƒç - ƒçek√° na input
                    return;
                }
                
                cs.currentTurnIndex = (cs.currentTurnIndex + 1) % cs.turnOrder.length;
                attempts++;
                
                // Pokud v≈°ichni odehr√°li, nov√© kolo
                if (cs.currentTurnIndex === 0) {
                    startNewRound();
                    return;
                }
            }
        }
        
        function performCompanionAITurn(unit) {
            const cs = window.combatState;
            if (!unit.alive || unit.actionsLeft <= 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
            if (enemies.length === 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            enemies.sort((a, b) => {
                const distA = Math.max(Math.abs(a.x - unit.x), Math.abs(a.y - unit.y));
                const distB = Math.max(Math.abs(b.x - unit.x), Math.abs(b.y - unit.y));
                return distA - distB;
            });
            
            const target = enemies[0];
            let dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
            let attacks = 0;
            
            // Helper funkce pro kontrolu pr≈Øchodnosti pole
            const isPassable = (x, y) => {
                if (x < 0 || x >= COMBAT_GRID.cols || y < 0 || y >= COMBAT_GRID.rows) return false;
                // Kontrola ter√©nu (sk√°ly, voda, auta, zdi...)
                const terrain = cs.terrain[y]?.[x];
                if (terrain && terrain.blocked) return false;
                // Kontrola jednotek
                const unitOnTile = cs.units.some(u => u.alive && u.x === x && u.y === y);
                if (unitOnTile) return false;
                return true;
            };
            
            // Najdi nejlep≈°√≠ pohyb k c√≠li s ohledem na p≈ôek√°≈æky
            const findBestMove = () => {
                const directions = [
                    { dx: 0, dy: -1 }, { dx: 0, dy: 1 }, { dx: -1, dy: 0 }, { dx: 1, dy: 0 },
                    { dx: -1, dy: -1 }, { dx: 1, dy: -1 }, { dx: -1, dy: 1 }, { dx: 1, dy: 1 }
                ];
                
                let bestMove = null;
                let bestDist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
                
                for (const dir of directions) {
                    const newX = unit.x + dir.dx;
                    const newY = unit.y + dir.dy;
                    
                    if (isPassable(newX, newY)) {
                        const newDist = Math.max(Math.abs(target.x - newX), Math.abs(target.y - newY));
                        if (newDist < bestDist) {
                            bestDist = newDist;
                            bestMove = { x: newX, y: newY };
                        }
                    }
                }
                
                return bestMove;
            };
            
            // 2 akce - pohyb + √∫tok nebo 2x √∫tok
            for (let action = 0; action < 2; action++) {
                if (dist <= 1) {
                    performCombatAttack(unit, target);
                    attacks++;
                } else {
                    // Pou≈æij pathfinding m√≠sto p≈ô√≠m√©ho pohybu
                    const move = findBestMove();
                    if (move) {
                        unit.x = move.x;
                        unit.y = move.y;
                    }
                    
                    dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
                }
            }
            
            if (attacks > 0) {
                cs.log.push(`üêæ ${unit.name} (${attacks}x √∫tok)`);
            }
            
            // Synchronizuj HP spoleƒçn√≠ka
            const comp = state.companions?.find(c => c.id === unit.companionId);
            if (comp) comp.hp = Math.max(0, unit.hp);
            
            setTimeout(() => {
                unit.actionsLeft = 0;
                useAction(unit, 0);
            }, 300);
        }
        
        function startNewRound() {
            const cs = window.combatState;
            cs.round++;
            cs.log.push(`--- Kolo ${cs.round} ---`);
            
            // === Vƒö≈ΩIƒåKA ST≈ò√çL√ç KA≈ΩD√â KOLO ===
            if (cs.turretDamage && cs.turretDamage > 0) {
                const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
                if (enemies.length > 0) {
                    const turretTarget = enemies[Math.floor(Math.random() * enemies.length)];
                    turretTarget.hp = Math.max(0, turretTarget.hp - cs.turretDamage);
                    cs.log.push(`üî´ Vƒõ≈æiƒçka st≈ô√≠l√≠ na ${turretTarget.name}: -${cs.turretDamage} HP`);
                    if (turretTarget.hp <= 0) {
                        turretTarget.alive = false;
                        cs.log.push(`üíÄ ${turretTarget.name} byl sest≈ôelen vƒõ≈æiƒçkou!`);
                    }
                }
            }
            
            // === ROBOT ST≈ò√çL√ç KA≈ΩD√â KOLO ===
            if (cs.robotDamage && cs.robotDamage > 0) {
                const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
                if (enemies.length > 0) {
                    const robotTarget = enemies[Math.floor(Math.random() * enemies.length)];
                    robotTarget.hp = Math.max(0, robotTarget.hp - cs.robotDamage);
                    cs.log.push(`ü§ñ Robot √∫toƒç√≠ na ${robotTarget.name}: -${cs.robotDamage} HP`);
                    if (robotTarget.hp <= 0) {
                        robotTarget.alive = false;
                        cs.log.push(`üíÄ ${robotTarget.name} byl zniƒçen robotem!`);
                    }
                }
            }
            
            // Reset akc√≠ a obrany pro v≈°echny
            cs.units.forEach(u => {
                u.actionsLeft = u.maxActions || 2;
                u.defending = false;
                
                // === TER√âNN√ç DAMAGE NA ZAƒå√ÅTKU KOLA ===
                if (u.alive) {
                    const terrain = cs.terrain[u.y]?.[u.x];
                    if (terrain?.damage) {
                        u.hp -= terrain.damage;
                        cs.log.push(`${terrain.icon || 'üî•'} ${u.name} stoj√≠ v ${terrain.name || 'nebezpeƒçn√©m ter√©nu'}: -${terrain.damage} HP`);
                        
                        if (u.hp <= 0) {
                            u.alive = false;
                            u.hp = 0;
                            cs.log.push(`üíÄ ${u.name} zem≈ôel v ${terrain.name || 'ter√©nu'}!`);
                        }
                    }
                    // Radiace z ter√©nu (jen hr√°ƒç)
                    if (terrain?.radiation && u.isPlayer) {
                        state.status.radiation = Math.min(100, state.status.radiation + terrain.radiation);
                        cs.log.push(`‚ò¢Ô∏è +${terrain.radiation} radiace z ${terrain.name || 'ter√©nu'}`);
                    }
                }
                
                // DoT efekty
                if (u.alive && u.poisoned > 0) {
                    const dmg = u.poisoned;
                    u.hp -= dmg;
                    u.poisoned = Math.max(0, u.poisoned - 2);
                    cs.log.push(`‚ò†Ô∏è ${u.name} trp√≠ jedem: -${dmg} HP`);
                    if (u.hp <= 0) {
                        u.alive = false;
                        cs.log.push(`üíÄ ${u.name} zem≈ôel na jed!`);
                    }
                }
                if (u.alive && u.bleeding > 0) {
                    const dmg = u.bleeding;
                    u.hp -= dmg;
                    u.bleeding = Math.max(0, u.bleeding - 1);
                    cs.log.push(`ü©∏ ${u.name} krv√°c√≠: -${dmg} HP`);
                    if (u.hp <= 0) {
                        u.alive = false;
                        cs.log.push(`üíÄ ${u.name} vykrv√°cel!`);
                    }
                }
                if (u.stunned) u.stunned = false;
            });
            
            // Zkontroluj konec boje
            if (checkCombatEnd()) return;
            
            // P≈ôepoƒç√≠tej po≈ôad√≠ (≈æiv√© jednotky)
            cs.turnOrder = cs.units.filter(u => u.alive).sort((a, b) => b.speed - a.speed);
            cs.currentTurnIndex = 0;
            
            startNextTurn();
            renderHeroesCombatUI();
        }
        
        function checkCombatEnd() {
            const cs = window.combatState;
            
            // Ochrana - pokud nen√≠ combatState, nic nedƒõl√°me
            if (!cs || !cs.units) {
                console.error('‚ö†Ô∏è checkCombatEnd: combatState is missing!');
                return false;
            }
            
            const playerUnits = cs.units.filter(u => u.team === 'player' && u.alive);
            const enemyUnits = cs.units.filter(u => u.team === 'enemy' && u.alive);
            
            console.log(`üéÆ checkCombatEnd: ${playerUnits.length} hr√°ƒç≈Ø, ${enemyUnits.length} nep≈ô√°tel ≈æiv√Ωch`);
            
            if (enemyUnits.length === 0) {
                console.log('üèÜ V≈°ichni nep≈ô√°tel√© mrtv√≠ - V√çTƒöZSTV√ç');
                // Synchronizuj HP zpƒõt do state
                const playerUnit = cs.units.find(u => u.isPlayer);
                if (playerUnit) state.char.hp = Math.max(1, playerUnit.hp);
                
                cs.units.filter(u => u.isCompanion).forEach(cu => {
                    // Hledej podle uniqueId nebo id
                    const comp = state.companions.find(c => 
                        c.uniqueId === cu.companionId || c.id === cu.companionId
                    );
                    if (comp) comp.hp = Math.max(0, cu.hp);
                });
                
                setTimeout(() => handleCombatVictory(), 500);
                return true;
            }
            
            if (playerUnits.length === 0) {
                console.log('üíÄ V≈°ichni hr√°ƒçi mrtv√≠ - PROHRA');
                setTimeout(() => handleCombatDefeat(), 500);
                return true;
            }
            
            return false;
        }
        
        function performAITurn(unit) {
            const cs = window.combatState;
            if (!unit.alive || unit.actionsLeft <= 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            // AI pou≈æ√≠v√° obƒõ akce najednou
            const targets = cs.units.filter(u => u.team === 'player' && u.alive);
            if (targets.length === 0) {
                unit.actionsLeft = 0;
                useAction(unit, 0);
                return;
            }
            
            // Se≈ôaƒè podle vzd√°lenosti (Chebyshev)
            targets.sort((a, b) => {
                const distA = Math.max(Math.abs(a.x - unit.x), Math.abs(a.y - unit.y));
                const distB = Math.max(Math.abs(b.x - unit.x), Math.abs(b.y - unit.y));
                return distA - distB;
            });
            
            const target = targets[0];
            // Chebyshev distance - diagon√°ly poƒç√≠taj√≠ jako 1
            let dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
            let actionsUsed = 0;
            
            // Helper pro nalezen√≠ nejlep≈°√≠ho pohybu (vyh√Ωb√° se nebezpeƒçn√©mu ter√©nu)
            const findBestMove = (fromX, fromY, toX, toY) => {
                const possibleMoves = [];
                for (let dx = -1; dx <= 1; dx++) {
                    for (let dy = -1; dy <= 1; dy++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = fromX + dx;
                        const ny = fromY + dy;
                        if (nx < 0 || nx >= COMBAT_GRID.cols || ny < 0 || ny >= COMBAT_GRID.rows) continue;
                        
                        const blocked = cs.units.some(u => u.alive && u.x === nx && u.y === ny);
                        const terrain = cs.terrain[ny]?.[nx];
                        if (blocked || terrain?.blocked) continue;
                        
                        // Vzd√°lenost k c√≠li
                        const newDist = Math.max(Math.abs(toX - nx), Math.abs(toY - ny));
                        // Penalizace za nebezpeƒçn√Ω ter√©n
                        const dangerPenalty = terrain?.damage ? terrain.damage * 0.5 : 0;
                        
                        possibleMoves.push({ x: nx, y: ny, dist: newDist, danger: dangerPenalty, score: newDist + dangerPenalty });
                    }
                }
                // Se≈ôaƒè podle sk√≥re (ni≈æ≈°√≠ = lep≈°√≠)
                possibleMoves.sort((a, b) => a.score - b.score);
                return possibleMoves[0] || null;
            };
            
            // Akce 1: Pohyb nebo √∫tok
            if (dist <= 1) {
                performCombatAttack(unit, target);
                actionsUsed++;
            } else {
                // Pohyb s vyh√Ωb√°n√≠m se nebezpeƒç√≠
                const bestMove = findBestMove(unit.x, unit.y, target.x, target.y);
                
                if (bestMove) {
                    unit.x = bestMove.x;
                    unit.y = bestMove.y;
                    actionsUsed++;
                    
                    // Ter√©nn√≠ damage p≈ôi pohybu
                    const terrain = cs.terrain[bestMove.y]?.[bestMove.x];
                    if (terrain?.damage) {
                        unit.hp -= terrain.damage;
                        cs.log.push(`${terrain.icon || 'üî•'} ${unit.name}: -${terrain.damage} HP`);
                        if (unit.hp <= 0) {
                            unit.alive = false;
                            unit.hp = 0;
                            cs.log.push(`üíÄ ${unit.name} zem≈ôel!`);
                        }
                    }
                }
                
                dist = Math.max(Math.abs(target.x - unit.x), Math.abs(target.y - unit.y));
            }
            
            // Akce 2: Dal≈°√≠ √∫tok nebo pohyb
            if (actionsUsed < 2 && unit.actionsLeft > 1 && unit.alive) {
                if (dist <= 1) {
                    performCombatAttack(unit, target);
                    actionsUsed++;
                } else {
                    // Dal≈°√≠ pohyb
                    const bestMove = findBestMove(unit.x, unit.y, target.x, target.y);
                    
                    if (bestMove) {
                        unit.x = bestMove.x;
                        unit.y = bestMove.y;
                        actionsUsed++;
                        
                        // Ter√©nn√≠ damage
                        const terrain = cs.terrain[bestMove.y]?.[bestMove.x];
                        if (terrain?.damage) {
                            unit.hp -= terrain.damage;
                            cs.log.push(`${terrain.icon || 'üî•'} ${unit.name}: -${terrain.damage} HP`);
                            if (unit.hp <= 0) {
                                unit.alive = false;
                                unit.hp = 0;
                            }
                        }
                    }
                }
            }
            
            cs.log.push(`${unit.icon} ${unit.name} (${actionsUsed} akce)`);
            
            setTimeout(() => {
                unit.actionsLeft = 0;
                useAction(unit, 0);
            }, 300);
        }
        
        function performCombatAttack(attacker, target) {
            const cs = window.combatState;
            
            // Z√≠skej skill efekty c√≠le (pokud je spoleƒçn√≠k)
            let targetSkillEffects = {};
            if (target.isCompanion && target.companionId) {
                const comp = state.companions.find(c => c.id === target.companionId);
                if (comp?.skills) {
                    const skillTree = COMPANION_SKILL_TREES[comp.id];
                    if (skillTree) {
                        comp.skills.forEach(skillId => {
                            Object.values(skillTree.trees).forEach(tree => {
                                const skill = tree.skills.find(s => s.id === skillId);
                                if (skill?.effect) {
                                    Object.entries(skill.effect).forEach(([key, val]) => {
                                        targetSkillEffects[key] = (targetSkillEffects[key] || 0) + val;
                                    });
                                }
                            });
                        });
                    }
                }
            }
            
            // Z√≠skej hr√°ƒçovy obrann√© skilly
            let playerDefenseEffects = {};
            if (target.isPlayer) {
                playerDefenseEffects = getPlayerCombatSkillEffects();
            }
            
            // ≈†t√≠tov√° zeƒè - spoleƒçn√≠k m≈Ø≈æe blokovat √∫tok na hr√°ƒçe
            if (target.isPlayer) {
                const companions = cs.units.filter(u => u.isCompanion && u.alive);
                for (const companion of companions) {
                    const comp = state.companions?.find(c => c.id === companion.companionId);
                    if (comp?.skills) {
                        const skillTree = COMPANION_SKILL_TREES[comp.id];
                        if (skillTree) {
                            let blockChance = 0;
                            comp.skills.forEach(skillId => {
                                Object.values(skillTree.trees).forEach(tree => {
                                    const skill = tree.skills.find(s => s.id === skillId);
                                    if (skill?.effect?.blockForPlayer) {
                                        blockChance += skill.effect.blockForPlayer;
                                    }
                                });
                            });
                            if (blockChance > 0 && Math.random() < blockChance) {
                                cs.log.push(`üõ°Ô∏è ${companion.name} zablokoval √∫tok na ${target.name}!`);
                                // Spoleƒçn√≠k dostane poloviƒçn√≠ damage
                                const blockedDamage = Math.floor(attacker.damage * 0.5);
                                companion.hp -= blockedDamage;
                                cs.log.push(`${companion.icon} ${companion.name} dostal ${blockedDamage} DMG`);
                                if (companion.hp <= 0) {
                                    companion.alive = false;
                                    companion.hp = 0;
                                    cs.log.push(`üíÄ ${companion.name} padl p≈ôi ochranƒõ!`);
                                }
                                return; // √ötok zablokov√°n
                            }
                        }
                    }
                }
            }
            
            // Hr√°ƒç≈Øv skill blokov√°n√≠
            if (target.isPlayer && playerDefenseEffects.blockChance > 0) {
                if (Math.random() < playerDefenseEffects.blockChance) {
                    cs.log.push(`üõ°Ô∏è ${target.name} zablokoval √∫tok! (skill)`);
                    return;
                }
            }
            
            // ≈†ance na √∫hyb (dodge)
            const dodgeChance = targetSkillEffects.dodgeChance || 0;
            if (dodgeChance > 0 && Math.random() < dodgeChance) {
                cs.log.push(`üåÄ ${target.name} se vyhnul √∫toku! (skill)`);
                return;
            }
            
            // ≈†ance p≈ôe≈æ√≠t smrteln√Ω √∫tok (devƒõt ≈æivot≈Ø nebo last_stand)
            let surviveChance = targetSkillEffects.surviveChance || 0;
            if (target.isPlayer && playerDefenseEffects.lastStand > 0) {
                surviveChance = Math.max(surviveChance, playerDefenseEffects.lastStand);
            }
            
            // Z√°kladn√≠ damage
            let damage = attacker.damage;
            
            // === CLASS PASSIVES - OBRANA ===
            if (target.isPlayer) {
                // Tank: Fortress - Blokuje 30% p≈ô√≠choz√≠ho damage
                if (state.char.classId === 'tank') {
                    const reduced = Math.floor(damage * 0.3);
                    damage = damage - reduced;
                    cs.log.push(`üè∞ Blokov√°no ${reduced} damage`);
                }
                
                // Mutant: +10 p≈ôirozen√° obrana a regenerace p≈ôi z√°sahu
                if (state.char.classId === 'mutant') {
                    state.char.hp = Math.min(state.char.maxHp, state.char.hp + 2);
                    cs.log.push(`ü¶é Regenerace +2 HP`);
                }
            }
            
            // Hr√°ƒçova obrana ze skill≈Ø
            let defense = target.defense;
            if (target.isPlayer && playerDefenseEffects.defense > 0) {
                defense += playerDefenseEffects.defense;
            }
            
            // Mutant base defense
            if (target.isPlayer && state.char.classId === 'mutant') {
                defense += 10;
            }
            
            // Ter√©nn√≠ bonus obrany
            const terrain = cs.terrain[target.y]?.[target.x];
            if (terrain?.defenseBonus) {
                defense = Math.floor(defense * (1 + terrain.defenseBonus));
            }
            
            // Kritick√Ω z√°sah (10% ≈°ance)
            const isCrit = Math.random() < 0.1;
            if (isCrit) damage = Math.floor(damage * 2);
            
            // Aplikuj obranu
            const finalDamage = Math.max(1, damage - defense);
            target.hp -= finalDamage;
            
            // Zvuky boje
            if (typeof playCombatSound === 'function') {
                if (attacker.team === 'player' || attacker.isPlayer) {
                    // Hr√°ƒç √∫toƒç√≠
                    const weaponType = attacker.weaponType || 'melee';
                    playCombatSound('playerAttack', weaponType);
                }
                if (target.isPlayer) {
                    playCombatSound('playerHit');
                } else {
                    playCombatSound(isCrit ? 'crit' : 'enemyHit');
                }
            }
            
            cs.log.push(`${attacker.icon} ${attacker.name} ‚Üí ${target.icon} ${target.name}: ${finalDamage} DMG${isCrit ? ' üí•KRIT!' : ''}`);
            
            // Efekty (jed, krv√°cen√≠)
            if (attacker.poisonChance && Math.random() < attacker.poisonChance) {
                target.poisoned = Math.max(target.poisoned || 0, 5);
                cs.log.push(`‚ò†Ô∏è ${target.name} byl otr√°ven!`);
            }
            
            if (target.hp <= 0) {
                // Survivor: Last Stand - 25% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫der
                let lastStandChance = surviveChance;
                if (target.isPlayer && state.char.classId === 'survivor') {
                    lastStandChance = Math.max(lastStandChance, 0.25);
                }
                
                if (lastStandChance > 0 && Math.random() < lastStandChance) {
                    target.hp = 1;
                    if (target.isPlayer && state.char.classId === 'survivor') {
                        cs.log.push(`üí™ LAST STAND! P≈ôe≈æil jsi s 1 HP!`);
                    } else {
                        cs.log.push(`‚ú® ${target.name} p≈ôe≈æil na posledn√≠ chv√≠li!`);
                    }
                } else {
                    target.alive = false;
                    target.hp = 0;
                    cs.log.push(`üíÄ ${target.name} byl pora≈æen!`);
                    SoundSystem.play('combat_hit');
                    if (typeof playCombatSound === 'function') playCombatSound('enemyDeath');
                }
            }
        }
        
        // Spot≈ôebuje 1 akci (pohyb/√∫tok/item) nebo v≈°echny (obrana/konec tahu)
        function useAction(unit, count = 1) {
            const cs = window.combatState;
            unit.actionsLeft = Math.max(0, unit.actionsLeft - count);
            
            if (checkCombatEnd()) return;
            
            // Pokud jednotka nem√° akce, p≈ôejdi na dal≈°√≠
            if (unit.actionsLeft <= 0) {
                cs.currentTurnIndex = (cs.currentTurnIndex + 1) % cs.turnOrder.length;
                
                // Zkontroluj jestli v≈°ichni odehr√°li (v≈°ichni maj√≠ 0 akc√≠)
                const anyoneHasActions = cs.turnOrder.some(u => u.alive && u.actionsLeft > 0);
                if (!anyoneHasActions) {
                    startNewRound();
                    return;
                }
            }
            
            startNextTurn();
            renderHeroesCombatUI();
        }
        
        function endUnitTurn(unit) {
            // Ukonƒç√≠ tah jednotky (spot≈ôebuje v≈°echny zb√Ωvaj√≠c√≠ akce)
            unit.actionsLeft = 0;
            useAction(unit, 0);
        }
        
        // === PLAYER ACTIONS ===
        
        function selectAction(action) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            cs.selectedAction = action;
            
            if (action === 'move') {
                calculateValidMoves(unit);
                renderHeroesCombatUI();
            } else if (action === 'attack') {
                calculateValidTargets(unit);
                renderHeroesCombatUI();
            } else if (action === 'defend') {
                // Obrana - spot≈ôebuje V≈†ECHNY zb√Ωvaj√≠c√≠ akce, ale d√°v√° velk√Ω bonus
                unit.defending = true;
                const defBonus = unit.actionsLeft === 2 ? 100 : 50; // 2 akce = +100%, 1 akce = +50%
                unit.defenseBonus = defBonus;
                cs.log.push(`üõ°Ô∏è ${unit.name} se br√°n√≠ (+${defBonus}% obrana do dal≈°√≠ho kola)`);
                endUnitTurn(unit);
            } else if (action === 'weapon') {
                showCombatWeaponSwitch();
                // Nerendruj UI - showCombatWeaponSwitch to ≈ôe≈°√≠ samo
            } else if (action === 'wait') {
                cs.log.push(`‚è≠Ô∏è ${unit.name} ukonƒçil tah (${unit.actionsLeft} akce nevyu≈æity)`);
                endUnitTurn(unit);
            }
        }
        
        // === V√ùMƒöNA ZBRANƒö V BOJI ===
        function showCombatWeaponSwitch() {
            const cs = window.combatState;
            const weapons = state.inv.filter(i => i.type === 'weapon');
            const currentWeapon = state.equipped?.weapon;
            
            let weaponsHtml = '<div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            weaponsHtml += '<div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">V√Ωmƒõna zbranƒõ spot≈ôebuje 1 akci</div>';
            
            if (currentWeapon) {
                const ammoInfo = currentWeapon.ammoType ? 
                    ` | üî´ ${getAmmoCount(currentWeapon.ammoType)} ${getAmmoName(currentWeapon.ammoType)}` : '';
                weaponsHtml += `<div style="background: #2a3a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #4a6a4a;">
                    <span style="color: #8bc34a;">Aktu√°ln√≠:</span> ${currentWeapon.icon || '‚öîÔ∏è'} ${currentWeapon.name} (‚öîÔ∏è${currentWeapon.damage || 10})
                    ${currentWeapon.ammoType ? `<span style="color: #ff9800;"> üéØ</span>` : `<span style="color: #64b5f6;"> üó°Ô∏è</span>`}
                    ${ammoInfo}
                </div>`;
            } else {
                weaponsHtml += `<div style="background: #3a3a3a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #555;">
                    <span style="color: #888;">Aktu√°ln√≠:</span> üëä Hol√© ruce (‚öîÔ∏è5)
                </div>`;
            }
            
            if (weapons.length === 0) {
                weaponsHtml += '<p style="color: #666; text-align: center;">Nem√°≈° ≈æ√°dn√© zbranƒõ v invent√°≈ôi</p>';
            } else {
                weapons.forEach(w => {
                    const isEquipped = currentWeapon?.id === w.id;
                    const hasAmmo = !w.ammoType || getAmmoCount(w.ammoType) > 0;
                    const ammoCount = w.ammoType ? getAmmoCount(w.ammoType) : null;
                    const weaponRange = w.ammoType ? 'üéØ' : 'üó°Ô∏è';
                    const ammoText = w.ammoType ? ` üî´${ammoCount}` : '';
                    const bgColor = isEquipped ? '#4a6a4a' : (hasAmmo ? '#2a3a4a' : '#4a2a2a');
                    
                    weaponsHtml += `<button class="btn" onclick="switchCombatWeapon('${w.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.4rem; background: ${bgColor}; text-align: left; font-size: 0.85rem;" ${isEquipped ? 'disabled' : ''}>
                        ${w.icon || '‚öîÔ∏è'} ${w.name} - ‚öîÔ∏è${w.damage || 10} ${weaponRange}${ammoText}${!hasAmmo ? ' ‚ö†Ô∏è' : ''}
                    </button>`;
                });
            }
            
            // Mo≈ænost odlo≈æit zbra≈à (pƒõsti)
            weaponsHtml += `<button class="btn" onclick="switchCombatWeapon('fists')" style="display: block; width: 100%; margin-top: 0.5rem; padding: 0.4rem; background: #3a3a3a; text-align: left; font-size: 0.85rem;">
                üëä Hol√© ruce - ‚öîÔ∏è5 üó°Ô∏è
            </button>`;
            
            weaponsHtml += '</div>';
            weaponsHtml += '<button class="btn" onclick="renderHeroesCombatUI()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt do boje</button>';
            
            // Zobraz p≈ô√≠mo v modal contentu
            document.getElementById('modalContent').innerHTML = `
                <div style="background: linear-gradient(180deg, #0d1520 0%, #0a0f15 100%); margin: -1rem; padding: 1rem; border-radius: 8px;">
                    <h3 style="text-align: center; margin-bottom: 1rem; color: #ffd700;">üîÑ V√Ωmƒõna zbranƒõ</h3>
                    ${weaponsHtml}
                </div>
            `;
        }
        
        function switchCombatWeapon(weaponId) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || unit.actionsLeft <= 0) return;
            
            if (weaponId === 'fists') {
                state.equipped.weapon = null;
                cs.log.push(`üëä ${unit.name} odlo≈æil zbra≈à`);
            } else {
                const weapon = state.inv.find(i => i.id === weaponId);
                if (weapon) {
                    state.equipped.weapon = weapon;
                    cs.log.push(`üîÑ ${unit.name} tasil ${weapon.name}`);
                }
            }
            
            // Aktualizuj damage jednotky
            unit.damage = calculateDamage();
            
            useAction(unit, 1);
        }
        
        function calculateValidMoves(unit) {
            const cs = window.combatState;
            cs.validMoves = [];
            
            // Pohyb pouze o 1 pole (4 smƒõry + diagon√°ly)
            const range = 1;
            for (let dx = -range; dx <= range; dx++) {
                for (let dy = -range; dy <= range; dy++) {
                    if (dx === 0 && dy === 0) continue;
                    const newX = unit.x + dx;
                    const newY = unit.y + dy;
                    
                    // Kontrola hranic
                    if (newX < 0 || newX >= COMBAT_GRID.cols || newY < 0 || newY >= COMBAT_GRID.rows) continue;
                    
                    // Kontrola koliz√≠
                    const occupied = cs.units.some(u => u.alive && u.x === newX && u.y === newY);
                    const terrainBlocked = cs.terrain[newY]?.[newX]?.blocked;
                    
                    if (!occupied && !terrainBlocked) {
                        cs.validMoves.push({ x: newX, y: newY });
                    }
                }
            }
        }
        
        function calculateValidTargets(unit) {
            const cs = window.combatState;
            cs.validTargets = [];
            
            // Spoleƒçn√≠ci √∫toƒç√≠ v≈ædy na bl√≠zko
            const isCompanion = unit.isCompanion;
            
            const weapon = !isCompanion ? state.equipped?.weapon : null;
            const isRanged = weapon?.ammoType; // St≈ôeln√° zbra≈à m√° ammoType
            
            // Kontrola munice pro st≈ôeln√© zbranƒõ (jen hr√°ƒç)
            if (isRanged && !isCompanion) {
                const ammoCount = getAmmoCount(weapon.ammoType);
                if (ammoCount <= 0) {
                    cs.log.push(`‚ö†Ô∏è Nem√°≈° ${getAmmoName(weapon.ammoType)}! Vymƒõ≈à zbra≈à nebo dopl≈à munici.`);
                    return;
                }
            }
            
            // Dosah zbranƒõ:
            // - St≈ôeln√° (luk, pistole, pu≈°ka): neomezen√Ω dosah (cel√° mapa)
            // - Zbra≈à na bl√≠zko (meƒç, n≈Ø≈æ, sekera): 1 pole vƒçetnƒõ diagon√°l (8 smƒõr≈Ø)
            // - Spoleƒçn√≠ci: v≈ædy na bl√≠zko (1 pole)
            // - Hol√© ruce: 1 pole vƒçetnƒõ diagon√°l
            const maxRange = (isRanged && !isCompanion) ? 99 : 1;
            
            cs.units.filter(u => u.team === 'enemy' && u.alive).forEach(enemy => {
                // Chebyshev distance - poƒç√≠t√° diagon√°ly jako 1 pole
                const dist = Math.max(Math.abs(enemy.x - unit.x), Math.abs(enemy.y - unit.y));
                
                if (dist <= maxRange) {
                    // Pro st≈ôeln√© zbranƒõ p≈ôidej info o vzd√°lenosti
                    enemy._combatDist = dist;
                    cs.validTargets.push(enemy);
                }
            });
            
            // Pokud nem√°m st≈ôelnou zbra≈à a nikdo nen√≠ v dosahu, upozorni
            if (maxRange === 1 && cs.validTargets.length === 0) {
                const enemies = cs.units.filter(u => u.team === 'enemy' && u.alive);
                if (enemies.length > 0) {
                    cs.log.push(`‚ö†Ô∏è ≈Ω√°dn√Ω nep≈ô√≠tel v dosahu! P≈ôibli≈æ se${!isCompanion ? ' nebo vymƒõ≈à zbra≈à' : ''}.`);
                }
            }
        }
        
        function clickCell(x, y) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            if (cs.selectedAction === 'move') {
                // Pohyb - spot≈ôebuje 1 akci
                const validMove = cs.validMoves.find(m => m.x === x && m.y === y);
                if (validMove) {
                    unit.x = x;
                    unit.y = y;
                    cs.log.push(`üö∂ ${unit.name} se p≈ôesunul [${unit.actionsLeft - 1} akce zb√Ωv√°]`);
                    
                    // Ter√©nn√≠ damage
                    const terrain = cs.terrain[y]?.[x];
                    if (terrain?.damage) {
                        unit.hp -= terrain.damage;
                        cs.log.push(`üî• ${terrain.name || 'Ter√©n'} zp≈Øsobil ${terrain.damage} DMG!`);
                    }
                    if (terrain?.radiation && unit.isPlayer) {
                        state.status.radiation = Math.min(100, state.status.radiation + terrain.radiation);
                        cs.log.push(`‚ò¢Ô∏è +${terrain.radiation} radiace!`);
                    }
                    
                    cs.selectedAction = null;
                    cs.validMoves = [];
                    useAction(unit, 1);
                }
            } else if (cs.selectedAction === 'attack') {
                // √ötok na jednotku v bu≈àce
                const target = cs.units.find(u => u.x === x && u.y === y && u.alive && u.team === 'enemy');
                if (target && cs.validTargets.includes(target)) {
                    playerAttackTarget(target);
                }
            }
        }
        
        function playerAttackTarget(target) {
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            
            // Nano armor regenerace na zaƒç√°tku tahu hr√°ƒçe
            if (!unit.isCompanion) {
                const armorEffects = getArmorSpecialEffects();
                if (armorEffects.regenPerTurn > 0 && state.char.hp < state.char.maxHp) {
                    const healAmt = Math.min(armorEffects.regenPerTurn, state.char.maxHp - state.char.hp);
                    state.char.hp += healAmt;
                    cs.log.push(`üî¨ Nano zbroj regeneruje +${healAmt} HP`);
                }
            }
            
            // Spoleƒçn√≠k nebo hr√°ƒç?
            const isCompanion = unit.isCompanion;
            
            // Z√≠skej skill efekty spoleƒçn√≠ka
            let companionSkillEffects = {};
            if (isCompanion && unit.companionId) {
                const comp = state.companions.find(c => c.id === unit.companionId);
                if (comp?.skills) {
                    const skillTree = COMPANION_SKILL_TREES[comp.id];
                    if (skillTree) {
                        comp.skills.forEach(skillId => {
                            Object.values(skillTree.trees).forEach(tree => {
                                const skill = tree.skills.find(s => s.id === skillId);
                                if (skill?.effect) {
                                    Object.entries(skill.effect).forEach(([key, val]) => {
                                        companionSkillEffects[key] = (companionSkillEffects[key] || 0) + val;
                                    });
                                }
                            });
                        });
                    }
                }
            }
            
            // Z√≠skej skill efekty hr√°ƒçe
            const playerSkillEffects = !isCompanion ? getPlayerCombatSkillEffects() : {};
            
            // Spot≈ôeba munice pro st≈ôeln√© zbranƒõ (jen hr√°ƒç)
            const weapon = !isCompanion ? state.equipped?.weapon : null;
            if (weapon?.ammoType) {
                if (!consumeAmmo(weapon.ammoType, 1)) {
                    cs.log.push(`‚ö†Ô∏è Nem√°≈° n√°boje!`);
                    renderHeroesCombatUI();
                    return;
                }
            }
            
            // Z√°kladn√≠ damage
            let damage = isCompanion ? unit.damage : calculateDamage();
            
            // === CLASS PASSIVES - √öTOK ===
            if (!isCompanion) {
                // Raider: Rage - Pod 30% HP +40% damage (nerfed from 50%)
                if (state.char.classId === 'raider' && state.char.hp / state.char.maxHp < 0.3) {
                    damage = Math.floor(damage * 1.4);
                    cs.log.push(`üò§ RAGE! +40% damage!`);
                }
                
                // Berserker: Frenzy stacks (+8% per stack, max 5)
                if (state.char.classId === 'berserker') {
                    const frenzyStacks = (state.buffs || []).filter(b => b.id === 'frenzy' && b.expires > Date.now()).length;
                    if (frenzyStacks > 0) {
                        damage = Math.floor(damage * (1 + frenzyStacks * 0.08));
                        cs.log.push(`üî• Frenzy! (+${Math.round(frenzyStacks * 8)}% DMG)`);
                    }
                }
                
                // Alchemist: Poison na ka≈æd√Ω √∫tok (8 DOT buffed from 5)
                if (state.char.classId === 'alchemist') {
                    target.poisoned = Math.max(target.poisoned || 0, 8);
                    cs.log.push(`‚ò†Ô∏è Jed aplikov√°n! (+8 DOT)`);
                }
                
                // Demolitionist: 12% ≈°ance na AoE (nerfed from 15%), 40% splash
                if (state.char.classId === 'demolitionist' && Math.random() < 0.12) {
                    const nearbyEnemies = cs.units.filter(u => 
                        u.team === 'enemy' && u.alive && u.id !== target.id &&
                        Math.max(Math.abs(u.x - target.x), Math.abs(u.y - target.y)) <= 1
                    );
                    nearbyEnemies.forEach(enemy => {
                        const aoeDamage = Math.floor(damage * 0.4); // nerfed from 0.5
                        enemy.hp -= aoeDamage;
                        cs.log.push(`üí• BOOM! ${enemy.icon}: ${aoeDamage} DMG`);
                        if (enemy.hp <= 0) {
                            enemy.alive = false;
                            enemy.hp = 0;
                        }
                    });
                }
                
                // Engineer: +15% DMG s craftƒõn√Ωmi zbranƒõmi
                if (state.char.classId === 'engineer' && state.equipped?.weapon) {
                    const craftedWeapons = ['stone_axe', 'club', 'spear', 'bow', 'crossbow_craft', 'hammer_craft', 'axe_craft', 'serrated_blade', 'barbed_club', 'pipe_pistol', 'pipe_rifle', 'pipe_shotgun'];
                    if (craftedWeapons.includes(state.equipped.weapon.id)) {
                        damage = Math.floor(damage * 1.15);
                        cs.log.push(`üîß Craftƒõn√° zbra≈à! +15% DMG`);
                    }
                }
                
                // Mechanik Pepa NPC bonus: +15/25% DMG s craftƒõn√Ωmi zbranƒõmi
                const npcBonuses = getNPCBonuses();
                if (npcBonuses.craftedWeaponBonus > 0 && state.equipped?.weapon) {
                    const craftedWeapons = ['stone_axe', 'club', 'spear', 'bow', 'crossbow_craft', 'hammer_craft', 'axe_craft', 'serrated_blade', 'barbed_club', 'pipe_pistol', 'pipe_rifle', 'pipe_shotgun', 'slingshot'];
                    if (craftedWeapons.includes(state.equipped.weapon.id)) {
                        damage = Math.floor(damage * (1 + npcBonuses.craftedWeaponBonus));
                        cs.log.push(`üîß Pep≈Øv bonus! +${Math.round(npcBonuses.craftedWeaponBonus * 100)}% DMG`);
                    }
                }
            }
            
            // Hr√°ƒç≈Øv damage bonus ze skill≈Ø (power_strike atd.)
            if (!isCompanion && playerSkillEffects.damageBonus > 0) {
                damage = Math.floor(damage * (1 + playerSkillEffects.damageBonus));
            }
            
            // Berserk bonus - v√≠c damage p≈ôi n√≠zk√©m HP
            if (!isCompanion && playerSkillEffects.berserkerBonus > 0) {
                const hpPercent = state.char.hp / state.char.maxHp;
                if (hpPercent < 0.3) {
                    damage = Math.floor(damage * (1 + playerSkillEffects.berserkerBonus));
                    cs.log.push(`üò§ Berserk skill! (+${Math.round(playerSkillEffects.berserkerBonus * 100)}% DMG)`);
                }
            }
            
            // Execute bonus - v√≠c damage na low HP nep≈ô√°tele
            if (!isCompanion && playerSkillEffects.executeBonus > 0) {
                if (target.hp / target.maxHp < 0.2) {
                    damage = Math.floor(damage * (1 + playerSkillEffects.executeBonus));
                    cs.log.push(`‚ö∞Ô∏è Poprava! (+${Math.round(playerSkillEffects.executeBonus * 100)}% DMG)`);
                }
            }
            
            // Kritick√Ω z√°sah
            // Assassin: +40% crit chance
            let baseCritChance = isCompanion ? 0.1 : calculateCritChance();
            if (!isCompanion && state.char.classId === 'assassin') {
                baseCritChance += 0.4;
            }
            let critChance = baseCritChance + (isCompanion ? (companionSkillEffects.critChance || 0) : (playerSkillEffects.critChance || 0));
            const isCrit = Math.random() < critChance;
            if (isCrit) {
                // Assassin: Kritick√Ω z√°sah dƒõl√° 2.5x damage (nerfed from 3x)
                let critMultiplier = 2 + (companionSkillEffects.critDamage || 0);
                if (!isCompanion && state.char.classId === 'assassin') {
                    critMultiplier = 2.5;
                    cs.log.push(`üó°Ô∏è EXECUTE! 2.5x kritick√Ω damage!`);
                }
                damage = Math.floor(damage * critMultiplier);
                cs.log.push(`üí• KRITICK√ù Z√ÅSAH!`);
                SoundSystem.play('critical');
                // Track pro achievement
                if (!isCompanion) {
                    state.stats.criticalHits = (state.stats.criticalHits || 0) + 1;
                }
            }
            
            // Ter√©nn√≠ bonus obrany
            const terrain = cs.terrain[target.y]?.[target.x];
            let defense = target.defense;
            
            // Armor pierce - ignoruje ƒç√°st obrany
            if (!isCompanion && playerSkillEffects.armorPierce > 0) {
                defense = Math.floor(defense * (1 - playerSkillEffects.armorPierce));
            }
            if (terrain?.defenseBonus) {
                defense = Math.floor(defense * (1 + terrain.defenseBonus));
            }
            
            // Bonus obrany z br√°nƒõn√≠
            if (target.defending && target.defenseBonus) {
                defense = Math.floor(defense * (1 + target.defenseBonus / 100));
            }
            
            // Execute bonus - v√≠ce damage na nep≈ô√°tele s n√≠zk√Ωm HP
            if (companionSkillEffects.executeBonus && target.hp / target.maxHp < 0.2) {
                damage = Math.floor(damage * (1 + companionSkillEffects.executeBonus));
                cs.log.push(`üíÄ Poprava! (+${Math.round(companionSkillEffects.executeBonus * 100)}% DMG)`);
            }
            
            // Low HP damage bonus
            if (companionSkillEffects.lowHpDamage && unit.hp / unit.maxHp < 0.3) {
                damage = Math.floor(damage * (1 + companionSkillEffects.lowHpDamage));
            }
            
            // Aplikuj damage
            const finalDamage = Math.max(1, damage - defense);
            target.hp -= finalDamage;
            
            // Visual effect - screen shake pokud je hr√°ƒç zasa≈æen
            if (target.isPlayer || target.team === 'player') {
                VisualEffects.screenShake();
            }
            
            cs.log.push(`‚öîÔ∏è ${unit.name} ‚Üí ${target.icon}: ${finalDamage} DMG [${unit.actionsLeft - 1} akce]`);
            SoundSystem.play('combat_hit');
            
            // Speci√°ln√≠ efekty zbranƒõ (jen hr√°ƒç)
            if (!isCompanion && weapon?.special === 'poison' && Math.random() < 0.3) {
                target.poisoned = Math.max(target.poisoned || 0, 5);
                cs.log.push(`‚ò†Ô∏è Jed pronik√° do r√°ny!`);
            }
            if (!isCompanion && weapon?.special === 'bleed' && Math.random() < 0.25) {
                target.bleeding = Math.max(target.bleeding || 0, 3);
                cs.log.push(`ü©∏ Zp≈Øsobil jsi krv√°cen√≠!`);
            }
            if (!isCompanion && weapon?.special === 'stun' && Math.random() < 0.2) {
                target.stunned = true;
                cs.log.push(`üí´ Omr√°ƒçil jsi nep≈ô√≠tele!`);
            }
            
            if (target.hp <= 0) {
                target.alive = false;
                target.hp = 0;
                cs.log.push(`üíÄ ${target.name} byl pora≈æen!`);
                
                // Berserker: Frenzy stack p≈ôi zabit√≠
                if (!isCompanion && state.char.classId === 'berserker') {
                    state.buffs = state.buffs || [];
                    const frenzyStacks = state.buffs.filter(b => b.id === 'frenzy').length;
                    if (frenzyStacks < 10) {
                        state.buffs.push({ id: 'frenzy', value: 0.1, expires: Date.now() + 60000 });
                        cs.log.push(`üî• FRENZY! (+${(frenzyStacks + 1) * 10}% damage)`);
                    }
                }
            }
            
            // Multi-target √∫tok (Cleave/Rozseknout)
            if (companionSkillEffects.multiTarget && companionSkillEffects.multiTarget > 1) {
                // Najdi dal≈°√≠ nep≈ô√°tele v dosahu (vedle prim√°rn√≠ho c√≠le)
                const nearbyEnemies = cs.units.filter(u => 
                    u.team === 'enemy' && u.alive && u.id !== target.id &&
                    Math.max(Math.abs(u.x - unit.x), Math.abs(u.y - unit.y)) <= 1
                ).slice(0, companionSkillEffects.multiTarget - 1);
                
                nearbyEnemies.forEach(enemy => {
                    const splashDamage = Math.floor(finalDamage * 0.5); // 50% damage na sekund√°rn√≠ c√≠le
                    enemy.hp -= splashDamage;
                    cs.log.push(`ü™ì Rozseknout ‚Üí ${enemy.icon}: ${splashDamage} DMG`);
                    if (enemy.hp <= 0) {
                        enemy.alive = false;
                        enemy.hp = 0;
                        cs.log.push(`üíÄ ${enemy.name} byl pora≈æen!`);
                    }
                });
            }
            
            // Synchronizuj HP spoleƒçn√≠ka
            if (isCompanion) {
                const comp = state.companions?.find(c => c.id === unit.companionId);
                if (comp) comp.hp = Math.max(0, unit.hp);
            }
            
            cs.selectedAction = null;
            cs.validTargets = [];
            
            useAction(unit, 1);
        }
        
        function useItemInCombat(itemId) {
            const cs = window.combatState;
            const item = state.inv.find(i => i.id === itemId);
            if (!item) return;
            
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            if (item.effect === 'health') {
                const healAmount = item.value || 30;
                const oldHp = unit.hp;
                unit.hp = Math.min(unit.maxHp, unit.hp + healAmount);
                const actualHeal = unit.hp - oldHp;
                cs.log.push(`üíö +${actualHeal} HP [${unit.actionsLeft - 1} akce]`);
                
                // Synchronizuj HP hr√°ƒçe
                if (unit.isPlayer) state.char.hp = unit.hp;
                
                // Odeber item bezpeƒçnƒõ
                removeItemFromInventory(item, 1);
                
                useAction(unit, 1);
            }
        }
        
        function showCombatInventory() {
            const cs = window.combatState;
            if (!cs) {
                renderHeroesCombatUI(); // Zobraz√≠ error
                return;
            }
            if (!cs.selectedUnit || cs.selectedUnit.team !== 'player') return;
            
            // Najdi bojov√© p≈ôedmƒõty
            const healItems = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
            const throwables = state.inv.filter(i => 
                i.type === 'throwable' || 
                i.result?.type === 'throwable' ||
                i.id?.includes('grenade') || 
                i.id?.includes('molotov') || 
                i.id?.includes('dynamite') ||
                i.id?.includes('bomb')
            );
            const buffs = state.inv.filter(i => i.type === 'consumable' && (i.effect === 'all_stats' || i.effect === 'damage'));
            
            let html = '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            
            // L√©ƒçiv√©
            if (healItems.length > 0) {
                html += '<div style="color: #4caf50; font-size: 0.9rem; margin-bottom: 0.3rem;">üíö L√©ƒçen√≠:</div>';
                healItems.forEach(item => {
                    html += `<button class="btn" onclick="useCombatHeal('${item.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #2e7d32; text-align: left;">
                        ${item.icon || 'üíä'} ${item.name} (+${item.value || 30} HP) x${item.count || 1}
                    </button>`;
                });
            }
            
            // Gran√°ty
            if (throwables.length > 0) {
                html += '<div style="color: #ff9800; font-size: 0.9rem; margin: 0.5rem 0 0.3rem;">üí£ V√Ωbu≈°niny (AOE):</div>';
                throwables.forEach(item => {
                    const dmg = item.damage || item.result?.damage || item.value || 25;
                    html += `<button class="btn" onclick="throwGrenade('${item.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #e65100; text-align: left;">
                        ${item.icon || 'üí£'} ${item.name} (${dmg} DMG v≈°em) x${item.count || 1}
                    </button>`;
                });
            }
            
            // Buffy
            if (buffs.length > 0) {
                html += '<div style="color: #9c27b0; font-size: 0.9rem; margin: 0.5rem 0 0.3rem;">‚ú® Pos√≠len√≠:</div>';
                buffs.forEach(item => {
                    html += `<button class="btn" onclick="useCombatBuff('${item.id}')" style="display: block; width: 100%; margin-bottom: 0.3rem; padding: 0.5rem; background: #7b1fa2; text-align: left;">
                        ${item.icon || '‚ú®'} ${item.name} x${item.count || 1}
                    </button>`;
                });
            }
            
            if (healItems.length === 0 && throwables.length === 0 && buffs.length === 0) {
                html += '<p style="color: #888; text-align: center; padding: 1rem;">≈Ω√°dn√© bojov√© p≈ôedmƒõty v invent√°≈ôi</p>';
            }
            
            html += '</div>';
            html += '<button class="btn" onclick="renderHeroesCombatUI();" style="width: 100%; margin-top: 0.5rem;">‚Üê Zpƒõt do boje</button>';
            
            showModal('üéí Bojov√© p≈ôedmƒõty', html);
        }
        
        function useCombatHeal(itemId) {
            // Nezav√≠rej modal! Combat UI je v modalu
            useItemInCombat(itemId);
        }
        
        function throwGrenade(itemId) {
            const cs = window.combatState;
            const item = state.inv.find(i => i.id === itemId);
            if (!item || !cs) return;
            
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            // Damage m≈Ø≈æe b√Ωt p≈ô√≠mo na itemu nebo v result
            const baseDamage = item.damage || item.result?.damage || item.value || 25;
            let totalDmg = 0;
            let kills = 0;
            
            // Damage v≈°em nep≈ô√°tel≈Øm
            cs.units.filter(u => u.team === 'enemy' && u.alive).forEach(enemy => {
                const dmg = Math.max(1, baseDamage - Math.floor(enemy.defense * 0.3));
                enemy.hp -= dmg;
                totalDmg += dmg;
                
                if (enemy.hp <= 0) {
                    enemy.alive = false;
                    enemy.hp = 0;
                    kills++;
                }
            });
            
            cs.log.push(`üí• ${item.name}: ${totalDmg} DMG! [${unit.actionsLeft - 1} akce]`);
            SoundSystem.play('combat_hit');
            
            // Odeber item
            if (item.count > 1) item.count--;
            else state.inv = state.inv.filter(i => i.id !== itemId);
            
            if (checkCombatEnd()) return;
            
            useAction(unit, 1);
        }
        
        function useCombatBuff(itemId) {
            const cs = window.combatState;
            const item = state.inv.find(i => i.id === itemId);
            if (!item || !cs) return;
            
            const unit = cs.selectedUnit;
            if (!unit || unit.team !== 'player' || unit.actionsLeft <= 0) return;
            
            if (item.effect === 'all_stats') {
                unit.damage = Math.floor(unit.damage * 1.25);
                unit.defense = Math.floor(unit.defense * 1.25);
                cs.log.push(`‚ú® +25% DMG/DEF [${unit.actionsLeft - 1} akce]`);
            } else if (item.effect === 'damage') {
                unit.damage += (item.value || 10);
                cs.log.push(`‚öîÔ∏è +${item.value || 10} DMG [${unit.actionsLeft - 1} akce]`);
            }
            
            // Odeber item
            if (item.count > 1) item.count--;
            else state.inv = state.inv.filter(i => i.id !== itemId);
            
            useAction(unit, 1);
        }
        
        function fleeCombat() {
            const cs = window.combatState;
            
            // Z√°kladn√≠ 50% ≈°ance na √∫tƒõk + bonus z vybaven√≠
            let fleeChance = 0.5;
            
            // P≈ôidej escape bonus z brnƒõn√≠/bot
            const armorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : {};
            if (armorEffects.escapeBonus) {
                fleeChance += armorEffects.escapeBonus;
            }
            
            // Bonus za agilitu
            const agiBonus = ((state.char.attrs?.agi || 5) - 5) * 0.02; // +2% za ka≈æd√Ω bod nad 5
            fleeChance += agiBonus;
            
            // Max 90%
            fleeChance = Math.min(0.9, fleeChance);
            
            if (Math.random() < fleeChance) {
                cs.log.push(`üèÉ √ötƒõk se poda≈ôil! (${Math.round(fleeChance * 100)}% ≈°ance)`);
                setTimeout(() => {
                    closeModal();
                    renderFull();
                    notifyWarning('Uprchl jsi!', 'Boj ukonƒçen bez odmƒõny');
                }, 500);
            } else {
                cs.log.push(`‚ùå √ötƒõk se nezda≈ôil! (${Math.round(fleeChance * 100)}% ≈°ance)`);
                endUnitTurn(cs.selectedUnit);
                renderHeroesCombatUI();
            }
        }
        
        // === OVL√ÅD√ÅN√ç SPOLEƒåN√çK≈Æ ===
        
        function toggleCompanionControl() {
            const cs = window.combatState;
            cs.manualCompanions = !cs.manualCompanions;
            
            // Ulo≈æ do nastaven√≠
            if (!state.settings) state.settings = {};
            state.settings.manualCompanions = cs.manualCompanions;
            saveGame();
            
            cs.log.push(`üêï Spoleƒçn√≠ci: ${cs.manualCompanions ? 'Manu√°ln√≠ ovl√°d√°n√≠' : 'AI ovl√°d√°n√≠'}`);
            renderHeroesCombatUI();
            
            // Pokud se p≈ôepnulo na AUTO a je pr√°vƒõ tah spoleƒçn√≠ka, spus≈• AI
            if (!cs.manualCompanions && cs.selectedUnit && cs.selectedUnit.isCompanion && cs.selectedUnit.alive && cs.selectedUnit.actionsLeft > 0) {
                setTimeout(() => performCompanionAITurn(cs.selectedUnit), 300);
            }
        }
        
        function letCompanionAI() {
            // Nech√° AI odehr√°t tah za spoleƒçn√≠ka
            const cs = window.combatState;
            const unit = cs.selectedUnit;
            if (!unit || !unit.isCompanion) return;
            
            performCompanionAITurn(unit);
        }
        
        // === RENDER ===
        
        function renderHeroesCombatUI() {
            const cs = window.combatState;
            if (!cs) {
                // Combat state ztracen - zobraz error a nab√≠dni restart
                document.getElementById('modalContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem;">‚ö†Ô∏è</div>
                        <h2 style="color: #ff9800;">Chyba boje</h2>
                        <p style="color: #888;">Combat state byl ztracen. Toto by se nemƒõlo st√°t.</p>
                        <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt do hry</button>
                    </div>
                `;
                return;
            }
            
            const currentUnit = cs.selectedUnit;
            // Hr√°ƒç≈Øv tah = hr√°ƒç NEBO spoleƒçn√≠k p≈ôi manu√°ln√≠m ovl√°d√°n√≠
            const isPlayerControlled = currentUnit && currentUnit.team === 'player' && !currentUnit.acted && 
                (currentUnit.isPlayer || (currentUnit.isCompanion && cs.manualCompanions));
            const isCompanionTurn = currentUnit && currentUnit.isCompanion && cs.manualCompanions;
            
            // Statistiky
            const playerUnits = cs.units.filter(u => u.team === 'player' && u.alive);
            const enemyUnits = cs.units.filter(u => u.team === 'enemy' && u.alive);
            const totalEnemyHp = enemyUnits.reduce((sum, e) => sum + e.hp, 0);
            const maxEnemyHp = cs.units.filter(u => u.team === 'enemy').reduce((sum, e) => sum + e.maxHp, 0);
            
            // Heal items
            const healItems = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
            
            // M√° spoleƒçn√≠ky?
            const hasCompanions = playerUnits.some(u => u.isCompanion);
            
            document.getElementById('modalContent').innerHTML = `
                <div style="background: linear-gradient(180deg, #0d1520 0%, #0a0f15 100%); margin: -1rem; padding: 0.8rem; border-radius: 8px; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    
                    <!-- HEADER -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #2a3a4a;">
                        <div>
                            <span style="color: #ff6b6b; font-weight: bold;">${'‚öîÔ∏è BOJ'}</span>
                            <span style="color: #666; font-size: 0.85rem;"> - Kolo ${cs.round}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${hasCompanions ? `
                                <button onclick="toggleCompanionControl()" style="background: ${cs.manualCompanions ? 'linear-gradient(135deg, #4CAF50, #2e7d32)' : 'linear-gradient(135deg, #ff9800, #f57c00)'}; border: 2px solid ${cs.manualCompanions ? '#8bc34a' : '#ffb74d'}; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; color: white; font-weight: bold; ${cs.manualCompanions ? '' : 'animation: pulse 1.5s infinite;'}" title="Klikni pro p≈ôepnut√≠ ovl√°d√°n√≠ spoleƒçn√≠k≈Ø">
                                    üêï ${cs.manualCompanions ? '‚úã RUƒåN√ç' : 'ü§ñ AUTO'}
                                </button>
                            ` : ''}
                            <span style="color: #4ecdc4; font-size: 0.85rem;">üë• ${playerUnits.length}</span>
                            <span style="color: #ff6b6b; font-size: 0.85rem;">üíÄ ${enemyUnits.length}</span>
                        </div>
                    </div>
                    </div>
                    
                    <!-- ENEMY HP BAR -->
                    <div style="margin-bottom: 0.5rem;">
                        <div style="height: 6px; background: #1a1a2a; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${(totalEnemyHp/maxEnemyHp)*100}%; background: linear-gradient(90deg, #c0392b, #e74c3c); transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- BOJOV√Å M≈ò√ç≈ΩKA -->
                    <div style="background: #0a0f15; border: 2px solid #2a3a4a; border-radius: 8px; padding: 0.3rem; margin-bottom: 0.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(${COMBAT_GRID.cols}, 1fr); gap: 2px;">
                            ${renderCombatGrid()}
                        </div>
                    </div>
                    
                    <!-- AKTU√ÅLN√ç JEDNOTKA -->
                    ${currentUnit ? `
                        <div style="background: ${currentUnit.team === 'player' ? '#1a2a1a' : '#2a1a1a'}; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid ${currentUnit.team === 'player' ? '#4a7c4a' : '#7c4a4a'};">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">${currentUnit.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: ${currentUnit.team === 'player' ? '#8bc34a' : '#ff6b6b'};">
                                        ${currentUnit.name}
                                        ${currentUnit.isCompanion ? '<span style="font-size: 0.7rem; color: #ff9800;"> (Spoleƒçn√≠k)</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #888;">
                                        ‚ù§Ô∏è ${currentUnit.hp}/${currentUnit.maxHp} | ‚öîÔ∏è ${currentUnit.damage} | üõ°Ô∏è ${currentUnit.defense} | üí® ${currentUnit.speed}
                                    </div>
                                </div>
                                ${currentUnit.team === 'player' ? `<div style="text-align: right;"><span style="color: #ffd700; font-size: 0.9rem;">‚óÄ ${currentUnit.isCompanion ? 'Spoleƒçn√≠k' : 'Tv≈Øj'} tah</span><br><span style="background: #2a4a2a; padding: 0.2rem 0.5rem; border-radius: 4px; color: #8bc34a; font-weight: bold;">‚ö° ${currentUnit.actionsLeft || 0}/2 akce</span></div>` : '<span style="color: #ff6b6b;">Nep≈ô√≠tel...</span>'}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- AKCE (pokud je hr√°ƒç≈Øv/spoleƒçn√≠k≈Øv tah) -->
                    ${isPlayerControlled ? `
                        <!-- Info o zbrani a munici -->
                        <div style="background: #1a1a2a; padding: 0.4rem; border-radius: 4px; margin-bottom: 0.4rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; color: #888;">
                                ${!isCompanionTurn && state.equipped?.weapon ? 
                                    `${state.equipped.weapon.icon || '‚öîÔ∏è'} ${state.equipped.weapon.name} (‚öîÔ∏è${state.equipped.weapon.damage || 10}) ${state.equipped.weapon.ammoType ? 'üéØ' : 'üó°Ô∏è'}` : 
                                    isCompanionTurn ? `üêæ ${currentUnit.name} √∫toƒç√≠` : 'üëä Hol√© ruce (‚öîÔ∏è5) üó°Ô∏è'}
                            </span>
                            ${!isCompanionTurn && state.equipped?.weapon?.ammoType ? 
                                `<span style="font-size: 0.75rem; padding: 0.2rem 0.4rem; border-radius: 4px; ${getAmmoCount(state.equipped.weapon.ammoType) > 0 ? 'background: #2a4a2a; color: #8bc34a;' : 'background: #4a2a2a; color: #ff6b6b;'}">
                                    üî´ ${getAmmoCount(state.equipped.weapon.ammoType)} ${getAmmoName(state.equipped.weapon.ammoType)}
                                </span>` : 
                                `<span style="font-size: 0.7rem; color: #ff9800;">Dosah: ${isCompanionTurn ? 'Na bl√≠zko' : '1 pole'}</span>`}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(${isCompanionTurn ? 3 : 4}, 1fr); gap: 0.3rem; margin-bottom: 0.4rem;">
                            <button class="btn" onclick="selectAction('move')" style="padding: 0.4rem; font-size: 0.8rem; background: ${cs.selectedAction === 'move' ? '#1565c0' : '#2a3a4a'};">
                                üö∂ Pohyb
                            </button>
                            <button class="btn" onclick="selectAction('attack')" style="padding: 0.4rem; font-size: 0.8rem; background: ${cs.selectedAction === 'attack' ? '#c62828' : '#2a3a4a'};">
                                ‚öîÔ∏è √ötok
                            </button>
                            <button class="btn" onclick="selectAction('defend')" style="padding: 0.4rem; font-size: 0.8rem; background: #2a3a4a;">
                                üõ°Ô∏è Obrana
                            </button>
                            ${!isCompanionTurn ? `
                            <button class="btn" onclick="selectAction('weapon')" style="padding: 0.4rem; font-size: 0.8rem; background: #6a4c93;">
                                üîÑ Zbra≈à
                            </button>
                            ` : ''}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(${isCompanionTurn ? 2 : 3}, 1fr); gap: 0.3rem; margin-bottom: 0.5rem;">
                            ${!isCompanionTurn ? `
                            <button class="btn" onclick="showCombatInventory()" style="padding: 0.4rem; font-size: 0.8rem; background: #1565c0;">
                                üéí Item
                            </button>
                            ` : ''}
                            <button class="btn" onclick="selectAction('wait')" style="padding: 0.4rem; font-size: 0.8rem; background: #2a3a4a;">
                                ‚è≠Ô∏è Konec
                            </button>
                            ${!isCompanionTurn ? `
                            <button class="btn" onclick="fleeCombat()" style="padding: 0.4rem; font-size: 0.8rem; background: #5d4037;">
                                üèÉ √ötƒõk
                            </button>
                            ` : `
                            <button class="btn" onclick="letCompanionAI()" style="padding: 0.4rem; font-size: 0.8rem; background: #ff9800;">
                                ü§ñ AI tah
                            </button>
                            `}
                        </div>
                    ` : ''}
                    
                    <!-- LEGENDA TLAƒå√çTKO -->
                    <button class="btn" onclick="showTerrainLegend()" style="width: 100%; padding: 0.3rem; font-size: 0.7rem; background: #333; margin-bottom: 0.3rem;">
                        üìã Legenda ter√©nu
                    </button>
                    
                    <!-- BOJ LOG -->
                    <div id="combatLogGrid" style="background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 0.4rem; max-height: 100px; overflow-y: auto; -webkit-overflow-scrolling: touch; font-size: 0.75rem;">
                        ${cs.log.slice(-8).map(l => `<div style="color: #aaa; margin-bottom: 2px;">${l}</div>`).join('')}
                    </div>
                    
                </div>
            `;
            
            // Scroll log dol≈Ø
            const log = document.getElementById('combatLogGrid');
            if (log) log.scrollTop = log.scrollHeight;
        }
        
        function showTerrainLegend() {
            const terrainTypes = [
                { icon: 'üî•', name: 'Ohe≈à', effect: '8 DMG ka≈æd√© kolo', color: '#ff4444' },
                { icon: '‚ò¢Ô∏è', name: 'Toxick√Ω odpad', effect: '5 DMG + 3 radiace', color: '#ff9800' },
                { icon: 'üï≥Ô∏è', name: 'Propast', effect: '10 DMG p≈ôi vstupu', color: '#ff4444' },
                { icon: 'üíß', name: 'Voda', effect: '-50% rychlost', color: '#2196f3' },
                { icon: 'üåä', name: 'Hlubok√° voda', effect: 'Nelze proj√≠t', color: '#1565c0' },
                { icon: 'üü§', name: 'Bahno', effect: '-30% rychlost', color: '#795548' },
                { icon: 'üå≤', name: 'Les', effect: '+20% obrana', color: '#4caf50' },
                { icon: 'üå≥', name: 'Strom', effect: 'Nelze proj√≠t', color: '#2e7d32' },
                { icon: 'üåø', name: 'Ke≈ô', effect: '+10% obrana', color: '#66bb6a' },
                { icon: 'ü™µ', name: 'Kl√°da', effect: '+10% obrana', color: '#8d6e63' },
                { icon: 'üåæ', name: 'R√°kos√≠', effect: '+10% obrana', color: '#aed581' },
                { icon: 'üß±', name: 'Trosky', effect: '+15% obrana, -20% rychlost', color: '#9e9e9e' },
                { icon: 'üöó', name: 'Vrak auta', effect: 'Nelze proj√≠t', color: '#607d8b' },
                { icon: 'üèöÔ∏è', name: 'Zeƒè', effect: 'Nelze proj√≠t', color: '#757575' },
                { icon: 'üõ¢Ô∏è', name: 'Sudy', effect: '+15% obrana', color: '#ff9800' },
                { icon: 'üì¶', name: 'Bedny', effect: '+10% obrana', color: '#795548' },
                { icon: '‚öôÔ∏è', name: 'Stroj', effect: 'Nelze proj√≠t', color: '#90a4ae' },
                { icon: 'üî©', name: 'Potrub√≠', effect: '+10% obrana', color: '#78909c' },
                { icon: 'ü™®', name: 'Sk√°la', effect: 'Nelze proj√≠t', color: '#9e9e9e' },
                { icon: 'üóø', name: 'Stalagmit', effect: 'Nelze proj√≠t', color: '#8d6e63' },
                { icon: 'üíé', name: 'Krystal', effect: '+10% obrana', color: '#e1bee7' }
            ];
            
            let html = '<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">';
            
            terrainTypes.forEach(t => {
                html += `
                    <div style="background: #1a1a1a; padding: 0.4rem; border-radius: 6px; border-left: 3px solid ${t.color};">
                        <span style="font-size: 1.2rem;">${t.icon}</span>
                        <span style="font-weight: bold; color: ${t.color};">${t.name}</span>
                        <div style="font-size: 0.7rem; color: #888;">${t.effect}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="margin-top: 0.5rem; padding: 0.5rem; background: #1a2a1a; border-radius: 6px; font-size: 0.75rem; color: #8bc34a;">';
            html += 'üí° <strong>Tip:</strong> Obrana se aplikuje p≈ôi √∫toku NA tebe. Rychlost ovliv≈àuje pohyb. Po≈°kozen√≠ se aplikuje ka≈æd√© kolo.';
            html += '</div>';
            html += '</div>';
            html += '<button class="btn" onclick="renderHeroesCombatUI()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt do boje</button>';
            
            showModal('üìã Legenda ter√©nu', html);
        }
        
        function renderCombatGrid() {
            const cs = window.combatState;
            let html = '';
            
            for (let y = 0; y < COMBAT_GRID.rows; y++) {
                for (let x = 0; x < COMBAT_GRID.cols; x++) {
                    const unit = cs.units.find(u => u.alive && u.x === x && u.y === y);
                    const terrain = cs.terrain[y]?.[x];
                    
                    // Zv√Ωraznƒõn√≠
                    const isValidMove = cs.validMoves.some(m => m.x === x && m.y === y);
                    const isValidTarget = unit && cs.validTargets.includes(unit);
                    const isSelected = cs.selectedUnit && cs.selectedUnit.x === x && cs.selectedUnit.y === y;
                    
                    let bgColor = '#151a20';
                    let border = '1px solid #2a3a4a';
                    
                    if (isSelected) {
                        bgColor = '#1a3a1a';
                        border = '2px solid #4caf50';
                    } else if (isValidMove) {
                        bgColor = '#1a2a3a';
                        border = '2px solid #2196f3';
                    } else if (isValidTarget) {
                        bgColor = '#3a1a1a';
                        border = '2px solid #f44336';
                    }
                    
                    // Ter√©n pozad√≠
                    if (terrain && terrain.type !== 'empty') {
                        if (terrain.blocked) {
                            bgColor = '#0a0a0a'; // Neprostupn√©
                            border = '1px solid #333';
                        } else if (terrain.type === 'forest' || terrain.type === 'bush' || terrain.type === 'reed') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#1a2a1a';
                        } else if (terrain.type === 'water' || terrain.type === 'mud') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#1a2a3a';
                        } else if (terrain.type === 'fire' || terrain.type === 'toxic') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#3a2a1a';
                        } else if (terrain.type === 'rubble' || terrain.type === 'barrel' || terrain.type === 'crate') {
                            bgColor = isSelected || isValidMove || isValidTarget ? bgColor : '#2a2a1a';
                        }
                    }
                    
                    const clickable = (isValidMove || isValidTarget) ? 'cursor: pointer;' : '';
                    const onClick = (isValidMove || isValidTarget) ? `onclick="clickCell(${x},${y})"` : '';
                    
                    // Tooltip pro ter√©n
                    const terrainTitle = terrain && terrain.type !== 'empty' ? `title="${terrain.name || terrain.type}${terrain.blocked ? ' (neprostupn√©)' : ''}${terrain.defenseBonus ? ' (+' + Math.round(terrain.defenseBonus*100) + '% obrana)' : ''}${terrain.damage ? ' (' + terrain.damage + ' DMG)' : ''}"` : '';
                    
                    html += `
                        <div ${onClick} ${terrainTitle} style="
                            aspect-ratio: 1;
                            background: ${bgColor};
                            border: ${border};
                            border-radius: 3px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-size: 1rem;
                            position: relative;
                            ${clickable}
                            min-height: 32px;
                            max-height: 45px;
                        ">
                            ${terrain && terrain.type !== 'empty' && !unit ? `<span style="opacity: ${terrain.blocked ? '0.6' : '0.35'}; font-size: 0.85rem;">${terrain.icon}</span>` : ''}
                            ${unit ? `
                                <span style="filter: ${unit.stunned ? 'grayscale(1)' : 'none'}; font-size: 1.1rem;">${unit.icon}</span>
                                <div style="
                                    position: absolute;
                                    bottom: 1px;
                                    left: 1px;
                                    right: 1px;
                                    height: 2px;
                                    background: #1a0a0a;
                                    border-radius: 1px;
                                    overflow: hidden;
                                ">
                                    <div style="
                                        height: 100%;
                                        width: ${(unit.hp/unit.maxHp)*100}%;
                                        background: ${unit.team === 'player' ? '#4caf50' : '#f44336'};
                                    "></div>
                                </div>
                                ${unit.poisoned ? '<span style="position: absolute; top: -2px; right: -2px; font-size: 0.5rem;">‚ò†Ô∏è</span>' : ''}
                                ${unit.bleeding ? '<span style="position: absolute; top: -2px; left: -2px; font-size: 0.5rem;">ü©∏</span>' : ''}
                                ${unit.stunned ? '<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 0.7rem;">üí´</span>' : ''}
                                ${unit.defending ? '<span style="position: absolute; bottom: 5px; right: -2px; font-size: 0.5rem;">üõ°Ô∏è</span>' : ''}
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            return html;
        }
        
        function handleCombatDefeat() {
            const cs = window.combatState;
            
            // Zvuk prohry
            if (typeof playCombatSound === 'function') playCombatSound('defeat');
            
            // === V√ÅLEƒåN√Å Z√ìNA - hr√°ƒç m≈Ø≈æe prohr√°t boj, ale nezem≈ôe ===
            if (state.warZoneFight?.active) {
                const warFight = state.warZoneFight;
                state.warZoneFight = null;
                window.combatState = null;
                
                // Obnov p≈Øvodn√≠ HP (p≈ôed bojem)
                state.char.hp = warFight.savedHp || Math.max(1, Math.floor(state.char.maxHp * 0.5));
                
                // Nastav cooldown
                if (multiplayerEnabled && firebaseDB) {
                    const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                    firebaseDB.ref('warZone/cooldowns/' + myName).set(Date.now()).catch(e => {});
                }
                
                showModal('üíÄ Prohra v boji!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">üíÄ</div>
                        <h3 style="color: #f44336;">Byl jsi pora≈æen!</h3>
                        <p style="color: #888;">Nez√≠skal jsi ≈æ√°dn√© body pro svou frakci.</p>
                        <p style="color: #8bc34a;">HP obnoveno na p≈Øvodn√≠ hodnotu</p>
                        <p style="color: #666; font-size: 0.9rem;">Dal≈°√≠ pokus za 10 minut.</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: #555;">
                        Zav≈ô√≠t
                    </button>
                `);
                return;
            }
            
            // === TERRITORY GUARD COMBAT ===
            // Pokud to byl boj se str√°≈æci √∫zem√≠, zpracuj ho zvl√°≈°≈•
            if (cs?.combatType === 'territory_guard' && window.territoryBattle) {
                onTerritoryBattleEnd(false);
                window.combatState = null;
                // P≈ôi proh≈ôe v √∫zem√≠ boji se neprohr√°v√° cel√° hra
                state.char.hp = Math.max(1, Math.floor(state.char.maxHp * 0.1)); // 10% HP
                notifyWarning('üíÄ Prohra!', 'Str√°≈æci tƒõ porazili. Utekl jsi s tƒõ≈æk√Ωmi zranƒõn√≠mi.');
                renderFull();
                saveGame(true);
                return;
            }
            
            state.stats.deaths = (state.stats.deaths || 0) + 1;
            
            // Speci√°ln√≠ handling pro Abyss - opravdov√° smrt bez mo≈ænosti respawnu
            if (cs?.combatType === 'abyss') {
                window.combatState = null;
                if (typeof handleAbyssDefeat === 'function') {
                    handleAbyssDefeat();
                } else {
                    // Fallback - norm√°ln√≠ smrt
                    state.isDead = true;
                    showModal('üíÄ SMRT V PROPASTI', `
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 4rem;">üï≥Ô∏èüíÄ</div>
                            <h2 style="color: #9c27b0;">Propast tƒõ pohltila!</h2>
                            <p style="color: #888;">Temnota Abyss je absolutn√≠...</p>
                            <button class="btn" onclick="location.reload();" style="width: 100%; margin-top: 1rem; background: #c62828;">
                                Zaƒç√≠t znovu
                            </button>
                        </div>
                    `);
                }
                return;
            }
            
            window.combatState = null;
            
            // === TEST MODE ===
            // Hr√°ƒç nezem≈ôe, jen se vyl√©ƒç√≠ - pro testov√°n√≠
            state.char.hp = state.char.maxHp;
            
            // P≈ôidej do hern√≠ho den√≠ku
            addLog(`üíÄ Prohra v boji! (TEST MODE - HP obnoveno)`, 'üíÄ');
            
            showModal('üíÄ PROHRA', `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem;">üß™</div>
                    <h2 style="color: #ff9800;">TEST MODE</h2>
                    <p style="color: #888;">Norm√°lnƒõ bys um≈ôel, ale pro testov√°n√≠ pokraƒçuje≈°.</p>
                    <p style="color: #4caf50;">HP obnoveno na maximum!</p>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">
                        ‚úì Pokraƒçovat v testov√°n√≠
                    </button>
                </div>
            `);
            
            saveGame(true);
        }
        
        // === STAR√ù startCombat upraven√Ω pro nov√Ω syst√©m ===
        
        function startCombat(enemy, isAmbush = false, isVillageRaid = false, forceEnemyCount = null) {
            // Blokace bƒõhem sp√°nku
            if (state.isSleeping) {
                state.isSleeping = false; // Probuƒè se p≈ôi √∫toku!
                state.sleepEndTime = null;
                notifyWarning('üí§ Probudil ses!', 'Nƒõkdo tƒõ napadl bƒõhem sp√°nku!');
            }
            
            // === AUTOMATICK√â DOPLNƒöN√ç N√ÅBOJ≈Æ PRO COMPANIONY ===
            if (state.companions) {
                state.companions.forEach(comp => {
                    if (!comp.isDead && comp.equipped?.weapon?.ammoType) {
                        const ammoType = comp.equipped.weapon.ammoType;
                        const currentAmmo = comp.ammo || 0;
                        const maxAmmo = 50; // Max n√°boj≈Ø co companion pot≈ôebuje
                        
                        if (currentAmmo < maxAmmo) {
                            const needed = maxAmmo - currentAmmo;
                            const playerHas = getAmmoCount(ammoType);
                            const toGive = Math.min(needed, playerHas);
                            
                            if (toGive > 0) {
                                consumeAmmo(ammoType, toGive);
                                comp.ammo = currentAmmo + toGive;
                                console.log(`üî´ ${comp.name} dostal ${toGive} n√°boj≈Ø (typ: ${ammoType})`);
                            }
                        }
                    }
                });
            }
            
            // Reset Phoenix efektu pro nov√Ω boj
            window.phoenixUsed = false;
            
            // Stalker passive - 50% chance to avoid ambush
            if (isAmbush) {
                const ambushPassive = getClassPassive('onAmbush');
                if (ambushPassive && ambushPassive.avoid) {
                    showModal('üë§ Vyklouzl jsi!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">üë§</div>
                            <p style="color: #8bc34a; font-size: 1.2rem;">Stealth!</p>
                            <p>${ambushPassive.message}</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${'Pokraƒçovat'}</button>
                    `);
                    return;
                }
            }
            
            closeModal();
            
            setTimeout(() => {
                // Pokud enemy m√° v≈°echna pot≈ôebn√° data (custom enemy z lovu), pou≈æij je p≈ô√≠mo
                let enemyData;
                if (enemy.hp && enemy.damage && enemy.name) {
                    // Custom enemy (nap≈ô. ze zv√≠≈ôat p≈ôi lovu)
                    // P≈ôeveƒè loot objekt na pole pro combat syst√©m
                    let lootArray = [];
                    if (enemy.loot) {
                        if (Array.isArray(enemy.loot)) {
                            lootArray = enemy.loot;
                        } else {
                            // Objekt { meat: 6, leather: 4 } -> pole ['meat', 'leather', ...]
                            Object.entries(enemy.loot).forEach(([item, count]) => {
                                for (let i = 0; i < count; i++) {
                                    lootArray.push(item === 'meat' ? 'raw_meat' : item);
                                }
                            });
                        }
                    }
                    
                    enemyData = {
                        id: enemy.id,
                        name: enemy.name,
                        icon: enemy.icon || '‚ùì',
                        hp: enemy.hp,
                        maxHp: enemy.hp,
                        damage: enemy.damage,
                        defense: enemy.defense || 0,
                        xp: enemy.xp || 10,
                        speed: enemy.speed || 5,
                        loot: lootArray,
                        minCount: 1,
                        maxCount: 1,
                        tier: enemy.tier || 1
                    };
                } else {
                    // Standardn√≠ enemy z datab√°ze
                    enemyData = ENEMIES.find(e => e.id === enemy.id);
                }
                
                if (!enemyData) {
                    console.error('Enemy not found:', enemy.id);
                    notifyError('Chyba', 'Nep≈ô√≠tel nenalezen!');
                    return;
                }
                
                // Psychic passive - 10% chance enemy flees
                const psychicPassive = getClassPassive('onCombatStart');
                if (psychicPassive && psychicPassive.flee) {
                    showModal('üîÆ Mind Control!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem;">üîÆ</div>
                            <p style="color: #aa00ff; font-size: 1.2rem;">Mind Control!</p>
                            <p>${enemyData.icon} ${enemyData.name} utekl v hr≈Øze!</p>
                            <p style="color: #8bc34a;">Z√≠sk√°v√°≈° ${Math.floor(enemyData.xp * 0.5)} XP</p>
                        </div>
                        <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">${'Pokraƒçovat'}</button>
                    `);
                    addXP(Math.floor(enemyData.xp * 0.5));
                    return;
                }
                
                // Determine enemy count - pou≈æij forceEnemyCount pokud je zad√°n
                let enemyCount;
                if (forceEnemyCount && forceEnemyCount > 0) {
                    enemyCount = forceEnemyCount;
                } else {
                    enemyCount = Math.floor(Math.random() * (enemyData.maxCount - enemyData.minCount + 1)) + enemyData.minCount;
                    
                    // Tier 1-2 nep≈ô√°tel√© se ƒçastƒõji objevuj√≠ ve skupin√°ch
                    if (enemyData.tier <= 2 && enemyCount === 1 && Math.random() < 0.5) {
                        enemyCount = 2;
                    }
                }
                
                if (isVillageRaid) {
                    enemyCount = Math.max(enemyCount, 3);
                    enemyCount = Math.min(enemyCount + 2, 6);
                }
                
                // Ambush bonus
                const ambushBonus = isAmbush ? 1.1 : 1.0;
                
                // Create enemy group pro nov√Ω Heroes3 syst√©m
                const enemyGroup = [];
                for (let i = 0; i < enemyCount; i++) {
                    enemyGroup.push({
                        ...enemyData,
                        damage: Math.floor(enemyData.damage * ambushBonus),
                        defense: Math.floor(enemyData.defense * ambushBonus),
                        hp: enemyData.hp,
                        maxHp: enemyData.hp,
                        speed: enemyData.speed || 5 + Math.floor(Math.random() * 5)
                    });
                }
                
                // Pokud m√°me spoleƒçn√≠ky a nen√≠ p≈ôepaden√≠, uka≈æ pre-combat setup
                const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
                if (aliveCompanions.length > 0 && !isAmbush) {
                    showPreCombatSetup(enemyGroup, isVillageRaid ? 'settlement_raid' : 'normal');
                } else {
                    // Bez spoleƒçn√≠k≈Ø nebo p≈ôi p≈ôepaden√≠ - rovnou do boje
                    const combatType = isVillageRaid ? 'settlement_raid' : 'normal';
                    startCombatWithGroup(enemyGroup, combatType);
                }
                
            }, 100);
        }
        
        // Pre-combat setup - rozm√≠stƒõn√≠ spoleƒçn√≠k≈Ø
        function showPreCombatSetup(enemyGroup, combatType) {
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
            
            // V√Ωchoz√≠ pozice spoleƒçn√≠k≈Ø
            const defaultPositions = [
                { id: 'back_top', x: 8, y: 1, label: 'Vzadu naho≈ôe' },
                { id: 'back_bot', x: 8, y: 3, label: 'Vzadu dole' },
                { id: 'back_mid', x: 8, y: 2, label: 'Vzadu st≈ôed' },
                { id: 'front_top', x: 7, y: 1, label: 'Naho≈ôe' },
                { id: 'front_bot', x: 7, y: 3, label: 'Dole' }
            ];
            
            // Naƒçti ulo≈æen√© pozice ze state (p≈ôe≈æij√≠ refresh) nebo pou≈æij v√Ωchoz√≠
            if (!state.savedCompanionPositions) {
                state.savedCompanionPositions = {};
            }
            
            // Inicializuj pozice spoleƒçn√≠k≈Ø - pou≈æij ulo≈æen√© nebo v√Ωchoz√≠
            window.preCombatPositions = {};
            aliveCompanions.forEach((comp, idx) => {
                const compId = comp.uniqueId || comp.id;
                if (state.savedCompanionPositions[compId]) {
                    // Pou≈æij ulo≈æenou pozici
                    window.preCombatPositions[compId] = state.savedCompanionPositions[compId];
                } else {
                    // V√Ωchoz√≠ pozice
                    window.preCombatPositions[compId] = defaultPositions[idx] || defaultPositions[0];
                }
            });
            
            // Ulo≈æ enemy group pro pozdƒõj≈°√≠ pou≈æit√≠
            window.pendingEnemyGroup = enemyGroup;
            window.pendingCombatType = combatType;
            
            renderPreCombatSetup();
        }
        
        function renderPreCombatSetup() {
            const enemyGroup = window.pendingEnemyGroup;
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && c.hp > 0);
            
            const positions = [
                { id: 'front_top', x: 6, y: 1, label: 'üõ°Ô∏è P≈ôedn√≠ - Naho≈ôe', desc: 'Prvn√≠ v boji' },
                { id: 'front_mid', x: 6, y: 2, label: 'üõ°Ô∏è P≈ôedn√≠ - St≈ôed', desc: 'Hlavn√≠ pozice' },
                { id: 'front_bot', x: 6, y: 3, label: 'üõ°Ô∏è P≈ôedn√≠ - Dole', desc: 'Prvn√≠ v boji' },
                { id: 'back_top', x: 8, y: 1, label: 'üèπ Zadn√≠ - Naho≈ôe', desc: 'Chr√°nƒõn√Ω' },
                { id: 'back_mid', x: 8, y: 2, label: 'üèπ Zadn√≠ - St≈ôed', desc: 'Bezpeƒçn√Ω' },
                { id: 'back_bot', x: 8, y: 3, label: 'üèπ Zadn√≠ - Dole', desc: 'Chr√°nƒõn√Ω' }
            ];
            
            let html = `
                <div style="margin-bottom: 1rem;">
                    <h3 style="color: #ff9800; margin: 0 0 0.5rem 0;">‚öîÔ∏è Nep≈ô√°tel√© (${enemyGroup.length}x)</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${enemyGroup.slice(0, 5).map(e => `
                            <div style="background: #2a1a1a; padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #8B0000;">
                                <span style="font-size: 1.2rem;">${e.icon}</span>
                                <span style="color: #ff6666; font-size: 0.8rem;">${e.name}</span>
                            </div>
                        `).join('')}
                        ${enemyGroup.length > 5 ? `<span style="color: #888;">+${enemyGroup.length - 5} dal≈°√≠ch</span>` : ''}
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <h3 style="color: #8bc34a; margin: 0 0 0.5rem 0;">üë• Rozm√≠stƒõn√≠ spoleƒçn√≠k≈Ø</h3>
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">Vyber pozici pro ka≈æd√©ho spoleƒçn√≠ka:</p>
            `;
            
            aliveCompanions.forEach((comp, idx) => {
                const compData = COMPANIONS.find(cd => cd.id === comp.id);
                const compId = comp.uniqueId || comp.id;
                const currentPos = window.preCombatPositions[compId] || positions[0];
                const isExcluded = currentPos.id === 'excluded';
                
                html += `
                    <div style="background: ${isExcluded ? '#2a2a1a' : '#1a2a1a'}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid ${isExcluded ? '#666' : '#2a4a2a'}; ${isExcluded ? 'opacity: 0.7;' : ''}">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">${comp.icon || compData?.icon || 'üë§'}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${isExcluded ? '#888' : '#8bc34a'};">${comp.name || compData?.name} ${isExcluded ? '(ƒçek√°)' : ''}</div>
                                <div style="font-size: 0.75rem; color: #888;">‚ù§Ô∏è ${comp.hp}/${comp.maxHp} | ‚öîÔ∏è ${getCompanionStat(comp, 'damage')} | üõ°Ô∏è ${getCompanionStat(comp, 'defense')}</div>
                            </div>
                        </div>
                        <select onchange="updateCompanionPosition('${compId}', this.value)" 
                            style="width: 100%; padding: 0.5rem; background: #0a0a0a; border: 1px solid #444; border-radius: 4px; color: #fff;">
                            <option value="excluded" ${isExcluded ? 'selected' : ''}>üö´ Nebojuje - z≈Østane vzadu</option>
                            ${positions.map(p => `
                                <option value="${p.id}" ${currentPos.id === p.id ? 'selected' : ''}>
                                    ${p.label} - ${p.desc}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="confirmPreCombatSetup()" style="background: #555;">
                        üé≤ V√Ωchoz√≠ pozice
                    </button>
                    <button class="btn" onclick="confirmPreCombatSetup()" style="background: linear-gradient(135deg, #8B0000, #5a0000);">
                        ‚öîÔ∏è Do boje!
                    </button>
                </div>
            `;
            
            showModal('‚öîÔ∏è P≈ô√≠prava na boj', html);
        }
        
        function updateCompanionPosition(compId, positionId) {
            const positions = {
                'excluded': { id: 'excluded', x: -1, y: -1, excluded: true },
                'front_top': { id: 'front_top', x: 6, y: 1 },
                'front_mid': { id: 'front_mid', x: 6, y: 2 },
                'front_bot': { id: 'front_bot', x: 6, y: 3 },
                'back_top': { id: 'back_top', x: 8, y: 1 },
                'back_mid': { id: 'back_mid', x: 8, y: 2 },
                'back_bot': { id: 'back_bot', x: 8, y: 3 }
            };
            const newPos = positions[positionId] || positions['back_mid'];
            window.preCombatPositions[compId] = newPos;
            
            // Ulo≈æ do state pro p≈ô√≠≈°t√≠ boje
            if (!state.savedCompanionPositions) state.savedCompanionPositions = {};
            state.savedCompanionPositions[compId] = newPos;
            
            // P≈ôekresli modal pro vizu√°ln√≠ feedback
            renderPreCombatSetup();
        }
        
        function confirmPreCombatSetup() {
            console.log('üéÆ confirmPreCombatSetup called');
            
            // Ulo≈æ reference P≈òED closeModal
            const enemyGroup = window.pendingEnemyGroup;
            const combatType = window.pendingCombatType;
            
            console.log('üéÆ enemyGroup:', enemyGroup);
            console.log('üéÆ combatType:', combatType);
            
            if (!enemyGroup || enemyGroup.length === 0) {
                console.error('confirmPreCombatSetup: No enemy group!');
                closeModal();
                notifyError('Chyba', '≈Ω√°dn√≠ nep≈ô√°tel√© k boji!');
                return;
            }
            
            // Ulo≈æ pozice do state pro p≈ô√≠≈°t√≠ boje
            if (!state.savedCompanionPositions) state.savedCompanionPositions = {};
            Object.assign(state.savedCompanionPositions, window.preCombatPositions);
            
            // P≈ôedej pozice do startCombatWithGroup
            window.companionPositionsOverride = window.preCombatPositions;
            
            // Cleanup a≈æ po ulo≈æen√≠ referenc√≠
            window.pendingEnemyGroup = null;
            window.pendingCombatType = null;
            window.preCombatPositions = null;
            
            console.log('üéÆ Calling startCombatWithGroup with', enemyGroup.length, 'enemies');
            
            // Nastav flag aby se pre-combat setup nezobrazoval znovu
            window._inPreCombatFlow = true;
            
            // Spus≈• boj s ulo≈æen√Ωmi referencemi
            startCombatWithGroup(enemyGroup, combatType, true); // true = skip pre-combat
        }
        
        function renderCombatUI() {
            const cs = window.combatState;
            if (!cs) return;
            
            const enemyGroup = cs.enemyGroup;
            
            // Fix: Ensure dead enemies are marked as not alive
            enemyGroup.forEach(e => {
                if (e.hp <= 0 && e.alive) {
                    e.alive = false;
                }
            });
            
            // Check if all enemies are dead - trigger victory
            const stillAlive = enemyGroup.filter(e => e.alive);
            if (stillAlive.length === 0) {
                handleCombatVictory();
                return;
            }
            
            const enemyData = enemyGroup[0];
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            
            // Zachovat obsah combat logu
            const existingLog = document.getElementById('combatLog');
            const combatStartText = '‚öîÔ∏è Boj zaƒç√≠n√°!';
            const logContent = existingLog ? existingLog.innerHTML : `<div style="color: #666;">${combatStartText}</div>`;
            
            // Calculate stats - pou≈æij NASAZEN√â vybaven√≠
            let playerDefense = Math.floor(state.char.attrs.end * 1); // END bonus
            const armor = state.equipped?.armor;
            const helmet = state.equipped?.helmet;
            const gloves = state.equipped?.gloves;
            const boots = state.equipped?.boots;
            if (armor && armor.defense) playerDefense += armor.defense;
            if (helmet && helmet.defense) playerDefense += helmet.defense;
            if (gloves && gloves.defense) playerDefense += gloves.defense;
            if (boots && boots.defense) playerDefense += boots.defense;
            playerDefense += getSkillTreeBonus('defense');
            // Bonusy z mutac√≠ (nap≈ô. Tlust√° k≈Ø≈æe +8 DEF)
            const mutBonuses = getMutationBonuses();
            playerDefense += mutBonuses.defense;
            if (cs.playerDefending) playerDefense *= 2;
            
            const playerDamage = calculateDamage();
            const critChance = Math.round(calculateCritChance() * 100);
            const dodgeChance = Math.round(calculateDodgeChance() * 100);
            
            const countText = enemyGroup.length > 1 ? ` x${enemyGroup.length}` : '';
            
            // Get available items for combat
            const healItems = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
            const throwables = state.inv.filter(i => i.type === 'throwable');
            
            document.getElementById('modalContent').innerHTML = `
                <div style="background: linear-gradient(180deg, #1a0a0a 0%, #0a0a0a 100%); margin: -1rem; padding: 1rem; border-radius: 8px;">
                    
                    <!-- HEADER -->
                    <div style="text-align: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #333;">
                        <h2 style="margin: 0; color: #ff4444;">‚öîÔ∏è ${t('combat', 'title')} - ${t('combat', 'round') || 'Kolo'} ${cs.turn}</h2>
                        ${cs.comboCount > 1 ? `<div style="color: #ffd700; font-size: 0.9rem;">üî• Combo x${cs.comboCount}!</div>` : ''}
                    </div>
                    
                    <!-- COMBATANTS -->
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        
                        <!-- PLAYER -->
                        <div style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #4a7c4a;">
                            <div style="text-align: center; margin-bottom: 0.5rem;">
                                <div style="font-size: 2rem;">üßç</div>
                                <div style="font-weight: bold; color: #8bc34a;">${state.char.name || 'Ty'}</div>
                            </div>
                            
                            <!-- HP Bar -->
                            <div style="margin-bottom: 0.3rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>‚ù§Ô∏è HP</span>
                                    <span>${Math.round(state.char.hp)}/${state.char.maxHp}</span>
                                </div>
                                <div style="height: 8px; background: #1a0a0a; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${(state.char.hp/state.char.maxHp)*100}%; background: linear-gradient(90deg, #c62828, #f44336); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            <!-- Stamina Bar -->
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span>‚ö° Stamina</span>
                                    <span>${cs.playerStamina}%</span>
                                </div>
                                <div style="height: 6px; background: #1a1a0a; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${cs.playerStamina}%; background: linear-gradient(90deg, #ff9800, #ffc107); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            <div style="font-size: 0.75rem; color: #888;">
                                <div>‚öîÔ∏è ${playerDamage} DMG | üõ°Ô∏è ${playerDefense} DEF</div>
                                <div>üí• ${critChance}% krit | üí® ${dodgeChance}% √∫hyb</div>
                                ${(() => {
                                    const weapon = state.equipped?.weapon;
                                    if (weapon?.ammoType) {
                                        const ammoCount = getAmmoCount(weapon.ammoType);
                                        const ammoColor = ammoCount > 10 ? '#8bc34a' : ammoCount > 3 ? '#ff9800' : '#f44336';
                                        return `<div style="color: ${ammoColor};">üî∏ ${getAmmoName(weapon.ammoType)}: ${ammoCount}</div>`;
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                        
                        <!-- VS -->
                        <div style="display: flex; align-items: center; font-size: 1.5rem; color: #666;">‚öîÔ∏è</div>
                        
                        <!-- ENEMIES -->
                        <div onclick="showEnemyInfo('${enemyData.id}')" style="background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.8rem; border-radius: 8px; border: 2px solid #7c4a4a; cursor: pointer;" title="Klikni pro info">
                            <div style="text-align: center; margin-bottom: 0.5rem;">
                                <div style="font-size: 2rem;">${enemyData.icon}</div>
                                <div style="font-weight: bold; color: #ff6666;">${enemyData.name}${countText} <span style="font-size: 0.7rem; color: #666;">‚ÑπÔ∏è</span></div>
                            </div>
                            
                            <!-- Enemy HP Bars -->
                            ${enemyGroup.map((e, i) => `
                                <div class="enemyRow" data-index="${i}" style="margin-bottom: 0.3rem; opacity: ${e.alive ? 1 : 0.3};">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                        <span class="enemyStatus">${e.alive ? '‚ù§Ô∏è' : 'üíÄ'} #${i+1}</span>
                                        <span><span class="enemyHp">${Math.max(0, e.hp)}</span>/${e.maxHp}</span>
                                    </div>
                                    <div style="height: 6px; background: #0a0a0a; border-radius: 3px; overflow: hidden;">
                                        <div class="enemyHpBar" style="height: 100%; width: ${Math.max(0, (e.hp/e.maxHp)*100)}%; background: ${e.alive ? '#c62828' : '#333'}; transition: width 0.3s;"></div>
                                    </div>
                                    ${e.stunned ? '<span style="font-size: 0.6rem; color: #ffeb3b;">üí´ Omr√°ƒçen</span>' : ''}
                                    ${e.poisoned > 0 ? '<span style="font-size: 0.6rem; color: #9c27b0;">‚ò†Ô∏è Otr√°ven</span>' : ''}
                                    ${e.bleeding > 0 ? '<span style="font-size: 0.6rem; color: #f44336;">ü©∏ Krv√°c√≠</span>' : ''}
                                </div>
                            `).join('')}
                            
                            <div style="font-size: 0.75rem; color: #888; margin-top: 0.5rem;">
                                ‚öîÔ∏è ${enemyData.damage} DMG | üõ°Ô∏è ${enemyData.defense} DEF
                            </div>
                        </div>
                    </div>
                    
                    <!-- COMBAT LOG -->
                    <div id="combatLog" style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem; font-family: monospace; font-size: 0.8rem; border: 1px solid #333;">
                        ${logContent}
                    </div>
                    
                    <!-- ACTION BUTTONS -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="combatAction('attack')" style="background: linear-gradient(135deg, #8B0000 0%, #5a0000 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">‚öîÔ∏è</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">√ötok</span>
                            <span style="font-size: 0.65rem; color: #ffa;">-20 stamina</span>
                        </button>
                        
                        <button class="btn" onclick="combatAction('heavy')" ${cs.playerStamina < 40 ? 'disabled style="opacity: 0.5;"' : ''} style="background: linear-gradient(135deg, #6a0000 0%, #3a0000 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">üí•</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">Siln√Ω √∫tok</span>
                            <span style="font-size: 0.65rem; color: #ffa;">-40 stamina, 2x DMG</span>
                        </button>
                        
                        <button class="btn" onclick="combatAction('defend')" style="background: linear-gradient(135deg, #1a4a1a 0%, #0a2a0a 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">üõ°Ô∏è</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">${currentLang === "en" ? "Defense" : "Obrana"}</span>
                            <span style="font-size: 0.65rem; color: #8f8;">+20 stamina, 2x DEF</span>
                        </button>
                        
                        <button class="btn" onclick="combatAction('dodge')" ${cs.playerStamina < 30 ? 'disabled style="opacity: 0.5;"' : ''} style="background: linear-gradient(135deg, #1a1a4a 0%, #0a0a2a 100%); padding: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                            <span style="font-size: 1.3rem;">üí®</span>
                            <span style="font-size: 0.85rem; font-weight: bold;">√öhyb</span>
                            <span style="font-size: 0.65rem; color: #88f;">-30 stamina, vyhni se</span>
                        </button>
                    </div>
                    
                    <!-- SPECIAL ACTIONS -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                        <button class="btn" onclick="showCombatItems('heal')" style="background: #2a2a2a; padding: 0.6rem; font-size: 0.8rem;" ${healItems.length === 0 ? 'disabled' : ''}>
                            üíä L√©ƒçit (${healItems.reduce((sum, i) => sum + (i.count || 1), 0)})
                        </button>
                        
                        <button class="btn" onclick="showCombatItems('throw')" style="background: #2a2a2a; padding: 0.6rem; font-size: 0.8rem;" ${throwables.length === 0 ? 'disabled' : ''}>
                            üí£ Hodit (${throwables.reduce((sum, i) => sum + (i.count || 1), 0)})
                        </button>
                        
                        <button class="btn" onclick="combatAction('flee')" style="background: #444; padding: 0.6rem; font-size: 0.8rem;">
                            üèÉ Ut√©ct
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Zobraz√≠ info o nep≈ô√≠teli bƒõhem boje
        function showEnemyInfo(enemyId) {
            const enemy = Object.values(ENEMIES).flat().find(e => e.id === enemyId);
            if (!enemy) return;
            
            const cs = window.combatState;
            const aliveCount = cs ? cs.enemyGroup.filter(e => e.alive).length : 0;
            const totalCount = cs ? cs.enemyGroup.length : 1;
            
            let html = `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${enemy.icon}</div>
                    <h2 style="margin: 0; color: #ff6666;">${enemy.name}</h2>
                    ${enemy.boss ? '<div style="color: #ffd700; font-size: 0.9rem;">‚≠ê BOSS</div>' : ''}
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>‚ù§Ô∏è HP: <span style="color: #ff6666;">${enemy.hp}</span></div>
                            <div>‚öîÔ∏è √ötok: <span style="color: #ff9800;">${enemy.damage}</span></div>
                            <div>üõ°Ô∏è Obrana: <span style="color: #2196f3;">${enemy.defense}</span></div>
                            <div>‚≠ê XP: <span style="color: #ffd700;">${enemy.xp}</span></div>
                        </div>
                    </div>
                    
                    ${enemy.abilities ? `
                        <div style="background: #2a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; text-align: left;">
                            <div style="color: #9c27b0; font-weight: bold; margin-bottom: 0.3rem;">‚ö° Schopnosti:</div>
                            <div style="color: #888; font-size: 0.85rem;">${enemy.abilities.join(', ')}</div>
                        </div>
                    ` : ''}
                    
                    ${enemy.loot ? `
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; text-align: left;">
                            <div style="color: #4caf50; font-weight: bold; margin-bottom: 0.3rem;">üéÅ Mo≈æn√° ko≈ôist:</div>
                            <div style="color: #888; font-size: 0.85rem;">${enemy.loot.slice(0, 5).join(', ')}${enemy.loot.length > 5 ? '...' : ''}</div>
                        </div>
                    ` : ''}
                    
                    ${cs ? `
                        <div style="margin-top: 1rem; color: #666; font-size: 0.85rem;">
                            Zb√Ωv√°: ${aliveCount}/${totalCount}
                        </div>
                    ` : ''}
                </div>
            `;
            
            showModal(`üìñ ${enemy.name}`, html);
        }
        
        function combatAction(action) {
            const cs = window.combatState;
            if (!cs) return; // Combat u≈æ skonƒçil
            
            const log = document.getElementById('combatLog');
            const enemyGroup = cs.enemyGroup;
            if (!enemyGroup) return; // ≈Ω√°dn√≠ nep≈ô√°tel√©
            
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            
            if (aliveEnemies.length === 0) return;
            
            cs.turn++;
            let playerActed = true;
            let skipEnemyTurn = false;
            
            // Reset defending
            const wasDefending = cs.playerDefending;
            cs.playerDefending = false;
            
            // === PLAYER ACTION ===
            switch(action) {
                case 'attack':
                    if (cs.playerStamina < 20) {
                        log.innerHTML += `<div style="color: #ff9800;">‚ö†Ô∏è ${'Nedostatek staminy pro √∫tok!'}</div>`;
                        playerActed = false;
                        break;
                    }
                    cs.playerStamina = Math.max(0, cs.playerStamina - 20);
                    performAttack(1.0, false);
                    break;
                    
                case 'heavy':
                    if (cs.playerStamina < 40) {
                        log.innerHTML += `<div style="color: #ff9800;">‚ö†Ô∏è ${'Nedostatek staminy pro siln√Ω √∫tok!'}</div>`;
                        playerActed = false;
                        break;
                    }
                    cs.playerStamina = Math.max(0, cs.playerStamina - 40);
                    performAttack(2.0, true);
                    break;
                    
                case 'defend':
                    cs.playerDefending = true;
                    cs.playerStamina = Math.min(100, cs.playerStamina + 20);
                    log.innerHTML += `<div style="color: #4caf50;">üõ°Ô∏è ${'Zauj√≠m√°≈° obrann√Ω postoj!'} (+20 stamina, 2x obrana)</div>`;
                    cs.comboCount = 0;
                    break;
                    
                case 'dodge':
                    if (cs.playerStamina < 30) {
                        log.innerHTML += `<div style="color: #ff9800;">‚ö†Ô∏è ${'Nedostatek staminy pro √∫hyb!'}</div>`;
                        playerActed = false;
                        break;
                    }
                    cs.playerStamina = Math.max(0, cs.playerStamina - 30);
                    skipEnemyTurn = true;
                    log.innerHTML += `<div style="color: #2196f3;">üí® ${'Vyh√Ωb√°≈° se √∫tok≈Øm tento tah!'}</div>`;
                    cs.comboCount = 0;
                    break;
                    
                case 'flee':
                    let fleeChanceOld = 0.4 + (state.char.attrs.agi - 5) * 0.05;
                    // P≈ôidej escape bonus z vybaven√≠
                    const fleeArmorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : {};
                    if (fleeArmorEffects.escapeBonus) {
                        fleeChanceOld += fleeArmorEffects.escapeBonus;
                    }
                    fleeChanceOld = Math.min(0.9, fleeChanceOld); // Max 90%
                    
                    if (Math.random() < fleeChanceOld) {
                        log.innerHTML += `<div style="color: #ff9800;">üèÉ √öspƒõ≈°nƒõ jsi utekl! (${Math.round(fleeChanceOld * 100)}% ≈°ance)</div>`;
                        addLog('üèÉ √ötƒõk z boje √∫spƒõ≈°n√Ω!', 'üèÉ');
                        setTimeout(() => {
                            closeModal();
                            renderFull();
                        }, 1000);
                        return;
                    } else {
                        log.innerHTML += `<div style="color: #c62828;">üèÉ √ötƒõk se nezda≈ôil! (${Math.round(fleeChanceOld * 100)}% ≈°ance)</div>`;
                    }
                    cs.comboCount = 0;
                    break;
            }
            
            // Check victory
            const stillAlive = enemyGroup.filter(e => e.alive);
            if (stillAlive.length === 0) {
                handleCombatVictory();
                return;
            }
            
            // === COMPANION ATTACKS ===
            if (playerActed && state.companions && state.companions.length > 0) {
                const aliveCompanions = state.companions.filter(c => !c.isDead && (c.hp === undefined || c.hp > 0));
                aliveCompanions.forEach(comp => {
                    const aliveEnemiesNow = enemyGroup.filter(e => e.alive);
                    if (aliveEnemiesNow.length === 0) return;
                    
                    // Najdi c√≠l (n√°hodn√Ω ≈æiv√Ω nep≈ô√≠tel)
                    const target = aliveEnemiesNow[Math.floor(Math.random() * aliveEnemiesNow.length)];
                    
                    // Vypoƒç√≠tej damage spoleƒçn√≠ka - pou≈æij getCompanionStat pro spr√°vn√Ω v√Ωpoƒçet
                    const baseDamage = getCompanionStat(comp, 'damage');
                    const levelBonus = Math.floor(((comp.level || 1) - 1) * 2); // +2 damage za ka≈æd√Ω level
                    const totalDamage = Math.max(1, baseDamage + levelBonus - Math.floor(target.defense * 0.3));
                    
                    // Aplikuj damage
                    target.hp -= totalDamage;
                    
                    const compIcon = comp.icon || 'üë§';
                    log.innerHTML += `<div style="color: #8bc34a;">ü§ù ${compIcon} ${escapeHtml(comp.name)} √∫toƒç√≠: -${totalDamage} HP</div>`;
                    
                    if (target.hp <= 0) {
                        target.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">üíÄ ${escapeHtml(comp.name)} zabil nep≈ô√≠tele!</div>`;
                    }
                });
                
                // Check victory po √∫toc√≠ch spoleƒçn√≠k≈Ø
                const stillAliveAfterCompanions = enemyGroup.filter(e => e.alive);
                if (stillAliveAfterCompanions.length === 0) {
                    handleCombatVictory();
                    return;
                }
            }
            
            // === ENEMY TURN ===
            if (playerActed && !skipEnemyTurn) {
                enemyTurn();
            }
            
            // Check death
            if (state.char.hp <= 0) {
                handleCombatDefeat();
                return;
            }
            
            // Apply DOT effects on enemies
            enemyGroup.forEach((e, i) => {
                if (!e.alive) return;
                
                if (e.poisoned > 0) {
                    const poisonDmg = e.poisoned;
                    e.hp -= poisonDmg;
                    log.innerHTML += `<div style="color: #9c27b0;">‚ò†Ô∏è #${i+1} trp√≠ jedem: -${poisonDmg} HP</div>`;
                    e.poisoned = Math.max(0, e.poisoned - 2);
                    if (e.hp <= 0) {
                        e.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">üíÄ #${i+1} zem≈ôel na jed!</div>`;
                    }
                }
                
                if (e.bleeding > 0) {
                    const bleedDmg = e.bleeding;
                    e.hp -= bleedDmg;
                    log.innerHTML += `<div style="color: #f44336;">ü©∏ #${i+1} krv√°c√≠: -${bleedDmg} HP</div>`;
                    e.bleeding = Math.max(0, e.bleeding - 1);
                    if (e.hp <= 0) {
                        e.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">üíÄ #${i+1} vykrv√°cel!</div>`;
                    }
                }
                
                if (e.stunned) {
                    e.stunned = false;
                }
            });
            
            // Check victory after DOT
            if (enemyGroup.filter(e => e.alive).length === 0) {
                handleCombatVictory();
                return;
            }
            
            // Regenerate stamina
            cs.playerStamina = Math.min(100, cs.playerStamina + 5);
            
            log.scrollTop = log.scrollHeight;
            
            // POUZE renderuj combat UI pokud boj st√°le prob√≠h√°
            if (enemyGroup.some(e => e.alive)) {
                renderCombatUI();
            }
        }
        
        function performAttack(multiplier, isHeavy) {
            const cs = window.combatState;
            const log = document.getElementById('combatLog');
            const enemyGroup = cs.enemyGroup;
            
            // Check if AOE attack (from Berserker ability or throwables)
            const isAOE = state.combatBonuses?.aoeNextAttack === true;
            if (isAOE) {
                state.combatBonuses.aoeNextAttack = false; // Reset
            }
            
            // Find targets
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            if (aliveEnemies.length === 0) return;
            
            // AOE attack targets all enemies, normal attack targets first alive
            const targets = isAOE ? aliveEnemies : [aliveEnemies[0]];
            
            if (isAOE) {
                log.innerHTML += `<div style="color: #ff5722; font-weight: bold;">üî• PLO≈†N√ù √öTOK! Zasa≈æeno ${targets.length} nep≈ô√°tel!</div>`;
                SoundSystem.play('critical');
            }
            
            // Check ammo for ranged weapons
            const weapon = state.equipped?.weapon;
            if (weapon?.ammoType) {
                const ammoNeeded = isHeavy ? 2 : 1; // Siln√Ω √∫tok spot≈ôebuje 2 n√°boje
                const currentAmmo = getAmmoCount(weapon.ammoType);
                
                if (currentAmmo < ammoNeeded) {
                    log.innerHTML += `<div style="color: #ff9800;">‚ö†Ô∏è Nem√°≈° dost n√°boj≈Ø pro ${weapon.name}! (pot≈ôeba: ${ammoNeeded}, m√°≈°: ${currentAmmo}) √ötoƒç√≠≈° pƒõstmi...</div>`;
                    // √ötok pƒõstmi - z√°kladn√≠ damage
                    if (aliveEnemies.length > 0) {
                        const fistDamage = Math.max(1, Math.floor(state.char.attrs.str * 0.5));
                        aliveEnemies[0].hp -= Math.max(1, fistDamage - aliveEnemies[0].defense);
                        log.innerHTML += `<div style="color: #888;">üëä √ötok pƒõst√≠: ${fistDamage} DMG</div>`;
                    }
                    return;
                }
                
                // Spot≈ôebuj munici
                consumeAmmo(weapon.ammoType, ammoNeeded);
                log.innerHTML += `<div style="color: #666; font-size: 0.8rem;">üî∏ -${ammoNeeded} ${getAmmoName(weapon.ammoType)} (zb√Ωv√°: ${currentAmmo - ammoNeeded})</div>`;
            }
            
            // Attack each target
            targets.forEach((target, idx) => {
                const targetIndex = enemyGroup.indexOf(target);
                
                // Skip stunned enemies can't defend
                const effectiveDefense = target.stunned ? 0 : target.defense;
                
                // Calculate damage (slightly reduced for AOE)
                let damage = Math.floor(calculateDamage() * multiplier * (isAOE && targets.length > 1 ? 0.7 : 1.0));
                
                // Combo bonus (only for single target)
                if (!isAOE) {
                    if (cs.lastAction === 'attack' || cs.lastAction === 'heavy') {
                        cs.comboCount++;
                        if (cs.comboCount > 1) {
                            const comboBonus = 1 + (cs.comboCount - 1) * 0.1;
                            damage = Math.floor(damage * comboBonus);
                        }
                    } else {
                        cs.comboCount = 1;
                    }
                }
                cs.lastAction = isHeavy ? 'heavy' : 'attack';
                
                // Critical hit
                const critChance = calculateCritChance();
                const isCrit = Math.random() < critChance;
                if (isCrit) {
                    damage = Math.floor(damage * 2);
                    if (idx === 0) { // Only show once
                        log.innerHTML += `<div style="color: #ffd700; font-weight: bold;">${'üí• KRITICK√ù Z√ÅSAH!'}</div>`;
                        SoundSystem.play('critical');
                    }
                }
                
                // Apply defense
                damage = Math.max(1, damage - effectiveDefense);
                target.hp -= damage;
                
                // Heavy attack can stun (lower chance for AOE)
                if (isHeavy && Math.random() < (isAOE ? 0.15 : 0.3)) {
                    target.stunned = true;
                    log.innerHTML += `<div style="color: #ffeb3b;">üí´ #${targetIndex+1} omr√°ƒçen!</div>`;
                }
                
                // Weapon special effects (only on first target for AOE)
                if (idx === 0 || !isAOE) {
                    if (weapon?.special === 'poison' && Math.random() < 0.3) {
                        target.poisoned = Math.max(target.poisoned, 5);
                        log.innerHTML += `<div style="color: #9c27b0;">‚ò†Ô∏è Jed pronik√° do r√°ny!</div>`;
                    }
                    if (weapon?.special === 'bleed' && Math.random() < 0.25) {
                        target.bleeding = Math.max(target.bleeding, 3);
                        log.innerHTML += `<div style="color: #f44336;">ü©∏ Zp≈Øsobil jsi krv√°cen√≠!</div>`;
                    }
                    if (weapon?.special === 'stun' && Math.random() < 0.2) {
                        target.stunned = true;
                        log.innerHTML += `<div style="color: #ffeb3b;">üí´ Elektrick√Ω ≈°ok omr√°ƒçil nep≈ô√≠tele!</div>`;
                    }
                }
                
                // Weapon coating effects (only first target)
                if (idx === 0 && state.weaponCoating && state.weaponCoating.uses > 0) {
                    state.weaponCoating.uses--;
                    if (state.weaponCoating.effect === 'poison') {
                        target.poisoned = Math.max(target.poisoned, 6);
                        log.innerHTML += `<div style="color: #9c27b0;">üß™ Jedov√Ω povlak: Otr√°veno! (zb√Ωv√° ${state.weaponCoating.uses} pou≈æit√≠)</div>`;
                    } else if (state.weaponCoating.effect === 'fire') {
                        const fireDmg = 5;
                        target.hp -= fireDmg;
                        log.innerHTML += `<div style="color: #ff5722;">üî• Z√°paln√° pasta: +${fireDmg} DMG! (zb√Ωv√° ${state.weaponCoating.uses} pou≈æit√≠)</div>`;
                    }
                    if (state.weaponCoating.uses <= 0) {
                        log.innerHTML += `<div style="color: #888;">üí® Povlak na zbrani se spot≈ôeboval.</div>`;
                        state.weaponCoating = null;
                    }
                }
                
                log.innerHTML += `<div style="color: #8bc34a;">‚öîÔ∏è ${isHeavy ? 'Siln√Ω √∫tok' : '√ötok'} na #${targetIndex+1}: ${damage} DMG${effectiveDefense > 0 ? ` (obrana -${effectiveDefense})` : ''}</div>`;
                
                // Check kill
                if (target.hp <= 0) {
                    target.alive = false;
                    log.innerHTML += `<div style="color: #ffd700;">üíÄ Zabil jsi #${targetIndex+1}!</div>`;
                }
            });
            
            SoundSystem.play('combat_hit');
            
            // Mutant regenerace: +2 HP p≈ôi z√°sahu
            if (state.char.class === 'mutant') {
                const healAmount = 2;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                log.innerHTML += `<div style="color: #76ff03;">ü¶é Regenerace: +${healAmount} HP</div>`;
            }
            
            // Companion attacks
            if (state.companions && state.companions.length > 0) {
                state.companions.forEach(comp => {
                    if (comp.isDead) return;
                    const compInfo = COMPANIONS.find(c => c.id === comp.id);
                    if (!compInfo) return;
                    
                    const aliveTarget = enemyGroup.find(e => e.alive);
                    if (!aliveTarget) return;
                    
                    // Pou≈æij getCompanionStat pro spr√°vn√Ω v√Ωpoƒçet vƒçetnƒõ levelu a vybaven√≠
                    let compDmg = getCompanionStat(comp, 'damage') + Math.floor(Math.random() * 3);
                    compDmg = Math.max(1, compDmg - aliveTarget.defense);
                    aliveTarget.hp -= compDmg;
                    
                    const compIcon = comp.icon || compInfo.icon;
                    const compName = comp.name || compInfo.name;
                    log.innerHTML += `<div style="color: #ce93d8;">${compIcon} ${compName}: ${compDmg} DMG</div>`;
                    
                    if (aliveTarget.hp <= 0) {
                        aliveTarget.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">üíÄ ${compName} zabil nep≈ô√≠tele!</div>`;
                    }
                });
            }
            
            // Update enemy HP bars
            enemyGroup.forEach((e, i) => {
                const hpSpan = document.querySelectorAll('.enemyHp')[i];
                if (hpSpan) hpSpan.textContent = Math.max(0, e.hp);
                const hpBar = document.querySelectorAll('.enemyHpBar')[i];
                if (hpBar) {
                    hpBar.style.width = Math.max(0, (e.hp/e.maxHp)*100) + '%';
                    if (!e.alive) hpBar.style.background = '#333';
                }
                if (!e.alive) {
                    const enemyRow = document.querySelectorAll('.enemyRow')[i];
                    if (enemyRow) enemyRow.style.opacity = '0.3';
                }
            });
            
            // Check victory after attack
            const stillAlive = enemyGroup.filter(e => e.alive);
            if (stillAlive.length === 0) {
                // Volej okam≈æitƒõ - combatAction() zkontroluje a ukonƒç√≠ se
                handleCombatVictory();
                return; // D≈Øle≈æit√© - ukonƒçi performAttack
            }
        }
        
        function enemyTurn() {
            const cs = window.combatState;
            if (!cs || !cs.enemyGroup) return; // Combat u≈æ skonƒçil
            
            const log = document.getElementById('combatLog');
            const enemyGroup = cs.enemyGroup;
            
            // Zkontroluj zda jsou v≈Øbec ≈æiv√≠ nep≈ô√°tel√©
            if (enemyGroup.filter(e => e.alive).length === 0) return;
            
            let totalDamage = 0;
            const aliveEnemies = enemyGroup.filter(e => e.alive && !e.stunned);
            
            // Get equipped armor
            const playerArmor = state.equipped?.armor;
            
            // Z√≠skej ≈æiv√© spoleƒçn√≠ky pro mo≈æn√Ω √∫tok nep≈ô√°tel na nƒõ
            const aliveCompanions = (state.companions || []).filter(c => !c.isDead && (c.hp === undefined || c.hp > 0));
            
            aliveEnemies.forEach((enemy, i) => {
                // 30% ≈°ance ≈æe nep≈ô√≠tel za√∫toƒç√≠ na spoleƒçn√≠ka m√≠sto hr√°ƒçe
                if (aliveCompanions.length > 0 && Math.random() < 0.3) {
                    const targetComp = aliveCompanions[Math.floor(Math.random() * aliveCompanions.length)];
                    let enemyDmg = enemy.damage + Math.floor(Math.random() * 5) - 2;
                    const compDef = targetComp.defense || 5;
                    enemyDmg = Math.max(1, enemyDmg - compDef);
                    
                    if (targetComp.hp === undefined) targetComp.hp = targetComp.maxHp || 80;
                    targetComp.hp -= enemyDmg;
                    
                    log.innerHTML += `<div style="color: #ff9800;">‚öîÔ∏è Nep≈ô√≠tel √∫toƒç√≠ na ${targetComp.icon || 'üë§'} ${targetComp.name}: -${enemyDmg} HP</div>`;
                    
                    if (targetComp.hp <= 0) {
                        targetComp.isDead = true;
                        targetComp.hp = 0;
                        log.innerHTML += `<div style="color: #c62828;">üíÄ ${targetComp.name} padl v boji!</div>`;
                        const idx = aliveCompanions.indexOf(targetComp);
                        if (idx > -1) aliveCompanions.splice(idx, 1);
                    }
                    return; // Tento nep≈ô√≠tel u≈æ √∫toƒçil
                }
                
                // Dodge chance
                const dodgeChance = calculateDodgeChance();
                if (Math.random() < dodgeChance) {
                    log.innerHTML += `<div style="color: #2196f3;">üí® Vyhnul ses √∫toku od #${enemyGroup.indexOf(enemy)+1}!</div>`;
                    return;
                }
                
                // Calculate enemy damage
                let enemyDmg = enemy.damage + Math.floor(Math.random() * 5) - 2;
                
                // üåô Noƒçn√≠ bonus pro nep≈ô√°tele (+20% v noci)
                const dayPhase = getCurrentDayPhase();
                if (dayPhase.id === 'night') {
                    enemyDmg = Math.floor(enemyDmg * 1.2);
                } else if (dayPhase.id === 'dusk') {
                    enemyDmg = Math.floor(enemyDmg * 1.1); // +10% za soumraku
                }
                
                // üåßÔ∏è Poƒças√≠ efekty pro nep≈ô√°tele - pou≈æij weather.effect.enemyDmgMod
                const weather = getCurrentWeather();
                if (weather?.effect?.enemyDmgMod) {
                    enemyDmg = Math.floor(enemyDmg * weather.effect.enemyDmgMod);
                }
                
                // Player defense - pou≈æij equipped armor
                let playerDef = Math.max(0, Math.floor((state.char.attrs.end - 5) * 1)); // END bonus
                if (playerArmor && playerArmor.defense) playerDef += playerArmor.defense;
                playerDef += getSkillTreeBonus('defense');
                if (cs.playerDefending) playerDef *= 2;
                
                // Accessory defense bonus
                if (state.equippedAccessory) {
                    const acc = state.inv.find(i => i.id === state.equippedAccessory);
                    if (acc?.bonus === 'defense') playerDef += acc.value || 0;
                }
                
                enemyDmg = Math.max(1, enemyDmg - playerDef);
                totalDamage += enemyDmg;
            });
            
            if (totalDamage > 0) {
                state.char.hp -= totalDamage;
                
                // Sleduj zdroj po≈°kozen√≠ pro death screen
                const firstEnemy = cs.units?.find(u => u.team === 'enemy' && u.hp > 0);
                state.lastDamageSource = firstEnemy?.name || 'Nep≈ô√≠tel';
                state.lastDamageAmount = totalDamage;
                
                log.innerHTML += `<div style="color: #f44336;">üíî Nep≈ô√°tel√© √∫toƒç√≠: -${totalDamage} HP${cs.playerDefending ? ' (obrana aktivn√≠)' : ''}</div>`;
                SoundSystem.play('damage');
                
                // Degrade armor - 2 durability za kolo
                if (playerArmor && playerArmor.durability !== undefined) {
                    playerArmor.durability = Math.max(0, playerArmor.durability - 2);
                    if (playerArmor.durability === 0) {
                        log.innerHTML += `<div style="color: #c62828;">üíî ${playerArmor.icon} ${playerArmor.name} se rozpadlo!</div>`;
                        state.equipped.armor = null;
                    } else if (playerArmor.durability <= 20) {
                        log.innerHTML += `<div style="color: #ff9800;">‚ö†Ô∏è Brnƒõn√≠: ${playerArmor.durability}/${playerArmor.maxDurability}</div>`;
                    }
                }
                
                // Degrade helmet - 1 durability za kolo
                const playerHelmet = state.equipped?.helmet;
                if (playerHelmet && playerHelmet.durability !== undefined) {
                    playerHelmet.durability = Math.max(0, playerHelmet.durability - 1);
                    if (playerHelmet.durability === 0) {
                        log.innerHTML += `<div style="color: #c62828;">üíî ${playerHelmet.icon} ${playerHelmet.name} se rozpadla!</div>`;
                        state.equipped.helmet = null;
                    }
                }
                
                // Degrade boots - 1 durability za kolo
                const playerBoots = state.equipped?.boots;
                if (playerBoots && playerBoots.durability !== undefined) {
                    playerBoots.durability = Math.max(0, playerBoots.durability - 1);
                    if (playerBoots.durability === 0) {
                        log.innerHTML += `<div style="color: #c62828;">üíî ${playerBoots.icon} ${playerBoots.name} se rozpadly!</div>`;
                        state.equipped.boots = null;
                    }
                }
            }
            
            // Stunned enemies message
            const stunnedCount = enemyGroup.filter(e => e.alive && e.stunned).length;
            if (stunnedCount > 0) {
                log.innerHTML += `<div style="color: #ffeb3b;">üí´ ${stunnedCount} nep≈ô√≠tel omr√°ƒçen - ne√∫toƒç√≠</div>`;
            }
        }
        
        function showCombatItems(type) {
            const cs = window.combatState;
            let items;
            let title;
            
            if (type === 'heal') {
                items = state.inv.filter(i => i.type === 'consumable' && i.effect === 'health');
                title = 'üíä Pou≈æ√≠t l√©ƒçivo';
            } else {
                items = state.inv.filter(i => i.type === 'throwable');
                title = 'üí£ Hodit p≈ôedmƒõt';
            }
            
            if (items.length === 0) return;
            
            let html = `<h3>${title}</h3><div style="display: grid; gap: 0.5rem; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
            items.forEach((item, idx) => {
                const count = item.count || 1;
                html += `
                    <button class="btn" onclick="useCombatItem('${item.id}', '${type}')" style="background: #2a2a2a; padding: 0.8rem; text-align: left; display: flex; align-items: center; gap: 0.8rem;">
                        <span style="font-size: 1.5rem;">${item.icon}</span>
                        <div>
                            <div style="font-weight: bold;">${item.name} x${count}</div>
                            <div style="font-size: 0.8rem; color: #888;">${type === 'heal' ? `+${item.value} HP` : `${item.damage || '?'} DMG`}</div>
                        </div>
                    </button>
                `;
            });
            html += '</div><button class="btn" onclick="renderCombatUI()" style="width: 100%; margin-top: 1rem; background: #555;">' + ('Zpƒõt') + '</button>';
            
            document.getElementById('modalContent').innerHTML = html;
        }
        
        function useCombatItem(itemId, type) {
            const cs = window.combatState;
            const log = document.getElementById('combatLog');
            const item = state.inv.find(i => i.id === itemId);
            
            if (!item) return;
            
            if (type === 'heal') {
                const healAmount = item.value || 20;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                log.innerHTML += `<div style="color: #4caf50;">üíä Pou≈æil jsi ${escapeHtml(item.name)}: +${healAmount} HP</div>`;
            } else {
                // Throwable - damage all enemies
                const damage = item.damage || 30;
                cs.enemyGroup.forEach((e, i) => {
                    if (!e.alive) return;
                    e.hp -= damage;
                    if (e.hp <= 0) {
                        e.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">üíÄ ${item.icon} zabil #${i+1}!</div>`;
                    }
                });
                log.innerHTML += `<div style="color: #ff9800;">üí• ${escapeHtml(item.name)}: ${damage} DMG v≈°em!</div>`;
                
                // Check victory
                if (cs.enemyGroup.filter(e => e.alive).length === 0) {
                    handleCombatVictory();
                    // Remove item
                    if (item.count > 1) item.count--;
                    else state.inv = state.inv.filter(i => i !== item);
                    return;
                }
            }
            
            // Remove item
            if (item.count > 1) item.count--;
            else state.inv = state.inv.filter(i => i !== item);
            
            // Enemy turn after using item
            enemyTurn();
            
            // Phoenix efekt - p≈ôe≈æit√≠ smrti
            if (state.char.hp <= 0) {
                const armorEffects = getArmorSpecialEffects();
                if (armorEffects.phoenix && !window.phoenixUsed) {
                    state.char.hp = Math.floor(state.char.maxHp * 0.3);
                    window.phoenixUsed = true;
                    const log = document.getElementById('combat-log');
                    if (log) log.innerHTML += `<div style="color: #ff9800; font-weight: bold;">üî• PHOENIX! Pl√°≈°≈• F√©nixe tƒõ zachr√°nil! Obnoveno ${state.char.hp} HP!</div>`;
                    SoundSystem.play('victory');
                }
            }
            
            if (state.char.hp <= 0) {
                handleCombatDefeat();
                return;
            }
            
            cs.turn++;
            renderCombatUI();
        }
        
        function handleCombatVictory() {
            const cs = window.combatState;
            
            // Zvuk v√≠tƒõzstv√≠
            if (typeof playCombatSound === 'function') playCombatSound('victory');
            
            // === TERRITORY GUARD COMBAT ===
            // Pokud to byl boj se str√°≈æci √∫zem√≠, zpracuj ho zvl√°≈°≈•
            if (cs.combatType === 'territory_guard' && window.territoryBattle) {
                onTerritoryBattleEnd(true);
                window.combatState = null;
                renderFull();
                return;
            }
            
            // Podpora pro star√Ω i nov√Ω syst√©m
            const enemyUnits = cs.units ? cs.units.filter(u => u.team === 'enemy') : cs.enemyGroup;
            
            // Debug
            console.log('üèÜ handleCombatVictory started');
            console.log('üèÜ combatState:', cs);
            console.log('üèÜ enemyUnits:', enemyUnits);
            
            // O≈°et≈ôen√≠ pro pr√°zdn√© enemyUnits
            if (!enemyUnits || enemyUnits.length === 0) {
                console.error('üèÜ ERROR: No enemy units found!');
                closeModal();
                renderFull();
                notifySuccess('üèÜ V√≠tƒõzstv√≠!', 'Porazil jsi v≈°echny nep≈ô√°tele!');
                window.combatState = null;
                return;
            }
            
            const enemyData = enemyUnits[0];
            const enemyCount = enemyUnits.length;
            
            state.stats.kills = (state.stats.kills || 0) + enemyCount;
            
            // === ACHIEVEMENT TRACKING ===
            // Boss kills
            if (enemyData.isBoss || enemyData.boss || enemyData.id?.includes('boss') || enemyData.name?.includes('Boss')) {
                state.stats.bossKills = (state.stats.bossKills || 0) + 1;
            }
            
            // Flawless win (bez zranƒõn√≠)
            const playerUnit = cs.units ? cs.units.find(u => u.team === 'player') : null;
            const startHp = cs.startPlayerHp || state.char.maxHp;
            const currentHp = playerUnit ? playerUnit.hp : state.char.hp;
            if (currentHp >= startHp) {
                state.stats.flawlessWins = (state.stats.flawlessWins || 0) + 1;
            }
            
            // Pacifist tracking - reset p≈ôi zabit√≠
            state.stats.lastKillDay = state.time.days;
            
            // Update timed quest objectives - combat victory
            checkTimedQuestObjectives('combat_victory', state.world.currentLocation);
            checkCompanionQuestObjectives('combat_victory', state.world.currentLocation);
            
            // Track kills by enemy type for bounties
            if (!state.stats.killsByType) state.stats.killsByType = {};
            const enemyType = enemyData.id || enemyData.name?.toLowerCase().replace(/\s+/g, '_');
            state.stats.killsByType[enemyType] = (state.stats.killsByType[enemyType] || 0) + enemyCount;
            
            // Track general categories too
            if (enemyData.id?.includes('wolf') || enemyData.name?.includes('Vlk')) {
                state.stats.killsByType['wolf'] = (state.stats.killsByType['wolf'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('mutant') || enemyData.name?.includes('utant')) {
                state.stats.killsByType['mutant'] = (state.stats.killsByType['mutant'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('raider') || enemyData.name?.includes('√°jezd')) {
                state.stats.killsByType['raider'] = (state.stats.killsByType['raider'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('ghoul') || enemyData.name?.includes('h√∫l')) {
                state.stats.killsByType['ghoul'] = (state.stats.killsByType['ghoul'] || 0) + enemyCount;
            }
            if (enemyData.id?.includes('robot') || enemyData.name?.includes('obot')) {
                state.stats.killsByType['robot'] = (state.stats.killsByType['robot'] || 0) + enemyCount;
            }
            
            // Update NPC quest progress (kills)
            if (state.npcQuests) {
                Object.keys(state.npcQuests).forEach(npcId => {
                    const quest = state.npcQuests[npcId];
                    if (quest && quest.id) {
                        if (!quest.progress) quest.progress = { kills: 0, explored: 0, escortLocations: 0, alphaKilled: false };
                        const questDef = NPC_QUESTS[quest.id];
                        
                        // Kills requirement
                        if (questDef?.requirement?.kills) {
                            quest.progress.kills = (quest.progress.kills || 0) + enemyCount;
                            console.log(`üíÄ Kills progress pro ${quest.id}: ${quest.progress.kills}/${questDef.requirement.kills}`);
                        }
                        
                        // Kill Alpha requirement - detekce alfa pred√°tor≈Ø
                        if (questDef?.requirement?.killAlpha && !quest.progress.alphaKilled) {
                            const isAlpha = enemyData.id?.includes('alpha') || 
                                           enemyData.name?.toLowerCase().includes('alfa') ||
                                           enemyData.isBoss || 
                                           enemyData.tier >= 4;
                            if (isAlpha) {
                                quest.progress.alphaKilled = true;
                                console.log(`üê∫ Alpha killed! Quest ${quest.id} splnƒõn`);
                                notifySuccess('Alfa zabit!', `Zabil jsi ${enemyData.name}! Vra≈• se pro odmƒõnu.`);
                            }
                        }
                    }
                });
            }
            
            // Debug
            console.log('üèÜ handleCombatVictory - enemyData:', enemyData);
            console.log('üèÜ enemyUnits:', enemyUnits);
            
            // === V√ÅLEƒåN√Å Z√ìNA - speci√°ln√≠ re≈æim ===
            if (state.warZoneFight?.active) {
                const warFight = state.warZoneFight;
                state.warZoneFight = null;
                window.combatState = null;
                
                // Obnov p≈Øvodn√≠ HP (p≈ôed bojem)
                state.char.hp = warFight.savedHp || state.char.hp;
                
                const factionData = PVP_FACTIONS[warFight.faction];
                
                // P≈ôidej body a nastav cooldown
                if (multiplayerEnabled && firebaseDB) {
                    const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                    
                    // Nastav cooldown
                    firebaseDB.ref('warZone/cooldowns/' + myName).set(Date.now()).catch(e => {});
                    
                    // P≈ôidej body frakci (do war zone)
                    firebaseDB.ref('warZone/factionPoints/' + warFight.faction).transaction(current => (current || 0) + warFight.pointsPerWin).catch(e => {});
                    
                    // P≈ôidej body i hr√°ƒçovi do ≈æeb≈ô√≠ƒçku - spolehlivƒõj≈°√≠ metoda
                    const contribRef = firebaseDB.ref('factionMembers/' + myName + '/contribution');
                    contribRef.once('value').then(snap => {
                        const current = snap.val() || 0;
                        contribRef.set(current + warFight.pointsPerWin).catch(e => console.error('Contrib error:', e));
                        console.log('üè¥ War zone contribution: ' + current + ' -> ' + (current + warFight.pointsPerWin));
                    }).catch(e => console.error('Contrib read error:', e));
                    
                    state.pvpFactionContribution = (state.pvpFactionContribution || 0) + warFight.pointsPerWin;
                }
                
                showModal('üèÜ V√≠tƒõzstv√≠!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">‚öîÔ∏è</div>
                        <h3 style="color: #4caf50;">Porazil jsi nep≈ô√°tele!</h3>
                        <div style="background: ${factionData?.color || '#666'}22; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${factionData?.color || '#666'};">
                            <p style="color: ${factionData?.color || '#fff'}; font-size: 1.5rem; margin: 0;">
                                +${warFight.pointsPerWin} bod≈Ø
                            </p>
                            <p style="color: #888; margin: 0.5rem 0 0 0;">pro ${factionData?.icon || '?'} ${factionData?.name || 'tvou frakci'}</p>
                        </div>
                        <p style="color: #ff9800; font-size: 0.9rem;">‚è≥ Dal≈°√≠ boj za 10 minut</p>
                    </div>
                    <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        V√Ωbornƒõ!
                    </button>
                `);
                return;
            }
            
            const xpGain = (enemyData?.xp || 25) * enemyCount;
            console.log('üèÜ xpGain:', xpGain);
            addXP(xpGain);
            
            // Companion XP - spoleƒçn√≠ci z√≠sk√°vaj√≠ 50% XP z boje
            addCompanionXP(Math.floor(xpGain * 0.5));
            
            // Faction reputation
            if (enemyData.faction) {
                changeReputation(enemyData.faction, -5 * enemyCount, 'zabit√≠ ' + enemyData.name);
                if (enemyData.faction === 'raiders') {
                    changeReputation('traders', 2 * enemyCount, 'ochrana obchodn√≠k≈Ø');
                    changeReputation('military', 1 * enemyCount, 'eliminace hrozby');
                }
                if (enemyData.faction === 'mutants') {
                    changeReputation('military', 2 * enemyCount, 'ƒçi≈°tƒõn√≠ pustiny');
                }
            }
            
            // Daily quest progress
            if (state.dailyQuests.progress) {
                state.dailyQuests.progress.kills = (state.dailyQuests.progress.kills || 0) + enemyCount;
            }
            checkDailyQuests();
            
            // Collect loot
            let lootHtml = '';
            let totalMoney = 0;
            
            // Helper pro generov√°n√≠ jednoho lootu
            function generateSingleLoot(lootArray) {
                // 50% ≈°ance ≈æe item v≈Øbec nepadne (sn√≠≈æen√≠ lootu)
                if (Math.random() < 0.5) {
                    return; // Nic nepadne
                }
                
                const lootId = lootArray[Math.floor(Math.random() * lootArray.length)];
                
                // Legendary m√° jen 8% ≈°anci dropnout (i kdy≈æ je v loot poli)
                if (lootId === 'legendary' || lootId === 'legendary_weapon' || lootId === 'legendary_armor' || lootId === 'legendary_item') {
                    if (Math.random() > 0.08) {
                        // 92% ≈°ance ≈æe legendary NEpadne - m√≠sto toho d√° rare nebo nic
                        if (Math.random() < 0.25) {
                            // 25% ≈°ance na rare jako n√°hradu
                            const rareItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic');
                            if (rareItems.length > 0) {
                                const rareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                                if (canAddItem(rareItem, 1)) {
                                    addItemToInventory(rareItem, 1, true);
                                    lootHtml += `<div style="color: #9c27b0;">üéÅ ${rareItem.icon} ${rareItem.name}</div>`;
                                }
                            }
                        }
                        return; // Legendary nepadne
                    }
                }
                
                // Unique m√° jen 5% ≈°anci dropnout
                if (lootId === 'unique' || lootId === 'unique_artifact') {
                    if (Math.random() > 0.05) {
                        // 95% ≈°ance ≈æe unique NEpadne - m√≠sto toho d√° rare nebo nic
                        if (Math.random() < 0.20) {
                            // 20% ≈°ance na rare jako n√°hradu
                            const rareItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic');
                            if (rareItems.length > 0) {
                                const rareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                                if (canAddItem(rareItem, 1)) {
                                    addItemToInventory(rareItem, 1, true);
                                    lootHtml += `<div style="color: #9c27b0;">üéÅ ${rareItem.icon} ${rareItem.name}</div>`;
                                }
                            }
                        }
                        return; // Unique nepadne
                    }
                }
                
                if (lootId === 'money') {
                    const moneyGain = Math.floor(Math.random() * 75) + 30;
                    totalMoney += moneyGain;
                    return;
                }
                
                // Zkus naj√≠t item p≈ô√≠mo nebo z kategorie
                let lootItem = ITEMS.find(i => i.id === lootId);
                
                // Pokud nen√≠ p≈ô√≠m√Ω item, zkus kategorie
                if (!lootItem) {
                    const categoryItems = {
                        'weapon': ITEMS.filter(i => i.type === 'weapon' && i.rarity !== 'legendary'),
                        'rare_weapon': ITEMS.filter(i => i.type === 'weapon' && (i.rarity === 'rare' || i.rarity === 'epic')),
                        'legendary_weapon': ITEMS.filter(i => i.type === 'weapon' && i.rarity === 'legendary'),
                        'armor': ITEMS.filter(i => i.type === 'armor' && i.rarity !== 'legendary'),
                        'rare_armor': ITEMS.filter(i => i.type === 'armor' && (i.rarity === 'rare' || i.rarity === 'epic')),
                        'legendary_armor': ITEMS.filter(i => i.type === 'armor' && i.rarity === 'legendary'),
                        'legendary': ITEMS.filter(i => i.rarity === 'legendary'),
                        'legendary_item': ITEMS.filter(i => i.rarity === 'legendary'),
                        'rare': ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic'),
                        'rare_item': ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic'),
                        'ammo': ITEMS.filter(i => i.type === 'ammo'),
                        'medkit': ITEMS.filter(i => i.id === 'medkit' || i.id === 'first_aid'),
                        'food': ITEMS.filter(i => i.type === 'food' || i.effect === 'hunger'),
                        'radaway': ITEMS.filter(i => i.id === 'radx'),
                        'radx': ITEMS.filter(i => i.id === 'radx'),
                        'tech': ITEMS.filter(i => i.type === 'tool'),
                        'unique': ITEMS.filter(i => i.rarity === 'legendary'),
                        'stimpak': ITEMS.filter(i => i.id === 'stimpak' || i.id === 'medkit')
                    };
                    
                    const categoryList = categoryItems[lootId];
                    if (categoryList && categoryList.length > 0) {
                        lootItem = categoryList[Math.floor(Math.random() * categoryList.length)];
                    }
                }
                
                if (lootItem) {
                    if (lootItem.type === 'resource') {
                        state.resources[lootItem.id] = (state.resources[lootItem.id] || 0) + 1;
                        const icon = RESOURCE_ICONS[lootItem.id] || lootItem.icon || 'üì¶';
                        const name = RESOURCE_NAMES[lootItem.id] || lootItem.name || lootItem.id;
                        lootHtml += `<div style="color: #ffd700;">üéÅ ${icon} ${name}</div>`;
                    } else if (lootItem.type === 'ammo') {
                        // Munice pad√° v mno≈æstv√≠ 3-6
                        const ammoCount = 3 + Math.floor(Math.random() * 4);
                        if (canAddItem(lootItem, ammoCount)) {
                            addItemToInventory(lootItem, ammoCount, true);
                            lootHtml += `<div style="color: #ffd700;">üéÅ ${lootItem.icon} ${lootItem.name} x${ammoCount}</div>`;
                        } else {
                            // Ulo≈æ na zem
                            addToGroundLoot({...lootItem, count: ammoCount});
                            lootHtml += `<div style="color: #ff9800;">üì¶ ${lootItem.icon} ${lootItem.name} x${ammoCount} (na zemi)</div>`;
                        }
                    } else if (canAddItem(lootItem, 1)) {
                        addItemToInventory(lootItem, 1, true);
                        lootHtml += `<div style="color: #ffd700;">üéÅ ${lootItem.icon} ${lootItem.name}</div>`;
                    } else {
                        // Ulo≈æ na zem m√≠sto zahozen√≠
                        addToGroundLoot({...lootItem});
                        lootHtml += `<div style="color: #ff9800;">üì¶ ${lootItem.icon} ${lootItem.name} (na zemi)</div>`;
                    }
                } else {
                    // Fallback - p≈ôidej jako resource s ƒçesk√Ωm p≈ôekladem
                    state.resources[lootId] = (state.resources[lootId] || 0) + 1;
                    const icon = RESOURCE_ICONS[lootId] || 'üì¶';
                    const lootTranslations = {
                        'documents': 'Dokumenty',
                        'plutonium_core': 'Plutoniov√© j√°dro',
                        'book': 'Kniha',
                        'medicine': 'L√©ky',
                        'tech': 'Technologie',
                        'unique': 'Unik√°t',
                        'legendary': 'Legend√°rn√≠ p≈ôedmƒõt',
                        'rare': 'Vz√°cn√Ω p≈ôedmƒõt',
                        'weapon': 'Zbra≈à',
                        'armor': 'Zbroj',
                        'ammo': 'Munice',
                        'food': 'J√≠dlo',
                        'water': 'Voda'
                    };
                    const name = RESOURCE_NAMES[lootId] || lootTranslations[lootId] || lootId;
                    lootHtml += `<div style="color: #ffd700;">üéÅ ${icon} +1 ${name}</div>`;
                }
            }
            
            // Loot se sb√≠r√° v≈ædy kromƒõ ar√©ny
            if (!state.inArena) {
                enemyUnits.forEach((unit) => {
                    if (unit.loot && unit.loot.length > 0) {
                        // Bossov√© maj√≠ lootCount pro v√≠ce item≈Ø
                        const lootCount = unit.lootCount || 1;
                        for (let i = 0; i < lootCount; i++) {
                            generateSingleLoot(unit.loot);
                        }
                    } else if (enemyData.loot && enemyData.loot.length > 0) {
                        generateSingleLoot(enemyData.loot);
                    }
                });
                
                // Scavenger armor bonus - ≈°ance na extra loot
                const armorEffects = getArmorSpecialEffects();
                if (armorEffects.lootBonus > 0 && Math.random() < armorEffects.lootBonus) {
                    if (enemyData.loot && enemyData.loot.length > 0) {
                        generateSingleLoot(enemyData.loot);
                        lootHtml += `<div style="color: #9c27b0;">üéí Sbƒõraƒç≈Øv bonus loot!</div>`;
                    }
                }
                
                // Bonus pen√≠ze v≈ædy
                totalMoney += Math.floor(Math.random() * 20) + 10;
            }
            
            if (totalMoney > 0) {
                addMoney(totalMoney);
                lootHtml += `<div style="color: #ffd700;">üí∞ +${totalMoney} penƒõz</div>`;
            }
            
            // Check for level up
            const levelUpInfo = getPendingLevelUp();
            let levelUpHtml = '';
            if (levelUpInfo) {
                levelUpHtml = `
                    <div style="background: linear-gradient(135deg, #1a3a1a, #2a4a2a); padding: 0.5rem 0.8rem; border-radius: 6px; margin: 0.3rem 0; border: 1px solid #4caf50; display: inline-block;">
                        <span style="color: #ffd700; font-weight: bold;">üéâ LEVEL ${levelUpInfo.level}!</span>
                        <span style="font-size: 0.75rem; color: #8bc34a; margin-left: 0.5rem;">+1 atribut, +1 skill</span>
                    </div>
                `;
            }
            
            // Handle special combat types
            let continueAction = "window.combatState = null; closeModal(); checkAchievements(); renderFull();";
            let specialRewardHtml = '';
            
            // Oznaƒç lokaci jako vyƒçi≈°tƒõnou pokud to byl raid
            if (window.currentRaidLocation) {
                state.clearedLocations = state.clearedLocations || [];
                if (!state.clearedLocations.includes(window.currentRaidLocation)) {
                    state.clearedLocations.push(window.currentRaidLocation);
                    
                    // Speci√°ln√≠ zpr√°va pro slave_camp
                    if (window.currentRaidLocation === 'slave_camp') {
                        specialRewardHtml += `
                            <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid #4caf50;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">‚õìÔ∏è T√°bor vyƒçi≈°tƒõn!</h4>
                                <p style="color: #888; margin: 0; font-size: 0.85rem;">Nyn√≠ m≈Ø≈æe≈° osvobodit zajatce!</p>
                            </div>
                        `;
                    }
                }
                window.currentRaidLocation = null;
            }
            
            if (cs.combatType === 'settlement_raid') {
                handleRaidVictory();
                // Add raid bonus to display
                const waveIndex = window.raidWaveIndex || 0;
                const wave = RAID_WAVES ? RAID_WAVES[waveIndex] : null;
                if (wave?.reward) {
                    specialRewardHtml = `
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid #4caf50;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üõ°Ô∏è Bonus za obranu osady:</h4>
                            <div style="color: #ffd700;">üí∞ +${wave.reward.money || 0} penƒõz</div>
                            <div style="color: #ffd700;">‚≠ê +${wave.reward.xp || 0} XP</div>
                        </div>
                    `;
                }
            } else if (cs.combatType === 'dungeon') {
                continueAction = "handleDungeonVictory();";
            } else if (cs.combatType === 'abyss') {
                continueAction = "handleAbyssVictory();";
            }
            
            // Show victory screen
            const killHumor = '"' + enemyData.name + ' ' + getRandomHumor('kill') + '"';
            
            // P≈ôidej do hern√≠ho den√≠ku
            addLog(`‚öîÔ∏è V√≠tƒõzstv√≠! Porazil jsi ${enemyCount}x ${enemyData.name} (+${xpGain} XP${totalMoney > 0 ? ', +' + totalMoney + ' üí∞' : ''})`, '‚öîÔ∏è');
            
            // Check achievements se vol√° a≈æ po zav≈ôen√≠ v√≠tƒõzn√©ho modalu (v continueAction)
            
            // === TECHNIK AUTO-REPAIR ===
            const companionBonuses = getAllCompanionBonuses();
            let repairHtml = '';
            if (companionBonuses.autoRepair) {
                // Oprav vybaven√≠ po boji
                let repaired = [];
                if (state.equipped?.weapon?.durability !== undefined && state.equipped.weapon.durability < state.equipped.weapon.maxDurability) {
                    const repairAmount = Math.min(10, state.equipped.weapon.maxDurability - state.equipped.weapon.durability);
                    state.equipped.weapon.durability += repairAmount;
                    repaired.push(`‚öîÔ∏è Zbra≈à +${repairAmount}`);
                }
                if (state.equipped?.armor?.durability !== undefined && state.equipped.armor.durability < state.equipped.armor.maxDurability) {
                    const repairAmount = Math.min(10, state.equipped.armor.maxDurability - state.equipped.armor.durability);
                    state.equipped.armor.durability += repairAmount;
                    repaired.push(`üõ°Ô∏è Zbroj +${repairAmount}`);
                }
                if (repaired.length > 0) {
                    repairHtml = `<div style="color: #ff9800; font-size: 0.8rem; margin-top: 0.3rem;">üîß Technik opravil: ${repaired.join(', ')}</div>`;
                }
            }
            
            showModal('üèÜ V√çTƒöZSTV√ç!', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.3rem;">üèÜ</div>
                    <h2 style="color: #8bc34a; margin: 0; font-size: 1.3rem;">V√çTƒöZSTV√ç!</h2>
                    <p style="color: #666; font-style: italic; font-size: 0.75rem; margin: 0.2rem 0;">${killHumor}</p>
                    <p style="color: #ffd700; font-size: 1rem; margin: 0.3rem 0;">+${xpGain} XP</p>
                    
                    ${lootHtml ? `
                        <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 8px; margin: 0.5rem 0; text-align: left; max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            <h4 style="margin: 0 0 0.3rem 0; color: #ff9800; font-size: 0.9rem;">üéí Ko≈ôist:</h4>
                            ${lootHtml}
                        </div>
                    ` : ''}
                    
                    ${levelUpHtml}
                    ${specialRewardHtml}
                    ${repairHtml}
                    
                    <p style="color: #555; font-size: 0.75rem; margin-top: 0.3rem;">Zabito: ${enemyCount}</p>
                </div>
                <button class="btn" onclick="${continueAction}" style="width: 100%; margin-top: 0.5rem; background: var(--toxic-green);">‚úì Pokraƒçovat</button>
            `);
            
            SoundSystem.play('victory');
            // combatState se ƒçist√≠ a≈æ v continueAction
        }
        
        // handleCombatDefeat je definov√°na v√Ω≈°e (≈ô√°dek ~39292)
        
        // === SKILL BONUS FUNKCE ===
        function getPlayerSkillBonus(skillId) {
            const level = state.skills?.[skillId] || 0;
            if (level === 0) return 0;
            const skill = SKILLS.find(s => s.id === skillId);
            return skill ? skill.value * level : 0;
        }
        
        function calculateMaxHp() {
            let maxHp = 100; // Z√°klad
            
            // END bonus (+5 HP per point above 5)
            maxHp += (state.char.attrs.end - 5) * 5;
            
            // Tough skill (+20 HP per level)
            const toughBonus = getPlayerSkillBonus('tough');
            if (toughBonus > 0) maxHp += toughBonus;
            
            // Class bonus
            if (state.char.classId === 'tank') maxHp += 50;
            if (state.char.classId === 'mutant') maxHp += 30;
            
            // Level bonus (+2 HP per level)
            maxHp += (state.char.level - 1) * 2;
            
            return maxHp;
        }
        
        function getScavengerBonus() {
            // Scavenger skill (+15% loot chance per level)
            return getPlayerSkillBonus('scavenger');
        }
        
        function getEfficiencyBonus() {
            // Efficient skill (+25% XP per level)
            return getPlayerSkillBonus('efficient');
        }
        
        function getLuckyBonus() {
            // Lucky skill (+10% loot quality per level)
            return getPlayerSkillBonus('lucky');
        }
        
        function calculateDamage() {
            // Base damage + STR bonus (+2 per point above 5)
            let baseDmg = 5 + getAttrBonus('str');
            
            // Weapon damage
            const weapon = state.equipped?.weapon || null;
            if (weapon) {
                baseDmg += weapon.damage;
            } else if (state.char.class === 'mutant') {
                // Mutant m√° v≈ædy dr√°py jako z√°lo≈æn√≠ zbra≈à (+20 DMG)
                baseDmg += 20;
            }
            
            // Raider class bonus (+30%)
            if (state.char.classId === 'raider') baseDmg = Math.floor(baseDmg * 1.3);
            
            // Berserker class bonus (+50% dmg, but we handle defense reduction elsewhere)
            if (state.char.classId === 'berserker') baseDmg = Math.floor(baseDmg * 1.5);
            
            // Mutant class bonus (+20% v radioaktivn√≠ch z√≥n√°ch)
            if (state.char.class === 'mutant') {
                const loc = WORLD_LOCATIONS.find(l => l.id === state.world.currentLocation);
                if (loc?.radiation && loc.radiation > 0) {
                    baseDmg = Math.floor(baseDmg * 1.2);
                }
            }
            
            // Skill tree damage bonus
            baseDmg = Math.floor(baseDmg * (1 + getSkillTreeBonus('damageBonus')));
            
            // üåô Noƒçn√≠ bonus pro hr√°ƒçe - assassin class
            const dayPhase = getCurrentDayPhase();
            if (dayPhase.id === 'night' && state.char.classId === 'assassin') {
                baseDmg = Math.floor(baseDmg * 1.2); // +20% v noci pro assassiny
            }
            
            // üåßÔ∏è Poƒças√≠ efekty - pou≈æij weather.effect.playerDmgMod
            const weather = getCurrentWeather();
            if (weather?.effect?.playerDmgMod) {
                baseDmg = Math.floor(baseDmg * weather.effect.playerDmgMod);
            }
            
            // üèóÔ∏è Bonus z budov (Zbrojnice +10%, Kov√°rna +5 DMG)
            if (state.map.inBase) {
                const bonuses = getBuildingBonuses();
                if (bonuses.damageBonus > 0) {
                    baseDmg = Math.floor(baseDmg * (1 + bonuses.damageBonus / 100));
                }
                if (bonuses.weaponBonus > 0) {
                    baseDmg += bonuses.weaponBonus;
                }
            }
            
            // üõ°Ô∏è Armor special efekty (berserker, exo, intimidate)
            const armorEffects = getArmorSpecialEffects();
            if (armorEffects.bonusDamage > 0) {
                baseDmg += armorEffects.bonusDamage;
            }
            
            // Exoskelet +10% damage multiplik√°tor
            if (armorEffects.damageMultiplier > 1.0) {
                baseDmg = Math.floor(baseDmg * armorEffects.damageMultiplier);
            }
            
            // üåô Noƒçn√≠ bonus z armor (night_stalker)
            if (dayPhase.id === 'night' && armorEffects.nightBonus) {
                baseDmg = Math.floor(baseDmg * 1.15); // +15% v noci
            }
            
            // üß¨ Mutace - berserker_blood (+25% damage)
            if (state.mutations?.includes('berserker_blood')) {
                baseDmg = Math.floor(baseDmg * 1.25);
            }
            
            // üéñÔ∏è Vojensk√Ω tr√©nink - combat bonus (permanentn√≠, stackuje se)
            if (state.trainingBonuses?.combat > 0) {
                baseDmg = Math.floor(baseDmg * (1 + state.trainingBonuses.combat));
            }
            
            // üéñÔ∏è Military frakce - tactical bonus (+5% damage jako Spojenec)
            const factionBonuses = getFactionBonuses();
            if (factionBonuses.tacticalBonus > 0) {
                baseDmg = Math.floor(baseDmg * (1 + factionBonuses.tacticalBonus));
            }
            
            // üíé Exotic bonus - Krystal pr√°zdnoty (+10% damage)
            if (state.exoticBonuses?.damageBoost > 0) {
                baseDmg = Math.floor(baseDmg * (1 + state.exoticBonuses.damageBoost));
            }
            
            // üî¥ Frakƒçn√≠ bonus - Koryho n√°sledovn√≠ci (+5% damage)
            const pvpFactionBonus = getFactionBonus();
            if (pvpFactionBonus.damage > 0) {
                baseDmg = Math.floor(baseDmg * (1 + pvpFactionBonus.damage));
            }
            
            // üîß Technik companion - vƒõ≈æiƒçka bonus
            const companionBonuses = getAllCompanionBonuses();
            if (companionBonuses.turretDamage > 0) {
                baseDmg += companionBonuses.turretDamage;
            }
            
            return Math.max(1, Math.floor(baseDmg));
        }
        
        function calculateDefense() {
            let defense = Math.floor(state.char.attrs.end * 1); // END bonus
            
            // Armor defense
            const armor = state.equipped?.armor;
            if (armor && armor.defense) defense += armor.defense;
            
            // Helmet defense
            const helmet = state.equipped?.helmet;
            if (helmet && helmet.defense) defense += helmet.defense;
            
            // Gloves defense
            const gloves = state.equipped?.gloves;
            if (gloves && gloves.defense) defense += gloves.defense;
            
            // Boots defense
            const boots = state.equipped?.boots;
            if (boots && boots.defense) defense += boots.defense;
            
            // Armor special efekty
            const armorEffects = getArmorSpecialEffects();
            defense += armorEffects.bonusDefense;
            
            // Skill tree bonus
            defense += getSkillTreeBonus('defense');
            
            // Mutant p≈ôirozen√° obrana +10
            if (state.char.classId === 'mutant') defense += 10;
            
            // Bonusy z mutac√≠ (nap≈ô. Tlust√° k≈Ø≈æe +8 DEF)
            const mutBonuses = getMutationBonuses();
            defense += mutBonuses.defense || 0;
            
            // Class bonuses
            if (state.char.classId === 'tank') defense = Math.floor(defense * 1.3);
            if (state.char.classId === 'berserker') defense = Math.floor(defense * 0.7);
            
            // üéñÔ∏è Vojensk√Ω tr√©nink - defense bonus (permanentn√≠, stackuje se)
            if (state.trainingBonuses?.defense > 0) {
                defense = Math.floor(defense * (1 + state.trainingBonuses.defense));
            }
            
            return Math.max(0, defense);
        }
        
        function calculateCritChance() {
            let crit = 0.05; // Base 5%
            
            // PER bonus (+3% per point above 5)
            crit += (state.char.attrs.per - 5) * 0.03;
            
            // LCK bonus (+2% per point above 5)
            crit += (state.char.attrs.lck - 5) * 0.02;
            
            // Assassin class bonus (+40%)
            const assassinCrit = getClassPassiveValue('critBonus');
            if (assassinCrit) crit += assassinCrit;
            
            // Skill tree bonus
            crit += getSkillTreeBonus('critChance');
            
            // Armor/boots special effects (combat_boots +5%)
            const armorEffects = getArmorSpecialEffects();
            if (armorEffects.critBonus > 0) {
                crit += armorEffects.critBonus;
            }
            
            return Math.min(0.75, crit); // Max 75%
        }
        
        function calculateDodgeChance() {
            let dodge = 0.02; // Base 2%
            
            // AGI bonus (+2% per point above 5)
            dodge += (state.char.attrs.agi - 5) * 0.02;
            
            // Companion skills dodge bonus
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.dodgeChance > 0) {
                dodge += compBonuses.dodgeChance;
            }
            
            // Bonusy z mutac√≠ (nap≈ô. ≈†est√Ω smysl +15% √∫hyb)
            const mutBonuses = getMutationBonuses();
            if (mutBonuses.dodgeChance > 0) {
                dodge += mutBonuses.dodgeChance;
            }
            
            // Armor special efekty
            const armorEffects = getArmorSpecialEffects();
            if (armorEffects.bonusDodge > 0) {
                dodge += armorEffects.bonusDodge;
            }
            
            return Math.min(0.50, dodge); // Max 50%
        }
        
        function calculateXPBonus() {
            let bonus = 1.0;
            
            // INT bonus (+10% per point above 5)
            bonus += (state.char.attrs.int - 5) * 0.10;
            
            // Accessory bonus (zlat√Ω amulet)
            if (state.equippedAccessory) {
                const acc = state.inv.find(i => i.id === state.equippedAccessory);
                if (acc?.bonus === 'xp') {
                    bonus += (acc.value || 0) / 100;
                }
            }
            
            // üèóÔ∏è Bonus z budov (Cviƒçi≈°tƒõ +10%)
            const bonuses = getBuildingBonuses();
            if (bonuses.xpBonus > 0) {
                bonus += bonuses.xpBonus;
            }
            
            return bonus;
        }
        
        function calculateLootBonus() {
            let bonus = 1.0;
            
            // PER bonus (+5% per point above 5)
            bonus += (state.char.attrs.per - 5) * 0.05;
            
            // Accessory bonus (st≈ô√≠brn√Ω prsten)
            if (state.equippedAccessory) {
                const acc = state.inv.find(i => i.id === state.equippedAccessory);
                if (acc?.bonus === 'luck') {
                    bonus += (acc.value || 0) / 100;
                }
            }
            
            // Companion skills loot bonus
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.lootChance > 0) {
                bonus += compBonuses.lootChance;
            }
            
            // Scavenger skill (+15% loot chance per level)
            const scavengerBonus = getScavengerBonus();
            if (scavengerBonus > 0) {
                bonus += scavengerBonus;
            }
            
            // ü™ô Exotic bonus - ≈†≈•astn√° mince (+15% loot)
            if (state.exoticBonuses?.luck > 0) {
                bonus += state.exoticBonuses.luck;
            }
            
            // üü¢ Frakƒçn√≠ bonus - Nez√°visl√≠ (+5% loot)
            const pvpFactionBonus = getFactionBonus();
            if (pvpFactionBonus.loot > 0) {
                bonus += pvpFactionBonus.loot;
            }
            
            // LCK bonus for rare loot (+3% per point above 5)
            // This is handled separately in loot rolls
            
            return bonus;
        }
        
        function calculateLootQuality() {
            let quality = 1.0;
            
            // LCK bonus (+3% per point above 5)
            quality += (state.char.attrs.lck - 5) * 0.03;
            
            // Lucky skill (+10% loot quality per level)
            const luckyBonus = getLuckyBonus();
            if (luckyBonus > 0) {
                quality += luckyBonus;
            }
            
            return quality;
        }
        
        function calculateCritBonus() {
            let bonus = 0.1; // Z√°kladn√≠ 10% ≈°ance na krit
            
            // AGI bonus
            bonus += (state.char.attrs.agi - 5) * 0.02;
            
            // Accessory bonus (krystalov√Ω fokus)
            if (state.equippedAccessory) {
                const acc = state.inv.find(i => i.id === state.equippedAccessory);
                if (acc?.bonus === 'crit') {
                    bonus += (acc.value || 0) / 100;
                }
            }
            
            // Companion skills crit bonus
            const compBonuses = getAllCompanionBonuses();
            if (compBonuses.critChance > 0) {
                bonus += compBonuses.critChance;
            }
            
            return Math.min(0.5, bonus); // Max 50%
        }
        
        // === PASIVN√ç SCHOPNOSTI POVOL√ÅN√ç ===
        const CLASS_PASSIVES = {
            // Bojov√©
            raider: {
                onAttack: (damage) => {
                    // Rage: Pod 30% HP +50% damage
                    if (state.char.hp / state.char.maxHp < 0.3) {
                        return { damage: Math.floor(damage * 1.5), message: 'üò§ RAGE! +50% damage!' };
                    }
                    return { damage };
                }
            },
            berserker: {
                onKill: () => {
                    // Frenzy: Ka≈æd√Ω kill +8% damage (max 5 stack≈Ø, 45s)
                    state.buffs = state.buffs || [];
                    const frenzyStacks = state.buffs.filter(b => b.id === 'frenzy' && b.expires > Date.now()).length;
                    if (frenzyStacks < 5) { // Max 5 stack≈Ø (nerfed from 10)
                        state.buffs.push({ id: 'frenzy', value: 0.08, expires: Date.now() + 45000 }); // 45s (nerfed from 60s)
                    }
                    return { message: `üî• FRENZY! (+${Math.round((frenzyStacks + 1) * 8)}% damage)` };
                },
                onAttack: (damage) => {
                    const frenzyStacks = (state.buffs || []).filter(b => b.id === 'frenzy' && b.expires > Date.now()).length;
                    if (frenzyStacks > 0) {
                        return { damage: Math.floor(damage * (1 + frenzyStacks * 0.08)) };
                    }
                    return { damage };
                }
            },
            
            // Obrann√©
            survivor: {
                onDamage: (damage) => {
                    // Last Stand: 20% ≈°ance p≈ôe≈æ√≠t smrteln√Ω √∫der s 1 HP (nerfed from 25%)
                    if (state.char.hp - damage <= 0 && Math.random() < 0.20) {
                        return { damage: state.char.hp - 1, message: 'üí™ LAST STAND! P≈ôe≈æil jsi s 1 HP!' };
                    }
                    return { damage };
                }
            },
            tank: {
                onDamage: (damage) => {
                    // Fortress: Blokuje 25% p≈ô√≠choz√≠ho damage (nerfed from 30%)
                    const reduced = Math.floor(damage * 0.75);
                    return { damage: reduced, message: `üè∞ Blokov√°no ${damage - reduced} damage` };
                }
            },
            
            // Skautsk√©
            stalker: {
                onAmbush: () => {
                    // Stealth: 50% ≈°ance vyhnout se p≈ôepaden√≠
                    if (Math.random() < 0.5) {
                        return { avoid: true, message: 'üë§ Vyklouzl jsi nepozorovanƒõ!' };
                    }
                    return { avoid: false };
                }
            },
            assassin: {
                onAttack: (damage, isCrit) => {
                    // Execute: Kritick√Ω z√°sah dƒõl√° 3x damage (m√≠sto 2x)
                    if (isCrit) {
                        return { damage: Math.floor(damage * 1.5), message: 'üó°Ô∏è EXECUTE! 3x kritick√Ω damage!' };
                    }
                    return { damage };
                },
                critBonus: 0.4 // +40% crit chance
            },
            
            // Podp≈Ørn√©
            medic: {
                onTick: () => {
                    // Regeneration: +2 HP za minutu
                    if (state.char.hp < state.char.maxHp) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + 2);
                        return { message: 'üíö +2 HP (regenerace)' };
                    }
                    return {};
                }
            },
            alchemist: {
                onAttack: (damage) => {
                    // Poison: √ötoky zp≈Øsobuj√≠ otravu (5 DOT)
                    window.enemyPoison = (window.enemyPoison || 0) + 5;
                    return { damage, message: '‚ò†Ô∏è Jed aplikov√°n! (+5 DOT)' };
                }
            },
            
            // Sbƒõraƒçsk√©
            scavenger: {
                onLoot: (items) => {
                    // Lucky Find: 10% ≈°ance na dvojit√Ω loot
                    if (Math.random() < 0.1) {
                        return { multiplier: 2, message: 'üçÄ LUCKY FIND! Dvojit√Ω loot!' };
                    }
                    return { multiplier: 1 };
                }
            },
            hunter: {
                animalLootBonus: 2.0 // +100% loot ze zv√≠≈ôat
            },
            
            // Technick√©
            engineer: {
                noDurabilityLoss: true, // Zbranƒõ a zbroje se neniƒç√≠
                craftCostReduction: 0.5 // -50% surovin na crafting
            },
            demolitionist: {
                onAttack: (damage) => {
                    // Boom: 15% ≈°ance na AoE damage p≈ôi √∫toku
                    if (Math.random() < 0.15) {
                        return { damage, aoe: true, message: 'üí• BOOM! AoE damage!' };
                    }
                    return { damage };
                }
            },
            
            // Speci√°ln√≠
            trader: {
                shopDiscount: 0.3, // -30% ceny v obchodech
                sellBonus: 0.5 // +50% ceny p≈ôi prodeji
            },
            nomad: {
                travelSpeedBonus: 0.05, // -5% ƒças cestov√°n√≠
                consumptionReduction: 0.5 // -50% hlad/≈æ√≠ze≈à
            },
            mutant: {
                radiationImmune: true,
                onRadiation: (amount) => {
                    // Radiace tƒõ l√©ƒç√≠ (+1 HP za 10 rad)
                    const healing = Math.floor(amount / 10);
                    if (healing > 0) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + healing);
                        return { immune: true, message: `‚ò¢Ô∏è Radiace tƒõ l√©ƒç√≠! +${healing} HP` };
                    }
                    return { immune: true };
                }
            },
            psychic: {
                onCombatStart: () => {
                    // Mind Control: 10% ≈°ance ≈æe nep≈ô√≠tel uteƒçe
                    if (Math.random() < 0.1) {
                        return { flee: true, message: 'üîÆ MIND CONTROL! Nep≈ô√≠tel utekl!' };
                    }
                    return { flee: false };
                },
                revealHiddenLocations: true
            }
        };
        
        function triggerClassPassive(event, ...args) {
            const classId = state.char.classId;
            const passive = CLASS_PASSIVES[classId];
            if (!passive) return null;
            
            if (event === 'onAttack' && passive.onAttack) {
                return passive.onAttack(...args);
            }
            if (event === 'onDamage' && passive.onDamage) {
                return passive.onDamage(...args);
            }
            if (event === 'onKill' && passive.onKill) {
                return passive.onKill(...args);
            }
            if (event === 'onLoot' && passive.onLoot) {
                return passive.onLoot(...args);
            }
            if (event === 'onAmbush' && passive.onAmbush) {
                return passive.onAmbush(...args);
            }
            if (event === 'onCombatStart' && passive.onCombatStart) {
                return passive.onCombatStart(...args);
            }
            if (event === 'onRadiation' && passive.onRadiation) {
                return passive.onRadiation(...args);
            }
            
            return null;
        }
        
        function hasClassPassive(passiveKey) {
            const classId = state.char.classId;
            const passive = CLASS_PASSIVES[classId];
            return passive && passive[passiveKey];
        }
        
        function getClassPassiveValue(passiveKey) {
            const classId = state.char.classId;
            const passive = CLASS_PASSIVES[classId];
            return passive ? passive[passiveKey] : null;
        }

        function attack() {
            const cs = window.combatState;
            if (!cs || !cs.enemyGroup) return;
            
            const enemyGroup = cs.enemyGroup;
            const log = document.getElementById('combatLog');
            
            // Find first alive enemy
            const aliveEnemies = enemyGroup.filter(e => e.alive);
            if (aliveEnemies.length === 0) return;
            
            const targetEnemy = aliveEnemies[0];
            const enemyIndex = enemyGroup.indexOf(targetEnemy);
            
            // === KONTROLA MUNICE PRO RANGED ZBRANƒö ===
            const weapon = state.equipped?.weapon;
            if (weapon && weapon.ammoType) {
                const ammoCount = getAmmoCount(weapon.ammoType);
                if (ammoCount <= 0) {
                    log.innerHTML += `<div style="color: #f44336;">‚ùå Nem√°≈° munici (${getAmmoName(weapon.ammoType)})! Pou≈æij jinou zbra≈à nebo uteƒç!</div>`;
                    notifyWarning('≈Ω√°dn√° munice!', `Nem√°≈° ${getAmmoName(weapon.ammoType)} pro ${weapon.name}`);
                    return;
                }
                // Spot≈ôebuj 1 n√°boj/≈°√≠p
                consumeAmmo(weapon.ammoType, 1);
                log.innerHTML += `<div style="color: #888; font-size: 0.85rem;">üî∏ -1 ${getAmmoName(weapon.ammoType)} (zb√Ωv√°: ${ammoCount - 1})</div>`;
            }
            
            // Calculate base damage
            let playerDmg = calculateDamage() + Math.floor(Math.random() * 5);
            
            // Aplikuj combat debuff (√∫nava z cesty p≈ôi obranƒõ osady)
            if (state.combatDebuffs?.fatigue) {
                const fatigueReduction = Math.floor(playerDmg * Math.abs(state.combatDebuffs.fatigue.effect));
                playerDmg = Math.max(1, playerDmg - fatigueReduction);
                log.innerHTML += `<div style="color: #ff9800;">üòì √önava z cesty: -${fatigueReduction} DMG (-10%)</div>`;
                state.combatDebuffs.fatigue.fights--;
                if (state.combatDebuffs.fatigue.fights <= 0) {
                    delete state.combatDebuffs.fatigue;
                }
            }
            
            // Aplikuj weapon buff (ze Zlat√©ho povlaku apod.)
            if (state.weaponBuff && state.weaponBuff.fights > 0) {
                playerDmg += state.weaponBuff.damage;
                log.innerHTML += `<div style="color: #ffd700;">‚ú® Weapon buff: +${state.weaponBuff.damage} DMG (zb√Ωv√° ${state.weaponBuff.fights} boj≈Ø)</div>`;
                state.weaponBuff.fights--;
                if (state.weaponBuff.fights <= 0) {
                    state.weaponBuff = null;
                }
            }
            
            // Aplikuj all_stats buff
            if (state.buffs?.allStats && state.buffs.allStats.until > Date.now()) {
                const statBonus = Math.floor(state.buffs.allStats.value * 0.5); // Polovina hodnoty jako damage
                playerDmg += statBonus;
                log.innerHTML += `<div style="color: #ffd700;">‚ú® Elix√≠r s√≠ly: +${statBonus} DMG</div>`;
            }
            
            // Check for critical hit using new function
            const critChance = calculateCritChance();
            
            // Companion firstStrikeCrit - prvn√≠ √∫tok v boji je v≈ædy crit
            const compBonuses = getAllCompanionBonuses();
            const isFirstStrike = !window.combatState?.playerAttacked;
            const isCrit = (compBonuses.firstStrikeCrit && isFirstStrike) || Math.random() < critChance;
            
            // Oznaƒç ≈æe hr√°ƒç u≈æ √∫toƒçil
            if (window.combatState) window.combatState.playerAttacked = true;
            
            if (isCrit) {
                // Z√°kladn√≠ crit = 2x, + companion bonus
                const critMultiplier = 2 + (compBonuses.critDamage || 0);
                playerDmg = Math.floor(playerDmg * critMultiplier);
                const firstStrikeText = (compBonuses.firstStrikeCrit && isFirstStrike) ? ' (üêæ First Strike!)' : '';
                log.innerHTML += `<div style="color: #ffd700;">üí• KRITICK√ù Z√ÅSAH!${firstStrikeText} (${critMultiplier}x DMG)</div>`;
            }
            
            // Apply class passive onAttack
            const attackPassive = getClassPassive('onAttack', playerDmg, isCrit);
            if (attackPassive) {
                playerDmg = attackPassive.damage;
                if (attackPassive.message) {
                    log.innerHTML += `<div style="color: #ff9800;">${attackPassive.message}</div>`;
                }
                
                // AoE damage (Demolitionist)
                if (attackPassive.aoe) {
                    aliveEnemies.forEach((enemy, idx) => {
                        if (idx > 0) { // Skip primary target
                            const aoeDmg = Math.floor(playerDmg * 0.5);
                            enemy.hp -= aoeDmg;
                            log.innerHTML += `<div style="color: #ff9800;">üí• AoE: #${enemyGroup.indexOf(enemy)+1} -${aoeDmg} HP</div>`;
                        }
                    });
                }
            }
            
            // Apply poison DOT (Alchemist)
            if (window.enemyPoison && window.enemyPoison > 0) {
                targetEnemy.hp -= window.enemyPoison;
                log.innerHTML += `<div style="color: #9c27b0;">‚ò†Ô∏è Jed: -${window.enemyPoison} HP</div>`;
            }
            
            // Apply defense
            playerDmg = Math.max(1, playerDmg - targetEnemy.defense);
            targetEnemy.hp -= playerDmg;
            SoundSystem.play('combat_hit');
            
            // Degrade weapon durability (unless Engineer)
            if (!hasClassPassive('noDurabilityLoss')) {
                const weapon = state.equipped?.weapon;
                if (weapon && weapon.durability !== undefined) {
                    // Technik zpevnƒõn√≠ - men≈°√≠ opot≈ôeben√≠
                    const compBonuses = getAllCompanionBonuses();
                    let durabilityLoss = 2;
                    if (compBonuses.durabilityBonus > 0) {
                        // S durabilityBonus 0.05 je ≈°ance 5% ≈æe se zbra≈à neopot≈ôeb√≠
                        if (Math.random() < compBonuses.durabilityBonus) {
                            durabilityLoss = 0; // Technik zabr√°nil opot≈ôeben√≠
                        }
                    }
                    
                    if (durabilityLoss > 0) {
                        weapon.durability = Math.max(0, weapon.durability - durabilityLoss);
                        if (weapon.durability === 0) {
                            log.innerHTML += `<div style="color: #c62828;">üíî ${weapon.icon} ${weapon.name} se rozpadla!</div>`;
                            state.equipped.weapon = null;
                        } else if (weapon.durability <= 20) {
                            log.innerHTML += `<div style="color: #ff9800;">‚ö†Ô∏è ${weapon.name}: ${weapon.durability}/${weapon.maxDurability}</div>`;
                        }
                    }
                }
            }
            
            if (targetEnemy.defense > 0) {
                log.innerHTML += `<div style="color: #8bc34a;">‚öîÔ∏è Zas√°hl jsi #${enemyIndex+1} za ${playerDmg} DMG! (obrana -${targetEnemy.defense})</div>`;
            } else {
                log.innerHTML += `<div style="color: #8bc34a;">‚öîÔ∏è Zas√°hl jsi #${enemyIndex+1} za ${playerDmg} DMG!</div>`;
            }
            
            // Vizu√°ln√≠ efekt z√°sahu
            showFloatingNumber(playerDmg, isCrit ? 'crit' : 'damage');
            if (isCrit) screenShake(3, 100);
            
            // === √öTOK SPOLEƒåN√çK≈Æ ===
            if (state.companions && state.companions.length > 0) {
                state.companions.forEach(comp => {
                    if (comp.isDead) return; // Mrtv√Ω spoleƒçn√≠k ne√∫toƒç√≠
                    
                    const compInfo = COMPANIONS.find(c => c.id === comp.id);
                    if (!compInfo) return;
                    
                    // Najdi ≈æiv√©ho nep≈ô√≠tele
                    const aliveTarget = enemyGroup.find(e => e.alive);
                    if (!aliveTarget) return;
                    
                    // Pou≈æij getCompanionStat pro damage vƒçetnƒõ bonus≈Ø ze skill≈Ø a level≈Ø
                    const baseDmg = getCompanionStat(comp, 'damage');
                    let compDmg = baseDmg + Math.floor(Math.random() * 3);
                    
                    // Bonus za level (+5% damage za level nad 1)
                    const levelBonus = ((comp.level || 1) - 1) * 0.05;
                    compDmg = Math.floor(compDmg * (1 + levelBonus));
                    
                    // Kritick√Ω z√°sah spoleƒçn√≠ka (5% z√°kladn√≠ ≈°ance + bonus ze skill≈Ø)
                    const compCritChance = 0.05 + (getCompanionStat(comp, 'critChance') || 0);
                    const isCompCrit = Math.random() < compCritChance;
                    if (isCompCrit) {
                        compDmg = Math.floor(compDmg * 1.5);
                    }
                    
                    // Aplikuj obranu nep≈ô√≠tele
                    compDmg = Math.max(1, compDmg - aliveTarget.defense);
                    aliveTarget.hp -= compDmg;
                    
                    // XP pro spoleƒçn√≠ka za √∫tok
                    if (!comp.xp) comp.xp = 0;
                    comp.xp += 1;
                    
                    const critText = isCompCrit ? ' üí• KRIT!' : '';
                    log.innerHTML += `<div style="color: #9c27b0;">${compInfo.icon} ${escapeHtml(comp.name || compInfo.name)} √∫toƒç√≠ za ${compDmg} DMG!${critText}</div>`;
                    
                    // Aktualizuj zobrazen√≠ HP nep≈ô√≠tele
                    const targetIdx = enemyGroup.indexOf(aliveTarget);
                    const hpSpanComp = document.querySelectorAll('.enemyHp')[targetIdx];
                    if (hpSpanComp) hpSpanComp.textContent = Math.max(0, aliveTarget.hp);
                    const hpBarComp = document.querySelectorAll('.enemyHpBar')[targetIdx];
                    if (hpBarComp) hpBarComp.style.width = Math.max(0, (aliveTarget.hp/aliveTarget.maxHp)*100) + '%';
                    
                    // Zkontroluj jestli spoleƒçn√≠k zabil nep≈ô√≠tele
                    if (aliveTarget.hp <= 0) {
                        aliveTarget.alive = false;
                        log.innerHTML += `<div style="color: #ffd700;">üíÄ ${compInfo.name} zabil nep≈ô√≠tele!</div>`;
                        
                        // Aktualizuj UI pro mrtv√©ho nep≈ô√≠tele
                        const enemyRowComp = document.querySelectorAll('.enemyRow')[targetIdx];
                        if (enemyRowComp) {
                            enemyRowComp.style.opacity = '0.3';
                            const statusSpanComp = enemyRowComp.querySelector('.enemyStatus');
                            if (statusSpanComp) statusSpanComp.innerHTML = `üíÄ #${targetIdx+1}`;
                            const hpBarDeadComp = enemyRowComp.querySelector('.enemyHpBar');
                            if (hpBarDeadComp) hpBarDeadComp.style.background = '#333';
                        }
                    }
                });
            }
            
            // Update HP display
            const hpSpan = document.querySelectorAll('.enemyHp')[enemyIndex];
            if (hpSpan) hpSpan.textContent = Math.max(0, targetEnemy.hp);
            const hpBar = document.querySelectorAll('.enemyHpBar')[enemyIndex];
            if (hpBar) hpBar.style.width = Math.max(0, (targetEnemy.hp/targetEnemy.maxHp)*100) + '%';
            
            // Check if this enemy died
            if (targetEnemy.hp <= 0) {
                targetEnemy.alive = false;
                log.innerHTML += `<div style="color: #ffd700;">üíÄ Zabil jsi #${enemyIndex+1}!</div>`;
                
                // Aktualizuj UI pro mrtv√©ho nep≈ô√≠tele
                const enemyRow = document.querySelectorAll('.enemyRow')[enemyIndex];
                if (enemyRow) {
                    enemyRow.style.opacity = '0.3';
                    const statusSpan = enemyRow.querySelector('.enemyStatus');
                    if (statusSpan) statusSpan.innerHTML = `üíÄ #${enemyIndex+1}`;
                    const hpBarDead = enemyRow.querySelector('.enemyHpBar');
                    if (hpBarDead) hpBarDead.style.background = '#333';
                }
                
                // Apply class passive onKill (Berserker Frenzy)
                const killPassive = getClassPassive('onKill');
                if (killPassive && killPassive.message) {
                    log.innerHTML += `<div style="color: #ff9800;">${killPassive.message}</div>`;
                }
                
                // Check if all enemies dead
                const stillAlive = enemyGroup.filter(e => e.alive);
                if (stillAlive.length === 0) {
                    // Victory!
                    state.stats.kills += enemyGroup.length;
                    const xpGain = targetEnemy.xp * enemyGroup.length;
                    addXP(xpGain);
                    
                    // Zmƒõna reputace podle frakce nep≈ô√≠tele
                    if (targetEnemy.faction) {
                        // Zabit√≠ ƒçlena frakce zhor≈°√≠ vztahy s touto frakc√≠
                        changeReputation(targetEnemy.faction, -5 * enemyGroup.length, 'zabit√≠ ' + targetEnemy.name);
                        
                        // Zabit√≠ n√°jezdn√≠k≈Ø zlep≈°√≠ vztahy s obchodn√≠ky a vojensk√Ωm
                        if (targetEnemy.faction === 'raiders') {
                            changeReputation('traders', 2 * enemyGroup.length, 'ochrana obchodn√≠k≈Ø');
                            changeReputation('military', 1 * enemyGroup.length, 'eliminace hrozby');
                        }
                        // Zabit√≠ mutant≈Ø zlep≈°√≠ vztahy s vojensk√Ωm
                        if (targetEnemy.faction === 'mutants') {
                            changeReputation('military', 2 * enemyGroup.length, 'ƒçi≈°tƒõn√≠ pustiny');
                        }
                    }
                    
                    // V ar√©nƒõ ≈æ√°dn√Ω loot - jen XP
                    if (!state.inArena) {
                        // Loot from each enemy - seskup√≠me
                        const lootGathered = {};
                        const resourcesGathered = {};
                        
                        enemyGroup.forEach(() => {
                            if (Math.random() < targetEnemy.chance && targetEnemy.loot.length > 0) {
                                const lootId = targetEnemy.loot[Math.floor(Math.random() * targetEnemy.loot.length)];
                                if (lootId === 'money') {
                                    const moneyGain = Math.floor(Math.random() * 75) + 30; // Zv√Ω≈°eno o 50%
                                    addMoney(moneyGain);
                                    log.innerHTML += `<div style="color: #ffd700;">üí∞ Na≈°el jsi ${moneyGain} penƒõz!</div>`;
                                } else {
                                    const lootItem = ITEMS.find(i => i.id === lootId);
                                    if (lootItem) {
                                        // Pokud je to resource, p≈ôidej do resources
                                        if (lootItem.type === 'resource') {
                                            resourcesGathered[lootId] = (resourcesGathered[lootId] || 0) + 1;
                                        } else {
                                            // Jinak seskup do lootGathered
                                            lootGathered[lootId] = (lootGathered[lootId] || 0) + 1;
                                        }
                                    }
                                }
                            }
                        });
                        
                        // P≈ôidej resources do state.resources
                        for (const [id, amount] of Object.entries(resourcesGathered)) {
                            state.resources[id] = (state.resources[id] || 0) + amount;
                            const item = ITEMS.find(i => i.id === id);
                            log.innerHTML += `<div style="color: #ffd700;">üéÅ +${amount}x ${item?.icon || 'üì¶'} ${item?.name || id}</div>`;
                        }
                        
                        // P≈ôidej itemy do invent√°≈ôe - seskupen√©
                        for (const [id, amount] of Object.entries(lootGathered)) {
                            const lootItem = ITEMS.find(i => i.id === id);
                            if (lootItem && canAddItem(lootItem, amount)) {
                                if (lootItem.type === 'consumable') {
                                    const existing = state.inv.find(i => i.id === id);
                                    if (existing) {
                                        existing.count = (existing.count || 1) + amount;
                                    } else {
                                        state.inv.push({...lootItem, count: amount});
                                    }
                                } else {
                                    // Pro non-consumables p≈ôidej jednotlivƒõ
                                    for (let i = 0; i < amount; i++) {
                                        state.inv.push({...lootItem});
                                    }
                                }
                                log.innerHTML += `<div style="color: #ffd700;">üéÅ +${amount}x ${lootItem.icon} ${lootItem.name}</div>`;
                            }
                        }
                    }
                    
                    // Extra loot for village raids! (ne v ar√©nƒõ)
                    if (window.isVillageRaid && !state.inArena) {
                        log.innerHTML += `<div style="color: #9c27b0; font-weight: bold;">üíé VESNICE DOBYTA!</div>`;
                        
                        // Guaranteed good loot
                        const rareLoot = ITEMS.filter(i => (i.rarity === 'rare' || i.rarity === 'epic') && i.findChance > 0);
                        if (rareLoot.length > 0) {
                            const bonus = rareLoot[Math.floor(Math.random() * rareLoot.length)];
                            if (canAddItem(bonus, 1)) {
                                const existing = state.inv.find(i => i.id === bonus.id);
                                if (existing && bonus.type === 'consumable') {
                                    existing.count = (existing.count || 1) + 1;
                                } else {
                                    state.inv.push({...bonus, count: bonus.type === 'consumable' ? 1 : undefined});
                                }
                                log.innerHTML += `<div style="color: #9c27b0;">üíé Bonus: ${bonus.icon} ${bonus.name}!</div>`;
                            }
                        }
                        
                        // Extra money
                        const bonusMoney = Math.floor(Math.random() * 200) + 100;
                        addMoney(bonusMoney);
                        log.innerHTML += `<div style="color: #ffd700;">üí∞ Bonus: ${bonusMoney} penƒõz!</div>`;
                        
                        // Village raid completed
                        window.isVillageRaid = false;
                    }
                    
                    // Zkontroluj level up
                    const levelUpInfo = getPendingLevelUp();
                    let victoryText = `‚úì V√çTƒöZSTV√ç! +${xpGain} XP`;
                    if (levelUpInfo) {
                        victoryText += `<br><span style="color: #ffd700; font-size: 1.1em;">üéâ LEVEL ${levelUpInfo.level}!</span>`;
                        victoryText += `<br><span style="font-size: 0.85em;">+1 atribut | +1 skill | +1 strom</span>`;
                    }
                    
                    log.innerHTML += `<div style="color: #ffd700; font-weight: bold; margin-top: 0.5rem;">${victoryText}</div>`;
                    
                    // Companion bonusy po boji
                    const compBonuses = getAllCompanionBonuses();
                    
                    // MEDIC_NPC COMPANION - z√°kladn√≠ l√©ƒçen√≠ +5 HP po boji (bez skillu)
                    const hasMedicCompanion = state.companions?.some(c => c.id === 'medic_npc' && !c.isDead);
                    if (hasMedicCompanion) {
                        const medicComp = state.companions.find(c => c.id === 'medic_npc' && !c.isDead);
                        const medicLevel = medicComp?.level || 1;
                        const baseHeal = 5 + (medicLevel - 1) * 2; // +5 base, +2 per level
                        
                        // L√©ƒçen√≠ hr√°ƒçe
                        const oldHp = state.char.hp;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + baseHeal);
                        const healed = state.char.hp - oldHp;
                        
                        // L√©ƒçen√≠ radiace (1/3 z heal)
                        let radHealed = 0;
                        if (state.char.radiation > 0) {
                            const radHeal = Math.floor(baseHeal / 3);
                            const oldRad = state.char.radiation;
                            state.char.radiation = Math.max(0, state.char.radiation - radHeal);
                            radHealed = oldRad - state.char.radiation;
                        }
                        
                        // L√©ƒçen√≠ ostatn√≠ch companion≈Ø
                        state.companions?.forEach(comp => {
                            if (!comp.isDead && comp.id !== 'medic_npc') {
                                comp.hp = Math.min(comp.maxHp || 80, comp.hp + Math.floor(baseHeal / 2));
                                if (comp.radiation > 0) {
                                    comp.radiation = Math.max(0, comp.radiation - Math.floor(baseHeal / 4));
                                }
                            }
                        });
                        
                        if (healed > 0 || radHealed > 0) {
                            log.innerHTML += `<div style="color: #81c784;">üë®‚Äç‚öïÔ∏è Poln√≠ medik tƒõ o≈°et≈ôil: +${healed} HP${radHealed > 0 ? `, -${radHealed} ‚ò¢Ô∏è` : ''}</div>`;
                        }
                    }
                    
                    // healPlayerAfterCombat - l√©ƒçen√≠ hr√°ƒçe po boji (skill bonus)
                    if (compBonuses.healPlayerAfterCombat > 0) {
                        const healAmount = compBonuses.healPlayerAfterCombat;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + healAmount);
                        log.innerHTML += `<div style="color: #81c784;">üêæ Spoleƒçn√≠k tƒõ o≈°et≈ôil: +${healAmount} HP</div>`;
                    }
                    
                    // regenAfterCombat - regenerace spoleƒçn√≠k≈Ø
                    if (compBonuses.regenAfterCombat > 0 && state.companions) {
                        state.companions.forEach(comp => {
                            if (comp.hp !== undefined && comp.hp < (comp.maxHp || 80)) {
                                comp.hp = Math.min(comp.maxHp || 80, comp.hp + compBonuses.regenAfterCombat);
                            }
                        });
                        log.innerHTML += `<div style="color: #81c784;">üêæ Spoleƒçn√≠ci regeneruj√≠: +${compBonuses.regenAfterCombat} HP</div>`;
                    }
                    
                    // fetchLoot - extra loot od spoleƒçn√≠ka
                    if (compBonuses.fetchLoot && Math.random() < 0.5) {
                        const randomItem = ITEMS.filter(i => i.type === 'consumable' && i.findChance > 0.2)[Math.floor(Math.random() * 5)];
                        if (randomItem && canAddItem(randomItem, 1)) {
                            const existing = state.inv.find(i => i.id === randomItem.id);
                            if (existing) existing.count = (existing.count || 1) + 1;
                            else state.inv.push({...randomItem, count: 1});
                            log.innerHTML += `<div style="color: #81c784;">üêæ Spoleƒçn√≠k na≈°el: ${randomItem.icon} ${randomItem.name}!</div>`;
                        }
                    }
                    
                    document.getElementById('attackBtn').style.display = 'none';
                    
                    // P≈ôidej tlaƒç√≠tko OK
                    const okBtn = document.createElement('button');
                    okBtn.className = 'btn';
                    okBtn.style.cssText = 'width: 100%; margin-top: 1rem; background: var(--toxic-dark);';
                    okBtn.textContent = '‚úì Pokraƒçovat';
                    okBtn.onclick = function() {
                        closeModal();
                        if (state.world.resumeAfterCombat) {
                            state.world.resumeAfterCombat = false;
                            continueTravel();
                        }
                        renderFull();
                    };
                    document.getElementById('attackBtn').parentNode.appendChild(okBtn);
                    
                    addLog(`Boj vyhr√°n! Zabil jsi ${enemyGroup.length}x ${targetEnemy.name}`, '‚öîÔ∏è');
                    state.stats.kills += enemyGroup.length;
                    if (state.dailyQuests.progress) {
                        state.dailyQuests.progress.kills = (state.dailyQuests.progress.kills || 0) + enemyGroup.length;
                        checkDailyQuests();
                    }
                    checkAchievements();
                    
                    // Kontrola pomoci p≈ôe≈æiv≈°√≠mu
                    if (state.helpingSurvivor) {
                        state.helpingSurvivor = false;
                        const reward = Math.floor(Math.random() * 100) + 50;
                        addMoney(reward);
                        setTimeout(() => {
                            showModal('üéâ P≈ôe≈æiv≈°√≠ zachr√°nƒõn!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem;">üôè</div>
                                    <p>P≈ôe≈æiv≈°√≠ ti dƒõkuje za z√°chranu!</p>
                                    <p style="color: #ffd700; font-size: 1.2rem;">+${reward} üí∞</p>
                                </div>
                                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                            `);
                        }, 1500);
                        return;
                    }
                    
                    setTimeout(() => {
                        closeModal();
                        // Pokud byl boj bƒõhem cestov√°n√≠, pokraƒçuj v cestƒõ
                        if (state.world.resumeAfterCombat) {
                            state.world.resumeAfterCombat = false;
                            continueTravel();
                        }
                        renderFull();
                    }, 2000);
                    return;
                }
            }
            
            // Alive enemies attack
            const attackingEnemies = enemyGroup.filter(e => e.alive);
            attackingEnemies.forEach((enemy) => {
                const enemyNum = enemyGroup.indexOf(enemy) + 1;
                
                // 30% ≈°ance ≈æe nep≈ô√≠tel za√∫toƒç√≠ na spoleƒçn√≠ka m√≠sto na hr√°ƒçe
                const aliveCompanions = state.companions?.filter(c => !c.isDead) || [];
                if (aliveCompanions.length > 0 && Math.random() < 0.3) {
                    const targetComp = aliveCompanions[Math.floor(Math.random() * aliveCompanions.length)];
                    const compInfo = COMPANIONS.find(c => c.id === targetComp.id);
                    
                    // Pou≈æij getCompanionStat pro defense vƒçetnƒõ bonus≈Ø
                    const compDefense = getCompanionStat(targetComp, 'defense');
                    let compDmgTaken = enemy.damage + Math.floor(Math.random() * 3);
                    compDmgTaken = Math.max(1, compDmgTaken - compDefense);
                    
                    // ≈†ance na uhnut√≠ spoleƒçn√≠ka (5% + bonus ze skill≈Ø)
                    const compDodge = 0.05 + (getCompanionStat(targetComp, 'dodgeChance') || 0);
                    if (Math.random() < compDodge) {
                        log.innerHTML += `<div style="color: #4caf50;">‚ö° ${compInfo?.icon || 'üë§'} ${targetComp.name || compInfo?.name} uhnul √∫toku!</div>`;
                        return;
                    }
                    
                    targetComp.hp -= compDmgTaken;
                    log.innerHTML += `<div style="color: #ff9800;">üí• #${enemyNum} zas√°hl ${compInfo?.icon || 'üë§'} ${targetComp.name || compInfo?.name} za ${compDmgTaken} DMG!</div>`;
                    
                    // Spoleƒçn√≠k zem≈ôel
                    if (targetComp.hp <= 0) {
                        targetComp.hp = 0;
                        targetComp.isDead = true;
                        const deadName = targetComp.name || compInfo?.name || 'Spoleƒçn√≠k';
                        log.innerHTML += `<div style="color: #c62828; font-weight: bold;">üíÄ ${deadName} padl v boji!</div>`;
                        addLog(`üíÄ ${deadName} zem≈ôel!`, '‚ò†Ô∏è');
                    }
                    return; // Tento nep≈ô√≠tel √∫toƒçil na spoleƒçn√≠ka
                }
                
                // Check for dodge (AGI based)
                const dodgeChance = calculateDodgeChance();
                if (Math.random() < dodgeChance) {
                    log.innerHTML += `<div style="color: #4caf50;">‚ö° Uhnul jsi √∫toku #${enemyNum}! (${Math.round(dodgeChance * 100)}% ≈°ance)</div>`;
                    return; // Skip this enemy's attack
                }
                
                let enemyDmg = enemy.damage + Math.floor(Math.random() * 5);
                
                // Defense reduction - pou≈æij NASAZEN√â brnƒõn√≠
                const armor = state.equipped?.armor;
                let totalDefense = 0;
                
                if (armor && armor.defense) {
                    totalDefense += armor.defense;
                }
                
                // END bonus to defense (+1 per point above 5)
                const endDefense = Math.max(0, Math.floor((state.char.attrs.end - 5) * 1));
                totalDefense += endDefense;
                
                // Skill tree defense bonus
                totalDefense += getSkillTreeBonus('defense');
                
                // Aplikuj celkovou obranu
                enemyDmg = Math.max(1, enemyDmg - totalDefense);
                
                // Apply class passive onDamage
                const damagePassive = getClassPassive('onDamage', enemyDmg);
                if (damagePassive) {
                    enemyDmg = damagePassive.damage;
                    if (damagePassive.message) {
                        log.innerHTML += `<div style="color: #4caf50;">${damagePassive.message}</div>`;
                    }
                }
                
                state.char.hp -= enemyDmg;
                log.innerHTML += `<div style="color: #c62828;">üí• #${enemyNum} tƒõ zas√°hl za ${enemyDmg} DMG!${totalDefense > 0 ? ` (üõ°Ô∏è-${totalDefense})` : ''}</div>`;
                SoundSystem.play('combat_hit');
                
                // Screen shake when player takes damage
                screenShake(enemyDmg > 15 ? 8 : 5, 200);
            });
            
            document.getElementById('playerHp').textContent = Math.max(0, Math.round(state.char.hp));
            
            if (state.char.hp <= 0) {
                // Last Stand check (Survivor) - already applied in onDamage, but double check
                const lastStandPassive = getClassPassive('onDamage', 0);
                if (lastStandPassive && state.char.hp <= 0 && Math.random() < 0.25) {
                    state.char.hp = 1;
                    log.innerHTML += `<div style="color: #ffd700;">üí™ LAST STAND! P≈ôe≈æil jsi s 1 HP!</div>`;
                    document.getElementById('playerHp').textContent = 1;
                    return;
                }
                
                // Companion surviveChance (p≈ôe≈æ√≠t smrteln√Ω √∫tok)
                const compBonuses = getAllCompanionBonuses();
                if (compBonuses.surviveChance > 0 && Math.random() < compBonuses.surviveChance) {
                    state.char.hp = 1;
                    log.innerHTML += `<div style="color: #81c784;">üêæ Tv≈Øj spoleƒçn√≠k tƒõ zachr√°nil! P≈ôe≈æil jsi s 1 HP!</div>`;
                    document.getElementById('playerHp').textContent = 1;
                    return;
                }
                
                // Companion resurrectChance (vzk≈ô√≠≈°en√≠ po smrti)
                if (compBonuses.resurrectChance > 0 && Math.random() < compBonuses.resurrectChance) {
                    state.char.hp = Math.floor(state.char.maxHp * 0.3);
                    log.innerHTML += `<div style="color: #ffd700;">‚ú® Tv≈Øj spoleƒçn√≠k tƒõ vzk≈ô√≠sil! HP obnoveno na 30%!</div>`;
                    document.getElementById('playerHp').textContent = state.char.hp;
                    return;
                }
                
                // Defeat
                log.innerHTML += `<div style="color: #c62828; font-weight: bold; margin-top: 0.5rem;">üíÄ PROHR√ÅL JSI!</div>`;
                document.getElementById('attackBtn').disabled = true;
                state.stats.deaths++;
                SoundSystem.play('death');
                const deathText = 'Zem≈ôel jsi v boji!';
                const restartText = 'Restart hry';
                setTimeout(() => {
                    showModal('üíÄ ' + t('death', 'youDied'), deathText + '<br><br><button class="btn" onclick="location.reload()" style="width: 100%;">' + restartText + '</button>');
                }, 1500);
            }
            
            log.scrollTop = log.scrollHeight;
        }
        
        function flee() {
            const fleeSuccessTitle = '√ötƒõk';
            const fleeSuccessText = 'Poda≈ôilo se ti ut√©ct!';
            const fleeFailTitle = '√ötƒõk selhal!';
            
            if (Math.random() < 0.7) {
                showModal(fleeSuccessTitle, fleeSuccessText);
            } else {
                const enemy = window.currentEnemy;
                const dmg = Math.floor(enemy.data.damage * 0.5);
                state.char.hp -= dmg;
                const fleeFailText = `Nep≈ô√≠tel tƒõ zas√°hl za ${dmg} DMG p≈ôi √∫tƒõku!`;
                showModal(fleeFailTitle, fleeFailText);
                if (state.char.hp <= 0) {
                    const deathFleeText = 'Zem≈ôel jsi p≈ôi √∫tƒõku!';
                    const restartText = 'Restart hry';
                    setTimeout(() => {
                        showModal('üíÄ ' + t('death', 'youDied'), deathFleeText + '<br><br><button class="btn" onclick="location.reload()" style="width: 100%;">' + restartText + '</button>');
                    }, 1000);
                }
            }
            renderFull();
        }
        
        // === ACHIEVEMENTS ===
        function checkAchievements() {
            ACHIEVEMENTS.forEach(ach => {
                if (!state.achievements.includes(ach.id) && ach.check()) {
                    state.achievements.push(ach.id);
                    
                    // Zjisti jestli je otev≈ôen√Ω nƒõjak√Ω modal (obchod, dialog...)
                    const modalOpen = document.getElementById('modal')?.style.display !== 'none';
                    
                    if (isInCombat() || modalOpen) {
                        // Bƒõhem boje nebo obchodu ulo≈æ pro pozdƒõj≈°√≠ zobrazen√≠
                        if (!state._pendingAchievements) state._pendingAchievements = [];
                        state._pendingAchievements.push(ach);
                        addLog(`üèÜ Achievement: ${ach.name}`, 'üèÜ');
                    } else {
                        showModal('üèÜ ACHIEVEMENT!', `<div style="text-align: center;"><div style="font-size: 4rem;">${ach.icon}</div><h3>${ach.name}</h3><p>${ach.desc}</p></div>`);
                    }
                }
            });
            
            // Zobraz odlo≈æen√© achievementy kdy≈æ nen√≠ modal
            const modalOpen = document.getElementById('modal')?.style.display !== 'none';
            if (!modalOpen && !isInCombat() && state._pendingAchievements?.length > 0) {
                const ach = state._pendingAchievements.shift();
                showModal('üèÜ ACHIEVEMENT!', `<div style="text-align: center;"><div style="font-size: 4rem;">${ach.icon}</div><h3>${ach.name}</h3><p>${ach.desc}</p></div>`);
            }
        }
        
        // === SAVE/LOAD ===
        // Maxim√°ln√≠ bezpeƒçn√© hodnoty
        const MAX_MONEY = 999999999; // 999M
        const MAX_XP = Number.MAX_SAFE_INTEGER;
        
        function saveGame(silent = false) {
            // Ulo≈æ ƒças pro sync porovn√°n√≠
            state.lastSaveTime = Date.now();
            
            // Vyƒçisti star√© logy p≈ôed ulo≈æen√≠m (max 50 z√°znam≈Ø)
            if (state.log && state.log.length > 50) {
                state.log = state.log.slice(-50);
            }
            if (state.settlement?.eventLog && state.settlement.eventLog.length > 15) {
                state.settlement.eventLog = state.settlement.eventLog.slice(0, 15);
            }
            
            // === SANITIZACE HODNOT P≈òED ULO≈ΩEN√çM ===
            if (state.money !== undefined) {
                state.money = Math.max(0, Math.min(MAX_MONEY, Math.floor(state.money)));
            }
            if (state.char?.hp !== undefined) {
                state.char.hp = Math.max(0, Math.min(state.char.maxHp || 9999, Math.floor(state.char.hp)));
            }
            if (state.char?.totalXP !== undefined) {
                state.char.totalXP = Math.max(0, Math.min(MAX_XP, Math.floor(state.char.totalXP)));
            }
            
            // Aktualizuj integrity check p≈ôed ulo≈æen√≠m
            if (typeof updateIntegrityCheck === 'function') updateIntegrityCheck();
            
            // V≈ædy ulo≈æit JSON verzi (spolehliv√©)
            let jsonData;
            try {
                jsonData = JSON.stringify(state);
            } catch (e) {
                console.error('Chyba p≈ôi serializaci state:', e);
                if (!silent) {
                    showModal('Chyba', 'Nelze ulo≈æit - data obsahuj√≠ neserializovateln√© hodnoty.');
                }
                return;
            }
            
            try {
                localStorage.setItem('survival_hero_save', jsonData);
                localStorage.setItem('survival_hero_backup', jsonData);
            } catch(e) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ do localStorage:', e);
                if (!silent) {
                    showModal('Chyba', 'Nelze ulo≈æit - √∫lo≈æi≈°tƒõ je pln√© nebo blokovan√©.');
                }
                return;
            }
            
            // Zkus ≈°ifrovanou verzi (voliteln√©)
            try {
                if (typeof encryptData === 'function') {
                    const encrypted = encryptData(state);
                    if (encrypted) {
                        localStorage.setItem('survival_hero_save_v2', encrypted);
                    }
                }
            } catch(e) {
                console.warn('≈†ifrov√°n√≠ selhalo, pou≈æ√≠v√°m ne≈°ifrovanou verzi');
            }
            
            // Cloud save pro p≈ôihl√°≈°en√© u≈æivatele (ka≈æd√© 10. ulo≈æen√≠ nebo p≈ôi ruƒçn√≠m ulo≈æen√≠)
            if (currentUser && !currentUser.isAnonymous && typeof saveCloudSave === 'function') {
                if (!silent) {
                    // Ruƒçn√≠ ulo≈æen√≠ - v≈ædy ulo≈æ do cloudu
                    saveCloudSave();
                } else {
                    // Auto-save - ulo≈æ do cloudu jen obƒças (ka≈æd√Ωch 5 minut ≈ôe≈°√≠ interval)
                }
            }
            
            if (!silent) {
                showModal('Ulo≈æeno!', 'Hra byla √∫spƒõ≈°nƒõ ulo≈æena.' + (currentUser && !currentUser.isAnonymous ? '<br><span style="color: #4CAF50;">‚òÅÔ∏è Tak√© ulo≈æeno do cloudu</span>' : ''));
            }
        }
        
        // Debouncovan√° verze pro ƒçast√© automatick√© ukl√°d√°n√≠ (nap≈ô. v boji)
        const saveGameDebounced = debounce((silent) => saveGame(silent), 2000);
        
        // Validace struktury ulo≈æen√Ωch dat
        function validateSaveData(data) {
            // Z√°kladn√≠ typ kontrola
            if (!data || typeof data !== 'object') return false;
            
            // Kritick√© vlastnosti mus√≠ existovat
            const criticalProps = ['char', 'status', 'time', 'inv'];
            for (const prop of criticalProps) {
                if (!data[prop]) {
                    console.warn(`validateSaveData: Chyb√≠ kritick√° vlastnost '${prop}'`);
                    return false;
                }
            }
            
            // Char validace
            if (typeof data.char !== 'object') return false;
            if (typeof data.char.hp !== 'number' || isNaN(data.char.hp)) {
                console.warn('validateSaveData: Neplatn√© HP');
                return false;
            }
            if (data.char.hp < 0 || data.char.hp > 99999) {
                console.warn('validateSaveData: HP mimo rozumn√Ω rozsah');
                return false;
            }
            
            // Status validace
            if (typeof data.status !== 'object') return false;
            const statusProps = ['hunger', 'thirst', 'energy'];
            for (const prop of statusProps) {
                if (data.status[prop] !== undefined) {
                    if (typeof data.status[prop] !== 'number' || isNaN(data.status[prop])) {
                        console.warn(`validateSaveData: Neplatn√Ω status.${prop}`);
                        return false;
                    }
                }
            }
            
            // Invent√°≈ô validace
            if (!Array.isArray(data.inv)) {
                console.warn('validateSaveData: Invent√°≈ô nen√≠ pole');
                return false;
            }
            
            // Time validace
            if (typeof data.time !== 'object') return false;
            
            // Money validace (pokud existuje)
            if (data.money !== undefined) {
                if (typeof data.money !== 'number' || isNaN(data.money) || data.money < 0) {
                    console.warn('validateSaveData: Neplatn√© money, resetuji na 0');
                    data.money = 0;
                }
                if (data.money > Number.MAX_SAFE_INTEGER) {
                    console.warn('validateSaveData: Money p≈ôekraƒçuje bezpeƒçnou hodnotu');
                    data.money = Number.MAX_SAFE_INTEGER;
                }
            }
            
            return true;
        }
        
        function loadGame() {
            // Zkus naƒç√≠st ≈°ifrovanou verzi
            let saveData = localStorage.getItem('survival_hero_save_v2');
            let decrypted = null;
            
            if (saveData && typeof decryptData === 'function') {
                try {
                    decrypted = decryptData(saveData);
                } catch (e) {
                    console.warn('De≈°ifrov√°n√≠ selhalo:', e);
                    decrypted = null;
                }
            }
            
            // Fallback na starou verzi
            if (!decrypted) {
                const oldSave = localStorage.getItem('survival_hero_save');
                if (oldSave) {
                    try {
                        decrypted = JSON.parse(oldSave);
                    } catch(e) {
                        console.warn('Parsov√°n√≠ star√©ho save selhalo:', e);
                    }
                }
            }
            
            // Fallback na z√°lohu
            if (!decrypted) {
                const backup = localStorage.getItem('survival_hero_backup');
                if (backup) {
                    try {
                        decrypted = JSON.parse(backup);
                    } catch(e) {
                        console.warn('Parsov√°n√≠ z√°lohy selhalo:', e);
                    }
                }
            }
            
            if (decrypted) {
                // === VALIDACE P≈òED POU≈ΩIT√çM ===
                if (!validateSaveData(decrypted)) {
                    console.error('Ulo≈æen√° hra nepro≈°la validac√≠!');
                    showModal(
                        'Po≈°kozen√° hra',
                        'Ulo≈æen√° hra obsahuje neplatn√° data a nelze ji naƒç√≠st. Pros√≠m, zaƒçni novou hru nebo obnov ze z√°lohy.'
                    );
                    return;
                }
                
                try {
                    state = decrypted;
                    // Reset timing references but keep totalElapsed
                    state.time.last = Date.now();
                    state.time.realStart = Date.now();
                    
                    // === MIGRACE - doplnƒõn√≠ chybƒõj√≠c√≠ch vlastnost√≠ ===
                    migrateState();
                    
                    // Po naƒçten√≠ v≈ædy p≈ôepni na Online tab
                    state.activeTab = 'multiplayer';
                    
                    // Aktualizuj integrity check po naƒçten√≠
                    if (typeof updateIntegrityCheck === 'function') updateIntegrityCheck();
                    
                    // === KONTROLA CHR√ÅNƒöN√âHO NICKU ===
                    const nicknameCheck = checkProtectedNickname();
                    if (nicknameCheck instanceof Promise) {
                        // ƒåekej na ovƒõ≈ôen√≠ hesla, pak zobraz "Naƒçteno"
                        nicknameCheck.then(() => {
                            renderFull();
                            showModal('Naƒçteno!', 'Hra byla √∫spƒõ≈°nƒõ naƒçtena.');
                        });
                    } else {
                        renderFull();
                        showModal('Naƒçteno!', 'Hra byla √∫spƒõ≈°nƒõ naƒçtena.');
                    }
                } catch (e) {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ulo≈æen√© hry:', e);
                    showModal(
                        'Chyba',
                        'Ulo≈æen√° hra je po≈°kozen√°. Pros√≠m, zaƒçni novou hru.'
                    );
                }
            } else {
                showModal('Chyba', 'Nebyla nalezena ≈æ√°dn√° ulo≈æen√° hra.');
            }
        }
        
        // Migrace star√Ωch ulo≈æen√Ωch her na novou verzi
        function migrateState() {
            console.log('üîÑ Migrace ulo≈æen√© hry...');
            
            // === KRITICK√â: Zajisti z√°kladn√≠ struktury ===
            if (!state.char) state.char = { name: 'Survivor', gender: null, level: 1, xp: 0, xpNeed: 400, totalXP: 0, hp: 100, maxHp: 100, attrs: { str: 5, int: 5, agi: 5, per: 5, end: 5, lck: 5 } };
            if (!state.status) state.status = { hunger: 100, thirst: 100, energy: 100, mood: 100, radiation: 0 };
            if (!state.time) state.time = { gameStart: Date.now(), realStart: Date.now(), last: Date.now(), days: 0, hours: 0, mins: 0, totalElapsed: 0 };
            if (!state.inv) state.inv = [];
            if (!state.equipped) state.equipped = { weapon: null, armor: null, gloves: null, boots: null };
            if (!state.resources) state.resources = { wood: 0, metal: 0, stone: 0, cloth: 0, fuel: 0, leather: 0, herbs: 0, chemicals: 0, electronics: 0, glass: 0, rope: 0, gunpowder: 0, scrap: 0, copper: 0 };
            
            // === KRITICK√â: Zajisti mainQuest strukturu ===
            if (!state.mainQuest) state.mainQuest = { currentQuest: 'intro', completedQuests: [], questProgress: {}, npcMet: [], storyComplete: false, chapter: 0 };
            if (!state.mainQuest.completedQuests) state.mainQuest.completedQuests = [];
            if (!state.mainQuest.questProgress) state.mainQuest.questProgress = {};
            if (!state.mainQuest.npcMet) state.mainQuest.npcMet = [];
            
            // === Oprava desetinn√©ho HP ===
            // === OPRAVA: HP bylo desetinn√© ===
            if (state.char?.hp && !Number.isInteger(state.char.hp)) {
                console.warn('‚ö†Ô∏è Oprava: HP bylo desetinn√©:', state.char.hp);
                state.char.hp = Math.floor(state.char.hp);
            }
            
            // === XP MIGRACE A KONTROLA KONZISTENCE ===
            // Detekce po≈°kozen√©ho XP syst√©mu - totalXP mus√≠ odpov√≠dat level + xp
            if (state.char?.totalXP !== undefined && state.char.totalXP !== null) {
                // Spoƒç√≠tej kolik by mƒõlo b√Ωt totalXP podle aktu√°ln√≠ho level a xp
                let expectedTotalXP = 0;
                for (let i = 1; i < (state.char.level || 1); i++) {
                    expectedTotalXP += Math.floor(350 * Math.pow(1.5, i - 1));
                }
                expectedTotalXP += (state.char.xp || 0);
                
                // Pokud totalXP neodpov√≠d√° (rozd√≠l > 10%), oprav ho
                const diff = Math.abs(state.char.totalXP - expectedTotalXP);
                const threshold = Math.max(100, expectedTotalXP * 0.1);
                
                if (diff > threshold) {
                    console.warn(`‚ö†Ô∏è XP NESOULAD DETEKOV√ÅN!`);
                    console.warn(`   TotalXP v ulo≈æen√© h≈ôe: ${state.char.totalXP}`);
                    console.warn(`   Oƒçek√°van√© podle level ${state.char.level} + xp ${state.char.xp}: ${expectedTotalXP}`);
                    console.warn(`   Opravuji totalXP na: ${expectedTotalXP}`);
                    state.char.totalXP = expectedTotalXP;
                }
            }
            
            // Pokud nem√° totalXP v≈Øbec, nastav podle aktu√°ln√≠ho xp
            if (state.char?.totalXP === undefined || state.char.totalXP === null) {
                state.char.totalXP = state.char.xp || 0;
                console.log(`üîß Migrace totalXP: Nastaveno na ${state.char.totalXP}`);
            }
            
            // P≈ôepoƒç√≠tej level z totalXP (v≈ædy - pro jistotu)
            if (typeof recalculateLevelFromTotalXP === 'function') {
                recalculateLevelFromTotalXP();
                console.log(`üìä Po migraci: Level ${state.char.level}, XP: ${state.char.xp}/${state.char.xpNeed}, TotalXP: ${state.char.totalXP}`);
            }
            
            if (!state.map) state.map = { x: 0, y: 0, hexes: {}, inBase: true, traveling: false };
            if (!state.base) state.base = ['wall'];
            if (!state.skills_secondary) state.skills_secondary = { hunting: 0, mining: 0, fishing: 0 };
            if (!state.stats) state.stats = { kills: 0, explored: 0, crafted: 0, traveled: 0 };
            
            // === Migrace stashes (skr√Ω≈°e) ===
            if (!state.stashes) {
                state.stashes = {};
                console.log('üîß Migrace: P≈ôid√°na struktura stashes');
            }
            
            // === Migrace settlement struktury ===
            if (!state.settlement) {
                state.settlement = { level: 1, prosperity: 0, settlers: [], buildings: [], resources: { food: 10, water: 10 }, defense: 0 };
            }
            if (!state.settlement.settlers) state.settlement.settlers = [];
            if (!state.settlement.buildings) state.settlement.buildings = [];
            if (!state.settlement.resources) state.settlement.resources = { food: 10, water: 10 };
            if (!state.settlement.eventLog) state.settlement.eventLog = []; // Historie ud√°lost√≠
            
            // === Migrace dailyQuests struktury ===
            if (!state.dailyQuests) state.dailyQuests = { quests: [], completed: [], progress: {}, lastRefresh: 0 };
            if (!state.dailyQuests.completed) state.dailyQuests.completed = [];
            if (!state.dailyQuests.progress) state.dailyQuests.progress = {};
            
            // === Migrace NPC quest≈Ø - zajisti progress objekt ===
            if (state.npcQuests) {
                Object.keys(state.npcQuests).forEach(npcId => {
                    const quest = state.npcQuests[npcId];
                    if (quest && !quest.progress) {
                        console.log(`üîß Migrace: P≈ôid√°v√°m progress pro quest ${quest.id}`);
                        quest.progress = { explored: 0, kills: 0, escortLocations: 0 };
                    }
                    // === Migrace talk quest≈Ø - automaticky spl≈à pokud je to talk quest ===
                    if (quest && quest.id && quest.progress) {
                        const questDef = NPC_QUESTS[quest.id];
                        if (questDef?.requirement?.talk && !quest.progress.talked) {
                            console.log(`üîß Migrace: Opravuji talk quest ${quest.id} pro ${npcId}`);
                            quest.progress.talked = true;
                        }
                    }
                });
            }
            
            // === Migrace dungeon struktury ===
            if (state.dungeon) {
                // Zajisti ≈æe cleared existuje
                if (!state.dungeon.cleared) state.dungeon.cleared = {};
                if (!state.dungeon.loot) state.dungeon.loot = [];
            }
            
            // Oprava corrupted totalDailyQuestsCompleted (max realistick√° hodnota)
            // Hr√°ƒç m≈Ø≈æe splnit max 3 denn√≠ questy za den, tak≈æe limit je dny * 3
            const maxRealisticQuests = Math.max(20, (state.time?.days || 0) * 3);
            if (state.stats.totalDailyQuestsCompleted && state.stats.totalDailyQuestsCompleted > maxRealisticQuests) {
                console.log('‚ö†Ô∏è Oprava: totalDailyQuestsCompleted bylo corrupted:', state.stats.totalDailyQuestsCompleted, 'max realistic:', maxRealisticQuests);
                // Odhadni realistickou hodnotu podle dn≈Ø hran√≠ (max 3 denn√≠ questy za den)
                const daysPlayed = state.time?.days || 0;
                const realisticValue = Math.min(daysPlayed * 3, 50); // Max 50 jako fallback
                state.stats.totalDailyQuestsCompleted = realisticValue;
                console.log('‚ö†Ô∏è Oprava: totalDailyQuestsCompleted nastaveno na:', state.stats.totalDailyQuestsCompleted);
                notifyWarning('Oprava dat', 'Poƒçet splnƒõn√Ωch quest≈Ø byl opraven (byla chyba v datech)');
            }
            
            // Aplikuj genetick√© upgrady na maxHp (pokud existuj√≠)
            if (state.geneticUpgrades && state.geneticUpgrades > 0) {
                const expectedMaxHp = 100 + (state.geneticUpgrades * 5);
                if (state.char.maxHp < expectedMaxHp) {
                    console.log('üß¨ Aplikuji genetick√© upgrady:', state.geneticUpgrades, '-> maxHp:', expectedMaxHp);
                    state.char.maxHp = expectedMaxHp;
                }
            }
            
            // Migrace: groundLoot syst√©m
            if (!state.world.groundLoot) state.world.groundLoot = {};
            
            // Pokud je to ƒçerstv√Ω import, p≈ôeskoƒç destruktivn√≠ migrace
            const isFreshImport = state._freshImport === true;
            if (isFreshImport) {
                console.log('‚úÖ ƒåerstv√Ω import - p≈ôeskakuji destruktivn√≠ migrace');
                delete state._freshImport;
                delete state._importTime;
            }
            
            // Migration: P≈ôesun resources z invent√°≈ôe do state.resources
            // POUZE pokud nejde o fresh import (tam u≈æ jsou suroviny spr√°vnƒõ)
            if (!isFreshImport) {
                const resourceIds = ['wood', 'metal', 'stone', 'cloth', 'leather', 'herbs', 'chemicals', 'electronics', 'glass', 'rope', 'gunpowder', 'scrap', 'fuel', 'copper', 'silver', 'gold', 'copper_ore', 'silver_ore', 'gold_ore', 'crystal', 'plastic', 'raw_meat', 'fish'];
                const toRemove = [];
                state.inv.forEach((item, idx) => {
                    if (item.type === 'resource' || resourceIds.includes(item.id)) {
                        const count = item.count || 1;
                        state.resources[item.id] = (state.resources[item.id] || 0) + count;
                        toRemove.push(idx);
                        console.log(`üì¶ Migrace: ${item.name || item.id} (${count}x) p≈ôesunuto do surovin`);
                    }
                });
                // Odstra≈à z invent√°≈ôe (od konce aby indexy z≈Østaly spr√°vn√©)
                for (let i = toRemove.length - 1; i >= 0; i--) {
                    state.inv.splice(toRemove[i], 1);
                }
            }
            
            // Migration: Fix item types - dopl≈à chybƒõj√≠c√≠ type z ITEMS definice
            state.inv.forEach(item => {
                const itemDef = ITEMS.find(i => i.id === item.id);
                if (itemDef) {
                    // Dopl≈à chybƒõj√≠c√≠ type
                    if (!item.type) item.type = itemDef.type;
                    // Dopl≈à i dal≈°√≠ chybƒõj√≠c√≠ vlastnosti
                    if (item.defense === undefined && itemDef.defense !== undefined) item.defense = itemDef.defense;
                    if (item.damage === undefined && itemDef.damage !== undefined) item.damage = itemDef.damage;
                    if (item.weight === undefined && itemDef.weight !== undefined) item.weight = itemDef.weight;
                    if (!item.icon && itemDef.icon) item.icon = itemDef.icon;
                    // D≈ÆLE≈ΩIT√â: V≈ædy oprav jm√©no na ƒçesk√© z ITEMS!
                    if (itemDef.name) item.name = itemDef.name;
                    // D≈ÆLE≈ΩIT√â: ammoType pro st≈ôeln√© zbranƒõ!
                    if (item.ammoType === undefined && itemDef.ammoType !== undefined) item.ammoType = itemDef.ammoType;
                    // Bonus pro n√°stroje (hunting, fishing, etc.)
                    if (item.bonus === undefined && itemDef.bonus !== undefined) item.bonus = itemDef.bonus;
                    // Efekty pro consumables
                    if (item.effect === undefined && itemDef.effect !== undefined) item.effect = itemDef.effect;
                    if (item.value === undefined && itemDef.value !== undefined) item.value = itemDef.value;
                    // D≈ÆLE≈ΩIT√â: special pro speci√°ln√≠ efekty (rad_immune, rad_resist, block, etc.)
                    if (item.special === undefined && itemDef.special !== undefined) item.special = itemDef.special;
                } else {
                    // Pokud nen√≠ v ITEMS, zkus RECIPES (uva≈ôen√© j√≠dlo, lektvary)
                    const recipeDef = RECIPES.find(r => r.id === item.id);
                    if (recipeDef) {
                        if (!item.name && recipeDef.name) item.name = recipeDef.name;
                        if (!item.icon && recipeDef.icon) item.icon = recipeDef.icon;
                        if (!item.type) item.type = 'consumable';
                    }
                }
            });
            
            // Migration: Fix equipped items too!
            if (state.equipped) {
                Object.keys(state.equipped).forEach(slot => {
                    const item = state.equipped[slot];
                    if (item && item.id) {
                        const itemDef = ITEMS.find(i => i.id === item.id);
                        if (itemDef) {
                            if (item.ammoType === undefined && itemDef.ammoType !== undefined) item.ammoType = itemDef.ammoType;
                            if (item.damage === undefined && itemDef.damage !== undefined) item.damage = itemDef.damage;
                            if (item.defense === undefined && itemDef.defense !== undefined) item.defense = itemDef.defense;
                            // D≈ÆLE≈ΩIT√â: Oprav ƒçesk√© jm√©no!
                            if (itemDef.name) item.name = itemDef.name;
                            if (!item.icon && itemDef.icon) item.icon = itemDef.icon;
                            // D≈ÆLE≈ΩIT√â: special pro speci√°ln√≠ efekty (rad_immune, rad_resist, block, etc.)
                            if (item.special === undefined && itemDef.special !== undefined) item.special = itemDef.special;
                        }
                    }
                });
            }
            
            // Migration: Add durability to old weapons/armor that don't have it
            state.inv.forEach(item => {
                if ((item.type === 'weapon' || item.type === 'armor') && item.durability === undefined) {
                    item.durability = 100;
                    item.maxDurability = 100;
                }
            });
            
            // Migration: Fix settler skillLevel (p≈ôevod z level na skillLevel)
            if (state.settlement?.settlers) {
                state.settlement.settlers.forEach(settler => {
                    // Pokud m√° level ale ne skillLevel, p≈ôeveƒè
                    if (settler.level && !settler.skillLevel) {
                        settler.skillLevel = settler.level;
                    }
                    // Zajisti ≈æe skillLevel existuje
                    if (!settler.skillLevel) settler.skillLevel = 1;
                    // Zajisti ≈æe xp existuje
                    if (!settler.xp) settler.xp = 0;
                });
            }
            
            // Migration: Fix dynamic companions (rescued survivors)
            if (state.companions) {
                state.companions.forEach(comp => {
                    // Najdi definici z COMPANIONS pro nastaven√≠ spr√°vn√Ωch hodnot
                    const baseDef = COMPANIONS.find(c => c.id === comp.id);
                    
                    // Zajisti ≈æe dynamiƒçt√≠ spoleƒçn√≠ci maj√≠ v≈°echny pot≈ôebn√© vlastnosti
                    // Priorita: existuj√≠c√≠ hodnota > hodnota z definice > fallback
                    if (!comp.type) comp.type = baseDef?.type || 'human';
                    if (!comp.equipped) comp.equipped = { weapon: null, armor: null, helmet: null, gloves: null, boots: null };
                    if (comp.equipment && !comp.equipped) {
                        comp.equipped = comp.equipment;
                        delete comp.equipment;
                    }
                    // Lid√© a survivor v≈ædy mohou m√≠t vybaven√≠
                    if (comp.canEquip === undefined) {
                        comp.canEquip = (comp.type === 'human' || comp.id === 'survivor' || baseDef?.type === 'human');
                    }
                    if (comp.inCombat === undefined) comp.inCombat = true;
                    if (!comp.skills) comp.skills = [];
                    if (comp.skillPoints === undefined) comp.skillPoints = 0;
                    
                    // Speci√°ln√≠ oprava pro freed_slave / survivor spoleƒçn√≠ky
                    if (comp.uniqueId && comp.uniqueId.startsWith('freed_slave')) {
                        comp.type = 'human';
                        comp.canEquip = true;
                        if (!comp.id) comp.id = 'survivor';
                    }
                });
            }
            
            // Migration: Add building cooldowns if missing
            if (!state.buildingCooldowns) {
                state.buildingCooldowns = {
                    hospitals: {},
                    workshops: {},
                    factories: {}
                };
            }
            
            // Migration: Update base capacity to 40 (was 20 in old saves)
            if (state.baseCapacity < 40) {
                let bonusCapacity = 0;
                if (state.base && state.base.includes('warehouse')) bonusCapacity += 30;
                if (state.base && state.base.includes('cryo_storage')) bonusCapacity += 50;
                state.baseCapacity = 40 + bonusCapacity;
            }
            
            // Migration: Add factions if missing
            if (!state.factions) {
                state.factions = { traders: 0, scientists: 0, raiders: -20, mutants: 0, military: 0 };
            }
            
            // Migration: Add dailyQuests progress if missing
            if (!state.dailyQuests) {
                state.dailyQuests = { lastReset: Date.now(), quests: [], completed: [], progress: {} };
            }
            if (!state.dailyQuests.progress) {
                state.dailyQuests.progress = { kills: 0, explored: 0, crafted: 0, moneyEarned: 0, travelled: 0, cooked: 0, sold: 0, bought: 0 };
            }
            // Ensure cooked exists for old saves
            if (state.dailyQuests.progress.cooked === undefined) {
                state.dailyQuests.progress.cooked = 0;
            }
            
            // Migration: Add world system if missing
            if (!state.world) {
                state.world = {
                    currentLocation: 'shelter',
                    visitedLocations: ['shelter'],
                    traveling: false,
                    travelTo: null,
                    travelStart: null,
                    travelDuration: null,
                    scheduledEvents: []
                };
            }
            
            // Migration: Add scheduledEvents array if missing
            if (!state.world.scheduledEvents) {
                state.world.scheduledEvents = [];
            }
            
            // Migration: Add firstTravelDone flag
            if (state.firstTravelDone === undefined) {
                // Pokud u≈æ m√° spoleƒçn√≠ka nebo odm√≠tl psa, tak firstTravelDone = true
                state.firstTravelDone = (state.companions?.length > 0) || (state.rejectedCompanions?.length > 0);
            }
            
            // Migration: Add companions array if missing
            if (!state.companions) {
                state.companions = [];
            }
            
            // Migration: Add rejectedCompanions array if missing
            if (!state.rejectedCompanions) {
                state.rejectedCompanions = [];
            }
            
            // Migration: Add caravan system if missing
            if (!state.caravan) {
                state.caravan = { active: false, until: 0, nextCheck: Date.now() + 3600000 };
            }
            if (!state.caravan.nextCheck) {
                state.caravan.nextCheck = Date.now() + 3600000;
            }
            
            // Migration: Add settlement raid check if missing
            if (!state.settlement) {
                state.settlement = { settlers: [], buildings: [], prosperity: 0 };
            }
            if (!state.settlement.nextRaidCheck) {
                state.settlement.nextRaidCheck = Date.now() + 300000;
            }
            
            // Migration: Add NPC quests if missing
            if (!state.npcQuests) {
                state.npcQuests = {};
            }
            
            // Migration: Add NPC trust if missing
            if (!state.npcTrust) {
                state.npcTrust = {};
            }
            
            // Migration: Add NPC relations if missing
            if (!state.npcRelations) {
                state.npcRelations = {};
            }
            
            // Migration: Add Bucovice karma if missing
            if (!state.storyKarma) {
                state.storyKarma = {
                    kory: 0,
                    koudy: 0,
                    componentsGiven: { kory: 0, koudy: 0 },
                    ending: null
                };
            }
            
            // Migration: Add karma for NPC quests if missing
            if (!state.karma) {
                state.karma = { kory: 0, koudy: 0 };
            }
            
            // Migration: Convert old story quests to new story
            const oldQuestIds = ['find_diary', 'return_diary', 'find_scientist', 'get_chemicals', 'return_chemicals', 'find_general', 'save_humanity'];
            if (state.mainQuest?.currentQuest && oldQuestIds.includes(state.mainQuest.currentQuest)) {
                console.log('üîÑ Migrace: Star√Ω p≈ô√≠bƒõh -> Nov√Ω p≈ô√≠bƒõh "Projekt Genesis"');
                
                // Zjisti jak daleko byl hr√°ƒç ve star√©m p≈ô√≠bƒõhu
                const oldProgress = oldQuestIds.indexOf(state.mainQuest.currentQuest);
                
                // Mapov√°n√≠ star√©ho progressu na nov√Ω
                let newQuest = 'intro';
                if (oldProgress >= 5) { // find_general nebo save_humanity
                    newQuest = 'third_component'; // Kapitola 3
                } else if (oldProgress >= 3) { // get_chemicals nebo return_chemicals
                    newQuest = 'second_component'; // Kapitola 2
                } else if (oldProgress >= 1) { // find_diary nebo return_diary
                    newQuest = 'meet_kory'; // Kapitola 1
                }
                
                state.mainQuest.currentQuest = newQuest;
                state.mainQuest.questProgress = {};
                state.mainQuest.completedQuests = state.mainQuest.completedQuests?.filter(q => !oldQuestIds.includes(q)) || [];
                
                const newQuestData = MAIN_QUESTS.find(q => q.id === newQuest);
                if (newQuestData) {
                    state.mainQuest.chapter = newQuestData.chapter;
                }
                
                // Odstra≈à star√© quest itemy
                state.inv = state.inv?.filter(item => !['military_diary', 'chemicals', 'antivirus'].includes(item.id)) || [];
                
                notifyInfo('üìñ P≈ô√≠bƒõh aktualizov√°n!', 'Nov√Ω p≈ô√≠bƒõh: Projekt Genesis - Dva brat≈ôi');
            }
            
            // Migration: Add stats if missing
            if (!state.stats) {
                state.stats = { kills: 0, deaths: 0, crafted: 0, travelled: 0 };
            }
            
            // Migration: Fix stuck quests - if currentQuest is in completedQuests, move to next
            if (state.mainQuest?.currentQuest && state.mainQuest?.completedQuests?.includes(state.mainQuest.currentQuest)) {
                const completedQuest = MAIN_QUESTS.find(q => q.id === state.mainQuest.currentQuest);
                if (completedQuest && completedQuest.nextQuest) {
                    console.log(`üîß Opravuji zasekl√Ω quest: ${state.mainQuest.currentQuest} -> ${completedQuest.nextQuest}`);
                    state.mainQuest.currentQuest = completedQuest.nextQuest;
                    state.mainQuest.questProgress = {};
                    const nextQuest = MAIN_QUESTS.find(q => q.id === completedQuest.nextQuest);
                    if (nextQuest) {
                        state.mainQuest.chapter = nextQuest.chapter;
                        // Spawn quest item pokud je pot≈ôeba
                        if (nextQuest.spawnItem) {
                            if (!state.world.questItems) state.world.questItems = {};
                            state.world.questItems[nextQuest.spawnItem.location] = nextQuest.spawnItem.id;
                        }
                    }
                } else if (completedQuest && completedQuest.ending) {
                    state.mainQuest.currentQuest = null;
                    state.mainQuest.storyComplete = true;
                }
            }
            
            // Migration: Add world.questItems if missing
            if (!state.world.questItems) {
                state.world.questItems = {};
            }
            
            // Migration: Add equipped if missing
            if (!state.equipped) {
                state.equipped = { weapon: null, armor: null };
            }
            
            // Migration: Add starterToolChosen (existuj√≠c√≠ hry u≈æ maj√≠ n√°stroj)
            if (state.starterToolChosen === undefined) {
                state.starterToolChosen = true; // Star√© save soubory u≈æ maj√≠ n√°stroje
            }
            
            // Migration: Add achievements if missing
            if (!state.achievements) {
                state.achievements = [];
            }
            
            // Migration: Add resources if missing
            if (!state.resources) {
                state.resources = {};
            }
            
            // Migration: Recalculate prosperity based on existing buildings
            if (state.base && state.settlement) {
                const baseBuildingCount = state.base.length || 0;
                const settlementBuildingCount = state.settlement.buildings?.length || 0;
                const minProsperity = (baseBuildingCount * 5) + (settlementBuildingCount * 20);
                if (state.settlement.prosperity < minProsperity) {
                    state.settlement.prosperity = Math.min(100, minProsperity);
                    console.log(`üîß P≈ôepoƒç√≠t√°na prosperita: ${state.settlement.prosperity}`);
                }
            }
            
            // Migration: Reschedule travel events if traveling but no events scheduled
            if (state.world.traveling && state.world.scheduledEvents.length === 0) {
                const now = Date.now();
                const timeElapsed = now - state.world.travelStart;
                const timeRemaining = state.world.travelDuration - timeElapsed;
                
                if (timeRemaining > 0) {
                    // Napl√°nuj n√°hodn√Ω event
                    const eventTime = now + (timeRemaining * (0.3 + Math.random() * 0.4));
                    state.world.scheduledEvents.push({
                        type: 'random',
                        triggerAt: eventTime,
                        dangerLevel: state.world.travelPath?.danger || 0,
                        triggered: false
                    });
                    console.log('üìÖ Napl√°nov√°n chybƒõj√≠c√≠ travel event');
                }
            }
            
            // Migration: Add first lore book if missing
            if (!state.inv.some(i => i.id === 'lore_1') && !state.firstLoreGiven) {
                state.inv.push({ id: 'lore_1', name: 'Den√≠k vƒõdce I', icon: 'üìï', type: 'lore', weight: 0, price: 0, rarity: 'rare' });
                state.firstLoreGiven = true;
                console.log('üìï P≈ôid√°na prvn√≠ kniha do invent√°≈ôe');
                notifyInfo('üìï Nov√Ω p≈ôedmƒõt!', 'Na≈°el jsi star√Ω den√≠k v √∫krytu...');
            }
            
            // Migration: Add readBooks array if missing
            if (!state.readBooks) {
                state.readBooks = [];
            }
            
            // Migration: Add casinoLastTokenTime if missing (for 24h real-time bonus)
            if (state.casinoLastTokenTime === undefined || state.casinoLastTokenTime === 0) {
                // Pokud m√° hr√°ƒç u≈æ nƒõjak√© ≈æetony nad 1000, pravdƒõpodobnƒõ u≈æ bonus dostal
                // Nastav√≠me ƒças na "teƒè" aby nedostal hned dal≈°√≠
                state.casinoLastTokenTime = Date.now();
                console.log('üé∞ Migrace: Nastaven casinoLastTokenTime');
            }
            
            // Migration: Add lastFreeHerbs if missing (bylinky od Marty)
            if (state.lastFreeHerbs === undefined || state.lastFreeHerbs === 0) {
                // Nastav√≠me ƒças na "teƒè" aby nedostal hned bylinky
                state.lastFreeHerbs = Date.now();
                console.log('üåø Migrace: Nastaven lastFreeHerbs');
            }
            
            // Migration: Add buildQueue if missing (fronta budov)
            if (!state.buildQueue) {
                state.buildQueue = [];
                console.log('üèóÔ∏è Migrace: P≈ôid√°no buildQueue');
            }
            
            // Migration: FIX ITEM TYPES - opravit itemy kter√© maj√≠ ≈°patn√Ω type
            const helmetIds = ['helmet_basic', 'helmet_craft', 'helmet', 'gas_mask', 'gas_mask_craft', 
                              'tactical_helmet', 'ballistic_helmet', 'rad_helmet', 'cap', 'hard_hat', 
                              'motorcycle_helmet', 'welding_mask', 'hazmat_helmet'];
            const glovesIds = ['work_gloves', 'leather_gloves', 'combat_gloves', 'tactical_gloves', 
                              'spiked_gloves', 'power_gloves', 'arm_guards'];
            const bootsIds = ['hiking_boots', 'combat_boots', 'stealth_boots', 'leg_guards', 
                             'running_shoes', 'steel_boots', 'sandals'];
            
            state.inv.forEach(item => {
                if (helmetIds.includes(item.id) && item.type !== 'helmet') {
                    item.type = 'helmet';
                }
                if (glovesIds.includes(item.id) && item.type !== 'gloves') {
                    item.type = 'gloves';
                }
                if (bootsIds.includes(item.id) && item.type !== 'boots') {
                    item.type = 'boots';
                }
                if (['helmet', 'gloves', 'boots'].includes(item.type) && item.durability === undefined) {
                    item.durability = 100;
                    item.maxDurability = 100;
                }
            });
            
            // V≈ædy ovƒõ≈ô XP syst√©m po naƒçten√≠
            const loadXpNeed = 350 + (state.char.level * 50);
            if (state.char.xpNeed !== loadXpNeed) {
                console.log(`üîß Load: Oprava xpNeed ${state.char.xpNeed} ‚Üí ${loadXpNeed}`);
                state.char.xpNeed = loadXpNeed;
            }
            
            // === KONTROLA V≈†ECH QUEST PROGRESS PO NAƒåTEN√ç ===
            // Zajist√≠ ≈æe questy se aktualizuj√≠ pokud u≈æ hr√°ƒç je v c√≠lov√© lokaci
            setTimeout(() => {
                const currentLoc = state.world?.currentLocation;
                if (!currentLoc) return;
                
                // 1. Main quest - p≈ô√≠bƒõhov√© questy
                if (state.mainQuest?.currentQuest && typeof updateQuestProgress === 'function') {
                    updateQuestProgress('location', currentLoc);
                }
                
                // 2. Timed questy - ƒçasovƒõ omezen√©
                if (state.timedQuests?.length > 0 && typeof checkTimedQuestObjectives === 'function') {
                    checkTimedQuestObjectives('location', currentLoc);
                }
                
                // 3. Companion questy
                if (state.companions?.length > 0 && typeof checkCompanionQuestObjectives === 'function') {
                    checkCompanionQuestObjectives('location', currentLoc);
                }
                
                // 4. Daily questy - zkontroluj progress
                if (typeof checkDailyQuests === 'function') {
                    checkDailyQuests();
                }
                
                console.log('üîÑ Quest progress zkontrolov√°n po naƒçten√≠');
            }, 200);
            
            // === VALIDACE INVENT√Å≈òE ===
            if (typeof validateInventory === 'function') {
                const invReport = validateInventory();
                if (invReport.fixed > 0 || invReport.removed > 0) {
                    console.log(`üéí Inventory validation: ${invReport.fixed} fixed, ${invReport.removed} removed`);
                }
            }
            
            // === MIGRACE: Doplnƒõn√≠ price/weight/rarity do star√Ωch item≈Ø ===
            if (state.inv && state.inv.length > 0) {
                let fixedItems = 0;
                state.inv.forEach(item => {
                    if (!item.id) return;
                    const itemDef = ITEMS.find(i => i.id === item.id);
                    if (itemDef) {
                        let fixed = false;
                        if (!item.price && itemDef.price) { item.price = itemDef.price; fixed = true; }
                        if (!item.weight && itemDef.weight) { item.weight = itemDef.weight; fixed = true; }
                        if (!item.rarity && itemDef.rarity) { item.rarity = itemDef.rarity; fixed = true; }
                        if (!item.type && itemDef.type) { item.type = itemDef.type; fixed = true; }
                        if (fixed) fixedItems++;
                    }
                });
                if (fixedItems > 0) {
                    console.log(`üí∞ Migrace: Doplnƒõny chybƒõj√≠c√≠ vlastnosti u ${fixedItems} item≈Ø`);
                }
            }
            
            // === KRITICK√Å OPRAVA: Znovu propojit equipped itemy s invent√°≈ôem ===
            // Po deserializaci z JSON jsou equipped itemy kopie, ne reference
            // Mus√≠me je propojit zpƒõt na skuteƒçn√© objekty v state.inv
            if (state.equipped) {
                ['weapon', 'armor', 'helmet', 'gloves', 'boots'].forEach(slot => {
                    if (state.equipped[slot]) {
                        const equippedItem = state.equipped[slot];
                        
                        // P≈ôidej unik√°tn√≠ ID pokud chyb√≠
                        if (!equippedItem._uniqueId) {
                            equippedItem._uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                        
                        // Najdi odpov√≠daj√≠c√≠ item v invent√°≈ôi
                        // Priorita 1: p≈ôesn√° shoda podle _uniqueId
                        let matchingItem = state.inv.find(i => i._uniqueId === equippedItem._uniqueId);
                        
                        // Priorita 2: shoda podle ID, typu a durability
                        if (!matchingItem) {
                            matchingItem = state.inv.find(i => 
                                i.id === equippedItem.id && 
                                i.type === equippedItem.type &&
                                i.durability === equippedItem.durability &&
                                !isItemEquippedInOtherSlot(i, slot)
                            );
                        }
                        
                        // Priorita 3: shoda jen podle ID a typu (pro star√© save)
                        if (!matchingItem) {
                            matchingItem = state.inv.find(i => 
                                i.id === equippedItem.id && 
                                i.type === equippedItem.type &&
                                !isItemEquippedInOtherSlot(i, slot)
                            );
                        }
                        
                        if (matchingItem) {
                            // Zkop√≠ruj _uniqueId na matching item
                            matchingItem._uniqueId = equippedItem._uniqueId;
                            // Propoj referenci
                            state.equipped[slot] = matchingItem;
                            console.log(`üîó Equipped ${slot} propojen: ${matchingItem.name}`);
                        } else {
                            // Item nen√≠ v invent√°≈ôi - p≈ôidej ho tam!
                            console.warn(`‚ö†Ô∏è Equipped ${slot} "${equippedItem.name}" nebyl v invent√°≈ôi - p≈ôid√°v√°m`);
                            state.inv.push(equippedItem);
                            // Teƒè propoj referenci
                            state.equipped[slot] = equippedItem;
                        }
                    }
                });
            }
            
            // Pomocn√° funkce - kontroluje jestli item je equipped v jin√©m slotu
            function isItemEquippedInOtherSlot(item, currentSlot) {
                const slots = ['weapon', 'armor', 'helmet', 'gloves', 'boots'];
                for (const slot of slots) {
                    if (slot !== currentSlot && state.equipped[slot] === item) {
                        return true;
                    }
                }
                return false;
            }
            
            console.log('‚úÖ Migrace dokonƒçena');
        }
        
        function toggleSound() {
            const enabled = SoundSystem.toggle();
            const btn = document.getElementById('soundBtn');
            if (btn) {
                btn.textContent = enabled ? 'üîä' : 'üîá';
                btn.style.background = enabled ? '#555' : '#c62828';
            }
            if (enabled) {
                SoundSystem.play('pickup');
            }
        }
        
        // Funkce pro opravu po≈°kozen√©ho totalXP
        window.fixTotalXP = function() {
            const input = document.getElementById('fixTotalXP');
            if (!input) return;
            
            const newTotalXP = parseInt(input.value) || 0;
            if (newTotalXP < 0) {
                notifyWarning('Chyba', 'XP nem≈Ø≈æe b√Ωt z√°porn√©!');
                return;
            }
            
            state.char.totalXP = newTotalXP;
            recalculateLevelFromTotalXP();
            saveGame();
            closeModal();
            renderFull();
            notifySuccess('XP opraveno!', `Nov√Ω level: ${state.char.level}, XP: ${state.char.xp}/${state.char.xpNeed}`);
        };
        
        // === V√ùBƒöR JAZYKA ===
        // Info o polo≈æk√°ch v horn√≠ li≈°tƒõ - glob√°ln√≠ funkce
        window.showStatInfo = function(statType) {
            // Kontrola ≈æe state existuje
            if (!state || !state.char) {
                console.log('State not ready');
                return;
            }
            
            let title = '';
            let content = '';
            
            switch(statType) {
                case 'name':
                    const classData = CLASSES[state.char.classId];
                    const attrs = state.char.attrs || state.char.stats || {};
                    
                    // V√Ωpoƒçet efektivn√≠ch stat≈Ø (z√°klad + bonusy)
                    const baseStats = {
                        strength: attrs.str || attrs.strength || 5,
                        endurance: attrs.end || attrs.endurance || 5,
                        agility: attrs.agi || attrs.agility || 5,
                        perception: attrs.per || attrs.perception || 5,
                        intelligence: attrs.int || attrs.intelligence || 5,
                        luck: attrs.lck || attrs.luck || 5
                    };
                    
                    // Bonusy z povol√°n√≠
                    const classBonuses = classData?.bonuses || {};
                    
                    // Bonusy z buff≈Ø
                    const buffBonus = (state.buffs?.allStats && state.buffs.allStats.until > Date.now()) ? Math.floor(state.buffs.allStats.value / 5) : 0;
                    
                    // Celkov√© staty
                    const totalStats = {
                        strength: baseStats.strength + (classBonuses.str || 0) + buffBonus,
                        endurance: baseStats.endurance + (classBonuses.end || 0) + buffBonus,
                        agility: baseStats.agility + (classBonuses.agi || 0) + buffBonus,
                        perception: baseStats.perception + (classBonuses.per || 0) + buffBonus,
                        intelligence: baseStats.intelligence + (classBonuses.int || 0) + buffBonus,
                        luck: baseStats.luck + (classBonuses.lck || 0) + buffBonus
                    };
                    
                    // V√Ωpoƒçet odvozen√Ωch hodnot - SJEDNOCENO s hlavn√≠m UI (z√°lo≈æka P≈òE≈ΩIV≈†√ç)
                    // Pou≈æij Z√ÅKLADN√ç atributy (state.char.attrs), ne totalStats
                    let damage = 5 + state.char.attrs.str;
                    const weapon = state.equipped?.weapon;
                    if (weapon) damage += weapon.damage || 0;
                    // Raider class bonus +30%
                    if (state.char.classId === 'raider') damage = Math.floor(damage * 1.3);
                    // Armory bonus +10%
                    if (state.base?.includes('armory')) damage = Math.floor(damage * 1.1);
                    // Skill tree bonus
                    if (typeof getSkillTreeBonus === 'function') {
                        damage = Math.floor(damage * (1 + getSkillTreeBonus('damageBonus')));
                    }
                    
                    // Obrana - pou≈æij calculateDefense() pro spr√°vn√Ω v√Ωpoƒçet
                    let defense = typeof calculateDefense === 'function' ? calculateDefense() : 0;
                    const armor = state.equipped?.armor;
                    
                    // Crit chance - pou≈æij calculateCritChance() pro spr√°vn√Ω v√Ωpoƒçet
                    const critChance = typeof calculateCritChance === 'function' ? Math.round(calculateCritChance() * 100) : 5;
                    
                    // Dodge chance - pou≈æij calculateDodgeChance() pro spr√°vn√Ω v√Ωpoƒçet
                    let armorEffects = { bonusDefense: 0, bonusDodge: 0 };
                    if (typeof getArmorSpecialEffects === 'function') {
                        armorEffects = getArmorSpecialEffects();
                    }
                    const mutBonuses2 = getMutationBonuses();
                    const dodgeChance = typeof calculateDodgeChance === 'function' ? Math.round(calculateDodgeChance() * 100) : 2;
                    
                    // Funkce pro zobrazen√≠ statu s bonusem
                    const showStat = (name, icon, base, total, desc) => {
                        const diff = total - base;
                        const diffText = diff > 0 ? `<span style="color: #8bc34a;">+${diff}</span>` : diff < 0 ? `<span style="color: #f44336;">${diff}</span>` : '';
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid #333;">
                                <span>${icon} ${name}</span>
                                <span>
                                    <strong style="color: #fff;">${total}</strong>
                                    ${diffText ? ` (${base} ${diffText})` : ''}
                                </span>
                            </div>
                            <div style="font-size: 0.75rem; color: #666; padding: 0.2rem 0 0.4rem 1.5rem;">${desc}</div>
                        `;
                    };
                    
                    title = '‚ò¢Ô∏è P≈ôe≈æiv≈°√≠ - Detaily';
                    content = `
                        <div style="max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            <!-- HLAVIƒåKA -->
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-size: 3rem;">${classData?.icon || 'üë§'}</div>
                                <div>
                                    <h2 style="margin: 0; color: #fff;">${state.char.name}</h2>
                                    <p style="margin: 0.2rem 0; color: #d4722e;">${state.char.gender === 'female' ? '‚ôÄÔ∏è' : '‚ôÇÔ∏è'} ${classData?.name || 'Nezn√°m√©'}</p>
                                    <p style="margin: 0; color: #ffd700; font-size: 0.85rem;">‚≠ê √örove≈à ${state.char.level}</p>
                                </div>
                            </div>
                            
                            <!-- BOJOV√â STATISTIKY -->
                            <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #c62828;">
                                <h4 style="margin: 0 0 0.8rem 0; color: #ff6b6b;">${'‚öîÔ∏è BOJOV√â STATISTIKY'}</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #f44336; font-size: 1.5rem; font-weight: bold;">${damage}</div>
                                        <div style="color: #888; font-size: 0.75rem;">‚öîÔ∏è √ötok</div>
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #2196f3; font-size: 1.5rem; font-weight: bold;">${defense}</div>
                                        <div style="color: #888; font-size: 0.75rem;">üõ°Ô∏è Obrana</div>
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">${critChance}%</div>
                                        <div style="color: #888; font-size: 0.75rem;">üí• Kritick√Ω</div>
                                    </div>
                                    <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                                        <div style="color: #8bc34a; font-size: 1.5rem; font-weight: bold;">${dodgeChance}%</div>
                                        <div style="color: #888; font-size: 0.75rem;">üí® √öhyb</div>
                                    </div>
                                </div>
                                ${weapon ? `<div style="margin-top: 0.5rem; padding: 0.3rem; background: #33333380; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #aaa;">${weapon.icon} ${weapon.name} (+${weapon.damage} DMG)</div>` : ''}
                                ${armor ? `<div style="margin-top: 0.3rem; padding: 0.3rem; background: #33333380; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #aaa;">${armor.icon} ${armor.name} (+${armor.defense} DEF)</div>` : ''}
                                ${state.weaponBuff?.fights > 0 ? `<div style="margin-top: 0.3rem; padding: 0.3rem; background: #ffd70030; border-radius: 4px; text-align: center; font-size: 0.8rem; color: #ffd700;">‚ú® Weapon buff: +${state.weaponBuff.damage} DMG (${state.weaponBuff.fights} boj≈Ø)</div>` : ''}
                                ${state.weaponCoating ? `<div style="margin-top: 0.3rem; padding: 0.3rem; background: ${state.weaponCoating.effect === 'poison' ? '#9c27b030' : '#ff572230'}; border-radius: 4px; text-align: center; font-size: 0.8rem; color: ${state.weaponCoating.effect === 'poison' ? '#9c27b0' : '#ff5722'};">${state.weaponCoating.effect === 'poison' ? '‚ò†Ô∏è Jedov√Ω' : 'üî• Ohniv√Ω'} povlak: ${state.weaponCoating.uses}x</div>` : ''}
                            </div>
                            
                            <!-- ATRIBUTY -->
                            <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #4CAF50;">
                                <h4 style="margin: 0 0 0.8rem 0; color: #8bc34a;">${'üìä ATRIBUTY'}</h4>
                                ${showStat('S√≠la', 'üí™', baseStats.strength, totalStats.strength, '+2 DMG za bod nad 5')}
                                ${showStat('V√Ωdr≈æ', '‚ù§Ô∏è', baseStats.endurance, totalStats.endurance, '+10 HP za bod nad 5')}
                                ${showStat('Obratnost', 'üèÉ', baseStats.agility, totalStats.agility, '+2% √∫hyb za bod nad 5')}
                                ${showStat('Vn√≠mavost', 'üëÅÔ∏è', baseStats.perception, totalStats.perception, '+2% krit za bod nad 5')}
                                ${showStat('Inteligence', 'üß†', baseStats.intelligence, totalStats.intelligence, '+10% XP za bod nad 5')}
                                ${showStat('≈†tƒõst√≠', 'üçÄ', baseStats.luck, totalStats.luck, '+3% krit, lep≈°√≠ loot')}
                                
                                ${state.char.availablePoints > 0 ? `
                                    <div style="margin-top: 0.8rem; padding: 0.5rem; background: #ffd70020; border-radius: 4px; text-align: center;">
                                        <span style="color: #ffd700;">‚ú® M√°≈° ${state.char.availablePoints} bod≈Ø k rozdƒõlen√≠!</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- POVOL√ÅN√ç -->
                            <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid ${classData?.color || '#666'};">
                                <h4 style="margin: 0 0 0.5rem 0; color: ${classData?.color || '#888'};">${classData?.icon || 'üë§'} ${classData?.name || 'Nezn√°m√©'}</h4>
                                <p style="color: #aaa; font-size: 0.9rem; margin: 0.3rem 0;">${classData?.desc || ''}</p>
                                <p style="color: #ffd700; font-size: 0.85rem; margin: 0.3rem 0;">‚ö° ${classData?.ability || '≈Ω√°dn√° schopnost'}</p>
                                <p style="color: #9c27b0; font-size: 0.85rem; margin: 0.3rem 0;">üîÆ ${classData?.passive || '≈Ω√°dn√° pasivka'}</p>
                            </div>
                            
                            <!-- AKTIVN√ç BUFFY -->
                            ${(state.buffs?.radResist && state.buffs.radResist.until > Date.now()) || (state.buffs?.allStats && state.buffs.allStats.until > Date.now()) ? `
                                <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #ffd700;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">‚ú® AKTIVN√ç BUFFY</h4>
                                    ${state.buffs?.radResist && state.buffs.radResist.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #8bc34a;">
                                            <span>‚ò¢Ô∏è Odolnost radiaci</span>
                                            <span>+${state.buffs.radResist.value}% (${Math.ceil((state.buffs.radResist.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                    ${state.buffs?.allStats && state.buffs.allStats.until > Date.now() ? `
                                        <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; color: #ffd700;">
                                            <span>‚ú® Elix√≠r s√≠ly</span>
                                            <span>+${state.buffs.allStats.value} (${Math.ceil((state.buffs.allStats.until - Date.now()) / 60000)}m)</span>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <!-- BONUSY -->
                            <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; border-left: 3px solid #888;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #888;">üìã DAL≈†√ç BONUSY</h4>
                                ${state.char.gender === 'female' ? '<p style="color: #e91e63; font-size: 0.85rem; margin: 0.3rem 0;">‚ôÄÔ∏è -10% ceny, +10% prodej</p>' : ''}
                                ${state.mutations?.length > 0 ? `<p style="color: #ff4444; font-size: 0.85rem; margin: 0.3rem 0;">‚ò£Ô∏è ${state.mutations.length} mutac√≠</p>` : ''}
                                ${state.companions?.length > 0 ? `<p style="color: #8bc34a; font-size: 0.85rem; margin: 0.3rem 0;">üë• ${state.companions.length} spoleƒçn√≠k≈Ø</p>` : ''}
                                ${state.settlement?.settlers?.some(s => s.type === 'builder') ? '<p style="color: #ffd700; font-size: 0.85rem; margin: 0.3rem 0;">üèóÔ∏è -50% cena budov (Stavitel)</p>' : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'level':
                    // XP syst√©m zalo≈æen√Ω na totalXP
                    const totalXP = state.char.totalXP || 0;
                    const xpForNext = state.char.xpNeed || Math.floor(350 * Math.pow(1.5, state.char.level - 1));
                    const xpPercent = Math.min(100, Math.floor((state.char.xp / xpForNext) * 100));
                    const lvlTexts = {
                        title: '‚öîÔ∏è √örove≈à', current: 'Aktu√°ln√≠ √∫rove≈à', whatItMeans: 'Co to znamen√°:',
                        levelExplain: '√örove≈à reprezentuje tvou zku≈°enost a s√≠lu. Vy≈°≈°√≠ √∫rove≈à = silnƒõj≈°√≠ postavy, lep≈°√≠ schopnosti.',
                        progress: 'Postup:', toNextLevel: 'do dal≈°√≠ √∫rovnƒõ',
                        onLevelUp: 'P≈ôi level upu dostane≈°:', attrPoint: '+1 bod do atribut≈Ø', skillPoint: '+1 skill point', fullHp: 'Pln√© HP'
                    };
                    title = lvlTexts.title;
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 3rem; color: #ffd700;">${state.char.level}</div>
                            <p style="color: #888;">${lvlTexts.current}</p>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">üìã ${lvlTexts.whatItMeans}</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">${lvlTexts.levelExplain}</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">üìä ${lvlTexts.progress}</h4>
                            <p>XP: <span style="color: #8bc34a;">${state.char.xp}</span> / ${xpForNext}</p>
                            <div style="background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 0.5rem;">
                                <div style="background: linear-gradient(90deg, #4CAF50, #8bc34a); height: 100%; width: ${xpPercent}%;"></div>
                            </div>
                            <p style="color: #888; font-size: 0.8rem; margin-top: 0.5rem;">${xpPercent}% ${lvlTexts.toNextLevel}</p>
                            <p style="color: #666; font-size: 0.75rem; margin-top: 0.3rem;">üìà Celkov√© XP: ${totalXP.toLocaleString()}</p>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üéÅ ${lvlTexts.onLevelUp}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa;">
                                <li>${lvlTexts.attrPoint}</li>
                                <li>${lvlTexts.skillPoint}</li>
                                <li>${lvlTexts.fullHp}</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'hp':
                    const hpPercent = Math.floor((state.char.hp / state.char.maxHp) * 100);
                    const hpColor = hpPercent > 60 ? '#4CAF50' : hpPercent > 30 ? '#ff9800' : '#f44336';
                    const endurance = state.char.stats?.endurance || 5;
                    title = '‚ù§Ô∏è Vitalita (HP)';
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2.5rem; color: ${hpColor};">${Math.round(state.char.hp)} / ${state.char.maxHp}</div>
                            <p style="color: #888;">Aktu√°ln√≠ zdrav√≠</p>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">üìã Co to znamen√°:</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">Vitalita (HP) je tv√© zdrav√≠. Kdy≈æ klesne na 0, zem≈ôe≈° a ztrat√≠≈° ƒç√°st invent√°≈ôe!</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">üìà V√Ωpoƒçet max HP:</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>Z√°klad: 100 HP</li>
                                <li>+10 HP za ka≈æd√Ω bod V√Ωdr≈æe nad 5</li>
                                <li>Tv√° V√Ωdr≈æ: ${endurance}</li>
                            </ul>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üíä Jak l√©ƒçit:</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>ü©π Obvazy, l√©k√°rniƒçky, stimpaky</li>
                                <li>üí§ Sp√°nek (+50 HP)</li>
                                <li>üè• Nemocnice (prozkoumej)</li>
                                <li>‚¨ÜÔ∏è Level up (pln√© HP)</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'weight':
                    const weightPercent = Math.floor((state.carryWeight / state.maxCarryWeight) * 100);
                    const weightColor = weightPercent > 90 ? '#f44336' : weightPercent > 70 ? '#ff9800' : '#4CAF50';
                    const str = state.char.stats?.strength || 5;
                    const hasBackpack = state.inv?.some(i => i.bonus === 'capacity') || false;
                    const packRatLevel = state.skills?.['pack_rat'] || 0;
                    const weightTexts = {
                        title: 'üì¶ N√°klad (Nosnost)', currentLoad: 'Aktu√°ln√≠ z√°tƒõ≈æ', whatItMeans: 'Co to znamen√°:',
                        loadExplain: 'Kolik m≈Ø≈æe≈° un√©st. Kdy≈æ jsi p≈ôet√≠≈æen√Ω, nem≈Ø≈æe≈° sb√≠rat dal≈°√≠ vƒõci!',
                        calculation: 'V√Ωpoƒçet nosnosti:', base: 'Z√°klad:', perStr: 'za ka≈æd√Ω bod S√≠ly nad 5',
                        yourStr: 'Tv√° S√≠la:', backpack: 'Batoh:', noBackpack: 'nem√°≈°',
                        tips: 'Tipy:', tipStr: 'Zvy≈° S√≠lu pro v√≠c nosnosti', tipBackpack: 'Vyrob si üéí Batoh (+20 kg)',
                        tipStash: 'Ulo≈æ vƒõci do √∫krytu', tipSkill: 'Nauƒç se skill Pack Rat'
                    };
                    title = weightTexts.title;
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2.5rem; color: ${weightColor};">${(state.carryWeight || 0).toFixed(1)} / ${state.maxCarryWeight || 50} kg</div>
                            <p style="color: #888;">${weightTexts.currentLoad}</p>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">üìã ${weightTexts.whatItMeans}</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">${weightTexts.loadExplain}</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">üìà ${weightTexts.calculation}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>${weightTexts.base} 50 kg</li>
                                <li>+5 kg ${weightTexts.perStr}</li>
                                <li>${weightTexts.yourStr} ${str} (+${Math.max(0, (str - 5) * 5)} kg)</li>
                                ${hasBackpack ? '<li style="color: #8bc34a;">üéí ' + weightTexts.backpack + ' +20 kg</li>' : '<li style="color: #666;">üéí ' + weightTexts.backpack + ' ' + weightTexts.noBackpack + '</li>'}
                                ${packRatLevel > 0 ? `<li style="color: #8bc34a;">üì¶ Pack Rat skill: +${packRatLevel * 10} kg</li>` : ''}
                            </ul>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üí° ${weightTexts.tips}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>${weightTexts.tipStr}</li>
                                <li>${weightTexts.tipBackpack}</li>
                                <li>${weightTexts.tipStash}</li>
                                <li>${weightTexts.tipSkill}</li>
                            </ul>
                        </div>
                    `;
                    break;
                    
                case 'time':
                    const totalSec = state.time.totalElapsed || 0;
                    const hoursPlayed = Math.floor(totalSec / 3600);
                    const minsPlayed = Math.floor((totalSec % 3600) / 60);
                    const secsToNextDay = 86400 - (totalSec % 86400);
                    const hoursToNext = Math.floor(secsToNextDay / 3600);
                    const minsToNext = Math.floor((secsToNextDay % 3600) / 60);
                    
                    title = 'üïê ƒåas';
                    const timeTexts = {
                        day: 'Den', whatItMeans: 'Co to znamen√°:',
                        clockExplain: 'Hodiny ukazuj√≠ re√°ln√Ω ƒças. Dny se poƒç√≠taj√≠ z odehran√©ho ƒçasu (24h hran√≠ = 1 den).',
                        playedTime: 'Odehran√Ω ƒças:', untilNextDay: 'Do dal≈°√≠ho dne:',
                        dailyCycles: 'Denn√≠ cykly:', dayTime: 'Den (lep≈°√≠ viditelnost)', nightTime: 'Noc (nebezpeƒçnƒõj≈°√≠)',
                        dailyQuestsReset: 'Ka≈æd√Ω den se resetuj√≠ denn√≠ questy', settlementProduces: 'Osada produkuje suroviny dennƒõ',
                        yourStats: 'Tv√© statistiky:', survived: 'P≈ôe≈æil jsi', days: 'dn√≠', enemiesKilled: 'Zabito nep≈ô√°tel:', itemsCrafted: 'Vyrobeno vƒõc√≠:'
                    };
                    content = `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2rem;">${timeTexts.day} ${state.time.days}</div>
                            <div style="font-size: 1.5rem; color: #888;">${String(state.time.hours).padStart(2, '0')}:${String(state.time.mins).padStart(2, '0')}</div>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #ffd700;">üìã ${timeTexts.whatItMeans}</h4>
                            <p style="color: #aaa; font-size: 0.9rem;">${timeTexts.clockExplain}</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">‚è±Ô∏è ${timeTexts.playedTime}</h4>
                            <p style="color: #8bc34a; font-size: 1.2rem; text-align: center;">${hoursPlayed}h ${minsPlayed}m</p>
                            <p style="color: #888; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">${timeTexts.untilNextDay} ${hoursToNext}h ${minsToNext}m</p>
                        </div>
                        
                        <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">‚è∞ ${timeTexts.dailyCycles}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>üåÖ 6:00-18:00 - ${timeTexts.dayTime}</li>
                                <li>üåô 18:00-6:00 - ${timeTexts.nightTime}</li>
                                <li>${timeTexts.dailyQuestsReset}</li>
                                <li>${timeTexts.settlementProduces}</li>
                            </ul>
                        </div>
                        
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üìä ${timeTexts.yourStats}</h4>
                            <ul style="margin: 0; padding-left: 1.2rem; color: #aaa; font-size: 0.9rem;">
                                <li>${timeTexts.survived} ${state.time.days} ${timeTexts.days}</li>
                                <li>${timeTexts.enemiesKilled} ${state.stats?.kills || 0}</li>
                                <li>${timeTexts.itemsCrafted} ${state.stats?.itemsCrafted || 0}</li>
                            </ul>
                        </div>
                    `;
                    break;
            }
            
            showModal(title, content + `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">${t('ui', 'close')}</button>`);
        }
        
        // === TUTORI√ÅL SYST√âM ===
        const TUTORIAL_STEPS = [
            {
                id: 'welcome',
                title: 'V√≠tej v pustinƒõ!',
                subtitle: 'Tv√© dobrodru≈æstv√≠ zaƒç√≠n√°',
                text: 'Rok 2077. Nukle√°rn√≠ v√°lka zmƒõnila svƒõt v radioaktivn√≠ pustinu. Ty jsi jeden z m√°la p≈ôe≈æiv≈°√≠ch. Tv√Ωm √∫kolem je p≈ôe≈æ√≠t, naj√≠t ostatn√≠ a mo≈æn√°... zachr√°nit lidstvo.',
                icon: '‚ò¢Ô∏è',
                tips: ['Hra se automaticky ukl√°d√°', 'M≈Ø≈æe≈° hr√°t i offline', 'Tutorial m≈Ø≈æe≈° kdykoli p≈ôeskoƒçit'],
                animation: 'pulse'
            },
            {
                id: 'stats',
                title: 'Tv√© p≈ôe≈æit√≠ z√°vis√≠ na...',
                subtitle: '≈Ωivotn√≠ statistiky',
                text: 'Sleduj tyto 4 kritick√© ukazatele. Pokud kter√Ωkoli klesne na 0, zaƒçne≈° um√≠rat!',
                icon: 'üìä',
                features: [
                    { icon: '‚ù§Ô∏è', name: 'HP', desc: 'Zdrav√≠ - l√©ƒç√≠ se l√©k√°rniƒçkami a odpoƒçinkem', color: '#f44336' },
                    { icon: 'üçñ', name: 'Hlad', desc: 'Kles√° ƒçasem - jez j√≠dlo!', color: '#ff9800' },
                    { icon: 'üíß', name: '≈Ω√≠ze≈à', desc: 'Kles√° rychleji ne≈æ hlad - pij!', color: '#2196f3' },
                    { icon: '‚ò¢Ô∏è', name: 'Radiace', desc: 'Zvy≈°uje se v nebezpeƒçn√Ωch z√≥n√°ch', color: '#8bc34a' }
                ],
                highlight: '.stats-bar',
                animation: 'highlight'
            },
            {
                id: 'inventory',
                title: 'Tv√° v√Ωbava',
                subtitle: 'Z√°lo≈æka V√ùBAVA',
                text: 'Zde najde≈° v≈°echny sv√© p≈ôedmƒõty. Na zaƒç√°tku m√°≈° z√°kladn√≠ vybaven√≠ - pou≈æ√≠vej ho moud≈ôe!',
                icon: 'üéí',
                features: [
                    { icon: '‚öïÔ∏è', name: 'L√©k√°rniƒçka', desc: 'Obnov√≠ HP', color: '#f44336' },
                    { icon: 'ü•´', name: 'J√≠dlo', desc: 'Obnov√≠ hlad', color: '#ff9800' },
                    { icon: 'üíß', name: 'Voda', desc: 'Obnov√≠ ≈æ√≠ze≈à', color: '#2196f3' },
                    { icon: '‚öîÔ∏è', name: 'Zbranƒõ', desc: 'Vyber a vyzbrojit!', color: '#9c27b0' }
                ],
                highlight: '[data-tab="inv"]',
                action: 'Klikni na V√ùBAVA a prozkoumej invent√°≈ô'
            },
            {
                id: 'map',
                title: 'Prozkoumej svƒõt',
                subtitle: 'Z√°lo≈æka MAPA',
                text: 'Mapa ukazuje celou pustinu. Ka≈æd√Ω hexagon je jin√° lokace - mƒõsta, lesy, ruiny, hory...',
                icon: 'üó∫Ô∏è',
                features: [
                    { icon: 'üè†', name: '√ökryt', desc: 'Tv√° z√°kladna - bezpeƒç√≠', color: '#4CAF50' },
                    { icon: 'üèôÔ∏è', name: 'Mƒõsta', desc: 'Obchody, NPC, questy', color: '#2196f3' },
                    { icon: 'üèöÔ∏è', name: 'Ruiny', desc: 'Loot ale i nebezpeƒç√≠', color: '#ff9800' },
                    { icon: '‚ò†Ô∏è', name: 'Nebezpeƒçn√©', desc: 'Radiace, mutanti', color: '#f44336' }
                ],
                highlight: '[data-tab="map"]',
                action: 'Prozkoumej mapu a vyber c√≠l cesty'
            },
            {
                id: 'combat',
                title: 'Bojov√Ω syst√©m',
                subtitle: '2 akce za kolo',
                text: 'Boj je tahov√Ω. Ka≈æd√© kolo m√°≈° 2 akce - kombinuj je strategicky!',
                icon: '‚öîÔ∏è',
                features: [
                    { icon: 'üö∂', name: 'Pohyb', desc: '1 akce - p≈ôibl√≠≈æ se/oddal', color: '#2196f3' },
                    { icon: '‚öîÔ∏è', name: '√ötok', desc: '1 akce - zra≈à nep≈ô√≠tele', color: '#f44336' },
                    { icon: 'üõ°Ô∏è', name: 'Obrana', desc: 'V≈°echny akce - +50-100% DEF', color: '#4CAF50' },
                    { icon: 'üîÑ', name: 'V√Ωmƒõna', desc: '1 akce - zmƒõ≈à zbra≈à', color: '#ff9800' }
                ],
                tips: ['St≈ôeln√© zbranƒõ = neomezen√Ω dosah', 'Melee zbranƒõ = mus√≠≈° b√Ωt bl√≠zko', 'Munice se spot≈ôebov√°v√°!']
            },
            {
                id: 'companion',
                title: 'Najdi spoleƒçn√≠ka!',
                subtitle: 'Nejsi v tom s√°m',
                text: 'P≈ôi prvn√≠ cestƒõ potk√°≈° opu≈°tƒõn√©ho psa. P≈òIJMI HO! Spoleƒçn√≠ci jsou v pustinƒõ neoceniteln√≠.',
                icon: 'üêï',
                features: [
                    { icon: '‚öîÔ∏è', name: 'Bojuj√≠', desc: 'Pom√°haj√≠ v boji', color: '#f44336' },
                    { icon: 'üîç', name: 'Hledaj√≠', desc: 'Bonus k lootu', color: '#ff9800' },
                    { icon: '‚ù§Ô∏è', name: 'Loajalita', desc: 'Krm je pro bonusy', color: '#e91e63' },
                    { icon: 'üìú', name: 'Questy', desc: 'Maj√≠ vlastn√≠ p≈ô√≠bƒõhy', color: '#9c27b0' }
                ],
                tips: ['Spoleƒçn√≠ci pot≈ôebuj√≠ 1üçñ + 1üíß dennƒõ', 'Krmen√≠m zvy≈°uje≈° loajalitu', 'Vysok√° loajalita = speci√°ln√≠ questy'],
                important: true
            },
            {
                id: 'settlement',
                title: 'Vybuduj osadu',
                subtitle: 'Z√°lo≈æka OSADA',
                text: 'Tv√° osada je kl√≠ƒçem k dlouhodob√©mu p≈ôe≈æit√≠. Stav budovy, naj√≠mej osadn√≠ky!',
                icon: 'üèòÔ∏è',
                features: [
                    { icon: 'üèóÔ∏è', name: 'Budovy', desc: 'Produkce, obrana, bonusy', color: '#795548' },
                    { icon: 'üë•', name: 'Osadn√≠ci', desc: 'Pracuj√≠ za tebe', color: '#2196f3' },
                    { icon: 'üí∞', name: 'Ekonomika', desc: '√ödr≈æba a p≈ô√≠jmy', color: '#ffd700' },
                    { icon: '‚öîÔ∏è', name: 'Obrana', desc: 'Bra≈à se n√°jezd≈Øm', color: '#f44336' }
                ],
                highlight: '[data-tab="base"]',
                tips: ['Stavitel sni≈æuje n√°klady na √∫dr≈æbu', 'Obchodn√≠k generuje pasivn√≠ p≈ô√≠jem', 'Farm√°≈ô a nosiƒç vody = z√°kladn√≠ z√°soby']
            },
            {
                id: 'quests',
                title: '7 typ≈Ø quest≈Ø',
                subtitle: 'V≈ædy je co dƒõlat',
                text: 'Hra nab√≠z√≠ obrovsk√© mno≈æstv√≠ √∫kol≈Ø. Sleduj Quest Tracker na mapƒõ!',
                icon: 'üìú',
                features: [
                    { icon: 'üìÖ', name: 'Denn√≠', desc: 'Obnovuj√≠ se ka≈æd√Ω den', color: '#4CAF50' },
                    { icon: 'üí¨', name: 'NPC', desc: 'Od postav ve mƒõstech', color: '#2196f3' },
                    { icon: 'üèòÔ∏è', name: 'Osadn√≠ci', desc: 'Pro tv√© obyvatele', color: '#795548' },
                    { icon: '‚è±Ô∏è', name: 'ƒåasovan√©', desc: 'Limitovan√Ω ƒças!', color: '#f44336' }
                ],
                tips: ['Hlavn√≠ p≈ô√≠bƒõh odemyk√° nov√© oblasti', 'Detektivn√≠ questy = logick√© h√°danky', 'Spoleƒçn√≠ci maj√≠ vlastn√≠ quest linie']
            },
            {
                id: 'tips',
                title: 'Zlat√© rady p≈ôe≈æiv≈°√≠ho',
                subtitle: 'Zapamatuj si!',
                text: 'Tƒõchto 5 rad ti zachr√°n√≠ ≈æivot:',
                icon: 'üí°',
                bigTips: [
                    { num: 1, tip: 'P≈òIJMI PSA p≈ôi prvn√≠ cestƒõ!', icon: 'üêï' },
                    { num: 2, tip: 'Jez a pij PRAVIDELNƒö', icon: 'üçñ' },
                    { num: 3, tip: '≈†et≈ôi RadAway na radiaƒçn√≠ z√≥ny', icon: '‚ò¢Ô∏è' },
                    { num: 4, tip: 'Stav osadu CO NEJD≈ò√çVE', icon: 'üèòÔ∏è' },
                    { num: 5, tip: 'Prozkoum√°vej - loot je v≈°ude!', icon: 'üîç' }
                ]
            },
            {
                id: 'ready',
                title: 'Jsi p≈ôipraven!',
                subtitle: 'Hodnƒõ ≈°tƒõst√≠, p≈ôe≈æiv≈°√≠',
                text: 'Teƒè v√≠≈° v≈°e pot≈ôebn√©. Pustina ƒçek√°. Tv≈Øj osud je v tv√Ωch rukou.',
                icon: 'üéì',
                final: true
            }
        ];
        
        function showTutorial(stepIndex = 0) {
            if (stepIndex >= TUTORIAL_STEPS.length) {
                state.tutorialComplete = true;
                saveGame();
                closeModal();
                return;
            }
            
            const step = TUTORIAL_STEPS[stepIndex];
            const progress = Math.round(((stepIndex + 1) / TUTORIAL_STEPS.length) * 100);
            
            // Zv√Ωrazni element pokud existuje
            if (step.highlight) {
                document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
                const el = document.querySelector(step.highlight);
                if (el) {
                    el.classList.add('tutorial-highlight');
                    el.style.animation = 'tutorialPulse 1s ease-in-out infinite';
                    setTimeout(() => {
                        el.style.animation = '';
                        el.classList.remove('tutorial-highlight');
                    }, 5000);
                }
            }
            
            // Generuj features HTML
            let featuresHtml = '';
            if (step.features) {
                featuresHtml = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin: 1rem 0;">
                        ${step.features.map(f => `
                            <div style="background: linear-gradient(135deg, ${f.color}22 0%, #1a1a1a 100%); padding: 0.6rem; border-radius: 6px; border-left: 3px solid ${f.color};">
                                <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.2rem;">
                                    <span style="font-size: 1.2rem;">${f.icon}</span>
                                    <strong style="color: ${f.color};">${f.name}</strong>
                                </div>
                                <div style="font-size: 0.75rem; color: #999;">${f.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Generuj tips HTML
            let tipsHtml = '';
            if (step.tips) {
                tipsHtml = `
                    <div style="background: #1a1a0a; padding: 0.8rem; border-radius: 6px; margin-top: 1rem; border: 1px solid #4a4a2a;">
                        <div style="color: #ffd700; font-size: 0.8rem; margin-bottom: 0.5rem;">üí° Tipy:</div>
                        ${step.tips.map(t => `<div style="color: #ccc; font-size: 0.8rem; margin-left: 1rem;">‚Ä¢ ${t}</div>`).join('')}
                    </div>
                `;
            }
            
            // Generuj big tips HTML pro posledn√≠ krok
            let bigTipsHtml = '';
            if (step.bigTips) {
                bigTipsHtml = `
                    <div style="margin: 1rem 0;">
                        ${step.bigTips.map(t => `
                            <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.6rem; background: linear-gradient(90deg, #2a2a1a 0%, #1a1a1a 100%); border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #ffd700;">
                                <div style="background: #ffd700; color: #000; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;">${t.num}</div>
                                <span style="font-size: 1.3rem;">${t.icon}</span>
                                <span style="color: #fff; font-size: 0.9rem;">${t.tip}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Action HTML
            let actionHtml = '';
            if (step.action) {
                actionHtml = `
                    <div style="background: linear-gradient(90deg, #1a3a1a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 6px; margin-top: 1rem; border: 1px solid #4CAF50; text-align: center;">
                        <span style="color: #8bc34a;">üëÜ ${step.action}</span>
                    </div>
                `;
            }
            
            // Final step special content
            let finalHtml = '';
            if (step.final) {
                finalHtml = `
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <div style="font-size: 4rem; margin-bottom: 1rem; animation: bounce 1s ease infinite;">üéì</div>
                        <div style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <div style="color: #fff; font-size: 1.1rem; font-weight: bold;">‚úì Tutorial dokonƒçen!</div>
                            <div style="color: #c8e6c9; font-size: 0.85rem; margin-top: 0.3rem;">Kdykoli ho m≈Ø≈æe≈° spustit znovu z Termin√°lu (üìü)</div>
                        </div>
                    </div>
                `;
            }
            
            showModal('', `
                <style>
                    @keyframes tutorialPulse {
                        0%, 100% { box-shadow: 0 0 10px 2px #ffd700; }
                        50% { box-shadow: 0 0 25px 8px #ffd700; }
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    @keyframes fadeInUp {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                </style>
                <div style="background: linear-gradient(180deg, #0a1a0a 0%, #1a1a1a 100%); border: 2px solid #4CAF50; border-radius: 12px; padding: 0; overflow: hidden; animation: fadeInUp 0.3s ease;">
                    <!-- Progress bar -->
                    <div style="height: 6px; background: #1a1a1a; position: relative;">
                        <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #4CAF50, #8bc34a); transition: width 0.5s ease; border-radius: 0 3px 3px 0;"></div>
                        <div style="position: absolute; right: 8px; top: 10px; font-size: 0.7rem; color: #666;">${stepIndex + 1}/${TUTORIAL_STEPS.length}</div>
                    </div>
                    
                    <!-- Header -->
                    <div style="padding: 1.2rem; text-align: center; background: linear-gradient(180deg, #0a2a0a 0%, transparent 100%); ${step.important ? 'border-bottom: 2px solid #ffd700;' : ''}">
                        <div style="font-size: 3rem; ${step.animation === 'pulse' ? 'animation: bounce 2s ease infinite;' : ''}">${step.icon}</div>
                        <h2 style="color: #8bc34a; margin: 0.5rem 0 0.2rem 0; font-size: 1.3rem;">${step.title}</h2>
                        <div style="color: #666; font-size: 0.85rem;">${step.subtitle}</div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 1rem 1.2rem;">
                        <p style="color: #ccc; line-height: 1.7; margin: 0; font-size: 0.9rem; text-align: center;">${step.text}</p>
                        ${featuresHtml}
                        ${bigTipsHtml}
                        ${actionHtml}
                        ${tipsHtml}
                        ${finalHtml}
                    </div>
                    
                    <!-- Navigation -->
                    <div style="padding: 1rem; background: #0a0a0a; border-top: 1px solid #333;">
                        <div style="display: grid; grid-template-columns: ${stepIndex > 0 ? '1fr 2fr' : '1fr'}; gap: 0.5rem;">
                            ${stepIndex > 0 ? `
                                <button class="btn" onclick="showTutorial(${stepIndex - 1})" style="background: #333; padding: 0.7rem;">
                                    ‚Üê Zpƒõt
                                </button>
                            ` : ''}
                            <button class="btn" onclick="showTutorial(${stepIndex + 1})" style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); padding: 0.7rem; font-weight: bold;">
                                ${step.final ? 'üéÆ Zaƒç√≠t hr√°t!' : 'Dal≈°√≠ ‚Üí'}
                            </button>
                        </div>
                        ${!step.final ? `
                            <div style="text-align: center; margin-top: 0.8rem;">
                                <span onclick="state.tutorialComplete = true; saveGame(); closeModal();" style="color: #555; font-size: 0.75rem; cursor: pointer;">P≈ôeskoƒçit tutorial</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);
        }
        
        function showGameInfo() {
            const texts = {
                title: 'Post-apokalyptick√° Survival RPG',
                version: 'Verze',
                story: 'Rok 2077. Nukle√°rn√≠ v√°lka zmƒõnila svƒõt v radioaktivn√≠ pustinu. Mƒõsta jsou v trosk√°ch, mutanti se potuluj√≠ krajinou a z√°soby doch√°zej√≠. Ty jsi jeden z m√°la p≈ôe≈æiv≈°√≠ch...',
                whatAwaits: 'Co tƒõ ƒçek√°?',
                combat: 'Tahov√© souboje',
                combatDesc: 'Bojuj s mutanty, bandity a monstry. Strategick√Ω boj s 2 akcemi za kolo.',
                world: 'Obrovsk√Ω svƒõt',
                worldDesc: '100+ lokac√≠ k prozkoum√°n√≠ - mƒõsta, ruiny, jeskynƒõ, bunkry, laborato≈ôe...',
                settlement: 'Budov√°n√≠ osady',
                settlementDesc: 'Stav budovy, naj√≠mej osadn√≠ky, bra≈à se n√°jezd≈Øm. Tv√° vlastn√≠ komunita!',
                companions: 'Spoleƒçn√≠ci',
                companionsDesc: 'Najdi psa, koƒçku, robota nebo lidsk√© spoleƒçn√≠ky. Ka≈æd√Ω m√° unik√°tn√≠ schopnosti!',
                crafting: 'Crafting & loot',
                craftingDesc: '119 recept≈Ø, 5 rarit p≈ôedmƒõt≈Ø, zbranƒõ, zbroje, l√©ky, j√≠dlo...',
                quests: '7 quest syst√©m≈Ø',
                casino: '9 casino her',
                classes: '9 povol√°n√≠',
                pvp: 'PvP boje',
                autosave: 'Auto-save',
                understand: 'Rozum√≠m, chci hr√°t!'
            };
            
            showModal('', `
                <div style="background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%); border: 2px solid var(--toxic-green); border-radius: 12px; padding: 0; overflow: hidden;">
                    <!-- HEADER -->
                    <div style="background: linear-gradient(180deg, #0a2a0a 0%, #1a1a1a 100%); padding: 1.5rem; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 0.5rem;">‚ò¢Ô∏è</div>
                        <h2 style="color: var(--toxic-green); margin: 0; text-shadow: 0 0 10px var(--toxic-green);">${texts.title}</h2>
                        <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">${texts.version} ${GAME_VERSION}</div>
                    </div>
                    
                    <!-- P≈ò√çBƒöH -->
                    <div style="padding: 1.2rem; border-bottom: 1px solid #333;">
                        <p style="color: #ccc; line-height: 1.8; margin: 0; font-size: 0.95rem; text-align: center;">
                            <em>${texts.story}</em>
                        </p>
                    </div>
                    
                    <!-- CO Tƒö ƒåEK√Å -->
                    <div style="padding: 1.2rem;">
                        <h3 style="color: #ffd700; margin: 0 0 1rem 0; text-align: center;">üéÆ ${texts.whatAwaits}</h3>
                        
                        <div style="display: grid; gap: 0.8rem;">
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #f44336;">
                                <span style="font-size: 2rem;">‚öîÔ∏è</span>
                                <div>
                                    <div style="color: #f44336; font-weight: bold;">${texts.combat}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.combatDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #2196f3;">
                                <span style="font-size: 2rem;">üó∫Ô∏è</span>
                                <div>
                                    <div style="color: #2196f3; font-weight: bold;">${texts.world}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.worldDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #4CAF50;">
                                <span style="font-size: 2rem;">üèòÔ∏è</span>
                                <div>
                                    <div style="color: #4CAF50; font-weight: bold;">${texts.settlement}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.settlementDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #ff9800;">
                                <span style="font-size: 2rem;">üêï</span>
                                <div>
                                    <div style="color: #ff9800; font-weight: bold;">${texts.companions}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.companionsDesc}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; align-items: center; background: #1a1a1a; padding: 0.8rem; border-radius: 8px; border-left: 3px solid #9c27b0;">
                                <span style="font-size: 2rem;">‚öóÔ∏è</span>
                                <div>
                                    <div style="color: #9c27b0; font-weight: bold;">${texts.crafting}</div>
                                    <div style="color: #888; font-size: 0.8rem;">${texts.craftingDesc}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- STATS -->
                    <div style="background: #0a0a0a; padding: 1rem; border-top: 1px solid #333;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1rem; font-size: 0.75rem; color: #666;">
                            <span>üìú ${texts.quests}</span>
                            <span>üé∞ ${texts.casino}</span>
                            <span>üë§ ${texts.classes}</span>
                            <span>üèÜ ${texts.pvp}</span>
                            <span>üíæ ${texts.autosave}</span>
                        </div>
                    </div>
                    
                    <!-- BUTTON -->
                    <div style="padding: 1rem;">
                        <button class="btn" onclick="closeModal()" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); padding: 0.8rem; font-size: 1rem;">
                            ‚úì ${texts.understand}
                        </button>
                    </div>
                </div>
            `);
        }
        
        function toggleMobileNotifications() {
            if (MobileNotifications.enabled) {
                // U≈æ je povoleno - info + test
                showModal('üîî Notifikace', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîî</div>
                        <h3 style="color: #4CAF50;">Notifikace jsou povoleny!</h3>
                        <p style="color: #888; margin: 1rem 0;">Bude≈° dost√°vat upozornƒõn√≠ na:</p>
                        <div style="text-align: left; background: #1a1a1a; padding: 1rem; border-radius: 8px; font-size: 0.85rem;">
                            <div>‚ù§Ô∏è Kritick√© zdrav√≠</div>
                            <div>üçñ Kritick√Ω hlad</div>
                            <div>üíß Kritick√° ≈æ√≠ze≈à</div>
                            <div>üêï Hladov√≠ spoleƒçn√≠ci</div>
                            <div>‚öîÔ∏è N√°jezdy na osadu</div>
                            <div>üåÖ Nov√Ω den</div>
                        </div>
                        <button class="btn" onclick="MobileNotifications.test(); notifySuccess('Notifikace odesl√°na!', 'Zkontroluj notifikaƒçn√≠ centrum')" style="width: 100%; margin-top: 1rem; background: #2196f3;">üß™ Testovat notifikaci</button>
                        <p style="color: #666; font-size: 0.8rem; margin-top: 1rem;">Pro vypnut√≠ jdi do nastaven√≠ prohl√≠≈æeƒçe/aplikace.</p>
                    </div>
                    <button class="btn" onclick="showGameInfo()" style="width: 100%; margin-top: 1rem;">${'Zpƒõt'}</button>
                `);
            } else {
                // Po≈æ√°dej o povolen√≠
                MobileNotifications.requestPermission().then(function(granted) {
                    if (granted) {
                        showModal('üîî Notifikace povoleny!', `
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                                <h3 style="color: #4CAF50;">Skvƒõle!</h3>
                                <p style="color: #888;">Teƒè bude≈° dost√°vat upozornƒõn√≠ i kdy≈æ je aplikace vypnut√°.</p>
                            </div>
                            <button class="btn" onclick="showGameInfo()" style="width: 100%; margin-top: 1rem; background: #4CAF50;">‚Üê Zpƒõt do termin√°lu</button>
                        `);
                        
                        // Test notifikace
                        setTimeout(function() {
                            MobileNotifications.send('‚ò¢Ô∏è Notifikace aktivn√≠!', {
                                body: 'Teƒè bude≈° dost√°vat d≈Øle≈æit√° upozornƒõn√≠.'
                            });
                        }, 1000);
                    } else {
                        showModal('üîï Notifikace zam√≠tnuty', `
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                                <h3 style="color: #f44336;">Notifikace nepovoleny</h3>
                                <p style="color: #888;">Pro povolen√≠ notifikac√≠ jdi do nastaven√≠ prohl√≠≈æeƒçe/aplikace a povol je ruƒçnƒõ.</p>
                            </div>
                            <button class="btn" onclick="showGameInfo()" style="width: 100%; margin-top: 1rem;">${'Zpƒõt'}</button>
                        `);
                    }
                });
            }
        }
        
        function updateGame() {
            showModal('üîÑ Reload hry', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîÑ</div>
                    <h3 style="margin: 0 0 1rem 0; color: var(--toxic-green);">Naƒç√≠st zmƒõny</h3>
                    
                    <div style="background: #1a4d1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: left;">
                        <p style="margin: 0; color: #8bc34a;">‚úÖ Tv≈Øj save z≈Østane zachov√°n!</p>
                        <p style="margin: 0.5rem 0 0 0; color: #888; font-size: 0.85rem;">Save je ulo≈æen√Ω v prohl√≠≈æeƒçi (localStorage)</p>
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.9rem; margin-bottom: 1rem;">
                        Str√°nka se znovu naƒçte a aplikuj√≠ se zmƒõny v k√≥du.
                    </p>
                </div>
                
                <button class="btn" onclick="forceReload()" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust);">üîÑ Reload teƒè</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">‚úó Zru≈°it</button>
            `);
        }
        
        function forceReload() {
            // Ulo≈æ√≠me p≈ôed reloadem
            saveGame();
            // Reload str√°nky (zachov√° localStorage)
            location.reload();
        }
        
        // === EXPORT / IMPORT SAVE ===
        function showExportImport() {
            showModal('üíæ P≈ôenos postavy', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üíæ</div>
                    <p style="color: #888;">P≈ôenes svou postavu mezi za≈ô√≠zen√≠mi</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="exportSave()" style="background: #1565c0; padding: 1rem;">
                        <div style="font-size: 1.5rem;">üì§</div>
                        <div style="font-weight: bold;">Exportovat save</div>
                        <div style="font-size: 0.75rem; color: #aaa;">Zkop√≠ruj k√≥d do schr√°nky</div>
                    </button>
                    
                    <button class="btn" onclick="showImportSave()" style="background: #2e7d32; padding: 1rem;">
                        <div style="font-size: 1.5rem;">üì•</div>
                        <div style="font-weight: bold;">Importovat save</div>
                        <div style="font-size: 0.75rem; color: #aaa;">Vlo≈æ k√≥d z jin√©ho za≈ô√≠zen√≠</div>
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">${'Zpƒõt'}</button>
            `);
        }
        
        function exportSave() {
            try {
                saveGame(true); // Ulo≈æit aktu√°ln√≠ stav (ti≈°e)
                
                // Exportuj p≈ô√≠mo aktu√°ln√≠ state objekt - to je nejspolehlivƒõj≈°√≠
                const exportData = JSON.parse(JSON.stringify(state)); // Deep copy
                
                // P≈ôidej metadata pro import
                exportData._exportVersion = 2;
                exportData._exportTime = Date.now();
                exportData._exportedFrom = window.location.hostname || 'local';
                
                // Zak√≥duj do base64 pro bezpeƒçn√Ω p≈ôenos
                const saveData = JSON.stringify(exportData);
                const encoded = btoa(unescape(encodeURIComponent(saveData)));
                
                // P≈ôiprav info o postavƒõ
                const charName = state.char.name || 'Nezn√°m√Ω';
                const charLevel = state.char.level || 1;
                const invCount = state.inv?.length || 0;
                const gold = state.money || 0;
                
                // Zkus zkop√≠rovat do schr√°nky
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(encoded).then(function() {
                        showModal('üì§ Export √∫spƒõ≈°n√Ω!', 
                            '<div style="text-align: center; margin-bottom: 1rem;">' +
                                '<div style="font-size: 3rem;">‚úÖ</div>' +
                                '<p style="color: #4caf50; font-weight: bold;">Save zkop√≠rov√°n do schr√°nky!</p>' +
                            '</div>' +
                            '<div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                                '<p style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.85rem;">Postava:</p>' +
                                '<p style="color: #ffd700; margin: 0; font-size: 1.1rem;">' + charName + ' (Lv.' + charLevel + ')</p>' +
                                '<p style="color: #888; margin: 0.3rem 0 0 0; font-size: 0.8rem;">üí∞ ' + gold + ' gold | üéí ' + invCount + ' item≈Ø</p>' +
                            '</div>' +
                            '<p style="color: #888; font-size: 0.85rem; text-align: center;">' +
                                'Teƒè otev≈ôi hru na druh√©m za≈ô√≠zen√≠ a pou≈æij "Importovat save"' +
                            '</p>' +
                            '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>'
                        );
                    }).catch(function() {
                        showExportCode(encoded);
                    });
                } else {
                    showExportCode(encoded);
                }
            } catch (e) {
                notifyError('Chyba exportu', e.message);
                console.error('Export error:', e);
            }
        }
        
        function showExportCode(code) {
            showModal('üì§ Export - ruƒçn√≠ kop√≠rov√°n√≠', 
                '<div style="text-align: center; margin-bottom: 1rem;">' +
                    '<p style="color: #ff9800;">' + ('Automatick√© kop√≠rov√°n√≠ nefunguje.') + '</p>' +
                    '<p style="color: #888; font-size: 0.85rem;">' + ('Oznaƒç a zkop√≠ruj k√≥d ruƒçnƒõ:') + '</p>' +
                '</div>' +
                '<textarea id="exportCode" readonly style="width: 100%; height: 150px; background: #0a0a0a; color: #4caf50; border: 1px solid #333; padding: 0.5rem; font-family: monospace; font-size: 0.7rem; resize: none;">' + code + '</textarea>' +
                '<button class="btn" onclick="document.getElementById(\'exportCode\').select()" style="width: 100%; margin-top: 0.5rem; background: #1565c0;">üìã ' + ('Oznaƒçit v≈°e') + '</button>' +
                '<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">' + ('Zpƒõt') + '</button>'
            );
        }
        
        function showImportSave() {
            showModal('üì• Import save', 
                '<div style="text-align: center; margin-bottom: 1rem;">' +
                    '<div style="font-size: 2rem;">üì•</div>' +
                    '<p style="color: #888;">' + ('Vlo≈æ k√≥d exportovan√Ω z jin√©ho za≈ô√≠zen√≠:') + '</p>' +
                '</div>' +
                '<textarea id="importCode" placeholder="' + ('Vlo≈æ sem exportovan√Ω k√≥d...') + '" style="width: 100%; height: 120px; background: #0a0a0a; color: #4caf50; border: 1px solid #333; padding: 0.5rem; font-family: monospace; font-size: 0.8rem; resize: none;"></textarea>' +
                '<div style="background: #3a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #c62828;">' +
                    '<p style="color: #f44336; margin: 0; font-size: 0.85rem;">‚ö†Ô∏è ' + ('Varov√°n√≠: Import p≈ôep√≠≈°e tvou aktu√°ln√≠ hru!') + '</p>' +
                '</div>' +
                '<button class="btn" id="importBtn" style="width: 100%; background: #2e7d32; margin-bottom: 0.5rem;">‚úì ' + ('Importovat') + '</button>' +
                '<button class="btn" onclick="showExportImport()" style="width: 100%; background: #555;">' + ('Zpƒõt') + '</button>'
            );
            
            // P≈ôidej event listener po renderov√°n√≠
            setTimeout(function() {
                var btn = document.getElementById('importBtn');
                if (btn) {
                    btn.onclick = importSave;
                }
            }, 100);
        }
        
        function importSave() {
            console.log('importSave called');
            try {
                var codeEl = document.getElementById('importCode');
                if (!codeEl) {
                    notifyError('Chyba!', 'Nenalezen input');
                    console.error('importCode element not found');
                    return;
                }
                
                var code = codeEl.value.trim();
                
                // Odstranƒõn√≠ neviditeln√Ωch znak≈Ø (BOM, zero-width spaces, atd.)
                code = code.replace(/[\u200B-\u200D\uFEFF\u00A0\u2060\u180E]/g, '');
                // Odstranƒõn√≠ v≈°ech whitespace znak≈Ø (mezery, nov√© ≈ô√°dky, taby)
                code = code.replace(/\s/g, '');
                
                console.log('Code length after cleanup:', code.length);
                
                if (!code) {
                    notifyError('Pr√°zdn√Ω k√≥d!', 'Vlo≈æ exportovan√Ω k√≥d');
                    return;
                }
                
                // Dek√≥duj z base64
                var decoded;
                try {
                    decoded = decodeURIComponent(escape(atob(code)));
                } catch(e) {
                    // Zkus je≈°tƒõ jednou odstranit p≈ô√≠padn√© probl√©my
                    try {
                        // Nƒõkdy se na konci p≈ôid√° = padding nav√≠c
                        var cleanCode = code.replace(/[^A-Za-z0-9+/=]/g, '');
                        decoded = decodeURIComponent(escape(atob(cleanCode)));
                    } catch(e2) {
                        notifyError('Neplatn√Ω k√≥d!', 'K√≥d obsahuje neplatn√© znaky. Zkus ho zkop√≠rovat znovu.');
                        console.error('Base64 decode error:', e, e2);
                        return;
                    }
                }
                
                var saveData;
                try {
                    saveData = JSON.parse(decoded);
                } catch(e) {
                    notifyError('Neplatn√Ω save!', 'Data nejsou platn√Ω JSON');
                    console.error('JSON parse error:', e);
                    return;
                }
                
                // Validace
                if (!saveData.char || !saveData.char.name) {
                    notifyError('Neplatn√Ω save!', 'Chyb√≠ data postavy');
                    return;
                }
                
                // D≈ÆLE≈ΩIT√â: Sma≈æ star√Ω save kompletnƒõ
                localStorage.removeItem('survival_hero_save');
                localStorage.removeItem('survival_hero_save_v2');
                localStorage.removeItem('survival_hero_backup');
                
                // P≈ôidej flag ≈æe jde o ƒçerstv√Ω import (aby se nemigrovala data)
                saveData._freshImport = true;
                saveData._importTime = Date.now();
                
                // Ulo≈æ do localStorage (star√° verze pro kompatibilitu)
                localStorage.setItem('survival_hero_save', JSON.stringify(saveData));
                
                // Ulo≈æ i ≈°ifrovanou verzi pokud je k dispozici
                if (typeof encryptData === 'function') {
                    const encrypted = encryptData(saveData);
                    if (encrypted) {
                        localStorage.setItem('survival_hero_save_v2', encrypted);
                    }
                }
                
                console.log('Save imported for:', saveData.char.name);
                console.log('Imported data keys:', Object.keys(saveData));
                
                var charName = saveData.char.name || 'Nezn√°m√Ω';
                var charLevel = saveData.char.level || 1;
                var invCount = saveData.inv?.length || 0;
                var gold = saveData.money || 0;
                var visitedLocs = saveData.world?.visitedLocations?.length || 0;
                
                showModal('‚úÖ Import √∫spƒõ≈°n√Ω!', 
                    '<div style="text-align: center;">' +
                        '<div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>' +
                        '<p style="color: #4caf50; font-weight: bold; font-size: 1.2rem;">Postava naƒçtena!</p>' +
                        '<div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">' +
                            '<p style="color: #ffd700; margin: 0; font-size: 1.3rem;">' + charName + '</p>' +
                            '<p style="color: #888; margin: 0.3rem 0 0 0;">Level ' + charLevel + '</p>' +
                            '<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 0.5rem; font-size: 0.85rem; color: #aaa;">' +
                                '<span>üí∞ ' + gold + '</span>' +
                                '<span>üéí ' + invCount + '</span>' +
                                '<span>üó∫Ô∏è ' + visitedLocs + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<p style="color: #ff9800; font-size: 0.85rem;">‚ö†Ô∏è Klikni na tlaƒç√≠tko pro dokonƒçen√≠ importu!</p>' +
                        '<button class="btn" onclick="location.reload(true)" style="width: 100%; background: var(--rust); margin-top: 0.5rem;">üîÑ Naƒç√≠st hru</button>' +
                    '</div>'
                );
            } catch (e) {
                notifyError('Chyba importu!', e.message);
                console.error('Import error:', e);
            }
        }
        
        function confirmNewGame() {
            showModal('üÜï Nov√° hra', `
                <p>Opravdu chce≈° zaƒç√≠t novou hru?</p>
                <p style="color: #c62828; font-size: 0.9rem;">‚ö†Ô∏è Aktu√°ln√≠ hra bude smaz√°na!</p>
                ${currentUser && !currentUser.isAnonymous ? `
                    <div style="background: #1a2a3a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="deleteCloudSave" checked style="width: 18px; height: 18px;">
                            <span>‚òÅÔ∏è Smazat i cloud save</span>
                        </label>
                        <p style="color: #888; font-size: 0.75rem; margin: 0.5rem 0 0 0;">Jinak se po reloadu naƒçte star√° hra z cloudu</p>
                    </div>
                ` : ''}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="startNewGame()" style="background: #8B0000;">üÜï Nov√° hra</button>
                </div>
            `);
        }
        
        async function startNewGame() {
            try {
                // Sma≈æ cloud save pokud je za≈°krtnuto
                const deleteCloud = document.getElementById('deleteCloudSave')?.checked;
                if (deleteCloud && currentUser && !currentUser.isAnonymous && firebaseDB) {
                    console.log('üóëÔ∏è Ma≈æu cloud save...');
                    await firebaseDB.ref('cloudSaves/' + currentUser.uid).remove();
                }
                
                // Nastav flag ≈æe vytv√°≈ô√≠me novou postavu (oboje - localStorage i sessionStorage pro jistotu)
                localStorage.setItem('creatingNewCharacter', 'true');
                sessionStorage.setItem('creatingNewCharacter', 'true');
                window.creatingNewCharacter = true;
                
                // Sma≈æ v≈°echny ulo≈æen√© hry
                localStorage.removeItem('survival_hero_save');
                localStorage.removeItem('survival_hero_save_v2');
                localStorage.removeItem('survival_hero_backup');
                localStorage.removeItem('friendsList_' + (state.char?.name || ''));
                console.log('üóëÔ∏è Save smaz√°n, reloaduji...');
            } catch(e) {
                console.error('Chyba p≈ôi maz√°n√≠ save:', e);
            }
            location.reload();
        }
        
        // O≈æiven√≠ hr√°ƒçe po smrti
        function respawnPlayer() {
            state.isDead = false;
            state.char.hp = Math.floor(state.char.maxHp * 0.5); // 50% HP
            state.status.hunger = 30;
            state.status.thirst = 30;
            state.status.energy = 30;
            state.status.radiation = Math.max(0, state.status.radiation - 20);
            
            // Teleport do √∫krytu
            state.world.currentLocation = 'shelter';
            state.world.traveling = false;
            state.map.traveling = false;
            state.map.inBase = true;
            
            // Ztr√°ta ƒç√°sti invent√°≈ôe (25% vƒõc√≠) - zapamatuj si co se ztratilo
            const lostItems = [];
            const itemsToLose = Math.floor(state.inv.length * 0.25);
            for (let i = 0; i < itemsToLose; i++) {
                const randomIndex = Math.floor(Math.random() * state.inv.length);
                const lostItem = state.inv[randomIndex];
                if (lostItem && lostItem.type !== 'quest') { // Neztr√°cet quest itemy
                    lostItems.push({
                        name: lostItem.name || getItemName(lostItem.id),
                        icon: lostItem.icon || 'üì¶',
                        count: lostItem.count || 1
                    });
                    state.inv.splice(randomIndex, 1);
                }
            }
            
            // Ztr√°ta 30% penƒõz
            const moneyBefore = getMoney();
            const moneyLost = Math.floor(moneyBefore * 0.3);
            if (moneyLost > 0) {
                removeMoney(moneyLost);
            }
            
            // Zobraz modal s informac√≠ o ztr√°t√°ch
            let lostItemsHtml = '';
            if (lostItems.length > 0) {
                lostItemsHtml = `
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0; max-height: 150px; overflow-y: auto;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b; font-size: 0.9rem;">üì¶ Ztracen√© vƒõci:</h4>
                        ${lostItems.map(item => `
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem; background: #1a1a1a; border-radius: 4px; margin-bottom: 0.2rem;">
                                <span>${item.icon}</span>
                                <span style="color: #888; font-size: 0.85rem;">${item.name}${item.count > 1 ? ' x' + item.count : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                lostItemsHtml = '<p style="color: #8bc34a; margin: 0.5rem 0;">‚úì Neztratil jsi ≈æ√°dn√© vƒõci!</p>';
            }
            
            showModal('üíÄ O≈æiven√≠', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üè•</div>
                    <p style="color: #888;">Probudil ses v √∫krytu...</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0; color: #8bc34a;">‚ù§Ô∏è HP obnoveno na 50%</p>
                        <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">üçñ Hlad: 30% | üíß ≈Ω√≠ze≈à: 30% | ‚ö° Energie: 30%</p>
                    </div>
                    
                    ${moneyLost > 0 ? `<p style="color: #ff9800;">üí∞ Ztr√°ta penƒõz: -${moneyLost} (mƒõl jsi ${moneyBefore})</p>` : ''}
                    
                    ${lostItemsHtml}
                </div>
                
                <button class="btn" onclick="closeModal(); renderFull();" style="width: 100%; margin-top: 1rem;">
                    ‚úì Pokraƒçovat
                </button>
            `);
            
            addLog(`Probudil ses v √∫krytu. Ztratil jsi ${lostItems.length} vƒõc√≠ a ${moneyLost} üí∞.`, 'üíÄ');
            saveGame(true);
        }
        
        function deleteSave() {
            showModal('‚ö†Ô∏è Smazat hru?', `
                <p>Opravdu chce≈° smazat ulo≈æenou hru?</p>
                <p style="color: #c62828; font-size: 0.9rem;">Tato akce je nevratn√°!</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="confirmDeleteSave()" style="background: #c62828;">üóëÔ∏è Smazat</button>
                </div>
            `);
        }
        
        function confirmDeleteSave() {
            localStorage.removeItem('survival_hero_save');
            closeModal();
            showModal('‚úì Smaz√°no!', '<p>Ulo≈æen√° hra byla smaz√°na.</p><button class="btn" onclick="location.reload()" style="width: 100%; margin-top: 1rem;">üîÑ Nov√° hra</button>');
        }
        
        // === GAME LOOP ===
        setInterval(() => {
            const now = Date.now();
            const delta = (now - state.time.last) / 1000; // seconds since last tick
            state.time.last = now;
            
            // Calculate total elapsed time (keeps counting even after reload)
            state.time.totalElapsed += delta;
            
            // Display REAL TIME instead of game time
            const realDate = new Date();
            state.time.hours = realDate.getHours();
            state.time.mins = realDate.getMinutes();
            state.time.days = Math.floor(state.time.totalElapsed / 86400); // Days from gameplay (24h real = 1 game day)
            
            // Update weather
            if (state.confirmed) {
                updateWeather();
            }
            
            // Process building queue
            if (state.confirmed) {
                processBuildQueue();
            }
            
            // Settlement daily update
            if (!state.settlement.lastUpdateDay) state.settlement.lastUpdateDay = 0;
            if (state.time.days > state.settlement.lastUpdateDay) {
                updateSettlementDaily();
                checkFoodSpoilage(); // Kontrola kazen√≠ j√≠dla
                feedCompanions(); // Krmen√≠ spoleƒçn√≠k≈Ø (legacy - teƒè se vol√° ka≈ædou hodinu)
                processFactionTerritoryIncome(); // P≈ô√≠jem z PvP frakc√≠ a √∫zem√≠
                
                // === DUNGEON RESET CHECK (ka≈æd√Ω den) ===
                if (state.dungeon?.cleared) {
                    const DUNGEON_RESET_TIME = 24 * 60 * 60 * 1000; // 24 hodin
                    for (const [dungeonId, clearData] of Object.entries(state.dungeon.cleared)) {
                        if (clearData?.clearedAt) {
                            const timeSinceClear = Date.now() - clearData.clearedAt;
                            if (timeSinceClear >= DUNGEON_RESET_TIME) {
                                delete state.dungeon.cleared[dungeonId];
                                const dungeonData = DUNGEON_FLOORS?.[dungeonId];
                                if (dungeonData) {
                                    addLog(`üè∞ ${dungeonData.name} se resetoval - nep≈ô√°tel√© se vr√°tili!`, 'üîÑ');
                                }
                            }
                        }
                    }
                }
                
                // === DENN√ç BONUS LOAJALITY PRO SPOLEƒåN√çKY ===
                if (state.companions && state.companions.length > 0) {
                    state.companions.forEach(comp => {
                        if (!comp.isDead) {
                            // P≈ôidej dny aktivn√≠
                            comp.daysActive = (comp.daysActive || 0) + 1;
                            
                            // Bonus loajalita za ka≈æd√Ω den spolu (+1)
                            comp.loyalty = Math.min(100, (comp.loyalty || 0) + 1);
                            
                            // Penalty pokud nebyl nakrmen/napojen za posledn√≠ch 24h
                            const now = Date.now();
                            const DAY_MS = 24 * 60 * 60 * 1000;
                            if (!comp.lastFedTime || (now - comp.lastFedTime) >= DAY_MS) {
                                comp.loyalty = Math.max(0, (comp.loyalty || 0) - 3);
                            }
                            if (!comp.lastWateredTime || (now - comp.lastWateredTime) >= DAY_MS) {
                                comp.loyalty = Math.max(0, (comp.loyalty || 0) - 2);
                            }
                        }
                    });
                }
                
                MobileNotifications.notifyNewDay(state.time.days); // Push notifikace
                state.settlement.lastUpdateDay = state.time.days;
                
                // === ACHIEVEMENT TRACKING - denn√≠ ===
                // Pacifist - kolik dn√≠ bez zabit√≠
                if (state.stats.lastKillDay === undefined) state.stats.lastKillDay = -1;
                const daysSinceLastKill = state.time.days - state.stats.lastKillDay;
                if (daysSinceLastKill > (state.stats.pacifistDays || 0)) {
                    state.stats.pacifistDays = daysSinceLastKill;
                }
            }
            
            // === ACHIEVEMENT TRACKING - pr≈Øbƒõ≈æn√© ===
            // Near death experience (1-5 HP)
            if (state.confirmed && state.char.hp <= 5 && state.char.hp > 0) {
                state.stats.nearDeathExp = (state.stats.nearDeathExp || 0) + 1;
            }
            
            // === KRMEN√ç SPOLEƒåN√çK≈Æ (ka≈ædou hodinu re√°ln√©ho ƒçasu) ===
            if (state.confirmed && state.companions && state.companions.length > 0) {
                if (!state._lastCompanionFeedCheck) state._lastCompanionFeedCheck = 0;
                if (now - state._lastCompanionFeedCheck > 3600000) { // Ka≈ædou hodinu
                    state._lastCompanionFeedCheck = now;
                    feedCompanions();
                }
            }
            
            // === SETTLEMENT EVENTY KA≈ΩD√ùCH 6 HODIN ===
            // Ale a≈æ 12 hodin po vytvo≈ôen√≠ postavy
            const twelveHoursMs = 12 * 60 * 60 * 1000;
            const gameAge = state.time?.totalElapsed ? state.time.totalElapsed * 1000 : (now - (state.time?.realStart || now));
            
            if (!state.settlement.lastEventCheck) state.settlement.lastEventCheck = 0;
            if (gameAge >= twelveHoursMs && now - state.settlement.lastEventCheck > 21600000) { // Ka≈æd√Ωch 6 hodin, ale a≈æ po 12h hran√≠
                state.settlement.lastEventCheck = now;
                checkSettlementEvents();
            }
            
            // === DENN√ç KASINO BONUS (ka≈æd√Ωch 24 hodin re√°ln√©ho ƒçasu) ===
            if (state.confirmed) {
                if (!state._lastCasinoCheck) state._lastCasinoCheck = 0;
                if (now - state._lastCasinoCheck > 60000) { // Kontroluj ka≈ædou minutu
                    state._lastCasinoCheck = now;
                    checkDailyCasinoTokens();
                }
            }
            
            // === REGENERACE Z BUDOV (ka≈ædou minutu kdy≈æ jsi v base) ===
            if (state.confirmed && state.map.inBase) {
                if (!state._lastBuildingRegen) state._lastBuildingRegen = 0;
                if (now - state._lastBuildingRegen > 60000) { // Ka≈ædou minutu
                    state._lastBuildingRegen = now;
                    const bonuses = getBuildingBonuses();
                    
                    // HP regenerace (nap≈ô. L≈Ø≈æko +2, O≈°et≈ôovna +5)
                    if (bonuses.hp > 0 && state.char.hp < state.char.maxHp) {
                        const oldHp = state.char.hp;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + bonuses.hp);
                        if (state.char.hp > oldHp) {
                            // Tich√© l√©ƒçen√≠ - jen log
                            console.log(`üè• Regenerace z budov: +${state.char.hp - oldHp} HP`);
                        }
                    }
                    
                    // Energie regenerace
                    if (bonuses.energy > 0 && state.status.energy < 100) {
                        state.status.energy = Math.min(100, state.status.energy + bonuses.energy);
                    }
                    
                    // Morale bonus pro hr√°ƒçe
                    if (bonuses.morale > 0 && state.status.mood < 100) {
                        state.status.mood = Math.min(100, state.status.mood + Math.floor(bonuses.morale / 10));
                    }
                }
            }
            
            // === PUSH NOTIFIKACE PRO KRITICK√â STAVY ===
            if (state.confirmed && !state._lastNotifyCheck) state._lastNotifyCheck = 0;
            if (state.confirmed && now - state._lastNotifyCheck > 60000) { // Max 1x za minutu
                state._lastNotifyCheck = now;
                
                // Kritick√© HP
                if (state.char.hp < state.char.maxHp * 0.2) {
                    MobileNotifications.notifyLowHealth();
                }
                // Kritick√Ω hlad
                if (state.status.hunger < 15) {
                    MobileNotifications.notifyLowHunger();
                }
                // Kritick√° ≈æ√≠ze≈à
                if (state.status.thirst < 15) {
                    MobileNotifications.notifyLowThirst();
                }
            }
            
            // Check for settlement raids (every 5 minutes of real time)
            if (state.confirmed && state.map.inBase) {
                // Napl√°nuj dal≈°√≠ raid pokud nen√≠ napl√°novan√Ω
                if (!state.settlement.nextRaidCheck) {
                    state.settlement.nextRaidCheck = now + 300000; // 5 min od teƒè
                }
                
                // Kontrola jestli nastal ƒças
                if (now >= state.settlement.nextRaidCheck) {
                    state.settlement.nextRaidCheck = now + 300000; // Dal≈°√≠ za 5 min
                    if (checkForRaid()) {
                        startSettlementRaid();
                    }
                }
            }
            
            // === FRAKƒåN√ç DANƒö Z √öZEM√ç (ka≈ædou hodinu) ===
            if (state.confirmed && multiplayerEnabled && firebaseDB) {
                if (!state._lastTerritoryTaxCheck) state._lastTerritoryTaxCheck = 0;
                if (now - state._lastTerritoryTaxCheck > 3600000) { // Ka≈ædou hodinu
                    state._lastTerritoryTaxCheck = now;
                    collectTerritoryTaxes();
                }
            }
            
            // === OBSAZOV√ÅN√ç √öZEM√ç (ka≈ædou sekundu) ===
            if (state.confirmed && state.territoryCapture && Object.keys(state.territoryCapture).length > 0) {
                updateTerritoryCapture(delta);
            }
            
            // === KARAVANA SYST√âM (perzistentn√≠) ===
            if (state.confirmed) {
                // Inicializace
                if (!state.caravan) {
                    state.caravan = { active: false, until: 0, nextCheck: now + 3600000 };
                }
                
                // Napl√°nuj dal≈°√≠ check pokud nen√≠
                if (!state.caravan.nextCheck) {
                    state.caravan.nextCheck = now + 3600000; // 60 min
                }
                
                // Kontrola jestli nastal ƒças na mo≈ænou karavanu (ka≈æd√Ωch 24 hodin hern√≠ho ƒçasu)
                if (now >= state.caravan.nextCheck && !state.caravan.active) {
                    state.caravan.nextCheck = now + 86400000; // Dal≈°√≠ check za 24 hodin re√°ln√©ho ƒçasu
                    
                    // Z√°kladn√≠ ≈°ance 20% + bonusy
                    let caravanChance = 0.20;
                    
                    // Bonus ze scout skillu (Ranger lvl 4 = +10%)
                    const scout = state.settlement?.settlers?.find(s => s.type === 'scout');
                    if (scout && scout.skillLevel >= 4) {
                        caravanChance += 0.10;
                    }
                    
                    // Bonus ze "S√≠≈• kontakt≈Ø" skillu (+20%)
                    if (state.unlockedAbilities?.network) {
                        caravanChance += 0.20;
                    }
                    
                    // Bonus z budovy "Obchodn√≠ stanice" (+15%)
                    if (state.settlement?.buildings?.includes('trading_post') || state.base?.includes('trading_post')) {
                        caravanChance += 0.15;
                    }
                    
                    if (Math.random() < caravanChance) {
                        state.caravan.active = true;
                        state.caravan.until = now + 300000; // 5 minut
                        notifyInfo('üê™ Karavana dorazila!', 'Obchodn√≠ci jsou v oblasti na 5 minut');
                        sendSystemNotification('Karavana dorazila!', 'Obchodn√≠ci jsou v oblasti na 5 minut', 'üê™');
                        addLog('Karavana obchodn√≠k≈Ø dorazila!', 'üê™');
                    }
                }
                
                // Kontrola jestli karavana neode≈°la
                if (state.caravan.active && now > state.caravan.until) {
                    state.caravan.active = false;
                    addLog('Karavana odjela.', 'üê™');
                }
                
                // Sync pro star√Ω syst√©m
                state.caravanPresent = state.caravan.active;
            }
            
            // Check if travel is complete
            checkTravelComplete();
            
            // Check scheduled travel events (p≈ôe≈æij√≠ refresh!)
            checkScheduledEvents();
            
            // Synchronizace state.map s state.world
            state.map.traveling = state.world.traveling;
            if (state.world.currentLocation === 'shelter' && !state.world.traveling) {
                // V shelter lokaci - inBase z√°vis√≠ na hr√°ƒçovƒõ volbƒõ (toggleBase)
            } else {
                state.map.inBase = false;
            }
            
            // Check if sleeping
            if (state.sleepEndTime && now < state.sleepEndTime) {
                // Player is sleeping
                const sleepProgress = (now - state.lastSleepTime) / (state.sleepEndTime - state.lastSleepTime);
                
                // During sleep: regen HP & energy, consume hunger & thirst faster
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + (50 / 3600) * delta); // +50 HP per hour
                state.status.energy = Math.min(100, state.status.energy + (80 / 3600) * delta); // +80 energy per hour
                state.status.hunger = Math.max(0, state.status.hunger - (30 / 3600) * delta); // -30 hunger per hour
                state.status.thirst = Math.max(0, state.status.thirst - (40 / 3600) * delta); // -40 thirst per hour
                
                // Skip normal consumption during sleep
            } else if (state.sleepEndTime && now >= state.sleepEndTime) {
                // Sleep ended - apply FULL effects (in case player was offline)
                state.status.energy = 100;
                const sleepHeal = 50;
                state.char.hp = Math.min(state.char.maxHp, state.char.hp + sleepHeal);
                state.status.hunger = Math.max(0, state.status.hunger - 30); // -30 hlad
                state.status.thirst = Math.max(0, state.status.thirst - 40); // -40 ≈æ√≠ze≈à
                state.sleepEndTime = null;
                state.isSleeping = false;
                
                // Daily quest progress - healing
                if (state.dailyQuests?.progress) {
                    state.dailyQuests.progress.healed = (state.dailyQuests.progress.healed || 0) + sleepHeal;
                    checkDailyQuests();
                }
                
                addLog('Probudil ses ze sp√°nku! C√≠t√≠≈° se odpoƒçat√Ω.', 'üòä');
                showModal('üòä Probudil ses!', `
                    <p>Spal jsi 1 hodinu a c√≠t√≠≈° se odpoƒçat√Ω!</p>
                    <p style="color: #8bc34a;">‚úì Energie: 100%</p>
                    <p style="color: #8bc34a;">‚úì HP: +50</p>
                    <p style="color: #ff9800;">‚ö†Ô∏è Hlad: -30</p>
                    <p style="color: #ff9800;">‚ö†Ô∏è ≈Ω√≠ze≈à: -40</p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">‚úì OK</button>
                `);
            }
            
            if (state.confirmed && !state.sleepEndTime) {
                // Passive consumption per real second
                // Much faster: 100% in 2 hours (7200 seconds) instead of 24 hours
                let hungerRate = 100 / 86400; // 24 hours to deplete
                let thirstRate = (100 / 86400) * 1.2; // 20 hours to deplete (slightly faster than hunger)
                let energyRate = 100 / 86400; // 24 hours to deplete
                
                // Aplikace mutac√≠ na spot≈ôebu
                if (state.mutations && state.mutations.length > 0) {
                    state.mutations.forEach(m => {
                        if (m.effect?.hungerRate) {
                            hungerRate *= m.effect.hungerRate; // 1.5 = +50% hlad
                        }
                        if (m.effect?.energyDrain) {
                            energyRate *= m.effect.energyDrain; // 1.3 = +30% energie
                        }
                    });
                }
                
                // Apply skill bonuses
                const ironStomachLevel = state.skills['iron_stomach'] || 0;
                if (ironStomachLevel > 0) {
                    const skill = SKILLS.find(s => s.id === 'iron_stomach');
                    hungerRate *= (1 - skill.value * ironStomachLevel);
                }
                
                const waterSaverLevel = state.skills['water_saver'] || 0;
                if (waterSaverLevel > 0) {
                    const skill = SKILLS.find(s => s.id === 'water_saver');
                    thirstRate *= (1 - skill.value * waterSaverLevel);
                }
                
                const enduranceLevel = state.skills['endurance'] || 0;
                if (enduranceLevel > 0) {
                    const skill = SKILLS.find(s => s.id === 'endurance');
                    energyRate *= (1 - skill.value * enduranceLevel);
                }
                
                // Nomad passive - 50% slower consumption
                const consumptionMod = hasClassPassive('consumptionReduction') ? 0.5 : 1.0;
                
                // Apply consumption based on state
                if (state.map.traveling) {
                    // During travel: use travel-specific rates (higher consumption)
                    // Ochrana AFK hr√°ƒç≈Ø - bƒõhem cesty neklesne pod 5% (tak≈æe nedostane≈° damage)
                    const MIN_TRAVEL_STATUS = 5;
                    state.status.hunger = Math.max(MIN_TRAVEL_STATUS, state.status.hunger - state.map.travelHungerRate * delta * consumptionMod);
                    state.status.thirst = Math.max(MIN_TRAVEL_STATUS, state.status.thirst - state.map.travelThirstRate * delta * consumptionMod);
                    state.status.energy = Math.max(MIN_TRAVEL_STATUS, state.status.energy - state.map.travelEnergyRate * delta);
                    
                    // Mutant radiation handling
                    if (hasClassPassive('radiationImmune')) {
                        const radGain = state.map.travelRadRate * delta;
                        const radPassive = getClassPassive('onRadiation', radGain);
                        // Radiation heals mutant instead
                    } else {
                        // Omezen√≠ radiace bƒõhem cestov√°n√≠ - max +20% za celou cestu
                        // Chr√°n√≠ hr√°ƒçe p≈ôed smrt√≠ kdy≈æ jsou offline bƒõhem radiaƒçn√≠ bou≈ôe
                        const radGain = state.map.travelRadRate * delta;
                        if (!state.map.travelRadAccumulated) state.map.travelRadAccumulated = 0;
                        
                        const MAX_TRAVEL_RAD = 20; // Max 20% radiace za jednu cestu
                        if (state.map.travelRadAccumulated < MAX_TRAVEL_RAD) {
                            const allowedGain = Math.min(radGain, MAX_TRAVEL_RAD - state.map.travelRadAccumulated);
                            state.status.radiation = Math.min(100, state.status.radiation + allowedGain);
                            state.map.travelRadAccumulated += allowedGain;
                        }
                    }
                } else if (!state.map.inBase) {
                    // Normal passive consumption when not traveling and not in base
                    state.status.hunger = Math.max(0, state.status.hunger - hungerRate * delta * consumptionMod);
                    state.status.thirst = Math.max(0, state.status.thirst - thirstRate * delta * consumptionMod);
                    state.status.energy = Math.max(0, state.status.energy - energyRate * delta);
                    
                    // Automatick√© konzumov√°n√≠ pokud m√° hr√°ƒç perk (kontrola ka≈æd√Ωch 10s)
                    if (Math.floor(now / 10000) !== Math.floor((now - delta * 1000) / 10000)) {
                        autoConsumeIfDying();
                    }
                    
                    // === P≈òIROZEN√Å REGENERACE HP ===
                    // 5 HP za hodinu, ale jen pokud nen√≠ hladov√Ω/dehydratovan√Ω a m√° m√©nƒõ ne≈æ max HP
                    if (state.char.hp < state.char.maxHp && state.status.hunger > 20 && state.status.thirst > 20 && state.status.radiation < 50) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + (5 / 3600) * delta); // +5 HP per hour
                    }
                    
                    // Medic passive - regeneration (bonus nav√≠c)
                    if (state.char.classId === 'medic' && state.char.hp < state.char.maxHp) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + 2 * delta / 60); // +2 HP per minute
                    }
                    
                    // Status warnings - flash red when critical
                    if (state.status.hunger <= 20 && Math.floor(now / 1000) % 3 === 0) {
                        document.body.style.animation = 'flash-red 0.5s';
                        setTimeout(() => document.body.style.animation = '', 500);
                    }
                    if (state.status.thirst <= 20 && Math.floor(now / 1000) % 3 === 0) {
                        document.body.style.animation = 'flash-red 0.5s';
                        setTimeout(() => document.body.style.animation = '', 500);
                    }
                } else {
                    // Regeneration in base (per real second)
                    // === P≈òIROZEN√Å REGENERACE V Z√ÅKLADNƒö ===
                    // V z√°kladnƒõ se HP regeneruje rychleji - 10 HP za hodinu
                    if (state.char.hp < state.char.maxHp && state.status.radiation < 50) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + (10 / 3600) * delta); // +10 HP per hour in base
                    }
                    
                    if (state.base.includes('bed')) {
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + 2 * delta / 3600);
                        state.status.energy = Math.min(100, state.status.energy + 2 * delta / 3600);
                    }
                    if (state.base.includes('garden')) {
                        state.status.hunger = Math.min(100, state.status.hunger + 1 * delta / 3600);
                    }
                    if (state.base.includes('water')) {
                        state.status.thirst = Math.min(100, state.status.thirst + 1.5 * delta / 3600);
                    }
                    
                    // Survivor skill passive regen
                    const survivorLevel = state.skills['survivor'] || 0;
                    if (survivorLevel > 0) {
                        const skill = SKILLS.find(s => s.id === 'survivor');
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + skill.value * survivorLevel * delta / 60);
                    }
                }
                
                // === P≈òIROZEN√â SNI≈ΩOV√ÅN√ç RADIACE ===
                // Radiace kles√° pomalu sama od sebe kdy≈æ nejsi v radioaktivn√≠ z√≥nƒõ
                // Pod 50%: -2% za hodinu, 50-80%: -1% za hodinu, nad 80%: nekles√° (pot≈ôebuje≈° RadAway)
                if (state.status.radiation > 0 && !state.world?.traveling) {
                    let radDecay = 0;
                    if (state.status.radiation < 50) {
                        radDecay = 2 / 3600 * delta; // -2% za hodinu
                    } else if (state.status.radiation < 80) {
                        radDecay = 1 / 3600 * delta; // -1% za hodinu
                    }
                    // Nad 80% radiace nekles√° p≈ôirozenƒõ - pot≈ôebuje≈° l√©ky!
                    
                    if (radDecay > 0) {
                        state.status.radiation = Math.max(0, state.status.radiation - radDecay);
                    }
                }
                
                // Radiation sickness
                if (state.status.radiation > 50) {
                    // 50-80%: velmi m√≠rn√© damage (0.1-0.3 HP/min) - hr√°ƒç p≈ôe≈æije i offline
                    // 80-99%: m√≠rn√© damage (0.3-1 HP/min) - st√°le p≈ôe≈æiteln√©
                    // 100%: kritick√© - rychl√° smrt (5 HP/min) - nutn√© l√©ƒçit!
                    let radDamage;
                    if (state.status.radiation >= 100) {
                        radDamage = 5 * delta / 60; // 5 HP/min p≈ôi 100%
                    } else if (state.status.radiation >= 80) {
                        radDamage = (0.3 + (state.status.radiation - 80) * 0.035) * delta / 60; // 0.3-1 HP/min
                    } else {
                        radDamage = (0.1 + (state.status.radiation - 50) * 0.007) * delta / 60; // 0.1-0.3 HP/min
                    }
                    
                    state.char.hp = Math.max(1, state.char.hp - radDamage); // Min 1 HP - nelze zem≈ô√≠t na radiaci pod 100%
                    
                    // Log warning
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        if (state.status.radiation >= 100) {
                            addLog('‚ò†Ô∏è KRITICK√Å RADIACE! Um√≠r√°≈°!', '‚ò¢Ô∏è');
                        } else if (state.status.radiation > 70) {
                            addLog('‚ö†Ô∏è Radiaƒçn√≠ nemoc! Vysok√° radiace ti bere zdrav√≠!', '‚ò¢Ô∏è');
                        }
                    }
                }
                
                // === MUTACE Z RADIACE ===
                // ≈†ance na mutaci ka≈æd√Ωch 15 minut p≈ôi vysok√© radiaci
                if (!state.lastMutationCheck) state.lastMutationCheck = 0;
                if (now - state.lastMutationCheck > 900000) { // Ka≈æd√Ωch 15 minut (900000ms)
                    state.lastMutationCheck = now;
                    
                    if (state.status.radiation > 50 && (state.mutations?.length || 0) < 5) {
                        checkForMutation();
                    }
                }
                
                // === PENALIZACE ZA N√çZK√â STATY ===
                // Kontrola noStarvation skillu (P≈ôe≈æ√≠vaƒç tier 4)
                const hasNoStarvation = getSkillTreeBonus('noStarvation') > 0;
                
                // Po≈°kozen√≠ z hladu (0% = -5 HP/min) - ale ne se skillem P≈ôe≈æ√≠vaƒç
                if (state.status.hunger <= 0 && !hasNoStarvation) {
                    const hungerDmg = 5 * delta / 60;
                    state.char.hp = Math.max(1, state.char.hp - hungerDmg); // Min 1 HP
                    if (Math.floor(state.time.totalElapsed) % 30 === 0) {
                        addLog('‚ö†Ô∏è Hladov√≠≈°! Ztr√°c√≠≈° zdrav√≠!', 'üçñ');
                    }
                } else if (state.status.hunger <= 0 && hasNoStarvation) {
                    // Se skillem jen warning, ne damage
                    state.char.hp = Math.max(1, state.char.hp);
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        addLog('üèÜ Hladov√≠≈°, ale p≈ôe≈æ√≠v√°≈° d√≠ky skillu!', 'üçñ');
                    }
                }
                
                // Po≈°kozen√≠ z ≈æ√≠znƒõ (0% = -8 HP/min, rychlej≈°√≠ ne≈æ hlad) - ale ne se skillem P≈ôe≈æ√≠vaƒç
                if (state.status.thirst <= 0 && !hasNoStarvation) {
                    const thirstDmg = 8 * delta / 60;
                    state.char.hp = Math.max(1, state.char.hp - thirstDmg); // Min 1 HP
                    if (Math.floor(state.time.totalElapsed) % 30 === 0) {
                        addLog('‚ö†Ô∏è Dehydratuje≈°! Ztr√°c√≠≈° zdrav√≠!', 'üíß');
                    }
                } else if (state.status.thirst <= 0 && hasNoStarvation) {
                    // Se skillem jen warning, ne damage
                    state.char.hp = Math.max(1, state.char.hp);
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        addLog('üèÜ Dehydratuje≈°, ale p≈ôe≈æ√≠v√°≈° d√≠ky skillu!', 'üíß');
                    }
                }
                
                // Penalizace za vyƒçerp√°n√≠ (0% energie = -50% max HP efektivnƒõ)
                if (state.status.energy <= 0) {
                    // Pomal√© HP po≈°kozen√≠ - ale ne bƒõhem cestov√°n√≠ (ochrana AFK hr√°ƒç≈Ø)
                    const energyDmg = 2 * delta / 60;
                    const minHp = state.world?.traveling ? 1 : 0; // Bƒõhem cesty min 1 HP
                    state.char.hp = Math.max(minHp, state.char.hp - energyDmg);
                    if (Math.floor(state.time.totalElapsed) % 60 === 0) {
                        addLog('‚ö†Ô∏è Jsi vyƒçerpan√Ω! Pot≈ôebuje≈° odpoƒçinek!', 'üò¥');
                    }
                }
                
                // === SMRT ===
                if (state.char.hp <= 0 && !state.isDead) {
                    state.isDead = true;
                    state.stats.deaths = (state.stats.deaths || 0) + 1;
                    
                    // Detailn√≠ p≈ô√≠ƒçina smrti
                    let deathReason = 'Zem≈ôel jsi';
                    let deathDetails = '';
                    
                    if (state.status.hunger <= 0) {
                        deathReason = 'üçñ Zem≈ôel jsi hlady';
                        deathDetails = 'Hlad: 0%';
                    } else if (state.status.thirst <= 0) {
                        deathReason = 'üíß Zem≈ôel jsi ≈æ√≠zn√≠';
                        deathDetails = '≈Ω√≠ze≈à: 0%';
                    } else if (state.status.radiation >= 100) {
                        deathReason = '‚ò¢Ô∏è Zem≈ôel jsi na radiaci';
                        deathDetails = `Radiace: ${state.status.radiation.toFixed(0)}%`;
                    } else if (state.lastDamageSource) {
                        // Pokud m√°me ulo≈æenou p≈ô√≠ƒçinu posledn√≠ho po≈°kozen√≠
                        deathReason = `‚öîÔ∏è Zabil tƒõ: ${state.lastDamageSource}`;
                        deathDetails = `Posledn√≠ damage: ${state.lastDamageAmount || '?'}`;
                    } else if (state.status.hunger < 20 || state.status.thirst < 20) {
                        deathReason = 'üòµ Zem≈ôel jsi vyƒçerp√°n√≠m';
                        deathDetails = `Hlad: ${state.status.hunger.toFixed(0)}%, ≈Ω√≠ze≈à: ${state.status.thirst.toFixed(0)}%`;
                    }
                    
                    // Ulo≈æ p≈ô√≠ƒçinu smrti do statistik
                    state.stats.lastDeathReason = deathReason;
                    state.stats.lastDeathDetails = deathDetails;
                    
                    const deathTexts = {
                        title: 'üíÄ SMRT',
                        survived: 'P≈ôe≈æil jsi',
                        days: 'dn√≠',
                        kills: 'Zabit√≠',
                        deaths: '√ömrt√≠',
                        respawn: 'üîÑ O≈æivit (ztrat√≠≈° ƒç√°st vƒõc√≠)',
                        newGame: 'üÜï Nov√° hra'
                    };
                    showModal(deathTexts.title, `
                        <div style="text-align: center;">
                            <div style="font-size: 5rem; margin-bottom: 1rem;">üíÄ</div>
                            <h2 style="color: #ff4444;">${deathReason}</h2>
                            ${deathDetails ? `<p style="color: #ff9800; font-size: 0.9rem;">${deathDetails}</p>` : ''}
                            <p style="color: #888; margin: 1rem 0;">${deathTexts.survived} ${state.time.days} ${deathTexts.days}.</p>
                            <p style="color: #666; font-size: 0.85rem;">${deathTexts.kills}: ${state.stats.kills || 0} | ${deathTexts.deaths}: ${state.stats.deaths}</p>
                            
                            <div style="margin-top: 1.5rem;">
                                <button class="btn" onclick="respawnPlayer()" style="width: 100%; margin-bottom: 0.5rem; background: var(--rust);">${deathTexts.respawn}</button>
                                <button class="btn" onclick="startNewGame()" style="width: 100%; background: #333;">${deathTexts.newGame}</button>
                            </div>
                        </div>
                    `);
                }
                
                // Update mood based on status
                const avgStatus = (state.status.hunger + state.status.thirst + state.status.energy) / 3;
                state.status.mood = avgStatus - state.status.radiation * 0.5;
                state.status.mood = Math.max(0, Math.min(100, state.status.mood));
            }
            
            render();
            
            // Scavenger production (every 6 hours of real time)
            const currentPeriod = Math.floor(state.time.totalElapsed / 21600); // 21600 = 6 hodin
            if (!state.settlement.lastScavengerPeriod) state.settlement.lastScavengerPeriod = currentPeriod;
            if (currentPeriod > state.settlement.lastScavengerPeriod && state.confirmed) {
                updateScavengerProduction();
                state.settlement.lastScavengerPeriod = currentPeriod;
            }
            
            // Production from buildings (check every minute)
            if (Math.floor(state.time.totalElapsed) % 60 === 0 && state.confirmed) {
                BUILDINGS.forEach(building => {
                    if ((state.base.includes(building.id) || state.settlement.buildings.includes(building.id)) && building.production) {
                        const prod = building.production;
                        const minutesPassed = Math.floor(state.time.totalElapsed / 60);
                        const productionInterval = 1440; // 24 hours in minutes
                        
                        if (minutesPassed % productionInterval === 0) {
                            // Produkce jde p≈ô√≠mo do settlement.resources
                            Object.entries(prod).forEach(([resource, amount]) => {
                                if (resource === 'food' || resource === 'water') {
                                    state.settlement.resources[resource] = (state.settlement.resources[resource] || 0) + amount;
                                } else if (resource !== 'power') {
                                    state.resources[resource] = (state.resources[resource] || 0) + amount;
                                }
                            });
                        }
                    }
                });
            }
            
            // Check achievements every 10 seconds
            if (Math.floor(state.time.totalElapsed) % 10 === 0) {
                checkAchievements();
            }
        }, 1000);
        
        // Auto-save every 1 second (silent) - ochrana proti refresh exploitu
        let lastSaveTime = 0;
        setInterval(() => {
            if (state.confirmed && Date.now() - lastSaveTime > 1000) {
                saveGame(true); // true = silent mode
                lastSaveTime = Date.now();
            }
        }, 1000); // Save every 1 second
        
        // === START ===
        // Auto-load saved game on page load
        let saveData = localStorage.getItem('survival_hero_save_v2');
        let loaded = null;
        
        // Zkus de≈°ifrovat novou verzi
        if (saveData && typeof decryptData === 'function') {
            loaded = decryptData(saveData);
        }
        
        // Fallback na starou ne≈°ifrovanou verzi
        if (!loaded) {
            const oldSave = localStorage.getItem('survival_hero_save');
            if (oldSave) {
                try {
                    loaded = JSON.parse(oldSave);
                    console.log('üì• Naƒç√≠t√°m ze star√© verze save...');
                } catch(e) {}
            }
        }
        
        // Fallback na z√°lohu
        if (!loaded) {
            const backup = localStorage.getItem('survival_hero_backup');
            if (backup) {
                try {
                    loaded = JSON.parse(backup);
                    console.log('üì• Naƒç√≠t√°m ze z√°lohy...');
                } catch(e) {}
            }
        }
        
        if (loaded) {
            try {
                
                // Debug: Check if save has confirmed flag
                console.log('üì• Naƒç√≠t√°m hru...', 'confirmed:', loaded.confirmed);
                
                // Pokud jde o ƒçerstv√Ω import, kompletnƒõ nahraƒè state
                if (loaded._freshImport) {
                    console.log('üîÑ Fresh import detected - nahrazuji kompletnƒõ state');
                    // Odstra≈à import flag
                    delete loaded._freshImport;
                    delete loaded._importTime;
                    // Kompletnƒõ nahraƒè state
                    Object.keys(loaded).forEach(key => {
                        state[key] = loaded[key];
                    });
                    // Ulo≈æ bez flagu
                    localStorage.setItem('survival_hero_save', JSON.stringify(state));
                } else {
                    // Norm√°ln√≠ naƒç√≠t√°n√≠ - nahraƒè state loaded daty kompletnƒõ
                    // Projdi v≈°echny kl√≠ƒçe v loaded (ne jen v state!) aby se p≈ôidaly i nov√©
                    Object.keys(loaded).forEach(key => {
                        state[key] = loaded[key];
                    });
                    // Explicitnƒõ naƒçti currentAction (m≈Ø≈æe b√Ωt null v p≈Øvodn√≠m state)
                    if (loaded.currentAction !== undefined) {
                        state.currentAction = loaded.currentAction;
                    }
                }
                
                // CRITICAL: Ensure confirmed is loaded
                if (loaded.confirmed === true) {
                    state.confirmed = true;
                    console.log('‚úì Hra potvrzena - postava existuje');
                } else {
                    console.log('‚ö†Ô∏è Hra nen√≠ potvrzena - bude vytvo≈ôena nov√° postava');
                }
                
                state.time.last = Date.now();
                state.time.realStart = Date.now();
                
                // Ensure new properties exist
                state.baseItems = state.baseItems || [];
                
                // Migration: Base capacity is now 40 + bonuses from buildings
                let bonusCapacity = 0;
                if (state.base && state.base.includes('warehouse')) bonusCapacity += 30;
                if (state.base && state.base.includes('cryo_storage')) bonusCapacity += 50;
                state.baseCapacity = 40 + bonusCapacity;
                
                state.log = state.log || [];
                state.diary = state.diary || '';
                state.lastSleepTime = state.lastSleepTime || 0;
                state.isSleeping = state.isSleeping || false;
                state.worldSeed = state.worldSeed || 123456; // Default seed for old saves
                state.dailyQuests = state.dailyQuests || { lastReset: Date.now(), quests: [], completed: [], progress: {} };
                if (!state.dailyQuests.progress) {
                    state.dailyQuests.progress = { kills: 0, explored: 0, crafted: 0, moneyEarned: 0, travelled: 0, cooked: 0, sold: 0, bought: 0 };
                }
                // Ensure cooked exists for old saves
                if (state.dailyQuests.progress.cooked === undefined) {
                    state.dailyQuests.progress.cooked = 0;
                }
                state.stats.totalMoneyEarned = state.stats.totalMoneyEarned || 0;
                
                // Migration: Add factions if missing
                if (!state.factions) {
                    state.factions = { traders: 0, scientists: 0, raiders: -20, mutants: 0, military: 0 };
                }
                
                // Migration: Add casino tokens if missing
                if (state.casinoTokens === undefined) {
                    state.casinoTokens = 1000; // Startovac√≠ bonus
                    state.casinoLastTokenTime = Date.now(); // Nastav na teƒè
                    console.log('üé∞ Migrace: P≈ôid√°ny casino ≈æetony (1000)');
                }
                // Oprava: Pokud m√° ≈æetony ale nem√° nastaven lastTokenTime, nastav ho
                if (state.casinoTokens > 0 && !state.casinoLastTokenTime) {
                    state.casinoLastTokenTime = Date.now();
                    console.log('üé∞ Migrace: Opraven casinoLastTokenTime');
                }
                
                // Generate daily quests
                generateDailyQuests();
                
                // Restore travel if it was in progress (star√Ω hex syst√©m - pro kompatibilitu)
                if (state.map.traveling) {
                    // Star√Ω hex travel - jednodu≈°e ho dokonƒç√≠me
                    state.map.traveling = false;
                    console.log('‚úì Star√Ω hex travel ukonƒçen p≈ôi naƒçten√≠');
                }
                
                // Restore travel if using new WORLD system
                if (state.world.traveling && state.world.travelStart && state.world.travelDuration) {
                    const now = Date.now();
                    const elapsed = now - state.world.travelStart;
                    
                    if (elapsed >= state.world.travelDuration) {
                        // Travel completed during offline - complete it
                        if (state.world.travelTo) {
                            state.world.currentLocation = state.world.travelTo;
                            if (!state.world.visitedLocations.includes(state.world.travelTo)) {
                                state.world.visitedLocations.push(state.world.travelTo);
                            }
                        }
                        state.world.traveling = false;
                        state.world.travelTo = null;
                        state.map.traveling = false;
                        state.map.inBase = (state.world.currentLocation === 'shelter');
                        console.log('‚úì WORLD cestov√°n√≠ dokonƒçeno bƒõhem offline');
                    } else {
                        // Still traveling - keep it going
                        console.log('‚úì WORLD cestov√°n√≠ pokraƒçuje...', Math.ceil((state.world.travelDuration - elapsed) / 1000), 's zb√Ωv√°');
                    }
                }
                
                // Restore sleep if it was in progress
                if (state.isSleeping && state.sleepEndTime) {
                    const now = Date.now();
                    if (now >= state.sleepEndTime) {
                        // Sp√°nek dokonƒçen bƒõhem offline
                        state.isSleeping = false;
                        state.sleepEndTime = null;
                        state.status.energy = 100;
                        state.char.hp = Math.min(state.char.maxHp, state.char.hp + 50);
                        console.log('‚úì Sp√°nek dokonƒçen bƒõhem offline');
                        addLog('Probudil ses osvƒõ≈æen√Ω!', '‚òÄÔ∏è');
                    } else {
                        // St√°le sp√≠ - zobraz√≠ se modal p≈ôi renderov√°n√≠
                        console.log('üí§ Sp√°nek pokraƒçuje...', Math.ceil((state.sleepEndTime - now) / 60000), 'min zb√Ωv√°');
                    }
                }
                
                // Restore timed action if it was in progress (hunt, mine, fish, explore)
                if (state.currentAction && state.currentAction.endTime) {
                    const now = Date.now();
                    if (now >= state.currentAction.endTime) {
                        // Akce dokonƒçena bƒõhem offline - spus≈• v√Ωsledek
                        const actionType = state.currentAction.type;
                        const icons = { hunt: 'üèπ', mine: '‚õèÔ∏è', fish: 'üé£', explore: 'üîç' };
                        const names = { hunt: 'Lov', mine: 'Tƒõ≈æba', fish: 'Rybolov', explore: 'Pr≈Øzkum' };
                        console.log(`‚úì ${names[actionType]} dokonƒçen bƒõhem offline`);
                        
                        // Dokonƒçit akci po naƒçten√≠
                        setTimeout(() => {
                            state.currentAction = null;
                            if (actionType === 'hunt') executeHunting();
                            else if (actionType === 'mine') executeMining();
                            else if (actionType === 'fish') executeFishing();
                            else if (actionType === 'explore') executeExploring();
                        }, 500);
                    } else {
                        // St√°le prob√≠h√° - obnov progress ti≈°e (bez modalu)
                        const remaining = Math.ceil((state.currentAction.endTime - now) / 1000);
                        console.log(`‚è≥ Akce pokraƒçuje... ${Math.floor(remaining / 60)}:${String(remaining % 60).padStart(2, '0')} zb√Ωv√°`);
                        
                        // Spus≈• progress na pozad√≠ bez modalu
                        setTimeout(() => {
                            const actionType = state.currentAction.type;
                            const totalMinutes = Math.ceil(state.currentAction.duration / 60000);
                            showActionProgress(actionType, totalMinutes, true); // true = isResumed
                        }, 100);
                    }
                }
                
                // Restore travel if in progress (state.world)
                if (state.world && state.world.traveling && state.world.travelStart) {
                    const now = Date.now();
                    const travelEnd = state.world.travelStart + state.world.travelDuration;
                    
                    if (now >= travelEnd) {
                        // Cestov√°n√≠ dokonƒçeno bƒõhem offline
                        console.log('‚úì Cestov√°n√≠ dokonƒçeno bƒõhem offline');
                        state.world.traveling = false;
                        state.world.currentLocation = state.world.travelTo;
                        if (!state.world.visitedLocations.includes(state.world.travelTo)) {
                            state.world.visitedLocations.push(state.world.travelTo);
                        }
                        state.world.travelTo = null;
                        state.world.travelStart = 0;
                        state.world.travelDuration = 0;
                    } else {
                        // Cestov√°n√≠ st√°le prob√≠h√° - obnov timer
                        const remaining = Math.ceil((travelEnd - now) / 1000);
                        console.log(`üö∂ Cestov√°n√≠ pokraƒçuje... ${Math.floor(remaining / 60)}:${String(remaining % 60).padStart(2, '0')} zb√Ωv√°`);
                        
                        // Spus≈• timeout pro dokonƒçen√≠
                        setTimeout(() => {
                            if (state.world.traveling) {
                                state.world.traveling = false;
                                state.world.currentLocation = state.world.travelTo;
                                if (!state.world.visitedLocations.includes(state.world.travelTo)) {
                                    state.world.visitedLocations.push(state.world.travelTo);
                                }
                                state.world.travelTo = null;
                                state.world.travelStart = 0;
                                state.world.travelDuration = 0;
                                renderFull();
                                notifySuccess('üö∂ Dorazil jsi!', 'Cestov√°n√≠ dokonƒçeno.');
                            }
                        }, travelEnd - now);
                    }
                }
                
                // Restore travel events if traveling (old state.map system)
                if (state.map && state.map.traveling && state.map.scheduledTravelEvents && state.map.scheduledTravelEvents.length > 0) {
                    console.log('üîÑ Obnovuji travel eventy...');
                    setTimeout(() => {
                        restoreScheduledEvents();
                    }, 200);
                }
                
                // Calculate offline time and apply status changes
                const offlineTime = (Date.now() - state.time.last) / 1000; // seconds
                if (offlineTime > 60 && state.confirmed) { // More than 1 minute offline
                    console.log('Offline time:', Math.floor(offlineTime / 60), 'minutes');
                    
                    // Apply offline consumption (same rates as game loop)
                    const hungerRate = 100 / 86400; // 24 hours to deplete
                    const thirstRate = (100 / 86400) * 1.2; // 20 hours to deplete
                    const energyRate = 100 / 86400; // 24 hours to deplete
                    
                    state.status.hunger = Math.max(0, state.status.hunger - hungerRate * offlineTime);
                    state.status.thirst = Math.max(0, state.status.thirst - thirstRate * offlineTime);
                    state.status.energy = Math.max(0, state.status.energy - energyRate * offlineTime);
                    
                    // Automatick√© konzumov√°n√≠ pokud m√° hr√°ƒç perk
                    autoConsumeIfDying();
                    
                    // Log if significant time passed
                    if (offlineTime > 600) { // More than 10 minutes
                        const hours = Math.floor(offlineTime / 3600);
                        const mins = Math.floor((offlineTime % 3600) / 60);
                        addLog(`Byl jsi offline ${hours}h ${mins}m - hlad, ≈æ√≠ze≈à a energie klesly!`, '‚è∞');
                    }
                }
                
                // Add sleeping bag ONLY ONCE for old saves (not if player sold it)
                // Use migration flag to prevent re-adding after player sells it
                if (!state.sleepingBagMigrated && state.confirmed) {
                    const hasSleepingBag = state.inv.find(i => i.id === 'sleeping_bag');
                    if (!hasSleepingBag) {
                        state.inv.push({ 
                            id: 'sleeping_bag', 
                            name: 'Spac√°k', 
                            icon: 'üõèÔ∏è', 
                            type: 'tool', 
                            effect: 'sleep', 
                            value: 1, 
                            weight: 2,
                            stackable: false,
                            unique: true
                        });
                        console.log('‚úì Spac√°k p≈ôid√°n do invent√°≈ôe (jednor√°zov√° migrace)');
                    }
                }
                // V≈ΩDY nastav flag (i kdy≈æ hr√°ƒç spac√°k u≈æ m√°) - zabr√°n√≠ opƒõtovn√©mu p≈ôid√°n√≠ po prodeji
                state.sleepingBagMigrated = true;
                
                // Migrace existuj√≠c√≠ch spac√°k≈Ø - ponech jen jeden a oprav vlastnosti
                const sleepingBags = state.inv.filter(i => i.id === 'sleeping_bag');
                if (sleepingBags.length > 0) {
                    // Oprav prvn√≠ spac√°k
                    sleepingBags[0].type = 'tool';
                    sleepingBags[0].stackable = false;
                    sleepingBags[0].unique = true;
                    delete sleepingBags[0].count; // Odstra≈à count
                    
                    // Sma≈æ p≈ôebyteƒçn√© spac√°ky
                    if (sleepingBags.length > 1) {
                        for (let i = 1; i < sleepingBags.length; i++) {
                            const idx = state.inv.indexOf(sleepingBags[i]);
                            if (idx > -1) state.inv.splice(idx, 1);
                        }
                        console.log('‚úì P≈ôebyteƒçn√© spac√°ky odstranƒõny:', sleepingBags.length - 1, 'ks');
                    }
                }
                
                // Migrace state.world pro nov√Ω mapov√Ω syst√©m
                if (!state.world || !state.world.currentLocation) {
                    state.world = {
                        currentLocation: 'shelter',
                        visitedLocations: ['shelter'],
                        traveling: false,
                        travelTo: null,
                        travelPath: null,
                        travelStart: 0,
                        travelDuration: 0,
                        locationCooldowns: {}
                    };
                    console.log('‚úì Migrace: state.world inicializov√°n pro nov√Ω mapov√Ω syst√©m');
                }
                
                // === RESET NEPLATN√âHO TRAVELING STAVU ===
                if (state.world.traveling) {
                    const now = Date.now();
                    const travelEnd = (state.world.travelStart || 0) + (state.world.travelDuration || 0);
                    
                    // Resetuj pokud: cestov√°n√≠ mƒõlo d√°vno skonƒçit, chyb√≠ c√≠l, nebo chyb√≠ duration
                    if ((travelEnd > 0 && now > travelEnd + 5000) || !state.world.travelTo || !state.world.travelDuration) {
                        console.log('üîß Migrace: Reset neplatn√©ho traveling stavu');
                        state.world.traveling = false;
                        state.world.travelTo = null;
                        state.world.travelPath = null;
                        state.world.scheduledEvents = [];
                        state.map.traveling = false;
                    }
                }
                
                // Synchronizace map.traveling s world.traveling
                state.map.traveling = state.world.traveling;
                
                // Zajisti ≈æe locationCooldowns existuje
                if (!state.world.locationCooldowns) {
                    state.world.locationCooldowns = {};
                }
                
                // Spus≈• kompletn√≠ migraci pro v≈°echny chybƒõj√≠c√≠ vlastnosti
                migrateState();
                
                // Obnov prob√≠haj√≠c√≠ akci (lov, pr≈Øzkum, tƒõ≈æba...)
                resumeCurrentAction();
                
                // === KONTROLA RE√ÅLN√âHO ƒåASU ===
                verifyRealTime();
                
                // Po naƒçten√≠ v≈ædy p≈ôepni na Online tab
                state.activeTab = 'multiplayer';
                
                console.log('‚úì Hra naƒçtena z auto-save', {
                    confirmed: state.confirmed,
                    charName: state.char.name,
                    level: state.char.lvl,
                    classId: state.char.classId
                });
                
                // === KONTROLA CHR√ÅNƒöN√âHO NICKU PO AUTO-LOAD ===
                setTimeout(() => {
                    if (state.confirmed && state.char?.name) {
                        const nicknameCheck = checkProtectedNickname();
                        if (nicknameCheck instanceof Promise) {
                            // ƒåek√° na ovƒõ≈ôen√≠ hesla
                            nicknameCheck.then(() => {
                                renderFull();
                            });
                        }
                    }
                }, 100);
                
            } catch(e) {
                console.error('‚ùå Auto-load failed:', e);
            }
        } else {
            console.log('‚ÑπÔ∏è ≈Ω√°dn√° ulo≈æen√° hra nenalezena - vytvo≈ô novou postavu');
        }
        
        // Modal click handler - close when clicking outside content (desktop only)
        document.getElementById('modal').addEventListener('click', (e) => {
            // Neklikat kdy≈æ prob√≠h√° boj!
            if (window.combatState) return;
            
            // Neklikat bƒõhem sp√°nku!
            if (state.isSleeping && state.sleepEndTime && Date.now() < state.sleepEndTime) return;
            
            // Only on desktop - prevent issues with mobile keyboard
            if (window.innerWidth >= 768 && e.target.id === 'modal') {
                closeModal();
            }
        });
        
        // Resume AudioContext on first user interaction (required by browser policies)
        document.addEventListener('click', function resumeAudio() {
            SoundSystem.resume();
            // Remove listener after first click
            document.removeEventListener('click', resumeAudio);
        }, { once: true });
        
        // Also try to resume on any touch for mobile
        document.addEventListener('touchstart', function resumeAudioTouch() {
            SoundSystem.resume();
            document.removeEventListener('touchstart', resumeAudioTouch);
        }, { once: true });
        
        // === CHR√ÅNƒöN√â NICKY ===
        const _0x=(s)=>{let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h=h&h;}const x=h.toString()+'x7K9m'+s.length;let h2=0;for(let i=0;i<x.length;i++){h2=((h2<<5)-h2)+x.charCodeAt(i);h2=h2&h2;}return h2.toString(16);};
        const PROTECTED_NICKNAMES = {
            // Chr√°nƒõn√© nicky s heslem
            'zaoo': 'maslo',
            'Zaoo': 'maslo',
            'ZAOO': 'maslo',
            'admin': false, // false = blokov√°no √∫plnƒõ
            'Admin': false,
            'ADMIN': false,
            'administrator': false,
            'moderator': false,
            'developer': false,
            'system': false
        };
        
        function checkProtectedNickname() {
            const playerName = state.char?.name;
            if (!playerName) return true; // Nov√° hra, OK
            
            // Kontrola v≈°ech variant
            const protectedPassword = PROTECTED_NICKNAMES[playerName] || PROTECTED_NICKNAMES[playerName.toLowerCase()];
            
            if (protectedPassword) {
                // Kontrola jestli u≈æ je ovƒõ≈ôen v t√©to session
                const sessionKey = 'nickname_verified_' + playerName.toLowerCase();
                if (sessionStorage.getItem(sessionKey) === 'true') {
                    return true; // U≈æ ovƒõ≈ôen
                }
                
                // Zobraz heslo modal
                return new Promise((resolve) => {
                    showProtectedNicknameModal(playerName, protectedPassword, resolve);
                });
            }
            
            return true; // Nick nen√≠ chr√°nƒõn√Ω
        }
        
        function showProtectedNicknameModal(nickname, correctPassword, callback) {
            // Ulo≈æ stav - ƒçek√°me na heslo (persistentn√≠ p≈ôes refresh)
            window._pendingPasswordPrompt = {
                nickname: nickname,
                correctPassword: correctPassword,
                callback: callback
            };
            
            // Ulo≈æ i do sessionStorage pro p≈ôe≈æit√≠ refreshe
            sessionStorage.setItem('pending_password_prompt', JSON.stringify({
                nickname: nickname,
                correctPassword: correctPassword
            }));
            
            renderProtectedNicknameModal();
        }
        
        function renderProtectedNicknameModal() {
            const pending = window._pendingPasswordPrompt;
            if (!pending) return;
            
            const { nickname, correctPassword } = pending;
            
            const modalEl = document.getElementById('modal');
            const contentEl = document.getElementById('modalContent');
            
            contentEl.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                    <h2 style="color: #ff9800; margin-bottom: 0.5rem;">Chr√°nƒõn√Ω √∫ƒçet</h2>
                    <p style="color: #888; margin-bottom: 1.5rem;">Nick <strong style="color: #8bc34a;">${escapeHtml(nickname)}</strong> je chr√°nƒõn√Ω heslem.</p>
                    
                    <input type="password" id="nicknamePasswordInput" placeholder="Zadej heslo..." 
                        style="width: 100%; padding: 0.8rem; font-size: 1.1rem; background: #1a1a1a; border: 2px solid #ff9800; border-radius: 8px; color: #fff; text-align: center; margin-bottom: 1rem;"
                        onkeypress="if(event.key==='Enter') verifyNicknamePassword('${escapeHtml(nickname)}', '${correctPassword}')">
                    
                    <div id="nicknamePasswordError" style="color: #f44336; margin-bottom: 1rem; display: none;">‚ùå ≈†patn√© heslo!</div>
                    
                    <button class="btn" onclick="verifyNicknamePassword('${escapeHtml(nickname)}', '${correctPassword}')" style="width: 100%; background: #4CAF50; padding: 0.8rem; margin-bottom: 0.5rem;">
                        ‚úì Ovƒõ≈ôit
                    </button>
                    
                    <button class="btn" onclick="resetToNewNickname()" style="width: 100%; background: #c62828; padding: 0.8rem;">
                        üîÑ Pou≈æ√≠t jin√Ω nick
                    </button>
                </div>
            `;
            
            modalEl.classList.add('show');
            
            // Focus na input
            setTimeout(() => {
                document.getElementById('nicknamePasswordInput')?.focus();
            }, 100);
        }
        
        function verifyNicknamePassword(nickname, correctPassword) {
            const input = document.getElementById('nicknamePasswordInput');
            const errorEl = document.getElementById('nicknamePasswordError');
            
            // Porovnej plaintext heslo (pro jednoduchost)
            const enteredPassword = input?.value?.trim();
            if (enteredPassword && enteredPassword === correctPassword) {
                // Spr√°vn√© heslo - vyƒçisti pending stav
                window._pendingPasswordPrompt = null;
                sessionStorage.removeItem('pending_password_prompt');
                
                sessionStorage.setItem('nickname_verified_' + nickname.toLowerCase(), 'true');
                closeModal();
                
                const callback = window._pendingPasswordPrompt?.callback;
                if (callback) {
                    callback(true);
                }
                
                notifySuccess('‚úì Ovƒõ≈ôeno', 'V√≠tej zpƒõt, ' + nickname + '!');
                renderFull();
            } else {
                // ≈†patn√© heslo
                if (errorEl) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = '‚ùå ≈†patn√© heslo! Zkus to znovu.';
                }
                if (input) {
                    input.style.borderColor = '#f44336';
                    input.value = '';
                    input.focus();
                }
            }
        }
        
        function resetToNewNickname() {
            // Vyƒçisti pending stav
            window._pendingPasswordPrompt = null;
            sessionStorage.removeItem('pending_password_prompt');
            
            // Zmƒõ≈à nick na nƒõco jin√©ho
            const newNick = 'P≈ôe≈æiv≈°√≠_' + Math.floor(Math.random() * 10000);
            state.char.name = newNick;
            closeModal();
            
            notifyWarning('Nick zmƒõnƒõn', 'Tv≈Øj nov√Ω nick je: ' + newNick);
            saveGame();
            renderFull();
        }
        
        // Kontrola neplatn√©ho mutanta (class mutant ale nem√° 5 mutac√≠)
        function checkInvalidMutant() {
            if (!state.confirmed) return;
            if (state.char?.classId !== 'mutant' && state.char?.class !== 'mutant') return;
            
            const mutationCount = state.mutations?.length || 0;
            if (mutationCount < 5) {
                console.log(`‚ö†Ô∏è Mutant s ${mutationCount} mutacemi - p≈ôid√°v√°m chybƒõj√≠c√≠`);
                // P≈ôidej n√°hodn√© mutace do 5
                const allMutations = ['thick_skin', 'night_vision', 'fast_metabolism', 'radiation_immunity', 'regeneration', 'extra_arm', 'enhanced_senses', 'toxic_blood'];
                if (!state.mutations) state.mutations = [];
                
                while (state.mutations.length < 5) {
                    const available = allMutations.filter(m => !state.mutations.includes(m));
                    if (available.length === 0) break;
                    const randomMutation = available[Math.floor(Math.random() * available.length)];
                    state.mutations.push(randomMutation);
                }
                saveGame();
            }
        }
        
        // Prvotn√≠ renderFull - bez kontroly nicku (defaultn√≠ state nem√° re√°ln√Ω nick)
        renderFull();
        
        // Kontrola neplatn√©ho mutanta (star√Ω save bez 5 mutac√≠)
        setTimeout(() => {
            checkInvalidMutant();
        }, 500);
        
        // Zkontroluj a zobraz p≈ô√≠padn√Ω neulo≈æen√Ω modal
        setTimeout(() => {
            checkPendingModal();
        }, 1000);
        
        // Obnov pending password prompt ze sessionStorage (p≈ôe≈æije refresh)
        setTimeout(() => {
            const pendingPromptData = sessionStorage.getItem('pending_password_prompt');
            if (pendingPromptData && !window._pendingPasswordPrompt) {
                try {
                    const data = JSON.parse(pendingPromptData);
                    if (data.nickname && data.correctPassword) {
                        console.log('üîí Obnovuji password prompt pro:', data.nickname);
                        window._pendingPasswordPrompt = {
                            nickname: data.nickname,
                            correctPassword: data.correctPassword,
                            callback: () => {} // Dummy callback po refreshi
                        };
                        renderProtectedNicknameModal();
                    }
                } catch (e) {
                    console.error('Chyba p≈ôi obnoven√≠ password prompt:', e);
                    sessionStorage.removeItem('pending_password_prompt');
                }
            }
        }, 1500);
        
        // ============================================================
        // üåê MULTIPLAYER SYST√âM - Leaderboard, Chat, Obchod, PvP
        // ============================================================
        
        // üî• FIREBASE KONFIGURACE
        const firebaseConfig = {
            apiKey: "AIzaSyAnqRlz8iSsMTKa0PePTIvbPwncG1yj9RM",
            authDomain: "posledni-prezivsi.firebaseapp.com",
            databaseURL: "https://posledni-prezivsi-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "posledni-prezivsi",
            storageBucket: "posledni-prezivsi.firebasestorage.app",
            messagingSenderId: "593304244516",
            appId: "1:593304244516:web:dd99f403be270dc89a63b1"
        };
        
        // Inicializace Firebase
        function initFirebase() {
            try {
                // Kontrola jestli je Firebase SDK naƒçten√©
                if (typeof firebase === 'undefined') {
                    console.log('‚ö†Ô∏è Firebase SDK nen√≠ naƒçten√© - zkus√≠m znovu za 2s');
                    updateOnlineIndicator('loading');
                    setTimeout(initFirebase, 2000);
                    return false;
                }
                
                if (firebaseConfig.apiKey === "TVUJ_API_KEY") {
                    console.log('‚ö†Ô∏è Firebase nen√≠ nakonfigurov√°n - multiplayer vypnut');
                    updateOnlineIndicator('offline');
                    return false;
                }
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDB = firebase.database();
                firebaseAuth = firebase.auth();
                multiplayerEnabled = true;
                console.log('‚úÖ Firebase p≈ôipojen - multiplayer aktivn√≠!');
                
                // Naƒçti staff ƒçleny z Firebase
                loadStaffMembers();
                
                // P≈ôedbƒõ≈ænƒõ naƒçti territory cache
                firebaseDB.ref('territories').once('value').then(terrSnapshot => {
                    window.territoryCache = terrSnapshot.val() || {};
                    window.territoryCacheTime = Date.now();
                    console.log('üó∫Ô∏è Pre-loaded territory cache:', Object.keys(window.territoryCache).length, 'territories');
                    // P≈ôekresli mapu pokud je aktivn√≠
                    if (state.activeTab === 'map') {
                        renderFull();
                    }
                }).catch(e => console.log('Territory pre-load error:', e));
                
                // Poslouchej zmƒõny p≈ôihl√°≈°en√≠
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        isGuest = user.isAnonymous;
                        console.log('‚úÖ P≈ôihl√°≈°en:', user.email || 'Host');
                        
                        // KONTROLA BANU
                        const playerName = state.char?.name || localStorage.getItem('playerName');
                        if (playerName) {
                            try {
                                const banSnap = await firebaseDB.ref('bannedPlayers/' + playerName).once('value');
                                const banData = banSnap.val();
                                if (banData) {
                                    // Zkontroluj jestli ban nevypr≈°el
                                    if (banData.until === 0 || banData.until > Date.now()) {
                                        const untilText = banData.until ? new Date(banData.until).toLocaleString('cs') : 'NAV≈ΩDY';
                                        showBanScreen(playerName, banData.reason, untilText);
                                        return; // Zastav inicializaci
                                    } else {
                                        // Ban vypr≈°el, odeber ho
                                        await firebaseDB.ref('bannedPlayers/' + playerName).remove();
                                    }
                                }
                            } catch(e) {
                                console.log('Ban check error:', e);
                            }
                        }
                        
                        // Naƒçti cloud save pokud existuje
                        // ALE pouze pokud:
                        // 1. Hra je≈°tƒõ nezaƒçala (nem√° confirmed stav)
                        // 2. A u≈æivatel AKTIVNƒö nevytv√°≈ô√≠ novou postavu
                        // 3. NOV√ù: A nen√≠ nastaven flag v sessionStorage
                        const isCreatingNewChar = window.creatingNewCharacter === true || 
                                                  sessionStorage.getItem('creatingNewCharacter') === 'true';
                        
                        // Odeber flag ze sessionStorage po kontrole
                        if (sessionStorage.getItem('creatingNewCharacter') === 'true') {
                            sessionStorage.removeItem('creatingNewCharacter');
                            window.creatingNewCharacter = true;
                            console.log('üÜï Detekov√°n flag nov√© postavy ze sessionStorage');
                        }
                        
                        if (!isGuest && !state.confirmed && !isCreatingNewChar) {
                            await loadCloudSave();
                        } else if (!isGuest && isCreatingNewChar) {
                            console.log('‚òÅÔ∏è P≈ôeskakuji auto-load cloud save - vytv√°≈ô√≠ se nov√° postava');
                        } else if (!isGuest && state.confirmed) {
                            console.log('‚òÅÔ∏è P≈ôeskakuji auto-load cloud save - hra u≈æ bƒõ≈æ√≠');
                        }
                        
                        // Spus≈• real-time cloud sync pro registrovan√© u≈æivatele
                        if (!isGuest && typeof setupCloudSyncListener === 'function') {
                            setTimeout(setupCloudSyncListener, 2000);
                        }
                        
                        // Spus≈• real-time listener na √∫zem√≠ pro okam≈æitou synchronizaci
                        setupTerritoryRealTimeListener();
                        
                        // Zkontroluj nevyzvednut√© odmƒõny od admina
                        if (!isGuest && state.char?.name) {
                            setTimeout(() => {
                                if (typeof checkPendingRewards === 'function') {
                                    checkPendingRewards();
                                }
                            }, 3000);
                        }
                        
                        updateOnlineIndicator('online');
                        renderFull();
                    } else {
                        currentUser = null;
                        isGuest = true;
                        console.log('‚ÑπÔ∏è Nep≈ôihl√°≈°en - re≈æim host');
                        updateOnlineIndicator('online');
                    }
                });
                
                // Aktualizuj indik√°tor
                updateOnlineIndicator('online');
                
                // Re-renderuj navigaci aby se zobrazil online status
                renderFull();
                
                // Nastav online status
                setupOnlineStatus();
                
                // Zkontroluj reset frakƒçn√≠ sez√≥ny
                checkSeasonReset();
                
                // Naƒçti VIP barvy
                loadVIPColors();
                
                // Naƒçti chat zpr√°vy
                listenToChat();
                
                // Naƒçti marketplace
                listenToMarketplace();
                
                // Naƒçti PvP v√Ωzvy
                listenToPvP();
                
                // Nastav listener na soukrom√© zpr√°vy (pro poƒçet nep≈ôeƒçten√Ωch)
                listenToPrivateMessages();
                
                return true;
            } catch (e) {
                console.error('‚ùå Firebase chyba:', e);
                multiplayerEnabled = false;
                updateOnlineIndicator('error');
                return false;
            }
        }
        
        // Funkce pro aktualizaci online indik√°toru v headeru
        function updateOnlineIndicator(status) {
            const indicator = document.getElementById('onlineIndicator');
            const icon = document.getElementById('onlineStatusIcon');
            if (!indicator || !icon) return;
            
            switch(status) {
                case 'online':
                    icon.textContent = 'üü¢';
                    indicator.style.background = 'linear-gradient(180deg, #1a3a1a 0%, #0a2a0a 100%)';
                    indicator.style.borderColor = '#4CAF50';
                    indicator.title = 'Online - klikni pro multiplayer';
                    break;
                case 'offline':
                    icon.textContent = 'üî¥';
                    indicator.style.background = 'linear-gradient(180deg, #3a1a1a 0%, #2a0a0a 100%)';
                    indicator.style.borderColor = '#f44336';
                    indicator.title = 'Offline - multiplayer nedostupn√Ω';
                    break;
                case 'loading':
                    icon.textContent = 'üü°';
                    indicator.style.background = 'linear-gradient(180deg, #3a3a1a 0%, #2a2a0a 100%)';
                    indicator.style.borderColor = '#ff9800';
                    indicator.title = 'P≈ôipojov√°n√≠...';
                    break;
                case 'error':
                    icon.textContent = '‚ö†Ô∏è';
                    indicator.style.background = 'linear-gradient(180deg, #3a2a1a 0%, #2a1a0a 100%)';
                    indicator.style.borderColor = '#ff5722';
                    indicator.title = 'Chyba p≈ôipojen√≠ - klikni pro detaily';
                    break;
                default:
                    icon.textContent = '‚ö´';
                    indicator.style.background = '#222';
                    indicator.style.borderColor = '#444';
                    indicator.title = 'Nezn√°m√Ω stav';
            }
        }
        
        // Inicializuj po naƒçten√≠ str√°nky
        setTimeout(initFirebase, 1500);
        
        // Nastav loading stav hned
        setTimeout(() => updateOnlineIndicator('loading'), 100);
        
        // === AUTHENTICATION SYST√âM ===
        
        // Zobraz√≠ p≈ôihla≈°ovac√≠/registraƒçn√≠ modal
        function showAuthModal() {
            if (!multiplayerEnabled || !firebaseAuth) {
                showModal('‚ö†Ô∏è Offline', 'Multiplayer nen√≠ dostupn√Ω.');
                return;
            }
            
            const isLoggedIn = currentUser && !currentUser.isAnonymous;
            
            if (isLoggedIn) {
                // U≈æ je p≈ôihl√°≈°en - zobraz profil √∫ƒçtu
                showAccountProfile();
                return;
            }
            
            showModal('üîê P≈ôihl√°≈°en√≠', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üë§</div>
                    <p style="color: #888;">P≈ôihlas se pro cloud save a ochranu nicku</p>
                </div>
                
                <div style="display: grid; gap: 0.8rem;">
                    <button class="btn" onclick="showLoginForm()" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); padding: 1rem;">
                        üîë P≈ôihl√°sit se
                    </button>
                    <button class="btn" onclick="showRegisterForm()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 1rem;">
                        üìù Registrace
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                        üë§ Pokraƒçovat jako host
                    </button>
                </div>
                
                <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 1rem;">
                    Jako host m≈Ø≈æe≈° hr√°t, ale save z≈Østane jen v tomto prohl√≠≈æeƒçi.
                </p>
            `);
        }
        
        // P≈ôep√≠n√°n√≠ viditelnosti hesla
        function togglePasswordVisibility(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.textContent = 'üôà';
            } else {
                input.type = 'password';
                iconElement.textContent = 'üëÅÔ∏è';
            }
        }
        
        function showLoginForm() {
            showModal('üîë P≈ôihl√°≈°en√≠', `
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Email:</label>
                    <input type="email" id="authEmail" placeholder="tvuj@email.cz"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo:</label>
                    <div style="position: relative;">
                        <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('authPassword', this)" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-70%); cursor: pointer; font-size: 1.1rem; user-select: none;">üëÅÔ∏è</span>
                    </div>
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doLogin()" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); padding: 0.8rem; margin-bottom: 0.5rem;">
                        üîë P≈ôihl√°sit
                    </button>
                    
                    <button class="btn" onclick="showForgotPassword()" style="width: 100%; background: #333; padding: 0.6rem; font-size: 0.85rem;">
                        üîÑ Zapomenut√© heslo
                    </button>
                </div>
                <button class="btn" onclick="showAuthModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        function showRegisterForm() {
            showModal('üìù Registrace', `
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Hern√≠ nick (bude chr√°nƒõn):</label>
                    <input type="text" id="authNick" placeholder="TvujNick" maxlength="20"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Email:</label>
                    <input type="email" id="authEmail" placeholder="tvuj@email.cz"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo (min. 6 znak≈Ø):</label>
                    <div style="position: relative;">
                        <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('authPassword', this)" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-70%); cursor: pointer; font-size: 1.1rem; user-select: none;">üëÅÔ∏è</span>
                    </div>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo znovu:</label>
                    <div style="position: relative;">
                        <input type="password" id="authPassword2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('authPassword2', this)" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-70%); cursor: pointer; font-size: 1.1rem; user-select: none;">üëÅÔ∏è</span>
                    </div>
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doRegister()" style="width: 100%; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 0.8rem;">
                        üìù Zaregistrovat
                    </button>
                </div>
                <button class="btn" onclick="showAuthModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        // Speci√°ln√≠ formul√°≈ô pro registraci chr√°nƒõn√©ho nicku
        function showProtectedNickRegistration(nick, email, password, password2) {
            showModal('üîí Chr√°nƒõn√Ω nick', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üîí</div>
                    <p style="color: #ff9800;">Nick <strong>${escapeHtml(nick)}</strong> je chr√°nƒõn√Ω!</p>
                    <p style="color: #888; font-size: 0.85rem;">Pokud jsi opr√°vnƒõn√Ω vlastn√≠k, zadej speci√°ln√≠ heslo.</p>
                </div>
                
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Heslo pro chr√°nƒõn√Ω nick:</label>
                    <input type="password" id="authProtectedPassword" placeholder="Zadej heslo..."
                        style="width: 100%; padding: 0.6rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 2px solid #ff9800; border-radius: 4px;">
                    
                    <!-- Skryt√© pole pro uchov√°n√≠ dat -->
                    <input type="hidden" id="authNick" value="${escapeHtml(nick)}">
                    <input type="hidden" id="authEmail" value="${escapeHtml(email || '')}">
                    <input type="hidden" id="authPassword" value="${escapeHtml(password || '')}">
                    <input type="hidden" id="authPassword2" value="${escapeHtml(password2 || '')}">
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doRegister()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        üîì Ovƒõ≈ôit a pokraƒçovat
                    </button>
                </div>
                <button class="btn" onclick="showRegisterForm()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        function showForgotPassword() {
            showModal('üîÑ Reset hesla', `
                <div style="text-align: left;">
                    <p style="color: #888; margin-bottom: 1rem;">Zadej email a po≈°leme ti odkaz pro reset hesla.</p>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Email:</label>
                    <input type="email" id="authEmail" placeholder="tvuj@email.cz"
                        style="width: 100%; padding: 0.6rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <div id="authError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doResetPassword()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        üìß Odeslat reset
                    </button>
                </div>
                <button class="btn" onclick="showLoginForm()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function doLogin() {
            const email = document.getElementById('authEmail')?.value?.trim();
            const password = document.getElementById('authPassword')?.value;
            const errorDiv = document.getElementById('authError');
            
            if (!email || !password) {
                if (errorDiv) { errorDiv.textContent = 'Vypl≈à email a heslo!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                if (errorDiv) { errorDiv.textContent = '‚è≥ P≈ôihla≈°uji...'; errorDiv.style.display = 'block'; errorDiv.style.color = '#ff9800'; }
                
                const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
                
                closeModal();
                notifySuccess('‚úÖ P≈ôihl√°≈°eno!', 'V√≠tej zpƒõt, ' + (userCredential.user.displayName || email));
                
            } catch (error) {
                console.error('Login error:', error);
                let msg = 'Chyba p≈ôihl√°≈°en√≠';
                if (error.code === 'auth/user-not-found') msg = '√öƒçet neexistuje';
                else if (error.code === 'auth/wrong-password') msg = '≈†patn√© heslo';
                else if (error.code === 'auth/invalid-email') msg = 'Neplatn√Ω email';
                else if (error.code === 'auth/too-many-requests') msg = 'P≈ô√≠li≈° mnoho pokus≈Ø, zkus pozdƒõji';
                
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
            }
        }
        
        async function doRegister() {
            const nick = document.getElementById('authNick')?.value?.trim();
            const email = document.getElementById('authEmail')?.value?.trim();
            const password = document.getElementById('authPassword')?.value;
            const password2 = document.getElementById('authPassword2')?.value;
            const protectedPassword = document.getElementById('authProtectedPassword')?.value?.trim();
            const errorDiv = document.getElementById('authError');
            
            if (!nick || nick.length < 3) {
                if (errorDiv) { errorDiv.textContent = 'Nick mus√≠ m√≠t alespo≈à 3 znaky!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            // Kontrola chr√°nƒõn√Ωch nick≈Ø
            const nickLower = nick.toLowerCase();
            const protectedNickValue = PROTECTED_NICKNAMES[nick] || PROTECTED_NICKNAMES[nickLower];
            
            if (protectedNickValue !== undefined) {
                if (protectedNickValue === false) {
                    // Nick je √∫plnƒõ blokovan√Ω
                    if (errorDiv) { errorDiv.textContent = 'Tento nick je rezervovan√Ω a nelze ho pou≈æ√≠t!'; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
                    return;
                } else if (typeof protectedNickValue === 'string') {
                    // Nick vy≈æaduje heslo
                    if (!protectedPassword) {
                        // Zobraz pole pro heslo
                        showProtectedNickRegistration(nick, email, password, password2);
                        return;
                    }
                    if (protectedPassword !== protectedNickValue) {
                        if (errorDiv) { errorDiv.textContent = '≈†patn√© heslo pro chr√°nƒõn√Ω nick!'; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
                        return;
                    }
                }
            }
            
            if (!email) {
                if (errorDiv) { errorDiv.textContent = 'Vypl≈à email!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (!password || password.length < 6) {
                if (errorDiv) { errorDiv.textContent = 'Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (password !== password2) {
                if (errorDiv) { errorDiv.textContent = 'Hesla se neshoduj√≠!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                if (errorDiv) { errorDiv.textContent = '‚è≥ Kontroluji nick...'; errorDiv.style.display = 'block'; errorDiv.style.color = '#ff9800'; }
                
                // Zkontroluj jestli nick nen√≠ zabran√Ω
                const nickCheck = await firebaseDB.ref('registeredNicks/' + nick.toLowerCase()).once('value');
                if (nickCheck.exists()) {
                    if (errorDiv) { errorDiv.textContent = 'Tento nick je u≈æ zabran√Ω!'; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
                    return;
                }
                
                if (errorDiv) { errorDiv.textContent = '‚è≥ Vytv√°≈ô√≠m √∫ƒçet...'; }
                
                // Vytvo≈ô √∫ƒçet
                const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                
                // Nastav display name
                await userCredential.user.updateProfile({ displayName: nick });
                
                // Zaregistruj nick v datab√°zi
                await firebaseDB.ref('registeredNicks/' + nick.toLowerCase()).set({
                    odid: userCredential.user.uid,
                    nick: nick,
                    email: email,
                    registeredAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Ulo≈æ user data
                await firebaseDB.ref('users/' + userCredential.user.uid).set({
                    nick: nick,
                    email: email,
                    registeredAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Nastav nick ve h≈ôe
                state.char.name = nick;
                
                closeModal();
                notifySuccess('‚úÖ Registrace √∫spƒõ≈°n√°!', 'V√≠tej, ' + nick + '!');
                
                // Ulo≈æ hru do cloudu
                await saveCloudSave();
                
                renderFull();
                
            } catch (error) {
                console.error('Register error:', error);
                let msg = 'Chyba registrace';
                if (error.code === 'auth/email-already-in-use') msg = 'Email u≈æ je registrov√°n';
                else if (error.code === 'auth/invalid-email') msg = 'Neplatn√Ω email';
                else if (error.code === 'auth/weak-password') msg = 'Heslo je p≈ô√≠li≈° slab√©';
                
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
            }
        }
        
        async function doResetPassword() {
            const email = document.getElementById('authEmail')?.value?.trim();
            const errorDiv = document.getElementById('authError');
            
            if (!email) {
                if (errorDiv) { errorDiv.textContent = 'Vypl≈à email!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                await firebaseAuth.sendPasswordResetEmail(email);
                closeModal();
                notifySuccess('üìß Email odesl√°n!', 'Zkontroluj schr√°nku pro reset hesla.');
            } catch (error) {
                console.error('Reset error:', error);
                let msg = 'Chyba p≈ôi odes√≠l√°n√≠';
                if (error.code === 'auth/user-not-found') msg = '√öƒçet s t√≠mto emailem neexistuje';
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; }
            }
        }
        
        function showAccountProfile() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            const isAnon = currentUser.isAnonymous;
            const email = currentUser.email || 'Host';
            const nick = currentUser.displayName || state.char.name || 'Nezn√°m√Ω';
            
            showModal('üë§ M≈Øj √∫ƒçet', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${isAnon ? 'üë§' : '‚úÖ'}</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #ffd700;">${escapeHtml(nick)}</div>
                    <div style="color: #888; font-size: 0.85rem;">${isAnon ? 'Re≈æim host' : escapeHtml(email)}</div>
                </div>
                
                ${isAnon ? `
                    <div style="background: #2a2a1a; padding: 1rem; border-radius: 8px; border: 1px solid #ff9800; margin-bottom: 1rem;">
                        <p style="color: #ff9800; margin: 0;">‚ö†Ô∏è Hraje≈° jako host. Registruj se pro:</p>
                        <ul style="color: #ccc; margin: 0.5rem 0 0 1rem; font-size: 0.85rem;">
                            <li>Cloud save (hraj na v√≠ce za≈ô√≠zen√≠ch)</li>
                            <li>Ochranu nicku</li>
                            <li>Obnoven√≠ √∫ƒçtu p≈ôi ztr√°tƒõ dat</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="showRegisterForm()" style="width: 100%; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 1rem; margin-bottom: 0.5rem;">
                        üìù Registrovat se
                    </button>
                ` : `
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; border: 1px solid #4CAF50; margin-bottom: 1rem;">
                        <p style="color: #4CAF50; margin: 0 0 0.5rem 0;">‚úÖ √öƒçet ovƒõ≈ôen</p>
                        <p style="color: #888; font-size: 0.8rem; margin: 0;">Tv≈Øj save je automaticky ukl√°d√°n do cloudu.</p>
                    </div>
                    
                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="saveCloudSave(); notifySuccess('‚òÅÔ∏è Ulo≈æeno', 'Save ulo≈æen do cloudu');" style="background: #4CAF50; padding: 0.8rem;">
                            ‚òÅÔ∏è Ulo≈æit do cloudu
                        </button>
                        <button class="btn" onclick="confirmLoadCloud()" style="background: #2196f3; padding: 0.8rem;">
                            üì• Naƒç√≠st z cloudu
                        </button>
                        <button class="btn" onclick="showChangePasswordForm()" style="background: #ff9800; padding: 0.8rem;">
                            üîë Zmƒõnit heslo
                        </button>
                    </div>
                    
                    <button class="btn" onclick="doLogout()" style="width: 100%; background: #8B0000; padding: 0.8rem; margin-bottom: 0.5rem;">
                        üö™ Odhl√°sit se
                    </button>
                `}
                
                <div style="border-top: 1px solid #333; padding-top: 1rem; margin-top: 0.5rem;">
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem; text-align: center;">Spr√°va hry:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="updateGame()" style="background: #3949AB; padding: 0.6rem; font-size: 0.85rem;">
                            üîÑ Aktualizovat
                        </button>
                        <button class="btn" onclick="confirmNewGame()" style="background: #8B0000; padding: 0.6rem; font-size: 0.85rem;">
                            üÜï Nov√° hra
                        </button>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>
            `);
        }
        
        function confirmLoadCloud() {
            showModal('üì• Naƒç√≠st z cloudu?', `
                <div style="text-align: center;">
                    <p style="color: #ff9800;">‚ö†Ô∏è T√≠m p≈ôep√≠≈°e≈° souƒçasn√Ω lok√°ln√≠ save!</p>
                    <p style="color: #888;">Opravdu chce≈° naƒç√≠st save z cloudu?</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showAccountProfile()" style="background: #555;">Zru≈°it</button>
                    <button class="btn" onclick="loadCloudSave(true); closeModal();" style="background: #2196f3;">üì• Naƒç√≠st</button>
                </div>
            `);
        }
        
        function showChangePasswordForm() {
            showModal('üîë Zmƒõnit heslo', `
                <div style="text-align: left;">
                    <label style="color: #aaa; font-size: 0.85rem;">Souƒçasn√© heslo:</label>
                    <div style="position: relative;">
                        <input type="password" id="currentPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('currentPassword', this)" 
                            style="position: absolute; right: 10px; top: 35%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; user-select: none;">üëÅÔ∏è</span>
                    </div>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Nov√© heslo (min. 6 znak≈Ø):</label>
                    <div style="position: relative;">
                        <input type="password" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('newPassword', this)" 
                            style="position: absolute; right: 10px; top: 35%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; user-select: none;">üëÅÔ∏è</span>
                    </div>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Nov√© heslo znovu:</label>
                    <div style="position: relative;">
                        <input type="password" id="newPassword2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            style="width: 100%; padding: 0.6rem; padding-right: 40px; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <span onclick="togglePasswordVisibility('newPassword2', this)" 
                            style="position: absolute; right: 10px; top: 35%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; user-select: none;">üëÅÔ∏è</span>
                    </div>
                    
                    <div id="changePassError" style="color: #f44336; font-size: 0.85rem; margin-bottom: 0.5rem; display: none;"></div>
                    
                    <button class="btn" onclick="doChangePassword()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        üîë Zmƒõnit heslo
                    </button>
                </div>
                <button class="btn" onclick="showAccountProfile()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function doChangePassword() {
            const currentPass = document.getElementById('currentPassword')?.value;
            const newPass = document.getElementById('newPassword')?.value;
            const newPass2 = document.getElementById('newPassword2')?.value;
            const errorDiv = document.getElementById('changePassError');
            
            if (!currentPass) {
                if (errorDiv) { errorDiv.textContent = 'Zadej souƒçasn√© heslo!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (!newPass || newPass.length < 6) {
                if (errorDiv) { errorDiv.textContent = 'Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            if (newPass !== newPass2) {
                if (errorDiv) { errorDiv.textContent = 'Nov√° hesla se neshoduj√≠!'; errorDiv.style.display = 'block'; }
                return;
            }
            
            try {
                if (errorDiv) { errorDiv.textContent = '‚è≥ Mƒõn√≠m heslo...'; errorDiv.style.display = 'block'; errorDiv.style.color = '#ff9800'; }
                
                // Reautentizace u≈æivatele
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass);
                await currentUser.reauthenticateWithCredential(credential);
                
                // Zmƒõna hesla
                await currentUser.updatePassword(newPass);
                
                closeModal();
                notifySuccess('‚úÖ Heslo zmƒõnƒõno!', 'Tvoje heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno.');
                
            } catch (error) {
                console.error('Change password error:', error);
                let msg = 'Chyba p≈ôi zmƒõnƒõ hesla';
                if (error.code === 'auth/wrong-password') msg = '≈†patn√© souƒçasn√© heslo!';
                else if (error.code === 'auth/weak-password') msg = 'Nov√© heslo je p≈ô√≠li≈° slab√©';
                else if (error.code === 'auth/requires-recent-login') msg = 'Odhl√°sit se a p≈ôihl√°sit se znovu';
                
                if (errorDiv) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; errorDiv.style.color = '#f44336'; }
            }
        }
        
        async function doLogout() {
            try {
                await firebaseAuth.signOut();
                currentUser = null;
                isGuest = true;
                closeModal();
                notifyInfo('üö™ Odhl√°≈°eno', 'Pokraƒçuje≈° jako host');
                renderFull();
            } catch (error) {
                console.error('Logout error:', error);
                notifyWarning('Chyba p≈ôi odhla≈°ov√°n√≠');
            }
        }
        
        // === CLOUD SAVE ===
        async function saveCloudSave() {
            if (!currentUser || currentUser.isAnonymous || !firebaseDB) return;
            
            try {
                const saveData = {
                    state: JSON.parse(JSON.stringify(state)),
                    savedAt: firebase.database.ServerValue.TIMESTAMP,
                    version: '59'
                };
                
                // Odstra≈à citliv√° data
                delete saveData.state.adminPassword;
                
                await firebaseDB.ref('cloudSaves/' + currentUser.uid).set(saveData);
                console.log('‚òÅÔ∏è Cloud save ulo≈æen');
                
            } catch (error) {
                console.error('Cloud save error:', error);
            }
        }
        
        async function loadCloudSave(showNotification = false) {
            if (!currentUser || currentUser.isAnonymous || !firebaseDB) return;
            
            // OCHRANA: Nenaƒç√≠tej cloud save bƒõhem cestov√°n√≠ nebo akce
            if (!showNotification) { // Pokud to nen√≠ manu√°ln√≠ naƒçten√≠
                if (state.world?.traveling || state.map?.traveling) {
                    console.log('‚òÅÔ∏è P≈ôeskakuji auto-load - prob√≠h√° cestov√°n√≠');
                    return;
                }
                if (state.currentAction && state.currentAction.endTime > Date.now()) {
                    console.log('‚òÅÔ∏è P≈ôeskakuji auto-load - prob√≠h√° akce');
                    return;
                }
            }
            
            try {
                const snapshot = await firebaseDB.ref('cloudSaves/' + currentUser.uid).once('value');
                const cloudData = snapshot.val();
                
                if (cloudData && cloudData.state) {
                    // Naƒçti cloud save
                    const loadedState = cloudData.state;
                    
                    // Zachovej nƒõkter√° lok√°ln√≠ nastaven√≠
                    loadedState.settings = state.settings;
                    
                    // Nastav state
                    Object.assign(state, loadedState);
                    
                    // Nastav nick z √∫ƒçtu
                    if (currentUser.displayName) {
                        state.char.name = currentUser.displayName;
                    }
                    
                    if (showNotification) {
                        const savedDate = cloudData.savedAt ? new Date(cloudData.savedAt).toLocaleString('cs-CZ') : 'Nezn√°m√©';
                        notifySuccess('‚òÅÔ∏è Cloud save naƒçten', 'Ze dne: ' + savedDate);
                    }
                    
                    renderFull();
                    saveGame(true); // Ulo≈æ lok√°lnƒõ
                    
                    console.log('‚òÅÔ∏è Cloud save naƒçten');
                } else if (showNotification) {
                    notifyInfo('‚òÅÔ∏è ≈Ω√°dn√Ω cloud save', 'V cloudu nen√≠ ulo≈æen√° hra');
                }
                
            } catch (error) {
                console.error('Cloud load error:', error);
                if (showNotification) {
                    notifyWarning('Chyba p≈ôi naƒç√≠t√°n√≠ z cloudu');
                }
            }
        }
        
        // === FIREBASE LISTENER REGISTRY ===
        // Centr√°ln√≠ registr pro spr√°vn√© uvolnƒõn√≠ Firebase listener≈Ø
        const _firebaseListeners = {
            listeners: [],
            
            /**
             * Registruje nov√Ω Firebase listener
             * @param {string} path - Cesta v datab√°zi
             * @param {string} eventType - Typ ud√°losti ('value', 'child_added', etc.)
             * @param {function} callback - Callback funkce
             * @param {function} errorCallback - Error callback (optional)
             * @returns {function} Unsubscribe funkce
             */
            subscribe(path, eventType, callback, errorCallback) {
                if (!firebaseDB) {
                    console.warn('Firebase DB nen√≠ inicializov√°na');
                    return () => {};
                }
                
                const ref = firebaseDB.ref(path);
                
                // Wrapper s error handlingem
                const wrappedCallback = (snapshot) => {
                    try {
                        callback(snapshot);
                    } catch (error) {
                        console.error(`Firebase listener error (${path}):`, error);
                        if (errorCallback) errorCallback(error);
                    }
                };
                
                // Zaregistruj listener
                ref.on(eventType, wrappedCallback, (error) => {
                    console.error(`Firebase subscription error (${path}):`, error);
                    if (errorCallback) errorCallback(error);
                });
                
                // Ulo≈æ do registry
                const listenerInfo = { path, eventType, callback: wrappedCallback, ref };
                this.listeners.push(listenerInfo);
                
                console.log(`üì° Firebase listener registered: ${path}`);
                
                // Vra≈• unsubscribe funkci
                return () => this.unsubscribe(listenerInfo);
            },
            
            /**
             * Odregistruje konkr√©tn√≠ listener
             */
            unsubscribe(listenerInfo) {
                const { ref, eventType, callback } = listenerInfo;
                try {
                    ref.off(eventType, callback);
                    this.listeners = this.listeners.filter(l => l !== listenerInfo);
                    console.log(`üì° Firebase listener removed: ${listenerInfo.path}`);
                } catch (e) {
                    console.warn('Error removing listener:', e);
                }
            },
            
            /**
             * Odstran√≠ v≈°echny listenery
             */
            unsubscribeAll() {
                console.log(`üì° Removing all ${this.listeners.length} Firebase listeners...`);
                this.listeners.forEach(({ ref, eventType, callback }) => {
                    try {
                        ref.off(eventType, callback);
                    } catch (e) {
                        console.warn('Error removing listener:', e);
                    }
                });
                this.listeners = [];
            },
            
            /**
             * Poƒçet aktivn√≠ch listener≈Ø
             */
            get count() {
                return this.listeners.length;
            }
        };
        
        // Cleanup p≈ôi odchodu ze str√°nky
        window.addEventListener('beforeunload', () => {
            _firebaseListeners.unsubscribeAll();
        });
        
        // Auto-save do cloudu ka≈æd√Ωch 2 minuty + real-time sync listener
        let lastCloudSaveTime = 0;
        let cloudSyncListener = null;
        let syncPaused = false; // Pauza bƒõhem lok√°ln√≠ch akc√≠
        
        // Auto-save ka≈æd√© 2 minuty
        setInterval(() => {
            if (currentUser && !currentUser.isAnonymous && !syncPaused) {
                saveCloudSave();
                lastCloudSaveTime = Date.now();
            }
        }, 2 * 60 * 1000);
        
        // Kontrola nevyzvednut√Ωch odmƒõn ka≈æd√Ωch 5 minut
        setInterval(() => {
            if (multiplayerEnabled && firebaseDB && state.char?.name && typeof checkPendingRewards === 'function') {
                checkPendingRewards();
            }
        }, 5 * 60 * 1000);
        
        // Real-time listener na √∫zem√≠ - synchronizuje zmƒõny okam≈æitƒõ
        let territoryRealTimeListener = null;
        function setupTerritoryRealTimeListener() {
            if (!firebaseDB) return;
            
            // Odstra≈à star√Ω listener
            if (territoryRealTimeListener) {
                firebaseDB.ref('territories').off('value', territoryRealTimeListener);
            }
            
            territoryRealTimeListener = firebaseDB.ref('territories').on('value', (snapshot) => {
                const newData = snapshot.val() || {};
                const oldCache = window.territoryCache || {};
                
                // Zkontroluj jestli se nƒõco zmƒõnilo
                const newKeys = Object.keys(newData);
                const oldKeys = Object.keys(oldCache);
                
                let changed = newKeys.length !== oldKeys.length;
                if (!changed) {
                    for (const key of newKeys) {
                        if (newData[key]?.owner !== oldCache[key]?.owner) {
                            changed = true;
                            break;
                        }
                    }
                }
                
                // Aktualizuj cache
                window.territoryCache = newData;
                window.territoryCacheTime = Date.now();
                
                // Pokud se nƒõco zmƒõnilo a jsme na mapƒõ, p≈ôekresli
                if (changed && state.activeTab === 'map') {
                    console.log('üó∫Ô∏è Territory real-time update detected');
                    setTimeout(() => renderFull(), 100);
                }
            });
            
            console.log('üó∫Ô∏è Territory real-time listener aktivov√°n');
        }
        
        // Real-time sync listener - sleduje zmƒõny v cloudu
        function setupCloudSyncListener() {
            if (!currentUser || currentUser.isAnonymous || !firebaseDB) return;
            
            // Odstra≈à star√Ω listener
            if (cloudSyncListener) {
                firebaseDB.ref('cloudSaves/' + currentUser.uid).off('value', cloudSyncListener);
            }
            
            // Nastav nov√Ω listener
            cloudSyncListener = firebaseDB.ref('cloudSaves/' + currentUser.uid).on('value', (snapshot) => {
                const cloudData = snapshot.val();
                if (!cloudData || !cloudData.savedAt) return;
                
                // Ignoruj pokud jsme pr√°vƒõ ulo≈æili (do 5 sekund)
                if (Date.now() - lastCloudSaveTime < 5000) return;
                
                // Ignoruj pokud je sync pozastaven
                if (syncPaused) return;
                
                // Ignoruj pokud prob√≠h√° cestov√°n√≠, akce nebo boj
                if (state.world?.traveling || state.map?.traveling) return;
                if (state.currentAction && state.currentAction.endTime > Date.now()) return;
                if (isInCombat()) return;
                
                // Ignoruj pokud je otev≈ôen√Ω modal s akc√≠ (lov, tƒõ≈æba, atd.)
                const activeModal = document.querySelector('#modal[style*="flex"]');
                if (activeModal) {
                    const modalTitle = activeModal.querySelector('h2, h3')?.textContent || '';
                    const actionModals = ['Lov', 'Tƒõ≈æba', 'Ryba≈ôen√≠', 'Pr≈Øzkum', 'Va≈ôen√≠', 'Alchymie', 'Sbƒõr', 'Sp√°nek'];
                    if (actionModals.some(a => modalTitle.includes(a))) return;
                }
                
                // Porovnej ƒçasy - pokud je cloud novƒõj≈°√≠ o v√≠c ne≈æ 10 sekund, nab√≠dni sync
                const localSaveTime = state.lastSaveTime || 0;
                const cloudSaveTime = cloudData.savedAt;
                
                if (cloudSaveTime > localSaveTime + 10000) {
                    // Cloud je novƒõj≈°√≠ - nab√≠dni synchronizaci
                    showCloudSyncPrompt(cloudData, cloudSaveTime);
                }
            });
            
            console.log('‚òÅÔ∏è Real-time cloud sync aktivov√°n');
        }
        
        // Dialog pro synchronizaci
        function showCloudSyncPrompt(cloudData, cloudTime) {
            const cloudDate = new Date(cloudTime).toLocaleString('cs-CZ');
            const cloudDays = cloudData.state?.time?.days || 0;
            const cloudLevel = cloudData.state?.char?.level || 1;
            const cloudHp = cloudData.state?.char?.hp || 0;
            const cloudMaxHp = cloudData.state?.char?.maxHp || 100;
            const localDays = state.time?.days || 0;
            const localLevel = state.char?.level || 1;
            const localHp = state.char?.hp || 0;
            const localMaxHp = state.char?.maxHp || 100;
            
            // Detekce aktivn√≠ch akc√≠ v cloudu
            let cloudStatus = '';
            if (cloudData.state?.map?.traveling) {
                cloudStatus = 'üö∂ Cestuje...';
            } else if (cloudData.state?.currentAction) {
                const actionNames = {
                    'scavenge': 'üîç Prohled√°v√°',
                    'hunt': 'üèπ Lov√≠',
                    'fish': 'üé£ Ryba≈ô√≠',
                    'explore': 'üó∫Ô∏è Pr≈Øzkum',
                    'rest': 'üí§ Odpoƒç√≠v√°',
                    'cook': 'üç≥ Va≈ô√≠',
                    'craft': 'üî® Vyr√°b√≠'
                };
                cloudStatus = actionNames[cloudData.state.currentAction] || '‚è≥ Akce...';
            } else {
                const locName = cloudData.state?.world?.currentLocation || 'shelter';
                cloudStatus = 'üìç ' + (locName === 'shelter' ? 'V √∫krytu' : locName);
            }
            
            // Detekce aktivn√≠ch akc√≠ lok√°lnƒõ
            let localStatus = '';
            if (state.map?.traveling) {
                localStatus = 'üö∂ Cestuje≈°...';
            } else if (state.currentAction) {
                const actionNames = {
                    'scavenge': 'üîç Prohled√°v√°≈°',
                    'hunt': 'üèπ Lov√≠≈°',
                    'fish': 'üé£ Ryba≈ô√≠≈°',
                    'explore': 'üó∫Ô∏è Pr≈Øzkum',
                    'rest': 'üí§ Odpoƒç√≠v√°≈°',
                    'cook': 'üç≥ Va≈ô√≠≈°',
                    'craft': 'üî® Vyr√°b√≠≈°'
                };
                localStatus = actionNames[state.currentAction] || '‚è≥ Akce...';
            } else {
                const locName = state.world?.currentLocation || 'shelter';
                localStatus = 'üìç ' + (locName === 'shelter' ? 'V √∫krytu' : locName);
            }
            
            // Zjisti rozd√≠l v ƒçase hry
            const timeDiff = Math.abs(cloudDays - localDays);
            const isTimeSuspicious = timeDiff > 1 || (cloudDays < localDays); // Cloud je star≈°√≠ = podez≈ôel√©
            
            showModal('‚òÅÔ∏è Nov√Ω cloud save', `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîÑ</div>
                    <p style="margin-bottom: 1rem;">Na jin√©m za≈ô√≠zen√≠ byl ulo≈æen novƒõj≈°√≠ save!</p>
                    
                    ${isTimeSuspicious ? `
                        <div style="background: #4a1a1a; padding: 0.8rem; border-radius: 8px; border: 2px solid #f44336; margin-bottom: 1rem;">
                            <div style="color: #f44336; font-weight: bold;">‚ö†Ô∏è VAROV√ÅN√ç</div>
                            <div style="font-size: 0.85rem; color: #ff9800; margin-top: 0.3rem;">
                                Cloud save m√° ${cloudDays < localDays ? 'STAR≈†√ç' : 'jin√Ω'} hern√≠ ƒças (${cloudDays < localDays ? '-' : '+'}${timeDiff} dn√≠).
                            </div>
                            <div style="font-size: 0.75rem; color: #888; margin-top: 0.3rem;">
                                Pokud jsi nehr√°l na jin√©m za≈ô√≠zen√≠, nƒõkdo mohl z√≠skat p≈ô√≠stup k tv√©mu √∫ƒçtu!<br>
                                <strong style="color: #f44336;">Doporuƒçujeme zmƒõnit heslo.</strong>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; border: 2px solid #4caf50;">
                            <div style="color: #4caf50; font-weight: bold;">‚òÅÔ∏è Cloud</div>
                            <div style="font-size: 0.9rem; color: #fff;">Den ${cloudDays}, Lvl ${cloudLevel}</div>
                            <div style="font-size: 0.8rem; color: #4caf50;">‚ù§Ô∏è ${cloudHp}/${cloudMaxHp}</div>
                            <div style="font-size: 0.75rem; color: #ff9800; margin-top: 0.3rem;">${cloudStatus}</div>
                            <div style="font-size: 0.65rem; color: #666; margin-top: 0.3rem;">${cloudDate}</div>
                        </div>
                        <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; border: 2px solid #888;">
                            <div style="color: #888; font-weight: bold;">üíæ Lok√°ln√≠</div>
                            <div style="font-size: 0.9rem; color: #fff;">Den ${localDays}, Lvl ${localLevel}</div>
                            <div style="font-size: 0.8rem; color: #f44336;">‚ù§Ô∏è ${localHp}/${localMaxHp}</div>
                            <div style="font-size: 0.75rem; color: #2196f3; margin-top: 0.3rem;">${localStatus}</div>
                            <div style="font-size: 0.65rem; color: #666; margin-top: 0.3rem;">Aktu√°ln√≠</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn" onclick="acceptCloudSync()" style="flex: 1; background: #4caf50; padding: 0.8rem;">
                            ‚òÅÔ∏è Naƒç√≠st cloud
                        </button>
                        <button class="btn" onclick="rejectCloudSync()" style="flex: 1; background: #ff9800; padding: 0.8rem;">
                            üíæ Ponechat lok√°ln√≠
                        </button>
                        <button class="btn" onclick="closeModal(); syncPaused = true; setTimeout(() => syncPaused = false, 60000);" style="flex: 1; background: #555; padding: 0.8rem;">
                            ‚è∏Ô∏è Ignorovat (1 min)
                        </button>
                    </div>
                    
                    <div style="margin-top: 1rem; font-size: 0.7rem; color: #666;">
                        üí° Tip: Pokud hraje≈° na v√≠ce za≈ô√≠zen√≠ch, v≈ædy vyƒçkej na synchronizaci p≈ôed hran√≠m.
                    </div>
                </div>
            `);
        }
        
        // P≈ôijmout cloud sync
        async function acceptCloudSync() {
            closeModal();
            syncPaused = true;
            await loadCloudSave(true);
            setTimeout(() => syncPaused = false, 5000);
        }
        
        // Odm√≠tnout cloud sync a ulo≈æit lok√°ln√≠ do cloudu
        async function rejectCloudSync() {
            closeModal();
            syncPaused = true;
            await saveCloudSave();
            lastCloudSaveTime = Date.now();
            notifySuccess('üíæ Lok√°ln√≠ save', 'Ulo≈æen do cloudu');
            setTimeout(() => syncPaused = false, 5000);
        }
        
        // Spus≈• listener po p≈ôihl√°≈°en√≠
        document.addEventListener('userLoggedIn', () => {
            setTimeout(setupCloudSyncListener, 2000);
        });
        
        // === HR√ÅƒåSK√â JM√âNO ===
        function getPlayerName() {
            // Pokud je p≈ôihl√°≈°en√Ω, pou≈æij nick z √∫ƒçtu
            if (currentUser && currentUser.displayName) {
                return currentUser.displayName;
            }
            // Jinak pou≈æij jm√©no postavy ze hry
            return state.char.name || 'Nezn√°m√Ω';
        }
        
        // setPlayerName a showSetNameModal odstranƒõny - jm√©no se nemƒõn√≠
        
        // === V√ùPOƒåET SK√ìRE ===
        function calculateMultiplayerScore() {
            // Pou≈æij spr√°vn√© promƒõnn√©
            const daysAlive = state.time?.days || 0;
            const kills = state.stats?.kills || 0;
            const itemsCrafted = state.stats?.itemsCrafted || 0;
            const dungeonsCleared = state.stats?.dungeonsCleared || (state.dungeon?.cleared ? Object.keys(state.dungeon.cleared).length : 0);
            const settlers = state.settlement?.settlers?.length || 0;
            const booksRead = state.readBooks?.length || 0;
            const money = getMoney() || 0;
            const level = state.char?.level || 1;
            const pvpWins = state.stats?.pvpWins || 0;
            
            const score = (
                level * 1000 +
                kills * 10 +
                daysAlive * 50 +
                itemsCrafted * 5 +
                money +
                booksRead * 200 +
                dungeonsCleared * 300 +
                settlers * 100 +
                pvpWins * 250
            );
            
            console.log('üìä Score breakdown:', { level, kills, daysAlive, itemsCrafted, money, booksRead, dungeonsCleared, settlers, pvpWins, total: score });
            
            return score;
        }
        
        // === PVP FRAKƒåN√ç V√ÅLKY ===
        
        // Z√≠skat frakci hr√°ƒçe
        function getPlayerFaction() {
            return state.pvpFaction || null;
        }
        
        // Definice str√°≈æc≈Ø
        const TERRITORY_GUARDS = [
            { id: 'rookie', name: 'Nov√°ƒçek', icon: 'üë§', hp: 80, damage: 10, defense: 3, price: 25, desc: 'Z√°kladn√≠ str√°≈æce' },
            { id: 'soldier', name: 'Voj√°k', icon: 'üíÇ', hp: 150, damage: 18, defense: 8, price: 75, desc: 'Zku≈°en√Ω bojovn√≠k' },
            { id: 'veteran', name: 'Veter√°n', icon: 'üéñÔ∏è', hp: 250, damage: 28, defense: 12, price: 175, desc: 'Tvrd√Ω protivn√≠k' },
            { id: 'elite', name: 'Elita', icon: '‚öîÔ∏è', hp: 400, damage: 45, defense: 18, price: 400, desc: 'Nebezpeƒçn√Ω zabij√°k' },
            { id: 'champion', name: '≈†ampion', icon: 'üèÜ', hp: 600, damage: 65, defense: 25, price: 800, desc: 'Legend√°rn√≠ bojovn√≠k' }
        ];
        
        const MAX_GUARDS_PER_TERRITORY = 3;
        
        // P≈ôipojit se k frakci
        // === HELPER: Aktualizace aktivity ƒçlena frakce ===
        
        async function updateFactionActivity() {
            const faction = getPlayerFaction();
            if (!faction || !multiplayerEnabled || !firebaseDB) return;
            
            try {
                const playerName = getPlayerName();
                const sanitizedName = playerName.replace(/[\\/\\.#$\\[\\]]/g, '_');
                
                // Zkontroluj factionSeason
                const seasonSnap = await firebaseDB.ref('factionSeason').once('value');
                const seasonData = seasonSnap.val();
                
                if (!seasonData) {
                    // factionSeason neexistuje - vytvo≈ô ho (prvn√≠ inicializace)
                    console.log('üè¥ Creating initial factionSeason');
                    await firebaseDB.ref('factionSeason').set({
                        startTime: Date.now(),
                        seasonNumber: 1,
                        lastReset: null
                    });
                } else if (seasonData.lastReset) {
                    // Byl proveden reset - zkontroluj jestli hr√°ƒç vstoupil do frakce P≈òED resetem
                    const joinedAt = state.pvpFactionJoinedAt || 0;
                    if (joinedAt < seasonData.lastReset) {
                        // Hr√°ƒç mƒõl frakci p≈ôed resetem - mus√≠ si vybrat znovu!
                        console.log('üîÑ Faction was reset after player joined, clearing local state');
                        state.pvpFaction = null;
                        state.pvpFactionJoinedAt = null;
                        state.pvpFactionContribution = 0;
                        saveGame();
                        notifyInfo('üè¥ Frakce resetov√°ny', 'Vyber si novou frakci!');
                        return;
                    }
                }
                
                // Zkontroluj jestli z√°znam hr√°ƒçe existuje v Firebase
                const snap = await firebaseDB.ref('factionMembers/' + sanitizedName).once('value');
                const existingData = snap.val();
                
                if (!existingData) {
                    // Z√°znam neexistuje - vytvo≈ô nov√Ω (ale bez star√Ωch bod≈Ø!)
                    // Pokud hr√°ƒç vstoupil po resetu, m≈Ø≈æe m√≠t contribution
                    // Pokud vstoupil p≈ôed a z√°znam chyb√≠, nƒõco je ≈°patnƒõ - dej 0
                    const safeContribution = (state.pvpFactionJoinedAt && seasonData?.lastReset && state.pvpFactionJoinedAt > seasonData.lastReset) 
                        ? (state.pvpFactionContribution || 0) 
                        : 0;
                    
                    await firebaseDB.ref('factionMembers/' + sanitizedName).set({
                        name: playerName,
                        faction: faction,
                        joinedAt: state.pvpFactionJoinedAt || Date.now(),
                        contribution: safeContribution,
                        lastActive: Date.now()
                    });
                    
                    // Synchronizuj lok√°ln√≠ stav
                    state.pvpFactionContribution = safeContribution;
                    
                    console.log('üîÑ Re-registered in factionMembers:', playerName, 'contribution:', safeContribution);
                } else {
                    // Existuje - jen aktualizuj lastActive
                    await firebaseDB.ref('factionMembers/' + sanitizedName + '/lastActive').set(Date.now());
                }
            } catch(e) {
                console.log('Update faction activity error:', e);
            }
        }
        
        async function joinFaction(factionId) {
            if (!PVP_FACTIONS[factionId]) {
                notifyError('Chyba', 'Neplatn√° frakce');
                return false;
            }
            
            // Pokud u≈æ m√° frakci, nelze zmƒõnit (zmƒõna jen po resetu sez√≥ny)
            if (state.pvpFaction) {
                notifyWarning('Nelze zmƒõnit', 'Frakci m≈Ø≈æe≈° zmƒõnit a≈æ po skonƒçen√≠ sez√≥ny!');
                return false;
            }
            
            // Kontrola poƒçtu ƒçlen≈Ø - max rozd√≠l mezi frakcemi je 3 hr√°ƒçi
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const membersSnap = await firebaseDB.ref('factionMembers').once('value');
                    const members = membersSnap.val() || {};
                    
                    const factionCounts = { kory: 0, koudy: 0, independent: 0 };
                    Object.values(members).forEach(m => {
                        if (m.faction && factionCounts[m.faction] !== undefined) {
                            factionCounts[m.faction]++;
                        }
                    });
                    
                    const minCount = Math.min(...Object.values(factionCounts));
                    const targetCount = factionCounts[factionId];
                    
                    if (targetCount >= minCount + 3) {
                        const smallest = Object.entries(factionCounts)
                            .filter(([id, count]) => count === minCount)
                            .map(([id]) => PVP_FACTIONS[id]);
                        
                        notifyWarning('Frakce je pln√°!', `P≈ô√≠li≈° mnoho ƒçlen≈Ø. Zkus ${smallest.map(f => f.icon + ' ' + f.name).join(' nebo ')}`);
                        return false;
                    }
                } catch(e) {
                    console.error('Faction balance check error:', e);
                }
            }
            
            const now = Date.now();
            state.pvpFaction = factionId;
            state.pvpFactionJoinedAt = now;
            state.pvpFactionContribution = 0;
            
            // Pozastav cloud sync aby se zmƒõna nep≈ôepsala
            if (typeof syncPaused !== 'undefined') {
                syncPaused = true;
                setTimeout(() => { syncPaused = false; }, 10000); // 10 sekund ochrana
            }
            
            // Ulo≈æ do Firebase (factionMembers)
            if (multiplayerEnabled && firebaseDB) {
                const playerName = getPlayerName();
                try {
                    await firebaseDB.ref('factionMembers/' + playerName.replace(/[\/\.#$\[\]]/g, '_')).set({
                        name: playerName,
                        faction: factionId,
                        joinedAt: now,
                        contribution: 0,
                        lastActive: now
                    });
                    console.log('üè¥ Faction joined and saved to Firebase:', factionId);
                } catch(e) {
                    console.error('Faction join error:', e);
                }
            }
            
            // Ulo≈æ lok√°lnƒõ
            saveGame();
            
            // Okam≈æitƒõ ulo≈æ do cloudu (aby se to neztratilo)
            if (typeof saveCloudSave === 'function') {
                await saveCloudSave();
                lastCloudSaveTime = Date.now(); // Nastav ƒças ulo≈æen√≠ aby se ignoroval p≈ô√≠choz√≠ sync
                console.log('üè¥ Cloud save completed after faction join');
            }
            
            const faction = PVP_FACTIONS[factionId];
            notifySuccess(`${faction.icon} ${faction.name}`, 'V√≠tej ve frakci!');
            return true;
        }
        
        // P≈ôispƒõt body pro frakci na aktu√°ln√≠ lokaci
        async function contributeToTerritory(points) {
            const faction = getPlayerFaction();
            if (!faction) {
                notifyWarning('Bez frakce', 'Mus√≠≈° se nejd≈ô√≠v p≈ôidat k frakci!');
                return false;
            }
            
            const locationId = state.world?.currentLocation;
            if (!locationId) return false;
            
            // P≈ôidej body lok√°lnƒõ
            state.pvpFactionContribution = (state.pvpFactionContribution || 0) + points;
            console.log('üè¥ Contributing ' + points + ' points, local total: ' + state.pvpFactionContribution);
            
            // Ulo≈æ do Firebase
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const territoryRef = firebaseDB.ref('territories/' + locationId + '/points/' + faction);
                    await territoryRef.transaction(current => (current || 0) + points);
                    
                    // Aktualizuj contribution hr√°ƒçe
                    const playerName = getPlayerName();
                    const sanitizedName = playerName.replace(/[\/\.#$\[\]]/g, '_');
                    console.log('üè¥ Saving to factionMembers/' + sanitizedName + '/contribution');
                    
                    // Pou≈æij set s increment m√≠sto transaction pro spolehlivost
                    const contribRef = firebaseDB.ref('factionMembers/' + sanitizedName + '/contribution');
                    const snap = await contribRef.once('value');
                    const currentVal = snap.val() || 0;
                    await contribRef.set(currentVal + points);
                    console.log('üè¥ Contribution updated: ' + currentVal + ' -> ' + (currentVal + points));
                    
                    // Aktualizuj vlastn√≠ka
                    await checkAndUpdateTerritoryOwner(locationId);
                    
                    // Aktualizuj aktivitu
                    await updateFactionActivity();
                    
                } catch(e) {
                    console.error('Territory contribution error:', e);
                }
            }
            
            return true;
        }
        
        // Zkontroluj a aktualizuj vlastn√≠ka teritoria
        async function checkAndUpdateTerritoryOwner(locationId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                const territory = snapshot.val() || {};
                const points = territory.points || {};
                
                // Najdi frakci s nejv√≠c body
                let maxPoints = 0;
                let winner = null;
                
                for (const [faction, pts] of Object.entries(points)) {
                    if (pts > maxPoints) {
                        maxPoints = pts;
                        winner = faction;
                    }
                }
                
                // Aktualizuj vlastn√≠ka
                if (winner) {
                    await firebaseDB.ref('territories/' + locationId + '/owner').set(winner);
                }
            } catch(e) {
                console.error('Territory owner update error:', e);
            }
        }
        
        // Hlavn√≠ Faction Hub v Online sekci
        async function showFactionHub() {
            const faction = getPlayerFaction();
            
            if (!faction) {
                // Pokud nem√° frakci, zobraz v√Ωbƒõr
                showFactionSelection();
                return;
            }
            
            // Zajisti ≈æe hr√°ƒç je zaregistrov√°n v factionMembers
            await updateFactionActivity();
            
            // M√° frakci - zobraz info se statistikami v≈°ech frakc√≠
            const factionData = PVP_FACTIONS[faction];
            
            // Naƒçti statistiky z Firebase
            let factionStats = { kory: { territories: 0, members: 0, topMembers: [] }, koudy: { territories: 0, members: 0, topMembers: [] }, independent: { territories: 0, members: 0, topMembers: [] } };
            let myRank = '?';
            const totalLocations = WORLD_LOCATIONS.filter(l => l.type !== 'home').length;
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    // Teritoria
                    const terrSnapshot = await firebaseDB.ref('territories').once('value');
                    const territories = terrSnapshot.val() || {};
                    Object.values(territories).forEach(t => {
                        if (t.owner && factionStats[t.owner]) factionStats[t.owner].territories++;
                    });
                    
                    // ƒålenov√©
                    const membersSnapshot = await firebaseDB.ref('factionMembers').once('value');
                    const members = membersSnapshot.val() || {};
                    const myName = getPlayerName();
                    
                    Object.values(members).forEach(m => {
                        if (m.faction && factionStats[m.faction]) {
                            factionStats[m.faction].members++;
                            factionStats[m.faction].topMembers.push({ name: m.name, contribution: m.contribution || 0 });
                        }
                    });
                    
                    // Se≈ôaƒè a o≈ô√≠zni top ƒçleny, najdi moji pozici
                    Object.entries(factionStats).forEach(([fid, fs]) => {
                        fs.topMembers.sort((a, b) => b.contribution - a.contribution);
                        if (fid === faction) {
                            const myIdx = fs.topMembers.findIndex(m => m.name === myName);
                            if (myIdx >= 0) myRank = myIdx + 1;
                        }
                        fs.topMembers = fs.topMembers.slice(0, 5);
                    });
                } catch(e) {
                    console.error('Faction stats error:', e);
                }
            }
            
            const canChange = !state.pvpFactionJoinedAt || (Date.now() - state.pvpFactionJoinedAt) >= (7 * 24 * 60 * 60 * 1000);
            let daysLeft = 0;
            if (!canChange) {
                daysLeft = Math.ceil((7 * 24 * 60 * 60 * 1000 - (Date.now() - state.pvpFactionJoinedAt)) / (24 * 60 * 60 * 1000));
            }
            
            // Najdi vedouc√≠ frakci
            let leadingFactionId = null;
            let maxTerritories = 0;
            Object.entries(factionStats).forEach(([id, stats]) => {
                if (stats.territories > maxTerritories) {
                    maxTerritories = stats.territories;
                    leadingFactionId = id;
                }
            });
            window.leadingFaction = leadingFactionId;
            
            // Sesb√≠rej v≈°echny top hr√°ƒçe ze v≈°ech frakc√≠ pro glob√°ln√≠ ≈æeb≈ô√≠ƒçek
            const allTopPlayers = [];
            Object.entries(factionStats).forEach(([fid, fs]) => {
                fs.topMembers.forEach(m => {
                    allTopPlayers.push({ ...m, faction: fid });
                });
            });
            allTopPlayers.sort((a, b) => b.contribution - a.contribution);
            const globalTop10 = allTopPlayers.slice(0, 10);
            
            // HTML pro v≈°echny frakce
            const allFactionsHtml = Object.entries(PVP_FACTIONS).map(([id, f]) => {
                const stats = factionStats[id];
                const percent = totalLocations > 0 ? Math.round(stats.territories / totalLocations * 100) : 0;
                const isMyFaction = id === faction;
                const isLeading = id === leadingFactionId;
                const topMembersHtml = stats.topMembers.length > 0 
                    ? stats.topMembers.map((m, i) => `<span style="color: ${f.color};">${i === 0 ? 'üëë' : (i+1)+'.'} ${m.name} <span style="color: #888;">(${m.contribution})</span></span>`).join('<br>')
                    : '<span style="color: #555;">≈æ√°dn√≠ ƒçlenov√©</span>';
                
                return `
                    <div style="background: ${f.color}${isMyFaction ? '30' : '15'}; padding: 0.8rem; border-radius: 8px; border: ${isMyFaction ? '2px' : '1px'} solid ${isMyFaction ? f.color : f.color + '44'}; margin-bottom: 0.5rem; ${isLeading ? 'box-shadow: 0 0 10px ' + f.color + '50;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: ${f.color}; font-weight: bold; font-size: 1.1rem;">${f.icon} ${f.name} ${isMyFaction ? '(ty)' : ''} ${isLeading ? 'üëë' : ''}</span>
                            <span style="color: #fff;">${stats.territories} √∫zem√≠</span>
                        </div>
                        ${isLeading ? '<p style="color: #ffd700; font-size: 0.75rem; margin: 0.2rem 0 0 0;">‚≠ê Vedouc√≠ frakce - aktivn√≠ bonus!</p>' : ''}
                        <div style="background: #000; height: 6px; border-radius: 3px; margin: 0.5rem 0; overflow: hidden;">
                            <div style="background: ${f.color}; height: 100%; width: ${percent}%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                            <span style="color: #888;">üë• ${stats.members} hr√°ƒç≈Ø</span>
                            <span style="color: #888;">${percent}% mapy</span>
                        </div>
                        <details style="margin-top: 0.5rem;">
                            <summary style="color: #666; cursor: pointer; font-size: 0.8rem;">üèÜ Top hr√°ƒçi frakce</summary>
                            <div style="padding: 0.3rem; font-size: 0.75rem; margin-top: 0.3rem;">${topMembersHtml}</div>
                        </details>
                    </div>
                `;
            }).join('');
            
            // HTML pro glob√°ln√≠ top 10
            const globalTopHtml = globalTop10.length > 0 
                ? globalTop10.map((m, i) => {
                    const f = PVP_FACTIONS[m.faction];
                    return `<div style="display: flex; justify-content: space-between; padding: 0.3rem; background: ${f.color}15; border-radius: 4px; margin-bottom: 0.2rem; border-left: 3px solid ${f.color};">
                        <span style="color: ${f.color};">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1)+'.'} ${f.icon} ${m.name}</span>
                        <span style="color: #ffd700;">${m.contribution}</span>
                    </div>`;
                }).join('')
                : '<p style="color: #555; text-align: center;">≈Ω√°dn√≠ hr√°ƒçi</p>';
            
            const isMyFactionLeading = faction === leadingFactionId;
            const bonusText = factionData.bonus.damage ? '+5% DMG' : factionData.bonus.xp ? '+5% XP' : '+5% loot';
            
            // P≈ôedpoƒç√≠tej war zone info
            const warZoneInfoHtml = await renderWarZoneInfo();
            
            showModal(`${factionData.icon} Frakƒçn√≠ v√°lka`, `
                <!-- Moje frakce info -->
                <div style="background: ${factionData.color}20; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ${factionData.color};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: ${factionData.color}; font-weight: bold;">${factionData.icon} ${factionData.name}</span>
                        <span style="color: #888; font-size: 0.85rem;">Pozice: #${myRank}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.85rem;">
                        <span style="color: #ffd700;">P≈ôispƒõno: ${state.pvpFactionContribution || 0} bod≈Ø</span>
                        <span style="color: ${isMyFactionLeading ? '#4caf50' : '#666'};">Bonus: ${bonusText} ${isMyFactionLeading ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    ${!isMyFactionLeading ? '<p style="color: #ff9800; font-size: 0.75rem; margin: 0.3rem 0 0 0;">‚ö†Ô∏è Bonus je aktivn√≠ jen pro vedouc√≠ frakci!</p>' : ''}
                </div>
                
                <!-- Glob√°ln√≠ top 10 -->
                <details style="margin-bottom: 1rem;">
                    <summary style="color: #ffd700; cursor: pointer; font-weight: bold;">üèÜ Top 10 hr√°ƒç≈Ø (v≈°echny frakce)</summary>
                    <div style="padding: 0.5rem; max-height: 200px; overflow-y: auto; margin-top: 0.5rem; background: #0a0a0a; border-radius: 6px;">
                        ${globalTopHtml}
                    </div>
                </details>
                
                <!-- P≈ôehled frakc√≠ - rozklik√°vac√≠ -->
                <details style="margin-bottom: 0.5rem;">
                    <summary style="color: #888; cursor: pointer; font-weight: bold; padding: 0.5rem; background: #1a1a1a; border-radius: 6px;">
                        üìä P≈ôehled frakc√≠ <span style="color: #555; font-weight: normal;">(klikni pro detail)</span>
                    </summary>
                    <div style="max-height: 220px; overflow-y: auto; margin-top: 0.3rem;">
                        ${allFactionsHtml}
                    </div>
                </details>
                
                <!-- War Zone sekce - rozklik√°vac√≠ -->
                <details style="margin-bottom: 0.5rem;">
                    <summary style="color: #f44336; cursor: pointer; font-weight: bold; padding: 0.5rem; background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); border-radius: 6px; border: 1px solid #f4433650;">
                        ‚öîÔ∏è V√°leƒçn√° z√≥na ${window.activeWarZone ? '<span style="color: #4caf50;">‚óè AKTIVN√ç</span>' : '<span style="color: #666;">‚óã Neaktivn√≠</span>'}
                    </summary>
                    <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 0 0 6px 6px; margin-top: 0.3rem;">
                        ${warZoneInfoHtml}
                    </div>
                </details>
                
                <!-- Sez√≥na info -->
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #0a0a15 100%); padding: 0.6rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #ffd70050; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="color: #888; font-size: 0.8rem;">‚è≥ Do konce sez√≥ny:</span>
                        <span style="color: #ffd700; font-weight: bold; margin-left: 0.5rem;">${formatTimeRemaining(getSeasonEndTime() - Date.now())}</span>
                    </div>
                    <button class="btn" onclick="showSeasonInfo()" style="background: #ffd70030; border: 1px solid #ffd700; padding: 0.3rem 0.6rem; font-size: 0.8rem;">üìÖ Info</button>
                </div>
                
                <button class="btn" onclick="showFactionHelp()" style="width: 100%; margin-top: 0.8rem; background: #2196f3;">‚ùì Jak to funguje</button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav≈ô√≠t</button>
            `);
        }
        
        // N√°povƒõda k frakƒçn√≠mu syst√©mu
        // Renderov√°n√≠ War Zone info pro Frakƒçn√≠ hub
        async function renderWarZoneInfo() {
            let html = '';
            
            // Aktivn√≠ war zone
            if (window.activeWarZone && window.activeWarZone.endTime > Date.now()) {
                const wz = window.activeWarZone;
                const loc = WORLD_LOCATIONS.find(l => l.id === wz.locationId);
                const enemy = ENEMIES.find(e => e.id === wz.enemyId);
                const remaining = Math.max(0, wz.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const hours = Math.floor(mins / 60);
                const timeStr = hours > 0 ? `${hours}h ${mins % 60}m` : `${mins}m`;
                
                // Naƒçti aktu√°ln√≠ body
                let pointsHtml = '<p style="color: #666;">Naƒç√≠t√°m...</p>';
                if (multiplayerEnabled && firebaseDB) {
                    try {
                        const snap = await firebaseDB.ref('warZone/factionPoints').once('value');
                        const pts = snap.val() || {};
                        const sorted = Object.entries(PVP_FACTIONS)
                            .map(([fid, f]) => ({ fid, f, pts: pts[fid] || 0 }))
                            .sort((a, b) => b.pts - a.pts);
                        
                        pointsHtml = sorted.map(({ fid, f, pts }) => 
                            `<span style="color: ${f.color};">${f.icon} ${pts}</span>`
                        ).join(' | ');
                    } catch(e) {}
                }
                
                html += `
                    <div style="background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); padding: 0.6rem; border-radius: 6px; border: 1px solid #f44336;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #f44336; font-weight: bold;">üî• PROB√çH√Å!</span>
                            <span style="color: #ffd700;">‚è±Ô∏è ${timeStr}</span>
                        </div>
                        <p style="color: #ddd; margin: 0.3rem 0;">üìç ${loc?.icon || ''} ${loc?.name || wz.locationId}</p>
                        <p style="color: #888; margin: 0.3rem 0; font-size: 0.85rem;">üëπ ${enemy?.icon || ''} ${enemy?.name || '?'} (${wz.enemyCount}x) | üèÜ ${wz.reward}üí∞</p>
                        <p style="color: #ff9800; margin: 0.5rem 0 0 0; font-size: 0.9rem;">üìä Sk√≥re: ${pointsHtml}</p>
                    </div>
                `;
            } else {
                html += `<p style="color: #666; text-align: center; margin: 0.5rem 0;">≈Ω√°dn√° aktivn√≠ v√°leƒçn√° z√≥na</p>`;
            }
            
            // Historie v√≠tƒõzstv√≠
            html += `
                <div style="margin-top: 0.8rem; border-top: 1px solid #333; padding-top: 0.8rem;">
                    <p style="color: #888; font-size: 0.85rem; margin: 0 0 0.5rem 0;">üìú Historie v√≠tƒõzstv√≠:</p>
            `;
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const histSnap = await firebaseDB.ref('warZoneHistory').orderByChild('endTime').limitToLast(5).once('value');
                    const history = histSnap.val();
                    
                    if (history) {
                        const entries = Object.entries(history).sort((a, b) => b[1].endTime - a[1].endTime);
                        html += entries.map(([key, h]) => {
                            const winnerF = PVP_FACTIONS[h.winner];
                            const loc = WORLD_LOCATIONS.find(l => l.id === h.locationId);
                            const date = new Date(h.endTime);
                            const dateStr = `${date.getDate()}.${date.getMonth()+1}.`;
                            return `
                                <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #111; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                                    <span style="color: ${winnerF?.color || '#888'};">${winnerF?.icon || '?'} ${winnerF?.name || '?'}</span>
                                    <span style="color: #666;">${loc?.icon || ''} ${loc?.name || '?'} | ${dateStr}</span>
                                </div>
                            `;
                        }).join('');
                    } else {
                        html += `<p style="color: #555; font-size: 0.8rem; text-align: center;">Zat√≠m ≈æ√°dn√° historie</p>`;
                    }
                } catch(e) {
                    html += `<p style="color: #555; font-size: 0.8rem; text-align: center;">Zat√≠m ≈æ√°dn√° historie</p>`;
                }
            } else {
                html += `<p style="color: #555; font-size: 0.8rem; text-align: center;">Offline re≈æim</p>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        function showFactionHelp() {
            showModal('‚ùì Jak funguje frakƒçn√≠ v√°lka', `
                <div style="max-height: 400px; overflow-y: auto; font-size: 0.9rem;">
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üè¥ Co je frakƒçn√≠ v√°lka?</h4>
                    <p style="color: #ccc; margin-bottom: 1rem;">T≈ôi frakce bojuj√≠ o nadvl√°du nad pustinou. Vyber si stranu a pomoz j√≠ ovl√°dnout co nejv√≠c √∫zem√≠!</p>
                    
                    <h4 style="color: #f44336; margin: 0 0 0.5rem 0;">‚öîÔ∏è V√°leƒçn√° z√≥na (War Zone)</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>Admin vyhl√°s√≠ <strong>v√°leƒçnou z√≥nu</strong> na lokaci</li>
                        <li>Lokace <strong>sv√≠t√≠ ƒçervenƒõ</strong> na mapƒõ</li>
                        <li>Bojuje≈° s <strong>pln√Ωm HP</strong> (po boji se vr√°t√≠ p≈Øvodn√≠)</li>
                        <li><strong>Nezem≈ôe≈°</strong> - p≈ôi proh≈ôe jen cooldown</li>
                        <li>Cooldown <strong>10 minut</strong> mezi boji</li>
                        <li>V√Ωhra = <strong>body pro frakci</strong></li>
                        <li>≈Ω√°dn√© XP ani loot</li>
                        <li>V√≠tƒõzn√° frakce dostane <strong>odmƒõnu</strong></li>
                    </ul>
                    
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">üìÖ T√Ωdenn√≠ sez√≥ny</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>Ka≈æd√° sez√≥na trv√° <strong>1 t√Ωden</strong></li>
                        <li>Reset: <strong>Nedƒõle 23:59</strong></li>
                        <li>V√≠tƒõz√≠ frakce s <strong>nejv√≠ce √∫zem√≠mi</strong></li>
                        <li>Po resetu: v≈°echna √∫zem√≠ neutr√°ln√≠, body na 0</li>
                    </ul>
                    
                    <h4 style="color: #4caf50; margin: 0 0 0.5rem 0;">üèÜ Odmƒõny za sez√≥nu</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li><strong>V√≠tƒõzn√° frakce:</strong> 100üí∞ + 50 XP</li>
                        <li><strong>ü•á 1. m√≠sto:</strong> +200üí∞ nav√≠c</li>
                        <li><strong>ü•à 2. m√≠sto:</strong> +150üí∞ nav√≠c</li>
                        <li><strong>ü•â 3. m√≠sto:</strong> +100üí∞ nav√≠c</li>
                        <li><strong>√öƒçast (ostatn√≠):</strong> 25üí∞</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üó∫Ô∏è Jak dob√Ωvat √∫zem√≠?</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li><strong>Neutr√°ln√≠</strong> - obsad√≠≈° okam≈æitƒõ</li>
                        <li><strong>Bez str√°≈æc≈Ø</strong> - ƒçekej 30 minut</li>
                        <li><strong>Se str√°≈æci</strong> - poraz je v boji</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üõ°Ô∏è Str√°≈æci</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>Max <strong>3 str√°≈æce</strong> na √∫zem√≠</li>
                        <li>5 typ≈Ø: Nov√°ƒçek ‚Üí ≈†ampion</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üìä Body</h4>
                    <ul style="color: #ccc; margin: 0 0 1rem 1rem; padding: 0;">
                        <li>+20 za neutr√°ln√≠ √∫zem√≠</li>
                        <li>+30 za dobyt√≠ ƒçek√°n√≠m</li>
                        <li>+50 za dobyt√≠ bojem</li>
                    </ul>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üí∞ Danƒõ z √∫zem√≠</h4>
                    <p style="color: #ccc; margin-bottom: 1rem;">5üí∞/hod za ka≈æd√© √∫zem√≠, rozdƒõleno mezi aktivn√≠ ƒçleny.</p>
                    
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üéÅ Bonusy vedouc√≠ frakce</h4>
                    <ul style="color: #ccc; margin: 0 0 0.5rem 1rem; padding: 0;">
                        <li>üî¥ Kory: +5% damage</li>
                        <li>üîµ Koudy: +5% XP</li>
                        <li>üü£ Nez√°visl√≠: +5% loot</li>
                    </ul>
                </div>
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        // Zobrazit info o frakci
        // Zobrazit v√Ωbƒõr frakce
        function showFactionSelection() {
            const currentFaction = getPlayerFaction();
            const canChange = !state.pvpFactionJoinedAt || (Date.now() - state.pvpFactionJoinedAt) >= (7 * 24 * 60 * 60 * 1000);
            
            let daysLeft = 0;
            if (state.pvpFactionJoinedAt && !canChange) {
                daysLeft = Math.ceil((7 * 24 * 60 * 60 * 1000 - (Date.now() - state.pvpFactionJoinedAt)) / (24 * 60 * 60 * 1000));
            }
            
            const factionsHtml = Object.values(PVP_FACTIONS).map(f => {
                const isCurrentFaction = currentFaction === f.id;
                const bonusText = f.bonus.damage ? '+5% damage' : f.bonus.xp ? '+5% XP' : '+5% loot';
                return `
                    <button class="btn" onclick="confirmJoinFaction('${f.id}')" 
                        style="background: linear-gradient(135deg, ${f.color}40 0%, ${f.color}20 100%); 
                               border: 2px solid ${isCurrentFaction ? f.color : '#333'}; 
                               padding: 1rem; margin-bottom: 0.5rem; width: 100%;
                               ${!canChange && !isCurrentFaction ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                        ${!canChange && !isCurrentFaction ? 'disabled' : ''}>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">${f.icon}</div>
                            <div style="text-align: left; flex: 1;">
                                <div style="color: ${f.color}; font-weight: bold;">${f.name}</div>
                                <div style="color: #888; font-size: 0.8rem;">${f.desc}</div>
                                <div style="color: #ffd700; font-size: 0.75rem;">üéÅ Bonus: ${bonusText}</div>
                            </div>
                            ${isCurrentFaction ? '<div style="color: #4caf50;">‚úì</div>' : ''}
                        </div>
                    </button>
                `;
            }).join('');
            
            showModal('üè¥ Vyber si frakci', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #888;">P≈ôipoj se k frakci a bojuj o teritoria!</p>
                    ${currentFaction ? `<p style="color: ${PVP_FACTIONS[currentFaction].color};">Aktu√°ln√≠: ${PVP_FACTIONS[currentFaction].icon} ${PVP_FACTIONS[currentFaction].name}</p>` : ''}
                    ${!canChange ? `<p style="color: #ff9800; font-size: 0.85rem;">‚è≥ Zmƒõna mo≈æn√° za ${daysLeft} dn√≠</p>` : ''}
                </div>
                
                <div style="max-height: 350px; overflow-y: auto;">
                    ${factionsHtml}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav≈ô√≠t</button>
            `);
        }
        
        function confirmJoinFaction(factionId) {
            const faction = PVP_FACTIONS[factionId];
            const currentFaction = getPlayerFaction();
            
            if (currentFaction === factionId) {
                notifyInfo('U≈æ jsi ƒçlenem', `U≈æ jsi v ${faction.name}`);
                return;
            }
            
            showModal(`${faction.icon} P≈ôipojit se?`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem;">${faction.icon}</div>
                    <h3 style="color: ${faction.color}; margin: 0.5rem 0;">${faction.name}</h3>
                    <p style="color: #888;">${faction.desc}</p>
                    
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #ffd700; margin: 0;">üéÅ Bonus: ${faction.bonus.damage ? '+5% damage' : faction.bonus.xp ? '+5% XP' : '+5% loot chance'}</p>
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.85rem;">‚ö†Ô∏è Frakci m≈Ø≈æe≈° zmƒõnit a≈æ za 7 dn√≠!</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showFactionSelection()" style="background: #555;">Zru≈°it</button>
                    <button class="btn" onclick="joinFaction('${factionId}'); closeModal(); showFactionHub();" style="background: ${faction.color};">P≈ôipojit se!</button>
                </div>
            `);
        }
        
        // Zobrazit statistiky v≈°ech frakc√≠
        async function showAllFactionStats() {
            let totalTerritories = { kory: 0, koudy: 0, independent: 0 };
            let totalPoints = { kory: 0, koudy: 0, independent: 0 };
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories').once('value');
                    const territories = snapshot.val() || {};
                    Object.values(territories).forEach(t => {
                        if (t.owner) totalTerritories[t.owner]++;
                        if (t.points) {
                            Object.entries(t.points).forEach(([f, p]) => {
                                totalPoints[f] = (totalPoints[f] || 0) + p;
                            });
                        }
                    });
                } catch(e) {
                    console.error('Stats error:', e);
                }
            }
            
            const totalLocations = WORLD_LOCATIONS.filter(l => l.type !== 'home').length;
            
            const statsHtml = Object.values(PVP_FACTIONS).map(f => {
                const terr = totalTerritories[f.id] || 0;
                const pts = totalPoints[f.id] || 0;
                const percent = Math.round(terr / totalLocations * 100);
                return `
                    <div style="background: ${f.color}20; padding: 1rem; border-radius: 8px; border-left: 4px solid ${f.color}; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: ${f.color}; font-weight: bold;">${f.icon} ${f.name}</span>
                            <span style="color: #fff;">${terr} √∫zem√≠ (${percent}%)</span>
                        </div>
                        <div style="background: #000; height: 8px; border-radius: 4px; margin: 0.5rem 0; overflow: hidden;">
                            <div style="background: ${f.color}; height: 100%; width: ${percent}%;"></div>
                        </div>
                        <div style="color: #888; font-size: 0.8rem;">Celkem bod≈Ø: ${pts.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
            
            showModal('üìä Statistiky frakc√≠', `
                ${statsHtml}
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        // Interval pro refresh territory modal bƒõhem capture
        let territoryRefreshInterval = null;
        
        function stopTerritoryRefresh() {
            if (territoryRefreshInterval) {
                clearInterval(territoryRefreshInterval);
                territoryRefreshInterval = null;
            }
        }
        
        // Zobrazit akce na teritoriu (tlaƒç√≠tko na lokaci)
        async function showTerritoryActions() {
            // Zastav p≈ôedchoz√≠ refresh interval
            stopTerritoryRefresh();
            
            const faction = getPlayerFaction();
            if (!faction) {
                showFactionSelection();
                return;
            }
            
            const locationId = state.world?.currentLocation;
            if (!locationId || locationId === 'shelter') {
                notifyWarning('Nelze', 'Tady nem≈Ø≈æe≈° dob√Ωvat √∫zem√≠');
                return;
            }
            
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            const factionData = PVP_FACTIONS[faction];
            const myName = getPlayerName();
            
            // Naƒçti info o teritoriu
            let territoryOwner = null;
            let territoryGuards = [];
            let captureProgress = 0;
            let territoryPoints = {};
            let activePlayer = null; // Hr√°ƒç kter√Ω pr√°vƒõ dob√Ωv√°/bojuje
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    console.log('üè¥ showTerritoryActions - loading territory:', locationId);
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    const territory = snapshot.val();
                    console.log('üè¥ showTerritoryActions - RAW data from Firebase:', JSON.stringify(territory));
                    
                    if (territory) {
                        territoryOwner = territory.owner;
                        territoryGuards = territory.guards || [];
                        territoryPoints = territory.points || {};
                        console.log('üè¥ showTerritoryActions - owner:', territoryOwner, 'guards:', territoryGuards.length);
                    } else {
                        console.log('üè¥ showTerritoryActions - NO DATA for this territory!');
                    }
                    
                    // Kontrola aktivn√≠ho hr√°ƒçe na √∫zem√≠
                    if (territory.activeCapture) {
                        const captureTime = territory.activeCapture.startTime || 0;
                        const timePassed = Date.now() - captureTime;
                        // Aktivn√≠ capture vypr≈°√≠ po 35 minut√°ch (30 min + 5 min buffer)
                        if (timePassed < 35 * 60 * 1000 && territory.activeCapture.player !== myName) {
                            activePlayer = territory.activeCapture;
                        }
                    }
                    
                    captureProgress = state.territoryCapture?.[locationId]?.progress || 0;
                } catch(e) {
                    console.error('Territory load error:', e);
                }
            }
            
            const ownerFaction = territoryOwner ? PVP_FACTIONS[territoryOwner] : null;
            const isOurTerritory = territoryOwner === faction;
            const isEnemyTerritory = territoryOwner && territoryOwner !== faction;
            const isNeutral = !territoryOwner;
            
            // Pokud nƒõkdo jin√Ω dob√Ωv√° √∫zem√≠
            if (activePlayer && activePlayer.player !== myName) {
                const playerFaction = PVP_FACTIONS[activePlayer.faction];
                showModal(`üè¥ ${loc?.name || '√özem√≠'}`, `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">‚öîÔ∏è</div>
                        <p style="color: #ff9800; font-size: 1.1rem;">√özem√≠ je obsazov√°no!</p>
                        <p style="color: #888;">Hr√°ƒç <strong style="color: ${playerFaction?.color || '#fff'};">${activePlayer.player}</strong> pr√°vƒõ dob√Ωv√° toto √∫zem√≠.</p>
                        <p style="color: #666; font-size: 0.85rem;">Frakce: ${playerFaction?.icon || '?'} ${playerFaction?.name || '?'}</p>
                        <p style="color: #f44336; margin-top: 1rem;">üö´ Nem≈Ø≈æe≈° zde prov√°dƒõt akce dokud neskonƒç√≠.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zav≈ô√≠t</button>
                `);
                return;
            }
            
            let actionsHtml = '';
            
            if (isOurTerritory) {
                // Na≈°e √∫zem√≠ - m≈Ø≈æeme najmout str√°≈æce (max 3)
                const guardsCount = territoryGuards.length;
                const canHireMore = guardsCount < MAX_GUARDS_PER_TERRITORY;
                
                const guardsListHtml = territoryGuards.length > 0 ? territoryGuards.map((g, i) => {
                    const guardDef = TERRITORY_GUARDS.find(gt => gt.id === g.type);
                    return `<span style="color: #8bc34a;">${guardDef?.icon || 'üë§'} ${guardDef?.name || 'Str√°≈æce'} (${g.hp}HP)</span>`;
                }).join(', ') : '<span style="color: #666;">≈Ω√°dn√≠</span>';
                
                actionsHtml = `
                    <p style="color: #4caf50; text-align: center;">‚úÖ Toto √∫zem√≠ pat≈ô√≠ tv√© frakci!</p>
                    
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin: 0.5rem 0;">
                        <p style="color: #888; margin: 0 0 0.3rem 0;">üõ°Ô∏è Str√°≈æci (${guardsCount}/${MAX_GUARDS_PER_TERRITORY}):</p>
                        <p style="margin: 0; font-size: 0.85rem;">${guardsListHtml}</p>
                    </div>
                    
                    ${canHireMore ? `
                        <h4 style="color: #ffd700; margin: 0.5rem 0;">‚ûï Najmout str√°≈æce:</h4>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${TERRITORY_GUARDS.map(g => `
                                <button class="btn" onclick="hireGuard('${locationId}', '${g.id}')" style="width: 100%; margin-bottom: 0.3rem; background: #333; display: flex; justify-content: space-between; align-items: center; ${getMoney() < g.price ? 'opacity: 0.5;' : ''}" ${getMoney() < g.price ? 'disabled' : ''}>
                                    <span>${g.icon} ${g.name} <span style="color: #666; font-size: 0.75rem;">(‚ù§Ô∏è${g.hp} ‚öîÔ∏è${g.damage} üõ°Ô∏è${g.defense})</span></span>
                                    <span style="color: #ffd700;">${g.price} üí∞</span>
                                </button>
                            `).join('')}
                        </div>
                    ` : `
                        <p style="color: #ff9800; text-align: center;">‚ö†Ô∏è Maximum str√°≈æc≈Ø dosa≈æeno!</p>
                    `}
                `;
            } else if (isEnemyTerritory) {
                // Nep≈ô√°telsk√© √∫zem√≠
                if (territoryGuards.length > 0) {
                    // Se str√°≈æci - mus√≠me je postupnƒõ porazit
                    const currentGuard = territoryGuards[0];
                    const guardDef = TERRITORY_GUARDS.find(g => g.id === currentGuard.type);
                    
                    actionsHtml = `
                        <p style="color: ${ownerFaction.color}; text-align: center;">${ownerFaction.icon} √özem√≠ pat≈ô√≠: ${ownerFaction.name}</p>
                        
                        <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; border: 2px solid #f44336;">
                            <h4 style="color: #f44336; margin: 0 0 0.5rem 0;">‚öîÔ∏è Str√°≈æci: ${territoryGuards.length}</h4>
                            <p style="color: #ff6b6b; margin: 0 0 0.3rem 0;">Aktu√°ln√≠: ${guardDef?.icon || 'üë§'} ${guardDef?.name || 'Str√°≈æce'}</p>
                            <p style="color: #888; margin: 0;">‚ù§Ô∏è HP: ${currentGuard.hp || guardDef?.hp || 100}</p>
                            <p style="color: #888; margin: 0;">‚öîÔ∏è Damage: ${guardDef?.damage || 10}</p>
                            ${territoryGuards.length > 1 ? `<p style="color: #666; font-size: 0.8rem; margin: 0.3rem 0 0 0;">+ ${territoryGuards.length - 1} dal≈°√≠ch str√°≈æc≈Ø</p>` : ''}
                        </div>
                        
                        <button class="btn" onclick="attackTerritoryGuard('${locationId}')" style="width: 100%; background: #f44336;">‚öîÔ∏è Za√∫toƒçit!</button>
                        <p style="color: #666; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">Pora≈æ v≈°echny str√°≈æce pro z√≠sk√°n√≠ √∫zem√≠</p>
                    `;
                } else {
                    // Bez str√°≈æce - ƒçek√°n√≠ 30 minut
                    const progressPercent = Math.min(100, captureProgress);
                    actionsHtml = `
                        <p style="color: ${ownerFaction.color}; text-align: center;">${ownerFaction.icon} √özem√≠ pat≈ô√≠: ${ownerFaction.name}</p>
                        <p style="color: #ff9800; text-align: center;">üö´ ≈Ω√°dn√Ω str√°≈æce - m≈Ø≈æe≈° obsadit ƒçek√°n√≠m!</p>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 0.5rem 0;">
                            <p style="color: #888; margin: 0 0 0.5rem 0;">Postup obsazen√≠:</p>
                            <div style="background: #000; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${factionData.color}; height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                            </div>
                            <p style="color: #ffd700; text-align: center; margin: 0.5rem 0 0 0;">${progressPercent.toFixed(0)}% (celkem 30 min)</p>
                        </div>
                        
                        ${state.territoryCapture?.[locationId] ? `
                            <button class="btn" disabled style="width: 100%; background: #555; cursor: not-allowed;">
                                ‚è≥ Prob√≠h√° obsazov√°n√≠... (${progressPercent.toFixed(0)}%)
                            </button>
                            <button class="btn" onclick="cancelTerritoryCapture('${locationId}')" style="width: 100%; background: #c62828; margin-top: 0.5rem;">
                                ‚ùå Zru≈°it obsazov√°n√≠
                            </button>
                        ` : `
                            <button class="btn" onclick="startTerritoryCapture('${locationId}')" style="width: 100%; background: ${factionData.color};">
                                ${captureProgress > 0 ? '‚è≥ Pokraƒçovat v obsazov√°n√≠' : 'üè¥ Zaƒç√≠t obsazovat'}
                            </button>
                        `}
                        <p style="color: #666; font-size: 0.75rem; text-align: center; margin-top: 0.3rem;">Mus√≠≈° z≈Østat na lokaci!</p>
                    `;
                }
            } else {
                // Neutr√°ln√≠ √∫zem√≠
                actionsHtml = `
                    <p style="color: #888; text-align: center;">‚ö™ Neutr√°ln√≠ √∫zem√≠ - nikdo ho neovl√°d√°</p>
                    <button class="btn" onclick="claimNeutralTerritory('${locationId}')" style="width: 100%; background: ${factionData.color}; margin-top: 1rem;">
                        üè¥ Obsadit pro ${factionData.name}!
                    </button>
                    <p style="color: #666; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">Neutr√°ln√≠ √∫zem√≠ lze obsadit okam≈æitƒõ</p>
                `;
            }
            
            showModal(`üè¥ ${loc?.name || '√özem√≠'}`, `
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <p style="color: ${factionData.color}; margin: 0;">Tv√° frakce: ${factionData.icon} ${factionData.name}</p>
                    <p style="color: #888; font-size: 0.8rem; margin: 0;">Tv≈Øj p≈ô√≠spƒõvek: ${state.pvpFactionContribution || 0} bod≈Ø</p>
                </div>
                
                ${actionsHtml}
                
                <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem;">
                    <p style="color: #666; font-size: 0.7rem; margin: 0; text-align: center;">
                        üí° Body = p≈ô√≠spƒõvek do ≈æeb≈ô√≠ƒçku. √özem√≠ vlastn√≠ frakce s nejv√≠ce body.
                    </p>
                </div>
                
                <button class="btn" onclick="stopTerritoryRefresh(); closeModal();" style="width: 100%; margin-top: 0.5rem; background: #555;">Zav≈ô√≠t</button>
            `);
            
            // Pokud prob√≠h√° capture, spus≈• auto-refresh ka≈ædou sekundu
            if (state.territoryCapture?.[locationId]) {
                territoryRefreshInterval = setInterval(() => {
                    // Zkontroluj jestli je modal je≈°tƒõ otev≈ôen√Ω a capture bƒõ≈æ√≠
                    const modalEl = document.getElementById('modalContainer');
                    if (!modalEl || modalEl.style.display === 'none' || !state.territoryCapture?.[locationId]) {
                        stopTerritoryRefresh();
                        return;
                    }
                    // Refresh modal
                    showTerritoryActions();
                }, 1000);
            }
        }
        
        // Najmout str√°≈æce
        async function hireGuard(locationId, guardType) {
            const guard = TERRITORY_GUARDS.find(g => g.id === guardType);
            if (!guard) return;
            
            const faction = getPlayerFaction();
            if (!faction) return;
            
            if (getMoney() < guard.price) {
                notifyWarning('M√°lo penƒõz', `Pot≈ôebuje≈° ${guard.price} üí∞`);
                return;
            }
            
            // Zkontroluj vlastnictv√≠, aktivitu a max str√°≈æc≈Ø
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    const territory = snapshot.val() || {};
                    
                    // Kontrola vlastnictv√≠ - pouze ƒçlenov√© vlastn√≠c√≠ frakce m≈Ø≈æou p≈ôidat str√°≈æce
                    if (territory.owner !== faction) {
                        notifyWarning('Nelze!', 'Str√°≈æce m≈Ø≈æe≈° p≈ôidat jen na √∫zem√≠ sv√© frakce');
                        return;
                    }
                    
                    // Kontrola jestli nƒõkdo nebojuje/nedob√Ωv√°
                    if (territory.activeCapture) {
                        const timePassed = Date.now() - (territory.activeCapture.startTime || 0);
                        if (timePassed < 35 * 60 * 1000) {
                            const action = territory.activeCapture.action === 'fighting' ? 'bojuje' : 'dob√Ωv√° √∫zem√≠';
                            notifyWarning('√özem√≠ obsazeno!', `Hr√°ƒç ${territory.activeCapture.player} zde pr√°vƒõ ${action}`);
                            return;
                        }
                    }
                    
                    const currentGuards = territory.guards || [];
                    
                    if (currentGuards.length >= MAX_GUARDS_PER_TERRITORY) {
                        notifyWarning('Maximum!', `√özem√≠ m≈Ø≈æe m√≠t max ${MAX_GUARDS_PER_TERRITORY} str√°≈æce`);
                        return;
                    }
                    
                    removeMoney(guard.price);
                    
                    // P≈ôidej str√°≈æce do pole
                    currentGuards.push({
                        type: guardType,
                        hp: guard.hp,
                        hiredBy: getPlayerName(),
                        hiredAt: Date.now()
                    });
                    
                    await firebaseDB.ref('territories/' + locationId + '/guards').set(currentGuards);
                    
                    // Aktualizuj aktivitu
                    await updateFactionActivity();
                    
                    notifySuccess('Str√°≈æce najat!', `${guard.icon} ${guard.name} hl√≠d√° √∫zem√≠ (${currentGuards.length}/${MAX_GUARDS_PER_TERRITORY})`);
                } catch(e) {
                    console.error('Hire guard error:', e);
                }
            }
            
            closeModal();
            showTerritoryActions();
        }
        
        // √ötok na str√°≈æce - pou≈æije klasick√Ω bojov√Ω syst√©m
        async function attackTerritoryGuard(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            const myName = getPlayerName();
            let territory = null;
            let guards = [];
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    territory = snapshot.val();
                    guards = territory?.guards || [];
                    
                    // Kontrola jestli nƒõkdo jin√Ω nebojuje
                    if (territory?.activeCapture) {
                        const timePassed = Date.now() - (territory.activeCapture.startTime || 0);
                        if (timePassed < 35 * 60 * 1000 && territory.activeCapture.player !== myName) {
                            notifyWarning('Obsazeno!', `Hr√°ƒç ${territory.activeCapture.player} zde pr√°vƒõ bojuje`);
                            return;
                        }
                    }
                } catch(e) {
                    console.error('Load territory error:', e);
                    return;
                }
            }
            
            if (guards.length === 0) {
                notifyInfo('≈Ω√°dn√Ω str√°≈æce', '√özem√≠ nem√° str√°≈æce');
                showTerritoryActions();
                return;
            }
            
            // Zobraz p≈ôehled str√°≈æc≈Ø p≈ôed bojem
            const ownerFaction = territory?.owner ? PVP_FACTIONS[territory.owner] : null;
            const guardsListHtml = guards.map((g, i) => {
                const guardDef = TERRITORY_GUARDS.find(gt => gt.id === g.type);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${i === 0 ? '#f44336' : '#555'};">
                        <span>${guardDef?.icon || 'üë§'} ${guardDef?.name || 'Str√°≈æce'}</span>
                        <span style="color: #888;">‚ù§Ô∏è ${g.hp || guardDef?.hp || 100} | ‚öîÔ∏è ${guardDef?.damage || 10}</span>
                    </div>
                `;
            }).join('');
            
            showModal('‚öîÔ∏è Str√°≈æci √∫zem√≠', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: ${ownerFaction?.color || '#888'};">${ownerFaction?.icon || '?'} √özem√≠ frakce: ${ownerFaction?.name || '?'}</p>
                    <p style="color: #f44336; font-size: 1.1rem;">üõ°Ô∏è ${guards.length} str√°≈æc≈Ø br√°n√≠ √∫zem√≠!</p>
                </div>
                
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">
                    ${guardsListHtml}
                </div>
                
                <p style="color: #888; font-size: 0.85rem; text-align: center;">Mus√≠≈° porazit v≈°echny str√°≈æce abys dobyl √∫zem√≠.</p>
                <p style="color: #ff9800; font-size: 0.8rem; text-align: center;">‚ö†Ô∏è Boj ned√°v√° XP ani loot!</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚Üê Zpƒõt</button>
                    <button class="btn" onclick="startGuardCombat('${locationId}')" style="background: #f44336;">‚öîÔ∏è Do boje!</button>
                </div>
            `);
        }
        
        // Spust√≠ skuteƒçn√Ω boj se str√°≈æci
        async function startGuardCombat(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            const myName = getPlayerName();
            let territory = null;
            let guards = [];
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories/' + locationId).once('value');
                    territory = snapshot.val();
                    guards = territory?.guards || [];
                    
                    // Zapi≈° ≈æe bojujeme
                    await firebaseDB.ref('territories/' + locationId + '/activeCapture').set({
                        player: myName,
                        faction: faction,
                        startTime: Date.now(),
                        action: 'fighting'
                    });
                } catch(e) {
                    console.error('Start guard combat error:', e);
                    return;
                }
            }
            
            if (guards.length === 0) {
                notifyInfo('≈Ω√°dn√Ω str√°≈æce', '√özem√≠ nem√° str√°≈æce');
                return;
            }
            
            // Ulo≈æ info o teritori√°ln√≠m boji
            window.territoryBattle = {
                locationId: locationId,
                faction: faction,
                originalGuards: [...guards]
            };
            
            // P≈ôeveƒè str√°≈æce na nep≈ô√°tele pro bojov√Ω syst√©m
            const enemyGroup = guards.map(g => {
                const guardDef = TERRITORY_GUARDS.find(gt => gt.id === g.type);
                return {
                    id: 'territory_guard_' + g.type,
                    name: guardDef?.name || 'Str√°≈æce',
                    icon: guardDef?.icon || 'üë§',
                    hp: g.hp || guardDef?.hp || 100,
                    maxHp: guardDef?.hp || 100,
                    damage: guardDef?.damage || 10,
                    defense: guardDef?.defense || 5,
                    xp: 0, // ≈Ω√°dn√© XP
                    loot: [], // ≈Ω√°dn√Ω loot
                    isGuard: true,
                    guardType: g.type
                };
            });
            
            closeModal();
            
            // Spus≈• klasick√Ω boj
            startCombatWithGroup(enemyGroup, 'territory_guard', true);
        }
        
        // Callback po skonƒçen√≠ boje se str√°≈æci
        async function onTerritoryBattleEnd(victory) {
            const battle = window.territoryBattle;
            if (!battle) return;
            
            const { locationId, faction } = battle;
            
            if (victory) {
                // Vyhr√°li jsme - dobyli jsme √∫zem√≠!
                if (multiplayerEnabled && firebaseDB) {
                    try {
                        await firebaseDB.ref('territories/' + locationId + '/guards').remove();
                        await firebaseDB.ref('territories/' + locationId + '/owner').set(faction);
                        await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                        await contributeToTerritory(50);
                        window.territoryCache = null;
                        
                        setTimeout(() => {
                            showModal('üèÜ √özem√≠ dobyto!', `
                                <div style="text-align: center;">
                                    <div style="font-size: 4rem;">üèÜ</div>
                                    <p style="color: #4caf50; font-size: 1.2rem;">V≈°ichni str√°≈æci pora≈æeni!</p>
                                    <p style="color: ${PVP_FACTIONS[faction].color};">√özem√≠ nyn√≠ pat≈ô√≠ ${PVP_FACTIONS[faction].name}!</p>
                                    <p style="color: #ffd700;">+50 bod≈Ø pro frakci</p>
                                </div>
                                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                            `);
                        }, 500);
                    } catch(e) {
                        console.error('Territory capture error:', e);
                    }
                }
            } else {
                // Prohr√°li jsme nebo utekli - aktualizuj HP str√°≈æc≈Ø
                if (multiplayerEnabled && firebaseDB) {
                    try {
                        // Z√≠skej aktu√°ln√≠ stav str√°≈æc≈Ø z bojov√©ho syst√©mu
                        const cs = window.combatState;
                        if (cs) {
                            const remainingGuards = cs.enemies
                                .filter(e => e.hp > 0 && e.isGuard)
                                .map(e => ({
                                    type: e.guardType,
                                    hp: e.hp,
                                    hiredBy: battle.originalGuards.find(g => g.type === e.guardType)?.hiredBy || 'unknown',
                                    hiredAt: battle.originalGuards.find(g => g.type === e.guardType)?.hiredAt || Date.now()
                                }));
                            
                            if (remainingGuards.length > 0) {
                                await firebaseDB.ref('territories/' + locationId + '/guards').set(remainingGuards);
                            } else {
                                // V≈°ichni mrtv√≠ ale hr√°ƒç taky - √∫zem√≠ z≈Øst√°v√°
                                await firebaseDB.ref('territories/' + locationId + '/guards').remove();
                            }
                        }
                        
                        await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                    } catch(e) {
                        console.error('Update guards error:', e);
                    }
                }
            }
            
            window.territoryBattle = null;
        }
        
        // Obsadit neutr√°ln√≠ √∫zem√≠
        async function claimNeutralTerritory(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            console.log('üè¥ claimNeutralTerritory:', locationId, 'faction:', faction);
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    console.log('üè¥ Setting owner in Firebase...');
                    await firebaseDB.ref('territories/' + locationId + '/owner').set(faction);
                    console.log('üè¥ Owner set! Now contributing...');
                    await contributeToTerritory(20);
                    // Invaliduj cache
                    window.territoryCache = null;
                    console.log('üè¥ Claim complete!');
                } catch(e) {
                    console.error('Claim territory error:', e);
                    notifyWarning('Chyba', 'Nepoda≈ôilo se obsadit: ' + e.message);
                    return;
                }
            }
            
            notifySuccess('√özem√≠ obsazeno!', `+20 bod≈Ø pro ${PVP_FACTIONS[faction].name}`);
            closeModal();
        }
        
        // Zaƒç√≠t obsazovat √∫zem√≠ bez str√°≈æce (30 min ƒçek√°n√≠)
        async function startTerritoryCapture(locationId) {
            const faction = getPlayerFaction();
            if (!faction) return;
            
            const myName = getPlayerName();
            
            // KONTROLA: U≈æ prob√≠h√° obsazov√°n√≠ na t√©to lokaci?
            if (state.territoryCapture?.[locationId]) {
                notifyWarning('U≈æ obsazuje≈°', 'Obsazov√°n√≠ ji≈æ prob√≠h√°');
                closeModal();
                return;
            }
            
            // KONTROLA: Zkontroluj Firebase jestli tam nen√≠ aktivn√≠ capture od tohoto hr√°ƒçe
            let originalOwner = null;
            if (multiplayerEnabled && firebaseDB) {
                try {
                    // Nejd≈ô√≠v zkontroluj jestli √∫zem√≠ u≈æ nevlastn√≠ na≈°e frakce
                    const ownerSnapshot = await firebaseDB.ref('territories/' + locationId + '/owner').once('value');
                    const currentOwner = ownerSnapshot.val();
                    originalOwner = currentOwner; // Ulo≈æ pro pozdƒõj≈°√≠ kontrolu
                    
                    if (currentOwner === faction) {
                        notifyInfo('√özem√≠ ji≈æ vlastn√≠me', 'Toto √∫zem√≠ u≈æ pat≈ô√≠ tv√© frakci');
                        closeModal();
                        return;
                    }
                    
                    const snapshot = await firebaseDB.ref('territories/' + locationId + '/activeCapture').once('value');
                    const activeCapture = snapshot.val();
                    
                    if (activeCapture && activeCapture.player === myName) {
                        // U≈æ m√°me rozdƒõlan√Ω capture - obnov ho
                        const elapsed = Date.now() - activeCapture.startTime;
                        const progress = Math.min(100, (elapsed / (30 * 60 * 1000)) * 100);
                        
                        if (progress < 100) {
                            // Obnov lok√°ln√≠ stav
                            if (!state.territoryCapture) state.territoryCapture = {};
                            state.territoryCapture[locationId] = {
                                startTime: activeCapture.startTime,
                                progress: progress,
                                faction: activeCapture.faction,
                                originalOwner: activeCapture.originalOwner || currentOwner
                            };
                            
                            // Spus≈• listener
                            startTerritoryListener(locationId);
                            
                            notifyInfo('Obsazov√°n√≠ obnoveno', `Progress: ${progress.toFixed(0)}%`);
                            closeModal();
                            return;
                        } else {
                            // Capture mƒõl b√Ωt dokonƒçen - dokonƒçi ho
                            await completeTerritoryCapture(locationId);
                            closeModal();
                            return;
                        }
                    } else if (activeCapture && activeCapture.player !== myName) {
                        // Nƒõkdo jin√Ω obsazuje - zkontroluj jestli nen√≠ star√Ω (> 35 min)
                        const elapsed = Date.now() - activeCapture.startTime;
                        if (elapsed > 35 * 60 * 1000) {
                            // Star√Ω capture - vyƒçisti ho
                            console.log('üè¥ Cleaning old capture from', activeCapture.player);
                            await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                            // Pokraƒçuj v norm√°ln√≠m startu capture
                        } else {
                            notifyWarning('√özem√≠ obsazeno', `${activeCapture.player} ji≈æ obsazuje`);
                            closeModal();
                            return;
                        }
                    }
                } catch(e) {
                    console.error('Check capture error:', e);
                }
            }
            
            // Zapi≈° aktivn√≠ho hr√°ƒçe do Firebase
            if (multiplayerEnabled && firebaseDB) {
                try {
                    await firebaseDB.ref('territories/' + locationId + '/activeCapture').set({
                        player: myName,
                        faction: faction,
                        startTime: Date.now(),
                        action: 'capturing',
                        originalOwner: originalOwner
                    });
                    // Invaliduj cache aby mapa zobrazila spr√°vn√Ω stav
                    window.territoryCache = null;
                    console.log('üè¥ Capture started, cache invalidated');
                } catch(e) {
                    console.error('Start capture error:', e);
                }
            }
            
            // Inicializuj progress lok√°lnƒõ
            if (!state.territoryCapture) state.territoryCapture = {};
            state.territoryCapture[locationId] = {
                startTime: Date.now(),
                progress: 0,
                faction: faction,
                originalOwner: originalOwner
            };
            
            // Spus≈• real-time listener na zmƒõny vlastn√≠ka
            startTerritoryListener(locationId);
            
            notifyInfo('Obsazov√°n√≠ zaƒçalo', 'Z≈Østa≈à na lokaci 30 minut');
            closeModal();
            
            // Spust√≠ se v gameLoop
        }
        
        // Aktualizace obsazov√°n√≠ (vol√° se v gameLoop)
        async function updateTerritoryCapture(deltaSeconds) {
            if (!state.territoryCapture) return;
            
            const locationId = state.world?.currentLocation;
            const CAPTURE_DURATION = 30 * 60 * 1000; // 30 minut v ms
            
            // Projdi v≈°echny aktivn√≠ capture
            for (const [capLocId, capture] of Object.entries(state.territoryCapture)) {
                // Pokud hr√°ƒç nen√≠ na t√©to lokaci, zru≈° capture
                if (capLocId !== locationId) {
                    console.log(`üè¥ Capture zru≈°en - opustil jsi lokaci ${capLocId}`);
                    
                    // Odstra≈à listener a Firebase z√°znam
                    stopTerritoryListener(capLocId);
                    if (multiplayerEnabled && firebaseDB) {
                        firebaseDB.ref('territories/' + capLocId + '/activeCapture').remove().catch(e => {});
                    }
                    
                    delete state.territoryCapture[capLocId];
                    notifyWarning('Obsazov√°n√≠ zru≈°eno', 'Opustil jsi lokaci p≈ôed dokonƒçen√≠m');
                    continue;
                }
                
                // Kontrola dokonƒçen√≠ pomoc√≠ ƒçasu
                if (capture.startTime) {
                    const elapsed = Date.now() - capture.startTime;
                    
                    // Aktualizuj progress v procentech
                    capture.progress = Math.min(100, (elapsed / CAPTURE_DURATION) * 100);
                    
                    if (elapsed >= CAPTURE_DURATION) {
                        // Dokonƒçeno!
                        console.log('üè¥ Capture duration reached for', capLocId);
                        stopTerritoryListener(capLocId);
                        await completeTerritoryCapture(capLocId);
                    }
                }
            }
        }
        
        // Real-time listenery pro √∫zem√≠
        let territoryListeners = {};
        
        function startTerritoryListener(locationId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (territoryListeners[locationId]) return; // U≈æ bƒõ≈æ√≠
            
            const myFaction = getPlayerFaction();
            const myName = getPlayerName();
            
            // Listener na zmƒõnu vlastn√≠ka
            const ownerRef = firebaseDB.ref('territories/' + locationId + '/owner');
            territoryListeners[locationId] = ownerRef.on('value', (snapshot) => {
                const currentOwner = snapshot.val();
                const capture = state.territoryCapture?.[locationId];
                
                if (!capture) return;
                
                // Pokud √∫zem√≠ u≈æ vlastn√≠ na≈°e frakce, zru≈° capture
                if (currentOwner === myFaction) {
                    console.log('üè¥ [Listener] √özem√≠ u≈æ vlastn√≠me - ru≈°√≠me capture');
                    firebaseDB.ref('territories/' + locationId + '/activeCapture').remove().catch(e => {});
                    delete state.territoryCapture[locationId];
                    stopTerritoryListener(locationId);
                    notifyInfo('Capture zru≈°en', '√özem√≠ u≈æ pat≈ô√≠ tv√© frakci!');
                    return;
                }
                
                // Pokud se vlastn√≠k zmƒõnil na jinou frakci (nƒõkdo jin√Ω dobyl)
                if (capture.originalOwner !== undefined && currentOwner !== capture.originalOwner && currentOwner !== null) {
                    console.log('üè¥ [Listener] Vlastn√≠k se zmƒõnil - ru≈°√≠me capture');
                    firebaseDB.ref('territories/' + locationId + '/activeCapture').remove().catch(e => {});
                    delete state.territoryCapture[locationId];
                    stopTerritoryListener(locationId);
                    notifyWarning('Capture zru≈°en', 'Nƒõkdo jin√Ω pr√°vƒõ dobyl toto √∫zem√≠!');
                }
            });
            
            console.log('üè¥ Started territory listener for', locationId);
        }
        
        function stopTerritoryListener(locationId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (!territoryListeners[locationId]) return;
            
            firebaseDB.ref('territories/' + locationId + '/owner').off('value', territoryListeners[locationId]);
            delete territoryListeners[locationId];
            console.log('üè¥ Stopped territory listener for', locationId);
        }
        
        function stopAllTerritoryListeners() {
            Object.keys(territoryListeners).forEach(locId => {
                stopTerritoryListener(locId);
            });
        }
        
        // Obnova rozdƒõlan√©ho capture po refreshi str√°nky
        async function restoreTerritoryCapture() {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (!state.confirmed) return;
            
            const myName = getPlayerName();
            const currentLocationId = state.world?.currentLocation;
            
            try {
                // Prohledej V≈†ECHNY √∫zem√≠ jestli tam nem√°me aktivn√≠ capture
                const snapshot = await firebaseDB.ref('territories').once('value');
                const territories = snapshot.val() || {};
                
                for (const [locationId, territory] of Object.entries(territories)) {
                    const activeCapture = territory.activeCapture;
                    
                    if (activeCapture && activeCapture.player === myName) {
                        const elapsed = Date.now() - activeCapture.startTime;
                        const progress = Math.min(100, (elapsed / (30 * 60 * 1000)) * 100);
                        
                        console.log(`üè¥ Found active capture at ${locationId}: ${progress.toFixed(1)}%`);
                        
                        if (progress >= 100) {
                            // Mƒõl b√Ωt dokonƒçen - dokonƒçi ho!
                            console.log('üè¥ Auto-completing expired capture at', locationId);
                            await completeTerritoryCapture(locationId);
                        } else if (locationId === currentLocationId) {
                            // Jsme na t√© lokaci - obnov lok√°ln√≠ stav
                            if (!state.territoryCapture) state.territoryCapture = {};
                            state.territoryCapture[locationId] = {
                                startTime: activeCapture.startTime,
                                progress: progress,
                                faction: activeCapture.faction,
                                originalOwner: activeCapture.originalOwner
                            };
                            
                            // Spus≈• listener
                            startTerritoryListener(locationId);
                            
                            console.log(`üè¥ Capture obnoven: ${progress.toFixed(1)}%`);
                            notifyInfo('Obsazov√°n√≠ obnoveno', `Progress: ${progress.toFixed(0)}% - pokraƒçuj!`);
                        } else {
                            // Nejsme na t√© lokaci - zru≈° capture
                            console.log('üè¥ Cancelling capture at', locationId, '- player is elsewhere');
                            await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                            notifyWarning('Obsazov√°n√≠ zru≈°eno', `Opustil jsi ${locationId} p≈ôed dokonƒçen√≠m`);
                        }
                    }
                }
            } catch(e) {
                console.error('Restore capture error:', e);
            }
        }
        
        async function completeTerritoryCapture(locationId) {
            const faction = getPlayerFaction();
            if (!faction) {
                console.log('üè¥ completeTerritoryCapture - no faction!');
                return;
            }
            
            console.log('üè¥ completeTerritoryCapture started for', locationId, 'faction:', faction);
            
            // Zastav listener
            stopTerritoryListener(locationId);
            
            // Sma≈æ lok√°ln√≠ stav (pokud existuje)
            if (state.territoryCapture && state.territoryCapture[locationId]) {
                delete state.territoryCapture[locationId];
            }
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    // Zkontroluj jestli √∫zem√≠ u≈æ nem√°me
                    const ownerSnapshot = await firebaseDB.ref('territories/' + locationId + '/owner').once('value');
                    const currentOwner = ownerSnapshot.val();
                    console.log('üè¥ Current owner:', currentOwner);
                    
                    if (currentOwner === faction) {
                        // U≈æ m√°me √∫zem√≠
                        console.log('üè¥ Territory already owned by us');
                        notifyInfo('√özem√≠ ji≈æ vlastn√≠me', 'Toto √∫zem√≠ u≈æ pat≈ô√≠ tv√© frakci');
                        
                        // Vyƒçisti p≈ô√≠padn√Ω activeCapture
                        await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                        return;
                    }
                    
                    // Zkontroluj activeCapture
                    const captureRef = firebaseDB.ref('territories/' + locationId + '/activeCapture');
                    const captureSnapshot = await captureRef.once('value');
                    const activeCapture = captureSnapshot.val();
                    const myName = getPlayerName();
                    console.log('üè¥ Active capture:', activeCapture, 'myName:', myName);
                    
                    // Pokud nƒõkdo jin√Ω aktivnƒõ obsazuje (ƒçerstv√Ω capture), neru≈°√≠me
                    if (activeCapture && activeCapture.player !== myName) {
                        const elapsed = Date.now() - activeCapture.startTime;
                        if (elapsed < 35 * 60 * 1000) {
                            // Nƒõkdo jin√Ω m√° ƒçerstv√Ω capture - zru≈°eno
                            console.log('üè¥ Someone else is capturing:', activeCapture.player);
                            notifyWarning('Obsazov√°n√≠ zru≈°eno', `${activeCapture.player} pr√°vƒõ obsazuje toto √∫zem√≠`);
                            return;
                        }
                        // Star√Ω capture - vyƒçist√≠me a pokraƒçujeme
                        console.log('üè¥ Cleaning stale capture from', activeCapture.player);
                    }
                    
                    // Vyƒçisti activeCapture (n√°≈° nebo star√Ω)
                    await captureRef.remove();
                    console.log('üè¥ ActiveCapture removed');
                    
                    // Nastav vlastn√≠ka
                    console.log('üè¥ Setting owner to', faction);
                    await firebaseDB.ref('territories/' + locationId + '/owner').set(faction);
                    console.log('üè¥ Owner set successfully!');
                    
                    await contributeToTerritory(30);
                    window.territoryCache = null; // Invaliduj cache
                    
                    console.log('üè¥ Territory captured:', locationId, 'for', faction);
                    notifySuccess('üè¥ √özem√≠ dobyto!', `+30 bod≈Ø pro ${PVP_FACTIONS[faction].name}`);
                    
                } catch(e) {
                    console.error('Complete capture error:', e);
                    notifyWarning('Chyba', 'Nepoda≈ôilo se dokonƒçit obsazov√°n√≠: ' + e.message);
                }
            } else {
                notifySuccess('üè¥ √özem√≠ dobyto!', `+30 bod≈Ø pro ${PVP_FACTIONS[faction].name}`);
            }
        }
        
        // Zru≈°it obsazov√°n√≠ √∫zem√≠
        async function cancelTerritoryCapture(locationId) {
            if (!state.territoryCapture || !state.territoryCapture[locationId]) return;
            
            // Zastav refresh interval
            stopTerritoryRefresh();
            
            // Odstra≈à z Firebase
            if (multiplayerEnabled && firebaseDB) {
                try {
                    await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                } catch(e) {
                    console.error('Cancel capture error:', e);
                }
            }
            
            // Odstra≈à lok√°ln√≠ stav
            delete state.territoryCapture[locationId];
            
            notifyInfo('Obsazov√°n√≠ zru≈°eno', 'Progress byl ztracen');
            closeModal();
            renderFull();
        }
        
        // Zobrazit mapu √∫zem√≠ (zjednodu≈°en√°)
        async function showTerritoryMap() {
            let territories = {};
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snapshot = await firebaseDB.ref('territories').once('value');
                    territories = snapshot.val() || {};
                } catch(e) {}
            }
            
            // Seskup podle frakce
            const byFaction = { kory: [], koudy: [], independent: [], neutral: [] };
            WORLD_LOCATIONS.filter(l => l.type !== 'home').forEach(loc => {
                const owner = territories[loc.id]?.owner;
                if (owner) {
                    byFaction[owner].push(loc.name);
                } else {
                    byFaction.neutral.push(loc.name);
                }
            });
            
            const html = Object.entries(PVP_FACTIONS).map(([id, f]) => `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: ${f.color}; margin: 0 0 0.3rem 0;">${f.icon} ${f.name} (${byFaction[id].length})</h4>
                    <p style="color: #888; font-size: 0.75rem; margin: 0;">${byFaction[id].slice(0, 5).join(', ')}${byFaction[id].length > 5 ? '...' : ''}</p>
                </div>
            `).join('') + `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #888; margin: 0 0 0.3rem 0;">‚ö™ Neutr√°ln√≠ (${byFaction.neutral.length})</h4>
                    <p style="color: #666; font-size: 0.75rem; margin: 0;">${byFaction.neutral.slice(0, 5).join(', ')}${byFaction.neutral.length > 5 ? '...' : ''}</p>
                </div>
            `;
            
            showModal('üó∫Ô∏è Mapa √∫zem√≠', `
                ${html}
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        // Cache pro vedouc√≠ frakci (aktualizuje se p≈ôi naƒçten√≠ territory cache)
        window.leadingFaction = null;
        
        // Z√≠skat vedouc√≠ frakci (ta s nejv√≠ce √∫zem√≠mi)
        function getLeadingFaction() {
            if (!window.territoryCache) return null;
            
            const counts = { kory: 0, koudy: 0, independent: 0 };
            Object.values(window.territoryCache).forEach(t => {
                if (t.owner && counts[t.owner] !== undefined) {
                    counts[t.owner]++;
                }
            });
            
            let leading = null;
            let maxCount = 0;
            Object.entries(counts).forEach(([faction, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    leading = faction;
                }
            });
            
            window.leadingFaction = leading;
            return leading;
        }
        
        // Z√≠skat frakƒçn√≠ bonus hr√°ƒçe (pouze pokud je jeho frakce vedouc√≠!)
        function getFactionBonus() {
            const faction = getPlayerFaction();
            if (!faction || !PVP_FACTIONS[faction]) return { damage: 0, xp: 0, loot: 0 };
            
            // Bonus pouze pro vedouc√≠ frakci
            const leading = window.leadingFaction || getLeadingFaction();
            if (faction !== leading) {
                return { damage: 0, xp: 0, loot: 0 }; // Nen√≠ vedouc√≠, ≈æ√°dn√Ω bonus
            }
            
            return PVP_FACTIONS[faction].bonus;
        }
        
        // Z√≠skat barvu frakce hr√°ƒçe podle jm√©na (pro chat)
        async function getPlayerFactionColor(playerName) {
            if (!multiplayerEnabled || !firebaseDB) return null;
            
            try {
                const sanitizedName = playerName.replace(/[\/\.#$\[\]]/g, '_');
                const snapshot = await firebaseDB.ref('factionMembers/' + sanitizedName).once('value');
                const data = snapshot.val();
                if (data?.faction && PVP_FACTIONS[data.faction]) {
                    return PVP_FACTIONS[data.faction].color;
                }
            } catch(e) {
                console.log('Get faction color error:', e);
            }
            return null;
        }
        
        // === DANƒö Z √öZEM√ç ===
        // Ka≈ædou hodinu se rozdƒõl√≠ p≈ô√≠jem z √∫zem√≠ mezi ƒçleny frakce
        async function collectTerritoryTaxes() {
            const faction = getPlayerFaction();
            if (!faction || !multiplayerEnabled || !firebaseDB) return;
            
            try {
                // Naƒçti poƒçet √∫zem√≠ tv√© frakce
                const terrSnapshot = await firebaseDB.ref('territories').once('value');
                const territories = terrSnapshot.val() || {};
                
                let factionTerritories = 0;
                Object.values(territories).forEach(t => {
                    if (t.owner === faction) factionTerritories++;
                });
                
                if (factionTerritories === 0) return; // ≈Ω√°dn√° √∫zem√≠, ≈æ√°dn√© danƒõ
                
                // Naƒçti poƒçet aktivn√≠ch ƒçlen≈Ø frakce (online v posledn√≠ch 24h)
                const membersSnapshot = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnapshot.val() || {};
                
                let activeMembers = 0;
                const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
                Object.values(members).forEach(m => {
                    if (m.faction === faction && m.lastActive && m.lastActive > dayAgo) {
                        activeMembers++;
                    }
                });
                
                // Minim√°lnƒõ 1 ƒçlen (ty)
                activeMembers = Math.max(1, activeMembers);
                
                // V√Ωpoƒçet p≈ô√≠jmu: 5 penƒõz za √∫zem√≠ za hodinu, rozdƒõleno mezi aktivn√≠ ƒçleny
                const totalIncome = factionTerritories * 5;
                const myShare = Math.floor(totalIncome / activeMembers);
                
                if (myShare > 0) {
                    state.resources.money = (state.resources.money || 0) + myShare;
                    
                    // Aktualizuj lastActive pro sebe
                    const myName = getPlayerName();
                    const sanitizedName = myName.replace(/[\/\.#$\[\]]/g, '_');
                    await firebaseDB.ref('factionMembers/' + sanitizedName + '/lastActive').set(Date.now());
                    
                    // Notifikace
                    const factionData = PVP_FACTIONS[faction];
                    notifySuccess(`${factionData.icon} Danƒõ z √∫zem√≠`, `+${myShare}üí∞ (${factionTerritories} √∫zem√≠)`);
                    addLog(`${factionData.icon} Frakƒçn√≠ danƒõ: +${myShare} penƒõz z ${factionTerritories} √∫zem√≠`, 'üí∞');
                    
                    console.log(`üí∞ Territory taxes: ${myShare} money from ${factionTerritories} territories (${activeMembers} active members)`);
                }
            } catch(e) {
                console.error('Territory taxes error:', e);
            }
        }
        
        // === T√ùDENN√ç SEZ√ìNA FRAKƒåN√ç V√ÅLKY ===
        
        // Z√≠skat ƒças do konce sez√≥ny (nedƒõle 23:59:59)
        function getSeasonEndTime() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = nedƒõle
            const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
            
            const endDate = new Date(now);
            endDate.setDate(now.getDate() + daysUntilSunday);
            endDate.setHours(23, 59, 59, 999);
            
            return endDate.getTime();
        }
        
        // Form√°tovat zb√Ωvaj√≠c√≠ ƒças
        function formatTimeRemaining(ms) {
            if (ms <= 0) return 'Konƒç√≠!';
            
            const days = Math.floor(ms / (24 * 60 * 60 * 1000));
            const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
            const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }
        
        // Zkontrolovat a prov√©st reset sez√≥ny
        async function checkSeasonReset() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0 = nedƒõle
                const hour = now.getHours();
                
                // Reset pouze v nedƒõli mezi 23:00 a 23:59
                if (dayOfWeek !== 0 || hour < 23) {
                    return; // Nen√≠ nedƒõle veƒçer, nic nedƒõlej
                }
                
                // Naƒçti posledn√≠ reset
                const seasonSnapshot = await firebaseDB.ref('factionSeason').once('value');
                const seasonData = seasonSnapshot.val() || {};
                
                const lastReset = seasonData.lastReset || 0;
                const lastResetDate = new Date(lastReset);
                
                // Pokud u≈æ byl reset dnes (tuto nedƒõli), nic nedƒõlej
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (lastReset > today.getTime()) {
                    return; // U≈æ bylo resetov√°no dnes
                }
                
                console.log('üîÑ Je nedƒõle 23:xx - ƒças na reset sez√≥ny!');
                await performSeasonReset();
                
            } catch(e) {
                // Ignoruj permission denied chyby - Firebase pravidla nemus√≠ dovolovat ƒçten√≠
                if (e.message && e.message.includes('permission_denied')) {
                    console.log('Season check skipped - no permission');
                } else {
                    console.error('Season check error:', e);
                }
            }
        }
        
        // Z√≠skat timestamp posledn√≠ nedƒõle 23:59:59 (pro zobrazen√≠ "do konce sez√≥ny")
        function getNextSundayMidnight() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = nedƒõle
            
            // Kolik dn√≠ do nedƒõle?
            const daysUntilSunday = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);
            
            const nextSunday = new Date(now);
            nextSunday.setDate(now.getDate() + daysUntilSunday);
            nextSunday.setHours(23, 59, 59, 999);
            
            return nextSunday.getTime();
        }
        
        // Star√° funkce pro zpƒõtnou kompatibilitu
        function getLastSundayMidnight() {
            return getNextSundayMidnight(); // Teƒè vrac√≠ P≈ò√ç≈†T√ç nedƒõli
        }
        
        // Prov√©st reset sez√≥ny
        async function performSeasonReset() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                // 1. Zjisti v√Ωsledky p≈ôed resetem
                const terrSnapshot = await firebaseDB.ref('territories').once('value');
                const territories = terrSnapshot.val() || {};
                
                const membersSnapshot = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnapshot.val() || {};
                
                // Spoƒç√≠tej √∫zem√≠ ka≈æd√© frakce
                const factionTerritories = { kory: 0, koudy: 0, independent: 0 };
                Object.values(territories).forEach(t => {
                    if (t.owner && factionTerritories[t.owner] !== undefined) {
                        factionTerritories[t.owner]++;
                    }
                });
                
                // Najdi v√≠tƒõze
                let winnerFaction = null;
                let maxTerr = 0;
                Object.entries(factionTerritories).forEach(([fid, count]) => {
                    if (count > maxTerr) {
                        maxTerr = count;
                        winnerFaction = fid;
                    }
                });
                
                // Spoƒç√≠tej top 3 hr√°ƒçe v√≠tƒõzn√© frakce
                const winnerMembers = [];
                Object.entries(members).forEach(([key, m]) => {
                    if (m.faction === winnerFaction) {
                        winnerMembers.push({ key, name: m.name, contribution: m.contribution || 0 });
                    }
                });
                winnerMembers.sort((a, b) => b.contribution - a.contribution);
                const top3Winners = winnerMembers.slice(0, 3);
                
                // 2. Ulo≈æ historii sez√≥ny
                const seasonNumber = (await firebaseDB.ref('factionSeason/seasonCount').once('value')).val() || 0;
                await firebaseDB.ref('factionSeasonHistory/' + (seasonNumber + 1)).set({
                    endedAt: Date.now(),
                    winner: winnerFaction,
                    territories: factionTerritories,
                    top3: top3Winners.map(m => ({ name: m.name, contribution: m.contribution }))
                });
                
                // 3. Reset √∫zem√≠
                await firebaseDB.ref('territories').remove();
                
                // 4. Reset ƒçlen≈Ø frakc√≠ - v≈°ichni si mus√≠ vybrat znovu
                await firebaseDB.ref('factionMembers').remove();
                
                // 5. Aktualizuj sez√≥nu
                await firebaseDB.ref('factionSeason').set({
                    lastReset: Date.now(),
                    seasonCount: seasonNumber + 1,
                    lastWinner: winnerFaction,
                    lastTerritories: factionTerritories
                });
                
                console.log('‚úÖ Sez√≥na resetov√°na! V√≠tƒõz:', winnerFaction);
                
                // 6. Rozdej odmƒõny tomuto hr√°ƒçi pokud je online
                await claimSeasonRewards(winnerFaction, top3Winners);
                
            } catch(e) {
                console.error('Season reset error:', e);
            }
        }
        
        // Vyzvednout odmƒõny za sez√≥nu
        async function claimSeasonRewards(winnerFaction, top3Winners) {
            const myFaction = getPlayerFaction();
            const myName = getPlayerName();
            
            if (!myFaction) return;
            
            let reward = { money: 0, xp: 0, bonus: '' };
            
            if (myFaction === winnerFaction) {
                // V√≠tƒõzn√° frakce
                reward.money = 100;
                reward.xp = 50;
                reward.bonus = 'üèÜ V√≠tƒõzn√° frakce!';
                
                // Bonus pro TOP 3
                const myRank = top3Winners.findIndex(m => m.name === myName);
                if (myRank === 0) {
                    reward.money += 200;
                    reward.bonus = 'ü•á 1. m√≠sto ve frakci!';
                } else if (myRank === 1) {
                    reward.money += 150;
                    reward.bonus = 'ü•à 2. m√≠sto ve frakci!';
                } else if (myRank === 2) {
                    reward.money += 100;
                    reward.bonus = 'ü•â 3. m√≠sto ve frakci!';
                }
            } else {
                // √öƒçastnick√° odmƒõna
                reward.money = 25;
                reward.xp = 0;
                reward.bonus = '√öƒçastnick√° odmƒõna';
            }
            
            // P≈ôidej odmƒõny
            if (reward.money > 0) {
                state.money = (state.money || 0) + reward.money;
            }
            if (reward.xp > 0) {
                addXP(reward.xp);
            }
            
            // Reset lok√°ln√≠ch dat - hr√°ƒç si mus√≠ vybrat novou frakci
            state.pvpFactionContribution = 0;
            state.pvpFaction = null;
            state.pvpFactionJoinedAt = null;
            saveGame();
            
            // Zobraz notifikaci
            const winnerData = PVP_FACTIONS[winnerFaction];
            showModal('üèÅ Sez√≥na skonƒçila!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin: 1rem 0;">${winnerData?.icon || 'üèÜ'}</div>
                    <h2 style="color: ${winnerData?.color || '#ffd700'}; margin: 0;">V√≠tƒõz: ${winnerData?.name || 'Nezn√°m√° frakce'}</h2>
                    <p style="color: #888;">Ovl√°dli ${factionTerritories?.[winnerFaction] || 0} √∫zem√≠!</p>
                    
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid ${myFaction === winnerFaction ? '#4caf50' : '#666'};">
                        <p style="color: ${myFaction === winnerFaction ? '#4caf50' : '#888'}; font-size: 1.2rem; margin: 0;">${reward.bonus}</p>
                        <p style="color: #ffd700; font-size: 1.1rem; margin: 0.5rem 0;">+${reward.money} üí∞${reward.xp > 0 ? ` +${reward.xp} XP` : ''}</p>
                    </div>
                    
                    <p style="color: #ff9800; font-size: 0.9rem;">üîÑ Vyber si frakci pro novou sez√≥nu!</p>
                </div>
                <button class="btn" onclick="closeModal(); showFactionSelection();" style="width: 100%; margin-top: 1rem; background: #4caf50;">Vybrat frakci</button>
            `);
        }
        
        // Zobrazit info o sez√≥nƒõ
        async function showSeasonInfo() {
            const seasonEnd = getSeasonEndTime();
            const timeLeft = seasonEnd - Date.now();
            const timeLeftStr = formatTimeRemaining(timeLeft);
            
            // Naƒçti historii
            let historyHtml = '<p style="color: #666; text-align: center;">≈Ω√°dn√° historie</p>';
            
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const historySnapshot = await firebaseDB.ref('factionSeasonHistory').orderByKey().limitToLast(5).once('value');
                    const history = historySnapshot.val() || {};
                    
                    const entries = Object.entries(history).reverse();
                    if (entries.length > 0) {
                        historyHtml = entries.map(([num, data]) => {
                            const winner = PVP_FACTIONS[data.winner];
                            const date = new Date(data.endedAt).toLocaleDateString('cs-CZ');
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${winner?.color || '#333'}20; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${winner?.color || '#666'};">
                                    <span style="color: #888;">Sez√≥na ${num}</span>
                                    <span style="color: ${winner?.color || '#fff'};">${winner?.icon || '?'} ${winner?.name || '?'}</span>
                                    <span style="color: #666; font-size: 0.8rem;">${date}</span>
                                </div>
                            `;
                        }).join('');
                    }
                } catch(e) {
                    console.error('Season history error:', e);
                }
            }
            
            showModal('üìÖ Frakƒçn√≠ sez√≥na', `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #0a0a15 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ffd700;">
                    <div style="text-align: center;">
                        <p style="color: #888; margin: 0;">‚è≥ Do konce sez√≥ny:</p>
                        <p style="color: #ffd700; font-size: 2rem; font-weight: bold; margin: 0.5rem 0;">${timeLeftStr}</p>
                        <p style="color: #666; font-size: 0.8rem; margin: 0;">Reset: Nedƒõle 23:59</p>
                    </div>
                </div>
                
                <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">üèÜ Odmƒõny za v√Ωhru:</h4>
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                    <p style="color: #4caf50; margin: 0 0 0.3rem 0;">üèÜ V√≠tƒõzn√° frakce: <span style="color: #ffd700;">100üí∞ + 50 XP</span></p>
                    <p style="color: #ffd700; margin: 0 0 0.3rem 0;">ü•á 1. m√≠sto: <span style="color: #ffd700;">+200üí∞ nav√≠c</span></p>
                    <p style="color: #c0c0c0; margin: 0 0 0.3rem 0;">ü•à 2. m√≠sto: <span style="color: #ffd700;">+150üí∞ nav√≠c</span></p>
                    <p style="color: #cd7f32; margin: 0 0 0.3rem 0;">ü•â 3. m√≠sto: <span style="color: #ffd700;">+100üí∞ nav√≠c</span></p>
                    <p style="color: #888; margin: 0;">üì¶ √öƒçast (ostatn√≠): <span style="color: #ffd700;">25üí∞</span></p>
                </div>
                
                <h4 style="color: #888; margin: 0 0 0.5rem 0;">üìú Historie sez√≥n:</h4>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${historyHtml}
                </div>
                
                <button class="btn" onclick="showFactionHub()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        // === ONLINE STATUS ===
        function setupOnlineStatus() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const playerName = getPlayerName();
            // Sanitizace jm√©na pro Firebase cestu (/ . # $ [ ] nejsou povoleny)
            const sanitizedName = playerName.replace(/[\/\.#$\[\]]/g, '_');
            const playerRef = firebaseDB.ref('online/' + sanitizedName);
            
            // Nastav online - ulo≈æ skuteƒçn√© jm√©no do dat
            playerRef.set({
                name: playerName,  // Skuteƒçn√© jm√©no (m≈Ø≈æe obsahovat speci√°ln√≠ znaky)
                level: state.char.level,
                location: state.world?.currentLocation || 'shelter',
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Aktualizuj frakƒçn√≠ aktivitu p≈ôi p≈ôihl√°≈°en√≠
            updateFactionActivity();
            
            // P≈ôi odpojen√≠ sma≈æ
            playerRef.onDisconnect().remove();
            
            // Aktualizuj ka≈æd√Ωch 30 sekund
            setInterval(() => {
                if (multiplayerEnabled) {
                    playerRef.update({
                        level: state.char.level,
                        location: state.world?.currentLocation || 'shelter',
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }, 30000);
        }
        
        // === LEADERBOARD ===
        async function submitScore() {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Multiplayer vypnut', 'Firebase nen√≠ nakonfigurov√°n');
                return;
            }
            
            initPvPStats();
            const playerName = getPlayerName();
            const score = calculateMultiplayerScore();
            
            // Pro registrovan√© hr√°ƒçe pou≈æij UID jako kl√≠ƒç, pro hosty jm√©no
            const leaderboardKey = currentUser && !currentUser.isAnonymous 
                ? 'user_' + currentUser.uid 
                : playerName;
            
            try {
                await firebaseDB.ref('leaderboard/' + leaderboardKey).set({
                    name: playerName,
                    score: score,
                    level: state.char.level,
                    kills: state.stats?.kills || 0,
                    days: state.time?.days || 0,
                    // PvP Stats
                    pvpElo: state.pvp?.elo || 1000,
                    pvpWins: state.pvp?.wins || 0,
                    pvpLosses: state.pvp?.losses || 0,
                    pvpWinStreak: state.pvp?.maxWinStreak || 0,
                    // Dopl≈àkov√© info
                    classId: state.char.classId || 'survivor',
                    settlers: state.settlement?.settlers?.length || 0,
                    dungeonsCleared: state.dungeon?.cleared ? Object.keys(state.dungeon.cleared).length : 0,
                    uid: currentUser?.uid || null,
                    isRegistered: currentUser && !currentUser.isAnonymous,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Pokud je registrovan√Ω, sma≈æ star√Ω z√°znam pod jm√©nem (pokud existuje a je jin√Ω kl√≠ƒç)
                if (currentUser && !currentUser.isAnonymous && leaderboardKey !== playerName) {
                    try {
                        await firebaseDB.ref('leaderboard/' + playerName).remove();
                    } catch (e) {
                        // Ignoruj chybu - star√Ω z√°znam nemusel existovat
                    }
                }
                
                notifySuccess('Sk√≥re odesl√°no!', `${score.toLocaleString()} bod≈Ø | ELO: ${state.pvp?.elo || 1000}`);
            } catch (e) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ sk√≥re:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se odeslat sk√≥re');
            }
        }
        
        async function showLeaderboard() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('üèÜ ≈Ωeb≈ô√≠ƒçek', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîå</div>
                        <h3 style="color: #ff9800;">Multiplayer nen√≠ aktivn√≠</h3>
                        <p style="color: #888; margin: 1rem 0;">Pro pou≈æit√≠ ≈æeb≈ô√≠ƒçku je pot≈ôeba nakonfigurovat Firebase.</p>
                        <p style="color: #666; font-size: 0.85rem;">Viz instrukce v k√≥du hry.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            showModal('üèÜ ≈Ωeb≈ô√≠ƒçek', `
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p>Naƒç√≠t√°m ≈æeb≈ô√≠ƒçek...</p>
                </div>
            `);
            
            try {
                const snapshot = await firebaseDB.ref('leaderboard')
                    .orderByChild('score')
                    .limitToLast(100)
                    .once('value');
                
                const data = snapshot.val() || {};
                const players = Object.values(data).sort((a, b) => b.score - a.score);
                
                // Naƒçti frakce hr√°ƒç≈Ø
                const factionsSnapshot = await firebaseDB.ref('factionMembers').once('value');
                const factionMembers = factionsSnapshot.val() || {};
                
                // Vytvo≈ô mapu jm√©no -> frakce
                const playerFactions = {};
                Object.values(factionMembers).forEach(m => {
                    if (m.name && m.faction) {
                        playerFactions[m.name] = m.faction;
                    }
                });
                
                // Najdi pozici hr√°ƒçe
                const myName = getPlayerName();
                const myScore = calculateMultiplayerScore();
                const myRank = players.findIndex(p => p.name === myName) + 1;
                
                // Online hr√°ƒçi
                const onlineSnapshot = await firebaseDB.ref('online').once('value');
                const onlinePlayers = Object.keys(onlineSnapshot.val() || {});
                
                let html = `
                    <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4a7a4a;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
                            <div>
                                <div style="color: #888; font-size: 0.8rem;">Tv√© sk√≥re</div>
                                <div style="color: #ffd700; font-size: 1.3rem; font-weight: bold;">${myScore.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 0.8rem;">Pozice</div>
                                <div style="color: #8bc34a; font-size: 1.3rem; font-weight: bold;">#${myRank || '?'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">
                        üë• Online: ${onlinePlayers.length} hr√°ƒç≈Ø
                    </div>
                    
                    <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; border-radius: 8px; padding: 0.5rem;">
                `;
                
                if (players.length === 0) {
                    html += `<div style="text-align: center; padding: 2rem; color: #666;">≈Ω√°dn√≠ hr√°ƒçi v ≈æeb≈ô√≠ƒçku</div>`;
                } else {
                    // Ulo≈æ data hr√°ƒç≈Ø do glob√°ln√≠ promƒõnn√©
                    window._leaderboardPlayers = {};
                    players.forEach((player, idx) => {
                        window._leaderboardPlayers[player.name] = player;
                        const rank = idx + 1;
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                        const isMe = player.name === myName;
                        const isOnline = onlinePlayers.includes(player.name);
                        
                        // Frakce hr√°ƒçe - text v z√°vorce jako v chatu
                        const playerFaction = playerFactions[player.name];
                        const factionData = playerFaction ? PVP_FACTIONS[playerFaction] : null;
                        let factionPrefix = '';
                        if (factionData) {
                            const factionShort = playerFaction === 'kory' ? 'Koryho' : playerFaction === 'koudy' ? 'Koudyho' : 'Nez√°visl√Ω';
                            factionPrefix = `<span style="color: ${factionData.color}; font-size: 0.65rem;">[${factionShort}]</span> `;
                        }
                        
                        html += `
                            <div onclick="${isMe ? '' : `showPlayerProfileByName('${escapeHtml(player.name).replace(/'/g, "\\'")}', ${isOnline})`}" 
                                 style="display: grid; grid-template-columns: 40px 1fr auto; gap: 0.5rem; padding: 0.6rem; background: ${isMe ? '#1a3a1a' : '#1a1a1a'}; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid ${isMe ? '#4a7a4a' : '#333'}; ${isMe ? '' : 'cursor: pointer;'} transition: transform 0.1s;"
                                 ${isMe ? '' : 'onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'"'}>
                                <div style="font-size: 1.1rem; text-align: center;">${medal}</div>
                                <div>
                                    <div style="color: ${isMe ? '#8bc34a' : '#fff'}; font-weight: ${isMe ? 'bold' : 'normal'};">
                                        ${isOnline ? 'üü¢' : '‚ö´'} ${factionPrefix}${escapeHtml(player.name)} ${isMe ? '(ty)' : ''}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #666;">
                                        Lvl ${player.level || '?'} | ‚öîÔ∏è${player.kills || 0} | üìú${player.quests || 0}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ffd700; font-weight: bold;">${(player.score || 0).toLocaleString()}</div>
                                    <div style="font-size: 0.7rem; color: #666;">${isMe ? '' : 'üëÜ klikni'}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`;
                
                html += `
                    <div style="margin-top: 1rem;">
                        <button class="btn" onclick="submitScore()" style="background: #4CAF50; width: 100%;">üì§ Odeslat sk√≥re</button>
                    </div>
                    <button class="btn" onclick="showScoreInfo()" style="width: 100%; margin-top: 0.5rem; background: #2196f3;">‚ÑπÔ∏è Jak se poƒç√≠t√° sk√≥re?</button>
                    <button class="btn" onclick="showHallOfFame()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #ffd700, #ff9800);">üèõÔ∏è S√≠≈à sl√°vy</button>
                    <p style="text-align: center; color: #888; font-size: 0.8rem; margin-top: 0.5rem;">Jm√©no: <strong style="color: #ffd700;">${getPlayerName()}</strong></p>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zav≈ô√≠t</button>
                `;
                
                showModal('üèÜ ≈Ωeb≈ô√≠ƒçek p≈ôe≈æiv≈°√≠ch', html);
                
            } catch (e) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ≈æeb≈ô√≠ƒçku:', e);
                showModal('üèÜ ≈Ωeb≈ô√≠ƒçek', `
                    <div style="text-align: center; color: #ff6b6b;">
                        <p>Chyba p≈ôi naƒç√≠t√°n√≠ ≈æeb≈ô√≠ƒçku</p>
                        <p style="font-size: 0.8rem; color: #888;">${e.message}</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
            }
        }
        
        // Zobrazen√≠ info o v√Ωpoƒçtu sk√≥re
        function showScoreInfo() {
            // Aktu√°ln√≠ hodnoty hr√°ƒçe
            const level = state.char?.level || 1;
            const kills = state.stats?.kills || 0;
            const daysAlive = state.time?.days || 0;
            const itemsCrafted = state.stats?.itemsCrafted || 0;
            const money = getMoney() || 0;
            const booksRead = state.readBooks?.length || 0;
            const dungeonsCleared = state.stats?.dungeonsCleared || (state.dungeon?.cleared ? Object.keys(state.dungeon.cleared).length : 0);
            const settlers = state.settlement?.settlers?.length || 0;
            const pvpWins = state.stats?.pvpWins || 0;
            
            // V√Ωpoƒçet bod≈Ø za ka≈ædou kategorii
            const scoreBreakdown = [
                { name: 'Level', value: level, multiplier: 1000, points: level * 1000, icon: '‚≠ê' },
                { name: 'Zabit√≠', value: kills, multiplier: 10, points: kills * 10, icon: 'üíÄ' },
                { name: 'Dny p≈ôe≈æit√≠', value: daysAlive, multiplier: 50, points: daysAlive * 50, icon: 'üìÖ' },
                { name: 'Crafting', value: itemsCrafted, multiplier: 5, points: itemsCrafted * 5, icon: 'üî®' },
                { name: 'Pen√≠ze', value: money, multiplier: 1, points: money, icon: 'üí∞' },
                { name: 'Knihy', value: booksRead, multiplier: 200, points: booksRead * 200, icon: 'üìö' },
                { name: 'Dungeony', value: dungeonsCleared, multiplier: 300, points: dungeonsCleared * 300, icon: 'üè∞' },
                { name: 'Osadn√≠ci', value: settlers, multiplier: 100, points: settlers * 100, icon: 'üë•' },
                { name: 'PvP v√Ωhry', value: pvpWins, multiplier: 250, points: pvpWins * 250, icon: '‚öîÔ∏è' }
            ];
            
            const totalScore = scoreBreakdown.reduce((sum, item) => sum + item.points, 0);
            
            let html = `
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; border: 2px solid #ffd700;">
                    <div style="color: #888; font-size: 0.85rem;">Tvoje celkov√© sk√≥re</div>
                    <div style="color: #ffd700; font-size: 2rem; font-weight: bold;">${totalScore.toLocaleString()}</div>
                </div>
                
                <h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">üìä Rozpis bod≈Ø:</h4>
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            `;
            
            scoreBreakdown.forEach(item => {
                const percentage = totalScore > 0 ? Math.round((item.points / totalScore) * 100) : 0;
                html += `
                    <div style="display: grid; grid-template-columns: 30px 1fr auto; gap: 0.5rem; padding: 0.5rem; background: #1a1a1a; border-radius: 6px; margin-bottom: 0.3rem; align-items: center;">
                        <span style="font-size: 1.2rem;">${item.icon}</span>
                        <div>
                            <div style="color: #fff; font-size: 0.9rem;">${item.name}</div>
                            <div style="font-size: 0.7rem; color: #666;">${item.value} √ó ${item.multiplier}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #ffd700; font-weight: bold;">+${item.points.toLocaleString()}</div>
                            <div style="font-size: 0.65rem; color: #888;">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 0.9rem;">üí° Tipy pro zv√Ω≈°en√≠ sk√≥re:</h4>
                    <ul style="margin: 0; padding-left: 1.2rem; color: #888; font-size: 0.8rem; line-height: 1.6;">
                        <li><strong style="color: #ffd700;">Level</strong> d√°v√° nejv√≠c bod≈Ø (1000/lvl)</li>
                        <li>Vyƒçisti <strong style="color: #9c27b0;">dungeony</strong> (300 bod≈Ø)</li>
                        <li>Vyhraj <strong style="color: #f44336;">PvP</strong> souboje (250 bod≈Ø)</li>
                        <li>ƒåti <strong style="color: #2196f3;">knihy</strong> (200 bod≈Ø)</li>
                        <li>Z√≠sk√°vej <strong style="color: #ffd700;">pen√≠ze</strong> (1 bod za 1üí∞)</li>
                    </ul>
                </div>
                
                <button class="btn" onclick="showLeaderboard()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt na ≈æeb≈ô√≠ƒçek</button>
            `;
            
            showModal('‚ÑπÔ∏è V√Ωpoƒçet sk√≥re', html);
        }
        
        // === PROFIL HR√ÅƒåE ===
        
        // Helper funkce pro vol√°n√≠ z leaderboardu
        function showPlayerProfileByName(playerName, isOnline) {
            const playerData = window._leaderboardPlayers?.[playerName] || {};
            showPlayerProfile(playerName, playerData, isOnline);
        }
        
        async function showPlayerProfile(playerName, playerData, isOnline) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const isFriend = friendsList.includes(playerName);
            
            // Z√≠skej hodnocen√≠ hr√°ƒçe
            let rating = { avg: 0, count: 0 };
            try {
                rating = await getSellerRating(playerName);
            } catch (e) {}
            
            // Z√≠skej PvP stats z playerData (je tam u≈æ z leaderboardu)
            const pvpElo = playerData?.pvpElo || 1000;
            const pvpWins = playerData?.pvpWins || 0;
            const pvpLosses = playerData?.pvpLosses || 0;
            const pvpRank = getPvPRank(pvpElo);
            const totalGames = pvpWins + pvpLosses;
            const winRate = totalGames > 0 ? Math.round((pvpWins / totalGames) * 100) : 0;
            
            // Class info
            const classNames = {
                survivor: 'P≈ôe≈æiv≈°√≠', raider: 'N√°jezdn√≠k', scout: 'Zvƒõd', 
                medic: 'Medik', technician: 'Technik', mutant: 'Mutant'
            };
            const className = classNames[playerData?.classId] || 'P≈ôe≈æiv≈°√≠';
            
            let html = `
                <!-- HEADER KARTA -->
                <div style="background: linear-gradient(135deg, ${pvpRank.color}22 0%, #0a0a0a 100%); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid ${pvpRank.color}44; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <div style="font-size: 2.5rem; filter: drop-shadow(0 0 8px ${pvpRank.color});">${pvpRank.icon}</div>
                        <div>
                            <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${escapeHtml(playerName)}</div>
                            <div style="color: ${pvpRank.color}; font-size: 0.8rem; text-transform: uppercase;">${pvpRank.name}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; font-size: 0.85rem;">
                        <span style="color: ${isOnline ? '#4CAF50' : '#666'};">${isOnline ? 'üü¢ Online' : '‚ö´ Offline'}</span>
                        <span style="color: #888;">‚Ä¢</span>
                        <span style="color: #888;">Lvl <span style="color: #ffd700; font-weight: bold;">${playerData?.level || '?'}</span></span>
                        <span style="color: #888;">‚Ä¢</span>
                        <span style="color: #888;">${className}</span>
                    </div>
                </div>
                
                <!-- STATISTIKY - 2 ≈ò√ÅDKY -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-bottom: 1rem;">
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">‚öîÔ∏è</div>
                        <div style="color: #ff6b6b; font-size: 1rem; font-weight: bold;">${playerData?.kills || 0}</div>
                        <div style="color: #555; font-size: 0.65rem;">Zabit√≠</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">üìú</div>
                        <div style="color: #8bc34a; font-size: 1rem; font-weight: bold;">${playerData?.quests || 0}</div>
                        <div style="color: #555; font-size: 0.65rem;">Questy</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">üìÖ</div>
                        <div style="color: #2196f3; font-size: 1rem; font-weight: bold;">${playerData?.days || 0}</div>
                        <div style="color: #555; font-size: 0.65rem;">Dn√≠</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.6rem 0.3rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem;">üèÜ</div>
                        <div style="color: #ffd700; font-size: 1rem; font-weight: bold;">${(playerData?.score || 0).toLocaleString()}</div>
                        <div style="color: #555; font-size: 0.65rem;">Sk√≥re</div>
                    </div>
                </div>
                
                <!-- PVP STATS -->
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #0a0a1a 100%); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem; border: 1px solid #333;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">üéÆ</span>
                            <span style="color: #888; font-size: 0.85rem;">PvP</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="text-align: center;">
                                <div style="color: ${pvpRank.color}; font-size: 1.1rem; font-weight: bold;">${pvpElo}</div>
                                <div style="color: #555; font-size: 0.6rem;">ELO</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #4CAF50; font-weight: bold;">${pvpWins}<span style="color: #666;">W</span></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #f44336; font-weight: bold;">${pvpLosses}<span style="color: #666;">L</span></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #ffd700; font-weight: bold;">${winRate}%</div>
                                <div style="color: #555; font-size: 0.6rem;">Win</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- HODNOCEN√ç OBCHODN√çKA -->
                ${rating.count > 0 ? `
                <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <span style="color: #888; font-size: 0.85rem;">üè™ Hodnocen√≠</span>
                    <div>
                        <span style="color: #ffd700;">${'‚òÖ'.repeat(Math.round(rating.avg))}${'‚òÜ'.repeat(5 - Math.round(rating.avg))}</span>
                        <span style="color: #666; font-size: 0.8rem;">(${rating.count})</span>
                    </div>
                </div>
                ` : ''}
                
                <!-- AKCE -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">`
            
            // Tlaƒç√≠tko zpr√°vy - pro v≈°echny
            html += `
                <button class="btn" onclick="showPrivateChat('${escapeHtml(playerName)}')" style="background: #2196f3; padding: 0.8rem;">
                    üí¨ Zpr√°va
                </button>
            `;
            
            // Tlaƒç√≠tko p≈ô√°telstv√≠
            if (isFriend) {
                html += `
                    <button class="btn" onclick="sendGift('${escapeHtml(playerName)}')" style="background: #ff9800; padding: 0.8rem;">
                        üéÅ D√°rek
                    </button>
                `;
            } else {
                html += `
                    <button class="btn" onclick="sendFriendRequest('${escapeHtml(playerName)}'); closeModal();" style="background: #4CAF50; padding: 0.8rem;">
                        üë• P≈ôidat p≈ô√≠tele
                    </button>
                `;
            }
            
            // Tlaƒç√≠tko PvP v√Ωzvy - pro online hr√°ƒçe
            if (isOnline && playerName !== myName) {
                html += `
                    <button class="btn" onclick="quickChallenge('${escapeHtml(playerName).replace(/'/g, "\\'")}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 0.8rem; grid-column: span 2;">
                        ‚öîÔ∏è Vyzvat na PvP souboj
                    </button>
                `;
            } else if (!isOnline && playerName !== myName) {
                html += `
                    <button class="btn" disabled style="background: #333; padding: 0.8rem; grid-column: span 2; opacity: 0.5;">
                        ‚öîÔ∏è Hr√°ƒç je offline
                    </button>
                `;
            }
            
            // Admin tlaƒç√≠tko pro odmƒõnu
            if (isAdmin()) {
                html += `
                    <button class="btn" onclick="showQuickReward('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.8rem;">
                        üéÅ Odmƒõna
                    </button>
                    <button class="btn" onclick="adminQuickMute('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 0.8rem;">
                        üîá Mute
                    </button>
                    <button class="btn" onclick="adminQuickBan('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 0.8rem; grid-column: span 2;">
                        üö´ Banovat
                    </button>
                `;
            }
            
            html += `
                </div>
                
                <button class="btn" onclick="showLeaderboard()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt na ≈æeb≈ô√≠ƒçek</button>
            `;
            
            showModal(`üë§ Profil: ${escapeHtml(playerName)}`, html);
        }
        
        // Rychl√° v√Ωzva na PvP z profilu
        function quickChallenge(playerName) {
            closeModal();
            showModal('‚öîÔ∏è Vyzvat ' + escapeHtml(playerName), `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚öîÔ∏è</div>
                    <p style="color: #fff; font-size: 1.1rem; margin-bottom: 0.5rem;">Vyzvat <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong> na PvP souboj?</p>
                    <p style="color: #4CAF50; font-size: 0.9rem;">PvP souboj je ZDARMA!</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showLeaderboard()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="createPvPChallenge('${escapeHtml(playerName).replace(/'/g, "\\'")}', 0); closeModal();" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">‚öîÔ∏è Vyzvat!</button>
                </div>
            `);
        }
        
        // === CHAT SYST√âM ===
        function listenToChat() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            chatListener = firebaseDB.ref('chat/messages')
                .orderByChild('timestamp')
                .limitToLast(100)
                .on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    chatMessages = Object.values(data).sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Zkontroluj nov√© zpr√°vy pro notifikaci
                    checkNewChatMessages();
                });
        }
        
        // === CHAT HODNOSTI (podle poƒçtu odeslan√Ωch zpr√°v) ===
        const CHAT_RANKS = [
            { min: 0, name: 'Tich√Ω', nameEn: 'Silent', icon: 'üîá', color: '#666' },
            { min: 1, name: 'Nov√°ƒçek', nameEn: 'Newbie', icon: 'üå±', color: '#8bc34a' },
            { min: 10, name: 'Pov√≠d√°lek', nameEn: 'Talker', icon: 'üí¨', color: '#4caf50' },
            { min: 25, name: 'Spoleƒçn√≠k', nameEn: 'Companion', icon: 'ü§ù', color: '#2196f3' },
            { min: 50, name: 'Veter√°n', nameEn: 'Veteran', icon: '‚≠ê', color: '#ff9800' },
            { min: 100, name: 'Legenda', nameEn: 'Legend', icon: 'üëë', color: '#ffd700' },
            { min: 250, name: 'Hlas pustiny', nameEn: 'Voice of Wasteland', icon: 'üì¢', color: '#e91e63' },
            { min: 500, name: 'Ikona', nameEn: 'Icon', icon: 'üèÜ', color: '#9c27b0' },
            { min: 1000, name: 'Nesmrteln√Ω', nameEn: 'Immortal', icon: 'üíé', color: '#00bcd4' }
        ];
        
        function getChatRank(messageCount) {
            let rank = CHAT_RANKS[0];
            for (const r of CHAT_RANKS) {
                if (messageCount >= r.min) rank = r;
            }
            return rank;
        }
        
        function getChatRankDisplay(messageCount) {
            const rank = getChatRank(messageCount);
            const name = rank.name;
            return `<span style="color: ${rank.color};">${rank.icon} ${name}</span>`;
        }
        
        async function sendChatMessage(text) {
            if (!multiplayerEnabled || !firebaseDB) return;
            if (!text || !text.trim()) return;
            
            // Kontrola mute
            const playerName = getPlayerName();
            try {
                const muteSnap = await firebaseDB.ref('mutedPlayers/' + playerName).once('value');
                const muteData = muteSnap.val();
                if (muteData) {
                    // Zkontroluj jestli mute nevypr≈°el
                    if (muteData.until === 0 || muteData.until > Date.now()) {
                        const untilText = muteData.until ? new Date(muteData.until).toLocaleString('cs') : 'nav≈ædy';
                        notifyWarning('üîá Jsi ztlumen', `Nem≈Ø≈æe≈° ps√°t do chatu do: ${untilText}`);
                        return;
                    } else {
                        // Mute vypr≈°el, odeber ho
                        await firebaseDB.ref('mutedPlayers/' + playerName).remove();
                    }
                }
            } catch(e) {}
            
            // Rate limiting - max 1 zpr√°va za 2 sekundy
            if (!RateLimiter.canProceed('chat_message', 2000)) {
                const remaining = Math.ceil(RateLimiter.getRemaining('chat_message', 2000) / 1000);
                notifyWarning('P≈ô√≠li≈° rychle', `Poƒçkej ${remaining}s p≈ôed dal≈°√≠ zpr√°vou`);
                return;
            }
            
            // Sanitizace textu
            const sanitizedText = escapeHtml(text.trim().substring(0, 200));
            if (!sanitizedText) return;
            
            // Inkrementuj poƒçet odeslan√Ωch zpr√°v
            state.stats = state.stats || {};
            state.stats.chatMessagesSent = (state.stats.chatMessagesSent || 0) + 1;
            
            const rank = getChatRank(state.stats.chatMessagesSent);
            const rankName = rank.name;
            
            const message = {
                author: getPlayerName(),
                text: sanitizedText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                level: state.char?.level || 1,
                msgCount: state.stats.chatMessagesSent,
                rankName: rankName,
                rankColor: rank.color,
                faction: getPlayerFaction() || null  // P≈ôidej frakci do zpr√°vy
            };
            
            try {
                await firebaseDB.ref('chat/messages').push(message);
                
                // Aktualizuj frakƒçn√≠ aktivitu
                updateFactionActivity();
                
                // Ozn√°men√≠ o nov√© hodnosti
                const prevRank = getChatRank(state.stats.chatMessagesSent - 1);
                if (rank.min > prevRank.min) {
                    notifySuccess('üéâ Nov√° chat hodnost!', `${rank.icon} ${rankName}`);
                    addLog(`${rank.icon} Dos√°hl jsi chat hodnosti: ${rankName}`, 'üí¨');
                }
            } catch (e) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ zpr√°v:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se odeslat zpr√°vu');
                // Vra≈• zpƒõt poƒç√≠tadlo
                state.stats.chatMessagesSent = Math.max(0, (state.stats.chatMessagesSent || 1) - 1);
            }
        }
        
        // Menu po kliknut√≠ na hr√°ƒçe v chatu
        function showChatPlayerMenu(playerName, event) {
            if (event) event.stopPropagation();
            
            const myName = getPlayerName();
            if (playerName === myName) return;
            
            const isFriend = friendsList.includes(playerName);
            
            // Vytvo≈ô popup menu
            const existingMenu = document.getElementById('chatPlayerMenu');
            if (existingMenu) existingMenu.remove();
            
            const menu = document.createElement('div');
            menu.id = 'chatPlayerMenu';
            menu.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #2a2a3a, #1a1a2a);
                border: 2px solid #9c27b0;
                border-radius: 12px;
                padding: 1rem;
                z-index: 10001;
                min-width: 200px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            `;
            
            menu.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">üë§</div>
                    <div style="color: #fff; font-weight: bold; font-size: 1.1rem;">${escapeHtml(playerName)}</div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="closeChatPlayerMenu(); replyToPlayer('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: #ff9800; padding: 0.6rem;">
                        ‚Ü©Ô∏è Odpovƒõdƒõt v chatu
                    </button>
                    
                    <button class="btn" onclick="closeChatPlayerMenu(); showPrivateChat('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: #e91e63; padding: 0.6rem;">
                        üí¨ Soukrom√° zpr√°va
                    </button>
                    
                    <button class="btn" onclick="closeChatPlayerMenu(); showPlayerProfileByName('${escapeHtml(playerName).replace(/'/g, "\\'")}', false);" style="background: #2196f3; padding: 0.6rem;">
                        üë§ Zobrazit profil
                    </button>
                    
                    <button class="btn" onclick="closeChatPlayerMenu(); quickChallenge('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 0.6rem;">
                        ‚öîÔ∏è Vyzvat na PvP
                    </button>
                    
                    ${!isFriend ? `
                        <button class="btn" onclick="closeChatPlayerMenu(); sendFriendRequest('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: #4CAF50; padding: 0.6rem;">
                            üë• P≈ôidat do p≈ô√°tel
                        </button>
                    ` : `
                        <div style="text-align: center; color: #8bc34a; font-size: 0.85rem; padding: 0.5rem;">
                            ‚úì Ji≈æ v p≈ô√°tel√≠ch
                        </div>
                    `}
                    
                    ${hasPermission('mute') ? `
                        <button class="btn" onclick="closeChatPlayerMenu(); adminQuickMute('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 0.6rem;">
                            üîá Mute (Staff)
                        </button>
                    ` : ''}
                    
                    ${isAdmin() ? `
                        <div style="border-top: 1px solid #f44336; margin-top: 0.5rem; padding-top: 0.5rem;">
                            <div style="color: #f44336; font-size: 0.7rem; text-align: center; margin-bottom: 0.3rem;">üëë ADMIN</div>
                        </div>
                        <button class="btn" onclick="closeChatPlayerMenu(); showQuickReward('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.6rem;">
                            üéÅ D√°t odmƒõnu
                        </button>
                        <button class="btn" onclick="closeChatPlayerMenu(); showQuickVIPColor('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.6rem;">
                            üé® Zmƒõnit barvu
                        </button>
                        <button class="btn" onclick="closeChatPlayerMenu(); quickAddToStaff('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 0.6rem;">
                            üë• P≈ôidat do Staff
                        </button>
                        <button class="btn" onclick="closeChatPlayerMenu(); adminQuickBan('${escapeHtml(playerName).replace(/'/g, "\\'")}');" style="background: linear-gradient(135deg, #b71c1c 0%, #7f0000 100%); padding: 0.6rem;">
                            üö´ Ban
                        </button>
                    ` : ''}
                    
                    <button class="btn" onclick="closeChatPlayerMenu();" style="background: #555; padding: 0.5rem; font-size: 0.9rem;">
                        ‚úï Zav≈ô√≠t
                    </button>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Zav≈ôi menu kliknut√≠m mimo
            setTimeout(() => {
                document.addEventListener('click', closeChatPlayerMenuOnClickOutside);
            }, 100);
        }
        
        function closeChatPlayerMenu() {
            const menu = document.getElementById('chatPlayerMenu');
            if (menu) menu.remove();
            document.removeEventListener('click', closeChatPlayerMenuOnClickOutside);
        }
        
        function closeChatPlayerMenuOnClickOutside(e) {
            const menu = document.getElementById('chatPlayerMenu');
            if (menu && !menu.contains(e.target)) {
                closeChatPlayerMenu();
            }
        }
        
        function replyToPlayer(playerName) {
            // Najdi chat input a vlo≈æ @nick
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = `@${playerName} ` + chatInput.value;
                chatInput.focus();
                // Nastav kurzor na konec
                chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
            }
        }
        
        // Form√°tov√°n√≠ chat zpr√°vy - barevn√© @nicky
        function formatChatMessage(text, myName) {
            if (!text) return '';
            
            // Nejd≈ô√≠v escapuj HTML
            let formatted = escapeHtml(text);
            
            // Najdi v≈°echny @nicky a obarvi je
            // Regex pro @nick (slovo zaƒç√≠naj√≠c√≠ @)
            formatted = formatted.replace(/@(\w+)/g, (match, nick) => {
                // Pokud je to m≈Øj nick, zv√Ωrazni zelenƒõ
                if (nick.toLowerCase() === myName.toLowerCase()) {
                    return `<span style="color: #4CAF50; font-weight: bold; background: rgba(76,175,80,0.2); padding: 0 3px; border-radius: 3px;">@${nick}</span>`;
                }
                // Ostatn√≠ nicky mod≈ôe
                return `<span style="color: #2196f3; font-weight: bold;">@${nick}</span>`;
            });
            
            return formatted;
        }

        function showChatModal() {
            if (!multiplayerEnabled) {
                showModal('üí¨ Chat', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîå</div>
                        <h3 style="color: #ff9800;">Multiplayer nen√≠ aktivn√≠</h3>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Moje statistiky
            const myMsgCount = state.stats.chatMessagesSent || 0;
            const myRank = getChatRank(myMsgCount);
            const myRankName = myRank.name;
            const nextRank = CHAT_RANKS.find(r => r.min > myMsgCount);
            const progressToNext = nextRank ? Math.min(100, ((myMsgCount - myRank.min) / (nextRank.min - myRank.min)) * 100) : 100;
            
            let messagesHtml = '';
            const myName = getPlayerName();
            
            if (chatMessages.length === 0) {
                messagesHtml = '<div style="text-align: center; padding: 2rem; color: #666;">≈Ω√°dn√© zpr√°vy... Buƒè prvn√≠!</div>';
            } else {
                chatMessages.slice(-50).forEach(msg => {
                    const isMe = msg.author === myName;
                    const isAdmin = msg.author === 'Zaoo';
                    const staffRole = getStaffRole(msg.author);
                    const staffRoleData = staffRole ? STAFF_ROLES[staffRole] : null;
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}) : '';
                    const msgRankName = msg.rankName || 'Tich√Ω';
                    const msgRankColor = msg.rankColor || '#666';
                    
                    // VIP barva
                    const vipColor = getVIPColor(msg.author);
                    const isRainbow = vipColor === 'rainbow';
                    const authorColor = isMe ? '#8bc34a' : staffRoleData ? staffRoleData.color : vipColor || '#aaa';
                    const rainbowStyle = isRainbow ? 'background: linear-gradient(90deg, #ff0000, #ff9800, #ffff00, #00ff00, #00bcd4, #9c27b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;' : '';
                    
                    // Staff badge (Admin/Mod/Helper)
                    const staffBadge = staffRoleData ? `<span style="background: ${staffRoleData.color}; color: #fff; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem; margin-left: 0.3rem;">${staffRoleData.badge}</span>` : '';
                    
                    // VIP badge (pouze pokud nen√≠ staff)
                    const vipBadge = (vipColor && !staffRole) ? '<span style="background: linear-gradient(135deg, #ff9800, #f57c00); color: #fff; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem; margin-left: 0.3rem;">‚≠ê VIP</span>' : '';
                    
                    // Frakce v z√°vorce p≈ôed nickem
                    let factionPrefix = '';
                    if (msg.faction && PVP_FACTIONS[msg.faction]) {
                        const f = PVP_FACTIONS[msg.faction];
                        const factionShort = msg.faction === 'kory' ? 'Koryho frakce' : msg.faction === 'koudy' ? 'Koudyho frakce' : 'Nez√°visl√° frakce';
                        factionPrefix = `<span style="color: ${f.color}; font-size: 0.65rem;">[${factionShort}]</span> `;
                    }
                    
                    // Syst√©mov√© zpr√°vy (tombola apod.)
                    const isSystemMessage = msg.system || msg.author === 'üéüÔ∏è TOMBOLA' || msg.author === 'üéâ TOMBOLA';
                    
                    // Klikateln√© jm√©no pro menu, cel√° zpr√°va pro rychlou odpovƒõƒè
                    let authorHtml;
                    if (isMe) {
                        authorHtml = `${factionPrefix}<span style="color: #8bc34a; font-weight: bold;">‚òÖ Ty</span>${staffBadge}`;
                    } else if (isSystemMessage) {
                        // Syst√©mov√° zpr√°va - klik otev≈ôe tombolu
                        authorHtml = `<span onclick="event.stopPropagation(); showTombola();" style="color: #e91e63; font-weight: bold; cursor: pointer; text-decoration: underline;">${escapeHtml(msg.author)}</span>`;
                    } else {
                        authorHtml = `${factionPrefix}<span onclick="event.stopPropagation(); showChatPlayerMenu('${escapeHtml(msg.author).replace(/'/g, "\\'")}', event)" style="color: ${isRainbow ? '#ff0000' : authorColor}; ${rainbowStyle} font-weight: bold; cursor: pointer; text-decoration: underline; text-decoration-style: dotted;">${escapeHtml(msg.author)}</span>${staffBadge}${vipBadge}`;
                    }
                    
                    // Kliknut√≠ na zpr√°vu (ne na jm√©no) = rychl√° odpovƒõƒè (ne pro syst√©mov√© zpr√°vy)
                    const messageClickHandler = (isMe || isSystemMessage) ? '' : `onclick="replyToPlayer('${escapeHtml(msg.author).replace(/'/g, "\\'")}')" style="cursor: pointer;" title="Klikni pro odpovƒõƒè"`;
                    
                    messagesHtml += `
                        <div style="margin-bottom: 0.5rem; ${isMe ? 'text-align: right;' : ''}">
                            <div ${messageClickHandler} style="display: inline-block; max-width: 80%; background: ${isMe ? '#1a3a1a' : isSystemMessage ? '#2a1a2a' : staffRole ? '#2a1a1a' : '#2a2a2a'}; padding: 0.5rem 0.8rem; border-radius: 12px; ${isMe ? 'border-bottom-right-radius: 4px;' : 'border-bottom-left-radius: 4px;'} ${isSystemMessage ? 'border: 1px solid #e91e63;' : staffRole ? `border: 1px solid ${staffRoleData.color};` : ''} ${!isMe && !isSystemMessage ? 'cursor: pointer; transition: background 0.2s;' : ''}" ${!isMe && !isSystemMessage ? `onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='${staffRole ? '#2a1a1a' : '#2a2a2a'}'"` : ''}>
                                <div style="font-size: 0.7rem; margin-bottom: 0.2rem;">
                                    ${authorHtml}
                                    ${!isSystemMessage ? `<span style="color: ${msgRankColor}; font-size: 0.65rem; margin-left: 0.3rem;">[${msgRankName}]</span>
                                    <span style="color: #555; font-size: 0.65rem;"> Lvl ${escapeHtml(msg.level) || '?'}</span>` : ''}
                                    <span style="color: #444; margin-left: 0.5rem;">${time}</span>
                                </div>
                                <div style="color: ${isSystemMessage ? '#e91e63' : '#ddd'};">${formatChatMessage(msg.text, myName)}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            showModal('üí¨ Chat p≈ôe≈æiv≈°√≠ch', `
                <!-- Moje hodnost -->
                <div style="background: linear-gradient(135deg, #1a1a2a, #0a0a1a); padding: 0.6rem; border-radius: 8px; margin-bottom: 0.8rem; border: 1px solid ${myRank.color}40;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: ${myRank.color}; font-size: 1.2rem;">${myRank.icon}</span>
                            <span style="color: ${myRank.color}; font-weight: bold;">${myRankName}</span>
                            <span style="color: #666; font-size: 0.75rem; margin-left: 0.5rem;">(${myMsgCount} ${'zpr√°v'})</span>
                        </div>
                        ${nextRank ? `<span style="color: #555; font-size: 0.7rem;">${'Dal≈°√≠'}: ${nextRank.icon} ${nextRank.min - myMsgCount}</span>` : '<span style="color: #ffd700; font-size: 0.7rem;">MAX!</span>'}
                    </div>
                    ${nextRank ? `<div style="background: #0a0a0a; height: 4px; border-radius: 2px; margin-top: 0.4rem; overflow: hidden;">
                        <div style="height: 100%; width: ${progressToNext}%; background: ${myRank.color};"></div>
                    </div>` : ''}
                </div>
                
                <div id="chatMessagesContainer" style="max-height: 45vh; min-height: 200px; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; touch-action: pan-y pinch-zoom; background: #0a0a0a; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem; position: relative;">
                    ${messagesHtml}
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="chatInput" placeholder="${'Napi≈° zpr√°vu...'}" maxlength="200"
                        style="flex: 1; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff;"
                        onkeypress="if(event.key==='Enter') sendChatFromInput()">
                    <button class="btn" onclick="sendChatFromInput()" style="background: #4CAF50; padding: 0.6rem 1rem;">üì§</button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${'Zav≈ô√≠t'}</button>
            `);
            
            // Scrollni dol≈Ø
            setTimeout(() => {
                const container = document.getElementById('chatMessagesContainer');
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function sendChatFromInput() {
            const input = document.getElementById('chatInput');
            if (input && input.value.trim()) {
                sendChatMessage(input.value.trim());
                input.value = '';
                // Obnov chat po chv√≠li
                setTimeout(() => showChatModal(), 500);
            }
        }
        
        // === MARKETPLACE (Obchod mezi hr√°ƒçi) ===
        function listenToMarketplace() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            firebaseDB.ref('marketplace/offers').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                marketplaceOffers = Object.entries(data).map(([key, val]) => ({...val, id: key}));
                
                // Kontrola expirovan√Ωch nab√≠dek (3 dny = 72 hodin)
                checkExpiredOffers();
            });
        }
        
        // Kontrola a sta≈æen√≠ nab√≠dek star≈°√≠ch ne≈æ 3 dny
        async function checkExpiredOffers() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const now = Date.now();
            const maxAge = 3 * 24 * 60 * 60 * 1000; // 3 dny v ms
            
            for (const offer of marketplaceOffers) {
                // Kontroluj jen vlastn√≠ nab√≠dky
                if (offer.seller !== myName) continue;
                if (offer.status !== 'active') continue;
                
                const offerAge = now - (offer.timestamp || 0);
                
                if (offerAge > maxAge) {
                    console.log('üì¶ Stahov√°n√≠ expirovan√© nab√≠dky:', offer.item?.name);
                    
                    try {
                        // Vra≈• item do invent√°≈ôe
                        const itemData = offer.item;
                        if (itemData) {
                            // Rekonstruuj item pro invent√°≈ô
                            const returnedItem = {
                                id: itemData.id,
                                name: itemData.name,
                                icon: itemData.icon,
                                type: itemData.type
                            };
                            if (itemData.damage) returnedItem.damage = itemData.damage;
                            if (itemData.defense) returnedItem.defense = itemData.defense;
                            if (itemData.rarity) returnedItem.rarity = itemData.rarity;
                            if (itemData.effect) returnedItem.effect = itemData.effect;
                            if (itemData.value) returnedItem.value = itemData.value;
                            if (itemData.weight) returnedItem.weight = itemData.weight;
                            
                            // Najdi kompletn√≠ definici itemu
                            const fullItem = ITEMS.find(i => i.id === itemData.id) || returnedItem;
                            const count = offer.count || 1;
                            
                            addItemToInventory({...fullItem, ...returnedItem}, count, true);
                            
                            // Sma≈æ nab√≠dku z Firebase
                            await firebaseDB.ref('marketplace/offers/' + offer.id).remove();
                            
                            notifySuccess('üì¶ Nab√≠dka sta≈æena', `${itemData.name} (${count}x) vr√°cen do invent√°≈ôe - uplynuly 3 dny`);
                            
                            // Ulo≈æ hru
                            saveGame(true);
                        }
                    } catch (e) {
                        console.error('Chyba p≈ôi stahov√°n√≠ nab√≠dky:', e);
                    }
                }
            }
        }
        
        async function createMarketOffer(item, price) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Vyfiltruj v≈°echny undefined hodnoty pro Firebase
            // Firebase validace vy≈æaduje damage a defense - p≈ôidej defaulty
            const cleanItem = {
                id: item.id || 'unknown',
                name: item.name || 'P≈ôedmƒõt',
                icon: item.icon || 'üì¶',
                type: item.type || 'misc',
                damage: typeof item.damage === 'number' ? item.damage : 0,
                defense: typeof item.defense === 'number' ? item.defense : 0
            };
            
            // P≈ôidej dal≈°√≠ hodnoty pokud existuj√≠
            if (item.rarity && typeof item.rarity === 'string') cleanItem.rarity = item.rarity;
            if (item.effect && typeof item.effect === 'string') cleanItem.effect = item.effect;
            if (typeof item.value === 'number') cleanItem.value = item.value;
            
            const offer = {
                seller: getPlayerName(),
                item: cleanItem,
                price: price || 100,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'active'
            };
            
            try {
                await firebaseDB.ref('marketplace/offers').push(offer);
                notifySuccess('Nab√≠dka vytvo≈ôena!', `${item.name} za ${price} üí∞`);
            } catch (e) {
                console.error('Chyba p≈ôi vytv√°≈ôen√≠ nab√≠dky:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se vytvo≈ôit nab√≠dku: ' + (e.message || 'Nezn√°m√° chyba'));
            }
        }
        
        // Dialog pro n√°kup s v√Ωbƒõrem poƒçtu
        function promptBuyOffer(offerId, maxCount, pricePerUnit) {
            const offer = marketplaceOffers.find(o => o.id === offerId);
            if (!offer) return;
            
            if (maxCount === 1) {
                // Pokud je jen 1 kus, kup rovnou
                buyMarketOffer(offerId, 1);
                return;
            }
            
            const maxAffordable = Math.floor(state.money / pricePerUnit);
            const maxBuyable = Math.min(maxCount, maxAffordable);
            
            showModal(`üõí Koupit ${escapeHtml(offer.item.name)}`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${escapeHtml(offer.item.icon)}</div>
                    <div style="color: #888; margin-bottom: 0.5rem;">Prod√°v√°: ${escapeHtml(offer.seller)}</div>
                    <div style="color: #ffd700; margin-bottom: 1rem;">Cena: ${pricePerUnit} üí∞/ks</div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="color: #888; font-size: 0.85rem;">Poƒçet kus≈Ø (max ${maxCount}, m≈Ø≈æe≈° si dovolit ${maxAffordable}):</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                            <button class="btn" onclick="adjustBuyCount(-10, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">-10</button>
                            <button class="btn" onclick="adjustBuyCount(-1, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">-</button>
                            <input type="number" id="buyCountInput" value="1" min="1" max="${maxBuyable}"
                                style="width: 60px; padding: 0.5rem; font-size: 1.1rem; background: #1a1a1a; border: 2px solid #4CAF50; border-radius: 8px; color: #4CAF50; text-align: center;"
                                onchange="updateBuyTotal(${pricePerUnit})">
                            <button class="btn" onclick="adjustBuyCount(1, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">+</button>
                            <button class="btn" onclick="adjustBuyCount(10, ${maxBuyable}, ${pricePerUnit})" style="padding: 0.3rem 0.6rem; background: #555;">+10</button>
                        </div>
                        <button class="btn" onclick="document.getElementById('buyCountInput').value=${maxBuyable}; updateBuyTotal(${pricePerUnit});" style="margin-top: 0.3rem; padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">Max (${maxBuyable})</button>
                    </div>
                    
                    <div id="buyTotalDisplay" style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                        <span style="color: #888;">Celkem:</span>
                        <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${pricePerUnit} üí∞</span>
                        <div style="color: #666; font-size: 0.8rem; margin-top: 0.3rem;">Tv√© pen√≠ze: ${state.money} üí∞</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="showMarketplace()" style="background: #555;">‚ùå Zru≈°it</button>
                        <button class="btn" onclick="buyMarketOffer('${escapeHtml(offerId)}', parseInt(document.getElementById('buyCountInput').value))" style="background: #4CAF50;">‚úì Koupit</button>
                    </div>
                </div>
            `);
        }
        
        function adjustBuyCount(delta, max, pricePerUnit) {
            const input = document.getElementById('buyCountInput');
            if (!input) return;
            const newVal = Math.max(1, Math.min(max, parseInt(input.value || 1) + delta));
            input.value = newVal;
            updateBuyTotal(pricePerUnit);
        }
        
        function updateBuyTotal(pricePerUnit) {
            const countInput = document.getElementById('buyCountInput');
            const display = document.getElementById('buyTotalDisplay');
            if (!countInput || !display) return;
            
            const count = parseInt(countInput.value) || 1;
            // Get price from parent scope or recalculate
            const price = pricePerUnit || parseInt(document.querySelector('[data-price]')?.dataset.price) || 0;
            const total = count * price;
            
            display.innerHTML = `
                <span style="color: #888;">${count}x ${price} = </span>
                <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${total} üí∞</span>
                <div style="color: ${state.money >= total ? '#666' : '#f44336'}; font-size: 0.8rem; margin-top: 0.3rem;">Tv√© pen√≠ze: ${state.money} üí∞ ${state.money < total ? '(nedostatek!)' : ''}</div>
            `;
        }
        
        async function buyMarketOffer(offerId, buyCount = 1) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const offer = marketplaceOffers.find(o => o.id === offerId);
            if (!offer) return;
            
            if (offer.seller === getPlayerName()) {
                notifyWarning('Nelze koupit', 'Nem≈Ø≈æe≈° koupit vlastn√≠ nab√≠dku!');
                return;
            }
            
            // Kontrola unique item≈Ø
            const itemDef = ITEMS.find(i => i.id === offer.item?.id);
            if (itemDef?.unique) {
                const alreadyHas = state.inv.some(i => i.id === offer.item.id);
                if (alreadyHas) {
                    notifyWarning('U≈æ m√°≈° ' + (offer.item.name || itemDef.name), 'M≈Ø≈æe≈° m√≠t pouze jeden');
                    return;
                }
            }
            
            const offerCount = offer.count || 1;
            const actualBuyCount = Math.min(buyCount, offerCount);
            const totalPrice = offer.price * actualBuyCount;
            
            // üí∞ POPLATEK Z PRODEJE - 5% jde jako da≈à
            const MARKET_FEE_PERCENT = 5;
            const marketFee = Math.max(1, Math.floor(totalPrice * MARKET_FEE_PERCENT / 100));
            const sellerReceives = totalPrice - marketFee;
            
            if (getMoney() < totalPrice) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot≈ôebuje≈° ${totalPrice} üí∞`);
                return;
            }
            
            try {
                const remainingCount = offerCount - actualBuyCount;
                
                if (remainingCount <= 0) {
                    // Koupeno v≈°e - oznaƒç jako prodan√©
                    await firebaseDB.ref('marketplace/offers/' + offerId).update({
                        status: 'sold',
                        buyer: getPlayerName(),
                        soldAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // Zb√Ωv√° nƒõco - aktualizuj poƒçet
                    await firebaseDB.ref('marketplace/offers/' + offerId).update({
                        count: remainingCount,
                        totalPrice: offer.price * remainingCount,
                        'item/count': remainingCount
                    });
                }
                
                // Odeƒçti pen√≠ze KUPUJ√çC√çMU (spr√°vnƒõ p≈ôes funkci)
                removeMoney(totalPrice);
                
                // P≈ôidej item do invent√°≈ôe - pou≈æij actualBuyCount jako druh√Ω parametr
                const newItem = {
                    ...offer.item
                };
                // OPRAVA: Pou≈æij actualBuyCount jako druh√Ω parametr pro spr√°vn√Ω poƒçet
                addItemToInventory(newItem, actualBuyCount, true);
                
                // Ozn√°men√≠ prodejci + P≈òIƒåTEN√ç PENƒöZ (PO ODEƒåTEN√ç POPLATKU)
                // Ulo≈æ√≠me pen√≠ze pro prodejce do Firebase - ten si je vyzvedne p≈ôi kontrole notifikac√≠
                const sellerPathKey = sanitizeFirebasePath(offer.seller);
                await firebaseDB.ref('marketplace/notifications/' + sellerPathKey).push({
                    type: 'sold',
                    item: offer.item.name,
                    count: actualBuyCount,
                    price: totalPrice,
                    fee: marketFee,
                    received: sellerReceives,
                    buyer: getPlayerName(),
                    moneyToAdd: sellerReceives,  // Pen√≠ze k p≈ôiƒçten√≠ prodejci (PO POPLATKU)
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Z√°znam do historie obchod≈Ø - kupuj√≠c√≠
                const buyerPathKey = sanitizeFirebasePath(getPlayerName());
                await firebaseDB.ref('tradeHistory/' + buyerPathKey).push({
                    type: 'buy',
                    itemName: offer.item.name,
                    itemIcon: offer.item.icon,
                    count: actualBuyCount,
                    price: totalPrice,
                    otherPlayer: offer.seller,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Z√°znam do historie obchod≈Ø - prodejce
                await firebaseDB.ref('tradeHistory/' + sellerPathKey).push({
                    type: 'sell',
                    itemName: offer.item.name,
                    itemIcon: offer.item.icon,
                    count: actualBuyCount,
                    price: totalPrice,
                    fee: marketFee,
                    received: sellerReceives,
                    otherPlayer: getPlayerName(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // VE≈òEJN√Å HISTORIE - viditeln√° pro v≈°echny
                await firebaseDB.ref('publicTradeHistory').push({
                    itemName: offer.item.name,
                    itemIcon: offer.item.icon,
                    itemId: offer.item.id,
                    count: actualBuyCount,
                    price: totalPrice,
                    fee: marketFee,
                    pricePerUnit: offer.price,
                    seller: offer.seller,
                    buyer: getPlayerName(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                notifySuccess('Koupeno!', `${actualBuyCount}x ${offer.item.name} za ${totalPrice} üí∞`);
                saveGame();
                
                // Zachovej scroll pozici
                const marketContent = document.getElementById('marketplaceOffersContainer');
                const scrollPos = marketContent ? marketContent.scrollTop : 0;
                
                await showMarketplace();
                
                // Obnov scroll pozici
                setTimeout(() => {
                    const newMarketContent = document.getElementById('marketplaceOffersContainer');
                    if (newMarketContent) newMarketContent.scrollTop = scrollPos;
                }, 100);
                
            } catch (e) {
                console.error('Chyba p≈ôi n√°kupu:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se koupit');
            }
        }
        
        async function cancelMarketOffer(offerId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                // Najdi nab√≠dku abychom mohli vr√°tit item
                const offer = marketplaceOffers.find(o => o.id === offerId);
                
                if (offer && offer.item) {
                    // Vra≈• p≈ôedmƒõt do invent√°≈ôe
                    const count = offer.count || 1;
                    const existingItem = state.inv.find(i => i.id === offer.item.id);
                    
                    if (existingItem && (existingItem.type === 'consumable' || existingItem.type === 'resource' || existingItem.type === 'ammo')) {
                        // Stackovateln√© - p≈ôidej k existuj√≠c√≠mu
                        existingItem.count = (existingItem.count || 1) + count;
                    } else {
                        // P≈ôidej jako nov√Ω item (nebo pro ka≈æd√Ω kus zvl√°≈°≈•)
                        for (let i = 0; i < count; i++) {
                            state.inv.push({...offer.item, count: 1});
                        }
                    }
                    
                    addLog(`üì¶ Vr√°ceno z tr≈æi≈°tƒõ: ${offer.item.icon} ${offer.item.name}${count > 1 ? ' (' + count + 'x)' : ''}`, 'üè™');
                }
                
                // Sma≈æ nab√≠dku z Firebase
                await firebaseDB.ref('marketplace/offers/' + offerId).remove();
                notifySuccess('Nab√≠dka zru≈°ena', 'P≈ôedmƒõt vr√°cen do invent√°≈ôe');
                showMarketplace();
                renderFull();
            } catch (e) {
                console.error('Chyba:', e);
                notifyWarning('Chyba p≈ôi ru≈°en√≠ nab√≠dky');
            }
        }
        
        async function showMarketplace(filterType = 'all', searchText = '') {
            if (!multiplayerEnabled) {
                showModal('üè™ Tr≈æi≈°tƒõ', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîå</div>
                        <h3 style="color: #ff9800;">Multiplayer nen√≠ aktivn√≠</h3>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            // Ulo≈æit aktu√°ln√≠ filtry
            window._marketFilter = filterType;
            window._marketSearch = searchText;
            
            // Automaticky vybrat pen√≠ze z prodej≈Ø
            await autoCollectMarketEarnings();
            
            const myName = getPlayerName();
            const activeOffers = marketplaceOffers.filter(o => o.status === 'active');
            const myOffers = activeOffers.filter(o => o.seller === myName);
            let otherOffers = activeOffers.filter(o => o.seller !== myName);
            
            // Aplikuj filtr typu
            // Aplikuj filtr typu
            if (filterType === 'armor') {
                otherOffers = otherOffers.filter(o => ['armor', 'helmet', 'gloves', 'boots'].includes(o.item.type));
            } else if (filterType === 'other') {
                otherOffers = otherOffers.filter(o => !['weapon', 'armor', 'helmet', 'gloves', 'boots', 'consumable'].includes(o.item.type));
            } else if (filterType !== 'all') {
                otherOffers = otherOffers.filter(o => o.item.type === filterType);
            }
            
            // Aplikuj textov√Ω filtr
            if (searchText.trim()) {
                const search = searchText.toLowerCase().trim();
                otherOffers = otherOffers.filter(o => 
                    o.item.name?.toLowerCase().includes(search) || 
                    o.seller?.toLowerCase().includes(search) ||
                    o.item.special?.toLowerCase().includes(search)
                );
            }
            
            // Poƒçet nab√≠dek podle typu (pro zobrazen√≠ v tlaƒç√≠tk√°ch)
            const allCount = activeOffers.filter(o => o.seller !== myName).length;
            const weaponCount = activeOffers.filter(o => o.seller !== myName && o.item.type === 'weapon').length;
            const armorCount = activeOffers.filter(o => o.seller !== myName && ['armor', 'helmet', 'gloves', 'boots'].includes(o.item.type)).length;
            const consumableCount = activeOffers.filter(o => o.seller !== myName && o.item.type === 'consumable').length;
            const otherCount = activeOffers.filter(o => o.seller !== myName && !['weapon', 'armor', 'helmet', 'gloves', 'boots', 'consumable'].includes(o.item.type)).length;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Tv√© pen√≠ze</div>
                        <div style="color: #ffd700; font-size: 1.2rem; font-weight: bold;">üí∞ ${state.money}</div>
                    </div>
                    <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #888; font-size: 0.8rem;">Tv√© nab√≠dky</div>
                        <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${myOffers.length}</div>
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('marketHoursInfo').style.display = document.getElementById('marketHoursInfo').style.display === 'none' ? 'block' : 'none'">
                        <span style="color: #888; font-size: 0.75rem;">üïê Otev√≠rac√≠ doby NPC obchod≈Ø ‚ñº</span>
                        <span style="color: #666; font-size: 0.7rem;">${new Date().getHours().toString().padStart(2,'0')}:${new Date().getMinutes().toString().padStart(2,'0')}</span>
                    </div>
                    <div id="marketHoursInfo" style="display: none; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #333; font-size: 0.7rem;">
                        <div style="display: grid; gap: 0.2rem;">
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('settlement') ? '#8bc34a' : '#666'};">üõí Osada <span>06-22</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('caravan') ? '#8bc34a' : '#666'};">üê™ Karavana <span>08-20</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('military') ? '#8bc34a' : '#666'};">üéñÔ∏è Vojensk√Ω <span>06-18</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('mutants') ? '#8bc34a' : '#666'};">‚ò£Ô∏è Mutanti <span>20-06üåô</span></div>
                            <div style="display: flex; justify-content: space-between; color: #8bc34a;">üß™ Laborato≈ô <span>non-stop</span></div>
                            <div style="display: flex; justify-content: space-between; color: ${isShopOpen('wandering') ? '#8bc34a' : '#666'};">üê™ Potuln√Ω <span>10-16</span></div>
                        </div>
                        <p style="color: #4caf50; font-size: 0.65rem; margin: 0.3rem 0 0 0; text-align: center;">‚úì Online tr≈æi≈°tƒõ je otev≈ôen√© 24/7!</p>
                    </div>
                </div>
                
                <div style="background: #2a1a1a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid #f44336; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1rem;">üèõÔ∏è</span>
                    <span style="color: #ff6b6b; font-size: 0.75rem;">Poplatek z prodeje: <strong>5%</strong> (strh√°v√° se prodejci)</span>
                </div>
                
                <div style="background: #1a2a2a; padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #2196f3; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1rem;">‚öñÔ∏è</span>
                    <span style="color: #64b5f6; font-size: 0.75rem;">V√°ha vystaven√Ωch vƒõc√≠ se poƒç√≠t√° do nosnosti dokud se neprodaj√≠</span>
                </div>
                
                <!-- FILTR -->
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="display: flex; gap: 0.3rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                        <button class="btn" onclick="showMarketplace('all', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'all' ? '#4CAF50' : '#333'};">V≈°e (${allCount})</button>
                        <button class="btn" onclick="showMarketplace('weapon', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'weapon' ? '#f44336' : '#333'};">‚öîÔ∏è (${weaponCount})</button>
                        <button class="btn" onclick="showMarketplace('armor', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'armor' ? '#2196f3' : '#333'};">üõ°Ô∏è (${armorCount})</button>
                        <button class="btn" onclick="showMarketplace('consumable', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'consumable' ? '#8bc34a' : '#333'};">üíä (${consumableCount})</button>
                        <button class="btn" onclick="showMarketplace('other', '${escapeHtml(searchText)}')" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: ${filterType === 'other' ? '#ff9800' : '#333'};">üì¶ (${otherCount})</button>
                    </div>
                    <input type="text" id="marketSearchInput" value="${escapeHtml(searchText)}" placeholder="üîç Hledat n√°zev, prodejce..." 
                        style="width: 100%; padding: 0.5rem; border-radius: 6px; background: #2a2a2a; border: 1px solid #444; color: #fff; font-size: 0.85rem;"
                        onkeyup="if(event.key==='Enter')showMarketplace('${filterType}', this.value)"
                        oninput="clearTimeout(window._marketSearchTimeout); window._marketSearchTimeout = setTimeout(() => showMarketplace('${filterType}', this.value), 500)">
                </div>
            `;
            
            // Moje nab√≠dky
            if (myOffers.length > 0) {
                html += `<div style="margin-bottom: 1rem;"><h4 style="color: #8bc34a; margin-bottom: 0.5rem;">üì¶ Tv√© nab√≠dky:</h4>`;
                myOffers.forEach(offer => {
                    const count = offer.count || 1;
                    const totalPrice = offer.totalPrice || offer.price;
                    
                    // V√Ωpoƒçet zb√Ωvaj√≠c√≠ho ƒçasu (3 dny max)
                    const maxAge = 3 * 24 * 60 * 60 * 1000;
                    const offerAge = Date.now() - (offer.timestamp || Date.now());
                    const remaining = maxAge - offerAge;
                    const hoursLeft = Math.max(0, Math.floor(remaining / (60 * 60 * 1000)));
                    const daysLeft = Math.floor(hoursLeft / 24);
                    const hoursRem = hoursLeft % 24;
                    
                    const timeColor = hoursLeft < 24 ? '#f44336' : hoursLeft < 48 ? '#ff9800' : '#8bc34a';
                    const timeText = daysLeft > 0 ? `${daysLeft}d ${hoursRem}h` : `${hoursLeft}h`;
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a3a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="font-size: 1.5rem;">${escapeHtml(offer.item.icon)}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff;">${escapeHtml(offer.item.name)} ${count > 1 ? `<span style="color: #8bc34a;">(${count}x)</span>` : ''}</div>
                                <div style="color: #ffd700; font-size: 0.85rem;">${totalPrice} üí∞ ${count > 1 ? `(${offer.price}/ks)` : ''}</div>
                                <div style="color: ${timeColor}; font-size: 0.7rem;">‚è±Ô∏è Zb√Ωv√°: ${timeText}</div>
                            </div>
                            <button class="btn" onclick="cancelMarketOffer('${escapeHtml(offer.id)}')" style="background: #c62828; padding: 0.3rem 0.6rem; font-size: 0.8rem;">‚ùå</button>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Nab√≠dky ostatn√≠ch
            html += `<h4 style="color: #2196f3; margin-bottom: 0.5rem;">üõí K prodeji (${otherOffers.length}):</h4>`;
            
            if (otherOffers.length === 0) {
                html += `<div style="text-align: center; padding: 1rem; color: #666;">≈Ω√°dn√© nab√≠dky...</div>`;
            } else {
                html += `<div style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                otherOffers.forEach(offer => {
                    const totalPrice = offer.totalPrice || offer.price;
                    const count = offer.count || 1;
                    const canBuy = state.money >= totalPrice;
                    const rarityColor = offer.item.rarity === 'legendary' ? '#ffd700' : offer.item.rarity === 'epic' ? '#9c27b0' : offer.item.rarity === 'rare' ? '#2196f3' : '#888';
                    
                    // Detailn√≠ info pro tooltip/proklik
                    const itemType = offer.item.type || 'misc';
                    const specialInfo = offer.item.special ? `‚ú® ${offer.item.special}` : '';
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${rarityColor};">
                            <span onclick="showMarketItemDetail('${escapeHtml(offer.id)}')" style="font-size: 1.8rem; cursor: pointer;" title="Klikni pro detail">${escapeHtml(offer.item.icon)}</span>
                            <div onclick="showMarketItemDetail('${escapeHtml(offer.id)}')" style="flex: 1; cursor: pointer;" title="Klikni pro detail">
                                <div style="color: #fff;">${escapeHtml(offer.item.name)} ${count > 1 ? `<span style="color: #8bc34a;">(${count}x)</span>` : ''}</div>
                                <div style="font-size: 0.75rem; color: #888;">
                                    ${offer.item.damage ? '‚öîÔ∏è' + escapeHtml(offer.item.damage) : ''} ${offer.item.defense ? 'üõ°Ô∏è' + escapeHtml(offer.item.defense) : ''} ${specialInfo}
                                    ‚Ä¢ ${escapeHtml(offer.seller)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #ffd700; font-weight: bold;">${totalPrice} üí∞</div>
                                ${count > 1 ? `<div style="color: #888; font-size: 0.7rem;">(${offer.price}/ks)</div>` : ''}
                                <button class="btn" onclick="promptBuyOffer('${escapeHtml(offer.id)}', ${count}, ${offer.price})" style="background: ${canBuy ? '#4CAF50' : '#555'}; padding: 0.2rem 0.5rem; font-size: 0.75rem;" ${!canBuy ? 'disabled' : ''}>
                                    ${canBuy ? 'üõí Koupit' : '‚ùå M√°lo üí∞'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showSellToMarketplace()" style="background: #ff9800;">‚ûï Prodat</button>
                    <button class="btn" onclick="checkMarketNotifications()" style="background: #2196f3;">üì¨ Ozn√°men√≠</button>
                    <button class="btn" onclick="showTradeHistory()" style="background: #607d8b;">üìä Historie</button>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zav≈ô√≠t</button>
            `;
            
            showModal('üè™ Tr≈æi≈°tƒõ p≈ôe≈æiv≈°√≠ch', html);
        }
        
        // Detail itemu na tr≈æi≈°ti
        function showMarketItemDetail(offerId) {
            const offer = marketplaceOffers.find(o => o.id === offerId);
            if (!offer) return;
            
            const item = offer.item;
            const rarityColor = item.rarity === 'legendary' ? '#ffd700' : item.rarity === 'epic' ? '#9c27b0' : item.rarity === 'rare' ? '#2196f3' : item.rarity === 'uncommon' ? '#4caf50' : '#888';
            const rarityName = item.rarity === 'legendary' ? 'Legend√°rn√≠' : item.rarity === 'epic' ? 'Epick√Ω' : item.rarity === 'rare' ? 'Vz√°cn√Ω' : item.rarity === 'uncommon' ? 'Neobvykl√Ω' : 'Bƒõ≈æn√Ω';
            const count = offer.count || 1;
            const totalPrice = offer.totalPrice || offer.price;
            const canBuy = state.money >= totalPrice;
            
            // Najdi kompletn√≠ definici itemu pro desc
            const fullItem = ITEMS.find(i => i.id === item.id);
            const itemDesc = fullItem?.desc || item.desc || '';
            
            // Speci√°ln√≠ efekt s klikateln√Ωm odkazem
            let specialHtml = '';
            if (item.special) {
                const detail = SPECIAL_EFFECT_DETAILS[item.special];
                if (detail) {
                    specialHtml = `
                        <div onclick="showSpecialEffectDetail('${item.special}')" style="background: ${detail.color}22; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0; cursor: pointer; border: 1px solid ${detail.color};">
                            <span style="color: ${detail.color};">‚ú® ${detail.name}</span>
                            <span style="color: #888; font-size: 0.8rem;"> (klikni pro detail)</span>
                        </div>
                    `;
                } else {
                    specialHtml = `<p style="color: #9c27b0;">‚ú® ${item.special}</p>`;
                }
            }
            
            showModal(`${item.icon} ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">${item.icon}</div>
                    <h3 style="margin: 0; color: ${rarityColor};">${item.name}</h3>
                    <p style="color: ${rarityColor}; font-size: 0.8rem; margin: 0.3rem 0;">${rarityName}</p>
                    ${itemDesc ? `<p style="color: #888; font-size: 0.85rem; font-style: italic;">"${itemDesc}"</p>` : ''}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #8bc34a;">üìä Statistiky:</h4>
                    ${item.damage ? `<div style="padding: 0.2rem 0;">‚öîÔ∏è √ötok: <span style="color: #f44336;">+${item.damage}</span></div>` : ''}
                    ${item.defense ? `<div style="padding: 0.2rem 0;">üõ°Ô∏è Obrana: <span style="color: #2196f3;">+${item.defense}</span></div>` : ''}
                    ${item.effect ? `<div style="padding: 0.2rem 0;">üíä Efekt: <span style="color: #4caf50;">${item.effect}</span></div>` : ''}
                    ${item.type ? `<div style="padding: 0.2rem 0;">üì¶ Typ: <span style="color: #888;">${item.type}</span></div>` : ''}
                    ${specialHtml}
                </div>
                
                <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Prod√°v√°:</span>
                        <span style="color: #2196f3;">${escapeHtml(offer.seller)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Poƒçet:</span>
                        <span style="color: #8bc34a;">${count}x</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.1rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #444;">
                        <span>Cena:</span>
                        <span style="color: #ffd700; font-weight: bold;">${totalPrice} üí∞</span>
                    </div>
                    ${count > 1 ? `<div style="text-align: right; font-size: 0.8rem; color: #888;">(${offer.price} üí∞/ks)</div>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="showMarketplace()" style="background: #555;">‚Üê Zpƒõt</button>
                    <button class="btn" onclick="promptBuyOffer('${offerId}', ${count}, ${offer.price})" style="background: ${canBuy ? '#4CAF50' : '#555'};" ${!canBuy ? 'disabled' : ''}>
                        ${canBuy ? 'üõí Koupit' : '‚ùå M√°lo üí∞'}
                    </button>
                </div>
            `);
        }
        
        function showSellToMarketplace() {
            // Na online tr≈æi≈°ti lze prodat V≈†ECHNO (vƒçetnƒõ fromShop, fromCaravan, crafted)
            const sellableItems = state.inv.filter(i => {
                const validTypes = ['weapon', 'armor', 'helmet', 'gloves', 'boots', 'consumable', 'tool', 'component', 'ammo', 'material'];
                if (!validTypes.includes(i.type)) return false;
                if (isItemEquipped(i)) return false;
                // Z√≠skej cenu
                const itemDef = ITEMS.find(it => it.id === i.id);
                const hasPrice = (i.price && i.price > 0) || (itemDef?.price && itemDef.price > 0);
                return hasPrice;
            });
            
            if (sellableItems.length === 0) {
                showModal('Prodat na tr≈æi≈°ti', `
                    <div style="text-align: center; padding: 1rem; color: #888;">
                        Nem√°≈° nic k prodeji!
                    </div>
                    <button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê ${'Zpƒõt'}</button>
                `);
                return;
            }
            
            let html = `<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
            
            sellableItems.forEach((item) => {
                const realIdx = state.inv.indexOf(item);
                const count = item.count || 1;
                // Z√≠skej cenu z itemu nebo z ITEMS definice
                const itemDef = ITEMS.find(i => i.id === item.id);
                const basePrice = item.price || itemDef?.price || item.value || 50;
                const suggestedPrice = Math.floor(basePrice * 0.8);
                const isStackable = count > 1;
                
                // Popis podle typu
                let desc = '';
                if (item.damage) desc += `‚öîÔ∏è${item.damage} `;
                if (item.defense) desc += `üõ°Ô∏è${item.defense} `;
                if (item.effect) desc += `üíä${item.effect} `;
                if (item.value && item.type === 'consumable') desc += `+${item.value} `;
                
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.5rem;">${item.icon}</span>
                        <div style="flex: 1;">
                            <div style="color: #fff;">
                                ${item.name}
                                ${isStackable ? `<span style="color: #ffd700; font-weight: bold;"> √ó${count}</span>` : ''}
                            </div>
                            <div style="font-size: 0.75rem; color: #888;">${desc || item.type}</div>
                        </div>
                        <button class="btn" onclick="promptSellPrice(${realIdx}, ${suggestedPrice}, ${count})" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">${'üí∞ Prodat'}</button>
                    </div>
                `;
            });
            
            html += `</div>
                <button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê ${'Zpƒõt'}</button>
            `;
            
            showModal('‚ûï Vyber item k prodeji', html);
        }
        
        function promptSellPrice(invIndex, suggestedPrice, maxCount = 1) {
            const item = state.inv[invIndex];
            if (!item) return;
            
            const count = item.count || 1;
            
            showModal(`üí∞ Prodat ${item.name}`, `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${item.icon}</div>
                    
                    ${count > 1 ? `
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #888; font-size: 0.85rem;">Poƒçet kus≈Ø (max ${count}):</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                                <button class="btn" onclick="adjustSellCount(-10)" style="padding: 0.3rem 0.6rem; background: #555;">-10</button>
                                <button class="btn" onclick="adjustSellCount(-1)" style="padding: 0.3rem 0.6rem; background: #555;">-</button>
                                <input type="number" id="sellCountInput" value="1" min="1" max="${count}"
                                    style="width: 60px; padding: 0.5rem; font-size: 1.1rem; background: #1a1a1a; border: 2px solid #8bc34a; border-radius: 8px; color: #8bc34a; text-align: center;"
                                    onchange="updateSellTotal(${suggestedPrice})">
                                <button class="btn" onclick="adjustSellCount(1)" style="padding: 0.3rem 0.6rem; background: #555;">+</button>
                                <button class="btn" onclick="adjustSellCount(10)" style="padding: 0.3rem 0.6rem; background: #555;">+10</button>
                            </div>
                            <button class="btn" onclick="document.getElementById('sellCountInput').value=${count}; updateSellTotal(${suggestedPrice});" style="margin-top: 0.3rem; padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #333;">V≈°e (${count})</button>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="color: #888; font-size: 0.85rem;">Cena za kus:</label>
                        <input type="number" id="sellPriceInput" value="${suggestedPrice}" min="1" max="99999"
                            style="width: 100%; padding: 0.8rem; font-size: 1.3rem; background: #1a1a1a; border: 2px solid #ffd700; border-radius: 8px; color: #ffd700; text-align: center; margin-top: 0.3rem;"
                            onchange="updateSellTotal(${suggestedPrice})">
                    </div>
                    
                    <div id="sellTotalDisplay" style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4CAF50;">
                        <span style="color: #888;">Celkem:</span>
                        <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${suggestedPrice} üí∞</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="showSellToMarketplace()" style="background: #555;">‚ùå Zru≈°it</button>
                        <button class="btn" onclick="confirmSellToMarket(${invIndex})" style="background: #4CAF50;">‚úì Prodat</button>
                    </div>
                </div>
            `);
        }
        
        function adjustSellCount(delta) {
            const input = document.getElementById('sellCountInput');
            if (!input) return;
            const max = parseInt(input.max) || 1;
            const newVal = Math.max(1, Math.min(max, parseInt(input.value || 1) + delta));
            input.value = newVal;
            updateSellTotal();
        }
        
        function updateSellTotal() {
            const countInput = document.getElementById('sellCountInput');
            const priceInput = document.getElementById('sellPriceInput');
            const display = document.getElementById('sellTotalDisplay');
            if (!priceInput || !display) return;
            
            const count = parseInt(countInput?.value) || 1;
            const price = parseInt(priceInput.value) || 0;
            const total = count * price;
            
            display.innerHTML = `
                <span style="color: #888;">${count > 1 ? `${count}x ${price} = ` : 'Celkem:'}</span>
                <span style="color: #4CAF50; font-size: 1.3rem; font-weight: bold;"> ${total} üí∞</span>
            `;
        }
        
        async function confirmSellToMarket(invIndex) {
            // Kontrola ≈æe je multiplayer aktivn√≠
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Offline', 'Tr≈æi≈°tƒõ nen√≠ dostupn√© - multiplayer nen√≠ p≈ôipojen');
                return;
            }
            
            const priceInput = document.getElementById('sellPriceInput');
            const countInput = document.getElementById('sellCountInput');
            const price = parseInt(priceInput?.value) || 0;
            const count = parseInt(countInput?.value) || 1;
            
            if (price < 1) {
                notifyWarning('Neplatn√° cena', 'Mus√≠ b√Ωt alespo≈à 1 üí∞');
                return;
            }
            
            const item = state.inv[invIndex];
            if (!item) {
                notifyWarning('Chyba', 'Item nenalezen v invent√°≈ôi');
                return;
            }
            
            // D≈ÆLE≈ΩIT√â: Odeber z invent√°≈ôe IHNED p≈ôed Firebase operac√≠
            // T√≠m zabr√°n√≠me duplikaci pokud hr√°ƒç zav≈ôe okno
            const availableCount = item.count || 1;
            const sellCount = Math.min(count, availableCount);
            
            // Odeber z invent√°≈ôe P≈òED vytvo≈ôen√≠m nab√≠dky
            const itemCopy = JSON.parse(JSON.stringify(item)); // Deep copy pro nab√≠dku
            const removeSuccess = removeItemFromInventory(item, sellCount);
            
            if (!removeSuccess) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se odebrat item z invent√°≈ôe');
                return;
            }
            
            // Ulo≈æ√≠me hru ihned po odebr√°n√≠
            saveGame();
            
            // Vytvo≈ô kopii itemu pro nab√≠dku
            const itemForOffer = {
                id: itemCopy.id || 'unknown',
                name: itemCopy.name || 'P≈ôedmƒõt',
                icon: itemCopy.icon || 'üì¶',
                type: itemCopy.type || 'misc',
                damage: typeof itemCopy.damage === 'number' ? itemCopy.damage : 0,
                defense: typeof itemCopy.defense === 'number' ? itemCopy.defense : 0,
                count: sellCount
            };
            
            // P≈ôidej dal≈°√≠ hodnoty pokud existuj√≠
            if (itemCopy.rarity && typeof itemCopy.rarity === 'string') itemForOffer.rarity = itemCopy.rarity;
            if (itemCopy.effect && typeof itemCopy.effect === 'string') itemForOffer.effect = itemCopy.effect;
            if (typeof itemCopy.value === 'number') itemForOffer.value = itemCopy.value;
            
            const totalPrice = price * sellCount;
            
            try {
                // Vytvo≈ô nab√≠dku
                const offer = {
                    seller: getPlayerName(),
                    item: itemForOffer,
                    price: price,
                    totalPrice: totalPrice,
                    count: sellCount,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active'
                };
                
                await firebaseDB.ref('marketplace/offers').push(offer);
                notifySuccess('Nab√≠dka vytvo≈ôena!', `${sellCount}x ${itemCopy.name} za ${totalPrice} üí∞`);
                
                renderFull();
                showMarketplace();
                
            } catch (e) {
                console.error('Chyba p≈ôi vytv√°≈ôen√≠ nab√≠dky:', e);
                // D≈ÆLE≈ΩIT√â: Vr√°tit item zpƒõt do invent√°≈ôe pokud Firebase sel≈æe
                addItemToInventory(itemCopy, sellCount, true);
                saveGame();
                notifyWarning('Chyba', ('Nepoda≈ôilo se vytvo≈ôit nab√≠dku: ') + (e.message || 'Nezn√°m√° chyba'));
            }
        }
        
        async function checkMarketNotifications() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                const snapshot = await firebaseDB.ref('marketplace/notifications/' + myName).once('value');
                const notifications = snapshot.val() || {};
                const notifList = Object.entries(notifications).map(([key, val]) => ({...val, id: key}));
                
                if (notifList.length === 0) {
                    showModal('üì¨ Ozn√°men√≠', `
                        <div style="text-align: center; padding: 2rem; color: #888;">
                            ≈Ω√°dn√° nov√° ozn√°men√≠
                        </div>
                        <button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 1rem;">${'Zpƒõt'}</button>
                    `);
                    return;
                }
                
                let html = `<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                let totalEarnings = 0;
                
                notifList.forEach(notif => {
                    if (notif.type === 'sold') {
                        totalEarnings += notif.price;
                        html += `
                            <div style="background: #1a3a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #8bc34a;">
                                <div style="color: #8bc34a;">üí∞ Prod√°no!</div>
                                <div style="color: #fff;">${notif.item} ‚Üí ${notif.buyer}</div>
                                <div style="color: #ffd700; font-weight: bold;">+${notif.price} üí∞</div>
                            </div>
                        `;
                    }
                });
                
                html += `</div>`;
                
                if (totalEarnings > 0) {
                    html += `
                        <div style="background: #2a3a1a; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
                            <div style="color: #888;">Celkov√Ω v√Ωdƒõlek:</div>
                            <div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">+${totalEarnings} üí∞</div>
                        </div>
                        <button class="btn" onclick="collectMarketEarnings(${totalEarnings})" style="width: 100%; margin-top: 0.5rem; background: #4CAF50;">‚úì Vybrat pen√≠ze</button>
                    `;
                }
                
                html += `<button class="btn" onclick="showMarketplace()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê ${'Zpƒõt'}</button>`;
                
                showModal('üì¨ Ozn√°men√≠ z tr≈æi≈°tƒõ', html);
                
            } catch (e) {
                console.error('Chyba:', e);
            }
        }
        
        // Automatick√° kontrola a vybr√°n√≠ penƒõz p≈ôi otev≈ôen√≠ marketplace
        async function autoCollectMarketEarnings() {
            if (!multiplayerEnabled || !firebaseDB) return 0;
            
            const myName = getPlayerName();
            
            try {
                const sanitizedName = sanitizeFirebasePath(myName);
                const snapshot = await firebaseDB.ref('marketplace/notifications/' + sanitizedName).once('value');
                const notifications = snapshot.val() || {};
                const notifList = Object.values(notifications);
                
                let totalEarnings = 0;
                let totalFees = 0;
                notifList.forEach(notif => {
                    if (notif.type === 'sold') {
                        // Pou≈æij moneyToAdd (u≈æ po odeƒçten√≠ poplatku) nebo fallback na price pro star√© notifikace
                        totalEarnings += notif.moneyToAdd || notif.price || 0;
                        totalFees += notif.fee || 0;
                    }
                });
                
                if (totalEarnings > 0) {
                    addMoney(totalEarnings);
                    await firebaseDB.ref('marketplace/notifications/' + sanitizedName).remove();
                    saveGame(true);
                    if (totalFees > 0) {
                        notifySuccess('üí∞ Pen√≠ze z prodeje!', `+${totalEarnings} üí∞ (poplatek: ${totalFees} üí∞)`);
                    } else {
                        notifySuccess('üí∞ Pen√≠ze z prodeje!', `+${totalEarnings} üí∞ automaticky p≈ôips√°no`);
                    }
                }
                
                return totalEarnings;
            } catch (e) {
                console.error('Auto collect error:', e);
                return 0;
            }
        }
        
        async function collectMarketEarnings(amount) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const sanitizedName = sanitizeFirebasePath(myName);
            
            // P≈ôidej pen√≠ze spr√°vnƒõ p≈ôes funkci
            addMoney(amount);
            
            // Sma≈æ ozn√°men√≠
            await firebaseDB.ref('marketplace/notifications/' + sanitizedName).remove();
            
            notifySuccess('Pen√≠ze vybr√°ny!', `+${amount} üí∞`);
            saveGame();
            showMarketplace();
        }
        
        // === üî• SUPER PvP SYST√âM v2.0 ===
        let lastPvPNotificationId = null;
        let activePvPBattle = null;
        let pvpAnimationFrame = null;
        
        // üèÜ PvP RANKING SYST√âM
        const PVP_RANKS = [
            { name: 'Nov√°ƒçek', icon: 'ü•â', minElo: 0, color: '#cd7f32' },
            { name: 'Bojovn√≠k', icon: '‚öîÔ∏è', minElo: 1000, color: '#c0c0c0' },
            { name: 'Veter√°n', icon: 'ü•à', minElo: 1200, color: '#87ceeb' },
            { name: 'Elita', icon: 'ü•á', minElo: 1400, color: '#ffd700' },
            { name: '≈†ampion', icon: 'üèÜ', minElo: 1600, color: '#ff9800' },
            { name: 'Gladi√°tor', icon: '‚öîÔ∏èüëë', minElo: 1800, color: '#e91e63' },
            { name: 'Legenda', icon: 'üåü', minElo: 2000, color: '#9c27b0' },
            { name: 'Nesmrteln√Ω', icon: 'üíÄüëë', minElo: 2500, color: '#f44336' }
        ];
        
        // üéØ PvP SPECI√ÅLN√ç SCHOPNOSTI
        const PVP_ABILITIES = {
            // √ötoƒçn√©
            powerStrike: { name: 'Drtiv√Ω √∫der', icon: 'üí•', cooldown: 3, damage: 2.0, desc: '200% damage', type: 'attack' },
            doubleSlash: { name: 'Dvojit√Ω sek', icon: '‚öîÔ∏è‚öîÔ∏è', cooldown: 2, hits: 2, damage: 0.7, desc: '2x 70% damage', type: 'attack' },
            criticalAim: { name: 'Kritick√Ω c√≠l', icon: 'üéØ', cooldown: 4, critBonus: 100, damage: 1.0, desc: '+100% crit ≈°ance', type: 'attack' },
            venomStrike: { name: 'Jedovat√Ω √∫der', icon: 'üêç', cooldown: 3, damage: 0.8, poison: 3, desc: 'Jed 3 kola', type: 'attack' },
            berserkerRage: { name: 'Zu≈ôivost', icon: 'üò§', cooldown: 5, damage: 2.5, selfDamage: 0.1, desc: '250% DMG, -10% HP', type: 'attack' },
            
            // Obrann√©
            ironSkin: { name: '≈Ωelezn√° k≈Ø≈æe', icon: 'üõ°Ô∏è', cooldown: 4, defenseBoost: 3.0, duration: 2, desc: '3x obrana 2 kola', type: 'defense' },
            dodge: { name: '√öhyb', icon: 'üí®', cooldown: 2, dodgeChance: 100, desc: '100% √∫hyb', type: 'defense' },
            counter: { name: 'Proti√∫tok', icon: '‚Ü©Ô∏è', cooldown: 3, counterDamage: 1.5, desc: 'Odraz√≠ 150% DMG', type: 'defense' },
            heal: { name: 'L√©ƒçen√≠', icon: 'üíö', cooldown: 4, healPercent: 25, desc: 'Vyl√©ƒç√≠ 25% HP', type: 'defense' },
            
            // Speci√°ln√≠
            stun: { name: 'Omr√°ƒçen√≠', icon: 'üí´', cooldown: 5, stunDuration: 1, damage: 0.5, desc: 'Stun 1 kolo', type: 'special' },
            lifeSteal: { name: 'Vys√°t√≠ ≈æivota', icon: 'üßõ', cooldown: 4, damage: 1.0, steal: 0.5, desc: 'Kradne 50% DMG', type: 'special' },
            execute: { name: 'Poprava', icon: '‚ö∞Ô∏è', cooldown: 6, executeThreshold: 0.25, damage: 3.0, desc: '3x DMG pod 25% HP', type: 'special' },
            lastStand: { name: 'Posledn√≠ vzdor', icon: 'üî•', cooldown: 0, passive: true, desc: '+50% DMG pod 20% HP', type: 'passive' }
        };
        
        // üéñÔ∏è PvP TITULY (achievementy)
        const PVP_TITLES = [
            { id: 'first_blood', name: 'Prvn√≠ krev', icon: 'ü©∏', req: 'Vyhr√°t prvn√≠ PvP', check: (s) => s.pvpWins >= 1 },
            { id: 'warrior', name: 'V√°leƒçn√≠k', icon: '‚öîÔ∏è', req: '10 v√≠tƒõzstv√≠', check: (s) => s.pvpWins >= 10 },
            { id: 'dominator', name: 'Domin√°tor', icon: 'üëë', req: '50 v√≠tƒõzstv√≠', check: (s) => s.pvpWins >= 50 },
            { id: 'legend', name: 'Legenda', icon: 'üåü', req: '100 v√≠tƒõzstv√≠', check: (s) => s.pvpWins >= 100 },
            { id: 'streak5', name: 'Na vlnƒõ', icon: 'üåä', req: '5 v√≠tƒõzstv√≠ v ≈ôadƒõ', check: (s) => s.pvpWinStreak >= 5 },
            { id: 'streak10', name: 'Nezastaviteln√Ω', icon: 'üî•', req: '10 v√≠tƒõzstv√≠ v ≈ôadƒõ', check: (s) => s.pvpWinStreak >= 10 },
            { id: 'comeback', name: 'Comeback King', icon: 'üëä', req: 'Vyhr√°t s <10% HP', check: (s) => s.pvpComeback >= 1 },
            { id: 'flawless', name: 'Perfektn√≠', icon: 'üíé', req: 'Vyhr√°t bez zranƒõn√≠', check: (s) => s.pvpFlawless >= 1 },
            { id: 'rich', name: 'High Roller', icon: 'üí∞', req: 'Vyhr√°t 10000+ s√°zku', check: (s) => s.pvpMaxBetWon >= 10000 },
            { id: 'gladiator', name: 'Gladi√°tor', icon: 'üèõÔ∏è', req: 'Dos√°hnout 1800 ELO', check: (s) => s.pvpElo >= 1800 },
            { id: 'tournament', name: '≈†ampion turnaje', icon: 'üèÜ', req: 'Vyhr√°t turnaj', check: (s) => s.pvpTournamentsWon >= 1 }
        ];
        
        // Inicializace PvP stats
        function initPvPStats() {
            if (!state.pvp) {
                state.pvp = {
                    elo: 1000,
                    wins: 0,
                    losses: 0,
                    winStreak: 0,
                    maxWinStreak: 0,
                    totalDamageDealt: 0,
                    totalDamageReceived: 0,
                    comebacks: 0,
                    flawless: 0,
                    maxBetWon: 0,
                    tournamentsWon: 0,
                    tournamentsPlayed: 0,
                    titles: [],
                    selectedAbilities: ['powerStrike', 'dodge', 'heal', 'stun'],
                    lastBattleLog: []
                };
            }
        }
        
        // Z√≠skej PvP rank podle ELO
        function getPvPRank(elo) {
            for (let i = PVP_RANKS.length - 1; i >= 0; i--) {
                if (elo >= PVP_RANKS[i].minElo) return PVP_RANKS[i];
            }
            return PVP_RANKS[0];
        }
        
        // V√Ωpoƒçet ELO zmƒõny
        function calculateEloChange(myElo, enemyElo, won) {
            // Zajisti ≈æe ELO jsou ƒç√≠sla
            myElo = parseInt(myElo) || 1000;
            enemyElo = parseInt(enemyElo) || 1000;
            
            const K = 32; // K-faktor
            const expected = 1 / (1 + Math.pow(10, (enemyElo - myElo) / 400));
            const actual = won ? 1 : 0;
            const change = Math.round(K * (actual - expected));
            
            // Vra≈• validn√≠ ƒç√≠slo
            return isNaN(change) ? (won ? 16 : -16) : change;
        }
        
        function listenToPvP() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            initPvPStats();
            const myName = getPlayerName();
            
            firebaseDB.ref('pvp/challenges').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                pvpChallenges = Object.entries(data).map(([key, val]) => ({...val, id: key}));
                
                // Zkontroluj jestli m√°m novou v√Ωzvu (max 5 minut starou)
                const now = Date.now();
                const PVP_CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minut
                const myChallenge = pvpChallenges.find(c => 
                    c.target === myName && 
                    c.status === 'pending' &&
                    (now - (c.createdAt || 0)) < PVP_CHALLENGE_TIMEOUT
                );
                if (myChallenge && myChallenge.id !== lastPvPNotificationId) {
                    lastPvPNotificationId = myChallenge.id;
                    showFullscreenPvPChallenge(myChallenge);
                }
                
                // Auto-expire star√© pending v√Ωzvy (pro challengera)
                const myOldPendingChallenge = pvpChallenges.find(c =>
                    c.challenger === myName &&
                    c.status === 'pending' &&
                    c.createdAt &&
                    (now - c.createdAt) > PVP_CHALLENGE_TIMEOUT
                );
                if (myOldPendingChallenge) {
                    // Automaticky zru≈° starou v√Ωzvu
                    firebaseDB.ref('pvp/challenges/' + myOldPendingChallenge.id).update({ status: 'expired' });
                    notifyWarning('‚è∞ V√Ωzva vypr≈°ela', `${myOldPendingChallenge.target} nereagoval/a vƒças.`);
                }
                
                // Zkontroluj real-time battle
                const activeBattle = pvpChallenges.find(c => 
                    (c.challenger === myName || c.target === myName) && 
                    c.status === 'in_progress'
                );
                if (activeBattle && !activePvPBattle) {
                    startRealTimePvPBattle(activeBattle);
                }
                
                // Zkontroluj dokonƒçen√© bitvy
                const myCompletedChallenge = pvpChallenges.find(c => 
                    (c.challenger === myName || c.target === myName) && 
                    c.status === 'completed' && 
                    !c.notified
                );
                if (myCompletedChallenge) {
                    showPvPResult(myCompletedChallenge);
                }
            });
            
            // Poslouchej turnaje
            firebaseDB.ref('pvp/tournaments').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                window.pvpTournaments = Object.entries(data).map(([key, val]) => ({...val, id: key}));
            });
        }
        
        // üé¨ FULLSCREEN PvP V√ùZVA s animacemi
        // Glob√°ln√≠ flag pro aktivn√≠ PvP v√Ωzvu - zabra≈àuje p≈ôekryt√≠ jin√Ωmi okny
        let pvpChallengeOverlayActive = false;
        
        function showFullscreenPvPChallenge(challenge) {
            // Oznaƒç ≈æe je aktivn√≠ PvP v√Ωzva
            pvpChallengeOverlayActive = true;
            
            const rank = getPvPRank(challenge.challengerStats?.elo || 1000);
            const html = `
                <div id="pvpFullscreenOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.98); z-index: 999999; display: flex; align-items: center; justify-content: center; animation: pvpFadeIn 0.3s;">
                    <div style="background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%); border: 2px solid #f44336; border-radius: 16px; padding: 1.5rem; max-width: 340px; width: 90%; text-align: center; animation: pvpBounce 0.5s; position: relative; overflow: hidden;">
                        
                        <!-- Animated background -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 50% 50%, rgba(244,67,54,0.1) 0%, transparent 70%); animation: pvpGlow 2s infinite;"></div>
                        
                        <div style="position: relative; z-index: 1;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem; animation: pvpPulse 1s infinite; filter: drop-shadow(0 0 10px rgba(244,67,54,0.8));">‚öîÔ∏è</div>
                            <h2 style="color: #f44336; margin: 0 0 0.8rem 0; text-shadow: 0 0 20px rgba(244,67,54,0.8); font-size: 1.3rem; letter-spacing: 1px;">V√ùZVA K SOUBOJI!</h2>
                            
                            <div style="background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); padding: 0.8rem; border-radius: 12px; margin: 0.8rem 0; border: 2px solid ${rank.color};">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.4rem; margin-bottom: 0.3rem;">
                                    <span style="font-size: 1rem;">${rank.icon}</span>
                                    <span style="color: ${rank.color}; font-size: 0.75rem;">${rank.name}</span>
                                </div>
                                <div style="color: #fff; font-size: 1.2rem; font-weight: bold;">${escapeHtml(challenge.challenger)}</div>
                                <div style="color: #888; font-size: 0.8rem; margin-top: 0.3rem;">
                                    Level ${challenge.challengerStats?.level || '?'} | 
                                    ELO: <span style="color: ${rank.color};">${challenge.challengerStats?.elo || 1000}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; margin-top: 0.5rem; background: #0a0a0a; padding: 0.4rem; border-radius: 6px; font-size: 0.8rem;">
                                    <div><span style="font-size: 0.85rem;">‚ù§Ô∏è</span><br>${challenge.challengerStats?.hp || '?'}</div>
                                    <div><span style="font-size: 0.85rem;">‚öîÔ∏è</span><br>${challenge.challengerStats?.damage || '?'}</div>
                                    <div><span style="font-size: 0.85rem;">üõ°Ô∏è</span><br>${challenge.challengerStats?.defense || '?'}</div>
                                    <div><span style="font-size: 0.85rem;">üí®</span><br>${challenge.challengerStats?.agility || '?'}</div>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #3a3a0a 0%, #2a2a00 100%); padding: 0.8rem; border-radius: 12px; margin: 0.8rem 0; border: 2px solid #ffd700; animation: goldPulse 2s infinite;">
                                <div style="color: #888; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;">S√°zka</div>
                                <div style="color: #ffd700; font-size: 1.8rem; font-weight: bold; text-shadow: 0 0 15px rgba(255,215,0,0.5);">${challenge.bet} üí∞</div>
                            </div>
                            
                            <div style="background: rgba(255,152,0,0.1); padding: 0.5rem; border-radius: 8px; margin: 0.8rem 0; border: 1px solid #ff9800;">
                                <p style="color: #ff9800; font-size: 0.8rem; margin: 0;">
                                    ‚ö†Ô∏è Prohra = -${challenge.bet} üí∞ a ELO!
                                </p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-top: 1rem;">
                                <button onclick="declinePvPFromOverlay('${challenge.id}')" style="background: linear-gradient(135deg, #555 0%, #333 100%); color: #fff; border: none; padding: 0.9rem; border-radius: 10px; font-size: 0.95rem; cursor: pointer; font-family: inherit; transition: all 0.3s;">
                                    ‚ùå Odm√≠tnout
                                </button>
                                <button onclick="acceptPvPFromOverlay('${challenge.id}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: #fff; border: none; padding: 0.9rem; border-radius: 10px; font-size: 0.95rem; cursor: pointer; font-weight: bold; font-family: inherit; animation: fightBtnPulse 1s infinite; box-shadow: 0 0 20px rgba(244,67,54,0.5);">
                                    ‚öîÔ∏è BOJOVAT!
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes pvpFadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes pvpBounce { 0% { transform: scale(0.3) rotate(-10deg); opacity: 0; } 50% { transform: scale(1.05) rotate(2deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
                    @keyframes pvpPulse { 0%, 100% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.1) rotate(-5deg); } 75% { transform: scale(1.1) rotate(5deg); } }
                    @keyframes pvpGlow { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
                    @keyframes goldPulse { 0%, 100% { box-shadow: 0 0 10px rgba(255,215,0,0.3); } 50% { box-shadow: 0 0 20px rgba(255,215,0,0.6); } }
                    @keyframes fightBtnPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            if (typeof SoundSystem !== 'undefined') SoundSystem.play('combat');
        }
        
        function closePvPOverlay() {
            const overlay = document.getElementById('pvpFullscreenOverlay');
            if (overlay) overlay.remove();
            pvpChallengeOverlayActive = false;
        }
        
        async function acceptPvPFromOverlay(challengeId) {
            closePvPOverlay();
            await acceptPvPChallenge(challengeId);
        }
        
        async function declinePvPFromOverlay(challengeId) {
            closePvPOverlay();
            await declinePvPChallenge(challengeId);
        }
        
        // üé¨ ZOBRAZEN√ç V√ùSLEDKU PvP s animacemi
        function showPvPResult(challenge) {
            // Tato funkce se vol√° pro CHALLENGERA (ten kdo poslal v√Ωzvu) kdy≈æ se boj dokonƒç√≠
            // Pro toho kdo P≈òIJAL v√Ωzvu se vol√° showPvPResultDirect
            
            // Pokud u≈æ je overlay zobrazen, nedƒõl√°me nic
            if (document.getElementById('pvpResultOverlay')) return;
            
            initPvPStats();
            const myName = getPlayerName();
            const iWon = challenge.winner === myName;
            const opponent = challenge.challenger === myName ? challenge.target : challenge.challenger;
            const eloChange = challenge.eloChange || 0;
            
            // Pro challengera - aktualizuj jeho stats kdy≈æ se dozv√≠ v√Ωsledek
            if (challenge.challenger === myName) {
                if (iWon) {
                    state.pvp.wins++;
                    state.pvp.winStreak++;
                    if (challenge.bet > 0) addMoney(challenge.bet);
                    notifySuccess('‚öîÔ∏è V√çTƒöZSTV√ç!', `${opponent} pora≈æen!${challenge.bet > 0 ? ` +${challenge.bet} üí∞` : ''}`);
                    
                    // Daily quest progress
                    if (state.dailyQuests?.progress) {
                        state.dailyQuests.progress.pvpWins = (state.dailyQuests.progress.pvpWins || 0) + 1;
                        checkDailyQuests();
                    }
                } else {
                    state.pvp.losses++;
                    state.pvp.winStreak = 0;
                    if (challenge.bet > 0) removeMoney(challenge.bet);
                    notifyWarning('‚öîÔ∏è Prohra', `${opponent} vyhr√°l!${challenge.bet > 0 ? ` -${challenge.bet} üí∞` : ''}`);
                }
                state.pvp.elo = Math.max(0, state.pvp.elo + (iWon ? eloChange : -eloChange));
                saveGame();
            }
            
            const myNewElo = state.pvp.elo;
            const newRank = getPvPRank(myNewElo);
            
            // Aktualizuj notifikaci
            if (firebaseDB) {
                firebaseDB.ref('pvp/challenges/' + challenge.id).update({ notified: true });
            }
            
            // Nov√© tituly?
            const newTitles = checkPvPTitles();
            
            const html = `
                <div id="pvpResultOverlayAuto" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.98); z-index: 99999; display: flex; align-items: center; justify-content: center; padding: 1rem; animation: pvpFadeIn 0.3s;">
                    <div style="background: linear-gradient(135deg, ${iWon ? '#1a3a1a' : '#3a1a1a'} 0%, #0a0a0a 100%); border: 2px solid ${iWon ? '#4CAF50' : '#f44336'}; border-radius: 16px; padding: 1.2rem; max-width: 340px; width: 100%; text-align: center; animation: resultBounce 0.6s;">
                        
                        <!-- Victory/Defeat animation -->
                        <div style="font-size: 3rem; margin-bottom: 0.5rem; animation: ${iWon ? 'victoryAnim' : 'defeatAnim'} 1s;">
                            ${iWon ? 'üèÜ' : 'üíÄ'}
                        </div>
                        
                        <h2 style="color: ${iWon ? '#4CAF50' : '#f44336'}; margin: 0 0 0.3rem 0; font-size: 1.4rem; text-shadow: 0 0 20px ${iWon ? 'rgba(76,175,80,0.8)' : 'rgba(244,67,54,0.8)'}; letter-spacing: 2px;">
                            ${iWon ? 'V√çTƒöZSTV√ç!' : 'PROHRA!'}
                        </h2>
                        
                        <p style="color: #888; margin: 0.3rem 0; font-size: 0.85rem;">vs <strong style="color: #fff;">${opponent}</strong></p>
                        
                        <!-- Pen√≠ze -->
                        <div style="background: ${iWon ? 'linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%)' : 'linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%)'}; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${iWon ? '#4CAF50' : '#f44336'};">
                            <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.8rem; font-weight: bold; animation: moneyPop 0.5s;">
                                ${iWon ? '+' : '-'}${challenge.bet} üí∞
                            </div>
                        </div>
                        
                        <!-- ELO zmƒõna -->
                        <div style="background: #1a1a2a; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${newRank.color};">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 0.8rem;">
                                <div style="text-align: center;">
                                    <div style="color: #888; font-size: 0.7rem;">ELO</div>
                                    <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.2rem; font-weight: bold;">
                                        ${iWon ? '+' : ''}${eloChange}
                                    </div>
                                </div>
                                <div style="color: #555; font-size: 1.3rem;">‚Üí</div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2rem;">${newRank.icon}</div>
                                    <div style="color: ${newRank.color}; font-weight: bold; font-size: 1.1rem;">${myNewElo}</div>
                                    <div style="color: ${newRank.color}; font-size: 0.7rem;">${newRank.name}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistiky boje -->
                        ${challenge.battleStats ? `
                            <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin: 0.7rem 0;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; font-size: 0.75rem;">
                                    <div><span style="color: #888;">Kola</span><br><span style="color: #fff;">${challenge.battleStats.rounds}</span></div>
                                    <div><span style="color: #888;">DMG</span><br><span style="color: #ff9800;">${challenge.battleStats.myDamage}</span></div>
                                    <div><span style="color: #888;">P≈ôijato</span><br><span style="color: #f44336;">${challenge.battleStats.damageTaken}</span></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Nov√© tituly -->
                        ${newTitles.length > 0 ? `
                            <div style="background: linear-gradient(135deg, #3a2a0a 0%, #2a1a00 100%); padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid #ffd700; animation: newTitleGlow 1s infinite;">
                                <div style="color: #ffd700; font-weight: bold; margin-bottom: 0.3rem; font-size: 0.85rem;">üèÖ NOV√ù TITUL!</div>
                                ${newTitles.map(t => `<div style="font-size: 1rem;">${t.icon} ${t.name}</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button onclick="showPvPBattleLog('${challenge.id}')" style="background: #333; color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                üìú Log
                            </button>
                            <button onclick="document.getElementById('pvpResultOverlay').remove(); showPvPArena();" style="background: linear-gradient(135deg, #555 0%, #333 100%); color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                ‚öîÔ∏è Dal≈°√≠
                            </button>
                        </div>
                        
                        <button onclick="document.getElementById('pvpResultOverlay').remove()" style="background: transparent; color: #666; border: none; padding: 0.4rem; margin-top: 0.3rem; cursor: pointer; font-family: inherit; width: 100%; font-size: 0.8rem;">
                            Zav≈ô√≠t
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes resultBounce { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 60% { transform: scale(1.1) rotate(10deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
                    @keyframes victoryAnim { 0% { transform: scale(0) rotate(-180deg); } 50% { transform: scale(1.3) rotate(20deg); } 100% { transform: scale(1) rotate(0deg); } }
                    @keyframes defeatAnim { 0% { transform: translateY(-50px); opacity: 0; } 60% { transform: translateY(10px); } 100% { transform: translateY(0); opacity: 1; } }
                    @keyframes moneyPop { 0% { transform: scale(0); } 60% { transform: scale(1.3); } 100% { transform: scale(1); } }
                    @keyframes newTitleGlow { 0%, 100% { box-shadow: 0 0 10px rgba(255,215,0,0.5); } 50% { box-shadow: 0 0 30px rgba(255,215,0,0.8); } }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            if (typeof SoundSystem !== 'undefined') SoundSystem.play(iWon ? 'victory' : 'damage');
        }
        
        // Zobrazit battle log
        function showPvPBattleLog(challengeId) {
            const challenge = pvpChallenges.find(c => c.id === challengeId);
            if (!challenge || !challenge.log) return;
            
            const myName = getPlayerName();
            const opponent = challenge.challenger === myName ? challenge.target : challenge.challenger;
            
            let logHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.8rem; background: #0a0a0a; border-radius: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem;">üë§</div>
                        <div style="color: #8bc34a; font-weight: bold;">${myName}</div>
                    </div>
                    <div style="color: #888; font-size: 1.5rem;">‚öîÔ∏è</div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem;">üë§</div>
                        <div style="color: #ff6b6b; font-weight: bold;">${opponent}</div>
                    </div>
                </div>
                
                <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">üìú Pr≈Øbƒõh boje (${challenge.battleStats?.rounds || '?'} kol)</div>
                
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; padding: 0.5rem; border-radius: 8px;">
            `;
            
            challenge.log.forEach((entry, i) => {
                const isMe = entry.actor === myName;
                const isSystem = entry.actor === 'System';
                
                logHtml += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; margin-bottom: 3px; background: ${isSystem ? '#2a1a2a' : (isMe ? 'rgba(76,175,80,0.1)' : 'rgba(244,67,54,0.1)')}; border-radius: 6px; border-left: 3px solid ${isSystem ? '#9c27b0' : (isMe ? '#4CAF50' : '#f44336')};">
                        <div style="min-width: 24px; text-align: center;">
                            ${isSystem ? '‚ö°' : (isMe ? 'üü¢' : 'üî¥')}
                        </div>
                        <div style="flex: 1;">
                            <span style="color: ${isSystem ? '#9c27b0' : (isMe ? '#8bc34a' : '#ff6b6b')}; font-weight: bold;">${entry.actor}</span>
                            ${entry.ability ? `<span style="color: #ffd700; margin-left: 0.3rem;">${entry.ability}</span>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${entry.damage ? `<span style="color: #ff9800; font-weight: bold;">${entry.damage} DMG</span>` : ''}
                            ${entry.effect ? `<div style="color: #9c27b0; font-size: 0.75rem;">${entry.effect}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            logHtml += `</div>`;
            
            // Statistiky boje
            if (challenge.battleStats) {
                logHtml += `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 1rem; padding: 0.8rem; background: #1a1a1a; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="color: #ff9800; font-size: 1.2rem; font-weight: bold;">${challenge.battleStats.myDamage || 0}</div>
                            <div style="color: #888; font-size: 0.7rem;">Tv≈Øj DMG</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #fff; font-size: 1.2rem; font-weight: bold;">${challenge.battleStats.rounds || 0}</div>
                            <div style="color: #888; font-size: 0.7rem;">Kol</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #f44336; font-size: 1.2rem; font-weight: bold;">${challenge.battleStats.damageTaken || 0}</div>
                            <div style="color: #888; font-size: 0.7rem;">P≈ôijat√Ω DMG</div>
                        </div>
                    </div>
                `;
            }
            
            logHtml += `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">${t('ui', 'close')}</button>`;
            
            showModal('üìú Log boje', logHtml);
        }
        
        // Kontrola nov√Ωch titul≈Ø
        function checkPvPTitles() {
            initPvPStats();
            const newTitles = [];
            const stats = {
                pvpWins: state.pvp.wins,
                pvpWinStreak: state.pvp.winStreak,
                pvpComeback: state.pvp.comebacks,
                pvpFlawless: state.pvp.flawless,
                pvpMaxBetWon: state.pvp.maxBetWon,
                pvpElo: state.pvp.elo,
                pvpTournamentsWon: state.pvp.tournamentsWon
            };
            
            PVP_TITLES.forEach(title => {
                if (title.check(stats) && !state.pvp.titles.includes(title.id)) {
                    state.pvp.titles.push(title.id);
                    newTitles.push(title);
                }
            });
            
            return newTitles;
        }
        
        // Kontrola nov√Ωch chat zpr√°v
        let lastChatMessageCount = 0;
        function checkNewChatMessages() {
            const myName = getPlayerName();
            const newMessages = chatMessages.filter(m => m.author !== myName);
            
            if (newMessages.length > lastChatMessageCount && lastChatMessageCount > 0) {
                const lastMsg = newMessages[newMessages.length - 1];
                
                // Zkontroluj jestli mƒõ nƒõkdo oznaƒçil (@mention)
                const isMentioned = lastMsg.text && lastMsg.text.toLowerCase().includes('@' + myName.toLowerCase());
                
                if (isMentioned) {
                    // Speci√°ln√≠ notifikace kdy≈æ mƒõ nƒõkdo oznaƒçil
                    notifySuccess('üì¢ ' + lastMsg.author + ' tƒõ oznaƒçil!', lastMsg.text.substring(0, 50));
                    
                    // P≈ôehr√°t zvuk pokud existuje
                    if (typeof SoundSystem !== 'undefined' && SoundSystem.play) {
                        SoundSystem.play('notification');
                    }
                } else {
                    // Bƒõ≈æn√° notifikace o nov√© zpr√°vƒõ
                    notifySuccess('üí¨ ' + lastMsg.author, lastMsg.text.substring(0, 50));
                }
            }
            
            lastChatMessageCount = newMessages.length;
        }
        
        function showPvPChallengeNotification(challenge) {
            // Tato funkce je nahrazena showFullscreenPvPChallenge
        }
        
        // üìä PvP BOJOV√â STATISTIKY - POU≈Ω√çV√Å SKUTEƒåN√â HERN√ç BONUSY
        function getPlayerCombatStats() {
            initPvPStats();
            
            // Pou≈æij stejn√© v√Ωpoƒçty jako v PvE boji
            const damage = typeof calculateDamage === 'function' ? calculateDamage() : 10;
            const defense = typeof calculateDefense === 'function' ? calculateDefense() : 5;
            const critChance = typeof calculateCritChance === 'function' ? Math.round(calculateCritChance() * 100) : 5;
            const dodgeChance = typeof calculateDodgeChance === 'function' ? Math.round(calculateDodgeChance() * 100) : 2;
            
            // Max HP - pou≈æij aktu√°ln√≠ max HP vƒçetnƒõ v≈°ech bonus≈Ø
            const maxHp = state.maxHp || state.char.maxHp || 100;
            
            // Vybaven√≠ pro zobrazen√≠
            const weapon = state.equipped?.weapon;
            const armor = state.equipped?.armor;
            const helmet = state.equipped?.helmet;
            const gloves = state.equipped?.gloves;
            const boots = state.equipped?.boots;
            
            // Speci√°ln√≠ efekty z vybaven√≠
            const armorEffects = typeof getArmorSpecialEffects === 'function' ? getArmorSpecialEffects() : {};
            
            // Mutace
            const mutations = state.mutations || [];
            const hasBerserkerBlood = mutations.includes('berserker_blood');
            const hasThickSkin = mutations.includes('thick_skin');
            const hasSixthSense = mutations.includes('sixth_sense');
            
            // Class info
            const classId = state.char.classId || 'survivor';
            const className = getClassName(classId);
            
            // Block ≈°ance (z rukavic a skill tree)
            let blockChance = 0;
            if (gloves?.special === 'block_bonus') blockChance += 10;
            if (gloves?.special === 'block') blockChance += 15;
            // Skill tree bonus je v desetinn√©m form√°tu (0.1 = 10%), n√°sob√≠me 100
            blockChance += (getSkillTreeBonus('blockChance') || 0) * 100;
            
            // Lifesteal (z mutac√≠ nebo vybaven√≠)
            let lifesteal = 0;
            if (mutations.includes('vampiric_touch')) lifesteal += 10;
            
            // Regenerace (z nano armor)
            let regenPerRound = 0;
            if (armor?.special === 'nano') regenPerRound = 2;
            
            // Phoenix efekt (1x p≈ôe≈æit√≠ smrteln√©ho z√°sahu)
            const hasPhoenix = armor?.special === 'phoenix';
            
            // Titan efekt (imunita na crit)
            const hasTitanArmor = armor?.special === 'titan';
            
            // Poison bonus z gloves
            const hasPoisonPunch = gloves?.special === 'bleed_punch';
            
            // Extra damage z gloves
            let gloveDamage = 0;
            if (gloves?.special === 'power_punch') gloveDamage = 10;
            if (gloves?.special === 'grip') gloveDamage = 2;
            if (gloves?.special === 'bleed_punch') gloveDamage = 3;
            
            // Extra damage z boots
            let bootDamage = 0;
            if (boots?.special === 'stomp') bootDamage = 8;
            
            return {
                name: getPlayerName(),
                hp: maxHp,
                maxHp: maxHp,
                damage: damage + gloveDamage + bootDamage,
                defense: defense,
                critChance: critChance,
                dodgeChance: dodgeChance,
                blockChance: blockChance,
                lifesteal: lifesteal,
                regenPerRound: regenPerRound,
                hasPhoenix: hasPhoenix,
                phoenixUsed: false,
                hasTitanArmor: hasTitanArmor,
                hasPoisonPunch: hasPoisonPunch,
                hasBerserkerBlood: hasBerserkerBlood,
                level: state.char.level,
                elo: state.pvp?.elo || 1000,
                classId: classId,
                className: className,
                weapon: weapon?.name || 'Pƒõsti',
                armor: armor?.name || '≈Ω√°dn√°',
                // Pro zobrazen√≠ v profilu
                mutations: mutations,
                equipped: {
                    weapon: weapon,
                    armor: armor,
                    helmet: helmet,
                    gloves: gloves,
                    boots: boots
                }
            };
        }
        
        // Pomocn√° funkce pro n√°zev classy
        function getClassName(classId) {
            const classNames = {
                survivor: 'P≈ôe≈æiv≈°√≠',
                raider: 'N√°jezdn√≠k',
                berserker: 'Berserk',
                scout: 'Zvƒõd',
                medic: 'Medik',
                engineer: 'In≈æen√Ωr',
                sniper: 'Odst≈ôelovaƒç',
                assassin: 'Zabij√°k',
                tank: 'Tank',
                mutant: 'Mutant'
            };
            return classNames[classId] || classId;
        }
        
        // üéØ VYTVO≈òEN√ç V√ùZVY - PvP je ZDARMA
        async function createPvPChallenge(targetName, bet = 0, mode = 'standard') {
            if (!multiplayerEnabled || !firebaseDB) {
                console.log('‚ùå createPvPChallenge: multiplayer not enabled or no firebaseDB');
                return;
            }
            
            initPvPStats();
            const myName = getPlayerName();
            
            console.log('‚öîÔ∏è createPvPChallenge called:', { targetName, bet, mode, myName });
            
            // Kontrola - u≈æ m√°m pending v√Ωzvu? (pvpChallenges m≈Ø≈æe b√Ωt undefined)
            const challenges = pvpChallenges || [];
            const existingChallenge = challenges.find(c => 
                c.challenger === myName && c.status === 'pending'
            );
            if (existingChallenge) {
                notifyWarning('‚è≥ ƒåekej na odpovƒõƒè', `U≈æ m√°≈° aktivn√≠ v√Ωzvu pro ${existingChallenge.target}. Poƒçkej ne≈æ ji p≈ôijme nebo odm√≠tne.`);
                return;
            }
            
            const myStats = getPlayerCombatStats();
            console.log('‚öîÔ∏è myStats:', myStats);
            
            // O≈°et≈ôen√≠ dat pro Firebase - odstra≈à undefined hodnoty a funkce
            const cleanStats = {
                name: myStats.name || myName,
                level: myStats.level || 1,
                class: myStats.class || 'survivor',
                hp: myStats.hp || 100,
                maxHp: myStats.maxHp || 100,
                damage: myStats.damage || 10,
                defense: myStats.defense || 0,
                critChance: myStats.critChance || 5,
                dodgeChance: myStats.dodgeChance || 0,
                blockChance: myStats.blockChance || 0,
                elo: myStats.elo || 1000
            };
            
            const challenge = {
                challenger: myName,
                target: targetName,
                challengerStats: cleanStats,
                bet: bet || 0,
                mode: mode || 'standard',
                status: 'pending',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            console.log('‚öîÔ∏è Sending challenge:', challenge);
            
            try {
                await firebaseDB.ref('pvp/challenges').push(challenge);
                notifySuccess('‚öîÔ∏è V√Ωzva odesl√°na!', `ƒåek√°m na odpovƒõƒè od ${targetName}`);
                addLog(`Vyzval jsi ${targetName} k PvP souboji!`, '‚öîÔ∏è');
                console.log('‚úÖ Challenge sent successfully');
            } catch (err) {
                console.error('‚ùå createPvPChallenge error:', err);
                notifyWarning('Chyba', 'Nepoda≈ôilo se odeslat v√Ωzvu: ' + (err.message || 'Nezn√°m√° chyba'));
            }
        }
        
        // ‚öîÔ∏è PvP BOJ - POU≈Ω√çV√Å SKUTEƒåN√â BONUSY Z POSTAVY
        async function runPvPBattle(myStats, enemyStats, challenge) {
            return new Promise((resolve) => {
                let myHp = myStats.hp;
                let enemyHp = enemyStats.hp;
                let round = 0;
                let log = [];
                let myDamageDealt = 0;
                let damageTaken = 0;
                
                // Efekty bƒõhem boje
                let myEffects = { poison: 0, bleed: 0 };
                let enemyEffects = { poison: 0, bleed: 0 };
                
                // Phoenix efekt (1x p≈ôe≈æit√≠)
                let myPhoenixUsed = false;
                let enemyPhoenixUsed = false;
                
                const maxRounds = 30;
                
                while (myHp > 0 && enemyHp > 0 && round < maxRounds) {
                    round++;
                    
                    // === ZAƒå√ÅTEK KOLA - DOT EFEKTY ===
                    // Jed/Krv√°cen√≠ na mƒõ
                    if (myEffects.poison > 0) {
                        const poisonDmg = Math.floor(myStats.maxHp * 0.03);
                        myHp -= poisonDmg;
                        damageTaken += poisonDmg;
                        myEffects.poison--;
                        log.push({ round, actor: '‚ò†Ô∏è', text: `Jed: -${poisonDmg} HP (${myStats.name})` });
                    }
                    if (myEffects.bleed > 0) {
                        const bleedDmg = Math.floor(myStats.maxHp * 0.02);
                        myHp -= bleedDmg;
                        damageTaken += bleedDmg;
                        myEffects.bleed--;
                        log.push({ round, actor: 'ü©∏', text: `Krv√°cen√≠: -${bleedDmg} HP (${myStats.name})` });
                    }
                    
                    // Jed/Krv√°cen√≠ na soupe≈ôe
                    if (enemyEffects.poison > 0) {
                        const poisonDmg = Math.floor(enemyStats.maxHp * 0.03);
                        enemyHp -= poisonDmg;
                        myDamageDealt += poisonDmg;
                        enemyEffects.poison--;
                        log.push({ round, actor: '‚ò†Ô∏è', text: `Jed: -${poisonDmg} HP (${enemyStats.name})` });
                    }
                    if (enemyEffects.bleed > 0) {
                        const bleedDmg = Math.floor(enemyStats.maxHp * 0.02);
                        enemyHp -= bleedDmg;
                        myDamageDealt += bleedDmg;
                        enemyEffects.bleed--;
                        log.push({ round, actor: 'ü©∏', text: `Krv√°cen√≠: -${bleedDmg} HP (${enemyStats.name})` });
                    }
                    
                    // Regenerace (nano armor)
                    if (myStats.regenPerRound > 0 && myHp < myStats.maxHp) {
                        const regen = Math.min(myStats.regenPerRound, myStats.maxHp - myHp);
                        myHp += regen;
                        log.push({ round, actor: 'üíö', text: `Nano regenerace: +${regen} HP (${myStats.name})` });
                    }
                    if (enemyStats.regenPerRound > 0 && enemyHp < enemyStats.maxHp) {
                        const regen = Math.min(enemyStats.regenPerRound, enemyStats.maxHp - enemyHp);
                        enemyHp += regen;
                        log.push({ round, actor: 'üíö', text: `Nano regenerace: +${regen} HP (${enemyStats.name})` });
                    }
                    
                    if (myHp <= 0 || enemyHp <= 0) break;
                    
                    // === M≈ÆJ TAH ===
                    const myAttackResult = executePvPAttack(myStats, enemyStats, enemyHp, myHp, enemyEffects);
                    
                    if (myAttackResult.dodged) {
                        log.push({ round, actor: enemyStats.name, text: `üí® Vyhnul se √∫toku!` });
                    } else if (myAttackResult.blocked) {
                        log.push({ round, actor: enemyStats.name, text: `üõ°Ô∏è Zablokoval √∫tok!` });
                    } else {
                        enemyHp -= myAttackResult.damage;
                        myDamageDealt += myAttackResult.damage;
                        
                        let logText = `‚öîÔ∏è ${myStats.name} √∫toƒç√≠: ${myAttackResult.damage} DMG`;
                        if (myAttackResult.crit) logText += ' üí•CRIT!';
                        if (myAttackResult.berserker) logText += ' üò§';
                        log.push({ round, actor: myStats.name, text: logText });
                        
                        // Lifesteal
                        if (myStats.lifesteal > 0) {
                            const stolen = Math.floor(myAttackResult.damage * myStats.lifesteal / 100);
                            myHp = Math.min(myStats.maxHp, myHp + stolen);
                            log.push({ round, actor: 'üßõ', text: `Vys√°t√≠: +${stolen} HP` });
                        }
                        
                        // Aplikuj efekty (bleed z gloves)
                        if (myAttackResult.applyBleed) {
                            enemyEffects.bleed = 3;
                            log.push({ round, actor: 'ü©∏', text: `${enemyStats.name} krv√°c√≠!` });
                        }
                    }
                    
                    // Phoenix efekt pro soupe≈ôe
                    if (enemyHp <= 0 && enemyStats.hasPhoenix && !enemyPhoenixUsed) {
                        enemyPhoenixUsed = true;
                        enemyHp = 1;
                        log.push({ round, actor: 'üî•', text: `F√âNIX! ${enemyStats.name} p≈ôe≈æil smrteln√Ω z√°sah!` });
                    }
                    
                    if (enemyHp <= 0) break;
                    
                    // === SOUPE≈ò≈ÆV TAH ===
                    const enemyAttackResult = executePvPAttack(enemyStats, myStats, myHp, enemyHp, myEffects);
                    
                    if (enemyAttackResult.dodged) {
                        log.push({ round, actor: myStats.name, text: `üí® Vyhnul se √∫toku!` });
                    } else if (enemyAttackResult.blocked) {
                        log.push({ round, actor: myStats.name, text: `üõ°Ô∏è Zablokoval √∫tok!` });
                    } else {
                        // Titan armor - imunita na crit
                        let finalDmg = enemyAttackResult.damage;
                        if (myStats.hasTitanArmor && enemyAttackResult.crit) {
                            finalDmg = Math.floor(finalDmg / 1.5); // Zru≈°√≠ crit bonus
                            log.push({ round, actor: 'üõ°Ô∏è', text: `Tit√°n: Kritick√Ω z√°sah zablokov√°n!` });
                        }
                        
                        myHp -= finalDmg;
                        damageTaken += finalDmg;
                        
                        let logText = `‚öîÔ∏è ${enemyStats.name} √∫toƒç√≠: ${finalDmg} DMG`;
                        if (enemyAttackResult.crit && !myStats.hasTitanArmor) logText += ' üí•CRIT!';
                        log.push({ round, actor: enemyStats.name, text: logText });
                        
                        // Lifesteal pro soupe≈ôe
                        if (enemyStats.lifesteal > 0) {
                            const stolen = Math.floor(finalDmg * enemyStats.lifesteal / 100);
                            enemyHp = Math.min(enemyStats.maxHp, enemyHp + stolen);
                        }
                        
                        // Aplikuj efekty
                        if (enemyAttackResult.applyBleed) {
                            myEffects.bleed = 3;
                            log.push({ round, actor: 'ü©∏', text: `${myStats.name} krv√°c√≠!` });
                        }
                    }
                    
                    // Phoenix efekt pro mƒõ
                    if (myHp <= 0 && myStats.hasPhoenix && !myPhoenixUsed) {
                        myPhoenixUsed = true;
                        myHp = 1;
                        log.push({ round, actor: 'üî•', text: `F√âNIX! ${myStats.name} p≈ôe≈æil smrteln√Ω z√°sah!` });
                    }
                }
                
                const iWon = enemyHp <= 0 || (myHp > 0 && myHp > enemyHp);
                
                resolve({
                    iWon,
                    myFinalHp: Math.max(0, myHp),
                    enemyFinalHp: Math.max(0, enemyHp),
                    rounds: round,
                    log,
                    myDamageDealt,
                    damageTaken
                });
            });
        }
        
        // Proveden√≠ √∫toku s v≈°emi bonusy
        function executePvPAttack(attacker, defender, defenderHp, attackerHp, defenderEffects) {
            // Dodge ≈°ance
            if (Math.random() * 100 < (defender.dodgeChance || 0)) {
                return { dodged: true, damage: 0 };
            }
            
            // Block ≈°ance
            if (Math.random() * 100 < (defender.blockChance || 0)) {
                return { blocked: true, damage: 0 };
            }
            
            // Z√°kladn√≠ damage
            let damage = attacker.damage || 10;
            let isCrit = false;
            let isBerserker = false;
            let applyBleed = false;
            
            // Berserker blood mutace (+25% damage pod 50% HP)
            if (attacker.hasBerserkerBlood && attackerHp < attacker.maxHp * 0.5) {
                damage = Math.floor(damage * 1.25);
                isBerserker = true;
            }
            
            // Crit ≈°ance
            if (Math.random() * 100 < (attacker.critChance || 5)) {
                damage = Math.floor(damage * 1.5);
                isCrit = true;
            }
            
            // Aplikuj obranu soupe≈ôe
            const defReduction = Math.floor((defender.defense || 0) * 0.5);
            damage = Math.max(1, damage - defReduction);
            
            // Bleed z gloves
            if (attacker.hasPoisonPunch && Math.random() < 0.3) {
                applyBleed = true;
            }
            
            return {
                damage,
                crit: isCrit,
                berserker: isBerserker,
                applyBleed,
                dodged: false,
                blocked: false
            };
        }
        
        // ‚öîÔ∏è P≈òIJET√ç V√ùZVY
        async function acceptPvPChallenge(challengeId) {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Chyba', 'Multiplayer nen√≠ aktivn√≠');
                return;
            }
            
            initPvPStats();
            const challenge = pvpChallenges.find(c => c.id === challengeId);
            if (!challenge) {
                notifyWarning('Chyba', 'V√Ωzva nenalezena');
                return;
            }
            
            if (challenge.bet > state.money) {
                notifyWarning(t('notifications', 'notEnoughMoney'), `Pot≈ôebuje≈° ${challenge.bet} üí∞`);
                return;
            }
            
            // Zobraz loading
            showModal('‚öîÔ∏è BOJ PROB√çH√Å...', `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; animation: swordClash 0.5s infinite;">‚öîÔ∏è</div>
                    <p style="color: #ff9800; margin-top: 1rem;">Bojuje≈° s ${escapeHtml(challenge.challenger)}...</p>
                    <div class="loading-spinner" style="margin: 1rem auto;"></div>
                </div>
                <style>
                    @keyframes swordClash { 0%,100%{transform:rotate(0)} 50%{transform:rotate(15deg)} }
                </style>
            `);
            
            try {
                const myStats = getPlayerCombatStats();
                const enemyStats = challenge.challengerStats;
                
                // Spus≈• boj
                const battleResult = await runPvPBattle(myStats, enemyStats, challenge);
                
                // V√Ωpoƒçet ELO
                const eloChange = calculateEloChange(myStats.elo, enemyStats.elo, battleResult.iWon);
                
                // Aktualizuj lok√°ln√≠ stats
                if (battleResult.iWon) {
                    state.pvp.wins++;
                    state.pvp.winStreak++;
                    state.pvp.maxWinStreak = Math.max(state.pvp.maxWinStreak, state.pvp.winStreak);
                    addMoney(challenge.bet);
                    state.pvp.maxBetWon = Math.max(state.pvp.maxBetWon, challenge.bet);
                    
                    if (battleResult.myFinalHp < myStats.maxHp * 0.1) state.pvp.comebacks++;
                    if (battleResult.myFinalHp >= myStats.maxHp) state.pvp.flawless++;
                    
                    // Denn√≠ bonus - prvn√≠ v√Ωhra dne
                    const today = new Date().toDateString();
                    if (state.pvp.lastDailyBonus !== today) {
                        state.pvp.lastDailyBonus = today;
                        addXP(50);
                        addMoney(25);
                        notifySuccess('üéÅ Denn√≠ PvP bonus!', '+50 XP, +25 üí∞');
                    }
                    
                    // Win streak bonus
                    if (state.pvp.winStreak >= 3) {
                        const streakBonus = Math.min(100, state.pvp.winStreak * 10);
                        addXP(streakBonus);
                        notifySuccess(`üî• Win streak x${state.pvp.winStreak}!`, `+${streakBonus} XP`);
                    }
                    
                    notifySuccess('‚öîÔ∏è V√çTƒöZSTV√ç!', `+${challenge.bet} üí∞ | ELO +${eloChange}`);
                } else {
                    state.pvp.losses++;
                    state.pvp.winStreak = 0;
                    removeMoney(challenge.bet);
                    
                    notifyWarning('‚öîÔ∏è Prohra', `-${challenge.bet} üí∞ | ELO ${eloChange}`);
                }
                
                state.pvp.elo = Math.max(0, state.pvp.elo + eloChange);
                state.pvp.totalDamageDealt += battleResult.myDamageDealt;
                state.pvp.totalDamageReceived += battleResult.damageTaken;
                
                // Ulo≈æ do Firebase
                await firebaseDB.ref('pvp/challenges/' + challengeId).update({
                    status: 'completed',
                    targetStats: myStats,
                    winner: battleResult.iWon ? getPlayerName() : challenge.challenger,
                    loser: battleResult.iWon ? challenge.challenger : getPlayerName(),
                    log: battleResult.log,
                    battleStats: {
                        rounds: battleResult.rounds,
                        myDamage: battleResult.myDamageDealt,
                        damageTaken: battleResult.damageTaken,
                        winnerHp: battleResult.iWon ? battleResult.myFinalHp : battleResult.enemyFinalHp
                    },
                    eloChange: Math.abs(eloChange),
                    completedAt: firebase.database.ServerValue.TIMESTAMP,
                    notified: false
                });
                
                saveGame();
                closeModal();
                
                // Zobraz v√Ωsledek okam≈æitƒõ
                const resultChallenge = {
                    ...challenge,
                    winner: battleResult.iWon ? getPlayerName() : challenge.challenger,
                    log: battleResult.log,
                    battleStats: {
                        rounds: battleResult.rounds,
                        myDamage: battleResult.myDamageDealt,
                        damageTaken: battleResult.damageTaken
                    },
                    eloChange: Math.abs(eloChange)
                };
                
                setTimeout(() => {
                    showPvPResultDirect(resultChallenge, battleResult.iWon, eloChange);
                }, 300);
                
            } catch (error) {
                console.error('PvP Error:', error);
                closeModal();
                notifyWarning('Chyba', 'Nƒõco se pokazilo: ' + error.message);
            }
        }
        
        // P≈ô√≠m√© zobrazen√≠ v√Ωsledku (ne p≈ôes listener)
        function showPvPResultDirect(challenge, iWon, eloChange) {
            const myName = getPlayerName();
            const opponent = challenge.challenger === myName ? challenge.target : challenge.challenger;
            const myNewElo = state.pvp.elo;
            const newRank = getPvPRank(myNewElo);
            const newTitles = checkPvPTitles();
            
            const html = `
                <div id="pvpResultOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.98); z-index: 99999; display: flex; align-items: center; justify-content: center; padding: 1rem; animation: pvpFadeIn 0.3s;">
                    <div style="background: linear-gradient(135deg, ${iWon ? '#1a3a1a' : '#3a1a1a'} 0%, #0a0a0a 100%); border: 2px solid ${iWon ? '#4CAF50' : '#f44336'}; border-radius: 16px; padding: 1.2rem; max-width: 340px; width: 100%; text-align: center; animation: resultBounce 0.6s;">
                        
                        <div style="font-size: 3rem; margin-bottom: 0.5rem; animation: ${iWon ? 'victoryAnim' : 'defeatAnim'} 1s;">
                            ${iWon ? 'üèÜ' : 'üíÄ'}
                        </div>
                        
                        <h2 style="color: ${iWon ? '#4CAF50' : '#f44336'}; margin: 0 0 0.3rem 0; font-size: 1.4rem; text-shadow: 0 0 20px ${iWon ? 'rgba(76,175,80,0.8)' : 'rgba(244,67,54,0.8)'};">
                            ${iWon ? 'V√çTƒöZSTV√ç!' : 'PROHRA!'}
                        </h2>
                        
                        <p style="color: #888; margin: 0.3rem 0; font-size: 0.85rem;">vs <strong style="color: #fff;">${opponent}</strong></p>
                        
                        <div style="background: ${iWon ? 'linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%)' : 'linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%)'}; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${iWon ? '#4CAF50' : '#f44336'};">
                            <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.8rem; font-weight: bold;">
                                ${iWon ? '+' : '-'}${challenge.bet} üí∞
                            </div>
                        </div>
                        
                        <div style="background: #1a1a2a; padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid ${newRank.color};">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 0.8rem;">
                                <div style="text-align: center;">
                                    <div style="color: #888; font-size: 0.7rem;">ELO</div>
                                    <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 1.2rem; font-weight: bold;">
                                        ${iWon ? '+' : ''}${eloChange}
                                    </div>
                                </div>
                                <div style="color: #555; font-size: 1.3rem;">‚Üí</div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2rem;">${newRank.icon}</div>
                                    <div style="color: ${newRank.color}; font-weight: bold; font-size: 1.1rem;">${myNewElo}</div>
                                    <div style="color: ${newRank.color}; font-size: 0.7rem;">${newRank.name}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${challenge.battleStats ? `
                            <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 8px; margin: 0.7rem 0;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem; font-size: 0.75rem;">
                                    <div><span style="color: #888;">Kola</span><br><span style="color: #fff;">${challenge.battleStats.rounds}</span></div>
                                    <div><span style="color: #888;">DMG</span><br><span style="color: #ff9800;">${challenge.battleStats.myDamage}</span></div>
                                    <div><span style="color: #888;">P≈ôijato</span><br><span style="color: #f44336;">${challenge.battleStats.damageTaken}</span></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${newTitles.length > 0 ? `
                            <div style="background: linear-gradient(135deg, #3a2a0a 0%, #2a1a00 100%); padding: 0.7rem; border-radius: 10px; margin: 0.7rem 0; border: 2px solid #ffd700;">
                                <div style="color: #ffd700; font-weight: bold; margin-bottom: 0.3rem; font-size: 0.85rem;">üèÖ NOV√ù TITUL!</div>
                                ${newTitles.map(t => `<div style="font-size: 1rem;">${t.icon} ${t.name}</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button onclick="closePvPResultAndShowLog('${challenge.id}')" style="background: #333; color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                üìú Log
                            </button>
                            <button onclick="closePvPResultAndShowArena()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: #fff; border: none; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit;">
                                ‚öîÔ∏è Dal≈°√≠
                            </button>
                        </div>
                        
                        <button onclick="document.getElementById('pvpResultOverlay')?.remove()" style="background: transparent; color: #666; border: none; padding: 0.4rem; margin-top: 0.3rem; cursor: pointer; font-family: inherit; width: 100%; font-size: 0.8rem;">
                            Zav≈ô√≠t
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            if (typeof SoundSystem !== 'undefined') SoundSystem.play(iWon ? 'victory' : 'damage');
            renderFull();
        }
        
        function closePvPResultAndShowLog(challengeId) {
            document.getElementById('pvpResultOverlay')?.remove();
            showPvPBattleLog(challengeId);
        }
        
        function closePvPResultAndShowArena() {
            document.getElementById('pvpResultOverlay')?.remove();
            showPvPArena();
        }
        
        async function declinePvPChallenge(challengeId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            await firebaseDB.ref('pvp/challenges/' + challengeId).update({
                status: 'declined'
            });
            
            notifySuccess('V√Ωzva odm√≠tnuta', '');
            showPvPArena();
        }
        
        function showPvPArena() {
            initPvPStats();
            
            if (!multiplayerEnabled) {
                showModal('‚öîÔ∏è PvP AR√âNA', `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üèüÔ∏è</div>
                        <h3 style="color: #ff9800;">Multiplayer nen√≠ aktivn√≠</h3>
                        <p style="color: #888; margin-top: 0.5rem;">Zapni multiplayer pro p≈ô√≠stup do ar√©ny.</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>
                `);
                return;
            }
            
            const myName = getPlayerName();
            const myStats = getPlayerCombatStats();
            const myRank = getPvPRank(state.pvp?.elo || 1000);
            const totalGames = (state.pvp?.wins || 0) + (state.pvp?.losses || 0);
            const winRate = totalGames > 0 ? Math.round((state.pvp.wins / totalGames) * 100) : 0;
            
            // Moje v√Ωzvy
            const pendingForMe = pvpChallenges.filter(c => c.target === myName && c.status === 'pending');
            const myPending = pvpChallenges.filter(c => c.challenger === myName && c.status === 'pending');
            
            // Denn√≠ bonus - lze z√≠skat 1x dennƒõ za prvn√≠ boj
            const today = new Date().toDateString();
            const hadDailyBonus = state.pvp?.lastDailyBonus === today;
            
            let html = `
                <!-- üéñÔ∏è PLAYER CARD -->
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 1.2rem; border-radius: 15px; margin-bottom: 1rem; border: 2px solid ${myRank.color}; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; width: 120px; height: 120px; background: radial-gradient(circle, ${myRank.color}33 0%, transparent 70%);"></div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; position: relative; z-index: 1;">
                        <div style="font-size: 2.5rem; filter: drop-shadow(0 0 10px ${myRank.color});">${myRank.icon}</div>
                        <div style="flex: 1;">
                            <div style="color: ${myRank.color}; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px;">${myRank.name}</div>
                            <div style="color: #fff; font-size: 1.2rem; font-weight: bold;">${myName}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${myRank.color}; font-size: 2rem; font-weight: bold; text-shadow: 0 0 10px ${myRank.color};">${state.pvp?.elo || 1000}</div>
                            <div style="color: #888; font-size: 0.7rem;">ELO RATING</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; background: rgba(0,0,0,0.3); padding: 0.6rem; border-radius: 8px;">
                        <div style="text-align: center;"><div style="color: #8bc34a; font-weight: bold;">${state.pvp?.wins || 0}</div><div style="color: #666; font-size: 0.65rem;">WINS</div></div>
                        <div style="text-align: center;"><div style="color: #f44336; font-weight: bold;">${state.pvp?.losses || 0}</div><div style="color: #666; font-size: 0.65rem;">LOSSES</div></div>
                        <div style="text-align: center;"><div style="color: #ffd700; font-weight: bold;">${winRate}%</div><div style="color: #666; font-size: 0.65rem;">WINRATE</div></div>
                        <div style="text-align: center;"><div style="color: #ff9800; font-weight: bold;">üî•${state.pvp?.winStreak || 0}</div><div style="color: #666; font-size: 0.65rem;">STREAK</div></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.3rem; margin-top: 0.6rem; text-align: center; font-size: 0.8rem;">
                        <div><span style="color: #ff6b6b;">‚ù§Ô∏è</span>${myStats.hp}</div>
                        <div><span style="color: #ff9800;">‚öîÔ∏è</span>${myStats.damage}</div>
                        <div><span style="color: #2196f3;">üõ°Ô∏è</span>${myStats.defense}</div>
                        <div><span style="color: #e91e63;">üí•</span>${myStats.critChance}%</div>
                        <div><span style="color: #8bc34a;">üí®</span>${myStats.dodgeChance}%</div>
                    </div>
                </div>
                
                <!-- üéÅ DENN√ç BONUS -->
                ${!hadDailyBonus ? `
                <div style="background: linear-gradient(135deg, #3a3a0a 0%, #2a2a00 100%); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ffd700; animation: goldPulse 2s infinite;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="color: #ffd700; font-weight: bold;">üéÅ Denn√≠ PvP bonus!</div>
                            <div style="color: #888; font-size: 0.8rem;">Zahraj si dnes a z√≠skej +50 XP a +25 üí∞</div>
                        </div>
                        <div style="color: #ffd700; font-size: 1.5rem;">üéØ</div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // V√Ωzvy pro mƒõ
            if (pendingForMe.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #3a2a1a 0%, #2a1a0a 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #ff9800; animation: challengePulse 2s infinite;">
                        <h4 style="color: #ff9800; margin: 0 0 0.8rem 0;">‚öîÔ∏è V√Ωzvy k boji (${pendingForMe.length})</h4>
                `;
                pendingForMe.forEach(challenge => {
                    const challengerRank = getPvPRank(challenge.challengerStats?.elo || 1000);
                    html += `
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; margin-bottom: 0.5rem; border-left: 4px solid ${challengerRank.color};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.3rem;">${challengerRank.icon}</span>
                                    <div>
                                        <div style="color: #fff; font-weight: bold;">${escapeHtml(challenge.challenger)}</div>
                                        <div style="font-size: 0.75rem; color: ${challengerRank.color};">${challengerRank.name} ‚Ä¢ ELO ${challenge.challengerStats?.elo || 1000}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #ffd700; font-weight: bold; font-size: 1.2rem;">${challenge.bet} üí∞</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; font-size: 0.75rem; margin-bottom: 0.5rem; background: #0a0a0a; padding: 0.4rem; border-radius: 6px;">
                                <div>‚ù§Ô∏è${challenge.challengerStats?.hp || '?'}</div>
                                <div>‚öîÔ∏è${challenge.challengerStats?.damage || '?'}</div>
                                <div>üõ°Ô∏è${challenge.challengerStats?.defense || '?'}</div>
                                <div>Lvl ${challenge.challengerStats?.level || '?'}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="btn" onclick="acceptPvPChallenge('${challenge.id}')" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%); padding: 0.7rem;">‚öîÔ∏è BOJOVAT!</button>
                                <button class="btn" onclick="declinePvPChallenge('${challenge.id}')" style="background: #444;">‚ùå Odm√≠tnout</button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>
                <style>
                    @keyframes challengePulse { 0%, 100% { box-shadow: 0 0 5px rgba(255,152,0,0.3); } 50% { box-shadow: 0 0 20px rgba(255,152,0,0.6); } }
                </style>`;
            }
            
            // Moje odeslan√© v√Ωzvy
            if (myPending.length > 0) {
                html += `<div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #888; margin: 0 0 0.5rem 0;">‚è≥ ƒåekaj√≠c√≠ v√Ωzvy</h4>`;
                myPending.forEach(challenge => {
                    if (!challenge.target) return;
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem; background: #0a0a0a; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="color: #888;">‚Üí ${escapeHtml(challenge.target) || '???'}</span>
                            <span style="color: #ffd700;">${challenge.bet || 0} üí∞</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // HLAVN√ç MENU TLAƒå√çTKA
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="showChallengePlayer()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem; border-radius: 12px;">
                        <div style="font-size: 1.5rem;">‚öîÔ∏è</div>
                        <div style="font-size: 0.85rem; font-weight: bold;">Vyzvat hr√°ƒçe</div>
                    </button>
                    <button class="btn" onclick="showQuickMatchmaking()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 1rem; border-radius: 12px;">
                        <div style="font-size: 1.5rem;">üé≤</div>
                        <div style="font-size: 0.85rem; font-weight: bold;">Rychl√Ω souboj</div>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button class="btn" onclick="showPvPLeaderboard()" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); color: #000; padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">üèÜ</div>
                        <div style="font-size: 0.75rem;">≈Ωeb≈ô√≠ƒçek</div>
                    </button>
                    <button class="btn" onclick="showPvPTitles()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">üèÖ</div>
                        <div style="font-size: 0.75rem;">Tituly</div>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showPvPMyBuild()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">üë§</div>
                        <div style="font-size: 0.75rem;">Moje postava</div>
                    </button>
                    <button class="btn" onclick="showPvPHistory()" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 0.8rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem;">üìú</div>
                        <div style="font-size: 0.75rem;">Historie</div>
                    </button>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; background: #333;">‚Üê Zav≈ô√≠t</button>
            `;
            
            showModal('‚öîÔ∏è PvP AR√âNA', html);
        }
        
        // üé≤ RYCHL√ù MATCHMAKING - najde n√°hodn√©ho soupe≈ôe podobn√©ho ELO
        async function showQuickMatchmaking() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            initPvPStats();
            const myName = getPlayerName();
            const myElo = state.pvp?.elo || 1000;
            
            showModal('üé≤ Hled√°m soupe≈ôe...', `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; animation: spin 1s linear infinite;">üé≤</div>
                    <p style="color: #9c27b0; margin-top: 1rem;">Hled√°m soupe≈ôe s podobn√Ωm ELO...</p>
                    <p style="color: #666; font-size: 0.85rem;">Tv√© ELO: ${myElo}</p>
                    <div class="loading-spinner" style="margin: 1rem auto;"></div>
                </div>
                <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
            `);
            
            try {
                // Naƒçti online hr√°ƒçe - pou≈æij kl√≠ƒç jako fallback pro jm√©no
                const snapshot = await firebaseDB.ref('online').once('value');
                const onlineData = snapshot.val() || {};
                const onlinePlayers = Object.entries(onlineData)
                    .map(([key, val]) => ({
                        name: val?.name || key,
                        level: val?.level || 1
                    }))
                    .filter(p => p.name && p.name !== myName && p.name !== 'undefined');
                
                if (onlinePlayers.length === 0) {
                    showModal('üé≤ Rychl√Ω souboj', `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üòî</div>
                            <p style="color: #888;">≈Ω√°dn√≠ online hr√°ƒçi...</p>
                            <p style="color: #666; font-size: 0.85rem;">Zkus to pozdƒõji nebo vyzvi p≈ô√≠tele!</p>
                        </div>
                        <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>
                    `);
                    return;
                }
                
                // Naƒçti ELO v≈°ech hr√°ƒç≈Ø
                const leaderboardSnap = await firebaseDB.ref('leaderboard').once('value');
                const leaderboardData = leaderboardSnap.val() || {};
                
                // P≈ôi≈ôaƒè ELO k online hr√°ƒç≈Øm a se≈ôaƒè podle vzd√°lenosti od m√©ho ELO
                const playersWithElo = onlinePlayers.map(p => {
                    const playerData = leaderboardData[p.name] || {};
                    return {
                        ...p,
                        elo: playerData.pvpElo || 1000,
                        level: playerData.level || p.level || 1
                    };
                }).sort((a, b) => Math.abs(a.elo - myElo) - Math.abs(b.elo - myElo));
                
                // Vyber n√°hodnƒõ z top 3 nejbli≈æ≈°√≠ch (nebo m√©nƒõ pokud jich je m√©nƒõ)
                const candidates = playersWithElo.slice(0, Math.min(3, playersWithElo.length));
                const opponent = candidates[Math.floor(Math.random() * candidates.length)];
                const opponentRank = getPvPRank(opponent.elo);
                
                // Doporuƒçen√° s√°zka podle ELO
                const suggestedBet = Math.min(500, Math.floor(myElo / 10));
                
                setTimeout(() => {
                    showModal('üé≤ Soupe≈ô nalezen!', `
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2rem; animation: foundAnim 0.5s;">üéØ</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #2a1a3a 0%, #1a0a2a 100%); padding: 1.2rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid ${opponentRank.color};">
                            <div style="text-align: center; margin-bottom: 0.8rem;">
                                <div style="font-size: 2rem;">${opponentRank.icon}</div>
                                <div style="color: ${opponentRank.color}; font-size: 0.8rem;">${opponentRank.name}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${escapeHtml(opponent.name)}</div>
                                <div style="color: #888; font-size: 0.85rem;">Level ${opponent.level} ‚Ä¢ ELO: <span style="color: ${opponentRank.color};">${opponent.elo}</span></div>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.8rem; color: #888; font-size: 0.85rem;">
                                <span>ELO rozd√≠l: <span style="color: ${Math.abs(opponent.elo - myElo) < 100 ? '#4CAF50' : '#ff9800'};">${opponent.elo > myElo ? '+' : ''}${opponent.elo - myElo}</span></span>
                            </div>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                            <label style="color: #888; font-size: 0.85rem;">S√°zka (0 = p≈ô√°telsk√Ω z√°pas):</label>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="number" id="quickMatchBet" value="${suggestedBet}" min="0" max="${getMoney()}" 
                                    style="flex: 1; padding: 0.6rem; background: #0a0a0a; border: 1px solid #444; border-radius: 8px; color: #ffd700; font-size: 1.1rem; text-align: center;">
                                <button onclick="document.getElementById('quickMatchBet').value='0'" style="background: #333; border: none; padding: 0.6rem 1rem; border-radius: 8px; color: #888; cursor: pointer;">0</button>
                                <button onclick="document.getElementById('quickMatchBet').value='${Math.floor(getMoney()/2)}'" style="background: #333; border: none; padding: 0.6rem 1rem; border-radius: 8px; color: #888; cursor: pointer;">50%</button>
                            </div>
                            <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">Tv√© pen√≠ze: ${getMoney()} üí∞</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <button class="btn" onclick="showQuickMatchmaking()" style="background: #555;">üîÑ Jin√Ω</button>
                            <button class="btn" onclick="sendQuickChallenge('${escapeHtml(opponent.name)}')" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">‚öîÔ∏è Vyzvat!</button>
                        </div>
                        
                        <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 0.5rem; background: #333;">‚Üê Zpƒõt</button>
                        
                        <style>@keyframes foundAnim { 0% { transform: scale(0) rotate(-180deg); } 100% { transform: scale(1) rotate(0); } }</style>
                    `);
                }, 1500);
                
            } catch (e) {
                console.error('Matchmaking error:', e);
                showPvPArena();
            }
        }
        
        function sendQuickChallenge(targetName) {
            const bet = parseInt(document.getElementById('quickMatchBet')?.value) || 0;
            if (bet > getMoney()) {
                notifyWarning('Nedostatek penƒõz', `M√°≈° jen ${getMoney()} üí∞`);
                return;
            }
            createPvPChallenge(targetName, bet);
            closeModal();
        }
        
        // üë§ ZOBRAZEN√ç BUILDU POSTAVY PRO PvP
        function showPvPMyBuild() {
            const stats = getPlayerCombatStats();
            const rank = getPvPRank(stats.elo);
            
            let html = `
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid ${rank.color};">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2rem;">${rank.icon}</div>
                        <div style="color: ${rank.color}; font-weight: bold;">${stats.className}</div>
                        <div style="color: #fff; font-size: 1.2rem;">Level ${stats.level}</div>
                    </div>
                </div>
                
                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">‚öîÔ∏è Bojov√© statistiky</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">‚ù§Ô∏è HP</span>
                            <span style="color: #ff6b6b; font-weight: bold;">${stats.maxHp}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">‚öîÔ∏è √ötok</span>
                            <span style="color: #ff9800; font-weight: bold;">${stats.damage}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">üõ°Ô∏è Obrana</span>
                            <span style="color: #2196f3; font-weight: bold;">${stats.defense}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">üí• Crit</span>
                            <span style="color: #e91e63; font-weight: bold;">${stats.critChance}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">üí® √öhyb</span>
                            <span style="color: #8bc34a; font-weight: bold;">${stats.dodgeChance}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.3rem; background: #0a0a0a; border-radius: 6px;">
                            <span style="color: #888;">üõ°Ô∏è Blok</span>
                            <span style="color: #9c27b0; font-weight: bold;">${stats.blockChance}%</span>
                        </div>
                    </div>
                </div>
                
                <h4 style="color: #4CAF50; margin: 0 0 0.5rem 0;">üéí Vybaven√≠</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
            `;
            
            const equipSlots = [
                { key: 'weapon', icon: '‚öîÔ∏è', name: 'Zbra≈à' },
                { key: 'armor', icon: 'üõ°Ô∏è', name: 'Brnƒõn√≠' },
                { key: 'helmet', icon: 'ü™ñ', name: 'Helma' },
                { key: 'gloves', icon: 'üß§', name: 'Rukavice' },
                { key: 'boots', icon: 'üë¢', name: 'Boty' }
            ];
            
            equipSlots.forEach(slot => {
                const item = stats.equipped?.[slot.key];
                const special = item?.special ? SPECIAL_EFFECT_DETAILS[item.special] : null;
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: #0a0a0a; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.2rem;">${slot.icon}</span>
                        <div style="flex: 1;">
                            <div style="color: ${item ? '#fff' : '#555'};">${item?.name || '≈Ω√°dn√©'}</div>
                            ${special ? `<div style="color: ${special.color}; font-size: 0.7rem;">‚ú® ${special.name}</div>` : ''}
                        </div>
                        ${item?.damage ? `<span style="color: #ff9800; font-size: 0.8rem;">+${item.damage} ‚öîÔ∏è</span>` : ''}
                        ${item?.defense ? `<span style="color: #2196f3; font-size: 0.8rem;">+${item.defense} üõ°Ô∏è</span>` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // Speci√°ln√≠ bonusy
            const bonuses = [];
            if (stats.hasPhoenix) bonuses.push({ icon: 'üî•', name: 'F√©nix', desc: 'P≈ôe≈æije≈° 1x smrteln√Ω z√°sah' });
            if (stats.hasTitanArmor) bonuses.push({ icon: 'üóø', name: 'Tit√°n', desc: 'Imunita na kritick√© z√°sahy' });
            if (stats.lifesteal > 0) bonuses.push({ icon: 'üßõ', name: 'Vys√°t√≠ ≈æivota', desc: `+${stats.lifesteal}% HP z damage` });
            if (stats.regenPerRound > 0) bonuses.push({ icon: 'üíö', name: 'Nano regenerace', desc: `+${stats.regenPerRound} HP/kolo` });
            if (stats.hasBerserkerBlood) bonuses.push({ icon: 'üò§', name: 'Krev berserkera', desc: '+25% DMG pod 50% HP' });
            if (stats.hasPoisonPunch) bonuses.push({ icon: 'ü©∏', name: 'Krvav√Ω √∫der', desc: 'Zp≈Øsobuje krv√°cen√≠' });
            
            if (bonuses.length > 0) {
                html += `<h4 style="color: #e91e63; margin: 0 0 0.5rem 0;">‚ú® Speci√°ln√≠ bonusy v PvP</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">`;
                bonuses.forEach(b => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: #1a2a1a; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid #4CAF50;">
                            <span style="font-size: 1.2rem;">${b.icon}</span>
                            <div>
                                <div style="color: #8bc34a; font-weight: bold;">${b.name}</div>
                                <div style="color: #888; font-size: 0.75rem;">${b.desc}</div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Mutace
            if (stats.mutations && stats.mutations.length > 0) {
                html += `<h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">üß¨ Aktivn√≠ mutace</h4>
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">`;
                stats.mutations.forEach(m => {
                    html += `<span style="background: #1a3a1a; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; color: #8bc34a;">üß¨ ${m}</span>`;
                });
                html += `</div></div>`;
            }
            
            html += `
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <p style="color: #888; font-size: 0.85rem; margin: 0; text-align: center;">
                        üí° <strong>Tip:</strong> Vylep≈°i sv√© vybaven√≠, zvedni atributy a z√≠skej mutace pro silnƒõj≈°√≠ PvP postavu!
                    </p>
                </div>
                
                <button class="btn" onclick="showPvPArena()" style="width: 100%; background: #333;">‚Üê Zpƒõt do ar√©ny</button>
            `;
            
            showModal('üë§ Moje PvP postava', html);
        }
        
        // üìú HISTORIE PvP Z√ÅPAS≈Æ
        async function showPvPHistory() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            showModal('üìú Historie PvP', '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div></div>');
            
            try {
                const myName = getPlayerName();
                const snap = await firebaseDB.ref('pvp/challenges')
                    .orderByChild('completedAt')
                    .limitToLast(20)
                    .once('value');
                
                const allChallenges = [];
                snap.forEach(child => {
                    const c = child.val();
                    if (c.status === 'completed' && (c.challenger === myName || c.target === myName)) {
                        allChallenges.push({ ...c, id: child.key });
                    }
                });
                
                // Se≈ôaƒè od nejnovƒõj≈°√≠ch
                allChallenges.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
                
                if (allChallenges.length === 0) {
                    showModal('üìú Historie PvP', `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">üìú</div>
                            <p style="color: #888;">Zat√≠m ≈æ√°dn√© z√°pasy...</p>
                            <p style="color: #666; font-size: 0.85rem;">Vyzvi nƒõkoho k souboji!</p>
                        </div>
                        <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>
                    `);
                    return;
                }
                
                let html = `<div style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                allChallenges.slice(0, 15).forEach(c => {
                    const iWon = c.winner === myName;
                    const opponent = c.challenger === myName ? c.target : c.challenger;
                    const date = c.completedAt ? new Date(c.completedAt).toLocaleDateString('cs-CZ') : '?';
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: ${iWon ? '#1a2a1a' : '#2a1a1a'}; border-radius: 10px; margin-bottom: 0.5rem; border-left: 4px solid ${iWon ? '#4CAF50' : '#f44336'};">
                            <div style="font-size: 1.5rem;">${iWon ? 'üèÜ' : 'üíÄ'}</div>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-weight: bold;">${iWon ? 'V√Ωhra' : 'Prohra'} vs ${escapeHtml(opponent)}</div>
                                <div style="color: #888; font-size: 0.75rem;">${date} ‚Ä¢ ${c.battleStats?.rounds || '?'} kol</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-weight: bold;">${iWon ? '+' : '-'}${c.bet || 0} üí∞</div>
                                <div style="color: ${iWon ? '#8bc34a' : '#ff6b6b'}; font-size: 0.8rem;">${iWon ? '+' : '-'}${c.eloChange || 0} ELO</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // Statistiky
                const wins = allChallenges.filter(c => c.winner === myName).length;
                const losses = allChallenges.length - wins;
                const totalEarned = allChallenges.filter(c => c.winner === myName).reduce((sum, c) => sum + (c.bet || 0), 0);
                const totalLost = allChallenges.filter(c => c.winner !== myName).reduce((sum, c) => sum + (c.bet || 0), 0);
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.3rem; margin-top: 1rem; background: #1a1a1a; padding: 0.8rem; border-radius: 10px; text-align: center; font-size: 0.8rem;">
                        <div><span style="color: #8bc34a; font-weight: bold;">${wins}</span><br><span style="color: #666;">V√Ωher</span></div>
                        <div><span style="color: #f44336; font-weight: bold;">${losses}</span><br><span style="color: #666;">Proher</span></div>
                        <div><span style="color: #8bc34a; font-weight: bold;">+${totalEarned}</span><br><span style="color: #666;">Z√≠sk√°no</span></div>
                        <div><span style="color: #f44336; font-weight: bold;">-${totalLost}</span><br><span style="color: #666;">Ztraceno</span></div>
                    </div>
                `;
                
                html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt</button>`;
                
                showModal('üìú Historie PvP', html);
                
            } catch (e) {
                console.error('History error:', e);
                showPvPArena();
            }
        }
        
        async function showChallengePlayer() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Naƒçti online hr√°ƒçe
            const snapshot = await firebaseDB.ref('online').once('value');
            const onlineData = snapshot.val() || {};
            const myName = getPlayerName();
            
            // P≈ôeveƒè na pole s kl√≠ƒçem jako fallback pro jm√©no
            const onlinePlayers = Object.entries(onlineData)
                .map(([key, val]) => ({
                    name: val?.name || key,  // Pou≈æij name nebo kl√≠ƒç jako fallback
                    level: val?.level || 1,
                    location: val?.location || 'unknown'
                }))
                .filter(p => p.name && p.name !== myName && p.name !== 'undefined');
            
            if (onlinePlayers.length === 0) {
                showModal('üéØ Vyzvat hr√°ƒçe', `
                    <div style="text-align: center; padding: 2rem; color: #888;">
                        ≈Ω√°dn√≠ online hr√°ƒçi k v√Ωzvƒõ...
                    </div>
                    <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;">Zpƒõt</button>
                `);
                return;
            }
            
            let html = `
                <p style="color: #888; margin-bottom: 1rem;">Vyber hr√°ƒçe a nastav s√°zku:</p>
                <div style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 1rem;">
            `;
            
            onlinePlayers.forEach(player => {
                const safeName = escapeHtml(player.name);
                html += `
                    <div onclick="selectPvPTarget('${safeName}')" id="pvp-${safeName}" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; background: #2a2a2a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border: 2px solid transparent;">
                        <span style="color: #8bc34a;">üü¢</span>
                        <div style="flex: 1;">
                            <div style="color: #fff;">${safeName}</div>
                            <div style="font-size: 0.75rem; color: #888;">Lvl ${player.level}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>
                <div style="margin-bottom: 1rem; text-align: center;">
                    <div style="color: #4CAF50; font-size: 1rem; padding: 0.5rem; background: #1a2a1a; border-radius: 8px;">
                        ‚öîÔ∏è PvP souboj je ZDARMA!
                    </div>
                </div>
                
                <button class="btn" onclick="confirmPvPChallenge()" id="pvpChallengeBtn" style="width: 100%; background: #555;" disabled>
                    üéØ VYBER HR√ÅƒåE
                </button>
                <button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 0.5rem; background: #333;">Zpƒõt</button>
            `;
            
            showModal('üéØ Vyzvat k souboji', html);
        }
        
        let selectedPvPTarget = null;
        
        function selectPvPTarget(name) {
            selectedPvPTarget = name;
            
            // Vizu√°ln√≠ feedback
            document.querySelectorAll('[id^="pvp-"]').forEach(el => {
                el.style.borderColor = 'transparent';
                el.style.background = '#2a2a2a';
            });
            
            const selected = document.getElementById('pvp-' + name);
            if (selected) {
                selected.style.borderColor = '#ff5722';
                selected.style.background = '#3a2a1a';
            }
            
            const btn = document.getElementById('pvpChallengeBtn');
            if (btn) {
                btn.disabled = false;
                btn.style.background = '#ff5722';
                btn.textContent = `‚öîÔ∏è Vyzvat ${name}`;
            }
        }
        
        function confirmPvPChallenge() {
            if (!selectedPvPTarget) return;
            
            // PvP je zdarma - bez s√°zky
            createPvPChallenge(selectedPvPTarget, 0);
            closeModal();
        }
        
        // üèÜ PvP LEADERBOARD
        async function showPvPLeaderboard() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('üèÜ PvP ≈Ωeb≈ô√≠ƒçek', '<p style="color: #888; text-align: center;">' + ('Multiplayer nen√≠ aktivn√≠') + '</p><button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem;">' + ('Zpƒõt') + '</button>');
                return;
            }
            
            try {
                const snapshot = await firebaseDB.ref('leaderboard').orderByChild('pvpElo').limitToLast(20).once('value');
                const players = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if (data.pvpElo) players.push(data);
                });
                players.sort((a, b) => (b.pvpElo || 0) - (a.pvpElo || 0));
                
                let html = `
                    <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        ${players.length === 0 ? '<p style="color: #888; text-align: center;">Zat√≠m ≈æ√°dn√≠ hr√°ƒçi</p>' : ''}
                        ${players.map((p, i) => {
                            const rank = getPvPRank(p.pvpElo || 1000);
                            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
                            const isMe = p.name === getPlayerName();
                            return `
                                <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: ${isMe ? 'linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%)' : '#1a1a1a'}; border-radius: 10px; margin-bottom: 0.5rem; border: ${isMe ? '2px solid #4CAF50' : '1px solid #333'};">
                                    <div style="font-size: 1.3rem; min-width: 35px; text-align: center;">${medal}</div>
                                    <div style="font-size: 1.5rem;">${rank.icon}</div>
                                    <div style="flex: 1;">
                                        <div style="color: #fff; font-weight: bold;">${escapeHtml(p.name)}${isMe ? ' (Ty)' : ''}</div>
                                        <div style="color: ${rank.color}; font-size: 0.8rem;">${rank.name}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: ${rank.color}; font-size: 1.3rem; font-weight: bold;">${p.pvpElo || 1000}</div>
                                        <div style="color: #888; font-size: 0.7rem;">ELO</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt do ar√©ny</button>`;
                showModal('üèÜ PvP ≈Ωeb≈ô√≠ƒçek', html);
            } catch (err) {
                console.error(err);
                showModal('üèÜ PvP ≈Ωeb≈ô√≠ƒçek', '<p style="color: #f44336;">' + ('Chyba naƒç√≠t√°n√≠') + '</p><button class="btn" onclick="showPvPArena()" style="width: 100%;">' + ('Zpƒõt') + '</button>');
            }
        }
        
        // ‚ú® PvP ABILITIES MENU
        function showPvPAbilities() {
            initPvPStats();
            const selectedAbilities = state.pvp?.selectedAbilities || ['powerStrike', 'dodge', 'heal', 'stun'];
            
            const categories = {
                attack: { name: '‚öîÔ∏è √ötoƒçn√©', abilities: [] },
                defense: { name: 'üõ°Ô∏è Obrann√©', abilities: [] },
                special: { name: '‚ú® Speci√°ln√≠', abilities: [] }
            };
            
            Object.entries(PVP_ABILITIES).forEach(([id, ability]) => {
                if (ability.type && categories[ability.type]) {
                    categories[ability.type].abilities.push({ id, ...ability });
                }
            });
            
            let html = `
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">Vyber 4 schopnosti pro PvP boj:</p>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="color: #ffd700; font-size: 0.8rem; margin-bottom: 0.5rem;">VYBRAN√â SCHOPNOSTI:</div>
                    <div id="selectedAbilitiesDisplay" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${selectedAbilities.map(id => {
                            const ab = PVP_ABILITIES[id];
                            return ab ? `<div style="background: #2a2a2a; padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.85rem;">${ab.icon} ${ab.name}</div>` : '';
                        }).join('')}
                    </div>
                </div>
            `;
            
            Object.entries(categories).forEach(([catId, cat]) => {
                if (cat.abilities.length === 0) return;
                html += `<h4 style="color: #888; margin: 1rem 0 0.5rem 0; font-size: 0.9rem;">${cat.name}</h4>`;
                html += `<div style="display: grid; gap: 0.4rem;">`;
                cat.abilities.forEach(ab => {
                    const isSelected = selectedAbilities.includes(ab.id);
                    html += `
                        <div onclick="togglePvPAbility('${ab.id}')" style="cursor: pointer; display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; background: ${isSelected ? '#1a3a1a' : '#1a1a1a'}; border-radius: 8px; border: 2px solid ${isSelected ? '#4CAF50' : 'transparent'};">
                            <div style="font-size: 1.5rem;">${ab.icon}</div>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-size: 0.9rem;">${ab.name}</div>
                                <div style="color: #888; font-size: 0.75rem;">${ab.desc} ‚Ä¢ CD: ${ab.cooldown || 0}</div>
                            </div>
                            <div style="color: ${isSelected ? '#4CAF50' : '#555'}; font-size: 1.2rem;">${isSelected ? '‚úì' : '‚óã'}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            });
            
            html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê ${'Zpƒõt'}</button>`;
            showModal('‚ú® PvP Schopnosti', html);
        }
        
        function togglePvPAbility(abilityId) {
            initPvPStats();
            const selected = state.pvp.selectedAbilities || [];
            const index = selected.indexOf(abilityId);
            
            if (index > -1) {
                selected.splice(index, 1);
            } else if (selected.length < 4) {
                selected.push(abilityId);
            } else {
                notifyWarning('Maximum 4 schopnosti', 'Odeber nƒõjakou schopnost');
                return;
            }
            
            state.pvp.selectedAbilities = selected;
            saveGame();
            showPvPAbilities();
        }
        
        // üèÖ PvP TITLES
        function showPvPTitles() {
            initPvPStats();
            const earnedTitles = state.pvp?.titles || [];
            
            let html = `
                <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">Z√≠skej tituly za PvP √∫spƒõchy:</p>
                
                <div style="display: grid; gap: 0.5rem;">
            `;
            
            PVP_TITLES.forEach(title => {
                const isEarned = earnedTitles.includes(title.id);
                html += `
                    <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; background: ${isEarned ? 'linear-gradient(135deg, #3a3a0a 0%, #2a2a00 100%)' : '#1a1a1a'}; border-radius: 10px; border: 2px solid ${isEarned ? '#ffd700' : 'transparent'}; ${!isEarned ? 'opacity: 0.6;' : ''}">
                        <div style="font-size: 2rem; ${!isEarned ? 'filter: grayscale(100%);' : ''}">${title.icon}</div>
                        <div style="flex: 1;">
                            <div style="color: ${isEarned ? '#ffd700' : '#888'}; font-weight: bold;">${title.name}</div>
                            <div style="color: #666; font-size: 0.8rem;">${title.req}</div>
                        </div>
                        <div style="color: ${isEarned ? '#4CAF50' : '#555'}; font-size: 1.3rem;">${isEarned ? '‚úì' : 'üîí'}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
            html += `
                <div style="margin-top: 1rem; padding: 0.8rem; background: #1a1a1a; border-radius: 8px; text-align: center;">
                    <span style="color: #ffd700;">üèÖ ${earnedTitles.length}</span>
                    <span style="color: #888;"> / ${PVP_TITLES.length} titul≈Ø z√≠sk√°no</span>
                </div>
            `;
            html += `<button class="btn" onclick="showPvPArena()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê ${'Zpƒõt'}</button>`;
            
            showModal('üèÖ PvP Tituly', html);
        }
        
        // Aktualizace leaderboardu s PvP ELO
        async function submitPvPScore() {
            if (!multiplayerEnabled || !firebaseDB) return;
            initPvPStats();
            
            const playerName = getPlayerName();
            try {
                await firebaseDB.ref('leaderboard/' + playerName).update({
                    pvpElo: state.pvp.elo,
                    pvpWins: state.pvp.wins,
                    pvpLosses: state.pvp.losses
                });
            } catch (err) {
                console.error('PvP score update error:', err);
            }
        }
        
        // === MULTIPLAYER TLAƒå√çTKO V MENU ===
        // === MULTIPLAYER TAB RENDERER ===
        function renderMultiplayerTab() {
            const isActive = multiplayerEnabled;
            const myName = getPlayerName();
            const myScore = calculateMultiplayerScore();
            
            // Poƒçet ƒçekaj√≠c√≠ch PvP v√Ωzev
            const pendingChallenges = pvpChallenges.filter(c => c.target === myName && c.status === 'pending').length;
            
            // Poƒçet nov√Ωch zpr√°v (posledn√≠ minuta)
            const recentMessages = chatMessages.filter(m => m.timestamp > Date.now() - 60000 && m.author !== myName).length;
            
            // Poƒçet nep≈ôeƒçten√Ωch soukrom√Ωch zpr√°v (pou≈æij glob√°ln√≠ promƒõnnou)
            let unreadPrivateMessages = unreadPMCount || 0;
            
            const hubTexts = {
                title: 'üåê ONLINE HUB', connected: '‚úÖ P≈ôipojeno k serveru', offline: '‚ö†Ô∏è Offline - zkontroluj p≈ôipojen√≠',
                yourName: 'Tv√© jm√©no:', score: 'SK√ìRE', level: 'LEVEL', kills: 'ZABIT√ç',
                leaderboard: '≈Ωeb≈ô√≠ƒçek', topPlayers: 'Top hr√°ƒçi', chat: 'Chat', messages: 'zpr√°v',
                marketplace: 'Tr≈æi≈°tƒõ', offers: 'nab√≠dek', pvpArena: 'PvP Ar√©na', battles: 'Souboje',
                quickActions: 'Rychl√© akce', submitScore: 'Odeslat sk√≥re', refreshData: 'Obnovit data',
                recentMessages: 'Posledn√≠ zpr√°vy'
            };
            
            return `
                <!-- HEADER -->
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a3a 100%); padding: 1.2rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #9c27b0; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; right: 0; width: 150px; height: 150px; background: radial-gradient(circle, rgba(156,39,176,0.2) 0%, transparent 70%);"></div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h2 style="margin: 0; color: #e1bee7; text-shadow: 0 0 10px rgba(156,39,176,0.5);">${hubTexts.title}</h2>
                            <p style="margin: 0.3rem 0 0 0; color: #888; font-size: 0.85rem;">
                                ${isActive ? hubTexts.connected : hubTexts.offline}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #888; font-size: 0.75rem;">${hubTexts.yourName}</div>
                            <div style="color: #e1bee7; font-weight: bold;">
                                ${myName}
                            </div>
                        </div>
                    </div>
                    
                    <!-- STATS -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 1rem;">
                        <div style="background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 8px; text-align: center;">
                            <div style="color: #888; font-size: 0.7rem;">${hubTexts.score}</div>
                            <div style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">${myScore.toLocaleString()}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 8px; text-align: center;">
                            <div style="color: #888; font-size: 0.7rem;">${hubTexts.level}</div>
                            <div style="color: #8bc34a; font-size: 1.1rem; font-weight: bold;">${state.char.level}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 8px; text-align: center;">
                            <div style="color: #888; font-size: 0.7rem;">${hubTexts.kills}</div>
                            <div style="color: #ff6b6b; font-size: 1.1rem; font-weight: bold;">${state.stats?.kills || 0}</div>
                        </div>
                    </div>
                </div>
                
                <!-- MAIN BUTTONS - 2x2 grid -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.6rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showLeaderboard()" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); color: #000; padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.3rem;">
                        <span style="font-size: 1.8rem;">üèÜ</span>
                        <span style="font-weight: bold; font-size: 0.85rem;">${hubTexts.leaderboard}</span>
                        <span style="font-size: 0.7rem; opacity: 0.8;">${hubTexts.topPlayers}</span>
                    </button>
                    
                    <button class="btn" onclick="showFactionHub()" style="background: linear-gradient(135deg, ${getPlayerFaction() ? PVP_FACTIONS[getPlayerFaction()].color : '#607d8b'} 0%, ${getPlayerFaction() ? PVP_FACTIONS[getPlayerFaction()].color + '99' : '#455a64'} 100%); padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.3rem;">
                        <span style="font-size: 1.8rem;">${getPlayerFaction() ? PVP_FACTIONS[getPlayerFaction()].icon : 'üè¥'}</span>
                        <span style="font-weight: bold; font-size: 0.85rem;">Frakce</span>
                        <span style="font-size: 0.7rem; opacity: 0.8;">${getPlayerFaction() ? PVP_FACTIONS[getPlayerFaction()].name : 'Vyber frakci!'}</span>
                    </button>
                    
                    <button class="btn" onclick="showChatModal()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; position: relative;">
                        <span style="font-size: 1.8rem;">üí¨</span>
                        <span style="font-weight: bold; font-size: 0.85rem;">${hubTexts.chat}</span>
                        <span style="font-size: 0.7rem; opacity: 0.8;">${chatMessages.length} ${hubTexts.messages}</span>
                        ${recentMessages > 0 ? `<span style="position: absolute; top: 5px; right: 5px; background: #f44336; color: #fff; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;">${recentMessages}</span>` : ''}
                    </button>
                    
                    <button class="btn" onclick="showMarketplace()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.3rem;">
                        <span style="font-size: 1.8rem;">üè™</span>
                        <span style="font-weight: bold; font-size: 0.85rem;">${hubTexts.marketplace}</span>
                        <span style="font-size: 0.7rem; opacity: 0.8;">${marketplaceOffers.filter(o => o.status === 'active').length} ${hubTexts.offers}</span>
                    </button>
                    
                    <button class="btn" onclick="notifyWarning('üîí Zamƒçeno', 'PvP Ar√©na je doƒçasnƒõ nedostupn√°')" style="background: linear-gradient(135deg, #555 0%, #333 100%); padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; position: relative; grid-column: span 2; opacity: 0.6; cursor: not-allowed;">
                        <span style="font-size: 1.8rem;">üîí</span>
                        <span style="font-weight: bold; font-size: 0.85rem;">${hubTexts.pvpArena}</span>
                        <span style="font-size: 0.7rem; opacity: 0.8;">Doƒçasnƒõ nedostupn√©</span>
                    </button>
                </div>
                
                <!-- √öƒåET / P≈òIHL√Å≈†EN√ç -->
                <button class="btn" onclick="showAuthModal()" style="width: 100%; background: linear-gradient(135deg, ${currentUser && !currentUser.isAnonymous ? '#4CAF50' : '#607D8B'} 0%, ${currentUser && !currentUser.isAnonymous ? '#388E3C' : '#455A64'} 100%); padding: 0.8rem; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 0.8rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.3rem;">${currentUser && !currentUser.isAnonymous ? '‚úÖ' : 'üîê'}</span>
                    <div style="text-align: left;">
                        <div style="font-weight: bold; font-size: 0.9rem;">${currentUser && !currentUser.isAnonymous ? 'M≈Øj √∫ƒçet' : 'P≈ôihl√°sit se'}</div>
                        <div style="font-size: 0.7rem; opacity: 0.8;">${currentUser && !currentUser.isAnonymous ? '‚òÅÔ∏è Cloud save aktivn√≠' : 'üë§ Hraje≈° jako host'}</div>
                    </div>
                </button>
                
                <!-- QUICK ACTIONS -->
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; border: 1px solid #333; margin-bottom: 1rem;">
                    <h3 style="margin: 0 0 0.8rem 0; color: #888; font-size: 0.9rem;">‚ö° ${hubTexts.quickActions}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn" onclick="submitScore()" style="background: #4CAF50; padding: 0.6rem; font-size: 0.85rem;">
                            üì§ ${hubTexts.submitScore}
                        </button>
                        <button class="btn" onclick="refreshMultiplayerData()" style="background: #2196f3; padding: 0.6rem; font-size: 0.85rem;">
                            üîÑ ${hubTexts.refreshData}
                        </button>
                        <button class="btn" onclick="showInbox()" style="background: #e91e63; padding: 0.6rem; font-size: 0.85rem; position: relative; grid-column: span 2;">
                            üì¨ ${'Soukrom√© zpr√°vy'}
                            ${unreadPrivateMessages > 0 ? `<span style="position: absolute; top: -5px; right: -5px; background: #f44336; color: #fff; border-radius: 50%; min-width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold;">${unreadPrivateMessages}</span>` : ''}
                        </button>
                    </div>
                </div>
                
                <!-- CONNECTION STATUS -->
                <div style="margin-top: 1rem; padding: 0.8rem; background: ${isActive ? 'rgba(76,175,80,0.1)' : 'rgba(255,152,0,0.1)'}; border-radius: 8px; border: 1px solid ${isActive ? '#4CAF50' : '#ff9800'}; text-align: center;">
                    <span style="color: ${isActive ? '#8bc34a' : '#ff9800'};">
                        ${isActive ? 'üü¢ Server: posledni-prezivsi.firebaseapp.com' : 'üî¥ Nep≈ôipojeno'}
                    </span>
                </div>
            `;
        }
        
        // Obnovit multiplayer data
        async function refreshMultiplayerData() {
            if (!multiplayerEnabled) {
                notifyWarning('Offline', 'Multiplayer nen√≠ aktivn√≠');
                return;
            }
            
            notifySuccess('Obnovuji...', 'Naƒç√≠t√°m data ze serveru');
            
            // Znovu naƒçti data
            try {
                const chatSnap = await firebaseDB.ref('chat/messages').orderByChild('timestamp').limitToLast(100).once('value');
                chatMessages = Object.values(chatSnap.val() || {}).sort((a, b) => a.timestamp - b.timestamp);
                
                const marketSnap = await firebaseDB.ref('marketplace/offers').once('value');
                marketplaceOffers = Object.entries(marketSnap.val() || {}).map(([key, val]) => ({...val, id: key}));
                
                const pvpSnap = await firebaseDB.ref('pvp/challenges').once('value');
                pvpChallenges = Object.entries(pvpSnap.val() || {}).map(([key, val]) => ({...val, id: key}));
                
                renderFull();
                notifySuccess('Hotovo!', 'Data aktualizov√°na');
            } catch (e) {
                console.error('Refresh error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se obnovit data');
            }
        }
        
        function showMultiplayerHub() {
            const isActive = multiplayerEnabled;
            
            showModal('üåê Multiplayer Hub', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">${isActive ? 'üåê' : 'üîå'}</div>
                    <div style="color: ${isActive ? '#8bc34a' : '#ff9800'};">
                        ${isActive ? '‚úì Online' : '‚ö†Ô∏è Offline'}
                    </div>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="showLeaderboard()" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); color: #000; padding: 1rem;">
                        üèÜ ≈Ωeb≈ô√≠ƒçek hr√°ƒç≈Ø
                    </button>
                    
                    <button class="btn" onclick="showChatModal()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 1rem;">
                        üí¨ Chat p≈ôe≈æiv≈°√≠ch
                    </button>
                    
                    <button class="btn" onclick="showMarketplace()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem;">
                        üè™ Tr≈æi≈°tƒõ (obchod mezi hr√°ƒçi)
                    </button>
                    
                    <button class="btn" onclick="showPvPArena()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem;">
                        ‚öîÔ∏è PvP Ar√©na
                    </button>
                    
                    <button class="btn" onclick="showBugReportModal()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 1rem;">
                        üêõ Nahl√°sit chybu
                    </button>
                    
                    <button class="btn" onclick="openCommunityLinks()" style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem;">
                        üåê Komunita
                    </button>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <span style="color: #888;">Hraje≈° jako: </span>
                        <span style="color: #ffd700; font-weight: bold;">${getPlayerName()}</span>
                    </div>
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>
            `);
        }
        
        // Automaticky odes√≠lej sk√≥re p≈ôi level upu
        const originalAddXP = addXP;
        addXP = function(amount) {
            const oldLevel = state.char.level;
            originalAddXP(amount);
            if (state.char.level > oldLevel && multiplayerEnabled) {
                setTimeout(submitScore, 1000);
            }
        };
        
        // ============================================
        // üåê KOMUNITA - WEB & FB
        // ============================================
        
        function openCommunityLinks() {
            showModal('üåê Komunita', `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üåê</div>
                    <h3 style="color: #ff5722; margin: 0;">Posledn√≠ p≈ôe≈æiv≈°√≠</h3>
                    <p style="color: #888; margin-top: 0.5rem;">P≈ôipoj se ke komunitƒõ p≈ôe≈æiv≈°√≠ch!</p>
                </div>
                
                <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ffd700; font-style: italic; text-align: center; margin: 0;">
                        "V pustinƒõ p≈ôe≈æij√≠ jen ti, co dr≈æ√≠ spolu!" ‚ò¢Ô∏èü§ù
                    </p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <a href="https://posledniprezivsi.cz/" target="_blank" rel="noopener noreferrer" 
                       class="btn" style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem; text-decoration: none; text-align: center; display: block;">
                        üåê Ofici√°ln√≠ web
                    </a>
                    <a href="https://www.facebook.com/groups/1155970856393862/" target="_blank" rel="noopener noreferrer" 
                       class="btn" style="background: linear-gradient(135deg, #1877f2 0%, #0d5bbd 100%); padding: 1rem; text-decoration: none; text-align: center; display: block;">
                        üìò Facebook skupina
                    </a>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                        ‚Üê Zpƒõt
                    </button>
                </div>
            `);
        }
        
        // Star√° funkce pro zpƒõtnou kompatibilitu
        function openFacebookGroup() {
            openCommunityLinks();
        }
        
        // ============================================
        // üêõ BUG REPORT SYST√âM
        // ============================================
        
        function showBugReportModal() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('‚ö†Ô∏è Offline', 'Pro zobrazen√≠ chyb mus√≠≈° b√Ωt online!');
                return;
            }
            
            showModal('üêõ Chyby ve h≈ôe', `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showBugReportForm()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 0.8rem;">
                        ‚úèÔ∏è Nahl√°sit novou
                    </button>
                    <button class="btn" onclick="showBugList()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); padding: 0.8rem;">
                        üìã Seznam chyb
                    </button>
                </div>
                <div id="bugContent" style="min-height: 200px;">
                    <p style="color: #888; text-align: center;">Vyber mo≈ænost v√Ω≈°e...</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>
            `);
        }
        
        function showBugReportForm() {
            const container = document.getElementById('bugContent');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: left;">
                    <p style="color: #888; margin-bottom: 1rem;">Na≈°el jsi chybu ve h≈ôe? Napi≈° ji sem a v√Ωvoj√°≈ô ji oprav√≠!</p>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Kategorie:</label>
                    <select id="bugCategory" style="width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <option value="gameplay">üéÆ Gameplay</option>
                        <option value="ui">üñ•Ô∏è Rozhran√≠ (UI)</option>
                        <option value="combat">‚öîÔ∏è Boj</option>
                        <option value="quests">üìú Questy</option>
                        <option value="items">üéí P≈ôedmƒõty</option>
                        <option value="skills">‚≠ê Dovednosti</option>
                        <option value="online">üåê Online/Multiplayer</option>
                        <option value="other">‚ùì Jin√©</option>
                    </select>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Popis chyby:</label>
                    <textarea id="bugDescription" placeholder="Popi≈° co se stalo, co jsi dƒõlal a co mƒõlo spr√°vnƒõ nastat..." 
                        style="width: 100%; height: 100px; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: vertical;"></textarea>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Kroky k reprodukci (voliteln√©):</label>
                    <textarea id="bugSteps" placeholder="1. Otev≈ôi invent√°≈ô&#10;2. Klikni na p≈ôedmƒõt&#10;3. ..."
                        style="width: 100%; height: 60px; padding: 0.5rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: vertical;"></textarea>
                    
                    <button class="btn" onclick="submitBugReport()" style="width: 100%; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">üì§ Odeslat</button>
                </div>
            `;
        }
        
        async function showBugList() {
            const container = document.getElementById('bugContent');
            if (!container) return;
            
            container.innerHTML = '<p style="color: #888; text-align: center;">‚è≥ Naƒç√≠t√°m...</p>';
            
            try {
                const snapshot = await firebaseDB.ref('bugReports').orderByChild('timestamp').once('value');
                const reports = snapshot.val() || {};
                
                const categoryIcons = {
                    gameplay: 'üéÆ', ui: 'üñ•Ô∏è', combat: '‚öîÔ∏è', quests: 'üìú',
                    items: 'üéí', skills: '‚≠ê', online: 'üåê', other: '‚ùì'
                };
                
                const statusInfo = {
                    new: { icon: 'üÜï', color: '#f44336', text: 'Nov√Ω' },
                    in_progress: { icon: 'üîß', color: '#ff9800', text: '≈òe≈°√≠ se' },
                    resolved: { icon: '‚úÖ', color: '#4CAF50', text: 'Opraveno' },
                    wont_fix: { icon: '‚ùå', color: '#666', text: 'Zam√≠tnuto' }
                };
                
                const allReports = Object.entries(reports).map(([id, r]) => ({...r, id}));
                
                // Statistiky
                const newCount = allReports.filter(r => r.status === 'new').length;
                const inProgressCount = allReports.filter(r => r.status === 'in_progress').length;
                const resolvedCount = allReports.filter(r => r.status === 'resolved').length;
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="background: rgba(244,67,54,0.2); padding: 0.5rem; border-radius: 6px; text-align: center; border: 1px solid #f44336;">
                            <div style="font-size: 1.3rem; color: #f44336;">${newCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Nov√©</div>
                        </div>
                        <div style="background: rgba(255,152,0,0.2); padding: 0.5rem; border-radius: 6px; text-align: center; border: 1px solid #ff9800;">
                            <div style="font-size: 1.3rem; color: #ff9800;">${inProgressCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">≈òe≈°√≠ se</div>
                        </div>
                        <div style="background: rgba(76,175,80,0.2); padding: 0.5rem; border-radius: 6px; text-align: center; border: 1px solid #4CAF50;">
                            <div style="font-size: 1.3rem; color: #4CAF50;">${resolvedCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Opraveno</div>
                        </div>
                    </div>
                `;
                
                if (allReports.length === 0) {
                    html += '<p style="text-align: center; color: #888;">≈Ω√°dn√© nahl√°≈°en√© chyby! üéâ</p>';
                } else {
                    html += '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                    
                    // Se≈ôadit - nejd≈ô√≠v nov√© a in_progress, pak resolved
                    const sortedReports = allReports.sort((a, b) => {
                        const statusOrder = { new: 0, in_progress: 1, resolved: 2, wont_fix: 3 };
                        const orderA = statusOrder[a.status] ?? 4;
                        const orderB = statusOrder[b.status] ?? 4;
                        if (orderA !== orderB) return orderA - orderB;
                        return (b.timestamp || 0) - (a.timestamp || 0);
                    });
                    
                    sortedReports.forEach(report => {
                        const status = statusInfo[report.status] || statusInfo.new;
                        const catIcon = categoryIcons[report.category] || '‚ùì';
                        const date = report.timestamp ? new Date(report.timestamp).toLocaleDateString('cs-CZ') : '';
                        const isMyReport = report.player === getPlayerName();
                        const safeId = report.id.replace(/'/g, "\\'");
                        
                        html += `
                            <div onclick="showBugReportDetail('${safeId}')" style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${status.color}; cursor: pointer;" title="Klikni pro detail">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                    <span style="font-size: 0.85rem;">${catIcon} <strong style="color: #ddd;">${report.category}</strong></span>
                                    <span style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: ${status.color}33; color: ${status.color}; border-radius: 4px;">${status.icon} ${status.text}</span>
                                </div>
                                <p style="margin: 0.3rem 0; color: #bbb; font-size: 0.85rem;">${escapeHtml(report.description).substring(0, 100)}${report.description.length > 100 ? '...' : ''}</p>
                                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-top: 0.3rem;">
                                    <span>${isMyReport ? 'üë§ Tv≈Øj report' : 'üë§ ' + report.player}</span>
                                    <span>${date}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Bug list error:', error);
                container.innerHTML = '<p style="color: #f44336; text-align: center;">Chyba p≈ôi naƒç√≠t√°n√≠ seznamu.</p>';
            }
        }
        
        // Zobrazen√≠ detailu bug reportu
        async function showBugReportDetail(reportId) {
            try {
                const snapshot = await firebaseDB.ref('bugReports/' + reportId).once('value');
                const report = snapshot.val();
                
                if (!report) {
                    notifyWarning('Report nenalezen');
                    return;
                }
                
                const categoryIcons = {
                    gameplay: 'üéÆ', ui: 'üñ•Ô∏è', combat: '‚öîÔ∏è', quests: 'üìú',
                    items: 'üéí', skills: '‚≠ê', online: 'üåê', other: '‚ùì'
                };
                
                const statusInfo = {
                    new: { icon: 'üÜï', color: '#f44336', text: 'Nov√Ω' },
                    in_progress: { icon: 'üîß', color: '#ff9800', text: '≈òe≈°√≠ se' },
                    resolved: { icon: '‚úÖ', color: '#4CAF50', text: 'Opraveno' },
                    wont_fix: { icon: '‚ùå', color: '#666', text: 'Zam√≠tnuto' }
                };
                
                const status = statusInfo[report.status] || statusInfo.new;
                const catIcon = categoryIcons[report.category] || '‚ùì';
                const date = report.timestamp ? new Date(report.timestamp).toLocaleDateString('cs-CZ') + ' ' + new Date(report.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}) : '';
                
                showModal(`${catIcon} Detail chyby`, `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; border-left: 4px solid ${status.color};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span style="font-weight: bold; color: #ddd;">${report.category.toUpperCase()}</span>
                            <span style="padding: 0.3rem 0.6rem; background: ${status.color}33; color: ${status.color}; border-radius: 4px; font-size: 0.85rem;">${status.icon} ${status.text}</span>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.3rem;">üìù POPIS:</div>
                            <p style="color: #ddd; margin: 0; line-height: 1.5; white-space: pre-wrap; word-break: break-word;">${escapeHtml(report.description)}</p>
                        </div>
                        
                        ${report.steps ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.3rem;">üîÑ KROKY K REPRODUKCI:</div>
                                <p style="color: #bbb; margin: 0; line-height: 1.4; white-space: pre-wrap; word-break: break-word; font-size: 0.9rem;">${escapeHtml(report.steps)}</p>
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-top: 0.8rem; border-top: 1px solid #333; font-size: 0.75rem; color: #666;">
                            <div>üë§ ${escapeHtml(report.player)} (lvl ${report.playerLevel || '?'})</div>
                            <div style="text-align: right;">üìÖ ${date}</div>
                            <div>üìç ${report.location || 'Nezn√°m√°'}</div>
                            <div style="text-align: right;">üÜî ${reportId.substring(0, 8)}...</div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="showBugReportModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt na seznam</button>
                `);
                
            } catch (error) {
                console.error('Bug detail error:', error);
                notifyWarning('Chyba p≈ôi naƒç√≠t√°n√≠ detailu');
            }
        }
        
        async function submitBugReport() {
            const category = document.getElementById('bugCategory')?.value || 'other';
            const description = document.getElementById('bugDescription')?.value?.trim() || '';
            const steps = document.getElementById('bugSteps')?.value?.trim() || '';
            
            if (!description) {
                notifyWarning('Vypl≈à popis chyby!');
                return;
            }
            
            if (description.length < 10) {
                notifyWarning('Popis je p≈ô√≠li≈° kr√°tk√Ω!');
                return;
            }
            
            try {
                const bugReport = {
                    category: category,
                    description: description,
                    steps: steps,
                    player: getPlayerName(),
                    playerLevel: state.char.level,
                    location: state.world?.currentLocation || 'unknown',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'new', // new, in_progress, resolved, wont_fix
                    resolved: false
                };
                
                await firebaseDB.ref('bugReports').push(bugReport);
                
                closeModal();
                notifySuccess('üêõ Chyba nahl√°≈°ena!', 'D√≠ky za pomoc s vylep≈°en√≠m hry!');
                
            } catch (error) {
                console.error('Bug report error:', error);
                notifyWarning('Chyba p≈ôi odes√≠l√°n√≠!');
            }
        }
        
        // === N√ÅPADY NA VYLEP≈†EN√ç ===
        function showIdeasModal() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('‚ö†Ô∏è Offline', 'Pro zobrazen√≠ n√°pad≈Ø mus√≠≈° b√Ωt online!');
                return;
            }
            
            showModal('üí° N√°pady na vylep≈°en√≠', `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="showIdeaForm()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        ‚úèÔ∏è P≈ôidat n√°pad
                    </button>
                    <button class="btn" onclick="showIdeasList()" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); padding: 0.8rem;">
                        üìã Seznam n√°pad≈Ø
                    </button>
                </div>
                <div id="ideasContent" style="min-height: 200px;">
                    <p style="color: #888; text-align: center;">Vyber mo≈ænost v√Ω≈°e...</p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>
            `);
        }
        
        function showIdeaForm() {
            const container = document.getElementById('ideasContent');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: left;">
                    <p style="color: #888; margin-bottom: 1rem;">M√°≈° n√°pad na vylep≈°en√≠ hry? Podƒõlte se o nƒõj!</p>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Kategorie:</label>
                    <select id="ideaCategory" style="width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                        <option value="feature">‚ú® Nov√° funkce</option>
                        <option value="content">üì¶ Nov√Ω obsah (itemy, nep≈ô√°tel√©...)</option>
                        <option value="balance">‚öñÔ∏è Balancov√°n√≠</option>
                        <option value="ui">üñ•Ô∏è Vylep≈°en√≠ rozhran√≠</option>
                        <option value="qol">üõ†Ô∏è Quality of Life</option>
                        <option value="story">üìñ P≈ô√≠bƒõh/Questy</option>
                        <option value="multiplayer">üåê Multiplayer</option>
                        <option value="other">‚ùì Jin√©</option>
                    </select>
                    
                    <label style="color: #aaa; font-size: 0.85rem;">N√°zev n√°padu:</label>
                    <input type="text" id="ideaTitle" placeholder="Struƒçn√Ω n√°zev n√°padu..."
                        style="width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
                    
                    <label style="color: #aaa; font-size: 0.85rem;">Popis:</label>
                    <textarea id="ideaDescription" placeholder="Popi≈° sv≈Øj n√°pad podrobnƒõji - co by to p≈ôineslo hr√°ƒç≈Øm, jak by to fungovalo..."
                        style="width: 100%; height: 100px; padding: 0.5rem; margin-bottom: 1rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: vertical;"></textarea>
                    
                    <button class="btn" onclick="submitIdea()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">üì§ Odeslat n√°pad</button>
                </div>
            `;
        }
        
        async function showIdeasList() {
            const container = document.getElementById('ideasContent');
            if (!container) return;
            
            container.innerHTML = '<p style="color: #888; text-align: center;">‚è≥ Naƒç√≠t√°m...</p>';
            
            try {
                const snapshot = await firebaseDB.ref('gameIdeas').orderByChild('votes').once('value');
                const ideas = snapshot.val() || {};
                
                const categoryIcons = {
                    feature: '‚ú®', content: 'üì¶', balance: '‚öñÔ∏è', ui: 'üñ•Ô∏è',
                    qol: 'üõ†Ô∏è', story: 'üìñ', multiplayer: 'üåê', other: '‚ùì'
                };
                
                const statusInfo = {
                    new: { icon: 'üÜï', color: '#2196f3', text: 'Nov√Ω', order: 0 },
                    considering: { icon: 'ü§î', color: '#ff9800', text: 'Zva≈æuje se', order: 1 },
                    planned: { icon: 'üìã', color: '#9c27b0', text: 'Pl√°nov√°no', order: 2 },
                    in_progress: { icon: 'üî®', color: '#ff9800', text: 'V pr√°ci', order: 3 },
                    done: { icon: '‚úÖ', color: '#4CAF50', text: 'Hotovo', order: 4 },
                    rejected: { icon: '‚ùå', color: '#666', text: 'Zam√≠tnuto', order: 5 }
                };
                
                // Se≈ôaƒè podle statusu (nevy≈ô√≠zen√© prvn√≠), pak podle hlas≈Ø (sestupnƒõ)
                const sortedIdeas = Object.entries(ideas).sort((a, b) => {
                    const statusA = statusInfo[a[1].status] || statusInfo.new;
                    const statusB = statusInfo[b[1].status] || statusInfo.new;
                    
                    // Nejd≈ô√≠v podle statusu (ni≈æ≈°√≠ order = prvn√≠)
                    if (statusA.order !== statusB.order) {
                        return statusA.order - statusB.order;
                    }
                    
                    // Pak podle hlas≈Ø (vy≈°≈°√≠ = prvn√≠)
                    return (b[1].votes || 0) - (a[1].votes || 0);
                });
                
                if (sortedIdeas.length === 0) {
                    container.innerHTML = '<p style="color: #888; text-align: center;">Zat√≠m ≈æ√°dn√© n√°pady. Buƒè prvn√≠!</p>';
                    return;
                }
                
                const myName = getPlayerName();
                
                let html = '<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                sortedIdeas.slice(0, 20).forEach(([id, idea]) => {
                    const status = statusInfo[idea.status] || statusInfo.new;
                    const catIcon = categoryIcons[idea.category] || '‚ùì';
                    const hasVoted = idea.votedBy && idea.votedBy[myName.replace(/[.#$[\]]/g, '_')];
                    const safeId = id.replace(/'/g, "\\'");
                    const hasReward = idea.rewarded;
                    
                    html += `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${status.color};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.3rem;">
                                <div style="flex: 1;">
                                    <span style="font-size: 1rem;">${catIcon}</span>
                                    <span style="color: #fff; font-weight: bold; font-size: 0.9rem;">${idea.title || 'Bez n√°zvu'}</span>
                                    ${hasReward ? '<span style="margin-left: 0.3rem; font-size: 0.8rem;" title="Autor dostal odmƒõnu">üéÅ</span>' : ''}
                                </div>
                                <span style="background: ${status.color}22; color: ${status.color}; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem;">
                                    ${status.icon} ${status.text}
                                </span>
                            </div>
                            <p style="color: #aaa; font-size: 0.75rem; margin: 0.3rem 0; line-height: 1.3;">${(idea.description || '').substring(0, 100)}${(idea.description || '').length > 100 ? '...' : ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                <span style="color: #666; font-size: 0.7rem;">Od: ${idea.player || 'Anonym'}</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    ${hasReward ? `<span style="color: #8bc34a; font-size: 0.65rem;">${hasReward.money}üí∞+${hasReward.xp}‚≠ê</span>` : ''}
                                    <button onclick="voteIdea('${safeId}')" style="background: ${hasVoted ? '#4CAF50' : '#333'}; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                        <span style="color: ${hasVoted ? '#fff' : '#ffd700'};">üëç</span>
                                        <span style="color: #fff; font-size: 0.8rem; font-weight: bold;">${idea.votes || 0}</span>
                                    </button>
                                    <button onclick="showIdeaDetail('${safeId}')" style="background: #444; border: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; color: #fff; font-size: 0.75rem;">
                                        üìñ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Ideas list error:', error);
                container.innerHTML = '<p style="color: #ff6666; text-align: center;">Chyba p≈ôi naƒç√≠t√°n√≠ n√°pad≈Ø</p>';
            }
        }
        
        async function submitIdea() {
            const category = document.getElementById('ideaCategory')?.value;
            const title = document.getElementById('ideaTitle')?.value?.trim();
            const description = document.getElementById('ideaDescription')?.value?.trim();
            
            if (!title || title.length < 5) {
                notifyWarning('N√°zev je p≈ô√≠li≈° kr√°tk√Ω!');
                return;
            }
            
            if (!description || description.length < 20) {
                notifyWarning('Popis je p≈ô√≠li≈° kr√°tk√Ω (min. 20 znak≈Ø)!');
                return;
            }
            
            try {
                const idea = {
                    category: category,
                    title: title,
                    description: description,
                    player: getPlayerName(),
                    playerLevel: state.char.level,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'new',
                    votes: 1,
                    votedBy: {
                        [getPlayerName().replace(/[.#$[\]]/g, '_')]: true
                    }
                };
                
                await firebaseDB.ref('gameIdeas').push(idea);
                
                closeModal();
                notifySuccess('üí° N√°pad odesl√°n!', 'D√≠ky za tv≈Øj p≈ô√≠spƒõvek!');
                
            } catch (error) {
                console.error('Idea submit error:', error);
                notifyWarning('Chyba p≈ôi odes√≠l√°n√≠!');
            }
        }
        
        async function voteIdea(ideaId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName().replace(/[.#$[\]]/g, '_');
            
            try {
                const snapshot = await firebaseDB.ref('gameIdeas/' + ideaId).once('value');
                const idea = snapshot.val();
                
                if (!idea) return;
                
                const hasVoted = idea.votedBy && idea.votedBy[myName];
                
                if (hasVoted) {
                    // Odeber hlas
                    await firebaseDB.ref('gameIdeas/' + ideaId).update({
                        votes: Math.max(0, (idea.votes || 1) - 1),
                        ['votedBy/' + myName]: null
                    });
                    notifyInfo('üëé Hlas odebr√°n', '');
                } else {
                    // P≈ôidej hlas
                    await firebaseDB.ref('gameIdeas/' + ideaId).update({
                        votes: (idea.votes || 0) + 1,
                        ['votedBy/' + myName]: true
                    });
                    notifySuccess('üëç Hlasov√°no!', '');
                }
                
                // Obnov seznam
                showIdeasList();
                
            } catch (error) {
                console.error('Vote error:', error);
                notifyWarning('Chyba p≈ôi hlasov√°n√≠!');
            }
        }
        
        async function showIdeaDetail(ideaId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const snapshot = await firebaseDB.ref('gameIdeas/' + ideaId).once('value');
                const idea = snapshot.val();
                
                if (!idea) {
                    notifyWarning('N√°pad nenalezen');
                    return;
                }
                
                const categoryNames = {
                    feature: '‚ú® Nov√° funkce', content: 'üì¶ Nov√Ω obsah', balance: '‚öñÔ∏è Balancov√°n√≠',
                    ui: 'üñ•Ô∏è Rozhran√≠', qol: 'üõ†Ô∏è Quality of Life', story: 'üìñ P≈ô√≠bƒõh',
                    multiplayer: 'üåê Multiplayer', other: '‚ùì Jin√©'
                };
                
                const statusInfo = {
                    new: { icon: 'üÜï', color: '#2196f3', text: 'Nov√Ω' },
                    considering: { icon: 'ü§î', color: '#ff9800', text: 'Zva≈æuje se' },
                    planned: { icon: 'üìã', color: '#9c27b0', text: 'Pl√°nov√°no' },
                    in_progress: { icon: 'üî®', color: '#ff9800', text: 'V pr√°ci' },
                    done: { icon: '‚úÖ', color: '#4CAF50', text: 'Hotovo' },
                    rejected: { icon: '‚ùå', color: '#666', text: 'Zam√≠tnuto' }
                };
                
                const status = statusInfo[idea.status] || statusInfo.new;
                const date = idea.timestamp ? new Date(idea.timestamp).toLocaleDateString('cs-CZ') : 'Nezn√°m√©';
                const myName = getPlayerName();
                const safeId = ideaId.replace(/'/g, "\\'");
                
                // Naƒçti koment√°≈ôe
                const comments = idea.comments ? Object.entries(idea.comments).sort((a, b) => a[1].timestamp - b[1].timestamp) : [];
                
                let commentsHtml = '';
                if (comments.length > 0) {
                    commentsHtml = '<div style="margin-top: 1rem;"><h4 style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">üí¨ Koment√°≈ôe (${comments.length})</h4>';
                    commentsHtml += '<div style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                    comments.forEach(([cId, comment]) => {
                        const isAdmin = comment.author === 'Zaoo';
                        const commentDate = comment.timestamp ? new Date(comment.timestamp).toLocaleString('cs-CZ', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'}) : '';
                        commentsHtml += `
                            <div style="background: ${isAdmin ? '#1a2a1a' : '#1a1a1a'}; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; ${isAdmin ? 'border-left: 3px solid #4CAF50;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                    <span style="color: ${isAdmin ? '#ffd700' : '#aaa'}; font-size: 0.75rem; font-weight: bold;">
                                        ${comment.author || 'Anonym'}${isAdmin ? ' üëë ADMIN' : ''}
                                    </span>
                                    <span style="color: #555; font-size: 0.65rem;">${commentDate}</span>
                                </div>
                                <p style="color: #ccc; font-size: 0.8rem; margin: 0; line-height: 1.4;">${escapeHtml(comment.text || '')}</p>
                            </div>
                        `;
                    });
                    commentsHtml += '</div></div>';
                }
                commentsHtml = commentsHtml.replace('${comments.length}', comments.length);
                
                // Admin funkce pro zmƒõnu stavu
                const adminControls = isAdmin() ? `
                    <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #f44336;">
                        <p style="color: #f44336; font-size: 0.8rem; margin: 0 0 0.5rem 0;">üëë Admin ovl√°d√°n√≠:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'considering')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #ff9800;">ü§î Zva≈æuje se</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'planned')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #9c27b0;">üìã Pl√°nov√°no</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'in_progress')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #ff9800;">üî® V pr√°ci</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'done')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #4CAF50;">‚úÖ Hotovo</button>
                            <button class="btn" onclick="setIdeaStatus('${safeId}', 'rejected')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #666;">‚ùå Zam√≠tnuto</button>
                        </div>
                        <button class="btn" onclick="rewardIdeaAuthor('${safeId}', '${escapeHtml(idea.player || '')}', '${escapeHtml(idea.title || '')}')" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.5rem;">
                            üéÅ D√°t odmƒõnu autorovi (${idea.player || 'Anonym'})
                        </button>
                    </div>
                ` : '';
                
                showModal('üí° Detail n√°padu', `
                    <div style="text-align: left;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="background: ${status.color}22; color: ${status.color}; padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.85rem;">
                                ${status.icon} ${status.text}
                            </span>
                            <span style="color: #ffd700; font-size: 1.2rem;">üëç ${idea.votes || 0}</span>
                        </div>
                        
                        ${idea.rewarded ? `
                            <div style="background: linear-gradient(135deg, #1a3a1a, #0a2a0a); padding: 0.5rem 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #4caf50; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üéÅ</span>
                                <span style="color: #8bc34a; font-size: 0.85rem;">
                                    Odmƒõnƒõno: ${idea.rewarded.money || 0}üí∞ + ${idea.rewarded.xp || 0}‚≠ê
                                </span>
                            </div>
                        ` : ''}
                        
                        <h3 style="color: #ff9800; margin: 0 0 0.5rem 0;">${idea.title || 'Bez n√°zvu'}</h3>
                        
                        <p style="color: #888; font-size: 0.8rem; margin-bottom: 1rem;">
                            ${categoryNames[idea.category] || 'Jin√©'} ‚Ä¢ Od: ${idea.player || 'Anonym'} ‚Ä¢ ${date}
                        </p>
                        
                        <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: #ccc; line-height: 1.5; white-space: pre-wrap; margin: 0;">${idea.description || 'Bez popisu'}</p>
                        </div>
                        
                        ${idea.devResponse ? `
                            <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; border-left: 3px solid #4CAF50; margin-bottom: 1rem;">
                                <p style="color: #4CAF50; font-size: 0.85rem; margin: 0 0 0.5rem 0;">üí¨ Odpovƒõƒè v√Ωvoj√°≈ôe:</p>
                                <p style="color: #ccc; margin: 0;">${idea.devResponse}</p>
                            </div>
                        ` : ''}
                        
                        ${commentsHtml}
                        
                        <!-- P≈ôidat koment√°≈ô -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #333;">
                            <textarea id="ideaCommentText" placeholder="Napi≈° koment√°≈ô nebo reakci..."
                                style="width: 100%; height: 60px; padding: 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; resize: none; margin-bottom: 0.5rem;"></textarea>
                            <button class="btn" onclick="addIdeaComment('${safeId}')" style="width: 100%; background: #2196f3;">üí¨ P≈ôidat koment√°≈ô</button>
                        </div>
                        
                        ${adminControls}
                    </div>
                    <button class="btn" onclick="showIdeasModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt na seznam</button>
                `);
                
            } catch (error) {
                console.error('Idea detail error:', error);
                notifyWarning('Chyba p≈ôi naƒç√≠t√°n√≠ detailu');
            }
        }
        
        // P≈ôidat koment√°≈ô k n√°padu
        async function addIdeaComment(ideaId) {
            const text = document.getElementById('ideaCommentText')?.value?.trim();
            if (!text || text.length < 3) {
                notifyWarning('Koment√°≈ô je p≈ô√≠li≈° kr√°tk√Ω!');
                return;
            }
            
            if (text.length > 500) {
                notifyWarning('Koment√°≈ô je p≈ô√≠li≈° dlouh√Ω (max 500 znak≈Ø)!');
                return;
            }
            
            try {
                const comment = {
                    author: getPlayerName(),
                    text: text,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await firebaseDB.ref('gameIdeas/' + ideaId + '/comments').push(comment);
                
                notifySuccess('üí¨ Koment√°≈ô p≈ôid√°n!', '');
                showIdeaDetail(ideaId); // Refresh
                
            } catch (error) {
                console.error('Comment error:', error);
                notifyWarning('Chyba p≈ôi p≈ôid√°v√°n√≠ koment√°≈ôe!');
            }
        }
        
        // Admin: zmƒõna stavu n√°padu
        // D√°t odmƒõnu autorovi n√°padu
        function rewardIdeaAuthor(ideaId, playerName, ideaTitle) {
            if (!isAdmin()) return;
            
            if (!playerName || playerName === 'Anonym') {
                notifyWarning('Chyba', 'N√°pad nem√° zn√°m√©ho autora!');
                return;
            }
            
            // P≈ôeddefinovan√© odmƒõny (ni≈æ≈°√≠ hodnoty pro vyv√°≈æen√≠)
            const rewardPresets = [
                { id: 'small', name: 'üéÅ Mal√°', money: 25, xp: 10 },
                { id: 'medium', name: 'üéÅ St≈ôedn√≠', money: 50, xp: 25 },
                { id: 'large', name: 'üéÅ Velk√°', money: 100, xp: 50 },
                { id: 'epic', name: 'üèÜ Epick√°', money: 250, xp: 100 }
            ];
            
            const safeId = ideaId.replace(/'/g, "\\'");
            
            let presetsHtml = rewardPresets.map(r => `
                <button class="btn" onclick="sendIdeaReward('${safeId}', '${escapeHtml(playerName)}', ${r.money}, ${r.xp}, '${escapeHtml(ideaTitle)}')" 
                    style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.5rem; text-align: center;">
                    <div>${r.name}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">${r.money}üí∞ + ${r.xp}‚≠ê</div>
                </button>
            `).join('');
            
            showModal('üéÅ Odmƒõna za n√°pad', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="color: #888;">D√°t odmƒõnu hr√°ƒçi:</p>
                    <p style="color: #2196f3; font-size: 1.2rem; font-weight: bold;">${escapeHtml(playerName)}</p>
                    <p style="color: #666; font-size: 0.85rem;">Za n√°pad: "${escapeHtml(ideaTitle)}"</p>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    ${presetsHtml}
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #888; font-size: 0.85rem; margin: 0 0 0.5rem 0;">Nebo vlastn√≠ ƒç√°stka:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <input type="number" id="customRewardMoney" placeholder="Pen√≠ze" value="50" min="0" style="padding: 0.5rem; background: #2a2a2a; color: #ffd700; border: 1px solid #444; border-radius: 4px;">
                        <input type="number" id="customRewardXP" placeholder="XP" value="25" min="0" style="padding: 0.5rem; background: #2a2a2a; color: #8bc34a; border: 1px solid #444; border-radius: 4px;">
                    </div>
                    <button class="btn" onclick="sendIdeaReward('${safeId}', '${escapeHtml(playerName)}', parseInt(document.getElementById('customRewardMoney').value)||0, parseInt(document.getElementById('customRewardXP').value)||0, '${escapeHtml(ideaTitle)}')" 
                        style="width: 100%; margin-top: 0.5rem; background: #ff9800;">
                        Odeslat vlastn√≠ odmƒõnu
                    </button>
                </div>
                
                <button class="btn" onclick="showIdeaDetail('${ideaId}')" style="width: 100%; background: #555;">‚Üê Zpƒõt na n√°pad</button>
            `);
        }
        
        async function sendIdeaReward(ideaId, playerName, money, xp, ideaTitle) {
            if (!isAdmin()) return;
            
            if (money <= 0 && xp <= 0) {
                notifyWarning('Chyba', 'Nastav alespo≈à pen√≠ze nebo XP!');
                return;
            }
            
            try {
                const reason = `Schv√°len√Ω n√°pad: "${ideaTitle}"`;
                const rewardId = Date.now().toString();
                
                // Ulo≈æ odmƒõnu do Firebase pod players/{playerName}/pendingRewards
                await firebaseDB.ref(`players/${playerName}/pendingRewards/${rewardId}`).set({
                    money: money,
                    xp: xp,
                    reason: reason,
                    from: ADMIN_NICK,
                    timestamp: Date.now(),
                    claimed: false
                });
                
                // Oznaƒç n√°pad jako odmƒõnƒõn√Ω v gameIdeas
                await firebaseDB.ref(`gameIdeas/${ideaId}/rewarded`).set({
                    money: money,
                    xp: xp,
                    timestamp: Date.now()
                });
                
                // Po≈°li zpr√°vu
                await firebaseDB.ref(`chat/private/${playerName}/${ADMIN_NICK}`).push({
                    from: ADMIN_NICK,
                    text: `üéÅ Tv≈Øj n√°pad "${ideaTitle}" byl schv√°len! Odmƒõna: ${money > 0 ? money + 'üí∞' : ''} ${xp > 0 ? xp + '‚≠êXP' : ''} - Vyzvedni si ji p≈ôi dal≈°√≠m p≈ôihl√°≈°en√≠!`,
                    timestamp: Date.now(),
                    type: 'reward'
                });
                
                // Zaloguj
                await firebaseDB.ref('admin/rewardLog').push({
                    player: playerName,
                    money: money,
                    xp: xp,
                    reason: reason,
                    admin: ADMIN_NICK,
                    timestamp: Date.now()
                });
                
                notifySuccess('üéÅ Odmƒõna odesl√°na!', `${playerName}: ${money}üí∞ + ${xp}‚≠êXP`);
                closeModal();
                
                // Refresh detail n√°padu
                setTimeout(() => showIdeaDetail(ideaId), 500);
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function setIdeaStatus(ideaId, newStatus) {
            if (!isAdmin()) return;
            
            try {
                await firebaseDB.ref('gameIdeas/' + ideaId).update({
                    status: newStatus
                });
                
                notifySuccess('‚úÖ Stav zmƒõnƒõn!', newStatus);
                showIdeaDetail(ideaId); // Refresh
                
            } catch (error) {
                console.error('Status change error:', error);
                notifyWarning('Chyba p≈ôi zmƒõnƒõ stavu!');
            }
        }
        
        // Admin panel pro bug reporty
        async function showAdminBugReports() {
            if (!hasPermission('bugs')) return;
            
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('‚ö†Ô∏è Offline', 'Mus√≠≈° b√Ωt online!');
                return;
            }
            
            try {
                const snapshot = await firebaseDB.ref('bugReports').orderByChild('timestamp').once('value');
                const reports = snapshot.val() || {};
                
                const categoryIcons = {
                    gameplay: 'üéÆ', ui: 'üñ•Ô∏è', combat: '‚öîÔ∏è', quests: 'üìú',
                    items: 'üéí', skills: '‚≠ê', online: 'üåê', other: '‚ùì'
                };
                
                const statusColors = {
                    new: '#f44336',
                    in_progress: '#ff9800',
                    resolved: '#4CAF50',
                    wont_fix: '#666'
                };
                
                const statusNames = {
                    new: 'üÜï Nov√Ω',
                    in_progress: 'üîÑ ≈òe≈°√≠ se',
                    resolved: '‚úÖ Vy≈ôe≈°eno',
                    wont_fix: '‚ùå Nebudeme opravovat'
                };
                
                let html = '<div style="max-height: 60vh; overflow-y: auto;">';
                
                // Statistiky
                const allReports = Object.values(reports);
                const newCount = allReports.filter(r => r.status === 'new').length;
                const inProgressCount = allReports.filter(r => r.status === 'in_progress').length;
                const resolvedCount = allReports.filter(r => r.status === 'resolved').length;
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="background: #3a1a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #f44336;">${newCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Nov√©</div>
                        </div>
                        <div style="background: #3a2a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #ff9800;">${inProgressCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">≈òe≈°√≠ se</div>
                        </div>
                        <div style="background: #1a3a1a; padding: 0.5rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1.5rem; color: #4CAF50;">${resolvedCount}</div>
                            <div style="font-size: 0.7rem; color: #888;">Vy≈ôe≈°eno</div>
                        </div>
                    </div>
                `;
                
                // Seznam report≈Ø (od nejnovƒõj≈°√≠ch)
                const sortedReports = Object.entries(reports).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
                
                if (sortedReports.length === 0) {
                    html += '<p style="text-align: center; color: #888;">≈Ω√°dn√© nahl√°≈°en√© chyby! üéâ</p>';
                } else {
                    sortedReports.forEach(([id, report]) => {
                        const date = report.timestamp ? new Date(report.timestamp).toLocaleDateString('cs-CZ') : 'Nezn√°m√©';
                        const icon = categoryIcons[report.category] || '‚ùì';
                        const statusColor = statusColors[report.status] || '#666';
                        
                        html += `
                            <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.85rem;">${icon} <strong>${report.category}</strong></span>
                                    <span style="font-size: 0.7rem; color: #888;">${date}</span>
                                </div>
                                <p style="margin: 0.5rem 0; color: #ddd; font-size: 0.9rem;">${escapeHtml(report.description).substring(0, 150)}${report.description.length > 150 ? '...' : ''}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: #888;">Od: ${report.player} (L${report.playerLevel})</span>
                                    <select onchange="updateBugStatus('${id}', this.value)" style="padding: 0.2rem 0.5rem; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 0.75rem;">
                                        <option value="new" ${report.status === 'new' ? 'selected' : ''}>üÜï Nov√Ω</option>
                                        <option value="in_progress" ${report.status === 'in_progress' ? 'selected' : ''}>üîÑ ≈òe≈°√≠ se</option>
                                        <option value="resolved" ${report.status === 'resolved' ? 'selected' : ''}>‚úÖ Vy≈ôe≈°eno</option>
                                        <option value="wont_fix" ${report.status === 'wont_fix' ? 'selected' : ''}>‚ùå Nebudeme</option>
                                    </select>
                                </div>
                                ${report.steps ? `<details style="margin-top: 0.5rem;"><summary style="color: #888; font-size: 0.75rem; cursor: pointer;">Kroky k reprodukci</summary><p style="color: #aaa; font-size: 0.8rem; white-space: pre-line; margin: 0.5rem 0;">${escapeHtml(report.steps)}</p></details>` : ''}
                                ${report.adminReply ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #1a2a1a; border-radius: 4px; border-left: 2px solid #4caf50;"><span style="color: #4caf50; font-size: 0.7rem;">üí¨ Admin odpovƒõƒè:</span><p style="color: #aaa; font-size: 0.8rem; margin: 0.3rem 0 0 0;">${escapeHtml(report.adminReply)}</p></div>` : ''}
                                <div style="display: flex; gap: 0.3rem; margin-top: 0.5rem;">
                                    <button onclick="showAdminReplyDialog('${id}')" style="padding: 0.2rem 0.5rem; background: #2196f3; border: none; color: #fff; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">üí¨ Odpovƒõdƒõt</button>
                                    <button onclick="deleteBugReport('${id}')" style="padding: 0.2rem 0.5rem; background: #c62828; border: none; color: #fff; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">üóëÔ∏è Smazat</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                
                showModal('üêõ Admin - Bug Reporty', html + `
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>
                `);
                
            } catch (error) {
                console.error('Admin bug reports error:', error);
                showModal('‚ùå Chyba', 'Nepoda≈ôilo se naƒç√≠st bug reporty.');
            }
        }
        
        async function updateBugStatus(reportId, newStatus) {
            if (!firebaseDB) return;
            
            try {
                await firebaseDB.ref('bugReports/' + reportId).update({
                    status: newStatus,
                    resolved: newStatus === 'resolved'
                });
                notifySuccess('Status aktualizov√°n!');
            } catch (error) {
                console.error('Update bug status error:', error);
                notifyWarning('Chyba p≈ôi aktualizaci!');
            }
        }
        
        async function deleteBugReport(reportId) {
            if (!firebaseDB) return;
            
            if (!confirm('Opravdu smazat tento bug report?')) return;
            
            try {
                await firebaseDB.ref('bugReports/' + reportId).remove();
                showAdminBugReports(); // Refresh
                notifySuccess('Bug report smaz√°n!');
            } catch (error) {
                console.error('Delete bug report error:', error);
                notifyWarning('Chyba p≈ôi maz√°n√≠!');
            }
        }
        
        function showAdminReplyDialog(reportId) {
            showModal('üí¨ Odpovƒõƒè na bug report', `
                <div style="text-align: center;">
                    <textarea id="adminReplyText" placeholder="Napi≈° odpovƒõƒè hr√°ƒçi..." 
                        style="width: 100%; height: 100px; padding: 0.8rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; resize: none; margin-bottom: 1rem;"></textarea>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="showAdminBugReports()" style="flex: 1; background: #555;">‚Üê Zpƒõt</button>
                        <button class="btn" onclick="sendAdminReply('${reportId}')" style="flex: 1; background: #4caf50;">üì§ Odeslat</button>
                    </div>
                </div>
            `);
        }
        
        async function sendAdminReply(reportId) {
            if (!firebaseDB) return;
            
            const replyText = document.getElementById('adminReplyText')?.value?.trim();
            if (!replyText) {
                notifyWarning('Napi≈° odpovƒõƒè!');
                return;
            }
            
            try {
                await firebaseDB.ref('bugReports/' + reportId).update({
                    adminReply: replyText,
                    adminReplyTime: firebase.database.ServerValue.TIMESTAMP
                });
                notifySuccess('Odpovƒõƒè odesl√°na!');
                showAdminBugReports(); // Refresh
            } catch (error) {
                console.error('Admin reply error:', error);
                notifyWarning('Chyba p≈ôi odes√≠l√°n√≠!');
            }
        }
        
        // ============================================
        // üéÆ VYLEP≈†EN√ù MULTIPLAYER SYST√âM
        // ============================================
        
        // === P≈ò√ÅTEL√â SYST√âM ===
        
        // Inicializace p≈ô√°tel
        function initFriendsSystem() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            // Naƒçti p≈ô√°tele z lok√°ln√≠ho ulo≈æen√≠
            try {
                friendsList = JSON.parse(localStorage.getItem('friendsList_' + myName) || '[]');
            } catch (e) {
                friendsList = [];
            }
            
            // Poslouchej notifikace (≈æ√°dosti o p≈ô√°telstv√≠ a p≈ôijet√≠)
            console.log('üë• Nastavuji listener na notifikace pro:', myName);
            const processedRewards = new Set(); // Ochrana proti duplicitn√≠mu zpracov√°n√≠
            const rewardQueue = []; // Fronta odmƒõn k zpracov√°n√≠
            let processingRewards = false;
            
            async function processRewardQueue() {
                if (processingRewards || rewardQueue.length === 0) return;
                processingRewards = true;
                
                while (rewardQueue.length > 0) {
                    const { reward, key } = rewardQueue.shift();
                    await processAdminReward(reward, key);
                    // Poƒçkej 500ms mezi modaly aby hr√°ƒç vidƒõl ka≈æd√Ω
                    if (rewardQueue.length > 0) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
                processingRewards = false;
            }
            
            firebaseDB.ref('notifications/' + myName).orderByChild('timestamp').limitToLast(100).on('value', (snap) => {
                const notifications = snap.val() || {};
                console.log('üë• P≈ôijat√© notifikace:', notifications);
                friendRequests = [];
                Object.entries(notifications).forEach(([k, v]) => {
                    if (v.type === 'friend_request') {
                        friendRequests.push({...v, id: k});
                        console.log('üë• ≈Ω√°dost o p≈ô√°telstv√≠ od:', v.from);
                    }
                    // Kdy≈æ nƒõkdo p≈ôijal na≈°i ≈æ√°dost, p≈ôidej ho do p≈ô√°tel
                    if (v.type === 'friend_accepted' && !friendsList.includes(v.from)) {
                        friendsList.push(v.from);
                        saveFriendsList();
                        notifySuccess('Nov√Ω p≈ô√≠tel!', `${v.from} p≈ôijal tvou ≈æ√°dost o p≈ô√°telstv√≠`);
                        // Sma≈æ notifikaci
                        firebaseDB.ref('notifications/' + myName + '/' + k).remove();
                    }
                    // Zpracov√°n√≠ v√Ωhry v tombole
                    if (v.type === 'tombola_win' && !v.processed) {
                        console.log('üéâ Tombola v√Ωhra!', v);
                        processTombolaWin(v);
                        // Oznaƒç jako zpracovan√© a sma≈æ
                        firebaseDB.ref('notifications/' + myName + '/' + k).remove();
                    }
                    // Zpracov√°n√≠ admin odmƒõny - p≈ôidej do fronty
                    if (v.type === 'admin_reward' && !v.claimed && !processedRewards.has(k)) {
                        processedRewards.add(k);
                        console.log('üéÅ Admin odmƒõna p≈ôid√°na do fronty:', k);
                        rewardQueue.push({ reward: v, key: k });
                    }
                });
                // Zpracuj frontu odmƒõn
                if (rewardQueue.length > 0) {
                    processRewardQueue();
                }
                if (friendRequests.length > 0) {
                    console.log('üë• Celkem ≈æ√°dost√≠:', friendRequests.length);
                    updateOnlineIndicator('notification');
                }
            });
            
            // Poslouchej soukrom√© zpr√°vy
            let lastPrivateMsgCount = 0;
            const privatePath = 'chat/private/' + myName;
            console.log('üì¨ Nastavuji listener na:', privatePath);
            
            firebaseDB.ref(privatePath).orderByChild('timestamp').limitToLast(100).on('value', (snap) => {
                const msgs = snap.val() || {};
                const msgArray = Object.values(msgs);
                console.log('üì¨ Naƒçteno soukrom√Ωch zpr√°v:', msgArray.length, 'pro', myName);
                
                privateMessages = {};
                msgArray.forEach(msg => {
                    // P≈ôeskoƒç zpr√°vy bez from nebo to
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    privateMessages[other].push(msg);
                });
                
                console.log('üì¨ Konverzace:', Object.keys(privateMessages));
                
                // Notifikace pro nov√© soukrom√© zpr√°vy
                const incomingMsgs = msgArray.filter(m => m.from !== myName);
                if (incomingMsgs.length > lastPrivateMsgCount && lastPrivateMsgCount > 0) {
                    const lastMsg = incomingMsgs[incomingMsgs.length - 1];
                    notifySuccess('üì¨ Soukrom√° zpr√°va od ' + lastMsg.from, lastMsg.text?.substring(0, 40) || '');
                    
                    // P≈ôehr√°t zvuk pokud existuje
                    if (typeof SoundSystem !== 'undefined' && SoundSystem.play) {
                        SoundSystem.play('notification');
                    }
                }
                lastPrivateMsgCount = incomingMsgs.length;
            });
        }
        
        // Ulo≈æit p≈ô√°tele lok√°lnƒõ
        function saveFriendsList() {
            const myName = getPlayerName();
            try {
                localStorage.setItem('friendsList_' + myName, JSON.stringify(friendsList));
            } catch (e) {}
        }
        
        // Odeslat ≈æ√°dost o p≈ô√°telstv√≠
        async function sendFriendRequest(targetName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            if (!targetName || targetName.trim() === '') {
                notifyWarning('Chyba', 'Zadej jm√©no hr√°ƒçe!');
                return;
            }
            
            targetName = targetName.trim();
            
            if (targetName.toLowerCase() === myName.toLowerCase()) {
                notifyWarning('Chyba', 'Nem≈Ø≈æe≈° si poslat ≈æ√°dost s√°m sobƒõ!');
                return;
            }
            
            if (friendsList.some(f => f.toLowerCase() === targetName.toLowerCase())) {
                notifyWarning('Ji≈æ p≈ô√°tel√©', 'Tento hr√°ƒç u≈æ je tv≈Øj p≈ô√≠tel!');
                return;
            }
            
            try {
                // Ovƒõ≈ô ≈æe hr√°ƒç existuje v leaderboardu
                const leaderboardSnap = await firebaseDB.ref('leaderboard').orderByChild('name').equalTo(targetName).once('value');
                const playerExists = leaderboardSnap.exists();
                
                if (!playerExists) {
                    // Zkus case-insensitive hled√°n√≠
                    const allPlayersSnap = await firebaseDB.ref('leaderboard').once('value');
                    const allPlayers = allPlayersSnap.val() || {};
                    const foundPlayer = Object.values(allPlayers).find(p => 
                        p.name && p.name.toLowerCase() === targetName.toLowerCase()
                    );
                    
                    if (foundPlayer) {
                        targetName = foundPlayer.name; // Pou≈æij spr√°vn√© jm√©no
                    } else {
                        notifyWarning('Hr√°ƒç nenalezen', `Hr√°ƒç "${targetName}" neexistuje nebo je≈°tƒõ nehr√°l.`);
                        return;
                    }
                }
                
                // Po≈°li notifikaci druh√©mu hr√°ƒçi
                await firebaseDB.ref('notifications/' + targetName).push({
                    type: 'friend_request',
                    from: myName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    level: state.char.level
                });
                notifySuccess('Odesl√°no!', `≈Ω√°dost o p≈ô√°telstv√≠ odesl√°na hr√°ƒçi ${targetName}`);
            } catch (e) {
                console.error('Friend request error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se odeslat ≈æ√°dost: ' + e.message);
            }
        }
        
        // P≈ôijmout ≈æ√°dost o p≈ô√°telstv√≠
        async function acceptFriendRequest(requestId, fromName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                // P≈ôidej do lok√°ln√≠ho seznamu
                if (!friendsList.includes(fromName)) {
                    friendsList.push(fromName);
                    saveFriendsList();
                }
                
                // Sma≈æ ≈æ√°dost z notifikac√≠
                await firebaseDB.ref('notifications/' + myName + '/' + requestId).remove();
                
                // Notifikace druh√©mu hr√°ƒçi, ≈æe jsme p≈ôijali + p≈ôid√°me ho taky
                await firebaseDB.ref('notifications/' + fromName).push({
                    type: 'friend_accepted',
                    from: myName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                notifySuccess('P≈ô√≠tel p≈ôid√°n!', `${fromName} je nyn√≠ tv≈Øj p≈ô√≠tel`);
                showFriendsModal();
            } catch (e) {
                console.error('Accept friend error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se p≈ôijmout ≈æ√°dost');
            }
        }
        
        // Odm√≠tnout ≈æ√°dost
        async function declineFriendRequest(requestId) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                await firebaseDB.ref('notifications/' + getPlayerName() + '/' + requestId).remove();
                notifySuccess('Odm√≠tnuto', '≈Ω√°dost byla odm√≠tnuta');
                showFriendsModal();
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se odm√≠tnout ≈æ√°dost');
            }
        }
        
        // Odebrat p≈ô√≠tele
        async function removeFriend(friendName) {
            const idx = friendsList.indexOf(friendName);
            if (idx > -1) {
                friendsList.splice(idx, 1);
                saveFriendsList();
                notifySuccess('Odebr√°no', `${friendName} byl odebr√°n z p≈ô√°tel`);
                showFriendsModal();
            }
        }
        
        // Zobrazit modal p≈ô√°tel
        function showFriendsModal() {
            if (!multiplayerEnabled) {
                showModal('üë• P≈ô√°tel√©', '<p style="color: #888; text-align: center;">Multiplayer nen√≠ aktivn√≠</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            const myName = getPlayerName();
            console.log('üë• showFriendsModal - myName:', myName);
            console.log('üë• showFriendsModal - friendRequests:', friendRequests);
            console.log('üë• showFriendsModal - friendsList:', friendsList);
            
            // Refresh ≈æ√°dost√≠ p≈ô√≠mo z Firebase
            if (firebaseDB) {
                firebaseDB.ref('notifications/' + myName).once('value').then(snap => {
                    const notifications = snap.val() || {};
                    console.log('üë• Aktu√°ln√≠ notifikace v Firebase:', notifications);
                    
                    // Aktualizuj friendRequests
                    friendRequests = [];
                    Object.entries(notifications).forEach(([k, v]) => {
                        if (v.type === 'friend_request') {
                            friendRequests.push({...v, id: k});
                        }
                    });
                    
                    // Znovu vykresli modal s aktu√°ln√≠mi daty
                    renderFriendsModalContent();
                });
            }
            
            renderFriendsModalContent();
        }
        
        function renderFriendsModalContent() {
            let html = `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="friendSearchInput" placeholder="Jm√©no hr√°ƒçe..." style="flex: 1; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff;">
                        <button class="btn" onclick="sendFriendRequest(document.getElementById('friendSearchInput').value)" style="background: #4CAF50;">‚ûï P≈ôidat</button>
                    </div>
                </div>
            `;
            
            // ≈Ω√°dosti o p≈ô√°telstv√≠
            if (friendRequests.length > 0) {
                html += `<div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ff9800;">
                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">üì¨ ≈Ω√°dosti (${friendRequests.length})</h4>`;
                friendRequests.forEach(req => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="flex: 1; color: #fff;">${escapeHtml(req.from)} <span style="color: #666; font-size: 0.8rem;">Lvl ${req.level || '?'}</span></span>
                            <button class="btn" onclick="acceptFriendRequest('${req.id}', '${escapeHtml(req.from)}')" style="background: #4CAF50; padding: 0.3rem 0.6rem; font-size: 0.8rem;">‚úì</button>
                            <button class="btn" onclick="declineFriendRequest('${req.id}')" style="background: #c62828; padding: 0.3rem 0.6rem; font-size: 0.8rem;">‚úó</button>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Seznam p≈ô√°tel
            html += `<div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px;">
                <h4 style="color: #8bc34a; margin: 0 0 0.5rem 0;">üë• P≈ô√°tel√© (${friendsList.length})</h4>`;
            
            if (friendsList.length === 0) {
                html += `<p style="color: #666; text-align: center; padding: 1rem;">Zat√≠m nem√°≈° ≈æ√°dn√© p≈ô√°tele</p>`;
            } else {
                friendsList.forEach(friend => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: #0a0a0a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem;">
                            <span style="flex: 1; color: #fff;">${escapeHtml(friend)}</span>
                            <button class="btn" onclick="showPrivateChat('${escapeHtml(friend)}')" style="background: #2196f3; padding: 0.3rem 0.6rem; font-size: 0.8rem;">üí¨</button>
                            <button class="btn" onclick="sendGift('${escapeHtml(friend)}')" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">üéÅ</button>
                            <button class="btn" onclick="removeFriend('${escapeHtml(friend)}')" style="background: #555; padding: 0.3rem 0.6rem; font-size: 0.8rem;">‚úó</button>
                        </div>
                    `;
                });
            }
            html += `</div>`;
            
            html += `<button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>`;
            
            showModal('üë• P≈ô√°tel√©', html);
        }
        
        // === SOUKROM√â ZPR√ÅVY ===
        async function showPrivateChat(friendName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            // Naƒçti zpr√°vy p≈ô√≠mo z Firebase pro jistotu
            try {
                const snap = await firebaseDB.ref('chat/private/' + myName).orderByChild('timestamp').limitToLast(100).once('value');
                const allMsgs = snap.val() || {};
                
                // Oznaƒç zpr√°vy od tohoto p≈ô√≠tele jako p≈ôeƒçten√©
                const updates = {};
                Object.entries(allMsgs).forEach(([key, msg]) => {
                    if (msg.from === friendName && !msg.read) {
                        updates['chat/private/' + myName + '/' + key + '/read'] = true;
                    }
                });
                
                // Ulo≈æen√≠ do Firebase
                if (Object.keys(updates).length > 0) {
                    await firebaseDB.ref().update(updates);
                }
                
                const msgArray = Object.values(allMsgs);
                
                // Aktualizuj privateMessages
                privateMessages = {};
                msgArray.forEach(msg => {
                    // P≈ôeskoƒç zpr√°vy bez from nebo to
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    // Oznaƒç lok√°lnƒõ jako p≈ôeƒçten√©
                    if (msg.from === friendName) msg.read = true;
                    privateMessages[other].push(msg);
                });
            } catch (e) {
                console.error('Chyba naƒç√≠t√°n√≠ zpr√°v:', e);
            }
            
            const msgs = (privateMessages[friendName] || []).sort((a, b) => a.timestamp - b.timestamp).slice(-30);
            
            // Bezpeƒçn√© escapov√°n√≠ pro onclick
            const safeName = escapeHtml(friendName).replace(/'/g, "\\'");
            
            let messagesHtml = '';
            if (msgs.length === 0) {
                messagesHtml = '<div style="text-align: center; padding: 2rem; color: #666;">≈Ω√°dn√© zpr√°vy... Napi≈° prvn√≠!</div>';
            } else {
                msgs.forEach(msg => {
                    const isMe = msg.from === myName;
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}) : '';
                    messagesHtml += `
                        <div style="margin-bottom: 0.5rem; ${isMe ? 'text-align: right;' : ''}">
                            <div style="display: inline-block; max-width: 80%; background: ${isMe ? '#1a3a1a' : '#2a2a2a'}; padding: 0.5rem 0.8rem; border-radius: 12px;">
                                <div style="color: #ddd;">${escapeHtml(msg.text)}</div>
                                <div style="font-size: 0.65rem; color: #555; margin-top: 0.2rem;">${time}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            showModal(`üí¨ Chat s ${escapeHtml(friendName)}`, `
                <div id="privateChatMessages" style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #0a0a0a; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem;">
                    ${messagesHtml}
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="privateMsgInput" placeholder="Napi≈° zpr√°vu..." maxlength="200"
                        style="flex: 1; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff;"
                        onkeypress="if(event.key==='Enter') sendPrivateMessage('${safeName}')">
                    <button class="btn" onclick="sendPrivateMessage('${safeName}')" style="background: #4CAF50;">üì§</button>
                </div>
                
                <button class="btn" onclick="showInbox()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt</button>
            `);
            
            setTimeout(() => {
                const container = document.getElementById('privateChatMessages');
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        async function sendPrivateMessage(toName) {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Chyba', 'Multiplayer nen√≠ aktivn√≠');
                return;
            }
            
            const input = document.getElementById('privateMsgInput');
            if (!input || !input.value.trim()) {
                notifyWarning('Chyba', 'Napi≈° zpr√°vu');
                return;
            }
            
            const myName = getPlayerName();
            if (!myName) {
                notifyWarning('Chyba', 'Nejsi p≈ôihl√°≈°en');
                return;
            }
            
            const msg = {
                from: myName,
                to: toName,
                text: input.value.trim().substring(0, 200),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            try {
                // Ulo≈æ do obou inbox≈Ø p≈ôes chat/private
                console.log('üì§ Odes√≠l√°m SZ:', msg);
                await firebaseDB.ref('chat/private/' + myName).push(msg);
                await firebaseDB.ref('chat/private/' + toName).push(msg);
                
                input.value = '';
                notifySuccess('‚úì Odesl√°no', 'Zpr√°va odesl√°na');
                setTimeout(() => showPrivateChat(toName), 300);
            } catch (e) {
                console.error('Private message error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se odeslat: ' + e.message);
            }
        }
        
        // === LISTENER NA SOUKROM√â ZPR√ÅVY (poƒçet nep≈ôeƒçten√Ωch) ===
        function listenToPrivateMessages() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            if (!myName) return;
            
            // Listener na moje soukrom√© zpr√°vy
            firebaseDB.ref('chat/private/' + myName).on('value', (snap) => {
                const allMsgs = snap.val() || {};
                const msgArray = Object.values(allMsgs);
                
                // Spoƒç√≠tej nep≈ôeƒçten√©
                unreadPMCount = 0;
                privateMessages = {};
                
                msgArray.forEach(msg => {
                    // P≈ôeskoƒç zpr√°vy bez from nebo to
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    privateMessages[other].push(msg);
                    
                    // Poƒç√≠tej nep≈ôeƒçten√© (od ostatn√≠ch, ne moje)
                    if (msg.from !== myName && !msg.read) {
                        unreadPMCount++;
                    }
                });
                
                console.log('üì¨ Private messages updated, unread:', unreadPMCount);
                
                // Aktualizuj UI pokud jsme na online tabu
                if (state.activeTab === 'multiplayer') {
                    renderFull();
                }
            });
        }
        
        // === INBOX - P≈òEHLED V≈†ECH KONVERZAC√ç ===
        async function showInbox() {
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('üì¨ Soukrom√© zpr√°vy', '<p style="color: #888; text-align: center;">Mus√≠≈° b√Ωt online!</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            const myName = getPlayerName();
            
            // Naƒçti zpr√°vy p≈ô√≠mo z Firebase pro jistotu
            try {
                const snap = await firebaseDB.ref('chat/private/' + myName).orderByChild('timestamp').limitToLast(100).once('value');
                const allMsgs = snap.val() || {};
                const msgArray = Object.values(allMsgs);
                
                console.log('üì¨ Inbox: naƒçteno', msgArray.length, 'zpr√°v pro', myName);
                
                // Aktualizuj privateMessages
                privateMessages = {};
                msgArray.forEach(msg => {
                    // P≈ôeskoƒç zpr√°vy bez from nebo to (corrupted data)
                    if (!msg.from || !msg.to) return;
                    const other = msg.from === myName ? msg.to : msg.from;
                    // P≈ôeskoƒç undefined/null konverzace
                    if (!other || other === 'undefined' || other === 'null') return;
                    if (!privateMessages[other]) privateMessages[other] = [];
                    privateMessages[other].push(msg);
                });
            } catch (e) {
                console.error('Chyba naƒç√≠t√°n√≠ zpr√°v:', e);
            }
            
            // Z√≠skej v≈°echny konverzace
            const conversations = Object.entries(privateMessages).map(([name, msgs]) => {
                const sortedMsgs = msgs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                const lastMsg = sortedMsgs[0];
                const unreadCount = sortedMsgs.filter(m => m.from !== myName && !m.read).length;
                return {
                    name,
                    lastMsg,
                    unreadCount,
                    timestamp: lastMsg?.timestamp || 0
                };
            }).sort((a, b) => b.timestamp - a.timestamp);
            
            let html = '';
            
            if (conversations.length === 0) {
                html = `
                    <div style="text-align: center; padding: 2rem; color: #888;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <p>Zat√≠m nem√°≈° ≈æ√°dn√© zpr√°vy.</p>
                        <p style="font-size: 0.85rem;">Klikni na hr√°ƒçe v ≈æeb≈ô√≠ƒçku a po≈°li mu zpr√°vu!</p>
                    </div>
                `;
            } else {
                html = '<div style="max-height: 350px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                conversations.forEach(conv => {
                    const timeStr = conv.lastMsg?.timestamp ? new Date(conv.lastMsg.timestamp).toLocaleString('cs-CZ', {day: 'numeric', month: 'numeric', hour: '2-digit', minute: '2-digit'}) : '';
                    const isFromMe = conv.lastMsg?.from === myName;
                    const preview = conv.lastMsg?.text ? (conv.lastMsg.text.substring(0, 40) + (conv.lastMsg.text.length > 40 ? '...' : '')) : '≈Ω√°dn√° zpr√°va';
                    
                    html += `
                        <div onclick="showPrivateChat('${escapeHtml(conv.name)}')" style="display: flex; align-items: center; gap: 0.8rem; background: ${conv.unreadCount > 0 ? '#1a2a3a' : '#1a1a1a'}; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border-left: 3px solid ${conv.unreadCount > 0 ? '#2196f3' : '#333'};">
                            <div style="font-size: 2rem;">üë§</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #fff;">${escapeHtml(conv.name)}</span>
                                    ${conv.unreadCount > 0 ? `<span style="background: #2196f3; color: #fff; font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 10px;">${conv.unreadCount}</span>` : ''}
                                </div>
                                <div style="font-size: 0.8rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${isFromMe ? '<span style="color: #666;">Ty: </span>' : ''}${escapeHtml(preview)}
                                </div>
                                <div style="font-size: 0.7rem; color: #555; margin-top: 0.2rem;">${timeStr}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            html += `
                <div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid #333;">
                    <button class="btn" onclick="showNewMessageModal()" style="width: 100%; background: #e91e63; margin-bottom: 0.5rem;">
                        ‚úâÔ∏è Napsat novou zpr√°vu
                    </button>
                    <button class="btn" onclick="closeModal()" style="width: 100%; background: #555;">‚Üê Zav≈ô√≠t</button>
                </div>
            `;
            
            showModal('üì¨ Soukrom√© zpr√°vy', html);
        }
        
        // Napsat novou zpr√°vu - vybrat p≈ô√≠jemce
        async function showNewMessageModal() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Naƒçti online hr√°ƒçe
            let onlinePlayers = [];
            try {
                const snapshot = await firebaseDB.ref('online').once('value');
                const data = snapshot.val() || {};
                onlinePlayers = Object.values(data).filter(p => p.name !== getPlayerName());
            } catch (e) {}
            
            let html = `
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">P≈ô√≠jemce (jm√©no hr√°ƒçe):</label>
                    <input type="text" id="newMsgRecipient" placeholder="Zadej jm√©no hr√°ƒçe..."
                        style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                </div>
            `;
            
            if (onlinePlayers.length > 0) {
                html += `<p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">Online hr√°ƒçi:</p>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem;">`;
                onlinePlayers.slice(0, 10).forEach(p => {
                    html += `<button class="btn" onclick="document.getElementById('newMsgRecipient').value='${escapeHtml(p.name)}'" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #333;">üü¢ ${escapeHtml(p.name)}</button>`;
                });
                html += `</div>`;
            }
            
            if (friendsList.length > 0) {
                html += `<p style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">P≈ô√°tel√©:</p>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem;">`;
                friendsList.slice(0, 10).forEach(name => {
                    html += `<button class="btn" onclick="document.getElementById('newMsgRecipient').value='${escapeHtml(name)}'" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #1a3a1a;">üë• ${escapeHtml(name)}</button>`;
                });
                html += `</div>`;
            }
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="showInbox()" style="background: #555;">‚Üê Zpƒõt</button>
                    <button class="btn" onclick="startNewConversation()" style="background: #e91e63;">üí¨ Otev≈ô√≠t chat</button>
                </div>
            `;
            
            showModal('‚úâÔ∏è Nov√° zpr√°va', html);
        }
        
        function startNewConversation() {
            const input = document.getElementById('newMsgRecipient');
            if (!input || !input.value.trim()) {
                notifyWarning('Zadej jm√©no p≈ô√≠jemce!');
                return;
            }
            
            const recipient = input.value.trim();
            if (recipient === getPlayerName()) {
                notifyWarning('Nem≈Ø≈æe≈° ps√°t s√°m sobƒõ!');
                return;
            }
            
            showPrivateChat(recipient);
        }
        
        // === D√ÅRKY ===
        function sendGift(friendName) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            // Vyfiltruj itemy kter√© lze darovat
            const giftableItems = state.inv.filter(item => 
                item && item.id && !item.questItem && (item.price || item.value) > 0
            );
            
            if (giftableItems.length === 0) {
                showModal('üéÅ Odeslat d√°rek', `
                    <p style="color: #888; text-align: center;">Nem√°≈° ≈æ√°dn√© itemy k darov√°n√≠.</p>
                    <button class="btn" onclick="showFriendsModal()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>
                `);
                return;
            }
            
            let html = `<div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
            giftableItems.slice(0, 20).forEach((item, idx) => {
                const realIdx = state.inv.indexOf(item);
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                        <span style="font-size: 1.5rem;">${item.icon}</span>
                        <div style="flex: 1;">
                            <div style="color: #fff;">${escapeHtml(item.name)} ${item.count > 1 ? `<span style="color: #ffd700;">x${item.count}</span>` : ''}</div>
                        </div>
                        <button class="btn" onclick="confirmSendGift('${escapeHtml(friendName)}', ${realIdx})" style="background: #ff9800; padding: 0.3rem 0.6rem; font-size: 0.8rem;">üéÅ</button>
                    </div>
                `;
            });
            html += `</div>`;
            html += `<button class="btn" onclick="showFriendsModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>`;
            
            showModal(`üéÅ Poslat d√°rek: ${escapeHtml(friendName)}`, html);
        }
        
        async function confirmSendGift(friendName, itemIdx) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const item = state.inv[itemIdx];
            if (!item) return;
            
            const myName = getPlayerName();
            
            try {
                // Odeber z invent√°≈ôe
                const giftItem = {...item, count: 1};
                if (item.count > 1) {
                    state.inv[itemIdx].count--;
                } else {
                    state.inv.splice(itemIdx, 1);
                }
                
                // Po≈°li d√°rek
                await firebaseDB.ref('gifts/' + friendName).push({
                    from: myName,
                    item: giftItem,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Notifikace
                await firebaseDB.ref('notifications/' + friendName).push({
                    type: 'gift',
                    from: myName,
                    itemName: item.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                notifySuccess('D√°rek odesl√°n!', `${item.name} byl odesl√°n hr√°ƒçi ${friendName}`);
                saveGame();
                showFriendsModal();
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se odeslat d√°rek');
            }
        }
        
        // P≈ôijmout d√°rky
        function checkGifts() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            firebaseDB.ref('gifts/' + myName).once('value', async (snap) => {
                const gifts = snap.val();
                if (!gifts) return;
                
                for (const [key, gift] of Object.entries(gifts)) {
                    // P≈ôidej item
                    addItemToInventory(gift.item, 1, true);
                    notifySuccess('üéÅ D√°rek!', `${gift.from} ti poslal ${gift.item.name}`);
                    
                    // Sma≈æ z datab√°ze
                    await firebaseDB.ref('gifts/' + myName + '/' + key).remove();
                }
                saveGame();
            });
        }
        
        // === VYLEP≈†EN√â OBCHODOV√ÅN√ç ===
        
        // Historie transakc√≠
        let tradeHistory = [];
        
        function listenToTradeHistory() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            const sanitizedName = sanitizeFirebasePath(myName);
            firebaseDB.ref('tradeHistory/' + sanitizedName).orderByChild('timestamp').limitToLast(100).on('value', (snap) => {
                tradeHistory = Object.values(snap.val() || {}).sort((a, b) => b.timestamp - a.timestamp);
            });
        }
        
        // Hodnocen√≠ prodejce
        async function rateSeller(sellerName, rating) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                await firebaseDB.ref('ratings/' + sellerName + '/' + myName).set({
                    rating: rating,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                notifySuccess('Hodnocen√≠ ulo≈æeno!', `Dal jsi ${rating}‚≠ê hr√°ƒçi ${sellerName}`);
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se ulo≈æit hodnocen√≠');
            }
        }
        
        // Z√≠skat pr≈Ømƒõrn√© hodnocen√≠ prodejce
        async function getSellerRating(sellerName) {
            if (!multiplayerEnabled || !firebaseDB) return { avg: 0, count: 0 };
            
            try {
                const snap = await firebaseDB.ref('ratings/' + sellerName).once('value');
                const ratings = Object.values(snap.val() || {});
                if (ratings.length === 0) return { avg: 0, count: 0 };
                
                const sum = ratings.reduce((a, b) => a + b.rating, 0);
                return { avg: (sum / ratings.length).toFixed(1), count: ratings.length };
            } catch (e) {
                return { avg: 0, count: 0 };
            }
        }
        
        // Zobrazit historii obchod≈Ø
        async function showTradeHistory() {
            if (!multiplayerEnabled) {
                showModal('üìú Historie tr≈æi≈°tƒõ', '<p style="color: #888; text-align: center;">Multiplayer nen√≠ aktivn√≠</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            showModal('üìú Historie tr≈æi≈°tƒõ', '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m historii...</p></div>');
            
            try {
                // Naƒçti VE≈òEJNOU historii - v≈°echny obchody mezi hr√°ƒçi
                const snap = await firebaseDB.ref('publicTradeHistory').orderByChild('timestamp').limitToLast(100).once('value');
                const allTrades = Object.values(snap.val() || {}).sort((a, b) => b.timestamp - a.timestamp);
                
                let html = `
                    <p style="color: #888; text-align: center; font-size: 0.85rem; margin-bottom: 1rem;">
                        üìä Ve≈ôejn√Ω p≈ôehled v≈°ech obchod≈Ø na tr≈æi≈°ti
                    </p>
                    <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                `;
                
                if (allTrades.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">Zat√≠m ≈æ√°dn√© obchody na tr≈æi≈°ti</p>';
                } else {
                    const myName = getPlayerName();
                    allTrades.forEach(trade => {
                        const date = new Date(trade.timestamp).toLocaleDateString('cs-CZ');
                        const time = new Date(trade.timestamp).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'});
                        const isMyTrade = trade.seller === myName || trade.buyer === myName;
                        const isSeller = trade.seller === myName;
                        const isBuyer = trade.buyer === myName;
                        
                        // Zv√Ωraznƒõn√≠ vlastn√≠ch obchod≈Ø
                        const bgColor = isMyTrade ? '#1a2a1a' : '#1a1a1a';
                        const borderColor = isSeller ? '#4CAF50' : (isBuyer ? '#2196f3' : '#555');
                        
                        html += `
                            <div style="background: ${bgColor}; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; border-left: 3px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${trade.itemIcon || 'üì¶'}</span>
                                    <div style="flex: 1;">
                                        <div style="color: #fff; font-weight: bold;">
                                            ${trade.count > 1 ? trade.count + 'x ' : ''}${escapeHtml(trade.itemName)}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #888; margin-top: 0.2rem;">
                                            <span style="color: ${trade.seller === myName ? '#4CAF50' : '#aaa'};">${escapeHtml(trade.seller)}</span>
                                            <span style="color: #666;"> ‚Üí </span>
                                            <span style="color: ${trade.buyer === myName ? '#2196f3' : '#aaa'};">${escapeHtml(trade.buyer)}</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #ffd700; font-weight: bold;">${trade.price} üí∞</div>
                                        <div style="font-size: 0.65rem; color: #666;">${trade.pricePerUnit ? trade.pricePerUnit + '/ks' : ''}</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.65rem; color: #555; text-align: right; margin-top: 0.3rem;">
                                    ${date} ${time}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                html += `
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="showMyTradeHistory()" style="flex: 1; background: #2196f3;">üìã Moje obchody</button>
                        <button class="btn" onclick="showMarketplace()" style="flex: 1; background: #555;">‚Üê Zpƒõt</button>
                    </div>
                `;
                
                showModal('üìú Historie tr≈æi≈°tƒõ', html);
                
            } catch (e) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ historie:', e);
                showModal('üìú Historie tr≈æi≈°tƒõ', '<p style="color: #f44336; text-align: center;">Chyba p≈ôi naƒç√≠t√°n√≠</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
            }
        }
        
        // Moje osobn√≠ historie obchod≈Ø
        async function showMyTradeHistory() {
            if (!multiplayerEnabled) return;
            
            showModal('üìã Moje obchody', '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m...</p></div>');
            
            try {
                const myName = getPlayerName();
                const sanitizedName = sanitizeFirebasePath(myName);
                const snap = await firebaseDB.ref('tradeHistory/' + sanitizedName).orderByChild('timestamp').limitToLast(50).once('value');
                const myTrades = Object.values(snap.val() || {}).sort((a, b) => b.timestamp - a.timestamp);
                
                let html = '<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">';
                
                if (myTrades.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">≈Ω√°dn√© obchody</p>';
                } else {
                    myTrades.forEach(trade => {
                        const date = new Date(trade.timestamp).toLocaleDateString('cs-CZ');
                        const isBuy = trade.type === 'buy';
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${isBuy ? '#2196f3' : '#4CAF50'};">
                                <span style="font-size: 1.3rem;">${trade.itemIcon || 'üì¶'}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(trade.itemName)}</div>
                                    <div style="font-size: 0.75rem; color: #888;">
                                        ${isBuy ? '‚Üê Koupeno od' : '‚Üí Prod√°no'} <strong>${escapeHtml(trade.otherPlayer)}</strong> ‚Ä¢ ${date}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${isBuy ? '#f44336' : '#4CAF50'}; font-weight: bold;">${isBuy ? '-' : '+'}${trade.price} üí∞</div>
                                </div>
                            </div>
                        `;
                    });
                }
                html += '</div>';
                html += `<button class="btn" onclick="showTradeHistory()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt na historii</button>`;
                
                showModal('üìã Moje obchody', html);
                
            } catch (e) {
                console.error('Chyba:', e);
            }
        }
        
        // === ANTI-CHEAT SYST√âM ===
        
        // Validace itemu p≈ôed prodejem
        function validateItemForSale(item) {
            if (!item || !item.id) return { valid: false, reason: 'Neplatn√Ω item' };
            
            // Kontrola z√°kladn√≠ch vlastnost√≠
            const itemDef = ITEMS.find(i => i.id === item.id);
            if (!itemDef) return { valid: false, reason: 'Nezn√°m√Ω item' };
            
            // Kontrola podez≈ôel√Ωch hodnot
            if (item.damage && item.damage > 500) return { valid: false, reason: 'Podez≈ôele vysok√Ω damage' };
            if (item.defense && item.defense > 300) return { valid: false, reason: 'Podez≈ôele vysok√° obrana' };
            if (item.count && item.count > 9999) return { valid: false, reason: 'Podez≈ôele vysok√Ω poƒçet' };
            
            // Kontrola durability
            if (item.durability !== undefined && item.maxDurability !== undefined) {
                if (item.durability > item.maxDurability) return { valid: false, reason: 'Neplatn√° durabilita' };
            }
            
            return { valid: true };
        }
        
        // Validace hr√°ƒçsk√Ωch statistik
        function validatePlayerStats() {
            const issues = [];
            
            // Level check
            if (state.char.level > 100) issues.push('Podez≈ôel√Ω level');
            if (state.char.level < 1) issues.push('Neplatn√Ω level');
            
            // HP check
            if (state.hp > 9999) issues.push('Podez≈ôel√© HP');
            if (state.maxHp > 9999) issues.push('Podez≈ôel√© max HP');
            
            // Pen√≠ze check
            if (state.money > 99999999) issues.push('Podez≈ôel√© mno≈æstv√≠ penƒõz');
            if (state.money < 0) issues.push('Z√°porn√© pen√≠ze');
            
            // Stats check
            if (state.stats) {
                if (state.stats.kills > 99999) issues.push('Podez≈ôel√Ω poƒçet zabit√≠');
                if (state.stats.daysPlayed > 9999) issues.push('Podez≈ôel√Ω poƒçet dn√≠');
            }
            
            return issues;
        }
        
        // Odeslat report podez≈ôel√©ho hr√°ƒçe
        async function reportPlayer(playerName, reason) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            const myName = getPlayerName();
            
            try {
                await firebaseDB.ref('reports').push({
                    reporter: myName,
                    reported: playerName,
                    reason: reason,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                notifySuccess('Report odesl√°n', `Hr√°ƒç ${playerName} byl nahl√°≈°en`);
            } catch (e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se odeslat report');
            }
        }
        
        // Kontrola p≈ôed odesl√°n√≠m sk√≥re
        const originalSubmitScore = submitScore;
        submitScore = async function() {
            const issues = validatePlayerStats();
            if (issues.length > 0) {
                console.warn('‚ö†Ô∏è Anti-cheat varov√°n√≠:', issues);
                // St√°le ode≈°li, ale s flagy
            }
            return originalSubmitScore();
        };
        
        // Kontrola p≈ôed prodejem na marketplace
        const originalCreateMarketOffer = createMarketOffer;
        createMarketOffer = async function(item, price) {
            const validation = validateItemForSale(item);
            if (!validation.valid) {
                notifyWarning('Nelze prodat', validation.reason);
                return;
            }
            
            // Kontrola ceny
            if (price > 999999) {
                notifyWarning('P≈ô√≠li≈° vysok√° cena', 'Maxim√°ln√≠ cena je 999,999 üí∞');
                return;
            }
            
            return originalCreateMarketOffer(item, price);
        };
        
        // === INICIALIZACE VYLEP≈†EN√ç ===
        
        // P≈ôidej do Firebase init
        const originalInitFirebase = initFirebase;
        initFirebase = function() {
            const result = originalInitFirebase();
            
            // Po √∫spƒõ≈°n√©m p≈ôipojen√≠ inicializuj nov√© syst√©my
            setTimeout(() => {
                if (multiplayerEnabled) {
                    initFriendsSystem();
                    initTombolaListener();
                    listenToTradeHistory();
                    checkGifts();
                    restoreTerritoryCapture(); // Obnov rozdƒõlan√Ω capture po refreshi
                }
            }, 1000);
            
            return result;
        };
        
        // P≈ôidej tlaƒç√≠tko p≈ô√°tel do renderMultiplayerTab
        const originalRenderMultiplayerTab = renderMultiplayerTab;
        renderMultiplayerTab = function() {
            let html = originalRenderMultiplayerTab();
            
            // Definuj myName pro pou≈æit√≠ v ≈°ablonƒõ
            const myName = getPlayerName();
            
            // P≈ôidej sekci p≈ô√°tel p≈ôed CONNECTION STATUS
            const friendsSection = `
                <!-- FRIENDS & SOCIAL -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showFriendsModal()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.3rem;">
                        <span style="font-size: 1.5rem;">üë•</span>
                        <span style="font-weight: bold;">P≈ô√°tel√©</span>
                        <span style="font-size: 0.7rem; opacity: 0.8;">${friendsList.length} p≈ô√°tel${friendRequests.length > 0 ? ` ‚Ä¢ ${friendRequests.length} ≈æ√°dost√≠` : ''}</span>
                    </button>
                    <button class="btn" onclick="showTombola()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 1rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.3rem;">
                        <span style="font-size: 1.5rem;">üéüÔ∏è</span>
                        <span style="font-weight: bold;">Tombola</span>
                        <span style="font-size: 0.7rem; opacity: 0.8;">${currentTombola ? 'üü¢ Aktivn√≠!' : 'Loterie'}</span>
                    </button>
                </div>
                
                <!-- BUG REPORT + N√ÅPADY -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                    <button class="btn" onclick="showBugReportModal()" style="background: linear-gradient(135deg, #795548 0%, #5d4037 100%); padding: 0.8rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                        <span style="font-size: 1.2rem;">üêõ</span>
                        <span style="font-weight: bold; font-size: 0.85rem;">Nahl√°sit bug</span>
                    </button>
                    <button class="btn" onclick="checkPendingRewards()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); padding: 0.8rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                        <span style="font-size: 1.2rem;">üéÅ</span>
                        <span style="font-weight: bold; font-size: 0.85rem;">Vyzvednout odmƒõny</span>
                    </button>
                </div>
                
                <!-- N√ÅPADY -->
                <button class="btn" onclick="showIdeasModal()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üí°</span>
                    <span style="font-weight: bold;">N√°pady na hru</span>
                </button>
                
                <!-- PODPO≈òIT HRU -->
                <button class="btn" onclick="showDonateStep1()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 0.8rem; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">‚òï</span>
                    <span style="font-weight: bold;">Podpo≈ôit autora</span>
                    <span style="font-size: 1.2rem;">‚ù§Ô∏è</span>
                </button>
                
                <!-- S√ç≈á SL√ÅVY -->
                <button class="btn" onclick="showHallOfFame()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 0.8rem; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üëë</span>
                    <span style="font-weight: bold;">S√≠≈à Sl√°vy</span>
                    <span style="font-size: 1.2rem;">üèÜ</span>
                </button>
                
                <!-- KOMUNITA -->
                <button class="btn" onclick="openCommunityLinks()" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 0.8rem; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üåê</span>
                    <span style="font-weight: bold;">Komunita</span>
                    <span style="font-size: 1.2rem;">üë•</span>
                </button>
                
                <!-- RECENT CHAT PREVIEW -->
                ${chatMessages.length > 0 ? `
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 10px; border: 1px solid #333; margin-top: 1rem;">
                        <h3 style="margin: 0 0 0.8rem 0; color: #888; font-size: 0.9rem;">üí¨ Posledn√≠ zpr√°vy</h3>
                        <div style="max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                            ${chatMessages.slice(-5).reverse().map(msg => `
                                <div style="padding: 0.4rem; background: #0a0a0a; border-radius: 6px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                                    <span style="color: ${msg.author === myName ? '#8bc34a' : '#2196f3'};">${escapeHtml(msg.author)}:</span>
                                    <span style="color: #ccc;">${escapeHtml(msg.text?.substring(0, 50) || '')}${(msg.text?.length || 0) > 50 ? '...' : ''}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- ADMIN BUTTON (skryt√Ω) -->
                <div style="margin-top: 1rem; text-align: center;">
                    <button onclick="showAdminLogin()" style="background: transparent; border: none; color: #333; font-size: 0.7rem; cursor: pointer; padding: 0.5rem;">‚öôÔ∏è</button>
                </div>
            `;
            
            // Vlo≈æ p≈ôed CONNECTION STATUS
            html = html.replace('<!-- CONNECTION STATUS -->', friendsSection + '\n                <!-- CONNECTION STATUS -->');
            
            return html;
        };
        
        // ============================================
        // ‚òï DONATE - VTIPN√Å SEKVENCE MODAL≈Æ
        // ============================================
        
        function showDonateStep1() {
            showModal('ü§î Moment...', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">üßê</div>
                    <h3 style="color: #e91e63;">Poƒçkat, poƒçkat...</h3>
                    <p style="color: #888; font-size: 1.1rem; margin: 1rem 0;">
                        Ty chce≈° DOBROVOLNƒö poslat pen√≠ze?
                    </p>
                    <p style="color: #666; font-size: 0.9rem;">
                        V roce 2026? V t√©hle ekonomice?
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 1rem;">
                        üèÉ Ut√≠k√°m pryƒç
                    </button>
                    <button class="btn" onclick="showDonateStep2()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 1rem;">
                        üí™ Ano, jsem ≈°√≠lenec
                    </button>
                </div>
            `);
        }
        
        function showDonateStep2() {
            showModal('üò± V√°≈ænƒõ?!', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">ü´£</div>
                    <h3 style="color: #ff9800;">Ale... jsi si √öPLNƒö jist√Ω?</h3>
                    <p style="color: #888; font-size: 1.1rem; margin: 1rem 0;">
                        V√≠≈° ≈æe ta hra je zadarmo, ≈æe jo?
                    </p>
                    <p style="color: #666; font-size: 0.9rem;">
                        Mohl bys si za to koupit... nev√≠m... <br>
                        p≈Ølku rohl√≠ku? ü•ñ
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 1rem;">
                        ü•ñ Rad≈°i ten rohl√≠k
                    </button>
                    <button class="btn" onclick="showDonateStep3()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem;">
                        üî• Rohl√≠ky jsou p≈ôecenƒõn√©
                    </button>
                </div>
            `);
        }
        
        function showDonateStep3() {
            showModal('ü•∫ Posledn√≠ ≈°ance ut√©ct', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">üö®</div>
                    <h3 style="color: #f44336;">VAROV√ÅN√ç!</h3>
                    <p style="color: #888; font-size: 1.1rem; margin: 1rem 0;">
                        Za tyto pen√≠ze autor pravdƒõpodobnƒõ koup√≠:
                    </p>
                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                        <div style="color: #ff9800; margin: 0.3rem 0;">‚òï Kafe (hodnƒõ kafe)</div>
                        <div style="color: #ff9800; margin: 0.3rem 0;">üçï Nƒõjakou pizzu</div>
                        <div style="color: #ff9800; margin: 0.3rem 0;">üò¥ Mo≈æn√° i sp√°nek (nepravdƒõpodobn√©)</div>
                        <div style="color: #f44336; margin: 0.3rem 0;">‚ùå Urƒçitƒõ NE nov√© bugy do hry</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 1rem;">
                        üòÖ Ok, p≈ôehodnot√≠m to
                    </button>
                    <button class="btn" onclick="showDonateStep4()" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem;">
                        ü¶∏ Jsem hrdina!
                    </button>
                </div>
            `);
        }
        
        function showDonateStep4() {
            showModal('üéâ LEGENDA!', `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin: 1rem 0;">üèÜ‚ù§Ô∏èüèÜ</div>
                    <h3 style="color: #4caf50; font-size: 1.5rem;">Ty jsi absolutn√≠ LEGENDA!</h3>
                    <p style="color: #888; font-size: 1rem; margin: 1rem 0;">
                        War never changes... ale tvoje karma pr√°vƒõ stoupla na maximum! ‚ò¢Ô∏è
                    </p>
                    
                    <div style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; border: 2px solid #4caf50;">
                        <p style="color: #8bc34a; margin: 0 0 0.5rem 0; font-size: 0.9rem;">üì± ƒå√≠slo √∫ƒçtu:</p>
                        <p style="color: #fff; font-size: 1.4rem; font-weight: bold; margin: 0; font-family: monospace; letter-spacing: 1px;">
                            3103143163/0800
                        </p>
                        <p style="color: #666; font-size: 0.8rem; margin: 0.5rem 0 0 0;">
                            (ƒåesk√° spo≈ôitelna)
                        </p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; border: 2px solid #e91e63; margin-bottom: 1rem;">
                        <p style="color: #e91e63; margin: 0 0 0.5rem 0; font-weight: bold;">‚ö†Ô∏è D≈ÆLE≈ΩIT√â!</p>
                        <p style="color: #fff; margin: 0; font-size: 0.95rem;">
                            Do zpr√°vy pro p≈ô√≠jemce napi≈° sv≈Øj <strong style="color: #ffd700;">HERN√ç NICK</strong>!
                        </p>
                        <p style="color: #888; margin: 0.5rem 0 0 0; font-size: 0.85rem;">
                            Bude≈° nav≈ædy zaps√°n v <strong style="color: #e91e63;">S√≠ni Sl√°vy</strong> 
                            a dostane≈° speci√°ln√≠ odmƒõnu ve h≈ôe! üéÅ
                        </p>
                    </div>
                    
                    <button class="btn" onclick="showHallOfFame()" style="width: 100%; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 0.8rem; margin-bottom: 0.5rem;">
                        üëë Zobrazit S√≠≈à Sl√°vy
                    </button>
                    
                    <p style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">
                        PS: Je≈°tƒõ jedna vƒõc... vlastnƒõ ne, tentokr√°t ti jdu jen podƒõkovat! ü•§
                    </p>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem; font-size: 1.1rem;">
                    ‚ù§Ô∏è Zav≈ô√≠t (a b√Ωt √∫≈æasn√Ω)
                </button>
            `);
        }
        
        // === S√ç≈á SL√ÅVY - P≈òISPƒöVATEL√â ===
        async function showHallOfFame() {
            // Seznam p≈ôispƒõvatel≈Ø - naƒç√≠t√° se z Firebase + hardcoded legendy
            let donors = [];
            let hofEntries = [];
            
            // Hardcoded legendy (v≈ædy zobrazeni)
            const legends = [
                { name: 'MrBeeCZ', amount: 999999, subtitle: 'Nositel legend√°rn√≠ zbranƒõ "Penƒõ≈æenka Zk√°zy" üí∞' },
                { name: 'Musters/CZE', amount: 999998, subtitle: 'P≈ôe≈æil 1000 radscorpion≈Ø jen aby mohl donate-ovat ü¶Ç' },
                { name: 'Denny', amount: 999997, subtitle: 'Ten co reportuje bugy rychleji ne≈æ je st√≠h√°m opravit üêõ' },
                { name: 'HLB', amount: 999996, subtitle: 'Ekonomika pustiny se t≈ôese, kdy≈æ se p≈ôihl√°s√≠ üí∞' },
                { name: 'Samai', amount: 999995, subtitle: 'Va≈ô√≠ gul√°≈° tak dob≈ôe, ≈æe i zomb√≠ci chod√≠ na veƒçe≈ôi üç≤' },
                { name: 'Delli', amount: 999994, subtitle: 'Jedin√° p≈ôe≈æiv≈°√≠ co si d√°v√° manik√∫ru i bƒõhem apokalypsy üíÖ' },
                { name: 'Czipi', amount: 999993, subtitle: 'M√° tolik v√≠ƒçek, ≈æe by i Mr. House z√°vidƒõl üé∞' },
                { name: 'CzechMateMan', amount: 999992, subtitle: '≈†achuje s mutanty a v≈ædycky vyhraje - mat na t≈ôi tahy! ‚ôüÔ∏è' },
                { name: 'Pot√°pƒõƒç', amount: 999991, subtitle: 'War never changes... ale on se po≈ô√°d pot√°p√≠ pro loot ü§ø' }
            ];
            
            try {
                if (multiplayerEnabled && firebaseDB) {
                    // Naƒçti donory
                    const snap = await firebaseDB.ref('donors').orderByChild('amount').once('value');
                    const data = snap.val();
                    if (data) {
                        donors = Object.values(data).sort((a, b) => (b.amount || 0) - (a.amount || 0));
                    }
                    
                    // Naƒçti admin p≈ôidan√© z√°znamy
                    const hofSnap = await firebaseDB.ref('hallOfFame').once('value');
                    const hofData = hofSnap.val();
                    if (hofData) {
                        hofEntries = Object.values(hofData).map(e => ({ ...e, amount: 500000 })); // St≈ôedn√≠ priorita
                    }
                }
            } catch (e) {
                console.log('Donors load error:', e);
            }
            
            // Spoj hardcoded legendy + admin z√°znamy + Firebase donory
            const allEntries = [...legends, ...hofEntries, ...donors];
            // Odstra≈à duplicity (podle jm√©na)
            const uniqueEntries = allEntries.filter((entry, index, self) => 
                index === self.findIndex(e => e.name === entry.name)
            );
            // Se≈ôaƒè podle amount
            donors = uniqueEntries.sort((a, b) => (b.amount || 0) - (a.amount || 0));
            
            let donorsList = '';
            if (donors.length > 0) {
                donorsList = donors.map((d, i) => {
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '‚ù§Ô∏è';
                    const subtitle = d.subtitle || '';
                    return `
                        <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #e91e63; display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 1.5rem;">${medal}</span>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-weight: bold;">${escapeHtml(d.name || 'Anonym')}</div>
                                ${subtitle ? `<div style="color: #888; font-size: 0.75rem; font-style: italic;">${escapeHtml(subtitle)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                donorsList = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üèöÔ∏è</div>
                        <p style="font-size: 1.1rem;">S√≠≈à Sl√°vy je zat√≠m pr√°zdn√°...</p>
                        <p style="font-size: 0.9rem;">Buƒè PRVN√ç kdo se sem zap√≠≈°e!</p>
                        <div style="font-size: 2rem; margin-top: 1rem;">üëÄ</div>
                    </div>
                `;
            }
            
            showModal('üëë S√≠≈à Sl√°vy', `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üèõÔ∏è‚ú®üèõÔ∏è</div>
                    <p style="color: #e91e63; font-size: 1.1rem; margin: 0.5rem 0;">
                        Hrdinov√©, kte≈ô√≠ podpo≈ôili tuto hru!
                    </p>
                    <p style="color: #666; font-size: 0.85rem;">
                        (A zaslou≈æ√≠ si vƒõƒçnou sl√°vu... nebo aspo≈à uzn√°n√≠)
                    </p>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${donorsList}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showDonateStep1()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 0.8rem;">
                        ‚òï Chci b√Ωt taky!
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                        ‚Üê Zav≈ô√≠t
                    </button>
                </div>
            `);
        }
        
        // ============================================
        // üîê ADMIN PANEL
        // ============================================
        
        const ADMIN_NICK = 'Zaoo';
        
        // === SYST√âM ROL√ç ===
        // Admin m√° pln√° pr√°va, moder√°to≈ôi omezen√°
        const STAFF_ROLES = {
            admin: {
                name: 'Admin',
                icon: 'üëë',
                color: '#f44336',
                badge: 'üëë ADMIN',
                permissions: ['all'] // V≈°echna pr√°va
            },
            moderator: {
                name: 'Moder√°tor',
                icon: 'üõ°Ô∏è',
                color: '#2196f3',
                badge: 'üõ°Ô∏è MOD',
                permissions: ['chat', 'mute', 'marketplace', 'pvp', 'bugs', 'tombola', 'warzone', 'treasure'] // Omezen√° pr√°va
            },
            helper: {
                name: 'Helper',
                icon: 'üíö',
                color: '#4caf50',
                badge: 'üíö HELPER',
                permissions: ['chat', 'bugs'] // Minim√°ln√≠ pr√°va
            }
        };
        
        // Seznam staff ƒçlen≈Ø - P≈òIDEJ SEM NOV√â MODER√ÅTORY
        let STAFF_MEMBERS = {
            'Zaoo': 'admin',
            // P≈ôidej moder√°tory zde:
            // 'NickModeratora': 'moderator',
            // 'NickHelpera': 'helper',
        };
        
        function getStaffRole(playerName) {
            return STAFF_MEMBERS[playerName] || null;
        }
        
        function getStaffRoleData(playerName) {
            const role = getStaffRole(playerName);
            return role ? STAFF_ROLES[role] : null;
        }
        
        function hasPermission(permission) {
            const playerName = getPlayerName();
            const role = getStaffRole(playerName);
            if (!role) return false;
            const roleData = STAFF_ROLES[role];
            if (!roleData) return false;
            return roleData.permissions.includes('all') || roleData.permissions.includes(permission);
        }
        
        function isStaff() {
            return !!getStaffRole(getPlayerName());
        }
        let isAdminLoggedIn = false;
        
        function isAdmin() {
            const playerName = getPlayerName();
            return playerName === ADMIN_NICK;
        }
        
        function showAdminLogin() {
            // Kontrola jestli je hr√°ƒç staff podle nicku
            if (isStaff()) {
                isAdminLoggedIn = true;
                const roleData = getStaffRoleData(getPlayerName());
                notifySuccess(`üîì ${roleData.name} p≈ôihl√°≈°en`, 'V√≠tej zpƒõt, ' + getPlayerName() + '!');
                showAdminPanel();
            } else {
                notifyWarning('‚ùå P≈ô√≠stup odep≈ôen', 'Nem√°≈° administr√°torsk√° pr√°va');
            }
        }
        
        function checkAdminPassword() {
            // Ji≈æ nepot≈ôebujeme - admin je podle nicku
            showAdminLogin();
        }
        
        function showAdminPanel() {
            if (!isStaff()) {
                notifyWarning('‚ùå P≈ô√≠stup odep≈ôen', 'Pouze pro staff');
                return;
            }
            isAdminLoggedIn = true;
            
            const playerName = getPlayerName();
            const role = getStaffRole(playerName);
            const roleData = STAFF_ROLES[role];
            
            if (!multiplayerEnabled || !firebaseDB) {
                showModal('üîê Staff Panel', '<p style="color: #f44336; text-align: center;">Multiplayer nen√≠ aktivn√≠</p><button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">OK</button>');
                return;
            }
            
            // Generuj tlaƒç√≠tka podle permissions
            let buttonsHtml = '';
            
            // Chat - pro v≈°echny staff
            if (hasPermission('chat')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManageChat()" style="background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üí¨</span>
                        <div>
                            <div style="font-weight: bold;">Spr√°va chatu</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Mazat zpr√°vy v≈°ech hr√°ƒç≈Ø</div>
                        </div>
                    </button>
                `;
            }
            
            // Marketplace - moder√°tor+
            if (hasPermission('marketplace')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManageMarketplace()" style="background: linear-gradient(135deg, #ff9800 0%, #e65100 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üè™</span>
                        <div>
                            <div style="font-weight: bold;">Spr√°va tr≈æi≈°tƒõ</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Mazat nab√≠dky hr√°ƒç≈Ø</div>
                        </div>
                    </button>
                `;
            }
            
            // PvP - moder√°tor+
            if (hasPermission('pvp')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManagePvP()" style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">‚öîÔ∏è</span>
                        <div>
                            <div style="font-weight: bold;">Spr√°va PvP</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Mazat v√Ωzvy a souboje</div>
                        </div>
                    </button>
                `;
            }
            
            // Bug Reports - pro v≈°echny staff
            if (hasPermission('bugs')) {
                buttonsHtml += `
                    <button class="btn" onclick="showAdminBugReports()" style="background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üêõ</span>
                        <div>
                            <div style="font-weight: bold;">Bug Reporty</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Nahl√°≈°en√© chyby od hr√°ƒç≈Ø</div>
                        </div>
                    </button>
                `;
            }
            
            // Mute - moder√°tor+
            if (hasPermission('mute')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminManageMutes()" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üîá</span>
                        <div>
                            <div style="font-weight: bold;">Mute hr√°ƒç≈Ø</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Ztlumit hr√°ƒçe v chatu</div>
                        </div>
                    </button>
                `;
            }
            
            // Tombola - moder√°tor+
            if (hasPermission('tombola')) {
                buttonsHtml += `
                    <button class="btn" onclick="showAdminTombola()" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üéüÔ∏è</span>
                        <div>
                            <div style="font-weight: bold;">Tombola</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Vytvo≈ôit/spravovat tombolu</div>
                        </div>
                    </button>
                `;
            }
            
            // V√°leƒçn√° z√≥na - moder√°tor+
            if (hasPermission('warzone')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminWarZone()" style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">‚öîÔ∏è</span>
                        <div>
                            <div style="font-weight: bold;">V√°leƒçn√° z√≥na</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Vyhl√°sit bitvu o √∫zem√≠</div>
                        </div>
                    </button>
                `;
            }
            
            // Poklad - moder√°tor+
            if (hasPermission('treasure')) {
                buttonsHtml += `
                    <button class="btn" onclick="adminTreasure()" style="background: linear-gradient(135deg, #ffd700 0%, #ff8f00 100%); color: #000; padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üíé</span>
                        <div>
                            <div style="font-weight: bold;">Poklad</div>
                            <div style="font-size: 0.75rem; opacity: 0.6;">Um√≠stit poklad na mapu</div>
                        </div>
                    </button>
                `;
            }
            
            // === POUZE PRO ADMINA ===
            if (isAdmin()) {
                buttonsHtml += `
                    <div style="border-top: 2px solid #f44336; margin: 0.5rem 0; padding-top: 0.5rem;">
                        <div style="color: #f44336; font-size: 0.75rem; text-align: center; margin-bottom: 0.5rem;">üëë POUZE ADMIN</div>
                    </div>
                    
                    <button class="btn" onclick="adminManageLeaderboard()" style="background: linear-gradient(135deg, #ffd700 0%, #ff8f00 100%); color: #000; padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üèÜ</span>
                        <div>
                            <div style="font-weight: bold;">Spr√°va ≈æeb≈ô√≠ƒçku</div>
                            <div style="font-size: 0.75rem; opacity: 0.6;">Odebrat hr√°ƒçe ze ≈æeb≈ô√≠ƒçku</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="showAdminRewards()" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üéÅ</span>
                        <div>
                            <div style="font-weight: bold;">Odmƒõny hr√°ƒç≈Øm</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">D√°t odmƒõnu za vylep≈°en√≠/n√°pady</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="showAdminVIPColors()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üé®</span>
                        <div>
                            <div style="font-weight: bold;">VIP Barvy</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Zmƒõnit barvu nicku v chatu</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminResetPoker()" style="background: linear-gradient(135deg, #1a5a1a 0%, #2d8a2d 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üÉè</span>
                        <div>
                            <div style="font-weight: bold;">Reset Pokeru</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Resetovat poker st≈Øl</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminManageHallOfFame()" style="background: linear-gradient(135deg, #ffd700 0%, #e91e63 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üèõÔ∏è</span>
                        <div>
                            <div style="font-weight: bold;">S√≠≈à sl√°vy</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">P≈ôidat/odebrat hr√°ƒçe</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminManageBans()" style="background: linear-gradient(135deg, #b71c1c 0%, #7f0000 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üö´</span>
                        <div>
                            <div style="font-weight: bold;">Ban hr√°ƒç≈Ø</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Zak√°zat p≈ô√≠stup do hry</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="adminClearCaptures()" style="background: linear-gradient(135deg, #795548 0%, #4e342e 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üè¥</span>
                        <div>
                            <div style="font-weight: bold;">Vyƒçistit Capture</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Odstranit zaseknut√© obsazov√°n√≠</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="showStaffManager()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); padding: 1rem; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üë•</span>
                        <div>
                            <div style="font-weight: bold;">Spr√°va Staff</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">P≈ôidat/odebrat moder√°tory</div>
                        </div>
                    </button>
                `;
            }
            
            showModal(`${roleData.icon} ${roleData.name.toUpperCase()} PANEL`, `
                <div style="background: linear-gradient(135deg, #1a1a2a 0%, #2a1a1a 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid ${roleData.color};">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.5rem;">${roleData.icon}</span>
                        <span style="color: ${roleData.color}; font-weight: bold;">${roleData.name} re≈æim</span>
                    </div>
                    <p style="color: #888; font-size: 0.8rem; margin: 0;">P≈ôihl√°≈°en jako: <strong style="color: ${roleData.color};">${playerName}</strong></p>
                </div>
                
                <div style="display: grid; gap: 0.5rem; max-height: 60vh; overflow-y: auto;">
                    ${buttonsHtml}
                </div>
                
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #333;">‚úó Zav≈ô√≠t</button>
            `);
        }
        
        // Spr√°va staff ƒçlen≈Ø (pouze admin)
        function showStaffManager() {
            if (!isAdmin()) {
                notifyWarning('‚ùå P≈ô√≠stup odep≈ôen', 'Pouze pro admina');
                return;
            }
            
            let staffHtml = '<div style="max-height: 300px; overflow-y: auto;">';
            
            for (const [name, role] of Object.entries(STAFF_MEMBERS)) {
                const roleData = STAFF_ROLES[role];
                staffHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #2a2a2a; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid ${roleData.color};">
                        <span>${roleData.icon} <strong>${name}</strong> - ${roleData.name}</span>
                        ${name !== ADMIN_NICK ? `<button class="btn" onclick="removeStaffMember('${name}')" style="background: #c62828; padding: 0.2rem 0.5rem; font-size: 0.75rem;">‚úó</button>` : '<span style="color: #ffd700; font-size: 0.75rem;">Hlavn√≠ admin</span>'}
                    </div>
                `;
            }
            staffHtml += '</div>';
            
            showModal('üë• Spr√°va Staff', `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #888; margin: 0 0 0.5rem 0;">Aktu√°ln√≠ Staff:</h4>
                    ${staffHtml}
                </div>
                
                <div style="background: #1a3a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="color: #4caf50; margin: 0 0 0.5rem 0;">‚ûï P≈ôidat nov√©ho ƒçlena:</h4>
                    <input type="text" id="newStaffNick" placeholder="Nick hr√°ƒçe" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px;">
                    <select id="newStaffRole" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px;">
                        <option value="helper">üíö Helper - pouze chat a bugy</option>
                        <option value="moderator">üõ°Ô∏è Moder√°tor - chat, mute, tr≈æi≈°tƒõ, PvP</option>
                    </select>
                    <button class="btn" onclick="addStaffMember()" style="width: 100%; background: #4caf50;">‚ûï P≈ôidat</button>
                </div>
                
                <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; font-size: 0.8rem; color: #888;">
                    <strong>Role:</strong><br>
                    üëë <strong>Admin</strong> - v≈°echna pr√°va<br>
                    üõ°Ô∏è <strong>Moder√°tor</strong> - chat, mute, tr≈æi≈°tƒõ, PvP, bugy<br>
                    üíö <strong>Helper</strong> - chat, bugy
                </div>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function addStaffMember() {
            if (!isAdmin()) return;
            
            const nick = document.getElementById('newStaffNick')?.value?.trim();
            const role = document.getElementById('newStaffRole')?.value;
            
            if (!nick) {
                notifyWarning('Chyba', 'Zadej nick hr√°ƒçe');
                return;
            }
            
            if (STAFF_MEMBERS[nick]) {
                notifyWarning('Chyba', 'Tento hr√°ƒç u≈æ je staff');
                return;
            }
            
            // P≈ôidej do STAFF_MEMBERS (pouze v pamƒõti - pro trval√© p≈ôid√°n√≠ je t≈ôeba upravit k√≥d)
            STAFF_MEMBERS[nick] = role;
            
            // Ulo≈æ do Firebase pro persistenci
            if (firebaseDB) {
                await firebaseDB.ref('adminData/staffMembers/' + nick.replace(/[\\/\\.#$\\[\\]]/g, '_')).set(role);
            }
            
            const roleData = STAFF_ROLES[role];
            notifySuccess('‚úì Staff p≈ôid√°n', `${nick} je nyn√≠ ${roleData.name}`);
            showStaffManager();
        }
        
        async function removeStaffMember(nick) {
            if (!isAdmin()) return;
            if (nick === ADMIN_NICK) {
                notifyWarning('Chyba', 'Nelze odebrat hlavn√≠ho admina');
                return;
            }
            
            delete STAFF_MEMBERS[nick];
            
            // Odeber z Firebase
            if (firebaseDB) {
                await firebaseDB.ref('adminData/staffMembers/' + nick.replace(/[\\/\\.#$\\[\\]]/g, '_')).remove();
            }
            
            notifySuccess('‚úì Odebr√°no', `${nick} byl odebr√°n ze staff`);
            showStaffManager();
        }
        
        // Naƒçti staff ƒçleny z Firebase p≈ôi startu
        async function loadStaffMembers() {
            if (!firebaseDB) return;
            
            try {
                const snap = await firebaseDB.ref('adminData/staffMembers').once('value');
                const data = snap.val();
                if (data) {
                    for (const [nick, role] of Object.entries(data)) {
                        if (!STAFF_MEMBERS[nick]) {
                            STAFF_MEMBERS[nick] = role;
                        }
                    }
                }
                console.log('üë• Staff naƒçten:', Object.keys(STAFF_MEMBERS));
            } catch (e) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ staff:', e);
            }
        }
        
        // === SPR√ÅVA CHATU ===
        async function adminManageChat() {
            if (!isStaff()) return;
            
            showModal('üí¨ Spr√°va chatu', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m zpr√°vy...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('chat/messages').orderByChild('timestamp').limitToLast(100).once('value');
                const messages = [];
                snap.forEach(child => {
                    messages.push({ id: child.key, ...child.val() });
                });
                messages.reverse();
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                if (messages.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">≈Ω√°dn√© zpr√°vy</p>';
                } else {
                    messages.forEach(msg => {
                        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString('cs-CZ') : '?';
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <div style="flex: 1;">
                                    <div style="color: #2196f3; font-size: 0.8rem;">${escapeHtml(msg.author)} <span style="color: #555;">${time}</span></div>
                                    <div style="color: #ccc; font-size: 0.9rem;">${escapeHtml(msg.text?.substring(0, 50))}${msg.text?.length > 50 ? '...' : ''}</div>
                                </div>
                                <button onclick="adminDeleteChatMessage('${msg.id}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearAllChat()" style="background: #c62828;">üóëÔ∏è Smazat V≈†E</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;">‚Üê Zpƒõt</button>
                    </div>
                `;
                
                showModal('üí¨ Spr√°va chatu', html);
            } catch (e) {
                showModal('üí¨ Spr√°va chatu', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>`);
            }
        }
        
        async function adminDeleteChatMessage(msgId) {
            if (!hasPermission('chat')) return;
            try {
                await firebaseDB.ref('chat/messages/' + msgId).remove();
                notifySuccess('Smaz√°no', 'Zpr√°va byla odstranƒõna');
                adminManageChat();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllChat() {
            if (!isAdmin()) return; // Smazat V≈†E m≈Ø≈æe jen admin
            if (!confirm('Opravdu smazat V≈†ECHNY zpr√°vy v chatu?')) return;
            
            try {
                await firebaseDB.ref('chat/messages').remove();
                notifySuccess('Chat smaz√°n', 'V≈°echny zpr√°vy byly odstranƒõny');
                adminManageChat();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === SPR√ÅVA TR≈ΩI≈†Tƒö ===
        async function adminManageMarketplace() {
            if (!hasPermission('marketplace')) return;
            
            showModal('üè™ Spr√°va tr≈æi≈°tƒõ', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m nab√≠dky...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('marketplace/offers').once('value');
                const offers = [];
                snap.forEach(child => {
                    offers.push({ id: child.key, ...child.val() });
                });
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                const activeOffers = offers.filter(o => o.status === 'active');
                if (activeOffers.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">≈Ω√°dn√© aktivn√≠ nab√≠dky</p>';
                } else {
                    activeOffers.forEach(offer => {
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <span style="font-size: 1.3rem;">${offer.item?.icon || 'üì¶'}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(offer.item?.name || '?')} <span style="color: #ffd700;">${offer.price} üí∞</span></div>
                                    <div style="color: #888; font-size: 0.75rem;">Prod√°v√°: ${escapeHtml(offer.seller || '?')}</div>
                                </div>
                                <button onclick="adminDeleteOffer('${offer.id}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearAllOffers()" style="background: #c62828;">üóëÔ∏è Smazat V≈†E</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;">‚Üê Zpƒõt</button>
                    </div>
                `;
                
                showModal('üè™ Spr√°va tr≈æi≈°tƒõ', html);
            } catch (e) {
                showModal('üè™ Spr√°va tr≈æi≈°tƒõ', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>`);
            }
        }
        
        async function adminDeleteOffer(offerId) {
            if (!hasPermission('marketplace')) return;
            try {
                await firebaseDB.ref('marketplace/offers/' + offerId).remove();
                notifySuccess('Smaz√°no', 'Nab√≠dka byla odstranƒõna');
                adminManageMarketplace();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllOffers() {
            if (!isAdmin()) return; // Smazat V≈†E m≈Ø≈æe jen admin
            if (!confirm('Opravdu smazat V≈†ECHNY nab√≠dky na tr≈æi≈°ti?')) return;
            
            try {
                await firebaseDB.ref('marketplace/offers').remove();
                notifySuccess('Tr≈æi≈°tƒõ smaz√°no', 'V≈°echny nab√≠dky byly odstranƒõny');
                adminManageMarketplace();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === SPR√ÅVA ≈ΩEB≈ò√çƒåKU ===
        async function adminManageLeaderboard() {
            if (!isAdmin()) return;
            
            showModal('üèÜ Spr√°va ≈æeb≈ô√≠ƒçku', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m ≈æeb≈ô√≠ƒçek...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('leaderboard').orderByChild('score').once('value');
                const players = [];
                snap.forEach(child => {
                    players.push({ id: child.key, ...child.val() });
                });
                players.sort((a, b) => (b.score || 0) - (a.score || 0));
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                if (players.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">≈Ω√°dn√≠ hr√°ƒçi v ≈æeb≈ô√≠ƒçku</p>';
                } else {
                    players.forEach((player, idx) => {
                        const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}.`;
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <span style="min-width: 30px; text-align: center;">${medal}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(player.name || player.id)}</div>
                                    <div style="color: #888; font-size: 0.75rem;">Lvl ${player.level || '?'} | Score: ${(player.score || 0).toLocaleString()}</div>
                                </div>
                                <button onclick="adminDeletePlayer('${escapeHtml(player.id)}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearLeaderboard()" style="background: #c62828;">üóëÔ∏è Smazat V≈†E</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;">‚Üê Zpƒõt</button>
                    </div>
                `;
                
                showModal('üèÜ Spr√°va ≈æeb≈ô√≠ƒçku', html);
            } catch (e) {
                showModal('üèÜ Spr√°va ≈æeb≈ô√≠ƒçku', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>`);
            }
        }
        
        async function adminDeletePlayer(playerId) {
            if (!isAdmin()) return;
            if (!confirm(`Opravdu odebrat hr√°ƒçe "${playerId}" ze ≈æeb≈ô√≠ƒçku?`)) return;
            
            try {
                await firebaseDB.ref('leaderboard/' + playerId).remove();
                await firebaseDB.ref('online/' + playerId).remove();
                notifySuccess('Smaz√°no', 'Hr√°ƒç byl odebr√°n ze ≈æeb≈ô√≠ƒçku');
                adminManageLeaderboard();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearLeaderboard() {
            if (!isAdmin()) return;
            if (!confirm('Opravdu smazat CEL√ù ≈æeb≈ô√≠ƒçek? Tato akce je nevratn√°!')) return;
            if (!confirm('JSTE SI OPRAVDU JISTI? V≈°echna sk√≥re budou ztracena!')) return;
            
            try {
                await firebaseDB.ref('leaderboard').remove();
                notifySuccess('≈Ωeb≈ô√≠ƒçek smaz√°n', 'V≈°ichni hr√°ƒçi byli odebr√°ni');
                adminManageLeaderboard();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === SPR√ÅVA PVP ===
        async function adminManagePvP() {
            if (!hasPermission('pvp')) return;
            
            showModal('‚öîÔ∏è Spr√°va PvP', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('pvp/challenges').once('value');
                const challenges = [];
                snap.forEach(child => {
                    challenges.push({ id: child.key, ...child.val() });
                });
                
                let html = `<div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">`;
                
                if (challenges.length === 0) {
                    html += '<p style="color: #666; text-align: center; padding: 2rem;">≈Ω√°dn√© PvP v√Ωzvy</p>';
                } else {
                    challenges.forEach(ch => {
                        html += `
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem;">
                                <div style="flex: 1;">
                                    <div style="color: #fff;">${escapeHtml(ch.challenger || '?')} vs ${escapeHtml(ch.target || '?')}</div>
                                    <div style="color: #888; font-size: 0.75rem;">Status: ${ch.status || '?'} | S√°zka: ${ch.bet || 0} üí∞</div>
                                </div>
                                <button onclick="adminDeleteChallenge('${ch.id}')" style="background: #c62828; border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminClearAllPvP()" style="background: #c62828;">üóëÔ∏è Smazat V≈†E</button>
                        <button class="btn" onclick="showAdminPanel()" style="background: #333;">‚Üê Zpƒõt</button>
                    </div>
                `;
                
                showModal('‚öîÔ∏è Spr√°va PvP', html);
            } catch (e) {
                showModal('‚öîÔ∏è Spr√°va PvP', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>`);
            }
        }
        
        async function adminDeleteChallenge(challengeId) {
            if (!hasPermission('pvp')) return;
            try {
                await firebaseDB.ref('pvp/challenges/' + challengeId).remove();
                notifySuccess('Smaz√°no', 'V√Ωzva byla odstranƒõna');
                adminManagePvP();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllPvP() {
            if (!isAdmin()) return; // Smazat V≈†E m≈Ø≈æe jen admin
            if (!confirm('Opravdu smazat V≈†ECHNY PvP v√Ωzvy?')) return;
            
            try {
                await firebaseDB.ref('pvp/challenges').remove();
                notifySuccess('PvP smaz√°no', 'V≈°echny v√Ωzvy byly odstranƒõny');
                adminManagePvP();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === ADMIN ODMƒöNY ZA VYLEP≈†EN√ç ===
        async function showAdminRewards() {
            if (!isAdmin()) return;
            
            // Naƒçti seznam hr√°ƒç≈Ø z OBOU zdroj≈Ø - leaderboard i players
            let players = [];
            let playerNames = new Set();
            
            try {
                // 1. Z leaderboard
                const leaderboardSnap = await firebaseDB.ref('leaderboard').orderByChild('score').limitToLast(500).once('value');
                const leaderboardData = leaderboardSnap.val();
                
                if (leaderboardData) {
                    Object.entries(leaderboardData).forEach(([name, info]) => {
                        if (!name.startsWith('user_') || name.length < 20) {
                            players.push({
                                name,
                                level: info.level || 1,
                                score: info.score || 0
                            });
                            playerNames.add(name);
                        }
                    });
                }
                
                // 2. Z players - p≈ôidej ty co nejsou v leaderboardu
                const playersSnap = await firebaseDB.ref('players').limitToLast(500).once('value');
                const playersData = playersSnap.val();
                
                if (playersData) {
                    Object.entries(playersData).forEach(([name, info]) => {
                        if (!playerNames.has(name) && (!name.startsWith('user_') || name.length < 20)) {
                            players.push({
                                name,
                                level: info.level || 1,
                                score: info.score || 0
                            });
                            playerNames.add(name);
                        }
                    });
                }
                
                // Se≈ôaƒè podle score
                players.sort((a, b) => b.score - a.score);
                
                // P≈ôidej admina na zaƒç√°tek seznamu pokud tam nen√≠ (se spr√°vn√Ωm levelem)
                const adminName = ADMIN_NICK || 'Zaoo';
                if (!playerNames.has(adminName)) {
                    const adminLevel = state.char?.level || 1;
                    const adminScore = state.stats?.score || 0;
                    players.unshift({ name: adminName, level: adminLevel, score: adminScore });
                }
                
                console.log('üìã Naƒçteno hr√°ƒç≈Ø pro odmƒõny:', players.length);
            } catch (e) {
                console.error('Error loading players:', e);
            }
            
            // P≈ôeddefinovan√© odmƒõny (ni≈æ≈°√≠ hodnoty pro vyv√°≈æen√≠)
            const rewardPresets = [
                { id: 'small', name: 'üéÅ Mal√° odmƒõna', money: 25, xp: 10, desc: 'Drobn√Ω tip/oprava' },
                { id: 'medium', name: 'üéÅ St≈ôedn√≠ odmƒõna', money: 50, xp: 25, desc: 'U≈æiteƒçn√Ω n√°pad' },
                { id: 'large', name: 'üéÅ Velk√° odmƒõna', money: 100, xp: 50, desc: 'V√Ωznamn√© vylep≈°en√≠' },
                { id: 'epic', name: 'üèÜ Epick√° odmƒõna', money: 250, xp: 100, desc: 'Z√°sadn√≠ p≈ô√≠spƒõvek' },
                { id: 'custom', name: '‚úèÔ∏è Vlastn√≠', money: 0, xp: 0, desc: 'Nastavit ruƒçnƒõ' }
            ];
            
            let playersHtml = players.length > 0 
                ? players.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)} (Lv.${p.level}, ${p.score} bod≈Ø)</option>`).join('')
                : '<option value="">≈Ω√°dn√≠ hr√°ƒçi v ≈æeb≈ô√≠ƒçku</option>';
            
            let presetsHtml = rewardPresets.map(r => `
                <option value="${r.id}" data-money="${r.money}" data-xp="${r.xp}">${r.name} - ${r.desc}</option>
            `).join('');
            
            // Seznam p≈ôedmƒõt≈Ø pro v√Ωbƒõr (rare+)
            const rewardItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legendary' || i.price >= 100)
                .sort((a, b) => (b.price || 0) - (a.price || 0));
            let itemsHtml = '<option value="">-- ≈Ω√°dn√Ω p≈ôedmƒõt --</option>' + 
                rewardItems.map(i => `<option value="${i.id}">${i.icon} ${i.name} ${i.rarity ? '(' + i.rarity + ')' : ''}</option>`).join('');
            
            showModal('üéÅ Odmƒõny za vylep≈°en√≠', `
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4caf50;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.9rem;">
                        üí° Zde m≈Ø≈æe≈° d√°t odmƒõnu hr√°ƒç≈Øm, kte≈ô√≠ navrhli vylep≈°en√≠ nebo nahl√°sili chyby.
                    </p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üë§ Hr√°ƒç: <span style="color: #4caf50;">(${players.length} hr√°ƒç≈Ø)</span></label>
                    <select id="rewardPlayerSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem; max-height: 300px;">
                        <option value="">-- Vyber hr√°ƒçe --</option>
                        ${playersHtml}
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üéÅ Typ odmƒõny:</label>
                    <select id="rewardPresetSelect" onchange="updateRewardPreset()" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                        ${presetsHtml}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ffd700; font-size: 0.85rem;">üí∞ Pen√≠ze:</label>
                        <input type="number" id="rewardMoney" value="0" min="0" max="999999" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem; font-size: 1.1rem; font-weight: bold;">
                    </div>
                    <div>
                        <label style="color: #8bc34a; font-size: 0.85rem;">‚≠ê XP:</label>
                        <input type="number" id="rewardXP" value="0" min="0" max="999999" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #8bc34a; border: 1px solid #8bc34a; border-radius: 6px; margin-top: 0.3rem; font-size: 1.1rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ff9800; font-size: 0.85rem;">üî´ N√°boje:</label>
                        <select id="rewardAmmo" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #ff9800; border-radius: 6px; margin-top: 0.3rem;">
                            <option value="">-- ≈Ω√°dn√© --</option>
                            <option value="9mm">üîπ 9mm pistole</option>
                            <option value="shell">üî∏ Broky</option>
                            <option value="rifle">üîπ Pu≈°kov√©</option>
                            <option value="energy">‚ö° Energetick√©</option>
                            <option value="arrow">üèπ ≈†√≠py</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ff9800; font-size: 0.85rem;">Poƒçet:</label>
                        <input type="number" id="rewardAmmoCount" value="50" min="1" max="9999" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #ff9800; border: 1px solid #ff9800; border-radius: 6px; margin-top: 0.3rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div>
                        <label style="color: #9c7cff; font-size: 0.85rem;">üì¶ P≈ôedmƒõt:</label>
                        <select id="rewardItem" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #9c7cff; border-radius: 6px; margin-top: 0.3rem;">
                            ${itemsHtml}
                        </select>
                    </div>
                    <div>
                        <label style="color: #9c7cff; font-size: 0.85rem;">Poƒçet:</label>
                        <input type="number" id="rewardItemCount" value="1" min="1" max="99" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #9c7cff; border: 1px solid #9c7cff; border-radius: 6px; margin-top: 0.3rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üìù D≈Øvod (zobraz√≠ se hr√°ƒçi):</label>
                    <input type="text" id="rewardReason" placeholder="nap≈ô. N√°vrh nov√©ho questu" maxlength="100" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                </div>
                
                <button class="btn" onclick="sendAdminReward()" style="width: 100%; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 1rem; font-size: 1rem;">
                    üéÅ Odeslat odmƒõnu
                </button>
                
                <button class="btn" onclick="showRewardHistory()" style="width: 100%; margin-top: 0.5rem; background: #2196f3;">
                    üìã Historie odmƒõn
                </button>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        function updateRewardPreset() {
            const select = document.getElementById('rewardPresetSelect');
            const option = select.options[select.selectedIndex];
            const money = option.dataset.money || 0;
            const xp = option.dataset.xp || 0;
            
            document.getElementById('rewardMoney').value = money;
            document.getElementById('rewardXP').value = xp;
        }
        
        async function sendAdminReward() {
            if (!isAdmin()) return;
            
            const playerName = document.getElementById('rewardPlayerSelect').value;
            const money = parseInt(document.getElementById('rewardMoney').value) || 0;
            const xp = parseInt(document.getElementById('rewardXP').value) || 0;
            const ammoType = document.getElementById('rewardAmmo')?.value || '';
            const ammoCount = parseInt(document.getElementById('rewardAmmoCount')?.value) || 0;
            const itemId = document.getElementById('rewardItem')?.value || '';
            const itemCount = parseInt(document.getElementById('rewardItemCount')?.value) || 1;
            const reason = document.getElementById('rewardReason').value.trim() || 'Odmƒõna od admina';
            
            if (!playerName) {
                notifyWarning('Chyba', 'Vyber hr√°ƒçe!');
                return;
            }
            
            if (money <= 0 && xp <= 0 && !itemId && !ammoType) {
                notifyWarning('Chyba', 'Nastav alespo≈à pen√≠ze, XP, n√°boje nebo p≈ôedmƒõt!');
                return;
            }
            
            // Z√≠skej info o p≈ôedmƒõtu
            let itemData = null;
            if (itemId) {
                const item = ITEMS.find(i => i.id === itemId);
                if (item) {
                    itemData = {
                        id: item.id,
                        name: item.name,
                        icon: item.icon,
                        count: Math.min(itemCount, 99) // max 99 kus≈Ø
                    };
                }
            }
            
            // Info o n√°boj√≠ch
            let ammoData = null;
            if (ammoType && ammoCount > 0) {
                const ammoNames = {
                    '9mm': 'üîπ 9mm',
                    'shell': 'üî∏ Broky',
                    'rifle': 'üîπ Pu≈°kov√©',
                    'energy': '‚ö° Energetick√©',
                    'arrow': 'üèπ ≈†√≠py'
                };
                ammoData = {
                    type: ammoType,
                    count: Math.min(ammoCount, 9999),
                    name: ammoNames[ammoType] || ammoType
                };
            }
            
            try {
                // Sestav text zpr√°vy
                let rewardText = [];
                if (money > 0) rewardText.push(money + 'üí∞');
                if (xp > 0) rewardText.push(xp + '‚≠êXP');
                if (ammoData) rewardText.push(ammoData.count + 'x ' + ammoData.name);
                if (itemData) rewardText.push(itemData.count + 'x ' + itemData.icon + ' ' + itemData.name);
                
                // Ulo≈æ odmƒõnu do notifications (real-time listener)
                const rewardData = {
                    type: 'admin_reward',
                    money: money,
                    xp: xp,
                    ammo: ammoData,
                    item: itemData,
                    reason: reason,
                    from: ADMIN_NICK,
                    timestamp: Date.now(),
                    claimed: false
                };
                
                await firebaseDB.ref(`notifications/${playerName}`).push(rewardData);
                
                // Po≈°li tak√© soukromou zpr√°vu
                await firebaseDB.ref(`chat/private/${playerName}`).push({
                    from: ADMIN_NICK,
                    to: playerName,
                    text: `üéÅ M√°≈° novou odmƒõnu! ${rewardText.join(', ')} - ${reason}`,
                    timestamp: Date.now(),
                    read: false
                });
                
                // Zaloguj
                await firebaseDB.ref('admin/rewardLog').push({
                    player: playerName,
                    money: money,
                    xp: xp,
                    item: itemData,
                    reason: reason,
                    admin: ADMIN_NICK,
                    timestamp: Date.now()
                });
                
                notifySuccess('Odmƒõna odesl√°na!', `${playerName} dostane ${rewardText.join(', ')}`);
                showAdminRewards();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Rychl√° admin odmƒõna z profilu hr√°ƒçe
        function showQuickReward(playerName) {
            if (!isAdmin()) return;
            
            // Seznam p≈ôedmƒõt≈Ø pro v√Ωbƒõr
            const rewardItems = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legendary' || i.price >= 100)
                .sort((a, b) => (b.price || 0) - (a.price || 0));
            let itemsHtml = '<option value="">-- ≈Ω√°dn√Ω --</option>' + 
                rewardItems.map(i => `<option value="${i.id}">${i.icon} ${i.name}</option>`).join('');
            
            showModal(`üéÅ Odmƒõna pro: ${escapeHtml(playerName)}`, `
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4caf50;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.85rem;">üë§ P≈ô√≠jemce: <strong>${escapeHtml(playerName)}</strong></p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ffd700; font-size: 0.8rem;">üí∞ Pen√≠ze:</label>
                        <input type="number" id="qrMoney" value="0" min="0" max="999999" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="color: #8bc34a; font-size: 0.8rem;">‚≠ê XP:</label>
                        <input type="number" id="qrXP" value="0" min="0" max="999999" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #8bc34a; border: 1px solid #8bc34a; border-radius: 6px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #ff9800; font-size: 0.8rem;">üî´ N√°boje:</label>
                        <select id="qrAmmo" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #ff9800; border-radius: 6px;">
                            <option value="">-- ≈Ω√°dn√© --</option>
                            <option value="9mm">üîπ 9mm</option>
                            <option value="shell">üî∏ Broky</option>
                            <option value="rifle">üîπ Pu≈°kov√©</option>
                            <option value="energy">‚ö° Energetick√©</option>
                            <option value="arrow">üèπ ≈†√≠py</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ff9800; font-size: 0.8rem;">Poƒçet:</label>
                        <input type="number" id="qrAmmoCount" value="50" min="1" max="9999" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #ff9800; border: 1px solid #ff9800; border-radius: 6px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="color: #9c7cff; font-size: 0.8rem;">üì¶ P≈ôedmƒõt:</label>
                        <select id="qrItem" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #9c7cff; border-radius: 6px;">
                            ${itemsHtml}
                        </select>
                    </div>
                    <div>
                        <label style="color: #9c7cff; font-size: 0.8rem;">Poƒçet:</label>
                        <input type="number" id="qrItemCount" value="1" min="1" max="99" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #9c7cff; border: 1px solid #9c7cff; border-radius: 6px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.8rem;">üìù D≈Øvod:</label>
                    <input type="text" id="qrReason" placeholder="nap≈ô. Kompenzace za bug" maxlength="100" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px;">
                </div>
                
                <button class="btn" onclick="sendQuickReward('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="width: 100%; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); padding: 0.8rem;">
                    üéÅ Odeslat odmƒõnu
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function sendQuickReward(playerName) {
            if (!isAdmin()) return;
            
            const money = parseInt(document.getElementById('qrMoney').value) || 0;
            const xp = parseInt(document.getElementById('qrXP').value) || 0;
            const ammoType = document.getElementById('qrAmmo').value;
            const ammoCount = parseInt(document.getElementById('qrAmmoCount').value) || 0;
            const itemId = document.getElementById('qrItem').value;
            const itemCount = parseInt(document.getElementById('qrItemCount').value) || 1;
            const reason = document.getElementById('qrReason').value.trim() || 'Odmƒõna od admina';
            
            if (money <= 0 && xp <= 0 && !itemId && !ammoType) {
                notifyWarning('Chyba', 'Nastav alespo≈à nƒõjakou odmƒõnu!');
                return;
            }
            
            // P≈ôiprav data
            let itemData = null;
            if (itemId) {
                const item = ITEMS.find(i => i.id === itemId);
                if (item) {
                    itemData = { id: item.id, name: item.name, icon: item.icon, count: Math.min(itemCount, 99) };
                }
            }
            
            let ammoData = null;
            if (ammoType && ammoCount > 0) {
                const ammoNames = { '9mm': 'üîπ 9mm', 'shell': 'üî∏ Broky', 'rifle': 'üîπ Pu≈°kov√©', 'energy': '‚ö° Energetick√©', 'arrow': 'üèπ ≈†√≠py' };
                ammoData = { type: ammoType, count: Math.min(ammoCount, 9999), name: ammoNames[ammoType] || ammoType };
            }
            
            try {
                // Sestav text
                let rewardText = [];
                if (money > 0) rewardText.push(money + 'üí∞');
                if (xp > 0) rewardText.push(xp + '‚≠êXP');
                if (ammoData) rewardText.push(ammoData.count + 'x ' + ammoData.name);
                if (itemData) rewardText.push(itemData.count + 'x ' + itemData.icon + ' ' + itemData.name);
                
                const rewardData = {
                    type: 'admin_reward',
                    money: money,
                    xp: xp,
                    ammo: ammoData,
                    item: itemData,
                    reason: reason,
                    from: ADMIN_NICK,
                    timestamp: Date.now(),
                    claimed: false
                };
                
                await firebaseDB.ref(`notifications/${playerName}`).push(rewardData);
                
                // Soukrom√° zpr√°va
                await firebaseDB.ref(`chat/private/${playerName}`).push({
                    from: ADMIN_NICK,
                    to: playerName,
                    text: `üéÅ M√°≈° novou odmƒõnu! ${rewardText.join(', ')} - ${reason}`,
                    timestamp: Date.now(),
                    read: false
                });
                
                // Log
                await firebaseDB.ref('admin/rewardLog').push({
                    player: playerName,
                    money: money,
                    xp: xp,
                    ammo: ammoData,
                    item: itemData,
                    reason: reason,
                    admin: ADMIN_NICK,
                    timestamp: Date.now()
                });
                
                notifySuccess('Odmƒõna odesl√°na!', `${playerName} dostane ${rewardText.join(', ')}`);
                closeModal();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === RYCHL√ù MUTE Z PROFILU ===
        function adminQuickMute(playerName) {
            if (!hasPermission('mute')) return;
            
            showModal(`üîá Mute: ${escapeHtml(playerName)}`, `
                <div style="background: #1a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #607d8b;">
                    <p style="color: #90a4ae; margin: 0;">Ztlumit hr√°ƒçe <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong> v chatu?</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">‚è±Ô∏è Doba trv√°n√≠:</label>
                    <select id="muteDuration" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #607d8b; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="10">10 minut</option>
                        <option value="30">30 minut</option>
                        <option value="60" selected>1 hodina</option>
                        <option value="180">3 hodiny</option>
                        <option value="720">12 hodin</option>
                        <option value="1440">24 hodin</option>
                        <option value="10080">7 dn√≠</option>
                        <option value="0">Permanentnƒõ</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üìù D≈Øvod:</label>
                    <input type="text" id="muteReason" placeholder="nap≈ô. Spam, toxicita..." maxlength="100" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="executeQuickMute('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);">üîá Ztlumit</button>
                </div>
            `);
        }
        
        // Rychl√© p≈ôid√°n√≠ do staff z chatu
        function quickAddToStaff(playerName) {
            if (!isAdmin()) return;
            
            if (STAFF_MEMBERS[playerName]) {
                notifyWarning('Ji≈æ je staff', `${playerName} u≈æ je ${STAFF_ROLES[STAFF_MEMBERS[playerName]].name}`);
                return;
            }
            
            showModal(`üë• P≈ôidat do Staff: ${escapeHtml(playerName)}`, `
                <div style="background: #1a1a3a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #9c27b0;">
                    <p style="color: #ce93d8; margin: 0;">P≈ôidat <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong> do staff t√Ωmu?</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üé≠ Vyber roli:</label>
                    <select id="quickStaffRole" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #9c27b0; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="helper">üíö Helper - pouze chat a bugy</option>
                        <option value="moderator">üõ°Ô∏è Moder√°tor - chat, mute, tr≈æi≈°tƒõ, PvP, bugy, tombola, warzone</option>
                    </select>
                </div>
                
                <div style="background: #2a2a2a; padding: 0.8rem; border-radius: 8px; font-size: 0.75rem; color: #888; margin-bottom: 1rem;">
                    <strong>Pr√°va rol√≠:</strong><br>
                    üíö Helper: Spr√°va chatu, Bug reporty<br>
                    üõ°Ô∏è Moder√°tor: + Mute, Tr≈æi≈°tƒõ, PvP, Tombola, Warzone
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="executeQuickAddStaff('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">üë• P≈ôidat</button>
                </div>
            `);
        }
        
        async function executeQuickAddStaff(playerName) {
            if (!isAdmin()) return;
            
            const role = document.getElementById('quickStaffRole')?.value || 'helper';
            
            STAFF_MEMBERS[playerName] = role;
            
            if (firebaseDB) {
                await firebaseDB.ref('adminData/staffMembers/' + playerName.replace(/[\\/\\.#$\\[\\]]/g, '_')).set(role);
            }
            
            const roleData = STAFF_ROLES[role];
            closeModal();
            notifySuccess('‚úì Staff p≈ôid√°n', `${playerName} je nyn√≠ ${roleData.icon} ${roleData.name}`);
        }
        
        async function executeQuickMute(playerName) {
            if (!hasPermission('mute')) return;
            
            const duration = parseInt(document.getElementById('muteDuration').value);
            const reason = document.getElementById('muteReason').value || 'Bez ud√°n√≠ d≈Øvodu';
            
            try {
                const muteData = {
                    player: playerName,
                    mutedBy: getPlayerName(), // Kdo mutnul (m≈Ø≈æe b√Ωt mod)
                    reason: reason,
                    timestamp: Date.now(),
                    duration: duration, // 0 = permanent
                    expiresAt: duration > 0 ? Date.now() + (duration * 60 * 1000) : 0
                };
                
                await firebaseDB.ref(`mutes/${playerName.replace(/[\/\.#$\[\]]/g, '_')}`).set(muteData);
                
                notifySuccess('üîá Hr√°ƒç ztlumen', `${playerName} - ${duration > 0 ? duration + ' min' : 'Permanentnƒõ'}`);
                closeModal();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === RYCHL√ù BAN Z PROFILU ===
        function adminQuickBan(playerName) {
            if (!isAdmin()) return;
            
            showModal(`üö´ Ban: ${escapeHtml(playerName)}`, `
                <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #f44336;">
                    <p style="color: #f44336; margin: 0;">‚ö†Ô∏è POZOR: Banovat hr√°ƒçe <strong style="color: #ffd700;">${escapeHtml(playerName)}</strong>?</p>
                    <p style="color: #888; font-size: 0.8rem; margin: 0.5rem 0 0 0;">Hr√°ƒç nebude moci hr√°t hru!</p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">‚è±Ô∏è Doba trv√°n√≠:</label>
                    <select id="banDuration" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #f44336; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="60">1 hodina</option>
                        <option value="720">12 hodin</option>
                        <option value="1440" selected>24 hodin</option>
                        <option value="4320">3 dny</option>
                        <option value="10080">7 dn√≠</option>
                        <option value="43200">30 dn√≠</option>
                        <option value="0">Permanentnƒõ</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üìù D≈Øvod:</label>
                    <input type="text" id="banReason" placeholder="nap≈ô. Cheating, toxicita..." maxlength="200" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="closeModal()" style="background: #555;">‚ùå Zru≈°it</button>
                    <button class="btn" onclick="executeQuickBan('${escapeHtml(playerName).replace(/'/g, "\\\\'")}')" style="background: linear-gradient(135deg, #f44336 0%, #b71c1c 100%);">üö´ Banovat</button>
                </div>
            `);
        }
        
        async function executeQuickBan(playerName) {
            if (!isAdmin()) return;
            
            const duration = parseInt(document.getElementById('banDuration').value);
            const reason = document.getElementById('banReason').value || 'Bez ud√°n√≠ d≈Øvodu';
            
            try {
                const banData = {
                    player: playerName,
                    bannedBy: ADMIN_NICK,
                    reason: reason,
                    timestamp: Date.now(),
                    duration: duration, // 0 = permanent
                    expiresAt: duration > 0 ? Date.now() + (duration * 60 * 1000) : 0
                };
                
                await firebaseDB.ref(`bans/${playerName.replace(/[\/\.#$\[\]]/g, '_')}`).set(banData);
                
                notifySuccess('üö´ Hr√°ƒç zabanov√°n', `${playerName} - ${duration > 0 ? (duration >= 1440 ? Math.floor(duration/1440) + ' dn√≠' : duration + ' min') : 'Permanentnƒõ'}`);
                closeModal();
                
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === RYCHL√Å ZMƒöNA BARVY Z CHATU ===
        function showQuickVIPColor(playerName) {
            if (!isAdmin()) return;
            
            // P≈ôeddefinovan√© barvy
            const presetColors = [
                { name: 'Zlat√°', color: '#ffd700' },
                { name: 'St≈ô√≠brn√°', color: '#c0c0c0' },
                { name: 'Bronzov√°', color: '#cd7f32' },
                { name: 'R≈Ø≈æov√°', color: '#ff69b4' },
                { name: 'Fialov√°', color: '#9c27b0' },
                { name: 'Tyrkysov√°', color: '#00bcd4' },
                { name: 'Oran≈æov√°', color: '#ff9800' },
                { name: 'ƒåerven√°', color: '#f44336' },
                { name: 'Zelen√°', color: '#4caf50' },
                { name: 'Modr√°', color: '#2196f3' },
                { name: 'Rainbow', color: 'rainbow' }
            ];
            
            const currentColor = vipColors[playerName] || '';
            
            let colorsHtml = '<option value="">-- Bez VIP barvy --</option>' +
                presetColors.map(c => `<option value="${c.color}" ${currentColor === c.color ? 'selected' : ''} style="color: ${c.color === 'rainbow' ? '#ff0000' : c.color}">${c.name}</option>`).join('');
            
            showModal('üé® Zmƒõnit barvu: ' + playerName, `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 3rem;">üé®</div>
                    <div style="color: ${currentColor === 'rainbow' ? '#ff0000' : (currentColor || '#fff')}; font-weight: bold; font-size: 1.3rem; ${currentColor === 'rainbow' ? 'background: linear-gradient(90deg, #ff0000, #ff9800, #ffff00, #00ff00, #00bcd4, #9c27b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;' : ''}">${escapeHtml(playerName)}</div>
                    ${currentColor ? '<p style="color: #888; font-size: 0.85rem;">Aktu√°ln√≠ barva: ' + (presetColors.find(c => c.color === currentColor)?.name || currentColor) + '</p>' : '<p style="color: #666; font-size: 0.85rem;">Zat√≠m bez VIP barvy</p>'}
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üé® Nov√° barva:</label>
                    <select id="quickVipColorSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #ff9800; border-radius: 6px; margin-top: 0.3rem;">
                        ${colorsHtml}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="btn" onclick="applyQuickVIPColor('${escapeHtml(playerName).replace(/'/g, "\\'")}')" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 0.8rem;">
                        ‚úì Ulo≈æit
                    </button>
                    <button class="btn" onclick="closeModal()" style="background: #555; padding: 0.8rem;">
                        ‚úï Zru≈°it
                    </button>
                </div>
            `);
        }
        
        async function applyQuickVIPColor(playerName) {
            if (!isAdmin()) return;
            
            const color = document.getElementById('quickVipColorSelect').value;
            
            // Firebase kl√≠ƒçe nemohou obsahovat . # $ [ ] /
            // Pou≈æijeme encodeURIComponent pro bezpeƒçn√© ukl√°d√°n√≠
            const safeKey = encodeURIComponent(playerName);
            
            try {
                if (color) {
                    await firebaseDB.ref('vipColors/' + safeKey).set(color);
                    vipColors[playerName] = color;
                    notifySuccess('Barva nastavena!', playerName + ' m√° novou VIP barvu');
                } else {
                    await firebaseDB.ref('vipColors/' + safeKey).remove();
                    delete vipColors[playerName];
                    notifySuccess('Barva odebr√°na', playerName + ' u≈æ nem√° VIP barvu');
                }
                closeModal();
            } catch (e) {
                console.error('VIP color error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function showRewardHistory() {
            if (!isAdmin()) return;
            
            try {
                const snapshot = await firebaseDB.ref('admin/rewardLog').orderByChild('timestamp').limitToLast(20).once('value');
                const data = snapshot.val();
                
                let html = '<div style="max-height: 300px; overflow-y: auto;">';
                
                if (data) {
                    const rewards = Object.values(data).reverse();
                    rewards.forEach(r => {
                        const date = new Date(r.timestamp).toLocaleString('cs-CZ');
                        html += `
                            <div style="background: #1a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.3rem; border-left: 3px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #2196f3;">${escapeHtml(r.player)}</span>
                                    <span style="color: #888; font-size: 0.75rem;">${date}</span>
                                </div>
                                <div style="color: #ffd700;">${r.money || 0}üí∞ + ${r.xp || 0}‚≠êXP</div>
                                <div style="color: #666; font-size: 0.8rem;">${escapeHtml(r.reason || '')}</div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center;">≈Ω√°dn√° historie</p>';
                }
                
                html += '</div>';
                html += '<button class="btn" onclick="showAdminRewards()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>';
                
                showModal('üìã Historie odmƒõn', html);
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === ADMIN VIP BARVY ===
        let vipColors = {}; // Cache VIP barev
        
        async function loadVIPColors() {
            if (!multiplayerEnabled || !firebaseDB) return;
            try {
                // Jednor√°zov√© naƒçten√≠ + real-time listener
                firebaseDB.ref('vipColors').on('value', (snap) => {
                    const rawData = snap.val() || {};
                    // Dek√≥duj kl√≠ƒçe (jm√©na hr√°ƒç≈Ø) z Firebase form√°tu
                    vipColors = {};
                    for (const [key, value] of Object.entries(rawData)) {
                        try {
                            const decodedName = decodeURIComponent(key);
                            vipColors[decodedName] = value;
                        } catch (e) {
                            // Pokud dek√≥dov√°n√≠ sel≈æe, pou≈æij p≈Øvodn√≠ kl√≠ƒç
                            vipColors[key] = value;
                        }
                    }
                    console.log('üé® VIP barvy aktualizov√°ny:', Object.keys(vipColors).length);
                });
            } catch (e) {
                console.error('Error loading VIP colors:', e);
            }
        }
        
        function getVIPColor(playerName) {
            return vipColors[playerName] || null;
        }
        
        async function showAdminVIPColors() {
            if (!isAdmin()) return;
            
            // Naƒçti aktu√°ln√≠ VIP barvy
            await loadVIPColors();
            
            // Naƒçti hr√°ƒçe ze ≈æeb≈ô√≠ƒçku
            let players = [];
            try {
                const snap = await firebaseDB.ref('leaderboard').orderByChild('score').limitToLast(100).once('value');
                const data = snap.val();
                if (data) {
                    players = Object.entries(data).map(([name, info]) => ({
                        name,
                        level: info.level || 1,
                        score: info.score || 0
                    }))
                    // Filtruj automaticky generovan√© nicky (user_xxx s dlouh√Ωm hashem)
                    .filter(p => !p.name.startsWith('user_') || p.name.length < 20)
                    .sort((a, b) => b.score - a.score);
                }
            } catch (e) {
                console.error('Error loading players:', e);
            }
            
            // P≈ôeddefinovan√© barvy
            const presetColors = [
                { name: 'Zlat√°', color: '#ffd700' },
                { name: 'St≈ô√≠brn√°', color: '#c0c0c0' },
                { name: 'Bronzov√°', color: '#cd7f32' },
                { name: 'R≈Ø≈æov√°', color: '#ff69b4' },
                { name: 'Fialov√°', color: '#9c27b0' },
                { name: 'Tyrkysov√°', color: '#00bcd4' },
                { name: 'Oran≈æov√°', color: '#ff9800' },
                { name: 'ƒåerven√°', color: '#f44336' },
                { name: 'Zelen√°', color: '#4caf50' },
                { name: 'Modr√°', color: '#2196f3' },
                { name: 'Rainbow', color: 'rainbow' }
            ];
            
            let playersHtml = players.map(p => {
                const currentColor = vipColors[p.name];
                return `<option value="${escapeHtml(p.name)}" ${currentColor ? 'style="color:' + currentColor + '"' : ''}>${escapeHtml(p.name)} (Lv.${p.level}) ${currentColor ? 'üé®' : ''}</option>`;
            }).join('');
            
            let colorsHtml = '<option value="">-- Bez VIP barvy --</option>' +
                presetColors.map(c => `<option value="${c.color}" style="color: ${c.color === 'rainbow' ? '#ff0000' : c.color}">${c.name}</option>`).join('');
            
            // Seznam aktu√°ln√≠ch VIP
            let currentVIPs = Object.entries(vipColors).map(([name, color]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #0a0a0a; border-radius: 4px; margin-bottom: 0.3rem;">
                    <span style="color: ${color === 'rainbow' ? '#ff0000' : color}; font-weight: bold; ${color === 'rainbow' ? 'background: linear-gradient(90deg, #ff0000, #ff9800, #ffff00, #00ff00, #00bcd4, #9c27b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;' : ''}">${escapeHtml(name)}</span>
                    <button onclick="removeVIPColor('${escapeHtml(name)}')" style="background: #f44336; border: none; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úï</button>
                </div>
            `).join('') || '<p style="color: #666; text-align: center;">≈Ω√°dn√≠ VIP hr√°ƒçi</p>';
            
            showModal('üé® VIP Barvy', `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #ff9800;">
                    <p style="color: #ff9800; margin: 0; font-size: 0.9rem;">
                        üé® Nastav speci√°ln√≠ barvu nicku v chatu pro VIP hr√°ƒçe (nap≈ô. p≈ôispƒõvatele).
                    </p>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üë§ Hr√°ƒç:</label>
                    <select id="vipPlayerSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                        <option value="">-- Vyber hr√°ƒçe --</option>
                        ${playersHtml}
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="color: #888; font-size: 0.85rem;">üé® Barva:</label>
                    <select id="vipColorSelect" style="width: 100%; padding: 0.7rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                        ${colorsHtml}
                    </select>
                </div>
                
                <button class="btn" onclick="setVIPColor()" style="width: 100%; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 1rem; font-size: 1rem;">
                    üé® Nastavit barvu
                </button>
                
                <div style="margin-top: 1.5rem;">
                    <h4 style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.9rem;">üëë Aktu√°ln√≠ VIP hr√°ƒçi:</h4>
                    <div style="max-height: 150px; overflow-y: auto;">
                        ${currentVIPs}
                    </div>
                </div>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function setVIPColor() {
            if (!isAdmin()) return;
            
            const playerName = document.getElementById('vipPlayerSelect').value;
            const color = document.getElementById('vipColorSelect').value;
            
            if (!playerName) {
                notifyWarning('Chyba', 'Vyber hr√°ƒçe!');
                return;
            }
            
            const safeKey = encodeURIComponent(playerName);
            
            try {
                if (color) {
                    await firebaseDB.ref('vipColors/' + safeKey).set(color);
                    vipColors[playerName] = color;
                    notifySuccess('Barva nastavena!', `${playerName} m√° teƒè VIP barvu`);
                } else {
                    await firebaseDB.ref('vipColors/' + safeKey).remove();
                    delete vipColors[playerName];
                    notifySuccess('Barva odebr√°na', `${playerName} u≈æ nem√° VIP barvu`);
                }
                showAdminVIPColors();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function removeVIPColor(playerName) {
            if (!isAdmin()) return;
            
            const safeKey = encodeURIComponent(playerName);
            
            try {
                await firebaseDB.ref('vipColors/' + safeKey).remove();
                delete vipColors[playerName];
                notifySuccess('Barva odebr√°na', `${playerName} u≈æ nem√° VIP barvu`);
                showAdminVIPColors();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Kontrola nevyzvednut√Ωch odmƒõn p≈ôi naƒçten√≠
        async function checkPendingRewards() {
            if (!multiplayerEnabled || !firebaseDB || !state.char?.name) return;
            
            const myName = state.char.name;
            
            try {
                let totalMoney = 0;
                let totalXP = 0;
                let totalAmmo = {};
                let receivedItems = [];
                let reasons = [];
                
                // === 1. Kontrola notifications/{name} (admin rewards, tombola wins) ===
                const notifSnapshot = await firebaseDB.ref(`notifications/${myName}`).once('value');
                const notifications = notifSnapshot.val() || {};
                
                for (const [key, notif] of Object.entries(notifications)) {
                    // Admin odmƒõna
                    if (notif.type === 'admin_reward' && !notif.claimed) {
                        const money = Math.min(parseInt(notif.money) || 0, 999999);
                        const xp = Math.min(parseInt(notif.xp) || 0, 999999);
                        totalMoney += money;
                        totalXP += xp;
                        if (notif.reason) reasons.push(notif.reason);
                        
                        // N√°boje
                        if (notif.ammo && notif.ammo.type && notif.ammo.count > 0) {
                            const ammoType = notif.ammo.type;
                            totalAmmo[ammoType] = (totalAmmo[ammoType] || 0) + Math.min(notif.ammo.count, 9999);
                        }
                        
                        // P≈ôedmƒõt
                        if (notif.item && notif.item.id) {
                            const itemDef = ITEMS.find(i => i.id === notif.item.id);
                            if (itemDef) {
                                const count = Math.min(notif.item.count || 1, 99);
                                const itemCopy = JSON.parse(JSON.stringify(itemDef));
                                itemCopy.count = count;
                                addItemToInventory(itemCopy, count);
                                receivedItems.push(`${count}x ${itemDef.icon} ${itemDef.name}`);
                            }
                        }
                        
                        // Sma≈æ notifikaci
                        await firebaseDB.ref(`notifications/${myName}/${key}`).remove();
                        console.log('üéÅ Admin odmƒõna vyzveduta:', notif);
                    }
                    
                    // War zone v√Ωhra
                    if (notif.type === 'war_reward' && !notif.claimed) {
                        const reward = notif.reward || {};
                        const money = Math.min(parseInt(reward.money) || 0, 999999);
                        totalMoney += money;
                        if (notif.title) reasons.push(notif.title);
                        
                        // Sma≈æ notifikaci
                        await firebaseDB.ref(`notifications/${myName}/${key}`).remove();
                        console.log('‚öîÔ∏è War zone odmƒõna vyzveduta:', notif);
                    }
                    
                    // Tombola v√Ωhra
                    if (notif.type === 'tombola_win' && !notif.processed) {
                        processTombolaWin(notif);
                        await firebaseDB.ref(`notifications/${myName}/${key}`).remove();
                    }
                }
                
                // === 2. Kontrola players/{name}/pendingRewards (star√Ω syst√©m) ===
                const pendingSnapshot = await firebaseDB.ref(`players/${myName}/pendingRewards`).once('value');
                const pendingData = pendingSnapshot.val() || {};
                
                for (const [key, reward] of Object.entries(pendingData)) {
                    if (!reward.claimed) {
                        const money = Math.min(reward.money || 0, 1000);
                        const xp = Math.min(reward.xp || 0, 500);
                        totalMoney += money;
                        totalXP += xp;
                        if (reward.reason) reasons.push(reward.reason);
                        
                        // P≈ôedmƒõt
                        if (reward.item && reward.item.id) {
                            const itemDef = ITEMS.find(i => i.id === reward.item.id);
                            if (itemDef) {
                                const count = Math.min(reward.item.count || 1, 10);
                                const itemCopy = JSON.parse(JSON.stringify(itemDef));
                                itemCopy.count = count;
                                addItemToInventory(itemCopy, count);
                                receivedItems.push(`${count}x ${itemDef.icon} ${itemDef.name}`);
                            }
                        }
                        
                        // Oznaƒç jako vyzvednut√©
                        await firebaseDB.ref(`players/${myName}/pendingRewards/${key}/claimed`).set(true);
                    }
                }
                
                // === 3. Zobraz v√Ωsledky ===
                if (totalMoney > 0 || totalXP > 0 || receivedItems.length > 0 || Object.keys(totalAmmo).length > 0) {
                    // P≈ôidej pen√≠ze
                    if (totalMoney > 0) {
                        state.money = (state.money || 0) + totalMoney;
                    }
                    
                    // P≈ôidej XP
                    if (totalXP > 0) {
                        addXP(totalXP);
                    }
                    
                    // P≈ôidej n√°boje
                    let ammoText = '';
                    const ammoNames = { '9mm': 'üîπ 9mm', 'shell': 'üî∏ Broky', 'rifle': 'üîπ Pu≈°kov√©', 'energy': '‚ö° Energetick√©', 'arrow': 'üèπ ≈†√≠py' };
                    for (const [type, count] of Object.entries(totalAmmo)) {
                        addAmmo(type, count);
                        ammoText += `<div style="color: #ff9800;">+${count}x ${ammoNames[type] || type}</div>`;
                    }
                    
                    console.log(`üéÅ Celkem vyzvednuto: ${totalMoney}üí∞ + ${totalXP}‚≠ê + ${receivedItems.length} p≈ôedmƒõt≈Ø`);
                    
                    // Zobraz modal
                    showModal('üéÅ M√°≈° odmƒõnu!', `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üéÅ</div>
                            <h3 style="color: #4caf50;">Gratulujeme!</h3>
                            <p style="color: #888;">Dostal jsi odmƒõnu od admina:</p>
                            <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                ${totalMoney > 0 ? `<div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">+${totalMoney} üí∞</div>` : ''}
                                ${totalXP > 0 ? `<div style="color: #8bc34a; font-size: 1.5rem; font-weight: bold;">+${totalXP} ‚≠êXP</div>` : ''}
                                ${ammoText}
                                ${receivedItems.length > 0 ? `<div style="color: #9c7cff; font-size: 1.1rem; margin-top: 0.5rem;">${receivedItems.join('<br>')}</div>` : ''}
                            </div>
                            ${reasons.length > 0 ? `<p style="color: #888; font-size: 0.9rem; font-style: italic;">"${reasons.slice(0, 3).join(', ')}"</p>` : ''}
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">üéâ Super!</button>
                    `);
                    
                    renderFull();
                    saveGame(true);
                }
                
            } catch (e) {
                console.error('Error checking pending rewards:', e);
            }
        }
        
        // ============================================
        // üéüÔ∏è TOMBOLA SYST√âM
        // ============================================
        
        let currentTombola = null;
        
        // Inicializace listeneru na tombolu
        function initTombolaListener() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            firebaseDB.ref('tombola/active').on('value', (snap) => {
                currentTombola = snap.val();
                console.log('üéüÔ∏è Tombola update:', currentTombola);
            });
        }
        
        // Admin: Zobrazit spr√°vu tomboly
        async function showAdminTombola() {
            if (!hasPermission('tombola')) return;
            
            showModal('üéüÔ∏è Tombola', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (tombola && tombola.status === 'active') {
                    // Aktivn√≠ tombola - zobraz spr√°vu
                    showAdminTombolaManage(tombola);
                } else {
                    // ≈Ω√°dn√° tombola - nab√≠dni vytvo≈ôen√≠
                    showAdminTombolaCreate();
                }
            } catch (e) {
                console.error('Tombola error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se naƒç√≠st tombolu');
            }
        }
        
        // Admin: Vytvo≈ôit novou tombolu
        function showAdminTombolaCreate() {
            showModal('üéüÔ∏è Vytvo≈ôit tombolu', `
                <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #e91e63; margin: 0;">Vytvo≈ô novou tombolu s v√Ωhrou pro hr√°ƒçe!</p>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">N√°zev tomboly:</label>
                        <input type="text" id="tombolaName" value="Velk√° tombola" 
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Typ v√Ωhry:</label>
                        <select id="tombolaPrizeType" onchange="updateTombolaPrizeFields()" 
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                            <option value="money">üí∞ Pen√≠ze</option>
                            <option value="tokens">üé´ ≈Ωetony</option>
                            <option value="xp">‚≠ê XP</option>
                            <option value="item">üì¶ P≈ôedmƒõt</option>
                        </select>
                    </div>
                    
                    <div id="tombolaPrizeFields">
                        <label style="color: #ffd700; font-size: 0.85rem;">ƒå√°stka (üí∞):</label>
                        <input type="number" id="tombolaPrizeAmount" value="1000" min="1" max="999999"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #ffd700; border-radius: 8px; color: #ffd700; margin-top: 0.3rem; font-weight: bold;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Cena l√≠stku (üí∞):</label>
                        <input type="number" id="tombolaTicketPrice" value="50" min="1"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Max l√≠stk≈Ø na hr√°ƒçe:</label>
                        <input type="number" id="tombolaMaxTickets" value="10" min="1" max="100"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                    
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">Trv√°n√≠ (hodiny):</label>
                        <input type="number" id="tombolaDuration" value="24" min="1" max="168"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="showAdminPanel()" style="background: #555;">‚Üê Zpƒõt</button>
                    <button class="btn" onclick="createTombola()" style="background: #e91e63;">üéüÔ∏è Vytvo≈ôit</button>
                </div>
            `);
        }
        
        function updateTombolaPrizeFields() {
            const type = document.getElementById('tombolaPrizeType').value;
            const container = document.getElementById('tombolaPrizeFields');
            
            if (type === 'item') {
                // V√Ωbƒõr p≈ôedmƒõtu
                const itemOptions = ITEMS.filter(i => i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legendary')
                    .map(i => `<option value="${i.id}">${i.icon} ${i.name} (${i.rarity})</option>`).join('');
                
                container.innerHTML = `
                    <label style="color: #888; font-size: 0.85rem;">P≈ôedmƒõt:</label>
                    <select id="tombolaPrizeItem" style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                        ${itemOptions}
                    </select>
                    <div style="margin-top: 0.5rem;">
                        <label style="color: #888; font-size: 0.85rem;">Poƒçet:</label>
                        <input type="number" id="tombolaPrizeAmount" value="1" min="1" max="99"
                            style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid #444; border-radius: 8px; color: #fff; margin-top: 0.3rem;">
                    </div>
                `;
            } else {
                // Pen√≠ze, ≈æetony nebo XP
                const labels = {
                    money: { label: 'ƒå√°stka (üí∞):', color: '#ffd700', default: 1000 },
                    tokens: { label: 'Poƒçet ≈æeton≈Ø (üé´):', color: '#e91e63', default: 1000 },
                    xp: { label: 'Mno≈æstv√≠ XP (‚≠ê):', color: '#8bc34a', default: 500 }
                };
                const config = labels[type] || labels.money;
                
                container.innerHTML = `
                    <label style="color: ${config.color}; font-size: 0.85rem;">${config.label}</label>
                    <input type="number" id="tombolaPrizeAmount" value="${config.default}" min="1" max="999999"
                        style="width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid ${config.color}; border-radius: 8px; color: ${config.color}; margin-top: 0.3rem; font-weight: bold;">
                `;
            }
        }
        
        // Vytvo≈ôit tombolu
        async function createTombola() {
            if (!hasPermission('tombola')) return;
            
            const name = document.getElementById('tombolaName').value.trim();
            const prizeType = document.getElementById('tombolaPrizeType').value;
            const prizeAmount = parseInt(document.getElementById('tombolaPrizeAmount').value) || 1;
            const prizeItem = document.getElementById('tombolaPrizeItem')?.value || null;
            const ticketPrice = parseInt(document.getElementById('tombolaTicketPrice').value) || 50;
            const maxTickets = parseInt(document.getElementById('tombolaMaxTickets').value) || 10;
            const durationHours = parseInt(document.getElementById('tombolaDuration').value) || 24;
            
            if (!name) {
                notifyWarning('Chyba', 'Zadej n√°zev tomboly');
                return;
            }
            
            // Sestav prize objekt
            let prize = { type: prizeType, amount: prizeAmount };
            if (prizeType === 'item' && prizeItem) {
                const item = ITEMS.find(i => i.id === prizeItem);
                if (item) {
                    prize.itemId = prizeItem;
                    prize.itemName = item.name;
                    prize.itemIcon = item.icon;
                }
            }
            
            const tombola = {
                name: name,
                prize: prize,
                ticketPrice: ticketPrice,
                maxTicketsPerPlayer: maxTickets,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                endsAt: Date.now() + (durationHours * 60 * 60 * 1000),
                status: 'active',
                tickets: {},
                totalTickets: 0,
                createdBy: getPlayerName()
            };
            
            try {
                await firebaseDB.ref('tombola/active').set(tombola);
                notifySuccess('üéüÔ∏è Tombola vytvo≈ôena!', name);
                
                // Ozn√°men√≠ v chatu
                await firebaseDB.ref('chat/messages').push({
                    author: 'üéüÔ∏è TOMBOLA',
                    text: `Nov√° tombola "${name}"! Cena l√≠stku: ${ticketPrice} üí∞. V√Ωhra: ${getPrizeDescription(prize)}. Konƒç√≠ za ${durationHours} hodin!`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                showAdminTombola();
            } catch (e) {
                console.error('Create tombola error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se vytvo≈ôit tombolu');
            }
        }
        
        function getPrizeDescription(prize) {
            if (prize.type === 'money') return `${prize.amount} üí∞`;
            if (prize.type === 'tokens') return `${prize.amount} üé´`;
            if (prize.type === 'xp') return `${prize.amount} ‚≠ê XP`;
            if (prize.type === 'item') return `${prize.amount}x ${prize.itemIcon || 'üì¶'} ${prize.itemName || 'P≈ôedmƒõt'}`;
            return '???';
        }
        
        // Admin: Spr√°va aktivn√≠ tomboly
        async function showAdminTombolaManage(tombola) {
            const timeLeft = Math.max(0, tombola.endsAt - Date.now());
            const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
            const minsLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
            
            // Spoƒç√≠tej √∫ƒçastn√≠ky a l√≠stky
            const tickets = tombola.tickets || {};
            const participants = Object.keys(tickets).filter(player => {
                const t = tickets[player];
                return t && typeof t.count === 'number' && !isNaN(t.count);
            });
            const totalTickets = Object.values(tickets).reduce((sum, t) => sum + (t?.count || 0), 0);
            
            let participantsList = '';
            participants.forEach(player => {
                const t = tickets[player];
                const ticketCount = t?.count || 0;
                const chance = totalTickets > 0 ? ((ticketCount / totalTickets) * 100).toFixed(1) : 0;
                const expectedPaid = ticketCount * tombola.ticketPrice;
                const actualPaid = t?.totalPaid || 0;
                const isValid = actualPaid >= expectedPaid;
                participantsList += `
                    <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #0a0a0a; border-radius: 4px; margin-bottom: 0.2rem; border-left: 3px solid ${isValid ? '#4caf50' : '#f44336'};">
                        <span style="color: #fff;">${escapeHtml(player)}</span>
                        <span style="color: ${isValid ? '#ffd700' : '#f44336'};">${ticketCount} l√≠stk≈Ø (${chance}%) ${!isValid ? '‚ö†Ô∏è' : ''}</span>
                    </div>
                `;
            });
            
            showModal('üéüÔ∏è Spr√°va tomboly', `
                <div style="background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #e91e63;">
                    <h3 style="color: #e91e63; margin: 0 0 0.5rem 0;">${escapeHtml(tombola.name)}</h3>
                    <p style="color: #ffd700; margin: 0;">V√Ωhra: ${getPrizeDescription(tombola.prize)}</p>
                    <p style="color: #888; margin: 0.3rem 0 0 0;">Cena l√≠stku: ${tombola.ticketPrice} üí∞</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #4caf50; font-size: 1.5rem; font-weight: bold;">${participants.length}</div>
                        <div style="color: #888; font-size: 0.8rem;">√öƒçastn√≠k≈Ø</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                        <div style="color: #e91e63; font-size: 1.5rem; font-weight: bold;">${totalTickets}</div>
                        <div style="color: #888; font-size: 0.8rem;">L√≠stk≈Ø celkem</div>
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                    <div style="color: ${timeLeft > 0 ? '#ff9800' : '#f44336'}; font-size: 1.2rem;">
                        ${timeLeft > 0 ? `‚è±Ô∏è Zb√Ωv√°: ${hoursLeft}h ${minsLeft}m` : '‚è∞ ƒåas vypr≈°el!'}
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto;">
                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">üìã √öƒçastn√≠ci:</div>
                    ${participantsList || '<p style="color: #555; text-align: center;">Zat√≠m nikdo</p>'}
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="drawTombolaWinner()" style="background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%); color: #000; padding: 1rem; font-weight: bold;">
                        üéâ LOSOVAT V√ùHERCE
                    </button>
                    <button class="btn" onclick="cancelTombola()" style="background: #c62828; padding: 0.8rem;">
                        ‚ùå Zru≈°it tombolu
                    </button>
                    <button class="btn" onclick="showAdminPanel()" style="background: #555;">‚Üê Zpƒõt</button>
                </div>
            `);
        }
        
        // Admin: Losovat v√Ωherce
        async function drawTombolaWinner() {
            if (!hasPermission('tombola')) return;
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (!tombola || tombola.status !== 'active') {
                    notifyWarning('Chyba', '≈Ω√°dn√° aktivn√≠ tombola');
                    return;
                }
                
                const tickets = tombola.tickets || {};
                const participants = Object.keys(tickets).filter(player => {
                    const t = tickets[player];
                    return player && t && typeof t.count === 'number' && !isNaN(t.count) && t.count > 0;
                });
                
                if (participants.length === 0) {
                    notifyWarning('Chyba', '≈Ω√°dn√≠ √∫ƒçastn√≠ci v tombole');
                    return;
                }
                
                // Vytvo≈ô pool l√≠stk≈Ø (ka≈æd√Ω hr√°ƒç m√° tolik z√°znam≈Ø kolik m√° l√≠stk≈Ø)
                const ticketPool = [];
                participants.forEach(player => {
                    const count = tickets[player]?.count || 0;
                    for (let i = 0; i < count; i++) {
                        ticketPool.push(player);
                    }
                });
                
                if (ticketPool.length === 0) {
                    notifyWarning('Chyba', '≈Ω√°dn√© l√≠stky v tombole');
                    return;
                }
                
                // N√°hodn√Ω v√Ωbƒõr
                const winnerIndex = Math.floor(Math.random() * ticketPool.length);
                const winner = ticketPool[winnerIndex];
                const winnerTickets = tickets[winner]?.count || 0;
                const winChance = ((winnerTickets / ticketPool.length) * 100).toFixed(1);
                
                // Ulo≈æ v√Ωsledek
                const result = {
                    ...tombola,
                    status: 'finished',
                    winner: winner,
                    winnerTickets: winnerTickets,
                    totalTickets: ticketPool.length,
                    drawnAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // P≈ôesun do historie
                await firebaseDB.ref('tombola/history').push(result);
                await firebaseDB.ref('tombola/active').remove();
                
                // Po≈°li v√Ωhru hr√°ƒçi
                await firebaseDB.ref('notifications/' + winner).push({
                    type: 'tombola_win',
                    tombolaName: tombola.name,
                    prize: tombola.prize,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Ozn√°men√≠ v chatu
                await firebaseDB.ref('chat/messages').push({
                    author: 'üéâ TOMBOLA',
                    text: `V√Ωherce tomboly "${tombola.name}" je ${winner}! Mƒõl ${winnerTickets} l√≠stk≈Ø (${winChance}% ≈°ance). V√Ωhra: ${getPrizeDescription(tombola.prize)}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    system: true
                });
                
                // Zobraz v√Ωsledek
                showModal('üéâ V√ùHERCE VYLOSOV√ÅN!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin: 1rem 0;">üèÜ</div>
                        <h2 style="color: #ffd700; margin: 0;">${escapeHtml(winner)}</h2>
                        <p style="color: #888; margin: 0.5rem 0;">vyhr√°l tombolu "${escapeHtml(tombola.name)}"!</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                            <p style="color: #4caf50; font-size: 1.3rem; margin: 0;">V√Ωhra: ${getPrizeDescription(tombola.prize)}</p>
                        </div>
                        <p style="color: #666; font-size: 0.85rem;">
                            ${winnerTickets} l√≠stk≈Ø z ${ticketPool.length} celkem (${winChance}% ≈°ance)
                        </p>
                    </div>
                    <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #4caf50;">‚úì OK</button>
                `);
                
                notifySuccess('üéâ V√Ωherce vylosov√°n!', winner);
                
            } catch (e) {
                console.error('Draw winner error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se losovat: ' + e.message);
            }
        }
        
        // Admin: Zru≈°it tombolu
        async function cancelTombola() {
            if (!hasPermission('tombola')) return;
            
            if (!confirm('Opravdu zru≈°it tombolu? L√≠stky nebudou vr√°ceny!')) return;
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (tombola) {
                    // Ozn√°men√≠ v chatu
                    await firebaseDB.ref('chat/messages').push({
                        author: 'üéüÔ∏è TOMBOLA',
                        text: `Tombola "${tombola.name}" byla zru≈°ena administr√°torem.`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        system: true
                    });
                }
                
                await firebaseDB.ref('tombola/active').remove();
                notifySuccess('Tombola zru≈°ena', 'Tombola byla zru≈°ena');
                showAdminPanel();
            } catch (e) {
                console.error('Cancel tombola error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se zru≈°it tombolu');
            }
        }
        
        // === HR√ÅƒåSK√â FUNKCE PRO TOMBOLU ===
        
        // Zobrazit tombolu pro hr√°ƒçe
        async function showTombola() {
            if (!multiplayerEnabled || !firebaseDB) {
                notifyWarning('Nedostupn√©', 'Multiplayer nen√≠ aktivn√≠');
                return;
            }
            
            showModal('üéüÔ∏è Tombola', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (!tombola || tombola.status !== 'active') {
                    showModal('üéüÔ∏è Tombola', `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üéüÔ∏è</div>
                            <p style="color: #888;">Moment√°lnƒõ neprob√≠h√° ≈æ√°dn√° tombola.</p>
                            <p style="color: #666; font-size: 0.85rem;">Sleduj chat pro ozn√°men√≠ nov√Ωch tombol!</p>
                        </div>
                        <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">‚Üê Zav≈ô√≠t</button>
                    `);
                    return;
                }
                
                const myName = getPlayerName();
                // Sanitizace jm√©na pro Firebase cestu
                const sanitizedName = myName.replace(/[\/\.#$\[\]]/g, '_');
                const myTickets = tombola.tickets?.[sanitizedName]?.count || 0;
                const totalTickets = Object.values(tombola.tickets || {}).reduce((sum, t) => sum + (t?.count || 0), 0);
                const myChance = totalTickets > 0 ? ((myTickets / totalTickets) * 100).toFixed(1) : 0;
                const participants = Object.keys(tombola.tickets || {}).filter(k => tombola.tickets[k]?.count > 0).length;
                
                const timeLeft = Math.max(0, tombola.endsAt - Date.now());
                const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                const minsLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                
                const canBuyMore = myTickets < tombola.maxTicketsPerPlayer;
                const canAfford = getMoney() >= tombola.ticketPrice;
                
                showModal('üéüÔ∏è ' + escapeHtml(tombola.name), `
                    <div style="background: linear-gradient(135deg, #2a1a2a 0%, #1a0a1a 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #e91e63;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üéÅ</div>
                            <p style="color: #ffd700; font-size: 1.2rem; margin: 0; font-weight: bold;">V√Ωhra: ${getPrizeDescription(tombola.prize)}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                            <div style="color: #e91e63; font-size: 1.3rem; font-weight: bold;">${myTickets}</div>
                            <div style="color: #888; font-size: 0.75rem;">Tv√Ωch l√≠stk≈Ø</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                            <div style="color: #4caf50; font-size: 1.3rem; font-weight: bold;">${myChance}%</div>
                            <div style="color: #888; font-size: 0.75rem;">Tv√° ≈°ance</div>
                        </div>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: #888;">√öƒçastn√≠k≈Ø:</span>
                            <span style="color: #fff;">${participants}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: #888;">L√≠stk≈Ø celkem:</span>
                            <span style="color: #fff;">${totalTickets}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: #888;">Cena l√≠stku:</span>
                            <span style="color: #ffd700;">${tombola.ticketPrice} üí∞</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">Max l√≠stk≈Ø/hr√°ƒç:</span>
                            <span style="color: #fff;">${tombola.maxTicketsPerPlayer}</span>
                        </div>
                    </div>
                    
                    <div style="background: ${timeLeft > 0 ? '#1a2a1a' : '#2a1a1a'}; padding: 0.8rem; border-radius: 8px; text-align: center; margin-bottom: 1rem; border: 1px solid ${timeLeft > 0 ? '#4caf50' : '#f44336'};">
                        <div style="color: ${timeLeft > 0 ? '#ff9800' : '#f44336'}; font-size: 1.1rem;">
                            ${timeLeft > 0 ? `‚è±Ô∏è Zb√Ωv√°: ${hoursLeft}h ${minsLeft}m` : '‚è∞ Losov√°n√≠ brzy!'}
                        </div>
                    </div>
                    
                    ${participants > 0 ? `
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto;">
                        <p style="color: #888; font-size: 0.75rem; margin: 0 0 0.5rem 0; text-align: center;">üë• √öƒçastn√≠ci a jejich ≈°ance:</p>
                        ${Object.entries(tombola.tickets || {})
                            .filter(([name, data]) => name && data && typeof data.count === 'number' && !isNaN(data.count))
                            .sort((a, b) => (b[1].count || 0) - (a[1].count || 0))
                            .map(([name, data]) => {
                                const ticketCount = data.count || 0;
                                const chance = totalTickets > 0 ? ((ticketCount / totalTickets) * 100).toFixed(1) : 0;
                                const isMe = name === myName;
                                return `<div style="display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #333; ${isMe ? 'background: #1a2a1a; margin: 0 -0.5rem; padding: 0.3rem 0.5rem; border-radius: 4px;' : ''}">
                                    <span style="color: ${isMe ? '#8bc34a' : '#aaa'};">${isMe ? '‚òÖ ' : ''}${escapeHtml(name)}</span>
                                    <span style="color: ${isMe ? '#4caf50' : '#ff9800'}; font-weight: bold;">${ticketCount}üéüÔ∏è (${chance}%)</span>
                                </div>`;
                            }).join('')}
                    </div>
                    ` : ''}
                    
                    <div style="display: grid; gap: 0.5rem;">
                        ${canBuyMore ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="buyTombolaTicket(1)" style="flex: 1; background: ${canAfford ? '#e91e63' : '#555'}; padding: 0.8rem;" ${canAfford ? '' : 'disabled'}>
                                    üéüÔ∏è Koupit 1 l√≠stek
                                </button>
                                <button class="btn" onclick="buyTombolaTicket(5)" style="flex: 1; background: ${getMoney() >= tombola.ticketPrice * 5 && myTickets + 5 <= tombola.maxTicketsPerPlayer ? '#9c27b0' : '#555'}; padding: 0.8rem;" 
                                    ${getMoney() >= tombola.ticketPrice * 5 && myTickets + 5 <= tombola.maxTicketsPerPlayer ? '' : 'disabled'}>
                                    üéüÔ∏è Koupit 5 l√≠stk≈Ø
                                </button>
                            </div>
                            <p style="color: #666; font-size: 0.8rem; text-align: center; margin: 0;">Tv√© pen√≠ze: ${getMoney()} üí∞ | Zb√Ωv√° l√≠stk≈Ø: ${tombola.maxTicketsPerPlayer - myTickets}</p>
                        ` : `
                            <div style="background: #2a2a1a; padding: 0.8rem; border-radius: 8px; text-align: center;">
                                <p style="color: #ff9800; margin: 0;">‚úì M√°≈° maximum l√≠stk≈Ø (${tombola.maxTicketsPerPlayer})</p>
                            </div>
                        `}
                        <button class="btn" onclick="closeModal()" style="background: #555;">‚Üê Zav≈ô√≠t</button>
                    </div>
                `);
                
            } catch (e) {
                console.error('Show tombola error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se naƒç√≠st tombolu');
            }
        }
        
        // Koupit l√≠stek
        async function buyTombolaTicket(count = 1) {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                // Nejd≈ô√≠v naƒçti z√°kladn√≠ info o tombole
                const snap = await firebaseDB.ref('tombola/active').once('value');
                const tombola = snap.val();
                
                if (!tombola || tombola.status !== 'active') {
                    notifyWarning('Chyba', 'Tombola nen√≠ aktivn√≠');
                    return;
                }
                
                const myName = getPlayerName();
                
                // Sanitizace jm√©na pro Firebase cestu (/ . # $ [ ] nejsou povoleny)
                const sanitizedName = myName.replace(/[\/\.#$\[\]]/g, '_');
                if (sanitizedName !== myName) {
                    console.warn('Tombola: Jm√©no obsahuje nepovolen√© znaky, pou≈æita sanitizovan√° verze:', sanitizedName);
                }
                
                const totalCost = tombola.ticketPrice * count;
                const maxTickets = tombola.maxTicketsPerPlayer || 10;
                
                // P≈ôedbƒõ≈æn√© kontroly
                if (getMoney() < totalCost) {
                    notifyWarning('Nedostatek penƒõz', `Pot≈ôebuje≈° ${totalCost} üí∞`);
                    return;
                }
                
                if (Date.now() > tombola.endsAt) {
                    notifyWarning('Pozdƒõ', 'Tombola ji≈æ skonƒçila');
                    return;
                }
                
                // ATOMICK√Å TRANSAKCE - ≈ôe≈°√≠ race condition
                let transactionSuccess = false;
                let finalCount = 0;
                
                try {
                    const ticketResult = await firebaseDB.ref('tombola/active/tickets/' + sanitizedName).transaction(currentData => {
                        const currentCount = currentData?.count || 0;
                        const currentPaid = currentData?.totalPaid || 0;
                        
                        // Kontrola limitu uvnit≈ô transakce
                        if (currentCount + count > maxTickets) {
                            return; // Abort transakce
                        }
                        
                        return {
                            count: currentCount + count,
                            totalPaid: currentPaid + totalCost,
                            lastPurchase: firebase.database.ServerValue.TIMESTAMP
                        };
                    });
                    
                    if (!ticketResult.committed) {
                        notifyWarning('Limit', `M≈Ø≈æe≈° m√≠t max ${maxTickets} l√≠stk≈Ø`);
                        return;
                    }
                    
                    transactionSuccess = true;
                    finalCount = ticketResult.snapshot.val()?.count || count;
                    
                    // Aktualizuj total pomoc√≠ transakce
                    await firebaseDB.ref('tombola/active/totalTickets').transaction(current => {
                        return (current || 0) + count;
                    });
                    
                } catch (firebaseError) {
                    console.error('Firebase transaction error:', firebaseError);
                    notifyWarning('Chyba serveru', 'Nepoda≈ôilo se koupit l√≠stek. Pen√≠ze nebyly odeƒçteny.');
                    return;
                }
                
                // A≈Ω POTOM odeƒçti pen√≠ze (Firebase transakce uspƒõla)
                if (transactionSuccess) {
                    removeMoney(totalCost);
                    saveGame(true);
                    
                    notifySuccess('üéüÔ∏è L√≠stek koupen!', `M√°≈° ${finalCount} l√≠stk≈Ø`);
                    addLog(`Koupen l√≠stek do tomboly "${escapeHtml(tombola.name)}" za ${totalCost} üí∞`, 'üéüÔ∏è');
                    
                    // Refresh zobrazen√≠
                    showTombola();
                }
                
            } catch (e) {
                console.error('Buy ticket error:', e);
                notifyWarning('Chyba', 'Nepoda≈ôilo se koupit l√≠stek: ' + (e.message ? escapeHtml(e.message) : 'Nezn√°m√° chyba'));
            }
        }
        
        // Zpracov√°n√≠ admin odmƒõny z notifikace
        async function processAdminReward(reward, notificationKey) {
            if (reward.type !== 'admin_reward' || reward.claimed) return;
            
            console.log('üéÅ Zpracov√°v√°m admin odmƒõnu:', reward);
            
            const myName = getPlayerName();
            let receivedItems = [];
            
            // P≈ôidej pen√≠ze
            const money = Math.min(parseInt(reward.money) || 0, 999999);
            if (money > 0) {
                state.money = (state.money || 0) + money;
                console.log('üéÅ P≈ôid√°no penƒõz:', money);
            }
            
            // P≈ôidej XP
            const xp = Math.min(parseInt(reward.xp) || 0, 999999);
            if (xp > 0) {
                addXP(xp);
                console.log('üéÅ P≈ôid√°no XP:', xp);
            }
            
            // P≈ôidej n√°boje
            let receivedAmmo = '';
            if (reward.ammo && reward.ammo.type && reward.ammo.count > 0) {
                const ammoCount = Math.min(reward.ammo.count, 9999);
                addAmmo(reward.ammo.type, ammoCount);
                receivedAmmo = `${ammoCount}x ${reward.ammo.name || reward.ammo.type}`;
                console.log('üéÅ P≈ôid√°no n√°boj≈Ø:', reward.ammo.type, 'x', ammoCount);
            }
            
            // P≈ôidej p≈ôedmƒõt
            if (reward.item && reward.item.id) {
                const itemDef = ITEMS.find(i => i.id === reward.item.id);
                if (itemDef) {
                    const count = Math.min(reward.item.count || 1, 99);
                    const itemCopy = JSON.parse(JSON.stringify(itemDef));
                    itemCopy.count = count;
                    addItemToInventory(itemCopy, count);
                    receivedItems.push(`${count}x ${itemDef.icon} ${itemDef.name}`);
                    console.log('üéÅ P≈ôid√°n p≈ôedmƒõt:', itemDef.name, 'x', count);
                }
            }
            
            // Oznaƒç jako zpracovan√© a sma≈æ
            try {
                await firebaseDB.ref('notifications/' + myName + '/' + notificationKey).remove();
            } catch (e) {
                console.error('Error removing notification:', e);
            }
            
            // Zobraz modal a poƒçkej ne≈æ hr√°ƒç klikne
            return new Promise((resolve) => {
                showModal('üéÅ M√°≈° odmƒõnu od admina!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üéÅ</div>
                        <h3 style="color: #4caf50;">Gratulujeme!</h3>
                        <p style="color: #888;">Dostal jsi odmƒõnu za p≈ô√≠nos h≈ôe:</p>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            ${money > 0 ? `<div style="color: #ffd700; font-size: 1.5rem; font-weight: bold;">+${money} üí∞</div>` : ''}
                            ${xp > 0 ? `<div style="color: #8bc34a; font-size: 1.5rem; font-weight: bold;">+${xp} ‚≠êXP</div>` : ''}
                            ${receivedAmmo ? `<div style="color: #ff9800; font-size: 1.2rem; margin-top: 0.5rem;">+${receivedAmmo}</div>` : ''}
                            ${receivedItems.length > 0 ? `<div style="color: #9c7cff; font-size: 1.1rem; margin-top: 0.5rem;">${receivedItems.join('<br>')}</div>` : ''}
                        </div>
                        ${reward.reason ? `<p style="color: #888; font-size: 0.9rem; font-style: italic;">"${escapeHtml(reward.reason)}"</p>` : ''}
                        <p style="color: #666; font-size: 0.8rem;">Dƒõkujeme za tvou pomoc!</p>
                    </div>
                    <button class="btn" onclick="closeModal(); window._rewardResolved && window._rewardResolved();" style="width: 100%; margin-top: 1rem; background: #4caf50;">üéâ Super!</button>
                `);
                
                // Callback pro zav≈ôen√≠ modalu
                window._rewardResolved = () => {
                    window._rewardResolved = null;
                    renderFull();
                    saveGame(true);
                    resolve();
                };
                
                // Fallback - po 30s automaticky pokraƒçuj
                setTimeout(() => {
                    if (window._rewardResolved) {
                        window._rewardResolved();
                    }
                }, 30000);
            });
        }
        
        // Zpracov√°n√≠ v√Ωhry z notifikace
        function processTombolaWin(notification) {
            if (notification.type !== 'tombola_win') return;
            
            console.log('üéâ Zpracov√°v√°m tombola v√Ωhru:', notification);
            
            const prize = notification.prize;
            if (!prize) {
                console.error('üéâ Chyb√≠ prize v notifikaci!', notification);
                return;
            }
            
            console.log('üéâ Prize objekt:', prize);
            
            const amount = parseInt(prize.amount) || 1;
            
            // P≈ôidej v√Ωhru podle typu
            if (prize.type === 'money') {
                if (amount > 0) {
                    state.money = (state.money || 0) + amount;
                    console.log('üéâ P≈ôid√°no penƒõz:', amount, 'Nov√Ω stav:', state.money);
                    notifySuccess('üéâ V√ùHRA V TOMBOLE!', `+${amount} üí∞`);
                }
            } else if (prize.type === 'tokens') {
                if (amount > 0) {
                    addCasinoTokens(amount);
                    console.log('üéâ P≈ôid√°no token≈Ø:', amount);
                    notifySuccess('üéâ V√ùHRA V TOMBOLE!', `+${amount} üé´`);
                }
            } else if (prize.type === 'xp') {
                if (amount > 0) {
                    addXP(amount);
                    console.log('üéâ P≈ôid√°no XP:', amount);
                    notifySuccess('üéâ V√ùHRA V TOMBOLE!', `+${amount} ‚≠ê XP`);
                }
            } else if (prize.type === 'item') {
                const itemId = prize.itemId;
                if (itemId) {
                    const item = ITEMS.find(i => i.id === itemId);
                    if (item) {
                        // P≈ôidej p≈ôedmƒõt/y do invent√°≈ôe
                        const itemCopy = JSON.parse(JSON.stringify(item));
                        itemCopy.count = amount;
                        addItemToInventory(itemCopy, amount);
                        console.log('üéâ P≈ôid√°n p≈ôedmƒõt:', item.name, 'x', amount);
                        notifySuccess('üéâ V√ùHRA V TOMBOLE!', `${amount}x ${item.icon} ${item.name}`);
                    } else {
                        console.error('üéâ P≈ôedmƒõt nenalezen v ITEMS:', itemId);
                        // Fallback - vytvo≈ô z√°kladn√≠ p≈ôedmƒõt z prize dat
                        if (prize.itemName) {
                            const fallbackItem = {
                                id: itemId,
                                name: prize.itemName,
                                icon: prize.itemIcon || 'üì¶',
                                type: 'misc',
                                count: amount
                            };
                            state.inv.push(fallbackItem);
                            console.log('üéâ P≈ôid√°n fallback p≈ôedmƒõt:', fallbackItem);
                            notifySuccess('üéâ V√ùHRA V TOMBOLE!', `${amount}x ${fallbackItem.icon} ${fallbackItem.name}`);
                        }
                    }
                } else {
                    console.error('üéâ Chyb√≠ itemId v prize:', prize);
                }
            } else {
                console.warn('üéâ Nezn√°m√Ω typ v√Ωhry:', prize.type);
            }
            
            addLog(`V√Ωhra v tombole: ${getPrizeDescription(prize)}`, 'üèÜ');
            saveGame(true);
            
            // Zobraz modal
            showModal('üéâ VYHR√ÅL JSI TOMBOLU!', `
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin: 1rem 0;">üèÜ</div>
                    <h2 style="color: #ffd700; margin: 0;">Gratulujeme!</h2>
                    <p style="color: #888; margin: 0.5rem 0;">Vyhr√°l jsi tombolu "${escapeHtml(notification.tombolaName || 'Tombola')}"!</p>
                    <div style="background: #1a2a1a; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border: 2px solid #4caf50;">
                        <p style="color: #4caf50; font-size: 1.5rem; margin: 0; font-weight: bold;">${getPrizeDescription(prize)}</p>
                    </div>
                </div>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #4caf50;">üéâ Super!</button>
            `);
            
            // Refresh UI
            renderFull();
        }
        
        // === ADMIN - S√çN√ç SL√ÅVY ===
        async function adminManageHallOfFame() {
            if (!isAdmin()) return;
            
            // Naƒçti souƒçasn√© z√°znamy z Firebase
            let entries = [];
            try {
                const snap = await firebaseDB.ref('hallOfFame').once('value');
                const data = snap.val();
                if (data) {
                    entries = Object.entries(data).map(([key, val]) => ({ key, ...val }));
                }
            } catch(e) {}
            
            let entriesHtml = entries.length > 0 ? entries.map(e => `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; color: #ffd700;">${escapeHtml(e.name)}</div>
                        <div style="font-size: 0.75rem; color: #888;">${escapeHtml(e.subtitle || '')}</div>
                    </div>
                    <button class="btn" onclick="adminRemoveFromHallOfFame('${e.key}')" style="background: #c62828; padding: 0.3rem 0.5rem; font-size: 0.75rem;">üóëÔ∏è</button>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">≈Ω√°dn√© z√°znamy v datab√°zi</p>';
            
            showModal('üèõÔ∏è Spr√°va S√≠nƒõ sl√°vy', `
                <div style="background: #1a2a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #4caf50;">‚ûï P≈ôidat nov√Ω z√°znam</h4>
                    <input type="text" id="hofName" placeholder="Jm√©no hr√°ƒçe" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <input type="text" id="hofSubtitle" placeholder="Hl√°≈°ka / popisek" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <button class="btn" onclick="adminAddToHallOfFame()" style="width: 100%; background: #4caf50;">‚ûï P≈ôidat do S√≠nƒõ sl√°vy</button>
                </div>
                
                <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">üìã Aktu√°ln√≠ z√°znamy (Firebase)</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${entriesHtml}
                </div>
                
                <p style="color: #666; font-size: 0.75rem; margin-top: 0.5rem;">üí° Hardcoded legendy (v k√≥du) se zobrazuj√≠ v≈ædy.</p>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function adminAddToHallOfFame() {
            if (!isAdmin()) return;
            
            const name = document.getElementById('hofName')?.value?.trim();
            const subtitle = document.getElementById('hofSubtitle')?.value?.trim();
            
            if (!name) {
                notifyWarning('Chyb√≠ jm√©no', 'Zadej jm√©no hr√°ƒçe');
                return;
            }
            
            try {
                await firebaseDB.ref('hallOfFame').push({
                    name: name,
                    subtitle: subtitle || '',
                    addedAt: Date.now(),
                    addedBy: getPlayerName()
                });
                
                notifySuccess('P≈ôid√°no!', `${name} je nyn√≠ v S√≠ni sl√°vy`);
                adminManageHallOfFame(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se p≈ôidat');
            }
        }
        
        async function adminRemoveFromHallOfFame(key) {
            if (!isAdmin()) return;
            if (!confirm('Opravdu odebrat ze S√≠nƒõ sl√°vy?')) return;
            
            try {
                await firebaseDB.ref('hallOfFame/' + key).remove();
                notifySuccess('Odebr√°no', 'Z√°znam smaz√°n');
                adminManageHallOfFame(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se odebrat');
            }
        }
        
        // === ADMIN - MUTE HR√Åƒå≈Æ ===
        async function adminManageMutes() {
            if (!hasPermission('mute')) return;
            
            // Naƒçti seznam muted hr√°ƒç≈Ø
            let mutes = [];
            try {
                const snap = await firebaseDB.ref('mutedPlayers').once('value');
                const data = snap.val();
                if (data) {
                    mutes = Object.entries(data).map(([key, val]) => ({ key, ...val }));
                }
            } catch(e) {}
            
            let mutesHtml = mutes.length > 0 ? mutes.map(m => `
                <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.3rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; color: #607d8b;">üîá ${escapeHtml(m.name)}</div>
                        <div style="font-size: 0.75rem; color: #888;">D≈Øvod: ${escapeHtml(m.reason || 'Neuvedeno')}</div>
                        <div style="font-size: 0.7rem; color: #666;">Do: ${m.until ? new Date(m.until).toLocaleString('cs') : 'Nav≈ædy'}</div>
                    </div>
                    <button class="btn" onclick="adminUnmutePlayer('${m.key}')" style="background: #4caf50; padding: 0.3rem 0.5rem; font-size: 0.75rem;">üîä Unmute</button>
                </div>
            `).join('') : '<p style="color: #666; text-align: center;">≈Ω√°dn√≠ ztlumen√≠ hr√°ƒçi</p>';
            
            showModal('üîá Spr√°va Mute', `
                <div style="background: #1a1a2a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #607d8b;">üîá Ztlumit hr√°ƒçe</h4>
                    <input type="text" id="muteName" placeholder="Nick hr√°ƒçe" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <input type="text" id="muteReason" placeholder="D≈Øvod (voliteln√©)" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <select id="muteDuration" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                        <option value="3600000">1 hodina</option>
                        <option value="86400000">1 den</option>
                        <option value="604800000">1 t√Ωden</option>
                        <option value="2592000000">1 mƒõs√≠c</option>
                        <option value="0">Nav≈ædy</option>
                    </select>
                    <button class="btn" onclick="adminMutePlayer()" style="width: 100%; background: #607d8b;">üîá Ztlumit</button>
                </div>
                
                <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">üìã Ztlumen√≠ hr√°ƒçi</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${mutesHtml}
                </div>
                
                <p style="color: #888; font-size: 0.75rem; margin-top: 0.5rem;">üí° Ztlumen√≠ hr√°ƒçi nemohou ps√°t do glob√°ln√≠ho chatu.</p>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function adminMutePlayer() {
            if (!hasPermission('mute')) return;
            
            const name = document.getElementById('muteName')?.value?.trim();
            const reason = document.getElementById('muteReason')?.value?.trim();
            const duration = parseInt(document.getElementById('muteDuration')?.value || '0');
            
            if (!name) {
                notifyWarning('Chyb√≠ nick', 'Zadej nick hr√°ƒçe');
                return;
            }
            
            const until = duration > 0 ? Date.now() + duration : 0; // 0 = nav≈ædy
            
            try {
                await firebaseDB.ref('mutedPlayers/' + name).set({
                    name: name,
                    reason: reason || '',
                    until: until,
                    mutedAt: Date.now(),
                    mutedBy: getPlayerName()
                });
                
                notifySuccess('Ztlumen!', `${name} byl ztlumen v chatu`);
                adminManageMutes(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se ztlumit');
            }
        }
        
        async function adminUnmutePlayer(key) {
            if (!hasPermission('mute')) return;
            
            try {
                await firebaseDB.ref('mutedPlayers/' + key).remove();
                notifySuccess('Odtlumeno', 'Hr√°ƒç m≈Ø≈æe opƒõt ps√°t');
                adminManageMutes(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se odtlumit');
            }
        }
        
        // === ADMIN - BAN HR√Åƒå≈Æ ===
        async function adminManageBans() {
            if (!isAdmin()) return;
            
            // Naƒçti seznam banned hr√°ƒç≈Ø z obou zdroj≈Ø
            let bans = [];
            try {
                // Star√Ω form√°t - bannedPlayers
                const snap1 = await firebaseDB.ref('bannedPlayers').once('value');
                const data1 = snap1.val();
                if (data1) {
                    Object.entries(data1).forEach(([key, val]) => {
                        bans.push({ key, source: 'bannedPlayers', name: val.name || key, ...val });
                    });
                }
                
                // Nov√Ω form√°t - bans
                const snap2 = await firebaseDB.ref('bans').once('value');
                const data2 = snap2.val();
                if (data2) {
                    Object.entries(data2).forEach(([key, val]) => {
                        // P≈ôeskoƒç pokud u≈æ existuje
                        if (!bans.find(b => b.name === val.player)) {
                            bans.push({ 
                                key, 
                                source: 'bans', 
                                name: val.player || key, 
                                reason: val.reason,
                                until: val.expiresAt,
                                bannedAt: val.timestamp,
                                bannedBy: val.bannedBy,
                                duration: val.duration
                            });
                        }
                    });
                }
            } catch(e) {
                console.error('Load bans error:', e);
            }
            
            // Se≈ôaƒè podle ƒçasu (nejnovƒõj≈°√≠ prvn√≠)
            bans.sort((a, b) => (b.bannedAt || 0) - (a.bannedAt || 0));
            
            let bansHtml = bans.length > 0 ? bans.map(b => {
                const isPermanent = !b.until || b.until === 0;
                const isExpired = !isPermanent && b.until < Date.now();
                const expiresText = isPermanent ? 'Permanentnƒõ' : (isExpired ? 'Vypr≈°el' : new Date(b.until).toLocaleString('cs'));
                const statusColor = isExpired ? '#888' : (isPermanent ? '#f44336' : '#ff9800');
                
                return `
                    <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${statusColor};">üö´ ${escapeHtml(b.name)}</div>
                                <div style="font-size: 0.75rem; color: #888;">D≈Øvod: ${escapeHtml(b.reason || 'Neuvedeno')}</div>
                                <div style="font-size: 0.7rem; color: #666;">
                                    ${isExpired ? '‚è∞ Vypr≈°el' : (isPermanent ? '‚õî Permanentn√≠' : '‚è±Ô∏è Do: ' + expiresText)}
                                </div>
                                ${b.bannedBy ? `<div style="font-size: 0.65rem; color: #555;">Zabanoval: ${escapeHtml(b.bannedBy)}</div>` : ''}
                            </div>
                            <button class="btn" onclick="adminUnbanPlayer('${b.key}', '${b.source}')" style="background: #4caf50; padding: 0.3rem 0.6rem; font-size: 0.75rem;">‚úÖ Unban</button>
                        </div>
                    </div>
                `;
            }).join('') : '<p style="color: #666; text-align: center; padding: 1rem;">≈Ω√°dn√≠ zabanovan√≠ hr√°ƒçi üéâ</p>';
            
            showModal('üö´ Spr√°va Ban≈Ø', `
                <div style="background: #2a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #f44336;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #f44336;">üö´ Zabanovat hr√°ƒçe</h4>
                    <input type="text" id="banName" placeholder="Nick hr√°ƒçe" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <input type="text" id="banReason2" placeholder="D≈Øvod banu" style="width: 100%; padding: 0.5rem; margin-bottom: 0.3rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                    <select id="banDuration2" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; border: 1px solid #333; background: #0a0a0a; color: #fff;">
                        <option value="60">1 hodina</option>
                        <option value="720">12 hodin</option>
                        <option value="1440">24 hodin</option>
                        <option value="4320">3 dny</option>
                        <option value="10080">7 dn√≠</option>
                        <option value="43200">30 dn√≠</option>
                        <option value="0">Permanentnƒõ</option>
                    </select>
                    <button class="btn" onclick="adminBanPlayer()" style="width: 100%; background: #b71c1c;">üö´ ZABANOVAT</button>
                </div>
                
                <h4 style="margin: 0 0 0.5rem 0; color: #ff9800;">üìã Zabanovan√≠ hr√°ƒçi (${bans.length})</h4>
                <div style="max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    ${bansHtml}
                </div>
                
                <p style="color: #888; font-size: 0.75rem; margin-top: 0.5rem;">‚ö†Ô∏è Zabanovan√≠ hr√°ƒçi nemohou hr√°t hru.</p>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt</button>
            `);
        }
        
        async function adminBanPlayer() {
            if (!isAdmin()) return;
            
            const name = document.getElementById('banName')?.value?.trim();
            const reason = document.getElementById('banReason2')?.value?.trim();
            const duration = parseInt(document.getElementById('banDuration2')?.value || '0');
            
            if (!name) {
                notifyWarning('Chyb√≠ nick', 'Zadej nick hr√°ƒçe');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è Opravdu chce≈° zabanovat hr√°ƒçe "${name}"?`)) return;
            
            const expiresAt = duration > 0 ? Date.now() + (duration * 60 * 1000) : 0; // 0 = permaban
            
            try {
                // Pou≈æij nov√Ω form√°t bans
                await firebaseDB.ref('bans/' + name.replace(/[\/\.#$\[\]]/g, '_')).set({
                    player: name,
                    reason: reason || 'Poru≈°en√≠ pravidel',
                    expiresAt: expiresAt,
                    duration: duration,
                    timestamp: Date.now(),
                    bannedBy: getPlayerName()
                });
                
                notifySuccess('üö´ Zabanov√°n!', `${name} byl zabanov√°n`);
                adminManageBans(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se zabanovat: ' + e.message);
            }
        }
        
        async function adminUnbanPlayer(key, source = 'bannedPlayers') {
            if (!isAdmin()) return;
            
            try {
                await firebaseDB.ref(source + '/' + key).remove();
                notifySuccess('‚úÖ Odbanov√°n', 'Hr√°ƒç m≈Ø≈æe opƒõt hr√°t');
                adminManageBans(); // Refresh
            } catch(e) {
                notifyWarning('Chyba', 'Nepoda≈ôilo se odbanovat: ' + e.message);
            }
        }
        
        // === BAN SCREEN ===
        function showBanScreen(playerName, reason, until) {
            document.body.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, #1a0a0a 0%, #2a0a0a 100%); display: flex; justify-content: center; align-items: center; padding: 2rem;">
                    <div style="background: #1a1a1a; padding: 2rem; border-radius: 16px; max-width: 500px; text-align: center; border: 3px solid #f44336; box-shadow: 0 0 50px rgba(244, 67, 54, 0.5);">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">üö´</div>
                        <h1 style="color: #f44336; margin: 0 0 1rem 0;">P≈ò√çSTUP ODEP≈òEN</h1>
                        <p style="color: #888; font-size: 1.1rem; margin-bottom: 1.5rem;">
                            √öƒçet <strong style="color: #fff;">${escapeHtml(playerName)}</strong> byl zabanov√°n.
                        </p>
                        
                        <div style="background: #2a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #f44336;">
                            <p style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.9rem;">D≈Øvod:</p>
                            <p style="color: #fff; margin: 0; font-size: 1rem;">${escapeHtml(reason || 'Poru≈°en√≠ pravidel')}</p>
                        </div>
                        
                        <div style="background: #1a1a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <p style="color: #888; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Ban vypr≈°√≠:</p>
                            <p style="color: #ff9800; margin: 0; font-size: 1.2rem; font-weight: bold;">${until}</p>
                        </div>
                        
                        <p style="color: #666; font-size: 0.85rem;">
                            Pokud si mysl√≠≈°, ≈æe jde o omyl, kontaktuj admina na Discordu.
                        </p>
                        
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.8rem 2rem; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            üîÑ Zkusit znovu
                        </button>
                    </div>
                </div>
            `;
        }
        
        // === VYƒåISTIT ZASEKNUT√â CAPTURE ===
        async function adminClearCaptures() {
            if (!isAdmin()) return;
            
            showModal('üè¥ Spr√°va Capture', '<div style="text-align: center;"><div class="loading-spinner"></div><p>Naƒç√≠t√°m teritoria...</p></div>');
            
            try {
                const snap = await firebaseDB.ref('territories').once('value');
                const territories = snap.val() || {};
                
                // Najdi v≈°echny aktivn√≠ capture
                const activeCaptures = [];
                for (const [locId, territory] of Object.entries(territories)) {
                    if (territory.activeCapture) {
                        const loc = WORLD_LOCATIONS.find(l => l.id === locId);
                        activeCaptures.push({
                            locationId: locId,
                            locationName: loc?.name || locId,
                            ...territory.activeCapture
                        });
                    }
                }
                
                if (activeCaptures.length === 0) {
                    showModal('üè¥ Spr√°va Capture', `
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                            <p style="color: #8bc34a;">≈Ω√°dn√© aktivn√≠ capture</p>
                            <p style="color: #888; font-size: 0.85rem;">V≈°echna teritoria jsou v po≈ô√°dku.</p>
                        </div>
                        <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt</button>
                    `);
                    return;
                }
                
                let html = `
                    <p style="color: #ff9800; margin-bottom: 1rem;">Nalezeno ${activeCaptures.length} aktivn√≠ch capture:</p>
                    <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                `;
                
                for (const capture of activeCaptures) {
                    const elapsed = Date.now() - capture.startTime;
                    const elapsedMins = Math.floor(elapsed / 60000);
                    const factionData = PVP_FACTIONS[capture.faction];
                    
                    html += `
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold; color: #ddd;">${capture.locationName}</div>
                                    <div style="font-size: 0.8rem; color: #888;">
                                        Hr√°ƒç: <span style="color: #ffd700;">${capture.player}</span> |
                                        Frakce: <span style="color: ${factionData?.color || '#888'};">${factionData?.name || capture.faction}</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: #666;">Bƒõ≈æ√≠: ${elapsedMins} minut</div>
                                </div>
                                <button class="btn" onclick="adminDeleteCapture('${capture.locationId}')" style="background: #c62828; padding: 0.5rem 1rem;">
                                    üóëÔ∏è Smazat
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                    <button class="btn" onclick="adminClearAllCaptures()" style="width: 100%; margin-top: 1rem; background: #f44336;">üóëÔ∏è Smazat V≈†ECHNY capture</button>
                    <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 0.5rem; background: #333;">‚Üê Zpƒõt</button>
                `;
                
                showModal('üè¥ Spr√°va Capture', html);
            } catch(e) {
                console.error('Load captures error:', e);
                showModal('üè¥ Chyba', `<p style="color: #f44336;">Chyba: ${e.message}</p><button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem;">‚Üê Zpƒõt</button>`);
            }
        }
        
        async function adminDeleteCapture(locationId) {
            if (!isAdmin()) return;
            
            try {
                await firebaseDB.ref('territories/' + locationId + '/activeCapture').remove();
                notifySuccess('Smaz√°no', `Capture na ${locationId} byl odstranƒõn`);
                adminClearCaptures(); // Refresh
            } catch(e) {
                console.error('Delete capture error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearAllCaptures() {
            if (!isAdmin()) return;
            
            if (!confirm('Opravdu smazat V≈†ECHNY aktivn√≠ capture?')) return;
            
            try {
                const snap = await firebaseDB.ref('territories').once('value');
                const territories = snap.val() || {};
                
                let count = 0;
                for (const [locId, territory] of Object.entries(territories)) {
                    if (territory.activeCapture) {
                        await firebaseDB.ref('territories/' + locId + '/activeCapture').remove();
                        count++;
                    }
                }
                
                notifySuccess('Hotovo', `Smaz√°no ${count} capture`);
                adminClearCaptures(); // Refresh
            } catch(e) {
                console.error('Clear all captures error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === ZTRACEN√ù POKLAD ===
        async function adminTreasure() {
            if (!hasPermission('treasure')) {
                notifyWarning('‚ùå P≈ô√≠stup odep≈ôen', 'Nem√°≈° opr√°vnƒõn√≠');
                return;
            }
            
            // Naƒçti aktivn√≠ poklad pokud existuje
            let activeTreasure = null;
            try {
                const snap = await firebaseDB.ref('treasure').once('value');
                activeTreasure = snap.val();
            } catch (e) {
                console.log('Treasure load error:', e);
            }
            
            // Seznam lokac√≠
            const locations = WORLD_LOCATIONS.filter(l => l.id !== 'shelter');
            
            // Seznam polo≈æek pro v√Ωbƒõr
            const treasureItems = [
                { id: 'water', name: 'üíß Voda', icon: 'üíß' },
                { id: 'canned_food', name: 'ü•´ Konzerva', icon: 'ü•´' },
                { id: 'medkit', name: 'üíä L√©k√°rniƒçka', icon: 'üíä' },
                { id: 'bandage', name: 'ü©π Obvaz', icon: 'ü©π' },
                { id: 'stimpack', name: 'üíâ Stimpack', icon: 'üíâ' },
                { id: 'money', name: 'üí∞ Pen√≠ze', icon: 'üí∞' },
                { id: 'ammo_9mm', name: 'üîπ 9mm n√°boje', icon: 'üîπ' },
                { id: 'ammo_shell', name: 'üî∏ Broky', icon: 'üî∏' },
                { id: 'scrap', name: 'üî© ≈†rot', icon: 'üî©' },
                { id: 'cloth', name: 'üßµ L√°tka', icon: 'üßµ' },
                { id: 'herbs', name: 'üåø Byliny', icon: 'üåø' },
                { id: 'leather', name: 'ü¶é K≈Ø≈æe', icon: 'ü¶é' },
                { id: 'electronics', name: 'üì± Elektronika', icon: 'üì±' },
                { id: 'chemicals', name: 'üß™ Chemik√°lie', icon: 'üß™' }
            ];
            
            if (activeTreasure && activeTreasure.endTime > Date.now()) {
                // Zobraz aktivn√≠ poklad
                const loc = WORLD_LOCATIONS.find(l => l.id === activeTreasure.locationId);
                const remaining = Math.max(0, activeTreasure.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const claimedCount = activeTreasure.claimedBy ? Object.keys(activeTreasure.claimedBy).length : 0;
                
                let itemsHtml = '';
                if (activeTreasure.items) {
                    activeTreasure.items.forEach(item => {
                        itemsHtml += `<div style="display: inline-block; background: #2a2a2a; padding: 0.3rem 0.6rem; border-radius: 4px; margin: 0.2rem;">${item.icon} ${item.count}x</div>`;
                    });
                }
                if (activeTreasure.money) {
                    itemsHtml += `<div style="display: inline-block; background: #2a2a2a; padding: 0.3rem 0.6rem; border-radius: 4px; margin: 0.2rem;">üí∞ ${activeTreasure.money}</div>`;
                }
                
                showModal('üíé Aktivn√≠ poklad', `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üíé</div>
                        <p style="color: #ffd700; font-size: 1.2rem;">Poklad je aktivn√≠!</p>
                        <p style="margin: 0.3rem 0;"><strong>Lokace:</strong> ${loc?.icon || 'üìç'} ${loc?.name || activeTreasure.locationId}</p>
                        <p style="margin: 0.3rem 0;"><strong>Zb√Ωv√°:</strong> <span style="color: #ff9800;">${mins} minut</span></p>
                        <p style="margin: 0.3rem 0;"><strong>Vyzvedlo:</strong> <span style="color: #4caf50;">${claimedCount} hr√°ƒç≈Ø</span></p>
                        <div style="margin: 0.5rem 0;">${itemsHtml}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="adminCancelTreasure()" style="flex: 1; background: #c62828;">‚ùå Zru≈°it poklad</button>
                        <button class="btn" onclick="closeModal()" style="flex: 1; background: #333;">‚Üê Zav≈ô√≠t</button>
                    </div>
                `);
            } else {
                // Formul√°≈ô pro vytvo≈ôen√≠ nov√©ho pokladu
                showModal('üíé Vytvo≈ôit poklad', `
                    <div style="font-size: 0.9rem;">
                        <p style="color: #ffd700; margin-bottom: 1rem;">Um√≠sti poklad na mapu - ka≈æd√Ω kdo tam dojde si m≈Ø≈æe vz√≠t!</p>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">üìç Lokace:</label>
                            <select id="treasureLocation" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem;">
                                ${locations.map(l => `<option value="${l.id}">${l.icon} ${l.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">‚è±Ô∏è Doba trv√°n√≠:</label>
                            <select id="treasureDuration" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                                <option value="15">15 minut</option>
                                <option value="30" selected>30 minut</option>
                                <option value="60">1 hodina</option>
                                <option value="120">2 hodiny</option>
                                <option value="360">6 hodin</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">üí∞ Pen√≠ze (0 = ≈æ√°dn√©):</label>
                            <input type="number" id="treasureMoney" value="0" min="0" max="10000" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem;">
                        </div>
                        
                        <div style="margin-bottom: 0.8rem;">
                            <label style="color: #888; font-size: 0.8rem;">üì¶ Polo≈æky (vyber a nastav poƒçet):</label>
                            <div id="treasureItemsList" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; border-radius: 6px; padding: 0.5rem; margin-top: 0.3rem;">
                                ${treasureItems.map(item => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem; border-bottom: 1px solid #333;">
                                        <span style="width: 80px;">${item.icon} ${item.name.split(' ')[1]}</span>
                                        <input type="number" id="treasure_${item.id}" value="0" min="0" max="99" style="width: 60px; padding: 0.3rem; background: #0d0d0d; color: #fff; border: 1px solid #444; border-radius: 4px; text-align: center;">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn" onclick="createTreasure()" style="flex: 2; background: linear-gradient(135deg, #ffd700 0%, #ff8f00 100%); color: #000; font-weight: bold;">üíé Vytvo≈ôit poklad</button>
                            <button class="btn" onclick="closeModal()" style="flex: 1; background: #333;">Zru≈°it</button>
                        </div>
                    </div>
                `);
            }
        }
        
        async function createTreasure() {
            if (!isAdmin()) return;
            
            const locationId = document.getElementById('treasureLocation').value;
            const duration = parseInt(document.getElementById('treasureDuration').value);
            const money = parseInt(document.getElementById('treasureMoney').value) || 0;
            
            // Sb√≠r√°n√≠ polo≈æek
            const items = [];
            const itemDefs = [
                { id: 'water', icon: 'üíß' },
                { id: 'canned_food', icon: 'ü•´' },
                { id: 'medkit', icon: 'üíä' },
                { id: 'bandage', icon: 'ü©π' },
                { id: 'stimpack', icon: 'üíâ' },
                { id: 'ammo_9mm', icon: 'üîπ', isAmmo: true, ammoType: '9mm' },
                { id: 'ammo_shell', icon: 'üî∏', isAmmo: true, ammoType: 'shell' },
                { id: 'scrap', icon: 'üî©' },
                { id: 'cloth', icon: 'üßµ' },
                { id: 'herbs', icon: 'üåø' },
                { id: 'leather', icon: 'ü¶é' },
                { id: 'electronics', icon: 'üì±' },
                { id: 'chemicals', icon: 'üß™' }
            ];
            
            itemDefs.forEach(def => {
                const input = document.getElementById('treasure_' + def.id);
                if (input) {
                    const count = parseInt(input.value) || 0;
                    if (count > 0) {
                        items.push({
                            id: def.id,
                            icon: def.icon,
                            count: count,
                            isAmmo: def.isAmmo || false,
                            ammoType: def.ammoType || null
                        });
                    }
                }
            });
            
            // Speci√°ln√≠ handling pro pen√≠ze
            const moneyInput = document.getElementById('treasure_money');
            if (moneyInput) {
                const moneyCount = parseInt(moneyInput.value) || 0;
                if (moneyCount > 0) {
                    // Money se p≈ôid√° p≈ô√≠mo, ne jako item
                }
            }
            
            if (items.length === 0 && money === 0) {
                notifyWarning('Pr√°zdn√Ω poklad', 'P≈ôidej alespo≈à jednu polo≈æku nebo pen√≠ze!');
                return;
            }
            
            try {
                const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
                
                // Ulo≈æ poklad do Firebase
                await firebaseDB.ref('treasure').set({
                    locationId: locationId,
                    items: items,
                    money: money,
                    startTime: Date.now(),
                    endTime: Date.now() + (duration * 60 * 1000),
                    createdBy: ADMIN_NICK,
                    claimedBy: {}
                });
                
                // Zpr√°va do chatu
                let treasureDesc = [];
                items.forEach(item => treasureDesc.push(`${item.count}x ${item.icon}`));
                if (money > 0) treasureDesc.push(`${money} üí∞`);
                
                await firebaseDB.ref('chat/messages').push({
                    player: 'üíé POKLAD',
                    text: `üó∫Ô∏è Byl nalezen ZTRACEN√ù POKLAD na lokaci ${loc?.icon || 'üìç'} ${loc?.name || locationId}! Obsahuje: ${treasureDesc.join(', ')}. Pospƒõ≈°te si - zmiz√≠ za ${duration} minut! üèÉ‚Äç‚ôÇÔ∏è`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                closeModal();
                notifySuccess('üíé Poklad vytvo≈ôen!', `Na ${loc?.name || locationId} - ${duration} minut`);
                
            } catch (e) {
                console.error('Create treasure error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminCancelTreasure() {
            if (!hasPermission('treasure')) return;
            
            if (!confirm('Opravdu zru≈°it poklad?')) return;
            
            try {
                await firebaseDB.ref('treasure').remove();
                window.activeTreasure = null;
                
                await firebaseDB.ref('chat/messages').push({
                    player: 'üíé POKLAD',
                    text: '‚ùå Ztracen√Ω poklad byl odstranƒõn.',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                closeModal();
                notifyInfo('Poklad zru≈°en', 'Odstranƒõno');
                
            } catch (e) {
                console.error('Cancel treasure error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Vyzvednut√≠ pokladu hr√°ƒçem
        async function claimTreasure() {
            if (!multiplayerEnabled || !firebaseDB || !state.char?.name) {
                notifyWarning('Chyba', 'Mus√≠≈° b√Ωt p≈ôihl√°≈°en!');
                return;
            }
            
            try {
                const snap = await firebaseDB.ref('treasure').once('value');
                const treasure = snap.val();
                
                if (!treasure || treasure.endTime < Date.now()) {
                    notifyWarning('Pozdƒõ!', 'Poklad u≈æ zmizel...');
                    window.activeTreasure = null;
                    renderWorldMap();
                    return;
                }
                
                // Kontrola jestli jsem na spr√°vn√© lokaci
                if (state.world?.currentLocation !== treasure.locationId) {
                    notifyWarning('≈†patn√° lokace', 'Mus√≠≈° b√Ωt na m√≠stƒõ pokladu!');
                    return;
                }
                
                // Kontrola jestli u≈æ jsem nevyzvedl
                const myName = state.char.name;
                if (treasure.claimedBy && treasure.claimedBy[myName.replace(/[.\[\]#$/]/g, '_')]) {
                    notifyWarning('U≈æ m√°≈°', 'Tento poklad jsi u≈æ vyzvedl!');
                    return;
                }
                
                // Vyzvedni poklad
                const safeName = myName.replace(/[.\[\]#$/]/g, '_');
                await firebaseDB.ref('treasure/claimedBy/' + safeName).set({
                    time: Date.now(),
                    name: myName
                });
                
                // P≈ôidej polo≈æky do invent√°≈ôe
                let receivedText = [];
                
                if (treasure.items) {
                    treasure.items.forEach(item => {
                        if (item.isAmmo && item.ammoType) {
                            // N√°boje
                            addAmmo(item.ammoType, item.count);
                            receivedText.push(`${item.count}x ${item.icon}`);
                        } else {
                            // Norm√°ln√≠ item
                            const itemDef = ITEMS.find(i => i.id === item.id);
                            if (itemDef) {
                                const newItem = JSON.parse(JSON.stringify(itemDef));
                                newItem.count = item.count;
                                addItemToInventory(newItem, item.count);
                                receivedText.push(`${item.count}x ${item.icon}`);
                            }
                        }
                    });
                }
                
                if (treasure.money > 0) {
                    addMoney(treasure.money);
                    receivedText.push(`${treasure.money} üí∞`);
                }
                
                SoundSystem.play('pickup');
                
                showModal('üíé Poklad vyzvednut!', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                        <h3 style="color: #ffd700;">Na≈°el jsi poklad!</h3>
                        <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="color: #8bc34a; font-size: 1.2rem;">${receivedText.join(', ')}</p>
                        </div>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #ffd700; color: #000;">üéâ Super!</button>
                `);
                
                addLog(`üíé Vyzvedl jsi poklad: ${receivedText.join(', ')}`, 'üíé');
                
            } catch (e) {
                console.error('Claim treasure error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === V√ÅLEƒåN√Å Z√ìNA ===
        async function adminWarZone() {
            if (!hasPermission('warzone')) return;
            
            // Naƒçti aktu√°ln√≠ v√°leƒçnou z√≥nu pokud existuje
            let activeWarZone = null;
            if (multiplayerEnabled && firebaseDB) {
                try {
                    const snap = await firebaseDB.ref('warZone').once('value');
                    activeWarZone = snap.val();
                } catch(e) {}
            }
            
            // Seznam lokac√≠ pro v√Ωbƒõr
            const locations = WORLD_LOCATIONS.filter(l => l.type !== 'home' && l.id !== 'shelter');
            const locOptions = locations.map(l => 
                `<option value="${l.id}" ${activeWarZone?.locationId === l.id ? 'selected' : ''}>${l.icon} ${l.name}</option>`
            ).join('');
            
            // Seznam nep≈ô√°tel pro v√Ωbƒõr
            const enemyOptions = ENEMIES.map(e => 
                `<option value="${e.id}">${e.icon} ${e.name} (HP: ${e.hp}, DMG: ${e.damage})</option>`
            ).join('');
            
            // ƒåasov√© mo≈ænosti
            const timeOptions = `
                <option value="30">30 minut</option>
                <option value="60" selected>1 hodina</option>
                <option value="120">2 hodiny</option>
                <option value="180">3 hodiny</option>
                <option value="360">6 hodin</option>
                <option value="720">12 hodin</option>
                <option value="1440">24 hodin</option>
            `;
            
            // Odmƒõny
            const rewardOptions = `
                <option value="100">100 üí∞</option>
                <option value="250" selected>250 üí∞</option>
                <option value="500">500 üí∞</option>
                <option value="1000">1000 üí∞</option>
            `;
            
            let activeHtml = '';
            if (activeWarZone && activeWarZone.endTime > Date.now()) {
                const loc = WORLD_LOCATIONS.find(l => l.id === activeWarZone.locationId);
                const enemy = ENEMIES.find(e => e.id === activeWarZone.enemyId);
                const remaining = Math.max(0, activeWarZone.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const hours = Math.floor(mins / 60);
                const timeStr = hours > 0 ? `${hours}h ${mins % 60}m` : `${mins}m`;
                
                // Naƒçti aktu√°ln√≠ body
                let pointsHtml = '';
                try {
                    const terrSnap = await firebaseDB.ref('warZone/factionPoints').once('value');
                    const warPoints = terrSnap.val() || {};
                    
                    // Se≈ôaƒè podle bod≈Ø
                    const sorted = Object.entries(PVP_FACTIONS)
                        .map(([fid, f]) => ({ fid, f, pts: warPoints[fid] || 0 }))
                        .sort((a, b) => b.pts - a.pts);
                    
                    pointsHtml = sorted.map(({ fid, f, pts }) => {
                        const isLeader = pts > 0 && pts === sorted[0].pts;
                        return `<div style="display: flex; justify-content: space-between; padding: 0.5rem; background: ${f.color}22; border-radius: 4px; margin: 0.3rem 0; ${isLeader ? 'border: 2px solid ' + f.color : ''}">
                            <span>${f.icon} ${f.name} ${isLeader ? 'üëë' : ''}</span>
                            <span style="font-weight: bold; color: ${f.color}; font-size: 1.1rem;">${pts} bod≈Ø</span>
                        </div>`;
                    }).join('');
                } catch(e) {}
                
                activeHtml = `
                    <div style="background: linear-gradient(135deg, #2a1a1a 0%, #1a1a2a 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ff5722;">
                        <h3 style="color: #ff5722; margin: 0 0 0.5rem 0;">‚öîÔ∏è AKTIVN√ç V√ÅLEƒåN√Å Z√ìNA</h3>
                        <p style="margin: 0.3rem 0;"><strong>Lokace:</strong> ${loc?.icon || 'üìç'} ${loc?.name || activeWarZone.locationId}</p>
                        <p style="margin: 0.3rem 0;"><strong>Nep≈ô√≠tel:</strong> ${enemy?.icon || 'üëπ'} ${enemy?.name || '?'} (${activeWarZone.enemyCount}x)</p>
                        <p style="margin: 0.3rem 0;"><strong>Zb√Ωv√°:</strong> <span style="color: #ffd700;">${timeStr}</span></p>
                        <p style="margin: 0.3rem 0;"><strong>Odmƒõna:</strong> <span style="color: #ffd700;">${activeWarZone.reward} üí∞</span></p>
                        
                        <div style="margin-top: 0.8rem;">
                            <p style="color: #ff9800; font-weight: bold; margin: 0.3rem 0;">üìä Aktu√°ln√≠ sk√≥re:</p>
                            ${pointsHtml}
                        </div>
                        
                        <button class="btn" onclick="adminEndWarZone()" style="width: 100%; margin-top: 1rem; background: #f44336;">
                            üõë Ukonƒçit a vyhodnotit
                        </button>
                        <button class="btn" onclick="adminCancelWarZone()" style="width: 100%; margin-top: 0.5rem; background: #555;">
                            ‚ùå Zru≈°it bez odmƒõn
                        </button>
                    </div>
                `;
            }
            
            showModal('‚öîÔ∏è V√°leƒçn√° z√≥na', `
                ${activeHtml}
                
                <div style="background: #1a2a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #4caf50;">
                    <p style="color: #8bc34a; margin: 0; font-size: 0.85rem;">
                        üí° <strong>Jak to funguje:</strong><br>
                        ‚Ä¢ Vyber lokaci, nep≈ô√≠tele a nastaven√≠<br>
                        ‚Ä¢ Hr√°ƒçi p≈ôijdou na lokaci a bojuj√≠ s tv√Ωm nep≈ô√≠telem<br>
                        ‚Ä¢ Po boji ƒçekaj√≠ 10 minut na dal≈°√≠ boj<br>
                        ‚Ä¢ Hr√°ƒç nem≈Ø≈æe zem≈ô√≠t a nedost√°v√° XP<br>
                        ‚Ä¢ Ka≈æd√Ω zabit√Ω nep≈ô√≠tel = body pro frakci<br>
                        ‚Ä¢ V√≠tƒõzn√° frakce dostane odmƒõnu!
                    </p>
                </div>
                
                <div style="margin-bottom: 0.8rem;">
                    <label style="color: #888; font-size: 0.85rem;">üìç Lokace bitvy:</label>
                    <select id="warZoneLocation" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #ff5722; border-radius: 6px; margin-top: 0.3rem;">
                        ${locOptions}
                    </select>
                </div>
                
                <div style="margin-bottom: 0.8rem;">
                    <label style="color: #888; font-size: 0.85rem;">üëπ Nep≈ô√≠tel:</label>
                    <select id="warZoneEnemy" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #f44336; border-radius: 6px; margin-top: 0.3rem;">
                        ${enemyOptions}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.8rem;">
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">üë• Poƒçet nep≈ô√°tel:</label>
                        <select id="warZoneEnemyCount" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">‚≠ê Body za boj:</label>
                        <select id="warZonePoints" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                            <option value="1">1 bod</option>
                            <option value="2">2 body</option>
                            <option value="3" selected>3 body</option>
                            <option value="5">5 bod≈Ø</option>
                            <option value="10">10 bod≈Ø</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">‚è±Ô∏è Doba trv√°n√≠:</label>
                        <select id="warZoneDuration" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.3rem;">
                            ${timeOptions}
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.85rem;">üèÜ Odmƒõna:</label>
                        <select id="warZoneReward" style="width: 100%; padding: 0.6rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.3rem;">
                            ${rewardOptions}
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="adminStartWarZone()" style="width: 100%; background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 1rem; font-size: 1.1rem;">
                    ‚öîÔ∏è VYHL√ÅSIT V√ÅLEƒåNOU Z√ìNU
                </button>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 0.5rem; background: #333;">‚Üê Zpƒõt</button>
            `);
        }
        
        // Renderov√°n√≠ mapy pro v√Ωbƒõr v√°leƒçn√© z√≥ny (admin)
        function renderWarZoneMap() {
            const cellSize = 38;
            const locations = WORLD_LOCATIONS.filter(l => l.type !== 'home' && l.id !== 'shelter');
            
            let minX = 0, maxX = 0, minY = 0, maxY = 0;
            locations.forEach(loc => {
                if (loc.x < minX) minX = loc.x;
                if (loc.x > maxX) maxX = loc.x;
                if (loc.y < minY) minY = loc.y;
                if (loc.y > maxY) maxY = loc.y;
            });
            
            const gridWidth = (maxX - minX + 1) * cellSize;
            const gridHeight = (maxY - minY + 1) * cellSize;
            
            let html = `<div style="position: relative; width: ${gridWidth}px; height: ${gridHeight}px; margin: 0 auto;">`;
            
            locations.forEach(loc => {
                const left = (loc.x - minX) * cellSize;
                const top = (loc.y - minY) * cellSize;
                
                html += `<div onclick="selectWarZoneLocation('${loc.id}')" 
                    style="position: absolute; left: ${left}px; top: ${top}px; width: ${cellSize - 4}px; height: ${cellSize - 4}px; 
                    background: #1a1a1a; border: 2px solid #444; border-radius: 4px; 
                    display: flex; align-items: center; justify-content: center; font-size: 0.9rem; 
                    cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='#ff5722'; this.style.boxShadow='0 0 10px #ff5722';"
                    onmouseout="this.style.borderColor='#444'; this.style.boxShadow='none';"
                    title="${loc.name}">
                    ${loc.icon}
                </div>`;
            });
            
            html += '</div>';
            return html;
        }
        
        // V√Ωbƒõr lokace pro v√°leƒçnou z√≥nu (admin)
        function selectWarZoneLocation(locationId) {
            window.selectedWarZoneLocation = locationId;
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            
            const enemyOptions = ENEMIES.map(e => 
                `<option value="${e.id}">${e.icon} ${e.name} (HP:${e.hp} DMG:${e.damage} T${e.tier || 1})</option>`
            ).join('');
            
            showModal(`‚öîÔ∏è ${loc?.icon || ''} ${loc?.name || locationId}`, `
                <div style="background: #2a1a1a; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.8rem; border: 2px solid #ff5722; text-align: center;">
                    <span style="color: #ff5722; font-size: 1.1rem;">üìç ${loc?.icon || ''} ${loc?.name || locationId}</span>
                </div>
                
                <div style="margin-bottom: 0.6rem;">
                    <label style="color: #888; font-size: 0.8rem;">üëπ Nep≈ô√≠tel:</label>
                    <select id="warZoneEnemy" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #f44336; border-radius: 6px; margin-top: 0.2rem; font-size: 0.85rem;">
                        ${enemyOptions}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-bottom: 0.6rem;">
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">üë• Poƒçet:</label>
                        <select id="warZoneEnemyCount" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">‚≠ê Body:</label>
                        <select id="warZonePoints" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="5">5</option><option value="10">10</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-bottom: 0.8rem;">
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">‚è±Ô∏è ƒåas:</label>
                        <select id="warZoneDuration" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="30">30m</option><option value="60" selected>1h</option><option value="120">2h</option><option value="180">3h</option><option value="360">6h</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #888; font-size: 0.8rem;">üèÜ Odmƒõna:</label>
                        <select id="warZoneReward" style="width: 100%; padding: 0.5rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 6px; margin-top: 0.2rem;">
                            <option value="100">100üí∞</option><option value="250" selected>250üí∞</option><option value="500">500üí∞</option><option value="1000">1000üí∞</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="adminStartWarZone()" style="width: 100%; background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); padding: 0.8rem; font-size: 1rem;">
                    ‚öîÔ∏è VYHL√ÅSIT V√ÅLKU!
                </button>
                <button class="btn" onclick="adminWarZone()" style="width: 100%; margin-top: 0.4rem; background: #333; padding: 0.6rem;">‚Üê Zpƒõt</button>
            `);
        }
        
        // Spustit v√°leƒçnou z√≥nu
        async function adminStartWarZone() {
            if (!hasPermission('warzone')) return;
            
            // Pou≈æij vybranou lokaci z mapy nebo z dropdownu
            const locationId = window.selectedWarZoneLocation || document.getElementById('warZoneLocation')?.value;
            const enemyId = document.getElementById('warZoneEnemy')?.value;
            const enemyCount = parseInt(document.getElementById('warZoneEnemyCount')?.value) || 3;
            const pointsPerWin = parseInt(document.getElementById('warZonePoints')?.value) || 3;
            const duration = parseInt(document.getElementById('warZoneDuration')?.value) || 60;
            const reward = parseInt(document.getElementById('warZoneReward')?.value) || 250;
            
            if (!locationId || !enemyId) {
                notifyWarning('Chyba', 'Vyber lokaci a nep≈ô√≠tele!');
                return;
            }
            
            const loc = WORLD_LOCATIONS.find(l => l.id === locationId);
            const enemy = ENEMIES.find(e => e.id === enemyId);
            
            try {
                // Nastav v√°leƒçnou z√≥nu v Firebase
                await firebaseDB.ref('warZone').set({
                    locationId: locationId,
                    locationName: loc?.name || locationId,
                    enemyId: enemyId,
                    enemyCount: enemyCount,
                    pointsPerWin: pointsPerWin,
                    startTime: Date.now(),
                    endTime: Date.now() + (duration * 60 * 1000),
                    reward: reward,
                    startedBy: getPlayerName(),
                    factionPoints: {
                        kory: 0,
                        koudy: 0,
                        independent: 0
                    }
                });
                
                // Aktualizuj lok√°ln√≠ cache
                window.activeWarZone = {
                    locationId: locationId,
                    endTime: Date.now() + (duration * 60 * 1000)
                };
                
                // Vyƒçisti vybranou lokaci
                window.selectedWarZoneLocation = null;
                
                // Po≈°li notifikaci v≈°em
                await firebaseDB.ref('chat/messages').push({
                    player: '‚öîÔ∏è SYST√âM',
                    text: `üî• V√ÅLEƒåN√Å Z√ìNA VYHL√Å≈†ENA! üî• Lokace: ${loc?.icon || 'üìç'} ${loc?.name || locationId} | Nep≈ô√≠tel: ${enemy?.icon || 'üëπ'} ${enemy?.name} (${enemyCount}x) | Odmƒõna: ${reward} üí∞ | ƒåas: ${duration} min! Frakce s nejv√≠ce body vyhr√°v√°!`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                notifySuccess('‚öîÔ∏è V√°leƒçn√° z√≥na vyhl√°≈°ena!', `${loc?.name || locationId} - ${duration} minut`);
                closeModal();
                renderFull(); // P≈ôekresli mapu s ƒçerven√Ωm sv√≠cen√≠m
                
            } catch(e) {
                console.error('Start war zone error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Ukonƒçit v√°leƒçnou z√≥nu a vyhodnotit
        // Zru≈°it v√°leƒçnou z√≥nu bez vyhodnocen√≠ a odmƒõn
        async function adminCancelWarZone() {
            if (!hasPermission('warzone')) return;
            
            if (!confirm('Opravdu zru≈°it v√°leƒçnou z√≥nu BEZ odmƒõn? Nikdo nedostane odmƒõny.')) return;
            
            try {
                // Sma≈æ v√°leƒçnou z√≥nu
                await firebaseDB.ref('warZone').remove();
                
                // Vyƒçisti cache
                window.activeWarZone = null;
                
                // Ozn√°men√≠ do chatu
                await firebaseDB.ref('chat/messages').push({
                    player: '‚öîÔ∏è SYST√âM',
                    text: '‚ùå V√°leƒçn√° z√≥na byla ZRU≈†ENA! ≈Ω√°dn√© odmƒõny nebyly rozd√°ny.',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                notifyInfo('‚ùå V√°leƒçn√° z√≥na zru≈°ena', 'Bez odmƒõn');
                closeModal();
                renderFull();
                
            } catch(e) {
                console.error('Cancel war zone error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Automatick√© vyhodnocen√≠ expirovan√© war zone (vol√° se kdy≈æ nƒõkdo naƒçte mapu a war zone u≈æ skonƒçila)
        async function autoEvaluateExpiredWarZone(warZone) {
            if (!warZone || !firebaseDB) return;
            
            try {
                // Pou≈æij transakci aby se to provedlo jen jednou
                const lockRef = firebaseDB.ref('warZone/evaluating');
                const lockResult = await lockRef.transaction(current => {
                    if (current === true) return; // U≈æ nƒõkdo vyhodnocuje
                    return true;
                });
                
                if (!lockResult.committed) {
                    console.log('‚öîÔ∏è War zone already being evaluated by another client');
                    return;
                }
                
                console.log('‚öîÔ∏è Auto-evaluating expired war zone...');
                
                // Naƒçti aktu√°ln√≠ stav (mohl se zmƒõnit)
                const snap = await firebaseDB.ref('warZone').once('value');
                const currentWarZone = snap.val();
                
                if (!currentWarZone || currentWarZone.endTime > Date.now()) {
                    // U≈æ nen√≠ nebo je≈°tƒõ neskonƒçila
                    await lockRef.remove();
                    return;
                }
                
                // Naƒçti body
                const warPoints = currentWarZone.factionPoints || {};
                
                // Najdi v√≠tƒõze
                let winner = null;
                let maxPoints = 0;
                for (const [fid, pts] of Object.entries(warPoints)) {
                    if (pts > maxPoints) {
                        maxPoints = pts;
                        winner = fid;
                    }
                }
                
                if (!winner || maxPoints === 0) {
                    // Nikdo nebojoval
                    await firebaseDB.ref('warZone').remove();
                    
                    await firebaseDB.ref('chat/messages').push({
                        player: '‚öîÔ∏è SYST√âM',
                        text: `‚è∞ V√°leƒçn√° z√≥na automaticky skonƒçila bez v√≠tƒõze! Nikdo nez√≠skal body.`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: 'system'
                    });
                    
                    console.log('‚öîÔ∏è War zone ended without winner');
                    return;
                }
                
                const winnerFaction = PVP_FACTIONS[winner];
                
                // Rozdej odmƒõny ƒçlen≈Øm v√≠tƒõzn√© frakce
                const membersSnap = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnap.val() || {};
                
                let winnersCount = 0;
                for (const [key, member] of Object.entries(members)) {
                    if (member.faction === winner) {
                        const safeName = member.name.replace(/[\\/.#$\[\]]/g, '_');
                        await firebaseDB.ref('notifications/' + safeName).push({
                            type: 'war_reward',
                            title: '‚öîÔ∏è V√≠tƒõzstv√≠ ve v√°leƒçn√© z√≥nƒõ!',
                            message: `Tv√° frakce ${winnerFaction.icon} ${winnerFaction.name} vyhr√°la bitvu s ${maxPoints} body! Odmƒõna: ${currentWarZone.reward} üí∞`,
                            reward: { money: currentWarZone.reward },
                            timestamp: Date.now(),
                            read: false
                        });
                        winnersCount++;
                    }
                }
                
                // Nastav √∫zem√≠ jako vlastnƒõn√© v√≠tƒõznou frakc√≠
                await firebaseDB.ref('territories/' + currentWarZone.locationId + '/owner').set(winner);
                
                // Ulo≈æ do historie
                await firebaseDB.ref('warZoneHistory').push({
                    locationId: currentWarZone.locationId,
                    winner: winner,
                    points: warPoints,
                    reward: currentWarZone.reward,
                    winnersCount: winnersCount,
                    endTime: Date.now(),
                    autoEvaluated: true
                });
                
                // Sma≈æ v√°leƒçnou z√≥nu
                await firebaseDB.ref('warZone').remove();
                
                // Ozn√°men√≠ do chatu
                const allPoints = Object.entries(warPoints)
                    .filter(([_, pts]) => pts > 0)
                    .sort((a, b) => b[1] - a[1])
                    .map(([fid, pts]) => `${PVP_FACTIONS[fid]?.icon || '?'} ${pts}`)
                    .join(' | ');
                
                await firebaseDB.ref('chat/messages').push({
                    player: '‚öîÔ∏è SYST√âM',
                    text: `‚è∞ V√°leƒçn√° z√≥na automaticky skonƒçila! üèÜ V√≠tƒõz: ${winnerFaction.icon} ${winnerFaction.name} (${maxPoints} bod≈Ø)! V√Ωsledky: ${allPoints}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                console.log('‚öîÔ∏è War zone auto-evaluated, winner:', winner);
                
            } catch (e) {
                console.error('Auto-evaluate war zone error:', e);
            }
        }
        
        async function adminEndWarZone() {
            if (!hasPermission('warzone')) return;
            
            if (!confirm('Opravdu ukonƒçit v√°leƒçnou z√≥nu a rozdat odmƒõny?')) return;
            
            try {
                const snap = await firebaseDB.ref('warZone').once('value');
                const warZone = snap.val();
                
                if (!warZone) {
                    notifyWarning('Chyba', '≈Ω√°dn√° aktivn√≠ v√°leƒçn√° z√≥na');
                    return;
                }
                
                // Naƒçti body
                const warPoints = warZone.factionPoints || {};
                
                // Najdi v√≠tƒõze
                let winner = null;
                let maxPoints = 0;
                for (const [fid, pts] of Object.entries(warPoints)) {
                    if (pts > maxPoints) {
                        maxPoints = pts;
                        winner = fid;
                    }
                }
                
                if (!winner || maxPoints === 0) {
                    // Nikdo nebojoval
                    await firebaseDB.ref('warZone').remove();
                    
                    await firebaseDB.ref('chat/messages').push({
                        player: '‚öîÔ∏è SYST√âM',
                        text: `‚ùå V√°leƒçn√° z√≥na skonƒçila bez v√≠tƒõze! Nikdo nez√≠skal body.`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: 'system'
                    });
                    
                    notifyInfo('V√°leƒçn√° z√≥na skonƒçila', 'Bez v√≠tƒõze');
                    closeModal();
                    return;
                }
                
                const winnerFaction = PVP_FACTIONS[winner];
                
                // Rozdej odmƒõny ƒçlen≈Øm v√≠tƒõzn√© frakce
                const membersSnap = await firebaseDB.ref('factionMembers').once('value');
                const members = membersSnap.val() || {};
                
                let winnersCount = 0;
                for (const [key, member] of Object.entries(members)) {
                    if (member.faction === winner) {
                        // Po≈°li notifikaci s odmƒõnou
                        const safeName = member.name.replace(/[\\/\\.#$\\[\\]]/g, '_');
                        await firebaseDB.ref('notifications/' + safeName).push({
                            type: 'war_reward',
                            title: '‚öîÔ∏è V√≠tƒõzstv√≠ ve v√°leƒçn√© z√≥nƒõ!',
                            message: `Tv√° frakce ${winnerFaction.icon} ${winnerFaction.name} vyhr√°la bitvu s ${maxPoints} body! Odmƒõna: ${warZone.reward} üí∞`,
                            reward: { money: warZone.reward },
                            timestamp: Date.now(),
                            read: false
                        });
                        winnersCount++;
                    }
                }
                
                // Nastav √∫zem√≠ jako vlastnƒõn√© v√≠tƒõznou frakc√≠
                await firebaseDB.ref('territories/' + warZone.locationId + '/owner').set(winner);
                
                // Ulo≈æ do historie v√≠tƒõzstv√≠
                await firebaseDB.ref('warZoneHistory').push({
                    locationId: warZone.locationId,
                    winner: winner,
                    points: warPoints,
                    reward: warZone.reward,
                    winnersCount: winnersCount,
                    endTime: Date.now()
                });
                
                // Sma≈æ v√°leƒçnou z√≥nu
                await firebaseDB.ref('warZone').remove();
                
                // Vyƒçisti cache
                window.activeWarZone = null;
                
                // Ozn√°men√≠ do chatu
                const allPoints = Object.entries(warPoints)
                    .filter(([_, pts]) => pts > 0)
                    .sort((a, b) => b[1] - a[1])
                    .map(([fid, pts]) => `${PVP_FACTIONS[fid]?.icon || '?'} ${pts}`)
                    .join(' | ');
                
                await firebaseDB.ref('chat/messages').push({
                    player: '‚öîÔ∏è SYST√âM',
                    text: `üèÜ V√ÅLEƒåN√Å Z√ìNA SKONƒåILA! V√≠tƒõz: ${winnerFaction.icon} ${winnerFaction.name}! Sk√≥re: ${allPoints} | ${winnersCount} hr√°ƒç≈Ø dost√°v√° ${warZone.reward} üí∞!`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                notifySuccess('üèÜ V√°leƒçn√° z√≥na vyhodnocena!', `V√≠tƒõz: ${winnerFaction.name} (${maxPoints} bod≈Ø)`);
                closeModal();
                
            } catch(e) {
                console.error('End war zone error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        // Zkontrolovat jestli je hr√°ƒç ve v√°leƒçn√© z√≥nƒõ a m≈Ø≈æe bojovat
        async function checkWarZoneFight() {
            if (!multiplayerEnabled || !firebaseDB) return null;
            
            try {
                const snap = await firebaseDB.ref('warZone').once('value');
                const warZone = snap.val();
                
                if (!warZone || warZone.endTime < Date.now()) return null;
                if (state.world?.currentLocation !== warZone.locationId) return null;
                
                const playerFaction = getPlayerFaction();
                if (!playerFaction) return null;
                
                // Zkontroluj cooldown
                const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                const cooldownSnap = await firebaseDB.ref('warZone/cooldowns/' + myName).once('value');
                const lastFight = cooldownSnap.val() || 0;
                const cooldownMs = 10 * 60 * 1000; // 10 minut
                
                if (Date.now() - lastFight < cooldownMs) {
                    const remaining = Math.ceil((cooldownMs - (Date.now() - lastFight)) / 60000);
                    return { canFight: false, cooldown: remaining, warZone: warZone };
                }
                
                return { canFight: true, warZone: warZone, faction: playerFaction };
                
            } catch(e) {
                console.error('Check war zone error:', e);
                return null;
            }
        }
        
        // Zobrazit UI pro v√°leƒçnou z√≥nu na lokaci
        async function showWarZoneUI() {
            const check = await checkWarZoneFight();
            
            if (!check) return;
            
            const warZone = check.warZone;
            const enemy = ENEMIES.find(e => e.id === warZone.enemyId);
            const loc = WORLD_LOCATIONS.find(l => l.id === warZone.locationId);
            const remaining = Math.max(0, warZone.endTime - Date.now());
            const mins = Math.floor(remaining / 60000);
            
            // Aktu√°ln√≠ sk√≥re
            const points = warZone.factionPoints || {};
            const sorted = Object.entries(PVP_FACTIONS)
                .map(([fid, f]) => ({ fid, f, pts: points[fid] || 0 }))
                .sort((a, b) => b.pts - a.pts);
            
            const scoreHtml = sorted.map(({ fid, f, pts }) => 
                `<span style="color: ${f.color}; margin: 0 0.3rem;">${f.icon} ${pts}</span>`
            ).join('|');
            
            if (!check.canFight) {
                showModal('‚öîÔ∏è V√°leƒçn√° z√≥na', `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem;">‚è≥</div>
                        <h3 style="color: #ff9800;">Mus√≠≈° poƒçkat!</h3>
                        <p style="color: #888;">Dal≈°√≠ boj za <strong style="color: #ffd700; font-size: 1.5rem;">${check.cooldown} min</strong></p>
                        
                        <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="color: #888; margin: 0 0 0.3rem 0; font-size: 0.85rem;">Aktu√°ln√≠ sk√≥re:</p>
                            <div style="font-size: 1.1rem;">${scoreHtml}</div>
                        </div>
                        
                        <p style="color: #666; font-size: 0.85rem;">Zb√Ωv√° ${mins} minut do konce ud√°losti</p>
                    </div>
                    <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 1rem; background: #555;">Zav≈ô√≠t</button>
                `);
                return;
            }
            
            const factionData = PVP_FACTIONS[check.faction];
            
            showModal('‚öîÔ∏è V√°leƒçn√° z√≥na', `
                <div style="text-align: center;">
                    <div style="font-size: 3rem;">${enemy?.icon || 'üëπ'}</div>
                    <h3 style="color: #f44336;">${enemy?.name || 'Nep≈ô√≠tel'} (${warZone.enemyCount}x)</h3>
                    <p style="color: #888;">HP: ${enemy?.hp || '?'} | DMG: ${enemy?.damage || '?'}</p>
                    
                    <div style="background: #1a1a1a; padding: 0.8rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #888; margin: 0 0 0.3rem 0; font-size: 0.85rem;">Aktu√°ln√≠ sk√≥re:</p>
                        <div style="font-size: 1.1rem;">${scoreHtml}</div>
                    </div>
                    
                    <p style="color: ${factionData.color};">Bojuje≈° za: ${factionData.icon} ${factionData.name}</p>
                    <p style="color: #8bc34a; font-size: 0.9rem;">üõ°Ô∏è Nem≈Ø≈æe≈° zem≈ô√≠t | ‚≠ê +${warZone.pointsPerWin} bod≈Ø za v√Ωhru</p>
                    <p style="color: #666; font-size: 0.85rem;">Zb√Ωv√° ${mins} minut | Odmƒõna: ${warZone.reward} üí∞</p>
                </div>
                
                <button class="btn" onclick="startWarZoneFight()" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #f44336 0%, #c62828 100%); padding: 1rem; font-size: 1.2rem;">
                    ‚öîÔ∏è BOJOVAT!
                </button>
                <button class="btn" onclick="closeModal()" style="width: 100%; margin-top: 0.5rem; background: #555;">Pozdƒõji</button>
            `);
        }
        
        // Spustit boj ve v√°leƒçn√© z√≥nƒõ
        async function startWarZoneFight() {
            const check = await checkWarZoneFight();
            
            if (!check || !check.canFight) {
                notifyWarning('Nelze bojovat', 'Mus√≠≈° poƒçkat na cooldown');
                closeModal();
                return;
            }
            
            const warZone = check.warZone;
            const enemyTemplate = ENEMIES.find(e => e.id === warZone.enemyId);
            
            if (!enemyTemplate) {
                notifyWarning('Chyba', 'Nep≈ô√≠tel nenalezen');
                closeModal();
                return;
            }
            
            // Vytvo≈ô pole nep≈ô√°tel pro bojov√Ω syst√©m
            const enemyGroup = [];
            for (let i = 0; i < warZone.enemyCount; i++) {
                enemyGroup.push({
                    ...enemyTemplate,
                    hp: enemyTemplate.hp,
                    maxHp: enemyTemplate.hp
                });
            }
            
            // Ulo≈æ aktu√°ln√≠ HP p≈ôed bojem
            const savedHp = state.char.hp;
            
            // Dej pln√© HP pro war zone boj
            state.char.hp = state.char.maxHp;
            
            // Oznaƒç jako war zone boj (speci√°ln√≠ re≈æim - ≈æ√°dn√° smrt, ≈æ√°dn√© XP)
            state.warZoneFight = {
                active: true,
                faction: check.faction,
                pointsPerWin: warZone.pointsPerWin,
                locationId: warZone.locationId,
                savedHp: savedHp  // Ulo≈æen√© HP pro obnoven√≠ po boji
            };
            
            closeModal();
            
            // Spus≈• norm√°ln√≠ boj se v≈°emi bonusy hr√°ƒçe
            // skipPreCombat = false - uka≈æ p≈ô√≠pravu spoleƒçn√≠k≈Ø pokud nƒõjak√© m√°
            startCombatWithGroup(enemyGroup, 'war_zone', false);
        }
        
        // Po dokonƒçen√≠ boje ve v√°leƒçn√© z√≥nƒõ
        async function finishWarZoneFight(won) {
            if (!state.warZoneFight?.active) return;
            
            const warFight = state.warZoneFight;
            state.warZoneFight = null;
            
            if (!won) {
                notifyInfo('Boj prohr√°n', 'Zkus to znovu za 10 minut');
                return;
            }
            
            try {
                const myName = getPlayerName().replace(/[\\/\\.#$\\[\\]]/g, '_');
                
                // Nastav cooldown
                await firebaseDB.ref('warZone/cooldowns/' + myName).set(Date.now());
                
                // P≈ôidej body frakci (do war zone)
                await firebaseDB.ref('warZone/factionPoints/' + warFight.faction).transaction(current => (current || 0) + warFight.pointsPerWin);
                
                // P≈ôidej body i hr√°ƒçovi do ≈æeb≈ô√≠ƒçku - spolehlivƒõj≈°√≠ metoda
                const contribRef = firebaseDB.ref('factionMembers/' + myName + '/contribution');
                const snap = await contribRef.once('value');
                const currentContrib = snap.val() || 0;
                await contribRef.set(currentContrib + warFight.pointsPerWin);
                console.log('üè¥ War zone contribution updated: ' + currentContrib + ' -> ' + (currentContrib + warFight.pointsPerWin));
                
                state.pvpFactionContribution = (state.pvpFactionContribution || 0) + warFight.pointsPerWin;
                
                const factionData = PVP_FACTIONS[warFight.faction];
                notifySuccess(`+${warFight.pointsPerWin} bod≈Ø!`, `Pro ${factionData.icon} ${factionData.name}`);
                
                // Refresh pokud jsme st√°le na lokaci
                if (state.world?.currentLocation === warFight.locationId) {
                    setTimeout(() => showWarZoneUI(), 1000);
                }
                
            } catch(e) {
                console.error('Finish war zone fight error:', e);
            }
        }
        
        // Zkontrolovat a zobrazit war zone UI p≈ôi p≈ô√≠chodu na lokaci
        async function checkAndShowWarZone() {
            if (!multiplayerEnabled || !firebaseDB) return;
            
            try {
                const snap = await firebaseDB.ref('warZone').once('value');
                const warZone = snap.val();
                
                if (!warZone || warZone.endTime < Date.now()) return;
                if (state.world?.currentLocation !== warZone.locationId) return;
                
                const playerFaction = getPlayerFaction();
                if (!playerFaction) return;
                
                // Zobraz war zone UI s mal√Ωm zpo≈ædƒõn√≠m
                setTimeout(() => showWarZoneUI(), 500);
                
            } catch(e) {
                console.error('Check war zone error:', e);
            }
        }
        
                // === DANGER ZONE ===
        function adminDangerZone() {
            if (!isAdmin()) return;
            
            showModal('‚ò¢Ô∏è DANGER ZONE', `
                <div style="background: #3a1a1a; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #f44336;">
                    <p style="color: #f44336; font-weight: bold; margin: 0 0 0.5rem 0;">‚ö†Ô∏è VAROV√ÅN√ç</p>
                    <p style="color: #888; font-size: 0.85rem; margin: 0;">Tyto akce jsou NEVRATN√â a sma≈æou data v≈°ech hr√°ƒç≈Ø!</p>
                </div>
                
                <div style="display: grid; gap: 0.5rem;">
                    <button class="btn" onclick="adminResetDatabase()" style="background: linear-gradient(135deg, #b71c1c 0%, #4a0000 100%); padding: 1rem;">
                        ‚ò¢Ô∏è RESET CEL√â DATAB√ÅZE
                    </button>
                    <button class="btn" onclick="adminResetFactions()" style="background: linear-gradient(135deg, #d84315 0%, #6a1b00 100%); padding: 1rem;">
                        üè¥ RESET FRAKC√ç
                    </button>
                    <button class="btn" onclick="adminClearOnlinePlayers()" style="background: #c62828; padding: 0.8rem;">
                        üë• Vyƒçistit online hr√°ƒçe
                    </button>
                    <button class="btn" onclick="adminClearNotifications()" style="background: #c62828; padding: 0.8rem;">
                        üîî Smazat v≈°echny notifikace
                    </button>
                </div>
                
                <button class="btn" onclick="showAdminPanel()" style="width: 100%; margin-top: 1rem; background: #333;">‚Üê Zpƒõt</button>
            `);
        }
        
        // Reset frakc√≠ - sma≈æe v≈°echna √∫zem√≠, ƒçleny a historii
        async function adminResetFactions() {
            if (!isAdmin()) return;
            if (!confirm('‚ö†Ô∏è OPRAVDU CHCE≈† RESETOVAT V≈†ECHNY FRAKCE?')) return;
            if (!confirm('Toto sma≈æe:\n‚Ä¢ V≈°echna √∫zem√≠\n‚Ä¢ V≈°echny ƒçleny frakc√≠\n‚Ä¢ Historii sez√≥n\n‚Ä¢ V√°leƒçnou z√≥nu\n\nHr√°ƒçi si budou muset znovu vybrat frakci!')) return;
            
            try {
                const resetTime = Date.now();
                
                // Sma≈æ √∫zem√≠
                await firebaseDB.ref('territories').remove();
                
                // Sma≈æ ƒçleny frakc√≠
                await firebaseDB.ref('factionMembers').remove();
                
                // Sma≈æ historii sez√≥n
                await firebaseDB.ref('factionSeasonHistory').remove();
                
                // Nastav novou sez√≥nu s ƒçasem resetu (d≈Øle≈æit√© pro detekci u ostatn√≠ch hr√°ƒç≈Ø!)
                await firebaseDB.ref('factionSeason').set({
                    startTime: resetTime,
                    seasonNumber: 1,
                    lastReset: resetTime
                });
                
                // Sma≈æ v√°leƒçnou z√≥nu
                await firebaseDB.ref('warZone').remove();
                
                // Vyƒçisti cache
                window.territoryCache = null;
                window.activeWarZone = null;
                
                // Reset lok√°ln√≠ho stavu frakce - hr√°ƒç si mus√≠ vybrat znovu
                state.pvpFaction = null;
                state.pvpFactionJoinedAt = null;
                state.pvpFactionContribution = 0;
                saveGame();
                
                // Ozn√°men√≠ do chatu
                await firebaseDB.ref('chat/messages').push({
                    player: '‚öîÔ∏è SYST√âM',
                    text: 'üè¥ FRAKCE BYLY RESETOV√ÅNY! V≈°echna √∫zem√≠ a ƒçlenstv√≠ byla smaz√°na. Vyberte si novou frakci!',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'system'
                });
                
                notifySuccess('üè¥ FRAKCE RESETOV√ÅNY', 'V≈°echna data frakc√≠ byla smaz√°na');
                closeModal();
                renderFull();
                
            } catch (e) {
                console.error('Reset factions error:', e);
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminResetDatabase() {
            if (!isAdmin()) return;
            if (!confirm('‚ö†Ô∏è OPRAVDU CHCE≈† SMAZAT CELOU DATAB√ÅZI?')) return;
            if (!confirm('TATO AKCE JE NEVRATN√Å! V≈°echna data budou ztracena!')) return;
            if (prompt('Napi≈° "SMAZAT" pro potvrzen√≠:') !== 'SMAZAT') {
                notifyWarning('Zru≈°eno', 'Reset nebyl proveden');
                return;
            }
            
            try {
                await firebaseDB.ref('leaderboard').remove();
                await firebaseDB.ref('chat').remove();
                await firebaseDB.ref('marketplace').remove();
                await firebaseDB.ref('pvp').remove();
                await firebaseDB.ref('online').remove();
                await firebaseDB.ref('notifications').remove();
                await firebaseDB.ref('ratings').remove();
                await firebaseDB.ref('tradeHistory').remove();
                await firebaseDB.ref('gifts').remove();
                
                notifySuccess('‚ò¢Ô∏è DATAB√ÅZE RESETOV√ÅNA', 'V≈°echna data byla smaz√°na');
                showAdminPanel();
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearOnlinePlayers() {
            if (!isAdmin()) return;
            if (!confirm('Smazat v≈°echny online hr√°ƒçe?')) return;
            
            try {
                await firebaseDB.ref('online').remove();
                notifySuccess('Hotovo', 'Online seznam vyƒçi≈°tƒõn');
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        async function adminClearNotifications() {
            if (!isAdmin()) return;
            if (!confirm('Smazat v≈°echny notifikace v≈°ech hr√°ƒç≈Ø?')) return;
            
            try {
                await firebaseDB.ref('notifications').remove();
                notifySuccess('Hotovo', 'Notifikace smaz√°ny');
            } catch (e) {
                notifyWarning('Chyba', e.message);
            }
        }
        
        // === GLOB√ÅLN√ç EXPORTY PRO ONCLICK ===
        window.adminTreasure = adminTreasure;
        window.createTreasure = createTreasure;
        window.adminCancelTreasure = adminCancelTreasure;
        window.claimTreasure = claimTreasure;
        window.showLootFilterSettings = showLootFilterSettings;
        window.updateLootFilter = updateLootFilter;
        window.resetLootFilter = resetLootFilter;
        window.recycleItem = recycleItem;
        window.confirmRecycle = confirmRecycle;
        // Dungeon funkce
        window.exploreDungeonFloor = exploreDungeonFloor;
        window.descendDungeon = descendDungeon;
        window.ascendDungeon = ascendDungeon;
        window.exitDungeon = exitDungeon;
        window.showDungeonUI = showDungeonUI;
        window.enterDungeon = enterDungeon;
        window.handleDungeonVictory = handleDungeonVictory;
        window.handleAbyssVictory = handleAbyssVictory;
    </script>
</body>
</html>
