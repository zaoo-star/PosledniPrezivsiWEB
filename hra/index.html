<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F√≥rum | Posledn√≠ P≈ôe≈æiv≈°√≠</title>
    <meta name="description" content="Komunitn√≠ f√≥rum hry Posledn√≠ P≈ôe≈æiv≈°√≠. Diskutuj, sd√≠lej n√°vody a hl√°sej bugy.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Share+Tech+Mono&family=Oxanium:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --rust: #d4722e; --rust-glow: rgba(212, 114, 46, 0.6); --blood: #8b0000;
            --toxic: #7cfc00; --toxic-dark: #3d5e00; --radiation: #ffff00;
            --dark: #0a0a0a; --darker: #050505; --metal: #2a2a2a;
            --text: #c4b998; --text-light: #e8dcc4;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Oxanium', sans-serif; background: var(--darker); color: var(--text); line-height: 1.6; min-height: 100vh; }
        a { color: var(--rust); text-decoration: none; transition: color 0.3s; }
        a:hover { color: var(--text-light); }
        
        /* Noise overlay */
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"); opacity: 0.03; pointer-events: none; z-index: 9999; }
        
        /* Navigation */
        nav { position: fixed; top: 0; left: 0; right: 0; padding: 0.8rem 2rem; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 1000; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(212, 114, 46, 0.3); }
        .nav-brand { display: flex; align-items: center; gap: 0.8rem; text-decoration: none; }
        .nav-logo { width: 40px; height: 40px; background: radial-gradient(circle, var(--radiation) 0%, var(--rust) 50%, transparent 70%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 0 15px var(--rust-glow); }
        .nav-title { font-family: 'Russo One', sans-serif; font-size: 1.1rem; color: var(--rust); text-transform: uppercase; letter-spacing: 2px; }
        .nav-links { display: flex; gap: 0.5rem; align-items: center; }
        .nav-link { color: var(--text); padding: 0.5rem 1rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; border: 1px solid transparent; transition: all 0.3s; }
        .nav-link:hover { color: var(--rust); border-color: var(--rust); }
        .nav-user { display: flex; align-items: center; gap: 0.5rem; color: var(--toxic); font-size: 0.85rem; }
        
        /* Main container */
        .container { max-width: 1200px; margin: 0 auto; padding: 100px 1rem 2rem; }
        
        /* Header */
        .forum-header { text-align: center; margin-bottom: 2rem; padding: 2rem; background: linear-gradient(180deg, rgba(212, 114, 46, 0.1) 0%, transparent 100%); border-bottom: 1px solid rgba(212, 114, 46, 0.2); }
        .forum-header h1 { font-family: 'Russo One', sans-serif; font-size: 2rem; color: var(--rust); margin-bottom: 0.5rem; }
        .forum-header p { color: #888; font-size: 0.9rem; }
        
        /* Categories */
        .categories { display: grid; gap: 1rem; margin-bottom: 2rem; }
        .category { background: linear-gradient(180deg, #151210 0%, #0a0908 100%); border: 1px solid #2a2520; border-radius: 8px; overflow: hidden; transition: all 0.3s; cursor: pointer; }
        .category:hover { border-color: var(--rust); transform: translateY(-2px); }
        .category-header { display: flex; align-items: center; gap: 1rem; padding: 1.2rem 1.5rem; background: rgba(212, 114, 46, 0.05); }
        .category-icon { font-size: 2rem; width: 50px; text-align: center; }
        .category-info { flex: 1; }
        .category-name { font-family: 'Russo One', sans-serif; font-size: 1.1rem; color: var(--text-light); margin-bottom: 0.2rem; }
        .category-desc { font-size: 0.85rem; color: #888; }
        .category-stats { text-align: right; font-size: 0.8rem; color: #666; }
        .category-stats span { display: block; }
        .category-count { color: var(--rust); font-weight: bold; }
        
        /* Topics list */
        .topics-container { display: none; }
        .topics-container.active { display: block; }
        
        .topics-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #2a2520; }
        .topics-title { font-family: 'Russo One', sans-serif; font-size: 1.3rem; color: var(--rust); display: flex; align-items: center; gap: 0.5rem; }
        .back-btn { background: none; border: 1px solid #444; color: #888; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; transition: all 0.3s; border-radius: 4px; }
        .back-btn:hover { border-color: var(--rust); color: var(--rust); }
        
        .new-topic-btn { background: linear-gradient(135deg, var(--rust) 0%, #8b4513 100%); border: none; color: #fff; padding: 0.7rem 1.5rem; font-family: 'Oxanium', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s; border-radius: 4px; }
        .new-topic-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--rust-glow); }
        
        .topics-list { display: grid; gap: 0.5rem; }
        .topic-item { display: grid; grid-template-columns: auto 1fr auto; gap: 1rem; align-items: center; padding: 1rem 1.2rem; background: #0d0b0a; border: 1px solid #1a1815; border-radius: 6px; transition: all 0.3s; cursor: pointer; }
        .topic-item:hover { border-color: #333; background: #121010; }
        .topic-item.pinned { border-color: var(--rust); background: rgba(212, 114, 46, 0.05); }
        .topic-icon { font-size: 1.5rem; opacity: 0.7; }
        .topic-info h3 { font-size: 1rem; color: var(--text-light); margin-bottom: 0.2rem; font-weight: normal; }
        .topic-info h3:hover { color: var(--rust); }
        .topic-meta { font-size: 0.75rem; color: #666; }
        .topic-meta span { margin-right: 1rem; }
        .topic-stats { text-align: right; font-size: 0.8rem; color: #555; }
        .topic-stats div { margin-bottom: 0.2rem; }
        .topic-replies { color: var(--toxic); }
        .topic-likes { color: #ff6b6b; }
        
        .no-topics { text-align: center; padding: 3rem; color: #555; }
        
        /* Topic detail */
        .topic-detail { display: none; }
        .topic-detail.active { display: block; }
        
        .topic-title-bar { background: linear-gradient(180deg, rgba(212, 114, 46, 0.1) 0%, transparent 100%); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #2a2520; }
        .topic-title-bar h2 { font-family: 'Russo One', sans-serif; font-size: 1.4rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .topic-title-meta { font-size: 0.85rem; color: #888; }
        .topic-title-meta span { margin-right: 1rem; }
        
        /* Posts */
        .posts-list { display: grid; gap: 1rem; margin-bottom: 1.5rem; }
        .post { background: #0d0b0a; border: 1px solid #1a1815; border-radius: 8px; overflow: hidden; }
        .post.op { border-color: var(--rust); }
        .post-header { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem; background: rgba(255,255,255,0.02); border-bottom: 1px solid #1a1815; }
        .post-author { display: flex; align-items: center; gap: 0.5rem; }
        .post-avatar { width: 35px; height: 35px; background: var(--metal); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .post-author-info { }
        .post-author-name { font-weight: 600; color: var(--text-light); font-size: 0.9rem; }
        .post-author-name.admin { color: var(--rust); }
        .post-date { font-size: 0.75rem; color: #666; }
        .post-content { padding: 1.2rem; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; }
        .post-footer { display: flex; gap: 1rem; padding: 0.8rem 1rem; border-top: 1px solid #1a1815; }
        .post-action { background: none; border: none; color: #666; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; transition: color 0.3s; }
        .post-action:hover { color: var(--text); }
        .post-action.liked { color: #ff6b6b; }
        
        /* Reply form */
        .reply-form { background: #0d0b0a; border: 1px solid #2a2520; border-radius: 8px; padding: 1.2rem; }
        .reply-form h4 { color: var(--rust); margin-bottom: 1rem; font-size: 1rem; }
        .reply-form textarea { width: 100%; min-height: 120px; background: #080706; border: 1px solid #2a2520; border-radius: 4px; color: var(--text); padding: 1rem; font-family: 'Oxanium', sans-serif; font-size: 0.95rem; resize: vertical; }
        .reply-form textarea:focus { outline: none; border-color: var(--rust); }
        .reply-form button { margin-top: 1rem; }
        
        /* New topic modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: linear-gradient(180deg, #1a1510 0%, #0d0a08 100%); border: 2px solid var(--rust); border-radius: 12px; padding: 2rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-family: 'Russo One', sans-serif; color: var(--rust); font-size: 1.3rem; }
        .modal-close { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
        .modal-close:hover { color: var(--rust); }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; color: #888; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: #080706; border: 1px solid #2a2520; border-radius: 4px; color: var(--text); padding: 0.8rem; font-family: 'Oxanium', sans-serif; font-size: 0.95rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--rust); }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .form-group select { cursor: pointer; }
        
        .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .form-actions button { flex: 1; padding: 0.8rem; font-family: 'Oxanium', sans-serif; font-size: 0.95rem; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .btn-cancel { background: #333; color: #888; }
        .btn-cancel:hover { background: #444; color: #fff; }
        .btn-submit { background: linear-gradient(135deg, var(--rust) 0%, #8b4513 100%); color: #fff; font-weight: 600; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--rust-glow); }
        
        /* Login required */
        .login-required { text-align: center; padding: 4rem 2rem; }
        .login-required h2 { font-family: 'Russo One', sans-serif; color: var(--rust); font-size: 1.5rem; margin-bottom: 1rem; }
        .login-required p { color: #888; margin-bottom: 2rem; }
        .login-btn { display: inline-block; background: linear-gradient(135deg, var(--rust) 0%, #8b4513 100%); color: #fff; padding: 1rem 2rem; font-family: 'Oxanium', sans-serif; font-size: 1rem; font-weight: 600; border-radius: 4px; text-decoration: none; transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--rust-glow); color: #fff; }
        
        /* Loading */
        .loading { text-align: center; padding: 2rem; color: #666; }
        
        /* Responsive */
        @media (max-width: 768px) {
            nav { padding: 0.5rem 1rem; }
            .nav-title { display: none; }
            .nav-links { gap: 0.2rem; }
            .nav-link { padding: 0.4rem 0.6rem; font-size: 0.75rem; }
            .container { padding: 80px 0.5rem 1rem; }
            .category-header { padding: 1rem; flex-wrap: wrap; }
            .category-stats { width: 100%; text-align: left; margin-top: 0.5rem; display: flex; gap: 1rem; }
            .category-stats span { display: inline; }
            .topic-item { grid-template-columns: 1fr; gap: 0.5rem; }
            .topic-stats { text-align: left; display: flex; gap: 1rem; }
            .topic-stats div { margin: 0; }
            .topics-header { flex-direction: column; gap: 1rem; align-items: stretch; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="/" class="nav-brand">
            <div class="nav-logo">‚ò¢Ô∏è</div>
            <span class="nav-title">Posledn√≠ P≈ôe≈æiv≈°√≠</span>
        </a>
        <div class="nav-links">
            <a href="/" class="nav-link">üè† Dom≈Ø</a>
            <a href="/hra/" class="nav-link">üéÆ Hr√°t</a>
            <span class="nav-user" id="navUser">Naƒç√≠t√°m...</span>
        </div>
    </nav>

    <div class="container">
        <!-- Login required screen -->
        <div class="login-required" id="loginRequired" style="display: none;">
            <h2>üîí P≈ô√≠stup odep≈ôen</h2>
            <p>Pro p≈ô√≠stup na f√≥rum se mus√≠≈° p≈ôihl√°sit.</p>
            <a href="/" class="login-btn">üë§ P≈ôihl√°sit se na hlavn√≠ str√°nce</a>
        </div>
        
        <!-- Forum content -->
        <div id="forumContent" style="display: none;">
            <div class="forum-header">
                <h1>üí¨ Komunitn√≠ F√≥rum</h1>
                <p>Diskutuj s ostatn√≠mi p≈ôe≈æiv≈°√≠mi, sd√≠lej tipy a hl√°sej bugy</p>
            </div>
            
            <!-- Categories view -->
            <div class="categories" id="categoriesView">
                <div class="category" onclick="openCategory('general')">
                    <div class="category-header">
                        <div class="category-icon">üí¨</div>
                        <div class="category-info">
                            <div class="category-name">Obecn√° diskuze</div>
                            <div class="category-desc">V≈°echno o h≈ôe, komunitƒõ a p≈ôe≈æit√≠ v pustinƒõ</div>
                        </div>
                        <div class="category-stats">
                            <span>T√©mat: <span class="category-count" id="count-general">0</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="category" onclick="openCategory('guides')">
                    <div class="category-header">
                        <div class="category-icon">üìö</div>
                        <div class="category-info">
                            <div class="category-name">N√°vody & Tipy</div>
                            <div class="category-desc">Strategie, buildy, crafting recepty a survival tipy</div>
                        </div>
                        <div class="category-stats">
                            <span>T√©mat: <span class="category-count" id="count-guides">0</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="category" onclick="openCategory('bugs')">
                    <div class="category-header">
                        <div class="category-icon">üêõ</div>
                        <div class="category-info">
                            <div class="category-name">Bug reporty</div>
                            <div class="category-desc">Nahl√°≈°en√≠ chyb a probl√©m≈Ø ve h≈ôe</div>
                        </div>
                        <div class="category-stats">
                            <span>T√©mat: <span class="category-count" id="count-bugs">0</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="category" onclick="openCategory('suggestions')">
                    <div class="category-header">
                        <div class="category-icon">üí°</div>
                        <div class="category-info">
                            <div class="category-name">N√°vrhy & N√°pady</div>
                            <div class="category-desc">Tv√© n√°pady na vylep≈°en√≠ hry</div>
                        </div>
                        <div class="category-stats">
                            <span>T√©mat: <span class="category-count" id="count-suggestions">0</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="category" onclick="openCategory('offtopic')">
                    <div class="category-header">
                        <div class="category-icon">üé≤</div>
                        <div class="category-info">
                            <div class="category-name">Off-topic</div>
                            <div class="category-desc">Cokoliv mimo hru - filmy, hudba, ≈æivot v apokalypse</div>
                        </div>
                        <div class="category-stats">
                            <span>T√©mat: <span class="category-count" id="count-offtopic">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Topics view -->
            <div class="topics-container" id="topicsView">
                <div class="topics-header">
                    <div>
                        <button class="back-btn" onclick="showCategories()">‚Üê Zpƒõt</button>
                        <span class="topics-title" id="topicsTitle">Kategorie</span>
                    </div>
                    <button class="new-topic-btn" onclick="showNewTopicModal()">‚úèÔ∏è Nov√© t√©ma</button>
                </div>
                <div class="topics-list" id="topicsList">
                    <div class="loading">Naƒç√≠t√°m t√©mata...</div>
                </div>
            </div>
            
            <!-- Topic detail view -->
            <div class="topic-detail" id="topicDetail">
                <div class="topics-header">
                    <button class="back-btn" onclick="backToTopics()">‚Üê Zpƒõt na t√©mata</button>
                </div>
                <div class="topic-title-bar" id="topicTitleBar">
                    <h2>N√°zev t√©matu</h2>
                    <div class="topic-title-meta">
                        <span>üë§ Autor</span>
                        <span>üìÖ Datum</span>
                    </div>
                </div>
                <div class="posts-list" id="postsList"></div>
                <div class="reply-form">
                    <h4>üí¨ Napsat odpovƒõƒè</h4>
                    <textarea id="replyContent" placeholder="Napi≈° svou odpovƒõƒè..."></textarea>
                    <button class="new-topic-btn" onclick="submitReply()">üì§ Odeslat odpovƒõƒè</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New topic modal -->
    <div class="modal-overlay" id="newTopicModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3>‚úèÔ∏è Nov√© t√©ma</h3>
                <button class="modal-close" onclick="closeNewTopicModal()">‚úï</button>
            </div>
            <div class="form-group">
                <label>Kategorie</label>
                <select id="topicCategory">
                    <option value="general">üí¨ Obecn√° diskuze</option>
                    <option value="guides">üìö N√°vody & Tipy</option>
                    <option value="bugs">üêõ Bug reporty</option>
                    <option value="suggestions">üí° N√°vrhy & N√°pady</option>
                    <option value="offtopic">üé≤ Off-topic</option>
                </select>
            </div>
            <div class="form-group">
                <label>N√°zev t√©matu</label>
                <input type="text" id="topicTitle" placeholder="V√Ωsti≈æn√Ω n√°zev t√©matu..." maxlength="100">
            </div>
            <div class="form-group">
                <label>Obsah</label>
                <textarea id="topicContent" placeholder="Popi≈° sv√© t√©ma podrobnƒõ..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn-cancel" onclick="closeNewTopicModal()">Zru≈°it</button>
                <button class="btn-submit" onclick="submitNewTopic()">üì§ Vytvo≈ôit t√©ma</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // Poƒçkej na naƒçten√≠ Firebase
        if (typeof firebase === 'undefined') {
            document.getElementById('navUser').innerHTML = '‚ùå Chyba naƒç√≠t√°n√≠';
            document.getElementById('loginRequired').innerHTML = '<h2>‚ùå Chyba</h2><p>Firebase se nepoda≈ôilo naƒç√≠st. Zkus obnovit str√°nku.</p><a href="/" class="login-btn">üîÑ Obnovit</a>';
            document.getElementById('loginRequired').style.display = 'block';
            throw new Error('Firebase not loaded');
        }
        
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAnqRlz8iSsMTKa0PePTIvbPwncG1yj9RM",
            authDomain: "posledni-prezivsi.firebaseapp.com",
            databaseURL: "https://posledni-prezivsi-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "posledni-prezivsi",
            storageBucket: "posledni-prezivsi.firebasestorage.app",
            messagingSenderId: "593304244516",
            appId: "1:593304244516:web:dd99f403be270dc89a63b1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        let currentUser = null;
        let currentCategory = null;
        let currentTopicId = null;
        
        const CATEGORIES = {
            general: { name: 'Obecn√° diskuze', icon: 'üí¨' },
            guides: { name: 'N√°vody & Tipy', icon: 'üìö' },
            bugs: { name: 'Bug reporty', icon: 'üêõ' },
            suggestions: { name: 'N√°vrhy & N√°pady', icon: 'üí°' },
            offtopic: { name: 'Off-topic', icon: 'üé≤' }
        };
        
        const ADMINS = ['zaoo', 'admin'];
        
        // Auth state
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateUI();
        });
        
        function updateUI() {
            const navUser = document.getElementById('navUser');
            const loginRequired = document.getElementById('loginRequired');
            const forumContent = document.getElementById('forumContent');
            
            if (currentUser && !currentUser.isAnonymous) {
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                navUser.innerHTML = '‚úÖ ' + escapeHtml(displayName);
                loginRequired.style.display = 'none';
                forumContent.style.display = 'block';
                loadCategoryCounts();
            } else {
                navUser.innerHTML = 'üîí Nep≈ôihl√°≈°en';
                loginRequired.style.display = 'block';
                forumContent.style.display = 'none';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'Nezn√°m√©';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Pr√°vƒõ teƒè';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' hod';
            if (diff < 604800000) return Math.floor(diff / 86400000) + ' dn√≠';
            
            return date.toLocaleDateString('cs-CZ');
        }
        
        // Load category counts
        function loadCategoryCounts() {
            Object.keys(CATEGORIES).forEach(cat => {
                db.ref('forum/topics').orderByChild('category').equalTo(cat).once('value', (snap) => {
                    const count = snap.numChildren();
                    const el = document.getElementById('count-' + cat);
                    if (el) el.textContent = count;
                });
            });
        }
        
        // Show categories
        function showCategories() {
            document.getElementById('categoriesView').style.display = 'grid';
            document.getElementById('topicsView').classList.remove('active');
            document.getElementById('topicDetail').classList.remove('active');
            currentCategory = null;
            currentTopicId = null;
            loadCategoryCounts();
        }
        
        // Open category
        function openCategory(category) {
            currentCategory = category;
            document.getElementById('categoriesView').style.display = 'none';
            document.getElementById('topicsView').classList.add('active');
            document.getElementById('topicDetail').classList.remove('active');
            
            const cat = CATEGORIES[category];
            document.getElementById('topicsTitle').innerHTML = cat.icon + ' ' + cat.name;
            document.getElementById('topicCategory').value = category;
            
            loadTopics(category);
        }
        
        // Load topics
        function loadTopics(category) {
            const list = document.getElementById('topicsList');
            list.innerHTML = '<div class="loading">Naƒç√≠t√°m t√©mata...</div>';
            
            db.ref('forum/topics').orderByChild('category').equalTo(category).once('value', (snap) => {
                const topics = [];
                snap.forEach((child) => {
                    topics.push({ id: child.key, ...child.val() });
                });
                
                // Sort by pinned first, then by date
                topics.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return (b.createdAt || 0) - (a.createdAt || 0);
                });
                
                if (topics.length === 0) {
                    list.innerHTML = '<div class="no-topics">Zat√≠m ≈æ√°dn√° t√©mata. Buƒè prvn√≠ kdo nƒõco nap√≠≈°e! ‚úèÔ∏è</div>';
                    return;
                }
                
                list.innerHTML = topics.map(topic => `
                    <div class="topic-item ${topic.pinned ? 'pinned' : ''}" onclick="openTopic('${topic.id}')">
                        <div class="topic-icon">${topic.pinned ? 'üìå' : 'üí¨'}</div>
                        <div class="topic-info">
                            <h3>${escapeHtml(topic.title)}</h3>
                            <div class="topic-meta">
                                <span>üë§ ${escapeHtml(topic.authorName)}</span>
                                <span>üìÖ ${formatDate(topic.createdAt)}</span>
                            </div>
                        </div>
                        <div class="topic-stats">
                            <div class="topic-replies">üí¨ ${topic.replyCount || 0}</div>
                            <div class="topic-likes">‚ù§Ô∏è ${topic.likes || 0}</div>
                        </div>
                    </div>
                `).join('');
            });
        }
        
        // Open topic
        function openTopic(topicId) {
            currentTopicId = topicId;
            document.getElementById('topicsView').classList.remove('active');
            document.getElementById('topicDetail').classList.add('active');
            
            loadTopicDetail(topicId);
        }
        
        // Load topic detail
        function loadTopicDetail(topicId) {
            const titleBar = document.getElementById('topicTitleBar');
            const postsList = document.getElementById('postsList');
            
            postsList.innerHTML = '<div class="loading">Naƒç√≠t√°m p≈ô√≠spƒõvky...</div>';
            
            // Load topic
            db.ref('forum/topics/' + topicId).once('value', (snap) => {
                const topic = snap.val();
                if (!topic) {
                    postsList.innerHTML = '<div class="no-topics">T√©ma nebylo nalezeno.</div>';
                    return;
                }
                
                titleBar.innerHTML = `
                    <h2>${escapeHtml(topic.title)}</h2>
                    <div class="topic-title-meta">
                        <span>üë§ ${escapeHtml(topic.authorName)}</span>
                        <span>üìÖ ${formatDate(topic.createdAt)}</span>
                        <span>${CATEGORIES[topic.category]?.icon || 'üí¨'} ${CATEGORIES[topic.category]?.name || topic.category}</span>
                    </div>
                `;
                
                // Load posts
                db.ref('forum/posts').orderByChild('topicId').equalTo(topicId).once('value', (postsSnap) => {
                    const posts = [];
                    postsSnap.forEach((child) => {
                        posts.push({ id: child.key, ...child.val() });
                    });
                    
                    posts.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                    
                    if (posts.length === 0) {
                        postsList.innerHTML = '<div class="no-topics">Zat√≠m ≈æ√°dn√© odpovƒõdi.</div>';
                        return;
                    }
                    
                    postsList.innerHTML = posts.map((post, idx) => {
                        const isAdmin = ADMINS.includes(post.authorName?.toLowerCase());
                        const isOP = idx === 0;
                        const userLiked = post.likedBy && currentUser && post.likedBy[currentUser.uid];
                        
                        return `
                            <div class="post ${isOP ? 'op' : ''}">
                                <div class="post-header">
                                    <div class="post-author">
                                        <div class="post-avatar">${isAdmin ? 'üëë' : 'üë§'}</div>
                                        <div class="post-author-info">
                                            <div class="post-author-name ${isAdmin ? 'admin' : ''}">${escapeHtml(post.authorName)}${isOP ? ' (autor)' : ''}</div>
                                            <div class="post-date">${formatDate(post.createdAt)}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="post-content">${escapeHtml(post.content)}</div>
                                <div class="post-footer">
                                    <button class="post-action ${userLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                                        ‚ù§Ô∏è ${post.likes || 0}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            });
        }
        
        // Back to topics
        function backToTopics() {
            document.getElementById('topicDetail').classList.remove('active');
            document.getElementById('topicsView').classList.add('active');
            currentTopicId = null;
            if (currentCategory) loadTopics(currentCategory);
        }
        
        // Toggle like
        async function toggleLike(postId) {
            if (!currentUser) return;
            
            const likeRef = db.ref('forum/posts/' + postId + '/likedBy/' + currentUser.uid);
            const likesRef = db.ref('forum/posts/' + postId + '/likes');
            
            const snap = await likeRef.once('value');
            
            if (snap.exists()) {
                // Unlike
                await likeRef.remove();
                await likesRef.transaction(current => Math.max(0, (current || 0) - 1));
            } else {
                // Like
                await likeRef.set(true);
                await likesRef.transaction(current => (current || 0) + 1);
            }
            
            // Reload
            if (currentTopicId) loadTopicDetail(currentTopicId);
        }
        
        // New topic modal
        function showNewTopicModal() {
            document.getElementById('newTopicModal').classList.add('active');
            document.getElementById('topicTitle').value = '';
            document.getElementById('topicContent').value = '';
            if (currentCategory) {
                document.getElementById('topicCategory').value = currentCategory;
            }
        }
        
        function closeNewTopicModal() {
            document.getElementById('newTopicModal').classList.remove('active');
        }
        
        // Submit new topic
        async function submitNewTopic() {
            if (!currentUser) return alert('Mus√≠≈° b√Ωt p≈ôihl√°≈°en√Ω!');
            
            const category = document.getElementById('topicCategory').value;
            const title = document.getElementById('topicTitle').value.trim();
            const content = document.getElementById('topicContent').value.trim();
            
            if (!title || title.length < 5) return alert('N√°zev mus√≠ m√≠t alespo≈à 5 znak≈Ø');
            if (!content || content.length < 10) return alert('Obsah mus√≠ m√≠t alespo≈à 10 znak≈Ø');
            
            const authorName = currentUser.displayName || currentUser.email.split('@')[0];
            
            try {
                // Create topic
                const topicRef = await db.ref('forum/topics').push({
                    category: category,
                    title: title,
                    authorId: currentUser.uid,
                    authorName: authorName,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    replyCount: 1,
                    likes: 0,
                    pinned: false
                });
                
                // Create first post
                await db.ref('forum/posts').push({
                    topicId: topicRef.key,
                    authorId: currentUser.uid,
                    authorName: authorName,
                    content: content,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    likes: 0
                });
                
                closeNewTopicModal();
                openTopic(topicRef.key);
                
            } catch (error) {
                console.error('Error creating topic:', error);
                alert('Chyba p≈ôi vytv√°≈ôen√≠ t√©matu: ' + error.message);
            }
        }
        
        // Submit reply
        async function submitReply() {
            if (!currentUser) return alert('Mus√≠≈° b√Ωt p≈ôihl√°≈°en√Ω!');
            if (!currentTopicId) return;
            
            const content = document.getElementById('replyContent').value.trim();
            if (!content || content.length < 3) return alert('Odpovƒõƒè mus√≠ m√≠t alespo≈à 3 znaky');
            
            const authorName = currentUser.displayName || currentUser.email.split('@')[0];
            
            try {
                // Create post
                await db.ref('forum/posts').push({
                    topicId: currentTopicId,
                    authorId: currentUser.uid,
                    authorName: authorName,
                    content: content,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    likes: 0
                });
                
                // Increment reply count
                await db.ref('forum/topics/' + currentTopicId + '/replyCount').transaction(current => (current || 0) + 1);
                
                document.getElementById('replyContent').value = '';
                loadTopicDetail(currentTopicId);
                
            } catch (error) {
                console.error('Error creating reply:', error);
                alert('Chyba p≈ôi odes√≠l√°n√≠ odpovƒõdi: ' + error.message);
            }
        }
    </script>
</body>
</html>
